<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:35:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-8897] Rowtime materialization causes &quot;mismatched type&quot; AssertionError</title>
                <link>https://issues.apache.org/jira/browse/FLINK-8897</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;As raised in &lt;a href=&quot;https://lists.apache.org/thread.html/e2ea38aa7ae224d7481145334955d84243690e9aad10d58310bdb8e7@%3Cuser.flink.apache.org%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this thread&lt;/a&gt;, the query created by the following code will throw a calcite &quot;mismatch type&quot; (&lt;tt&gt;Timestamp(3)&lt;/tt&gt; and &lt;tt&gt;TimeIndicator&lt;/tt&gt;) exception.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; sql1 = &lt;span class=&quot;code-quote&quot;&gt;&quot;select id, eventTs as t1, count(*) over (partition by id order by eventTs rows between 100 preceding and current row) as cnt1 from myTable1&quot;&lt;/span&gt;;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; sql2 = &lt;span class=&quot;code-quote&quot;&gt;&quot;select distinct id as r_id, eventTs as t2, count(*) over (partition by id order by eventTs rows between 50 preceding and current row) as cnt2 from myTable2&quot;&lt;/span&gt;;

Table left = tableEnv.sqlQuery(sql1);
Table right = tableEnv.sqlQuery(sql2);
left.join(right).where(&lt;span class=&quot;code-quote&quot;&gt;&quot;id === r_id &amp;amp;&amp;amp; t1 === t2&quot;&lt;/span&gt;).select(&lt;span class=&quot;code-quote&quot;&gt;&quot;id, t1&quot;&lt;/span&gt;).writeToSink(...)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The logical plan is as follows.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
LogicalProject(id=[$0], t1=[$1])
  LogicalFilter(condition=[AND(=($0, $3), =($1, $4))])
    LogicalJoin(condition=[&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;], joinType=[&lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt;])
      LogicalAggregate(group=[{0, 1, 2}])
        LogicalWindow(window#0=[window(partition {0} order by [1] rows between $2 PRECEDING and CURRENT ROW aggs [COUNT()])])
          LogicalProject(id=[$0], eventTs=[$3])
            LogicalTableScan(table=[[_DataStreamTable_0]])
      LogicalAggregate(group=[{0, 1, 2}])
        LogicalWindow(window#0=[window(partition {0} order by [1] rows between $2 PRECEDING and CURRENT ROW aggs [COUNT()])])
          LogicalProject(id=[$0], eventTs=[$3])
            LogicalTableScan(table=[[_DataStreamTable_0]])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That is because the the rowtime field after an aggregation will be materialized while the &lt;tt&gt;RexInputRef&lt;/tt&gt; type for the filter&apos;s operands (&lt;tt&gt;t1 === t2&lt;/tt&gt;) is still &lt;tt&gt;TimeIndicator&lt;/tt&gt;. We should make them unified.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13143592">FLINK-8897</key>
            <summary>Rowtime materialization causes &quot;mismatched type&quot; AssertionError</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="twalthr">Timo Walther</assignee>
                                    <reporter username="xccui">Xingcan Cui</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 8 Mar 2018 15:58:52 +0000</created>
                <updated>Mon, 5 Nov 2018 13:55:34 +0000</updated>
                            <resolved>Mon, 5 Nov 2018 13:55:01 +0000</resolved>
                                                    <fixVersion>1.7.0</fixVersion>
                                    <component>Table SQL / API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16419189" author="till.rohrmann" created="Thu, 29 Mar 2018 15:25:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt; is this a problem introduced with Flink 1.5.0 or does it exist for longer?&lt;/p&gt;</comment>
                            <comment id="16419231" author="twalthr" created="Thu, 29 Mar 2018 15:52:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; it has been introduced with Flink 1.5 but it must not be a blocker.&lt;/p&gt;</comment>
                            <comment id="16587268" author="twalthr" created="Tue, 21 Aug 2018 10:32:45 +0000"  >&lt;p&gt;The following query is also affected by this bug:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
  def testRunningLast2() = {
    val env = StreamExecutionEnvironment.getExecutionEnvironment
    env.setParallelism(1)
    env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)
    val tEnv = TableEnvironment.getTableEnvironment(env)
    StreamITCase.clear

    val data = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; mutable.MutableList[(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Timestamp, Int, Int)]
    data.+=((&lt;span class=&quot;code-quote&quot;&gt;&quot;ACME&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Timestamp(1000L), 12, 1))
    data.+=((&lt;span class=&quot;code-quote&quot;&gt;&quot;ACME&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Timestamp(2000L), 17, 2))
    data.+=((&lt;span class=&quot;code-quote&quot;&gt;&quot;ACME&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Timestamp(3000L), 13, 4))
    data.+=((&lt;span class=&quot;code-quote&quot;&gt;&quot;ACME&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Timestamp(4000L), 11, 3))
    data.+=((&lt;span class=&quot;code-quote&quot;&gt;&quot;ACME&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Timestamp(5000L), 20, 4))
    data.+=((&lt;span class=&quot;code-quote&quot;&gt;&quot;ACME&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Timestamp(6000L), 24, 4))
    data.+=((&lt;span class=&quot;code-quote&quot;&gt;&quot;ACME&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Timestamp(7000L), 25, 3))
    data.+=((&lt;span class=&quot;code-quote&quot;&gt;&quot;ACME&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Timestamp(8000L), 19, 8))

    val t = env.fromCollection(data).assignAscendingTimestamps(e =&amp;gt; e._2.toInstant.toEpochMilli).toTable(tEnv, &lt;span class=&quot;code-quote&quot;&gt;&apos;symbol, &apos;&lt;/span&gt;tstamp.rowtime, &lt;span class=&quot;code-quote&quot;&gt;&apos;price, &apos;&lt;/span&gt;tax)
    tEnv.registerTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;Ticker&quot;&lt;/span&gt;, t)

    val sqlQuery =
      s&quot;&quot;&quot;
         |SELECT *
         |FROM (
         |   SELECT symbol, SUM(price) as price, TUMBLE_ROWTIME(tstamp, interval &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; second) as rowTime, TUMBLE_START(tstamp, interval &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; second) as startTime, TUMBLE_END(tstamp, interval &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; second) as endTime
         |   FROM Ticker
         |   GROUP BY symbol, TUMBLE(tstamp, interval &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; second)
         |)
         |WHERE startTime &amp;lt; endTime
         |&quot;&quot;&quot;.stripMargin

    val result = tEnv.sql(sqlQuery).toAppendStream[Row]
    result.addSink(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StreamITCase.StringSink[Row])
    env.execute()

    val expected = List(&lt;span class=&quot;code-quote&quot;&gt;&quot;2,4,5&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;2,4,6&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;3,4,5&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;3,4,6&quot;&lt;/span&gt;)
    assertEquals(expected.sorted, StreamITCase.testResults.sorted)
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16671585" author="githubbot" created="Thu, 1 Nov 2018 12:59:08 +0000"  >&lt;p&gt;twalthr opened a new pull request #6987: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8897&quot; title=&quot;Rowtime materialization causes &amp;quot;mismatched type&amp;quot; AssertionError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8897&quot;&gt;&lt;del&gt;FLINK-8897&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix rowtime materialization issues for filters and joins&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6987&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6987&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This PR solves the `&quot;mismatched type&quot; AssertionError` caused by invalid time indicator materialization. &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6232&quot; title=&quot;Support proctime inner equi-join between two streams in the SQL API&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6232&quot;&gt;&lt;del&gt;FLINK-6232&lt;/del&gt;&lt;/a&gt; removed the materialization of filters for windowed joins, however, this led to mismatches between input types and expected input types of `RexNodes`. This PR modifies the window join rule to match against a newly materialized expression (`CAST(rowtime)` and `PROCTIME(proctime)`) instead.&lt;/p&gt;

&lt;p&gt;   Additionally, this PR simplifies the general time attribute logic for joins and gives better error messages for current limitations (namely no rowtime attributes in projections or condiitions). We should fix these limitation by some major refactoring as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10211&quot; title=&quot;Time indicators are not correctly materialized for LogicalJoin&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10211&quot;&gt;&lt;del&gt;FLINK-10211&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Materialize conditions of filters and joins again and match against newly materialized expressions&lt;/li&gt;
	&lt;li&gt;Simplify code and improve error message&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Change is covered by existing tests.&lt;/li&gt;
	&lt;li&gt;New tests in `JoinValidationTest`&lt;/li&gt;
	&lt;li&gt;New test in `TimeAttributesITCase`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): no&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: no&lt;/li&gt;
	&lt;li&gt;The serializers: no&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): no&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: no&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: no&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? no&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? not applicable&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16671587" author="githubbot" created="Thu, 1 Nov 2018 13:00:30 +0000"  >&lt;p&gt;twalthr commented on issue #6987: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8897&quot; title=&quot;Rowtime materialization causes &amp;quot;mismatched type&amp;quot; AssertionError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8897&quot;&gt;&lt;del&gt;FLINK-8897&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix rowtime materialization issues for filters and joins&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6987#issuecomment-435033426&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6987#issuecomment-435033426&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @xccui @hequn8128 would be great if you can take a look&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16671631" author="githubbot" created="Thu, 1 Nov 2018 13:50:14 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6987: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8897&quot; title=&quot;Rowtime materialization causes &amp;quot;mismatched type&amp;quot; AssertionError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8897&quot;&gt;&lt;del&gt;FLINK-8897&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix rowtime materialization issues for filters and joins&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6987#discussion_r230039997&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6987#discussion_r230039997&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/validation/JoinValidationTest.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -30,18 +30,6 @@ class JoinValidationTest extends TableTestBase {&lt;br/&gt;
   streamUtil.addTable&lt;span class=&quot;error&quot;&gt;&amp;#91;(Int, String, Long)&amp;#93;&lt;/span&gt;(&quot;MyTable&quot;, &apos;a, &apos;b, &apos;c.rowtime, &apos;proctime.proctime)&lt;br/&gt;
   streamUtil.addTable&lt;span class=&quot;error&quot;&gt;&amp;#91;(Int, String, Long)&amp;#93;&lt;/span&gt;(&quot;MyTable2&quot;, &apos;a, &apos;b, &apos;c.rowtime, &apos;proctime.proctime)&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/** There should exist exactly two time conditions **/&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   What&apos;s happened with this test?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16671632" author="githubbot" created="Thu, 1 Nov 2018 13:50:14 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6987: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8897&quot; title=&quot;Rowtime materialization causes &amp;quot;mismatched type&amp;quot; AssertionError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8897&quot;&gt;&lt;del&gt;FLINK-8897&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix rowtime materialization issues for filters and joins&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6987#discussion_r230040369&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6987#discussion_r230040369&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/validation/JoinValidationTest.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -136,4 +124,66 @@ class JoinValidationTest extends TableTestBase &lt;/p&gt;
{
 
     streamUtil.verifySql(sql, &quot;n/a&quot;)
   }
&lt;p&gt;+&lt;br/&gt;
+  /** Rowtime attributes cannot be accessed in filter conditions yet. */&lt;br/&gt;
+  @Test(expected = classOf&lt;span class=&quot;error&quot;&gt;&amp;#91;TableException&amp;#93;&lt;/span&gt;)&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   please add also some trivial expected message matcher, otherwise this can give false negative results.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16671633" author="githubbot" created="Thu, 1 Nov 2018 13:50:14 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6987: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8897&quot; title=&quot;Rowtime materialization causes &amp;quot;mismatched type&amp;quot; AssertionError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8897&quot;&gt;&lt;del&gt;FLINK-8897&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix rowtime materialization issues for filters and joins&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6987#discussion_r230039672&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6987#discussion_r230039672&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/JoinTest.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1003,12 +980,43 @@ class JoinTest extends TableTestBase &lt;/p&gt;
{
     util.verifyTable(result, expected)
   }

&lt;p&gt;+  private def verifyTimeBoundary(&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Please either revert this move or extract it to separate commit. As it is now, I can not easily tell if something has changed or if that&apos;s a simple refactor without any functional change.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16671634" author="githubbot" created="Thu, 1 Nov 2018 13:50:14 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6987: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8897&quot; title=&quot;Rowtime materialization causes &amp;quot;mismatched type&amp;quot; AssertionError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8897&quot;&gt;&lt;del&gt;FLINK-8897&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix rowtime materialization issues for filters and joins&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6987#discussion_r230040453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6987#discussion_r230040453&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/validation/JoinValidationTest.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -136,4 +124,66 @@ class JoinValidationTest extends TableTestBase &lt;/p&gt;
{
 
     streamUtil.verifySql(sql, &quot;n/a&quot;)
   }
&lt;p&gt;+&lt;br/&gt;
+  /** Rowtime attributes cannot be accessed in filter conditions yet. */&lt;br/&gt;
+  @Test(expected = classOf&lt;span class=&quot;error&quot;&gt;&amp;#91;TableException&amp;#93;&lt;/span&gt;)&lt;br/&gt;
+  def testJoinWithRowtimeCondition(): Unit = &lt;/p&gt;
{
+    val sql =
+      &quot;&quot;&quot;
+        |SELECT t2.a
+        |FROM MyTable t1 JOIN MyTable2 t2 ON
+        |  t1.a = t2.a AND
+        |  t1.c &amp;gt; t2.c - INTERVAL &apos;5&apos; SECOND
+        |&quot;&quot;&quot;.stripMargin
+
+    streamUtil.verifySql(sql, &quot;n/a&quot;)
+  }
&lt;p&gt;+&lt;br/&gt;
+  /** Rowtime attributes cannot be accessed in filter conditions yet. */&lt;br/&gt;
+  @Test(expected = classOf&lt;span class=&quot;error&quot;&gt;&amp;#91;TableException&amp;#93;&lt;/span&gt;)&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   ditto&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16674623" author="githubbot" created="Mon, 5 Nov 2018 03:23:19 +0000"  >&lt;p&gt;hequn8128 commented on a change in pull request #6987: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8897&quot; title=&quot;Rowtime materialization causes &amp;quot;mismatched type&amp;quot; AssertionError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8897&quot;&gt;&lt;del&gt;FLINK-8897&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix rowtime materialization issues for filters and joins&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6987#discussion_r230626371&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6987#discussion_r230626371&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/validation/JoinValidationTest.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -30,18 +30,6 @@ class JoinValidationTest extends TableTestBase {&lt;br/&gt;
   streamUtil.addTable&lt;span class=&quot;error&quot;&gt;&amp;#91;(Int, String, Long)&amp;#93;&lt;/span&gt;(&quot;MyTable&quot;, &apos;a, &apos;b, &apos;c.rowtime, &apos;proctime.proctime)&lt;br/&gt;
   streamUtil.addTable&lt;span class=&quot;error&quot;&gt;&amp;#91;(Int, String, Long)&amp;#93;&lt;/span&gt;(&quot;MyTable2&quot;, &apos;a, &apos;b, &apos;c.rowtime, &apos;proctime.proctime)&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/** There should exist exactly two time conditions **/&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Hi, `DataStreamJoinRule` would match this case after we materialize time indicators in the join condition.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16674631" author="githubbot" created="Mon, 5 Nov 2018 03:45:47 +0000"  >&lt;p&gt;hequn8128 commented on issue #6987: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8897&quot; title=&quot;Rowtime materialization causes &amp;quot;mismatched type&amp;quot; AssertionError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8897&quot;&gt;&lt;del&gt;FLINK-8897&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix rowtime materialization issues for filters and joins&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6987#issuecomment-435747112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6987#issuecomment-435747112&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Hi, @twalthr  A neat fix! LGTM.&lt;/p&gt;

&lt;p&gt;   And thanks for adding the logic that throw an exception in `DataStreamJoinRule` when the rule doesn&apos;t match which I think makes the exceptions more friendly to users. How about add similar logic to `DataStreamWindowJoinRule`, i.e, throw an exception when window bound has been defined while contains rowtime field in the output. &lt;/p&gt;

&lt;p&gt;   Best, Hequn&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16675124" author="githubbot" created="Mon, 5 Nov 2018 13:13:52 +0000"  >&lt;p&gt;fhueske commented on issue #6987: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8897&quot; title=&quot;Rowtime materialization causes &amp;quot;mismatched type&amp;quot; AssertionError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8897&quot;&gt;&lt;del&gt;FLINK-8897&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix rowtime materialization issues for filters and joins&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6987#issuecomment-435869177&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6987#issuecomment-435869177&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Hi @hequn8128, the problem with throwing exceptions in the rules is that they result in canceling the optimizer completely, i.e., as soon as a rule is applied on a plan that does not meet the condition, the query fails even if the query could be transformed into a valid execution plan. I know that Calcite&apos;s &quot;Cannot optimize&quot; exceptions are hard to digest, but they are only thrown when the optimizer cannot generate a valid plan. &lt;/p&gt;

&lt;p&gt;   Aborting the optimization is especially tricky for specialized operators like window join that require very specific conditions. If these conditions are not met, the join can often be executed with a regular (fully materializing) join. I don&apos;t think we should speculate whether this is something that the user intended to do or not.&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16675144" author="githubbot" created="Mon, 5 Nov 2018 13:32:01 +0000"  >&lt;p&gt;twalthr commented on issue #6987: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8897&quot; title=&quot;Rowtime materialization causes &amp;quot;mismatched type&amp;quot; AssertionError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8897&quot;&gt;&lt;del&gt;FLINK-8897&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix rowtime materialization issues for filters and joins&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6987#issuecomment-435874189&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6987#issuecomment-435874189&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @fhueske This is also why &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10211&quot; title=&quot;Time indicators are not correctly materialized for LogicalJoin&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10211&quot;&gt;&lt;del&gt;FLINK-10211&lt;/del&gt;&lt;/a&gt; should be fixed quite soon as it would properly materialize the time attributes and would reduce the need for exceptions that a non-advanced user can hardly understand.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16675160" author="githubbot" created="Mon, 5 Nov 2018 13:46:34 +0000"  >&lt;p&gt;twalthr commented on issue #6987: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8897&quot; title=&quot;Rowtime materialization causes &amp;quot;mismatched type&amp;quot; AssertionError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8897&quot;&gt;&lt;del&gt;FLINK-8897&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix rowtime materialization issues for filters and joins&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6987#issuecomment-435878892&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6987#issuecomment-435878892&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I will merge these changes now to have it in Flink 1.7. But we should aim to fix these issues entirely by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10211&quot; title=&quot;Time indicators are not correctly materialized for LogicalJoin&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10211&quot;&gt;&lt;del&gt;FLINK-10211&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16675175" author="twalthr" created="Mon, 5 Nov 2018 13:55:01 +0000"  >&lt;p&gt;Fixed in 1.8: fa256b2a8983d899f71ba8bbda415db9a57f6c23, d041baaf3f16d58105d958ba6c2928fb143298f2, 9f31d5c76086943d92cbaa27b035c351d9ac3dc8&lt;br/&gt;
Fixed in 1.7: b7a76e0afd12b8c84c5e3a580e77fe6b215f150b, 4d6d14543666e71130b723589f1239943ca118d4, 9c0fddecb15536e4624c5b88af91ce19ee5ff622&lt;/p&gt;</comment>
                            <comment id="16675177" author="githubbot" created="Mon, 5 Nov 2018 13:55:34 +0000"  >&lt;p&gt;twalthr closed pull request #6987: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-8897&quot; title=&quot;Rowtime materialization causes &amp;quot;mismatched type&amp;quot; AssertionError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-8897&quot;&gt;&lt;del&gt;FLINK-8897&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix rowtime materialization issues for filters and joins&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6987&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6987&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/calcite/RelTimeIndicatorConverter.scala b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/calcite/RelTimeIndicatorConverter.scala&lt;br/&gt;
index 41f0fc5f685..c1bcf1438d3 100644&lt;br/&gt;
&amp;#8212; a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/calcite/RelTimeIndicatorConverter.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/calcite/RelTimeIndicatorConverter.scala&lt;br/&gt;
@@ -23,6 +23,7 @@ import org.apache.calcite.rel.core._&lt;br/&gt;
 import org.apache.calcite.rel.logical._&lt;br/&gt;
 import org.apache.calcite.rel.&lt;/p&gt;
{RelNode, RelShuttle}
&lt;p&gt; import org.apache.calcite.rex._&lt;br/&gt;
+import org.apache.calcite.sql.`type`.SqlTypeName&lt;br/&gt;
 import org.apache.calcite.sql.fun.SqlStdOperatorTable&lt;br/&gt;
 import org.apache.flink.api.common.typeinfo.SqlTimeTypeInfo&lt;br/&gt;
 import org.apache.flink.table.api.&lt;/p&gt;
{TableException, ValidationException}
&lt;p&gt;@@ -100,13 +101,7 @@ class RelTimeIndicatorConverter(rexBuilder: RexBuilder) extends RelShuttle {&lt;br/&gt;
   override def visit(matchRel: LogicalMatch): RelNode = {&lt;br/&gt;
     // visit children and update inputs&lt;br/&gt;
     val input = matchRel.getInput.accept(this)&lt;br/&gt;
-&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// check if input field contains time indicator type&lt;/li&gt;
	&lt;li&gt;// materialize field if no time indicator is present anymore&lt;/li&gt;
	&lt;li&gt;// if input field is already materialized, change to timestamp type&lt;/li&gt;
	&lt;li&gt;val materializer = new RexTimeIndicatorMaterializer(&lt;/li&gt;
	&lt;li&gt;rexBuilder,&lt;/li&gt;
	&lt;li&gt;input.getRowType.getFieldList.map(_.getType))&lt;br/&gt;
+    val materializer = createMaterializer(input)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     // update input expressions&lt;br/&gt;
     val patternDefs = matchRel.getPatternDefinitions.mapValues(_.accept(materializer))&lt;br/&gt;
@@ -180,23 +175,16 @@ class RelTimeIndicatorConverter(rexBuilder: RexBuilder) extends RelShuttle {&lt;br/&gt;
   override def visit(filter: LogicalFilter): RelNode = &lt;/p&gt;
{
     // visit children and update inputs
     val input = filter.getInput.accept(this)
+    val materializer = createMaterializer(input)
 
-    // We do not materialize time indicators in conditions because they can be locally evaluated.
-    // Some conditions are evaluated by special operators (e.g., time window joins).
-    // Time indicators in remaining conditions are materialized by Calc before the code generation.
-    LogicalFilter.create(input, filter.getCondition)
+    val condition = filter.getCondition.accept(materializer)
+    LogicalFilter.create(input, condition)
   }

&lt;p&gt;   override def visit(project: LogicalProject): RelNode = {&lt;br/&gt;
     // visit children and update inputs&lt;br/&gt;
     val input = project.getInput.accept(this)&lt;br/&gt;
-&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// check if input field contains time indicator type&lt;/li&gt;
	&lt;li&gt;// materialize field if no time indicator is present anymore&lt;/li&gt;
	&lt;li&gt;// if input field is already materialized, change to timestamp type&lt;/li&gt;
	&lt;li&gt;val materializer = new RexTimeIndicatorMaterializer(&lt;/li&gt;
	&lt;li&gt;rexBuilder,&lt;/li&gt;
	&lt;li&gt;input.getRowType.getFieldList.map(_.getType))&lt;br/&gt;
+    val materializer = createMaterializer(input)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     val projects = project.getProjects.map(_.accept(materializer))&lt;br/&gt;
     val fieldNames = project.getRowType.getFieldNames&lt;br/&gt;
@@ -206,8 +194,14 @@ class RelTimeIndicatorConverter(rexBuilder: RexBuilder) extends RelShuttle {&lt;br/&gt;
   override def visit(join: LogicalJoin): RelNode = &lt;/p&gt;
{
     val left = join.getLeft.accept(this)
     val right = join.getRight.accept(this)
+    val materializer = createMaterializer(left, right)
 
-    LogicalJoin.create(left, right, join.getCondition, join.getVariablesSet, join.getJoinType)
+    LogicalJoin.create(
+      left,
+      right,
+      join.getCondition.accept(materializer),
+      join.getVariablesSet,
+      join.getJoinType)
   }

&lt;p&gt;   def visit(temporalJoin: LogicalTemporalTableJoin): RelNode = {&lt;br/&gt;
@@ -229,19 +223,11 @@ class RelTimeIndicatorConverter(rexBuilder: RexBuilder) extends RelShuttle {&lt;br/&gt;
       case scan: LogicalTableFunctionScan =&amp;gt;&lt;br/&gt;
         // visit children and update inputs&lt;br/&gt;
         val scanInputs = scan.getInputs.map(_.accept(this))&lt;br/&gt;
-&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// check if input field contains time indicator type&lt;/li&gt;
	&lt;li&gt;// materialize field if no time indicator is present anymore&lt;/li&gt;
	&lt;li&gt;// if input field is already materialized, change to timestamp type&lt;/li&gt;
	&lt;li&gt;val materializer = new RexTimeIndicatorMaterializer(&lt;/li&gt;
	&lt;li&gt;rexBuilder,&lt;/li&gt;
	&lt;li&gt;inputs.head.getRowType.getFieldList.map(_.getType))&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;val call = scan.getCall.accept(materializer)&lt;br/&gt;
+        val materializer = createMaterializer(inputs.head)&lt;br/&gt;
         LogicalTableFunctionScan.create(&lt;br/&gt;
           scan.getCluster,&lt;br/&gt;
           scanInputs,&lt;/li&gt;
	&lt;li&gt;call,&lt;br/&gt;
+          scan.getCall.accept(materializer),&lt;br/&gt;
           scan.getElementType,&lt;br/&gt;
           scan.getRowType,&lt;br/&gt;
           scan.getColumnMappings)&lt;br/&gt;
@@ -369,6 +355,15 @@ class RelTimeIndicatorConverter(rexBuilder: RexBuilder) extends RelShuttle 
{
 
     indicesToMaterialize.toSet
   }
&lt;p&gt;+&lt;br/&gt;
+  private def createMaterializer(inputs: RelNode*): RexTimeIndicatorMaterializer = &lt;/p&gt;
{
+    // check if input field contains time indicator type
+    // materialize field if no time indicator is present anymore
+    // if input field is already materialized, change to timestamp type
+    new RexTimeIndicatorMaterializer(
+      rexBuilder,
+      inputs.flatMap(_.getRowType.getFieldList.map(_.getType)))
+  }
&lt;p&gt; }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; object RelTimeIndicatorConverter {&lt;br/&gt;
@@ -412,11 +407,34 @@ object RelTimeIndicatorConverter {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@return The expression with materialized time indicators.&lt;br/&gt;
     */&lt;br/&gt;
   def convertExpression(expr: RexNode, rowType: RelDataType, rexBuilder: RexBuilder): RexNode = 
{
+    // check if input field contains time indicator type
+    // materialize field if no time indicator is present anymore
+    // if input field is already materialized, change to timestamp type
     val materializer = new RexTimeIndicatorMaterializer(
-          rexBuilder,
-          rowType.getFieldList.map(_.getType))
+      rexBuilder,
+      rowType.getFieldList.map(_.getType))
+
+    expr.accept(materializer)
+  }
&lt;p&gt;+&lt;br/&gt;
+  /**&lt;br/&gt;
+    * Checks if the given call is a materialization call for either proctime or rowtime.&lt;br/&gt;
+    */&lt;br/&gt;
+  def isMaterializationCall(call: RexCall): Boolean = {&lt;br/&gt;
+    val isProctimeCall: Boolean = &lt;/p&gt;
{
+      call.getOperator == ProctimeSqlFunction &amp;amp;&amp;amp;
+        call.getOperands.size() == 1 &amp;amp;&amp;amp;
+        isProctimeIndicatorType(call.getOperands.get(0).getType)
+    }
&lt;p&gt;+&lt;br/&gt;
+    val isRowtimeCall: Boolean = &lt;/p&gt;
{
+      call.getOperator == SqlStdOperatorTable.CAST &amp;amp;&amp;amp;
+        call.getOperands.size() == 1 &amp;amp;&amp;amp;
+        isRowtimeIndicatorType(call.getOperands.get(0).getType) &amp;amp;&amp;amp;
+        call.getType.getSqlTypeName == SqlTypeName.TIMESTAMP
+    }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;expr.accept(materializer)&lt;br/&gt;
+    isProctimeCall || isRowtimeCall&lt;br/&gt;
   }&lt;br/&gt;
 }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;diff --git a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/datastream/DataStreamJoinRule.scala b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/datastream/DataStreamJoinRule.scala&lt;br/&gt;
index 072acb34c73..ad749d25df3 100644&lt;br/&gt;
&amp;#8212; a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/datastream/DataStreamJoinRule.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/datastream/DataStreamJoinRule.scala&lt;br/&gt;
@@ -20,10 +20,8 @@ package org.apache.flink.table.plan.rules.datastream&lt;/p&gt;

&lt;p&gt; import org.apache.calcite.plan.&lt;/p&gt;
{RelOptRule, RelOptRuleCall, RelTraitSet}&lt;br/&gt;
 import org.apache.calcite.rel.RelNode&lt;br/&gt;
-import org.apache.calcite.rel.`type`.RelDataType&lt;br/&gt;
 import org.apache.calcite.rel.convert.ConverterRule&lt;br/&gt;
-import org.apache.calcite.rex.{RexCall, RexInputRef, RexNode}&lt;br/&gt;
-import org.apache.flink.table.api.TableConfig&lt;br/&gt;
+import org.apache.flink.table.api.{TableConfig, TableException}&lt;br/&gt;
 import org.apache.flink.table.calcite.FlinkTypeFactory&lt;br/&gt;
 import org.apache.flink.table.plan.nodes.FlinkConventions&lt;br/&gt;
 import org.apache.flink.table.plan.nodes.datastream.DataStreamJoin&lt;br/&gt;
@@ -40,45 +38,32 @@ class DataStreamJoinRule&lt;br/&gt;
     FlinkConventions.DATASTREAM,&lt;br/&gt;
     &quot;DataStreamJoinRule&quot;) {&lt;br/&gt;
 &lt;br/&gt;
-  /**&lt;br/&gt;
-    * Checks if an expression accesses a time attribute.&lt;br/&gt;
-    *&lt;br/&gt;
-    * @param expr The expression to check.&lt;br/&gt;
-    * @param inputType The input type of the expression.&lt;br/&gt;
-    * @return True, if the expression accesses a time attribute. False otherwise.&lt;br/&gt;
-    */&lt;br/&gt;
-  def accessesTimeAttribute(expr: RexNode, inputType: RelDataType): Boolean = {&lt;br/&gt;
-    expr match {
-      case i: RexInputRef =&amp;gt;
-        val accessedType = inputType.getFieldList.get(i.getIndex).getType
-        FlinkTypeFactory.isTimeIndicatorType(accessedType)
-      case c: RexCall =&amp;gt;
-        c.operands.asScala.exists(accessesTimeAttribute(_, inputType))
-      case _ =&amp;gt; false
-    }&lt;br/&gt;
-  }&lt;br/&gt;
-&lt;br/&gt;
   override def matches(call: RelOptRuleCall): Boolean = {&lt;br/&gt;
     val join: FlinkLogicalJoin = call.rel(0).asInstanceOf&lt;span class=&quot;error&quot;&gt;&amp;#91;FlinkLogicalJoin&amp;#93;&lt;/span&gt;&lt;br/&gt;
     val joinInfo = join.analyzeCondition&lt;br/&gt;
 &lt;br/&gt;
-    val (windowBounds, remainingPreds) = WindowJoinUtil.extractWindowBoundsFromPredicate(&lt;br/&gt;
+    val (windowBounds, _) = WindowJoinUtil.extractWindowBoundsFromPredicate(&lt;br/&gt;
       joinInfo.getRemaining(join.getCluster.getRexBuilder),&lt;br/&gt;
       join.getLeft.getRowType.getFieldCount,&lt;br/&gt;
       join.getRowType,&lt;br/&gt;
       join.getCluster.getRexBuilder,&lt;br/&gt;
       TableConfig.DEFAULT)&lt;br/&gt;
 &lt;br/&gt;
-    // remaining predicate must not access time attributes&lt;br/&gt;
-    val remainingPredsAccessTime = remainingPreds.isDefined &amp;amp;&amp;amp;&lt;br/&gt;
-      accessesTimeAttribute(remainingPreds.get, join.getRowType)&lt;br/&gt;
+    if (windowBounds.isDefined) {
+      return false
+    }&lt;br/&gt;
 &lt;br/&gt;
-    // Check that no event-time attributes are in the input because non-window join is unbounded&lt;br/&gt;
-    // and we don&apos;t know how much to hold back watermarks.&lt;br/&gt;
+    // Check that no event-time attributes are in the outputs (composed of two inputs)&lt;br/&gt;
+    // because non-window join is unbounded and we don&apos;t know how much to hold back watermarks.&lt;br/&gt;
     val rowTimeAttrInOutput = join.getRowType.getFieldList.asScala&lt;br/&gt;
       .exists(f =&amp;gt; FlinkTypeFactory.isRowtimeIndicatorType(f.getType))&lt;br/&gt;
 &lt;br/&gt;
-    windowBounds.isEmpty &amp;amp;&amp;amp; !remainingPredsAccessTime &amp;amp;&amp;amp; !rowTimeAttrInOutput&lt;br/&gt;
+    if (rowTimeAttrInOutput) {
+      throw new TableException(
+        &quot;Rowtime attributes must not be in the input rows of a regular join. &quot; +
+        &quot;As a workaround you can cast the time attributes of input tables to TIMESTAMP before.&quot;)
+    }&lt;br/&gt;
+    true&lt;br/&gt;
   }&lt;br/&gt;
 &lt;br/&gt;
   override def convert(rel: RelNode): RelNode = {&lt;br/&gt;
diff --git a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/datastream/DataStreamTemporalTableJoinRule.scala b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/datastream/DataStreamTemporalTableJoinRule.scala&lt;br/&gt;
index 94ff19c229d..5bdea53b58a 100644&lt;br/&gt;
&amp;#8212; a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/datastream/DataStreamTemporalTableJoinRule.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/datastream/DataStreamTemporalTableJoinRule.scala&lt;br/&gt;
@@ -22,12 +22,10 @@ import org.apache.calcite.plan.{RelOptRule, RelOptRuleCall, RelTraitSet}
&lt;p&gt; import org.apache.calcite.rel.RelNode&lt;br/&gt;
 import org.apache.calcite.rel.convert.ConverterRule&lt;br/&gt;
 import org.apache.calcite.rel.core.JoinRelType&lt;br/&gt;
-import org.apache.flink.table.api.TableConfig&lt;br/&gt;
 import org.apache.flink.table.plan.nodes.FlinkConventions&lt;br/&gt;
 import org.apache.flink.table.plan.nodes.datastream.DataStreamTemporalTableJoin&lt;br/&gt;
 import org.apache.flink.table.plan.nodes.logical.FlinkLogicalTemporalTableJoin&lt;br/&gt;
 import org.apache.flink.table.plan.schema.RowSchema&lt;br/&gt;
-import org.apache.flink.table.runtime.join.WindowJoinUtil&lt;/p&gt;

&lt;p&gt; class DataStreamTemporalTableJoinRule&lt;br/&gt;
   extends ConverterRule(&lt;br/&gt;
@@ -38,16 +36,7 @@ class DataStreamTemporalTableJoinRule&lt;/p&gt;

&lt;p&gt;   override def matches(call: RelOptRuleCall): Boolean = &lt;/p&gt;
{
     val join: FlinkLogicalTemporalTableJoin = call.rel(0)
-    val joinInfo = join.analyzeCondition
-
-    val (windowBounds, remainingPreds) = WindowJoinUtil.extractWindowBoundsFromPredicate(
-      joinInfo.getRemaining(join.getCluster.getRexBuilder),
-      join.getLeft.getRowType.getFieldCount,
-      join.getRowType,
-      join.getCluster.getRexBuilder,
-      TableConfig.DEFAULT)
-
-    windowBounds.isEmpty &amp;amp;&amp;amp; join.getJoinType == JoinRelType.INNER
+    join.getJoinType == JoinRelType.INNER
   }

&lt;p&gt;   override def convert(rel: RelNode): RelNode = {&lt;br/&gt;
diff --git a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/datastream/DataStreamWindowJoinRule.scala b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/datastream/DataStreamWindowJoinRule.scala&lt;br/&gt;
index 3dfae99a696..cd9c5a86f34 100644&lt;br/&gt;
&amp;#8212; a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/datastream/DataStreamWindowJoinRule.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/datastream/DataStreamWindowJoinRule.scala&lt;br/&gt;
@@ -52,7 +52,7 @@ class DataStreamWindowJoinRule&lt;br/&gt;
       if (windowBounds.get.isEventTime) &lt;/p&gt;
{
         true
       }
&lt;p&gt; else {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// Check that no event-time attributes are in the input because the processing time window&lt;br/&gt;
+        // Check that no event-time attributes are in the output because the processing time window&lt;br/&gt;
         // join does not correctly hold back watermarks.&lt;br/&gt;
         // We rely on projection pushdown to remove unused attributes before the join.&lt;br/&gt;
         !join.getRowType.getFieldList.asScala&lt;br/&gt;
diff --git a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/runtime/join/WindowJoinUtil.scala b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/runtime/join/WindowJoinUtil.scala&lt;br/&gt;
index 18e26df89cc..3e355e800a1 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/runtime/join/WindowJoinUtil.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/runtime/join/WindowJoinUtil.scala&lt;br/&gt;
@@ -23,12 +23,14 @@ import org.apache.calcite.plan.RelOptUtil&lt;br/&gt;
 import org.apache.calcite.rel.`type`.RelDataType&lt;br/&gt;
 import org.apache.calcite.rel.core.JoinRelType&lt;br/&gt;
 import org.apache.calcite.rex._&lt;br/&gt;
-import org.apache.calcite.sql.SqlKind&lt;br/&gt;
+import org.apache.calcite.sql.fun.SqlStdOperatorTable&lt;br/&gt;
+import org.apache.calcite.sql.
{SqlKind, SqlOperatorTable}
&lt;p&gt; import org.apache.flink.api.common.functions.FlatJoinFunction&lt;br/&gt;
 import org.apache.flink.api.common.typeinfo.TypeInformation&lt;br/&gt;
 import org.apache.flink.table.api.TableConfig&lt;br/&gt;
-import org.apache.flink.table.calcite.FlinkTypeFactory&lt;br/&gt;
+import org.apache.flink.table.calcite.&lt;/p&gt;
{FlinkTypeFactory, RelTimeIndicatorConverter}
&lt;p&gt; import org.apache.flink.table.codegen.&lt;/p&gt;
{ExpressionReducer, FunctionCodeGenerator, GeneratedFunction}
&lt;p&gt;+import org.apache.flink.table.functions.sql.ProctimeSqlFunction&lt;br/&gt;
 import org.apache.flink.table.plan.schema.&lt;/p&gt;
{RowSchema, TimeIndicatorRelDataType}
&lt;p&gt; import org.apache.flink.types.Row&lt;/p&gt;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -380,13 +382,13 @@ object WindowJoinUtil {&lt;br/&gt;
       */&lt;br/&gt;
     def replaceTimeFieldWithLiteral(expr: RexNode): RexNode = {&lt;br/&gt;
       expr match &lt;/p&gt;
{
+        case c: RexCall if RelTimeIndicatorConverter.isMaterializationCall(c) =&amp;gt;
+          // replace with timestamp
+          rexBuilder.makeZeroLiteral(expr.getType)
         case c: RexCall =&amp;gt;
           // replace in call operands
           val newOps = c.operands.asScala.map(replaceTimeFieldWithLiteral).asJava
           rexBuilder.makeCall(c.getType, c.getOperator, newOps)
-        case i: RexInputRef if FlinkTypeFactory.isTimeIndicatorType(i.getType) =&amp;gt;
-          // replace with timestamp
-          rexBuilder.makeZeroLiteral(expr.getType)
         case _ =&amp;gt; expr
       }
&lt;p&gt;     }&lt;br/&gt;
diff --git a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/JoinTest.scala b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/JoinTest.scala&lt;br/&gt;
index 736f9a2cad0..37d5bc1ea97 100644&lt;br/&gt;
&amp;#8212; a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/JoinTest.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/JoinTest.scala&lt;br/&gt;
@@ -21,6 +21,7 @@ import org.apache.calcite.rel.logical.LogicalJoin&lt;br/&gt;
 import org.apache.flink.api.scala._&lt;br/&gt;
 import org.apache.flink.table.api.Types&lt;br/&gt;
 import org.apache.flink.table.api.scala._&lt;br/&gt;
+import org.apache.flink.table.calcite.RelTimeIndicatorConverter&lt;br/&gt;
 import org.apache.flink.table.expressions.Null&lt;br/&gt;
 import org.apache.flink.table.plan.logical.TumblingGroupWindow&lt;br/&gt;
 import org.apache.flink.table.runtime.join.WindowJoinUtil&lt;br/&gt;
@@ -29,6 +30,9 @@ import org.apache.flink.table.utils.&lt;/p&gt;
{StreamTableTestUtil, TableTestBase}&lt;br/&gt;
 import org.junit.Assert._&lt;br/&gt;
 import org.junit.Test&lt;br/&gt;
 &lt;br/&gt;
+/**&lt;br/&gt;
+  * Tests for both windowed and non-windowed joins.&lt;br/&gt;
+  */&lt;br/&gt;
 class JoinTest extends TableTestBase {&lt;br/&gt;
   private val streamUtil: StreamTableTestUtil = streamTestUtil()&lt;br/&gt;
   streamUtil.addTable&lt;span class=&quot;error&quot;&gt;&amp;#91;(Int, String, Long)&amp;#93;&lt;/span&gt;(&quot;MyTable&quot;, &apos;a, &apos;b, &apos;c.rowtime, &apos;proctime.proctime)&lt;br/&gt;
@@ -62,8 +66,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             term(&quot;select&quot;, &quot;a&quot;, &quot;b&quot;, &quot;proctime&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
           term(&quot;where&quot;,&lt;br/&gt;
-            &quot;AND(=(a, a0), &amp;gt;=(proctime, -(proctime0, 3600000)), &quot; +&lt;br/&gt;
-              &quot;&amp;lt;=(proctime, +(proctime0, 3600000)))&quot;),&lt;br/&gt;
+            &quot;AND(=(a, a0), &amp;gt;=(PROCTIME(proctime), -(PROCTIME(proctime0), 3600000)), &quot; +&lt;br/&gt;
+              &quot;&amp;lt;=(PROCTIME(proctime), +(PROCTIME(proctime0), 3600000)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a, proctime, a0, b, proctime0&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;InnerJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -100,8 +104,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             term(&quot;select&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
           term(&quot;where&quot;,&lt;br/&gt;
-            &quot;AND(=(a, a0), &amp;gt;=(c, -(c0, 10000)), &quot; +&lt;br/&gt;
-              &quot;&amp;lt;=(c, +(c0, 3600000)))&quot;),&lt;br/&gt;
+            &quot;AND(=(a, a0), &amp;gt;=(CAST(c), -(CAST(c0), 10000)), &quot; +&lt;br/&gt;
+              &quot;&amp;lt;=(CAST(c), +(CAST(c0), 3600000)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a, c, a0, b, c0&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;InnerJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -138,8 +142,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             term(&quot;select&quot;, &quot;a&quot;, &quot;b&quot;, &quot;proctime&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
           term(&quot;where&quot;,&lt;br/&gt;
-            &quot;AND(=(a, a0), &amp;gt;=(proctime, -(proctime0, 3600000)), &quot; +&lt;br/&gt;
-              &quot;&amp;lt;=(proctime, +(proctime0, 3600000)))&quot;),&lt;br/&gt;
+            &quot;AND(=(a, a0), &amp;gt;=(PROCTIME(proctime), -(PROCTIME(proctime0), 3600000)), &quot; +&lt;br/&gt;
+              &quot;&amp;lt;=(PROCTIME(proctime), +(PROCTIME(proctime0), 3600000)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a, proctime, a0, b, proctime0&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;InnerJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -176,8 +180,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             term(&quot;select&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
           term(&quot;where&quot;,&lt;br/&gt;
-            &quot;AND(=(a, a0), &amp;gt;=(c, -(c0, 600000)), &quot; +&lt;br/&gt;
-              &quot;&amp;lt;=(c, +(c0, 3600000)))&quot;),&lt;br/&gt;
+            &quot;AND(=(a, a0), &amp;gt;=(CAST(c), -(CAST(c0), 600000)), &quot; +&lt;br/&gt;
+              &quot;&amp;lt;=(CAST(c), +(CAST(c0), 3600000)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a, c, a0, b, c0&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;InnerJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -208,7 +212,7 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             streamTableNode(1),&lt;br/&gt;
             term(&quot;select&quot;, &quot;a&quot;, &quot;b&quot;, &quot;proctime&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
-          term(&quot;where&quot;, &quot;AND(=(a, a0), =(proctime, proctime0))&quot;),&lt;br/&gt;
+          term(&quot;where&quot;, &quot;AND(=(a, a0), =(PROCTIME(proctime), PROCTIME(proctime0)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a&quot;, &quot;proctime&quot;, &quot;a0&quot;, &quot;b&quot;, &quot;proctime0&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;InnerJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -238,7 +242,7 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             streamTableNode(1),&lt;br/&gt;
             term(&quot;select&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
-          term(&quot;where&quot;, &quot;AND(=(a, a0), =(c, c0))&quot;),&lt;br/&gt;
+          term(&quot;where&quot;, &quot;AND(=(a, a0), =(CAST(c), CAST(c0)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a&quot;, &quot;c&quot;, &quot;a0&quot;, &quot;b&quot;, &quot;c0&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;InnerJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -280,8 +284,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             streamTableNode(1),&lt;br/&gt;
             term(&quot;select&quot;, &quot;a&quot;, &quot;c&quot;, &quot;proctime&quot;, &quot;12 AS nullField&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
-          term(&quot;where&quot;, &quot;AND(=(a, a0), =(nullField, nullField0), &amp;gt;=(proctime, &quot; +&lt;br/&gt;
-            &quot;-(proctime0, 5000)), &amp;lt;=(proctime, +(proctime0, 5000)))&quot;),&lt;br/&gt;
+          term(&quot;where&quot;, &quot;AND(=(a, a0), =(nullField, nullField0), &amp;gt;=(PROCTIME(proctime), &quot; +&lt;br/&gt;
+            &quot;-(PROCTIME(proctime0), 5000)), &amp;lt;=(PROCTIME(proctime), +(PROCTIME(proctime0), 5000)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a&quot;, &quot;c&quot;, &quot;proctime&quot;, &quot;nullField&quot;, &quot;a0&quot;, &quot;c0&quot;, &quot;proctime0&quot;, &quot;nullField0&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;InnerJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -320,8 +324,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
               term(&quot;select&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;)&lt;br/&gt;
             ),&lt;br/&gt;
             term(&quot;where&quot;,&lt;br/&gt;
-              &quot;AND(=(a, a0), &amp;gt;=(c, -(c0, 600000)), &quot; +&lt;br/&gt;
-                &quot;&amp;lt;=(c, +(c0, 3600000)))&quot;),&lt;br/&gt;
+              &quot;AND(=(a, a0), &amp;gt;=(CAST(c), -(CAST(c0), 600000)), &quot; +&lt;br/&gt;
+                &quot;&amp;lt;=(CAST(c), +(CAST(c0), 3600000)))&quot;),&lt;br/&gt;
             term(&quot;join&quot;, &quot;a, b, c, a0, b0, c0&quot;),&lt;br/&gt;
             term(&quot;joinType&quot;, &quot;InnerJoin&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
@@ -365,8 +369,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
               term(&quot;select&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;)&lt;br/&gt;
             ),&lt;br/&gt;
             term(&quot;where&quot;,&lt;br/&gt;
-              &quot;AND(=(a, a0), &amp;gt;=(c, -(c0, 600000)), &quot; +&lt;br/&gt;
-                &quot;&amp;lt;=(c, +(c0, 3600000)))&quot;),&lt;br/&gt;
+              &quot;AND(=(a, a0), &amp;gt;=(CAST(c), -(CAST(c0), 600000)), &quot; +&lt;br/&gt;
+                &quot;&amp;lt;=(CAST(c), +(CAST(c0), 3600000)))&quot;),&lt;br/&gt;
             term(&quot;join&quot;, &quot;a, b, c, a0, b0, c0&quot;),&lt;br/&gt;
             term(&quot;joinType&quot;, &quot;InnerJoin&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
@@ -408,8 +412,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             term(&quot;select&quot;, &quot;a&quot;, &quot;b&quot;, &quot;proctime&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
           term(&quot;where&quot;,&lt;br/&gt;
-            &quot;AND(=(a, a0), &amp;gt;=(proctime, -(proctime0, 3600000)), &quot; +&lt;br/&gt;
-              &quot;&amp;lt;=(proctime, +(proctime0, 3600000)))&quot;),&lt;br/&gt;
+            &quot;AND(=(a, a0), &amp;gt;=(PROCTIME(proctime), -(PROCTIME(proctime0), 3600000)), &quot; +&lt;br/&gt;
+              &quot;&amp;lt;=(PROCTIME(proctime), +(PROCTIME(proctime0), 3600000)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a, proctime, a0, b, proctime0&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;LeftOuterJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -446,8 +450,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             term(&quot;select&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
           term(&quot;where&quot;,&lt;br/&gt;
-            &quot;AND(=(a, a0), &amp;gt;=(c, -(c0, 10000)), &quot; +&lt;br/&gt;
-              &quot;&amp;lt;=(c, +(c0, 3600000)))&quot;),&lt;br/&gt;
+            &quot;AND(=(a, a0), &amp;gt;=(CAST(c), -(CAST(c0), 10000)), &quot; +&lt;br/&gt;
+              &quot;&amp;lt;=(CAST(c), +(CAST(c0), 3600000)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a, c, a0, b, c0&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;LeftOuterJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -485,8 +489,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             term(&quot;select&quot;, &quot;a&quot;, &quot;b&quot;, &quot;proctime&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
           term(&quot;where&quot;,&lt;br/&gt;
-            &quot;AND(=(a, a0), &amp;gt;=(proctime, -(proctime0, 3600000)), &quot; +&lt;br/&gt;
-              &quot;&amp;lt;=(proctime, +(proctime0, 3600000)))&quot;),&lt;br/&gt;
+            &quot;AND(=(a, a0), &amp;gt;=(PROCTIME(proctime), -(PROCTIME(proctime0), 3600000)), &quot; +&lt;br/&gt;
+              &quot;&amp;lt;=(PROCTIME(proctime), +(PROCTIME(proctime0), 3600000)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a, proctime, a0, b, proctime0&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;RightOuterJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -523,8 +527,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             term(&quot;select&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
           term(&quot;where&quot;,&lt;br/&gt;
-            &quot;AND(=(a, a0), &amp;gt;=(c, -(c0, 10000)), &quot; +&lt;br/&gt;
-              &quot;&amp;lt;=(c, +(c0, 3600000)))&quot;),&lt;br/&gt;
+            &quot;AND(=(a, a0), &amp;gt;=(CAST(c), -(CAST(c0), 10000)), &quot; +&lt;br/&gt;
+              &quot;&amp;lt;=(CAST(c), +(CAST(c0), 3600000)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a, c, a0, b, c0&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;RightOuterJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -562,8 +566,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             term(&quot;select&quot;, &quot;a&quot;, &quot;b&quot;, &quot;proctime&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
           term(&quot;where&quot;,&lt;br/&gt;
-            &quot;AND(=(a, a0), &amp;gt;=(proctime, -(proctime0, 3600000)), &quot; +&lt;br/&gt;
-              &quot;&amp;lt;=(proctime, +(proctime0, 3600000)))&quot;),&lt;br/&gt;
+            &quot;AND(=(a, a0), &amp;gt;=(PROCTIME(proctime), -(PROCTIME(proctime0), 3600000)), &quot; +&lt;br/&gt;
+              &quot;&amp;lt;=(PROCTIME(proctime), +(PROCTIME(proctime0), 3600000)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a, proctime, a0, b, proctime0&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;FullOuterJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -600,8 +604,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             term(&quot;select&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
           term(&quot;where&quot;,&lt;br/&gt;
-            &quot;AND(=(a, a0), &amp;gt;=(c, -(c0, 10000)), &quot; +&lt;br/&gt;
-              &quot;&amp;lt;=(c, +(c0, 3600000)))&quot;),&lt;br/&gt;
+            &quot;AND(=(a, a0), &amp;gt;=(CAST(c), -(CAST(c0), 10000)), &quot; +&lt;br/&gt;
+              &quot;&amp;lt;=(CAST(c), +(CAST(c0), 3600000)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a, c, a0, b, c0&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;FullOuterJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -640,8 +644,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             term(&quot;select&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
           term(&quot;where&quot;,&lt;br/&gt;
-            &quot;AND(=(a, a0), &amp;gt;=(c, -(c0, 10000)), &quot; +&lt;br/&gt;
-              &quot;&amp;lt;=(c, +(c0, 3600000)), LIKE(b, b0))&quot;),&lt;br/&gt;
+            &quot;AND(=(a, a0), &amp;gt;=(CAST(c), -(CAST(c0), 10000)), &quot; +&lt;br/&gt;
+              &quot;&amp;lt;=(CAST(c), +(CAST(c0), 3600000)), LIKE(b, b0))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a, b, c, a0, b0, c0&quot;),&lt;br/&gt;
           // Since we filter on attributes b and b0 after the join, the full outer join&lt;br/&gt;
           // will be automatically optimized to inner join.&lt;br/&gt;
@@ -786,33 +790,6 @@ class JoinTest extends TableTestBase {
       &quot;AND(=($0, $4), &amp;gt;($2, $6))&quot;)
   }&lt;br/&gt;
 &lt;br/&gt;
-  private def verifyTimeBoundary(&lt;br/&gt;
-      timeSql: String,&lt;br/&gt;
-      expLeftSize: Long,&lt;br/&gt;
-      expRightSize: Long,&lt;br/&gt;
-      expTimeType: String): Unit = {
-    val query =
-      &quot;SELECT t1.a, t2.b FROM MyTable as t1 join MyTable2 as t2 on t1.a = t2.a and &quot; + timeSql
-
-    val resultTable = streamUtil.tableEnv.sqlQuery(query)
-    val relNode = resultTable.getRelNode
-    val joinNode = relNode.getInput(0).asInstanceOf[LogicalJoin]
-    val (windowBounds, _) =
-      WindowJoinUtil.extractWindowBoundsFromPredicate(
-        joinNode.getCondition,
-        4,
-        joinNode.getRowType,
-        joinNode.getCluster.getRexBuilder,
-        streamUtil.tableEnv.getConfig)
-
-    val timeTypeStr =
-      if (windowBounds.get.isEventTime) &quot;rowtime&quot;
-      else  &quot;proctime&quot;
-    assertEquals(expLeftSize, windowBounds.get.leftLowerBound)
-    assertEquals(expRightSize, windowBounds.get.leftUpperBound)
-    assertEquals(expTimeType, timeTypeStr)
-  }&lt;br/&gt;
-&lt;br/&gt;
   @Test&lt;br/&gt;
   def testLeftOuterJoinEquiPred(): Unit = {&lt;br/&gt;
     val util = streamTestUtil()&lt;br/&gt;
@@ -1003,12 +980,43 @@ class JoinTest extends TableTestBase {
     util.verifyTable(result, expected)
   }&lt;br/&gt;
 &lt;br/&gt;
+  private def verifyTimeBoundary(&lt;br/&gt;
+      timeSql: String,&lt;br/&gt;
+      expLeftSize: Long,&lt;br/&gt;
+      expRightSize: Long,&lt;br/&gt;
+      expTimeType: String): Unit = {
+    val query =
+      &quot;SELECT t1.a, t2.b FROM MyTable as t1 join MyTable2 as t2 on t1.a = t2.a and &quot; + timeSql
+
+    val resultTable = streamUtil.tableEnv.sqlQuery(query)
+    val relNode = RelTimeIndicatorConverter.convert(
+      resultTable.getRelNode,
+      streamUtil.tableEnv.getRelBuilder.getRexBuilder)
+    val joinNode = relNode.getInput(0).asInstanceOf[LogicalJoin]
+    val (windowBounds, _) =
+      WindowJoinUtil.extractWindowBoundsFromPredicate(
+        joinNode.getCondition,
+        4,
+        joinNode.getRowType,
+        joinNode.getCluster.getRexBuilder,
+        streamUtil.tableEnv.getConfig)
+
+    val timeTypeStr =
+      if (windowBounds.get.isEventTime) &quot;rowtime&quot;
+      else  &quot;proctime&quot;
+    assertEquals(expLeftSize, windowBounds.get.leftLowerBound)
+    assertEquals(expRightSize, windowBounds.get.leftUpperBound)
+    assertEquals(expTimeType, timeTypeStr)
+  }&lt;br/&gt;
+&lt;br/&gt;
   private def verifyRemainConditionConvert(&lt;br/&gt;
       query: String,&lt;br/&gt;
       expectCondStr: String): Unit = {&lt;br/&gt;
 &lt;br/&gt;
     val resultTable = streamUtil.tableEnv.sqlQuery(query)&lt;br/&gt;
-    val relNode = resultTable.getRelNode&lt;br/&gt;
+    val relNode = RelTimeIndicatorConverter.convert(&lt;br/&gt;
+      resultTable.getRelNode,&lt;br/&gt;
+      streamUtil.tableEnv.getRelBuilder.getRexBuilder)&lt;br/&gt;
     val joinNode = relNode.getInput(0).asInstanceOf&lt;span class=&quot;error&quot;&gt;&amp;#91;LogicalJoin&amp;#93;&lt;/span&gt;&lt;br/&gt;
     val (_, remainCondition) =&lt;br/&gt;
       WindowJoinUtil.extractWindowBoundsFromPredicate(&lt;br/&gt;
diff --git a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/validation/JoinValidationTest.scala b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/validation/JoinValidationTest.scala&lt;br/&gt;
index 141c8173ea0..2a994f31a2c 100644&lt;br/&gt;
&amp;#8212; a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/validation/JoinValidationTest.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/validation/JoinValidationTest.scala&lt;br/&gt;
@@ -19,8 +19,8 @@&lt;br/&gt;
 package org.apache.flink.table.api.stream.sql.validation&lt;br/&gt;
 &lt;br/&gt;
 import org.apache.flink.api.scala._&lt;br/&gt;
-import org.apache.flink.table.api.scala._&lt;br/&gt;
 import org.apache.flink.table.api.TableException&lt;br/&gt;
+import org.apache.flink.table.api.scala._&lt;br/&gt;
 import org.apache.flink.table.utils.{StreamTableTestUtil, TableTestBase}
&lt;p&gt; import org.junit.Test&lt;/p&gt;

&lt;p&gt;@@ -30,18 +30,6 @@ class JoinValidationTest extends TableTestBase {&lt;br/&gt;
   streamUtil.addTable&lt;span class=&quot;error&quot;&gt;&amp;#91;(Int, String, Long)&amp;#93;&lt;/span&gt;(&quot;MyTable&quot;, &apos;a, &apos;b, &apos;c.rowtime, &apos;proctime.proctime)&lt;br/&gt;
   streamUtil.addTable&lt;span class=&quot;error&quot;&gt;&amp;#91;(Int, String, Long)&amp;#93;&lt;/span&gt;(&quot;MyTable2&quot;, &apos;a, &apos;b, &apos;c.rowtime, &apos;proctime.proctime)&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/** There should exist exactly two time conditions **/&lt;/li&gt;
	&lt;li&gt;@Test(expected = classOf&lt;span class=&quot;error&quot;&gt;&amp;#91;TableException&amp;#93;&lt;/span&gt;)&lt;/li&gt;
	&lt;li&gt;def testWindowJoinSingleTimeCondition() = 
{
-    val sql =
-      &quot;&quot;&quot;
-        |SELECT t2.a
-        |FROM MyTable t1 JOIN MyTable2 t2 ON
-        |  t1.a = t2.a AND
-        |  t1.proctime &amp;gt; t2.proctime - INTERVAL &apos;5&apos; SECOND&quot;&quot;&quot;.stripMargin
-    streamUtil.verifySql(sql, &quot;n/a&quot;)
-  }
&lt;p&gt;-&lt;br/&gt;
   /** Both time attributes in a join condition must be of the same type **/&lt;br/&gt;
   @Test(expected = classOf&lt;span class=&quot;error&quot;&gt;&amp;#91;TableException&amp;#93;&lt;/span&gt;)&lt;br/&gt;
   def testWindowJoinDiffTimeIndicator() = &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {@@ -136,4 +124,78 @@ class JoinValidationTest extends TableTestBase {
 
     streamUtil.verifySql(sql, &quot;n/a&quot;)
   }++  /** Rowtime attributes cannot be accessed in filter conditions yet. */+  @Test+  def testJoinWithRowtimeCondition()}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;diff --git a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/table/JoinTest.scala b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/table/JoinTest.scala&lt;br/&gt;
index d7f5c715815..138497cada3 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/table/JoinTest.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/table/JoinTest.scala&lt;br/&gt;
@@ -27,7 +27,7 @@ import org.apache.flink.table.utils.TableTestUtil._&lt;br/&gt;
 import org.junit.Test&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; /**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Currently only time-windowed joins can be processed in a streaming fashion.&lt;br/&gt;
+  * Tests for both windowed and non-windowed joins.&lt;br/&gt;
   */&lt;br/&gt;
 class JoinTest extends TableTestBase {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -57,8 +57,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             streamTableNode(1),&lt;br/&gt;
             term(&quot;select&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rrtime&quot;)&lt;br/&gt;
           ),&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(lrtime, -(rrtime, 300000)),&quot; +&lt;/li&gt;
	&lt;li&gt;&quot; &amp;lt;(lrtime, +(rrtime, 3000)))&quot;),&lt;br/&gt;
+          term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(CAST(lrtime), -(CAST(rrtime), 300000)),&quot; +&lt;br/&gt;
+            &quot; &amp;lt;(CAST(lrtime), +(CAST(rrtime), 3000)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a&quot;, &quot;lrtime&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rrtime&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;InnerJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -92,7 +92,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             streamTableNode(1),&lt;br/&gt;
             term(&quot;select&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rptime&quot;)&lt;br/&gt;
           ),&lt;/li&gt;
	&lt;li&gt;term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(lptime, -(rptime, 1000)), &amp;lt;(lptime, rptime))&quot;),&lt;br/&gt;
+          term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(PROCTIME(lptime), -(PROCTIME(rptime), 1000)), &quot; +&lt;br/&gt;
+            &quot;&amp;lt;(PROCTIME(lptime), PROCTIME(rptime)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a&quot;, &quot;lptime&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rptime&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;InnerJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -126,7 +127,7 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             streamTableNode(1),&lt;br/&gt;
             term(&quot;select&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rptime&quot;)&lt;br/&gt;
           ),&lt;/li&gt;
	&lt;li&gt;term(&quot;where&quot;, &quot;AND(=(a, d), =(lptime, rptime))&quot;),&lt;br/&gt;
+          term(&quot;where&quot;, &quot;AND(=(a, d), =(PROCTIME(lptime), PROCTIME(rptime)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a&quot;, &quot;lptime&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rptime&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;InnerJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -153,7 +154,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
         streamTableNode(0),&lt;br/&gt;
         streamTableNode(1),&lt;br/&gt;
         term(&quot;where&quot;,&lt;/li&gt;
	&lt;li&gt;&quot;AND(=(a, d), &amp;gt;=(lrtime, -(rrtime, 300000)), &amp;lt;(lrtime, rrtime), &amp;gt;(lrtime, &quot; + &quot;f))&quot;),&lt;br/&gt;
+          &quot;AND(=(a, d), &amp;gt;=(CAST(lrtime), -(CAST(rrtime), 300000)), &quot; +&lt;br/&gt;
+            &quot;&amp;lt;(CAST(lrtime), CAST(rrtime)), &amp;gt;(CAST(lrtime), f))&quot;),&lt;br/&gt;
         term(&quot;join&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;lrtime&quot;, &quot;d&quot;, &quot;e&quot;, &quot;f&quot;, &quot;rrtime&quot;),&lt;br/&gt;
         term(&quot;joinType&quot;, &quot;InnerJoin&quot;)&lt;br/&gt;
       )&lt;br/&gt;
@@ -188,8 +190,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             streamTableNode(1),&lt;br/&gt;
             term(&quot;select&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rrtime&quot;)&lt;br/&gt;
           ),&lt;/li&gt;
	&lt;li&gt;term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(lrtime, -(rrtime, 300000)),&quot; +&lt;/li&gt;
	&lt;li&gt;&quot; &amp;lt;(lrtime, +(rrtime, 3000)))&quot;),&lt;br/&gt;
+          term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(CAST(lrtime), -(CAST(rrtime), 300000)),&quot; +&lt;br/&gt;
+            &quot; &amp;lt;(CAST(lrtime), +(CAST(rrtime), 3000)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a&quot;, &quot;lrtime&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rrtime&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;LeftOuterJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -223,7 +225,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             streamTableNode(1),&lt;br/&gt;
             term(&quot;select&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rptime&quot;)&lt;br/&gt;
           ),&lt;/li&gt;
	&lt;li&gt;term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(lptime, -(rptime, 1000)), &amp;lt;(lptime, rptime))&quot;),&lt;br/&gt;
+          term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(PROCTIME(lptime), -(PROCTIME(rptime), 1000)), &quot; +&lt;br/&gt;
+            &quot;&amp;lt;(PROCTIME(lptime), PROCTIME(rptime)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a&quot;, &quot;lptime&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rptime&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;LeftOuterJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -260,8 +263,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             streamTableNode(1),&lt;br/&gt;
             term(&quot;select&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rrtime&quot;)&lt;br/&gt;
           ),&lt;/li&gt;
	&lt;li&gt;term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(lrtime, -(rrtime, 300000)),&quot; +&lt;/li&gt;
	&lt;li&gt;&quot; &amp;lt;(lrtime, +(rrtime, 3000)))&quot;),&lt;br/&gt;
+          term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(CAST(lrtime), -(CAST(rrtime), 300000)),&quot; +&lt;br/&gt;
+            &quot; &amp;lt;(CAST(lrtime), +(CAST(rrtime), 3000)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a&quot;, &quot;lrtime&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rrtime&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;RightOuterJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -295,7 +298,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             streamTableNode(1),&lt;br/&gt;
             term(&quot;select&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rptime&quot;)&lt;br/&gt;
           ),&lt;/li&gt;
	&lt;li&gt;term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(lptime, -(rptime, 1000)), &amp;lt;(lptime, rptime))&quot;),&lt;br/&gt;
+          term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(PROCTIME(lptime), -(PROCTIME(rptime), 1000)), &quot; +&lt;br/&gt;
+            &quot;&amp;lt;(PROCTIME(lptime), PROCTIME(rptime)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a&quot;, &quot;lptime&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rptime&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;RightOuterJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -332,8 +336,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             streamTableNode(1),&lt;br/&gt;
             term(&quot;select&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rrtime&quot;)&lt;br/&gt;
           ),&lt;/li&gt;
	&lt;li&gt;term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(lrtime, -(rrtime, 300000)),&quot; +&lt;/li&gt;
	&lt;li&gt;&quot; &amp;lt;(lrtime, +(rrtime, 3000)))&quot;),&lt;br/&gt;
+          term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(CAST(lrtime), -(CAST(rrtime), 300000)),&quot; +&lt;br/&gt;
+            &quot; &amp;lt;(CAST(lrtime), +(CAST(rrtime), 3000)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a&quot;, &quot;lrtime&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rrtime&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;FullOuterJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -367,7 +371,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             streamTableNode(1),&lt;br/&gt;
             term(&quot;select&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rptime&quot;)&lt;br/&gt;
           ),&lt;/li&gt;
	&lt;li&gt;term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(lptime, -(rptime, 1000)), &amp;lt;(lptime, rptime))&quot;),&lt;br/&gt;
+          term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(PROCTIME(lptime), -(PROCTIME(rptime), 1000)), &quot; +&lt;br/&gt;
+            &quot;&amp;lt;(PROCTIME(lptime), PROCTIME(rptime)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a&quot;, &quot;lptime&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rptime&quot;),&lt;br/&gt;
           term(&quot;joinType&quot;, &quot;FullOuterJoin&quot;)&lt;br/&gt;
         ),&lt;br/&gt;
@@ -402,8 +407,8 @@ class JoinTest extends TableTestBase {&lt;br/&gt;
             streamTableNode(1),&lt;br/&gt;
             term(&quot;select&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rrtime&quot;)&lt;br/&gt;
           ),&lt;/li&gt;
	&lt;li&gt;term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(lrtime, -(rrtime, 300000)),&quot; +&lt;/li&gt;
	&lt;li&gt;&quot; &amp;lt;(lrtime, +(rrtime, 3000)))&quot;),&lt;br/&gt;
+          term(&quot;where&quot;, &quot;AND(=(a, d), &amp;gt;=(CAST(lrtime), -(CAST(rrtime), 300000)),&quot; +&lt;br/&gt;
+            &quot; &amp;lt;(CAST(lrtime), +(CAST(rrtime), 3000)))&quot;),&lt;br/&gt;
           term(&quot;join&quot;, &quot;a&quot;, &quot;lrtime&quot;, &quot;d&quot;, &quot;e&quot;, &quot;rrtime&quot;),&lt;br/&gt;
           // Since we filter on attributes of the left table after the join, the left outer join&lt;br/&gt;
           // will be automatically optimized to inner join.&lt;br/&gt;
diff --git a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/plan/TimeIndicatorConversionTest.scala b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/plan/TimeIndicatorConversionTest.scala&lt;br/&gt;
index 17061692153..29dda21f932 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/plan/TimeIndicatorConversionTest.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/plan/TimeIndicatorConversionTest.scala&lt;br/&gt;
@@ -85,7 +85,7 @@ class TimeIndicatorConversionTest extends TableTestBase {&lt;br/&gt;
       &quot;DataStreamCalc&quot;,&lt;br/&gt;
       streamTableNode(0),&lt;br/&gt;
       term(&quot;select&quot;, &quot;rowtime&quot;),&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;term(&quot;where&quot;, &quot;&amp;gt;(rowtime, 1990-12-02 12:11:11)&quot;)&lt;br/&gt;
+      term(&quot;where&quot;, &quot;&amp;gt;(CAST(rowtime), 1990-12-02 12:11:11)&quot;)&lt;br/&gt;
     )&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     util.verifyTable(result, expected)&lt;br/&gt;
diff --git a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/stream/TimeAttributesITCase.scala b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/stream/TimeAttributesITCase.scala&lt;br/&gt;
index 304dbb317f3..1706fc8a112 100644&lt;br/&gt;
&amp;#8212; a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/stream/TimeAttributesITCase.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/stream/TimeAttributesITCase.scala&lt;br/&gt;
@@ -20,6 +20,7 @@ package org.apache.flink.table.runtime.stream&lt;/p&gt;

&lt;p&gt; import java.lang.&lt;/p&gt;
{Integer =&amp;gt; JInt, Long =&amp;gt; JLong}
&lt;p&gt; import java.math.BigDecimal&lt;br/&gt;
+import java.sql.Timestamp&lt;/p&gt;

&lt;p&gt; import org.apache.flink.api.common.typeinfo.TypeInformation&lt;br/&gt;
 import org.apache.flink.api.java.typeutils.RowTypeInfo&lt;br/&gt;
@@ -661,6 +662,51 @@ class TimeAttributesITCase extends AbstractTestBase &lt;/p&gt;
{
     )
     assertEquals(expected.sorted, StreamITCase.testResults.sorted)
   }
&lt;p&gt;+&lt;br/&gt;
+  @Test&lt;br/&gt;
+  def testMaterializedRowtimeFilter(): Unit = &lt;/p&gt;
{
+    val env = StreamExecutionEnvironment.getExecutionEnvironment
+    env.setParallelism(1)
+    env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)
+    val tEnv = TableEnvironment.getTableEnvironment(env)
+    StreamITCase.clear
+
+    val data = new mutable.MutableList[(String, Timestamp, Int)]
+    data.+=((&quot;ACME&quot;, new Timestamp(1000L), 12))
+    data.+=((&quot;ACME&quot;, new Timestamp(2000L), 17))
+    data.+=((&quot;ACME&quot;, new Timestamp(3000L), 13))
+    data.+=((&quot;ACME&quot;, new Timestamp(4000L), 11))
+
+    val t = env.fromCollection(data)
+      .assignAscendingTimestamps(e =&amp;gt; e._2.toInstant.toEpochMilli)
+      .toTable(tEnv, &apos;symbol, &apos;tstamp.rowtime, &apos;price)
+    tEnv.registerTable(&quot;Ticker&quot;, t)
+
+    val sqlQuery =
+      s&quot;&quot;&quot;
+         |SELECT *
+         |FROM (
+         |   SELECT symbol, SUM(price) as price,
+         |     TUMBLE_ROWTIME(tstamp, interval &apos;1&apos; second) as rowTime,
+         |     TUMBLE_START(tstamp, interval &apos;1&apos; second) as startTime,
+         |     TUMBLE_END(tstamp, interval &apos;1&apos; second) as endTime
+         |   FROM Ticker
+         |   GROUP BY symbol, TUMBLE(tstamp, interval &apos;1&apos; second)
+         |)
+         |WHERE startTime &amp;lt; endTime
+         |&quot;&quot;&quot;.stripMargin
+
+    val result = tEnv.sqlQuery(sqlQuery).toAppendStream[Row]
+    result.addSink(new StreamITCase.StringSink[Row])
+    env.execute()
+
+    val expected = List(
+      &quot;ACME,12,1970-01-01 00:00:01.999,1970-01-01 00:00:01.0,1970-01-01 00:00:02.0&quot;,
+      &quot;ACME,17,1970-01-01 00:00:02.999,1970-01-01 00:00:02.0,1970-01-01 00:00:03.0&quot;,
+      &quot;ACME,13,1970-01-01 00:00:03.999,1970-01-01 00:00:03.0,1970-01-01 00:00:04.0&quot;,
+      &quot;ACME,11,1970-01-01 00:00:04.999,1970-01-01 00:00:04.0,1970-01-01 00:00:05.0&quot;)
+    assertEquals(expected.sorted, StreamITCase.testResults.sorted)
+  }
&lt;p&gt; }&lt;/p&gt;

&lt;p&gt; object TimeAttributesITCase {&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13180970">FLINK-10210</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13180971">FLINK-10211</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 2 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3r1vj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>