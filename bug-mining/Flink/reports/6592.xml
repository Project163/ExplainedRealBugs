<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:11:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-28861] Non-deterministic UID generation might cause issues during restore</title>
                <link>https://issues.apache.org/jira/browse/FLINK-28861</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I want to use the savepoint mechanism to move existing jobs from one version of Flink to another, by:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Stopping a job with a savepoint&lt;/li&gt;
	&lt;li&gt;Creating a new job from the savepoint, on the new version.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;In Flink 1.15.1, it fails, even when going from 1.15.1 to 1.15.1. I get this error, meaning that it could not map the state from the previous job to the new one because of one operator:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;tt&gt;Failed to rollback to checkpoint/savepoint hdfs://hdfs-name:8020/flink-savepoints/savepoint-046708-238e921f5e78. Cannot map checkpoint/savepoint state for operator d14a399e92154660771a806b90515d4c to the new program, because the operator is not available in the new program.&lt;/tt&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;After investigation, the problematic operator corresponds to a &lt;tt&gt;ChangelogNormalize&lt;/tt&gt; operator, that I do not explicitly create. It is generated because I use &lt;a href=&quot;https://nightlies.apache.org/flink/flink-docs-release-1.15/api/java/org/apache/flink/table/api/bridge/java/StreamTableEnvironment.html#fromChangelogStream-org.apache.flink.streaming.api.datastream.DataStream-org.apache.flink.table.api.Schema-org.apache.flink.table.connector.ChangelogMode-&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;tableEnv.fromChangelogStream(stream, schema, ChangelogMode.upsert())&lt;/tt&gt;&lt;/a&gt; (the upsert mode is important, other modes do not fail). The table created is passed to an SQL query using the SQL API, which generates something like:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;tt&gt;ChangelogNormalize&lt;span class=&quot;error&quot;&gt;&amp;#91;8&amp;#93;&lt;/span&gt; -&amp;gt; Calc&lt;span class=&quot;error&quot;&gt;&amp;#91;9&amp;#93;&lt;/span&gt; -&amp;gt; TableToDataSteam -&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;my_sql_transformation&amp;#93;&lt;/span&gt; -&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;my_sink&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;In previous versions of Flink it seems this operator was always given the same uid so the state could match when starting from the savepoint. In Flink 1.15.1, I see that a different uid is generated every time. I could not find a reliable way to set that uid manually. The only way I found was by going backwards from the transformation:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;tt&gt;dataStream.getTransformation().getInputs().get(0).getInputs().get(0).getInputs().get(0).setUid(&quot;the_user_defined_id&quot;);&lt;/tt&gt;&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
        <key id="13475673">FLINK-28861</key>
            <summary>Non-deterministic UID generation might cause issues during restore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="twalthr">Timo Walther</assignee>
                                    <reporter username="colinsmetz">Colin Smetz</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 8 Aug 2022 07:11:46 +0000</created>
                <updated>Wed, 17 Aug 2022 07:55:05 +0000</updated>
                            <resolved>Tue, 16 Aug 2022 07:41:06 +0000</resolved>
                                    <version>1.15.1</version>
                                    <fixVersion>1.16.0</fixVersion>
                    <fixVersion>1.15.2</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17576645" author="twalthr" created="Mon, 8 Aug 2022 08:51:36 +0000"  >&lt;p&gt;This is clearly a bug that needs investigation. We introduced stable UIDs for all operators that the planner ingests. The default before was to set no UIDs at all, which resulted in autogenerated UIDs based on the topology and previous operators. &lt;/p&gt;</comment>
                            <comment id="17576770" author="twalthr" created="Mon, 8 Aug 2022 13:24:50 +0000"  >&lt;p&gt;After looking into this topic, I have a first guess what the problem might be. Could you share the UID of the affected operator with us after multiple tries? There might be a bug in the design. A UID is currently set as &lt;tt&gt;1_stream-exec-table-source-scan_1_external-datastream&lt;/tt&gt;, however, the first component is generated by an &lt;tt&gt;AtomicCounter&lt;/tt&gt; that is started per JVM. Which means that multiple runs of the same main() in the same JVM might generated different UIDs. How do you submit your jobs?&lt;/p&gt;

&lt;p&gt;In any case, there is a workaround, you can set &lt;tt&gt;table.exec.legacy-transformation-uids&lt;/tt&gt; to &lt;tt&gt;true&lt;/tt&gt;. Let me know if this solves your problem for 1.15 upgrades or simple pipelines from previous versions? However, keep in mind that we don&apos;t support stateful upgrades between Flink versions for Flink SQL yet. &lt;a href=&quot;https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=191336489&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FLIP-190&lt;/a&gt; aims to fix this.&lt;/p&gt;</comment>
                            <comment id="17576791" author="colinsmetz" created="Mon, 8 Aug 2022 14:07:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;Could you share the UID of the affected operator with us after multiple tries?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I only have what seems to be a hash of the uid (obtained via &lt;a href=&quot;https://nightlies.apache.org/flink/flink-docs-release-1.12/api/java/org/apache/flink/runtime/OperatorIDPair.html#getGeneratedOperatorID--&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;getGeneratedOperatorID&lt;/a&gt;), but here&apos;s what I get for three successive submissions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;3c217b755850a1fb331af4b7f67946f5&lt;/li&gt;
	&lt;li&gt;2ea21244917b900c533f89ff25291e8d&lt;/li&gt;
	&lt;li&gt;48f2f08e9f1663064e1369bd518990a1&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Does that help?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;How do you submit your jobs?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;When we first noticed the problem, we were submitting the job with the REST API (POST /jars/:jarid/run). But we&apos;ve since reproduced it in our tests using [PackagedProgramUtils.createJobGraph|&lt;a href=&quot;https://nightlies.apache.org/flink/flink-docs-release-1.15/api/java/org/apache/flink/client/program/PackagedProgramUtils.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://nightlies.apache.org/flink/flink-docs-release-1.15/api/java/org/apache/flink/client/program/PackagedProgramUtils.html&lt;/a&gt;]&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;In any case, there is a workaround, you can set &lt;tt&gt;table.exec.legacy-transformation-uids&lt;/tt&gt; to &lt;tt&gt;true&lt;/tt&gt;. Let me know if this solves your problem for 1.15 upgrades or simple pipelines from previous versions?&#160;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It works indeed, thanks! At least from 1.15.1 to 1.15.1, I&apos;ll check more complex cases later.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;However, keep in mind that we don&apos;t support stateful upgrades between Flink versions for Flink SQL yet. &lt;a href=&quot;https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=191336489&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FLIP-190&lt;/a&gt; aims to fix this.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We are aware of that but since it does seem to work at least sometimes, it&apos;s still better than nothing. Good to see there is a FLIP to support that.&lt;/p&gt;</comment>
                            <comment id="17576821" author="twalthr" created="Mon, 8 Aug 2022 14:39:16 +0000"  >&lt;p&gt;Thanks for the response! The generated UID hashes were Flink 1.14 behavior, we replaced them with explicit and human readable UIDs as shown above. So 1.15.1 to 1.15.1 should not show you a hash. But nevertheless, the bug that will result in different UIDs when executing the same JAR twice needs to be fixed.&lt;/p&gt;</comment>
                            <comment id="17577337" author="twalthr" created="Tue, 9 Aug 2022 10:18:33 +0000"  >&lt;p&gt;Let me summarize the issue: The UID generation using a static AtomicInteger as counter makes sense for plan compilation. There, the generated UID will be immediately persisted in JSON and thus remains static.&lt;/p&gt;

&lt;p&gt;However, it should not be enabled by default for regular Table API jobs that potentially connect to DataStream API. The current counter approach for UID generation causes issues when the same JVM translates multiple SQL/Table API pipelines. It is not easily possible to ensure uniqueness as one DataStream API job could potentially consist of multiple SQL pipelines. The previous approach in 1.14 (viewing the entire StreamGraph and assigning the UIDs in a last step at the end) makes more sense if the pipeline is not constructed from a compiled plan.&lt;/p&gt;

&lt;p&gt;I would suggest to revert the change made in 1.15. Not all pipelines are affected by this bug. It works nicely in containerized environments that start a new JVM per job. I suggest to introduce a new config option:&lt;br/&gt;
&lt;tt&gt;table.exec.uid-generation&lt;/tt&gt; of type enum with values &lt;tt&gt;PLAN_ONLY&lt;/tt&gt; (default) and &lt;tt&gt;ALWAYS&lt;/tt&gt; (for 1.15.0, 1.15.1 behavior and expert users that know what they are doing). &lt;tt&gt;PLAN_ONLY&lt;/tt&gt; means that we use the behavior of &lt;tt&gt;table.exec.legacy-transformation-uids&lt;/tt&gt; if the translation does not happen for a compiled plan.&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=godfrey&quot; class=&quot;user-hover&quot; rel=&quot;godfrey&quot;&gt;godfrey&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17579705" author="twalthr" created="Mon, 15 Aug 2022 13:27:21 +0000"  >&lt;p&gt;Fixed in master:&lt;br/&gt;
commit b142860352721fe65b8fe7e4106cbcd2059714e5&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[FLINK-28861][table] Make UID generation behavior configurable and plan-only by &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;

Before &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; commit, due to changes &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; FLIP-190, every &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; generated by the planner
got a UID assigned. However, the UID is based on a &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; counter that might &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; different
results depending on the environment. Thus, UIDs are not deterministic and make stateful
restores impossible e.g. when going from 1.15.0 -&amp;gt; 1.15.1. This PR restores the old pre-1.15
behavior &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; regular Table API. It only adds UIDs &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; has been created from a
compiled plan. A compiled plan makes the UIDs &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; and thus deterministic.

table.exec.uid.generation=ALWAYS exists &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; backwards compatibility and could make stateful
upgrades possible even with invalid UIDs on best effort basis.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;commit 881b2bf046e510b1b6dddddf8c15af45926397f1&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[FLINK-28861][table] Fix bug in UID format &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; migrations and make it configurable

Before &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; commit, the UID format was not &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;-proof &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; migrations. The ExecNode version
should not be in the UID, otherwise, &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; migration won&apos;t be possible once plan migration
is executed. See the FLIP-190 example that drops a version in the plan, once &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; migration
has been performed. Given that the plan feature is marked as @Experimental, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; change should
still be possible without providing backwards compatibility.

However, the config option table.exec.uid.format allows &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; restoring the old format and solves
other UID related issues on the way.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17580104" author="twalthr" created="Tue, 16 Aug 2022 07:33:11 +0000"  >&lt;p&gt;Fixed in 1.15.2:&lt;/p&gt;

&lt;p&gt;commit 105d7c911bd0c5d8634417c22164547651abf07b&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[FLINK-28861][table] Make UID generation behavior configurable and plan-only by &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;

Before &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; commit, due to changes &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; FLIP-190, every &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; generated by the planner
got a UID assigned. However, the UID is based on a &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; counter that might &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; different
results depending on the environment. Thus, UIDs are not deterministic and make stateful
restores impossible e.g. when going from 1.15.0 -&amp;gt; 1.15.1. This PR restores the old pre-1.15
behavior &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; regular Table API. It only adds UIDs &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; has been created from a
compiled plan. A compiled plan makes the UIDs &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; and thus deterministic.

table.exec.uid.generation=ALWAYS exists &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; backwards compatibility and could make stateful
upgrades possible even with invalid UIDs on best effort basis.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 13 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z17k94:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.15.0 and 1.15.1 generated non-deterministic UIDs for operators that make it difficult/impossible to restore state or upgrade to next patch version. A new table.exec.uid.generation config option (with correct default behavior) disables setting a UID for new pipelines from non-compiled plans. Existing pipelines can set table.exec.uid.generation=ALWAYS if the 1.15.0/1 behavior was acceptable.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>