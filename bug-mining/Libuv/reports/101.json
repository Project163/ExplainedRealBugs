{"url":"https://api.github.com/repos/libuv/libuv/issues/4738","repository_url":"https://api.github.com/repos/libuv/libuv","labels_url":"https://api.github.com/repos/libuv/libuv/issues/4738/labels{/name}","comments_url":"https://api.github.com/repos/libuv/libuv/issues/4738/comments","events_url":"https://api.github.com/repos/libuv/libuv/issues/4738/events","html_url":"https://github.com/libuv/libuv/issues/4738","id":2921566589,"node_id":"I_kwDOAOIGQ86uI5F9","number":4738,"title":"Hang issue in Windows named pipes support","user":{"login":"cstavaru","id":18140680,"node_id":"MDQ6VXNlcjE4MTQwNjgw","avatar_url":"https://avatars.githubusercontent.com/u/18140680?v=4","gravatar_id":"","url":"https://api.github.com/users/cstavaru","html_url":"https://github.com/cstavaru","followers_url":"https://api.github.com/users/cstavaru/followers","following_url":"https://api.github.com/users/cstavaru/following{/other_user}","gists_url":"https://api.github.com/users/cstavaru/gists{/gist_id}","starred_url":"https://api.github.com/users/cstavaru/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cstavaru/subscriptions","organizations_url":"https://api.github.com/users/cstavaru/orgs","repos_url":"https://api.github.com/users/cstavaru/repos","events_url":"https://api.github.com/users/cstavaru/events{/privacy}","received_events_url":"https://api.github.com/users/cstavaru/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2025-03-15T01:09:09Z","updated_at":"2025-07-10T13:08:37Z","closed_at":"2025-07-10T13:08:37Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello,\n\nI have a project using Windows named pipes extensively. Sometime between release 1.48.0 and 1.49.0, there was a commit 727ee72 in which windows named pipes support (`src/win/pipe.c file`) was extensively reworked. This introduced a bug in which the `uv__pipe_read_data()` call can block in certain conditions, because it can be called by `uv__process_pipe_read_req()` when there is no data available on the pipe. More precisely, the inner call to `GetOverlappedResult(handle->handle, &req->u.io.overlapped, bytes_read, TRUE)` is the one ending up blocking   indefinitely.\n\nHow does this happen ? the  `uv__process_pipe_read_req()` mistakenly assumes that there is more data to be read when the last read amount is equal to the provided buffer size. If the provided buffer size is **exactly equal** to the size of data available on the pipe, this assumption fails, there is no data to be read yet it assumes that it is the case and attempts to process another read  request without waiting on the IOCP.\n\nMy project first reads a header size of a structure from the pipe, then it sets the buffer size to exactly the size of the rest of the structure I'm trying to read and places a new read, and this triggers the issue for subsequent read operations.\n\nAs a solution, I can't see a different one than using `PeekNamedPipe()` in `uv__process_pipe_read_req()` (like it was before that commit) to first read how much data is available, rather than assuming that there is more data to be read when `uv__pipe_read_data()`  returns 1.\n\nAs a side note, I also think that the code:\n\n`req->u.io.overlapped.hEvent = (HANDLE) ((uintptr_t) req->event_handle | 1);`\n\nshould be replaced with:\n\n`if (handle->flags & UV_HANDLE_EMULATE_IOCP) {\n  assert(req->event_handle != NULL);\n  req->u.io.overlapped.hEvent = (HANDLE) ((uintptr_t) req->event_handle | 1);\n}`\n\nin  `uv__pipe_read_data()` and in `uv__pipe_read_exactly()` inside the `pipe.c` file, because otherwise two different I/O models (true IOCP and emulated IOCP) are mixed.\n\nThank you.\n","closed_by":{"login":"vtjnash","id":330950,"node_id":"MDQ6VXNlcjMzMDk1MA==","avatar_url":"https://avatars.githubusercontent.com/u/330950?v=4","gravatar_id":"","url":"https://api.github.com/users/vtjnash","html_url":"https://github.com/vtjnash","followers_url":"https://api.github.com/users/vtjnash/followers","following_url":"https://api.github.com/users/vtjnash/following{/other_user}","gists_url":"https://api.github.com/users/vtjnash/gists{/gist_id}","starred_url":"https://api.github.com/users/vtjnash/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vtjnash/subscriptions","organizations_url":"https://api.github.com/users/vtjnash/orgs","repos_url":"https://api.github.com/users/vtjnash/repos","events_url":"https://api.github.com/users/vtjnash/events{/privacy}","received_events_url":"https://api.github.com/users/vtjnash/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/libuv/libuv/issues/4738/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/libuv/libuv/issues/4738/timeline","performed_via_github_app":null,"state_reason":"completed"}