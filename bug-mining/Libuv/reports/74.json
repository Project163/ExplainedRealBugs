{"url":"https://api.github.com/repos/libuv/libuv/issues/852","repository_url":"https://api.github.com/repos/libuv/libuv","labels_url":"https://api.github.com/repos/libuv/libuv/issues/852/labels{/name}","comments_url":"https://api.github.com/repos/libuv/libuv/issues/852/comments","events_url":"https://api.github.com/repos/libuv/libuv/issues/852/events","html_url":"https://github.com/libuv/libuv/issues/852","id":152755701,"node_id":"MDU6SXNzdWUxNTI3NTU3MDE=","number":852,"title":"tty issues when switching to raw mode on Windows","user":{"login":"orangemocha","id":1625870,"node_id":"MDQ6VXNlcjE2MjU4NzA=","avatar_url":"https://avatars.githubusercontent.com/u/1625870?v=4","gravatar_id":"","url":"https://api.github.com/users/orangemocha","html_url":"https://github.com/orangemocha","followers_url":"https://api.github.com/users/orangemocha/followers","following_url":"https://api.github.com/users/orangemocha/following{/other_user}","gists_url":"https://api.github.com/users/orangemocha/gists{/gist_id}","starred_url":"https://api.github.com/users/orangemocha/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/orangemocha/subscriptions","organizations_url":"https://api.github.com/users/orangemocha/orgs","repos_url":"https://api.github.com/users/orangemocha/repos","events_url":"https://api.github.com/users/orangemocha/events{/privacy}","received_events_url":"https://api.github.com/users/orangemocha/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":68370103,"node_id":"MDU6TGFiZWw2ODM3MDEwMw==","url":"https://api.github.com/repos/libuv/libuv/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":158970478,"node_id":"MDU6TGFiZWwxNTg5NzA0Nzg=","url":"https://api.github.com/repos/libuv/libuv/labels/windows","name":"windows","color":"ab378b","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2016-05-03T11:50:02Z","updated_at":"2016-05-16T21:06:25Z","closed_at":"2016-05-16T21:06:25Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"While investigating https://github.com/nodejs/node/issues/5384 and a host of related issues, we have discovered a few issues and incompatibilites with the current Windows implementation of tty in libuv.\n1. Switching to raw mode doesn’t work reliably. This is by far the most severe issue, and the cause of arrow keys not working on Windows per recent user reports. Libuv is relying [on CloseHandle](https://github.com/libuv/libuv/blob/4844c75de8d6fefd6efb1ac7e6050a07160e8eec/src/win/tty.c#L955-L958) to interrupt the call to ReadConsole in another thread. This might have worked on older versions of Windows, but it is unreliable on Windows 7, and doesn’t work at all in Windows 8.1 and higher. On Windows 8.1 and higher, ReadConsole doesn’t return until ENTER is pressed.\n2. Even when ReadConsole is interrupted successfully, any keypresses in its buffer are lost forever, whereas on Linux switching to raw mode causes any buffered keypresses to be emitted as raw keypresses.\n\nAfter much investigation, we have identified two possible fixes:\n\n<ol type=\"a\">\n  <li>Make ReadConsole return. We have tested CloseHandle, SetConsoleMode, CancelIoEx and none of those do the job reliably. The only reliable way we have found is to send VK_ENTER to the console using WriteConsoleInput, similarly to how <a href=\"https://github.com/libuv/libuv/blob/4844c75de8d6fefd6efb1ac7e6050a07160e8eec/src/win/tty.c#L943-L953\">libuv already does</a> to cancel the console wait in raw mode.</li>\n  <li>Eliminating the use of ReadConsole and implementing line input in terms of ReadConsoleInput. This essentially amounts to re-implementing a good portion of ReadConsole’s functionality.</li>\n</ol>\n\n\nFix a) is much easier, and also the only fix of the two that would be admissible in Node LTS releases, so we are pursuing it first. It doesn’t address the second issue (pending line input getting lost when transitioning to raw mode), but again that seems less critical.\n\nRegarding fix b), I wanted to first get your feedback on whether it would be desirable before deciding if we should attempt it. We would have the ability to emulate the Unix tty behavior more closely, and re-play any pending line input after switching to raw mode (fix issue 2). We would have to keep our own buffer and process arrow keys, backspace, etc.. Line history is implemented by ReadConsole, and doesn’t seem to have a counterpart in the Unix tty implementation. There are a few Node modules implementing history though, including the built-in readline module, so it might not be a bad thing to level this platform difference. The Unix tty also doesn’t handle arrow keys - they are returned as escape sequences. Again, we could consider emulating the same, which would probably also make it easier to implement. Would such behavior be desirable? It would have to be considered a breaking change on Windows.\n\ncc @saghul @piscisaureus \n","closed_by":{"login":"saghul","id":317464,"node_id":"MDQ6VXNlcjMxNzQ2NA==","avatar_url":"https://avatars.githubusercontent.com/u/317464?v=4","gravatar_id":"","url":"https://api.github.com/users/saghul","html_url":"https://github.com/saghul","followers_url":"https://api.github.com/users/saghul/followers","following_url":"https://api.github.com/users/saghul/following{/other_user}","gists_url":"https://api.github.com/users/saghul/gists{/gist_id}","starred_url":"https://api.github.com/users/saghul/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/saghul/subscriptions","organizations_url":"https://api.github.com/users/saghul/orgs","repos_url":"https://api.github.com/users/saghul/repos","events_url":"https://api.github.com/users/saghul/events{/privacy}","received_events_url":"https://api.github.com/users/saghul/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/libuv/libuv/issues/852/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/libuv/libuv/issues/852/timeline","performed_via_github_app":null,"state_reason":"completed"}