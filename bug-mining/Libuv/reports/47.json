{"url":"https://api.github.com/repos/libuv/libuv/issues/774","repository_url":"https://api.github.com/repos/libuv/libuv","labels_url":"https://api.github.com/repos/libuv/libuv/issues/774/labels{/name}","comments_url":"https://api.github.com/repos/libuv/libuv/issues/774/comments","events_url":"https://api.github.com/repos/libuv/libuv/issues/774/events","html_url":"https://github.com/libuv/libuv/issues/774","id":142703586,"node_id":"MDU6SXNzdWUxNDI3MDM1ODY=","number":774,"title":"Support for polling kernfs attribute files","user":{"login":"aldehir","id":765227,"node_id":"MDQ6VXNlcjc2NTIyNw==","avatar_url":"https://avatars.githubusercontent.com/u/765227?v=4","gravatar_id":"","url":"https://api.github.com/users/aldehir","html_url":"https://github.com/aldehir","followers_url":"https://api.github.com/users/aldehir/followers","following_url":"https://api.github.com/users/aldehir/following{/other_user}","gists_url":"https://api.github.com/users/aldehir/gists{/gist_id}","starred_url":"https://api.github.com/users/aldehir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aldehir/subscriptions","organizations_url":"https://api.github.com/users/aldehir/orgs","repos_url":"https://api.github.com/users/aldehir/repos","events_url":"https://api.github.com/users/aldehir/events{/privacy}","received_events_url":"https://api.github.com/users/aldehir/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":163844368,"node_id":"MDU6TGFiZWwxNjM4NDQzNjg=","url":"https://api.github.com/repos/libuv/libuv/labels/feature-request","name":"feature-request","color":"fad8c7","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-03-22T16:29:27Z","updated_at":"2016-05-17T10:40:08Z","closed_at":"2016-05-17T10:40:08Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I would like to work on support for polling kernfs attribute files through the use of `uv_poll_t`. Before doing so, I'd like to get the blessing of the libuv maintainers for the proposed changes.\n\nAs documented [here](https://github.com/torvalds/linux/blob/master/fs/kernfs/file.c#L768-L781),\n\n> Kernfs attribute files are pollable.  The idea is that you read\n> the content and then you use 'poll' or 'select' to wait for\n> the content to change.  When the content changes (assuming the\n> manager for the kobject supports notification), poll will\n> return POLLERR|POLLPRI, and select will return the fd whether\n> it is waiting for read, write, or exceptions.\n> Once poll/select indicates that the value has changed, you\n> need to close and re-open the file, or seek to 0 and read again.\n> Reminder: this only works for attributes which actively support\n> it, and it is not possible to test an attribute from userspace\n> to see if it supports poll (Neither 'poll' nor 'select' return\n> an appropriate error code).  When in doubt, set a suitable timeout value.\n\nCertain kernfs attribute files can be polled for the event `POLLPRI | POLLERR`, or in terms of epoll, `EPOLLPRI | EPOLLERR`. Unfortunately, the existing implementation of `uv_poll_t` doesn't lend itself well to this use case for two reasons:\n- `uv_poll_event` doesn't have an event mapped for `EPOLLPRI`.\n- `uv__poll_io()` automatically removes the poll handle from the event loop upon receiving `EPOLLERR`.\n\nI propose to add an additional event to `uv_poll_event`, say... `UV_PRIORITY`, or `UV_URGENT`. In addition, add poll specific flags to the `uv_poll_t` handle to support different behavior(s). A flag such as `UV_NOAUTOCLOSE` may be passed to prevent `uv__poll_io()` from cleaning up the poll handle when receiving an `EPOLLERR` event. Then have a pair of functions, `uv_set_poll_flags()` and `uv_get_poll_flags()`, for getting/setting the flags.\n\nPlease let me know your thoughts/concerns about my proposed modifications. If it seems like a good addition, then I'll follow up with a PR.\n\nThanks!\n","closed_by":{"login":"saghul","id":317464,"node_id":"MDQ6VXNlcjMxNzQ2NA==","avatar_url":"https://avatars.githubusercontent.com/u/317464?v=4","gravatar_id":"","url":"https://api.github.com/users/saghul","html_url":"https://github.com/saghul","followers_url":"https://api.github.com/users/saghul/followers","following_url":"https://api.github.com/users/saghul/following{/other_user}","gists_url":"https://api.github.com/users/saghul/gists{/gist_id}","starred_url":"https://api.github.com/users/saghul/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/saghul/subscriptions","organizations_url":"https://api.github.com/users/saghul/orgs","repos_url":"https://api.github.com/users/saghul/repos","events_url":"https://api.github.com/users/saghul/events{/privacy}","received_events_url":"https://api.github.com/users/saghul/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/libuv/libuv/issues/774/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/libuv/libuv/issues/774/timeline","performed_via_github_app":null,"state_reason":"completed"}