{"url":"https://api.github.com/repos/libuv/libuv/issues/799","repository_url":"https://api.github.com/repos/libuv/libuv","labels_url":"https://api.github.com/repos/libuv/libuv/issues/799/labels{/name}","comments_url":"https://api.github.com/repos/libuv/libuv/issues/799/comments","events_url":"https://api.github.com/repos/libuv/libuv/issues/799/events","html_url":"https://github.com/libuv/libuv/issues/799","id":145289858,"node_id":"MDU6SXNzdWUxNDUyODk4NTg=","number":799,"title":"`tcp_close_accept` test is flaky on `SmartOS`","user":{"login":"santigimeno","id":1084056,"node_id":"MDQ6VXNlcjEwODQwNTY=","avatar_url":"https://avatars.githubusercontent.com/u/1084056?v=4","gravatar_id":"","url":"https://api.github.com/users/santigimeno","html_url":"https://github.com/santigimeno","followers_url":"https://api.github.com/users/santigimeno/followers","following_url":"https://api.github.com/users/santigimeno/following{/other_user}","gists_url":"https://api.github.com/users/santigimeno/gists{/gist_id}","starred_url":"https://api.github.com/users/santigimeno/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/santigimeno/subscriptions","organizations_url":"https://api.github.com/users/santigimeno/orgs","repos_url":"https://api.github.com/users/santigimeno/repos","events_url":"https://api.github.com/users/santigimeno/events{/privacy}","received_events_url":"https://api.github.com/users/santigimeno/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2016-04-01T21:35:22Z","updated_at":"2016-08-18T08:23:03Z","closed_at":"2016-08-18T08:23:03Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The `tcp_close_accept` test has been flaky in `SmartOS` for a while. See https://ci.nodejs.org/job/libuv+any-pr+multi/297/:\n\n```\n`tcp_close_accept` failed: exit code 134\nOutput from process `tcp_close_accept`:\nAssertion failed in test/test-tcp-close-accept.c on line 59: status != 0\n```\n\nI've been looking into it and have found what I think is inconsistent behavior of `SmartOS` handling `connect` errors. In this test, just after the last connection is tried, the server socket is closed (see [code](https://github.com/libuv/libuv/blob/v1.x/test/test-tcp-close-accept.c#L99-L108)). One would think the `connect_cb` should be called with an error but it does not happen all the time. At least on 50% of the test runs, it returns success. By debugging I've noticed the following:\n- The execution order of the syscalls is the same in both cases.\n- The `getsockopt` call [here](https://github.com/libuv/libuv/blob/v1.x/src/unix/stream.c#L1315) returns `ECONNRESET` when the test succeeds and 0 when the test fails.\n- When the test succeeds (`ECONNRESET` is reported), the poll function reports `POLLIN` && `POLLOUT`, whereas when no error is returned, it returns only `POLLOUT`.\n\nIf my analysis is correct, what would be a proper solution for this? I've been thinking about trying some operation (`write` 0 bytes maybe?) to see if the connection is established and return an error if it is not.\n\nThanks in advance.\n","closed_by":{"login":"santigimeno","id":1084056,"node_id":"MDQ6VXNlcjEwODQwNTY=","avatar_url":"https://avatars.githubusercontent.com/u/1084056?v=4","gravatar_id":"","url":"https://api.github.com/users/santigimeno","html_url":"https://github.com/santigimeno","followers_url":"https://api.github.com/users/santigimeno/followers","following_url":"https://api.github.com/users/santigimeno/following{/other_user}","gists_url":"https://api.github.com/users/santigimeno/gists{/gist_id}","starred_url":"https://api.github.com/users/santigimeno/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/santigimeno/subscriptions","organizations_url":"https://api.github.com/users/santigimeno/orgs","repos_url":"https://api.github.com/users/santigimeno/repos","events_url":"https://api.github.com/users/santigimeno/events{/privacy}","received_events_url":"https://api.github.com/users/santigimeno/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/libuv/libuv/issues/799/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/libuv/libuv/issues/799/timeline","performed_via_github_app":null,"state_reason":"completed"}