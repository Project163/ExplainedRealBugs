{"url":"https://api.github.com/repos/libuv/libuv/issues/120","repository_url":"https://api.github.com/repos/libuv/libuv","labels_url":"https://api.github.com/repos/libuv/libuv/issues/120/labels{/name}","comments_url":"https://api.github.com/repos/libuv/libuv/issues/120/comments","events_url":"https://api.github.com/repos/libuv/libuv/issues/120/events","html_url":"https://github.com/libuv/libuv/issues/120","id":53605279,"node_id":"MDU6SXNzdWU1MzYwNTI3OQ==","number":120,"title":"unix: uv_tty_init overwrites input tty file descriptor.","user":{"login":"torque","id":949138,"node_id":"MDQ6VXNlcjk0OTEzOA==","avatar_url":"https://avatars.githubusercontent.com/u/949138?v=4","gravatar_id":"","url":"https://api.github.com/users/torque","html_url":"https://github.com/torque","followers_url":"https://api.github.com/users/torque/followers","following_url":"https://api.github.com/users/torque/following{/other_user}","gists_url":"https://api.github.com/users/torque/gists{/gist_id}","starred_url":"https://api.github.com/users/torque/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/torque/subscriptions","organizations_url":"https://api.github.com/users/torque/orgs","repos_url":"https://api.github.com/users/torque/repos","events_url":"https://api.github.com/users/torque/events{/privacy}","received_events_url":"https://api.github.com/users/torque/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2015-01-07T07:25:30Z","updated_at":"2015-01-07T12:59:44Z","closed_at":"2015-01-07T12:59:44Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Currently, any file descriptor that is a tty (according to `isatty`) passed in to `uv_tty_init` will be overwritten with a file descriptor pointing to `/dev/tty`. This is a problem because I want to stream data from a serial device disguised as a tty, `/dev/tty.usbserial`, which is distinctly not `/dev/tty`.\n\nBlame points to b197515367d1a996dca9009483d202b306f9474e from joyent/libuv#1184. This leads me to believe this is somewhat intentional, but I can't find it mentioned in the documentation. If `uv_tty_t` is intended to only provide access to `/dev/tty`, this should be explicitly documented.\n#19 seems to provide an alternate approach to solving this problem, but it's a larger change that needs to be reviewed, tested, and documented.\n\nI think more reasonable behavior would be to duplicate the file descriptor passed to `uv_tty_init`.\n\nThe following patch fixes my problem, but I don't know what ramifications it may have for other use cases.\n\n``` diff\ndiff --git a/src/unix/tty.c b/src/unix/tty.c\nindex 068025e..c8847f2 100644\n--- a/src/unix/tty.c\n+++ b/src/unix/tty.c\n@@ -66,7 +66,7 @@ int uv_tty_init(uv_loop_t* loop, uv_tty_t* tty, int fd, int readable) {\n\n     newfd = r;\n\n-    r = uv__dup2_cloexec(newfd, fd);\n+    r = uv__dup2_cloexec(fd, newfd);\n     if (r < 0 && r != -EINVAL) {\n       /* EINVAL means newfd == fd which could conceivably happen if another\n        * thread called close(fd) between our calls to isatty() and open().\n```\n","closed_by":{"login":"saghul","id":317464,"node_id":"MDQ6VXNlcjMxNzQ2NA==","avatar_url":"https://avatars.githubusercontent.com/u/317464?v=4","gravatar_id":"","url":"https://api.github.com/users/saghul","html_url":"https://github.com/saghul","followers_url":"https://api.github.com/users/saghul/followers","following_url":"https://api.github.com/users/saghul/following{/other_user}","gists_url":"https://api.github.com/users/saghul/gists{/gist_id}","starred_url":"https://api.github.com/users/saghul/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/saghul/subscriptions","organizations_url":"https://api.github.com/users/saghul/orgs","repos_url":"https://api.github.com/users/saghul/repos","events_url":"https://api.github.com/users/saghul/events{/privacy}","received_events_url":"https://api.github.com/users/saghul/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/libuv/libuv/issues/120/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/libuv/libuv/issues/120/timeline","performed_via_github_app":null,"state_reason":"completed"}