{"url":"https://api.github.com/repos/libuv/libuv/issues/3469","repository_url":"https://api.github.com/repos/libuv/libuv","labels_url":"https://api.github.com/repos/libuv/libuv/issues/3469/labels{/name}","comments_url":"https://api.github.com/repos/libuv/libuv/issues/3469/comments","events_url":"https://api.github.com/repos/libuv/libuv/issues/3469/events","html_url":"https://github.com/libuv/libuv/issues/3469","id":1130497321,"node_id":"I_kwDOAOIGQ85DYgUp","number":3469,"title":"Intermittent issue seen on SPARC platform with test ipc_send_recv_pipe","user":{"login":"alls0rts","id":3480847,"node_id":"MDQ6VXNlcjM0ODA4NDc=","avatar_url":"https://avatars.githubusercontent.com/u/3480847?v=4","gravatar_id":"","url":"https://api.github.com/users/alls0rts","html_url":"https://github.com/alls0rts","followers_url":"https://api.github.com/users/alls0rts/followers","following_url":"https://api.github.com/users/alls0rts/following{/other_user}","gists_url":"https://api.github.com/users/alls0rts/gists{/gist_id}","starred_url":"https://api.github.com/users/alls0rts/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alls0rts/subscriptions","organizations_url":"https://api.github.com/users/alls0rts/orgs","repos_url":"https://api.github.com/users/alls0rts/repos","events_url":"https://api.github.com/users/alls0rts/events{/privacy}","received_events_url":"https://api.github.com/users/alls0rts/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-10T17:14:41Z","updated_at":"2022-02-20T11:17:14Z","closed_at":"2022-02-20T11:17:14Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"\r\n* **Version**: 1.42.0\r\n* **Platform**: SunOS 5.11 11.4.42.109.0 sun4v sparc non-virtualized\r\n\r\nWhile testing libuv on SPARC (SPARC-T4-2) running Solaris 11.4\r\ntest `ipc_send_recv_pipe` is seen to intermittently fail.\r\nVersions tested include v1.41.0, v1.41.1 and v1.42.0.\r\n\r\nThe stack trace on failure is:\r\n\r\n    (dbx) where\r\n    current thread: t@1\r\n      [1] __lwp_sigqueue(0x0, 0xa00bcbd6fb0, 0x6, 0x0, 0xffffffffffffffff, 0x0), at 0x7fffff0e26b0\r\n      [2] raise(0x6, 0xffffffff7fff8750, 0x5, 0x5, 0x0, 0x0), at 0x7fffff02ba64\r\n      [3] abort(0x1, 0x1210, 0x0, 0x1000, 0x7fffff224000, 0x9b), at 0x7ffffeffaa24\r\n    =>[4] read_cb(handle = 0x1003624f0, nread = <value unavailable>, rdbuf = <value unavailable>) (optimized), at 0x1000bbd20 (line ~323) in \"test-ipc-send-recv.c\"\r\n      [5] uv__read(stream = 0x1003624f0) (optimized), at 0x7ffff1533d6c (line ~1192) in \"stream.c\"\r\n      [6] uv__stream_io(loop = <value unavailable>, w = 0x100362578, events = 8U) (optimized), at 0x7ffff153410c (line ~1316) in \"stream.c\"\r\n      [7] uv__io_poll(loop = 0x7ffff1700140, timeout = -1) (optimized), at 0x7ffff153be9c (line ~311) in \"sunos.c\"\r\n      [8] uv_run(loop = 0x7ffff1700140, mode = UV_RUN_DEFAULT) (optimized), at 0x7ffff151f1c0 (line ~389) in \"core.c\"\r\n      [9] run_ipc_send_recv_helper(loop = <value unavailable>, inprocess = <value unavailable>) (inlined), line 398 in \"test-ipc-send-recv.c\"\r\n      [10] ipc_send_recv_helper() (optimized), line 410 in \"test-ipc-send-recv.c\"\r\n    (dbx)\r\n\r\nNote that:\r\n\r\n-   attempts to truss(1) the test cause it to pass.\r\n-   intermittent is between 30-50% of the time when running the test\r\n    in a loop on a system that is quiescent.\r\n\r\nLooking into a possible cause I believe the issue is with the test itself.\r\n\r\nAs the stack shows, `uv_read` called the test's call-back function;\r\nthe specific line is `src/unix/stream.c'uv__read:1192`, shown here with some context:\r\n\r\n        1162          if (!is_ipc) {\r\n        1163        do {\r\n        1164          nread = read(uv__stream_fd(stream), buf.base, buf.len);\r\n        1165        }\r\n        1166        while (nread < 0 && errno == EINTR);\r\n        1167      } else {\r\n        1168        /* ipc uses recvmsg */\r\n        1169        msg.msg_flags = 0;\r\n        1170        msg.msg_iov = (struct iovec*) &buf;\r\n        1171        msg.msg_iovlen = 1;\r\n        1172        msg.msg_name = NULL;\r\n        1173        msg.msg_namelen = 0;\r\n        1174        /* Set up to receive a descriptor even if one isn't in the message */\r\n        1175        msg.msg_controllen = sizeof(cmsg_space);\r\n        1176        msg.msg_control = cmsg_space;\r\n        1177  \r\n        1178        do {\r\n        1179          nread = uv__recvmsg(uv__stream_fd(stream), &msg, 0);\r\n        1180        }\r\n        1181        while (nread < 0 && errno == EINTR);\r\n        1182      }\r\n        1183  \r\n        1184      if (nread < 0) {\r\n        1185        /* Error */\r\n        1186        if (errno == EAGAIN || errno == EWOULDBLOCK) {  /* SJM Yes, errno 11 : EAGAIN */\r\n        1187          /* Wait for the next one. */  /* SJM does it really wait? */\r\n        1188          if (stream->flags & UV_HANDLE_READING) {  /* SJM, yes this flag is set */\r\n        1189            uv__io_start(stream->loop, &stream->io_watcher, POLLIN);  /* SJM Does not appear to wait */\r\n        1190            uv__stream_osx_interrupt_select(stream); /* SJM NOP */\r\n        1191          }\r\n        1192          stream->read_cb(stream, 0, &buf);    /* <---- SJM */\r\n\r\nThus we can deduce that `uv__recmsg()` / `recvmsg()` returned a negative\r\nresult and the errno was 11, EAGAIN (which on Solaris is the same as\r\nEWOULDBLOCK).  The call to `stream->read_cb (uv_read_cb)` as shown\r\nexplicitly passes in `nread` as 0.\r\n\r\nDocumentation ([`uv_stream_t` — Stream handle — libuv documentation](http://docs.libuv.org/en/v1.x/stream.html)) states\r\n\r\n    This is equivalent to EAGAIN or EWOULDBLOCK under read(2).\r\n\r\nThe call-back routine does not check for `nread == 0`, and so erroneously \r\ncontinues until an assertion is hit.\r\n\r\nModifying the test to simply return when `nread == 0` prevents assertions,\r\nand the test passes.  Though I have not confirmed that it the right\r\nsolution and seek advice or confirmation.\r\n\r\nThanks.","closed_by":{"login":"bnoordhuis","id":275871,"node_id":"MDQ6VXNlcjI3NTg3MQ==","avatar_url":"https://avatars.githubusercontent.com/u/275871?v=4","gravatar_id":"","url":"https://api.github.com/users/bnoordhuis","html_url":"https://github.com/bnoordhuis","followers_url":"https://api.github.com/users/bnoordhuis/followers","following_url":"https://api.github.com/users/bnoordhuis/following{/other_user}","gists_url":"https://api.github.com/users/bnoordhuis/gists{/gist_id}","starred_url":"https://api.github.com/users/bnoordhuis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bnoordhuis/subscriptions","organizations_url":"https://api.github.com/users/bnoordhuis/orgs","repos_url":"https://api.github.com/users/bnoordhuis/repos","events_url":"https://api.github.com/users/bnoordhuis/events{/privacy}","received_events_url":"https://api.github.com/users/bnoordhuis/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/libuv/libuv/issues/3469/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/libuv/libuv/issues/3469/timeline","performed_via_github_app":null,"state_reason":"completed"}