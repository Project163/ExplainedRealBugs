{"url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1235","repository_url":"https://api.github.com/repos/sqlalchemy/alembic","labels_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1235/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1235/comments","events_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1235/events","html_url":"https://github.com/sqlalchemy/alembic/issues/1235","id":1698303946,"node_id":"I_kwDOCX47u85lOg_K","number":1235,"title":"prefix = autogen_context.opts[\"user_module_prefix\"] raise KeyError","user":{"login":"allmonday","id":2917822,"node_id":"MDQ6VXNlcjI5MTc4MjI=","avatar_url":"https://avatars.githubusercontent.com/u/2917822?v=4","gravatar_id":"","url":"https://api.github.com/users/allmonday","html_url":"https://github.com/allmonday","followers_url":"https://api.github.com/users/allmonday/followers","following_url":"https://api.github.com/users/allmonday/following{/other_user}","gists_url":"https://api.github.com/users/allmonday/gists{/gist_id}","starred_url":"https://api.github.com/users/allmonday/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/allmonday/subscriptions","organizations_url":"https://api.github.com/users/allmonday/orgs","repos_url":"https://api.github.com/users/allmonday/repos","events_url":"https://api.github.com/users/allmonday/events{/privacy}","received_events_url":"https://api.github.com/users/allmonday/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141241826,"node_id":"MDU6TGFiZWwxMTQxMjQxODI2","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141243519,"node_id":"MDU6TGFiZWwxMTQxMjQzNTE5","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/autogenerate%20-%20rendering","name":"autogenerate - rendering","color":"00B0E0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/alembic/milestones/11","html_url":"https://github.com/sqlalchemy/alembic/milestone/11","labels_url":"https://api.github.com/repos/sqlalchemy/alembic/milestones/11/labels","id":9126829,"node_id":"MI_kwDOCX47u84Ai0Ot","number":11,"title":"1.11","description":null,"creator":{"login":"zzzeek","id":128223,"node_id":"MDQ6VXNlcjEyODIyMw==","avatar_url":"https://avatars.githubusercontent.com/u/128223?v=4","gravatar_id":"","url":"https://api.github.com/users/zzzeek","html_url":"https://github.com/zzzeek","followers_url":"https://api.github.com/users/zzzeek/followers","following_url":"https://api.github.com/users/zzzeek/following{/other_user}","gists_url":"https://api.github.com/users/zzzeek/gists{/gist_id}","starred_url":"https://api.github.com/users/zzzeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zzzeek/subscriptions","organizations_url":"https://api.github.com/users/zzzeek/orgs","repos_url":"https://api.github.com/users/zzzeek/repos","events_url":"https://api.github.com/users/zzzeek/events{/privacy}","received_events_url":"https://api.github.com/users/zzzeek/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":5,"state":"closed","created_at":"2023-03-06T23:59:02Z","updated_at":"2023-08-10T19:42:47Z","due_on":null,"closed_at":"2023-08-10T19:42:47Z"},"comments":2,"created_at":"2023-05-05T23:26:59Z","updated_at":"2023-05-12T16:59:51Z","closed_at":"2023-05-12T16:59:50Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n\r\nI've made a small snippet to generate create_table ops for my models\r\n```python\r\ndef create_orm_migration(metadata):\r\n\r\n    operations = []\r\n    for table in metadata.tables.values():\r\n        if table.name.startswith('meeting_note'):\r\n            operations.append(\r\n                ops.CreateTableOp.from_table(table)\r\n            )\r\n            for idx in table.indexes:\r\n                operations.append(ops.CreateIndexOp.from_index(idx))\r\n\r\n    print(autogenerate.render_python_code(\r\n        ops.UpgradeOps(ops=operations),\r\n        ), \r\n    )\r\n```\r\nand it raises KeyError because UUID is defined in other modules.\r\n\r\nfrom portal.utils.db import UUID\r\n```python\r\nBase = declarative_base()\r\n\r\nclass MeetingNotes(Base, CommonFieldsMixin):\r\n    __tablename__ = 'meeting_note_notes'\r\n\r\n    id = Column(UUID, primary_key=True, default=uuid.uuid1)\r\n    date = Column(Date)\r\n    duration = Column(Integer)\r\n    category = Column(String(1024))\r\n    type = Column(String())\r\n    host_employee_number = Column(Integer)\r\n    content = Column(Text(100000))\r\n    title = Column(String(1024))\r\n    agenda = Column(Text())\r\n```\r\n\r\n**Expected behavior**\r\nIt should add module path automatically without raise KeyError\r\n\r\n**To Reproduce**\r\nPlease try to provide a [Minimal, Complete, and Verifiable](http://stackoverflow.com/help/mcve) example, with the migration script and/or the SQLAlchemy tables or models involved.\r\nSee also [Reporting Bugs](https://www.sqlalchemy.org/participate.html#bugs) on the website.\r\n\r\n```py\r\n    def test_render_create_table_with_user_module_type(self):\r\n        class MyType(UserDefinedType):\r\n            def get_col_spec(self):\r\n                return \"MYTYPE\"\r\n\r\n        type_ = MyType()\r\n        uo = ops.UpgradeOps(\r\n            ops=[\r\n                ops.CreateTableOp(\r\n                    \"sometable\", [Column(\"x\", type_)]\r\n                )\r\n            ]\r\n        )\r\n        eq_(\r\n            autogenerate.render_python_code(uo),\r\n            \"# ### commands auto generated by Alembic - please adjust! ###\\n\"\r\n            \"    op.create_table('sometable',\\n\"\r\n            \"    sa.Column('x', tests.test_autogen_render.MyType(), nullable=True)\\n\"\r\n            \"    )\\n\"\r\n            \"    # ### end Alembic commands ###\",\r\n        )\r\n```\r\n\r\n**Error**\r\n\r\n```\r\nTraceback (most recent call last): File \"/home/tangkikodo/.pyenv-wsl/versions/3.7.8/lib/python3.7/runpy.py\", line 193, in _run_module_as_main \"__main__\", mod_spec) \r\nFile \"/home/tangkikodo/.pyenv-wsl/versions/3.7.8/lib/python3.7/runpy.py\", line 85, in _run_code exec(code, run_globals) \r\nFile \"/home/tangkikodo/portal/portal/service/meeting_notes/models.py\", line 51, in <module> create_orm_migration(Base.metadata) \r\nFile \"/home/tangkikodo/portal/portal/toolbox/ale_gen.py\", line 20, in create_orm_migration ops.UpgradeOps(ops=operations), File \"/home/tangkikodo/portal/venv/lib/python3.7/site-packages/alembic/autogenerate/api.py\", line 203, in render_python_code render._render_cmd_body(up_or_down_op, autogen_context) \r\nFile \"/home/tangkikodo/portal/venv/lib/python3.7/site-packages/alembic/autogenerate/render.py\", line 107, in _render_cmd_body lines = render_op(autogen_context, op) \r\nFile \"/home/tangkikodo/portal/venv/lib/python3.7/site-packages/alembic/autogenerate/render.py\", line 125, in render_op lines = util.to_list(renderer(autogen_context, op)) \r\nFile \"/home/tangkikodo/portal/venv/lib/python3.7/site-packages/alembic/autogenerate/render.py\", line 219, in _add_table _render_column(col, autogen_context) for col in table.columns \r\nFile \"/home/tangkikodo/portal/venv/lib/python3.7/site-packages/alembic/autogenerate/render.py\", line 219, in <listcomp> _render_column(col, autogen_context) for col in table.columns \r\nFile \"/home/tangkikodo/portal/venv/lib/python3.7/site-packages/alembic/autogenerate/render.py\", line 708, in _render_column \"type\": _repr_type(column.type, autogen_context), \r\nFile \"/home/tangkikodo/portal/venv/lib/python3.7/site-packages/alembic/autogenerate/render.py\", line 838, in _repr_type prefix = _user_autogenerate_prefix(autogen_context, type_) \r\nFile \"/home/tangkikodo/portal/venv/lib/python3.7/site-packages/alembic/autogenerate/render.py\", line 637, in _user_autogenerate_prefix prefix = autogen_context.opts[\"user_module_prefix\"] KeyError: 'user_module_prefix'\r\n```\r\n\r\n**Versions.**\r\n - OS: \r\n - Python:\r\n - Alembic:\r\n - SQLAlchemy:\r\n - Database:\r\n - DBAPI:\r\n\r\n**Additional context**\r\n<!-- Add any other context about the problem here. -->\r\n\r\n**Have a nice day!**\r\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1235/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1235/timeline","performed_via_github_app":null,"state_reason":"completed"}