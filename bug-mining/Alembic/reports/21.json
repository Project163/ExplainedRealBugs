{"url":"https://api.github.com/repos/sqlalchemy/alembic/issues/202","repository_url":"https://api.github.com/repos/sqlalchemy/alembic","labels_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/202/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/202/comments","events_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/202/events","html_url":"https://github.com/sqlalchemy/alembic/issues/202","id":384601506,"node_id":"MDU6SXNzdWUzODQ2MDE1MDY=","number":202,"title":"Autogenerate wants to add existing indexes","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141241826,"node_id":"MDU6TGFiZWwxMTQxMjQxODI2","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141242873,"node_id":"MDU6TGFiZWwxMTQxMjQyODcz","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/autogenerate%20-%20detection","name":"autogenerate - detection","color":"301030","default":false,"description":null},{"id":1141243076,"node_id":"MDU6TGFiZWwxMTQxMjQzMDc2","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/high%20priority","name":"high priority","color":"8030B0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2014-05-02T10:01:55Z","updated_at":"2014-05-02T20:05:50Z","closed_at":"2014-05-02T20:05:06Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Sjoerd Langkemper**\n\nThe autogenerate functionality adds indexes that already exist, if the index name is the same as the column name.\n\nWe have explicit indexes in our metadata.py with the same name as the column:\n\n\n```\nIndex(u'account_id', account_buildingblock.c.account_id)\n\n```\n\nWhen using `alembic revision --autogenerate`, alembic wants to add this index to the database, even though it already exists.\n\nThe index is correctly detected by Inspector.get_indexes, but then removed from the `conn_indexes` list by `MySQLImpl.correct_for_autogen_constraints`. This method removes all indexes where the name is equal to the first column. The result is that the index is created in the `upgrade` method of the migration:\n\n```\nop.create_index('account_id', 'account_event', ['account_id'], unique=False)\n```\n\nRunning this migration gives an error:\n```\nsqlalchemy.exc.OperationalError: (OperationalError) (1061, \"Duplicate key name 'account_id'\") 'CREATE INDEX account_id ON account_event (account_id)' ()\n```\n\nIt would be ok if `_compare_indexes_and_uniques` ignores these indexes, but it has to do so on the metadata side as well as the database side. Currently it pretends the indexes on the database don't exist, and tries to add them, which gives an error.\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/alembic/issues/202/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/202/timeline","performed_via_github_app":null,"state_reason":"completed"}