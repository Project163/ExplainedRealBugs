{"url":"https://api.github.com/repos/sqlalchemy/alembic/issues/306","repository_url":"https://api.github.com/repos/sqlalchemy/alembic","labels_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/306/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/306/comments","events_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/306/events","html_url":"https://github.com/sqlalchemy/alembic/issues/306","id":384602450,"node_id":"MDU6SXNzdWUzODQ2MDI0NTA=","number":306,"title":"extensible autogen compare","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141242821,"node_id":"MDU6TGFiZWwxMTQxMjQyODIx","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/feature","name":"feature","color":"801010","default":false,"description":null},{"id":1141242873,"node_id":"MDU6TGFiZWwxMTQxMjQyODcz","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/autogenerate%20-%20detection","name":"autogenerate - detection","color":"301030","default":false,"description":null},{"id":1141243076,"node_id":"MDU6TGFiZWwxMTQxMjQzMDc2","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/high%20priority","name":"high priority","color":"8030B0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/alembic/milestones/2","html_url":"https://github.com/sqlalchemy/alembic/milestone/2","labels_url":"https://api.github.com/repos/sqlalchemy/alembic/milestones/2/labels","id":3850498,"node_id":"MDk6TWlsZXN0b25lMzg1MDQ5OA==","number":2,"title":"tier 1","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":24,"state":"closed","created_at":"2018-11-27T03:04:06Z","updated_at":"2020-04-10T15:00:48Z","due_on":null,"closed_at":"2020-04-10T15:00:48Z"},"comments":2,"created_at":"2015-07-04T19:06:54Z","updated_at":"2015-07-16T23:03:44Z","closed_at":"2015-07-16T23:03:44Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Michael Bayer ([@zzzeek](https://github.com/zzzeek))**\n\n1. replace the whole \"diffs\" list with a system that generates the Ops directives directly from autogenerate.render.   Instead of `diffs.append(('add_index', Index))` it's `ops.append(AddIndex.from_index(index))`.  This removes the need for compose._produce_adddrop_command, compose._produce_modify_command, and compose._produce_command.\n\n2. the production of the list here will now do the \"compose\" in place; e.g. when we do compare_tables, we first produce an ops.ModifyTableOps, and pass that into sub-operations.  This removes the need for compose._group_diffs_by_table..\n\n3. Most ops will now have a reverse() function.  CreateIndex reverses to DropIndex and vice versa, UpgradeOps reverses to `DowngradeOps(ops=list(reversed([o.reverse() for o in upgrade.ops])))` and vice versa, etc.     This removes the need for compose._to_updown_op and related functions.\n\n4. with #3, we now just produce an UpgradeOps from alembic.compare, and the DowngradeOps is just upgrade_ops.reverse().   this removes the need for compose._to_migration_script.\n\n5. the use case of the legacy \"diffs\" being needed is now met by a new method on each Ops object, `to_simple_diff()`, which produces that old tuple; the autogenerate.api.compare_metadata function will call upon produce_migrations, then run through the whole UpgradeOps list, flattening it and running `to_simple_diff()`.  This is also how user-defined operations can participate in the old-school \"diffs\" API.   The current test suite that runs compare_metadata can continue to use this function.\n\n6. the compare system needs to break into dispatch hooks, e.g. util.Dispatch, but a new list-version util.ListDispatch.  Targets will be specific to UpgradeOps representing schema-wide changes, and ModifyTableOps for table-specific changes, which will invoke in the same place that foreign key / unique constraints and indexes are run, e.g. in between column adds and drops.  We can also add AlterColumnOp as a dispatch target, where column-specific migrates can be detected, the current example being MySQL autoincrement.   Each hook will have a different callable style that is specific to the type of diff we are doing.\n\n7. the \"include object\" hook needs to be passed to the dispatchers we are doing in #6 as well in some way that isn't going to break; need to decide if the user-defined comparison function calls upon include object itself or if this is done in some automated way.\n\n8. as always, the internal system needs to use these hooks.  so the AlterColumnOp dispatcher itself is consulted within the dispatch for ModifyTableOps, the ModifyTableOps dispatcher itself is consulted within the dispatch for UpgradeOps.\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/alembic/issues/306/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/306/timeline","performed_via_github_app":null,"state_reason":"completed"}