{"url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1391","repository_url":"https://api.github.com/repos/sqlalchemy/alembic","labels_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1391/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1391/comments","events_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1391/events","html_url":"https://github.com/sqlalchemy/alembic/issues/1391","id":2072921035,"node_id":"I_kwDOCX47u857jkPL","number":1391,"title":"Computed statements containing newlines cause warnings on autogenerate","user":{"login":"GeorchW","id":8687777,"node_id":"MDQ6VXNlcjg2ODc3Nzc=","avatar_url":"https://avatars.githubusercontent.com/u/8687777?v=4","gravatar_id":"","url":"https://api.github.com/users/GeorchW","html_url":"https://github.com/GeorchW","followers_url":"https://api.github.com/users/GeorchW/followers","following_url":"https://api.github.com/users/GeorchW/following{/other_user}","gists_url":"https://api.github.com/users/GeorchW/gists{/gist_id}","starred_url":"https://api.github.com/users/GeorchW/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/GeorchW/subscriptions","organizations_url":"https://api.github.com/users/GeorchW/orgs","repos_url":"https://api.github.com/users/GeorchW/repos","events_url":"https://api.github.com/users/GeorchW/events{/privacy}","received_events_url":"https://api.github.com/users/GeorchW/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141242873,"node_id":"MDU6TGFiZWwxMTQxMjQyODcz","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/autogenerate%20-%20detection","name":"autogenerate - detection","color":"301030","default":false,"description":null},{"id":1388914604,"node_id":"MDU6TGFiZWwxMzg4OTE0NjA0","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/use%20case","name":"use case","color":"f28b2b","default":false,"description":"not quite a feature and not quite a bug, something we just didn't think of"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2024-01-09T18:21:51Z","updated_at":"2024-01-15T15:09:51Z","closed_at":"2024-01-15T15:09:51Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\nWhen using ORM code that contains multi-line computed statements, they always generate warnings when being fed into Alembic. Like this:\r\n\r\n```py\r\nclass MyModel(Base):\r\n    ...\r\n    whatever: Mapped[int] = mapped_column(Computed(\"\"\"1\r\n        + 2\"\"\")) # just a simple multi-line expression for demo purposes\r\n    # makes more sense with longer expressions\r\n```\r\n\r\nAlembic will always complain with \"UserWarning: Computed default on MyModel.start_holding cannot be modified\".\r\n\r\n**Expected behavior**\r\nNo warning should appear as long as the expression does not change.\r\n\r\n**To Reproduce**\r\n\r\n\r\nPlease try to provide a [Minimal, Complete, and Verifiable](http://stackoverflow.com/help/mcve) example, with the migration script and/or the SQLAlchemy tables or models involved.\r\nSee also [Reporting Bugs](https://www.sqlalchemy.org/participate.html#bugs) on the website.\r\n\r\nThis is the model:\r\n\r\n```py\r\nfrom sqlalchemy import Computed\r\nfrom sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column\r\n\r\n\r\nclass Base(DeclarativeBase):\r\n    pass\r\n\r\n\r\nclass MyModel(Base):\r\n    __tablename__ = \"mymodel\"\r\n    id: Mapped[int] = mapped_column(primary_key=True)\r\n    whatever: Mapped[int] = mapped_column(Computed(\"\"\"1\r\n        + 2\"\"\"))  # just a simple multi-line expression for demo purposes\r\n    # makes more sense with longer expressions\r\n```\r\n\r\nThe reproduction does not work with sqlite, since it stores the SQL expressions verbatim, but the warning does appear for MySQL. Start a MySQL container:\r\n\r\n```bash\r\ndocker run --rm -p 1234:3306 --env MYSQL_ALLOW_EMPTY_PASSWORD=1 --name tmp mysql\r\n```\r\n\r\nThen initialize alembic and create a first revision:\r\n\r\n```bash\r\nalembic init alembic\r\n```\r\n\r\nSet the correct URL in the alembic.ini file:\r\n```ini\r\nsqlalchemy.url = mysql+pymysql://root:@localhost:1234/mysql\r\n```\r\n\r\nSet the correct metadata in `env.py`:\r\n```py\r\n...\r\nimport demo\r\ntarget_metadata = demo.Base.metadata\r\n...\r\n```\r\n\r\nGenerate a first revision and upgrade the database:\r\n\r\n```bash\r\nalembic revision --autogenerate\r\nalembic upgrade head\r\n```\r\n\r\nNow, when generating additional revisions, a warning will appear:\r\n\r\n```bash\r\nalembic revision --autogenerate\r\n```\r\n\r\n**Error**\r\n\r\n```\r\nvenv/lib/python3.11/site-packages/alembic/autogenerate/compare.py:1037: UserWarning: Computed default on mymodel.whatever cannot be modified\r\n  util.warn(\"Computed default on %s.%s cannot be modified\" % (tname, cname))\r\n  Generating ./alembic/versions/3b750bbd8b7c_.py ...  done\r\n```\r\n\r\n**Versions.**\r\n - OS: Linux\r\n - Python: 3.11.7\r\n - Alembic: 1.13.1\r\n - SQLAlchemy: 2.0.25\r\n - Database: MySQL 8.2.0\r\n - DBAPI: pymysql\r\n\r\n**Additional context**\r\n\r\nPhew, that was a lot of work to write for a two-line PR!\r\n\r\n**Have a nice day!**\r\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1391/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1391/timeline","performed_via_github_app":null,"state_reason":"completed"}