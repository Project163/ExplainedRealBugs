{"url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1323","repository_url":"https://api.github.com/repos/sqlalchemy/alembic","labels_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1323/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1323/comments","events_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1323/events","html_url":"https://github.com/sqlalchemy/alembic/issues/1323","id":1941710110,"node_id":"I_kwDOCX47u85zvCUe","number":1323,"title":"Index creation with `if_not_exists` not supported for SQLAlchemy 1.4.49","user":{"login":"inikolaev","id":7585750,"node_id":"MDQ6VXNlcjc1ODU3NTA=","avatar_url":"https://avatars.githubusercontent.com/u/7585750?v=4","gravatar_id":"","url":"https://api.github.com/users/inikolaev","html_url":"https://github.com/inikolaev","followers_url":"https://api.github.com/users/inikolaev/followers","following_url":"https://api.github.com/users/inikolaev/following{/other_user}","gists_url":"https://api.github.com/users/inikolaev/gists{/gist_id}","starred_url":"https://api.github.com/users/inikolaev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/inikolaev/subscriptions","organizations_url":"https://api.github.com/users/inikolaev/orgs","repos_url":"https://api.github.com/users/inikolaev/repos","events_url":"https://api.github.com/users/inikolaev/events{/privacy}","received_events_url":"https://api.github.com/users/inikolaev/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141242979,"node_id":"MDU6TGFiZWwxMTQxMjQyOTc5","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/op%20directives","name":"op directives","color":"90F020","default":false,"description":null},{"id":1388914604,"node_id":"MDU6TGFiZWwxMzg4OTE0NjA0","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/use%20case","name":"use case","color":"f28b2b","default":false,"description":"not quite a feature and not quite a bug, something we just didn't think of"},{"id":5152551365,"node_id":"LA_kwDOCX47u88AAAABMx2xxQ","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/PRs%20(with%20tests!)%20welcome","name":"PRs (with tests!) welcome","color":"9EE5DD","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2023-10-13T10:47:02Z","updated_at":"2023-11-17T14:18:06Z","closed_at":"2023-11-17T14:18:06Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n<!-- A clear and concise description of what the bug is. -->\r\nIndex creation with `if_not_exists` is not supported for SQLAlchemy 1.4.x\r\n\r\n**Expected behavior**\r\n<!-- A clear and concise description of what you expected to happen. -->\r\nIt should be possible to specify `if_not_exists` when creating an index and using SQLAlchemy version that supports it.\r\n\r\n**To Reproduce**\r\n\r\n* Manually create a simple table with a few fields\r\n* Manually create an index on that table\r\n* Create a migration to create an\r\n* Run the migration\r\n\r\n**Error**\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"/bin/alembic\", line 8, in <module>\r\n    sys.exit(main())\r\n             ^^^^^^\r\n  File \"/lib/python3.11/site-packages/alembic/config.py\", line 630, in main\r\n    CommandLine(prog=prog).main(argv=argv)\r\n  File \"/lib/python3.11/site-packages/alembic/config.py\", line 624, in main\r\n    self.run_cmd(cfg, options)\r\n  File \"/lib/python3.11/site-packages/alembic/config.py\", line 601, in run_cmd\r\n    fn(\r\n  File \"/lib/python3.11/site-packages/alembic/command.py\", line 399, in upgrade\r\n    script.run_env()\r\n  File \"/lib/python3.11/site-packages/alembic/script/base.py\", line 578, in run_env\r\n    util.load_python_file(self.dir, \"env.py\")\r\n  File \"/lib/python3.11/site-packages/alembic/util/pyfiles.py\", line 93, in load_python_file\r\n    module = load_module_py(module_id, path)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/lib/python3.11/site-packages/alembic/util/pyfiles.py\", line 109, in load_module_py\r\n    spec.loader.exec_module(module)  # type: ignore\r\n    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"<frozen importlib._bootstrap_external>\", line 940, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\r\n  File \"/alembic/env.py\", line 129, in <module>\r\n    run_migrations_online()\r\n  File \"/alembic/env.py\", line 122, in run_migrations_online\r\n    context.run_migrations()\r\n  File \"<string>\", line 8, in run_migrations\r\n  File \"/lib/python3.11/site-packages/alembic/runtime/environment.py\", line 937, in run_migrations\r\n    self.get_context().run_migrations(**kw)\r\n  File \"/lib/python3.11/site-packages/alembic/runtime/migration.py\", line 624, in run_migrations\r\n    step.migration_fn(**kw)\r\n  File \"/alembic/versions/2023_10_12_1551-a19846cced8b_indices.py\", line 22, in upgrade\r\n    op.create_index(\r\n  File \"<string>\", line 8, in create_index\r\n  File \"<string>\", line 3, in create_index\r\n  File \"/lib/python3.11/site-packages/alembic/operations/ops.py\", line 994, in create_index\r\n    return operations.invoke(op)\r\n           ^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/lib/python3.11/site-packages/alembic/operations/base.py\", line 393, in invoke\r\n    return fn(self, operation)\r\n           ^^^^^^^^^^^^^^^^^^^\r\n  File \"/lib/python3.11/site-packages/alembic/operations/toimpl.py\", line 102, in create_index\r\n    raise NotImplementedError(\"SQLAlchemy 2.0+ required\")\r\nNotImplementedError: SQLAlchemy 2.0+ required\r\n```\r\n\r\n**Versions.**\r\n - OS: macOS 14.1\r\n - Python: 3.11\r\n - Alembic: 1.12.0\r\n - SQLAlchemy: 1.4.49\r\n - Database: PostgreSQL\r\n - DBAPI: psycopg3\r\n\r\n**Additional context**\r\n\r\nIs it really so that SQLAlchemy 1.4.x does not support this? At least checking the source it looks like it [does](https://github.com/sqlalchemy/sqlalchemy/blob/rel_1_4/lib/sqlalchemy/dialects/postgresql/base.py#L2824-L2825).\r\n\r\nCommenting out [this](https://github.com/sqlalchemy/alembic/blob/bd8e465ded7ead899472dcc8efc4e033ff14d802/alembic/operations/toimpl.py#L100-L102) check seems to work just fine and I can see the following part of the statement generated correctly:\r\n\r\n```sql\r\nCREATE INDEX CONCURRENTLY IF NOT EXISTS\r\n```\r\n\r\nShould the requirements be lowered and allow SQLAlchemy version that does support this feature? I have seen some constants available that check for other SQLAlchemy versions, so should be pretty straightforward to support this, unless there a reason not to. \r\n\r\nI don't think we will migrate to 2.0 soon and it would be great to have this feature around.\r\n\r\n**Have a nice day!**\r\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1323/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/1323/timeline","performed_via_github_app":null,"state_reason":"completed"}