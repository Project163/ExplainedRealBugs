{"url":"https://api.github.com/repos/sqlalchemy/alembic/issues/266","repository_url":"https://api.github.com/repos/sqlalchemy/alembic","labels_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/266/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/266/comments","events_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/266/events","html_url":"https://github.com/sqlalchemy/alembic/issues/266","id":384602080,"node_id":"MDU6SXNzdWUzODQ2MDIwODA=","number":266,"title":"Using as_sql=True and autogenerate results in exception in SQLAlchemy and alembic","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141241826,"node_id":"MDU6TGFiZWwxMTQxMjQxODI2","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141242890,"node_id":"MDU6TGFiZWwxMTQxMjQyODkw","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/low%20priority","name":"low priority","color":"900080","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/alembic/milestones/4","html_url":"https://github.com/sqlalchemy/alembic/milestone/4","labels_url":"https://api.github.com/repos/sqlalchemy/alembic/milestones/4/labels","id":3850500,"node_id":"MDk6TWlsZXN0b25lMzg1MDUwMA==","number":4,"title":"fasttrack","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":47,"state":"closed","created_at":"2018-11-27T03:05:33Z","updated_at":"2020-04-10T15:00:46Z","due_on":null,"closed_at":"2020-04-10T15:00:46Z"},"comments":8,"created_at":"2015-01-14T17:21:06Z","updated_at":"2015-03-19T19:53:14Z","closed_at":"2015-03-19T19:53:14Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Johannes Erdfelt ([@jerdfelt](https://github.com/jerdfelt))**\n\nI tested this using the trunk versions of both alembic and SQLAlchemy.\n\nUsing a simple test program with as_sql=True, an exception occurs in SQLAlchemy:\n\n\n```\nTraceback (most recent call last):\n  File \"test_as_sql.py\", line 15, in <module>\n    print compare_metadata(context, metadata)\n  File \"/home/johannes/openstack/alembic/alembic/autogenerate/api.py\", line 116, in compare_metadata\n    object_filters, include_schemas)\n  File \"/home/johannes/openstack/alembic/alembic/autogenerate/api.py\", line 216, in _produce_net_changes\n    inspector = Inspector.from_engine(connection)\n  File \"/home/johannes/openstack/sqlalchemy/lib/sqlalchemy/engine/reflection.py\", line 135, in from_engine\n    return Inspector(bind)\n  File \"/home/johannes/openstack/sqlalchemy/lib/sqlalchemy/engine/reflection.py\", line 109, in __init__\n    bind.connect().close()\nAttributeError: 'NoneType' object has no attribute 'close'\n```\n\nIt appears that the mock engine used when as_sql is True doesn't return self from the connect() method (and also doesn't have a close() method at all).\n\nIf I add simple connect() and close() methods in MockConnection, then I run into another exception:\n\n```\nTraceback (most recent call last):\n  File \"test_as_sql.py\", line 15, in <module>\n    print compare_metadata(context, metadata)\n  File \"/home/johannes/openstack/alembic/alembic/autogenerate/api.py\", line 116, in compare_metadata\n    object_filters, include_schemas)\n  File \"/home/johannes/openstack/alembic/alembic/autogenerate/api.py\", line 219, in _produce_net_changes\n    default_schema = connection.dialect.default_schema_name\nAttributeError: 'MySQLDialect_mysqldb' object has no attribute 'default_schema_name'\n```\n\nLooking at the code, it seems like the connection passed in gets discarded in lieu of the mock connection. So it makes me think that the autogenerate code would never work with as_sql=True.\n\nI've worked around this (or maybe this is what I should be doing all along) by creating two different contexts. One with as_sql=False for alembic.autogenerate and then one with as_sql=True for alembic.operations.\n\n----------------------------------------\nAttachments: [test_as_sql.py](../wiki/imported_issue_attachments/266/test_as_sql.py)\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/alembic/issues/266/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/266/timeline","performed_via_github_app":null,"state_reason":"completed"}