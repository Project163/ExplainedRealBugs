{"url":"https://api.github.com/repos/sqlalchemy/alembic/issues/287","repository_url":"https://api.github.com/repos/sqlalchemy/alembic","labels_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/287/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/287/comments","events_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/287/events","html_url":"https://github.com/sqlalchemy/alembic/issues/287","id":384602278,"node_id":"MDU6SXNzdWUzODQ2MDIyNzg=","number":287,"title":"SQLite batch migrations: missing operations for index","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141241826,"node_id":"MDU6TGFiZWwxMTQxMjQxODI2","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141244719,"node_id":"MDU6TGFiZWwxMTQxMjQ0NzE5","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/batch%20migrations","name":"batch migrations","color":"405060","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2015-03-27T17:48:46Z","updated_at":"2015-03-27T19:16:15Z","closed_at":"2015-03-27T19:16:15Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by Thomas Tanner ([@ttanner](https://github.com/ttanner))**\n\nI'm trying to use batch migrations with SQLite.\nHere's a very simple example:\n```\n...\nclass Example(Base):\n    uuid = Column(String(36), unique=True, index=True, primary_key=True)\n   ...\n```\n\nIn env.py I have added  render_as_batch=True and set the metadata\n```\n...\n        for name, rec in engines.items():\n            logger.info(\"Migrating database %s\" % name)\n            context.configure(\n                        connection=rec['connection'],\n                        upgrade_token=\"%s_upgrades\" % name,\n                        downgrade_token=\"%s_downgrades\" % name,\n                        target_metadata=target_metadata.get(name),\n                        render_as_batch=True,\n                    )\n            context.run_migrations(engine_name=name)\n\n```\n\nalembic revision --autogenerate creates:\n```\n...\ndef upgrade_example():\n   op.create_table('example',\n    sa.Column('uuid', sa.String(length=36), nullable=False),\n    sa.PrimaryKeyConstraint('uuid'),\n  ...\n  )\n   with op.batch_alter_table('example', schema=None) as batch_op:\n        batch_op.create_index(batch_op.f('ix_example_uuid'), ['uuid'], unique=True)\n\n```\n\nThen \"alembic upgrade head\" fails with:\n```\n#!\n\nINFO  [alembic.env] Migrating database example\nINFO  [alembic.migration] Context impl SQLiteImpl.\nINFO  [alembic.migration] Will assume non-transactional DDL.\nINFO  [alembic.migration] Running upgrade  -> initial, empty message\nTraceback (most recent call last):\n  File \"<path>/bin/alembic\", line 9, in <module>\n    load_entry_point('alembic==0.7.5.post2', 'console_scripts', 'alembic')()\n  File \"<path>/lib/python/site-packages/alembic/config.py\", line 439, in main\n    CommandLine(prog=prog).main(argv=argv)\n  File \"<path>/lib/python/site-packages/alembic/config.py\", line 433, in main\n    self.run_cmd(cfg, options)\n  File \"<path>/lib/python/site-packages/alembic/config.py\", line 416, in run_cmd\n    **dict((k, getattr(options, k)) for k in kwarg)\n  File \"<path>/lib/python/site-packages/alembic/command.py\", line 165, in upgrade\n    script.run_env()\n  File \"<path>/lib/python/site-packages/alembic/script.py\", line 390, in run_env\n    util.load_python_file(self.dir, 'env.py')\n  File \"<path>/lib/python/site-packages/alembic/util.py\", line 243, in load_python_file\n    module = load_module_py(module_id, path)\n  File \"<path>/lib/python/site-packages/alembic/compat.py\", line 79, in load_module_py\n    mod = imp.load_source(module_id, path, fp)\n  File \"alembic/env.py\", line 173, in <module>\n    run_migrations_online()\n  File \"alembic/env.py\", line 153, in run_migrations_online\n    context.run_migrations(engine_name=name)\n  File \"<string>\", line 7, in run_migrations\n  File \"<path>/lib/python/site-packages/alembic/environment.py\", line 742, in run_migrations\n    self.get_context().run_migrations(**kw)\n  File \"<path>/lib/python/site-packages/alembic/migration.py\", line 309, in run_migrations\n    step.migration_fn(**kw)\n  File \"<proj>/alembic/versions/initial.py\", line 23, in upgrade\n    globals()[\"upgrade_%s\" % engine_name]()\n  File \"<proj>/alembic/versions/initial.py\", line 56, in upgrade_uuid\n    batch_op.create_index(batch_op.f('ix_example_uuid'), ['uuid'], unique=True)\n  File \"<path>/lib/python2.7/contextlib.py\", line 24, in __exit__\n    self.gen.next()\n  File \"<path>/lib/python/site-packages/alembic/operations.py\", line 320, in batch_alter_table\n    impl.flush()\n  File \"<path>/lib/python/site-packages/alembic/batch.py\", line 71, in flush\n    fn = getattr(batch_impl, opname)\nAttributeError: 'ApplyBatchImpl' object has no attribute 'create_index'\n\n```\n\n\"alembic upgrade head --sql\" fails with:\n\n```\n#!\n\nINFO  [alembic.env] Migrating database example\nINFO  [alembic.env] Writing output to example.sql\nINFO  [alembic.migration] Context impl SQLiteImpl.\nINFO  [alembic.migration] Generating static SQL\nINFO  [alembic.migration] Will assume non-transactional DDL.\nINFO  [alembic.migration] Running upgrade  -> initial, empty message\nTraceback (most recent call last):\n  File \"<path>/bin/alembic\", line 9, in <module>\n    load_entry_point('alembic==0.7.5.post2', 'console_scripts', 'alembic')()\n  File \"<path>/lib/python/site-packages/alembic/config.py\", line 439, in main\n    CommandLine(prog=prog).main(argv=argv)\n  File \"<path>/lib/python/site-packages/alembic/config.py\", line 433, in main\n    self.run_cmd(cfg, options)\n  File \"<path>/lib/python/site-packages/alembic/config.py\", line 416, in run_cmd\n    **dict((k, getattr(options, k)) for k in kwarg)\n  File \"<path>/lib/python/site-packages/alembic/command.py\", line 165, in upgrade\n    script.run_env()\n  File \"<path>/lib/python/site-packages/alembic/script.py\", line 390, in run_env\n    util.load_python_file(self.dir, 'env.py')\n  File \"<path>/lib/python/site-packages/alembic/util.py\", line 243, in load_python_file\n    module = load_module_py(module_id, path)\n  File \"<path>/lib/python/site-packages/alembic/compat.py\", line 79, in load_module_py\n    mod = imp.load_source(module_id, path, fp)\n  File \"alembic/env.py\", line 171, in <module>\n    run_migrations_offline()\n  File \"alembic/env.py\", line 112, in run_migrations_offline\n    context.run_migrations(engine_name=name)\n  File \"<string>\", line 7, in run_migrations\n  File \"<path>/lib/python/site-packages/alembic/environment.py\", line 742, in run_migrations\n    self.get_context().run_migrations(**kw)\n  File \"<path>/lib/python/site-packages/alembic/migration.py\", line 309, in run_migrations\n    step.migration_fn(**kw)\n  File \"<proj>/alembic/versions/initial.py\", line 23, in upgrade\n    globals()[\"upgrade_%s\" % engine_name]()\n  File \"<proj>/alembic/versions/initial.py\", line 56, in upgrade_example\n    batch_op.create_index(batch_op.f('ix_example_uuid'), ['uuid'], unique=True)\n  File \"<path>/lib/python2.7/contextlib.py\", line 24, in __exit__\n    self.gen.next()\n  File \"<path>/lib/python/site-packages/alembic/operations.py\", line 320, in batch_alter_table\n    impl.flush()\n  File \"<path>/lib/python/site-packages/alembic/batch.py\", line 66, in flush\n    *self.reflect_args, **self.reflect_kwargs)\n  File \"<path>/lib/python/site-packages/sqlalchemy/sql/schema.py\", line 406, in __new__\n    table._init(name, metadata, *args, **kw)\n  File \"<path>/lib/python/site-packages/sqlalchemy/sql/schema.py\", line 479, in _init\n    self._autoload(metadata, autoload_with, include_columns)\n  File \"<path>/lib/python/site-packages/sqlalchemy/sql/schema.py\", line 489, in _autoload\n    autoload_with.run_callable(\nAttributeError: 'MockConnection' object has no attribute 'run_callable'\n```\n\n\nsqlalchemy 0.9.9, alembic 0.7.5post2, Python 2.7.9\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/alembic/issues/287/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/287/timeline","performed_via_github_app":null,"state_reason":"completed"}