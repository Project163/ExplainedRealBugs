{"url":"https://api.github.com/repos/sqlalchemy/alembic/issues/318","repository_url":"https://api.github.com/repos/sqlalchemy/alembic","labels_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/318/labels{/name}","comments_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/318/comments","events_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/318/events","html_url":"https://github.com/sqlalchemy/alembic/issues/318","id":384602548,"node_id":"MDU6SXNzdWUzODQ2MDI1NDg=","number":318,"title":"Using autogenerate first time on multi-database env generates invalid revision file.","user":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1141241826,"node_id":"MDU6TGFiZWwxMTQxMjQxODI2","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":1141243076,"node_id":"MDU6TGFiZWwxMTQxMjQzMDc2","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/high%20priority","name":"high priority","color":"8030B0","default":false,"description":null},{"id":1141243519,"node_id":"MDU6TGFiZWwxMTQxMjQzNTE5","url":"https://api.github.com/repos/sqlalchemy/alembic/labels/autogenerate%20-%20rendering","name":"autogenerate - rendering","color":"00B0E0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sqlalchemy/alembic/milestones/4","html_url":"https://github.com/sqlalchemy/alembic/milestone/4","labels_url":"https://api.github.com/repos/sqlalchemy/alembic/milestones/4/labels","id":3850500,"node_id":"MDk6TWlsZXN0b25lMzg1MDUwMA==","number":4,"title":"fasttrack","description":null,"creator":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":47,"state":"closed","created_at":"2018-11-27T03:05:33Z","updated_at":"2020-04-10T15:00:46Z","due_on":null,"closed_at":"2020-04-10T15:00:46Z"},"comments":8,"created_at":"2015-08-20T06:28:07Z","updated_at":"2015-08-21T01:05:17Z","closed_at":"2015-08-20T22:53:28Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Migrated issue, originally created by pipoket ([@pipoket](https://github.com/pipoket))**\n\n# Description\n\nI was looking into alembic to figure out whether i could use it on my project, but ended up finding out some strange behavior.\n\nAs my project is using multiple databases, I followed the documentation to prepare alembic environment and tried to generate 'initial' migration revision file with current database schema.\n\nHowever, strangely, the revision file generated contained all the tables from every other database on *single* database upgrade/downgrade function. And as expected, running the migration on clean database using the revision file made all the tables to be created on single database.\n\n\n# How to Reproduce the Problem\n\nHere is the minimized test case for reproducing what I explained above.\n\n## Model & Configurations\n\nThis is the ```models.py``` file for model declaration.\n```\nfrom sqlalchemy import Table, Column, Integer\nfrom sqlalchemy.ext.declarative import declarative_base\n\n\nBaseA = declarative_base()\n\nclass TableA(BaseA):\n    __tablename__ = \"TableA\"\n\n    id = Column(Integer, autoincrement=True, primary_key=True)\n\n\nBaseB = declarative_base()\n\nclass TableB(BaseB):\n    __tablename__ = \"TableB\"\n\n    id = Column(Integer, autoincrement=True, primary_key=True)\n```\n\nAlembic is configured like following:\n\n```\n// alembic.ini\n// Only updated 'databases' portion of the file with sections for each database\n\n// ...(snip)...\n\ndatabases = my_database_a, my_database_b\n\n[my_database_a]\nsqlalchemy.url = mysql+mysqldb://user_a:user_a@127.0.0.1:18920/my_database_a?charset=utf8\n\n[my_database_b]\nsqlalchemy.url = mysql+mysqldb://user_b:user_b@127.0.0.1:18920/my_database_b?charset=utf8\n\n// ...(snip)...\n```\n\n```\n# alembic/env.py\n# Only updated 'target_metadata' portion of the file\n\n# ...(snip)...\n\nimport os\nimport sys\nMODEL_PATH = os.path.join(os.path.abspath(os.path.dirname(__file__)), \"..\")\nsys.path.append(MODEL_PATH)\n\nfrom model import *\ntarget_metadata = {\n        'my_database_a': BaseA.metadata,\n        'my_database_b': BaseB.metadata,\n}\n\n# ...(snip)...\n```\n\nNote that above ```alembic.ini``` file has non-standard port for mysql connection which I use on my development environment (and yes, mysqld is properly running and connection can be made).\n\n## Procedure\n\n1\\. Make empty database for both tables\n\n2\\. Try to generate revision file using autogenerate feature like blow\n\n```\n$ alembic revision --autogenerate -m \"initial\"\nINFO  [alembic.env] Migrating database my_database_b\nINFO  [alembic.runtime.migration] Context impl MySQLImpl.\nINFO  [alembic.runtime.migration] Will assume non-transactional DDL.\nINFO  [alembic.autogenerate.compare] Detected added table 'TableB'\nINFO  [alembic.env] Migrating database my_database_a\nINFO  [alembic.runtime.migration] Context impl MySQLImpl.\nINFO  [alembic.runtime.migration] Will assume non-transactional DDL.\nINFO  [alembic.autogenerate.compare] Detected added table 'TableA'\n  Generating /home/pipoket/testcase/alembic/versions/5863df07ca83_init.py ... done\n```\n\n3\\. Generated revision file contains all the tables within single database, this is the problem.\n\n```\n\"\"\"init\n\nRevision ID: 5863df07ca83\nRevises:\nCreate Date: 2015-08-20 14:36:12.803208\n\n\"\"\"\n\n# revision identifiers, used by Alembic.\nrevision = '5863df07ca83'\ndown_revision = None\nbranch_labels = None\ndepends_on = None\n\nfrom alembic import op\nimport sqlalchemy as sa\n\n\ndef upgrade(engine_name):\n    globals()[\"upgrade_%s\" % engine_name]()\n\n\ndef downgrade(engine_name):\n    globals()[\"downgrade_%s\" % engine_name]()\n\n\n\n\n\ndef upgrade_my_database_a():\n    ### commands auto generated by Alembic - please adjust! ###\n    op.create_table('TableB',\n    sa.Column('id', sa.Integer(), nullable=False),\n    sa.PrimaryKeyConstraint('id')\n    )\n    op.create_table('TableA',\n    sa.Column('id', sa.Integer(), nullable=False),\n    sa.PrimaryKeyConstraint('id')\n    )\n    ### end Alembic commands ###\n\n\ndef downgrade_my_database_a():\n    ### commands auto generated by Alembic - please adjust! ###\n    op.drop_table('TableA')\n    op.drop_table('TableB')\n    ### end Alembic commands ###\n\n\ndef upgrade_my_database_b():\n    pass\n\n\ndef downgrade_my_database_b():\n    pass\n```\n\n4\\. Making first migration using file above creates all the tables within *single* database, as expected from the revision file itself.\n\n```\n $ alembic upgrade 5863df07ca83\n INFO  [alembic.env] Migrating database my_database_b\n INFO  [alembic.runtime.migration] Context impl MySQLImpl.\n INFO  [alembic.runtime.migration] Will assume non-transactional DDL.\n INFO  [alembic.runtime.migration] Running upgrade  -> 5863df07ca83, init\n INFO  [alembic.env] Migrating database my_database_a\n INFO  [alembic.runtime.migration] Context impl MySQLImpl.\n INFO  [alembic.runtime.migration] Will assume non-transactional DDL.\n INFO  [alembic.runtime.migration] Running upgrade  -> 5863df07ca83, init\n\n $ mysql -uroot -p\n mysql> use my_database_a;\n Database changed\n mysql> show tables;\n +-------------------------+\n | Tables_in_my_database_a |\n +-------------------------+\n | TableA                  |\n | TableB                  |\n | alembic_version         |\n +-------------------------+\n 3 rows in set (0.00 sec)\n mysql> use my_database_b;\n Database changed\n mysql> show tables;\n +-------------------------+\n | Tables_in_my_database_b |\n +-------------------------+\n | alembic_version         |\n +-------------------------+\n 1 row in set (0.00 sec)\n```\n\n\n## Expected Behavior\n\nI expected autogenerate feature to generate the revision file like fowllowing:\n\n```\n\"\"\"init\n\nRevision ID: 5863df07ca83\nRevises:\nCreate Date: 2015-08-20 14:36:12.803208\n\n\"\"\"\n\n# revision identifiers, used by Alembic.\nrevision = '5863df07ca83'\ndown_revision = None\nbranch_labels = None\ndepends_on = None\n\nfrom alembic import op\nimport sqlalchemy as sa\n\n\ndef upgrade(engine_name):\n    globals()[\"upgrade_%s\" % engine_name]()\n\n\ndef downgrade(engine_name):\n    globals()[\"downgrade_%s\" % engine_name]()\n\n\n\n\n\ndef upgrade_my_database_a():\n    ### commands auto generated by Alembic - please adjust! ###\n    op.create_table('TableB',\n    sa.Column('id', sa.Integer(), nullable=False),\n    sa.PrimaryKeyConstraint('id')\n    )\n    op.create_table('TableA',\n    sa.Column('id', sa.Integer(), nullable=False),\n    sa.PrimaryKeyConstraint('id')\n    )\n    ### end Alembic commands ###\n\n\ndef downgrade_my_database_a():\n    ### commands auto generated by Alembic - please adjust! ###\n    op.drop_table('TableA')\n    ### end Alembic commands ###\n\n\ndef upgrade_my_database_b():\n    ### commands auto generated by Alembic - please adjust! ###\n    op.create_table('TableB',\n    sa.Column('id', sa.Integer(), nullable=False),\n    sa.PrimaryKeyConstraint('id')\n    )\n    ### end Alembic commands ###\n\n\ndef downgrade_my_database_b():\n    ### commands auto generated by Alembic - please adjust! ###\n    op.drop_table('TableB')\n    ### end Alembic commands ###\n```\n\n\n# Conclusion\n\nThere is a possibility that I might have completely misunderstood the proper usage of alembic. If so, please feel free to let me know. Otherwise, I would really appreciate it if you look into the case above whether it is a bug or expected behavior.\n\n","closed_by":{"login":"sqlalchemy-bot","id":36047385,"node_id":"MDQ6VXNlcjM2MDQ3Mzg1","avatar_url":"https://avatars.githubusercontent.com/u/36047385?v=4","gravatar_id":"","url":"https://api.github.com/users/sqlalchemy-bot","html_url":"https://github.com/sqlalchemy-bot","followers_url":"https://api.github.com/users/sqlalchemy-bot/followers","following_url":"https://api.github.com/users/sqlalchemy-bot/following{/other_user}","gists_url":"https://api.github.com/users/sqlalchemy-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/sqlalchemy-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sqlalchemy-bot/subscriptions","organizations_url":"https://api.github.com/users/sqlalchemy-bot/orgs","repos_url":"https://api.github.com/users/sqlalchemy-bot/repos","events_url":"https://api.github.com/users/sqlalchemy-bot/events{/privacy}","received_events_url":"https://api.github.com/users/sqlalchemy-bot/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sqlalchemy/alembic/issues/318/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sqlalchemy/alembic/issues/318/timeline","performed_via_github_app":null,"state_reason":"completed"}