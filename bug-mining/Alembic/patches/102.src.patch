diff --git a/alembic/testing/env.py b/alembic/testing/env.py
index 15f7777..473c73e 100644
--- a/alembic/testing/env.py
+++ b/alembic/testing/env.py
@@ -60,6 +60,9 @@ def staging_env(create=True, template="generic", sourceless=False):
 
 
 def clear_staging_env():
+    from sqlalchemy.testing import engines
+
+    engines.testing_reaper.close_all()
     shutil.rmtree(_get_staging_directory(), True)
 
 
diff --git a/tests/test_command.py b/tests/test_command.py
index af8272d..b866d63 100644
--- a/tests/test_command.py
+++ b/tests/test_command.py
@@ -100,8 +100,14 @@ finally:
         if env_token:
             assert_lines.insert(0, "environment included OK")
 
+        actual = (
+            buf.getvalue()
+            .decode("ascii", "replace")
+            .replace(os.linesep, "\n")
+            .strip()
+        )
         eq_(
-            buf.getvalue().decode("ascii", "replace").strip(),
+            actual,
             "\n".join(assert_lines)
             .encode("ascii", "replace")
             .decode("ascii")
@@ -879,9 +885,9 @@ class EditTest(TestBase):
         command.stamp(self.cfg, "base")
 
     def test_edit_head(self):
-        expected_call_arg = "%s/scripts/versions/%s_revision_c.py" % (
-            EditTest.cfg.config_args["here"],
-            EditTest.c,
+        expected_call_arg = os.path.normpath(
+            "%s/scripts/versions/%s_revision_c.py"
+            % (EditTest.cfg.config_args["here"], EditTest.c,)
         )
 
         with mock.patch("alembic.util.edit") as edit:
@@ -889,9 +895,9 @@ class EditTest(TestBase):
             edit.assert_called_with(expected_call_arg)
 
     def test_edit_b(self):
-        expected_call_arg = "%s/scripts/versions/%s_revision_b.py" % (
-            EditTest.cfg.config_args["here"],
-            EditTest.b,
+        expected_call_arg = os.path.normpath(
+            "%s/scripts/versions/%s_revision_b.py"
+            % (EditTest.cfg.config_args["here"], EditTest.b,)
         )
 
         with mock.patch("alembic.util.edit") as edit:
@@ -928,9 +934,9 @@ class EditTest(TestBase):
         )
 
     def test_edit_current(self):
-        expected_call_arg = "%s/scripts/versions/%s_revision_b.py" % (
-            EditTest.cfg.config_args["here"],
-            EditTest.b,
+        expected_call_arg = os.path.normpath(
+            "%s/scripts/versions/%s_revision_b.py"
+            % (EditTest.cfg.config_args["here"], EditTest.b,)
         )
 
         command.stamp(self.cfg, self.b)
@@ -1096,7 +1102,10 @@ class CommandLineTest(TestBase):
             "alembic.command.ScriptDirectory"
         ):
             command.init(self.cfg, directory="foobar")
-            eq_(makedirs.mock_calls, [mock.call("foobar/versions")])
+            eq_(
+                makedirs.mock_calls,
+                [mock.call(os.path.normpath("foobar/versions"))],
+            )
 
     def test_init_file_doesnt_exist(self):
         def access_(path, mode):
@@ -1113,7 +1122,10 @@ class CommandLineTest(TestBase):
             command.init(self.cfg, directory="foobar")
             eq_(
                 makedirs.mock_calls,
-                [mock.call("foobar"), mock.call("foobar/versions")],
+                [
+                    mock.call("foobar"),
+                    mock.call(os.path.normpath("foobar/versions")),
+                ],
             )
 
     def test_init_w_package(self):
diff --git a/tests/test_script_production.py b/tests/test_script_production.py
index ae2a2b8..aca16a3 100644
--- a/tests/test_script_production.py
+++ b/tests/test_script_production.py
@@ -1236,9 +1236,9 @@ def downgrade():
         clear_staging_env()
 
     def test_env_emits_warning(self):
-        with assertions.expect_warnings(
+        msg = (
             "File %s loaded twice! ignoring. "
-            "Please ensure version_locations is unique"
+            "Please ensure version_locations is unique."
             % (
                 os.path.realpath(
                     os.path.join(
@@ -1248,7 +1248,8 @@ def downgrade():
                     )
                 )
             )
-        ):
+        )
+        with assertions.expect_warnings(msg, regex=False):
             script = ScriptDirectory.from_config(self.cfg)
             script.revision_map.heads
             eq_(
