{"url":"https://api.github.com/repos/jmoiron/sqlx/issues/366","repository_url":"https://api.github.com/repos/jmoiron/sqlx","labels_url":"https://api.github.com/repos/jmoiron/sqlx/issues/366/labels{/name}","comments_url":"https://api.github.com/repos/jmoiron/sqlx/issues/366/comments","events_url":"https://api.github.com/repos/jmoiron/sqlx/issues/366/events","html_url":"https://github.com/jmoiron/sqlx/issues/366","id":275042868,"node_id":"MDU6SXNzdWUyNzUwNDI4Njg=","number":366,"title":"sqlx.Connect - close db connection if db.Ping() fails","user":{"login":"somersf","id":14315598,"node_id":"MDQ6VXNlcjE0MzE1NTk4","avatar_url":"https://avatars.githubusercontent.com/u/14315598?v=4","gravatar_id":"","url":"https://api.github.com/users/somersf","html_url":"https://github.com/somersf","followers_url":"https://api.github.com/users/somersf/followers","following_url":"https://api.github.com/users/somersf/following{/other_user}","gists_url":"https://api.github.com/users/somersf/gists{/gist_id}","starred_url":"https://api.github.com/users/somersf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/somersf/subscriptions","organizations_url":"https://api.github.com/users/somersf/orgs","repos_url":"https://api.github.com/users/somersf/repos","events_url":"https://api.github.com/users/somersf/events{/privacy}","received_events_url":"https://api.github.com/users/somersf/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2017-11-18T01:43:10Z","updated_at":"2017-11-29T23:28:51Z","closed_at":"2017-11-29T23:28:51Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The current code leaves the db connection open if the ping fails, and returns it to the caller along with the error.\r\n```\r\nfunc Connect(driverName, dataSourceName string) (*DB, error) {\r\n\tdb, err := Open(driverName, dataSourceName)\r\n\tif err != nil {\r\n\t\treturn db, err\r\n\t}\r\n\terr = db.Ping()\r\n\treturn db, err\r\n}\r\n```\r\n\r\nIMHO it should be cleaning it up if Ping fails, rather than returning it to the caller.  Most go code assumes that if an error is returned the other return values are at their \"zero value\".\r\n\r\nI would expect that the last few lines should instead be:\r\n```\r\n\terr = db.Ping()\r\n\tif err != nil {\r\n\t\tdb.Close()\r\n\t\treturn nil, err\r\n\t}\r\n\treturn db, nil\r\n}\r\n```\r\n","closed_by":{"login":"jmoiron","id":218132,"node_id":"MDQ6VXNlcjIxODEzMg==","avatar_url":"https://avatars.githubusercontent.com/u/218132?v=4","gravatar_id":"","url":"https://api.github.com/users/jmoiron","html_url":"https://github.com/jmoiron","followers_url":"https://api.github.com/users/jmoiron/followers","following_url":"https://api.github.com/users/jmoiron/following{/other_user}","gists_url":"https://api.github.com/users/jmoiron/gists{/gist_id}","starred_url":"https://api.github.com/users/jmoiron/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jmoiron/subscriptions","organizations_url":"https://api.github.com/users/jmoiron/orgs","repos_url":"https://api.github.com/users/jmoiron/repos","events_url":"https://api.github.com/users/jmoiron/events{/privacy}","received_events_url":"https://api.github.com/users/jmoiron/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/jmoiron/sqlx/issues/366/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/jmoiron/sqlx/issues/366/timeline","performed_via_github_app":null,"state_reason":"completed"}