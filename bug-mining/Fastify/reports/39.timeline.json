[{"actor":{"login":"ericmacfa","id":18381801,"node_id":"MDQ6VXNlcjE4MzgxODAx","avatar_url":"https://avatars.githubusercontent.com/u/18381801?v=4","gravatar_id":"","url":"https://api.github.com/users/ericmacfa","html_url":"https://github.com/ericmacfa","followers_url":"https://api.github.com/users/ericmacfa/followers","following_url":"https://api.github.com/users/ericmacfa/following{/other_user}","gists_url":"https://api.github.com/users/ericmacfa/gists{/gist_id}","starred_url":"https://api.github.com/users/ericmacfa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ericmacfa/subscriptions","organizations_url":"https://api.github.com/users/ericmacfa/orgs","repos_url":"https://api.github.com/users/ericmacfa/repos","events_url":"https://api.github.com/users/ericmacfa/events{/privacy}","received_events_url":"https://api.github.com/users/ericmacfa/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-05T15:43:09Z","updated_at":"2019-07-05T15:43:09Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/SerayaEryn/fastify-session/issues/65","repository_url":"https://api.github.com/repos/SerayaEryn/fastify-session","labels_url":"https://api.github.com/repos/SerayaEryn/fastify-session/issues/65/labels{/name}","comments_url":"https://api.github.com/repos/SerayaEryn/fastify-session/issues/65/comments","events_url":"https://api.github.com/repos/SerayaEryn/fastify-session/issues/65/events","html_url":"https://github.com/SerayaEryn/fastify-session/issues/65","id":463801611,"node_id":"MDU6SXNzdWU0NjM4MDE2MTE=","number":65,"title":"Request handler called even when response.redirect() is called in preHandler","user":{"login":"ericmacfa","id":18381801,"node_id":"MDQ6VXNlcjE4MzgxODAx","avatar_url":"https://avatars.githubusercontent.com/u/18381801?v=4","gravatar_id":"","url":"https://api.github.com/users/ericmacfa","html_url":"https://github.com/ericmacfa","followers_url":"https://api.github.com/users/ericmacfa/followers","following_url":"https://api.github.com/users/ericmacfa/following{/other_user}","gists_url":"https://api.github.com/users/ericmacfa/gists{/gist_id}","starred_url":"https://api.github.com/users/ericmacfa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ericmacfa/subscriptions","organizations_url":"https://api.github.com/users/ericmacfa/orgs","repos_url":"https://api.github.com/users/ericmacfa/repos","events_url":"https://api.github.com/users/ericmacfa/events{/privacy}","received_events_url":"https://api.github.com/users/ericmacfa/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":732175145,"node_id":"MDU6TGFiZWw3MzIxNzUxNDU=","url":"https://api.github.com/repos/SerayaEryn/fastify-session/labels/question","name":"question","color":"cc317c","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2019-07-03T14:57:04Z","updated_at":"2019-07-05T15:43:09Z","closed_at":"2019-07-05T15:43:09Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":108468603,"node_id":"MDEwOlJlcG9zaXRvcnkxMDg0Njg2MDM=","name":"fastify-session","full_name":"SerayaEryn/fastify-session","private":false,"owner":{"login":"SerayaEryn","id":22620443,"node_id":"MDQ6VXNlcjIyNjIwNDQz","avatar_url":"https://avatars.githubusercontent.com/u/22620443?v=4","gravatar_id":"","url":"https://api.github.com/users/SerayaEryn","html_url":"https://github.com/SerayaEryn","followers_url":"https://api.github.com/users/SerayaEryn/followers","following_url":"https://api.github.com/users/SerayaEryn/following{/other_user}","gists_url":"https://api.github.com/users/SerayaEryn/gists{/gist_id}","starred_url":"https://api.github.com/users/SerayaEryn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SerayaEryn/subscriptions","organizations_url":"https://api.github.com/users/SerayaEryn/orgs","repos_url":"https://api.github.com/users/SerayaEryn/repos","events_url":"https://api.github.com/users/SerayaEryn/events{/privacy}","received_events_url":"https://api.github.com/users/SerayaEryn/received_events","type":"User","user_view_type":"public","site_admin":false},"html_url":"https://github.com/SerayaEryn/fastify-session","description":"session plugin for fastify","fork":false,"url":"https://api.github.com/repos/SerayaEryn/fastify-session","forks_url":"https://api.github.com/repos/SerayaEryn/fastify-session/forks","keys_url":"https://api.github.com/repos/SerayaEryn/fastify-session/keys{/key_id}","collaborators_url":"https://api.github.com/repos/SerayaEryn/fastify-session/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/SerayaEryn/fastify-session/teams","hooks_url":"https://api.github.com/repos/SerayaEryn/fastify-session/hooks","issue_events_url":"https://api.github.com/repos/SerayaEryn/fastify-session/issues/events{/number}","events_url":"https://api.github.com/repos/SerayaEryn/fastify-session/events","assignees_url":"https://api.github.com/repos/SerayaEryn/fastify-session/assignees{/user}","branches_url":"https://api.github.com/repos/SerayaEryn/fastify-session/branches{/branch}","tags_url":"https://api.github.com/repos/SerayaEryn/fastify-session/tags","blobs_url":"https://api.github.com/repos/SerayaEryn/fastify-session/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/SerayaEryn/fastify-session/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/SerayaEryn/fastify-session/git/refs{/sha}","trees_url":"https://api.github.com/repos/SerayaEryn/fastify-session/git/trees{/sha}","statuses_url":"https://api.github.com/repos/SerayaEryn/fastify-session/statuses/{sha}","languages_url":"https://api.github.com/repos/SerayaEryn/fastify-session/languages","stargazers_url":"https://api.github.com/repos/SerayaEryn/fastify-session/stargazers","contributors_url":"https://api.github.com/repos/SerayaEryn/fastify-session/contributors","subscribers_url":"https://api.github.com/repos/SerayaEryn/fastify-session/subscribers","subscription_url":"https://api.github.com/repos/SerayaEryn/fastify-session/subscription","commits_url":"https://api.github.com/repos/SerayaEryn/fastify-session/commits{/sha}","git_commits_url":"https://api.github.com/repos/SerayaEryn/fastify-session/git/commits{/sha}","comments_url":"https://api.github.com/repos/SerayaEryn/fastify-session/comments{/number}","issue_comment_url":"https://api.github.com/repos/SerayaEryn/fastify-session/issues/comments{/number}","contents_url":"https://api.github.com/repos/SerayaEryn/fastify-session/contents/{+path}","compare_url":"https://api.github.com/repos/SerayaEryn/fastify-session/compare/{base}...{head}","merges_url":"https://api.github.com/repos/SerayaEryn/fastify-session/merges","archive_url":"https://api.github.com/repos/SerayaEryn/fastify-session/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/SerayaEryn/fastify-session/downloads","issues_url":"https://api.github.com/repos/SerayaEryn/fastify-session/issues{/number}","pulls_url":"https://api.github.com/repos/SerayaEryn/fastify-session/pulls{/number}","milestones_url":"https://api.github.com/repos/SerayaEryn/fastify-session/milestones{/number}","notifications_url":"https://api.github.com/repos/SerayaEryn/fastify-session/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/SerayaEryn/fastify-session/labels{/name}","releases_url":"https://api.github.com/repos/SerayaEryn/fastify-session/releases{/id}","deployments_url":"https://api.github.com/repos/SerayaEryn/fastify-session/deployments","created_at":"2017-10-26T21:41:45Z","updated_at":"2024-11-25T15:55:58Z","pushed_at":"2023-03-07T04:57:12Z","git_url":"git://github.com/SerayaEryn/fastify-session.git","ssh_url":"git@github.com:SerayaEryn/fastify-session.git","clone_url":"https://github.com/SerayaEryn/fastify-session.git","svn_url":"https://github.com/SerayaEryn/fastify-session","homepage":"","size":182,"stargazers_count":102,"watchers_count":102,"language":"JavaScript","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":32,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":19,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["fastify","nodejs","session"],"visibility":"public","forks":32,"open_issues":19,"watchers":102,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"_**Disclaimer:** I'm not absolutely certain whether this ticket is a bug with this plugin, or with Fastify itself, but I was not able to reproduce without using this plugin._\r\n\r\n** Summary**\r\nTLDR: A route's handler is still called even when the `preHandler` hook (of the same route) calls `reply.redirect(...)`\r\n\r\nI have a route with a `preHandler` hook, and the hook is intended to protect the route by checking if the request is authenticated. If the request is not authenticated, then it is redirected to the login route. However, even when `reply.redirect('/login')` is called inside the route's `preHandler`, the route's handler is still called.\r\n\r\n----\r\n\r\n**Setup**\r\n1. `npm init -y && npm i -S fastify fastify-cookie fastify-session memorystore ms`\r\n2. Add the code from [this gist](https://gist.github.com/ericmacfa/20f70db342c8aed7feea844a847975aa) to `index.js`\r\n3. `node ./index.js`\r\n\r\n**Steps to reproduce**\r\n1. `curl -L localhost:3000` (Or via a browser, postman, etc.)\r\n2. Notice that the server log shows\r\n    ```\r\n    GET / -> preHandler()\r\n    GET / -> handler() !! This should never be shown !!\r\n    GET /login -> handler()\r\n    ```\r\n\r\n----\r\n\r\nI think it's important to note that this issue does not occur in the following scenarios:\r\n1. An error is thrown after `reply.redirect('/login')`\r\n2. The `preHandler` hook uses the [callback signature](https://github.com/fastify/fastify/blob/master/docs/Hooks.md#requestresponse-hooks), and does not call `next()` if the request is not authenticated\r\n\r\n\r\nUnfortunately I'm at a loss for where to start with this investigation, this seems like a very wonky issue ðŸ¤”","reactions":{"url":"https://api.github.com/repos/SerayaEryn/fastify-session/issues/65/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/SerayaEryn/fastify-session/issues/65/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"id":2463989325,"node_id":"MDEyOkxhYmVsZWRFdmVudDI0NjM5ODkzMjU=","url":"https://api.github.com/repos/fastify/fastify/issues/events/2463989325","actor":{"login":"Eomm","id":11404065,"node_id":"MDQ6VXNlcjExNDA0MDY1","avatar_url":"https://avatars.githubusercontent.com/u/11404065?v=4","gravatar_id":"","url":"https://api.github.com/users/Eomm","html_url":"https://github.com/Eomm","followers_url":"https://api.github.com/users/Eomm/followers","following_url":"https://api.github.com/users/Eomm/following{/other_user}","gists_url":"https://api.github.com/users/Eomm/gists{/gist_id}","starred_url":"https://api.github.com/users/Eomm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Eomm/subscriptions","organizations_url":"https://api.github.com/users/Eomm/orgs","repos_url":"https://api.github.com/users/Eomm/repos","events_url":"https://api.github.com/users/Eomm/events{/privacy}","received_events_url":"https://api.github.com/users/Eomm/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2019-07-06T15:30:08Z","label":{"name":"bug","color":"ee0701"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/fastify/fastify/issues/comments/508934868","html_url":"https://github.com/fastify/fastify/issues/1733#issuecomment-508934868","issue_url":"https://api.github.com/repos/fastify/fastify/issues/1733","id":508934868,"node_id":"MDEyOklzc3VlQ29tbWVudDUwODkzNDg2OA==","user":{"login":"Eomm","id":11404065,"node_id":"MDQ6VXNlcjExNDA0MDY1","avatar_url":"https://avatars.githubusercontent.com/u/11404065?v=4","gravatar_id":"","url":"https://api.github.com/users/Eomm","html_url":"https://github.com/Eomm","followers_url":"https://api.github.com/users/Eomm/followers","following_url":"https://api.github.com/users/Eomm/following{/other_user}","gists_url":"https://api.github.com/users/Eomm/gists{/gist_id}","starred_url":"https://api.github.com/users/Eomm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Eomm/subscriptions","organizations_url":"https://api.github.com/users/Eomm/orgs","repos_url":"https://api.github.com/users/Eomm/repos","events_url":"https://api.github.com/users/Eomm/events{/privacy}","received_events_url":"https://api.github.com/users/Eomm/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-06T15:35:16Z","updated_at":"2019-07-06T15:35:16Z","body":"Hi,\r\nthank you for reporting. Would you like to give it a shot?\r\n\r\nOtherwise, you could apply the following workaround right now:\r\n\r\n```js\r\n  preHandler: function (request, reply, next) {\r\n    console.log('GET / -> preHandler()')\r\n    reply.redirect('/login')\r\n    next(new Error('redirect'))\r\n  },\r\n```\r\nNB: this will not trigger the `fastify.setErrorHandler` function ðŸ‘\r\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/fastify/fastify/issues/comments/508934868/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Eomm","id":11404065,"node_id":"MDQ6VXNlcjExNDA0MDY1","avatar_url":"https://avatars.githubusercontent.com/u/11404065?v=4","gravatar_id":"","url":"https://api.github.com/users/Eomm","html_url":"https://github.com/Eomm","followers_url":"https://api.github.com/users/Eomm/followers","following_url":"https://api.github.com/users/Eomm/following{/other_user}","gists_url":"https://api.github.com/users/Eomm/gists{/gist_id}","starred_url":"https://api.github.com/users/Eomm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Eomm/subscriptions","organizations_url":"https://api.github.com/users/Eomm/orgs","repos_url":"https://api.github.com/users/Eomm/repos","events_url":"https://api.github.com/users/Eomm/events{/privacy}","received_events_url":"https://api.github.com/users/Eomm/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/fastify/fastify/issues/comments/509208021","html_url":"https://github.com/fastify/fastify/issues/1733#issuecomment-509208021","issue_url":"https://api.github.com/repos/fastify/fastify/issues/1733","id":509208021,"node_id":"MDEyOklzc3VlQ29tbWVudDUwOTIwODAyMQ==","user":{"login":"ericmacfa","id":18381801,"node_id":"MDQ6VXNlcjE4MzgxODAx","avatar_url":"https://avatars.githubusercontent.com/u/18381801?v=4","gravatar_id":"","url":"https://api.github.com/users/ericmacfa","html_url":"https://github.com/ericmacfa","followers_url":"https://api.github.com/users/ericmacfa/followers","following_url":"https://api.github.com/users/ericmacfa/following{/other_user}","gists_url":"https://api.github.com/users/ericmacfa/gists{/gist_id}","starred_url":"https://api.github.com/users/ericmacfa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ericmacfa/subscriptions","organizations_url":"https://api.github.com/users/ericmacfa/orgs","repos_url":"https://api.github.com/users/ericmacfa/repos","events_url":"https://api.github.com/users/ericmacfa/events{/privacy}","received_events_url":"https://api.github.com/users/ericmacfa/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-08T12:38:02Z","updated_at":"2019-07-08T12:38:12Z","body":"I'd like to take a look, but I'm still wrapping my head around the fastify codebase, so don't wait up for me ðŸ˜„.  \r\nIf I find the source of the bug before someone else opens a PR, then I'll go ahead and submit it ðŸ‘","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/fastify/fastify/issues/comments/509208021/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ericmacfa","id":18381801,"node_id":"MDQ6VXNlcjE4MzgxODAx","avatar_url":"https://avatars.githubusercontent.com/u/18381801?v=4","gravatar_id":"","url":"https://api.github.com/users/ericmacfa","html_url":"https://github.com/ericmacfa","followers_url":"https://api.github.com/users/ericmacfa/followers","following_url":"https://api.github.com/users/ericmacfa/following{/other_user}","gists_url":"https://api.github.com/users/ericmacfa/gists{/gist_id}","starred_url":"https://api.github.com/users/ericmacfa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ericmacfa/subscriptions","organizations_url":"https://api.github.com/users/ericmacfa/orgs","repos_url":"https://api.github.com/users/ericmacfa/repos","events_url":"https://api.github.com/users/ericmacfa/events{/privacy}","received_events_url":"https://api.github.com/users/ericmacfa/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"SerayaEryn","id":22620443,"node_id":"MDQ6VXNlcjIyNjIwNDQz","avatar_url":"https://avatars.githubusercontent.com/u/22620443?v=4","gravatar_id":"","url":"https://api.github.com/users/SerayaEryn","html_url":"https://github.com/SerayaEryn","followers_url":"https://api.github.com/users/SerayaEryn/followers","following_url":"https://api.github.com/users/SerayaEryn/following{/other_user}","gists_url":"https://api.github.com/users/SerayaEryn/gists{/gist_id}","starred_url":"https://api.github.com/users/SerayaEryn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SerayaEryn/subscriptions","organizations_url":"https://api.github.com/users/SerayaEryn/orgs","repos_url":"https://api.github.com/users/SerayaEryn/repos","events_url":"https://api.github.com/users/SerayaEryn/events{/privacy}","received_events_url":"https://api.github.com/users/SerayaEryn/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-30T12:43:41Z","updated_at":"2019-07-30T12:43:41Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/fastify/fastify/issues/1776","repository_url":"https://api.github.com/repos/fastify/fastify","labels_url":"https://api.github.com/repos/fastify/fastify/issues/1776/labels{/name}","comments_url":"https://api.github.com/repos/fastify/fastify/issues/1776/comments","events_url":"https://api.github.com/repos/fastify/fastify/issues/1776/events","html_url":"https://github.com/fastify/fastify/issues/1776","id":474424999,"node_id":"MDU6SXNzdWU0NzQ0MjQ5OTk=","number":1776,"title":"async preValidation hook does not abort request","user":{"login":"tobspr","id":5307711,"node_id":"MDQ6VXNlcjUzMDc3MTE=","avatar_url":"https://avatars.githubusercontent.com/u/5307711?v=4","gravatar_id":"","url":"https://api.github.com/users/tobspr","html_url":"https://github.com/tobspr","followers_url":"https://api.github.com/users/tobspr/followers","following_url":"https://api.github.com/users/tobspr/following{/other_user}","gists_url":"https://api.github.com/users/tobspr/gists{/gist_id}","starred_url":"https://api.github.com/users/tobspr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tobspr/subscriptions","organizations_url":"https://api.github.com/users/tobspr/orgs","repos_url":"https://api.github.com/users/tobspr/repos","events_url":"https://api.github.com/users/tobspr/events{/privacy}","received_events_url":"https://api.github.com/users/tobspr/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":451588686,"node_id":"MDU6TGFiZWw0NTE1ODg2ODY=","url":"https://api.github.com/repos/fastify/fastify/labels/bug","name":"bug","color":"ee0701","default":true,"description":"Confirmed bug"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-07-30T07:39:42Z","updated_at":"2019-07-31T14:08:20Z","closed_at":"2019-07-31T07:59:04Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":69495170,"node_id":"MDEwOlJlcG9zaXRvcnk2OTQ5NTE3MA==","name":"fastify","full_name":"fastify/fastify","private":false,"owner":{"login":"fastify","id":24939410,"node_id":"MDEyOk9yZ2FuaXphdGlvbjI0OTM5NDEw","avatar_url":"https://avatars.githubusercontent.com/u/24939410?v=4","gravatar_id":"","url":"https://api.github.com/users/fastify","html_url":"https://github.com/fastify","followers_url":"https://api.github.com/users/fastify/followers","following_url":"https://api.github.com/users/fastify/following{/other_user}","gists_url":"https://api.github.com/users/fastify/gists{/gist_id}","starred_url":"https://api.github.com/users/fastify/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fastify/subscriptions","organizations_url":"https://api.github.com/users/fastify/orgs","repos_url":"https://api.github.com/users/fastify/repos","events_url":"https://api.github.com/users/fastify/events{/privacy}","received_events_url":"https://api.github.com/users/fastify/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/fastify/fastify","description":"Fast and low overhead web framework, for Node.js","fork":false,"url":"https://api.github.com/repos/fastify/fastify","forks_url":"https://api.github.com/repos/fastify/fastify/forks","keys_url":"https://api.github.com/repos/fastify/fastify/keys{/key_id}","collaborators_url":"https://api.github.com/repos/fastify/fastify/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/fastify/fastify/teams","hooks_url":"https://api.github.com/repos/fastify/fastify/hooks","issue_events_url":"https://api.github.com/repos/fastify/fastify/issues/events{/number}","events_url":"https://api.github.com/repos/fastify/fastify/events","assignees_url":"https://api.github.com/repos/fastify/fastify/assignees{/user}","branches_url":"https://api.github.com/repos/fastify/fastify/branches{/branch}","tags_url":"https://api.github.com/repos/fastify/fastify/tags","blobs_url":"https://api.github.com/repos/fastify/fastify/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/fastify/fastify/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/fastify/fastify/git/refs{/sha}","trees_url":"https://api.github.com/repos/fastify/fastify/git/trees{/sha}","statuses_url":"https://api.github.com/repos/fastify/fastify/statuses/{sha}","languages_url":"https://api.github.com/repos/fastify/fastify/languages","stargazers_url":"https://api.github.com/repos/fastify/fastify/stargazers","contributors_url":"https://api.github.com/repos/fastify/fastify/contributors","subscribers_url":"https://api.github.com/repos/fastify/fastify/subscribers","subscription_url":"https://api.github.com/repos/fastify/fastify/subscription","commits_url":"https://api.github.com/repos/fastify/fastify/commits{/sha}","git_commits_url":"https://api.github.com/repos/fastify/fastify/git/commits{/sha}","comments_url":"https://api.github.com/repos/fastify/fastify/comments{/number}","issue_comment_url":"https://api.github.com/repos/fastify/fastify/issues/comments{/number}","contents_url":"https://api.github.com/repos/fastify/fastify/contents/{+path}","compare_url":"https://api.github.com/repos/fastify/fastify/compare/{base}...{head}","merges_url":"https://api.github.com/repos/fastify/fastify/merges","archive_url":"https://api.github.com/repos/fastify/fastify/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/fastify/fastify/downloads","issues_url":"https://api.github.com/repos/fastify/fastify/issues{/number}","pulls_url":"https://api.github.com/repos/fastify/fastify/pulls{/number}","milestones_url":"https://api.github.com/repos/fastify/fastify/milestones{/number}","notifications_url":"https://api.github.com/repos/fastify/fastify/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/fastify/fastify/labels{/name}","releases_url":"https://api.github.com/repos/fastify/fastify/releases{/id}","deployments_url":"https://api.github.com/repos/fastify/fastify/deployments","created_at":"2016-09-28T19:10:14Z","updated_at":"2025-11-09T19:27:27Z","pushed_at":"2025-11-09T20:20:24Z","git_url":"git://github.com/fastify/fastify.git","ssh_url":"git@github.com:fastify/fastify.git","clone_url":"https://github.com/fastify/fastify.git","svn_url":"https://github.com/fastify/fastify","homepage":"https://www.fastify.dev","size":9357,"stargazers_count":34974,"watchers_count":34974,"language":"JavaScript","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":2510,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":100,"license":{"key":"other","name":"Other","spdx_id":"NOASSERTION","url":null,"node_id":"MDc6TGljZW5zZTA="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":true,"topics":["hacktoberfest","nodejs","performance","speed","webframework"],"visibility":"public","forks":2510,"open_issues":100,"watchers":34974,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"## ðŸ› Bug Report\r\n\r\nWhen calling `reply.send` within an async preValidation hook, this does not abort the request and thus emits a `Response has already been sent` error. Related: #677\r\n\r\nAccording to the linked issue and pr, it should have been fixed, however it doesn't seem to be (At least for me):\r\n\r\n## To Reproduce\r\n\r\nHook:\r\n```js\r\nfastify.addHook(\"preValidation\", async function (request, reply) {\r\n  reply.code(403).send({error: \"unauthenticated\"});\r\n});\r\n```\r\nHandler:\r\n```js\r\nmodule.exports = function (fastify, opts, next) {\r\n   fastify.get(\"/\", {}, async (request, reply) => {\r\n       // This gets still executed, and reply.sent is true here\r\n   });\r\n   next();\r\n}\r\n ```\r\n\r\n## Expected behavior\r\n\r\nThe handler should not get called.\r\n\r\n## Your Environment\r\n\r\n- *node version*: 10.16.0\r\n- *fastify version*: >=2.5.0\r\n- *os*: Windows, Linux\r\n","reactions":{"url":"https://api.github.com/repos/fastify/fastify/issues/1776/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/fastify/fastify/issues/1776/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"id":2520453122,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDI1MjA0NTMxMjI=","url":"https://api.github.com/repos/fastify/fastify/issues/events/2520453122","actor":{"login":"mcollina","id":52195,"node_id":"MDQ6VXNlcjUyMTk1","avatar_url":"https://avatars.githubusercontent.com/u/52195?v=4","gravatar_id":"","url":"https://api.github.com/users/mcollina","html_url":"https://github.com/mcollina","followers_url":"https://api.github.com/users/mcollina/followers","following_url":"https://api.github.com/users/mcollina/following{/other_user}","gists_url":"https://api.github.com/users/mcollina/gists{/gist_id}","starred_url":"https://api.github.com/users/mcollina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mcollina/subscriptions","organizations_url":"https://api.github.com/users/mcollina/orgs","repos_url":"https://api.github.com/users/mcollina/repos","events_url":"https://api.github.com/users/mcollina/events{/privacy}","received_events_url":"https://api.github.com/users/mcollina/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"2d7baf9fdecc5462f8d294095982d1bb0b4cb95b","commit_url":"https://api.github.com/repos/fastify/fastify/commits/2d7baf9fdecc5462f8d294095982d1bb0b4cb95b","created_at":"2019-07-30T16:35:34Z","performed_via_github_app":null},{"actor":{"login":"mcollina","id":52195,"node_id":"MDQ6VXNlcjUyMTk1","avatar_url":"https://avatars.githubusercontent.com/u/52195?v=4","gravatar_id":"","url":"https://api.github.com/users/mcollina","html_url":"https://github.com/mcollina","followers_url":"https://api.github.com/users/mcollina/followers","following_url":"https://api.github.com/users/mcollina/following{/other_user}","gists_url":"https://api.github.com/users/mcollina/gists{/gist_id}","starred_url":"https://api.github.com/users/mcollina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mcollina/subscriptions","organizations_url":"https://api.github.com/users/mcollina/orgs","repos_url":"https://api.github.com/users/mcollina/repos","events_url":"https://api.github.com/users/mcollina/events{/privacy}","received_events_url":"https://api.github.com/users/mcollina/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-30T16:36:20Z","updated_at":"2019-07-30T16:36:20Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/fastify/fastify/issues/1778","repository_url":"https://api.github.com/repos/fastify/fastify","labels_url":"https://api.github.com/repos/fastify/fastify/issues/1778/labels{/name}","comments_url":"https://api.github.com/repos/fastify/fastify/issues/1778/comments","events_url":"https://api.github.com/repos/fastify/fastify/issues/1778/events","html_url":"https://github.com/fastify/fastify/pull/1778","id":474687348,"node_id":"MDExOlB1bGxSZXF1ZXN0MzAyNTgyNTAw","number":1778,"title":"Ensure we are not running the handler if reply.sent is true","user":{"login":"mcollina","id":52195,"node_id":"MDQ6VXNlcjUyMTk1","avatar_url":"https://avatars.githubusercontent.com/u/52195?v=4","gravatar_id":"","url":"https://api.github.com/users/mcollina","html_url":"https://github.com/mcollina","followers_url":"https://api.github.com/users/mcollina/followers","following_url":"https://api.github.com/users/mcollina/following{/other_user}","gists_url":"https://api.github.com/users/mcollina/gists{/gist_id}","starred_url":"https://api.github.com/users/mcollina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mcollina/subscriptions","organizations_url":"https://api.github.com/users/mcollina/orgs","repos_url":"https://api.github.com/users/mcollina/repos","events_url":"https://api.github.com/users/mcollina/events{/privacy}","received_events_url":"https://api.github.com/users/mcollina/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":750220462,"node_id":"MDU6TGFiZWw3NTAyMjA0NjI=","url":"https://api.github.com/repos/fastify/fastify/labels/bugfix","name":"bugfix","color":"e99695","default":false,"description":"Issue or PR that should land as semver patch"},{"id":1265652632,"node_id":"MDU6TGFiZWwxMjY1NjUyNjMy","url":"https://api.github.com/repos/fastify/fastify/labels/v2.x","name":"v2.x","color":"dddddd","default":false,"description":"Issue or pr related to Fastify v2"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-07-30T16:36:20Z","updated_at":"2022-02-10T09:15:14Z","closed_at":"2019-07-31T07:59:04Z","author_association":"MEMBER","type":null,"active_lock_reason":"resolved","draft":false,"repository":{"id":69495170,"node_id":"MDEwOlJlcG9zaXRvcnk2OTQ5NTE3MA==","name":"fastify","full_name":"fastify/fastify","private":false,"owner":{"login":"fastify","id":24939410,"node_id":"MDEyOk9yZ2FuaXphdGlvbjI0OTM5NDEw","avatar_url":"https://avatars.githubusercontent.com/u/24939410?v=4","gravatar_id":"","url":"https://api.github.com/users/fastify","html_url":"https://github.com/fastify","followers_url":"https://api.github.com/users/fastify/followers","following_url":"https://api.github.com/users/fastify/following{/other_user}","gists_url":"https://api.github.com/users/fastify/gists{/gist_id}","starred_url":"https://api.github.com/users/fastify/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fastify/subscriptions","organizations_url":"https://api.github.com/users/fastify/orgs","repos_url":"https://api.github.com/users/fastify/repos","events_url":"https://api.github.com/users/fastify/events{/privacy}","received_events_url":"https://api.github.com/users/fastify/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/fastify/fastify","description":"Fast and low overhead web framework, for Node.js","fork":false,"url":"https://api.github.com/repos/fastify/fastify","forks_url":"https://api.github.com/repos/fastify/fastify/forks","keys_url":"https://api.github.com/repos/fastify/fastify/keys{/key_id}","collaborators_url":"https://api.github.com/repos/fastify/fastify/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/fastify/fastify/teams","hooks_url":"https://api.github.com/repos/fastify/fastify/hooks","issue_events_url":"https://api.github.com/repos/fastify/fastify/issues/events{/number}","events_url":"https://api.github.com/repos/fastify/fastify/events","assignees_url":"https://api.github.com/repos/fastify/fastify/assignees{/user}","branches_url":"https://api.github.com/repos/fastify/fastify/branches{/branch}","tags_url":"https://api.github.com/repos/fastify/fastify/tags","blobs_url":"https://api.github.com/repos/fastify/fastify/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/fastify/fastify/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/fastify/fastify/git/refs{/sha}","trees_url":"https://api.github.com/repos/fastify/fastify/git/trees{/sha}","statuses_url":"https://api.github.com/repos/fastify/fastify/statuses/{sha}","languages_url":"https://api.github.com/repos/fastify/fastify/languages","stargazers_url":"https://api.github.com/repos/fastify/fastify/stargazers","contributors_url":"https://api.github.com/repos/fastify/fastify/contributors","subscribers_url":"https://api.github.com/repos/fastify/fastify/subscribers","subscription_url":"https://api.github.com/repos/fastify/fastify/subscription","commits_url":"https://api.github.com/repos/fastify/fastify/commits{/sha}","git_commits_url":"https://api.github.com/repos/fastify/fastify/git/commits{/sha}","comments_url":"https://api.github.com/repos/fastify/fastify/comments{/number}","issue_comment_url":"https://api.github.com/repos/fastify/fastify/issues/comments{/number}","contents_url":"https://api.github.com/repos/fastify/fastify/contents/{+path}","compare_url":"https://api.github.com/repos/fastify/fastify/compare/{base}...{head}","merges_url":"https://api.github.com/repos/fastify/fastify/merges","archive_url":"https://api.github.com/repos/fastify/fastify/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/fastify/fastify/downloads","issues_url":"https://api.github.com/repos/fastify/fastify/issues{/number}","pulls_url":"https://api.github.com/repos/fastify/fastify/pulls{/number}","milestones_url":"https://api.github.com/repos/fastify/fastify/milestones{/number}","notifications_url":"https://api.github.com/repos/fastify/fastify/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/fastify/fastify/labels{/name}","releases_url":"https://api.github.com/repos/fastify/fastify/releases{/id}","deployments_url":"https://api.github.com/repos/fastify/fastify/deployments","created_at":"2016-09-28T19:10:14Z","updated_at":"2025-11-09T19:27:27Z","pushed_at":"2025-11-09T20:20:24Z","git_url":"git://github.com/fastify/fastify.git","ssh_url":"git@github.com:fastify/fastify.git","clone_url":"https://github.com/fastify/fastify.git","svn_url":"https://github.com/fastify/fastify","homepage":"https://www.fastify.dev","size":9357,"stargazers_count":34974,"watchers_count":34974,"language":"JavaScript","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":2510,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":100,"license":{"key":"other","name":"Other","spdx_id":"NOASSERTION","url":null,"node_id":"MDc6TGljZW5zZTA="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":true,"topics":["hacktoberfest","nodejs","performance","speed","webframework"],"visibility":"public","forks":2510,"open_issues":100,"watchers":34974,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/fastify/fastify/pulls/1778","html_url":"https://github.com/fastify/fastify/pull/1778","diff_url":"https://github.com/fastify/fastify/pull/1778.diff","patch_url":"https://github.com/fastify/fastify/pull/1778.patch","merged_at":"2019-07-31T07:59:04Z"},"body":"Fixes #1733\r\nFixes #1776\r\n \r\n#### Checklist\r\n\r\n- [x] run `npm run test` and `npm run benchmark`\r\n- [x] tests and/or benchmarks are included\r\n- [x] commit message and code follows [Code of conduct](https://github.com/fastify/fastify/blob/master/CODE_OF_CONDUCT.md)\r\n","reactions":{"url":"https://api.github.com/repos/fastify/fastify/issues/1778/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/fastify/fastify/issues/1778/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":2522303268,"node_id":"MDExOkNsb3NlZEV2ZW50MjUyMjMwMzI2OA==","url":"https://api.github.com/repos/fastify/fastify/issues/events/2522303268","actor":{"login":"mcollina","id":52195,"node_id":"MDQ6VXNlcjUyMTk1","avatar_url":"https://avatars.githubusercontent.com/u/52195?v=4","gravatar_id":"","url":"https://api.github.com/users/mcollina","html_url":"https://github.com/mcollina","followers_url":"https://api.github.com/users/mcollina/followers","following_url":"https://api.github.com/users/mcollina/following{/other_user}","gists_url":"https://api.github.com/users/mcollina/gists{/gist_id}","starred_url":"https://api.github.com/users/mcollina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mcollina/subscriptions","organizations_url":"https://api.github.com/users/mcollina/orgs","repos_url":"https://api.github.com/users/mcollina/repos","events_url":"https://api.github.com/users/mcollina/events{/privacy}","received_events_url":"https://api.github.com/users/mcollina/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2019-07-31T07:59:04Z","state_reason":null,"performed_via_github_app":null},{"id":2522303371,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDI1MjIzMDMzNzE=","url":"https://api.github.com/repos/fastify/fastify/issues/events/2522303371","actor":{"login":"mcollina","id":52195,"node_id":"MDQ6VXNlcjUyMTk1","avatar_url":"https://avatars.githubusercontent.com/u/52195?v=4","gravatar_id":"","url":"https://api.github.com/users/mcollina","html_url":"https://github.com/mcollina","followers_url":"https://api.github.com/users/mcollina/followers","following_url":"https://api.github.com/users/mcollina/following{/other_user}","gists_url":"https://api.github.com/users/mcollina/gists{/gist_id}","starred_url":"https://api.github.com/users/mcollina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mcollina/subscriptions","organizations_url":"https://api.github.com/users/mcollina/orgs","repos_url":"https://api.github.com/users/mcollina/repos","events_url":"https://api.github.com/users/mcollina/events{/privacy}","received_events_url":"https://api.github.com/users/mcollina/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"2996fd83042084a2ecccc38b6fa123ec87546eec","commit_url":"https://api.github.com/repos/fastify/fastify/commits/2996fd83042084a2ecccc38b6fa123ec87546eec","created_at":"2019-07-31T07:59:06Z","performed_via_github_app":null},{"id":2882575141,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDI4ODI1NzUxNDE=","url":"https://api.github.com/repos/fastify/fastify/issues/events/2882575141","actor":{"login":"theliuk","id":809858,"node_id":"MDQ6VXNlcjgwOTg1OA==","avatar_url":"https://avatars.githubusercontent.com/u/809858?v=4","gravatar_id":"","url":"https://api.github.com/users/theliuk","html_url":"https://github.com/theliuk","followers_url":"https://api.github.com/users/theliuk/followers","following_url":"https://api.github.com/users/theliuk/following{/other_user}","gists_url":"https://api.github.com/users/theliuk/gists{/gist_id}","starred_url":"https://api.github.com/users/theliuk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/theliuk/subscriptions","organizations_url":"https://api.github.com/users/theliuk/orgs","repos_url":"https://api.github.com/users/theliuk/repos","events_url":"https://api.github.com/users/theliuk/events{/privacy}","received_events_url":"https://api.github.com/users/theliuk/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"4a879a2604a8abe06cb9867b1972809990d98607","commit_url":"https://api.github.com/repos/theliuk/fastify/commits/4a879a2604a8abe06cb9867b1972809990d98607","created_at":"2019-12-13T20:26:07Z","performed_via_github_app":null},{"id":2906358950,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDI5MDYzNTg5NTA=","url":"https://api.github.com/repos/fastify/fastify/issues/events/2906358950","actor":{"login":"delvedor","id":4865608,"node_id":"MDQ6VXNlcjQ4NjU2MDg=","avatar_url":"https://avatars.githubusercontent.com/u/4865608?v=4","gravatar_id":"","url":"https://api.github.com/users/delvedor","html_url":"https://github.com/delvedor","followers_url":"https://api.github.com/users/delvedor/followers","following_url":"https://api.github.com/users/delvedor/following{/other_user}","gists_url":"https://api.github.com/users/delvedor/gists{/gist_id}","starred_url":"https://api.github.com/users/delvedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/delvedor/subscriptions","organizations_url":"https://api.github.com/users/delvedor/orgs","repos_url":"https://api.github.com/users/delvedor/repos","events_url":"https://api.github.com/users/delvedor/events{/privacy}","received_events_url":"https://api.github.com/users/delvedor/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"f47b3d2e174d71c2443c9425cb3eddf7f63815fb","commit_url":"https://api.github.com/repos/fastify/fastify/commits/f47b3d2e174d71c2443c9425cb3eddf7f63815fb","created_at":"2019-12-24T07:42:33Z","performed_via_github_app":null}]