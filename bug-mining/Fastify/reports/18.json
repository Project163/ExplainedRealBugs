{"url":"https://api.github.com/repos/fastify/fastify/issues/677","repository_url":"https://api.github.com/repos/fastify/fastify","labels_url":"https://api.github.com/repos/fastify/fastify/issues/677/labels{/name}","comments_url":"https://api.github.com/repos/fastify/fastify/issues/677/comments","events_url":"https://api.github.com/repos/fastify/fastify/issues/677/events","html_url":"https://github.com/fastify/fastify/issues/677","id":289395379,"node_id":"MDU6SXNzdWUyODkzOTUzNzk=","number":677,"title":"End request in async preHandler","user":{"login":"jsumners","id":321201,"node_id":"MDQ6VXNlcjMyMTIwMQ==","avatar_url":"https://avatars.githubusercontent.com/u/321201?v=4","gravatar_id":"","url":"https://api.github.com/users/jsumners","html_url":"https://github.com/jsumners","followers_url":"https://api.github.com/users/jsumners/followers","following_url":"https://api.github.com/users/jsumners/following{/other_user}","gists_url":"https://api.github.com/users/jsumners/gists{/gist_id}","starred_url":"https://api.github.com/users/jsumners/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jsumners/subscriptions","organizations_url":"https://api.github.com/users/jsumners/orgs","repos_url":"https://api.github.com/users/jsumners/repos","events_url":"https://api.github.com/users/jsumners/events{/privacy}","received_events_url":"https://api.github.com/users/jsumners/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":451588686,"node_id":"MDU6TGFiZWw0NTE1ODg2ODY=","url":"https://api.github.com/repos/fastify/fastify/labels/bug","name":"bug","color":"ee0701","default":true,"description":"Confirmed bug"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/fastify/fastify/milestones/1","html_url":"https://github.com/fastify/fastify/milestone/1","labels_url":"https://api.github.com/repos/fastify/fastify/milestones/1/labels","id":2947145,"node_id":"MDk6TWlsZXN0b25lMjk0NzE0NQ==","number":1,"title":"v1.0.0","description":"","creator":{"login":"delvedor","id":4865608,"node_id":"MDQ6VXNlcjQ4NjU2MDg=","avatar_url":"https://avatars.githubusercontent.com/u/4865608?v=4","gravatar_id":"","url":"https://api.github.com/users/delvedor","html_url":"https://github.com/delvedor","followers_url":"https://api.github.com/users/delvedor/followers","following_url":"https://api.github.com/users/delvedor/following{/other_user}","gists_url":"https://api.github.com/users/delvedor/gists{/gist_id}","starred_url":"https://api.github.com/users/delvedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/delvedor/subscriptions","organizations_url":"https://api.github.com/users/delvedor/orgs","repos_url":"https://api.github.com/users/delvedor/repos","events_url":"https://api.github.com/users/delvedor/events{/privacy}","received_events_url":"https://api.github.com/users/delvedor/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":34,"state":"closed","created_at":"2017-11-29T17:01:39Z","updated_at":"2018-06-12T10:05:52Z","due_on":"2018-03-06T08:00:00Z","closed_at":"2018-06-12T10:03:32Z"},"comments":7,"created_at":"2018-01-17T20:03:16Z","updated_at":"2018-01-22T20:44:51Z","closed_at":"2018-01-22T20:44:51Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Let's assume you have a plugin that supplies a `preHandler` hook. This plugin does some validation of incoming requests and returns an error response (401) if the request fails validation and terminates the request chain. With the traditional interface this looks like:\r\n\r\n```js\r\nfastify.addHook('preHandler', function (req, reply, next) {\r\n  if (req.headers['foo'] === foo) return next()\r\n  req.code(401).send({error: 'nope'})\r\n  return\r\n})\r\n```\r\n\r\nBut what do we do if the hook is an `async` function?\r\n\r\n```js\r\nfastify.addHook('preHandler', async function (req, reply) {\r\n  if (req.headers['foo'] === foo) return\r\n  req.code(401).send({error: 'nope'})\r\n  return\r\n})\r\n```\r\n\r\nIn this case we will get an error informing us that the reply has already been sent because 1. it has and 2. the request continues as if the hook didn't encounter an error *despite* `undefined` being returned. So let's modify it to satisfy the error check:\r\n\r\n```js\r\nfastify.addHook('preHandler', async function (req, reply) {\r\n  if (req.headers['foo'] === foo) return\r\n  req.code(401).send({error: 'nope'})\r\n  return Error('make fastify realize an error occurred')\r\n})\r\n```\r\n\r\nOops, we have a new problem. In this case we are creating an unhandled rejection. \r\n\r\nIt seems to me that there is no way to properly terminate a request at the `preHandler` step when using an `async` hook. I think there needs to be a way to do it to be consistent with the traditional interface.\r\n\r\nMaybe `async` hooks can look for specific return values to determine what to do? For example, maybe this would terminate the request correctly?:\r\n\r\n```js\r\nfastify.addHook('preHandler', async function (req, reply) {\r\n  if (req.headers['foo'] === foo) return\r\n  req.code(401).send({error: 'nope'})\r\n  return fastify.TERM_REQ\r\n})\r\n```\r\n\r\n#### Context\r\n\r\n* *node version*: 8\r\n* *fastify version*: 0.39.1\r\n* *os*: Mac","closed_by":{"login":"delvedor","id":4865608,"node_id":"MDQ6VXNlcjQ4NjU2MDg=","avatar_url":"https://avatars.githubusercontent.com/u/4865608?v=4","gravatar_id":"","url":"https://api.github.com/users/delvedor","html_url":"https://github.com/delvedor","followers_url":"https://api.github.com/users/delvedor/followers","following_url":"https://api.github.com/users/delvedor/following{/other_user}","gists_url":"https://api.github.com/users/delvedor/gists{/gist_id}","starred_url":"https://api.github.com/users/delvedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/delvedor/subscriptions","organizations_url":"https://api.github.com/users/delvedor/orgs","repos_url":"https://api.github.com/users/delvedor/repos","events_url":"https://api.github.com/users/delvedor/events{/privacy}","received_events_url":"https://api.github.com/users/delvedor/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/fastify/fastify/issues/677/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/fastify/fastify/issues/677/timeline","performed_via_github_app":null,"state_reason":"completed"}