{"url":"https://api.github.com/repos/fastify/fastify/issues/686","repository_url":"https://api.github.com/repos/fastify/fastify","labels_url":"https://api.github.com/repos/fastify/fastify/issues/686/labels{/name}","comments_url":"https://api.github.com/repos/fastify/fastify/issues/686/comments","events_url":"https://api.github.com/repos/fastify/fastify/issues/686/events","html_url":"https://github.com/fastify/fastify/issues/686","id":290066588,"node_id":"MDU6SXNzdWUyOTAwNjY1ODg=","number":686,"title":"Plugin needs to know its full path","user":{"login":"jsumners","id":321201,"node_id":"MDQ6VXNlcjMyMTIwMQ==","avatar_url":"https://avatars.githubusercontent.com/u/321201?v=4","gravatar_id":"","url":"https://api.github.com/users/jsumners","html_url":"https://github.com/jsumners","followers_url":"https://api.github.com/users/jsumners/followers","following_url":"https://api.github.com/users/jsumners/following{/other_user}","gists_url":"https://api.github.com/users/jsumners/gists{/gist_id}","starred_url":"https://api.github.com/users/jsumners/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jsumners/subscriptions","organizations_url":"https://api.github.com/users/jsumners/orgs","repos_url":"https://api.github.com/users/jsumners/repos","events_url":"https://api.github.com/users/jsumners/events{/privacy}","received_events_url":"https://api.github.com/users/jsumners/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":769201197,"node_id":"MDU6TGFiZWw3NjkyMDExOTc=","url":"https://api.github.com/repos/fastify/fastify/labels/feature%20request","name":"feature request","color":"a78ced","default":false,"description":"New feature to be added"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-01-19T18:29:28Z","updated_at":"2018-01-20T14:26:12Z","closed_at":"2018-01-20T14:26:12Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Sometimes a plugin needs to be able to compose the full URL to the handlers it defines. For example, when working with SAML you must tell the remote IdP the callback URL to use when it POSTs back to you. If the SAML communication is implemented in a plugin, then that plugin could be mounted with a prefix that is itself under another prefix. But the plugin only has access to its *immediate* prefix. Example:\r\n\r\nhttps://github.com/fastify/fastify/blob/4a5cd18e5bda435548370623034c7cedeafcf55b/test/route-prefix.test.js#L20-L25\r\n\r\nOn the line where the route gets registered the following is true:\r\n\r\n1. `opts.prefix` is set to `/v2`\r\n1. `fastify._routePrefix` is set to `/v1/v2`\r\n\r\nSo let's use the public API:\r\n\r\n```js\r\nfastify.register(function (instance, opts, next) {\r\n  instance.register(function (instance, opts, next) {\r\n    instance.get('/foo', function (req, reply) {\r\n      const address = instance.server.address()\r\n      // next line is returning the wrong result\r\n      reply.send( `url = ${address.addres}:${address.port}${opts.prefix}` )\r\n    })\r\n    \r\n    next()\r\n  }, {prefix: '/v2'})\r\n  \r\n  next()\r\n}, {prefix: '/v1'})\r\n```\r\n\r\nI propose that the `instance` should expose a public property that provides the full path, e.g.:\r\n\r\n```js\r\nfastify.register(function (instance, opts, next) {\r\n  // 'basePath: /v1'\r\n  instance.log.debug('basePath: %s', instance.basePath)\r\n\r\n  instance.register(function (instance, opts, next) {\r\n    // 'basePath: /v1/v2'\r\n    instance.log.debug('basePath: %s', instance.basePath)\r\n\r\n    next()\r\n  }, {prefix: '/v2'})\r\n\r\n  next()\r\n}, {prefix: '/v1'})\r\n```","closed_by":{"login":"jsumners","id":321201,"node_id":"MDQ6VXNlcjMyMTIwMQ==","avatar_url":"https://avatars.githubusercontent.com/u/321201?v=4","gravatar_id":"","url":"https://api.github.com/users/jsumners","html_url":"https://github.com/jsumners","followers_url":"https://api.github.com/users/jsumners/followers","following_url":"https://api.github.com/users/jsumners/following{/other_user}","gists_url":"https://api.github.com/users/jsumners/gists{/gist_id}","starred_url":"https://api.github.com/users/jsumners/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jsumners/subscriptions","organizations_url":"https://api.github.com/users/jsumners/orgs","repos_url":"https://api.github.com/users/jsumners/repos","events_url":"https://api.github.com/users/jsumners/events{/privacy}","received_events_url":"https://api.github.com/users/jsumners/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/fastify/fastify/issues/686/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/fastify/fastify/issues/686/timeline","performed_via_github_app":null,"state_reason":"completed"}