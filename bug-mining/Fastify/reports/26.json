{"url":"https://api.github.com/repos/fastify/fastify/issues/1043","repository_url":"https://api.github.com/repos/fastify/fastify","labels_url":"https://api.github.com/repos/fastify/fastify/issues/1043/labels{/name}","comments_url":"https://api.github.com/repos/fastify/fastify/issues/1043/comments","events_url":"https://api.github.com/repos/fastify/fastify/issues/1043/events","html_url":"https://github.com/fastify/fastify/issues/1043","id":341334486,"node_id":"MDU6SXNzdWUzNDEzMzQ0ODY=","number":1043,"title":" Schema with key or id already exists","user":{"login":"SkeLLLa","id":2273103,"node_id":"MDQ6VXNlcjIyNzMxMDM=","avatar_url":"https://avatars.githubusercontent.com/u/2273103?v=4","gravatar_id":"","url":"https://api.github.com/users/SkeLLLa","html_url":"https://github.com/SkeLLLa","followers_url":"https://api.github.com/users/SkeLLLa/followers","following_url":"https://api.github.com/users/SkeLLLa/following{/other_user}","gists_url":"https://api.github.com/users/SkeLLLa/gists{/gist_id}","starred_url":"https://api.github.com/users/SkeLLLa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SkeLLLa/subscriptions","organizations_url":"https://api.github.com/users/SkeLLLa/orgs","repos_url":"https://api.github.com/users/SkeLLLa/repos","events_url":"https://api.github.com/users/SkeLLLa/events{/privacy}","received_events_url":"https://api.github.com/users/SkeLLLa/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":451588686,"node_id":"MDU6TGFiZWw0NTE1ODg2ODY=","url":"https://api.github.com/repos/fastify/fastify/labels/bug","name":"bug","color":"ee0701","default":true,"description":"Confirmed bug"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2018-07-15T16:31:35Z","updated_at":"2021-11-20T15:01:50Z","closed_at":"2018-07-23T12:35:43Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Related issue #922. @delvedor.\r\n\r\nI don't know if it's a bug. Or may be it's just a limitation of schemas.\r\nSeems the root cause is quiet similar. If there are 2 or more schemas that depend on each other are defined using `allOf`, e.g.:\r\n```js\r\napp.addSchema({\r\n  $id: 'first',\r\n  type: 'object',\r\n  properties: {\r\n    first: {\r\n      type: 'number',\r\n    },\r\n  },\r\n});\r\napp.addSchema({\r\n  $id: 'second',\r\n  type: 'object',\r\n  allOf: [\r\n    {\r\n      type: 'object',\r\n      properties: {\r\n        second: {\r\n          type: 'number',\r\n        },\r\n      },\r\n    },\r\n    'first#',\r\n  ],\r\n});\r\n```\r\n\r\nthen if `first` schema will be used after `second` fastify will throw exception:\r\n```\r\nError: schema with key or id \"first\" already exists\r\n```\r\nIf schema \"usages\" will go in sequential order, then app will start without any exceptions. See full example below:\r\n\r\n#### What are you trying to achieve or the steps to reproduce?\r\n\r\n```js\r\nconst fastify = require('fastify');\r\nconst app = fastify({\r\n  logger: {\r\n    level: 'info',\r\n    prettyPrint: true,\r\n  },\r\n  ignoreTrailingSlash: true,\r\n});\r\napp.addSchema({\r\n  $id: 'first',\r\n  type: 'object',\r\n  properties: {\r\n    first: {\r\n      type: 'number',\r\n    },\r\n  },\r\n});\r\n\r\napp.addSchema({\r\n  $id: 'second',\r\n  type: 'object',\r\n  allOf: [\r\n    {\r\n      type: 'object',\r\n      properties: {\r\n        second: {\r\n          type: 'number',\r\n        },\r\n      },\r\n    },\r\n    'first#',\r\n  ],\r\n});\r\n\r\napp.get(\r\n  '/',\r\n  {\r\n    schema: {\r\n      description: `get`,\r\n      body: 'second#',\r\n      response: {\r\n        200: 'second#',\r\n      },\r\n    },\r\n  },\r\n  async function(request, reply) {\r\n    return {ok: 'ok'};\r\n  }\r\n);\r\n\r\napp.patch(\r\n  '/',\r\n  {\r\n    schema: {\r\n      description: `patch`,\r\n      body: 'first#',\r\n      response: {\r\n        200: 'first#',\r\n      },\r\n    },\r\n  },\r\n  async function(request, reply) {\r\n    return {ok: 'ok'};\r\n  }\r\n);\r\n\r\n(async () => {\r\n  try {\r\n    await Promise.all([\r\n      app.listen(3333),\r\n      app.ready(),\r\n    ]);\r\n  } catch (ex) {\r\n    console.log(ex);\r\n    process.exit(1);\r\n  }\r\n})();\r\n\r\n```\r\n\r\n#### What was the result you received?\r\n\r\nApp schema validation fails. App doesn't start.\r\n```\r\nError: schema with key or id \"first\" already exists\r\n```\r\n\r\nSwapping `get` and `patch` methods \"solves\" issue.\r\n\r\n#### What did you expect?\r\n\r\nOrder of using schemas that depend on each other should not affect app.\r\n\r\n#### Context\r\n\r\n* *node version*: 9\r\n* *fastify version*: 1.8.0\r\n","closed_by":{"login":"delvedor","id":4865608,"node_id":"MDQ6VXNlcjQ4NjU2MDg=","avatar_url":"https://avatars.githubusercontent.com/u/4865608?v=4","gravatar_id":"","url":"https://api.github.com/users/delvedor","html_url":"https://github.com/delvedor","followers_url":"https://api.github.com/users/delvedor/followers","following_url":"https://api.github.com/users/delvedor/following{/other_user}","gists_url":"https://api.github.com/users/delvedor/gists{/gist_id}","starred_url":"https://api.github.com/users/delvedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/delvedor/subscriptions","organizations_url":"https://api.github.com/users/delvedor/orgs","repos_url":"https://api.github.com/users/delvedor/repos","events_url":"https://api.github.com/users/delvedor/events{/privacy}","received_events_url":"https://api.github.com/users/delvedor/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/fastify/fastify/issues/1043/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/fastify/fastify/issues/1043/timeline","performed_via_github_app":null,"state_reason":"completed"}