{"url":"https://api.github.com/repos/fastify/fastify/issues/4120","repository_url":"https://api.github.com/repos/fastify/fastify","labels_url":"https://api.github.com/repos/fastify/fastify/issues/4120/labels{/name}","comments_url":"https://api.github.com/repos/fastify/fastify/issues/4120/comments","events_url":"https://api.github.com/repos/fastify/fastify/issues/4120/events","html_url":"https://github.com/fastify/fastify/issues/4120","id":1299058749,"node_id":"I_kwDOBCRpgs5NbhA9","number":4120,"title":"Typescript: Type Provider information gets lost with onRequest","user":{"login":"qqilihq","id":2172260,"node_id":"MDQ6VXNlcjIxNzIyNjA=","avatar_url":"https://avatars.githubusercontent.com/u/2172260?v=4","gravatar_id":"","url":"https://api.github.com/users/qqilihq","html_url":"https://github.com/qqilihq","followers_url":"https://api.github.com/users/qqilihq/followers","following_url":"https://api.github.com/users/qqilihq/following{/other_user}","gists_url":"https://api.github.com/users/qqilihq/gists{/gist_id}","starred_url":"https://api.github.com/users/qqilihq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/qqilihq/subscriptions","organizations_url":"https://api.github.com/users/qqilihq/orgs","repos_url":"https://api.github.com/users/qqilihq/repos","events_url":"https://api.github.com/users/qqilihq/events{/privacy}","received_events_url":"https://api.github.com/users/qqilihq/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":772309804,"node_id":"MDU6TGFiZWw3NzIzMDk4MDQ=","url":"https://api.github.com/repos/fastify/fastify/labels/typescript","name":"typescript","color":"0061ca","default":false,"description":"TypeScript related"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2022-07-08T13:56:13Z","updated_at":"2022-08-18T17:34:38Z","closed_at":"2022-07-21T16:35:00Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Prerequisites\r\n\r\n- [X] I have written a descriptive issue title\r\n- [X] I have searched existing issues to ensure the bug has not already been reported\r\n\r\n\r\n### Fastify version\r\n\r\n4.2.0\r\n\r\n### Plugin version\r\n\r\n_No response_\r\n\r\n### Node.js version\r\n\r\n16.13.0\r\n\r\n### Operating system\r\n\r\nmacOS\r\n\r\n### Operating system version (i.e. 20.04, 11.3, 10)\r\n\r\nn/a\r\n\r\n### Description\r\n\r\nI've added the new type providers from Fastify 4 to my project to avoid the redundant, cluttered generics.\r\n\r\nMy project makes use of “onRequest” hooks which check a custom authentication in different endpoints.\r\n\r\nExample:\r\n\r\n```typescript\r\n// simplified for demo purposes -- this is used in various endpoints\r\nconst authenticateHook: onRequestAsyncHookHandler<any, any, any, any, any, any, any, any, any> = () => {\r\n  return Promise.resolve();\r\n};\r\n\r\n// example copied from https://www.fastify.io/docs/latest/Reference/Type-Providers/#typebox\r\nserver.get('/route', {\r\n    schema: {\r\n        querystring: Type.Object({\r\n            foo: Type.Number(),\r\n            bar: Type.String()\r\n        })\r\n    },\r\n    onRequest: authenticateHook\r\n}, (request, reply) => {\r\n    // type Query = { foo: number, bar: string }\r\n    const { foo, bar } = request.query // NOT type safe when adding `onRequest` :-(\r\n})\r\n```\r\n\r\nThe problem: After adding the `onRequest` hook, the type safety gets totally lost and e.g. request.query is `unknown`.\r\n\r\nI've been trying various workarounds (e.g. handling through all these generics), however I didn't really get to a clean, let alone, scalable solution.\r\n\r\n### Steps to Reproduce\r\n\r\nSee snippet.\r\n\r\n### Expected Behavior\r\n\r\nI'd expect the type information to be preserved.","closed_by":{"login":"mcollina","id":52195,"node_id":"MDQ6VXNlcjUyMTk1","avatar_url":"https://avatars.githubusercontent.com/u/52195?v=4","gravatar_id":"","url":"https://api.github.com/users/mcollina","html_url":"https://github.com/mcollina","followers_url":"https://api.github.com/users/mcollina/followers","following_url":"https://api.github.com/users/mcollina/following{/other_user}","gists_url":"https://api.github.com/users/mcollina/gists{/gist_id}","starred_url":"https://api.github.com/users/mcollina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mcollina/subscriptions","organizations_url":"https://api.github.com/users/mcollina/orgs","repos_url":"https://api.github.com/users/mcollina/repos","events_url":"https://api.github.com/users/mcollina/events{/privacy}","received_events_url":"https://api.github.com/users/mcollina/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/fastify/fastify/issues/4120/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/fastify/fastify/issues/4120/timeline","performed_via_github_app":null,"state_reason":"completed"}