<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 19:29:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[JAMES-3828] ava.lang.ClassCastException: class [B cannot be cast to class org.apache.mailet.AttributeValue ([B is in module java.base of loader &apos;bootstrap&apos;; org.apache.mailet.AttributeValue is in unnamed module of loader &apos;app&apos;)</title>
                <link>https://issues.apache.org/jira/browse/JAMES-3828</link>
                <project id="10411" key="JAMES">James Server</project>
                    <description>&lt;p&gt;Got the following error today&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
exception	java.lang.ClassCastException: class [B cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.mailet.AttributeValue ([B is in module java.base of loader &lt;span class=&quot;code-quote&quot;&gt;&apos;bootstrap&apos;&lt;/span&gt;; org.apache.mailet.AttributeValue is in unnamed module of loader &lt;span class=&quot;code-quote&quot;&gt;&apos;app&apos;&lt;/span&gt;)
 at org.apache.mailet.Serializer$MapSerializer.lambda$serialize$0(Serializer.java:507)
  at com.google.common.collect.CollectCollectors.lambda$toImmutableMap$6(CollectCollectors.java:185)
   at java.base/java.util.stream.ReduceOps$3ReducingSink.accept(Unknown Source)
    at java.base/java.util.Spliterators$ArraySpliterator.forEachRemaining(Unknown Source)
     at java.base/java.util.stream.AbstractPipeline.copyInto(Unknown Source)
      at java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(Unknown Source)
       at java.base/java.util.stream.ReduceOps$ReduceOp.evaluateSequential(Unknown Source)
        at java.base/java.util.stream.AbstractPipeline.evaluate(Unknown Source)
         at java.base/java.util.stream.ReferencePipeline.collect(Unknown Source)
          at org.apache.mailet.Serializer$MapSerializer.serialize(Serializer.java:507)
           at org.apache.mailet.Serializer$MapSerializer.serialize(Serializer.java:503)
            at org.apache.mailet.AttributeValue.toJson(AttributeValue.java:256)
             at org.apache.mailet.AttributeValue.duplicate(AttributeValue.java:250)
              at org.apache.mailet.Attribute.duplicate(Attribute.java:62)
               at java.base/java.util.stream.ReferencePipeline$3$1.accept(Unknown Source)
                at java.base/java.util.HashMap$ValueSpliterator.forEachRemaining(Unknown Source)
                 at java.base/java.util.stream.AbstractPipeline.copyInto(Unknown Source)
                  at java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(Unknown Source)
                   at java.base/java.util.stream.ReduceOps$ReduceOp.evaluateSequential(Unknown Source)
                    at java.base/java.util.stream.AbstractPipeline.evaluate(Unknown Source)
                     at java.base/java.util.stream.ReferencePipeline.collect(Unknown Source)
                      at org.apache.james.server.core.MailImpl.duplicateAttributes(MailImpl.java:117)
                       at org.apache.james.server.core.MailImpl.duplicateWithoutMessage(MailImpl.java:111)
                        at org.apache.james.server.core.MailImpl.duplicate(MailImpl.java:97)
                         at org.apache.james.mailetcontainer.impl.MatcherSplitter.split(MatcherSplitter.java:149)
                          at org.apache.james.mailetcontainer.impl.MailetProcessorImpl.lambda$executeProcessingStep$3(MailetProcessorImpl.java:158)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The postmortem is that for XYZ reason, we ingested a Map that do not have the good actual types thus we fail serializing the associate attribute. This prevent us from duplicating the attributes and causes the mail not to be split, thus aborting mail processing.&lt;/p&gt;

&lt;p&gt;We do not know where invalid data was first generated.&lt;/p&gt;

&lt;p&gt;That&apos;s weaknesses of the Java parameter type systems.&lt;/p&gt;

&lt;p&gt;We shall:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Avoid serializing / deserializing attributes to duplicate them and instead do something smarter&lt;/li&gt;
	&lt;li&gt;Reject invalid collections/bad type parameters as early as possible.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This is potentially due to a custom extension.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13483759">JAMES-3828</key>
            <summary>ava.lang.ClassCastException: class [B cannot be cast to class org.apache.mailet.AttributeValue ([B is in module java.base of loader &apos;bootstrap&apos;; org.apache.mailet.AttributeValue is in unnamed module of loader &apos;app&apos;)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="btellier">Benoit Tellier</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 Sep 2022 04:49:10 +0000</created>
                <updated>Tue, 4 Oct 2022 02:28:48 +0000</updated>
                            <resolved>Tue, 4 Oct 2022 02:28:48 +0000</resolved>
                                    <version>master</version>
                                    <fixVersion>3.8.0</fixVersion>
                                    <component>Mailet Contributions</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17611330" author="btellier" created="Fri, 30 Sep 2022 03:19:25 +0000"  >&lt;p&gt;Interesting bit about that one is that the Attributes being un-serialisable, the error was basically un-manageable.&lt;/p&gt;

&lt;p&gt;&#160;- Cannot requeue while tracking failure count as attributes could not be serialised&lt;br/&gt;
&#160;- Cannot store it in a mail repository (attribute serialization still failing)&lt;/p&gt;

&lt;p&gt;Thus the spooler was doing a NACK that effectively requeued the poisonnous message, resulting in an infinite loop.&lt;/p&gt;

&lt;p&gt;I do belive that we should give the grammar for the Spooler to REJECT poisonnous mails, underlying implementations could then handle this rejection. In the Rabbit/Pulsar case, a dead letter topic sounds like the way to go. (that&apos;s a good thing that we have healthchecks for it!)&lt;/p&gt;

&lt;p&gt;I propose an evolution of `MailQueueItem` interface:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; MailQueueItem {
    &lt;span class=&quot;code-keyword&quot;&gt;enum&lt;/span&gt; CompletionStatus {
        SUCCESS,
        RETRY,
        REJECT
    }

    /**
     * Return the dequeued {@link Mail}
     * 
     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; mail
     */
    Mail getMail();

    /**
     * Callback which MUST get called after the operation on the dequeued
     * {@link Mail} was complete.
     * 
     * This is mostly used to either commit a transaction or rollback.
     * 
     * @param success
     * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; MailQueueException
     */
    void done(CompletionStatus success) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; MailQueueException;
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 6 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z18xpk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>