{"url":"https://api.github.com/repos/FasterXML/jackson-core/issues/1173","repository_url":"https://api.github.com/repos/FasterXML/jackson-core","labels_url":"https://api.github.com/repos/FasterXML/jackson-core/issues/1173/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-core/issues/1173/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-core/issues/1173/events","html_url":"https://github.com/FasterXML/jackson-core/issues/1173","id":2044406932,"node_id":"I_kwDOAC5a08552yyU","number":1173,"title":"`JsonLocation` consistently off by one character for many invalid JSON parsing cases","user":{"login":"hal7df","id":4631197,"node_id":"MDQ6VXNlcjQ2MzExOTc=","avatar_url":"https://avatars.githubusercontent.com/u/4631197?v=4","gravatar_id":"","url":"https://api.github.com/users/hal7df","html_url":"https://github.com/hal7df","followers_url":"https://api.github.com/users/hal7df/followers","following_url":"https://api.github.com/users/hal7df/following{/other_user}","gists_url":"https://api.github.com/users/hal7df/gists{/gist_id}","starred_url":"https://api.github.com/users/hal7df/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hal7df/subscriptions","organizations_url":"https://api.github.com/users/hal7df/orgs","repos_url":"https://api.github.com/users/hal7df/repos","events_url":"https://api.github.com/users/hal7df/events{/privacy}","received_events_url":"https://api.github.com/users/hal7df/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":6027138442,"node_id":"LA_kwDOAC5a088AAAABZz7Vig","url":"https://api.github.com/repos/FasterXML/jackson-core/labels/2.17","name":"2.17","color":"5319e7","default":false,"description":"Issues planned (at earliest) for 2.17"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2023-12-15T21:44:14Z","updated_at":"2024-02-12T03:14:17Z","closed_at":"2024-02-12T03:14:17Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"# Issue\r\nThe `JsonLocation` attached to a `JsonProcessingException` thrown when parsing an invalid JSON string is consistently one character to the right of the invalid character, except in cases where the error is due to an unexpected EOF. This affects both `JsonLocation.getCharOffset()` and `JsonLocation.getColumnNr()` (presumably `JsonLocation.getByteOffset()` as well, although I haven't tested that explicitly); because this information is used to construct the exception message, that is affected as well.\r\n\r\nI first noticed this on Jackson 2.10.0, but the issue persists on Jackson 2.16.0.\r\n\r\n## Minimally reproducible example\r\n```java\r\npackage example;\r\n\r\nimport com.fasterxml.jackson.core.JsonLocation;\r\nimport com.fasterxml.jackson.core.JsonProcessingException;\r\nimport com.fasterxml.jackson.databind.ObjectMapper;\r\n\r\npublic class JsonLocationTest {\r\n    public static void main(String[] args) {\r\n        for (String input : INVALID_JSON) {\r\n            try {\r\n                MAPPER.readTree(input);\r\n            } catch (JsonProcessingException jpe) {\r\n                JsonLocation location = jpe.getLocation();\r\n\r\n                System.out.printf(\r\n                    \"%s (at line %d, column %d):%n  %s%n  \",\r\n                    jpe.getOriginalMessage(),\r\n                    location.getLineNr(),\r\n                    location.getColumnNr(),\r\n                    input\r\n                );\r\n\r\n                // annotate the location of the error on the previous line\r\n                for (int i = 0; i < location.getCharOffset(); ++i) {\r\n                  System.out.print(' ');\r\n                }\r\n\r\n                System.out.println('^');\r\n            }\r\n        }\r\n    }\r\n\r\n    private static final String[] INVALID_JSON = new String[] {\r\n        \"{\\\"invalid\\\" \\\"json\\\"}\",\r\n        \"{\\\"also\\\", \\\"invalid\\\"}\",\r\n        \"{\\\"still\\\":[\\\"invalid\\\"[]]}\",\r\n        \"[\\\"json\\\":\\\"doesn't\\\",\\\"work\\\":\\\"like\\\",\\\"this\\\"]\",\r\n        \"{\\\"really\\\": \\\"funkyðŸ’ƒ\\\" \\\"unicode\\\"}\",\r\n        \"{\",\r\n        \"}\"\r\n    };\r\n    private static final ObjectMapper MAPPER = new ObjectMapper();\r\n}\r\n```\r\n\r\n### Expected output\r\n```\r\nUnexpected character ('\"' (code 34)): was expecting a colon to separate field name and value (at line 1, column 12):\r\n  {\"invalid\" \"json\"}\r\n             ^\r\nUnexpected character (',' (code 44)): was expecting a colon to separate field name and value (at line 1, column 8):\r\n  {\"also\", \"invalid\"}\r\n         ^\r\nUnexpected character ('[' (code 91)): was expecting comma to separate Array entries (at line 1, column 20):\r\n  {\"still\":[\"invalid\"[]]}\r\n                     ^\r\nUnexpected character (':' (code 58)): was expecting comma to separate Array entries (at line 1, column 8):\r\n  [\"json\":\"doesn't\",\"work\":\"like\",\"this\"]\r\n         ^\r\nUnexpected character ('\"' (code 34)): was expecting comma to separate Object entries (at line 1, column 22):\r\n  {\"really\": \"funkyðŸ’ƒ\" \"unicode\"}\r\n                       ^\r\nUnexpected end-of-input: expected close marker for Object (start marker at [Source: REDACTED (`StreamReadFeature.INCLUDE_SOURCE_IN_LOCATION` disabled); line: 1, column: 1]) (at line 1, column 2):\r\n  {\r\n   ^\r\nUnexpected close marker '}': expected ']' (for root starting at [Source: REDACTED (`StreamReadFeature.INCLUDE_SOURCE_IN_LOCATION` disabled); line: 1]) (at line 1, column 1):\r\n  }\r\n  ^\r\n```\r\n\r\n### Actual output\r\n(The unexpected end-of-input case here is correct IMO, just including it to be thorough)\r\n```\r\nUnexpected character ('\"' (code 34)): was expecting a colon to separate field name and value (at line 1, column 13):\r\n  {\"invalid\" \"json\"}\r\n              ^\r\nUnexpected character (',' (code 44)): was expecting a colon to separate field name and value (at line 1, column 9):\r\n  {\"also\", \"invalid\"}\r\n          ^\r\nUnexpected character ('[' (code 91)): was expecting comma to separate Array entries (at line 1, column 21):\r\n  {\"still\":[\"invalid\"[]]}\r\n                      ^\r\nUnexpected character (':' (code 58)): was expecting comma to separate Array entries (at line 1, column 9):\r\n  [\"json\":\"doesn't\",\"work\":\"like\",\"this\"]\r\n          ^\r\nUnexpected character ('\"' (code 34)): was expecting comma to separate Object entries (at line 1, column 23):\r\n  {\"really\": \"funkyðŸ’ƒ\" \"unicode\"}\r\n                        ^\r\nUnexpected end-of-input: expected close marker for Object (start marker at [Source: REDACTED (`StreamReadFeature.INCLUDE_SOURCE_IN_LOCATION` disabled); line: 1, column: 1]) (at line 1, column 2):\r\n  {\r\n   ^\r\nUnexpected close marker '}': expected ']' (for root starting at [Source: REDACTED (`StreamReadFeature.INCLUDE_SOURCE_IN_LOCATION` disabled); line: 1]) (at line 1, column 2):\r\n  }\r\n   ^\r\n```","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-core/issues/1173/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-core/issues/1173/timeline","performed_via_github_app":null,"state_reason":"completed"}