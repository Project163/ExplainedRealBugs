{"url":"https://api.github.com/repos/FasterXML/jackson-core/issues/476","repository_url":"https://api.github.com/repos/FasterXML/jackson-core","labels_url":"https://api.github.com/repos/FasterXML/jackson-core/issues/476/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-core/issues/476/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-core/issues/476/events","html_url":"https://github.com/FasterXML/jackson-core/issues/476","id":357496811,"node_id":"MDU6SXNzdWUzNTc0OTY4MTE=","number":476,"title":"Problem with `BufferRecycler` via async parser (or when sharing parser across threads)","user":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-09-06T05:00:23Z","updated_at":"2018-09-20T02:21:08Z","closed_at":"2018-09-18T05:35:53Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"(note: came from https://jira.spring.io/browse/SPR-17193)\r\n\r\nIt seems that `ThreadLocal`-based scheme used via `BufferRecycler`/`BufferRecyclers` does not work reliably if `JsonParser` (and probably `JsonGenerator` too) instance is used from more than one thread. This is commonly case for non-blocking parsing.\r\nThe problem is likely due to the fact that parser/generator obtains a `BufferRecycler` container from `ThreadLocal` and retains it during whole operation: and although underlying buffer references are cleared (to avoid accidental sharing), those operation are assumed to come from a single thread and are not synchronized.\r\n\r\nThere are multiple ways we could approach fixing. For example, it would be possible to change buffer references to use `AtomicReference`, or use equivalent data structure (like `AtomicReferenceArray`) to contain references. That would add synchronization overhead for individual access; this might not be a big problem.\r\n\r\nAlternatively we could see if the whole buffer recycling should be disabled for async parser: this is probably feasible thing to do by simply always constructing clean `BufferRecycler` for new parsers.\r\nThis would not help possible case of accessing a parser/generator from multiple threads (like separate initial processor, passing to a worker thread), however. It may or may not have worse performance as well, as no reuse would occur.\r\n\r\nBut perhaps the most interesting approach would be to instead guard access to `BufferRecycler` behind `AtomicReference` (or alternatively add `AtomicBoolean` marker in recycler, as a mark of \"in use\"). This would add overhead in just two places: when obtaining and when releasing instance.\r\nUnfortunately there is one significant problem: as things are, there is no place where recycler instance is \"returned\"; and this is by design as there is no easy place to do it from.\r\nIt may be possible to find a place, however, since parsers do have mechanism for returning individual buffers -- this would seem like the place for \"releasing\" recycler itself too.\r\n\r\n","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-core/issues/476/reactions","total_count":5,"+1":5,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-core/issues/476/timeline","performed_via_github_app":null,"state_reason":"completed"}