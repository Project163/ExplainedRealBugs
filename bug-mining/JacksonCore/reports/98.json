{"url":"https://api.github.com/repos/FasterXML/jackson-core/issues/652","repository_url":"https://api.github.com/repos/FasterXML/jackson-core","labels_url":"https://api.github.com/repos/FasterXML/jackson-core/issues/652/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-core/issues/652/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-core/issues/652/events","html_url":"https://github.com/FasterXML/jackson-core/issues/652","id":741174786,"node_id":"MDU6SXNzdWU3NDExNzQ3ODY=","number":652,"title":"Misleading exception for input source when processing byte buffer with start offset (see `JsonProcessingException`)","user":{"login":"gwittel","id":484093,"node_id":"MDQ6VXNlcjQ4NDA5Mw==","avatar_url":"https://avatars.githubusercontent.com/u/484093?v=4","gravatar_id":"","url":"https://api.github.com/users/gwittel","html_url":"https://github.com/gwittel","followers_url":"https://api.github.com/users/gwittel/followers","following_url":"https://api.github.com/users/gwittel/following{/other_user}","gists_url":"https://api.github.com/users/gwittel/gists{/gist_id}","starred_url":"https://api.github.com/users/gwittel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwittel/subscriptions","organizations_url":"https://api.github.com/users/gwittel/orgs","repos_url":"https://api.github.com/users/gwittel/repos","events_url":"https://api.github.com/users/gwittel/events{/privacy}","received_events_url":"https://api.github.com/users/gwittel/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-core/milestones/58","html_url":"https://github.com/FasterXML/jackson-core/milestone/58","labels_url":"https://api.github.com/repos/FasterXML/jackson-core/milestones/58/labels","id":6361716,"node_id":"MDk6TWlsZXN0b25lNjM2MTcxNg==","number":58,"title":"2.13.0","description":null,"creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":7,"state":"open","created_at":"2021-01-28T03:31:46Z","updated_at":"2021-08-19T02:29:21Z","due_on":null,"closed_at":null},"comments":9,"created_at":"2020-11-11T23:04:09Z","updated_at":"2025-06-13T20:45:23Z","closed_at":"2021-04-04T19:18:59Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n\r\nIf I use the `ObjectMapper.readValue(byte[], int offset, int len, TypeReference)` interface to deserialize a value AND the deserialize fails (e.g. bad data not conforming to the expected type), the exception refers to the entire buffer rather than the buffer starting at `offset`.\r\n\r\nThis leads to a misleading exception where it appears as the entire buffer is the problem, where the real problem is starting somewhere else.\r\n\r\nThis came up when processing byte buffers of JSON line separated data (so the buffer may contain more than one JSON object).\r\n\r\n**Version information**\r\nWhich Jackson version(s) was this for?\r\n\r\n2.11.0\r\n\r\n**To Reproduce**\r\nIf you have a way to reproduce this with:\r\n\r\n```java\r\n@Test\r\npublic void simpleJsonTest()\r\n        throws Exception\r\n{\r\n    String json = \"{\\\"k1\\\":\\\"v1\\\"}\\n[\\\"oops\\\"]\\n{\\\"k2\\\":\\\"v2\\\"}\";\r\n    byte[] buffer = json.getBytes(UTF_8);\r\n    int itemStart = json.indexOf('\\n') + 1; // Get the second record start\r\n    int itemEnd = json.indexOf('\\n', itemStart); // End of second record\r\n    int itemLength = itemEnd - itemStart;\r\n\r\n    ObjectMapper mapper = new ObjectMapper();\r\n\r\n    TypeReference<Map<String, String>> typeReference = new TypeReference<>()\r\n    {\r\n    };\r\n\r\n    Map<String, String> decoded = mapper.readValue(buffer, itemStart, itemLength, typeReference);\r\n}\r\n```\r\n\r\nStack trace with error:\r\n\r\n```\r\ncom.fasterxml.jackson.databind.exc.MismatchedInputException: Cannot deserialize instance of `java.util.LinkedHashMap<java.lang.Object,java.lang.Object>` out of START_ARRAY token\r\n at [Source: (byte[])\"{\"k1\":\"v1\"}\r\n[\"oops\"]\r\n{\"k2\":\"v2\"}\"; line: 1, column: 1]\r\n\r\n\tat com.fasterxml.jackson.databind.exc.MismatchedInputException.from(MismatchedInputException.java:59)\r\n\tat com.fasterxml.jackson.databind.DeserializationContext.reportInputMismatch(DeserializationContext.java:1464)\r\n\tat com.fasterxml.jackson.databind.DeserializationContext.handleUnexpectedToken(DeserializationContext.java:1238)\r\n\tat com.fasterxml.jackson.databind.DeserializationContext.handleUnexpectedToken(DeserializationContext.java:1148)\r\n\tat com.fasterxml.jackson.databind.deser.std.StdDeserializer._deserializeFromEmpty(StdDeserializer.java:639)\r\n\tat com.fasterxml.jackson.databind.deser.std.MapDeserializer.deserialize(MapDeserializer.java:360)\r\n\tat com.fasterxml.jackson.databind.deser.std.MapDeserializer.deserialize(MapDeserializer.java:29)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper._readMapAndClose(ObjectMapper.java:4482)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3521)\r\n\tat XXX.simpleJsonTest(XXX.java:152)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n\tat org.testng.internal.MethodInvocationHelper.invokeMethod(MethodInvocationHelper.java:124)\r\n\tat org.testng.internal.Invoker.invokeMethod(Invoker.java:583)\r\n\tat org.testng.internal.Invoker.invokeTestMethod(Invoker.java:719)\r\n\tat org.testng.internal.Invoker.invokeTestMethods(Invoker.java:989)\r\n\tat org.testng.internal.TestMethodWorker.invokeTestMethods(TestMethodWorker.java:125)\r\n\tat org.testng.internal.TestMethodWorker.run(TestMethodWorker.java:109)\r\n\tat org.testng.TestRunner.privateRun(TestRunner.java:648)\r\n\tat org.testng.TestRunner.run(TestRunner.java:505)\r\n\tat org.testng.SuiteRunner.runTest(SuiteRunner.java:455)\r\n\tat org.testng.SuiteRunner.runSequentially(SuiteRunner.java:450)\r\n\tat org.testng.SuiteRunner.privateRun(SuiteRunner.java:415)\r\n\tat org.testng.SuiteRunner.run(SuiteRunner.java:364)\r\n\tat org.testng.SuiteRunnerWorker.runSuite(SuiteRunnerWorker.java:52)\r\n\tat org.testng.SuiteRunnerWorker.run(SuiteRunnerWorker.java:84)\r\n\tat org.testng.TestNG.runSuitesSequentially(TestNG.java:1208)\r\n\tat org.testng.TestNG.runSuitesLocally(TestNG.java:1137)\r\n\tat org.testng.TestNG.runSuites(TestNG.java:1049)\r\n\tat org.testng.TestNG.run(TestNG.java:1017)\r\n\tat com.intellij.rt.testng.IDEARemoteTestNG.run(IDEARemoteTestNG.java:66)\r\n\tat com.intellij.rt.testng.RemoteTestNGStarter.main(RemoteTestNGStarter.java:109)\r\n```\r\n\r\n**Expected behavior**\r\n\r\nIn this case, I would expect the exception error message to point to the start offset (here its the `[\"oops\"]` chunk).  Due to the supplied source context, the \"line 1 column 1\" guides the reader to point to the start of the (valid) first record in the buffer, rather than the actual problem which is line 1 column 1 in the second invalid record.\r\n\r\n**Additional context**\r\n\r\nAdd any other context about the problem here.\r\n\r\nIn the example, the underlying exceptions' JsonLocation looks like this:\r\n\r\n```\r\n_totalBytes = 0\r\n_totalChars = -1\r\n_lineNr = 1\r\n_columnNr = 1\r\n_sourceRef= The whole buffer\r\n```\r\n","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-core/issues/652/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-core/issues/652/timeline","performed_via_github_app":null,"state_reason":"completed"}