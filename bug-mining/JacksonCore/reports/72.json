{"url":"https://api.github.com/repos/FasterXML/jackson-core/issues/547","repository_url":"https://api.github.com/repos/FasterXML/jackson-core","labels_url":"https://api.github.com/repos/FasterXML/jackson-core/issues/547/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-core/issues/547/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-core/issues/547/events","html_url":"https://github.com/FasterXML/jackson-core/issues/547","id":473655426,"node_id":"MDU6SXNzdWU0NzM2NTU0MjY=","number":547,"title":"`CharsToNameCanonicalizer`: Internal error on `SymbolTable.rehash()` with high number of hash collisions","user":{"login":"alpire","id":111427,"node_id":"MDQ6VXNlcjExMTQyNw==","avatar_url":"https://avatars.githubusercontent.com/u/111427?v=4","gravatar_id":"","url":"https://api.github.com/users/alpire","html_url":"https://github.com/alpire","followers_url":"https://api.github.com/users/alpire/followers","following_url":"https://api.github.com/users/alpire/following{/other_user}","gists_url":"https://api.github.com/users/alpire/gists{/gist_id}","starred_url":"https://api.github.com/users/alpire/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpire/subscriptions","organizations_url":"https://api.github.com/users/alpire/orgs","repos_url":"https://api.github.com/users/alpire/repos","events_url":"https://api.github.com/users/alpire/events{/privacy}","received_events_url":"https://api.github.com/users/alpire/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-core/milestones/46","html_url":"https://github.com/FasterXML/jackson-core/milestone/46","labels_url":"https://api.github.com/repos/FasterXML/jackson-core/milestones/46/labels","id":4527808,"node_id":"MDk6TWlsZXN0b25lNDUyNzgwOA==","number":46,"title":"2.10.0.pr2","description":null,"creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":5,"state":"open","created_at":"2019-07-28T21:25:19Z","updated_at":"2019-08-27T05:06:35Z","due_on":null,"closed_at":null},"comments":5,"created_at":"2019-07-27T16:37:51Z","updated_at":"2019-07-28T21:26:07Z","closed_at":"2019-07-28T21:26:07Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Fuzzing jackson-core led to the following exception during CharsToNameCanonicalizer's rehashing:\r\n\r\n```\r\njava.lang.IllegalStateException: Internal error on SymbolTable.rehash(): had 3379 entries; now have 3381\r\n       at com.fasterxml.jackson.core.sym.CharsToNameCanonicalizer.rehash(CharsToNameCanonicalizer.java:678)\r\n       at com.fasterxml.jackson.core.sym.CharsToNameCanonicalizer._addSymbol(CharsToNameCanonicalizer.java:483)\r\n       at com.fasterxml.jackson.core.sym.CharsToNameCanonicalizer.findSymbol(CharsToNameCanonicalizer.java:463)\r\n       at com.fasterxml.jackson.core.json.ReaderBasedJsonParser._handleOddName(ReaderBasedJsonParser.java:1813)\r\n       at com.fasterxml.jackson.core.json.ReaderBasedJsonParser.nextFieldName(ReaderBasedJsonParser.java:932)\r\n       at com.fasterxml.jackson.databind.deser.BeanDeserializer.vanillaDeserialize(BeanDeserializer.java:295)\r\n       at com.fasterxml.jackson.databind.deser.BeanDeserializer.deserialize(BeanDeserializer.java:151)\r\n       at com.fasterxml.jackson.databind.ObjectMapper._readMapAndClose(ObjectMapper.java:4086)\r\n       at com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3139))\r\n```\r\n\r\nRehasing leads to additional entries in the hash table. This is probably due from `_size` not maching the actual number of entries in the hash table. I unfortunately cannot easily reproduce the issue since it is the results of parsing millions of inputs in the same process. Starting another fuzzing run may or may not trigger it.\r\n\r\nLooking at the code, I think this mismatch could be stemming from  `_handleSpillOverflow`.  The function [reduces the `_size` by `newBucket.length`](https://github.com/FasterXML/jackson-core/blob/master/src/main/java/com/fasterxml/jackson/core/sym/CharsToNameCanonicalizer.java#L529), even though it keeps one item out of that bucket in the table. I believe that line should be `_size -= (newBucket.length - 1);`. The code is unfamiliar to me, so it's very possibly I got that wrong.\r\n\r\njackson-core was compiled from source (commit c8fe42d601dea21f2f0de1530123ef041817394c in 2.10). jackson-bind and jackson-annotations were downloaded from maven (2.10.0.pr1).\r\n\r\n","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-core/issues/547/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-core/issues/547/timeline","performed_via_github_app":null,"state_reason":"completed"}