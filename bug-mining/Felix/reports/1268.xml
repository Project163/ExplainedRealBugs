<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:22:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-1816] deadlock on SystemBundle.stop()</title>
                <link>https://issues.apache.org/jira/browse/FELIX-1816</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;When one calls SystemBundle.stop within BundleActivator.start(BundleContext) a deadlock occurs.&lt;/p&gt;

&lt;p&gt;I will attach a stacktrace.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12439261">FELIX-1816</key>
            <summary>deadlock on SystemBundle.stop()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="dennisg">Dennis Geurts</reporter>
                        <labels>
                    </labels>
                <created>Wed, 28 Oct 2009 09:34:47 +0000</created>
                <updated>Thu, 10 Mar 2011 21:12:42 +0000</updated>
                            <resolved>Thu, 10 Mar 2011 21:12:42 +0000</resolved>
                                    <version>framework-2.0.1</version>
                                    <fixVersion>framework-3.2.0</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12770887" author="karlpauls" created="Wed, 28 Oct 2009 10:43:36 +0000"  >&lt;p&gt;This doesn&apos;t seem to be correct in the sense that the systembundle.stop isn&apos;t the only thing contributing to the deadlock. The shutdownhook in the launcher is running and causing your problems again. Are you ctrl-c&apos;ing or sending kill signals to the jvm externally? Just have a look at the stacktrace:&lt;/p&gt;

&lt;p&gt;&quot;SIGTERM handler&quot; daemon prio=9 tid=0x0000000102830800 nid=0x114b94000 in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0x0000000114b93000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: WAITING (on object monitor)&lt;br/&gt;
	at java.lang.Object.wait(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting on &amp;lt;0x000000010637fa10&amp;gt; (a org.apache.felix.main.Main$1)&lt;br/&gt;
	at java.lang.Thread.join(Thread.java:1167)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x000000010637fa10&amp;gt; (a org.apache.felix.main.Main$1)&lt;br/&gt;
	at java.lang.Thread.join(Thread.java:1220)&lt;br/&gt;
	at java.lang.ApplicationShutdownHooks.runHooks(ApplicationShutdownHooks.java:79)&lt;br/&gt;
	at java.lang.ApplicationShutdownHooks$1.run(ApplicationShutdownHooks.java:24)&lt;br/&gt;
	at java.lang.Shutdown.runHooks(Shutdown.java:79)&lt;br/&gt;
	at java.lang.Shutdown.sequence(Shutdown.java:123)&lt;br/&gt;
	at java.lang.Shutdown.exit(Shutdown.java:168)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x000000010ba5b830&amp;gt; (a java.lang.Class for java.lang.Shutdown)&lt;br/&gt;
	at java.lang.Terminator$1.handle(Terminator.java:35)&lt;br/&gt;
	at sun.misc.Signal$1.run(Signal.java:195)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:637)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The jvm is getting a SIGTERM. Notice, in the other issue the stacktrace didn&apos;t contain a SIGTERM but just the call to system exit. If you don&apos;t do anything externally please attach an example again so that i can try to reproduce. &lt;/p&gt;

&lt;p&gt;Anyways, I will have to investigate as a control-c together with a systembundle.stop shouldn&apos;t deadlock in the first place. Thanks for reporting &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12770898" author="karlpauls" created="Wed, 28 Oct 2009 11:34:32 +0000"  >&lt;p&gt;Ok, I think I see what is gonig on. You probably just hit ctrl-c to terminate the jvm after it was deadlocking. &lt;/p&gt;

&lt;p&gt;Nevermind, this looks like a bug. I will try to fix it (but you might not like the solution). Basically, the issue seems to be that you are trying to stop the system bundle while it is still starting. This shouldn&apos;t deadlock but we probably will have to throw some exception from the stop method. I will have to look into this some more first, however. Thanks again. &lt;/p&gt;</comment>
                            <comment id="12770909" author="dennisg" created="Wed, 28 Oct 2009 12:17:51 +0000"  >&lt;p&gt;Thanks for looking into the issue. It&apos;s much appreciated!&lt;/p&gt;

&lt;p&gt;Indeed I get my &lt;em&gt;stacktraces&lt;/em&gt; from a &apos;kill -QUIT&apos;; Thus the SIGTERM handler kicking in.&lt;/p&gt;

&lt;p&gt;I hadn&apos;t noticed that the SIGTERM isn&apos;t there in the trace of the other issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-1812&quot; title=&quot;deadlock on System.exit()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-1812&quot;&gt;&lt;del&gt;FELIX-1812&lt;/del&gt;&lt;/a&gt;). Is this due to the fact that System.exit already has been called ?&lt;/p&gt;

&lt;p&gt;the blocking factors are:&lt;br/&gt;
&quot;Felix Shutdown Hook&quot; prio=5 tid=0x0000000102031000 nid=0x114c97000 in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0x0000000114c96000&amp;#93;&lt;/span&gt;&lt;br/&gt;
        ...&lt;br/&gt;
        at org.apache.felix.framework.Felix.acquireBundleLock(Felix.java:4481)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked &amp;lt;0x0000000106451f38&amp;gt; (a [Ljava.lang.Object&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;and&lt;br/&gt;
&quot;FelixStartLevel&quot; daemon prio=5 tid=0x00000001020f7800 nid=0x114904000 in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0x0000000114903000&amp;#93;&lt;/span&gt;&lt;br/&gt;
        ...&lt;br/&gt;
        at org.apache.felix.framework.Felix.acquireBundleLock(Felix.java:4481)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked &amp;lt;0x0000000106451f38&amp;gt; (a [Ljava.lang.Object&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Please find attached an additional stacktrace, also recorded using a &apos;kill -QUIT&apos;  while running WITHOUT the shutdown hook. Then, the end result is such, that the java process is not stopped. There&apos;s no deadlock however, since ctrl-c&apos;ing stops the process.&lt;/p&gt;
</comment>
                            <comment id="12771958" author="karlpauls" created="Fri, 30 Oct 2009 14:38:37 +0000"  >&lt;p&gt;Ok, well, the problem is in this case that the system bundle is still in the STARTING state when it&apos;s stop method is called. That get us into the deadlock. &lt;/p&gt;

&lt;p&gt;Now, a proper solution would probably include a timeout mechanism but for now i just resolved the issue by having the framework throw an exception as a result of the stop call (this is allowed by the spec and would happen with a timeout too - eventually). Downside for you is that you don&apos;t get what you want (i.e., the framework shutdown) but an exception inside your Activator.start. Again, what you would have to do is to at least wait for the framework to be in the ACTIVE state before calling the stop method (you can check the state and if its not ACTIVE then register a framework listener and wait for that event). &lt;/p&gt;

&lt;p&gt;However, as a side effect this makes it possible again to call System.exit inside an activator.start method while the framework is still in the STARTING state. See &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-1812&quot; title=&quot;deadlock on System.exit()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-1812&quot;&gt;&lt;del&gt;FELIX-1812&lt;/del&gt;&lt;/a&gt; for more on that. &lt;/p&gt;</comment>
                            <comment id="12771959" author="karlpauls" created="Fri, 30 Oct 2009 14:39:13 +0000"  >&lt;p&gt;Please close this issue if you are satisfied with the change to trunk.&lt;/p&gt;</comment>
                            <comment id="12772049" author="dennisg" created="Fri, 30 Oct 2009 19:24:36 +0000"  >&lt;p&gt;verified, indeed the exception is thrown, with a very good explanation of the situation.&lt;/p&gt;</comment>
                            <comment id="12772340" author="karlpauls" created="Sun, 1 Nov 2009 16:40:16 +0000"  >&lt;p&gt;I re-open this issue as I really don&apos;t like the solution (and it makes various other cases fail). I will have to get back to this and fix it correctly by introducing timeouts or something. The result for this case would be the same I imagine but for now i will rollback.&lt;/p&gt;</comment>
                            <comment id="13005336" author="rickhall" created="Thu, 10 Mar 2011 21:12:42 +0000"  >&lt;p&gt;I committed a patch to move the shutdown thread out further so that the calling thread doesn&apos;t attempt to lock the system bundle, thus allowing it to return immediately and avoiding the deadlock.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12423444" name="Activator.java" size="427" author="dennisg" created="Wed, 28 Oct 2009 12:17:51 +0000"/>
                            <attachment id="12423443" name="felix-framework-2.0.1.tar.gz" size="364049" author="dennisg" created="Wed, 28 Oct 2009 12:17:51 +0000"/>
                            <attachment id="12423445" name="trace-nohook.log" size="5793" author="dennisg" created="Wed, 28 Oct 2009 12:17:51 +0000"/>
                            <attachment id="12423430" name="trace.log" size="7249" author="dennisg" created="Wed, 28 Oct 2009 09:35:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>57221</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0vr3b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>183362</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>