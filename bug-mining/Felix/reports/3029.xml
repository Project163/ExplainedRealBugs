<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:12:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-4260] IllegalStateException: The service has been unregistered</title>
                <link>https://issues.apache.org/jira/browse/FELIX-4260</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;Currently I get this as an framework Error:&lt;/p&gt;

&lt;p&gt;java.lang.IllegalStateException: The service has been unregistered&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:209)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:668)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:644)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerComponentService(AbstractComponentManager.java:688)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$Unsatisfied.activate(AbstractComponentManager.java:1481)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.activateInternal(AbstractComponentManager.java:550)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.serviceAdded(DependencyManager.java:333)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:159)&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.FilteredServiceListener.serviceChanged(FilteredServiceListener.java:104)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleContextImpl.dispatchEvent(BundleContextImpl.java:861)&lt;br/&gt;
	at org.eclipse.osgi.framework.eventmgr.EventManager.dispatchEvent(EventManager.java:230)&lt;br/&gt;
	at org.eclipse.osgi.framework.eventmgr.ListenerQueue.dispatchEventSynchronous(ListenerQueue.java:148)&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.ServiceRegistry.publishServiceEventPrivileged(ServiceRegistry.java:819)&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.ServiceRegistry.publishServiceEvent(ServiceRegistry.java:771)&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.ServiceRegistrationImpl.register(ServiceRegistrationImpl.java:130)&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.ServiceRegistry.registerService(ServiceRegistry.java:214)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleContextImpl.registerService(BundleContextImpl.java:433)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:660)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:644)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerComponentService(AbstractComponentManager.java:688)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$Unsatisfied.activate(AbstractComponentManager.java:1481)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.activateInternal(AbstractComponentManager.java:550)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.enable(AbstractComponentManager.java:261)&lt;br/&gt;
	at org.apache.felix.scr.impl.config.ImmediateComponentHolder.enableComponents(ImmediateComponentHolder.java:328)&lt;br/&gt;
	at org.apache.felix.scr.impl.BundleComponentActivator.initialize(BundleComponentActivator.java:158)&lt;br/&gt;
	at org.apache.felix.scr.impl.BundleComponentActivator.&amp;lt;init&amp;gt;(BundleComponentActivator.java:113)&lt;br/&gt;
	at org.apache.felix.scr.impl.Activator.loadComponents(Activator.java:261)&lt;br/&gt;
	at org.apache.felix.scr.impl.Activator.bundleChanged(Activator.java:179)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleContextImpl.dispatchEvent(BundleContextImpl.java:847)&lt;br/&gt;
	at org.eclipse.osgi.framework.eventmgr.EventManager.dispatchEvent(EventManager.java:230)&lt;br/&gt;
	at org.eclipse.osgi.framework.eventmgr.ListenerQueue.dispatchEventSynchronous(ListenerQueue.java:148)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.Framework.publishBundleEventPrivileged(Framework.java:1522)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.Framework.publishBundleEvent(Framework.java:1458)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.Framework.publishBundleEvent(Framework.java:1453)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleHost.startWorker(BundleHost.java:391)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.AbstractBundle.resume(AbstractBundle.java:389)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.Framework.resumeBundle(Framework.java:1130)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.StartLevelManager.resumeBundles(StartLevelManager.java:559)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.StartLevelManager.resumeBundles(StartLevelManager.java:544)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.StartLevelManager.incFWSL(StartLevelManager.java:457)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.StartLevelManager.doSetStartLevel(StartLevelManager.java:243)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.StartLevelManager.dispatchEvent(StartLevelManager.java:438)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.StartLevelManager.dispatchEvent(StartLevelManager.java:1)&lt;br/&gt;
	at org.eclipse.osgi.framework.eventmgr.EventManager.dispatchEvent(EventManager.java:230)&lt;br/&gt;
	at org.eclipse.osgi.framework.eventmgr.EventManager$EventThread.run(EventManager.java:340)&lt;/p&gt;

&lt;p&gt;This currently prevents the starting of one of my components. It seems that there is some kind of concurrency. If the ServiceReference is handled in a concurrent way, the IllegalStateException must be caught because it is possible that the service was already unregistered automatically in the event of an refresh/stop of the bundle.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12671533">FELIX-4260</key>
            <summary>IllegalStateException: The service has been unregistered</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cziegeler">Carsten Ziegeler</assignee>
                                    <reporter username="laeubi">Christoph L&#228;ubrich</reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 Oct 2013 08:43:22 +0000</created>
                <updated>Sat, 6 Oct 2018 14:56:33 +0000</updated>
                            <resolved>Sun, 23 Sep 2018 15:28:32 +0000</resolved>
                                                    <fixVersion>scr-2.1.10</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13783066" author="djencks" created="Tue, 1 Oct 2013 15:49:39 +0000"  >&lt;p&gt;Please try with trunk. I fixed a lot of problems in this area.&lt;/p&gt;</comment>
                            <comment id="14658471" author="bosschaert" created="Wed, 5 Aug 2015 16:30:38 +0000"  >&lt;p&gt;Is this still an issue? If so please provide the versions of the framework and SCR used...&lt;/p&gt;</comment>
                            <comment id="14658699" author="laeubi" created="Wed, 5 Aug 2015 19:03:12 +0000"  >&lt;p&gt;At the time this issue was present I used Equinox 3.7 and Felic SCR 1.6&lt;br/&gt;
I then switched to the trunk version as suggested and didn&apos;t see the problem any longer as far as I remember. I still see in the 1.8 line where operations for DS components are executed outside the &quot;Component-Thread&quot; e.g. if services are registered inside seperate threads or if CM updates take place. I&apos;m just not sure if this is an issue or is intentional.&lt;/p&gt;</comment>
                            <comment id="16622164" author="bdaniel" created="Thu, 20 Sep 2018 14:59:59 +0000"  >&lt;p&gt;This is still a problem in the current trunk (or, at least, a very similar problem.)&#160;&lt;/p&gt;

&lt;p&gt;I see this when a component is activated and deactivated simultaneously. AbstractComponentManager activateInternal and deactivateInternal only obtain the read lock of the ReentrantReadWriteLock so they&apos;re able to run simultaneously. activateInternal runs to the finally block currently on line 744. Then the deactivateInternal thread gets control which causes the service registration to be unregistered. The activate thread gets control again and gets an IllegalStateException in serviceRegistration.getReference().&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
java.lang.IllegalStateException: The service has been unregistered&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.eclipse.osgi.internal.serviceregistry.ServiceRegistrationImpl.getReferenceImpl(ServiceRegistrationImpl.java:285)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.eclipse.osgi.internal.serviceregistry.ServiceRegistrationImpl.getReference(ServiceRegistrationImpl.java:274)&lt;br/&gt;
&#160;&#160;&#160;&#160;at org.apache.felix.scr.impl.manager.AbstractComponentManager.activateInternal(AbstractComponentManager.java:759)&lt;/p&gt;</comment>
                            <comment id="16622324" author="cziegeler" created="Thu, 20 Sep 2018 16:46:48 +0000"  >&lt;p&gt;Thanks for reporting, let&apos;s try to get this fixed in the next release. Is it possible to provide a reproducible test case for this?&lt;/p&gt;</comment>
                            <comment id="16622353" author="laeubi" created="Thu, 20 Sep 2018 17:12:55 +0000"  >&lt;p&gt;This is hard to tell witout knowing the details of the implementation but you can force such an error in the following way:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Register a service in the activator&lt;/li&gt;
	&lt;li&gt;in the stop method, start a thread that sleeps for a second and the unregisters the service reference&lt;/li&gt;
	&lt;li&gt;start the bundle and then stop it&lt;/li&gt;
	&lt;li&gt;You will get the exception from the framework after the 1 second delay because the service was unregistered already&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;With this in mind, one has to check the places mentioned in the stack traces if there is a chance that these are called concurrently in respect to the OSGi thread, e.g this can happen if config changes occurs from config admin and so on. Another thing to check is, if the SCR service might shares service references and they got freede more than once.&lt;/p&gt;

&lt;p&gt;Sad enough, there is no way to tell if the service was previously unregistered. My aproach would be to have a method for unregister a service reference and has some kind of&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
  sr.unregister()
} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(IllegalStateException e) {
 LOG.warn(&quot;Attempted to unregister ServiceRegistration {} from thread {} but it was already unregistered from bundle {] state {}), sr, &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread(), sr.
getBundle().getSymbolicName(), sr.
getBundle().getState()}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That way the unregistration will proceed and the warning would contain better information to debug the problem further (if there is any)&lt;/p&gt;</comment>
                            <comment id="16625145" author="cziegeler" created="Sun, 23 Sep 2018 15:28:32 +0000"  >&lt;p&gt;I&apos;ve added additional code to catch the illegal state exception in various places&lt;br/&gt;
That should fix the problem.&lt;/p&gt;

&lt;p&gt;Rev 1841758&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13189851">FELIX-5953</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>351243</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 8 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ok7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>351535</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>