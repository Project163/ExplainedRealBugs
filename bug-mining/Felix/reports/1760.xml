<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:46:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3761] When a bundle registers a service, the bundle lock is obtained without any real purpose</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3761</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;It leads to the following kind of deadlocks:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;Felix WebConsole worker&quot;&lt;/span&gt; Id=170 in WAITING on lock=[Ljava.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;@108a93d9
    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:485)
    at org.apache.felix.framework.Felix.acquireBundleLock(Felix.java:5203)
    at org.apache.felix.framework.Felix.registerService(Felix.java:3452)
    at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)
    at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:320)
    at org.apache.felix.webconsole.internal.core.BundlesServlet.activate(BundlesServlet.java:132)
    at org.apache.felix.webconsole.internal.servlet.PluginHolder$InternalPlugin.doGetConsolePlugin(PluginHolder.java:752)
    at org.apache.felix.webconsole.internal.servlet.PluginHolder$Plugin.getConsolePlugin(PluginHolder.java:535)
    at org.apache.felix.webconsole.internal.servlet.PluginHolder.getPlugin(PluginHolder.java:205)
    at org.apache.felix.webconsole.internal.servlet.OsgiManager.initInternalPlugins(OsgiManager.java:1016)
    at org.apache.felix.webconsole.internal.servlet.OsgiManager.doUpdateConfiguration(OsgiManager.java:981)
    at org.apache.felix.webconsole.internal.servlet.OsgiManager$6.run(OsgiManager.java:930)
    at org.apache.felix.webconsole.internal.servlet.Executor$Worker.run(Executor.java:67)

&lt;span class=&quot;code-quote&quot;&gt;&quot;FelixFrameworkWiring&quot;&lt;/span&gt; Id=168 in WAITING on lock=java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;@3d6bca49
    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:485)
    at org.apache.felix.webconsole.internal.servlet.Executor.shutdown(Executor.java:45)
      - locked org.apache.felix.webconsole.internal.servlet.Executor@21875b11
    at org.apache.felix.webconsole.internal.servlet.OsgiManager.dispose(OsgiManager.java:407)
    at org.apache.felix.webconsole.internal.KarafOsgiManagerActivator.stop(KarafOsgiManagerActivator.java:52)
    at org.apache.felix.framework.util.SecureAction.stopActivator(SecureAction.java:667)
    at org.apache.felix.framework.Felix.stopBundle(Felix.java:2604)
    at org.apache.felix.framework.Felix$RefreshHelper.stop(Felix.java:4961)
    at org.apache.felix.framework.Felix.refreshPackages(Felix.java:4203)
    at org.apache.felix.framework.FrameworkWiringImpl.run(FrameworkWiringImpl.java:172)
    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:680)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There&apos;s really no need to grab the bundle lock because the bundle is necessarily starting / active / stopping, else an exception would have been thrown when calling the registerService because the BundleContext object would have been invalidated, and the registry itself is synchronized.  &lt;/p&gt;</description>
                <environment></environment>
        <key id="12616379">FELIX-3761</key>
            <summary>When a bundle registers a service, the bundle lock is obtained without any real purpose</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gnodet">Guillaume Nodet</assignee>
                                    <reporter username="gnodet">Guillaume Nodet</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Nov 2012 09:15:20 +0000</created>
                <updated>Fri, 14 Dec 2012 16:24:13 +0000</updated>
                            <resolved>Fri, 14 Dec 2012 16:24:13 +0000</resolved>
                                    <version>framework-4.0.2</version>
                                    <fixVersion>framework-4.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13498685" author="gnt" created="Fri, 16 Nov 2012 09:18:06 +0000"  >&lt;p&gt;I&apos;m proposing the following patch, which is only about removing the bundle lock access in the Felix#registerService method&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/framework/src/main/java/org/apache/felix/framework/Felix.java b/framework/src/main/java/org/apache/felix/framework/Felix.java
index 8ffec89..08b6d90 100644
--- a/framework/src/main/java/org/apache/felix/framework/Felix.java
+++ b/framework/src/main/java/org/apache/felix/framework/Felix.java
@@ -3446,51 +3446,32 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Felix &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; BundleImpl &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Framework
             &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Service object cannot be &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;.&quot;&lt;/span&gt;);
         }
 
-        &lt;span class=&quot;code-comment&quot;&gt;// Acquire bundle lock.
&lt;/span&gt;-        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
-        {
-            acquireBundleLock(bundle, Bundle.STARTING | Bundle.ACTIVE | Bundle.STOPPING);
-        }
-        &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IllegalStateException ex)
-        {
-            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(
-                &lt;span class=&quot;code-quote&quot;&gt;&quot;Can only register services &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; bundle is active or activating.&quot;&lt;/span&gt;);
-        }
-
         ServiceRegistration reg = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
 
-        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
+        &lt;span class=&quot;code-comment&quot;&gt;// Check to make sure that the service object is
&lt;/span&gt;+        &lt;span class=&quot;code-comment&quot;&gt;// an instance of all service classes; ignore &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;
&lt;/span&gt;+        &lt;span class=&quot;code-comment&quot;&gt;// service object is a service factory.
&lt;/span&gt;+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(svcObj &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ServiceFactory))
         {
-            &lt;span class=&quot;code-comment&quot;&gt;// Check to make sure that the service object is
&lt;/span&gt;-            &lt;span class=&quot;code-comment&quot;&gt;// an instance of all service classes; ignore &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;
&lt;/span&gt;-            &lt;span class=&quot;code-comment&quot;&gt;// service object is a service factory.
&lt;/span&gt;-            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(svcObj &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ServiceFactory))
+            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; classNames.length; i++)
             {
-                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; classNames.length; i++)
+                &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; clazz = Util.loadClassUsingClass(svcObj.getClass(), classNames[i], m_secureAction);
+                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (clazz == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
                 {
-                    &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; clazz = Util.loadClassUsingClass(svcObj.getClass(), classNames[i], m_secureAction);
-                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (clazz == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
-                    {
-                        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(
-                            &lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; service: &quot;&lt;/span&gt; + classNames[i]);
-                    }
-                    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!clazz.isAssignableFrom(svcObj.getClass()))
-                    {
-                        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(
-                            &lt;span class=&quot;code-quote&quot;&gt;&quot;Service object is not an instance of \&quot;&lt;/span&gt;&quot;
-                            + classNames[i] + &lt;span class=&quot;code-quote&quot;&gt;&quot;\&quot;&lt;/span&gt;.&quot;);
-                    }
+                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(
+                        &lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; service: &quot;&lt;/span&gt; + classNames[i]);
+                }
+                &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!clazz.isAssignableFrom(svcObj.getClass()))
+                {
+                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(
+                        &lt;span class=&quot;code-quote&quot;&gt;&quot;Service object is not an instance of \&quot;&lt;/span&gt;&quot;
+                        + classNames[i] + &lt;span class=&quot;code-quote&quot;&gt;&quot;\&quot;&lt;/span&gt;.&quot;);
                 }
             }
-
-            reg = m_registry.registerService(bundle, classNames, svcObj, dict);
-        }
-        &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt;
-        {
-            &lt;span class=&quot;code-comment&quot;&gt;// Always release bundle lock.
&lt;/span&gt;-            releaseBundleLock(bundle);
         }
 
+        reg = m_registry.registerService(bundle, classNames, svcObj, dict);
+
         &lt;span class=&quot;code-comment&quot;&gt;// Check to see &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; a listener hook; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; so, then we need
&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// to invoke the callback with all existing service listeners.
&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ServiceRegistry.isHook(
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13507082" author="rickhall" created="Fri, 30 Nov 2012 04:20:12 +0000"  >&lt;p&gt;Perhaps I&apos;m missing something, but if we remove the bundle lock, then isn&apos;t it possible that the bundle could stop before the service is registered and thus the service would get missed when unregistering all services when the bundle is stopped? Ultimately, this would leave the service in the service registry even though the bundle is stopped.&lt;/p&gt;</comment>
                            <comment id="13507141" author="fmeschbe" created="Fri, 30 Nov 2012 06:51:20 +0000"  >&lt;p&gt;Looking from the Web Console side of the things: I never have seen this Executor class. What is this about ?&lt;/p&gt;</comment>
                            <comment id="13507152" author="rickhall" created="Fri, 30 Nov 2012 07:12:38 +0000"  >&lt;p&gt;Just to follow up with a little more detail as to why I think the lock is necessary...&lt;/p&gt;

&lt;p&gt;It is true that we check if the bundle is in the correct state in BundleContextImpl.registerService(), but if we don&apos;t prevent the bundle&apos;s state from changing then the bundle could technically be stopped in between when the validity check occurs in BundleContextImpl and when we acquire the service registry lock in Felix.registerService(). This is appears to be a typical check-then-act scenario.&lt;/p&gt;</comment>
                            <comment id="13507153" author="gnt" created="Fri, 30 Nov 2012 07:12:44 +0000"  >&lt;p&gt;The web console Executor comes from &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3760&quot; title=&quot;Clean webconsole startup and disposal&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3760&quot;&gt;&lt;del&gt;FELIX-3760&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13507192" author="gnt" created="Fri, 30 Nov 2012 08:28:01 +0000"  >&lt;p&gt;I think the main problem is that bundles are supposed to be able to register services while stopping, but this rule isn&apos;t really possible with felix now, because a bundle being stopped can&apos;t really register services from another thread because of the bundle lock being grabbed while calling the activator.&lt;/p&gt;

&lt;p&gt;I agree that with the proposed patch the bundle could be stopped while registering a service, so between the check and the actual registration.&lt;br/&gt;
I think a better way would be to check the validity of the bundle context from inside the service registry.&lt;br/&gt;
I&apos;ll work on an improved patch.&lt;/p&gt;</comment>
                            <comment id="13507193" author="rickhall" created="Fri, 30 Nov 2012 08:34:47 +0000"  >&lt;p&gt;Checking the validity inside the service registry is complicated by the fact that it still needs to hold the bundle lock to do so for the entire until it is done registering the service, which is why the call to it was wrapped with a bundle lock in the first place. Wrapping the code inside service registry method is no different than wrapping it on the outside. Further, the code inside doesn&apos;t have access to these locking mechanisms and would require breaking abstractions to do so.&lt;/p&gt;</comment>
                            <comment id="13507203" author="gnt" created="Fri, 30 Nov 2012 08:50:48 +0000"  >&lt;p&gt;I disagree.  It&apos;s not about grabbing the bundle lock inside the registry, it&apos;s just about checking that the bundle context is still valid.&lt;br/&gt;
Something like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/framework/src/main/java/org/apache/felix/framework/ServiceRegistry.java b/framework/src/main/java/org/apache/felix/framework/ServiceRegistry.java
index 4a6aa8e..357d557 100644
--- a/framework/src/main/java/org/apache/felix/framework/ServiceRegistry.java
+++ b/framework/src/main/java/org/apache/felix/framework/ServiceRegistry.java
@@ -118,6 +118,10 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ServiceRegistry
 
         &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;)
         {
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (bundle.getBundleContext() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Invalid BundleContext.&quot;&lt;/span&gt;);
+            }
+
             &lt;span class=&quot;code-comment&quot;&gt;// Create the service registration.
&lt;/span&gt;             reg = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ServiceRegistrationImpl(
                 &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, bundle, classNames, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;(m_currentServiceId++), svcObj, dict);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It should solve all problems.  While the activator is running, the bundle will still be able to register services from a different thread.  Once the activator has run, felix will invalidate the bundle context, then unregister all services.  So even is a service is registered while the activator is running (or even after it has run but before the context is invalidated), that service will be correctly unregistered.&lt;br/&gt;
If the service is being registered after the bundle context has been invalidated, it will be rejected as expected.&lt;/p&gt;

&lt;p&gt;It may happen there is still a gap between the service registration thread being run and the check of the bundle context validity, which means the bundle could be restarted and the service registered.  I agree that&apos;s bad and the service registry should be given the calling bundle context instead of the bundle itself, which would make get rid of that problem by making sure the context is still valid.&lt;/p&gt;


&lt;p&gt;So I think this could be solved the following way:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/framework/src/main/java/org/apache/felix/framework/BundleContextImpl.java b/framework/src/main/java/org/apache/felix/framework/BundleContextImpl.java
index d7bbfa0..e7a3f4e 100644
--- a/framework/src/main/java/org/apache/felix/framework/BundleContextImpl.java
+++ b/framework/src/main/java/org/apache/felix/framework/BundleContextImpl.java
@@ -343,7 +343,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;BundleContextImpl &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; FelixBundleContext
             }
         }
 
-        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; m_felix.registerService(m_bundle, clazzes, svcObj, dict);
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; m_felix.registerService(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, clazzes, svcObj, dict);
     }
 
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &amp;lt;S&amp;gt; ServiceRegistration&amp;lt;S&amp;gt; registerService(
@@ -498,7 +498,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;BundleContextImpl &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; FelixBundleContext
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; m_felix.getDataFile(m_bundle, s);
     }
 
-    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void checkValidity()
+    void checkValidity()
     {
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (m_valid)
         {
diff --git a/framework/src/main/java/org/apache/felix/framework/Felix.java b/framework/src/main/java/org/apache/felix/framework/Felix.java
index 08b6d90..2ad8a70 100644
--- a/framework/src/main/java/org/apache/felix/framework/Felix.java
+++ b/framework/src/main/java/org/apache/felix/framework/Felix.java
@@ -3435,7 +3435,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Felix &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; BundleImpl &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Framework
      * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; A &amp;lt;code&amp;gt;ServiceRegistration&amp;lt;/code&amp;gt; object or &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;.
     **/
     ServiceRegistration registerService(
-        BundleImpl bundle, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] classNames, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; svcObj, Dictionary dict)
+        BundleContextImpl context, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] classNames, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; svcObj, Dictionary dict)
     {
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (classNames == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
         {
@@ -3470,7 +3470,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Felix &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; BundleImpl &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Framework
             }
         }
 
-        reg = m_registry.registerService(bundle, classNames, svcObj, dict);
+        reg = m_registry.registerService(context, classNames, svcObj, dict);
 
         &lt;span class=&quot;code-comment&quot;&gt;// Check to see &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; a listener hook; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; so, then we need
&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// to invoke the callback with all existing service listeners.
&lt;/span&gt;diff --git a/framework/src/main/java/org/apache/felix/framework/ServiceRegistry.java b/framework/src/main/java/org/apache/felix/framework/ServiceRegistry.java
index 4a6aa8e..77b17b8 100644
--- a/framework/src/main/java/org/apache/felix/framework/ServiceRegistry.java
+++ b/framework/src/main/java/org/apache/felix/framework/ServiceRegistry.java
@@ -112,12 +112,14 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ServiceRegistry
 
     &lt;span class=&quot;code-comment&quot;&gt;// Caller is expected to fire REGISTERED event.
&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; ServiceRegistration registerService(
-        Bundle bundle, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] classNames, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; svcObj, Dictionary dict)
+        BundleContextImpl context, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] classNames, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; svcObj, Dictionary dict)
     {
         ServiceRegistrationImpl reg = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
 
         &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;)
         {
+            Bundle bundle = context.getBundle();
+
             &lt;span class=&quot;code-comment&quot;&gt;// Create the service registration.
&lt;/span&gt;             reg = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ServiceRegistrationImpl(
                 &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, bundle, classNames, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;(m_currentServiceId++), svcObj, dict);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thoughts ?&lt;/p&gt;</comment>
                            <comment id="13526702" author="rickhall" created="Fri, 7 Dec 2012 19:42:11 +0000"  >&lt;p&gt;Yes, I had thought about switching to bundle context in the past too. I think that approach might work.&lt;/p&gt;</comment>
                            <comment id="13532422" author="gnt" created="Fri, 14 Dec 2012 16:24:13 +0000"  >&lt;p&gt;Fixed in  &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1421958&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1421958&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>258157</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 49 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0kncv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>118601</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>