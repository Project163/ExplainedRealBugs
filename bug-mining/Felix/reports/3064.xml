<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:13:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-6036] Race condition prevents optional/greedy ref setter method from being called</title>
                <link>https://issues.apache.org/jira/browse/FELIX-6036</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;I have a component with an optional/dynamic/greedy reference. The target is registered directly with OSGi using BundleContext.registerService(). Normally, either SingleDynamicCustomizer.addedService() or SingleComponentManager.createImplementationObject() will succeed in binding the reference, but there is a race condition that can prevent the setter method from ever being called.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The failure path is as follows:&lt;/p&gt;

&lt;p&gt;1) SingleComponentManager.createImplementationObject calls open() on each of its DependencyManagers. This generates an OpenStatus where the RefPair list is empty because our target has not been registered yet.&#160;&lt;/p&gt;

&lt;p&gt;2) Before createImplementationObject() can set the component context, the customizer&apos;s addedService() method is called in response to the target service registration. It attempts to bind the target service, but that will not happen&#160;because the component context has not been set yet.&#160;&lt;/p&gt;

&lt;p&gt;3) createImplementationObject then creates the implementation, sets the component context, and goes through the list of OpenStatus objects to bind target services. The RefPair list for the OpenStatus object will still be empty, so we will not&#160;call the setter method for the reference we&apos;re concerned about.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;m not sure of a good way to fix this. I couldn&apos;t come up with a good approach using synchronization or earlier creation of the implementation object. At the moment I am working around this by refreshing the list of RefPairs in the OpenStatus object at the top of DependencyManager.bindDependency():&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Refresh ref list before binding
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(m_tracker.tracked()) {
   status.refs=m_customizer.getRefs(status.trackingCount);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13211336">FELIX-6036</key>
            <summary>Race condition prevents optional/greedy ref setter method from being called</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tjwatson">Tom Watson</assignee>
                                    <reporter username="bdaniel">Brent Daniel</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 Jan 2019 17:30:32 +0000</created>
                <updated>Fri, 1 Mar 2019 14:26:44 +0000</updated>
                            <resolved>Fri, 25 Jan 2019 14:40:35 +0000</resolved>
                                    <version>scr-2.1.14</version>
                                    <fixVersion>scr-2.1.16</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16751587" author="githubbot" created="Thu, 24 Jan 2019 21:07:53 +0000"  >&lt;p&gt;GitHub user tjwatson opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/felix/pull/170&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/felix/pull/170&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-6036&quot; title=&quot;Race condition prevents optional/greedy ref setter method from being called&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-6036&quot;&gt;&lt;del&gt;FELIX-6036&lt;/del&gt;&lt;/a&gt; - avoid stashing stale RefPair objects in OpenStatus&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tjwatson/felix&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tjwatson/felix&lt;/a&gt; fixSCR-6036&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/felix/pull/170.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/felix/pull/170.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #170&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 072aa9539a9ce1636304ee25e4b1fc598959a393&lt;br/&gt;
Author: Tom Watson &amp;lt;tjwatson@...&amp;gt;&lt;br/&gt;
Date:   2019-01-24T16:46:13Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-6036&quot; title=&quot;Race condition prevents optional/greedy ref setter method from being called&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-6036&quot;&gt;&lt;del&gt;FELIX-6036&lt;/del&gt;&lt;/a&gt; - avoid stashing stale RefPair objects in OpenStatus&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16752315" author="githubbot" created="Fri, 25 Jan 2019 14:38:47 +0000"  >&lt;p&gt;Github user tjwatson closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/felix/pull/170&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/felix/pull/170&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16752317" author="tjwatson" created="Fri, 25 Jan 2019 14:40:35 +0000"  >&lt;p&gt;Will be fixed in next release of SCR&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi08b4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>