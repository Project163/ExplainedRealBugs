<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:21:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-2813] NPE in UpdateThread when updating a configuration right after ConfigurationAdmin service starts</title>
                <link>https://issues.apache.org/jira/browse/FELIX-2813</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;When you:&lt;br/&gt;
1) register as a configuration listener&lt;br/&gt;
2) wait for the ConfigurationAdmin service to start&lt;br/&gt;
3) upon start, immediately create a new configuration and update its properties&lt;/p&gt;

&lt;p&gt;You (sometimes) get a NPE in the UpdateThread because there is a race condition in the codebase:&lt;br/&gt;
a) ConfigurationManager.java:1818 will invoke getServiceReference() which uses the service registration to get to the reference&lt;br/&gt;
b) ConfigurationManager.java:242 registers the service and assigns the registration to &apos;configurationAdminRegistration&apos;&lt;/p&gt;

&lt;p&gt;First of all, the call to registerService in line 242 will already trigger service listeners and trackers to invoke callbacks before this call returns, so &apos;configurationAdminRegistration&apos; will still be null. Furthermore, there is no synchronization, the member is not volatile, so we need to make sure this value is really written before any configuration events are created under a) (now the thread doing that is started way before the service is registered).&lt;/p&gt;

&lt;p&gt;I will commit a test that shows the exception, but since it happens in a thread I cannot &quot;catch&quot; it won&apos;t show up as a failed test.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12497247">FELIX-2813</key>
            <summary>NPE in UpdateThread when updating a configuration right after ConfigurationAdmin service starts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fmeschbe">Felix Meschberger</assignee>
                                    <reporter username="marrs">Marcel Offermans</reporter>
                        <labels>
                    </labels>
                <created>Mon, 31 Jan 2011 19:54:46 +0000</created>
                <updated>Wed, 25 Sep 2013 14:02:34 +0000</updated>
                            <resolved>Tue, 1 Feb 2011 12:43:17 +0000</resolved>
                                                    <fixVersion>configadmin-1.4.0</fixVersion>
                                    <component>Configuration Admin</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12989094" author="fmeschbe" created="Tue, 1 Feb 2011 08:32:22 +0000"  >&lt;p&gt;Thanks for reporting the bug.&lt;/p&gt;

&lt;p&gt;First of all declaring the configurationAdminRegistration volatile should help your concerns with the getServiceReference() method; particularly with respect to logging. On the other hand for the getServiceReference() method itself, this is irrelelvant.&lt;/p&gt;

&lt;p&gt;Second the other issue is in fact not properly handled but easily fixed: Instead of immediately starting the worker threads for the UpdateQueue instances, we delay the start until after the ConfigurationAdmin service has been fully registered. This allows for events to be queued during the service registration process (by ServiceListeners) and to actually process them after completion of the registration.&lt;/p&gt;

&lt;p&gt;This problem has a symmetry in the ConfigurationManager.stop(BundleContext) method: Here the queues should be stopped before unregistering the ConfigurationAdmin service to not get an NPE if a ServiceListener is updating/deleting configuration in the serviceStopped method.&lt;/p&gt;</comment>
                            <comment id="12989101" author="marrs" created="Tue, 1 Feb 2011 08:49:11 +0000"  >&lt;p&gt;Take care that the service reference is fetched when an event is created, so even if you delay processing the queue it might be that there&apos;s invalid events in there.&lt;/p&gt;</comment>
                            <comment id="12989180" author="fmeschbe" created="Tue, 1 Feb 2011 12:39:57 +0000"  >&lt;p&gt;Yes, the ConfigurationEvent is actually generated immediately before sending it out. So just enqueuing the task to send the event is save.&lt;/p&gt;</comment>
                            <comment id="12989183" author="fmeschbe" created="Tue, 1 Feb 2011 12:43:17 +0000"  >&lt;p&gt;Committed a fix in Rev. 1066033.&lt;/p&gt;

&lt;p&gt;Besides making the service registration field volatile (as proposed) the background threads are started after registering the service (though jobs may be enqueued during the service registration) and are stopped before the service is unregistered.&lt;/p&gt;</comment>
                            <comment id="13284808" author="glyn.normington" created="Tue, 29 May 2012 13:30:49 +0000"  >&lt;p&gt;I&apos;m interesting in when this fix will be available for download. Is there a date for configadmin-1.4.0?&lt;/p&gt;</comment>
                            <comment id="13285475" author="fmeschbe" created="Wed, 30 May 2012 07:50:37 +0000"  >&lt;p&gt;I am now preparing the release with the released compendium 4.3 libraries&lt;/p&gt;</comment>
                            <comment id="13777505" author="fmeschbe" created="Wed, 25 Sep 2013 14:02:34 +0000"  >&lt;p&gt;Close issues after release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12546124">FELIX-3390</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40426</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 9 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0aqgn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>60560</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>