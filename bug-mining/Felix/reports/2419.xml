<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:57:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-4913] DM Optional callbacks may sometimes be invoked twice</title>
                <link>https://issues.apache.org/jira/browse/FELIX-4913</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;The following use case is not currently supported by the DM state machine, which suffers from a bug where sometimes, when the use case happens, the same optional callback may be invoked twice.&lt;/p&gt;

&lt;p&gt;The following case is supported by DS, so DM should support it, regardless of the fact that the design of this use case is arguable/questionable:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;there is a component B&lt;/li&gt;
	&lt;li&gt;there is a component BFactory (registered in the OSGI registry). And BFactory.createB() creates a B instance and simply registers it in the OSGi registry.&lt;/li&gt;
	&lt;li&gt;there is a A component that has two OPTIONAL dependencies:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  A.bind(BFactory)
  A.bind(B b)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Then A is created and is starting. Since BFactory is available, the DM state machine for A transits from the INSTANTIATED_AND_WAITING_FOR_REQUIRED into the  TRACKING_OPTIONAL state:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (oldState == ComponentState.INSTANTIATED_AND_WAITING_FOR_REQUIRED &amp;amp;&amp;amp; newState == ComponentState.TRACKING_OPTIONAL) {
            invokeAutoConfigInstanceBoundDependencies();
            invokeAddRequiredInstanceBoundDependencies();
            invoke(m_callbackStart);
            invokeAddOptionalDependencies();
            registerService();
            notifyListeners(newState);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;then, when the invokeAddOptionalDependencies() is running, it is invoking A.bind(BFactory b). At this exact point, the A.bind(BFactory) method calls bf.createB():&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;A.bind(BFactory bf) {
    bf.createB();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;this has the following side effect: a B service is synchronously registered in the OSGI service registry. So ComponentImpl.handleAdded() is called, and since we are in the&lt;br/&gt;
TRACKING_OPTIONAL state (we are entering into this state), then the A.bindB(B b) callback is invoked.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;BUT ... we are still running in the invokeAddOptionalDependencies() method. So when that method is about to iterate on the available services of the B dependency, then it calls a&lt;br/&gt;
second time the &quot;A.bind(B)&quot; callback.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I have a patch for this use case, which I have extensively tested since two days.&lt;/p&gt;

&lt;p&gt;To preserve my soul, the patch is simple and conservative: I use the same technique that was done in the ConfigurationDependencyImpl class: I&apos;m using a cache of callbacks that ensures that the same callback won&apos;t be invoked more than one time. The advantage of this patch is that it does not make too much polutions in the state machine which is not altered too much.&lt;/p&gt;

&lt;p&gt;I will also commit a test case which demonstrates the issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12835297">FELIX-4913</key>
            <summary>DM Optional callbacks may sometimes be invoked twice</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pderop">Pierre De Rop</assignee>
                                    <reporter username="pderop">Pierre De Rop</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Jun 2015 06:32:24 +0000</created>
                <updated>Tue, 9 Jun 2015 21:39:27 +0000</updated>
                            <resolved>Thu, 4 Jun 2015 21:09:33 +0000</resolved>
                                    <version>org.apache.felix.dependencymanager-r3</version>
                                    <fixVersion>  org.apache.felix.dependencymanager-r5</fixVersion>
                                    <component>Dependency Manager</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="14572281" author="pderop" created="Thu, 4 Jun 2015 06:58:29 +0000"  >&lt;p&gt;Committed in revision 1683471 the org.apache.felix.dependencymanager.itest/src/org/apache/felix/dm/itest/api/FELIX4913_OptionalCallbackInvokedTwiceTest.java which reproduces the issue.&lt;/p&gt;</comment>
                            <comment id="14572508" author="pderop" created="Thu, 4 Jun 2015 10:26:17 +0000"  >&lt;p&gt;Commited the patch in 1683504.&lt;/p&gt;

&lt;p&gt;Now, a hashtable is used to keep track of all invoked callbacks. An IdentityHashMap is used to make sure that a &quot;change&quot; event will be different from an &quot;add&quot; event (in case both may refer to the same ServiceReference instance).&lt;/p&gt;

&lt;p&gt;When we invoke a component dependency callback in ComponentImpl, we are now using the invokeCallbackSafe which won&apos;t invoke the same callback twice. &lt;/p&gt;

&lt;p&gt;When handleEvent is called, the clearInvokeCallbackCache() method is called at the end of the method, but this method will only clear the cache of invoked callbacks if the handleChange is not currently running.&lt;/p&gt;

&lt;p&gt;Also added some comments and did some code cleanup.&lt;br/&gt;
Removed the handleChange() method call from the startDependencies() method (this is useless).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 24 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2fm7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>