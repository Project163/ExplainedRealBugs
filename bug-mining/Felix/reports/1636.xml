<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:42:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3645] SCR could not obtain lock in 5000 ms</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3645</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;I finally made an integration test and committed it in the trunk.&lt;br/&gt;
This test sounds to reproduce the problem described in &lt;a href=&quot;http://www.mail-archive.com/dev@felix.apache.org/msg26360.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/dev@felix.apache.org/msg26360.html&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;the test contains the following files:&lt;/p&gt;

&lt;p&gt;src/test/resources/integration_test_component_concurrency.xml&lt;br/&gt;
src/test/java/org/apache/felix/scr/integration/ComponentConcurrencyTest.java&lt;br/&gt;
src/test/java/org/apache/felix/scr/integration/components/concurrency/A.java&lt;br/&gt;
src/test/java/org/apache/felix/scr/integration/components/concurrency/B.java&lt;br/&gt;
src/test/java/org/apache/felix/scr/integration/components/concurrency/C.java&lt;br/&gt;
src/test/java/org/apache/felix/scr/integration/components/concurrency/AFactory.java&lt;br/&gt;
src/test/java/org/apache/felix/scr/integration/components/concurrency/CFactory.java&lt;/p&gt;

&lt;p&gt;I also slightly modified src/test/java/org/apache/felix/scr/integration/ComponentTestBase.java&lt;br/&gt;
in order to use the apache log service, and also to declare the new package from org/apache/felix/scr/integration/components/concurrency.&lt;/p&gt;

&lt;p&gt;The test does the following:&lt;/p&gt;

&lt;p&gt;A optionally depends on B (dynamic=true, cardinality=0..N)&lt;br/&gt;
B depends on C&lt;/p&gt;

&lt;p&gt;A is a factory component and is created by the AFactory class, in an infinite loop and in a dedicated thread.&lt;br/&gt;
C is also a factory component and is created/disposed for ever, by the CFactory class.&lt;/p&gt;

&lt;p&gt;the integration test uses the log service in order to track logged errors, and runs 30 seconds.&lt;br/&gt;
If after 30 seconds, some errors are detected, then the test fail.&lt;/p&gt;

&lt;p&gt;It seems that we have many exceptions when the test fail, which I did not reproduced so far. (see many IllegalMonitorState Exceptions).&lt;/p&gt;

&lt;p&gt;The initial exception discussed from the post in the @dev list is also reproduced.&lt;br/&gt;
For example, I attached to this post my target/failsafe-reports/TEST-org.apache.felix.scr.integration.ComponentConcurrencyTest.xml, when the problem takes place.&lt;/p&gt;

&lt;p&gt;Please take a look starting at line 951, as well as at the corresponding dumpstack at line 713, and also the &quot;Locking activity before IllegalMonitorStateException&quot; log, line 887.&lt;/p&gt;

&lt;p&gt;Hope this will help.&lt;br/&gt;
/pierre&lt;/p&gt;

</description>
                <environment>linux fc16, bipro, Java(TM) SE Runtime Environment (build 1.6.0_32-b05)&lt;br/&gt;
</environment>
        <key id="12605895">FELIX-3645</key>
            <summary>SCR could not obtain lock in 5000 ms</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="djencks">David Jencks</assignee>
                                    <reporter username="pderop">Pierre De Rop</reporter>
                        <labels>
                    </labels>
                <created>Sun, 2 Sep 2012 13:44:48 +0000</created>
                <updated>Wed, 28 Nov 2012 07:15:34 +0000</updated>
                            <resolved>Wed, 28 Nov 2012 05:51:50 +0000</resolved>
                                                    <fixVersion>scr-1.6.2</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13449194" author="djencks" created="Wed, 5 Sep 2012 22:19:17 +0000"  >&lt;p&gt;I made a lot of changes and think I have this problem solved.&lt;/p&gt;

&lt;p&gt;I think your integration test can produce some expected errors and warnings as services disappear between the time we think a component is satisfied and when we actually get the service from the service reference.  Felix logs an error in this case, and we do some logging too.  So I modified the test to ignore the &quot;expected&quot; errors due to this.&lt;/p&gt;

&lt;p&gt;I also moved the very useful logging code into the base itest so I could use it for all the other problems I was having &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The current state of the code is that we release all locks (including read locks) when registering the service and when collecting dependencies for a component instance.  Then we take a write lock to actually create the component instance using these collected dependencies.&lt;/p&gt;

&lt;p&gt;I&apos;m storing the collected dependencies in a map in AbstractComponentManager.  This now holds most of the state for the dependency managers.  I think we could move the rest of the state into this map and make the bind/unbind/updated methods even more permanent and share the dependency managers between ImmediateComponentManagers for different configurations for the same Component.&lt;/p&gt;</comment>
                            <comment id="13449209" author="fmeschbe" created="Wed, 5 Sep 2012 22:26:00 +0000"  >&lt;p&gt;Sorry, your refactoring broke functionality around service binding.&lt;/p&gt;

&lt;p&gt;This is manifest in a CT test failure: The test declares a DS 1.0 component. DS 1.0 only allows the Service instance or the ServiceReference as an argument to the bind method. The test component, though has a method taking the Service plus a Map (service props). The test expects the component to &lt;b&gt;not&lt;/b&gt; register because the bind method is not found.&lt;/p&gt;

&lt;p&gt;The implementation (in the BindMethod) also correctly analyzes the situation and logs, that an appropriate bind method cannot be found. But later the DependencyManager.bind(Map) method just does a BindMethod.invoke and ignores the result. Thus the DependencyManager does not pass back the situation of not being able to call a missing bind method and thus the component is activated, where it shouldn&apos;t.&lt;/p&gt;

&lt;p&gt;I would assume the DependencyManager.bind(Map) method must record whether the bind method can be called or not as it was before:&lt;/p&gt;

&lt;p&gt;                    // success is if we have the minimal required number of services bound&lt;br/&gt;
                    if ( invokeBindMethod( refs&lt;span class=&quot;error&quot;&gt;&amp;#91;index&amp;#93;&lt;/span&gt; ) )&lt;/p&gt;
                    {
                        // of course, we have success if the service is bound
                        success = true;
                    }</comment>
                            <comment id="13449234" author="djencks" created="Wed, 5 Sep 2012 23:04:27 +0000"  >&lt;p&gt;The functionality you describe seems reasonable but I can&apos;t find support for it in the DS 1.0 or 1.2 specs.  All I see is &lt;/p&gt;

&lt;p&gt;ds 1.0 112.3.1 If the method is not found or the found method is not declared protected or public, SCR must log an error message with the Log Service, if present, and ignore the method.&lt;/p&gt;

&lt;p&gt;ds 1.2 112.3.2  If no suitable method is located, SCR must log an error message with the Log Service, if present, and there will be no bind, updated, or unbind notification.&lt;/p&gt;

&lt;p&gt;Assuming that the cts is correct I would think we could detect this situation in initBindMethods and put the component into a state where we wouldn&apos;t try to do anything with it?&lt;/p&gt;</comment>
                            <comment id="13449253" author="djencks" created="Wed, 5 Sep 2012 23:20:42 +0000"  >&lt;p&gt;I think I restored the previous behavior.... we may want to save arguing with the CTS till later &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13449255" author="fmeschbe" created="Wed, 5 Sep 2012 23:26:22 +0000"  >&lt;p&gt;Cool. Thanks. So I will rerun.&lt;/p&gt;

&lt;p&gt;Anyway, I already started arguing &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13449270" author="fmeschbe" created="Wed, 5 Sep 2012 23:44:21 +0000"  >&lt;p&gt;Just got the CT to pass.&lt;/p&gt;</comment>
                            <comment id="13505237" author="djencks" created="Wed, 28 Nov 2012 05:51:50 +0000"  >&lt;p&gt;this was actually fixed in 1.6.2&lt;/p&gt;</comment>
                            <comment id="13505266" author="fmeschbe" created="Wed, 28 Nov 2012 07:15:34 +0000"  >&lt;p&gt;Thanks for the update. So I close this (as the release is out already) and have updated the changelog in Rev. 1414557&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12543477" name="TEST-org.apache.felix.scr.integration.ComponentConcurrencyTest.xml" size="166366" author="pderop" created="Sun, 2 Sep 2012 13:45:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>246056</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i07h27:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>41530</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>