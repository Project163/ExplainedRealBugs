<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:03:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5285] iPojo does not delegate to the right classloader for Nullable Proxy instantiation</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5285</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;iPojo runtime &amp;amp; api: 1.12.1 &lt;br/&gt;
Felix framework: 4.2.1&lt;br/&gt;
This issue is similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-2093&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FELIX-2093&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This interface exist in v1.0 of an api and is exported by the system bundle (felix) A&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; com.data.service

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; DataService
{
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void search(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; condition);
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A bundle, B, imports com.data.service;version=1.0:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Requires(optional = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; DataServiceImpl dataServiceImpl;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;where DataServiceImpl only implements the interface&lt;br/&gt;
All is working well at this point.&lt;/p&gt;

&lt;p&gt;Then, the api evolves with a new method:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; com.data.service

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.data.service.conditions.Condition;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; DataService
{
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void search(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; condition);

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void search(Condition condition);
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;still exported by system bundle A but now as version 1.1&lt;br/&gt;
The bundle B is not recompiled against this new version and does not import the new package com.data.service.conditions&lt;/p&gt;

&lt;p&gt;Now, when bundle B runs with v1.1 of the api, the requires of DataServiceImpl is failing in Dependency.createNullableObject() (&lt;a href=&quot;http://felix.apache.org/ipojo/api/1.12.1/src-html/org/apache/felix/ipojo/handlers/dependency/Dependency.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://felix.apache.org/ipojo/api/1.12.1/src-html/org/apache/felix/ipojo/handlers/dependency/Dependency.html&lt;/a&gt; line 433) when creating the proxy: the proxy class is created w/o issue but when an instance of this proxy class is done, there is a Class.forName() done that fails to load the class Condition because it is not imported&lt;/p&gt;

&lt;p&gt;Since the class Condition is already available and allows to create the proxy class, it would make sense to use it instead of trying to load it thru the bundle classloader&lt;br/&gt;
To achieve this, the methods of the specification could be browsed, for each parameters and return types the classloader could be collected and given to the NullableClassLoader. All classloaders could be asked to load the class. At some point, the classloader of Condition would be queried and would return the class&lt;/p&gt;

&lt;p&gt;I don&apos;t know if this is breaking OSGi principles but I think it can fix this issue&lt;/p&gt;

&lt;p&gt;NB: I also tried to export the new api with uses directive:&lt;br/&gt;
com.data.service;version=1.1;uses:=&quot;com.data.service.conditions&quot;&lt;br/&gt;
with no result. If I understand correctly uses directive is not supposed to add implicit package import to bundle B, but are only used by the OSGi framework to help it on the wiring process&lt;/p&gt;

&lt;p&gt;Here&apos;s the cause exception thrown in java.lang.IllegalStateException: Cannot create the Nullable object, a referenced class cannot be loaded:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.NoClassDefFoundError: *** &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;com.data.service.conditions.Condition&apos;&lt;/span&gt; was not found because bundle B [5] does not &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;com.data.service.conditions&apos;&lt;/span&gt; even though bundle org.apache.felix.framework [0] does export it. Additionally, the &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;is also available from the system &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;loader. There are two fixes: 1) Add an &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;com.data.service.conditions&apos;&lt;/span&gt; to bundle B [5]; imports are necessary &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; each &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;directly touched by bundle code or indirectly touched, such as &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt; classes &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; their methods are used. 2) Add &lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;com.data.service.conditions&apos;&lt;/span&gt; to the &lt;span class=&quot;code-quote&quot;&gt;&apos;org.osgi.framework.bootdelegation&apos;&lt;/span&gt; property; a library or VM bug can cause classes to be loaded by the wrong &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;loader. The first approach is preferable &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; preserving modularity. ***&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And the stack trace of the loadClass that fails:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;[iPOJO] pool-1-thread-1@4605&quot;&lt;/span&gt; daemon prio=5 tid=0x21 nid=NA runnable 
java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
	  at org.apache.felix.ipojo.handlers.dependency.Dependency$NullableClassLoader.loadClass(Dependency.java:1072)
	  at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName0(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:-1)
	  at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:264)
	  at com.sun.proxy.$Proxy154.&amp;lt;clinit&amp;gt;(Unknown Source:-1)
	  at sun.reflect.NativeConstructorAccessorImpl.newInstance0(NativeConstructorAccessorImpl.java:-1)
	  at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
	  at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
	  at java.lang.reflect.Constructor.newInstance(Constructor.java:422)
	  at java.lang.reflect.Proxy.newProxyInstance(Proxy.java:739)
	  at org.apache.felix.ipojo.handlers.dependency.Dependency.createNullableObject(Dependency.java:434)
	  at org.apache.felix.ipojo.handlers.dependency.Dependency.start(Dependency.java:457)
	  at org.apache.felix.ipojo.handlers.dependency.DependencyHandler.__M_start(DependencyHandler.java:496)
	  at org.apache.felix.ipojo.handlers.dependency.DependencyHandler.start(DependencyHandler.java:-1)
	  at org.apache.felix.ipojo.HandlerManager.start(HandlerManager.java:136)
	  at org.apache.felix.ipojo.InstanceManager.start(InstanceManager.java:421)
	  at org.apache.felix.ipojo.ComponentFactory.createInstance(ComponentFactory.java:179)
	  at org.apache.felix.ipojo.IPojoFactory.createComponentInstance(IPojoFactory.java:319)
	  - locked &amp;lt;0x2a3b&amp;gt; (a org.apache.felix.ipojo.ComponentFactory)
	  at org.apache.felix.ipojo.IPojoFactory.createComponentInstance(IPojoFactory.java:240)
	  at org.apache.felix.ipojo.extender.internal.linker.ManagedType$InstanceSupport$1.call(ManagedType.java:312)
	  at org.apache.felix.ipojo.extender.internal.linker.ManagedType$InstanceSupport$1.call(ManagedType.java:306)
	  at org.apache.felix.ipojo.extender.internal.queue.JobInfoCallable.call(JobInfoCallable.java:114)
	  at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12982663">FELIX-5285</key>
            <summary>iPojo does not delegate to the right classloader for Nullable Proxy instantiation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="clement.escoffier">Clement Escoffier</assignee>
                                    <reporter username="ejuste">Emmanuel Juste</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 Jun 2016 12:08:40 +0000</created>
                <updated>Wed, 31 Aug 2016 15:26:44 +0000</updated>
                            <resolved>Wed, 31 Aug 2016 15:26:44 +0000</resolved>
                                                                    <component>iPOJO</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15348258" author="clement.escoffier" created="Fri, 24 Jun 2016 13:30:35 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;If you could provide a test case that would be great. If in addition you can provide a patch that would be awesome.&lt;/p&gt;</comment>
                            <comment id="15348366" author="ejuste" created="Fri, 24 Jun 2016 14:43:43 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Ok I&apos;ll try to provide a test case and I&apos;ll provide a patch for the solution I proposed&lt;/p&gt;

&lt;p&gt;Emmanuel&lt;/p&gt;</comment>
                            <comment id="15350960" author="ejuste" created="Mon, 27 Jun 2016 13:11:25 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Here&apos;s attached the patch with the fix: I tested on my product and now the creation of the nullable object is successful!&lt;br/&gt;
I also made 2 unit tests to make sure the feature of nullable still works w/o any issue (it&apos;s a bit difficult,  in a unit test, to reproduce the context of the issue with multiple classloaders like in OSGi)&lt;/p&gt;

&lt;p&gt;Emmanuel&lt;/p&gt;</comment>
                            <comment id="15361018" author="ejuste" created="Mon, 4 Jul 2016 08:35:34 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=clement.escoffier&quot; class=&quot;user-hover&quot; rel=&quot;clement.escoffier&quot;&gt;clement.escoffier&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Any news? Could you have a look to the patch?&lt;/p&gt;

&lt;p&gt;Many thanks!&lt;br/&gt;
Emmanuel&lt;/p&gt;</comment>
                            <comment id="15361024" author="clement.escoffier" created="Mon, 4 Jul 2016 08:44:38 +0000"  >&lt;p&gt;Will have a look this week (just back from the US, I&apos;m out of phase &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;).&lt;/p&gt;</comment>
                            <comment id="15374752" author="ejuste" created="Wed, 13 Jul 2016 09:55:01 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I hope you&apos;re better now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Do you think you could have a look at the proposed patch?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;br/&gt;
Emmanuel&lt;/p&gt;</comment>
                            <comment id="15381883" author="clement.escoffier" created="Mon, 18 Jul 2016 08:25:48 +0000"  >&lt;p&gt;The patch looks good to me. I&apos;m wondering if the same trick need to be done in the composition support.&lt;/p&gt;</comment>
                            <comment id="15384084" author="ejuste" created="Tue, 19 Jul 2016 12:33:06 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Great &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Will you merge it on master?&lt;br/&gt;
Any idea when a release with this fix can be done?&lt;/p&gt;

&lt;p&gt;About composition, I can&apos;t tell, I never used this feature&lt;/p&gt;

&lt;p&gt;Emmanuel&lt;/p&gt;</comment>
                            <comment id="15430853" author="ejuste" created="Mon, 22 Aug 2016 14:23:34 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=clement.escoffier&quot; class=&quot;user-hover&quot; rel=&quot;clement.escoffier&quot;&gt;clement.escoffier&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Any news?&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Emmanuel&lt;/p&gt;</comment>
                            <comment id="15452420" author="clement.escoffier" created="Wed, 31 Aug 2016 14:43:29 +0000"  >&lt;p&gt;Working on it, should land in the trunk tonight.&lt;/p&gt;</comment>
                            <comment id="15452530" author="clement.escoffier" created="Wed, 31 Aug 2016 15:26:22 +0000"  >&lt;p&gt;Patched applied in trunk. I&apos;m deploying the snapshots.&lt;/p&gt;

&lt;p&gt;Thanks ! &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12813655" name="FELIX-5285.patch" size="10191" author="ejuste" created="Mon, 27 Jun 2016 13:11:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 12 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3013b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>