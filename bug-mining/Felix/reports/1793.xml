<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:47:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3839] iPOJO deadlocks on a bundle refresh</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3839</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;iPOJO grabs a number of locks during synchronous callbacks from the framework, some in InstanceCreator and some in IPojoFactory. This can cause a repeatable deadlock situation during service registration (which attempts to grab the global felix framework lock, fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3761&quot; title=&quot;When a bundle registers a service, the bundle lock is obtained without any real purpose&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3761&quot;&gt;&lt;del&gt;FELIX-3761&lt;/del&gt;&lt;/a&gt;) or during class resolution (still a problem). iPOJO should not be grabbing any locks during callbacks from the framework because those callbacks may be holding framework locks, and if another thread invokes the framework while holding the same lock, a deadlock will result. Below are stack traces two deadlock situations.&lt;/p&gt;

&lt;p&gt;Here&apos;s the stack trace that causes the deadlock in the first situation, which happens before &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3761&quot; title=&quot;When a bundle registers a service, the bundle lock is obtained without any real purpose&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3761&quot;&gt;&lt;del&gt;FELIX-3761&lt;/del&gt;&lt;/a&gt;, but really shouldn&apos;t happen with or without that fix:&lt;/p&gt;

&lt;p&gt;Daemon Thread &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-1&amp;#93;&lt;/span&gt; (Suspended)	&lt;br/&gt;
	Object.wait(long) line: not available &lt;span class=&quot;error&quot;&gt;&amp;#91;native method&amp;#93;&lt;/span&gt;	&lt;br/&gt;
	Object[](Object).wait() line: 485	&lt;br/&gt;
	Felix.acquireBundleLock(BundleImpl, int) line: 4871	&lt;br/&gt;
	Felix.registerService(BundleImpl, String[], Object, Dictionary) line: 3205	&lt;br/&gt;
	BundleContextImpl.registerService(String[], Object, Dictionary) line: 346	&lt;br/&gt;
	IPojoContext.registerService(String[], Object, Dictionary) line: 385	&lt;br/&gt;
	ProvidedService.registerService() line: 362	&lt;br/&gt;
	ProvidedServiceHandler.__M_stateChanged(int) line: 509	&lt;br/&gt;
	ProvidedServiceHandler.stateChanged(int) line: not available	&lt;br/&gt;
	InstanceManager.setState(int) line: 536	&lt;br/&gt;
	InstanceManager.start() line: 418	&lt;br/&gt;
	ComponentFactory.createInstance(Dictionary, IPojoContext, HandlerManager[]) line: 179	&lt;br/&gt;
	ComponentFactory(IPojoFactory).createComponentInstance(Dictionary, ServiceContext) line: 310	&lt;br/&gt;
	ComponentFactory(IPojoFactory).createComponentInstance(Dictionary) line: 239	&lt;br/&gt;
	InstanceCreator$ManagedInstance.create(IPojoFactory) line: 355	&lt;br/&gt;
	InstanceCreator.addInstance(Dictionary, long) line: 89	&lt;br/&gt;
	Extender.parse(Bundle, String) line: 306	&lt;br/&gt;
	Extender.startManagementFor(Bundle) line: 237	&lt;br/&gt;
	Extender.access$600(Extender, Bundle) line: 52	&lt;br/&gt;
	Extender$CreatorThread.run() line: 769	&lt;br/&gt;
	Thread.run() line: 662	&lt;/p&gt;

&lt;p&gt;Daemon Thread &lt;span class=&quot;error&quot;&gt;&amp;#91;FelixFrameworkWiring&amp;#93;&lt;/span&gt; (Suspended)	&lt;br/&gt;
	InstanceCreator.removeInstancesFromBundle(long) line: 116	&lt;br/&gt;
	Extender.closeManagementFor(Bundle) line: 171	&lt;br/&gt;
	Extender.bundleChanged(BundleEvent) line: 153	&lt;br/&gt;
	EventDispatcher.invokeBundleListenerCallback(Bundle, EventListener, EventObject) line: 868	&lt;br/&gt;
	EventDispatcher.fireEventImmediately(EventDispatcher, int, Map, EventObject, Dictionary) line: 789	&lt;br/&gt;
	EventDispatcher.fireBundleEvent(BundleEvent, Framework) line: 514	&lt;br/&gt;
	Felix.fireBundleEvent(int, Bundle) line: 4244	&lt;br/&gt;
	Felix.stopBundle(BundleImpl, boolean) line: 2351	&lt;br/&gt;
	Felix$RefreshHelper.stop() line: 4629	&lt;br/&gt;
	Felix.refreshPackages(Collection, FrameworkListener[]) line: 3951	&lt;br/&gt;
	FrameworkWiringImpl.run() line: 172	&lt;br/&gt;
	Thread.run() line: 662&lt;/p&gt;

&lt;p&gt;Here&apos;s the stack trace for the other situation caused by class resolution in the framework:&lt;/p&gt;

&lt;p&gt;Name: Thread-2&lt;br/&gt;
State: WAITING on [Ljava.lang.Object;@4a018e1b&lt;br/&gt;
Total blocked: 38,871,649  Total waited: 38,871,650&lt;/p&gt;

&lt;p&gt;Stack trace: &lt;br/&gt;
 java.lang.Object.wait(Native Method)&lt;br/&gt;
java.lang.Object.wait(Object.java:485)&lt;br/&gt;
org.apache.felix.framework.Felix.acquireGlobalLock(Felix.java:5033)&lt;br/&gt;
org.apache.felix.framework.StatefulResolver.resolve(StatefulResolver.java:451)&lt;br/&gt;
org.apache.felix.framework.BundleWiringImpl.searchDynamicImports(BundleWiringImpl.java:1578)&lt;br/&gt;
org.apache.felix.framework.BundleWiringImpl.findClassOrResourceByDelegation(BundleWiringImpl.java:1478)&lt;br/&gt;
org.apache.felix.framework.BundleWiringImpl.access$400(BundleWiringImpl.java:75)&lt;br/&gt;
org.apache.felix.framework.BundleWiringImpl$BundleClassLoader.loadClass(BundleWiringImpl.java:1882)&lt;br/&gt;
java.lang.ClassLoader.loadClass(ClassLoader.java:247)&lt;br/&gt;
org.apache.felix.framework.BundleWiringImpl.getClassByDelegation(BundleWiringImpl.java:1356)&lt;br/&gt;
org.apache.felix.framework.ServiceRegistrationImpl$ServiceReferenceImpl.isAssignableTo(ServiceRegistrationImpl.java:548)&lt;br/&gt;
org.apache.felix.framework.util.Util.isServiceAssignable(Util.java:280)&lt;br/&gt;
org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:916)&lt;br/&gt;
org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4346)&lt;br/&gt;
org.apache.felix.framework.Felix.registerService(Felix.java:3356)&lt;br/&gt;
org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
org.apache.felix.ipojo.IPojoFactory.start(IPojoFactory.java:613)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked org.apache.felix.ipojo.ComponentFactory@468034b6&lt;br/&gt;
org.apache.felix.ipojo.Extender.createAbstractFactory(Extender.java:520)&lt;br/&gt;
org.apache.felix.ipojo.Extender.parse(Extender.java:301)&lt;br/&gt;
org.apache.felix.ipojo.Extender.startManagementFor(Extender.java:237)&lt;br/&gt;
org.apache.felix.ipojo.Extender.access$600(Extender.java:52)&lt;br/&gt;
org.apache.felix.ipojo.Extender$CreatorThread.run(Extender.java:769)&lt;br/&gt;
java.lang.Thread.run(Thread.java:662)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Name: FelixFrameworkWiring&lt;br/&gt;
State: BLOCKED on org.apache.felix.ipojo.ComponentFactory@468034b6 owned by: Thread-2&lt;br/&gt;
Total blocked: 7  Total waited: 1&lt;/p&gt;

&lt;p&gt;Stack trace: &lt;br/&gt;
org.apache.felix.ipojo.IPojoFactory.removeFactoryStateListener(IPojoFactory.java:511)&lt;br/&gt;
org.apache.felix.ipojo.InstanceCreator.removeFactory(InstanceCreator.java:199)&lt;br/&gt;
org.apache.felix.ipojo.Extender.closeManagementFor(Extender.java:180)&lt;br/&gt;
org.apache.felix.ipojo.Extender.bundleChanged(Extender.java:153)&lt;br/&gt;
org.apache.felix.framework.util.EventDispatcher.invokeBundleListenerCallback(EventDispatcher.java:868)&lt;br/&gt;
org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:789)&lt;br/&gt;
org.apache.felix.framework.util.EventDispatcher.fireBundleEvent(EventDispatcher.java:514)&lt;br/&gt;
org.apache.felix.framework.Felix.fireBundleEvent(Felix.java:4330)&lt;br/&gt;
org.apache.felix.framework.Felix.stopBundle(Felix.java:2451)&lt;br/&gt;
org.apache.felix.framework.Felix$RefreshHelper.stop(Felix.java:4715)&lt;br/&gt;
org.apache.felix.framework.Felix.refreshPackages(Felix.java:4037)&lt;br/&gt;
org.apache.felix.framework.FrameworkWiringImpl.run(FrameworkWiringImpl.java:178)&lt;br/&gt;
java.lang.Thread.run(Thread.java:662)&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12626345">FELIX-3839</key>
            <summary>iPOJO deadlocks on a bundle refresh</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="clement.escoffier">Clement Escoffier</assignee>
                                    <reporter username="jnaous">Jad Naous</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Jan 2013 13:08:41 +0000</created>
                <updated>Mon, 4 Feb 2013 12:34:34 +0000</updated>
                            <resolved>Mon, 7 Jan 2013 15:45:31 +0000</resolved>
                                    <version>ipojo-core-1.8.4</version>
                    <version>ipojo-runtime-1.8.6</version>
                                    <fixVersion>ipojo-runtime-1.8.6</fixVersion>
                                    <component>iPOJO</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13545970" author="clement.escoffier" created="Mon, 7 Jan 2013 15:45:31 +0000"  >&lt;p&gt;I did a first attempt to fix it. Could you check against the trunk ? &lt;/p&gt;</comment>
                            <comment id="13545998" author="jnaous" created="Mon, 7 Jan 2013 16:14:23 +0000"  >&lt;p&gt;Thanks for the quick turnaround. iPOJO doesn&apos;t deadlock anymore (btw, I&apos;m testing against felix framework 4.1.0-SNAPSHOT), but it&apos;s creating two instances of each service, and I get a NPE in the logs:&lt;/p&gt;

&lt;p&gt;ERROR: Bundle org.apache.felix.bundlerepository &lt;span class=&quot;error&quot;&gt;&amp;#91;29&amp;#93;&lt;/span&gt; EventDispatcher: Error during dispatch. (java.lang.NullPointerException)&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at org.apache.felix.bundlerepository.impl.LocalRepositoryImpl.serviceChanged(LocalRepositoryImpl.java:71)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
        at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4346)&lt;br/&gt;
        at org.apache.felix.framework.Felix.registerService(Felix.java:3356)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
        at org.apache.felix.ipojo.IPojoFactory.start(IPojoFactory.java:615)&lt;br/&gt;
        at org.apache.felix.ipojo.Extender.createAbstractFactory(Extender.java:520)&lt;br/&gt;
        at org.apache.felix.ipojo.Extender.parse(Extender.java:301)&lt;br/&gt;
        at org.apache.felix.ipojo.Extender.startManagementFor(Extender.java:237)&lt;br/&gt;
        at org.apache.felix.ipojo.Extender.access$600(Extender.java:52)&lt;br/&gt;
        at org.apache.felix.ipojo.Extender$CreatorThread.run(Extender.java:772)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;</comment>
                            <comment id="13545999" author="jnaous" created="Mon, 7 Jan 2013 16:15:31 +0000"  >&lt;p&gt;Should I reopen this issue or create a new one?&lt;/p&gt;</comment>
                            <comment id="13546851" author="jnaous" created="Tue, 8 Jan 2013 13:03:33 +0000"  >&lt;p&gt;Looking at the changes you made, there is still the possibility of deadlock. Locks really should be completely removed from the synchronous callback paths... Finer grained locks are only make it less probable the deadlock will arise, but this will also make it harder to debug deadlocks when they arise because they will be more difficult to reproduce.&lt;/p&gt;</comment>
                            <comment id="13546910" author="jnaous" created="Tue, 8 Jan 2013 14:08:08 +0000"  >&lt;p&gt;Also, I fixed the NPE raised. It was a bug in the bundlerrepository implementation (or so it seems). Opening another bug report for that. That also resolves the multiple instances of components.&lt;/p&gt;</comment>
                            <comment id="13547200" author="jnaous" created="Tue, 8 Jan 2013 20:07:55 +0000"  >&lt;p&gt;And actually, it turns out that the duplicate instances problem is still there...&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>302935</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 46 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i176n3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>250044</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>