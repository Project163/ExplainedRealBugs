<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:32:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3153] [Framework] refreshPackages() should stop bundles in one pass and refresh them in a second pass</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3153</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;When using refreshPackages on a bundle that is used by a lot of other bundles, it results in error.&lt;br/&gt;
There is no deterministic behavior and the error is not always the same, even if I repeat the exact same test twice.&lt;/p&gt;

&lt;p&gt;A typical example on how I reproduce it is to refresh the spring-context bundle inside servicemix 4.4 (running on felix).&lt;br/&gt;
If I switch to equinox I don&apos;t have that issue. That doesn&apos;t say much, but I mention it to exclude other possibilities. &lt;/p&gt;

&lt;p&gt;From my logs I see that Felix tries to refresh the bundles in the populated graph with a different order each time (I don&apos;t know if this helps identifying the issue).&lt;/p&gt;

&lt;p&gt;Usually, the error looks like this:&lt;/p&gt;

&lt;p&gt;ERROR: Bundle org.springframework.osgi.extender &lt;span class=&quot;error&quot;&gt;&amp;#91;83&amp;#93;&lt;/span&gt; Error stopping bundle. (java.lang.NoClassDefFoundError: org/osgi/framework/ServiceRegistration)&lt;br/&gt;
java.lang.NoClassDefFoundError: org/osgi/framework/ServiceRegistration&lt;br/&gt;
	at org.springframework.osgi.util.OsgiServiceUtils.unregisterService(OsgiServiceUtils.java:41)&lt;br/&gt;
	at org.springframework.osgi.extender.internal.support.NamespaceManager.unregisterResolverService(NamespaceManager.java:195)&lt;br/&gt;
	at org.springframework.osgi.extender.internal.support.NamespaceManager.destroy(NamespaceManager.java:223)&lt;br/&gt;
	at org.springframework.osgi.extender.internal.activator.ContextLoaderListener.shutdown(ContextLoaderListener.java:547)&lt;br/&gt;
	at org.springframework.osgi.extender.internal.activator.ContextLoaderListener.stop(ContextLoaderListener.java:431)&lt;br/&gt;
	at org.apache.felix.framework.util.SecureAction.stopActivator(SecureAction.java:651)&lt;br/&gt;
	at org.apache.felix.framework.Felix.stopBundle(Felix.java:2216)&lt;br/&gt;
	at org.apache.felix.framework.Felix$RefreshHelper.stop(Felix.java:4489)&lt;br/&gt;
	at org.apache.felix.framework.Felix.refreshPackages(Felix.java:3581)&lt;br/&gt;
	at org.apache.felix.framework.PackageAdminImpl.run(PackageAdminImpl.java:363)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:680)&lt;br/&gt;
Caused by: java.lang.ClassNotFoundException: org.osgi.framework.ServiceRegistration not found by org.springframework.osgi.core &lt;span class=&quot;error&quot;&gt;&amp;#91;80&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.felix.framework.ModuleImpl.findClassOrResourceByDelegation(ModuleImpl.java:787)&lt;br/&gt;
	at org.apache.felix.framework.ModuleImpl.access$400(ModuleImpl.java:71)&lt;br/&gt;
	at org.apache.felix.framework.ModuleImpl$ModuleClassLoader.loadClass(ModuleImpl.java:1768)&lt;br/&gt;
	at java.lang.ClassLoader.loadClass(ClassLoader.java:247)&lt;br/&gt;
	... 11 more&lt;/p&gt;</description>
                <environment></environment>
        <key id="12526461">FELIX-3153</key>
            <summary>[Framework] refreshPackages() should stop bundles in one pass and refresh them in a second pass</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="iocanel">Ioannis Canellos</reporter>
                        <labels>
                    </labels>
                <created>Mon, 10 Oct 2011 15:47:06 +0000</created>
                <updated>Mon, 10 Oct 2011 20:13:48 +0000</updated>
                            <resolved>Mon, 10 Oct 2011 20:00:42 +0000</resolved>
                                    <version>framework-3.0.9</version>
                    <version>framework-3.2.2</version>
                                    <fixVersion>framework-4.0.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13124241" author="rickhall" created="Mon, 10 Oct 2011 16:07:46 +0000"  >&lt;p&gt;Try to recreate on the current framework release. Let me know what happens.&lt;/p&gt;</comment>
                            <comment id="13124309" author="iocanel" created="Mon, 10 Oct 2011 17:16:52 +0000"  >&lt;p&gt;I also managed to reproduce the same behavior using 3.2.2. &lt;br/&gt;
An other interesting exception I get from time to time (using the same scenario) is the following:&lt;/p&gt;

&lt;p&gt;ERROR: Bundle org.apache.servicemix.jbi.deployer &lt;span class=&quot;error&quot;&gt;&amp;#91;171&amp;#93;&lt;/span&gt; EventDispatcher: Error during dispatch. (java.lang.LinkageError: loader constraint violation: loader (instance of org/apache/felix/framework/ModuleImpl$ModuleClassLoaderJava5) previously initiated loading for a different type with name &quot;org/apache/servicemix/executors/Executor&quot;)&lt;br/&gt;
java.lang.LinkageError: loader constraint violation: loader (instance of org/apache/felix/framework/ModuleImpl$ModuleClassLoaderJava5) previously initiated loading for a different type with name &quot;org/apache/servicemix/executors/Executor&quot;&lt;br/&gt;
	at org.apache.servicemix.wsn.component.WSNComponent$WSNEndpointManager.unregister(WSNComponent.java:291)&lt;br/&gt;
	at org.apache.servicemix.wsn.AbstractEndpoint.unregister(AbstractEndpoint.java:52)&lt;br/&gt;
	at org.apache.servicemix.wsn.AbstractPublisher.destroy(AbstractPublisher.java:81)&lt;br/&gt;
	at org.apache.servicemix.wsn.jms.JmsPublisher.destroy(JmsPublisher.java:149)&lt;br/&gt;
	at org.apache.servicemix.wsn.AbstractNotificationBroker.destroy(AbstractNotificationBroker.java:104)&lt;br/&gt;
	at org.apache.servicemix.wsn.jms.JmsNotificationBroker.destroy(JmsNotificationBroker.java:58)&lt;br/&gt;
	at org.apache.servicemix.wsn.component.WSNComponent.doShutDown(WSNComponent.java:191)&lt;br/&gt;
	at org.apache.servicemix.common.AsyncBaseLifeCycle.shutDown(AsyncBaseLifeCycle.java:259)&lt;br/&gt;
	at org.apache.servicemix.jbi.deployer.artifacts.ComponentImpl$ComponentWrapper.shutDown(ComponentImpl.java:277)&lt;br/&gt;
	at org.apache.servicemix.jbi.deployer.artifacts.ComponentImpl.shutDown(ComponentImpl.java:182)&lt;br/&gt;
	at org.apache.servicemix.jbi.deployer.impl.Deployer.unregisterComponent(Deployer.java:452)&lt;br/&gt;
	at org.apache.servicemix.jbi.deployer.impl.Deployer.unregisterDeployedComponent(Deployer.java:676)&lt;br/&gt;
	at org.apache.servicemix.jbi.deployer.impl.Deployer$1.removedService(Deployer.java:223)&lt;br/&gt;
	at org.osgi.util.tracker.ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:922)&lt;br/&gt;
	at org.osgi.util.tracker.AbstractTracked.untrack(AbstractTracked.java:351)&lt;br/&gt;
	at org.osgi.util.tracker.ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:865)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:871)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:733)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:662)&lt;br/&gt;
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:3890)&lt;br/&gt;
	at org.apache.felix.framework.Felix.access$000(Felix.java:79)&lt;br/&gt;
	at org.apache.felix.framework.Felix$2.serviceChanged(Felix.java:728)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:135)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:129)&lt;br/&gt;
	at org.apache.aries.blueprint.container.ServiceRecipe.unregister(ServiceRecipe.java:201)&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintContainerImpl.notifySatisfaction(BlueprintContainerImpl.java:615)&lt;br/&gt;
	at org.apache.aries.blueprint.container.AbstractServiceReferenceRecipe.setSatisfied(AbstractServiceReferenceRecipe.java:305)&lt;br/&gt;
	at org.apache.aries.blueprint.container.AbstractServiceReferenceRecipe.serviceRemoved(AbstractServiceReferenceRecipe.java:281)&lt;br/&gt;
	at org.apache.aries.blueprint.container.AbstractServiceReferenceRecipe.serviceChanged(AbstractServiceReferenceRecipe.java:251)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:871)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:733)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:662)&lt;br/&gt;
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:3890)&lt;br/&gt;
	at org.apache.felix.framework.Felix.access$000(Felix.java:79)&lt;br/&gt;
	at org.apache.felix.framework.Felix$2.serviceChanged(Felix.java:728)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:135)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:129)&lt;br/&gt;
	at org.apache.aries.blueprint.container.ServiceRecipe.unregister(ServiceRecipe.java:201)&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintContainerImpl.unregisterServices(BlueprintContainerImpl.java:673)&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintContainerImpl.namespaceHandlerUnregistered(BlueprintContainerImpl.java:866)&lt;br/&gt;
	at org.apache.aries.blueprint.namespace.NamespaceHandlerRegistryImpl$NamespaceHandlerSetImpl.unregisterHandler(NamespaceHandlerRegistryImpl.java:365)&lt;br/&gt;
	at org.apache.aries.blueprint.namespace.NamespaceHandlerRegistryImpl.unregisterHandler(NamespaceHandlerRegistryImpl.java:149)&lt;br/&gt;
	at org.apache.aries.blueprint.namespace.NamespaceHandlerRegistryImpl.removedService(NamespaceHandlerRegistryImpl.java:119)&lt;br/&gt;
	at org.osgi.util.tracker.ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:922)&lt;br/&gt;
	at org.osgi.util.tracker.AbstractTracked.untrack(AbstractTracked.java:351)&lt;br/&gt;
	at org.osgi.util.tracker.ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:865)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:871)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:733)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:662)&lt;br/&gt;
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:3890)&lt;br/&gt;
	at org.apache.felix.framework.Felix.access$000(Felix.java:79)&lt;br/&gt;
	at org.apache.felix.framework.Felix$2.serviceChanged(Felix.java:728)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:135)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:129)&lt;br/&gt;
	at org.apache.aries.blueprint.container.ServiceRecipe.unregister(ServiceRecipe.java:201)&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintContainerImpl.unregisterServices(BlueprintContainerImpl.java:673)&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintContainerImpl.destroy(BlueprintContainerImpl.java:822)&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintExtender.destroyContext(BlueprintExtender.java:250)&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintExtender.bundleChanged(BlueprintExtender.java:242)&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintExtender$BlueprintBundleTrackerCustomizer.modifiedBundle(BlueprintExtender.java:431)&lt;br/&gt;
	at org.osgi.util.tracker.BundleTracker$Tracked.customizerModified(BundleTracker.java:453)&lt;br/&gt;
	at org.osgi.util.tracker.AbstractTracked.track(AbstractTracked.java:237)&lt;br/&gt;
	at org.osgi.util.tracker.BundleTracker$Tracked.bundleChanged(BundleTracker.java:413)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.invokeBundleListenerCallback(EventDispatcher.java:807)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:729)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireBundleEvent(EventDispatcher.java:610)&lt;br/&gt;
	at org.apache.felix.framework.Felix.fireBundleEvent(Felix.java:3879)&lt;br/&gt;
	at org.apache.felix.framework.Felix.stopBundle(Felix.java:2268)&lt;br/&gt;
	at org.apache.felix.framework.Felix$RefreshHelper.stop(Felix.java:4668)&lt;br/&gt;
	at org.apache.felix.framework.Felix.refreshPackages(Felix.java:3699)&lt;br/&gt;
	at org.apache.felix.framework.PackageAdminImpl.run(PackageAdminImpl.java:365)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:680)&lt;/p&gt;</comment>
                            <comment id="13124310" author="iocanel" created="Mon, 10 Oct 2011 17:18:04 +0000"  >&lt;p&gt;I haven&apos;t tried 4.0.0 (if this is what you meant by current release) since it still requires some more work to be used with karaf/servicemix. &lt;/p&gt;</comment>
                            <comment id="13124324" author="rickhall" created="Mon, 10 Oct 2011 17:31:01 +0000"  >&lt;p&gt;Yes, the &quot;current&quot; release is 4.0.0. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Can you just replace the old Felix framework JAR file with the new one in Karaf as a quick and dirty fix? I don&apos;t think it should look much different from a client&apos;s perspective.&lt;/p&gt;</comment>
                            <comment id="13124391" author="iocanel" created="Mon, 10 Oct 2011 18:51:36 +0000"  >&lt;p&gt;Richard,&lt;/p&gt;

&lt;p&gt;thanks for your lightning fast responses. I appreciate the help!&lt;br/&gt;
Unfortunately, the dirty fix doesn&apos;t work. I get plenty of errors. So I guess that I will have to spent some more time with it.&lt;/p&gt;</comment>
                            <comment id="13124431" author="rickhall" created="Mon, 10 Oct 2011 19:53:36 +0000"  >&lt;p&gt;Ok, I hacked up ServiceMix to run with framework 4.0.0...the difficult part is that they provide their own OSGi API classes instead of using the ones coming from the framework...this is probably not a smart thing since frameworks are free to make implementation-specific adaptations to the OSGi API implementations, so you cannot be sure that a given framework will work properly with the original OSGi JARs. At any rate...&lt;/p&gt;

&lt;p&gt;I was able to reproduce similar issues. In the end, I believe I understand at least some aspect of what is going wrong. When refreshing bundles, the Felix framework is stopping and refreshing bundles one at a time, when in fact it should be stopping them all first, then refreshing them all in a separate pass, and finally restarting them again in a third pass. So, I will commit a patch to do just that and change the subject of this bug to more accurately reflect the issue.&lt;/p&gt;

&lt;p&gt;Unfortunately, it doesn&apos;t appear to make the refresh of the spring context bundle work correctly, but at least the error is more consistent and controlled. I regularly see this:&lt;/p&gt;

&lt;p&gt;ERROR: Bundle org.apache.servicemix.jbi.osgi &lt;span class=&quot;error&quot;&gt;&amp;#91;123&amp;#93;&lt;/span&gt; EventDispatcher: Error during dispatch. (org.apache.servicemix.nmr.api.ServiceMixException: Unable to register service servicemix-wsn2005 with properties &lt;/p&gt;
{NAME=servicemix-wsn2005, objectClass=[Ljava.lang.String;@2cf9f1b5, service.id=725, TYPE=service-engine}. Reason: javax.jbi.JBIException: Error calling init)&lt;br/&gt;
org.apache.servicemix.nmr.api.ServiceMixException: Unable to register service servicemix-wsn2005 with properties {NAME=servicemix-wsn2005, objectClass=[Ljava.lang.String;@2cf9f1b5, service.id=725, TYPE=service-engine}
&lt;p&gt;. Reason: javax.jbi.JBIException: Error calling init&lt;br/&gt;
	at org.apache.servicemix.nmr.core.ServiceRegistryImpl.register(ServiceRegistryImpl.java:52)&lt;br/&gt;
	at org.apache.servicemix.nmr.osgi.OsgiServiceRegistryTracker.addingService(OsgiServiceRegistryTracker.java:78)&lt;br/&gt;
	at org.osgi.util.tracker.ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:980)&lt;br/&gt;
	at org.osgi.util.tracker.ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:906)&lt;br/&gt;
	at org.osgi.util.tracker.AbstractTracked.trackAdding(AbstractTracked.java:262)&lt;br/&gt;
	at org.osgi.util.tracker.AbstractTracked.track(AbstractTracked.java:234)&lt;br/&gt;
	at org.osgi.util.tracker.ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:941)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4250)&lt;br/&gt;
	at org.apache.felix.framework.Felix.registerService(Felix.java:3275)&lt;br/&gt;
	at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
	at org.apache.servicemix.jbi.deployer.impl.Deployer.registerService(Deployer.java:762)&lt;br/&gt;
	at org.apache.servicemix.jbi.deployer.impl.Deployer.registerComponent(Deployer.java:418)&lt;br/&gt;
	at org.apache.servicemix.jbi.deployer.impl.ComponentInstaller.initComponent(ComponentInstaller.java:424)&lt;br/&gt;
	at org.apache.servicemix.jbi.deployer.impl.ComponentInstaller.install(ComponentInstaller.java:150)&lt;br/&gt;
	at org.apache.servicemix.jbi.deployer.impl.Deployer.registerDeployedComponent(Deployer.java:657)&lt;br/&gt;
	at org.apache.servicemix.jbi.deployer.impl.Deployer$1.addingService(Deployer.java:222)&lt;br/&gt;
	at org.osgi.util.tracker.ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:980)&lt;br/&gt;
	at org.osgi.util.tracker.ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:906)&lt;br/&gt;
	at org.osgi.util.tracker.AbstractTracked.trackAdding(AbstractTracked.java:262)&lt;br/&gt;
	at org.osgi.util.tracker.AbstractTracked.track(AbstractTracked.java:234)&lt;br/&gt;
	at org.osgi.util.tracker.ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:941)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4250)&lt;br/&gt;
	at org.apache.felix.framework.Felix.registerService(Felix.java:3275)&lt;br/&gt;
	at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintContainerImpl.registerService(BlueprintContainerImpl.java:388)&lt;br/&gt;
	at org.apache.aries.blueprint.container.ServiceRecipe.register(ServiceRecipe.java:166)&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintContainerImpl.registerServices(BlueprintContainerImpl.java:646)&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintContainerImpl.doRun(BlueprintContainerImpl.java:314)&lt;br/&gt;
	at org.apache.aries.blueprint.container.BlueprintContainerImpl.run(BlueprintContainerImpl.java:213)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:98)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:206)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:680)&lt;br/&gt;
Caused by: javax.jbi.JBIException: Error calling init&lt;br/&gt;
	at org.apache.servicemix.common.AsyncBaseLifeCycle.init(AsyncBaseLifeCycle.java:213)&lt;br/&gt;
	at org.apache.servicemix.jbi.deployer.artifacts.ComponentImpl$ComponentWrapper.init(ComponentImpl.java:247)&lt;br/&gt;
	at org.apache.servicemix.jbi.runtime.impl.ComponentRegistryImpl.doRegister(ComponentRegistryImpl.java:89)&lt;br/&gt;
	at org.apache.servicemix.jbi.runtime.impl.ComponentRegistryImpl.doRegister(ComponentRegistryImpl.java:38)&lt;br/&gt;
	at org.apache.servicemix.nmr.core.ServiceRegistryImpl.register(ServiceRegistryImpl.java:47)&lt;br/&gt;
	... 42 more&lt;br/&gt;
Caused by: javax.jms.JMSException: Could not connect to broker URL: tcp://localhost:61616. Reason: java.net.ConnectException: Connection refused&lt;br/&gt;
	at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:35)&lt;br/&gt;
	at org.apache.activemq.ActiveMQConnectionFactory.createActiveMQConnection(ActiveMQConnectionFactory.java:286)&lt;br/&gt;
	at org.apache.activemq.ActiveMQConnectionFactory.createActiveMQConnection(ActiveMQConnectionFactory.java:230)&lt;br/&gt;
	at org.apache.activemq.ActiveMQConnectionFactory.createConnection(ActiveMQConnectionFactory.java:178)&lt;br/&gt;
	at org.apache.activemq.pool.PooledConnectionFactory.createConnection(PooledConnectionFactory.java:137)&lt;br/&gt;
	at org.apache.activemq.pool.PooledConnectionFactory.createConnection(PooledConnectionFactory.java:121)&lt;br/&gt;
	at org.apache.activemq.pool.PooledConnectionFactory.createConnection(PooledConnectionFactory.java:92)&lt;br/&gt;
	at $javax.jms.ConnectionFactory$$EnhancerByCGLIB$$786945a.createConnection(&amp;lt;generated&amp;gt;)&lt;br/&gt;
	at org.apache.servicemix.wsn.jms.JmsNotificationBroker.init(JmsNotificationBroker.java:48)&lt;br/&gt;
	at org.apache.servicemix.wsn.component.WSNComponent.doInit(WSNComponent.java:147)&lt;br/&gt;
	at org.apache.servicemix.common.AsyncBaseLifeCycle.init(AsyncBaseLifeCycle.java:205)&lt;br/&gt;
	... 46 more&lt;br/&gt;
Caused by: java.net.ConnectException: Connection refused&lt;br/&gt;
	at java.net.PlainSocketImpl.socketConnect(Native Method)&lt;br/&gt;
	at java.net.PlainSocketImpl.doConnect(PlainSocketImpl.java:351)&lt;br/&gt;
	at java.net.PlainSocketImpl.connectToAddress(PlainSocketImpl.java:213)&lt;br/&gt;
	at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:200)&lt;br/&gt;
	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:432)&lt;br/&gt;
	at java.net.Socket.connect(Socket.java:529)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.connect(TcpTransport.java:484)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.doStart(TcpTransport.java:447)&lt;br/&gt;
	at org.apache.activemq.util.ServiceSupport.start(ServiceSupport.java:53)&lt;br/&gt;
	at org.apache.activemq.transport.InactivityMonitor.start(InactivityMonitor.java:127)&lt;br/&gt;
	at org.apache.activemq.transport.TransportFilter.start(TransportFilter.java:58)&lt;br/&gt;
	at org.apache.activemq.transport.WireFormatNegotiator.start(WireFormatNegotiator.java:72)&lt;br/&gt;
	at org.apache.activemq.transport.TransportFilter.start(TransportFilter.java:58)&lt;br/&gt;
	at org.apache.activemq.transport.TransportFilter.start(TransportFilter.java:58)&lt;br/&gt;
	at org.apache.activemq.ActiveMQConnectionFactory.createActiveMQConnection(ActiveMQConnectionFactory.java:266)&lt;br/&gt;
	... 55 more&lt;/p&gt;</comment>
                            <comment id="13124436" author="iocanel" created="Mon, 10 Oct 2011 19:58:14 +0000"  >&lt;p&gt;This is probably one step. Maybe hacking the order of refresh could be the trick?&lt;/p&gt;</comment>
                            <comment id="13124438" author="rickhall" created="Mon, 10 Oct 2011 20:00:42 +0000"  >&lt;p&gt;I have committed a patch for the issue related to the framework not refreshing bundles in multiple passes; this fix will go out in the 4.0.1 release happening today. If you cannot use 4.0.1 yet, then you can port the patch for this issue to 3.0.9, it should be really easy. If you are satisfied by this fix, please close this issue.&lt;/p&gt;

&lt;p&gt;The other issue (i.e., connection refused) appearing when refreshing the Spring context bundle may or may not be related to Felix. If you feel that it is, please open up a separate issue for it. Thanks.&lt;/p&gt;</comment>
                            <comment id="13124449" author="rickhall" created="Mon, 10 Oct 2011 20:12:29 +0000"  >&lt;p&gt;I don&apos;t see how the order of refresh would play a role here. Once stop is called on all bundles they should cease to execute any code. If the bundles misbehaved and continued to let their threads execute after stop(), then you might see failures.&lt;/p&gt;

&lt;p&gt;I suppose one other possibility where order could be important is for bundles whose code assumed they were active and thus had bundle contexts (e.g., lazily activated bundles). If so, that would be another good argument against lazy activation because it makes your bundle dependent on deactivation order.&lt;/p&gt;

&lt;p&gt;You can open up another bug for that and I can look into it too, but not for this release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>56781</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 7 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0vuun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>183971</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>