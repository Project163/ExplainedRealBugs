<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:12:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-1545] Configurations may still be delivered more than once (or not at all)</title>
                <link>https://issues.apache.org/jira/browse/FELIX-1545</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;Even after &quot;fixing&quot; &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-1146&quot; title=&quot;ConfigAdmin can deliver updates to a managed service factory more than once&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-1146&quot;&gt;&lt;del&gt;FELIX-1146&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-1542&quot; title=&quot;Configuration may be supplied twice in certain situations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-1542&quot;&gt;&lt;del&gt;FELIX-1542&lt;/del&gt;&lt;/a&gt; configurations may be delivered more than once. Under lab conditions it can even be observed, that configuration is not delivered at all.&lt;/p&gt;

&lt;p&gt;After digging into this issue a bit further (and writing test cases), it looks like we have three issues:&lt;/p&gt;

&lt;p&gt;(1) The granularity of System.currentTimeMillis() to feed the last modification time and last update time fields is to coarse causing false positives when testing whether configuration should be supplied or not&lt;/p&gt;

&lt;p&gt;(2) In contrast to service update due to Configuration.update(Dictionary), the updates cause by ManagedService&lt;span class=&quot;error&quot;&gt;&amp;#91;Factory&amp;#93;&lt;/span&gt; service registration do not observe the last update time field and thus may cause duplicate delivery&lt;/p&gt;

&lt;p&gt;     T1: update configuration, schedule update task&lt;br/&gt;
     T2: register ManagedService, schedule update task&lt;br/&gt;
     T3: run update task from T1 --&amp;gt; ManagedService is registered and updated&lt;br/&gt;
     T3: run update task from T1 --&amp;gt; ManagedService is updated because last update time flag is ignored&lt;br/&gt;
          This last update call should not take place and must be guarded&lt;/p&gt;

&lt;p&gt;(3) After a service update the ManagedService update tasks (handling update after ManagedService registration) always sets the last update time flag, regardless of whether configuration properties exist or not.&lt;/p&gt;

&lt;p&gt;     T1: create (empty) configuration&lt;br/&gt;
     T2: register ManagedService, schedule update task&lt;br/&gt;
     T1:  update configuration, schedule update task&lt;br/&gt;
     T3: runs update task from T2, updates ManagedService with null (no proeprties) and updates last update time&lt;br/&gt;
         (last update time is now higher than last modification time even though no properties have been supplied)&lt;br/&gt;
     T3: runs update task from T1, but does &lt;b&gt;not&lt;/b&gt; update ManagedService because last update &amp;gt; last modification&lt;/p&gt;

&lt;p&gt;Please note, that the third issue is actually much worse since it prevents the ManagedService from getting configuration at all !&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12434426">FELIX-1545</key>
            <summary>Configurations may still be delivered more than once (or not at all)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fmeschbe">Felix Meschberger</assignee>
                                    <reporter username="fmeschbe">Felix Meschberger</reporter>
                        <labels>
                    </labels>
                <created>Mon, 31 Aug 2009 13:34:51 +0000</created>
                <updated>Mon, 13 Sep 2010 10:20:15 +0000</updated>
                            <resolved>Thu, 26 Aug 2010 08:51:59 +0000</resolved>
                                    <version> configadmin-1.2.4</version>
                                    <fixVersion> configadmin-1.2.8</fixVersion>
                                    <component>Configuration Admin</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12749495" author="fmeschbe" created="Mon, 31 Aug 2009 13:44:22 +0000"  >&lt;p&gt;Committed test cases exhibiting the problems in this issue in Rev. 809592.&lt;/p&gt;</comment>
                            <comment id="12749503" author="fmeschbe" created="Mon, 31 Aug 2009 14:05:37 +0000"  >&lt;p&gt;In Rev. 809597 implement last modification and last update trackers as simple counters (instead of System.currentTimeMillis()) :&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;last modification time is incremented whenever Configuration.update(Dictionary) is called&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;last update time is set to last modification time after each update of the Configuration&apos;s properties in a ManagedSerive&lt;span class=&quot;error&quot;&gt;&amp;#91;Factory&amp;#93;&lt;/span&gt;.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12749512" author="fmeschbe" created="Mon, 31 Aug 2009 14:33:41 +0000"  >&lt;p&gt;In Rev. 809608 added guards to ManagedService&lt;span class=&quot;error&quot;&gt;&amp;#91;Factory&amp;#93;&lt;/span&gt;Update to prevent multiple updates and a guard to ManagedServiceUpdate to prevent setting the last update field if no properties were provided to the ManagedService.&lt;/p&gt;

&lt;p&gt;Plus added some more DEBUG logging.&lt;/p&gt;</comment>
                            <comment id="12749515" author="fmeschbe" created="Mon, 31 Aug 2009 14:46:14 +0000"  >&lt;p&gt;Im satisfied with the fix, therefore resolving this issue.&lt;/p&gt;</comment>
                            <comment id="12749779" author="fmeschbe" created="Tue, 1 Sep 2009 06:05:48 +0000"  >&lt;p&gt;Reopening this issue because BJ Hargrave reported more OSGi TCK failures with this fix applied than without this fix applied.&lt;/p&gt;

&lt;p&gt;I need to more thoroughly investigate.&lt;/p&gt;</comment>
                            <comment id="12756557" author="fmeschbe" created="Thu, 17 Sep 2009 14:10:30 +0000"  >&lt;p&gt;Our bamboo build seems to sporadically have the same issues. &lt;/p&gt;

&lt;p&gt;See here for two failures:&lt;/p&gt;

&lt;p&gt;   &lt;a href=&quot;http://opensource.bamboo.atlassian.com/browse/FELIX-DEF-2478/test/org.apache.felix.cm.integration.ConfigurationBindingTest:test_statically_bound&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://opensource.bamboo.atlassian.com/browse/FELIX-DEF-2478/test/org.apache.felix.cm.integration.ConfigurationBindingTest:test_statically_bound&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and&lt;/p&gt;

&lt;p&gt;   &lt;a href=&quot;http://opensource.bamboo.atlassian.com/browse/FELIX-DEF-2478/test/org.apache.felix.cm.integration.ConfigurationBindingTest:test_static_binding&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://opensource.bamboo.atlassian.com/browse/FELIX-DEF-2478/test/org.apache.felix.cm.integration.ConfigurationBindingTest:test_static_binding&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12768172" author="fmeschbe" created="Wed, 21 Oct 2009 10:56:25 +0000"  >&lt;p&gt;Recent bamboo build failur: &lt;a href=&quot;http://opensource.bamboo.atlassian.com/browse/FELIX-DEF-2757/test/org.apache.felix.cm.integration.ConfigurationBaseTest:test_basic_configuration_factory_configure_then_start&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://opensource.bamboo.atlassian.com/browse/FELIX-DEF-2757/test/org.apache.felix.cm.integration.ConfigurationBaseTest:test_basic_configuration_factory_configure_then_start&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12860831" author="pderop" created="Mon, 26 Apr 2010 07:05:52 +0000"  >&lt;p&gt;Felix,&lt;/p&gt;

&lt;p&gt;Don&apos;t know if it may help, but I have attached to this post a junit/pax-exam test which seems to definitely reproduce the problem.&lt;br/&gt;
(see also the post: &lt;a href=&quot;http://www.mail-archive.com/dev@felix.apache.org/msg16928.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/dev@felix.apache.org/msg16928.html&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;The test creates a factory pid, and perform many updates, and checks that the updated method is called accordingly;&lt;/p&gt;


</comment>
                            <comment id="12860832" author="fmeschbe" created="Mon, 26 Apr 2010 07:13:11 +0000"  >&lt;p&gt;This definitely is helpful and I thank you very much for providing it !&lt;/p&gt;</comment>
                            <comment id="12861365" author="fmeschbe" created="Tue, 27 Apr 2010 11:13:57 +0000"  >&lt;p&gt;The configuration manager currently maintains two counters for configuration updates: one for actual calls to the Configuration.update(Dictionary) method (the last modification counter) and one for the actual delivery of the configuration to the ManagerService&lt;span class=&quot;error&quot;&gt;&amp;#91;Factory&amp;#93;&lt;/span&gt; (the last update counter).&lt;/p&gt;

&lt;p&gt;When a configuration is now provided to a ManagedService&lt;span class=&quot;error&quot;&gt;&amp;#91;Factory&amp;#93;&lt;/span&gt; the last update counter is set to the value of the last modification counter. This may cause multiple configuration updates to be missed if the rate of calls to the Configurtion.update(Dictionary) method is higher than the rate of actual delivery of configuraiton to ManagedService&lt;span class=&quot;error&quot;&gt;&amp;#91;Factory&amp;#93;&lt;/span&gt; services.&lt;/p&gt;

&lt;p&gt;As a solution we might want to introduce another counter, a service registration counter.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;the last modification counter is maintained according to the Configuration.update(Dictionary) method&lt;/li&gt;
	&lt;li&gt;the last update counter is set by the UpdateTask and checked by the ManagedService&lt;span class=&quot;error&quot;&gt;&amp;#91;Factory&amp;#93;&lt;/span&gt;Update task&lt;/li&gt;
	&lt;li&gt;the service registration counter is set by the ManagedService&lt;span class=&quot;error&quot;&gt;&amp;#91;Factory&amp;#93;&lt;/span&gt;Update task and checked by the UpdateTask&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This should allow for consecutive configuration updates to all be delivered to the ManagedSerivce&lt;span class=&quot;error&quot;&gt;&amp;#91;Factory&amp;#93;&lt;/span&gt; services but prevent provisiong of the same configuration to the same service multiple times upon new service registration.&lt;/p&gt;</comment>
                            <comment id="12902435" author="fmeschbe" created="Wed, 25 Aug 2010 13:30:11 +0000"  >&lt;p&gt;Rev. 989094&lt;/p&gt;

&lt;p&gt;Committed Pierre de Rop&apos;s test case (thanks alot for providing) slightly enhanced to not only ensure delivery of the configuration but also to ensure the correct configuration is actually delivered.&lt;/p&gt;

&lt;p&gt;Modified the way the last update flag for configurations is set: Asynchronous configuration delivery is implemented as tasks, which are setup at the time of the configuration update (or service event processing). At this time the current configuration properties are extracted from the configuration as well as the last modification time of these properties. This kind of a timestamped snapshot of the configuration properties.&lt;/p&gt;

&lt;p&gt;At the time of the configuration update (asynchronously as mandated by the spec), last modification time is compared to the actual last update time field of the configuration object. If the last update time is higher than the last modification time of the update task, nothing is done. Otherwise the update takes place and the last update time field is now set to the last modification time of the properties just updated.&lt;/p&gt;

&lt;p&gt;Previously the last update time field was set to the last modification time value at the time of configuration update. This is wrong, because it may cause configurations to get lost.&lt;/p&gt;

&lt;p&gt;All our integration tests (including the new one) now pass. But there are 3 OSGi CT test failures I have to further investigate before resolving this issue fixed.&lt;/p&gt;</comment>
                            <comment id="12902785" author="fmeschbe" created="Thu, 26 Aug 2010 08:51:59 +0000"  >&lt;p&gt;With these fixes (along with the &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-2557&quot; title=&quot;ConfigurationEvent delivery not building the listener list correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-2557&quot;&gt;&lt;del&gt;FELIX-2557&lt;/del&gt;&lt;/a&gt;) fixes testcases by Pierre de Rop, the our own integration test cases as well as the OSGi CT seem to run fine now.&lt;/p&gt;

&lt;p&gt;Thus this issue can be resolved.&lt;/p&gt;</comment>
                            <comment id="12908694" author="fmeschbe" created="Mon, 13 Sep 2010 10:20:15 +0000"  >&lt;p&gt;Closing issues after Configuration Admin 1.2.8 release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12442823" name="cm-stress-test.tgz" size="3555" author="pderop" created="Mon, 26 Apr 2010 07:06:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>57482</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 11 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0vytr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>184615</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>