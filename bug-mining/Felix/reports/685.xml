<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:13:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-1600] ServiceReference.isAssignableTo() always returns true if requesting bundle has no wire</title>
                <link>https://issues.apache.org/jira/browse/FELIX-1600</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;[ from &lt;a href=&quot;http://markmail.org/message/pu5usr5s7vsweyv3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://markmail.org/message/pu5usr5s7vsweyv3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;I think there&apos;s a bug in our ServiceReference.isAssignableTo implementation...&lt;/p&gt;

&lt;p&gt;the javadoc for this method states:&lt;/p&gt;

&lt;p&gt; &quot;This method performs the following checks:&lt;/p&gt;

&lt;p&gt;   1. Get the package name from the specified class name.&lt;br/&gt;
   2. For the bundle that registered the service referenced by this ServiceReference (registrant bundle);&lt;br/&gt;
       find the source for the package. If no source is found then return true if the registrant bundle is&lt;br/&gt;
       equal to the specified bundle; otherwise return false.&lt;br/&gt;
   3. If the package source of the registrant bundle is equal to the package source of the specified&lt;br/&gt;
      bundle then return true; otherwise return false.&quot;&lt;/p&gt;

&lt;p&gt;whereas our implementation does:&lt;/p&gt;

&lt;p&gt;            // There are three situations that may occur here:&lt;br/&gt;
            //   1. The requester does not have a wire for the package.&lt;br/&gt;
            //   2. The provider does not have a wire for the package.&lt;br/&gt;
            //   3. Both have a wire for the package.&lt;br/&gt;
            // For case 1, we do not filter the service reference since we&lt;br/&gt;
            // assume that the bundle is using reflection or that it won&apos;t&lt;br/&gt;
            // use that class at all since it does not import it. For&lt;br/&gt;
            // case 2, we have to try to load the class from the class&lt;br/&gt;
            // loader of the service object and then compare the class&lt;br/&gt;
            // loaders to determine if we should filter the service&lt;br/&gt;
            // refernce. In case 3, we simply compare the exporting&lt;br/&gt;
            // modules from the package wiring to determine if we need&lt;br/&gt;
            // to filter the service reference.&lt;/p&gt;

&lt;p&gt;assume both the provider and requester have no wire for the package&lt;br/&gt;
(as happens when a bundle uses it&apos;s own export, as in this situation)&lt;/p&gt;

&lt;p&gt;the javadoc says isAssignableTo should return false, because the&lt;br/&gt;
provider has no wire and the provider != requester - but we&apos;ll return&lt;br/&gt;
true because the requester has no wire and we do that check first&lt;/p&gt;</description>
                <environment></environment>
        <key id="12435705">FELIX-1600</key>
            <summary>ServiceReference.isAssignableTo() always returns true if requesting bundle has no wire</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="karlpauls">Karl Pauls</assignee>
                                    <reporter username="mcculls">Stuart McCulloch</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 Sep 2009 12:33:30 +0000</created>
                <updated>Tue, 10 Nov 2009 17:12:06 +0000</updated>
                            <resolved>Fri, 2 Oct 2009 12:14:35 +0000</resolved>
                                    <version>framework-2.0.0</version>
                                    <fixVersion>framework-2.0.1</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12758346" author="hand" created="Tue, 22 Sep 2009 18:34:28 +0000"  >&lt;p&gt;We ran into this issue too when using the ServiceTracker, which ends up calling ServiceRegistrationImpl.isAssignableTo, where case 1 causes a class cast exception in our application due to seeing a service object that is not compatible with the requesting  bundles classloader. A fix would be good news (though we should be able to filter the results ourselves).&lt;/p&gt;</comment>
                            <comment id="12758695" author="rickhall" created="Wed, 23 Sep 2009 13:23:44 +0000"  >&lt;p&gt;I have committed a potential fix for this. If someone wants to test trunk (or the latest snapshot) and let me know if it works, that would be great, thanks!&lt;/p&gt;</comment>
                            <comment id="12758805" author="hand" created="Wed, 23 Sep 2009 17:58:52 +0000"  >&lt;p&gt;Unfortunately, it does not work - at least not in our case. We run into the new &quot;case 2&quot;, having a requesterWire==null and providerWire filled in. I believe the new case 2 (the old 1.8.1 version case 1) should simply set allow=false instead of true? The comment on reflection seems like something one should not do, if you want to get the services as seen from a bundle, you need to use that modules bundle-context to ask for the services.&lt;/p&gt;

&lt;p&gt;In our case we have one bundle A declaring&lt;/p&gt;

&lt;p&gt;interface com.stibo.X&lt;/p&gt;

&lt;p&gt;class com.stibo.Ximpl&lt;/p&gt;

&lt;p&gt;and Ximpl is registered as a service of interface X in bundle-context of bundle A. Everything is not exported in this bundle.&lt;/p&gt;

&lt;p&gt;We have another bundle B declaring (and exporting)&lt;/p&gt;

&lt;p&gt;interface com.stibo.X&lt;/p&gt;

&lt;p&gt;and a third bundle C (importing com.stibo package) declaring&lt;/p&gt;

&lt;p&gt;class com.stibo.xxx.yyy.Ximpl2&lt;/p&gt;

&lt;p&gt;and Ximpl2 is registered as a service of interface X in bundle-context of bundle C.&lt;/p&gt;

&lt;p&gt;We see Ximpl2 when bundle A asks for services of com.stibo.X, but clearly, Ximpl2 is not compatible with the X in bundle A (and the X in bundle B is not visible in bundle A).&lt;/p&gt;

&lt;p&gt;I tested this against the snapshot: org.apache.felix.framework-2.1.0-20090923.131858-1.jar&lt;/p&gt;</comment>
                            <comment id="12758816" author="hand" created="Wed, 23 Sep 2009 18:22:45 +0000"  >&lt;p&gt;Tried to fix this locally, allow=false is not the solution. It seems to me that case 2 is symmetrical to case 3 and implementing case using the below code fixed the problem for our application and did not at a first glance seem to have any negative sideeffects.&lt;/p&gt;

&lt;p&gt;            // Case 2: Only include service reference if the service&lt;br/&gt;
            // object uses the same class as the requester.&lt;br/&gt;
            else if (requesterWire == null)&lt;br/&gt;
            {&lt;br/&gt;
	            // If the provider has a wire to the requestor, we are OK. If not,&lt;br/&gt;
	            // then try to use the service registration to see if the requester&apos;s&lt;br/&gt;
	            // class is accessible.&lt;br/&gt;
	            if (!((BundleImpl) providerWire.getExporter().getBundle()).hasModule(requesterModule))&lt;br/&gt;
	            {&lt;br/&gt;
	                try&lt;/p&gt;
	                {
	                    // Load the class from the requesting bundle.
	                    Class requestClass = requesterModule.getClassByDelegation(className);
	                    // Get the service registration and ask it to check
	                    // if the service object is assignable to the requesting
	                    // bundle&apos;s class.
	                    allow = getRegistration().isClassAccessible(requestClass);
	                }
&lt;p&gt;	                catch (Exception ex)&lt;/p&gt;
	                {
	                    // This should not happen, filter to be safe.
	                    allow = false;
	                }
&lt;p&gt;	            }&lt;br/&gt;
	            else&lt;/p&gt;
	            {
	                // O.k. the provider is wired to the requestor&apos;s package, now check
	                // if the provider is wired to the latest version of the requestor, if so
	                // then allow else don&apos;t (the requestor has been updated but not refreshed).
	                allow = requesterModule == providerWire.getExporter();
	            }
&lt;p&gt;            }&lt;/p&gt;</comment>
                            <comment id="12758840" author="rickhall" created="Wed, 23 Sep 2009 19:18:09 +0000"  >&lt;p&gt;From my perspective, you have a degenerate case since you have a requester with its own private copy of the interface it is querying. As it said in the comments, case 2 was specifically allowed because the assumption was the requesting bundle was using reflection. This is sort of extra-spec, but I am fairly certain Equinox does it the same way, since I have talk with the guys there about it.&lt;/p&gt;

&lt;p&gt;However, I think I have committed a refinement to the algorithm with checks to see if the requester has no wire but still has access to the class. If so, then I compare the class, if not then always true. Could you please test again. Thanks!&lt;/p&gt;</comment>
                            <comment id="12758862" author="hand" created="Wed, 23 Sep 2009 20:18:26 +0000"  >&lt;p&gt;The fix seems to work perfectly, thanks...&lt;/p&gt;

&lt;p&gt;Yes, the case is a bit degenerate, but nevertheless to fix our case properly and safely we had to include the service interface locally in an extra bundle.&lt;/p&gt;</comment>
                            <comment id="12758877" author="rickhall" created="Wed, 23 Sep 2009 20:53:06 +0000"  >&lt;p&gt;Excellent! I will close this issue since you have verified that it works. Thanks a lot.&lt;/p&gt;</comment>
                            <comment id="12759523" author="rickhall" created="Fri, 25 Sep 2009 13:22:26 +0000"  >&lt;p&gt;It turns out this fix is not 100% correct...it messes up when there is a service being provided under multiple interfaces and a client requests under one interface and doesn&apos;t have access to the other. I will need to look into some changes, then we will have to test it again.&lt;/p&gt;</comment>
                            <comment id="12760384" author="rickhall" created="Mon, 28 Sep 2009 21:13:52 +0000"  >&lt;p&gt;Henning, could you please test again and let me know if the latest trunk/snapshot still works for you? Thanks.&lt;/p&gt;</comment>
                            <comment id="12760559" author="hand" created="Tue, 29 Sep 2009 11:38:29 +0000"  >&lt;p&gt;The new version also works - I tested the latest snapshot: org.apache.felix.framework-2.1.0-20090928.211315-3.jar. Thanks, Henning&lt;/p&gt;</comment>
                            <comment id="12760563" author="rickhall" created="Tue, 29 Sep 2009 11:53:30 +0000"  >&lt;p&gt;Great, thanks Henning. I will close this issue again.&lt;/p&gt;</comment>
                            <comment id="12761556" author="karlpauls" created="Fri, 2 Oct 2009 12:13:05 +0000"  >&lt;p&gt;There is still an issue when the requester doesn&apos;t have a wire but the provider does and the service is a service factory. In that case, we should see whether the provider has access and if so whether the class is the same as of the requester. &lt;/p&gt;</comment>
                            <comment id="12761558" author="karlpauls" created="Fri, 2 Oct 2009 12:14:35 +0000"  >&lt;p&gt;I commited a fix as of revision 820985. Could you please re-test trunk and see whether it still works for you?&lt;/p&gt;</comment>
                            <comment id="12761574" author="hand" created="Fri, 2 Oct 2009 13:43:59 +0000"  >&lt;p&gt;Hi Karl, would it be possible to generate a new snapshot build to test against? Thanks, Henning&lt;/p&gt;</comment>
                            <comment id="12761628" author="rickhall" created="Fri, 2 Oct 2009 15:55:42 +0000"  >&lt;p&gt;I have deployed new snapshots, let us know if everything is ok.&lt;/p&gt;</comment>
                            <comment id="12762043" author="rickhall" created="Sun, 4 Oct 2009 19:19:30 +0000"  >&lt;p&gt;Ok, Henning, just because I think you need some more work, I did some more fine tuning of the algorithm and deployed new snapshots. If you could check it out again, that would be great. Thanks.&lt;/p&gt;</comment>
                            <comment id="12775433" author="hand" created="Tue, 10 Nov 2009 14:29:44 +0000"  >&lt;p&gt;Hi Karl and Richard, I finally got back to testing this - and it works, both in 2.0.1 and in org.apache.felix.framework-2.1.0-20091008.113048-6.jar. Thanks, Henning&lt;/p&gt;</comment>
                            <comment id="12775944" author="rickhall" created="Tue, 10 Nov 2009 17:12:05 +0000"  >&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>57428</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 3 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0vwjr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>184246</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>