<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:14:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-1754] Usage of BundleContext.getServiceReferences results in failure to activate components</title>
                <link>https://issues.apache.org/jira/browse/FELIX-1754</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;I&apos;m attempting to move some code from Equinox to Felix that makes use of the declarative services 1.1 runtime.  Many of the components in our bundles declare multiple &apos;provide&apos; elements in the service declaration .  In general these services consist of a standardized interface in one package and extensions to that interface in another.  Depending on the requirements of the code using the component, other bundles will declare their components with references to either the standardized interface or the extended interface.&lt;/p&gt;

&lt;p&gt;The issue I&apos;m seeing is that the Felix SCR fails to activate some components because it&apos;s failing to resolve references to the service provided by another component.  It turns out that the SCR is using BundleContext.getServiceReferences instead of BundleContext.getAllServiceReferences to locate candidate services when resolving references.  Unfortunately, the getServiceReference flavor requires that the using bundle have access to all class names under which the target service was registered - not just the interface associated with the reference.&lt;/p&gt;

&lt;p&gt;Given the use-case I&apos;ve described and the behavior of Equinox, I believe the Felix SCR should be using BundleContext.getAllServiceReferences(..) to resolve references and rely on the bundle creator to define the correct imports.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12438014">FELIX-1754</key>
            <summary>Usage of BundleContext.getServiceReferences results in failure to activate components</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="sykesm">Matthew Sykes</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Oct 2009 21:35:35 +0000</created>
                <updated>Sun, 1 Nov 2009 16:14:55 +0000</updated>
                            <resolved>Fri, 30 Oct 2009 19:44:01 +0000</resolved>
                                    <version>framework-2.0.1</version>
                                    <fixVersion>framework-2.0.2</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12765250" author="sykesm" created="Tue, 13 Oct 2009 21:37:49 +0000"  >&lt;p&gt;Simple patch to have the DependencyManager use getAllServiceReferences instead of getServiceReferences.  This addressed the component activation problem.&lt;/p&gt;</comment>
                            <comment id="12765273" author="rickhall" created="Tue, 13 Oct 2009 22:04:18 +0000"  >&lt;p&gt;I am not so sure if that is accurate, since it depends on how SCR is implemented. If SCR uses the bundle context of the component bundles to register services and service listeners, then it should work fine using a normal service listener.&lt;/p&gt;

&lt;p&gt;If SCR uses a single service listener for all components and registers it on its own context, then it would need to use an AllServiceListener as you suggest. However, it would also need to use ServiceReference.isAssignableTo() to filter them before injecting them into components to make sure they are actually compatible with the component being injected. Since your patch doesn&apos;t do this, I am a little suspicious that it is completely correct.&lt;/p&gt;

&lt;p&gt;FYI, there was a bug in service filtering that was fixed in the new Felix framework 2.0.1 and that could be related, so you should test with 2.0.1 to see how that impacts your scenario. Thanks!&lt;/p&gt;</comment>
                            <comment id="12765328" author="sykesm" created="Wed, 14 Oct 2009 00:16:31 +0000"  >&lt;p&gt;Thank your for your comments.  The behavior I&apos;m reporting was observed when using the current (as of mid-afternoon today) Felix SCR and Framework.  The same behavior was also observed when using the Felix SCR with Equinox 3.5.&lt;/p&gt;

&lt;p&gt;I&apos;m not trying to suggest that the patch I sent was complete, only that the current behavior doesn&apos;t seem appropriate.  Making the minor change from getServiceReferences to getAllServiceReferences resolved my issue by removing the arbitrary filtering done by the framework to ensure that the using bundle has access to &lt;b&gt;all&lt;/b&gt; classes that the target service was registered with.&lt;/p&gt;

&lt;p&gt;If you feel that adding a check to verify assignability is appropriate during reference resolution, that seems reasonable and correct - provided the check is made using the interface declared on the reference and not for &lt;b&gt;all&lt;/b&gt; class names that the target service was registered with.  This behavior is particularly important when using graphs of DS components as a component can only offer a single service declared with multiple object names.&lt;/p&gt;</comment>
                            <comment id="12765346" author="rickhall" created="Wed, 14 Oct 2009 01:02:46 +0000"  >&lt;p&gt;To be clear, the framework doesn&apos;t require the requester have access to &lt;b&gt;all&lt;/b&gt; class names with which the target service was registered, it requires that the ones to which it does have access are the same as the provider.&lt;/p&gt;

&lt;p&gt;If no check for assignability is being done by SCR currently, then it would &lt;b&gt;have&lt;/b&gt; to be done if introducing your patch. Perhaps you are not seeing an issue because you do not have incompatible service versions registered.&lt;/p&gt;

&lt;p&gt;At any rate, if you are running from trunk and it is still exhibiting the issue, then I agree it needs to be looked into. I will wait for Felix to comment, since he is the expert here.&lt;/p&gt;</comment>
                            <comment id="12765383" author="sykesm" created="Wed, 14 Oct 2009 03:44:51 +0000"  >&lt;p&gt;Based on your updates I added the isAssignableTo checks and the issue came back.  As usual, things aren&apos;t as simple as I&apos;d hoped.&lt;/p&gt;

&lt;p&gt;I threw a couple of debug statements into ServiceRegistrationImpl.isAssignableTo and isClassAccessible.  When the isAssignableTo check is run against the ServiceReference for the interface associated with the reference, the requester and provider references are null so the code falls into case 1.&lt;/p&gt;

&lt;p&gt;RequesterWire = null&lt;br/&gt;
ProviderWire  = null&lt;br/&gt;
Case 1&lt;/p&gt;

&lt;p&gt;The interface class gets loaded successfully and then ServiceRegistrationImpl.isClassAccessible is driven:&lt;/p&gt;

&lt;p&gt;requestClass from requesterModule.getClassByDelegation = interface foo.bar.event.EventEngine&lt;br/&gt;
isClassAccessible: m_factory = Component: foo.bar.event.internal.EventEngineImpl (11)&lt;br/&gt;
isClassAccessible: m_svcObj = Component: foo.bar.event.internal.EventEngineImpl (11)&lt;br/&gt;
isClassAccessible: sourceClass= class org.apache.felix.scr.impl.manager.DelayedComponentManager&lt;br/&gt;
isClassAccessible: targetClass= null&lt;br/&gt;
isClassAccessible: sourceClass == targetClass = false&lt;br/&gt;
serviceRef &lt;span class=&quot;error&quot;&gt;&amp;#91;foo.bar.event.EventEngine, org.osgi.service.event.EventAdmin&amp;#93;&lt;/span&gt; was not assignable to foo.bar.event.EventEngine&lt;/p&gt;

&lt;p&gt;If I&apos;m reading the code correctly, it looks like the SCR bundle&apos;s class loader is being used to resolve the the service interface.  This only seems to happen in &quot;case 1&quot; where no wire was found.  Well, go figure, the manifest for the bundle that&apos;s declared the reference is poorly constructed and relies on a DynamicImport-Package: *.&lt;/p&gt;

&lt;p&gt;So, it looks like a combination of dynamic import, the implementation of isAssignableTo, and the use of a &quot;smart&quot; service factory is causing the reference to remain unsatisfied.  I don&apos;t know if this is just how things are or if the framework should attempt to wire the package (because of the dynamic import) or what...&lt;/p&gt;

&lt;p&gt;At this point I&apos;m not sure what&apos;s going on in Equinox as the external symptom was the same; I&apos;ll have to look more closely tomorrow.  Whatever that issue is, it&apos;s most likely unrelated.&lt;/p&gt;</comment>
                            <comment id="12765400" author="fmeschbe" created="Wed, 14 Oct 2009 05:26:25 +0000"  >&lt;p&gt;Well, actually, the resolution is &amp;#8211; unfortunately for you &amp;#8211; quite easy and clearly described in the spec (Section 112.3 References to Services in the R4.2 Compendium Manual, DS 1.1): &lt;/p&gt;

&lt;p&gt;          The services that are selected by a reference are called the target services.&lt;br/&gt;
          These are the services selected by the BundleContext.getServiceReferences&lt;br/&gt;
          method where the first argument is the reference&apos;s interface and the second&lt;br/&gt;
          argument is the reference&apos;s target property, which must be a valid filter.&lt;/p&gt;

&lt;p&gt;So, the spec refers to the getServiceReferences method and using the getAllServiceReferences method is therefore in my understanding violating the spec.&lt;/p&gt;

&lt;p&gt;From the POV of the Felix DS implementation, I fear there is nothing to be done.&lt;/p&gt;


&lt;p&gt;But... what worries me is your output:&lt;/p&gt;

&lt;p&gt;   &amp;gt; isClassAccessible: m_factory = Component: foo.bar.event.internal.EventEngineImpl (11)&lt;br/&gt;
   &amp;gt; isClassAccessible: m_svcObj = Component: foo.bar.event.internal.EventEngineImpl (11)&lt;br/&gt;
   &amp;gt; isClassAccessible: sourceClass= class org.apache.felix.scr.impl.manager.DelayedComponentManager &lt;/p&gt;

&lt;p&gt;If you are using SCR to register the service, then m_factory is probably the DelayedComponentManager instance and not the EventEngineImpl instance ! I think your log output is incorrect.&lt;/p&gt;

&lt;p&gt;Anyway, the problem is that an SCR class &amp;#8211; the DelayedComponentManager acting as the ServiceFactory &amp;#8211; is used to load the interface class, a situation which is definitely wrong. And a situation, which I assumed Karl has fixed for 2.0.1....&lt;/p&gt;

&lt;p&gt;The problem here is, that the m_factory may not be used to verify accessibility since the service may be registered as a ServiceFactory on behalf of the real bundle. So the actual provider bundle must probably be used to verify accessibility and not the ServiceFactory object&apos;s class loader.&lt;/p&gt;</comment>
                            <comment id="12765457" author="karlpauls" created="Wed, 14 Oct 2009 08:07:08 +0000"  >&lt;p&gt;It should be fixed in 2.0.1 for some cases. Unfortunately, we will not be able to avoid asking the factory in all cases. Did you try with felix 2.0.1/trunk?&lt;/p&gt;</comment>
                            <comment id="12765518" author="sykesm" created="Wed, 14 Oct 2009 11:32:52 +0000"  >&lt;p&gt;Felix,&lt;/p&gt;

&lt;p&gt;&amp;gt; If you are using SCR to register the service, then m_factory is probably the DelayedComponentManager instance and not the EventEngineImpl instance ! I think your log output is incorrect. &lt;/p&gt;

&lt;p&gt;The values associated with m_factory and m_svcObj are, in fact, instances of DelayedComponentManager.  The name of the component is &apos;foo.bar.event.internal.EventEngineImpl&apos; - which happens to match the name of the implementation class.  The toString representation from AbstractComponentManager is  &quot;Component: &quot; + getName() + &quot; (&quot; + getId() + &quot;)&quot;;&lt;/p&gt;

&lt;p&gt;&amp;gt; Anyway, the problem is that an SCR class &amp;#8211; the DelayedComponentManager acting as the ServiceFactory &amp;#8211; is used to load the interface class, a situation which is definitely wrong&lt;/p&gt;

&lt;p&gt;After spending the time with the code yesterday, I have to agree.  I&apos;m able to get around this with a &quot;proper&quot; manifest that codes a direct import for the package without relying on dynamic import.  While that&apos;s the change I&apos;m making locally to get the desired behavior, it still seems like the ServiceReference.isAssignableTo doesn&apos;t handle the dynamic import scenario that involves and extender and a service factory.&lt;/p&gt;

&lt;p&gt;Karl,&lt;/p&gt;

&lt;p&gt;&amp;gt; Did you try with felix 2.0.1/trunk?&lt;/p&gt;

&lt;p&gt;Yes.  This behavior was observed with the code in the trunk.&lt;/p&gt;

&lt;p&gt;Is it possible that an attempt to wire to the target package could be useful in the case where the requester bundle doesn&apos;t have an existing wire and it does have a matching dynamic import header?  I have no idea how the resolver works so I&apos;m just throwing out as a question.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;
</comment>
                            <comment id="12765524" author="sykesm" created="Wed, 14 Oct 2009 11:47:35 +0000"  >&lt;p&gt;Changing component and severity.  The workaround of using an explicit import package is simple and straightforward.&lt;/p&gt;</comment>
                            <comment id="12765555" author="sykesm" created="Wed, 14 Oct 2009 13:06:59 +0000"  >&lt;p&gt;As an experiment, I changed ServiceRegistrationImpl.isAssignableTo to attempt to get the requester&apos;s wire after the call to getClassByDelegation.  While the wire was null before the attempt to load the class, the getClassByDelegation resolved the dynamic import and wired the requester to the provider.&lt;/p&gt;

&lt;p&gt;While I don&apos;t expect this is necessarily the correct way to address the problem, it did seem to work.&lt;/p&gt;</comment>
                            <comment id="12765556" author="sykesm" created="Wed, 14 Oct 2009 13:11:06 +0000"  >&lt;p&gt;Re-acquire the wire after loading the class instance&lt;/p&gt;</comment>
                            <comment id="12765557" author="karlpauls" created="Wed, 14 Oct 2009 13:11:50 +0000"  >&lt;p&gt;Interesting. We need to look into it. Thanks.&lt;/p&gt;</comment>
                            <comment id="12769259" author="rickhall" created="Fri, 23 Oct 2009 15:32:31 +0000"  >&lt;p&gt;I think perhaps the issue is in ServiceRegistrationImpl.isClassAccessible(). In this method it tries to get the service type from the registered service object and in the case of a service factory will use that instead of the service object. Currently, if the factory is used to retrieve the service type and the type is not found, it does a comparison to null which will always return false. Maybe we need to do something like this instead:&lt;/p&gt;

&lt;p&gt;    private boolean isClassAccessible(Class clazz)&lt;br/&gt;
    {&lt;br/&gt;
        try&lt;/p&gt;
        {
            // Try to load from the service object or service factory class.
            Class sourceClass = (m_factory != null)
                ? m_factory.getClass() : m_svcObj.getClass();
            Class targetClass = Util.loadClassUsingClass(sourceClass, clazz.getName());
            return ((m_factory != null) &amp;amp;&amp;amp; (targetClass == null)) ? true : (targetClass == clazz);
        }
&lt;p&gt;        catch (Exception ex)&lt;/p&gt;
        {
            // Ignore this and return false.
        }
&lt;p&gt;        return false;&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;So if the factory doesn&apos;t have access, we always return true instead of always returning false. We could potentially try to make a more fine-grained decision by getting the bundle associated with the service factory class and return true when the type if not found if the factory type comes from a bundle other than the registering bundle. This assumes that extenders register services using the context of the bundle they are extending and not their own.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="12770235" author="rickhall" created="Mon, 26 Oct 2009 22:12:30 +0000"  >&lt;p&gt;Matthew, I am not sure if you are still around, but I have attached a patch to try to address this issue. Is there anyway you could try it out? If you cannot easily apply the patch to trunk yourself, I could also send you a patch felix.jar. Thanks!&lt;/p&gt;</comment>
                            <comment id="12770316" author="sykesm" created="Tue, 27 Oct 2009 00:41:50 +0000"  >&lt;p&gt;Richard, I&apos;ll apply to trunk and give it a shot tomorrow.  Will update with the results.  Thanks.&lt;/p&gt;</comment>
                            <comment id="12770333" author="rickhall" created="Tue, 27 Oct 2009 01:04:17 +0000"  >&lt;p&gt;Thanks, I won&apos;t make any guarantees that it will work, but hopefully it does. Effectively, we are trying to approximate the wired state of a service object without actually having the service object (i.e., we only have a service factory), so to some degree it is like stabbing in the dark...&lt;/p&gt;</comment>
                            <comment id="12772056" author="sykesm" created="Fri, 30 Oct 2009 19:41:34 +0000"  >&lt;p&gt;I finally got a chance to test and it worked for me.  Thanks again.&lt;/p&gt;</comment>
                            <comment id="12772057" author="rickhall" created="Fri, 30 Oct 2009 19:44:01 +0000"  >&lt;p&gt;Thanks. Closing this as fixed. Please open a new bug report if additional issues are uncovered.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12438841">FELIX-1798</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12423257" name="FELIX-1754.txt" size="2795" author="rickhall" created="Mon, 26 Oct 2009 22:10:01 +0000"/>
                            <attachment id="12422100" name="assignable.diff" size="1396" author="sykesm" created="Wed, 14 Oct 2009 13:11:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>57277</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 4 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1aryf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>270995</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>