<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:09:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-1036] FileInstaller spawns multiple watchers for same directory</title>
                <link>https://issues.apache.org/jira/browse/FELIX-1036</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;I am running into a strange issue and I don&apos;t know if it has to do with any bad use in my part. I am using fileinstall to monitor two directories. fileinstall is configured using config.properties file to monitor a dir called /space/ss141213/software/felix-1.6.0/bundle. I have a cfg file in modules dir that configures fileinstall to monitor a second dir called /tmp/bundles. During subsequent start of the framework, I see fileinstall spwaning more than one watchers for the second dir as shown in the jstack output below:&lt;/p&gt;

&lt;p&gt;&quot;&lt;/p&gt;
{felix.fileinstall.dir=/space/ss141213/software/felix-1.6.0/bundle, felix.fileinstall.debug=1}
&lt;p&gt;&quot; daemon prio=3 tid=0x0833fc00 nid=0xd waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0xcbaea000..0xcbaeaae0&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: TIMED_WAITING (sleeping)&lt;br/&gt;
        at java.lang.Thread.sleep(Native Method)&lt;br/&gt;
        at org.apache.felix.fileinstall.DirectoryWatcher.run(DirectoryWatcher.java:122)&lt;/p&gt;

&lt;p&gt;&quot;&lt;/p&gt;
{service.pid=org.apache.felix.fileinstall.bd775a2e-9ed9-41e4-8159-83295f3aaefa, felix.fileinstall.dir=/tmp/bundles, service.factorypid=org.apache.felix.fileinstall, felix.fileinstall.debug=1}
&lt;p&gt;&quot; daemon prio=3 tid=0x083a5800 nid=0x13 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0xcb7ad000..0xcb7adbe0&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: TIMED_WAITING (sleeping)&lt;br/&gt;
        at java.lang.Thread.sleep(Native Method)&lt;br/&gt;
        at org.apache.felix.fileinstall.DirectoryWatcher.run(DirectoryWatcher.java:122)&lt;/p&gt;

&lt;p&gt;&quot;&lt;/p&gt;
{service.pid=org.apache.felix.fileinstall.2aac2209-96d0-4dcb-8e33-ac3f6fbf2856, felix.fileinstall.dir=/tmp/bundles, service.factorypid=org.apache.felix.fileinstall, felix.fileinstall.debug=1}
&lt;p&gt;&quot; daemon prio=3 tid=0x08387800 nid=0x12 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0xcb927000..0xcb927a60&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: TIMED_WAITING (sleeping)&lt;br/&gt;
        at java.lang.Thread.sleep(Native Method)&lt;br/&gt;
        at org.apache.felix.fileinstall.DirectoryWatcher.run(DirectoryWatcher.java:122)&lt;/p&gt;

&lt;p&gt;&quot;&lt;/p&gt;
{service.pid=org.apache.felix.fileinstall.8997ded4-b1de-46bb-b675-4166734eea73, felix.fileinstall.dir=/tmp/bundles, service.factorypid=org.apache.felix.fileinstall, felix.fileinstall.debug=1}
&lt;p&gt;&quot; daemon prio=3 tid=0x0838a000 nid=0x11 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0xcb979000..0xcb9798e0&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: TIMED_WAITING (sleeping)&lt;br/&gt;
        at java.lang.Thread.sleep(Native Method)&lt;br/&gt;
        at org.apache.felix.fileinstall.DirectoryWatcher.run(DirectoryWatcher.java:122)&lt;/p&gt;

&lt;p&gt;&quot;&lt;/p&gt;
{service.pid=org.apache.felix.fileinstall.15c95057-a0f9-4269-b827-44df4fa23f6b, felix.fileinstall.dir=/tmp/bundles, service.factorypid=org.apache.felix.fileinstall, felix.fileinstall.debug=1}
&lt;p&gt;&quot; daemon prio=3 tid=0x0838c800 nid=0x10 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0xcb9cb000..0xcb9cb960&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: TIMED_WAITING (sleeping)&lt;br/&gt;
        at java.lang.Thread.sleep(Native Method)&lt;br/&gt;
        at org.apache.felix.fileinstall.DirectoryWatcher.run(DirectoryWatcher.java:122)&lt;/p&gt;


&lt;p&gt;The funny thing is the number keeps increasing by one more for every subsequent restart.&lt;/p&gt;

&lt;p&gt;I see that as part of initial configuration, fileinstall spwans a directory watcher for modules dir, as this is configured using config.properties. Then that directorywatcher spawns a second one after it discovers the cfg file in modules dir. At the same time, configuration manager also notifies fileinstaller based on what appears to be its cached values.&lt;/p&gt;

&lt;p&gt;It is very easy to reproduce. In a standard felix installation, drop fileinstall bundle alonng with configurationmanager bundle into bundle dir. Add it to the auto.start list. Add a cfg file with an entry: felix.fileinstall.dir=/tmp/bundles. Now start Felix. This time you shall see only thread for /tmp/bundles. Restart Felix, now you shall see two threads for that dir. Restart again to see three threads and it continues. If you clean the cache, it goes back to one thread.&lt;/p&gt;</description>
                <environment>Felix 1.6.0, fileinstall 0.9.2, configadmin 1.0.10</environment>
        <key id="12422635">FELIX-1036</key>
            <summary>FileInstaller spawns multiple watchers for same directory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="clement.escoffier">Clement Escoffier</assignee>
                                    <reporter username="sahoo">Sanjeeb Kumar Sahoo</reporter>
                        <labels>
                    </labels>
                <created>Sat, 11 Apr 2009 15:58:29 +0000</created>
                <updated>Wed, 22 Apr 2009 14:20:39 +0000</updated>
                            <resolved>Wed, 22 Apr 2009 09:27:22 +0000</resolved>
                                    <version>fileinstall-0.9.2</version>
                                    <fixVersion> fileinstall-1.0.0</fixVersion>
                                    <component>File Install</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12699129" author="fdiotalevi" created="Wed, 15 Apr 2009 09:23:54 +0000"  >&lt;p&gt;Replicated with Felix 1.4.1. I didn&apos;t notice it before because I always delete felix cache before starting.&lt;/p&gt;

&lt;p&gt;It&apos;s quite tricky. FileInstall (a ManagedServiceFactory) is notified twice (or more times ): the first time the configuration contained in the cache is passed, the second the configuration as read in the configuration file.&lt;br/&gt;
Trying to work on a patch now.&lt;/p&gt;</comment>
                            <comment id="12699575" author="fdiotalevi" created="Thu, 16 Apr 2009 08:12:20 +0000"  >&lt;p&gt;Sahoo, can you give this patch a run? I tried againt you use case and in my application, and it seems to work.&lt;/p&gt;

&lt;p&gt;First of all I removed the configuration map and ConfigurationKey object.&lt;/p&gt;

&lt;p&gt;Second, every time a property file is detected, I (transparently to the user) add a property &quot;felix.fileinstall.filename&quot; with the name of the file as value to the dictionary. In this way the configuration dictionary always contains the filename, and we can just use Configuration Admin service to check if a configuration file has been read and processed.&lt;/p&gt;

&lt;p&gt;Finally, when the DirectoryWatcher finds an updated file (or, after Felix startup, simply finds any file) it uses the Configuration Admin service to check if a configuration exist with felix.fileinstall.filename=&amp;lt;filename&amp;gt;&lt;br/&gt;
If it already exists, it updates the configuration using the dictionary provided by the configuration file.&lt;/p&gt;

&lt;p&gt;The patch assumes that configuration files always &quot;win&quot;. In other words, at startup, all cached configurations are updated with dictionaries coming from configuration files.&lt;br/&gt;
I think it&apos;s acceptable, since when you use FileInstall you are not supposed to change the configurations using other tools like WebConsole.&lt;/p&gt;</comment>
                            <comment id="12699713" author="sahoo" created="Thu, 16 Apr 2009 14:11:51 +0000"  >&lt;p&gt;Filippo,&lt;/p&gt;

&lt;p&gt;I tried the patch. It works as I see only one watcher per every watched directory, but for some reason, I see configuration values getting printed twice for the second directory as shown below:&lt;/p&gt;

&lt;p&gt;felix.fileinstall.poll  (ms)   5000&lt;br/&gt;
felix.fileinstall.dir            /space/ss141213/WS/gf/v3.trunk.new/publish/glassfish/modules&lt;br/&gt;
felix.fileinstall.debug          1&lt;br/&gt;
felix.fileinstall.bundles.new.start          false&lt;br/&gt;
felix.fileinstall.poll  (ms)   5000&lt;br/&gt;
felix.fileinstall.dir            /space/ss141213/WS/gf/v3.trunk.new/publish/glassfish/domains/domain1/autodeploy-modules&lt;br/&gt;
felix.fileinstall.debug          1&lt;br/&gt;
felix.fileinstall.bundles.new.start          true&lt;br/&gt;
Updating configuration from org.apache.felix.fileinstall-autodeploy-modules.cfg&lt;br/&gt;
felix.fileinstall.poll  (ms)   5000&lt;br/&gt;
felix.fileinstall.dir            /space/ss141213/WS/gf/v3.trunk.new/publish/glassfish/domains/domain1/autodeploy-modules&lt;br/&gt;
felix.fileinstall.debug          1&lt;br/&gt;
felix.fileinstall.bundles.new.start          true&lt;/p&gt;

&lt;p&gt;Pl. also note that, it does not always happen. So, I think there is some timing issue here.&lt;/p&gt;</comment>
                            <comment id="12699726" author="sahoo" created="Thu, 16 Apr 2009 15:15:58 +0000"  >&lt;p&gt;Looks like I missed the line &quot;Updating configuration from org.apache.felix.fileinstall-autodeploy-modules.cfg.&quot; So the second output is expected. So, the patch works for me. &lt;/p&gt;</comment>
                            <comment id="12701456" author="clement.escoffier" created="Wed, 22 Apr 2009 09:27:22 +0000"  >&lt;p&gt;I committed the patch. Please close the issue if it&apos;s ok for you.&lt;/p&gt;</comment>
                            <comment id="12701542" author="sahoo" created="Wed, 22 Apr 2009 14:20:39 +0000"  >&lt;p&gt;Issue resolved.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12405630" name="FELIX-1036.patch" size="10055" author="fdiotalevi" created="Thu, 16 Apr 2009 08:12:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>57954</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 32 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0vyxz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>184634</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>