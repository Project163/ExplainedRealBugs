<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:14:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-6160] Dynamic HTTP(S) port assignment does not work with HTTP Jetty</title>
                <link>https://issues.apache.org/jira/browse/FELIX-6160</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;The documentation of Felix HTTP describes the feature that &quot;org.osgi.service.http.port&quot;=0 or &quot;org.osgi.service.http.port.secure&quot;=0 will bind to a free port.&lt;/p&gt;

&lt;p&gt;Felix HTTP Jetty does bind to a free port as expected but then it does try to store the real port in its service properties and this is where it goes wrong.&lt;br/&gt;
Http Jetty stores the real port in the properties &quot;org.osgi.service.http.port&quot; and &quot;org.osgi.service.http.port.secure&quot; of HttpService and HttpServiceRuntime.&lt;/p&gt;

&lt;p&gt;Unfortunately it uses JettyConfig.getHttp(s)Port() to do this. getHttpPort() calls determinePort() which calls getSocketPort(0). And getSocketPort(0) opens the next free socket, stores the port number and &lt;b&gt;closes the port immediately&lt;/b&gt;.&lt;br/&gt;
So the next time getHttp(s)Port() is called a different port might be returned.&lt;/p&gt;

&lt;p&gt;This is where for example getHttpPort() is called (getHttpsPort() is similar):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
JettyConfig.isUseHttp():
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; useHttp &amp;amp;&amp;amp; getHttpPort() &amp;gt; 0;
JettyConfig.setServiceProperties():
    props.put(HTTP_PORT, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.toString(getHttpPort()));
JettyService.initializeJetty():
    message.append(&lt;span class=&quot;code-quote&quot;&gt;&quot; HTTP:&quot;&lt;/span&gt;).append(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.config.getHttpPort());
JettyService.initializeHttp():
    configureConnector(connector, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.config.getHttpPort());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So each time a different port is returned and there is no possibility to determine which the used port really is.&lt;br/&gt;
For example in the log it mentions:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[CM Configuration Updater (Update: pid=org.apache.felix.http)] INFO org.eclipse.jetty.server.AbstractConnector - Started ServerConnector@74c8438a{SSL,[ssl, http/1.1]}{0.0.0.0:55707}
[DEBUG] Adding bundle de.sma.ennexos.webui.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.api.ioconfigurationapi:0.1.0.5C1DA7096F86D478F13D5148A119A1AFCB0AAA87 (111) : active
[INFO] Started Jetty 9.4.12.v20180830 at port(s) HTTP:55705 HTTPS:55712 on context path / [minThreads=8,maxThreads=200,acceptors=1,selectors=2]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So JettyService.initializeHttp() uses port 55707 for HTTPS (this is really the port that is used) whereas the log output (JettyService.initializeJetty()) one line below mentions port 55712 which is wrong. When I lock into the service properties of HttpService or HttpServiceRuntime &quot;org.osgi.service.http.port.secure&quot; is set to another wrong port (e.g. 55711).&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Possible fix:&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;either make sure that determinePort()/getHttpPort()/getHttpsPort() is only called once per HttpService (e.g. make it private) and only use the HTTP(S)_PORT property of the HTTP service&lt;/li&gt;
	&lt;li&gt;or make getHttpPort() remember the last returned port so that it can return the same port when it is called multiple times. I am not sure if each HttpService has an own JettyConfig otherwise this solution would probably not work. Also config updates should also make getHttpPort() return the new port.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13244634">FELIX-6160</key>
            <summary>Dynamic HTTP(S) port assignment does not work with HTTP Jetty</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cziegeler">Carsten Ziegeler</assignee>
                                    <reporter username="tobgun">Tobias Gunkel</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Jul 2019 14:36:37 +0000</created>
                <updated>Sat, 7 Sep 2019 13:54:20 +0000</updated>
                            <resolved>Fri, 26 Jul 2019 06:14:28 +0000</resolved>
                                    <version>http.jetty-4.0.10</version>
                                    <fixVersion>http.jetty-4.0.12</fixVersion>
                                    <component>HTTP Service</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="16893355" author="cziegeler" created="Fri, 26 Jul 2019 06:14:28 +0000"  >&lt;p&gt;Thanks for reporting &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tobgun&quot; class=&quot;user-hover&quot; rel=&quot;tobgun&quot;&gt;tobgun&lt;/a&gt;. I&apos;ve fixed this in rev 1863772. by simply caching the determined port in JettyConfig. Each Httpservice has its own config object&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 16 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z04mbk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>