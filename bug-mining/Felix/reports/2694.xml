<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:03:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5274] remove callback fails after manually removing dynamic dependencies</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5274</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;When dynamic instance bound dependencies are removed in the component destroy dm fails to call the remove callback. &lt;/p&gt;

&lt;p&gt;I use an adapter service like &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;manager.add(createAdapterService(ApplicationService.class, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;onAdd&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;onChange&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;onRemove&quot;&lt;/span&gt;)
  .setInterface(Servlet.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName(), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
  .setImplementation(WinkServlet.class)
  .setCallbacks(&lt;span class=&quot;code-quote&quot;&gt;&quot;dmInit&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;dmStart&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;dmStop&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;dmDestroy&quot;&lt;/span&gt;)
  );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the WinkServlet init callback an additional dependency is added and this is removed in the destroy callback. When the component is removed I get log messages like&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR org.amdatu.web.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.wink - [main] &lt;span class=&quot;code-quote&quot;&gt;&quot;onRemove&quot;&lt;/span&gt; callback not found on component instances []
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;http://www.mail-archive.com/users%40felix.apache.org/msg17300.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/users%40felix.apache.org/msg17300.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12975051">FELIX-5274</key>
            <summary>remove callback fails after manually removing dynamic dependencies</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pderop">Pierre De Rop</assignee>
                                    <reporter username="brampouwelse">Bram Pouwelse</reporter>
                        <labels>
                    </labels>
                <created>Thu, 2 Jun 2016 05:48:07 +0000</created>
                <updated>Tue, 27 Sep 2016 13:20:52 +0000</updated>
                            <resolved>Tue, 27 Sep 2016 13:20:51 +0000</resolved>
                                    <version>org.apache.felix.dependencymanager-r8</version>
                                    <fixVersion>org.apache.felix.dependencymanager-r9</fixVersion>
                                    <component>Dependency Manager</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15519645" author="pderop" created="Sat, 24 Sep 2016 21:19:45 +0000"  >&lt;p&gt;Hi Bram,&lt;/p&gt;

&lt;p&gt;I finally committed a patch in revision 1762151 for your issue (it fixes the issue where you explicitly remove an instance-bound dependency from &quot;destroy&quot; method).&lt;/p&gt;

&lt;p&gt;added test case in FELIX5274_CleanupInstanceBoundDependenciesInDestroy.java.&lt;/p&gt;

&lt;p&gt;Let me explain what was going on (I prefer to write here all the internals; for the record):&lt;/p&gt;

&lt;p&gt;So, not easy to explain, but the DM state machine is currently re-entrant, and this may causes some side effects when you add or remove dependencies from lifecycle callback methods.&lt;br/&gt;
In your case, you are removing an instance-bound dependency from the &quot;destroy&quot; method. So, at the time you remove the instance-bound dependency from the destroy() method, then the&lt;br/&gt;
DM state machine (which is currently transiting from INSTANTIATED_AND_WAITING_FOR_REQUIRED -&amp;gt; WAITING_FOR_REQUIRED) then re-enter in the &quot;handleChange&quot; method, which then transits from&lt;br/&gt;
WAITING_FOR_REQUIRED -&amp;gt; INACTIVE, and the problem is that at this point we have not yet finished the transition from INSTANTIATED_AND_WAITING_FOR_REQUIRED -&amp;gt; WAITING_FOR_REQUIRED.&lt;/p&gt;

&lt;p&gt;Here is the scenario which helps to understand the issue:&lt;/p&gt;

&lt;p&gt;1) you remove a component, using &quot;dm.remove(component)&quot; for example.&lt;/p&gt;

&lt;p&gt;2) so, at this point, the &quot;handleChange()&quot; method (which is internal to ComponentImpl.java in DM) then performs some state transitions in order to destroy the component.&lt;/p&gt;

&lt;p&gt;3) and at the time the state machine transits from INSTANTIATED_AND_WAITING_FOR_REQUIRED -&amp;gt; WAITING_FOR_REQUIRED, then it does the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (oldState == ComponentState.INSTANTIATED_AND_WAITING_FOR_REQUIRED &amp;amp;&amp;amp; newState == ComponentState.WAITING_FOR_REQUIRED) {
            invoke(m_callbackDestroy);  &lt;span class=&quot;code-comment&quot;&gt;// 3.1
&lt;/span&gt;            removeInstanceBoundDependencies();
            invokeRemoveRequiredDependencies(); &lt;span class=&quot;code-comment&quot;&gt;// 3.2
&lt;/span&gt;            notifyListeners(newState);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (! someDependenciesNeedInstance()) {
                destroyComponent();
            }
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;4) in 3.1, the &quot;invoke(m_callbackDestroy)&quot; is invoked, and your &quot;destroy&quot; callback then removes an instance bound dependency that was initially added in &quot;init&quot; callback.&lt;br/&gt;
And at this point the DM state machine sudenly transits from WAITING_FOR_REQUIRED -&amp;gt; INACTIVE (notice it has not yet finished the initial transition):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (oldState == ComponentState.WAITING_FOR_REQUIRED &amp;amp;&amp;amp; newState == ComponentState.INACTIVE) {
            stopDependencies();
            destroyComponent(); &lt;span class=&quot;code-comment&quot;&gt;// 4.1
&lt;/span&gt;            notifyListeners(newState);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;so, you see in 4.1 the component is destroyed, and when the initial transition resumes, when we execute 3.2 the component&lt;br/&gt;
has already been destroyed in 4.1, and required dependencies can&apos;t be unbounded.&lt;/p&gt;

&lt;p&gt;So, I think that the only way to properly resolve this issue without risks is to not allow reentrency in the state machine, a transition should be fully finished before evaluating what has been done in a lifecyle callback.&lt;/p&gt;

&lt;p&gt;the patch which avoid the state machine to be reentrant is located at the beginning of the handleChange method:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void handleChange() {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isHandlingChange()) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }
        ...
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With the patch, all tests are passing OK, except the ComponentTest.testAddAvailableDependencyFromInitCallback().&lt;/p&gt;

&lt;p&gt;This test was testing that a dependency added or removed from a lifecycle callback was immediately evaluated, but now, since the patch does not allow to re-enter into the state machine, I had to modify a bit the test, which is still making sense.&lt;/p&gt;



</comment>
                            <comment id="15519646" author="pderop" created="Sat, 24 Sep 2016 21:20:33 +0000"  >&lt;p&gt;putting this issue to Fixed but feel free to reopen if any problems.&lt;/p&gt;</comment>
                            <comment id="15522458" author="pderop" created="Mon, 26 Sep 2016 08:32:07 +0000"  >&lt;p&gt;Reopening this issue because it seems Amdatu remote integration tests are not passing anymore with the patch. &lt;br/&gt;
will uncommit the patch and will investigate soon.&lt;/p&gt;</comment>
                            <comment id="15526106" author="pderop" created="Tue, 27 Sep 2016 13:20:52 +0000"  >&lt;p&gt;The patch actually works with amdatu-remote (I did a wrong test).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 8 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yvcn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>