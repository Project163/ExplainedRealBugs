<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:05:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-335] Configuration Admin updates with empty properties and throws NullPointerExceptions due to race condition</title>
                <link>https://issues.apache.org/jira/browse/FELIX-335</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;There appears to be a race condition in the configuration admin that allows managed services to get updated with empty properties (but not null). Furthermore, due to the same bug NullPointerExceptions appear under heavy load. &lt;/p&gt;

&lt;p&gt;Fortunately, I think I was able to isolate the bug. The issue is that configurations are persisted when created but before they are initialized (i.e., given a configuration). If during this window a new ManagedService appears it gets updated with an empty Dictionary. Likewise, if the configuration is re-read after such an update attempt it does not have a pid which causes the null pointer exceptions.&lt;/p&gt;

&lt;p&gt;The fix seems to be rather simple  (unless I&apos;m missing something &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; but took me some time to figure out. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12375690">FELIX-335</key>
            <summary>Configuration Admin updates with empty properties and throws NullPointerExceptions due to race condition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fmeschbe">Felix Meschberger</assignee>
                                    <reporter username="karlpauls">Karl Pauls</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Aug 2007 16:45:48 +0000</created>
                <updated>Mon, 20 Aug 2007 19:17:46 +0000</updated>
                            <resolved>Mon, 20 Aug 2007 13:18:43 +0000</resolved>
                                                    <fixVersion>framework-1.0.0</fixVersion>
                                    <component>Configuration Admin</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12520267" author="fmeschbe" created="Thu, 16 Aug 2007 14:58:15 +0000"  >&lt;p&gt;Thanks for reporting this issue.&lt;/p&gt;

&lt;p&gt;After looking deeper into the problems, I realize there is more than just this:&lt;/p&gt;

&lt;p&gt;(1) If a configuration object is created it has to be persisted (104.7.1) but getProperties() must return null as long as the configuration object is not updated with properties. If now, the framework (or actually the Configuration Admin service) is restarted before such an update takes place, I assume, getProperties() must still return null after the restart. Currently, empty properties is returned in this case.&lt;/p&gt;

&lt;p&gt;(2) As a configuration object has to be persisted upon creation, the save operation is where I originally put it. But it is correct, that there is a race condition, where multiple configuration objects might be created or the may be incomplete.&lt;/p&gt;

&lt;p&gt;(3) If a ManagedService is registered but no configuration is available (assuming that newly created configuration prior to a first update is equivalent to non-existing) the updated() method must be called with null. Currently, either a NullPointerException may occurr or an empty directory may wrongly be given to the updated() method.&lt;/p&gt;

&lt;p&gt;(4) If a ManagedService is updated with configuration, the bundle location is not always set on the configuration object.&lt;/p&gt;

&lt;p&gt;(5) it may be, that the callPlugins method is called with a configuration object, which is new and therefore getProperties() returns null and hence the callPlugins might throw a NullPointerException.&lt;/p&gt;

&lt;p&gt;Given all these issues, I restructured accessing configurations from the cache and the persistent store as well as ensuring the &quot;new&quot; state survives a restart.&lt;/p&gt;

&lt;p&gt;What do you think ?&lt;/p&gt;</comment>
                            <comment id="12520362" author="karlpauls" created="Thu, 16 Aug 2007 20:38:35 +0000"  >&lt;p&gt;With your patch, I see the following exception appear quite often in a heavily multithreaded project:&lt;/p&gt;

&lt;p&gt;java.lang.NullPointerException&lt;br/&gt;
        at org.apache.felix.cm.file.FilePersistenceManager.encodePid(FilePersistenceManager.java:140)&lt;br/&gt;
        at org.apache.felix.cm.file.FilePersistenceManager.getFile(FilePersistenceManager.java:473)&lt;br/&gt;
        at org.apache.felix.cm.file.FilePersistenceManager.store(FilePersistenceManager.java:394)&lt;br/&gt;
        at org.apache.felix.cm.impl.ConfigurationImpl.store(ConfigurationImpl.java:340)&lt;br/&gt;
        at org.apache.felix.cm.impl.ConfigurationImpl.setBundleLocation(ConfigurationImpl.java:223)&lt;br/&gt;
        at org.apache.felix.cm.impl.ConfigurationManager$ManagedServiceUpdate.run(ConfigurationManager.java:840)&lt;br/&gt;
        at org.apache.felix.cm.impl.UpdateThread.run(UpdateThread.java:89) &lt;/p&gt;</comment>
                            <comment id="12520549" author="fmeschbe" created="Fri, 17 Aug 2007 13:11:14 +0000"  >&lt;p&gt;Thanks for the feedback.&lt;/p&gt;

&lt;p&gt;I went over the code again and again found some issues:&lt;/p&gt;

&lt;p&gt;(1) It seems that when a ManagedService is registered and a new configuration is found, the configuration is immediately bound to the ManagedService. I assume, this is probably wrong. So I added precaution to not bind brand new configuration to the ManagedService.&lt;/p&gt;

&lt;p&gt;(2) The FilePersistenceManager does not seem to act very well in multithreaded situations: A configuration file is directly written and thus may be read at the same time and hence returning nothing at. I added synchronization to the load and store methods to prevent same-time access to files as well as have the store method write to a temporary file which is renamed when done.&lt;/p&gt;

&lt;p&gt;Attached, find a new patch, which is complete in a sense, that it includes the changes of yesterday.&lt;/p&gt;

&lt;p&gt;Sorry to misuse you as the testbed for this... But I cannot currently come up with a good muli-threaded test case.&lt;/p&gt;</comment>
                            <comment id="12521075" author="fmeschbe" created="Mon, 20 Aug 2007 13:12:30 +0000"  >&lt;p&gt;I created now my own test cases, which could reproduce the initially reported issues as well as those reported by Karl on 16/Aug. Both issues have been resolved and the service seems to work correctly.&lt;/p&gt;

&lt;p&gt;I will commit these fixes now and deploy a new snapshot, such that regular users may also test.&lt;/p&gt;</comment>
                            <comment id="12521080" author="fmeschbe" created="Mon, 20 Aug 2007 13:18:43 +0000"  >&lt;p&gt;Committed the fixes to Rev. 567688 and deployed a new snapshot of this bundle.&lt;/p&gt;</comment>
                            <comment id="12521202" author="karlpauls" created="Mon, 20 Aug 2007 19:17:46 +0000"  >&lt;p&gt;I asked Ronald Spierenburg to run it through our (even more) involved tests and he wasn&apos;t able to produce any problems &amp;#8211; hence, I&apos;m going to close this issue. Thanks a lot for fixing these issues so quickly!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12363943" name="ConfigAdmin.FELIX-335.patch" size="15700" author="fmeschbe" created="Thu, 16 Aug 2007 14:58:15 +0000"/>
                            <attachment id="12364033" name="ConfigAdmin.FELIX-335_2.patch" size="27433" author="fmeschbe" created="Fri, 17 Aug 2007 13:11:14 +0000"/>
                            <attachment id="12363507" name="empty-properties.patch" size="732" author="karlpauls" created="Thu, 9 Aug 2007 16:46:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>58649</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 years, 15 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0w073:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>184837</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>