<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:33:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3317] Concurrency issue during Component Service registration</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3317</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;In our Sling-based application we saw the following behavior: The Sling ResourceResolverFactory is a component being activated. Yet every now and then a field of that component seems to become null which is not expected for an activated ResourceResolverFactory component and thus causes a NullPointerException.&lt;/p&gt;

&lt;p&gt;Upon inspection I saw, that for the same Declarative Services component two Services have been registered where only one was actually expected.&lt;/p&gt;

&lt;p&gt;Turns out that consumers of the ResoureResovlerFactory where all bound to the same service. The component on the other hand has been cycled due to a configuration update. So one service is backed by a deactivated component (whose field has been reset to null already) and the other service is live.&lt;/p&gt;

&lt;p&gt;The problem is that the service backed by the deactivated method has not been unregistered and thus all consumers are hooked up to the deactivated instance causing all sorts of problems ...&lt;/p&gt;

&lt;p&gt;This is what most probably happens in the AbstractComponentManager:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;T1 Unsatisfied.activate has set the state to Active already before calling registerService&lt;/li&gt;
	&lt;li&gt;T1 registerService is called but the service registration field field is not assigned yet&lt;br/&gt;
                    during registerService ServiceListeners are called&lt;/li&gt;
	&lt;li&gt;T2 A Configuration update comes in and Satisfied(Active).deactivate is called&lt;/li&gt;
	&lt;li&gt;T2 calls unregisterComponentService; does nothing because the service registration field is not assigned&lt;/li&gt;
	&lt;li&gt;T2 destroys component&lt;/li&gt;
	&lt;li&gt;T1 assigns field from service registration&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;As a result the deactivated object&apos;s service registration may be unregistered later when the component is cycled again and the second service registration will only be unregistered when the providing bundle is restarted.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12539761">FELIX-3317</key>
            <summary>Concurrency issue during Component Service registration</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fmeschbe">Felix Meschberger</assignee>
                                    <reporter username="fmeschbe">Felix Meschberger</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Jan 2012 13:17:23 +0000</created>
                <updated>Tue, 20 Nov 2012 10:58:16 +0000</updated>
                            <resolved>Thu, 26 Jan 2012 14:47:41 +0000</resolved>
                                    <version> scr-1.6.0</version>
                                    <fixVersion>scr-1.6.2</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13193043" author="fmeschbe" created="Wed, 25 Jan 2012 13:45:38 +0000"  >&lt;p&gt;There are multiple approaches to this problem:&lt;/p&gt;

&lt;p&gt;(1) Try to delay the destruction of the component due to the configuration update if an &quot;incomplete&quot; satisified state is recognized&lt;/p&gt;

&lt;p&gt;(2) Check state consistency after registering the service with the framework: If the state after registration is still the same as before and the service registration field has not been set (by another thread for example), the field is set. Otherwise the field is left untouched and the service is unregistered again (the backing object is most probably destroyed anyway).&lt;/p&gt;

&lt;p&gt;The first solution must make sure to not create unsolvable deadlocks by for example employing a timout in the delay instead of just waiting. Also an indication of what &quot;incomplete&quot; means and is would be required.&lt;/p&gt;

&lt;p&gt;The second solution really is a workaround since an invalid (or partially invalid) service object is being distributed causing all sorts of log messages (and may be trouble).&lt;/p&gt;</comment>
                            <comment id="13193705" author="fmeschbe" created="Thu, 26 Jan 2012 10:06:08 +0000"  >&lt;p&gt;Committed a first fix in Rev. 1236123&lt;/p&gt;

&lt;p&gt;This implements the second option by checking the consistency before assigning the service registration field: If the state is (still) the same after registering the service and the service registration field is still null (concurrent execution might have already set the field) the field is set. Otherwise a WARN message is logged with the log service and the service is unregistered again.&lt;/p&gt;</comment>
                            <comment id="13193752" author="fmeschbe" created="Thu, 26 Jan 2012 10:54:25 +0000"  >&lt;p&gt;Improved state check in Rev. 1236132: a delayed or service factory component may be really activated during service registration and thus may change the state from Registered to Active. This is perfectly valid and thus must not cause the service registration to be thrown away.&lt;/p&gt;

&lt;p&gt;Also improved logging of the Service Reference to get some usefull information out of it.&lt;/p&gt;</comment>
                            <comment id="13193870" author="fmeschbe" created="Thu, 26 Jan 2012 14:47:41 +0000"  >&lt;p&gt;I think this works now. Will create follow-up issues if problems surface.&lt;/p&gt;</comment>
                            <comment id="13501045" author="fmeschbe" created="Tue, 20 Nov 2012 10:58:16 +0000"  >&lt;p&gt;Close after release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>225264</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i07gbz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>41412</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>