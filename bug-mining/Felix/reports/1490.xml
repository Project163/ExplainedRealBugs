<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:33:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3334] PreferencesManager can throw NPE after being stopped.</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3334</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;PreferencesManager#bundleChanged tries to intercept bundles that are uninstalled. However, if the PreferencesManager itself is stopped, it does not unregister itself as bundle listener, causing possible NPEs when other bundles depending on the preferences service are stopped later on, for example during a shutdown.&lt;/p&gt;

&lt;p&gt;I&apos;ve got a patch available, will attach it to this issue to be applied.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12540577">FELIX-3334</key>
            <summary>PreferencesManager can throw NPE after being stopped.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cziegeler">Carsten Ziegeler</assignee>
                                    <reporter username="jajans">J.W. Janssen</reporter>
                        <labels>
                            <label>patch</label>
                    </labels>
                <created>Tue, 31 Jan 2012 16:21:14 +0000</created>
                <updated>Thu, 8 Aug 2013 10:56:23 +0000</updated>
                            <resolved>Thu, 8 Aug 2013 10:56:22 +0000</resolved>
                                    <version>prefs-1.0.4</version>
                                    <fixVersion>prefs-1.0.6</fixVersion>
                                    <component>Preferences Service</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13197004" author="jajans" created="Tue, 31 Jan 2012 16:22:00 +0000"  >&lt;p&gt;A simple fix for this issue is attached.&lt;/p&gt;</comment>
                            <comment id="13197641" author="fmeschbe" created="Wed, 1 Feb 2012 07:33:39 +0000"  >&lt;p&gt;A bundle being stopped is automatically unregistered as a bundle listener but only after having called the stop method of the BundleActivator.&lt;/p&gt;

&lt;p&gt;Looking at the code, chances are minimal (if there is a concurrency between event handling and handling stop), but this would not be 100% solved by the patch (because an event might still be coming in.&lt;/p&gt;

&lt;p&gt;A better fix would be to check for the null-situation in the event handler when accessing the store.&lt;/p&gt;

&lt;p&gt;Did you actually encounter an NPE ?&lt;/p&gt;</comment>
                            <comment id="13201617" author="jajans" created="Mon, 6 Feb 2012 21:28:21 +0000"  >&lt;p&gt;@Felix: you&apos;re right; I was too early with my conclusion. The spec clearly says that bundles are to be unregistered automatically as listeners after being stopped.&lt;/p&gt;

&lt;p&gt;We actually do encounter the NPE, but we&apos;re running multiple instances of the PreferenceService to provide this service in a multi-tenant situation. That said, we also encountered situations that the original fix did not fix the problem either. So, I&apos;ve changed the code to test for null, which does resolve the issue for our situation.&lt;/p&gt;
</comment>
                            <comment id="13203340" author="cziegeler" created="Wed, 8 Feb 2012 07:38:51 +0000"  >&lt;p&gt;Thanks for your patch. I&apos;ve applied it in revision 1241796&lt;/p&gt;</comment>
                            <comment id="13219051" author="jajans" created="Wed, 29 Feb 2012 10:00:34 +0000"  >&lt;p&gt;I&apos;m reopening this issue after giving my earlier fix yet another thought. From field tests it appears that other NPEs can occur even with my earlier fix.&lt;/p&gt;

&lt;p&gt;Why not let the BackingStoreManager#getStore() throw an BackingStoreException if there is no backing store service tracker available?&lt;/p&gt;

&lt;p&gt;While it would mean a (internal) API-change, all usages of the #getStore() method would only yield an exception if used after the bundle has being stopped. We could try to cover all usages of #getStore() with a null-check as well, but would make the code (IMO) more complicated than necessary?!&lt;/p&gt;

&lt;p&gt;I&apos;ve investigated the impact of this change, and found that all places where #getStore() is called already handle or throw a BackingStoreException, making it a trivial change.&lt;/p&gt;</comment>
                            <comment id="13219053" author="jajans" created="Wed, 29 Feb 2012 10:01:10 +0000"  >&lt;p&gt;Trivial patch to support my previous comment.&lt;/p&gt;</comment>
                            <comment id="13227491" author="marrs" created="Mon, 12 Mar 2012 13:12:47 +0000"  >&lt;p&gt;Applied this patch with a small change:&lt;br/&gt;
To prevent a possible race condition when &quot;this.storeTracker&quot; is nulled whilst in the middle of this method, I read the member once into a local variable and use that throughout the rest of the codebase.&lt;br/&gt;
To be honest, I have the feeling that there are other possible concurrency issues in this code, but for now I wanted to allow J.W. to test his patch.&lt;br/&gt;
@Carsten/@Felix WDYT?&lt;/p&gt;</comment>
                            <comment id="13227505" author="cziegeler" created="Mon, 12 Mar 2012 13:21:23 +0000"  >&lt;p&gt;To be honest, i&apos;m not using this implementation very intensively, so chances are that there are more concurrency issues.&lt;br/&gt;
I&apos;m wondering if we need the support for different stores at all or just go with the default store and are done. So far I haven&apos;t heard that someone is using its own store implementation&lt;/p&gt;</comment>
                            <comment id="13227521" author="marrs" created="Mon, 12 Mar 2012 13:40:19 +0000"  >&lt;p&gt;Can&apos;t speak for everybody, but I actually like the fact that you can plug-in a different store implementation. I don&apos;t think it structurally causes problems (other than the fact that it slightly complicates the design and leaves us with questions like &quot;what should happen if the backing store changes or goes away). The concurrency issues are things we should keep working on. In any case we&apos;re actively using prefs in &lt;a href=&quot;http://amdatu.org/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://amdatu.org/&lt;/a&gt; so we&apos;ll keep contributing patches whenever we run into something.&lt;/p&gt;</comment>
                            <comment id="13227525" author="cziegeler" created="Mon, 12 Mar 2012 13:49:32 +0000"  >&lt;p&gt;Yeah, I liked this feature as well but I fear those questions in reality. A lot of interesting things could happen which in most cases might be unwanted.&lt;br/&gt;
Maybe we should just use a different way of pluggability which allows for more predictable scenarios:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;moving the default implementation of the store into a separate bundle and making the dependency required would be one solution&lt;/li&gt;
	&lt;li&gt;require people to create their own prefs bundle where the store impl has to be inside the prefs bundle would be another one&lt;br/&gt;
Not nice either....&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13733373" author="sahoo" created="Thu, 8 Aug 2013 10:56:23 +0000"  >&lt;p&gt;Since there has been no negative comments since the last patch, I am marking this issue as resolved.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12516541" name="felix-prefs-3334-2.patch" size="2160" author="jajans" created="Wed, 29 Feb 2012 10:01:10 +0000"/>
                            <attachment id="12513501" name="quickfix-new.patch" size="7732" author="jajans" created="Mon, 6 Feb 2012 21:28:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>225990</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 15 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i07glz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>41457</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>