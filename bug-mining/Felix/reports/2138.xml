<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:53:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3988] FilterHandler does not handle return of context.handleSecurity() correctly</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3988</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;This is somewhat similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-2768&quot; title=&quot;HttpContext.handleSecurity returns SC_FORBIDDEN unless response is comitted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-2768&quot;&gt;&lt;del&gt;FELIX-2768&lt;/del&gt;&lt;/a&gt;, but not resolved.&lt;/p&gt;

&lt;p&gt;The JavaDoc for HttpContext.handleSecurity states: &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;When this method returns false, the Http Service will send the response back to the client, thereby&lt;/li&gt;
	&lt;li&gt;completing the request. When this method returns true, the Http Service will proceed with servicing the&lt;/li&gt;
	&lt;li&gt;request.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The current FilterHandler impl is as follows:&lt;/p&gt;

&lt;p&gt;if (!getContext().handleSecurity(req, res)) {&lt;br/&gt;
  res.sendError(HttpServletResponse.SC_FORBIDDEN);&lt;br/&gt;
} else {&lt;br/&gt;
  this.filter.doFilter(req, res, chain);&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;1) This does not comply to the above doc, because the context might have set a status/error code and prepared everything correctly to be returned. Sending an error will overwrite the prepared headers and status.&lt;/p&gt;

&lt;p&gt;2) Some context implementations are a bit eager and already send the response back before they return &quot;false&quot; from the above method. The current implementation will then lead to an IllegalStateException, because the response has already been committed. In order to be more robust, there should be a if(!res.isCommitted())-block around the handling of the &quot;false&quot; return value.&lt;/p&gt;

&lt;p&gt;I attached a patch for the second aspect of the issue, but couldn&apos;t resolve the first part, because - as it is at the moment - there seems to be no way to check if there is already a status set on the resource (no getStatus() or isStatusSet() method).&lt;/p&gt;

&lt;p&gt;Ideally the fix should be something like:&lt;/p&gt;

&lt;p&gt;if (!res.isCommitted() &amp;amp;&amp;amp; !res.isStatusSet()) {&lt;br/&gt;
  res.sendError(SC_FORBIDDEN);&lt;br/&gt;
}&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12638265">FELIX-3988</key>
            <summary>FilterHandler does not handle return of context.handleSecurity() correctly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jajans">J.W. Janssen</assignee>
                                    <reporter username="kvgunten">Kaspar von Gunten</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Mar 2013 15:53:31 +0000</created>
                <updated>Tue, 27 Feb 2018 14:46:02 +0000</updated>
                            <resolved>Tue, 27 Feb 2018 14:46:02 +0000</resolved>
                                    <version>http-2.2.0</version>
                                    <fixVersion>http-2.3.0</fixVersion>
                                    <component>HTTP Service</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13609058" author="kvgunten" created="Thu, 21 Mar 2013 15:58:46 +0000"  >&lt;p&gt;Suggested patch to make handling of false return value by context.handleSecurity() more robust.&lt;/p&gt;

&lt;p&gt;This patch is only a partial solution to the issue, see description.&lt;/p&gt;</comment>
                            <comment id="13900129" author="jajans" created="Thu, 13 Feb 2014 08:44:45 +0000"  >&lt;p&gt;Changed your proposed patch with:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!res.isCommitted() &amp;amp;&amp;amp; res.getStatus() == SC_OK) {
    res.sendError(SC_FORBIDDEN);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As of Servlet 3.0, you can query the current status of a response. Jetty, by default, initialises the status code to &lt;tt&gt;SC_OK&lt;/tt&gt;, allowing us to make the following rule: &lt;/p&gt;

&lt;p&gt;either the &lt;tt&gt;HttpContext#handleSecurity&lt;/tt&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;committed its own response, or;&lt;/li&gt;
	&lt;li&gt;set a non-default status code.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;in which case we &lt;b&gt;won&apos;t&lt;/b&gt; send the &lt;tt&gt;SC_FORBIDDEN&lt;/tt&gt; code. In case of an uncommitted response with a default status code, we send an &lt;tt&gt;SC_FORBIDDEN&lt;/tt&gt; error.&lt;/p&gt;</comment>
                            <comment id="13900134" author="fmeschbe" created="Thu, 13 Feb 2014 08:53:20 +0000"  >&lt;p&gt;I am not really sure, that proposed fix is a good one, since the handleSecurity could expressely set SC_OK for any one reason (e.g. sending an HTML form to enter credentials) but not commit the response. In this case sending back FORBIDDEN is wrong.&lt;/p&gt;

&lt;p&gt;Maybe we could setStatus(SC_FORBIDDEN) before calling handleSecurity and if that returns false the response is just terminated (committed if needed). Otherwise (handleSecurity returns true) setStatus(SC_OK) is called and the request continues.&lt;/p&gt;

&lt;p&gt;WDYT ?&lt;/p&gt;</comment>
                            <comment id="13900150" author="jajans" created="Thu, 13 Feb 2014 09:18:14 +0000"  >&lt;p&gt;In case of filters, always setting the status to &lt;tt&gt;SC_FORBIDDEN&lt;/tt&gt; prior to calling &lt;tt&gt;HttpContext#handleSecurity&lt;/tt&gt; is also wrong in my opinion, as we&apos;re not sure that there is only &lt;b&gt;one&lt;/b&gt; filter present in the chain. It could be that another filter already set a &quot;non default&quot; status code which we would overwrite in that case.&lt;/p&gt;

&lt;p&gt;To send an HTML form to enter user credentials with a status code of &lt;tt&gt;SC_OK&lt;/tt&gt;, I think it is &quot;defendable&quot; to state that an &lt;tt&gt;HttpContext#handleSecurity&lt;/tt&gt; should commit its own response. Perhaps this could be addressed to the JavaDoc of &lt;tt&gt;HttpContext&lt;/tt&gt; or in the HTTP service update?&lt;/p&gt;</comment>
                            <comment id="13900155" author="fmeschbe" created="Thu, 13 Feb 2014 09:24:53 +0000"  >&lt;p&gt;Will the filters be called during handleSecurity at all ? I thought requests are processed like this:&lt;/p&gt;

&lt;p&gt;1. handleSecurity&lt;br/&gt;
2. REQUEST scoped filters&lt;br/&gt;
3. Servlet&lt;br/&gt;
4. more filters and servlet as per RequestDispatcher&lt;/p&gt;</comment>
                            <comment id="13900169" author="jajans" created="Thu, 13 Feb 2014 09:42:02 +0000"  >&lt;p&gt;I could be wrong, but that is not how I understand (and read) the code: the current dispatcher first dispatches the request through all available filters, which, when matching the request, all individually call &lt;tt&gt;handleSecurity&lt;/tt&gt; and proceeds by dispatching the request to the first matching servlet, which will also call &lt;tt&gt;handleSecurity&lt;/tt&gt; prior to handling the request.&lt;/p&gt;
</comment>
                            <comment id="13900203" author="fmeschbe" created="Thu, 13 Feb 2014 10:36:07 +0000"  >&lt;p&gt;Oh, you are right ! each filter is registered with an HttpContext and the handleSecurity of each of these context&apos;s is called.&lt;/p&gt;

&lt;p&gt;I have the impression, this is not how it should be. In fact, this raises a very interesting question: Should only filters be called for a servlet where all HttpContexts are the same ? Not going into this one here.&lt;/p&gt;

&lt;p&gt;So, ok, lets keep it as you proposed and reconsider later if needed.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12574817" name="FilterHandler.patch" size="253" author="kvgunten" created="Thu, 21 Mar 2013 15:58:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>318741</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1izxj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>319082</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>