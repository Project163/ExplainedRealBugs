<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:32:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3220] Multiple ClassCastException(s) when invoking OSGi Service-Hooks (EventHook, FindHook)</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3220</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;&lt;b&gt;Scenario:&lt;/b&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Register a EventHook in the OSGi service registry as described in the OSGi core specification 4.2.&lt;/li&gt;
	&lt;li&gt;Run felix with a SecurityManager&lt;/li&gt;
	&lt;li&gt;The framework is not calling the EventHook during framework service (register, modify, and unregister service) operations.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Expected Behavior&lt;/b&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The framework code calls the EventHook during framework service (register, modify, and unregister service) operations.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Current Behavior:&lt;/b&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;A ClassCastException occurs in the framework code org.apache.felix.framework.util.SecureAction:1628&lt;/li&gt;
	&lt;li&gt;Logged on &quot;WARNING&quot; Level&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Probably Caused By:&lt;/b&gt;&lt;br/&gt;
The ClassCastException is caused by calling the wrong setter-method within the org.apache.felix.framework.util.SecureAction:1135 class. &lt;br/&gt;
The ServiceEvent will never be set which causes that in line 1628 when invoking the EventHook the ServiceEvent argument is missing and parameters for the EventHook will be casted wrong.&lt;/p&gt;

&lt;p&gt;Method: org.apache.felix.framework.util.SecureAction # invokeServiceEventHook&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void invokeServiceEventHook(
        org.osgi.framework.hooks.service.EventHook eh,
        ServiceEvent event, Collection&amp;lt;BundleContext&amp;gt; contexts)
        &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
    { ....
      actions.set(Actions.INVOKE_SERVICE_EVENT_HOOK, eh, contexts);
     ....
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Method: org.apache.felix.framework.util.SecureAction.Actions # run&lt;br/&gt;
has wrong arguments: &lt;br/&gt;
arg1 = EventHook&lt;br/&gt;
arg2 = Collection&amp;lt;BundleContext&amp;gt;&lt;br/&gt;
arg3 = null&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; INVOKE_SERVICE_EVENT_HOOK:
                    ((org.osgi.framework.hooks.service.EventHook) arg1).event(
                        (ServiceEvent) arg2, (Collection&amp;lt;BundleContext&amp;gt;) arg3);
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&lt;b&gt;Solution:&lt;/b&gt;&lt;br/&gt;
Changing the method of setting the arguments for the Action class. Set also the ServiceEvent!&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void invokeServiceEventHook(
        org.osgi.framework.hooks.service.EventHook eh,
        ServiceEvent event, Collection&amp;lt;BundleContext&amp;gt; contexts)
        &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
    { ....
      actions.set(Actions.INVOKE_SERVICE_EVENT_HOOK, eh, event, contexts);
     ....
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&lt;b&gt;Additional:&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Meanwhile investigating code I found that also invoking the ServiceEventListenerHook has probably the same behavior! When calling the setter-method for setting the arguments for the Action class there is missing the ServiceEvent.&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;Invoking FindHook using wrong action constant which causes a ClassCastException!&lt;br/&gt;
Actions.INVOKE_SERVICE_EVENT_HOOK need to be changed to Actions.INVOKE_SERVICE_FIND_HOOK
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void invokeServiceFindHook(
        org.osgi.framework.hooks.service.FindHook fh,
        BundleContext context, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; filter,
        &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; allServices, Collection&amp;lt;ServiceReference&amp;lt;?&amp;gt;&amp;gt; references)
        &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
    {....
       actions.set(
                Actions.INVOKE_SERVICE_EVENT_HOOK, fh, context, name, filter,
                (allServices) ? &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.TRUE : &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.FALSE, references);
     ....}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment>Enable OSGi Security, using Felix security bundle version 2.0.0</environment>
        <key id="12531292">FELIX-3220</key>
            <summary>Multiple ClassCastException(s) when invoking OSGi Service-Hooks (EventHook, FindHook)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="karlpauls">Karl Pauls</assignee>
                                    <reporter username="michael.hirsch">Michael Hirsch</reporter>
                        <labels>
                    </labels>
                <created>Mon, 14 Nov 2011 08:52:45 +0000</created>
                <updated>Mon, 21 Nov 2011 09:39:52 +0000</updated>
                            <resolved>Fri, 18 Nov 2011 11:04:25 +0000</resolved>
                                    <version>framework-4.0.1</version>
                                    <fixVersion>framework-4.0.2</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13152783" author="karlpauls" created="Fri, 18 Nov 2011 11:04:25 +0000"  >&lt;p&gt;Yes, I think you are correct. I commited a fix (actually, I did go over all hook callbacks and did find some more of this kind of problems). Thanks a lot. Can you please test with the latest trunk and close this issue if it works for you.&lt;/p&gt;</comment>
                            <comment id="13154086" author="michael.hirsch" created="Mon, 21 Nov 2011 09:39:52 +0000"  >&lt;p&gt;I tested the EventHook and FindHook invocation and it works properly now!&lt;br/&gt;
Not tested is the invocation of other service hooks (e.g. ServiceEventListenerHook).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>217028</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 1 week, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0vwif:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>184240</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>