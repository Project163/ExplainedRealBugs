<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:14:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-6162] ConfigurationManager crashes on shutdown if PersistenceManager not yet available</title>
                <link>https://issues.apache.org/jira/browse/FELIX-6162</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;If ConfigurationManager shuts down, it tries to close the managedServiceFactoryTracker and managedServiceTracker.&lt;/p&gt;

&lt;p&gt;ConfigurationManager.stop():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-comment&quot;&gt;// stop handling ManagedService[Factory] services
&lt;/span&gt;        managedServiceFactoryTracker.close();
        managedServiceTracker.close();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In integration tests both services might not available at this time and it crashes:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.NullPointerException
             at org.apache.felix.cm.impl.ConfigurationManager.stop(ConfigurationManager.java:222)
             at org.apache.felix.cm.impl.ConfigurationAdminStarter.deactivate(ConfigurationAdminStarter.java:95)
             at org.apache.felix.cm.impl.DependencyTracker.stop(DependencyTracker.java:112)
             at org.apache.felix.cm.impl.Activator.stop(Activator.java:160)
             at org.apache.felix.framework.util.SecureAction.stopActivator(SecureAction.java:720)
             at org.apache.felix.framework.Felix.stopBundle(Felix.java:2795)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;++&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
             at org.apache.felix.framework.Felix.setActiveStartLevel(Felix.java:1557)
             at org.apache.felix.framework.FrameworkStartLevelImpl.run(FrameworkStartLevelImpl.java:308)
             at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The reason for this is that managedServiceTracker and managedServiceFactoryTracker are assigned &lt;b&gt;after&lt;/b&gt; service registration of ConfigurationAdmin in the start() method.&lt;br/&gt;
 The integration test is (sometimes) directly run after the bundleContext.registerService(ConfigurationAdmin.class, ...) line. And directly after the integration test execution the Configuration.stop() method is called where it crashes as managedServiceTracker and managedServiceFactoryTracker are still null.&lt;/p&gt;

&lt;p&gt;ConfigurationManager.start():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        configurationAdminRegistration = bundleContext.registerService(ConfigurationAdmin.class, caf,
                serviceProperties);

        &lt;span class=&quot;code-comment&quot;&gt;// start handling ManagedService[Factory] services
&lt;/span&gt;        managedServiceTracker = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ManagedServiceTracker(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
        managedServiceFactoryTracker = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ManagedServiceFactoryTracker(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Although this sounds like a rare race-condition, it is reproducible in our test environment. About 30% of the tests fail with the above exception.&lt;/p&gt;

&lt;p&gt;A simple solution would be to just add null-checks (as with every other service that is accessed in the stop() method):&lt;br/&gt;
 ConfigurationManager.stop():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-comment&quot;&gt;// stop handling ManagedService[Factory] services
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (managedServiceFactoryTracker != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
        {
            managedServiceFactoryTracker.close();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (managedServiceTracker != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
        {
            managedServiceTracker.close();
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13246821">FELIX-6162</key>
            <summary>ConfigurationManager crashes on shutdown if PersistenceManager not yet available</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cziegeler">Carsten Ziegeler</assignee>
                                    <reporter username="tobgun">Tobias Gunkel</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Jul 2019 13:15:52 +0000</created>
                <updated>Mon, 20 Jul 2020 06:33:53 +0000</updated>
                            <resolved>Fri, 26 Jul 2019 05:38:15 +0000</resolved>
                                                    <fixVersion>configadmin-1.9.18</fixVersion>
                                    <component>Configuration Admin</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="16893338" author="cziegeler" created="Fri, 26 Jul 2019 05:38:15 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tobgun&quot; class=&quot;user-hover&quot; rel=&quot;tobgun&quot;&gt;tobgun&lt;/a&gt; for reporting, it&apos;s now fixed in rev 1863771.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 16 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z04zc8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>