<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:33:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3393] Possible deadlock with reentrant calls</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3393</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;This happen when a thread which has a bundle lock has some reentrant call while the global lock is held by another thread (see stack trace below)&lt;/p&gt;

&lt;p&gt;In the code Felix#acquireBundleLock, the comment on the loop says &quot;Wait if the desired bundle is already locked by someone else or if any thread has the global lock, unless the current thread holds the global lock or the bundle lock already.&quot; which makes total sense, but I don&apos;t think the code handle the case where the lock is already held by the current thread &lt;b&gt;and&lt;/b&gt; the global lock is held by a different thread.&lt;/p&gt;

&lt;p&gt;Possible patch below.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/framework/src/main/java/org/apache/felix/framework/Felix.java b/framework/src/main/java/org/apache/felix/framework/Felix.java
index 6504f13..0965d8b 100644
--- a/framework/src/main/java/org/apache/felix/framework/Felix.java
+++ b/framework/src/main/java/org/apache/felix/framework/Felix.java
@@ -5002,7 +5002,8 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Felix &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; BundleImpl &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Framework
             &lt;span class=&quot;code-comment&quot;&gt;// holds the global lock or the bundle lock already.
&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!bundle.isLockable() ||
                 ((m_globalLockThread != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
-                    &amp;amp;&amp;amp; (m_globalLockThread != &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread())))
+                    &amp;amp;&amp;amp; (m_globalLockThread != &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread())
+                    &amp;amp;&amp;amp; (bundle.getLockingThread() != &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread())))
             {
                 &lt;span class=&quot;code-comment&quot;&gt;// Check to make sure the bundle is in a desired state.
&lt;/span&gt;                 &lt;span class=&quot;code-comment&quot;&gt;// If so, keep waiting. If not, &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; an exception.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;FelixStartLevel&quot;&lt;/span&gt; daemon prio=5 tid=7fb1b2ac7800 nid=0x111144000 in &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [111142000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (on object monitor)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
	- waiting on &amp;lt;7e039bc90&amp;gt; (a [Ljava.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:485)
	at org.apache.felix.framework.Felix.acquireBundleLock(Felix.java:5025)
	- locked &amp;lt;7e039bc90&amp;gt; (a [Ljava.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;)
	at org.apache.felix.framework.Felix.registerService(Felix.java:3282)
	at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)
	at org.apache.aries.blueprint.container.BlueprintContainerImpl.registerService(BlueprintContainerImpl.java:408)
	at org.apache.aries.blueprint.container.ServiceRecipe.register(ServiceRecipe.java:184)
	at org.apache.aries.blueprint.container.BlueprintContainerImpl.registerServices(BlueprintContainerImpl.java:666)
	at org.apache.aries.blueprint.container.BlueprintContainerImpl.doRun(BlueprintContainerImpl.java:334)
	at org.apache.aries.blueprint.container.BlueprintContainerImpl.run(BlueprintContainerImpl.java:230)
	- locked &amp;lt;7f5898750&amp;gt; (a java.util.concurrent.atomic.AtomicBoolean)
	- locked &amp;lt;7f5898740&amp;gt; (a java.util.concurrent.atomic.AtomicBoolean)
	at org.apache.aries.blueprint.container.BlueprintExtender.checkBundle(BlueprintExtender.java:325)
	at org.apache.aries.blueprint.container.BlueprintExtender.bundleChanged(BlueprintExtender.java:244)
	at org.apache.aries.blueprint.container.BlueprintExtender$BlueprintBundleTrackerCustomizer.modifiedBundle(BlueprintExtender.java:471)
	at org.osgi.util.tracker.BundleTracker$Tracked.customizerModified(BundleTracker.java:495)
	at org.osgi.util.tracker.BundleTracker$Tracked.customizerModified(BundleTracker.java:1)
	at org.osgi.util.tracker.AbstractTracked.track(AbstractTracked.java:238)
	at org.osgi.util.tracker.BundleTracker$Tracked.bundleChanged(BundleTracker.java:457)
	at org.apache.felix.framework.util.EventDispatcher.invokeBundleListenerCallback(EventDispatcher.java:870)
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:791)
	at org.apache.felix.framework.util.EventDispatcher.fireBundleEvent(EventDispatcher.java:515)
	at org.apache.felix.framework.Felix.fireBundleEvent(Felix.java:4321)
	at org.apache.felix.framework.Felix.startBundle(Felix.java:1945)
	at org.apache.felix.framework.Felix.setActiveStartLevel(Felix.java:1213)
	at org.apache.felix.framework.FrameworkStartLevelImpl.run(FrameworkStartLevelImpl.java:295)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:680)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12546394">FELIX-3393</key>
            <summary>Possible deadlock with reentrant calls</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gnodet">Guillaume Nodet</assignee>
                                    <reporter username="gnodet">Guillaume Nodet</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Mar 2012 14:07:35 +0000</created>
                <updated>Tue, 26 Jun 2012 19:01:26 +0000</updated>
                            <resolved>Mon, 2 Apr 2012 20:21:06 +0000</resolved>
                                    <version>framework-4.0.2</version>
                                    <fixVersion>framework-4.0.3</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13229219" author="rickhall" created="Wed, 14 Mar 2012 14:18:42 +0000"  >&lt;p&gt;Just out of curiousity, I did some source code archeology and it appears that this bug has existed since we switched to our current locking approach around framework 1.6.0, so it is a good catch. Not sure how often we run into this, but it is good to have it fixed.&lt;/p&gt;</comment>
                            <comment id="13242534" author="gawor@mcs.anl.gov" created="Fri, 30 Mar 2012 16:57:54 +0000"  >&lt;p&gt;I was hoping that this fix also addresses the problem we were seeing in Geronimo (which looks very similar to the original stack trace) but we are still seeing the problem. Here are the relevant stack traces:&lt;/p&gt;

&lt;p&gt;&quot;FelixShutdown&quot; prio=10 tid=0x08157c00 nid=0x5a0c in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0x30ffe000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: WAITING (on object monitor)&lt;br/&gt;
        at java.lang.Object.wait(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting on &amp;lt;0xa33ded98&amp;gt; (a java.lang.Integer)&lt;br/&gt;
        at java.lang.Object.wait(Object.java:485)&lt;br/&gt;
        at org.apache.felix.framework.FrameworkStartLevelImpl.setStartLevelAndWait(FrameworkStartLevelImpl.java:153)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0xa33ded98&amp;gt; (a java.lang.Integer)&lt;br/&gt;
        at org.apache.felix.framework.Felix$SystemBundleActivator.stop(Felix.java:4492)&lt;br/&gt;
        at org.apache.felix.framework.util.SecureAction.stopActivator(SecureAction.java:663)&lt;br/&gt;
        at org.apache.felix.framework.Felix.stopBundle(Felix.java:2361)&lt;br/&gt;
        at org.apache.felix.framework.Felix$2.run(Felix.java:882)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;&quot;Blueprint Extender: 1&quot; daemon prio=10 tid=0x086fa400 nid=0x5a09 in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0x312fb000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: WAITING (on object monitor)&lt;br/&gt;
        at java.lang.Object.wait(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting on &amp;lt;0x9f6a28f0&amp;gt; (a [Ljava.lang.Object&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
        at java.lang.Object.wait(Object.java:485)&lt;br/&gt;
        at org.apache.felix.framework.Felix.acquireBundleLock(Felix.java:4871)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x9f6a28f0&amp;gt; (a [Ljava.lang.Object&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
        at org.apache.felix.framework.Felix.registerService(Felix.java:3205)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
        at org.apache.aries.blueprint.container.BlueprintContainerImpl.registerService(BlueprintContainerImpl.java:388)&lt;br/&gt;
        at org.apache.aries.blueprint.container.BlueprintContainerImpl.doRun(BlueprintContainerImpl.java:324)&lt;br/&gt;
        at org.apache.aries.blueprint.container.BlueprintContainerImpl.run(BlueprintContainerImpl.java:213)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0xa26ec7f0&amp;gt; (a java.util.concurrent.atomic.AtomicBoolean)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0xa26ec7e0&amp;gt; (a java.util.concurrent.atomic.AtomicBoolean)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
        at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:98)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:206)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&quot;FelixStartLevel&quot; daemon prio=10 tid=0x082dcc00 nid=0x5a07 waiting for monitor entry &lt;span class=&quot;error&quot;&gt;&amp;#91;0x326c8000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: BLOCKED (on object monitor)&lt;br/&gt;
        at org.apache.aries.blueprint.container.BlueprintContainerImpl.destroy(BlueprintContainerImpl.java:810)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0xa26ec7f0&amp;gt; (a java.util.concurrent.atomic.AtomicBoolean)&lt;br/&gt;
        at org.apache.aries.blueprint.container.BlueprintExtender.destroyContext(BlueprintExtender.java:204)&lt;br/&gt;
        at org.apache.aries.blueprint.container.BlueprintExtender.bundleChanged(BlueprintExtender.java:196)&lt;br/&gt;
        at org.apache.aries.blueprint.container.BlueprintExtender$BlueprintBundleTrackerCustomizer.modifiedBundle(BlueprintExtender.java:385)&lt;br/&gt;
        at org.osgi.util.tracker.BundleTracker$Tracked.customizerModified(BundleTracker.java:453)&lt;br/&gt;
        at org.osgi.util.tracker.AbstractTracked.track(AbstractTracked.java:237)&lt;br/&gt;
        at org.osgi.util.tracker.BundleTracker$Tracked.bundleChanged(BundleTracker.java:413)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.invokeBundleListenerCallback(EventDispatcher.java:868)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:789)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireBundleEvent(EventDispatcher.java:514)&lt;br/&gt;
        at org.apache.felix.framework.Felix.fireBundleEvent(Felix.java:4244)&lt;br/&gt;
        at org.apache.felix.framework.Felix.stopBundle(Felix.java:2351)&lt;br/&gt;
        at org.apache.felix.framework.Felix.setActiveStartLevel(Felix.java:1214)&lt;br/&gt;
        at org.apache.felix.framework.FrameworkStartLevelImpl.run(FrameworkStartLevelImpl.java:298)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&quot;main&quot; prio=10 tid=0x08058c00 nid=0x470e in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0xb7410000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: TIMED_WAITING (on object monitor)&lt;br/&gt;
        at java.lang.Object.wait(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting on &amp;lt;0x9f875888&amp;gt; (a org.apache.felix.framework.util.ThreadGate)&lt;br/&gt;
        at org.apache.felix.framework.util.ThreadGate.await(ThreadGate.java:79)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x9f875888&amp;gt; (a org.apache.felix.framework.util.ThreadGate)&lt;br/&gt;
        at org.apache.felix.framework.Felix.waitForStop(Felix.java:921)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13244548" author="rickhall" created="Mon, 2 Apr 2012 20:21:06 +0000"  >&lt;p&gt;I am closing this because the Aries Blueprint issue is unrelated. If nothing else it deserves a separate bug.&lt;/p&gt;

&lt;p&gt;However, I don&apos;t see how the Aries Blueprint issue can be easily resolved by the framework. Aries is using a synchronous bundle listener to react to bundle events and it is trying to grab an internal user-code lock, which is already held by Aries extender trying to register a service on a different thread.&lt;/p&gt;

&lt;p&gt;The framework is forced to hold some locks when calling out to user code due to synchronous listeners and especially in this case since this is on the STOPPING bundle event and still has work to do. So the fact that Aries Blueprint is calling into framework code while holding its own locks creates a dangerous situation.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>231552</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 34 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i07gif:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>41441</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>