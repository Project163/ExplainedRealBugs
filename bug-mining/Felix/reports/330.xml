<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:08:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-911] Potential deadlock between Bundle.stop() and BundleContext.registerService()</title>
                <link>https://issues.apache.org/jira/browse/FELIX-911</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;When a bundle tries to register a service (in thread T1) and the framework is at the same time stopping the bundle (in thread T2), it may be that thread T2 holds the bundle&apos;s lock. T1 trying to register the service is thus blocked since it cannot get the bundle lock.&lt;/p&gt;

&lt;p&gt;This may cause a deadlock in Felix SCR, which also works with synchronized instances: T1 may be SCR Actor thread starting a component and registering a service and thus holding a lock on the component instance. T2 may be the StartLevel service trying to stop the bundle, which causes the SCR to immediately stop the component. Since the component is locked by T1, T2 cannot acquire the lock. But since T2 already has the bundle lock, T1 cannot continue.&lt;/p&gt;

&lt;p&gt;The problem is, that in this concrete case it is the Component&apos;s activate() method which registers the service and not the SCR ComponentManager (the latter deadlock situation has been taken care of in &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-384&quot; title=&quot;Possible deadlock on framework startlevel change&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-384&quot;&gt;&lt;del&gt;FELIX-384&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Looking at the code of Felix.registerService it looks like we could check for the bundle state before holding the bundle lock (and we could recheck after&lt;br/&gt;
the lock just to be sure, if needed) and thus prevent the deadlock situation.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12413602">FELIX-911</key>
            <summary>Potential deadlock between Bundle.stop() and BundleContext.registerService()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="fmeschbe">Felix Meschberger</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 Jan 2009 10:11:33 +0000</created>
                <updated>Thu, 2 May 2013 02:29:19 +0000</updated>
                            <resolved>Fri, 6 Feb 2009 18:26:44 +0000</resolved>
                                    <version>framework-1.0.0</version>
                    <version>framework-1.0.1</version>
                    <version>framework-1.0.3</version>
                    <version>framework-1.0.4</version>
                    <version>framework-1.2.0</version>
                    <version>framework-1.2.1</version>
                    <version>framework-1.2.2</version>
                    <version>framework-1.4.0</version>
                    <version>framework-1.4.1</version>
                    <version>framework-1.6.0</version>
                                    <fixVersion>framework-1.6.0</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12668801" author="fmeschbe" created="Fri, 30 Jan 2009 10:16:05 +0000"  >&lt;p&gt;Proposed patch: Do the check before and after getting the bundle lock. Check before to fail early and check after to be sure, there was no bundle state change.&lt;/p&gt;</comment>
                            <comment id="12668804" author="karlpauls" created="Fri, 30 Jan 2009 10:22:54 +0000"  >&lt;p&gt;We are currently reworking parts of the locking stuff around bundles in trunk. So perfect timing &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;I will discuss this with richard. I assume you tested your patch and it did make a difference, right?&lt;/p&gt;</comment>
                            <comment id="12668854" author="fmeschbe" created="Fri, 30 Jan 2009 12:59:27 +0000"  >&lt;p&gt;Yes, I tested it and I get an IllegalStateException now, which is then handled in the component code, which tries to register. Next the component lock is released in SCR Actor Thread T1 and the StartLevel service can continue with the shutdown in T2.&lt;/p&gt;</comment>
                            <comment id="12669653" author="rickhall" created="Mon, 2 Feb 2009 16:37:29 +0000"  >&lt;p&gt;The main issue with the patch is that it only narrows the possibility of a deadlock. I think I have an idea on how we could eliminate it in this situation, so I will try to look into it this week.&lt;/p&gt;

&lt;p&gt;The main gist is to have threads waiting for bundle locks get notified whenever the bundle state changes so they can check to see if the bundle is in the state they need and fail if it isn&apos;t. In your example, the registering thread would need the bundle to be active, when it was notified that the stopping thread caused the bundle&apos;s state to become stopping, it would return a failure for the register operation.&lt;/p&gt;</comment>
                            <comment id="12669693" author="fmeschbe" created="Mon, 2 Feb 2009 19:06:06 +0000"  >&lt;p&gt;&amp;gt; The main issue with the patch is that it only narrows the possibility of a deadlock.&lt;/p&gt;

&lt;p&gt;Unfortunately, yes.&lt;/p&gt;

&lt;p&gt;&amp;gt; I think I have an idea on how we could eliminate it in this situation, so I will try to look into it this week.&lt;/p&gt;

&lt;p&gt;Cool. Thanks.&lt;/p&gt;</comment>
                            <comment id="12671228" author="rickhall" created="Fri, 6 Feb 2009 18:26:44 +0000"  >&lt;p&gt;I have committed a patch that causes threads waiting for a bundle lock to evaluate the state of the bundle they are trying to lock and fail if the state changes in an incompatible way. I think this should address this bug, since a thread waiting to register a service will now fail if the bundle switches to the STOPPING state. Please close this issue if you are satisfied.&lt;/p&gt;</comment>
                            <comment id="12671261" author="fmeschbe" created="Fri, 6 Feb 2009 19:24:22 +0000"  >&lt;p&gt;Thanks alot. This looks good to me and it also works in my tests.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12409383">FELIX-836</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12399110" name="FELIX-911.patch" size="1185" author="fmeschbe" created="Fri, 30 Jan 2009 10:16:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>58078</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 42 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0vxzj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>184479</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>