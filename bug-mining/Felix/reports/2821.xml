<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:08:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5573] Don&apos;t return null but throw a CNFE from BundleClassloader.loadclass and Bundle.loadClass on recursive class loads.</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5573</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;We need to detect recursive class loads while invoking weaving hooks, if recursion is detected for a class name then we want to simply ignore all weave hooks for the recursive class load and allow it to proceed to define class.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13047118">FELIX-5573</key>
            <summary>Don&apos;t return null but throw a CNFE from BundleClassloader.loadclass and Bundle.loadClass on recursive class loads.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="karlpauls">Karl Pauls</assignee>
                                    <reporter username="karlpauls">Karl Pauls</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Feb 2017 22:42:09 +0000</created>
                <updated>Wed, 1 Mar 2017 15:54:01 +0000</updated>
                            <resolved>Wed, 1 Mar 2017 15:49:01 +0000</resolved>
                                    <version>framework-5.6.2</version>
                                    <fixVersion>framework-5.6.4</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15889008" author="karlpauls" created="Tue, 28 Feb 2017 22:43:53 +0000"  >&lt;p&gt;One example of this is &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5570&quot; title=&quot;Immediate service component that provides a WeavingHook results in an NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5570&quot;&gt;FELIX-5570&lt;/a&gt; where we apparently just return null (we should probably make sure we throw a CNFE if we detect a recursive class load that doesn&apos;t involve weaving hooks too) which makes it so that SCR blows up.&lt;/p&gt;</comment>
                            <comment id="15889029" author="rickhall" created="Tue, 28 Feb 2017 22:53:22 +0000"  >&lt;p&gt;Rightly or wrongly, we explicitly chose to return null in this case because we were under the assumption that this situation would only occur for internal framework operation (i.e., we didn&apos;t expect null to be returned to end user code). We explicitly check for null being returned and know we can ignore that case when we detect a cycle. So, if we just start throwing a CNFE, then we might have some difficulty ignoring it or knowing when to ignore it in the framework.&lt;/p&gt;</comment>
                            <comment id="15889096" author="djencks" created="Tue, 28 Feb 2017 23:21:37 +0000"  >&lt;p&gt;I don&apos;t see why there&apos;s a problem returning null if there&apos;s some problem such as recursion in class loading.  My question was what is supposed to happen if getService for one of the weaving hooks returns null.  If this is supposed to prevent the original class load then weaving hooks can&apos;t be DS components.  If that hook is supposed to be ignored (presumably with logging) then the original class load ought to succeed and DS succeed in creating the weaving hook.&lt;/p&gt;</comment>
                            <comment id="15889751" author="karlpauls" created="Wed, 1 Mar 2017 08:33:19 +0000"  >&lt;p&gt;I agree, it might turn out to not be a bug but I want to investigate the situation as we clearly didn&apos;t expect that it would happen due to outside conditions. I might be wrong but as far as I understood the situation we are talking about two different null values - the one for getService and the one for getting the class. I&apos;m interested in the latter - hence, this issue which may or may not be relevant for &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5570&quot; title=&quot;Immediate service component that provides a WeavingHook results in an NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5570&quot;&gt;FELIX-5570&lt;/a&gt;. It so happens that it is triggered by the use-case in there but it might need to be (or not to be) addressed regardless. &lt;/p&gt;

&lt;p&gt;I&apos;ll try to look into it soon and report back here.&lt;/p&gt;</comment>
                            <comment id="15889790" author="fmeschbe" created="Wed, 1 Mar 2017 08:49:33 +0000"  >&lt;p&gt;My understanding is like David&apos;s: I think Bundle.loadClass should not return null as this sounds unexpected, although the specification is not entirely clear. So I would sort this under the topic &quot;managing expectations&quot;.&lt;/p&gt;

&lt;p&gt;How about throwing a new &quot;ClassLoadingCircularityDetectedException extends ClassNotFoundException&quot; ? This way callers get the &quot;ClassNotFoundException&quot; while internally you can differentiate between the cases. Plus logging the exception will properly indicate the actual problem: the circularity.&lt;/p&gt;</comment>
                            <comment id="15889820" author="karlpauls" created="Wed, 1 Mar 2017 09:13:11 +0000"  >&lt;p&gt;Right, throwing some kind of CNFE might be one solution to it but first things first - right now, we don&apos;t expect to return null in the first place. This is a special case that makes that happen but we &quot;explicitly&quot; assume it will not. The relevant comment is: &lt;/p&gt;

&lt;p&gt;// If a cycle is detected, we should return null to break the&lt;br/&gt;
// cycle. This should only ever be return to internal class&lt;br/&gt;
// loading code and not to the actual instigator of the class load. &lt;/p&gt;

&lt;p&gt;It sounds like this assumption doesn&apos;t hold in the case of a class load of a class that requires to be woven &quot;by itself&quot;. In other words, we use null as a result to signal to &lt;em&gt;internal&lt;/em&gt; code that this was a cycle and needs to be dealt with accordingly. In this case our &lt;em&gt;internal&lt;/em&gt; code doesn&apos;t deal with it (or so it appears) and if that is true it needs to be addressed so that it does. That is when the question of how comes up. &lt;/p&gt;

&lt;p&gt;Whether the fix is to throw an exception or to ignore the cycle in this case and allow the class load to succeed unwoven we have to see. Regardless, it should be because we understand that this is going on and not an accident. &lt;/p&gt;</comment>
                            <comment id="15890395" author="karlpauls" created="Wed, 1 Mar 2017 15:35:54 +0000"  >&lt;p&gt;Ok, I can confirm that we do return null in this case. I created a test case that reproduces the issue. Luckily, the immediate fix seems easy. Basically, all we are missing is a check in BundleClassloader.loadClass for the class to be null and throw a CNFE in that case. This is consistent with both, bundle.loadClass and (more importantly) Classloader.loadClass API (I don&apos;t think any of the two really allow to return a null). &lt;/p&gt;

&lt;p&gt;Regarding &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5570&quot; title=&quot;Immediate service component that provides a WeavingHook results in an NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5570&quot;&gt;FELIX-5570&lt;/a&gt;, I think it will now work as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djencks&quot; class=&quot;user-hover&quot; rel=&quot;djencks&quot;&gt;djencks&lt;/a&gt; describes it above i.e., the attempt to get the WeavingHook from the service factory will cause a CNFE inside the service factory which will make it return null (or maybe an exception) which in turn, makes us ignore the weaving hook for this classload. It sounds like this should get us on par with equinox for the moment.&lt;/p&gt;

&lt;p&gt;Granted, I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjwatson&quot; class=&quot;user-hover&quot; rel=&quot;tjwatson&quot;&gt;tjwatson&lt;/a&gt; raised another question in &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5570&quot; title=&quot;Immediate service component that provides a WeavingHook results in an NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5570&quot;&gt;FELIX-5570&lt;/a&gt; namely, whether it would be possible to detect that the cycle was due to this special situation and resolve it without throwing any exception but I think that discussion can continue somewhere else. I&apos;m going to rename this issue to reflect that it is about not return null in a cycle but rather throw an CNFE.&lt;/p&gt;</comment>
                            <comment id="15890414" author="karlpauls" created="Wed, 1 Mar 2017 15:49:01 +0000"  >&lt;p&gt;I committed a test that reproduces the issue and a fix in r1784979.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13046778">FELIX-5570</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 38 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ar9j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>