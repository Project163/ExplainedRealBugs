<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:04:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5404] Annotation configurations default values are not considered</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5404</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;When an annotation is used to configure an SCR component (as per DS 1.3), the annotation&apos;s default values are not considered.&lt;/p&gt;

&lt;p&gt;This can lead to the odd situation that an annotation method with a default value returns null. I&apos;m not sure if this violates a contract or another, however, my IDE complains when I do a null check.&lt;/p&gt;

&lt;p&gt;I think it would be the right thing to do to return the default value if no value is explicitly configured.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13019811">FELIX-5404</key>
            <summary>Annotation configurations default values are not considered</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="cziegeler">Carsten Ziegeler</assignee>
                                    <reporter username="jsedding">Julian Sedding</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Nov 2016 12:01:21 +0000</created>
                <updated>Thu, 22 Dec 2016 08:46:53 +0000</updated>
                            <resolved>Wed, 21 Dec 2016 06:26:05 +0000</resolved>
                                    <version>scr-2.0.6</version>
                                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15653886" author="jsedding" created="Thu, 10 Nov 2016 12:03:37 +0000"  >&lt;p&gt;Attached patch extends the &lt;tt&gt;AnnotationTest&lt;/tt&gt; and provides a fix that makes it pass.&lt;/p&gt;

&lt;p&gt;Note: I had to update the configadmin dependency to 1.9.0-SNAPSHOT to allow the build to work.&lt;/p&gt;</comment>
                            <comment id="15747753" author="cziegeler" created="Wed, 14 Dec 2016 09:08:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jsedding&quot; class=&quot;user-hover&quot; rel=&quot;jsedding&quot;&gt;jsedding&lt;/a&gt; Can you provide a full test case? I think the SCR implementation is fine. While you&apos;re right that this case is not handled in the Annotations class, this is handled at build time and property elements are generated in the component XML for the default values. &lt;/p&gt;</comment>
                            <comment id="15748160" author="jsedding" created="Wed, 14 Dec 2016 11:59:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt; you mean a test that tests the entire stack? I&apos;ll try to find the time. Please note that I &lt;b&gt;did&lt;/b&gt; get unexpected NPEs due to missing null checks on the return values of annotation methods with default values.&lt;/p&gt;</comment>
                            <comment id="15748167" author="cziegeler" created="Wed, 14 Dec 2016 12:02:24 +0000"  >&lt;p&gt;Yes, a full test would be great or if you can point to an existing bundle and mention the things to change to experience the error.&lt;br/&gt;
I&apos;m pretty sure that the CT for Declarative Services has tests for this, but this doesn&apos;t rule out that we really have a bug here.&lt;/p&gt;</comment>
                            <comment id="15748168" author="cziegeler" created="Wed, 14 Dec 2016 12:02:26 +0000"  >&lt;p&gt;Yes, a full test would be great or if you can point to an existing bundle and mention the things to change to experience the error.&lt;br/&gt;
I&apos;m pretty sure that the CT for Declarative Services has tests for this, but this doesn&apos;t rule out that we really have a bug here.&lt;/p&gt;</comment>
                            <comment id="15750961" author="jsedding" created="Thu, 15 Dec 2016 10:00:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt; Attached is a failing integration test.&lt;/p&gt;</comment>
                            <comment id="15754417" author="cziegeler" created="Fri, 16 Dec 2016 13:26:59 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jsedding&quot; class=&quot;user-hover&quot; rel=&quot;jsedding&quot;&gt;jsedding&lt;/a&gt; - your component XML does not have the required property XML elements. These should be generated by bnd at build time.&lt;/p&gt;

&lt;p&gt;I just used your test component in a maven project, added @Component and @Activate and the XML is generated correctly including the property elements&lt;/p&gt;</comment>
                            <comment id="15760373" author="cziegeler" created="Mon, 19 Dec 2016 07:02:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jsedding&quot; class=&quot;user-hover&quot; rel=&quot;jsedding&quot;&gt;jsedding&lt;/a&gt; Thanks for your patch, I&apos;ve applied it - although as mentioned I don&apos;t think it is strictly required. The default values are already handled at build time and added as properties to the XML&lt;/p&gt;</comment>
                            <comment id="15762701" author="djencks" created="Tue, 20 Dec 2016 00:01:51 +0000"  >&lt;p&gt;My opinion is that this is not spec compliant. 112.8.2 says&lt;/p&gt;

&lt;p&gt;At build time, the component property types must be processed to potentially generate property ele- ments in the component description. See Ordering of Generated Properties on page 218.&lt;br/&gt;
At runtime, when SCR needs to call a lifecycle method on a component instance which takes an ar- gument whose type is a component property type, SCR must construct an instance of the compo- nent property type whose methods are backed by the values of the component properties for the component instance. This object is then passed to the life cycle method which can use the object to obtain the property values in a type safe manner.&lt;/p&gt;

&lt;p&gt;&amp;#8212;&lt;/p&gt;

&lt;p&gt;I think this states that the annotation methods are backed by the component properties, not by annotation default values.  I may not have explained the situation properly, but I think BJ agrees with my interpretation.&lt;/p&gt;</comment>
                            <comment id="15763347" author="cziegeler" created="Tue, 20 Dec 2016 05:50:17 +0000"  >&lt;p&gt;I agree with this as well as I tried to explain above.&lt;/p&gt;

&lt;p&gt;However, the patch does not change this behaviour - if at build time the property elements are generated everything is fine, regardless whether the patch is applied or not. But I think the code in general is more complete (not sure if that is the right word) if the helper method reverts to the default values of the annotation.&lt;/p&gt;</comment>
                            <comment id="15766256" author="cziegeler" created="Wed, 21 Dec 2016 06:19:54 +0000"  >&lt;p&gt;Further reading the spec, section 112.8.2.2 states:&lt;br/&gt;
&quot;If there is no corresponding component property for a component property type method, the component&lt;br/&gt;
property type method must:&lt;br/&gt;
&#8226; Return 0 for numerical and char method types.&lt;br/&gt;
&#8226; Return false for boolean method type.&lt;br/&gt;
&#8226; Return null for String, Class, enum and array method types.&lt;br/&gt;
&#8226; Throw a ComponentException for annotation method types.&quot;&lt;/p&gt;

&lt;p&gt;This means the behaviour before the patch was correct, I&apos;ll revert the patch and check that we exactly follow above spec text&lt;/p&gt;</comment>
                            <comment id="15766264" author="cziegeler" created="Wed, 21 Dec 2016 06:26:06 +0000"  >&lt;p&gt;As explained above, this works as expected therefore I removed the patch&lt;br/&gt;
I changed the defaults test case to verify the behaviour&lt;/p&gt;</comment>
                            <comment id="15766954" author="jsedding" created="Wed, 21 Dec 2016 12:34:03 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djencks&quot; class=&quot;user-hover&quot; rel=&quot;djencks&quot;&gt;djencks&lt;/a&gt;. It seems that my analysis of the issue I experienced was wrong and the patch addressed the symptom rather than the cause. I have done some more manual testing and have indications that the XML generated from my annotation is missing &quot;property&quot; tags when the default value of a &lt;tt&gt;String[]&lt;/tt&gt; is &quot;{}&quot;. I&apos;ll have to dig some more to figure out which tool is in use and which version is affected. Will follow up with a new issue if appropriate.&lt;/p&gt;</comment>
                            <comment id="15767689" author="djencks" created="Wed, 21 Dec 2016 18:00:15 +0000"  >&lt;p&gt;There&apos;s no way to represent an empty array as a bunch of key=value pairs, so I think bnd is working correctly in that case.  I don&apos;t recall why the default value for an array valued method is null rather than an empty array.  If you don&apos;t want to live with the IDE warnings about null checks you might investigate using felix/bnd extensions so you can use an interface instead of an annotation for the configuration properties.&lt;/p&gt;</comment>
                            <comment id="15769506" author="jsedding" created="Thu, 22 Dec 2016 08:46:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djencks&quot; class=&quot;user-hover&quot; rel=&quot;djencks&quot;&gt;djencks&lt;/a&gt; do I understand you correctly, that you are saying that it is correct that no &lt;tt&gt;&amp;lt;property/&amp;gt;&lt;/tt&gt; tag is generated for annotation methods with a default value that is an empty array? I&apos;m still reading up on the spec, so I assume your interpretation to be correct.&lt;/p&gt;

&lt;p&gt;However, if this is the case, I would argue that the SCR spec is in conflict with the Java spec section 9.6.2[0], which requires an &quot;annotation type element&quot; (i.e. a method) to be &quot;commensurate&quot; with the default value. Commensurate (in this context) is defined as follows (my words with details omitted, see section 9.7.1[1] for details):&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;An array type is commensurate with a value if the array&apos;s component type is commensurate with each of its values.&lt;/li&gt;
	&lt;li&gt;A non-array is commensurate with a value if the value is assignment compatible and &lt;b&gt;not null&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Since we are not using annotations exactly the way they were designed, I would argue that this implies that a method with a default value &lt;b&gt;must not&lt;/b&gt; return null. In my books, that would certainly be in violation of the principle of least surprise.&lt;/p&gt;

&lt;p&gt;Furthermore, the Java spec says about default values in section 9.6.2[0]:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Default values are not compiled into annotations, but rather applied dynamically at the time annotations are read. Thus, changing a default value affects annotations even in classes that were compiled before the change was made (presuming these annotations lack an explicit value for the defaulted element).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;While we are certainly not applying the default values dynamically, one could argue that we&apos;re ok here, because an annotation type with changed default values is typically deployed within a bundle that also contains a descriptor generated from the annotation type, and thus the descriptor contains the changed default values.&lt;/p&gt;

&lt;p&gt;[0] &lt;a href=&quot;http://docs.oracle.com/javase/specs/jls/se8/html/jls-9.html#jls-9.6.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/specs/jls/se8/html/jls-9.html#jls-9.6.2&lt;/a&gt;&lt;br/&gt;
[1] &lt;a href=&quot;http://docs.oracle.com/javase/specs/jls/se8/html/jls-9.html#jls-9.7.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/specs/jls/se8/html/jls-9.html#jls-9.7.1&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12843391" name="FELIX-5404-integration-test-jsedding.patch" size="9631" author="jsedding" created="Thu, 15 Dec 2016 10:00:49 +0000"/>
                            <attachment id="12838352" name="FELIX-5404-jsedding.patch" size="4576" author="jsedding" created="Thu, 10 Nov 2016 12:03:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 47 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3666v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>