<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:43:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3680] Exceptions in SCR using concurrent service activation/deactivation</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3680</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;This issue contains a sample code which reproduces many various exceptions, using a concurrent&lt;br/&gt;
scenario, where some services are enabled/disabled concurrently.&lt;/p&gt;

&lt;p&gt;I did not have time to commit an integration test about these exceptions but I will try to do.&lt;br/&gt;
In the meantime, I join to this issue my scenario ... &lt;br/&gt;
Before trying to make an integration test, could you please run the scenario, in order to confirm the problems, and that the scenario is valid ?&lt;/p&gt;

&lt;p&gt;To execute the scenario&lt;/p&gt;

&lt;p&gt;1) first, since the framework is not currently using any available log service, you have to make a modification in the framework, in order to force the framework to use a log service, when displaying caught exceptions. If you don&apos;t do this, then you will get many exceptions thrown by many threads and displayed in the console; and this is then not easy to diagnose problems.&lt;/p&gt;

&lt;p&gt;So, in the framework, in the file src/main/java/org/apache/felix/framework/Logger.java, in method setBundleContext, just uncomment the following code, which activate the fwk log service listener:&lt;/p&gt;

&lt;p&gt;    protected void setSystemBundleContext(BundleContext context)&lt;/p&gt;
    {
        // TODO: Find a way to log to a log service inside the framework.
        // The issue is that we log messages while holding framework
        // internal locks -- hence, when a log service calls back into 
        // the framework (e.g., by loading a class) we might deadlock. 
        // One instance of this problem is tracked in FELIX-536.
        // For now we just disable logging to log services inside the
        // framework. 

        m_context = context;
        startListeningForLogService();
    }

&lt;p&gt;-&amp;gt; this will make sure all logs caught by the framework are redirected to the log service, and I did not find any deadlock issue, as described in the comments.&lt;br/&gt;
Notice that even if you don&apos;t activate the log service listener, then the Exceptions are also taking place ...&lt;/p&gt;

&lt;p&gt;2) next, compile the attached concurrent scenario (it&apos;s a simple maven project).&lt;/p&gt;

&lt;p&gt;3) run the framework with the following bundles:&lt;/p&gt;

&lt;p&gt;org.apache.felix.scr from trunk&lt;br/&gt;
org.apache.felix.configadmin-1.4.0.jar&lt;/p&gt;

&lt;p&gt;4) wait for about 20 seconds, then suspend the framework, and kill it (using kill -9)&lt;br/&gt;
Don&apos;t do &quot;Ctrl-C&quot;, because this might interrupt some locked threads and some exceptions might be generated because of the Ctlr-C ... So doing a &quot;Kill -9&quot; is better.&lt;/p&gt;

&lt;p&gt;5) Then take a look at the produced &quot;./logs.txt&quot; file.&lt;/p&gt;


&lt;p&gt;scenario description:&lt;br/&gt;
===============&lt;/p&gt;

&lt;p&gt;here is a description of the Components used in the scenario:&lt;/p&gt;

&lt;p&gt;A: delayed component, enabled, depending on B,C,D,E,F&lt;br/&gt;
B,C,D,E: delayed components, disabled, without any dependencies&lt;br/&gt;
F: delayed component, disabled, depending on G&lt;br/&gt;
G: delayed component, disabled, depending on H&lt;br/&gt;
I: delayed component, disabled, depending on J&lt;br/&gt;
J: delayed component, disabled, depending on K&lt;br/&gt;
Main: depends on A. &lt;/p&gt;

&lt;p&gt;&quot;Main&quot; is the main scenario component: it uses a thread pool in order to enable B,C,D,E,F,G,H,I,J,K in parallel, randomly. &lt;/p&gt;

&lt;p&gt;&quot;Main&quot; depends on A.&lt;/p&gt;

&lt;p&gt;When B,C,D,E,F,G,H,I,J,K are enabled, then A becomes satisfied, provided and injected in the &quot;Main&quot; component.&lt;/p&gt;

&lt;p&gt;Once &quot;A&quot; is bound to &quot;Main&quot;, then B,C,D,E,F,G,H,I,J,K are then disabled in parallel, randomly. &quot;Main&quot; also checks that &quot;A&quot; is properly unbound.&lt;/p&gt;

&lt;p&gt;LogService logs are written to &quot;./logs.txt&quot;.&lt;/p&gt;

&lt;p&gt;So, running the test using scr 1.6.0 runs seamlessly. But with trunk we have many various exceptions.&lt;br/&gt;
For example, I have noticed the three following exceptions:&lt;/p&gt;

&lt;p&gt;1) we have some IllegalMontorStateException:&lt;br/&gt;
=================================&lt;/p&gt;

&lt;p&gt;log level: 1 D=Mon Sep 24 11:07:45 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;F&amp;#93;&lt;/span&gt; Locking activity before IllegalMonitorStateException: &lt;br/&gt;
  obtainWriteLock failure from: ImmediateComponentManager.ungetService.1 readLocks: 0 writeLocks: 0 thread: Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;SCR Component Actor,5,main&amp;#93;&lt;/span&gt; time: 1348477665425 Could not obtain write lock.&lt;/p&gt;

&lt;p&gt;log level: 1 D=Mon Sep 24 11:07:45 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;F&amp;#93;&lt;/span&gt; Thread dump&lt;/p&gt;


&lt;p&gt;ThreadId: 59 : name: pool-1-thread-30 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 58 : name: pool-1-thread-29 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 57 : name: pool-1-thread-28 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 56 : name: pool-1-thread-27 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 55 : name: pool-1-thread-26 State: BLOCKED&lt;br/&gt;
  LockInfo: org.apache.felix.framework.ServiceRegistry@ae533a LockOwnerId: 15 LockOwnerName: SCR Component Actor&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistry.getServiceReferences(ServiceRegistry.java:204)&lt;br/&gt;
  org.apache.felix.framework.Felix.getServiceReferences(Felix.java:3372)&lt;br/&gt;
  org.apache.felix.framework.Felix.getAllowedServiceReferences(Felix.java:3445)&lt;br/&gt;
  org.apache.felix.framework.BundleContextImpl.getServiceReferences(BundleContextImpl.java:432)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.getFrameworkServiceReferences(DependencyManager.java:658)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.getFrameworkServiceReferences(DependencyManager.java:634)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.enable(DependencyManager.java:551)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.enableDependencyManagers(AbstractComponentManager.java:1056)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.access$700(AbstractComponentManager.java:63)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager$Disabled.enable(AbstractComponentManager.java:1440)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.enableInternal(AbstractComponentManager.java:625)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.enable(AbstractComponentManager.java:358)&lt;br/&gt;
  org.apache.felix.scr.impl.config.ImmediateComponentHolder.enableComponents(ImmediateComponentHolder.java:384)&lt;br/&gt;
  org.apache.felix.scr.impl.BundleComponentActivator.enableComponent(BundleComponentActivator.java:395)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.ComponentContextImpl.enableComponent(ComponentContextImpl.java:101)&lt;br/&gt;
  test.scr.Main$EnableManager$1.run(Main.java:66)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 54 : name: pool-1-thread-25 State: BLOCKED&lt;br/&gt;
  LockInfo: org.apache.felix.framework.ServiceRegistry@ae533a LockOwnerId: 15 LockOwnerName: SCR Component Actor&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistry.getServiceReferences(ServiceRegistry.java:204)&lt;br/&gt;
  org.apache.felix.framework.Felix.getServiceReferences(Felix.java:3372)&lt;br/&gt;
  org.apache.felix.framework.Felix.getAllowedServiceReferences(Felix.java:3445)&lt;br/&gt;
  org.apache.felix.framework.BundleContextImpl.getServiceReferences(BundleContextImpl.java:432)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.getFrameworkServiceReferences(DependencyManager.java:658)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.getFrameworkServiceReferences(DependencyManager.java:634)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.enable(DependencyManager.java:551)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.enableDependencyManagers(AbstractComponentManager.java:1056)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.access$700(AbstractComponentManager.java:63)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager$Disabled.enable(AbstractComponentManager.java:1440)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.enableInternal(AbstractComponentManager.java:625)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.enable(AbstractComponentManager.java:358)&lt;br/&gt;
  org.apache.felix.scr.impl.config.ImmediateComponentHolder.enableComponents(ImmediateComponentHolder.java:384)&lt;br/&gt;
  org.apache.felix.scr.impl.BundleComponentActivator.enableComponent(BundleComponentActivator.java:395)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.ComponentContextImpl.enableComponent(ComponentContextImpl.java:101)&lt;br/&gt;
  test.scr.Main$EnableManager$1.run(Main.java:66)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 53 : name: pool-1-thread-24 State: BLOCKED&lt;br/&gt;
  LockInfo: org.apache.felix.framework.ServiceRegistry@ae533a LockOwnerId: 15 LockOwnerName: SCR Component Actor&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistry.getServiceReferences(ServiceRegistry.java:204)&lt;br/&gt;
  org.apache.felix.framework.Felix.getServiceReferences(Felix.java:3372)&lt;br/&gt;
  org.apache.felix.framework.Felix.getAllowedServiceReferences(Felix.java:3445)&lt;br/&gt;
  org.apache.felix.framework.BundleContextImpl.getServiceReferences(BundleContextImpl.java:432)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.getFrameworkServiceReferences(DependencyManager.java:658)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.getFrameworkServiceReferences(DependencyManager.java:634)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.enable(DependencyManager.java:551)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.enableDependencyManagers(AbstractComponentManager.java:1056)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.access$700(AbstractComponentManager.java:63)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager$Disabled.enable(AbstractComponentManager.java:1440)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.enableInternal(AbstractComponentManager.java:625)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.enable(AbstractComponentManager.java:358)&lt;br/&gt;
  org.apache.felix.scr.impl.config.ImmediateComponentHolder.enableComponents(ImmediateComponentHolder.java:384)&lt;br/&gt;
  org.apache.felix.scr.impl.BundleComponentActivator.enableComponent(BundleComponentActivator.java:395)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.ComponentContextImpl.enableComponent(ComponentContextImpl.java:101)&lt;br/&gt;
  test.scr.Main$EnableManager$1.run(Main.java:66)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 52 : name: pool-1-thread-23 State: BLOCKED&lt;br/&gt;
  LockInfo: org.apache.felix.framework.ServiceRegistry@ae533a LockOwnerId: 15 LockOwnerName: SCR Component Actor&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistry.getServiceReferences(ServiceRegistry.java:204)&lt;br/&gt;
  org.apache.felix.framework.Felix.getServiceReferences(Felix.java:3372)&lt;br/&gt;
  org.apache.felix.framework.Felix.getAllowedServiceReferences(Felix.java:3445)&lt;br/&gt;
  org.apache.felix.framework.BundleContextImpl.getServiceReferences(BundleContextImpl.java:432)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.getFrameworkServiceReferences(DependencyManager.java:658)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.getFrameworkServiceReferences(DependencyManager.java:634)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.enable(DependencyManager.java:551)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.enableDependencyManagers(AbstractComponentManager.java:1056)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.access$700(AbstractComponentManager.java:63)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager$Disabled.enable(AbstractComponentManager.java:1440)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.enableInternal(AbstractComponentManager.java:625)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.enable(AbstractComponentManager.java:358)&lt;br/&gt;
  org.apache.felix.scr.impl.config.ImmediateComponentHolder.enableComponents(ImmediateComponentHolder.java:384)&lt;br/&gt;
  org.apache.felix.scr.impl.BundleComponentActivator.enableComponent(BundleComponentActivator.java:395)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.ComponentContextImpl.enableComponent(ComponentContextImpl.java:101)&lt;br/&gt;
  test.scr.Main$EnableManager$1.run(Main.java:66)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 51 : name: pool-1-thread-22 State: BLOCKED&lt;br/&gt;
  LockInfo: org.apache.felix.framework.ServiceRegistry@ae533a LockOwnerId: 15 LockOwnerName: SCR Component Actor&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistry.getServiceReferences(ServiceRegistry.java:204)&lt;br/&gt;
  org.apache.felix.framework.Felix.getServiceReferences(Felix.java:3372)&lt;br/&gt;
  org.apache.felix.framework.Felix.getAllowedServiceReferences(Felix.java:3445)&lt;br/&gt;
  org.apache.felix.framework.BundleContextImpl.getServiceReferences(BundleContextImpl.java:432)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.getFrameworkServiceReferences(DependencyManager.java:658)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.getFrameworkServiceReferences(DependencyManager.java:634)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.enable(DependencyManager.java:551)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.enableDependencyManagers(AbstractComponentManager.java:1056)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.access$700(AbstractComponentManager.java:63)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager$Disabled.enable(AbstractComponentManager.java:1440)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.enableInternal(AbstractComponentManager.java:625)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.enable(AbstractComponentManager.java:358)&lt;br/&gt;
  org.apache.felix.scr.impl.config.ImmediateComponentHolder.enableComponents(ImmediateComponentHolder.java:384)&lt;br/&gt;
  org.apache.felix.scr.impl.BundleComponentActivator.enableComponent(BundleComponentActivator.java:395)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.ComponentContextImpl.enableComponent(ComponentContextImpl.java:101)&lt;br/&gt;
  test.scr.Main$EnableManager$1.run(Main.java:66)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 50 : name: pool-1-thread-21 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 49 : name: pool-1-thread-20 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 48 : name: pool-1-thread-19 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 47 : name: pool-1-thread-18 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 46 : name: pool-1-thread-17 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 45 : name: pool-1-thread-16 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 44 : name: pool-1-thread-15 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 43 : name: pool-1-thread-14 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 42 : name: pool-1-thread-13 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 41 : name: pool-1-thread-12 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 40 : name: pool-1-thread-11 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 28 : name: pool-1-thread-10 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 27 : name: pool-1-thread-9 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 26 : name: pool-1-thread-8 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 25 : name: pool-1-thread-7 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 24 : name: pool-1-thread-6 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 23 : name: pool-1-thread-5 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 22 : name: pool-1-thread-4 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 21 : name: pool-1-thread-3 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 20 : name: pool-1-thread-2 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 19 : name: pool-1-thread-1 State: WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@15d17d7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
  java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
  java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 17 : name: Thread-2 State: TIMED_WAITING&lt;br/&gt;
  LockInfo: java.util.concurrent.CountDownLatch$Sync@ba5bdb LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
  java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:196)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedNanos(AbstractQueuedSynchronizer.java:1011)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer.tryAcquireSharedNanos(AbstractQueuedSynchronizer.java:1303)&lt;br/&gt;
  java.util.concurrent.CountDownLatch.await(CountDownLatch.java:253)&lt;br/&gt;
  test.scr.Main.run(Main.java:157)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 16 : name: Thread-1 State: WAITING&lt;br/&gt;
  LockInfo: java.util.ArrayList@e49dcd LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  java.lang.Object.wait(Native Method)&lt;br/&gt;
  java.lang.Object.wait(Object.java:485)&lt;br/&gt;
  org.apache.felix.log.LogListenerThread.run(LogListenerThread.java:139)&lt;/p&gt;

&lt;p&gt;ThreadId: 15 : name: SCR Component Actor State: RUNNABLE&lt;br/&gt;
  LockInfo: null LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.management.ThreadImpl.dumpThreads0(Native Method)&lt;br/&gt;
  sun.management.ThreadImpl.dumpAllThreads(ThreadImpl.java:433)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.dumpThreads(AbstractComponentManager.java:294)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.logLockingInfo(AbstractComponentManager.java:240)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.releaseReadLock(AbstractComponentManager.java:222)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.ImmediateComponentManager.ungetService(ImmediateComponentManager.java:706)&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistrationImpl.ungetFactoryUnchecked(ServiceRegistrationImpl.java:349)&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistrationImpl.ungetService(ServiceRegistrationImpl.java:258)&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistry.ungetService(ServiceRegistry.java:389)&lt;br/&gt;
  org.apache.felix.framework.Felix.ungetService(Felix.java:3494)&lt;br/&gt;
  org.apache.felix.framework.BundleContextImpl.ungetService(BundleContextImpl.java:486)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.ungetService(DependencyManager.java:900)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.unbind(DependencyManager.java:1138)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.close(DependencyManager.java:970)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.ImmediateComponentManager.disposeImplementationObject(ImmediateComponentManager.java:274)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.ImmediateComponentManager.deleteComponent(ImmediateComponentManager.java:147)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager$Active.ungetService(AbstractComponentManager.java:1697)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.ImmediateComponentManager.ungetService(ImmediateComponentManager.java:692)&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistrationImpl.ungetFactoryUnchecked(ServiceRegistrationImpl.java:349)&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistrationImpl.ungetService(ServiceRegistrationImpl.java:258)&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistry.ungetService(ServiceRegistry.java:389)&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:158)&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:127)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.unregisterComponentService(AbstractComponentManager.java:779)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager$State.doDeactivate(AbstractComponentManager.java:1382)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager$Satisfied.deactivate(AbstractComponentManager.java:1644)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.deactivateInternal(AbstractComponentManager.java:635)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.serviceRemoved(DependencyManager.java:375)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:217)&lt;br/&gt;
  org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
  org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
  org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
  org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4327)&lt;br/&gt;
  org.apache.felix.framework.Felix.access$000(Felix.java:74)&lt;br/&gt;
  org.apache.felix.framework.Felix$1.serviceChanged(Felix.java:390)&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:148)&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:127)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.unregisterComponentService(AbstractComponentManager.java:779)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager$State.doDeactivate(AbstractComponentManager.java:1382)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager$Disabled.deactivate(AbstractComponentManager.java:1456)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.deactivateInternal(AbstractComponentManager.java:635)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager$2.run(AbstractComponentManager.java:435)&lt;br/&gt;
  org.apache.felix.scr.impl.ComponentActorThread.run(ComponentActorThread.java:98)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 14 : name: Gogo shell State: RUNNABLE&lt;br/&gt;
  LockInfo: null LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  java.io.FileInputStream.readBytes(Native Method)&lt;br/&gt;
  java.io.FileInputStream.read(FileInputStream.java:220)&lt;br/&gt;
  java.io.BufferedInputStream.fill(BufferedInputStream.java:218)&lt;br/&gt;
  java.io.BufferedInputStream.read(BufferedInputStream.java:237)&lt;br/&gt;
  org.apache.felix.gogo.runtime.threadio.ThreadInputStream.read(ThreadInputStream.java:77)&lt;br/&gt;
  org.apache.felix.gogo.shell.Console.getLine(Console.java:117)&lt;br/&gt;
  org.apache.felix.gogo.shell.Console.run(Console.java:53)&lt;br/&gt;
  org.apache.felix.gogo.shell.Shell.console(Shell.java:203)&lt;br/&gt;
  org.apache.felix.gogo.shell.Shell.gosh(Shell.java:128)&lt;br/&gt;
  sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
  sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
  sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
  java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
  org.apache.felix.gogo.runtime.Reflective.invoke(Reflective.java:137)&lt;br/&gt;
  org.apache.felix.gogo.runtime.CommandProxy.execute(CommandProxy.java:82)&lt;br/&gt;
  org.apache.felix.gogo.runtime.Closure.executeCmd(Closure.java:477)&lt;br/&gt;
  org.apache.felix.gogo.runtime.Closure.executeStatement(Closure.java:403)&lt;br/&gt;
  org.apache.felix.gogo.runtime.Pipe.run(Pipe.java:108)&lt;br/&gt;
  org.apache.felix.gogo.runtime.Closure.execute(Closure.java:183)&lt;br/&gt;
  org.apache.felix.gogo.runtime.Closure.execute(Closure.java:120)&lt;br/&gt;
  org.apache.felix.gogo.runtime.CommandSessionImpl.execute(CommandSessionImpl.java:89)&lt;br/&gt;
  org.apache.felix.gogo.shell.Activator.run(Activator.java:75)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 13 : name: CM Event Dispatcher State: WAITING&lt;br/&gt;
  LockInfo: java.util.LinkedList@13c0b53 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  java.lang.Object.wait(Native Method)&lt;br/&gt;
  java.lang.Object.wait(Object.java:485)&lt;br/&gt;
  org.apache.felix.cm.impl.UpdateThread.run(UpdateThread.java:77)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 12 : name: CM Configuration Updater State: WAITING&lt;br/&gt;
  LockInfo: java.util.LinkedList@10b9279 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  java.lang.Object.wait(Native Method)&lt;br/&gt;
  java.lang.Object.wait(Object.java:485)&lt;br/&gt;
  org.apache.felix.cm.impl.UpdateThread.run(UpdateThread.java:77)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 11 : name: FelixStartLevel State: WAITING&lt;br/&gt;
  LockInfo: java.util.ArrayList@bd6a5f LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  java.lang.Object.wait(Native Method)&lt;br/&gt;
  java.lang.Object.wait(Object.java:485)&lt;br/&gt;
  org.apache.felix.framework.FrameworkStartLevelImpl.run(FrameworkStartLevelImpl.java:273)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 10 : name: FelixDispatchQueue State: WAITING&lt;br/&gt;
  LockInfo: java.util.ArrayList@192a848 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  java.lang.Object.wait(Native Method)&lt;br/&gt;
  java.lang.Object.wait(Object.java:485)&lt;br/&gt;
  org.apache.felix.framework.util.EventDispatcher.run(EventDispatcher.java:1063)&lt;br/&gt;
  org.apache.felix.framework.util.EventDispatcher.access$000(EventDispatcher.java:54)&lt;br/&gt;
  org.apache.felix.framework.util.EventDispatcher$1.run(EventDispatcher.java:101)&lt;br/&gt;
  java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ThreadId: 4 : name: Signal Dispatcher State: RUNNABLE&lt;br/&gt;
  LockInfo: null LockOwnerId: -1 LockOwnerName: null&lt;/p&gt;

&lt;p&gt;ThreadId: 3 : name: Finalizer State: WAITING&lt;br/&gt;
  LockInfo: java.lang.ref.ReferenceQueue$Lock@16614e7 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  java.lang.Object.wait(Native Method)&lt;br/&gt;
  java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:118)&lt;br/&gt;
  java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:134)&lt;br/&gt;
  java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:159)&lt;/p&gt;

&lt;p&gt;ThreadId: 2 : name: Reference Handler State: WAITING&lt;br/&gt;
  LockInfo: java.lang.ref.Reference$Lock@e66f56 LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  java.lang.Object.wait(Native Method)&lt;br/&gt;
  java.lang.Object.wait(Object.java:485)&lt;br/&gt;
  java.lang.ref.Reference$ReferenceHandler.run(Reference.java:116)&lt;/p&gt;

&lt;p&gt;ThreadId: 1 : name: main State: WAITING&lt;br/&gt;
  LockInfo: org.apache.felix.framework.util.ThreadGate@979e8b LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  java.lang.Object.wait(Native Method)&lt;br/&gt;
  org.apache.felix.framework.util.ThreadGate.await(ThreadGate.java:79)&lt;br/&gt;
  org.apache.felix.framework.Felix.waitForStop(Felix.java:983)&lt;br/&gt;
  org.apache.felix.main.Main.main(Main.java:299)&lt;br/&gt;
log level: 1 D=Mon Sep 24 11:07:45 CEST 2012, T=Thread-1: ServiceRegistrationImpl: Error ungetting service.&lt;br/&gt;
java.lang.IllegalMonitorStateException&lt;br/&gt;
	at java.util.concurrent.locks.ReentrantReadWriteLock$Sync.tryReleaseShared(ReentrantReadWriteLock.java:363)&lt;br/&gt;
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.releaseShared(AbstractQueuedSynchronizer.java:1317)&lt;br/&gt;
	at java.util.concurrent.locks.ReentrantReadWriteLock$ReadLock.unlock(ReentrantReadWriteLock.java:745)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$JLock.unlockReadLock(AbstractComponentManager.java:1895)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.releaseReadLock(AbstractComponentManager.java:218)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.ImmediateComponentManager.ungetService(ImmediateComponentManager.java:706)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.ungetFactoryUnchecked(ServiceRegistrationImpl.java:349)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.ungetService(ServiceRegistrationImpl.java:258)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistry.ungetService(ServiceRegistry.java:389)&lt;br/&gt;
	at org.apache.felix.framework.Felix.ungetService(Felix.java:3494)&lt;br/&gt;
	at org.apache.felix.framework.BundleContextImpl.ungetService(BundleContextImpl.java:486)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.ungetService(DependencyManager.java:900)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.unbind(DependencyManager.java:1138)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.close(DependencyManager.java:970)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.ImmediateComponentManager.disposeImplementationObject(ImmediateComponentManager.java:274)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.ImmediateComponentManager.deleteComponent(ImmediateComponentManager.java:147)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$Active.ungetService(AbstractComponentManager.java:1697)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.ImmediateComponentManager.ungetService(ImmediateComponentManager.java:692)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.ungetFactoryUnchecked(ServiceRegistrationImpl.java:349)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.ungetService(ServiceRegistrationImpl.java:258)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistry.ungetService(ServiceRegistry.java:389)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:158)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:127)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.unregisterComponentService(AbstractComponentManager.java:779)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$State.doDeactivate(AbstractComponentManager.java:1382)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$Satisfied.deactivate(AbstractComponentManager.java:1644)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.deactivateInternal(AbstractComponentManager.java:635)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.serviceRemoved(DependencyManager.java:375)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:217)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4327)&lt;br/&gt;
	at org.apache.felix.framework.Felix.access$000(Felix.java:74)&lt;br/&gt;
	at org.apache.felix.framework.Felix$1.serviceChanged(Felix.java:390)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:148)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:127)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.unregisterComponentService(AbstractComponentManager.java:779)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$State.doDeactivate(AbstractComponentManager.java:1382)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$Disabled.deactivate(AbstractComponentManager.java:1456)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.deactivateInternal(AbstractComponentManager.java:635)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$2.run(AbstractComponentManager.java:435)&lt;br/&gt;
	at org.apache.felix.scr.impl.ComponentActorThread.run(ComponentActorThread.java:98)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;


&lt;p&gt;2) we also have this IllegalStateException:&lt;br/&gt;
==============================&lt;/p&gt;

&lt;p&gt;log level: 1 D=Mon Sep 24 11:07:45 CEST 2012, T=Thread-1: ServiceRegistrationImpl: Error ungetting service.&lt;br/&gt;
java.lang.IllegalStateException: ungetServiceUnsatisfied&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$State.ungetService(AbstractComponentManager.java:1336)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.ImmediateComponentManager.ungetService(ImmediateComponentManager.java:692)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.ungetFactoryUnchecked(ServiceRegistrationImpl.java:349)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.ungetService(ServiceRegistrationImpl.java:258)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistry.ungetService(ServiceRegistry.java:389)&lt;br/&gt;
	at org.apache.felix.framework.Felix.ungetService(Felix.java:3494)&lt;br/&gt;
	at org.apache.felix.framework.BundleContextImpl.ungetService(BundleContextImpl.java:486)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.ungetService(DependencyManager.java:900)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.unbind(DependencyManager.java:1138)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.close(DependencyManager.java:970)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.ImmediateComponentManager.disposeImplementationObject(ImmediateComponentManager.java:274)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.ImmediateComponentManager.deleteComponent(ImmediateComponentManager.java:147)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$Active.ungetService(AbstractComponentManager.java:1697)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.ImmediateComponentManager.ungetService(ImmediateComponentManager.java:692)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.ungetFactoryUnchecked(ServiceRegistrationImpl.java:349)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.ungetService(ServiceRegistrationImpl.java:258)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistry.ungetService(ServiceRegistry.java:389)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:158)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:127)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.unregisterComponentService(AbstractComponentManager.java:779)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$State.doDeactivate(AbstractComponentManager.java:1382)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$Satisfied.deactivate(AbstractComponentManager.java:1644)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.deactivateInternal(AbstractComponentManager.java:635)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.serviceRemoved(DependencyManager.java:375)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:217)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4327)&lt;br/&gt;
	at org.apache.felix.framework.Felix.access$000(Felix.java:74)&lt;br/&gt;
	at org.apache.felix.framework.Felix$1.serviceChanged(Felix.java:390)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:148)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:127)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.unregisterComponentService(AbstractComponentManager.java:779)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$State.doDeactivate(AbstractComponentManager.java:1382)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$Disabled.deactivate(AbstractComponentManager.java:1456)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.deactivateInternal(AbstractComponentManager.java:635)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$2.run(AbstractComponentManager.java:435)&lt;br/&gt;
	at org.apache.felix.scr.impl.ComponentActorThread.run(ComponentActorThread.java:98)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;


&lt;p&gt;3) An exception when getting a service from a Reference:&lt;br/&gt;
==============================================&lt;/p&gt;

&lt;p&gt;log level: 2 D=Mon Sep 24 11:07:45 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Could not get service from ref &lt;span class=&quot;error&quot;&gt;&amp;#91;test.scr.F&amp;#93;&lt;/span&gt;&lt;/p&gt;



&lt;p&gt;Can you please confirm that you also see these exceptions ?&lt;br/&gt;
Thanks.&lt;/p&gt;


</description>
                <environment>linux fc16, jdk1.6.032</environment>
        <key id="12608845">FELIX-3680</key>
            <summary>Exceptions in SCR using concurrent service activation/deactivation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="djencks">David Jencks</assignee>
                                    <reporter username="pderop">Pierre De Rop</reporter>
                        <labels>
                    </labels>
                <created>Mon, 24 Sep 2012 09:34:25 +0000</created>
                <updated>Sun, 31 Mar 2013 06:23:06 +0000</updated>
                            <resolved>Sun, 31 Mar 2013 06:23:06 +0000</resolved>
                                                    <fixVersion>scr-1.6.2</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13461701" author="pderop" created="Mon, 24 Sep 2012 09:35:00 +0000"  >&lt;p&gt;Attached the concurrent scenario&lt;/p&gt;</comment>
                            <comment id="13463956" author="djencks" created="Wed, 26 Sep 2012 17:06:24 +0000"  >&lt;p&gt;Could you provide more complete instructions on how to run the framework with the test?  I&apos;m too used to running stuff only in servers.  Also could you verify the problems still occur after I fixed &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3681?&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FELIX-3681?&lt;/a&gt;  There was a good chance that components would be holding onto disposed instances of references that are delayed components.&lt;/p&gt;</comment>
                            <comment id="13464607" author="pderop" created="Thu, 27 Sep 2012 10:43:04 +0000"  >&lt;p&gt;The problem also occurs with recent last commits.&lt;/p&gt;

&lt;p&gt;I have attached a second tar (test_with_fwk.tgz) which will allow you to execute the test simply, and directly.&lt;br/&gt;
(I improved logging so please ignore previous issue attachment).&lt;/p&gt;

&lt;p&gt;The test_with_fwk.tgz contains the test maven project, and also the felix fwk distribution 4.0.3 with a symbolic link to the test, in felix-framework-4.0.3/bundle/test.scr-1.0.0.jar -&amp;gt; ../../test.scr/target/test.scr-1.0.0.jar&lt;/p&gt;

&lt;p&gt;So, to start the test, go to /tmp, untar the tgz, and run the framework:&lt;/p&gt;

&lt;p&gt;   cd /tmp&lt;br/&gt;
   tar zxvf test_with_fwk.tgz&lt;br/&gt;
   cd felix-framework-4.0.3/&lt;br/&gt;
   java -jar bin/felix.jar&lt;/p&gt;


&lt;p&gt;I don&apos;t have recompiled the fwk in order to redirect stdout messages to the log service, so you will probably see many exceptions in the console stdout. &lt;br/&gt;
But you can first have a look at ./logs.txt, which contains all messages displayed by the Logservice.&lt;/p&gt;

&lt;p&gt;One last important remark: If the test does not seem to start, you will see after 10 seconds the following log in the console:&lt;/p&gt;

&lt;p&gt;g! Did not get A injected timely ... see logs.txt&lt;/p&gt;

&lt;p&gt;and in the logs.txt, you will see the states of all components at the end of the log file:&lt;/p&gt;


&lt;p&gt;cat ./logs.txt&lt;/p&gt;

&lt;p&gt;Level=2 D=12:20:52,413 T=pool-1-thread-1: enabling component G&lt;br/&gt;
Level=2 D=12:20:52,420 T=pool-1-thread-5: enabling component D&lt;br/&gt;
Level=2 D=12:20:52,420 T=pool-1-thread-2: enabling component I&lt;br/&gt;
Level=2 D=12:20:52,422 T=pool-1-thread-8: enabling component B&lt;br/&gt;
Level=2 D=12:20:52,422 T=pool-1-thread-10: enabling component E&lt;br/&gt;
Level=2 D=12:20:52,423 T=pool-1-thread-6: enabling component F&lt;br/&gt;
Level=2 D=12:20:52,424 T=pool-1-thread-4: enabling component K&lt;br/&gt;
Level=2 D=12:20:52,437 T=pool-1-thread-3: enabling component C&lt;br/&gt;
Level=2 D=12:20:52,422 T=pool-1-thread-9: enabling component H&lt;br/&gt;
Level=2 D=12:20:52,440 T=pool-1-thread-7: enabling component J&lt;br/&gt;
Level=2 D=12:20:52,472 T=pool-1-thread-11: disabling component D&lt;br/&gt;
Level=2 D=12:20:52,475 T=pool-1-thread-12: disabling component K&lt;br/&gt;
Level=2 D=12:20:52,486 T=pool-1-thread-13: disabling component I&lt;br/&gt;
Level=2 D=12:20:52,490 T=pool-1-thread-14: disabling component J&lt;br/&gt;
Level=2 D=12:20:52,492 T=pool-1-thread-16: disabling component H&lt;br/&gt;
Level=2 D=12:20:52,492 T=pool-1-thread-15: disabling component F&lt;br/&gt;
Level=2 D=12:20:52,493 T=pool-1-thread-17: disabling component C&lt;br/&gt;
Level=2 D=12:20:52,494 T=pool-1-thread-18: disabling component G&lt;br/&gt;
Level=2 D=12:20:52,495 T=pool-1-thread-19: disabling component E&lt;br/&gt;
Level=2 D=12:20:52,496 T=pool-1-thread-20: disabling component B&lt;br/&gt;
Level=2 D=12:20:52,497 T=pool-1-thread-21: enabling component C&lt;br/&gt;
Level=2 D=12:20:52,501 T=pool-1-thread-24: enabling component D&lt;br/&gt;
Level=2 D=12:20:52,503 T=pool-1-thread-22: enabling component B&lt;br/&gt;
Level=2 D=12:20:52,503 T=pool-1-thread-23: enabling component K&lt;br/&gt;
Level=2 D=12:20:52,503 T=pool-1-thread-25: enabling component F&lt;br/&gt;
Level=2 D=12:20:52,503 T=pool-1-thread-26: enabling component G&lt;br/&gt;
Level=2 D=12:20:52,504 T=pool-1-thread-27: enabling component I&lt;br/&gt;
Level=2 D=12:20:52,504 T=pool-1-thread-28: enabling component J&lt;br/&gt;
Level=2 D=12:20:52,504 T=pool-1-thread-29: enabling component E&lt;br/&gt;
Level=2 D=12:20:52,504 T=pool-1-thread-30: enabling component H&lt;/p&gt;

&lt;p&gt;Level=1 D=12:21:02,505 T=Thread-1: enableLatch TIMEOUT&lt;br/&gt;
Level=2 D=12:21:02,506 T=Thread-1: A&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; B&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; C&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; D&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; E&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; F&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; G&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; H&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; I&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; J&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; K&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; &lt;/p&gt;


&lt;p&gt;Here, no exception are thrown, but A is never satisfied while it should be (in the log above, F is unsatisfied but it should not because K is registered).&lt;/p&gt;

&lt;p&gt;Then after restarting the test a couple of times, you should see some exceptions in stdout and ./logs.txt ...&lt;/p&gt;
</comment>
                            <comment id="13464608" author="pderop" created="Thu, 27 Sep 2012 10:43:59 +0000"  >&lt;p&gt;attached the second tar gz file with framework + test sample code.&lt;/p&gt;</comment>
                            <comment id="13465127" author="djencks" created="Thu, 27 Sep 2012 21:33:49 +0000"  >&lt;p&gt;Great test!!!  I think the major problem is &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3687&quot; title=&quot;Deadlock potential from ServiceRegistry.unregisterService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3687&quot;&gt;&lt;del&gt;FELIX-3687&lt;/del&gt;&lt;/a&gt;.  There are a bunch of minor fixes within DS I&apos;m working on.&lt;/p&gt;</comment>
                            <comment id="13465128" author="djencks" created="Thu, 27 Sep 2012 21:34:35 +0000"  >&lt;p&gt;The cause of the write lock timeouts I see&lt;/p&gt;</comment>
                            <comment id="13465144" author="djencks" created="Thu, 27 Sep 2012 21:54:16 +0000"  >&lt;p&gt;DS fixes for most of the little problems are in 1391231.  I see some test runs with few exceptions other than org.osgi.framework.ServiceException: Service factory returned null.&lt;br/&gt;
 which is expected.&lt;/p&gt;</comment>
                            <comment id="13465236" author="djencks" created="Fri, 28 Sep 2012 00:03:24 +0000"  >&lt;p&gt;I fixed the last DS problem I saw in r1391266&lt;/p&gt;</comment>
                            <comment id="13465477" author="pderop" created="Fri, 28 Sep 2012 08:29:35 +0000"  >&lt;p&gt;Thanks David for the quick anwser and fixes, I will now manage to transform the sample code into an integration test and will commit it.&lt;/p&gt;

&lt;p&gt;I confirm that now, with your last fixes, I don&apos;t see anymore the two following problems:&lt;/p&gt;

&lt;p&gt;1) &lt;/p&gt;

&lt;p&gt; log level: 1 D=Mon Sep 24 11:07:45 CEST 2012, T=Thread-1: ServiceRegistrationImpl: Error ungetting service.&lt;br/&gt;
java.lang.IllegalStateException: ungetServiceUnsatisfied&lt;br/&gt;
at org.apache.felix.scr.impl.manager.AbstractComponentManager$State.ungetService(AbstractComponentManager.java:1336) &lt;/p&gt;

&lt;p&gt;2)&lt;/p&gt;

&lt;p&gt; log level: 2 D=Mon Sep 24 11:07:45 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Could not get service from ref &lt;span class=&quot;error&quot;&gt;&amp;#91;test.scr.F&amp;#93;&lt;/span&gt; &lt;/p&gt;


&lt;p&gt;But could you please clarify to me the following points:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Why Is the &quot;ServiceException:Service factory returned null&quot; problem expected ? Is it because of the &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3687&quot; title=&quot;Deadlock potential from ServiceRegistry.unregisterService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3687&quot;&gt;&lt;del&gt;FELIX-3687&lt;/del&gt;&lt;/a&gt; issue ?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m still seeing this exception. So nothing to do in DS and we have to wait for a fix from &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3687&quot; title=&quot;Deadlock potential from ServiceRegistry.unregisterService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3687&quot;&gt;&lt;del&gt;FELIX-3687&lt;/del&gt;&lt;/a&gt;, right ?&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I still sometimes see that A is never enabled and I see the log:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Level=1 D=09:38:56,17 T=Thread-1: enableLatch TIMEOUT&lt;br/&gt;
Level=2 D=09:38:56,18 T=Thread-1: A&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; B&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; C&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; D&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; E&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; F&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; G&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; H&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; I&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; J&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; K&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;Is this also related to deadlock from &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3687&quot; title=&quot;Deadlock potential from ServiceRegistry.unregisterService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3687&quot;&gt;&lt;del&gt;FELIX-3687&lt;/del&gt;&lt;/a&gt; ? I guess yes ?&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Lastly, I also still see the following exception (I think it is also related to &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3687&quot; title=&quot;Deadlock potential from ServiceRegistry.unregisterService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3687&quot;&gt;&lt;del&gt;FELIX-3687&lt;/del&gt;&lt;/a&gt;, am I correct ?) -&amp;gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Level=1 D=09:46:35,687 T=SCR Component Actor: &lt;span class=&quot;error&quot;&gt;&amp;#91;F&amp;#93;&lt;/span&gt; Locking activity before IllegalMonitorStateException:&lt;br/&gt;
  obtainWriteLock failure from: ImmediateComponentManager.ungetService.1 readLocks: 0 writeLocks: 0 thread: Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;SCR Component Actor,5,main&amp;#93;&lt;/span&gt; time: 1348818395686 Could not obtain write lock.&lt;br/&gt;
 ...&lt;br/&gt;
and in one of the threads dump, I then see:&lt;/p&gt;

&lt;p&gt;ThreadId: 15 : name: SCR Component Actor State: RUNNABLE&lt;br/&gt;
  LockInfo: null LockOwnerId: -1 LockOwnerName: null&lt;br/&gt;
  sun.management.ThreadImpl.dumpThreads0(Native Method)&lt;br/&gt;
  sun.management.ThreadImpl.dumpAllThreads(ThreadImpl.java:433)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.dumpThreads(AbstractComponentManager.java:294)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.logLockingInfo(AbstractComponentManager.java:240)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.AbstractComponentManager.releaseReadLock(AbstractComponentManager.java:222)&lt;br/&gt;
  org.apache.felix.scr.impl.manager.ImmediateComponentManager.ungetService(ImmediateComponentManager.java:710)&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistrationImpl.ungetFactoryUnchecked(ServiceRegistrationImpl.java:349)&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistrationImpl.ungetService(ServiceRegistrationImpl.java:258)&lt;br/&gt;
  org.apache.felix.framework.ServiceRegistry.ungetService(ServiceRegistry.java:389)&lt;br/&gt;
  org.apache.felix.framework.Felix.ungetService(Felix.java:3432)&lt;/p&gt;

</comment>
                            <comment id="13465705" author="djencks" created="Fri, 28 Sep 2012 16:16:04 +0000"  >&lt;p&gt;Pierre,&lt;/p&gt;

&lt;p&gt;&amp;#8211; returning null from a get service call is always expected.  There&apos;s no way to be sure that the ServiceReference you have is still valid except by trying to get the service, and if you get null back, it wasn&apos;t.  For some other kind of behavior you&apos;d have to have a way of locking the service reference to prevent any other threads from changing its state.&lt;/p&gt;

&lt;p&gt;&amp;#8211; I think the &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3687&quot; title=&quot;Deadlock potential from ServiceRegistry.unregisterService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3687&quot;&gt;&lt;del&gt;FELIX-3687&lt;/del&gt;&lt;/a&gt; problem is causing the IllegalMonitorStateExceptions and the Could not obtain write lock messages.  So far I&apos;ve concentrated on reducing the exceptions rather than completely understanding what your test is doing so I&apos;m not sure why A might not be getting enabled.&lt;/p&gt;</comment>
                            <comment id="13465762" author="djencks" created="Fri, 28 Sep 2012 17:27:58 +0000"  >&lt;p&gt;I proposed a patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3687&quot; title=&quot;Deadlock potential from ServiceRegistry.unregisterService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3687&quot;&gt;&lt;del&gt;FELIX-3687&lt;/del&gt;&lt;/a&gt; which seems to fix the deadlock.&lt;/p&gt;

&lt;p&gt;IIUC the test runs forever until A is not bound to Main or A is not unbound from Main?   Since the test eventually terminates with A not bound I think this must mean there is still a window where a service event is not processed correctly.  Probably with debug logging we could see where this is happening.&lt;/p&gt;</comment>
                            <comment id="13466380" author="djencks" created="Sun, 30 Sep 2012 01:14:47 +0000"  >&lt;p&gt;I updated the &quot;try circular dependencies again later&quot; idea from &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3557&quot; title=&quot;Tests for DS circular dependency behavior&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3557&quot;&gt;&lt;del&gt;FELIX-3557&lt;/del&gt;&lt;/a&gt; to apply to current trunk, and thought it might be useful to have an api to determine if all the async work is done, &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3692&quot; title=&quot;[DS] api for finding out if async work is done&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3692&quot;&gt;&lt;del&gt;FELIX-3692&lt;/del&gt;&lt;/a&gt;.  I think all the getService returning null exceptions are caused by the async activate/deactivate after enable/disable overlapping.  At the moment all the activate/deactivate is done on the same single thread.  Anyway I wondered what would happen if you used the proposed ScrService.waitForTasksCompleted() api either between the enable/disable and disable/enable steps in your test or just between disable/enable.  I suspect all the getService return null errors will stop.&lt;/p&gt;</comment>
                            <comment id="13466885" author="pderop" created="Mon, 1 Oct 2012 15:49:00 +0000"  >&lt;p&gt;I confirm that the &quot;could not obtain writelock&quot; exception has disappeared, after having applied the patch you proposed in &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3687&quot; title=&quot;Deadlock potential from ServiceRegistry.unregisterService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3687&quot;&gt;&lt;del&gt;FELIX-3687&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;However, I still have the two remaining problems:&lt;/p&gt;

&lt;p&gt;1) A is sometimes never satisfied with log:&lt;br/&gt;
Level=2 D=17:05:40,113 T=Thread-1: A&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; B&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; C&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; D&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; E&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; F&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; G&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; H&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; I&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; J&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; K&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;2) sometimes, main.bindA method gets a null when trying to dereference A from the bundle context.&lt;/p&gt;

&lt;p&gt;Regarding the second point, correct me if I am wrong, but I believe that the &quot;enabledLatch&quot; latch I am using should always ensure that we never get null from getService:&lt;/p&gt;

&lt;p&gt;  @Reference(type = &apos;*&apos;, service = A.class, unbind = &quot;unbindA&quot;)&lt;br/&gt;
  void bindA(ServiceReference sr) {&lt;br/&gt;
    sr.getBundle().getBundleContext().getService(sr);&lt;br/&gt;
    if (_counter.incrementAndGet() != 1) &lt;/p&gt;
{
      throw new IllegalStateException(&quot;bindA: invalid counter value: &quot; + _counter);
    }
&lt;p&gt;    _enabledLatch.countDown();&lt;br/&gt;
  }&lt;/p&gt;

&lt;p&gt;Here, the enableLatch is decremented in order to unblock the Main.run() method, which at this point should not have deactivated  B,C,D,E,F,G,H,I,J,K.&lt;br/&gt;
The enableLatch is initialized to 11 (10 for the activation of B,C,D,E,F,G,H,I,J,K, plus one additional latch (10+1=11) decremented by the Main.bindA() method call.&lt;/p&gt;

&lt;p&gt;So, to summarize, the Main.run method  does the following, in an infinite loop:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;create enabledLatch = 11&lt;/li&gt;
	&lt;li&gt;create disableLatch = 11&lt;/li&gt;
	&lt;li&gt;concurrently enable B,C,D,E,F,G,H,I,J,K (each decrement the enableLatch ten times,concurrently)&lt;/li&gt;
	&lt;li&gt;when A is available, Main.bindA is called and A service is dereferenced using sr.getBundle().getBundleContext().getService(sr);&lt;/li&gt;
	&lt;li&gt;At this point: A should be available because the Main.run() method should be blocked on the _enableLatch&lt;/li&gt;
	&lt;li&gt;Then once Main.bindA method has dereferenced the A service, it then decrements the &quot;enableLatch&quot;.&lt;/li&gt;
	&lt;li&gt;Then at this point, the Main.run() is unblocked from the enableLatch, and B,C,D,E,F,G,H,I,J,K are disabled concurrently, and the disableLatch is decremented 10 times&lt;/li&gt;
	&lt;li&gt;Then Main.unbindA method should be called and the disableLatch is then decremented (to 0)&lt;/li&gt;
	&lt;li&gt;Then Main.run is unblocked from the disableLatch and the same steps are repeated in an infinite loop.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Now, I have applied the patches from &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3557&quot; title=&quot;Tests for DS circular dependency behavior&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3557&quot;&gt;&lt;del&gt;FELIX-3557&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3692&quot; title=&quot;[DS] api for finding out if async work is done&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3692&quot;&gt;&lt;del&gt;FELIX-3692&lt;/del&gt;&lt;/a&gt;, and now I have modified the Main.run method in  order to&lt;br/&gt;
invoke _scr.waitForTasksCompleted() before disabling  B,C,D,E,F,G,H,I,J,K:&lt;/p&gt;

&lt;p&gt;      manager.enableComponents(exec);&lt;br/&gt;
      if (!_enabledLatch.await(10000, TimeUnit.MILLISECONDS)) &lt;/p&gt;
{
         ...
      }
&lt;p&gt;      _scr.waitForTasksCompleted();&lt;br/&gt;
      manager.disableComponents(exec);&lt;br/&gt;
      try {&lt;br/&gt;
        if (!_disabledLatch.await(10000, TimeUnit.MILLISECONDS)) {&lt;br/&gt;
        ...&lt;/p&gt;

&lt;p&gt;But I am getting:&lt;/p&gt;

&lt;p&gt;g! Exception in thread &quot;Thread-1&quot; java.lang.IllegalMonitorStateException&lt;br/&gt;
        at java.lang.Object.wait(Native Method)&lt;br/&gt;
        at java.lang.Object.wait(Object.java:485)&lt;br/&gt;
        at org.apache.felix.scr.impl.ComponentActorThread.waitForTasksCompleted(ComponentActorThread.java:148)&lt;br/&gt;
        at org.apache.felix.scr.impl.ComponentRegistry.waitForTasksCompleted(ComponentRegistry.java:707)&lt;br/&gt;
        at test.scr.Main.run(Main.java:148)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;So, in ComponentActorThread, I changed the method:&lt;/p&gt;

&lt;p&gt;    void waitForTasksCompleted()&lt;br/&gt;
    {&lt;br/&gt;
        synchronized ( tasks )&lt;br/&gt;
        {&lt;br/&gt;
            while ( !tasks.isEmpty() )&lt;br/&gt;
            {&lt;br/&gt;
                try&lt;/p&gt;
                {
                    wait();
                }
&lt;p&gt;                catch ( InterruptedException e )&lt;br/&gt;
                {&lt;/p&gt;

&lt;p&gt;                }&lt;br/&gt;
            }&lt;/p&gt;

&lt;p&gt;        }&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;to:&lt;/p&gt;

&lt;p&gt;    void waitForTasksCompleted()&lt;br/&gt;
    {&lt;br/&gt;
        synchronized ( tasks )&lt;br/&gt;
        {&lt;br/&gt;
            while ( !tasks.isEmpty() )&lt;br/&gt;
            {&lt;br/&gt;
                try&lt;/p&gt;
                {
                    tasks.wait();
                }
&lt;p&gt;                catch ( InterruptedException e )&lt;br/&gt;
                {&lt;/p&gt;

&lt;p&gt;                }&lt;br/&gt;
            }&lt;/p&gt;

&lt;p&gt;        }&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;(I wait on the tasks instead of this)&lt;/p&gt;

&lt;p&gt;So, no more exception but I still have sometimes null returned by getService (from Main.bindA method).&lt;/p&gt;

&lt;p&gt;But I also noticed another exception, telling that the Main.unbindA method seems to be invoked twice (but should not):&lt;/p&gt;

&lt;p&gt;ERROR: test.scr (8): &lt;span class=&quot;error&quot;&gt;&amp;#91;test.scr.Main&amp;#93;&lt;/span&gt; The unbindA method has thrown an exception&lt;br/&gt;
java.lang.IllegalStateException: unbindA: invalid counter value: -1&lt;br/&gt;
        at test.scr.Main.unbindA(Main.java:110)&lt;/p&gt;


&lt;p&gt;(I only got this exception with the patches from  &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3557&quot; title=&quot;Tests for DS circular dependency behavior&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3557&quot;&gt;&lt;del&gt;FELIX-3557&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3692&quot; title=&quot;[DS] api for finding out if async work is done&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3692&quot;&gt;&lt;del&gt;FELIX-3692&lt;/del&gt;&lt;/a&gt; + my fix in waitForTasksCompleted method).&lt;/p&gt;

</comment>
                            <comment id="13466910" author="djencks" created="Mon, 1 Oct 2012 16:25:46 +0000"  >&lt;p&gt;Pierre,&lt;/p&gt;

&lt;p&gt;Thanks for catching what to wait on &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;, that is obviously correct.&lt;/p&gt;

&lt;p&gt;I think the remaining problems of main bindA getService returning null and unbindA getting called twice may be related, but I don&apos;t understand how it can be happening.  Can you try putting a call to&lt;br/&gt;
       _scr.waitForTasksCompleted();&lt;br/&gt;
after the disabled latch countdown?  At first I thought perhaps some of the disabled components had not been deactivated by the time the new set are being enabled, but since all the async actions are put in a linked list and run in a single thread I&apos;m not sure how this could happen.&lt;/p&gt;


</comment>
                            <comment id="13467217" author="pderop" created="Mon, 1 Oct 2012 21:42:55 +0000"  >&lt;p&gt;I think that the two latches (enableLatch and disableLatch) both ensure that activation never takes place while deactivation is running.&lt;br/&gt;
Anyway, I added a call to the waitForTasksCompleted after the disable latch has reached 0, like this:&lt;/p&gt;

&lt;p&gt;-&amp;gt; &lt;/p&gt;

&lt;p&gt;    while (true) {&lt;br/&gt;
      ++ loop;&lt;br/&gt;
      if ((loop % 100) == 0) &lt;/p&gt;
{
        _logService.log(LogService.LOG_WARNING, &quot;Performed &quot; + loop + &quot; tests.&quot;);
      }
&lt;p&gt;      _enabledLatch = new CountDownLatch(11);&lt;br/&gt;
      _disabledLatch = new CountDownLatch(11);&lt;/p&gt;

&lt;p&gt;      EnableManager manager = new EnableManager(new String[] &lt;/p&gt;
{ &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;E&quot;, &quot;F&quot;, &quot;G&quot;, &quot;H&quot;, &quot;I&quot;, &quot;J&quot;,
          &quot;K&quot; }
&lt;p&gt;);&lt;br/&gt;
      manager.enableComponents(exec);&lt;/p&gt;

&lt;p&gt;      try {&lt;br/&gt;
        if (!_enabledLatch.await(10000, TimeUnit.MILLISECONDS)) &lt;/p&gt;
{
          System.out.println(&quot;Did not get A injected timely ... see logs.txt&quot;);
          _logService.log(LogService.LOG_ERROR, &quot;enableLatch TIMEOUT&quot;);
          dumpComponents();
          System.exit(1);
        }
&lt;p&gt;      } catch (InterruptedException e) {&lt;br/&gt;
      }&lt;/p&gt;

&lt;p&gt;      _scr.waitForTasksCompleted();&lt;/p&gt;

&lt;p&gt;      manager.disableComponents(exec);&lt;br/&gt;
      try {&lt;br/&gt;
        if (!_disabledLatch.await(10000, TimeUnit.MILLISECONDS)) &lt;/p&gt;
{
          System.out.println(&quot;Could not disable components timely ... see logs.txt&quot;);
          _logService.log(LogService.LOG_ERROR, &quot;disableLatch TIMEOUT&quot;);
          dumpComponents();
          System.exit(1);
        }
&lt;p&gt;      } catch (InterruptedException e) {&lt;br/&gt;
      }&lt;/p&gt;

&lt;p&gt;      _scr.waitForTasksCompleted();&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;But this does not change anything. Either I see some null returned by getService, on the enableLatch timeouts because Main is never bound to A.&lt;/p&gt;

&lt;p&gt;What is strange is that I can&apos;t reproduce the double call to Main.unbindA(A a) ...&lt;/p&gt;

&lt;p&gt;Now, I have done another test without calling at all the scr.waitForTasksCompleted() method, but this time I configured ds.loglevel=DEBUG in  felix-framework-4.0.3/conf/config.properties. And I saw the following warns which might help to make a diagnostic:&lt;/p&gt;

&lt;p&gt;(notice that now, I&apos;m using your two patches from  &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3557&quot; title=&quot;Tests for DS circular dependency behavior&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3557&quot;&gt;&lt;del&gt;FELIX-3557&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3692&quot; title=&quot;[DS] api for finding out if async work is done&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3692&quot;&gt;&lt;del&gt;FELIX-3692&lt;/del&gt;&lt;/a&gt;, but I don&apos;t call the scr.waitForTasksCompleted)&lt;/p&gt;

&lt;p&gt;-&amp;gt;&lt;/p&gt;

&lt;p&gt;Level=2 D=23:22:00,219 T=SCR Component Actor: &lt;span class=&quot;error&quot;&gt;&amp;#91;J&amp;#93;&lt;/span&gt; Could not get service from ref &lt;span class=&quot;error&quot;&gt;&amp;#91;test.scr.K&amp;#93;&lt;/span&gt;&lt;br/&gt;
Level=2 D=23:22:00,220 T=SCR Component Actor: &lt;span class=&quot;error&quot;&gt;&amp;#91;I&amp;#93;&lt;/span&gt; Could not get service from ref &lt;span class=&quot;error&quot;&gt;&amp;#91;test.scr.J&amp;#93;&lt;/span&gt;&lt;br/&gt;
Level=2 D=23:22:00,220 T=SCR Component Actor: &lt;span class=&quot;error&quot;&gt;&amp;#91;H&amp;#93;&lt;/span&gt; Could not get service from ref &lt;span class=&quot;error&quot;&gt;&amp;#91;test.scr.I&amp;#93;&lt;/span&gt;&lt;br/&gt;
Level=2 D=23:22:00,220 T=SCR Component Actor: &lt;span class=&quot;error&quot;&gt;&amp;#91;G&amp;#93;&lt;/span&gt; Could not get service from ref &lt;span class=&quot;error&quot;&gt;&amp;#91;test.scr.H&amp;#93;&lt;/span&gt;&lt;br/&gt;
Level=2 D=23:22:00,220 T=SCR Component Actor: &lt;span class=&quot;error&quot;&gt;&amp;#91;F&amp;#93;&lt;/span&gt; Could not get service from ref &lt;span class=&quot;error&quot;&gt;&amp;#91;test.scr.G&amp;#93;&lt;/span&gt;&lt;br/&gt;
Level=2 D=23:22:00,220 T=SCR Component Actor: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Could not get service from ref &lt;span class=&quot;error&quot;&gt;&amp;#91;test.scr.F&amp;#93;&lt;/span&gt;&lt;br/&gt;
Level=1 D=23:22:00,219 T=FelixDispatchQueue: FrameworkEvent: ERROR&lt;br/&gt;
org.osgi.framework.ServiceException: Service factory returned null.&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistrationImpl.getFactoryUnchecked(ServiceRegistrationImpl.java:341)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistrationImpl.getService(ServiceRegistrationImpl.java:219)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistry.getService(ServiceRegistry.java:313)&lt;br/&gt;
        at org.apache.felix.framework.Felix.getService(Felix.java:3482)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.getService(BundleContextImpl.java:468)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BindMethod.getServiceObject(BindMethod.java:562)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.prebind(DependencyManager.java:1007)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.collectDependencies(AbstractComponentManager.java:835)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.ImmediateComponentManager.getService(ImmediateComponentManager.java:622)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistrationImpl.getFactoryUnchecked(ServiceRegistrationImpl.java:308)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistrationImpl.getService(ServiceRegistrationImpl.java:219)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistry.getService(ServiceRegistry.java:313)&lt;br/&gt;
        at org.apache.felix.framework.Felix.getService(Felix.java:3482)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.getService(BundleContextImpl.java:468)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BindMethod.getServiceObject(BindMethod.java:562)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.prebind(DependencyManager.java:1007)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.collectDependencies(AbstractComponentManager.java:835)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.ImmediateComponentManager.getService(ImmediateComponentManager.java:622)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistrationImpl.getFactoryUnchecked(ServiceRegistrationImpl.java:308)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistrationImpl.getService(ServiceRegistrationImpl.java:219)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistry.getService(ServiceRegistry.java:313)&lt;/p&gt;


&lt;p&gt;So, What is the root cause of these &quot;Could not get service from ref ...&quot; warnings ?&lt;/p&gt;

&lt;p&gt;I have attached a &quot;logs_with_could_not_get_service_from_ref.txt.gz&quot; file, which contains the logs.&lt;br/&gt;
Can you please take a look at it, especially at line 3236 ? &lt;/p&gt;

&lt;p&gt;Or you can also modify the Log.log() method in order to display every LogService log levels, and try to reproduce the problem yourself (using ds.loglevel=DEBUG in the felix config.properties) ?&lt;/p&gt;

&lt;p&gt;  public void log(int level, String message, Throwable exception) {&lt;br/&gt;
    if (level &amp;lt;= 4) {&lt;br/&gt;
      ...&lt;/p&gt;

&lt;p&gt;instead of &lt;/p&gt;

&lt;p&gt;  public void log(int level, String message, Throwable exception) {&lt;br/&gt;
    if (level &amp;lt;= 2) {&lt;/p&gt;


&lt;p&gt;Anyway, I believe that now, I should work on trying to transform the sample code into an integration test ...&lt;/p&gt;</comment>
                            <comment id="13468108" author="pderop" created="Tue, 2 Oct 2012 21:52:57 +0000"  >&lt;p&gt;David, &lt;/p&gt;

&lt;p&gt;I have committed in r1393203 an integration test for this issue (Felix3680Test).&lt;/p&gt;

&lt;p&gt;The test currently fails either when getService returns null or when A is never enabled.&lt;/p&gt;

&lt;p&gt;When getService returns null, you will see the following error in TEST-org.apache.felix.scr.integration.Felix3680Test.xml:&lt;/p&gt;

&lt;p&gt;log level: 1 D=Tue Oct 02 23:12:31 CEST 2012, T=Thread-1: FrameworkEvent ERROR&lt;br/&gt;
org.apache.felix.log.LogException: org.osgi.framework.ServiceException: Service factory returned null.&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistrationImpl.getFactoryUnchecked(ServiceRegistrationImpl.java:341)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistrationImpl.getService(ServiceRegistrationImpl.java:219)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistry.getService(ServiceRegistry.java:310)&lt;br/&gt;
        at org.apache.felix.framework.Felix.getService(Felix.java:3420)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.getService(BundleContextImpl.java:468)&lt;br/&gt;
        at org.apache.felix.scr.integration.components.felix3680.Main.bindA(Main.java:112)&lt;br/&gt;
        at sun.reflect.GeneratedMethodAccessor6.invoke(Unknown Source)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod.invokeMethod(BaseMethod.java:236)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod.access$500(BaseMethod.java:37)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod$Resolved.invoke(BaseMethod.java:613)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod.invoke(BaseMethod.java:496)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethod(DependencyManager.java:1207)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethod(DependencyManager.java:1168)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.ImmediateComponentManager.invokeBindMethod(ImmediateComponentManager.java:300)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceAdded(DependencyManager.java:326)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:134)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
        at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4260)&lt;br/&gt;
        at org.apache.felix.framework.Felix.registerService(Felix.java:3275)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:741)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:724)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerComponentService(AbstractComponentManager.java:769)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager$Unsatisfied.activate(AbstractComponentManager.java:1554)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.activateInternal(AbstractComponentManager.java:630)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceAdded(DependencyManager.java:257)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:134)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
        at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4260)&lt;br/&gt;
        at org.apache.felix.framework.Felix.registerService(Felix.java:3275)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:741)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:724)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerComponentService(AbstractComponentManager.java:769)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager$Unsatisfied.activate(AbstractComponentManager.java:1554)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.activateInternal(AbstractComponentManager.java:630)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager$1.run(AbstractComponentManager.java:381)&lt;br/&gt;
        at org.apache.felix.scr.impl.ComponentActorThread.run(ComponentActorThread.java:98)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;and when A is never bound to the &quot;Main&quot; component, you will then see the log in TEST-org.apache.felix.scr.integration.Felix3680Test.xml:&lt;/p&gt;

&lt;p&gt;log level: 1 D=Tue Oct 02 23:11:07 CEST 2012, T=Thread-1: enableLatch TIMEOUT&lt;br/&gt;
log level: 2 D=Tue Oct 02 23:11:07 CEST 2012, T=Thread-1: A&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; B&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; C&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; D&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; E&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; F&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; G&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; H&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; I&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; J&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; K&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 14.313 sec &lt;/p&gt;

&lt;p&gt;Notice that I also have set ds.loglevel=warn by default in ComponentTestBase, in order to maximize concurrency.&lt;br/&gt;
(I wonder which default value we should use ? warn or debug ?)&lt;/p&gt;

&lt;p&gt;I Hope that the integration test will help ? Let me know if there is a problem with this test.&lt;/p&gt;</comment>
                            <comment id="13468188" author="djencks" created="Tue, 2 Oct 2012 23:34:55 +0000"  >&lt;p&gt;I&apos;ve been working with the standalone version of the test and think I&apos;m getting closer to understanding the problem.  After adding some logging I see (filtered for G events)&lt;/p&gt;

&lt;p&gt;Level=4 D=16:22:09,285 T=SCR Component Actor: Running task: Async Deactivate: G&lt;br/&gt;
Level=4 D=16:22:09,285 T=SCR Component Actor: &lt;span class=&quot;error&quot;&gt;&amp;#91;G&amp;#93;&lt;/span&gt; Current state: Unsatisfied, Event: deactivate (reason: 1)&lt;br/&gt;
Level=4 D=16:22:09,287 T=SCR Component Actor: Running task: Async Activate: G&lt;br/&gt;
Level=4 D=16:22:09,287 T=SCR Component Actor: &lt;span class=&quot;error&quot;&gt;&amp;#91;G&amp;#93;&lt;/span&gt; Activating component&lt;br/&gt;
Level=4 D=16:22:09,287 T=SCR Component Actor: &lt;span class=&quot;error&quot;&gt;&amp;#91;G&amp;#93;&lt;/span&gt; No change in target property for dependency h&lt;br/&gt;
Level=4 D=16:22:09,287 T=SCR Component Actor: &lt;span class=&quot;error&quot;&gt;&amp;#91;G&amp;#93;&lt;/span&gt; State transition : Unsatisfied -&amp;gt; Registered&lt;br/&gt;
Level=4 D=16:22:09,287 T=SCR Component Actor: &lt;span class=&quot;error&quot;&gt;&amp;#91;G&amp;#93;&lt;/span&gt; Existing service registration, not registering&lt;/p&gt;

&lt;p&gt;There are two peculiar things here:&lt;/p&gt;

&lt;p&gt;1. we are calling deactivate on an unsatisified component.  This is actually probably fine&lt;/p&gt;

&lt;p&gt;2. when we activate G again there is already a service registration present.  This is definitely wrong.&lt;/p&gt;

&lt;p&gt;I haven&apos;t figured out how this can happen yet.&lt;/p&gt;</comment>
                            <comment id="13468466" author="pderop" created="Wed, 3 Oct 2012 10:45:06 +0000"  >&lt;p&gt;I have updated what I committed yesterday in order to use only static/required References in A.&lt;/p&gt;

&lt;p&gt;Now I&apos;m thinking about the following, and wonder if it is related to what you observed:&lt;/p&gt;

&lt;p&gt;I realize that that when disabling components, then the disable task (that is: ComponentContext.disable method call) is done asynchronously (using the component actor thread).&lt;br/&gt;
Am I correct ? (I think you already explained this but I did not catch it ... sorry).&lt;/p&gt;

&lt;p&gt;So, it is then possible that when the Main.unbind method is called, then the _disableLatch.countDown() is called while some disable tasks are not yet executed and still scheduled in the component actor thread. At this point, the Main.run method is then unblocked form the _disableLatch, and then try to re-enable components ... while the previous disable tasks are not yet executed by the component actor thread. However, since enable tasks are also scheduled in the component actor thread queue, then all pending disable tasks should be executed before the new enable tasks ...&lt;/p&gt;

&lt;p&gt;I now start to understand why you asked me to try the (not yet committed) ScrService.waitForTasksCompleted.&lt;/p&gt;

&lt;p&gt;So, did you try to use your ScrService.waitForTasksCompleted() method from the standalone version ?&lt;/p&gt;

</comment>
                            <comment id="13468576" author="pderop" created="Wed, 3 Oct 2012 14:06:56 +0000"  >&lt;p&gt;in revision r1393476, the latches are now called from activate/deactivate methods from B/C/D/E/F/G/H/I/J/K.&lt;/p&gt;

&lt;p&gt;This makes sure that the latches are incremented or decremented from the component actor thread, where async enable/disable tasks are executed.&lt;/p&gt;

&lt;p&gt;Now, it&apos;s better: I successfully ran 93 times the loop in the Main.run method.&lt;/p&gt;

&lt;p&gt;But then after the test 94,  I&apos;m getting null returned by getService(sr) from the Main.bindA() method, &lt;br/&gt;
or sometimes, A is never injected to Main.&lt;/p&gt;






</comment>
                            <comment id="13468763" author="djencks" created="Wed, 3 Oct 2012 19:35:24 +0000"  >&lt;p&gt;I found a couple more problems that I fixed in rev 1393716.  If I run the standalone test with ds.loglevel=debug then I get OOM errors from the lock logging.  If I disable this I can run the standalone test for several minutes without errors.  The testsuite test still fails but I haven&apos;t looked at why yet.&lt;/p&gt;</comment>
                            <comment id="13469283" author="pderop" created="Thu, 4 Oct 2012 10:44:25 +0000"  >&lt;p&gt;I confirm that now,  my standalone test goes further, and the committed integration test also goes further.&lt;br/&gt;
But both tests end up failing.&lt;/p&gt;

&lt;p&gt;For instance, I have the following logs with the integration test: the Main.run method did one successful iteration, but then failed with the second one, because A is not enabled timely&lt;br/&gt;
(see at the end of the logs: enableLatch TIMEOUT)&lt;/p&gt;

&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;log level: 2 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: ******* Performed 1 tests.&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;K&amp;#93;&lt;/span&gt; invoked deactivate: stop&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;K&amp;#93;&lt;/span&gt; Unset implementation object for component K in deleteComponent&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;G&amp;#93;&lt;/span&gt; Enabling Component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;G&amp;#93;&lt;/span&gt; No change in target property for dependency h&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;G&amp;#93;&lt;/span&gt; Registered for service events, currently 0 service(s) match the filter&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;G&amp;#93;&lt;/span&gt; State transition : Disabled -&amp;gt; Unsatisfied : service reg: null&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;G&amp;#93;&lt;/span&gt; Component enabled&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Adding task &lt;span class=&quot;error&quot;&gt;&amp;#91;Async Activate: G&amp;#93;&lt;/span&gt; as #1 in the queue&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Running task: Async Activate: G&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;G&amp;#93;&lt;/span&gt; Activating component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;G&amp;#93;&lt;/span&gt; No change in target property for dependency h&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;G&amp;#93;&lt;/span&gt; Dependency not satisfied: h&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;G&amp;#93;&lt;/span&gt; Not all dependencies satisfied, cannot activate&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;D&amp;#93;&lt;/span&gt; Enabling Component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;D&amp;#93;&lt;/span&gt; State transition : Disabled -&amp;gt; Unsatisfied : service reg: null&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;D&amp;#93;&lt;/span&gt; Component enabled&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Adding task &lt;span class=&quot;error&quot;&gt;&amp;#91;Async Activate: D&amp;#93;&lt;/span&gt; as #1 in the queue&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Running task: Async Activate: D&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;D&amp;#93;&lt;/span&gt; Activating component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;D&amp;#93;&lt;/span&gt; State transition : Unsatisfied -&amp;gt; Registered : service reg: null&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;D&amp;#93;&lt;/span&gt; registering services&lt;br/&gt;
log level: 3 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: ServiceEvent REGISTERED&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency Manager: Adding Service org.apache.felix.scr.integration.components.felix3680.D/25&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency Manager: Service d registered, activate component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Activating component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency b&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency not satisfied: b&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency c&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency not satisfied: c&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency d&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency e&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency not satisfied: e&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency f&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency not satisfied: f&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Not all dependencies satisfied, cannot activate&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency Manager: Service d activation on other thread bound service reference &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.felix.scr.integration.components.felix3680.D&amp;#93;&lt;/span&gt;&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;I&amp;#93;&lt;/span&gt; Enabling Component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;I&amp;#93;&lt;/span&gt; No change in target property for dependency j&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;I&amp;#93;&lt;/span&gt; Registered for service events, currently 0 service(s) match the filter&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;I&amp;#93;&lt;/span&gt; State transition : Disabled -&amp;gt; Unsatisfied : service reg: null&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;I&amp;#93;&lt;/span&gt; Component enabled&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Adding task &lt;span class=&quot;error&quot;&gt;&amp;#91;Async Activate: I&amp;#93;&lt;/span&gt; as #1 in the queue&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Running task: Async Activate: I&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;I&amp;#93;&lt;/span&gt; Activating component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;I&amp;#93;&lt;/span&gt; No change in target property for dependency j&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;I&amp;#93;&lt;/span&gt; Dependency not satisfied: j&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;I&amp;#93;&lt;/span&gt; Not all dependencies satisfied, cannot activate&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;C&amp;#93;&lt;/span&gt; Enabling Component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;C&amp;#93;&lt;/span&gt; State transition : Disabled -&amp;gt; Unsatisfied : service reg: null&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;C&amp;#93;&lt;/span&gt; Component enabled&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Adding task &lt;span class=&quot;error&quot;&gt;&amp;#91;Async Activate: C&amp;#93;&lt;/span&gt; as #1 in the queue&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Running task: Async Activate: C&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;C&amp;#93;&lt;/span&gt; Activating component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;C&amp;#93;&lt;/span&gt; State transition : Unsatisfied -&amp;gt; Registered : service reg: null&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;C&amp;#93;&lt;/span&gt; registering services&lt;br/&gt;
log level: 3 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: ServiceEvent REGISTERED&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency Manager: Adding Service org.apache.felix.scr.integration.components.felix3680.C/26&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency Manager: Service c registered, activate component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Activating component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency b&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency not satisfied: b&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency c&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency d&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency e&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency not satisfied: e&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency f&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency not satisfied: f&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Not all dependencies satisfied, cannot activate&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency Manager: Service c activation on other thread bound service reference &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.felix.scr.integration.components.felix3680.C&amp;#93;&lt;/span&gt;&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;B&amp;#93;&lt;/span&gt; Enabling Component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;B&amp;#93;&lt;/span&gt; State transition : Disabled -&amp;gt; Unsatisfied : service reg: null&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;B&amp;#93;&lt;/span&gt; Component enabled&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Adding task &lt;span class=&quot;error&quot;&gt;&amp;#91;Async Activate: B&amp;#93;&lt;/span&gt; as #1 in the queue&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Running task: Async Activate: B&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;B&amp;#93;&lt;/span&gt; Activating component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;B&amp;#93;&lt;/span&gt; State transition : Unsatisfied -&amp;gt; Registered : service reg: null&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;B&amp;#93;&lt;/span&gt; registering services&lt;br/&gt;
log level: 3 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: ServiceEvent REGISTERED&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency Manager: Adding Service org.apache.felix.scr.integration.components.felix3680.B/27&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency Manager: Service b registered, activate component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Activating component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency b&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency c&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency d&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency e&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency not satisfied: e&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency f&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency not satisfied: f&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Not all dependencies satisfied, cannot activate&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency Manager: Service b activation on other thread bound service reference &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.felix.scr.integration.components.felix3680.B&amp;#93;&lt;/span&gt;&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;E&amp;#93;&lt;/span&gt; Enabling Component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;E&amp;#93;&lt;/span&gt; State transition : Disabled -&amp;gt; Unsatisfied : service reg: null&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;E&amp;#93;&lt;/span&gt; Component enabled&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Adding task &lt;span class=&quot;error&quot;&gt;&amp;#91;Async Activate: E&amp;#93;&lt;/span&gt; as #1 in the queue&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Running task: Async Activate: E&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;E&amp;#93;&lt;/span&gt; Activating component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;E&amp;#93;&lt;/span&gt; State transition : Unsatisfied -&amp;gt; Registered : service reg: null&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;F&amp;#93;&lt;/span&gt; Enabling Component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;E&amp;#93;&lt;/span&gt; registering services&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;F&amp;#93;&lt;/span&gt; No change in target property for dependency g&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;F&amp;#93;&lt;/span&gt; Registered for service events, currently 0 service(s) match the filter&lt;br/&gt;
log level: 3 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: ServiceEvent REGISTERED&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;F&amp;#93;&lt;/span&gt; State transition : Disabled -&amp;gt; Unsatisfied : service reg: null&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;F&amp;#93;&lt;/span&gt; Component enabled&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Adding task &lt;span class=&quot;error&quot;&gt;&amp;#91;Async Activate: F&amp;#93;&lt;/span&gt; as #1 in the queue&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency Manager: Adding Service org.apache.felix.scr.integration.components.felix3680.E/28&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency Manager: Service e registered, activate component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Activating component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency b&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency c&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency d&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency e&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; No change in target property for dependency f&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency not satisfied: f&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Not all dependencies satisfied, cannot activate&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Dependency Manager: Service e activation on other thread bound service reference &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.felix.scr.integration.components.felix3680.E&amp;#93;&lt;/span&gt;&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Running task: Async Activate: F&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;F&amp;#93;&lt;/span&gt; Activating component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;K&amp;#93;&lt;/span&gt; Enabling Component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;F&amp;#93;&lt;/span&gt; No change in target property for dependency g&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;F&amp;#93;&lt;/span&gt; Dependency not satisfied: g&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;K&amp;#93;&lt;/span&gt; State transition : Disabled -&amp;gt; Unsatisfied : service reg: null&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;F&amp;#93;&lt;/span&gt; Not all dependencies satisfied, cannot activate&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;K&amp;#93;&lt;/span&gt; Component enabled&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Adding task &lt;span class=&quot;error&quot;&gt;&amp;#91;Async Activate: K&amp;#93;&lt;/span&gt; as #1 in the queue&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;J&amp;#93;&lt;/span&gt; Enabling Component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;J&amp;#93;&lt;/span&gt; No change in target property for dependency k&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Running task: Async Activate: K&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;K&amp;#93;&lt;/span&gt; Activating component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;K&amp;#93;&lt;/span&gt; State transition : Unsatisfied -&amp;gt; Registered : service reg: null&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;K&amp;#93;&lt;/span&gt; registering services&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;J&amp;#93;&lt;/span&gt; Registered for service events, currently 0 service(s) match the filter&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;J&amp;#93;&lt;/span&gt; State transition : Disabled -&amp;gt; Unsatisfied : service reg: null&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;J&amp;#93;&lt;/span&gt; Component enabled&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Adding task &lt;span class=&quot;error&quot;&gt;&amp;#91;Async Activate: J&amp;#93;&lt;/span&gt; as #1 in the queue&lt;br/&gt;
log level: 3 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: ServiceEvent REGISTERED&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;H&amp;#93;&lt;/span&gt; Enabling Component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;H&amp;#93;&lt;/span&gt; No change in target property for dependency i&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Running task: Async Activate: J&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;H&amp;#93;&lt;/span&gt; Registered for service events, currently 0 service(s) match the filter&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;J&amp;#93;&lt;/span&gt; Activating component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;H&amp;#93;&lt;/span&gt; State transition : Disabled -&amp;gt; Unsatisfied : service reg: null&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;H&amp;#93;&lt;/span&gt; Component enabled&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;J&amp;#93;&lt;/span&gt; No change in target property for dependency k&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;J&amp;#93;&lt;/span&gt; Dependency not satisfied: k&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Adding task &lt;span class=&quot;error&quot;&gt;&amp;#91;Async Activate: H&amp;#93;&lt;/span&gt; as #1 in the queue&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;J&amp;#93;&lt;/span&gt; Not all dependencies satisfied, cannot activate&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: Running task: Async Activate: H&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;H&amp;#93;&lt;/span&gt; Activating component&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;H&amp;#93;&lt;/span&gt; No change in target property for dependency i&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;H&amp;#93;&lt;/span&gt; Dependency not satisfied: i&lt;br/&gt;
log level: 4 D=Thu Oct 04 11:48:04 CEST 2012, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;H&amp;#93;&lt;/span&gt; Not all dependencies satisfied, cannot activate&lt;/p&gt;

&lt;p&gt;&amp;gt; here, there is a timeout on  _enableLatch: -&amp;gt;&lt;br/&gt;
log level: 1 D=Thu Oct 04 11:48:14 CEST 2012, T=Thread-1: enableLatch TIMEOUT&lt;br/&gt;
log level: 2 D=Thu Oct 04 11:48:14 CEST 2012, T=Thread-1: A&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; B&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; C&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; D&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; E&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; F&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; G&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; H&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; I&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; J&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; K&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;A is not enabled because F remains unsatisfied; but F should be registered because K is registered (F &amp;gt; G &amp;gt; H &amp;gt; I &amp;gt; J &amp;gt; K).&lt;/p&gt;</comment>
                            <comment id="13470058" author="djencks" created="Fri, 5 Oct 2012 06:48:19 +0000"  >&lt;p&gt;I&apos;m pretty sure that I found another problem and the test sometimes hits it.&lt;/p&gt;

&lt;p&gt;DependencyManager.enable does this:&lt;/p&gt;

&lt;p&gt;            ServiceReference refs[] = getFrameworkServiceReferences();&lt;br/&gt;
            m_size = ( refs == null ) ? 0 : refs.length;&lt;br/&gt;
            // register the service listener&lt;br/&gt;
            String filterString = &quot;(&quot; + Constants.OBJECTCLASS + &quot;=&quot; + m_dependencyMetadata.getInterface() + &quot;)&quot;;&lt;br/&gt;
            m_componentManager.getActivator().getBundleContext().addServiceListener( this, filterString );&lt;/p&gt;

&lt;p&gt;In between getting the initial service references and registering the listener, other threads can register more services that will never be seen by the dependency manager.&lt;/p&gt;

&lt;p&gt;The service tracker solves this problem by registering the service listener first.  The code to avoid duplicates is rather complicated and I don&apos;t think I can imitate it successfully.  I&apos;m going to see about basing the dependency manager on a service tracker.  The ServiceTrackerCustomizer will return RefPairs so we can get the service later as needed.&lt;/p&gt;</comment>
                            <comment id="13470066" author="pderop" created="Fri, 5 Oct 2012 07:13:34 +0000"  >&lt;p&gt;I have experimented the following work around, which seems to resolve many concurrency issues in the felix 1.6.0.&lt;br/&gt;
And I wonder if it might also be helpful or not in the trunk:&lt;/p&gt;

&lt;p&gt;in the scr 1.6.0, I&apos;m using the following SerialExecutor from Neil Bartlett free osgi book, and slightly adapted it in order to allow it to be reentrant, and plugged it in the DependencyManager, when getting called in the serviceChanged method.&lt;/p&gt;

&lt;p&gt;what I like with this is that concurrent service events can be handled by the serial executor without holding any locks, but of course the serial executor also has the drawback of serializing every multi thread events in one single worker thread ...&lt;/p&gt;

&lt;p&gt;In DependencyManager:&lt;/p&gt;

&lt;p&gt;+++ src/main/java/org/apache/felix/scr/impl/manager/DependencyManager.java      (working copy)&lt;br/&gt;
@@ -31,6 +31,7 @@&lt;br/&gt;
 import org.apache.felix.scr.Reference;&lt;br/&gt;
 import org.apache.felix.scr.impl.BundleComponentActivator;&lt;br/&gt;
 import org.apache.felix.scr.impl.helper.BindMethod;&lt;br/&gt;
+import org.apache.felix.scr.impl.helper.SerialExecutor;&lt;br/&gt;
 import org.apache.felix.scr.impl.helper.UnbindMethod;&lt;br/&gt;
 import org.apache.felix.scr.impl.helper.UpdatedMethod;&lt;br/&gt;
 import org.apache.felix.scr.impl.metadata.ReferenceMetadata;&lt;br/&gt;
@@ -151,8 +152,15 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Called when a registered service changes state. In the case of service&lt;/li&gt;
	&lt;li&gt;modification the service is assumed to be removed and added again.&lt;br/&gt;
      */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void serviceChanged( ServiceEvent event )&lt;br/&gt;
+    public void serviceChanged( final ServiceEvent event )&lt;br/&gt;
     {&lt;br/&gt;
+      SerialExecutor.INSTANCE.execute(new Runnable() {&lt;br/&gt;
+        public void run() {&lt;br/&gt;
+          _serviceChanged(event);&lt;br/&gt;
+        }});&lt;br/&gt;
+    }&lt;br/&gt;
+    public void _serviceChanged( ServiceEvent event ) &lt;br/&gt;
+    {&lt;br/&gt;
          ...&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;and here is the adapted (reentrant) SerialExecutor:&lt;/p&gt;

&lt;p&gt;package org.apache.felix.scr.impl.helper;&lt;/p&gt;

&lt;p&gt;import java.util.ArrayList;&lt;br/&gt;
import java.util.List;&lt;br/&gt;
import java.util.concurrent.Executor;&lt;/p&gt;

&lt;p&gt;import org.apache.felix.scr.impl.Activator;&lt;br/&gt;
import org.osgi.service.log.LogService;&lt;/p&gt;

&lt;p&gt;public class SerialExecutor implements Executor {&lt;br/&gt;
  public final static SerialExecutor INSTANCE = new SerialExecutor();&lt;br/&gt;
  private final List queue = new ArrayList();&lt;br/&gt;
  private Thread _runningThread;&lt;/p&gt;

&lt;p&gt;  public void execute(Runnable command) {&lt;br/&gt;
    Runnable next = null;&lt;br/&gt;
    Thread currThread = Thread.currentThread();&lt;br/&gt;
    boolean runImmediately = false;&lt;/p&gt;

&lt;p&gt;    synchronized (this) {&lt;br/&gt;
      if (_runningThread == null) &lt;/p&gt;
{
        _runningThread = currThread;
      }
&lt;p&gt; else if (_runningThread == currThread) &lt;/p&gt;
{
        runImmediately = true;
      }

&lt;p&gt;      if (! runImmediately) &lt;/p&gt;
{
        next = queue.isEmpty() ? command : null;
        queue.add(command);
      }
&lt;p&gt;    }&lt;/p&gt;

&lt;p&gt;    if (runImmediately) &lt;/p&gt;
{
      runTask(command);
      return;
    }

&lt;p&gt;    while (next != null) {&lt;br/&gt;
      runTask(next);&lt;br/&gt;
      synchronized (this) {&lt;br/&gt;
        queue.remove(0);&lt;br/&gt;
        next = queue.isEmpty() ? null : (Runnable) queue.get(0);&lt;br/&gt;
        if (next == null) &lt;/p&gt;
{
          _runningThread = null;
        }
&lt;p&gt;      }&lt;br/&gt;
    }&lt;br/&gt;
  }&lt;/p&gt;

&lt;p&gt;  private void runTask(Runnable command) {&lt;br/&gt;
    try &lt;/p&gt;
{
      command.run();
    }
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
{
      Activator.log(LogService.LOG_ERROR, null, &quot;Error processing tasks&quot;, t);
    }
&lt;p&gt;  }&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;Of course, this fully breaks concurrency and the SerialExecutor should also be plugged when handling configuration events, may be ...&lt;/p&gt;

&lt;p&gt;I have tried this with felix 1.6.0 because I had many concurrency issues in the old release, but I will try this with the trunk and see how the integration test is working or not.&lt;/p&gt;

&lt;p&gt;what do you think ?&lt;/p&gt;</comment>
                            <comment id="13470462" author="djencks" created="Fri, 5 Oct 2012 17:04:56 +0000"  >&lt;p&gt;I&apos;m not happy with the default situation being that service events return before the response to them is complete.  In my proposed circular dependency resolve-later scheme, when there&apos;s a problem responding to the event synchronously we try again asynchronously but I think that the default needs to be to complete the response before returning.&lt;/p&gt;

&lt;p&gt;If we were to do this single-threading I think we could use the ComponentActorThread.  We might also consider replacing the ComponentActorThread with an injected executor which might of course bring a whole new set of problems.&lt;/p&gt;</comment>
                            <comment id="13470682" author="pderop" created="Fri, 5 Oct 2012 21:31:14 +0000"  >&lt;p&gt;FYI, I tried to plug the SerialExecutor in the trunk, but it sounds like that the problem is the same: at some point in time, A is not injected to Main.&lt;/p&gt;</comment>
                            <comment id="13474677" author="djencks" created="Fri, 12 Oct 2012 00:42:06 +0000"  >&lt;p&gt;I found a way to use the main idea from ServiceTracker to fix the timing hole in DependencyManager without rewriting everything.  I got the test to pass once.... will look for more holes and try some more times.&lt;/p&gt;</comment>
                            <comment id="13475592" author="pderop" created="Sat, 13 Oct 2012 12:10:13 +0000"  >&lt;p&gt;Indeed, I successfully ran the test several times. But, using a multiprocessor machine, I sometimes find the following remaining problems:&lt;br/&gt;
(it&apos;s difficult to reproduce, and maybe the current issue should not block anymore a release ?)&lt;br/&gt;
-&amp;gt;&lt;/p&gt;

&lt;p&gt;1) A not enabled because some dependencies are not available:&lt;/p&gt;

&lt;p&gt;log level: 1 D=13:35:24,797, T=Thread-1: enableLatch TIMEOUT&lt;br/&gt;
log level: 2 D=13:35:24,797, T=Thread-1: A&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; B&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; C&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; D&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; E&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; F&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; G&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; H&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; I&lt;span class=&quot;error&quot;&gt;&amp;#91;disabled&amp;#93;&lt;/span&gt; J&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; K&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;2) sometimes the Main.bindA(A a) method gets null when calling getService; but since we decrement the &quot;enableLatch&quot; after calling getService, then we should never get null (am I correct or is there something wrong in the integration test ?):&lt;/p&gt;

&lt;p&gt;log level: 2 D=13:31:21,17, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt; Could not get service from ref &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.felix.scr.integration.components.felix3680.B&amp;#93;&lt;/span&gt;&lt;br/&gt;
log level: 1 D=13:31:21,18, T=Thread-1: FrameworkEvent ERROR&lt;br/&gt;
org.apache.felix.log.LogException: org.osgi.framework.ServiceException: Service factory returned null.&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistrationImpl.getFactoryUnchecked(ServiceRegistrationImpl.java:341)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistrationImpl.getService(ServiceRegistrationImpl.java:219)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistry.getService(ServiceRegistry.java:310)&lt;br/&gt;
        at org.apache.felix.framework.Felix.getService(Felix.java:3420)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.getService(BundleContextImpl.java:468)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BindMethod.getServiceObject(BindMethod.java:563)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.prebind(DependencyManager.java:1048)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.collectDependencies(AbstractComponentManager.java:857)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.ImmediateComponentManager.getService(ImmediateComponentManager.java:620)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistrationImpl.getFactoryUnchecked(ServiceRegistrationImpl.java:308)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistrationImpl.getService(ServiceRegistrationImpl.java:219)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistry.getService(ServiceRegistry.java:310)&lt;br/&gt;
        at org.apache.felix.framework.Felix.getService(Felix.java:3420)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.getService(BundleContextImpl.java:468)&lt;br/&gt;
        at org.apache.felix.scr.integration.components.felix3680.Main.bindA(Main.java:129)&lt;br/&gt;
        at sun.reflect.GeneratedMethodAccessor6.invoke(Unknown Source)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:616)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod.invokeMethod(BaseMethod.java:236)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod.access$500(BaseMethod.java:37)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod$Resolved.invoke(BaseMethod.java:613)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod.invoke(BaseMethod.java:496)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BindMethod.invoke(BindMethod.java:38)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethod(DependencyManager.java:1231)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethod(DependencyManager.java:1192)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.ImmediateComponentManager.invokeBindMethod(ImmediateComponentManager.java:300)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceAdded(DependencyManager.java:339)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:146)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
        at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4260)&lt;br/&gt;
        at org.apache.felix.framework.Felix.registerService(Felix.java:3275)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:752)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:735)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerComponentService(AbstractComponentManager.java:783)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager$Unsatisfied.activate(AbstractComponentManager.java:1549)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.activateInternal(AbstractComponentManager.java:641)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceAdded(DependencyManager.java:270)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:146)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
        at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4260)&lt;br/&gt;
        at org.apache.felix.framework.Felix.registerService(Felix.java:3275)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:752)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:735)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerComponentService(AbstractComponentManager.java:783)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager$Unsatisfied.activate(AbstractComponentManager.java:1549)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.activateInternal(AbstractComponentManager.java:641)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager$1.run(AbstractComponentManager.java:381)&lt;br/&gt;
        at org.apache.felix.scr.impl.ComponentActorThread.run(ComponentActorThread.java:98)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:679)&lt;/p&gt;



</comment>
                            <comment id="13475647" author="djencks" created="Sat, 13 Oct 2012 16:20:11 +0000"  >&lt;p&gt;With the current test code I don&apos;t expect any errors.  I committed a lot more changes that among other things don&apos;t drop any service removed or modified events.  I haven&apos;t seen any errors locally in the last 10-15 runs.  &lt;/p&gt;

&lt;p&gt;Is your test machine multiprocessor rather than just multicore?    I wonder if that results in less cache consistency.&lt;/p&gt;

&lt;p&gt;thanks for the logging improvements.&lt;/p&gt;</comment>
                            <comment id="13475901" author="pderop" created="Sun, 14 Oct 2012 20:56:06 +0000"  >&lt;p&gt;My mp machine is an HP G6 2*2.67GHz(2*6cores).&lt;/p&gt;

&lt;p&gt;a I did some tests on my laptop using the latest commits and sorry butI&apos;m still seeing some errors.&lt;/p&gt;

&lt;p&gt;I&apos;m Using &lt;/p&gt;

&lt;p&gt;    &quot;MAVEN_OPTS=-Xmx512M -Xms512m -server&quot; &lt;/p&gt;

&lt;p&gt;and also I modified the Felix3680Test.test_concurrent_reference_bindings() method in order to run the test during 600 seconds:&lt;/p&gt;

&lt;p&gt;    public void test_concurrent_reference_bindings()&lt;br/&gt;
    {&lt;br/&gt;
        final Component main =&lt;br/&gt;
                findComponentByName(&quot;org.apache.felix.scr.integration.components.felix3680.Main&quot;);&lt;br/&gt;
        TestCase.assertNotNull(main);&lt;br/&gt;
        main.enable();&lt;br/&gt;
        delay(600);&lt;br/&gt;
        ...&lt;/p&gt;

&lt;p&gt;So, I see the two following errors:&lt;/p&gt;

&lt;p&gt;1) a new error which I never noticed so far (&quot;Cannot disable component&quot;)&lt;/p&gt;

&lt;p&gt;log level: 2 D=22:15:13,303, T=Thread-1: Performed 12000 tests.&lt;br/&gt;
log level: 2 D=22:15:14,295, T=Thread-1: Performed 12500 tests.&lt;br/&gt;
log level: 1 D=22:15:15,72, T=Thread-1: &lt;span class=&quot;error&quot;&gt;&amp;#91;F&amp;#93;&lt;/span&gt; Cannot disable component&lt;br/&gt;
java.lang.IllegalStateException: disableDisabled&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager$State.disable(AbstractComponentManager.java:1373)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.disableInternal(AbstractComponentManager.java:651)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.disable(AbstractComponentManager.java:421)&lt;br/&gt;
        at org.apache.felix.scr.impl.config.ImmediateComponentHolder.disableComponents(ImmediateComponentHolder.java:405)&lt;br/&gt;
        at org.apache.felix.scr.impl.BundleComponentActivator.disableComponent(BundleComponentActivator.java:431)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.ComponentContextImpl.disableComponent(ComponentContextImpl.java:107)&lt;br/&gt;
        at org.apache.felix.scr.integration.components.felix3680.Main$EnableManager$1.run(Main.java:87)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;2) and after having restarted the test a second time, then after 40 seconds:&lt;/p&gt;

&lt;p&gt;...&lt;br/&gt;
log level: 2 D=22:20:55,882, T=Thread-1: Performed 15000 tests.&lt;br/&gt;
log level: 1 D=22:21:06,150, T=Thread-1: enableLatch TIMEOUT&lt;br/&gt;
log level: 2 D=22:21:06,151, T=Thread-1: A&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; B&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; C&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; D&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; E&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; F&lt;span class=&quot;error&quot;&gt;&amp;#91;unsatisfied&amp;#93;&lt;/span&gt; G&lt;span class=&quot;error&quot;&gt;&amp;#91;disabled&amp;#93;&lt;/span&gt; H&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; I&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; J&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; K&lt;span class=&quot;error&quot;&gt;&amp;#91;registered&amp;#93;&lt;/span&gt; &lt;/p&gt;
</comment>
                            <comment id="13477454" author="djencks" created="Tue, 16 Oct 2012 23:16:58 +0000"  >&lt;p&gt;I found a way to reliably produce test failures by replacing the single component actor thread with an executor so the activations happen concurrently. This is more similar to delayed components being activate by service events on many threads. Going to investigate....&lt;/p&gt;</comment>
                            <comment id="13477692" author="pderop" created="Wed, 17 Oct 2012 07:37:49 +0000"  >&lt;p&gt;from my side, I have made another integration test which is using bundleContext.registerService instead of using enable/disable ...&lt;br/&gt;
and this new test is also reproducing some errors more reliably.&lt;/p&gt;

&lt;p&gt;for example: I see a new error: sometimes, Main.bindA(A a) is called twice for the same &quot;A&quot; service instance. I&apos;ll attach this integration test today, and hope it will help to investigate.&lt;/p&gt;</comment>
                            <comment id="13477802" author="pderop" created="Wed, 17 Oct 2012 12:03:55 +0000"  >&lt;p&gt;I committed in the trunk a modification of the ComponentTestBase.Log inner class, in order to replace the usage of a LogListener by our own LogService &lt;br/&gt;
(still implemented in ComponentTestBase, see new Log inner class).&lt;/p&gt;

&lt;p&gt;I did this because the LogListener is handled from an internal LogService worker thread, preventing to be able to log the real thread-name of the thread which do the actual log.&lt;/p&gt;

&lt;p&gt;Now, if you update the trunk, you will see all actual logging thread name. for instance:&lt;/p&gt;

&lt;p&gt;log level: 4 D=14:00:02,762 T=Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;pool-2-thread-23,5,main&amp;#93;&lt;/span&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.felix.scr.integration.components.felix3680_2.A&amp;#93;&lt;/span&gt; Dependency Manager: Removing Service org.apache.felix.scr.integration.components.felix3680_2.F/51&lt;/p&gt;

&lt;p&gt;(the &quot;T=Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;pool-2-thread-23,5,main&amp;#93;&lt;/span&gt;&quot; trace is now logging the correct thread which did the log; before the &quot;T=...&quot; trace was always displaying the LogService internal thread used to handle our LogListener ...).&lt;/p&gt;</comment>
                            <comment id="13477803" author="pderop" created="Wed, 17 Oct 2012 12:11:18 +0000"  >&lt;p&gt;Attached a new test in integration_test_FELIX_3880_2.tgz, which seems to reproduce more reliably some concurrency issues.&lt;/p&gt;

&lt;p&gt;Please update the trunk before untaring, because I use the new ComponentTestBase.Log inner class I just committed today, in order to be able to display the correct logging thread name, instead of the LogService logging thread.&lt;/p&gt;

&lt;p&gt;Let me know if you want me to commit this new integration test.&lt;/p&gt;

&lt;p&gt;This test uses BundleContext.registerService/unregisterService instead of using ComponentContext.enable/disable methods.&lt;/p&gt;

&lt;p&gt;unfortunately, sometimes, I have the problem of the deadlock from the framework you recently reported, because I have some &quot;could not obtain lock&quot; logs (well, I don&apos;t know if its a new problem but I guess that this comes from the potential deadlock from the trunk).&lt;/p&gt;

&lt;p&gt;So, when I don&apos;t have the &quot;could not obtain lock&quot; problem, I sometimes have getService returning null, or even the A service is injected twice in the Main.bindA(A a) method&lt;/p&gt;
</comment>
                            <comment id="13480399" author="pderop" created="Fri, 19 Oct 2012 21:15:45 +0000"  >&lt;p&gt;Now, I don&apos;t see anymore getService returning null because the fix from &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3724&quot; title=&quot;[DS] concurrent getService calls may return null&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3724&quot;&gt;&lt;del&gt;FELIX-3724&lt;/del&gt;&lt;/a&gt; has fixed this problem (thanks).&lt;/p&gt;

&lt;p&gt;But with integration_test_FELIX_3880_2.tgz, and with latest trunk, I sometimes reproduces a problem where the &quot;A&quot; service is injected twice in Main.bindA(A a) method.&lt;/p&gt;

&lt;p&gt;I may be wrong, but I wonder why theDependencyManager.serviceAdded is not using a write lock, instead of a read lock ?&lt;/p&gt;

&lt;p&gt;Because looking at the two following stacktraces, we see that DependencyManager.serviceAdded is concurrently invoked by two threads, which are registering some services on which A is depending: &lt;br/&gt;
The thread Thread[pool-1-thread-30 is registering a first service from this stacktrace:&lt;/p&gt;

&lt;p&gt;Level=1 D=22:49:27,793 T=pool-1-thread-7: Already bound A from stacktrace:&lt;br/&gt;
java.lang.Exception: bindA (Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;pool-1-thread-30,5,main&amp;#93;&lt;/span&gt;)&lt;br/&gt;
	at test.scr2.Main.bindA(Main.java:122)&lt;br/&gt;
	at sun.reflect.GeneratedMethodAccessor5.invoke(Unknown Source)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.apache.felix.scr.impl.helper.BaseMethod.invokeMethod(BaseMethod.java:236)&lt;br/&gt;
	at org.apache.felix.scr.impl.helper.BaseMethod.access$500(BaseMethod.java:37)&lt;br/&gt;
	at org.apache.felix.scr.impl.helper.BaseMethod$Resolved.invoke(BaseMethod.java:613)&lt;br/&gt;
	at org.apache.felix.scr.impl.helper.BaseMethod.invoke(BaseMethod.java:496)&lt;br/&gt;
	at org.apache.felix.scr.impl.helper.BindMethod.invoke(BindMethod.java:38)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethod(DependencyManager.java:1308)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethod(DependencyManager.java:1242)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.ImmediateComponentManager.invokeBindMethod(ImmediateComponentManager.java:302)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.serviceAdded(DependencyManager.java:406)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:159)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4327)&lt;br/&gt;
	at org.apache.felix.framework.Felix.registerService(Felix.java:3337)&lt;br/&gt;
	at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:752)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:735)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerComponentService(AbstractComponentManager.java:783)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$Unsatisfied.activate(AbstractComponentManager.java:1567)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.activateInternal(AbstractComponentManager.java:641)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.serviceAdded(DependencyManager.java:337)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:159)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4327)&lt;br/&gt;
	at org.apache.felix.framework.Felix.registerService(Felix.java:3337)&lt;br/&gt;
	at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
	at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:320)&lt;br/&gt;
	at test.scr2.Main$EnableManager$1.run(Main.java:78)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;and a second thread pool-1-thread-7  is also registering (at the same time) another service on which A depends (probably an optional dependency):&lt;/p&gt;

&lt;p&gt; java.lang.Exception: bindA (Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;pool-1-thread-7,5,main&amp;#93;&lt;/span&gt;)&lt;br/&gt;
	at test.scr2.Main.bindA(Main.java:122)&lt;br/&gt;
	at sun.reflect.GeneratedMethodAccessor5.invoke(Unknown Source)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.apache.felix.scr.impl.helper.BaseMethod.invokeMethod(BaseMethod.java:236)&lt;br/&gt;
	at org.apache.felix.scr.impl.helper.BaseMethod.access$500(BaseMethod.java:37)&lt;br/&gt;
	at org.apache.felix.scr.impl.helper.BaseMethod$Resolved.invoke(BaseMethod.java:613)&lt;br/&gt;
	at org.apache.felix.scr.impl.helper.BaseMethod.invoke(BaseMethod.java:496)&lt;br/&gt;
	at org.apache.felix.scr.impl.helper.BindMethod.invoke(BindMethod.java:38)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethod(DependencyManager.java:1308)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethod(DependencyManager.java:1242)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.ImmediateComponentManager.invokeBindMethod(ImmediateComponentManager.java:302)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.serviceAdded(DependencyManager.java:406)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:159)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4327)&lt;br/&gt;
	at org.apache.felix.framework.Felix.registerService(Felix.java:3337)&lt;br/&gt;
	at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:752)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:735)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerComponentService(AbstractComponentManager.java:783)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$Unsatisfied.activate(AbstractComponentManager.java:1567)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.activateInternal(AbstractComponentManager.java:641)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.serviceAdded(DependencyManager.java:337)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:159)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4327)&lt;br/&gt;
	at org.apache.felix.framework.Felix.registerService(Felix.java:3337)&lt;br/&gt;
	at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
	at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:320)&lt;br/&gt;
	at test.scr2.Main$EnableManager$1.run(Main.java:78)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;and these two threads end up calling twice Main.bindA(A a) method.&lt;/p&gt;

&lt;p&gt;so, why don&apos;t we protect the DependencyManager.serviceAdded method , using a write lock, or a serial executor ?&lt;/p&gt;</comment>
                            <comment id="13480557" author="djencks" created="Sat, 20 Oct 2012 00:24:17 +0000"  >&lt;p&gt;I think there&apos;s a deadlock scenario if you basically synchronize on the service registration.   I don&apos;t remember the details, let me think about it.&lt;/p&gt;</comment>
                            <comment id="13480839" author="pderop" created="Sat, 20 Oct 2012 21:37:19 +0000"  >&lt;p&gt;ah ! I see ... I think you are right, we must not use a write lock in the DependencyManager.serviceAdded method because if we do this, we would then possibly register a satisfied service (that is: invoke bundleContext.registerService) while holding a write-lock ... and another thread then might be bound with that service and if this thread has a synchronized bind method, then we might have a dead lock if this thread is currently blocked on the write lock ...&lt;/p&gt;

&lt;p&gt;Now, there is another strategy, based on a serial executor I talked about in a previous post.&lt;br/&gt;
I have tested it and it sounds to work well (I don&apos;t have anymore any concurrent exceptions using all the concurrent tests I have, and also extensively tested it in the previous 1.6.0 version, where I had many concurrency issues resolved by using this serial executor).&lt;/p&gt;

&lt;p&gt;I have attached serial-executor.tgz, which is a tar gz, containing the SerialExecutor, as well as a patch.&lt;/p&gt;

&lt;p&gt;Now, even if this seems to resolve most of the concurrency problems, I do agree that there is still a problem when using this SerialExecutor: because according to the specification, the ComponentContext.enableComponent/disableComponent methods must be asynchronous ... so I am not sure for now how we could use the SerialExecutor in the context of enableComponent/disableComponent methods ... may be the component actor thread could also be patched in order to reschedule using the serial executor ?&lt;/p&gt;

&lt;p&gt;Another way could consist in dispatching every events to the actor thread, but in this case, the problem is that this would make component activation fully asynchronous and I think that Felix might not agree with this (in the past, components were activated asynchronously in the actor thread, but Felix changed this behavior in order to make sure that all components are started synchronously and are really available once the framework has started).&lt;/p&gt;

&lt;p&gt;Anyway, if you have time to take a look, I would be interested what you think about ?&lt;/p&gt;</comment>
                            <comment id="13480850" author="djencks" created="Sat, 20 Oct 2012 22:58:13 +0000"  >&lt;p&gt;I thought about it more and came to the opposite conclusion.  I think that as long as there are &lt;em&gt;different&lt;/em&gt; locks for registering the service and creating the implementation object there will be no deadlock.  Possibly the read-write lock won&apos;t be needed.&lt;/p&gt;

&lt;p&gt;The register-service code can be gotten to by activate or by a dependency manager service added event.&lt;/p&gt;

&lt;p&gt;Registering the service A can trigger getService on the registering thread (from a DM service added call) or a different thread (from that service happening to activate between the time the A service registration and the A service event arriving).&lt;/p&gt;

&lt;p&gt;The get service needs to be synchronized (currently with the write lock) so only one component instance is created.  As long as these have 2 locks I don&apos;t see how a deadlock can occur.&lt;/p&gt;

&lt;p&gt;The read lock might get in the way too... have to think more.&lt;/p&gt;

&lt;p&gt;&amp;#8212;&lt;/p&gt;

&lt;p&gt;Just synchronizing the register-service code and fixing your test a bit seems to pass consistently.&lt;/p&gt;

&lt;p&gt;Could you commit your _2 test?  I think there need to be a few changes to not always fail but I&apos;d rather not mix up our work too much.&lt;/p&gt;

&lt;p&gt;Still thinking, anyway....&lt;/p&gt;</comment>
                            <comment id="13480938" author="pderop" created="Sun, 21 Oct 2012 09:54:09 +0000"  >&lt;p&gt;ok, I see what you mean if we are using different locks.&lt;/p&gt;

&lt;p&gt;I have committed the integration_test_FELIX_3880_2 test in revision 1400611.&lt;br/&gt;
I just tested it and got the unexpected double injection, in Main.bindA(A a) method (unless the test is itself wrong ?)&lt;/p&gt;

&lt;p&gt;But take care about the fact that sometimes, we also come across the framework deadlock problem: (&quot;could not obtain lock&quot;).&lt;/p&gt;

&lt;p&gt;When we don&apos;t have the fwk deadlock problem, then we have:&lt;/p&gt;

&lt;p&gt;...&lt;br/&gt;
invoking bind: bindA&lt;br/&gt;
log level: 1 D=11:41:41,66 T=Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;pool-2-thread-10,5,main&amp;#93;&lt;/span&gt;: Already bound A from stacktrace:&lt;br/&gt;
java.lang.Exception: bindA (Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;pool-2-thread-10,5,main&amp;#93;&lt;/span&gt;)&lt;br/&gt;
        at org.apache.felix.scr.integration.components.felix3680_2.Main.bindA(Main.java:156)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod.invokeMethod(BaseMethod.java:236)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod.access$500(BaseMethod.java:37)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod$Resolved.invoke(BaseMethod.java:613)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod.invoke(BaseMethod.java:496)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BindMethod.invoke(BindMethod.java:38)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethod(DependencyManager.java:1308)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethod(DependencyManager.java:1242)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.ImmediateComponentManager.invokeBindMethod(ImmediateComponentManager.java:302)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceAdded(DependencyManager.java:406)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:159)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
        at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4260)&lt;br/&gt;
        at org.apache.felix.framework.Felix.registerService(Felix.java:3275)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:752)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:735)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerComponentService(AbstractComponentManager.java:783)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager$Unsatisfied.activate(AbstractComponentManager.java:1567)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.activateInternal(AbstractComponentManager.java:641)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceAdded(DependencyManager.java:337)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:159)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
        at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4260)&lt;br/&gt;
        at org.apache.felix.framework.Felix.registerService(Felix.java:3275)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:320)&lt;br/&gt;
        at org.apache.felix.scr.integration.components.felix3680_2.Main$RegistrationHelper$1.run(Main.java:108)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;log level: 1 D=11:41:41,66 T=Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;pool-2-thread-10,5,main&amp;#93;&lt;/span&gt;: Current stacktrace is:&lt;br/&gt;
java.lang.Exception: bindA (Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;pool-2-thread-10,5,main&amp;#93;&lt;/span&gt;)&lt;br/&gt;
        at org.apache.felix.scr.integration.components.felix3680_2.Main.bindA(Main.java:156)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod.invokeMethod(BaseMethod.java:236)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod.access$500(BaseMethod.java:37)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod$Resolved.invoke(BaseMethod.java:613)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod.invoke(BaseMethod.java:496)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BindMethod.invoke(BindMethod.java:38)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethod(DependencyManager.java:1308)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethod(DependencyManager.java:1242)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.ImmediateComponentManager.invokeBindMethod(ImmediateComponentManager.java:302)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceRemoved(DependencyManager.java:527)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:274)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
        at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4260)&lt;br/&gt;
        at org.apache.felix.framework.Felix.access$000(Felix.java:74)&lt;br/&gt;
        at org.apache.felix.framework.Felix$1.serviceChanged(Felix.java:390)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:148)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:127)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:760)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerService(AbstractComponentManager.java:735)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.registerComponentService(AbstractComponentManager.java:783)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager$Unsatisfied.activate(AbstractComponentManager.java:1567)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.activateInternal(AbstractComponentManager.java:641)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceAdded(DependencyManager.java:337)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:159)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
        at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4260)&lt;br/&gt;
        at org.apache.felix.framework.Felix.registerService(Felix.java:3275)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:320)&lt;br/&gt;
        at org.apache.felix.scr.integration.components.felix3680_2.Main$RegistrationHelper$1.run(Main.java:108)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;thanks for your patience and for keeping to investigate this last concurrency issue.&lt;/p&gt;

</comment>
                            <comment id="13480998" author="djencks" created="Sun, 21 Oct 2012 17:31:53 +0000"  >&lt;p&gt;I have no reason to suppose this is the last concurrency issue &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;We&apos;ll keep getting duplicate bind and unbind events until we synchronized the service registration.&lt;/p&gt;

&lt;p&gt;Locally I&apos;ve hacked away the read lock and synchronized the service registration. Most things seem to work well, including the &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3680&quot; title=&quot;Exceptions in SCR using concurrent service activation/deactivation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3680&quot;&gt;&lt;del&gt;FELIX-3680&lt;/del&gt;&lt;/a&gt;_2Test, but it has exposed some problems in the FELIX3680Test.  One problem is that waiting for the deactivations does not mean all the components are disabled, since e.g. G can be deactivated by H being deactivated.  This can result in G being disabled, G being enabled, and then G being deactivated.on a separate thread.  I think we might want to do something so that disable blocks until activation completes and enable blocks until deactivation completes.  I wonder if the spec should mention this?&lt;/p&gt;

&lt;p&gt;BTW removing the read lock produces a dramatic speedup.  Instead of getting about 5000 runs in the _2 test I get around 50000.&lt;/p&gt;</comment>
                            <comment id="13484582" author="djencks" created="Thu, 25 Oct 2012 23:54:30 +0000"  >&lt;p&gt;With my last set of changes I haven&apos;t seen any test failures in a lot of runs.  Can you try it?&lt;/p&gt;

&lt;p&gt;I fixed ( among other things):&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;made enable and disable wait for the async bit from the other to complete&lt;/li&gt;
	&lt;li&gt;sort of fixed the reference counting so it never goes below 0 and is no smaller than the actual number of services satisfying the filter.  It might be larger, but we don&apos;t really care.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m not 100% convinced the actual service tracking of bound services is entirely correct.  I opened 3729 to think about how to improve this.&lt;/p&gt;</comment>
                            <comment id="13485012" author="pderop" created="Fri, 26 Oct 2012 15:53:24 +0000"  >&lt;p&gt;Thank you David, I ran the tests several times and the problems seem to be fixed.&lt;/p&gt;

&lt;p&gt;One point to notice: now I don&apos;t reproduce anymore the potential deadlock problem from &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3687&quot; title=&quot;Deadlock potential from ServiceRegistry.unregisterService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3687&quot;&gt;&lt;del&gt;FELIX-3687&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
It also sounds like the tests are now running faster.&lt;/p&gt;

&lt;p&gt;I will do more tests next week. So, you think that this commit might not be final and that some more work has to be done in &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3729&quot; title=&quot;[DS] Track dependencies by imitating ServiceTracker and keeping a list of actual service references all the time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3729&quot;&gt;&lt;del&gt;FELIX-3729&lt;/del&gt;&lt;/a&gt; ?&lt;/p&gt;
</comment>
                            <comment id="13618260" author="djencks" created="Sun, 31 Mar 2013 06:23:06 +0000"  >&lt;p&gt;The major problems here got fixed for 1.6.2 and Pierre&apos;s great stress tests are passing pretty consistently.  We can open more bugs as they show up.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12609456">FELIX-3687</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12549408" name="FELIX-3680-concurrent-activate.diff" size="5457" author="djencks" created="Tue, 16 Oct 2012 23:16:58 +0000"/>
                            <attachment id="12549492" name="integration_test_FELIX_3880_2.tgz" size="9276" author="pderop" created="Wed, 17 Oct 2012 12:11:18 +0000"/>
                            <attachment id="12547277" name="logs_with_could_not_get_service_from_ref.txt.gz" size="724909" author="pderop" created="Mon, 1 Oct 2012 21:44:37 +0000"/>
                            <attachment id="12550153" name="serial-executor.tgz" size="2478" author="pderop" created="Sat, 20 Oct 2012 21:37:19 +0000"/>
                            <attachment id="12546274" name="test.scr.tgz" size="22744" author="pderop" created="Mon, 24 Sep 2012 09:35:00 +0000"/>
                            <attachment id="12546842" name="test_with_fwk.tgz" size="1929929" author="pderop" created="Thu, 27 Sep 2012 10:43:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>240035</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 34 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i00vlz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3053</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>