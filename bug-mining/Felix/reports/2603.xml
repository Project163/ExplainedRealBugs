<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:00:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5199] Race condition in HttpServiceFactory.getService() causing exception</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5199</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;The HttpServiceFactory.getService() is as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; HttpService getService(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Bundle bundle, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ServiceRegistration&amp;lt;HttpService&amp;gt; reg)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ServletContext servletContext = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.context;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( servletContext != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PerBundleHttpServiceImpl(bundle,
                    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sharedHttpService,
                    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.context,
                    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.contextAttributeListenerManager,
                    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sharedContextAttributes,
                    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.requestListenerManager,
                    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.requestAttributeListenerManager);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However it is possible that this.context is set to &lt;tt&gt;null&lt;/tt&gt; after the check for &lt;tt&gt;null&lt;/tt&gt; is done but before the constructor is called causing a null servlet context to be passed to &lt;tt&gt;PerBundleHttpServiceImpl&lt;/tt&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12944592">FELIX-5199</key>
            <summary>Race condition in HttpServiceFactory.getService() causing exception</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bosschaert">David Bosschaert</assignee>
                                    <reporter username="bosschaert">David Bosschaert</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Feb 2016 18:34:07 +0000</created>
                <updated>Fri, 1 Apr 2016 07:40:32 +0000</updated>
                            <resolved>Wed, 23 Mar 2016 06:55:01 +0000</resolved>
                                    <version>http.base-3.0.6</version>
                    <version>http.jetty-3.1.6</version>
                    <version>http.bridge-3.0.6</version>
                                    <fixVersion>http.base-3.0.8</fixVersion>
                    <fixVersion>http.jetty-3.2.0</fixVersion>
                    <fixVersion>http.bridge-3.0.8</fixVersion>
                                    <component>HTTP Service</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15167607" author="bosschaert" created="Thu, 25 Feb 2016 18:35:47 +0000"  >&lt;p&gt;The attached small patch fixes the issue. It would be great if someone could review that I didn&apos;t miss anything.&lt;/p&gt;</comment>
                            <comment id="15168580" author="cziegeler" created="Fri, 26 Feb 2016 07:12:49 +0000"  >&lt;p&gt;I think we need to check all objects that can get invalidated in stop(). If any of these is null or closed, we should not return the service anymore. So maybe using a simple flag (started/stopped) that&apos;s set in start/stop and evaluated in the getService method is safer&lt;/p&gt;</comment>
                            <comment id="15168648" author="bosschaert" created="Fri, 26 Feb 2016 08:21:36 +0000"  >&lt;p&gt;Thanks for the feedback, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt;. I didn&apos;t think of checking for the other objects as &lt;tt&gt;PerBundleHttpServiceImpl&lt;/tt&gt; only seems to require the Bundle and the ServletContext to be non-null. As this is a service factory which is called by the framework the Bundle can never be null...&lt;/p&gt;

&lt;p&gt;I agree that a started/stopped flag would cover the overall case. Let me rework the patch for that...&lt;/p&gt;</comment>
                            <comment id="15168770" author="bosschaert" created="Fri, 26 Feb 2016 10:13:45 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://svn.apache.org/viewvc?view=revision&amp;amp;revision=1732445&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/viewvc?view=revision&amp;amp;revision=1732445&lt;/a&gt; using flag as suggested.&lt;/p&gt;</comment>
                            <comment id="15168817" author="bosschaert" created="Fri, 26 Feb 2016 10:57:26 +0000"  >&lt;p&gt;I improved the thread-safety in the fix after feedback from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt; in this commit: &lt;a href=&quot;https://svn.apache.org/viewvc?view=revision&amp;amp;revision=1732453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/viewvc?view=revision&amp;amp;revision=1732453&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15203515" author="epirealer" created="Sun, 20 Mar 2016 20:47:56 +0000"  >&lt;p&gt;While investigating &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5219&quot; title=&quot;Servlet Bridge does not work if not mounted as root servlet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5219&quot;&gt;&lt;del&gt;FELIX-5219&lt;/del&gt;&lt;/a&gt; I ran into some issues that I believe is related to this patch. &lt;/p&gt;

&lt;p&gt;If a &lt;tt&gt;ServiceTracker&lt;/tt&gt; is opened and listening for &lt;tt&gt;HttpService&lt;/tt&gt; (&lt;b&gt;before&lt;/b&gt; &lt;tt&gt;HttpServiceFactory#start&lt;/tt&gt; have been called) the &lt;tt&gt;active&lt;/tt&gt; flag in &lt;tt&gt;HttpServiceFactory#getService&lt;/tt&gt; will never be &lt;tt&gt;!= null&lt;/tt&gt; (and the returned service will be &lt;tt&gt;null&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;The reason is that the ServiceTracker will get a callback to &lt;tt&gt;addingService&lt;/tt&gt; synchronously when the service-factory is registered (line 114 in &lt;tt&gt;HttpServiceFactory&lt;/tt&gt;. At this point the &lt;tt&gt;active&lt;/tt&gt; flag is still &lt;tt&gt;false&lt;/tt&gt; (it&apos;s set to &lt;tt&gt;true&lt;/tt&gt; right after the registration. If the ServiceTracker tries to resolve the service-reference in its &lt;tt&gt;addingService&lt;/tt&gt; this will call into &lt;tt&gt;HttpServiceFactory#getService&lt;/tt&gt; - but &lt;tt&gt;active&lt;/tt&gt; is false, so no service is returned.&lt;/p&gt;

&lt;p&gt;I tried setting &lt;tt&gt;active&lt;/tt&gt; to true just before registering the HttpServiceFactory, and this seemed to work - but perhaps that will lead to similar race conditions as in the original code before this patch?&lt;/p&gt;</comment>
                            <comment id="15203792" author="cziegeler" created="Mon, 21 Mar 2016 06:22:29 +0000"  >&lt;p&gt;Good catch, I think we somehow have to do this differently&lt;/p&gt;</comment>
                            <comment id="15206779" author="bosschaert" created="Tue, 22 Mar 2016 16:54:42 +0000"  >&lt;p&gt;Yeah, when I looked at it the best solution seemed to split this object into two separate objects, but I didn&apos;t get to implement that yet...&lt;/p&gt;</comment>
                            <comment id="15207975" author="cziegeler" created="Wed, 23 Mar 2016 06:55:01 +0000"  >&lt;p&gt;Moving the boolean before registering should actually solve the problem, no one else is able to get the service until it is registered, therefore setting it to true before registering works as expected&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12789978" name="felix-5199.patch" size="773" author="bosschaert" created="Thu, 25 Feb 2016 18:35:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 35 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2tri7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>