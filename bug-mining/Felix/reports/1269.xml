<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:22:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-2748] Possible synchronization issue with BundleContext.getBundle()</title>
                <link>https://issues.apache.org/jira/browse/FELIX-2748</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;On 12/26/10 23:24, Sahoo wrote:&lt;br/&gt;
&amp;gt; Hi,&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt; Looking at the code, it seems to me that BundleContext.getBundle() can return a bundle even though the BundleContext has been invalidated. I say this based on the following reasoning:&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt; public BundleContext.getBundle()&lt;br/&gt;
&amp;gt; &lt;/p&gt;
{
&amp;gt;         checkValidity();
&amp;gt;
&amp;gt;         return m_bundle;
&amp;gt; }
&lt;p&gt;&amp;gt;&lt;br/&gt;
&amp;gt; private void checkValidity() // non-synchronized method&lt;br/&gt;
&amp;gt; {&lt;br/&gt;
&amp;gt;         if (m_valid) // m_valid is a non-volatile field&lt;br/&gt;
&amp;gt;         {&lt;br/&gt;
&amp;gt;             switch (m_bundle.getState())&lt;br/&gt;
&amp;gt;             &lt;/p&gt;
{
&amp;gt;                 case Bundle.ACTIVE:
&amp;gt;                 case Bundle.STARTING:
&amp;gt;                 case Bundle.STOPPING:
&amp;gt;                     return;
&amp;gt;             }
&lt;p&gt;&amp;gt;         }&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt;         throw new IllegalStateException(&quot;Invalid BundleContext.&quot;);&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt; }&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt; protected void invalidate()    &lt;/p&gt;
{        m_valid = false;    }
&lt;p&gt;&amp;gt;&lt;br/&gt;
&amp;gt; class Bundle  {&lt;br/&gt;
&amp;gt;   public int getState() // non-synchronized method&lt;br/&gt;
&amp;gt;     &lt;/p&gt;
{
&amp;gt;         return m_state;
&amp;gt;     }
&lt;p&gt;&amp;gt; }&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt; time t1: thread1 has access to bundleContext.&lt;br/&gt;
&amp;gt; time t2: thread2 calls b.update()&lt;br/&gt;
&amp;gt; time t3: bundle has been stopped and is now in STARTING state. thread1 calls bundleContext.getBundle().&lt;br/&gt;
&amp;gt; Since m_valid is not a volatile field, it can see m_valid as true, although thread2 would have set it to false. Since m_state is volatile, it sees its value as STARTING. So, it fails to detect invalidation of the bundle and is returned with the bundle object instead of IllegalStateException.&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt; Am I missing anything here?&lt;/p&gt;

&lt;p&gt;No, I think you are correct.&lt;/p&gt;

&lt;p&gt;I&apos;ll have to think about it a little more, but I think the real issue here is the fact that the validity of the bundle context has to be more directly tied to the bundle. They can&apos;t be treated as independent values, because even if they were both volatile or synchronized, you could still end up with a change in state between checking each value.&lt;/p&gt;

&lt;p&gt;I think the simpler BundleContext.checkValidity() method should be something like:&lt;/p&gt;

&lt;p&gt;    m_bundle._getBundleContext() == this&lt;/p&gt;

&lt;p&gt;Which says as long as &quot;this&quot; bundle context is the bundle&apos;s bundle context, then it is valid. I think. I&apos;ll still need to think about it. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Want to open a bug on this issue?&lt;/p&gt;

&lt;p&gt;Is this a theoretical exercise or are you suffering from this?&lt;/p&gt;

&lt;p&gt;-&amp;gt; richard&lt;/p&gt;</description>
                <environment></environment>
        <key id="12494129">FELIX-2748</key>
            <summary>Possible synchronization issue with BundleContext.getBundle()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="sahoo">Sanjeeb Kumar Sahoo</reporter>
                        <labels>
                    </labels>
                <created>Mon, 27 Dec 2010 16:30:20 +0000</created>
                <updated>Tue, 15 Mar 2011 20:49:29 +0000</updated>
                            <resolved>Tue, 15 Mar 2011 20:49:29 +0000</resolved>
                                    <version>framework-3.0.7</version>
                                    <fixVersion>framework-3.2.0</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12975549" author="rickhall" created="Tue, 28 Dec 2010 16:05:18 +0000"  >&lt;p&gt;Even if we modify the checkValidity() method like I suggest, I think there will still be a race condition between the check and the action (e.g., registering a listener). We need to check and make sure that each existing action either does a double check while holding the bundle lock or make it acquire the bundle lock to perform the associated action.&lt;/p&gt;</comment>
                            <comment id="13007171" author="rickhall" created="Tue, 15 Mar 2011 20:49:29 +0000"  >&lt;p&gt;I have committed a patch for this. In some cases, I think it is ok for us to ignore the race condition since the result is no different than if the calling thread had won the race. On the other hand, for the listener-related methods, I modified the framework code to grab the bundle state lock which acts as a double check, since not doing so could leave lingering listeners from an stopped bundle. For registering services, we already grabbed the bundle state lock. Please close if you are satisfied. Thanks for reporting.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>56163</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0vs5z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>183536</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>