<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:33:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3160] NPE in BundleRevisionImpl.close() when uninstalling a bundle</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3160</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;There seems to be a case where m_content can be null when uninstalling a bundle, causing the following code to throw an NPE:&lt;/p&gt;

&lt;p&gt;    synchronized void close()&lt;br/&gt;
    {&lt;br/&gt;
        try&lt;/p&gt;
        {
            resolve(null);
        }
&lt;p&gt;        catch (Exception ex)&lt;/p&gt;
        {
            ((BundleImpl) m_bundle).getFramework().getLogger().log(
                Logger.LOG_ERROR, &quot;Error releasing revision: &quot; + ex.getMessage(), ex);
        }

&lt;p&gt;       m_content.close();&lt;/p&gt;


&lt;p&gt;I&apos;ve added a simple check for null around the close in my version to avoid the exception, which I&apos;ll check in.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure of the scenarios where this can legally be null at this point, and whether there&apos;s some nastier underlying circumstance that needs investigating. We see it under the following circumstances:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;we register a listener that looks for framework STARTED&lt;/li&gt;
	&lt;li&gt;when triggered, this iterates all bundles and performs an uninstall on ones which we determine are zombies leftover from a previous run&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Aside from the fact we&apos;re calling uninstall from inside an event handling method, there doesn&apos;t anything else unusual about this code.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12526847">FELIX-3160</key>
            <summary>NPE in BundleRevisionImpl.close() when uninstalling a bundle</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="walkerr">Rob Walker</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Oct 2011 13:33:43 +0000</created>
                <updated>Sat, 16 Jun 2012 19:30:38 +0000</updated>
                            <resolved>Sat, 16 Jun 2012 19:30:38 +0000</resolved>
                                    <version>framework-4.0.0</version>
                                    <fixVersion>framework-4.2.0</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13125852" author="walkerr" created="Wed, 12 Oct 2011 13:43:28 +0000"  >&lt;p&gt;Fix committed to test for null pointer.&lt;br/&gt;
Will close once reviewed and agreed that no further/deeper checks are needed.&lt;/p&gt;</comment>
                            <comment id="13125887" author="rickhall" created="Wed, 12 Oct 2011 14:34:41 +0000"  >&lt;p&gt;This doesn&apos;t sound right. Do you have something to help me reproduce the scenario? If not, are you saying it will always happen if I create a bundle that uninstalls another bundle after receiving the STARTED event?&lt;/p&gt;</comment>
                            <comment id="13125986" author="walkerr" created="Wed, 12 Oct 2011 17:34:08 +0000"  >&lt;p&gt;Certainly always happened our side.&lt;/p&gt;

&lt;p&gt;Here&apos;s the code in our activator:&lt;/p&gt;

&lt;p&gt;    public void start(BundleContext context) &lt;br/&gt;
            throws &lt;br/&gt;
                    Exception&lt;br/&gt;
    {&lt;br/&gt;
        this.context = context;&lt;br/&gt;
        ...&lt;br/&gt;
        // Only run sweeper once fully started&lt;br/&gt;
        this.context.addFrameworkListener(new FrameworkListener()&lt;br/&gt;
	        {&lt;br/&gt;
				public void frameworkEvent(FrameworkEvent evt) &lt;br/&gt;
				{&lt;br/&gt;
					if (evt.getType() == FrameworkEvent.STARTED)&lt;/p&gt;
					{
				           runSweeper();
					}
&lt;p&gt;					else if (evt.getType() == FrameworkEvent.ERROR)&lt;/p&gt;
					{
						diag.debug(&quot;Framework error, bundle: &quot; + evt.getBundle(), evt.getThrowable());
					}
&lt;p&gt;				}&lt;br/&gt;
	        });&lt;br/&gt;
    }&lt;/p&gt;


&lt;p&gt;We added the diag.debug when we started getting framework errors - that&apos;s what nailed the source of the NPE&lt;/p&gt;

&lt;p&gt;The runSweeper method is very simple. This is a framework restart - so we are warm starting using previously cached and started bundles. The sweeper looks for our transient bundles and cleans them out. They used START_TRANSIENT in the last run of the framework, this time around they only reach an INSTALLED state on startup.&lt;/p&gt;

&lt;p&gt;    protected void runSweeper() &lt;br/&gt;
    {&lt;br/&gt;
		// TODO Auto-generated method stub&lt;br/&gt;
    	for (Bundle bundle : this.context.getBundles())&lt;br/&gt;
    	{&lt;br/&gt;
    		try&lt;br/&gt;
    		{&lt;br/&gt;
	    		if (bundle.getSymbolicName().startsWith(VtLibrary.TRANSIENT_PREFIX) &amp;amp;&amp;amp;&lt;br/&gt;
	    		    bundle.getState() == Bundle.INSTALLED)&lt;/p&gt;
	    		{
	    			diag.debug(&quot;Removing transient bundle: &quot; + bundle.toString());
	    			bundle.uninstall();
	    		}
&lt;p&gt;    		}&lt;br/&gt;
    		catch (BundleException be)&lt;/p&gt;
    		{
                app.error(&quot;Watchdog: sweeper error removing transient bundle: &quot; + bundle.getSymbolicName());    			
    		}
&lt;p&gt;    	}&lt;br/&gt;
	}&lt;/p&gt;

&lt;p&gt;Not really sure what the trigger for m_content being null at uninstall time - whether it&apos;s to do with the uninstall() being called from inside the event handle, or whether some facet of the framework restart has left m_content null.&lt;/p&gt;


</comment>
                            <comment id="13128277" author="rickhall" created="Sat, 15 Oct 2011 20:51:14 +0000"  >&lt;p&gt;I created a bundle like this:&lt;/p&gt;

&lt;p&gt;public class Activator implements BundleActivator&lt;br/&gt;
{&lt;br/&gt;
    public void start(final BundleContext bc)&lt;br/&gt;
    {&lt;br/&gt;
        bc.addFrameworkListener(new FrameworkListener() {&lt;br/&gt;
            public void frameworkEvent(FrameworkEvent event)&lt;br/&gt;
            {&lt;br/&gt;
                if (event.getType() == FrameworkEvent.STARTED)&lt;br/&gt;
                {&lt;br/&gt;
                    for (Bundle b : bc.getBundles())&lt;br/&gt;
                    {&lt;br/&gt;
                        if ((b.getBundleId() != 0)&lt;br/&gt;
                            &amp;amp;&amp;amp; (b != bc.getBundle())&lt;br/&gt;
                            &amp;amp;&amp;amp; !b.getSymbolicName().startsWith(&quot;org.apache.felix.gogo&quot;))&lt;br/&gt;
                        {&lt;br/&gt;
                            try&lt;/p&gt;
                            {
                                b.uninstall();
                            }
&lt;p&gt;                            catch (Exception ex)&lt;/p&gt;
                            {
                                System.out.println(&quot;+++ Uninstall error: &quot; + ex);
                            }
&lt;p&gt;                        }&lt;br/&gt;
                    }&lt;br/&gt;
                }&lt;br/&gt;
            }&lt;br/&gt;
        });&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;    public void stop(BundleContext bc)&lt;br/&gt;
    {&lt;br/&gt;
    }&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;This was working for me, it was correctly deleting any non-shell bundles on framework restart. Perhaps there is something else I need to do to recreate. Perhaps you could see if my code above gives you an error too. Thanks.&lt;/p&gt;</comment>
                            <comment id="13128684" author="walkerr" created="Mon, 17 Oct 2011 05:51:53 +0000"  >&lt;p&gt;Sounds like there must be some other obscure factor at work here. Will try and assess what else is different in our setup and see if I can recreate with your bundle above.&lt;/p&gt;</comment>
                            <comment id="13128720" author="karlpauls" created="Mon, 17 Oct 2011 08:17:02 +0000"  >&lt;p&gt;Richard, did you test with the current trunk? Rob commited a quick fix to it so if you are trying to reproduce you&apos;d need to test against a revision before his commit ...&lt;/p&gt;</comment>
                            <comment id="13128727" author="walkerr" created="Mon, 17 Oct 2011 08:42:38 +0000"  >&lt;p&gt;Now that would be quite funny ... but I have an odd sense of humour &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;There are 2 aspects I wonder if could be different in our setup.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Our sweeper bundle runs at a start level of 2. The bundles being uninstalled have a start level of 1, but, they used START_TRANSIENT in the previous framework start. On the restart, they never get beyond a start state of INSTALLED due do the transient start option.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The original JAR from which these bundles were started was a temporary file and will not be accessible on restarted (it&apos;s been deleted). The cached JAR and settings are of course still present. I don&apos;t recall any OSGi rule that says the original location/file that a bundle was installed from has to always be available, but maybe I forgot this?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Rob&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13128896" author="rickhall" created="Mon, 17 Oct 2011 14:09:12 +0000"  >&lt;p&gt;Yeah, I think Karl is correct. I&apos;ll look into it again later, thanks.&lt;/p&gt;</comment>
                            <comment id="13128917" author="rickhall" created="Mon, 17 Oct 2011 14:49:18 +0000"  >&lt;p&gt;I&apos;m still not able to recreate, so I guess we&apos;ll have to try to recreate the exact scenario. If you can come up with something, let me know. Otherwise, I&apos;ll tinker around with it later and see if I can come up with something.&lt;/p&gt;</comment>
                            <comment id="13129115" author="walkerr" created="Mon, 17 Oct 2011 19:42:26 +0000"  >&lt;p&gt;Might take me a couple of days to get to it but will see if I can figure what sequence of start, restart and uninstall are needed to trigger this every time.&lt;/p&gt;</comment>
                            <comment id="13148334" author="rickhall" created="Fri, 11 Nov 2011 07:56:37 +0000"  >&lt;p&gt;Rob, I&apos;m still waiting on you to help me recreate this situation...&lt;/p&gt;</comment>
                            <comment id="13148340" author="walkerr" created="Fri, 11 Nov 2011 08:16:55 +0000"  >&lt;p&gt;Yep, apols, got caught up with a ton of work on our next release so hadn&apos;t managed to get an isolated environment that recreates this yet. Still on my todo list, will update when I have.&lt;/p&gt;</comment>
                            <comment id="13148387" author="walkerr" created="Fri, 11 Nov 2011 09:53:22 +0000"  >&lt;p&gt;Struggling to recreate in a simplified form. I don&apos;t think it&apos;s as simple as just the uninstall inside the handler for the framework STARTED event.&lt;/p&gt;

&lt;p&gt;I think it has something related to package admin - looking at the exception trace again, the log message I have after the uninstall has already been output. The Null pointer exception looks to happen asynchronously soon after:&lt;/p&gt;

&lt;p&gt;===&lt;br/&gt;
11-11-11 10:35:39 DEBUG - Removing transient bundle: com.ascert.transient.vt.lib.lib_4047819872618789.jar &lt;span class=&quot;error&quot;&gt;&amp;#91;36&amp;#93;&lt;/span&gt;&lt;br/&gt;
11-11-11 10:35:39 DEBUG - Framework error, bundle: com.ascert.transient.vt.lib.lib_4047819872618789.jar &lt;span class=&quot;error&quot;&gt;&amp;#91;36&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at org.apache.felix.framework.BundleRevisionImpl.close(BundleRevisionImpl.java:642)&lt;br/&gt;
        at org.apache.felix.framework.BundleImpl.closeRevisions(BundleImpl.java:154)&lt;br/&gt;
        at org.apache.felix.framework.BundleImpl.closeAndDelete(BundleImpl.java:138)&lt;br/&gt;
        at org.apache.felix.framework.Felix$RefreshHelper.refreshOrRemove(Felix.java:4640)&lt;br/&gt;
        at org.apache.felix.framework.Felix.refreshPackages(Felix.java:3952)&lt;br/&gt;
        at org.apache.felix.framework.FrameworkWiringImpl.run(FrameworkWiringImpl.java:172)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
===&lt;/p&gt;

&lt;p&gt;My cut down example still has the same package refresh code in, but as yet isn&apos;t tripping the issue. &lt;/p&gt;

&lt;p&gt;Will continue trying to recreate&lt;/p&gt;</comment>
                            <comment id="13148423" author="walkerr" created="Fri, 11 Nov 2011 11:02:27 +0000"  >&lt;p&gt;Will run out of time to look further into this one shortly. Summary at this stage:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;the NPE happens every time in our own application setup&lt;/li&gt;
	&lt;li&gt;the trigger seems to be to do with the uninstall of bundles started as transient from previous runs of the framework&lt;/li&gt;
	&lt;li&gt;the exception itself seems to come out of a package refresh, which is triggered by the same bundle as we do the uninstall from&lt;/li&gt;
	&lt;li&gt;it doesn&apos;t happen on a simple setup with just a few bundles - our application takes 3 to 5s to startup, and has around 48 bundles - implying maybe timing or complexity of bundle inter wiring could be a factor&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13148431" author="walkerr" created="Fri, 11 Nov 2011 11:25:03 +0000"  >&lt;p&gt;Just as I was about to give up - I think I got it!&lt;/p&gt;

&lt;p&gt;Adding 1 more bundle to the startup set seemed to trigger it (http)&lt;/p&gt;

&lt;p&gt;This is the bundle set I load:&lt;/p&gt;

&lt;p&gt;===&lt;br/&gt;
felix.auto.install.1=&quot;${bundle.root}/lib/ext/osgi.compendium.jar&quot;&lt;/p&gt;

&lt;p&gt;org.osgi.framework.startlevel.beginning=3&lt;/p&gt;

&lt;p&gt;felix.auto.start.1=&quot;${bundle.root}/lib/ext/felix.log.jar&quot;&lt;/p&gt;

&lt;p&gt;felix.auto.start.2=&quot;${bundle.root}/lib/ext/httpjetty.jar&quot; \&lt;br/&gt;
                   &quot;${bundle.root}/lib/vt/watchdog.jar&quot;&lt;/p&gt;

&lt;p&gt;felix.auto.start.3=&quot;${bundle.root}/lib/ext/shell.jar&quot; \&lt;br/&gt;
                   &quot;${bundle.root}/lib/ext/shelltui.jar&quot;&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;we&apos;ll start this transient so we have something to clean up&lt;br/&gt;
test.bundle=&lt;a href=&quot;file:c:/mnt/data/vtmp/lib/shell.gui.jar&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:c:/mnt/data/vtmp/lib/shell.gui.jar&lt;/a&gt;&lt;br/&gt;
===&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;All the above bundles are standard from felix SVN, except my watchdog bundle. Will attach source for that.&lt;/p&gt;


&lt;p&gt;Steps I take are:&lt;/p&gt;

&lt;p&gt;1 - start cold with the above bundle set&lt;/p&gt;

&lt;p&gt;2 -  from shell TUI start the shell.gui.jar transient (my activator code looks for this symbolic name on restart) e.g.&lt;/p&gt;

&lt;p&gt;     -&amp;gt; install &lt;a href=&quot;file:c:/mnt/data/vtmp/lib/shell.gui.jar&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:c:/mnt/data/vtmp/lib/shell.gui.jar&lt;/a&gt;&lt;br/&gt;
     Bundle ID: 7&lt;br/&gt;
     -&amp;gt; start -t 7&lt;/p&gt;

&lt;p&gt;3 - kill the framework (I used Ctrl-C in fact, rather than clean shutdown)&lt;/p&gt;

&lt;p&gt;4 - start the framework warm this time. NPE occurs after the auto uninstall of the shell GUI jar:&lt;/p&gt;

&lt;p&gt;     C:\mnt\Data\runvt&amp;gt;vtmp&lt;br/&gt;
     Removing transient bundle: org.apache.felix.shell.gui &lt;span class=&quot;error&quot;&gt;&amp;#91;7&amp;#93;&lt;/span&gt;&lt;br/&gt;
     -&amp;gt; Framework error, bundle: org.apache.felix.shell.gui &lt;span class=&quot;error&quot;&gt;&amp;#91;7&amp;#93;&lt;/span&gt;&lt;br/&gt;
     java.lang.NullPointerException&lt;br/&gt;
             at org.apache.felix.framework.BundleRevisionImpl.close(BundleRevisionImpl.java:642)&lt;br/&gt;
             at org.apache.felix.framework.BundleImpl.closeRevisions(BundleImpl.java:154)&lt;br/&gt;
             at org.apache.felix.framework.BundleImpl.closeAndDelete(BundleImpl.java:138)&lt;br/&gt;
             at org.apache.felix.framework.Felix$RefreshHelper.refreshOrRemove(Felix.java:4640)&lt;br/&gt;
             at org.apache.felix.framework.Felix.refreshPackages(Felix.java:3952)&lt;br/&gt;
             at org.apache.felix.framework.FrameworkWiringImpl.run(FrameworkWiringImpl.java:172)&lt;br/&gt;
             at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;



&lt;p&gt;===&lt;/p&gt;

&lt;p&gt;Remember to comment out the workaround checked in to SVN to ensure the NPE appears:&lt;/p&gt;

&lt;p&gt;    synchronized void close()&lt;br/&gt;
    {&lt;br/&gt;
        try&lt;/p&gt;
        {
            resolve(null);
        }
&lt;p&gt;        catch (Exception ex)&lt;/p&gt;
        {
            ((BundleImpl) m_bundle).getFramework().getLogger().log(
                Logger.LOG_ERROR, &quot;Error releasing revision: &quot; + ex.getMessage(), ex);
        }

&lt;p&gt;        //if (m_content != null)&lt;br/&gt;
        //&lt;/p&gt;
{
            m_content.close();
        //}

&lt;p&gt;        m_content = null;&lt;br/&gt;
        for (int i = 0; (m_contentPath != null) &amp;amp;&amp;amp; (i &amp;lt; m_contentPath.size()); i++)&lt;/p&gt;
        {
            m_contentPath.get(i).close();
        }
&lt;p&gt;        m_contentPath = null;&lt;br/&gt;
    }&lt;/p&gt;
</comment>
                            <comment id="13149247" author="rickhall" created="Sun, 13 Nov 2011 08:11:17 +0000"  >&lt;p&gt;Well, I was hopeful. I recreated the scenario as faithfully as I could, but it still works properly for me (and I remembered to comment out the null check).&lt;/p&gt;

&lt;p&gt;Not sure what is going on. Maybe it is related to platform. To rule everything else out, could you create a self-contained zip of the exact scenario that can reproduce the situation for you and attach it here? Then I will try to use that exactly and see what I see.&lt;/p&gt;

&lt;p&gt;If that doesn&apos;t work, then we&apos;ll have to make sure we are testing on the same platform (I&apos;m on a Mac using Java 6) and go from there.&lt;/p&gt;</comment>
                            <comment id="13149448" author="walkerr" created="Mon, 14 Nov 2011 05:35:36 +0000"  >&lt;p&gt;That&apos;s a shame. I&apos;ll need to try and create a version my side that doesn&apos;t use our custom launcher, which is a bit too involved to make for a simple self contained example. Travelling with work the next week but will have a look when I get back.&lt;/p&gt;</comment>
                            <comment id="13149449" author="walkerr" created="Mon, 14 Nov 2011 05:36:05 +0000"  >&lt;p&gt;I should have added, we are Windows 7 and also Java 6, so I doubt there should be too many differences.&lt;/p&gt;</comment>
                            <comment id="13153859" author="rickhall" created="Sun, 20 Nov 2011 19:55:33 +0000"  >&lt;p&gt;Rob, I&apos;ve reverted the patch for now, since it covers up the real issue. I&apos;d rather have people suffer the exception so we might find the real solution quicker. You can always reapply the workaround after the 4.0.2 release or locally if you want. Otherwise, continue to help me reproduce it so I can fix it. Thanks.&lt;/p&gt;</comment>
                            <comment id="13161483" author="walkerr" created="Fri, 2 Dec 2011 08:18:17 +0000"  >&lt;p&gt;Battling to recreate this one in an isolated environment.&lt;/p&gt;

&lt;p&gt;Happens every time on a warm start of our application, but can&apos;t seem to isolate the combination of bundles &amp;amp; bindings that trigger it.&lt;/p&gt;</comment>
                            <comment id="13161507" author="walkerr" created="Fri, 2 Dec 2011 09:37:05 +0000"  >&lt;p&gt;Yay! &lt;/p&gt;

&lt;p&gt;Finally nailed the recreation part. What triggers it is the refreshPackages call in the Activator sample code above. That only happens for a bundle with no exports, which wasn&apos;t the case for shell.gui. Swapping to an alternate bundle for the start -t and i can now recreate. Will tidy up my full example and post just now&lt;/p&gt;</comment>
                            <comment id="13161509" author="rickhall" created="Fri, 2 Dec 2011 09:39:39 +0000"  >&lt;p&gt;Good news, thanks for figuring it out.&lt;/p&gt;</comment>
                            <comment id="13161519" author="walkerr" created="Fri, 2 Dec 2011 09:58:54 +0000"  >&lt;p&gt;Worked example for recreating&lt;/p&gt;</comment>
                            <comment id="13161523" author="walkerr" created="Fri, 2 Dec 2011 10:04:13 +0000"  >&lt;p&gt;Well - I&apos;ve only figured how to recreate it, not actually fix the underlying cause. Baby steps &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Have attached a ZIP with the worked example. Afraid it&apos;s a Windows BAT file, should be hard to alter for .SH though.&lt;/p&gt;

&lt;p&gt;I&apos;ve set it up so that only the custom bundles are present (including the original example). The felix standard bundles load from the SVN tree to save upload, and also make it easier to retest when fixed. Just alter the following env var to set where felix is rooted:&lt;/p&gt;

&lt;p&gt;set FELIX_HOME=C:/mnt/MiscProjs/felix&lt;/p&gt;


&lt;p&gt;First you need a cold run to get things going:&lt;/p&gt;

&lt;p&gt;   &amp;gt;go clean&lt;/p&gt;

&lt;p&gt;Initial bundles will load, then a few seconds later the gui plugin will get loaded (that&apos;s really the only purpose of my main.Main class now - to autoload this to make recreating less typing). My output trace looks as follows:&lt;/p&gt;

&lt;p&gt;===&lt;br/&gt;
C:\mnt\tmp\Felix3160&amp;gt;go clean&lt;/p&gt;

&lt;p&gt;C:\mnt\tmp\Felix3160&amp;gt;set EXAMPLE_HOME=C:\mnt\tmp\Felix3160\/.&lt;/p&gt;

&lt;p&gt;C:\mnt\tmp\Felix3160&amp;gt;set FELIX_HOME=C:/mnt/MiscProjs/felix&lt;/p&gt;

&lt;p&gt;C:\mnt\tmp\Felix3160&amp;gt;set CLEAN=none&lt;/p&gt;

&lt;p&gt;C:\mnt\tmp\Felix3160&amp;gt;if &quot;clean&quot; == &quot;clean&quot; set CLEAN=onFirstInit&lt;/p&gt;

&lt;p&gt;C:\mnt\tmp\Felix3160&amp;gt;&quot;C:\Program Files (x86)\Java\jdk1.6.0_27\bin\java&quot; -Dfelix.home=C:/mnt/MiscProjs/felix -Dexample.home=&quot;C:\mnt\t&lt;br/&gt;
mp\Felix3160\/.&quot;  -Dclean=onFirstInit -Dconfig=&quot;C:\mnt\tmp\Felix3160\/./conf/config.properties&quot; -cp C:/mnt/MiscProjs/felix/main/targ&lt;br/&gt;
et/org.apache.felix.main-4.1.0-SNAPSHOT.jar;C:\mnt\tmp\Felix3160\/./lib/main.jar main.Main&lt;br/&gt;
initializeAdmin: org.apache.felix.framework.PackageAdminImpl@b8f82d&lt;br/&gt;
bundleChanged: watchdog &lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt;&lt;br/&gt;
-&amp;gt; bundleChanged: org.osgi.service.obr &lt;span class=&quot;error&quot;&gt;&amp;#91;5&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.osgi.service.obr &lt;span class=&quot;error&quot;&gt;&amp;#91;5&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.apache.felix.shell &lt;span class=&quot;error&quot;&gt;&amp;#91;6&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.apache.felix.shell.tui &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.apache.felix.shell.tui &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.apache.felix.shell.gui &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.apache.felix.shell.gui &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.apache.felix.framework &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.apache.felix.shell.gui.plugin &lt;span class=&quot;error&quot;&gt;&amp;#91;9&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.apache.felix.shell.gui.plugin &lt;span class=&quot;error&quot;&gt;&amp;#91;9&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.apache.felix.shell.gui.plugin &lt;span class=&quot;error&quot;&gt;&amp;#91;9&amp;#93;&lt;/span&gt;&lt;br/&gt;
===&lt;/p&gt;

&lt;p&gt;At this stage Ctrl-C exit. The restart &quot;warm&quot;&lt;/p&gt;

&lt;p&gt;&amp;gt;go&lt;/p&gt;

&lt;p&gt;It seems to be the refreshPackages call that triggers the NPE - which as above, only happens if the auto uninstalled bundle had no exports&lt;/p&gt;

&lt;p&gt;My output trace from the warm start:&lt;/p&gt;

&lt;p&gt;===&lt;br/&gt;
C:\mnt\tmp\Felix3160&amp;gt;go&lt;/p&gt;

&lt;p&gt;C:\mnt\tmp\Felix3160&amp;gt;set EXAMPLE_HOME=C:\mnt\tmp\Felix3160\/.&lt;/p&gt;

&lt;p&gt;C:\mnt\tmp\Felix3160&amp;gt;set FELIX_HOME=C:/mnt/MiscProjs/felix&lt;/p&gt;

&lt;p&gt;C:\mnt\tmp\Felix3160&amp;gt;set CLEAN=none&lt;/p&gt;

&lt;p&gt;C:\mnt\tmp\Felix3160&amp;gt;if &quot;&quot; == &quot;clean&quot; set CLEAN=onFirstInit&lt;/p&gt;

&lt;p&gt;C:\mnt\tmp\Felix3160&amp;gt;&quot;C:\Program Files (x86)\Java\jdk1.6.0_27\bin\java&quot; -Dfelix.home=C:/mnt/MiscProjs/felix -Dexample.home=&quot;C:\mnt\t&lt;br/&gt;
mp\Felix3160\/.&quot;  -Dclean=none -Dconfig=&quot;C:\mnt\tmp\Felix3160\/./conf/config.properties&quot; -cp C:/mnt/MiscProjs/felix/main/target/org.&lt;br/&gt;
apache.felix.main-4.1.0-SNAPSHOT.jar;C:\mnt\tmp\Felix3160\/./lib/main.jar main.Main&lt;br/&gt;
initializeAdmin: org.apache.felix.framework.PackageAdminImpl@b8f82d&lt;br/&gt;
bundleChanged: watchdog &lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.osgi.service.obr &lt;span class=&quot;error&quot;&gt;&amp;#91;5&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.osgi.service.obr &lt;span class=&quot;error&quot;&gt;&amp;#91;5&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.apache.felix.shell &lt;span class=&quot;error&quot;&gt;&amp;#91;6&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.apache.felix.shell.tui &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.apache.felix.shell.tui &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.apache.felix.shell.gui &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;&lt;br/&gt;
-&amp;gt; bundleChanged: org.apache.felix.shell.gui &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.apache.felix.framework &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;&lt;br/&gt;
Removing transient bundle: org.apache.felix.shell.gui.plugin &lt;span class=&quot;error&quot;&gt;&amp;#91;9&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.apache.felix.shell.gui.plugin &lt;span class=&quot;error&quot;&gt;&amp;#91;9&amp;#93;&lt;/span&gt;&lt;br/&gt;
bundleChanged: org.apache.felix.shell.gui.plugin &lt;span class=&quot;error&quot;&gt;&amp;#91;9&amp;#93;&lt;/span&gt;&lt;br/&gt;
refresh: org.apache.felix.shell.gui.plugin &lt;span class=&quot;error&quot;&gt;&amp;#91;9&amp;#93;&lt;/span&gt;&lt;br/&gt;
Framework error, bundle: org.apache.felix.shell.gui.plugin &lt;span class=&quot;error&quot;&gt;&amp;#91;9&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at org.apache.felix.framework.BundleRevisionImpl.close(BundleRevisionImpl.java:639)&lt;br/&gt;
        at org.apache.felix.framework.BundleImpl.closeRevisions(BundleImpl.java:154)&lt;br/&gt;
        at org.apache.felix.framework.BundleImpl.closeAndDelete(BundleImpl.java:138)&lt;br/&gt;
        at org.apache.felix.framework.Felix$RefreshHelper.refreshOrRemove(Felix.java:4648)&lt;br/&gt;
        at org.apache.felix.framework.Felix.refreshPackages(Felix.java:3960)&lt;br/&gt;
        at org.apache.felix.framework.FrameworkWiringImpl.run(FrameworkWiringImpl.java:172)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
===&lt;/p&gt;





</comment>
                            <comment id="13162062" author="rickhall" created="Sat, 3 Dec 2011 07:19:09 +0000"  >&lt;p&gt;I was able to recreate and I&apos;ve determined what is happening.&lt;/p&gt;

&lt;p&gt;Basically, the framework auto-refreshes the bundle when you do an uninstall (since no one depends on it), then your worker explicitly refreshes the uninstalled bundle once it receives the UNINSTALLED event, but at this time the bundle has already been refreshed and is now stale. That&apos;s why the content is already null, since we end up refreshing a stale bundle.&lt;/p&gt;

&lt;p&gt;During the refactoring for the the R4.3 API, we must have lost a check somewhere that avoided this situation. I believe the proper thing to do here is to just ignore stale bundles when refreshing. I&apos;ll investigate whether this is the correct behavior and, if so, will implement a fix.&lt;/p&gt;</comment>
                            <comment id="13162064" author="rickhall" created="Sat, 3 Dec 2011 07:37:56 +0000"  >&lt;p&gt;I&apos;ve committed a patch that turns such an occurrence into a no-op, assuming for now that this is the right thing to do. Please check that the trunk framework fixes the issue for you. Thanks for your help.&lt;/p&gt;</comment>
                            <comment id="13162635" author="walkerr" created="Mon, 5 Dec 2011 06:45:40 +0000"  >&lt;p&gt;Thanks for the patch. Has fixed the NPE on our startup, good news as it means we can move back to trunk version.&lt;br/&gt;
Let me know if I should close the issue, or if you&apos;d rather leave open until you&apos;ve had a chance to investigate correct behaviour.&lt;/p&gt;</comment>
                            <comment id="13162641" author="rickhall" created="Mon, 5 Dec 2011 06:59:17 +0000"  >&lt;p&gt;Leave it open for now. I&apos;ll close it once I&apos;m certain. Thanks for verifying the fix.&lt;/p&gt;</comment>
                            <comment id="13393373" author="rickhall" created="Sat, 16 Jun 2012 19:30:38 +0000"  >&lt;p&gt;I guess this is fine. I&apos;m closing it as fixed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12503365" name="Activator.java" size="8793" author="walkerr" created="Fri, 11 Nov 2011 11:26:46 +0000"/>
                            <attachment id="12505866" name="Felix3160.zip" size="23212" author="walkerr" created="Fri, 2 Dec 2011 09:58:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>74145</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 23 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1aujz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>271416</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>