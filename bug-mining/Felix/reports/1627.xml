<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:42:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3639] SCR &quot;need write lock&quot; assertion error</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3639</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;This issue is related to the post &lt;a href=&quot;http://www.mail-archive.com/dev@felix.apache.org/msg26360.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/dev@felix.apache.org/msg26360.html&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Initially, the post was about an apparent deadlock, where SCR can&apos;t obtain its state lock timely.&lt;br/&gt;
But after having added some tracking code in SCR, we came across another (probably different) problem,&lt;br/&gt;
where the &quot;need write lock (createComponent)&quot; assertion fails from the ImmediateComponentManager.createComponent() method.&lt;/p&gt;

&lt;p&gt;In order to see the full stacktrace, I have modified the ImmediateComponentManager.createComponent method with a log, like this:&lt;/p&gt;

&lt;p&gt;    protected boolean createComponent()&lt;br/&gt;
    {&lt;br/&gt;
        if ( !isWriteLocked() )&lt;/p&gt;
        {
            log(LogService.LOG_ERROR, &quot;need write lock (createComponent)&quot;, new Object[0], new Exception(&quot;stacktrace&quot;)); throw new IllegalStateException( &quot;need write lock (createComponent)&quot; );
        }
&lt;p&gt;        ...&lt;br/&gt;
(I just added a log with a &quot;stacktrace&quot; exception, just before throwing the illegal state).&lt;/p&gt;

&lt;p&gt;I have attached the full log to this issue, with ds.loglevel set to DEBUG.&lt;br/&gt;
Please take a look at line line 8143, where the assertion fails.&lt;/p&gt;

&lt;p&gt;It&apos;s difficult to explain the whole context, but I will try to give a quick overview:&lt;/p&gt;

&lt;p&gt;1- the &quot;sipagent&quot; component is declared like this (we are using bnd DS annotations):&lt;/p&gt;

&lt;p&gt;@Component(name=&quot;sipagent&quot;,provide=&lt;/p&gt;
{com.nextenso.mux.MuxHandler.class,SipAgent.class}
&lt;p&gt;,properties=(&quot;protocol=sip&quot;),configurationPolicy=ConfigurationPolicy.require,factory=&quot;composite.sip&quot;)&lt;br/&gt;
public class SipAgentActivator extends SipAgent implements ServiceListener {&lt;br/&gt;
...&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;Here, the SipAgentActivator class actually extends SipAgent, which extends the MuxHandler abstract class, and the MuxHandler abstract class is provided as an OSGi service, using a &quot;protocol=sip&quot; service property.&lt;/p&gt;

&lt;p&gt;The &quot;sipagent&quot; component is also declared as a factory component (with name=&quot;composite.sip&quot;), and another manager is in charge of instantiating the &quot;sipagent&quot; component instances (using ComponentFactory.newInstance() method). When the sip message load increases, more sipagent component instances are created.&lt;/p&gt;

&lt;p&gt;2- when one &quot;sipagent&quot; component instance is created, there is another tracking &quot;agent&quot; component, which has a Reference on the MuxHandler interface, provided by the &quot;sipagent&quot; component. We use a ServiceReference. Here is how the &quot;agent&quot; component defines its reference:&lt;/p&gt;

&lt;p&gt;@Component(name = &quot;agent&quot;,  configurationPolicy = ConfigurationPolicy.require)&lt;br/&gt;
public class Agent {&lt;/p&gt;

&lt;p&gt;  @Reference(service = MuxHandler.class, type = &apos;*&apos;, unbind = &quot;unbindMuxHandler&quot;)&lt;br/&gt;
  public void bindMuxHandler(final ServiceReference&amp;lt;?&amp;gt; muxHandler) {&lt;br/&gt;
    _logger.info(&quot;bound mux handler (protocol=%s)&quot;, muxHandler.getProperty(&quot;protocol&quot;));&lt;br/&gt;
    _serial.execute(new Runnable() {&lt;br/&gt;
      public void run() {&lt;br/&gt;
        if (!_started) &lt;/p&gt;
{
          _pendingMuxHandlers.add(muxHandler);
        }
&lt;p&gt; else {&lt;br/&gt;
           ...&lt;/p&gt;

&lt;p&gt;Here, the &quot;agent&quot; is tracking every mux handlers, but if the &quot;agent&quot; component is not yet started, then the mux handler is simply stored in the &quot;pendingMuxHandlers&quot; temporary list. The _serial object is a serial executor, used to avoid synchronized methods.&lt;/p&gt;

&lt;p&gt;3- The &quot;agent&quot; component also have a Reference on a &quot;SessionManager&quot; service, and when this service is injected, then then the &quot;agent&quot; component decides to handle the sip MuxHandler stored in the pendingMuxHandlers temporary list. At this point, the &quot;agent&quot; gets the MuxHandler ServiceReference from the temporary list, and directly calls BundleContext.getService(ServiceReference), in order to get the pointer to the actual MuxHandler object.&lt;/p&gt;

&lt;p&gt;But the BundleContext.getService method returns null, and internally, the ImmediateComponentManager.createComponent has throws an IllegalStateException because the writelock has not been aquired.&lt;/p&gt;

&lt;p&gt;See stacktrace, starting from line 8143 (it is the log I have added in the ImmediateComponentManager.createComponent method):&lt;/p&gt;

&lt;p&gt;2012-08-27 13:07:45,909 Processing-ThreadPool-10 ERROR osgi  - &lt;span class=&quot;error&quot;&gt;&amp;#91;sipagent&amp;#93;&lt;/span&gt; need write lock (createComponent)&lt;/p&gt;

&lt;p&gt;java.lang.Exception: stacktrace&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.ImmediateComponentManager.createComponent(ImmediateComponentManager.java:123)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$FactoryInstance.getService(AbstractComponentManager.java:1570)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.ImmediateComponentManager.getService(ImmediateComponentManager.java:632)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.getFactoryUnchecked(ServiceRegistrationImpl.java:308)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.getService(ServiceRegistrationImpl.java:219)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistry.getService(ServiceRegistry.java:310)&lt;br/&gt;
	at org.apache.felix.framework.Felix.getService(Felix.java:3420)&lt;br/&gt;
	at org.apache.felix.framework.BundleContextImpl.getService(BundleContextImpl.java:468)&lt;br/&gt;
	at com.nextenso.agent.Agent$9.run(Agent.java:427)&lt;br/&gt;
	at com.alcatel.as.service.concurrent.SerialExecutor.execute(SerialExecutor.java:41)&lt;br/&gt;
	at com.nextenso.agent.Agent.bindSessionManager(Agent.java:362)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:616)&lt;br/&gt;
	at org.apache.felix.scr.impl.helper.BaseMethod.invokeMethod(BaseMethod.java:226)&lt;br/&gt;
	at org.apache.felix.scr.impl.helper.BaseMethod.access$500(BaseMethod.java:37)&lt;br/&gt;
	at org.apache.felix.scr.impl.helper.BaseMethod$Resolved.invoke(BaseMethod.java:603)&lt;br/&gt;
	at org.apache.felix.scr.impl.helper.BaseMethod$NotResolved.invoke(BaseMethod.java:560)&lt;br/&gt;
	at org.apache.felix.scr.impl.helper.BaseMethod.invoke(BaseMethod.java:484)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethod(DependencyManager.java:1086)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.serviceAdded(DependencyManager.java:328)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:170)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4260)&lt;br/&gt;
	at org.apache.felix.framework.Felix.registerService(Felix.java:3275)&lt;br/&gt;
	at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
	at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:320)&lt;br/&gt;
	at com.alcatel.as.util.osgi.DependencyActivatorHelper.registerService(DependencyActivatorHelper.java:209)&lt;br/&gt;
	at com.alcatel.as.session.distributed.mgr.Engine$7.run(Engine.java:1383)&lt;br/&gt;
	at com.alcatel.as.service.concurrent.impl.Helper.runTask(Helper.java:54)&lt;br/&gt;
	at com.alcatel.as.service.concurrent.impl.QueueExecutor$1.run(QueueExecutor.java:165)&lt;br/&gt;
	at com.alcatel.as.service.concurrent.impl.SerialQueue.run(SerialQueue.java:80)&lt;br/&gt;
	at alcatel.tess.hometop.gateways.concurrent.ThreadPool$3.run(ThreadPool.java:286)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:679)&lt;/p&gt;


&lt;p&gt;Is the attached log enough with ds.loglevel=DEBUG, or do you need some more informations ?&lt;/p&gt;</description>
                <environment>openjdk version &amp;quot;1.6.0-OpenSCG-Build-24&amp;quot;, on Red Hat Enterprise Linux Server release 5.4 (Tikanga)&lt;br/&gt;
</environment>
        <key id="12605064">FELIX-3639</key>
            <summary>SCR &quot;need write lock&quot; assertion error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="djencks">David Jencks</assignee>
                                    <reporter username="pderop">Pierre De Rop</reporter>
                        <labels>
                    </labels>
                <created>Mon, 27 Aug 2012 12:24:08 +0000</created>
                <updated>Tue, 20 Nov 2012 10:58:14 +0000</updated>
                            <resolved>Wed, 5 Sep 2012 21:32:28 +0000</resolved>
                                                    <fixVersion>scr-1.6.2</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13442374" author="pderop" created="Mon, 27 Aug 2012 12:25:26 +0000"  >&lt;p&gt;Here is the log file, using ds.loglevel=DEBUG&lt;/p&gt;</comment>
                            <comment id="13442840" author="djencks" created="Tue, 28 Aug 2012 00:34:21 +0000"  >&lt;p&gt;I didn&apos;t see how to write a good test yet, but I think I see what is going on and I think I fixed it in rev 1377921.  Could you try it out?  I&apos;d expect the error you saw to be very consistent so if its fixed it should be obvious.&lt;/p&gt;</comment>
                            <comment id="13443046" author="pderop" created="Tue, 28 Aug 2012 09:38:31 +0000"  >&lt;p&gt;Thank your David, your fix is working fine and I don&apos;t have the &quot;need write lock&quot; assertion error anymore.&lt;br/&gt;
I&apos;m now going back to reproduce the initial deadlock issue.&lt;/p&gt;

&lt;p&gt;Should I close this issue, or will you do it ?&lt;/p&gt;</comment>
                            <comment id="13443261" author="djencks" created="Tue, 28 Aug 2012 16:48:50 +0000"  >&lt;p&gt;Seems to be fixed.&lt;/p&gt;</comment>
                            <comment id="13449161" author="djencks" created="Wed, 5 Sep 2012 21:32:03 +0000"  >&lt;p&gt;assign to me&lt;/p&gt;</comment>
                            <comment id="13501021" author="fmeschbe" created="Tue, 20 Nov 2012 10:58:14 +0000"  >&lt;p&gt;Close after release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12542594" name="NeedWriteLock.log" size="1482212" author="pderop" created="Mon, 27 Aug 2012 12:25:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>246072</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i07gnj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>41464</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>