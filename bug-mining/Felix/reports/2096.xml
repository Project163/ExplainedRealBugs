<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:52:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-4350] Component wrongly activated</title>
                <link>https://issues.apache.org/jira/browse/FELIX-4350</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description></description>
                <environment></environment>
        <key id="12683572">FELIX-4350</key>
            <summary>Component wrongly activated</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="djencks">David Jencks</assignee>
                                    <reporter username="gnodet">Guillaume Nodet</reporter>
                        <labels>
                    </labels>
                <created>Mon, 9 Dec 2013 10:41:35 +0000</created>
                <updated>Wed, 6 Aug 2014 02:21:51 +0000</updated>
                            <resolved>Thu, 12 Dec 2013 18:52:55 +0000</resolved>
                                                    <fixVersion>scr-1.8.2</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13843052" author="gnt" created="Mon, 9 Dec 2013 10:46:03 +0000"  >&lt;p&gt;The problem seems to happen between 2013-12-09 11:34:09,210 and 2013-12-09 11:34:09,238.&lt;/p&gt;

&lt;p&gt;The GitHttpServerRegistrationHandler component is bound to an HttpService in a stopped state (this service uses a ServiceFactory and the state is changed when the service is ungot, which usually means that this service is not registered anymore in the OSGi registry).&lt;/p&gt;</comment>
                            <comment id="13843113" author="gnt" created="Mon, 9 Dec 2013 12:37:29 +0000"  >&lt;p&gt;It seems that when tracking the httpService, SIngleStaticCustomizer#removedService() is called between the calls to prebind() and getRefs(), but the refPair field isn&apos;t set to null.&lt;/p&gt;

&lt;p&gt;I wonder if a call to refPair.setFailed() in the removedService() call would help.&lt;/p&gt;</comment>
                            <comment id="13843239" author="gnt" created="Mon, 9 Dec 2013 15:35:08 +0000"  >&lt;p&gt;I have written a junit test that shows the problem.&lt;br/&gt;
It&apos;s basically the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void test_unbind_while_activating()
    {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Component main = findComponentByName(&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.felix.scr.integration.components.Felix4350Component&quot;&lt;/span&gt;);
        TestCase.assertNotNull(main);

        ServiceRegistration dep1Reg = bundleContext.registerService(SimpleComponent.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName(),
                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ServiceFactory() {
                    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; getService(Bundle bundle, ServiceRegistration registration) {
                        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleComponent();
                    }
                    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void ungetService(Bundle bundle, ServiceRegistration registration, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; service) {
                    }
                }, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
        ServiceRegistration dep2Reg = bundleContext.registerService(SimpleComponent2.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName(),
                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ServiceFactory() {
                    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; getService(Bundle bundle, ServiceRegistration registration) {
                        delay(1000);
                        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleComponent2();
                    }
                    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void ungetService(Bundle bundle, ServiceRegistration registration, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; service) {
                    }
                }, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);

        main.enable();
        delay(300);
        dep1Reg.unregister();
        delay(2000);

        ComponentInstance mainCompInst = main.getComponentInstance();

        TestCase.assertNull(mainCompInst);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Where the Felix4350Component is defined with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;components xmlns:scr=&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//www.osgi.org/xmlns/scr/v1.1.0&quot;&lt;/span&gt;&amp;gt;
&lt;/span&gt;
    &amp;lt;scr:component xmlns:scr=&lt;span class=&quot;code-quote&quot;&gt;&apos;http:&lt;span class=&quot;code-comment&quot;&gt;//www.osgi.org/xmlns/scr/v1.1.0&apos;&lt;/span&gt;
&lt;/span&gt;                   enabled=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&apos;&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.felix.scr.integration.components.Felix4350Component&apos;&lt;/span&gt;
                   activate=&lt;span class=&quot;code-quote&quot;&gt;&apos;start&apos;&lt;/span&gt; deactivate=&lt;span class=&quot;code-quote&quot;&gt;&apos;stop&apos;&lt;/span&gt;&amp;gt;
        &amp;lt;implementation
                class=&lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.felix.scr.integration.components.Felix4350Component&apos;&lt;/span&gt; /&amp;gt;
        &amp;lt;reference name=&lt;span class=&quot;code-quote&quot;&gt;&apos;component1&apos;&lt;/span&gt;
                   &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.felix.scr.integration.components.SimpleComponent&apos;&lt;/span&gt;
                   cardinality=&lt;span class=&quot;code-quote&quot;&gt;&apos;1..1&apos;&lt;/span&gt; bind=&lt;span class=&quot;code-quote&quot;&gt;&apos;bindComponent1&apos;&lt;/span&gt; unbind=&lt;span class=&quot;code-quote&quot;&gt;&apos;unbindComponent1&apos;&lt;/span&gt; policy=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;&apos;&lt;/span&gt; /&amp;gt;
        &amp;lt;reference name=&lt;span class=&quot;code-quote&quot;&gt;&apos;component2&apos;&lt;/span&gt;
                   &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.felix.scr.integration.components.SimpleComponent2&apos;&lt;/span&gt;
                   cardinality=&lt;span class=&quot;code-quote&quot;&gt;&apos;1..1&apos;&lt;/span&gt; bind=&lt;span class=&quot;code-quote&quot;&gt;&apos;bindComponent2&apos;&lt;/span&gt; unbind=&lt;span class=&quot;code-quote&quot;&gt;&apos;unbindComponent2&apos;&lt;/span&gt; policy=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;&apos;&lt;/span&gt; /&amp;gt;
    &amp;lt;/scr:component&amp;gt;

&amp;lt;/components&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The explanation is the following:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the 2 dependencies are registered&lt;/li&gt;
	&lt;li&gt;main is enabled&lt;/li&gt;
	&lt;li&gt;it will go into the prebind() phase and call the first dependency factory, and the second one&lt;/li&gt;
	&lt;li&gt;while the second while is waiting, the first dependency is unregistered&lt;/li&gt;
	&lt;li&gt;the component is created and bound to an unregistered service&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;ll now work on a fix.&lt;/p&gt;</comment>
                            <comment id="13843305" author="gnt" created="Mon, 9 Dec 2013 16:37:15 +0000"  >&lt;p&gt;It seems that all customizers suffer from the same problem ...&lt;/p&gt;</comment>
                            <comment id="13843503" author="gnt" created="Mon, 9 Dec 2013 20:20:48 +0000"  >&lt;p&gt;I&apos;ve committed the integration test (disabled), but not sure how to fix it.&lt;br/&gt;
The attempts I&apos;ve made so far cause other tests to fail &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Committing to &lt;a href=&quot;https://svn.apache.org/repos/asf/felix/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/felix/trunk&lt;/a&gt; ...&lt;br/&gt;
	A	scr/src/test/java/org/apache/felix/scr/integration/Felix4350Test.java&lt;br/&gt;
	A	scr/src/test/java/org/apache/felix/scr/integration/components/Felix4350Component.java&lt;br/&gt;
	A	scr/src/test/resources/integration_test_FELIX_4350.xml&lt;br/&gt;
Committed r1549666&lt;/p&gt;</comment>
                            <comment id="13843797" author="djencks" created="Tue, 10 Dec 2013 01:21:27 +0000"  >&lt;p&gt;I committed a fix for this that I think is OK but exposes another problem.  My fix adds a &quot;deleted&quot; field to RefPair and checks that a RefPair is not deleted before trying to bind it.  So if a removedService event comes in before starting to open a dependency manager on an instance object, the ref pair will be marked deleted and binding wont happen, and if it comes in after the open starts the open latch should prevent anything happening until after the bind is complete. (rev 1549723)&lt;/p&gt;

&lt;p&gt;However, with this change I get a consistent NPE in Felix3680Test where the service tracker is calling removedService will a null tracking object.  I think I introduced a bug in untrack in that a remove event may come in before initial is populated.  Restoring the &quot;if tracked object is null return&quot; should fix this. (rev 1549728)&lt;/p&gt;

&lt;p&gt;Can you review this and look for problems?&lt;/p&gt;</comment>
                            <comment id="13844412" author="gnt" created="Tue, 10 Dec 2013 16:57:04 +0000"  >&lt;p&gt;Thanks for the patch.  I&apos;ve tested it and unfortunately, my use case isn&apos;t solved.&lt;br/&gt;
I&apos;ve extended the integration test to cover that.&lt;/p&gt;

&lt;p&gt;As indicated by the test, it seems the component can not recover properly when the dependency is registered after a missed attempt to activate.&lt;/p&gt;

&lt;p&gt;Committing to &lt;a href=&quot;https://svn.apache.org/repos/asf/felix/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/felix/trunk&lt;/a&gt; ...&lt;br/&gt;
	M	scr/src/test/java/org/apache/felix/scr/integration/Felix4350Test.java&lt;br/&gt;
Committed r1549890&lt;/p&gt;</comment>
                            <comment id="13844918" author="djencks" created="Wed, 11 Dec 2013 01:33:16 +0000"  >&lt;p&gt;That was harder &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; but I got the test passing again.  Review and more tests would be great.&lt;/p&gt;</comment>
                            <comment id="14087147" author="djencks" created="Wed, 6 Aug 2014 02:21:51 +0000"  >&lt;p&gt;closing remaining 1.8.2 resolved issues&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12617807" name="karaf.log" size="286718" author="gnodet" created="Mon, 9 Dec 2013 10:46:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>362645</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 16 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qie7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>362939</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>