<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:11:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5776] Memory Leak by Config Admin</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5776</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;I have a heapdump (which I cannot share publicly) of a karaf container which crashed due to out of memory.&lt;/p&gt;

&lt;p&gt;The Heapdump shows 30mb occupied by&#160;org.apache.felix.cm.impl.CachingPersistenceManagerProxy including several related classes.&lt;/p&gt;

&lt;p&gt;I am going to attach a few screenshots from MAT/JProfiler.&lt;/p&gt;

&lt;p&gt;There are a few threads involved which look interesting.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
  Thread &quot;CM Configuration Updater (Delete: pid=ce24c1344-88bb-4c66-bebc-527cc574f347)&quot;:
    at sun.misc.Unsafe.park(boolean, long)
    at java.util.concurrent.locks.LockSupport.park(java.lang.Object) (line: 175)
    at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt() (line: 836)
    at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(java.util.concurrent.locks.AbstractQueuedSynchronizer$Node, int) (line: 870)
    at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(int) (line: 1199)
    at java.util.concurrent.locks.ReentrantReadWriteLock$WriteLock.lock() (line: 943)
    at org.apache.felix.cm.impl.CachingPersistenceManagerProxy.store(java.lang.String, java.util.Dictionary) (line: 245)
    at org.apache.felix.cm.impl.Factory.store() (line: 137)
    at org.apache.felix.cm.impl.ConfigurationManager$DeleteConfiguration.run() (line: 1876)
    at org.apache.felix.cm.impl.UpdateThread.run0(java.lang.Runnable) (line: 141)
    at org.apache.felix.cm.impl.UpdateThread.run() (line: 109)
    at java.lang.Thread.run() (line: 748)

  Thread &quot;updater-thread-1&quot;:
    at sun.misc.Unsafe.park(boolean, long)
    at java.util.concurrent.locks.LockSupport.park(java.lang.Object) (line: 175)
    at java.util.concurrent.FutureTask.awaitDone(boolean, long) (line: 429)
    at java.util.concurrent.FutureTask.get() (line: 191)
    at org.apache.karaf.features.internal.service.FeaturesServiceImpl.doProvisionInThread(java.util.Map, java.util.Map, org.apache.karaf.features.internal.service.State, java.util.EnumSet) (line: 1134)
    at org.apache.karaf.features.internal.service.FeaturesServiceImpl.addRequirements(java.util.Map, java.util.EnumSet) (line: 1077)

  Thread &quot;features-1-thread-1&quot;:
    at sun.misc.Unsafe.park(boolean, long)
    at java.util.concurrent.locks.LockSupport.park(java.lang.Object) (line: 175)
    at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt() (line: 836)
    at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireShared(int) (line: 967)
    at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireShared(int) (line: 1283)
    at java.util.concurrent.locks.ReentrantReadWriteLock$ReadLock.lock() (line: 727)
    at org.apache.felix.cm.impl.CachingPersistenceManagerProxy.getDictionaries(org.apache.felix.cm.impl.SimpleFilter) (line: 137)
    at org.apache.felix.cm.impl.ConfigurationManager.listConfigurations(org.apache.felix.cm.impl.ConfigurationAdminImpl, java.lang.String) (line: 660)
    at org.apache.felix.cm.impl.ConfigurationAdminImpl.listConfigurations(java.lang.String) (line: 190)
    at org.apache.felix.scr.impl.manager.RegionConfigurationSupport.findConfigurations(org.osgi.service.cm.ConfigurationAdmin, java.lang.String) (line: 605)
    at org.apache.felix.scr.impl.manager.RegionConfigurationSupport.findFactoryConfigurations(org.osgi.service.cm.ConfigurationAdmin, java.lang.String, org.osgi.framework.Bundle) (line: 540)
    at org.apache.felix.scr.impl.manager.RegionConfigurationSupport.configureComponentHolder(org.apache.felix.scr.impl.manager.ComponentHolder) (line: 143)
    at org.apache.felix.scr.impl.BundleComponentActivator.setRegionConfigurationSupport(org.osgi.framework.ServiceReference) (line: 833)
    at org.apache.felix.scr.impl.helper.ConfigAdminTracker$1.addingService(org.osgi.framework.ServiceReference) (line: 71)
    at org.apache.felix.scr.impl.helper.ConfigAdminTracker$1.addingService(org.osgi.framework.ServiceReference) (line: 43)
    at org.osgi.util.tracker.ServiceTracker$Tracked.customizerAdding(org.osgi.framework.ServiceReference, org.osgi.framework.ServiceEvent) (line: 941)
    at org.osgi.util.tracker.ServiceTracker$Tracked.customizerAdding(java.lang.Object, java.lang.Object) (line: 870)
    at org.osgi.util.tracker.AbstractTracked.trackAdding(java.lang.Object, java.lang.Object) (line: 256)
    at org.osgi.util.tracker.AbstractTracked.trackInitial() (line: 183)
    at org.osgi.util.tracker.ServiceTracker.open(boolean) (line: 318)
    at org.osgi.util.tracker.ServiceTracker.open() (line: 261)
    at org.apache.felix.scr.impl.helper.ConfigAdminTracker.&amp;lt;init&amp;gt;(org.apache.felix.scr.impl.manager.ComponentActivator) (line: 88)
    at org.apache.felix.scr.impl.BundleComponentActivator.&amp;lt;init&amp;gt;(org.apache.felix.scr.impl.helper.SimpleLogger, org.apache.felix.scr.impl.ComponentRegistry, org.apache.felix.scr.impl.ComponentActorThread, org.osgi.framework.BundleContext, org.apache.felix.scr.impl.manager.ScrConfiguration) (line: 274)
    at org.apache.felix.scr.impl.Activator.loadComponents(org.osgi.framework.Bundle) (line: 388)
    at org.apache.felix.scr.impl.Activator.access$200(org.apache.felix.scr.impl.Activator, org.osgi.framework.Bundle) (line: 54)
    at org.apache.felix.scr.impl.Activator$ScrExtension.start() (line: 265)
    at org.apache.felix.utils.extender.AbstractExtender.createExtension(org.osgi.framework.Bundle) (line: 254)
    at org.apache.felix.utils.extender.AbstractExtender.modifiedBundle(org.osgi.framework.Bundle, org.osgi.framework.BundleEvent, java.lang.Object) (line: 227)
    at org.osgi.util.tracker.BundleTracker$Tracked.customizerModified(org.osgi.framework.Bundle, org.osgi.framework.BundleEvent, java.lang.Object) (line: 482)
    at org.osgi.util.tracker.BundleTracker$Tracked.customizerModified(java.lang.Object, java.lang.Object, java.lang.Object) (line: 415)
    at org.osgi.util.tracker.AbstractTracked.track(java.lang.Object, java.lang.Object) (line: 232)
    at org.osgi.util.tracker.BundleTracker$Tracked.bundleChanged(org.osgi.framework.BundleEvent) (line: 444)
    at org.apache.felix.framework.EventDispatcher.invokeBundleListenerCallback(org.osgi.framework.Bundle, java.util.EventListener, java.util.EventObject) (line: 915)
    at org.apache.felix.framework.EventDispatcher.fireEventImmediately(org.apache.felix.framework.EventDispatcher, int, java.util.Map, java.util.EventObject, java.util.Dictionary) (line: 834)
    at org.apache.felix.framework.EventDispatcher.fireBundleEvent(org.osgi.framework.BundleEvent, org.apache.felix.framework.Felix) (line: 516)
    at org.apache.felix.framework.Felix.fireBundleEvent(int, org.osgi.framework.Bundle) (line: 4563)
    at org.apache.felix.framework.Felix.startBundle(org.apache.felix.framework.BundleImpl, int) (line: 2173)
    at org.apache.felix.framework.BundleImpl.start(int) (line: 998)
    at org.apache.felix.framework.BundleImpl.start() (line: 984)
    at org.apache.karaf.features.internal.service.FeaturesServiceImpl.startBundle(org.osgi.framework.Bundle) (line: 1346)
    at org.apache.karaf.features.internal.service.Deployer.deploy(org.apache.karaf.features.internal.service.Deployer$DeploymentState, org.apache.karaf.features.internal.service.Deployer$DeploymentRequest) (line: 891)
    at org.apache.karaf.features.internal.service.FeaturesServiceImpl.doProvision(java.util.Map, java.util.Map, org.apache.karaf.features.internal.service.State, java.util.EnumSet, java.lang.String) (line: 1233)
    at org.apache.karaf.features.internal.service.FeaturesServiceImpl.lambda$doProvisionInThread$0(java.util.Map, java.util.Map, org.apache.karaf.features.internal.service.State, java.util.EnumSet, java.lang.String) (line: 1132)
    at org.apache.karaf.features.internal.service.FeaturesServiceImpl$$Lambda$16.call()
    at java.util.concurrent.FutureTask.run() (line: 266)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(java.util.concurrent.ThreadPoolExecutor$Worker) (line: 1142)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run() (line: 617)
    at java.lang.Thread.run() (line: 748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This might as well be a karaf bug.&lt;/p&gt;

&lt;p&gt;While it looks like a memory leak, I could also suspect that this might be cause by a concurrency problem, as the threadump shows multiple updating threads.&lt;/p&gt;

&lt;p&gt;I can provide more details if required, or share the dump privately.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13132631">FELIX-5776</key>
            <summary>Memory Leak by Config Admin</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cziegeler">Carsten Ziegeler</assignee>
                                    <reporter username="fabianlange">Fabian Lange</reporter>
                        <labels>
                    </labels>
                <created>Mon, 22 Jan 2018 10:29:44 +0000</created>
                <updated>Wed, 12 Jun 2019 07:50:40 +0000</updated>
                            <resolved>Wed, 12 Jun 2019 07:50:32 +0000</resolved>
                                    <version>configadmin-1.8.16</version>
                                    <fixVersion>configadmin-1.9.0</fixVersion>
                                    <component>Configuration Admin</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16334127" author="fabianlange" created="Mon, 22 Jan 2018 10:43:04 +0000"  >&lt;p&gt;Also interesting, there is no thread that holds the lock the others are waiting on, maybe it died/stopped without freeing the lock&lt;/p&gt;</comment>
                            <comment id="16334154" author="fabianlange" created="Mon, 22 Jan 2018 11:00:24 +0000"  >&lt;p&gt;I remember I provided a patch for . &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5443&quot; title=&quot;Frequent Changes cause UpdateThread to ConcurrentModificationException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5443&quot;&gt;&lt;del&gt;FELIX-5443&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/felix/commit/4da58686059cff3e85513e3d7564348e6690c7bd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/felix/commit/4da58686059cff3e85513e3d7564348e6690c7bd&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;imho this looks like a related problem. maybe it is still the problem i had before and the fix is incomplete&lt;/p&gt;</comment>
                            <comment id="16334158" author="fabianlange" created="Mon, 22 Jan 2018 11:11:49 +0000"  >&lt;p&gt;I checked configurations that are still in the dicstionary, they are factory configurations for components that no longer exist.&lt;br/&gt;
So apparently at least the deletion from memory failed&lt;br/&gt;
The update task is still backlogged with 166 deletions, but there are way more in the dictionary that do not correspond to a running service instance.&lt;/p&gt;</comment>
                            <comment id="16335721" author="cziegeler" created="Tue, 23 Jan 2018 12:38:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fabianlange&quot; class=&quot;user-hover&quot; rel=&quot;fabianlange&quot;&gt;fabianlange&lt;/a&gt; Thanks for reporting - so far I&apos;ve not seen a memory problem with the config admin; however in our use cases configurations are mostly static and don&apos;t change over time.&lt;/p&gt;

&lt;p&gt;I guess the first thing would be to correct the removal of removed factory configurations. In recent versions I&apos;ve seen other strange things, like invalid notification of configuration changes, but I haven&apos;t had time to track them down.&lt;/p&gt;</comment>
                            <comment id="16336364" author="cziegeler" created="Tue, 23 Jan 2018 20:55:12 +0000"  >&lt;p&gt;I&apos;ve added a basic test, inspecting the behaviour of deleting factory configs. This looks ok.&lt;/p&gt;

&lt;p&gt;Now, if the update thread has still tasks, then this could explain why the memory is not cleaned up, because the update task is actually doing this. The locking wrt factory configurations looks strange and incomplete to me. I&apos;ll have a deeper look into that&lt;/p&gt;

&lt;p&gt;Just to be sure, are you using custom persistence managers?&lt;/p&gt;</comment>
                            <comment id="16336428" author="fabianlange" created="Tue, 23 Jan 2018 21:53:46 +0000"  >&lt;p&gt;using a stock karaf. Not sure if the karaf one counts as custom&lt;/p&gt;</comment>
                            <comment id="16340093" author="cziegeler" created="Thu, 25 Jan 2018 21:15:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fabianlange&quot; class=&quot;user-hover&quot; rel=&quot;fabianlange&quot;&gt;fabianlange&lt;/a&gt; I&apos;ve refactored the factory configuration handling as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5778&quot; title=&quot;Refactor factory configuration handling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5778&quot;&gt;&lt;del&gt;FELIX-5778&lt;/del&gt;&lt;/a&gt;, it would be great if you could give the latest snapshot a try&lt;/p&gt;</comment>
                            <comment id="16340181" author="fabianlange" created="Thu, 25 Jan 2018 22:11:05 +0000"  >&lt;p&gt;Carsten, the code looks much cleaner now with more centralized synchronisation.&lt;br/&gt;
Ill give it a try, but no guaranttes on reproducing the problem, it only happens once in a while.&lt;br/&gt;
I could share the heap dump with you if you want to have a peek&lt;/p&gt;</comment>
                            <comment id="16425399" author="cziegeler" created="Wed, 4 Apr 2018 12:11:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fabianlange&quot; class=&quot;user-hover&quot; rel=&quot;fabianlange&quot;&gt;fabianlange&lt;/a&gt; Do you have any updates, whether &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5778&quot; title=&quot;Refactor factory configuration handling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5778&quot;&gt;&lt;del&gt;FELIX-5778&lt;/del&gt;&lt;/a&gt; might have fixed this issue?&lt;/p&gt;</comment>
                            <comment id="16426735" author="fabianlange" created="Thu, 5 Apr 2018 10:43:18 +0000"  >&lt;p&gt;I tried once, of course it did not reproduce.&lt;br/&gt;
I guess i can only give insightful feedback once its available downstream via karaf and we can ship that to customers&lt;/p&gt;</comment>
                            <comment id="16861834" author="cziegeler" created="Wed, 12 Jun 2019 07:50:32 +0000"  >&lt;p&gt;This is hopefully fixed with &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5778&quot; title=&quot;Refactor factory configuration handling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5778&quot;&gt;&lt;del&gt;FELIX-5778&lt;/del&gt;&lt;/a&gt;. If not please open a new issue against the latest version. Thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12907079" name="Screen Shot 2018-01-22 at 11.26.39.png" size="400354" author="fabianlange" created="Mon, 22 Jan 2018 10:27:11 +0000"/>
                            <attachment id="12907078" name="Screen Shot 2018-01-22 at 11.28.14.png" size="105034" author="fabianlange" created="Mon, 22 Jan 2018 10:28:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 23 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3p6d3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>