<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:41:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3306] Lazy activation of bundles is not always working as expected</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3306</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;When loading a class from a &quot;lazy&quot; bundle (e.g. Bundle-ActivationPolicy: lazy) the bundle is not always activated.&lt;br/&gt;
More precisely, when a bundle is triggering the activation of a chain of more than one lazy bundle (due to a class loading) not all the bundles in the chain are activated.&lt;/p&gt;

&lt;p&gt;Example:&lt;br/&gt;
Let say we have 3 bundles: bundle1, bundle2 and bundle3. All those bundles are defining a lazy activation via: &apos;Bundle-ActivationPolicy: lazy&apos;.&lt;br/&gt;
In the activator of bundle1 we load a class from bundle2. In activator of bundle2 we load a class from bundle3.&lt;br/&gt;
By starting (from the felix command line) the bundle1 - only the bundle2 will be activated even if the class from bundle3 is successfully loaded by the activator of bundle2.&lt;/p&gt;

&lt;p&gt;You can find attached 3 bundles you can use to reproduce the bug. (they also contains the source code)&lt;/p&gt;

&lt;p&gt;To reproduce the bug: &lt;br/&gt;
Install a felix 4.0.2 (or 4.2.0-SNAPSHOT) and add the plugin &quot;org.apache.felix.fileinstall&quot;&lt;br/&gt;
Configure the fileinstall plugin to load the bundles located inside the directory ./plugins:&lt;/p&gt;

&lt;p&gt;felix.fileinstall.dir=./plugins&lt;/p&gt;

&lt;p&gt;and put there the 3 bundles attached to the issue.&lt;/p&gt;

&lt;p&gt;After starting Felix by typing &quot;lb -s&quot; I have:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;START LEVEL 1
   ID|State      |Level|Symbolic name
    0|Active     |    0|org.apache.felix.framework (4.0.2)
    1|Active     |    1|org.apache.felix.bundlerepository (1.6.6)
    2|Active     |    1|org.apache.felix.fileinstall (3.1.10)
    3|Active     |    1|org.apache.felix.gogo.command (0.12.0)
    4|Active     |    1|org.apache.felix.gogo.runtime (0.10.0)
    5|Active     |    1|org.apache.felix.gogo.shell (0.10.0)
    6|Starting   |    1|bundle3 (1.0.0.201201161439)
    7|Starting   |    1|bundle1 (1.0.0.201201161439)
    8|Starting   |    1|bundle2 (1.0.0.201201161439)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which is OK since the 3 bundles are declared as &quot;lazy&quot; so they will enter the STARTING state.&lt;br/&gt;
Now start the bundle1 by typing &quot;start 7&quot;. I have the following output:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;gt;&amp;gt;&amp;gt; Bundle3Object loaded
Sarted bundle: bundle2
&amp;gt;&amp;gt;&amp;gt; Bundle2Object loaded
Started Bundle: bundle1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and typing again &quot;lb -s&quot; I have:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;START LEVEL 1
   ID|State      |Level|Symbolic name
    0|Active     |    0|org.apache.felix.framework (4.0.2)
    1|Active     |    1|org.apache.felix.bundlerepository (1.6.6)
    2|Active     |    1|org.apache.felix.fileinstall (3.1.10)
    3|Active     |    1|org.apache.felix.gogo.command (0.12.0)
    4|Active     |    1|org.apache.felix.gogo.runtime (0.10.0)
    5|Active     |    1|org.apache.felix.gogo.shell (0.10.0)
    6|Starting   |    1|bundle3 (1.0.0.201201161439)
    7|Active     |    1|bundle1 (1.0.0.201201161439)
    8|Active     |    1|bundle2 (1.0.0.201201161439)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which is NOT OK, since the bundle2 is loading a class &apos;Bundle3Object&apos; from bundle3 in the activator - the bundle3 must be activated too but it is not.&lt;br/&gt;
You can see in the log made by bundle2 that Bundle3Object is correctly loaded (but the bundle3 not activated).&lt;/p&gt;

&lt;p&gt;(You can see the bundle2 was correctly activated by bundle1 by loading a class from bundle2 but the bundle3 is not activated when bundle2 is loading a class from bundle3)&lt;/p&gt;

&lt;p&gt;The fileinstall plugin seems to work correctly. I think the problem is in BundleWiringImpl$BundleClassLoader.findClass()&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12538520">FELIX-3306</key>
            <summary>Lazy activation of bundles is not always working as expected</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="bstefanescu">Bogdan Stefanescu</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Jan 2012 15:01:18 +0000</created>
                <updated>Sat, 16 Jun 2012 19:10:07 +0000</updated>
                            <resolved>Sat, 16 Jun 2012 19:10:07 +0000</resolved>
                                    <version>framework-4.0.2</version>
                                    <fixVersion>framework-4.2.0</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13187162" author="rickhall" created="Mon, 16 Jan 2012 20:28:49 +0000"  >&lt;p&gt;I think I see the issue. The lazy activation code works properly if it is triggered by class loads caused during the defineClass() operation, but not if the class loads occur when a lazy bundle is being activated as a result of a trigger (i.e., in the lazy bundle&apos;s start() method). This latter case is demonstrated by your example bundles.&lt;/p&gt;

&lt;p&gt;The code doesn&apos;t expect the deferred list to grow during the activation of lazy bundles, so the lazy bundles added due to class loads during activation are effectively ignored. The code should be changed so that it grabs the deferred list first and inserts an empty deferred list back into the thread local before starting to activate. That way any subsequent class loads triggering lazy activation in the start() method will be handled in a similar fashion as any other class load triggering lazy activation.&lt;/p&gt;</comment>
                            <comment id="13187179" author="rickhall" created="Mon, 16 Jan 2012 20:54:15 +0000"  >&lt;p&gt;I&apos;ve committed a potential fix to trunk. It works for me on your example bundles. Let me know if it works for you.&lt;/p&gt;

&lt;p&gt;However, currently the code does not continue activating deferred bundles if there is an exception while activating the deferred bundles. Perhaps this should catch all exceptions and continue to activate the other bundles in the deferred list.&lt;/p&gt;

&lt;p&gt;I&apos;ll keep this bug open until I address this aspect.&lt;/p&gt;</comment>
                            <comment id="13187693" author="bstefanescu" created="Tue, 17 Jan 2012 14:02:35 +0000"  >&lt;p&gt;Thanks it is working for me&lt;/p&gt;</comment>
                            <comment id="13393367" author="rickhall" created="Sat, 16 Jun 2012 19:10:07 +0000"  >&lt;p&gt;I&apos;m closing this issue as fixed. The code actually did catch BundleExceptions and continued to activate; however, I modified it to catch Throwable and log exception too.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12510710" name="bundle1_1.0.0.201201161439.jar" size="2689" author="bstefanescu" created="Mon, 16 Jan 2012 15:05:01 +0000"/>
                            <attachment id="12510711" name="bundle2_1.0.0.201201161439.jar" size="2690" author="bstefanescu" created="Mon, 16 Jan 2012 15:05:01 +0000"/>
                            <attachment id="12510712" name="bundle3_1.0.0.201201161439.jar" size="2630" author="bstefanescu" created="Mon, 16 Jan 2012 15:05:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>224024</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 23 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i07gn3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>41462</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>