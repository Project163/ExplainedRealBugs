<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:50:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3910] Race conditions in DependencyManager</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3910</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;In a multi threaded context, where dependencies are injected concurrently from different threads, we  came across some exceptions which seem to take place from dependencymanager.&lt;/p&gt;

&lt;p&gt;I have tried to reproduce the problems using a paxexam test which I will commit.&lt;br/&gt;
Not all exceptions are reproduced by the test case, but I think that the testcase really reproduces a problem. &lt;/p&gt;

&lt;p&gt;I also have a candidate patch, which I will submit to this jira issue.&lt;/p&gt;


&lt;p&gt;Here are the exceptions we have seen:&lt;/p&gt;

&lt;p&gt;first stacktrace seen:&lt;br/&gt;
===============&lt;/p&gt;

&lt;p&gt;ERROR: Bundle test.dm &lt;span class=&quot;error&quot;&gt;&amp;#91;21&amp;#93;&lt;/span&gt; EventDispatcher: Error during dispatch. (java.lang.NullPointerException)&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at org.apache.felix.dm.impl.dependencies.ServiceDependencyImpl.addedService(ServiceDependencyImpl.java:481)&lt;br/&gt;
        at org.apache.felix.dm.tracker.ServiceTracker$Tracked.customizerAdded(ServiceTracker.java:1325)&lt;br/&gt;
        at org.apache.felix.dm.tracker.AbstractTracked.trackAdding(AbstractTracked.java:290)&lt;br/&gt;
        at org.apache.felix.dm.tracker.AbstractTracked.track(AbstractTracked.java:236)&lt;br/&gt;
        at org.apache.felix.dm.tracker.ServiceTracker$Tracked.serviceChangedHideAspects(ServiceTracker.java:1206)&lt;br/&gt;
        at org.apache.felix.dm.tracker.ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:1101)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
        at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4260)&lt;br/&gt;
        at org.apache.felix.framework.Felix.registerService(Felix.java:3275)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:346)&lt;br/&gt;
        at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:320)&lt;br/&gt;
        at test.dm.race.RaceTest$RegistrationHelper$1.run(RaceTest.java:104)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;


&lt;p&gt;second exceptions:&lt;br/&gt;
==============&lt;/p&gt;

&lt;p&gt;ERROR: EventDispatcher: Error during dispatch. (java.lang.NullPointerException)&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at org.apache.felix.dm.impl.ComponentImpl.invokeCallbackMethod(ComponentImpl.java:686)&lt;br/&gt;
        at org.apache.felix.dm.impl.dependencies.ServiceDependencyImpl.invoke(ServiceDependencyImpl.java:704)&lt;br/&gt;
        at org.apache.felix.dm.impl.dependencies.ServiceDependencyImpl.invokeRemoved(ServiceDependencyImpl.java:666)&lt;br/&gt;
        at org.apache.felix.dm.impl.dependencies.ServiceDependencyImpl.removedService(ServiceDependencyImpl.java:520)&lt;br/&gt;
        at org.apache.felix.dm.tracker.ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:1351)&lt;br/&gt;
        at org.apache.felix.dm.tracker.AbstractTracked.untrack(AbstractTracked.java:359)&lt;br/&gt;
        at org.apache.felix.dm.tracker.ServiceTracker$Tracked.serviceChangedHideAspects(ServiceTracker.java:1285)&lt;br/&gt;
        at org.apache.felix.dm.tracker.ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:1101)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:878)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:732)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:662)&lt;br/&gt;
        at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:3587)&lt;br/&gt;
        at org.apache.felix.framework.Felix.access$000(Felix.java:40)&lt;br/&gt;
        at org.apache.felix.framework.Felix$1.serviceChanged(Felix.java:625)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:117)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:128)&lt;br/&gt;
        at org.apache.felix.dm.test.RaceTest$AFactory$2.run(RaceTest.java:151)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;
</description>
                <environment>jdk1.6, jdk1.7, linux fc16</environment>
        <key id="12633190">FELIX-3910</key>
            <summary>Race conditions in DependencyManager</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pderop">Pierre De Rop</assignee>
                                    <reporter username="pderop">Pierre De Rop</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Feb 2013 13:30:53 +0000</created>
                <updated>Mon, 21 Jul 2014 22:41:01 +0000</updated>
                            <resolved>Mon, 21 Jul 2014 22:40:37 +0000</resolved>
                                    <version>dependencymanager-3.0.0</version>
                                    <fixVersion>dependencymanager-3.2.0</fixVersion>
                                    <component>Dependency Manager</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13582179" author="pderop" created="Wed, 20 Feb 2013 13:50:43 +0000"  >&lt;p&gt;Committed a testcase (src/test/java/org/apache/felix/dm/test/RaceTest.java) in revision 1448165.&lt;/p&gt;

&lt;p&gt;The testcase seems to reproduces some of the exceptions mentioned above, but the test is currently incomplete because it relies on the fact that the framework is firing a FrameworkEvent, when it catches some exceptions from &apos;service changed&apos; service listener callback. But the pax exam version we are currently using is an old one, and uses an old version of Felix which is not firing events on service listeners exceptions ...&lt;/p&gt;

</comment>
                            <comment id="13582187" author="pderop" created="Wed, 20 Feb 2013 13:59:01 +0000"  >&lt;p&gt;Attached a proposed patch, which seems to resolve the issue.&lt;br/&gt;
Notice that the other dependencies (ConfigurationDependency, etc ...) might have to be patched in a similar way.&lt;/p&gt;

&lt;p&gt;Mainly, the patch is located in the ServiceDependencyImpl.java and is simply reusing the SerialExecutor of the components the ServiceDependency is attached to. &lt;/p&gt;

&lt;p&gt;I would appreciate if some DM committers could take a look at this patch; may be I have missed something and there is another way to go ?&lt;/p&gt;

&lt;p&gt;thanks. &lt;br/&gt;
/pierre&lt;/p&gt;</comment>
                            <comment id="13589825" author="marrs" created="Thu, 28 Feb 2013 19:21:50 +0000"  >&lt;p&gt;I quickly glanced over the patch. I am a bit worried about the huge &quot;synchronized (this) {}&quot; blocks. Are you sure you&apos;re not invoking any other services, callbacks or framework methods while holding such a lock? I admit, I have to take a closer look later.&lt;/p&gt;</comment>
                            <comment id="13590642" author="pderop" created="Fri, 1 Mar 2013 15:40:18 +0000"  >&lt;p&gt;Thanks for looking at the patch;&lt;/p&gt;

&lt;p&gt;I do agree, the synchronize block might be problematic. Initially, I did not think about any problems because I&apos;m executing the serial executor outside the synchronized block.&lt;br/&gt;
But one of the components may execute its serial executor, and in this case some runnables may be executed while still holding the lock ...&lt;/p&gt;

&lt;p&gt;I did this synchronization in order to avoid a race condition when multiple services are registered concurrently (when the ServiceDependencyImpl.addedService is called concurrently).&lt;br/&gt;
Indeed, If many services are registered concurrently, then we have to ensure that we always call &quot;ds.dependencyAvailable(ServiceDependencyImpl.this);&quot; before &quot;ds.dependencyChanged(ServiceDependencyImpl.this);&quot; ...&lt;/p&gt;






</comment>
                            <comment id="13666505" author="pderop" created="Fri, 24 May 2013 17:59:07 +0000"  >&lt;p&gt;If this may help, here is another patch (in &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3910&quot; title=&quot;Race conditions in DependencyManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3910&quot;&gt;&lt;del&gt;FELIX-3910&lt;/del&gt;&lt;/a&gt;.patch.2), which avoid the problem from the first proposed patch: &lt;br/&gt;
The addedService/modifiedService/removedService methods are now executed outside a synchronized block,&lt;br/&gt;
in a serial executor owed by the ServiceDependency instance.&lt;/p&gt;

&lt;p&gt;The patch also concerns invokeRemoved method: the array of Tupple is retrieved from the synchronization lock, not outside.&lt;/p&gt;

&lt;p&gt;I don&apos;t know if using a serial executor is the best way to resolve this issue, but It looks like the RaceTest is now running without any errors. Also checked that all tests are still successful.&lt;/p&gt;



</comment>
                            <comment id="13666507" author="pderop" created="Fri, 24 May 2013 18:00:23 +0000"  >&lt;p&gt;attached the second proposed patch.&lt;/p&gt;</comment>
                            <comment id="13673551" author="pderop" created="Mon, 3 Jun 2013 20:57:52 +0000"  >&lt;p&gt;Attached an third version of the patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3910&quot; title=&quot;Race conditions in DependencyManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3910&quot;&gt;&lt;del&gt;FELIX-3910&lt;/del&gt;&lt;/a&gt;.patch.3), which has been aligned with recent commit made by Xander, in revision r1488970.&lt;/p&gt;</comment>
                            <comment id="13774356" author="uiterlix" created="Mon, 23 Sep 2013 07:38:14 +0000"  >&lt;p&gt;Ik just reviewed the patch. I see it introduces a SerialExecutor to prevent race conditions. With revision r1488970 I introduced a guarded block to guarantee execution of callback methods in the correct order. See the enqueueCallback, waitForCallbackLock, execute and releaseCallback methods. Maybe we can remove the serial executor introduced in the patch and use this mechanism for the non-aspect aware callbacks as well ?&lt;/p&gt;</comment>
                            <comment id="13777358" author="pderop" created="Wed, 25 Sep 2013 11:10:34 +0000"  >&lt;p&gt;I tried to follow your suggestion by reusing the same aspect locking mechanism for non aspect callbacks.&lt;/p&gt;

&lt;p&gt;The patch is not finished but I prefer to attach it now (see &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3910&quot; title=&quot;Race conditions in DependencyManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3910&quot;&gt;&lt;del&gt;FELIX-3910&lt;/del&gt;&lt;/a&gt;.patch.4) so you can take a look at.&lt;/p&gt;

&lt;p&gt;patch description&lt;br/&gt;
=================&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if I understand correctly, the locking methods used by the aspect aware methods allow to serialize the execution of tasks, and other concurrent tasks are blocked until the currently executing task is done.&lt;br/&gt;
So, I have added the following method which I call from other methods needing to be serialized:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;	private void executeExclusivelyOrBlock(Runnable task) {&lt;br/&gt;
		enqueueCallback(task);&lt;br/&gt;
		waitForCallbackLock(task);&lt;br/&gt;
		try &lt;/p&gt;
{
			execute(task);
		}
&lt;p&gt; finally &lt;/p&gt;
{
			releaseCallback(task);
		}
&lt;p&gt;	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;in the waitForCallbackLock, I did a minor optimization and replaced &quot;indexOf&quot; usage by this:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    private synchronized void waitForCallbackLock(Runnable runnable) {&lt;br/&gt;
    	while (m_injectionQueue.size() &amp;gt; 0 &amp;amp;&amp;amp; m_injectionQueue.get(0) != runnable) {&lt;br/&gt;
    		try &lt;/p&gt;
{
				wait();
			}
&lt;p&gt; catch (InterruptedException e) {&lt;br/&gt;
			}&lt;br/&gt;
    	}&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;I think this might improve performance, especially when there is a high number of dependency services.&lt;br/&gt;
But perhaps, this optimization might be done later ...&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;while doing the patch, I came across another synchronization hole that I did not notice and fix in the previous &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3910&quot; title=&quot;Race conditions in DependencyManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3910&quot;&gt;&lt;del&gt;FELIX-3910&lt;/del&gt;&lt;/a&gt;.patch.3 patch: Indeed, there is a subtle issue in the addedService(ServiceReference ref, Object service) and removed(ServiceReference ref, Object service) methods, which I think have to be entirely serialized (by reusing your guarded methods): The race condition concerns the call to makeAvailable(), makeUnavailable() methods ...&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So, in the &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3910&quot; title=&quot;Race conditions in DependencyManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3910&quot;&gt;&lt;del&gt;FELIX-3910&lt;/del&gt;&lt;/a&gt;.patch.4: the addedService/removedService are serialized using the call to executeExclusivelyOrBlock method. I also serialized the modifiedService, but I am not sure for now if this is necessary:&lt;/p&gt;

&lt;p&gt;    public void addedService(final ServiceReference ref, final Object service) {&lt;br/&gt;
    	executeExclusivelyOrBlock(new Runnable() {&lt;br/&gt;
			public void run() &lt;/p&gt;
{
				addedServiceExclusively(ref, service);
			}
&lt;p&gt;		});&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;    private void addedServiceExclusively(ServiceReference ref, Object service) &lt;/p&gt;
{
       // same code as in addedService, before the patch.
       ...
    }

&lt;p&gt;    public void modifiedService(final ServiceReference ref, final Object service) {&lt;br/&gt;
    	executeExclusivelyOrBlock(new Runnable() {&lt;br/&gt;
			public void run() &lt;/p&gt;
{
				modifiedServiceExclusively(ref, service);
			}
&lt;p&gt;		});&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;    private void modifiedServiceExclusively(ServiceReference ref, Object service) &lt;/p&gt;
{
       // same code as in modifiedService, before the patch.
       ...
    }

&lt;p&gt;    public void removedService(final ServiceReference ref, final Object service) {&lt;br/&gt;
    	executeExclusivelyOrBlock(new Runnable() {&lt;br/&gt;
			public void run() &lt;/p&gt;
{
				removedServiceExclusively(ref, service);
			}
&lt;p&gt;		});&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;    private void removedServiceExclusively(ServiceReference ref, Object service) &lt;/p&gt;
{
       // same code as in removedService, before the patch.
       ...
    }

&lt;p&gt;With these patches, the &quot;RaceTest&quot; test seems to pass seamlessly. I ran it on a multi-core machine with 32 cores.&lt;/p&gt;


&lt;p&gt;Comments/Questions:&lt;br/&gt;
==================&lt;/p&gt;

&lt;p&gt;1) since the three addedService/modifiedService/removedService are now serialized, I wonder if the locking blocks are still necessary in the handleAspectAwareAdded methods ?&lt;br/&gt;
I think we shall remove the locking blocks from this method because we would then have a deadlock, since the addedService/removedService are already holding locks (using the executeExclusivelyOrBlock method).&lt;/p&gt;

&lt;p&gt;Do you agree with this ? (I will provide &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3910&quot; title=&quot;Race conditions in DependencyManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3910&quot;&gt;&lt;del&gt;FELIX-3910&lt;/del&gt;&lt;/a&gt;.patch.5 which does this, if you are OK).&lt;/p&gt;

&lt;p&gt;2) in the handleAspectAwareAdded method, I may miss something but I wonder why the&lt;br/&gt;
tasks are executed while holding a lock on the &quot;rankings&quot; variable ?&lt;/p&gt;

&lt;p&gt;		if (callbackRunnable != null) {&lt;br/&gt;
			waitForCallbackLock(callbackRunnable);&lt;br/&gt;
			synchronized (rankings) &lt;/p&gt;
{
				releaseCallback(callbackRunnable);
				execute(callbackRunnable);
			}
&lt;p&gt;		}&lt;/p&gt;

&lt;p&gt;Could it be possible to have a deadlock if the callback blocks on a synchronization lock ?&lt;br/&gt;
In this case, then why not doing the following: &lt;/p&gt;

&lt;p&gt;		if (callbackRunnable != null) {&lt;br/&gt;
			waitForCallbackLock(callbackRunnable);&lt;br/&gt;
                        try &lt;/p&gt;
{
		            execute(callbackRunnable);
			}
&lt;p&gt; finally &lt;/p&gt;
{
	                    releaseCallback(callbackRunnable);
                        }
&lt;p&gt;			&lt;br/&gt;
		}&lt;br/&gt;
3) I&apos;m currently wondering if the invokeAdded(DependencyService service) and invokeRemoved(DependencyService service) methods shall (or not) also also serialized ? I&apos;m not sure for now ... what do you think ?&lt;/p&gt;

&lt;p&gt;4) I have to modify the &quot;RaceTest&quot; test in order to use aspects as well.&lt;/p&gt;

&lt;p&gt;thanks again for your feedback; feel free to propose another patch if you think I&apos;m not on the right direction ...&lt;/p&gt;

&lt;p&gt;/Pierre&lt;/p&gt;</comment>
                            <comment id="13777360" author="pderop" created="Wed, 25 Sep 2013 11:11:30 +0000"  >&lt;p&gt;attached the new patch, which is using the locking blocks from the aspect aware dependencies.&lt;/p&gt;</comment>
                            <comment id="13789080" author="pderop" created="Tue, 8 Oct 2013 10:07:05 +0000"  >&lt;p&gt;Before submitting a patch, I need a better integration test than the RaceTest I committed in test/ submodule. I also need the latest pax exam, as well as latest felix framework.&lt;/p&gt;

&lt;p&gt;So, as discussed with Marcel privately, I committed in revision 1530206., a new &quot;test2&quot; subproject, based on pax exam 3.0.0 and latest Felix framework. &lt;/p&gt;

&lt;p&gt;In that new test2 project, I committed an &quot;AspectRaceTest&quot; which reproduces some race conditions when aspect-aware services are concurrently registered/unregistered.&lt;/p&gt;

&lt;p&gt;I also started to migrate the old api test &quot;test/src/test/java/org/apache/felix/dm/test/AspectBaseTest.java&quot;, and moved it to test2/src/test/java/org/apache/felix/dependencymanager/test2/integration/api/AspectBaseTest.java&lt;/p&gt;

&lt;p&gt;The work is in progress, and the intent is to progressively migrate all our existing tests from test/* into test2/*.  And once all is migrated, we&apos;ll finally remove old &quot;test&quot; module and rename new &quot;test2&quot; module into &quot;test&quot;.&lt;/p&gt;

&lt;p&gt;To run the tests, the &quot;mvn clean install&quot; command has to be executed (because tests are run in the integration phase, after the test phase. I need this in order to be able to generate some annotated components before executing tests.&lt;/p&gt;

&lt;p&gt;Basically, migrating an old api test seems simple: the test has to extend TestBase, which already has a @Configuration annotation. If one maven dependency is missing, just add it to the TestBase class.&lt;br/&gt;
Notice that with the new pax exam 3.0.0, all testXXX methods must not take the BundleContext in parameter (but the super class has a &quot;context&quot; BundleContext class attribute, which can be reused by all existing tests).&lt;/p&gt;


&lt;p&gt;The test2 module is organized like this:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;src/main/java/org/apache/felix/dependencymanager/test2/components/&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This package contains some components used by integration tests. Most of the components from this package are meant to be used by only annotations tests, except  the &quot;Ensure&quot; helper, which is used by all integration tests.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;src/test/java/org/apache/felix/dependencymanager/test2/integration/*&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;this package contains all integration tests&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;src/test/java/org/apache/felix/dependencymanager/test2/integration/api/*&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;this package contains all API integration tests. For now, I have migrated the old test/.../AspectBaseTest.java into test2/src/test/java/org/apache/felix/dependencymanager/test2/integration/api/AspectBaseTest.java&lt;/p&gt;

&lt;p&gt;There is also the new AspectRaceTest in the api package.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;src/test/java/org/apache/felix/dependencymanager/test2/integration/annotations/*&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;this package contains all Annotations integration tests. For now, I migrated the old test/.../SimpleAnnotationsTest.java into test2/src/test/java/org/apache/felix/dependencymanager/test2/integration/annotations//SimpleAnnotationsTest.java&lt;/p&gt;


&lt;p&gt;I will now cleanup the patch and will submit it to this issue a bit later.&lt;/p&gt;

&lt;p&gt;/Pierre&lt;/p&gt;</comment>
                            <comment id="13791366" author="pderop" created="Thu, 10 Oct 2013 10:24:12 +0000"  >&lt;p&gt;I have attached the patch candidate (&lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3910&quot; title=&quot;Race conditions in DependencyManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3910&quot;&gt;&lt;del&gt;FELIX-3910&lt;/del&gt;&lt;/a&gt;.patch.5.tgz).&lt;/p&gt;

&lt;p&gt;can you please check if it works in your environment ?&lt;br/&gt;
All tests are passing, except the two following tests:&lt;/p&gt;

&lt;p&gt;1) testDynamicComponentStateListingLifeCycle2(org.apache.felix.dm.test.ComponentLifeCycleTest)&lt;/p&gt;

&lt;p&gt;I think this is a pending issue, and the test also fails without the patch&lt;/p&gt;

&lt;p&gt;2)   testServiceRegistrationAndConsumption(org.apache.felix.dm.test.AspectAwareServiceDependencyTest)&lt;/p&gt;

&lt;p&gt;This test also fails without the patch: I looked into it quickly and think that the pb might come from the dependency of the &quot;ServiceConsumerCallbacks&quot; component, which is optional and the swap method is called twice (the second swap call occurs when the &quot;ServiceConsumerCallbacks&quot; component is removed because the dependency is optional ... but this can be discussed in another jira issue.&lt;/p&gt;

&lt;p&gt;patch description:&lt;br/&gt;
-----------------------&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added a new &quot;BlockingSerialExecutor&quot; class which basically contains most of the logic that is currently done in the enqueueCallback, waitForCallbackLock, execute and releaseCallback methods: this class ensures that a single leader thread is executing a given task, and other threads are blocked until the leader thread is done. Additionally, I had to allow this new executor to be reentrant: when one executing task reschedule a new sub-task: then we need to execute the subtask immediately. This is required for instance when the serialized &quot;addedService(ServiceReference ref, Object service)&quot; method calls &quot;ds.dependencyAvailable(this)&quot;, which then calls the serialized &quot;invokeAdded(final DependencyService service)&quot; method ... see the patch for more details.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I added this new class because I think we need to reuse it in other kind of dependencies, which may have also some concurrency issues.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I then reworked a little the ServiceDependencyImpl class like this:&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;all public methods are regrouped in the beginning of the class file, then comes the protected methods, and then the private methods&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;serialized some public methods, in order to fix the race conditions.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;made protected the getService() method, which also impacts some minor modifs in the TemporalServiceDependencyImpl class.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;made volatile or final some attributes in the ServiceDependencyImpl / ComponentImpl / TemporalServiceDependencyImpl classes: Using pax-exam 3.0.0 (in test2), I came across some subtle problems regarding some attributes which are modified from a synchronized block, but read from unsynchronized blocks. So, to fix the problem, I had to use volatile or final ...&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;did a small patch in the ServiceDependencyImpl.makeUnavailable method:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    private synchronized boolean makeUnavailable() {&lt;br/&gt;
        if ((isAvailable()) &amp;amp;&amp;amp; (m_isStarted == false || !m_tracker.hasReference())) &lt;/p&gt;
{
            m_isAvailable = false;
            return true;
        }
&lt;p&gt;        return false;&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;Here, the &quot;m_isStarted&quot; flag must be checked in order to avoid a potential NPE, when m_tracker is null. The m_tracker can be null when many service dependencies are unregistered concurrently (it&apos;s tricky and difficult to explain ...).&lt;/p&gt;

&lt;p&gt;Please notice that since most of the public methods in the ServiceDependencyImpl class are now serialized, it&apos;s now making sense to remove many synchronized blocks. &lt;br/&gt;
However, I did not do it because I prefer to play safe for now, and we can probably do it in a next step. I prefer for now to minimize code modifications. The only synchronized blocks I had to comment are in the  handleAspectAwareAdded/handleAspectAwareRemoved methods: Indeed, these methods are now fully serialized; and since they invoke swap callbacks,  I prefer  to not hold any locks during swap callback invocations.&lt;/p&gt;

&lt;p&gt;Let me know if this is not breaking anything from your side and if you are ok for a commit.&lt;br/&gt;
thanks;&lt;/p&gt;

</comment>
                            <comment id="13791369" author="pderop" created="Thu, 10 Oct 2013 10:25:25 +0000"  >&lt;p&gt;attached the patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3910&quot; title=&quot;Race conditions in DependencyManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3910&quot;&gt;&lt;del&gt;FELIX-3910&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13805500" author="pderop" created="Fri, 25 Oct 2013 17:42:13 +0000"  >&lt;p&gt;Updated patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3910&quot; title=&quot;Race conditions in DependencyManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3910&quot;&gt;&lt;del&gt;FELIX-3910&lt;/del&gt;&lt;/a&gt;.patch.6.tgz) with the recent debugLog modifications committed today in ServiceDependencyImpl.java.&lt;/p&gt;

&lt;p&gt;Also made volatile the m_isInstanceBound attribute in the DependencyBase class.&lt;/p&gt;</comment>
                            <comment id="13805585" author="pderop" created="Fri, 25 Oct 2013 18:50:18 +0000"  >&lt;p&gt;commited the fix in revisions: 1535805, 1535807, 1535808, 1535809.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12570125" name="FELIX-3910-patch" size="10101" author="pderop" created="Wed, 20 Feb 2013 13:59:01 +0000"/>
                            <attachment id="12584730" name="FELIX-3910.patch.2" size="9318" author="pderop" created="Fri, 24 May 2013 18:00:23 +0000"/>
                            <attachment id="12585942" name="FELIX-3910.patch.3" size="10537" author="pderop" created="Mon, 3 Jun 2013 20:57:52 +0000"/>
                            <attachment id="12604996" name="FELIX-3910.patch.4" size="2908" author="pderop" created="Wed, 25 Sep 2013 11:11:30 +0000"/>
                            <attachment id="12607777" name="FELIX-3910.patch.5.tgz" size="20572" author="pderop" created="Thu, 10 Oct 2013 10:25:25 +0000"/>
                            <attachment id="12610351" name="FELIX-3910.patch.6.tgz" size="20870" author="pderop" created="Fri, 25 Oct 2013 17:42:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>313686</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 4 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1i4rj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>314031</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>