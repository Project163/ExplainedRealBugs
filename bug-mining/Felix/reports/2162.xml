<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:53:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-4462] Classloader deadlock in Java6 between two bundles</title>
                <link>https://issues.apache.org/jira/browse/FELIX-4462</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;As discussed on the user list (&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;) there is a deadlock in Java 6 (if bug 4670071 &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; is not fixed). The problem is the hidden, implicit ClassLoader.loadClassInternal which is is synchronized(this) in that case. &lt;/p&gt;

&lt;p&gt;Consider the following scenario:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;bundle 2 wants to load a class of bundle 1 - hence is not synchronized with bundle 1&apos;s classloader - thus uses the m_classLocks locking mechanism to lock bundle 1&apos;s classloader for the particular class being loaded. Then calls defineClass (with bundle 1&apos;s classloader)&lt;/li&gt;
	&lt;li&gt;before it can do so, bundle 1 wants to load the same class (of bundle 1) - hence does a synchronized loadClassInternal. then reaches the m_classLocks locking mechanism and notices that there&apos;s another thread loading the class&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;-&amp;gt; this results in the deadlock reported.&lt;/p&gt;

&lt;p&gt;There&apos;s multiple fixes for this:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;use Java 7&lt;/li&gt;
	&lt;li&gt;use -XX:+UnlockDiagnosticVMOptions -XX:+UnsyncloadClass&lt;/li&gt;
	&lt;li&gt;create a special Java 6 classloader (Java 7 would use the current one) which does a plain synchronized findClass() - and replaces all synchronized(m_classLocks) with synchronized(this)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://markmail.org/thread/crwqzqobxgob7q3n&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://markmail.org/thread/crwqzqobxgob7q3n&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://bugs.java.com/bugdatabase/view_bug.do?bug_id=4670071&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bugs.java.com/bugdatabase/view_bug.do?bug_id=4670071&lt;/a&gt;&lt;/p&gt;</description>
                <environment>MacOS 10.7.5, java version &amp;quot;1.6.0_65&amp;quot;, Java(TM) SE Runtime Environment (build 1.6.0_65-b14-462-11M4609), Java HotSpot(TM) 64-Bit Server VM (build 20.65-b04-462, mixed mode)</environment>
        <key id="12702388">FELIX-4462</key>
            <summary>Classloader deadlock in Java6 between two bundles</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="stefanegli">Stefan Egli</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 Mar 2014 14:36:05 +0000</created>
                <updated>Wed, 19 Mar 2014 16:23:34 +0000</updated>
                            <resolved>Wed, 19 Mar 2014 16:23:34 +0000</resolved>
                                    <version>framework-4.2.1</version>
                                    <fixVersion>framework-4.4.0</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13940510" author="egli" created="Wed, 19 Mar 2014 14:39:24 +0000"  >&lt;p&gt;Adding a patch which contains a test (Java6DeadlockTest) that reproduces the deadlock. I had a problem reproducing it via maven (mvn clean test), there is succeeds, but when running it in Eclipse it indeed reproduces the deadlock. When running it in Eclipse with &apos;-XX:+UnlockDiagnosticVMOptions -XX:+UnsyncloadClass&apos; it succeeds.&lt;/p&gt;</comment>
                            <comment id="13940519" author="egli" created="Wed, 19 Mar 2014 14:44:02 +0000"  >&lt;p&gt;Attached the synchronized findClass as mentioned in the description of this ticket. This would fix the deadlock encountered - but prevents parallel classloading for Java 7 onwards. So maybe there&apos;s a better solution...&lt;/p&gt;</comment>
                            <comment id="13940563" author="rickhall" created="Wed, 19 Mar 2014 15:23:12 +0000"  >&lt;p&gt;I&apos;ve attached a patch that tries to determine if we are using a parallel class loader or not. If so, it uses the class locks list as the lock object, if not, it uses the class loader itself as the lock object.&lt;/p&gt;

&lt;p&gt;Please test this patch and see if it works. Thanks.&lt;/p&gt;</comment>
                            <comment id="13940565" author="egli" created="Wed, 19 Mar 2014 15:24:24 +0000"  >&lt;p&gt;Attached a patch which replaces the synchronization monitor of m_classLocks to this. With this fix the Java6DeadlockTest succeeds.&lt;/p&gt;</comment>
                            <comment id="13940572" author="egli" created="Wed, 19 Mar 2014 15:28:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rickhall&quot; class=&quot;user-hover&quot; rel=&quot;rickhall&quot;&gt;rickhall&lt;/a&gt;, yes, with your patch Java6DeadlockTest succeeds.&lt;/p&gt;</comment>
                            <comment id="13940595" author="rickhall" created="Wed, 19 Mar 2014 15:51:18 +0000"  >&lt;p&gt;Ok, great. I&apos;ve applied the fix, so please close this issue if satisfied. Thanks.&lt;/p&gt;</comment>
                            <comment id="13940604" author="egli" created="Wed, 19 Mar 2014 15:58:46 +0000"  >&lt;p&gt;Thanks! Test works fine with the fix now.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12635451">FELIX-3953</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12560654">FELIX-3553</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12635556" name="FELIX-4462.txt" size="3884" author="rickhall" created="Wed, 19 Mar 2014 15:23:12 +0000"/>
                            <attachment id="12635557" name="classLockMonitor.FELIX-4462.patch2" size="2552" author="stefanegli" created="Wed, 19 Mar 2014 15:24:24 +0000"/>
                            <attachment id="12635552" name="suggested.synchronized.FELIX-4462.patch" size="575" author="stefanegli" created="Wed, 19 Mar 2014 14:44:02 +0000"/>
                            <attachment id="12635551" name="test.reproducingFELIX-4462.patch" size="16489" author="stefanegli" created="Wed, 19 Mar 2014 14:39:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>380727</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 35 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1tliv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>381006</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>