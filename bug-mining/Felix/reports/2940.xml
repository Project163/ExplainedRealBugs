<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:11:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5759] StackOverflowError thrown during URL construction</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5759</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;I get the following callstack resulting in a stack overflow error when building a URL object:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[info]   at org.apache.felix.framework.URLHandlersStreamHandlerProxy.parseURL(URLHandlersStreamHandlerProxy.java:401)
[info]   at java.net.URL.&amp;lt;init&amp;gt;(URL.java:622)
[info]   at java.net.URL.&amp;lt;init&amp;gt;(URL.java:490)
[info]   at org.apache.felix.framework.URLHandlersStreamHandlerProxy.parseURL(URLHandlersStreamHandlerProxy.java:401)
[info]   at java.net.URL.&amp;lt;init&amp;gt;(URL.java:622)
[info]   at java.net.URL.&amp;lt;init&amp;gt;(URL.java:490)
[info]   at org.apache.felix.framework.URLHandlersStreamHandlerProxy.parseURL(URLHandlersStreamHandlerProxy.java:401)
[info]   at java.net.URL.&amp;lt;init&amp;gt;(URL.java:622)
[info]   at java.net.URL.&amp;lt;init&amp;gt;(URL.java:490)
[info]   at org.apache.felix.framework.URLHandlersStreamHandlerProxy.parseURL(URLHandlersStreamHandlerProxy.java:401)
[info]   at java.net.URL.&amp;lt;init&amp;gt;(URL.java:622)
[info]   at java.net.URL.&amp;lt;init&amp;gt;(URL.java:490)
[info]   at org.apache.felix.framework.URLHandlersStreamHandlerProxy.parseURL(URLHandlersStreamHandlerProxy.java:401)
[info]   at java.net.URL.&amp;lt;init&amp;gt;(URL.java:622)
[info]   at java.net.URL.&amp;lt;init&amp;gt;(URL.java:490)
[info]   at org.apache.felix.framework.URLHandlersStreamHandlerProxy.parseURL(URLHandlersStreamHandlerProxy.java:401)
[info]   at java.net.URL.&amp;lt;init&amp;gt;(URL.java:622)
[info]   at java.net.URL.&amp;lt;init&amp;gt;(URL.java:490)
[info]   at org.apache.felix.framework.URLHandlersStreamHandlerProxy.parseURL(URLHandlersStreamHandlerProxy.java:401)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Using org.apache.felix.framework 4.4.1 and Java 1.8.0_111 running on Ubuntu.&lt;/p&gt;

&lt;p&gt;We started getting this exception after upgrading to Spark 2.2.0, after some investigation we realized Spark 2.2.0 registers its own &lt;tt&gt;URLStreamHandlerFactory&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.apache.spark.sql.internal

object SharedState &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Logging {
  &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    URL.setURLStreamHandlerFactory(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FsUrlStreamHandlerFactory())
  } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; {
    &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; e: Error =&amp;gt;
      logWarning(&lt;span class=&quot;code-quote&quot;&gt;&quot;URL.setURLStreamHandlerFactory failed to set FsUrlStreamHandlerFactory&quot;&lt;/span&gt;)
  }
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looks like the bug is related to line 128 in &lt;tt&gt;URLHandlers.java&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            URLStreamHandler handler = getBuiltInStreamHandler(protocol, factory);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (handler != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
            {
                URL url = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URL(protocol, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, -1, &quot;&quot;, handler);
                m_handlerToURL.put(handler, url);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This code assumes there is a unique mapping from handlers to protocols, which doesn&apos;t seem to be a valid assumption, at least not with Spark. Spark URL handler factory is returning the same handler instance for both &lt;tt&gt;file&lt;/tt&gt; and &lt;tt&gt;ftp&lt;/tt&gt; protocols. When &lt;tt&gt;URLHandlers&lt;/tt&gt; is initializing it first tries to register a handler for &lt;tt&gt;file&lt;/tt&gt; and then for &lt;tt&gt;ftp&lt;/tt&gt;, but because the factory returns the same handler we end up replacing the URL object we have for &lt;tt&gt;file&lt;/tt&gt; with &lt;tt&gt;ftp&lt;/tt&gt; in &lt;tt&gt;m_handlerToURL&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Later when a URL is being constructed it calls &lt;tt&gt;createURLStreamHandler&lt;/tt&gt; from URLHandlers, at the end of this method:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-comment&quot;&gt;// If built-in content handler, then create a proxy handler.
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; addToStreamCache(protocol,
            &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URLHandlersStreamHandlerProxy(protocol, m_secureAction,
                handler, (URL) m_handlerToURL.get(handler)));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that it&apos;s trying to use &lt;tt&gt;m_handlerToURL&lt;/tt&gt; to look up the protocol for the handler, and in case of &lt;tt&gt;file&lt;/tt&gt; instead of returning a URL with protocol set to &lt;tt&gt;file&lt;/tt&gt; it returns a URL with protocol set to &lt;tt&gt;ftp&lt;/tt&gt;, so &lt;tt&gt;URLHandlersStreamHandlerProxy&lt;/tt&gt; gets constructed with &lt;tt&gt;m_builtInURL&lt;/tt&gt; set to &lt;tt&gt;ftp&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Later in URL.java we have this code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((context != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &amp;amp;&amp;amp; ((newProtocol == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) ||
                            newProtocol.equalsIgnoreCase(context.protocol))) {
                &lt;span class=&quot;code-comment&quot;&gt;// inherit the protocol handler from the context
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; not specified to the constructor
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (handler == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                    handler = context.handler;
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This code only uses the handler if protocols match, but in this case protocols don&apos;t match because it&apos;s expected to be &lt;tt&gt;file&lt;/tt&gt; but we receive &lt;tt&gt;ftp&lt;/tt&gt; that comes from &lt;tt&gt;m_builtInURL&lt;/tt&gt;, and the code falls back to asking the factory to create a new handler:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (handler == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp;
                (handler = getURLStreamHandler(protocol)) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MalformedURLException(&lt;span class=&quot;code-quote&quot;&gt;&quot;unknown protocol: &quot;&lt;/span&gt;+protocol);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The factory returns a handler with protocol set to &lt;tt&gt;ftp&lt;/tt&gt; again and we get stuck in a loop.&lt;/p&gt;

&lt;p&gt;Looking at the newest Felix code looks like the assumption of having a unique handler per protocol is still there, so I believe this bug still exists in the newest Felix as well.&lt;/p&gt;

&lt;p&gt;To reproduce this bug before starting a bundle you only need to register a factory that returns the same handler instance for &lt;tt&gt;file&lt;/tt&gt; and &lt;tt&gt;ftp&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13123265">FELIX-5759</key>
            <summary>StackOverflowError thrown during URL construction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="karlpauls">Karl Pauls</assignee>
                                    <reporter username="kamali.ali">Ali Kamali</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Dec 2017 18:27:39 +0000</created>
                <updated>Mon, 9 Jul 2018 10:31:53 +0000</updated>
                            <resolved>Thu, 7 Dec 2017 23:29:28 +0000</resolved>
                                    <version>framework-5.6.10</version>
                                    <fixVersion>framework-6.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16282710" author="karlpauls" created="Thu, 7 Dec 2017 23:29:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kamali.ali&quot; class=&quot;user-hover&quot; rel=&quot;kamali.ali&quot;&gt;kamali.ali&lt;/a&gt;, yes, that seems to be an issue and it is still present in the current version of Felix. I commited a fix for this in r1817441. &lt;/p&gt;

&lt;p&gt;Could you please test it with the current trunk (i.e., framework-5.7.0-SNAPSHOT) and close this issue if it works for you or reopen when it doesn&apos;t?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 49 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nm73:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>