<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:08:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-902] Empty bundle.state file produces NPE</title>
                <link>https://issues.apache.org/jira/browse/FELIX-902</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;If I have empty bundle.state file in Felix cache then exception is thrown while bundle start:&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
            at org.apache.felix.framework.cache.BundleArchive.getPersistentState(BundleArchive.java:315)&lt;br/&gt;
            at org.apache.felix.framework.Felix.start(Felix.java:776)&lt;/p&gt;

&lt;p&gt;But if i delete bundle.state then no exception is thrown and org.apache.felix.framework.cache.BundleArchive#getPersistentState returns &apos;Installed&apos; state.&lt;br/&gt;
The exception is thrown because string comparsions in org.apache.felix.framework.cache.BundleArchive#getPersistentState do not respect java.io.BufferedReader#readLine&apos;s null return value if file is empty. Also there is a bug in org.apache.felix.framework.cache.BundleArchive#setPersistentState that can produce not persistent state of cache by creation of empty bundle.state file.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12413391">FELIX-902</key>
            <summary>Empty bundle.state file produces NPE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="c00l">Pavel Tiunov</reporter>
                        <labels>
                    </labels>
                <created>Tue, 27 Jan 2009 16:16:43 +0000</created>
                <updated>Mon, 16 Mar 2009 18:32:08 +0000</updated>
                            <resolved>Mon, 16 Mar 2009 18:32:08 +0000</resolved>
                                    <version>framework-1.0.4</version>
                                    <fixVersion>framework-1.6.0</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12667753" author="rickhall" created="Tue, 27 Jan 2009 18:52:38 +0000"  >&lt;p&gt;Thanks for the feedback.&lt;/p&gt;

&lt;p&gt;Regarding your first issue, I added a null check to make sure we will default to INSTALLED.&lt;/p&gt;

&lt;p&gt;As for the second issue in setPersistentState(), I do not understand what you are saying. The method is quite simple, it opens a file, writes a value, then closes the file. What is the bug? It defaults to INSTALLED and seems there could only be an issue if it had difficulty writing to the disk. If that is the case, there isn&apos;t much we can do. Am I missing something?&lt;/p&gt;</comment>
                            <comment id="12667998" author="c00l" created="Wed, 28 Jan 2009 11:13:59 +0000"  >&lt;p&gt;Yes, org.apache.felix.framework.cache.BundleArchive#setPersistentState looks pretty secure but there is some magic about what it performs just after output stream is created. What if BufferedWriter, OutputStreamWriter or anything else that surrounded by try...catch throws exception if stream is created? The answer is simple: stream should be closed in finally block and we have an empty bundle.state file (This is may be platform dependent behavior. Reproduced on Windows).&lt;br/&gt;
But this is just my opinion, because at the moment i can&apos;t catch what excactly breaks bundle.state file. Our application runs under Applet environment and i expect that this situation may occur when we closing Applet while OSGi is still in startup state.&lt;/p&gt;</comment>
                            <comment id="12668134" author="rickhall" created="Wed, 28 Jan 2009 20:08:15 +0000"  >&lt;p&gt;Still, shouldn&apos;t the second issue be resolved by the first issue? Now, if for some reason there is an empty file created, it will be interpreted as being the INSTALLED state. Said another way, there is really only one bug here, which is under some circumstances an empty state file might be created, so we need to handle that when we read the state file. Would you agree?&lt;/p&gt;</comment>
                            <comment id="12668468" author="c00l" created="Thu, 29 Jan 2009 13:42:39 +0000"  >&lt;p&gt;Yes, you are completely right. The fix is to handle empty state files. But i just thought that you wil be interested in root cause of problem, because it can bring cache into not persistent state.&lt;br/&gt;
P.S. And when this fix will be released? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; It&apos;s really important for us, because this bug reproduces very often in our environment.&lt;/p&gt;</comment>
                            <comment id="12668512" author="rickhall" created="Thu, 29 Jan 2009 16:46:09 +0000"  >&lt;p&gt;Ok, good to understand. I just committed a fix for the empty state file. Unfortunately, I don&apos;t expect a release for a little while, since the trunk is undergoing some major refactoring. I would recommend rolling your own release with the fix if it is impacting you.&lt;/p&gt;

&lt;p&gt;Since you can apparently reproduce the root cause, it would be excellent if you could look into what is going on a little bit to see if that is something we could fix too. Or if you can create an example to reproduce it, I will look into it. Thanks for your help.&lt;/p&gt;</comment>
                            <comment id="12682403" author="rickhall" created="Mon, 16 Mar 2009 18:32:08 +0000"  >&lt;p&gt;This has been fixed in trunk and will be included in the next release. Please close if satisfied. Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>58087</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 37 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0vqy7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>183339</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>