<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:12:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5716] Dead Lock in DM</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5716</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;I just found an unfortunate deadlock when using latest DM r11 and latest SCR 2.0.12 in the same JVM.&lt;/p&gt;

&lt;p&gt;I believe that the same issue applies to both DM and SCR (I may have to open a seperate issue for SCR).&lt;/p&gt;

&lt;p&gt;First, here is the deadlock:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Found one Java-level deadlock:
=============================
&lt;span class=&quot;code-quote&quot;&gt;&quot;CM Event Dispatcher (Fire ConfigurationEvent: pid=com.alcatel.as.http.ioh.impl.HttpIOH)&quot;&lt;/span&gt;:
  waiting to lock monitor 0x00007f8188004538 (object 0x00000000eb38d420, a org.apache.felix.dm.tracker.ServiceTracker$Tracked),
  which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;FelixDispatchQueue&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;FelixDispatchQueue&quot;&lt;/span&gt;:
  waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ownable synchronizer 0x00000000c0699f30, (a java.util.concurrent.locks.ReentrantLock$FairSync),
  which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;CM Event Dispatcher (Fire ConfigurationEvent: pid=com.alcatel.as.http.ioh.impl.HttpIOH)&quot;&lt;/span&gt;

Java stack information &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the threads listed above:
===================================================
&lt;span class=&quot;code-quote&quot;&gt;&quot;CM Event Dispatcher (Fire ConfigurationEvent: pid=com.alcatel.as.http.ioh.impl.HttpIOH)&quot;&lt;/span&gt;:
        at org.apache.felix.dm.tracker.ServiceTracker$Tracked.serviceChangedHideAspects(ServiceTracker.java:1140)
        - waiting to lock &amp;lt;0x00000000eb38d420&amp;gt; (a org.apache.felix.dm.tracker.ServiceTracker$Tracked)
        at org.apache.felix.dm.tracker.ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:1054)
        at org.apache.felix.framework.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:990)
        at org.apache.felix.framework.EventDispatcher.fireEventImmediately(EventDispatcher.java:838)
        at org.apache.felix.framework.EventDispatcher.fireServiceEvent(EventDispatcher.java:545)
        at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4579)
        at org.apache.felix.framework.Felix.access$000(Felix.java:105)
        at org.apache.felix.framework.Felix$1.serviceChanged(Felix.java:419)
        at org.apache.felix.framework.ServiceRegistry.servicePropertiesModified(ServiceRegistry.java:588)
        at org.apache.felix.framework.ServiceRegistrationImpl.setProperties(ServiceRegistrationImpl.java:131)
        at org.apache.felix.scr.impl.manager.SingleComponentManager.updateServiceRegistration(SingleComponentManager.java:558)
        at org.apache.felix.scr.impl.manager.SingleComponentManager.modify(SingleComponentManager.java:755)
        at org.apache.felix.scr.impl.manager.SingleComponentManager.reconfigure(SingleComponentManager.java:645)
        at org.apache.felix.scr.impl.manager.SingleComponentManager.reconfigure(SingleComponentManager.java:609)
        at org.apache.felix.scr.impl.manager.ConfigurableComponentHolder.configurationUpdated(ConfigurableComponentHolder.java:426)
        at org.apache.felix.scr.impl.manager.RegionConfigurationSupport.configurationEvent(RegionConfigurationSupport.java:284)
        at org.apache.felix.scr.impl.manager.RegionConfigurationSupport$1.configurationEvent(RegionConfigurationSupport.java:89)
        at org.apache.felix.cm.impl.ConfigurationManager$FireConfigurationEvent.sendEvent(ConfigurationManager.java:2090)
        at org.apache.felix.cm.impl.ConfigurationManager$FireConfigurationEvent.run(ConfigurationManager.java:2058)
        at org.apache.felix.cm.impl.UpdateThread.run0(UpdateThread.java:141)
        at org.apache.felix.cm.impl.UpdateThread.run(UpdateThread.java:109)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;span class=&quot;code-quote&quot;&gt;&quot;FelixDispatchQueue&quot;&lt;/span&gt;:
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000000c0699f30&amp;gt; (a java.util.concurrent.locks.ReentrantLock$FairSync)
        at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireNanos(AbstractQueuedSynchronizer.java:934)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.tryAcquireNanos(AbstractQueuedSynchronizer.java:1247)
        at java.util.concurrent.locks.ReentrantLock.tryLock(ReentrantLock.java:442)
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.obtainLock(AbstractComponentManager.java:228)
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.obtainStateLock(AbstractComponentManager.java:279)
        at org.apache.felix.scr.impl.manager.SingleComponentManager.getService(SingleComponentManager.java:806)
        at org.apache.felix.framework.ServiceRegistrationImpl.getFactoryUnchecked(ServiceRegistrationImpl.java:347)
        at org.apache.felix.framework.ServiceRegistrationImpl.getService(ServiceRegistrationImpl.java:247)
        at org.apache.felix.framework.ServiceRegistry.getService(ServiceRegistry.java:350)
        at org.apache.felix.framework.Felix.getService(Felix.java:3721)
        at org.apache.felix.framework.BundleContextImpl.getService(BundleContextImpl.java:470)
        at org.apache.felix.dm.impl.ServiceEventImpl.getEvent(ServiceEventImpl.java:86)
        at org.apache.felix.dm.impl.ServiceDependencyImpl.addingService(ServiceDependencyImpl.java:251)
        at org.apache.felix.dm.tracker.ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:1276)
        at org.apache.felix.dm.tracker.AbstractTracked.trackAdding(AbstractTracked.java:279)
        at org.apache.felix.dm.tracker.AbstractTracked.trackInitial(AbstractTracked.java:188)
        - locked &amp;lt;0x00000000eb38d420&amp;gt; (a org.apache.felix.dm.tracker.ServiceTracker$Tracked)
        at org.apache.felix.dm.tracker.ServiceTracker.open(ServiceTracker.java:387)
        - locked &amp;lt;0x00000000eb38d420&amp;gt; (a org.apache.felix.dm.tracker.ServiceTracker$Tracked)
        - locked &amp;lt;0x00000000eb38cd00&amp;gt; (a org.apache.felix.dm.tracker.ServiceTracker)
        at org.apache.felix.dm.tracker.ServiceTracker.open(ServiceTracker.java:320)
        at org.apache.felix.dm.tracker.ServiceTracker.open(ServiceTracker.java:296)
        at org.apache.felix.dm.impl.ServiceDependencyImpl.start(ServiceDependencyImpl.java:235)
        at org.apache.felix.dm.impl.ComponentImpl.startDependencies(ComponentImpl.java:1360)
        at org.apache.felix.dm.impl.ComponentImpl.performTransition(ComponentImpl.java:1059)
        at org.apache.felix.dm.impl.ComponentImpl.handleChange(ComponentImpl.java:1010)
        at org.apache.felix.dm.impl.ComponentImpl.lambda$start$2(ComponentImpl.java:426)
        at org.apache.felix.dm.impl.ComponentImpl$$Lambda$7/201251057.run(Unknown Source)
        at org.apache.felix.dm.impl.SerialExecutor.runTask(SerialExecutor.java:138)
        at org.apache.felix.dm.impl.SerialExecutor.runTasks(SerialExecutor.java:120)
        at org.apache.felix.dm.impl.SerialExecutor.execute(SerialExecutor.java:86)
        at org.apache.felix.dm.impl.SerialExecutor.execute(SerialExecutor.java:105)
        at org.apache.felix.dm.impl.ComponentImpl.start(ComponentImpl.java:424)
        at org.apache.felix.dm.impl.ComponentScheduler.add(ComponentScheduler.java:69)
        at org.apache.felix.dm.DependencyManager.add(DependencyManager.java:136)
        at com.alcatel.as.service.coordinator.impl.Activator.init(Activator.java:16)
        at org.apache.felix.dm.DependencyActivatorBase.start(DependencyActivatorBase.java:75)
        at org.apache.felix.framework.util.SecureAction.startActivator(SecureAction.java:697)
        at org.apache.felix.framework.Felix.activateBundle(Felix.java:2239)
        at org.apache.felix.framework.Felix.startBundle(Felix.java:2145)
        at org.apache.felix.framework.BundleImpl.start(BundleImpl.java:998)
        at com.alcatel.as.service.bundleinstaller.impl.BundleInstallerImpl$DeployedBundle.start(BundleInstallerImpl.java:1056)
        at com.alcatel.as.service.bundleinstaller.impl.BundleInstallerImpl.startBundles(BundleInstallerImpl.java:728)
        at com.alcatel.as.service.bundleinstaller.impl.BundleInstallerImpl.finishInitialisation(BundleInstallerImpl.java:230)
        at com.alcatel.as.service.bundleinstaller.impl.BundleInstallerImpl.frameworkEvent(BundleInstallerImpl.java:213)
        at com.alcatel.as.service.bundleinstaller.impl.BundleInstallerImpl.start(BundleInstallerImpl.java:174)
        at org.apache.felix.framework.util.SecureAction.startActivator(SecureAction.java:697)
        at org.apache.felix.framework.Felix.activateBundle(Felix.java:2239)
        at org.apache.felix.framework.Felix.startBundle(Felix.java:2145)
        at org.apache.felix.framework.Felix.updateBundle(Felix.java:2506)
        at org.apache.felix.framework.BundleImpl.update(BundleImpl.java:1018)
        at org.apache.felix.framework.BundleImpl.update(BundleImpl.java:1004)
        at com.alcatel.as.service.bundleinstaller.impl.BundleInstallerImpl.checkSelfUpdate(BundleInstallerImpl.java:273)
        at com.alcatel.as.service.bundleinstaller.impl.BundleInstallerImpl.frameworkEvent(BundleInstallerImpl.java:192)
        at org.apache.felix.framework.EventDispatcher.invokeFrameworkListenerCallback(EventDispatcher.java:881)
        at org.apache.felix.framework.EventDispatcher.fireEventImmediately(EventDispatcher.java:830)
        at org.apache.felix.framework.EventDispatcher.run(EventDispatcher.java:1147)
        at org.apache.felix.framework.EventDispatcher.access$000(EventDispatcher.java:54)
        at org.apache.felix.framework.EventDispatcher$1.run(EventDispatcher.java:102)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)

Found 1 deadlock.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;now, here is my first interpretation of what is going on:&lt;/p&gt;

&lt;p&gt;in SCR:&lt;br/&gt;
=====&lt;/p&gt;

&lt;p&gt;Configuration Admin is delivering a configuration update event to SCR. So, the org.apache.felix.scr.impl.manager.RegionConfigurationSupport.configurationEvent() method is then called. This method then indirectly triggers a call to the SingleComponentManager.reconfigure method, which then calls SingleComponentManager.modify method. Here is the modify() method:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; modify(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; configurationDeleted)
    {
        &lt;span class=&quot;code-comment&quot;&gt;//0 SCR 112.7.1 If configuration is deleted, and version is &amp;lt; 1.3 and no flag set, then deactivate unconditionally.
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// For version 1.3 and later, or with a flag, more sensible behavior is allowed.
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( configurationDeleted &amp;amp;&amp;amp; !getComponentMetadata().isDeleteCallsModify()){
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        }

        &lt;span class=&quot;code-comment&quot;&gt;// 1. no live update &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; there is no declared method
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( getComponentMetadata().getModified() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; )
        {
            log( LogService.LOG_DEBUG, &lt;span class=&quot;code-quote&quot;&gt;&quot;No modified method, cannot update dynamically&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; );
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        }
        &lt;span class=&quot;code-comment&quot;&gt;// invariant: we have a modified method name
&lt;/span&gt;
        &lt;span class=&quot;code-comment&quot;&gt;// 2. get and check configured method
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// invariant: modify method is configured and found
&lt;/span&gt;
        &lt;span class=&quot;code-comment&quot;&gt;// 3. check whether we can dynamically apply the configuration &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// any target filters influence the bound services
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; props = getProperties();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ( DependencyManager&amp;lt;S, ?&amp;gt; dm: getDependencyManagers() )
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( !dm.canUpdateDynamically( props ) )
            {
                log( LogService.LOG_DEBUG,
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot dynamically update the configuration due to dependency changes induced on dependency {0}&quot;&lt;/span&gt;,
                        &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] {dm.getName()}, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; );
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            }
        }
        &lt;span class=&quot;code-comment&quot;&gt;// invariant: modify method existing and no &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; bound service changes
&lt;/span&gt;
        &lt;span class=&quot;code-comment&quot;&gt;// 4. call method (nothing to &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; when failed, since it has already been logged)
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//   (call with non-&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; result to &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt; even &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//    modify method call failed)
&lt;/span&gt;        obtainStateLock(  );
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
        {
            &lt;span class=&quot;code-comment&quot;&gt;//cf 112.5.12 where invoking modified method before updating target services is specified.
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; MethodResult result = invokeModifiedMethod();
            updateTargets( props );
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( result == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; )
            {
                &lt;span class=&quot;code-comment&quot;&gt;// log an error &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the declared method cannot be found
&lt;/span&gt;                log( LogService.LOG_ERROR, &lt;span class=&quot;code-quote&quot;&gt;&quot;Declared modify method &lt;span class=&quot;code-quote&quot;&gt;&apos;&apos;{0}&apos;&lt;/span&gt;&apos; cannot be found, configuring by reactivation&quot;&lt;/span&gt;,
                        &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] {getComponentMetadata().getModified()}, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; );
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            }

            &lt;span class=&quot;code-comment&quot;&gt;// 5. update the target filter on the services now, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; may still
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// result in unsatisfied dependencies, in which &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; we abort
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; dynamic update and have the component be deactivated
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( !verifyDependencyManagers() )
            {
                log( LogService.LOG_DEBUG,
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;Updating the service references caused at least one reference to become unsatisfied, deactivating component&quot;&lt;/span&gt;,
                        &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; );
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            }

            &lt;span class=&quot;code-comment&quot;&gt;// 6. update service registration properties &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we didn&apos;t just &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; it
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( result.hasResult() )
            {
                setServiceProperties( result, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; );
            }
            &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
            {
                updateServiceRegistration();
            }
     ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is problematic because we see that the modify method is invoking the updateServiceRegistration while holding the StateLock. (the obtainStateLock() method is called and then the service registration is updaded). &lt;/p&gt;

&lt;p&gt;Here, the listener is a DM component, but this component is internally synchronized on it&apos;s service tracker, and is currently blocked, trying to dereference the DS service, but it can&apos;t because the DS service state lock is currently held by the modify method.&lt;/p&gt;

&lt;p&gt;in the next section, I&apos;m now analyzing what is doing DM and will propose a patch in order to make sure DM does not hold any locks while calling bundleContext.getService(ref) ... this will fix the issue.&lt;/p&gt;

&lt;p&gt;Dependency Manager&lt;br/&gt;
=================&lt;/p&gt;

&lt;p&gt;In dependency manager, now let&apos;s analyze the the FelixDispatchQueue stacktrace: we open the DM service tracker, but the open method (in the DM service tracker) calls the AbstractTracked.trackInitial while holding the lock on ServiceTracker$Tracked. Then this triggers the customizer &quot;addingService&quot; method call, which then perform a getService. But the getService then tries to dereference a declarative service component, and the stacktrace is then blocked because the DS component state lock is currently locked by the other &quot;CM Event Dispatcher&quot;&lt;br/&gt;
So, in the end, I think that there is something wrong in both SCR and DM :&lt;/p&gt;

&lt;p&gt;1) SCR obtain the state lock while update the service registration.&lt;br/&gt;
This is , I think, unfortunate because updating the service registration while holding a lock is like hodling a lock while calling foreign code (you don&apos;t know what will do the service listener when you update the service registration).&lt;/p&gt;

&lt;p&gt;2) and DM calls the customizer &quot;addingService&quot; method while holding the lock on the service tracker. This is also not satisfying.&lt;/p&gt;

&lt;p&gt;So, at minimul, in DM I do believe that we should manage to not invoke the customizer.addingService while holding the lock on the DM service tracker.&lt;/p&gt;

&lt;p&gt;now, I have given a look into the DM ServiceTracker.open method and it is currently implemented like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void open(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; trackAllServices, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; trackAllAspects) {
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (debug) {
			&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;[ServiceTracker] &quot;&lt;/span&gt; + debugKey + &lt;span class=&quot;code-quote&quot;&gt;&quot; T&quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getId() + &lt;span class=&quot;code-quote&quot;&gt;&quot; open&quot;&lt;/span&gt;);
		}
		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Tracked t;
		&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tracked != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
				&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
			}
			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (DEBUG) {
				&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;ServiceTracker.open: &quot;&lt;/span&gt; + filter); 
			}
			m_trackAllAspects = trackAllAspects;
			t = trackAllServices ? &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AllTracked() : &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Tracked();
			&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (t) {
				&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
					context.addServiceListener(t, listenerFilter);
					ServiceReference[] references = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
					&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (trackClass != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
						references = getInitialReferences(trackAllServices,
								trackClass, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
					}
					&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
						&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (trackReference != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
							&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (trackReference.getBundle() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
								references = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ServiceReference[] {trackReference};
							}
						}
						&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; { &lt;span class=&quot;code-comment&quot;&gt;/* user supplied filter */&lt;/span&gt;
							references = getInitialReferences(trackAllServices,
									&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,
									(listenerFilter != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) ? listenerFilter
											: filter.toString());
						}
					}
					&lt;span class=&quot;code-comment&quot;&gt;/* set tracked with the initial references */&lt;/span&gt;
					t.setInitial(references);
					
					&lt;span class=&quot;code-comment&quot;&gt;// only actually schedules the actions &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; execution within &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; block,
&lt;/span&gt;					&lt;span class=&quot;code-comment&quot;&gt;// but &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; the actual execution afterwards.
&lt;/span&gt;					t.trackInitial(); 

				}
				&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InvalidSyntaxException e) {
					&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(
							&lt;span class=&quot;code-quote&quot;&gt;&quot;unexpected InvalidSyntaxException: &quot;&lt;/span&gt;
									+ e.getMessage(), e); 
				}
			}
			tracked = t;
		}
		&lt;span class=&quot;code-comment&quot;&gt;/* Call tracked outside of &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; region */&lt;/span&gt;
		&lt;span class=&quot;code-comment&quot;&gt;// just trigger the executor
&lt;/span&gt;		t.getExecutor().execute();
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As you can see the &quot;t.trackInitial()&quot; is invoked from within the synchronized block. This method actually schedules customizer &quot;added&quot; callbacks, which will be invoked properly outside of the synchronized block  (when t.getExecutor().executor() will be called).&lt;br/&gt;
But please notice that the the issue is that the t.trackInitial() will also invoke the &quot;addingService&quot; customizer callback from the synchronized block. Doing so will end up dereferencing the DS service reference while we are holding the ServiceTracker lock.&lt;/p&gt;

&lt;p&gt;Interestingly, notice that the BundleTracker is not calling the t.trackInitial() method from the synchronized block.&lt;/p&gt;

&lt;p&gt;so, I have attempted to make a patch, which seems to resolve the issue. All tests are passing OK, and we don&apos;t experience the deadlock anymore, and I would appreciate if another DM developer or user could take a look at my proposed patch, to make sure I don&apos;t have messed up &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;thanks&lt;/p&gt;</description>
                <environment></environment>
        <key id="13110136">FELIX-5716</key>
            <summary>Dead Lock in DM</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pderop">Pierre De Rop</assignee>
                                    <reporter username="pderop">Pierre De Rop</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Oct 2017 21:48:06 +0000</created>
                <updated>Mon, 22 Oct 2018 09:01:29 +0000</updated>
                            <resolved>Thu, 29 Mar 2018 20:12:32 +0000</resolved>
                                    <version>org.apache.felix.dependencymanager-r1</version>
                                    <fixVersion>org.apache.felix.dependencymanager-r13</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16208466" author="pderop" created="Tue, 17 Oct 2017 21:49:05 +0000"  >&lt;p&gt;Attaching the proposed patch.&lt;/p&gt;</comment>
                            <comment id="16418731" author="sstoel" created="Thu, 29 Mar 2018 10:40:52 +0000"  >&lt;p&gt;My application was also experiencing a deadlock after unregistering certain services with aspects, after applying this patch it is working as expected.&lt;/p&gt;</comment>
                            <comment id="16418838" author="pderop" created="Thu, 29 Mar 2018 11:56:27 +0000"  >&lt;p&gt;thanks for reporting;&lt;/p&gt;

&lt;p&gt;I should committed the patch a long time ago &#160;(I&apos;m sorry). I will manage to do it this week-end.&lt;/p&gt;

&lt;p&gt;I think I will also make a new release the next week (it&#160;will also include the enhancements that have been made in&#160;&lt;a href=&quot;https://github.com/pderop/dm.enhanced&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pderop/dm.enhanced&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;thank you&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16419679" author="pderop" created="Thu, 29 Mar 2018 20:12:32 +0000"  >&lt;p&gt;Committed the patch in&#160;revision 1828022.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12892690" name="deadlock.proposed.patch.txt" size="2128" author="pderop" created="Tue, 17 Oct 2017 21:48:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 33 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ldtz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>