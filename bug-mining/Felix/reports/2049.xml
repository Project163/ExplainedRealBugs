<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:51:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-4297] [DS] timing hole in opening a dependency manager</title>
                <link>https://issues.apache.org/jira/browse/FELIX-4297</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;Pierre de Rop saw this running the integration tests:&lt;/p&gt;

&lt;p&gt;test_concurrent_injection_with_bundleContext(org.apache.felix.scr.integration.Felix3680_2Test)  Time elapsed: 36.597 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.invokeUnbindMethod(DependencyManager.java:1710)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.SingleComponentManager.invokeUnbindMethod(SingleComponentManager.java:387)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager$MultipleDynamicCustomizer.removedService(DependencyManager.java:355)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager$MultipleDynamicCustomizer.removedService(DependencyManager.java:290)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:1503)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:1398)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.ServiceTracker$AbstractTracked.untrack(ServiceTracker.java:1258)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:1437)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
        at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
        at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4260)&lt;br/&gt;
        at org.apache.felix.framework.Felix.access$000(Felix.java:74)&lt;br/&gt;
        at org.apache.felix.framework.Felix$1.serviceChanged(Felix.java:390)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:148)&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:127)&lt;br/&gt;
        at org.apache.felix.scr.integration.components.felix3680_2.Main$RegistrationHelper$2.run(Main.java:136)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;


&lt;p&gt;The problem is that a service is being removed between the time the component instance is being created and the time the dependency manager is opened, and there is no open latch yet.  I see that the EdgeInfos are never reused, so the fix appears to be to:&lt;br/&gt;
1. set up all the edgeInfos in the ComponentContextImpl constructor, avoiding a race (not observed AFAIK) in getEdgeInfo&lt;br/&gt;
2. make the open latch and close latch in EdgeInfo final&lt;br/&gt;
3. in DependencyManager.invokeUnbind and invokeUpdated make sure open is complete before checking outOfRange.&lt;br/&gt;
4. distinguish between out of range before and after.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12676191">FELIX-4297</key>
            <summary>[DS] timing hole in opening a dependency manager</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="djencks">David Jencks</assignee>
                                    <reporter username="djencks">David Jencks</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 Oct 2013 18:35:38 +0000</created>
                <updated>Thu, 4 Sep 2014 08:04:07 +0000</updated>
                            <resolved>Mon, 28 Oct 2013 23:08:42 +0000</resolved>
                                    <version>scr-1.8.0</version>
                                    <fixVersion>scr-1.8.0</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13807453" author="djencks" created="Mon, 28 Oct 2013 23:08:42 +0000"  >&lt;p&gt;Should be fixed in rev 1536550&lt;/p&gt;</comment>
                            <comment id="13808132" author="pderop" created="Tue, 29 Oct 2013 16:13:20 +0000"  >&lt;p&gt;While testing, I got two &quot;timeount on latch&quot; logs, following by some stacktraces.&lt;/p&gt;

&lt;p&gt;For simplicity, I changed the current dumpThreads method in order to log in WARN, instead of DEBUG, in order to reproduce the problem without having too much logs.&lt;/p&gt;

&lt;p&gt;Also: should this dumpstack be logged in WARN instead of DEBUG ? &lt;/p&gt;</comment>
                            <comment id="13808295" author="djencks" created="Tue, 29 Oct 2013 18:47:58 +0000"  >&lt;p&gt;Added one possible fix for the latch timeout in rev 1536844&lt;/p&gt;

&lt;p&gt;I&apos;m slightly reluctant to make all dumpThreads log at WARN since it&apos;s also called from the circular dependency detection, which does not necessarily indicate an error.  Rather than making the log level configurable I&apos;m tempted to leave it as is and ask people who find bugs to turn up the log level.  (hopefully we&apos;ll fix all these bugs soon &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13808545" author="pderop" created="Tue, 29 Oct 2013 22:28:29 +0000"  >&lt;p&gt;Ok, in fact, I did not know that it was intentional to log this dump stack in debug , and I have no problem with this. Now, I know it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I have tested the fix in rv 1536844, but I&apos;m still having the two &quot;timeout on latch&quot; logs , including the stacktraces in debug.&lt;/p&gt;

&lt;p&gt;I have attached stacktrace2.log to this issue.&lt;br/&gt;
In this log, I also joined every DS debug logs, in case it may help.&lt;/p&gt;

&lt;p&gt;let me know if you need more informations.&lt;/p&gt;</comment>
                            <comment id="13808839" author="djencks" created="Wed, 30 Oct 2013 08:11:41 +0000"  >&lt;p&gt;Looking hard at the new logs I found what I think the problem is, I added a test case demonstrating.&lt;/p&gt;

&lt;p&gt;Component FactoryClient has references to a factory component (ComponentFactory) and also a multiple reference to the service the component factory creates with newInstance.  The ComponentFactory reference is first in the xml descriptor so is opened first.  The setFactory method calls newInstance on the factory, creating a service which results in a service event for the other bind method.  Since we&apos;re still in the first bind method for the factory, the edgeInfo for the 2nd reference hasn&apos;t even had the open tracking count set, and can&apos;t possibly get it&apos;s open latch counted down... that happens later when the 2nd dependency manager is opened.&lt;/p&gt;

&lt;p&gt;The solution is to notice that if the open tracking count is not set, then the tracking count from the service event must be out of range since the tracker has recorded it and sometime later the open will be set to the highest tracking count the tracker has recorded.&lt;/p&gt;

&lt;p&gt;rev 1536996&lt;/p&gt;</comment>
                            <comment id="13808923" author="pderop" created="Wed, 30 Oct 2013 10:15:59 +0000"  >&lt;p&gt;I confirm that the fix works ! I don&apos;t have anymore the &quot;&quot;timeount on latch&quot; error messages.&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12610827" name="stacktrace.log" size="56311" author="pderop" created="Tue, 29 Oct 2013 16:13:20 +0000"/>
                            <attachment id="12610935" name="stacktrace2.log" size="779761" author="pderop" created="Tue, 29 Oct 2013 22:28:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>355688</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1pbi7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>355976</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>