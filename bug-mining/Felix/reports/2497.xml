<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:58:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-4984] Issues in CircularReferenceTest</title>
                <link>https://issues.apache.org/jira/browse/FELIX-4984</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;This issue is described in the dev mailing list, in &lt;a href=&quot;http://www.mail-archive.com/dev@felix.apache.org/msg37281.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/dev@felix.apache.org/msg37281.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;while working on &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-4955&quot; title=&quot;DS based on Dependency Manager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-4955&quot;&gt;FELIX-4955&lt;/a&gt;, I sometimes have the CircularReferenceTest failing.&lt;/p&gt;

&lt;p&gt;Everything is located in my sandbox, in &lt;a href=&quot;http://svn.apache.org/repos/asf/felix/sandbox/pderop/dependencymanager.ds/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/felix/sandbox/pderop/dependencymanager.ds/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To reproduce the test:&lt;/p&gt;

&lt;p&gt;install eclipse Mars&lt;/p&gt;

&lt;p&gt;install latest bndtools using &quot;install new software&quot; from Eclipse, and then add latest stable release from &lt;a href=&quot;http://dl.bintray.com/bndtools/bndtools/latest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://dl.bintray.com/bndtools/bndtools/latest/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;install a java8 runtime (I&apos;m using oracle java8 1.8.0_45, 64 bit version). The whole new dependencymanager.ds project is intented to be build in java8.&lt;/p&gt;

&lt;p&gt;checkout my sandbox:&lt;br/&gt;
$ svn checkout &lt;a href=&quot;http://svn.apache.org/repos/asf/felix/sandbox/pderop/dependencymanager.ds&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/felix/sandbox/pderop/dependencymanager.ds&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;go to &quot;dependencymanager.ds&quot; directory:&lt;br/&gt;
$ cd dependencymanager.ds/&lt;/p&gt;

&lt;p&gt;due to a pending issue, you have to first build the DM bnd annotation plugin before importing the project into eclipse. to do so, just type:&lt;br/&gt;
$ ./gradlew org.apache.felix.dependencymanager.annotation:jar&lt;/p&gt;

&lt;p&gt;now launch eclipse and use the the dependencymanager/ds directory as the workspace dir for Eclipse.&lt;/p&gt;

&lt;p&gt;switch to BndTools perpective.&lt;/p&gt;

&lt;p&gt;import the bndtools project into eclipse: Import -&amp;gt; Existing Projects into Workspace -&amp;gt; Browse -&amp;gt; select dependencymanager.ds directory (it is proposed by default).&lt;/p&gt;

&lt;p&gt;normally, and hopefully, everything should compile fine. Junit tests are left in org.apache.felix.dependencymanager.ds/ directory and integration tests are located in org.apache.felix.dependencymanager.ds.itest/ directory.&lt;/p&gt;

&lt;p&gt;Open under Eclipse the org.apache.felix.dependencymanager.ds.itest/src/org/apache/felix/scr/integration/CircularReferenceTest.java&lt;br/&gt;
I slightly modified it in order to dump stack traces when A component is bound multiple times to the same B instance.&lt;/p&gt;

&lt;p&gt;(I believe that only delayed components are concerned by the issue).&lt;/p&gt;

&lt;p&gt;For example, in the test_A11_B0n_delayed_A_first() method, I added a call to &quot;assertABoundToOneB(a)&quot; like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void test_A11_B0n_delayed_A_first() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InvalidSyntaxException
    {
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; componentNameA = &lt;span class=&quot;code-quote&quot;&gt;&quot;4.1.A.1.1.dynamic&quot;&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ComponentConfigurationDTO componentA = findComponentConfigurationByName( componentNameA, ComponentConfigurationDTO.SATISFIED );

        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; componentNameB = &lt;span class=&quot;code-quote&quot;&gt;&quot;4.1.B.0.n.dynamic&quot;&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ComponentConfigurationDTO componentB = findComponentConfigurationByName( componentNameB, ComponentConfigurationDTO.SATISFIED );

        delay();

        A a = getServiceFromConfiguration(componentA, A.class);
        assertABoundToOneB(a);
        delay(); &lt;span class=&quot;code-comment&quot;&gt;//async binding of a to b after circular ref detected
&lt;/span&gt;        B b = getServiceFromConfiguration(componentB, B.class);
        assertEquals( 1, b.getAs().size() );
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the &quot;assertABoundToOneB(a)&quot; call does this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void assertABoundToOneB(A a) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (a.getBs().size() != 1) {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;detected problem ...&quot;&lt;/span&gt;);
            a.dumpStackTracesWhenBWasBound();
        }
        assertEquals( 1, a.getBs().size());
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And stacktraces will be dumped in order to determine why A was bound two times to the same B instance.&lt;/p&gt;

&lt;p&gt;it&apos;s possible that you have to run several times the &quot;CircularReferenceTest&quot; test before having a failure (and some stacktraces).&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12850337">FELIX-4984</key>
            <summary>Issues in CircularReferenceTest</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="pderop">Pierre De Rop</reporter>
                        <labels>
                    </labels>
                <created>Thu, 30 Jul 2015 19:11:27 +0000</created>
                <updated>Mon, 27 Feb 2017 14:00:15 +0000</updated>
                            <resolved>Mon, 27 Feb 2017 14:00:15 +0000</resolved>
                                                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14649086" author="pderop" created="Fri, 31 Jul 2015 11:03:02 +0000"  >&lt;p&gt;I forgot to mention an important point: if you are testing using a corporate http proxy, it seems that the Aether plugin (that I use to connect to maven from bndtools) is not able to use the eclipse proxy settings.&lt;br/&gt;
So, to work around, you can install a local nexus, configure it with your corporate http proxy, then you can configure the aether plugin repository in order to access to maven central through your local nexus.&lt;/p&gt;

&lt;p&gt;something like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-plugin:\
       ...
	aQute.bnd.deployer.repository.aether.AetherRepository; name=Maven Central; url=http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8081/nexus/content/repositories/central/; cache=${build}/cache/maven	&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14662878" author="pderop" created="Sat, 8 Aug 2015 08:38:32 +0000"  >&lt;p&gt;So, I think I reproduced the issue with DEBUG logs. I introduced a new &quot;WRITE_LOGS_TO_FILE&quot; variable in the ComponentTestBase class in order to allow the CircularReferenceTest to log to a file in /tmp asynchronously instead of logging into the BndTools console.&lt;/p&gt;

&lt;p&gt;The concerned test is &quot;test_A11_B0n_delayed_B_first&quot; test (the assert fails at line 157).&lt;/p&gt;

&lt;p&gt;Please look into the attached log file ( org.apache.felix.scr.integration.CircularReferenceTest.test_A11_B0n_delayed_B_first.log), which is the log file for the failing test and look for the &quot;detected problems&quot;, line 1095&lt;/p&gt;

&lt;p&gt;So, here, the &quot;A.setB(B b)&quot;  method is indirectly called by the SingleComponentManager.createComponent() method, which opens the DependencyManager, (the open method calls &quot;A.setB(B b)&quot;). You can check this from the stacktrace line 1098&lt;/p&gt;

&lt;p&gt;Then, concurrently (see at line 1142), the ComponentActor thread calls &quot;invokeBindMethodLate&quot;, which ends up calling the &quot;A.setB(B b)&quot; method a second time.&lt;/p&gt;

&lt;p&gt;My theory is the following (not sure, it&apos;s a supposition, please confirm this): I think that from the integration test, when the ServiceReference on B is dereferenced (line 146), then when the SingleComponentManager.createComponent method creates B, this method (at the end) calls &quot; activator.missingServicePresent&quot; line 140. And this method seems to find A component (because at this point, A is in the m_missingDependencies table). So a task is scheduled in the ComponentActor thread which ends up calling the A.setB(B b) method at the same time A is created (at the same time we are concurrently executing from the main thread the code called from the line 152 in the CircularReferenceTest). And when we are execute code from line 152 (CircularReferenceTest.java), we are currently in the SingleComponentManager.createComponent method (for the A component), and the DependencyManager.open has been called and has already called &quot;A.setB(b b)&quot; method.&lt;/p&gt;

&lt;p&gt;So, this results in two invocations on A.setB(B b) method.&lt;br/&gt;
Is my analysis correct or is all this a result of a side effect on my porting of SCR integration tests under bndtools ?&lt;/p&gt;

&lt;p&gt;Hope you will find interesting information in the DEBUG logs.&lt;/p&gt;

&lt;p&gt;Thank you;&lt;/p&gt;</comment>
                            <comment id="14662879" author="pderop" created="Sat, 8 Aug 2015 08:41:13 +0000"  >&lt;p&gt;attached log file.&lt;/p&gt;</comment>
                            <comment id="14693635" author="djencks" created="Wed, 12 Aug 2015 15:04:22 +0000"  >&lt;p&gt;After studying this for a while I think that what is happening is that we&apos;re remembering to &quot;bind later&quot; a reference for a component that can&apos;t possibly be created from the original request, because of cardinality constraints.  Then when it &lt;em&gt;is&lt;/em&gt; created (due to starting at a different point in the cycle) the leftover &quot;bind later&quot; request is binding the same object as the &quot;normally working&quot; bind, but to a different  object than we originally expected.  I&apos;m not entirely sure why this only happens occasionally.&lt;/p&gt;

&lt;p&gt;I have a proposal (see patch) to only add a &quot;bind later&quot; request when the cardinality is otherwise satisfied, without the missing dependency, so that if we know the component can&apos;t be created we don&apos;t add the &quot;bind later&quot; request.  Do you think this is at least on the right track?  It now occurs to me that perhaps checking &lt;em&gt;all&lt;/em&gt; the references before adding any &quot;bind later&quot; requests would be safer.&lt;/p&gt;</comment>
                            <comment id="14693637" author="djencks" created="Wed, 12 Aug 2015 15:05:44 +0000"  >&lt;p&gt;single-dependency manager checking for satisfied cardinality without the missing dependency.&lt;/p&gt;</comment>
                            <comment id="14706347" author="pderop" created="Fri, 21 Aug 2015 07:38:34 +0000"  >&lt;p&gt;I just tested the patch and the problem seems to be resolved:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Under bndtools, I ran 50 successful times the CircularReferenceTest (under bndtools).&lt;/li&gt;
	&lt;li&gt;Ran all tests successfully under bndtools.&lt;/li&gt;
	&lt;li&gt;Ran all tests with &quot;gradle org.apache.felix.dependencymanager.ds.itest:check&quot;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Please give me some time so I can fully understand the patch (I will study it this week-end).&lt;/p&gt;

&lt;p&gt;Currently, I tend to agree with the fact that it might be necessary to ensure that all references are satisfied before scheduling the &quot;bind later&quot; tasks (I need to study the patch).&lt;/p&gt;

&lt;p&gt;thanks !&lt;/p&gt;</comment>
                            <comment id="14711355" author="pderop" created="Tue, 25 Aug 2015 14:24:49 +0000"  >&lt;p&gt;In order to better understand what is going on and to better verify that the attached patch is working, I just committed a new test case, which seems to reproduce the issue more reliably.&lt;/p&gt;

&lt;p&gt;The itest is made of the following parts:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;org.apache.felix.dependencymanager.ds.itest/resource/integration_test_FELIX_4984.xml: this file defines two components A, and B. A has a dynamic 1..1 dependency on B. And B has a 0..N dynamic dependency on A.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;org.apache.felix.dependencymanager.ds.itest/src/org/apache/felix/scr/integration/components/felix4984/A.java: This is the A component that is defined in the integration_test_FELIX_4984.xml DS descriptor.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;org.apache.felix.dependencymanager.ds.itest/src/org/apache/felix/scr/integration/components/felix4984/B.java: this is the B component that is defined in the integration_test_FELIX_4984.xml DS descriptor.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;org.apache.felix.dependencymanager.ds.itest/src/org/apache/felix/scr/integration/Felix4984Test.java: This is the new  integration test that performs a loop (1000 times). During each iteration, the tiny bundle that corresponds to the integration_test_FELIX_4984.xml descriptor is restarted. Then the test is getting a B instance from the B reference. Finally, the test is then getting a A instance from the A reference.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So, using the test above, and without your patch, I think that the issue is reproduced reliably: after a couple of iterations, A.setB(B b) is called twice on the same b instance.&lt;br/&gt;
I attached org.apache.felix.scr.integration.Felix4984Test.test_A11_B0n_delayed_B_first_ABoundToAtMostOneB.log&lt;br/&gt;
and if you take a look at line 3100 (during iteration #16), you will see the two stacktraces when A.setB(B b) is called.&lt;/p&gt;

&lt;p&gt;A.setB(B b) is first called when we dereference the A service reference (see first stacktrace, line 3104).&lt;br/&gt;
A.setB(B b) is called a second time because previously, when the B service reference was dereferenced, then a task was scheduled in the ComponentActor thread, which calls invokeBindMethodLate (see second stacktrace, line 3147).&lt;/p&gt;

&lt;p&gt;So, using your patch seems to resolve the problem (I&apos;m not sure enough to say if it&apos;s really necessary to ensure that all references are satisfied before scheduling the &quot;bind later&quot; tasks).&lt;/p&gt;

&lt;p&gt;But, using the new integration test, a new problem occurs. It&apos;s probably less important than the previous one but it&apos;s worth taking a look at it. I think that the task scheduled in the component actor thread that calls invokeBindMethodLate has a kind of synchronization issue, because in the test, when we stop the tiny bundle (in line 69, in Felix4984Test.java), the task running in the actor thread is concurrently invoking  invokeBindMethodLate, which is then getting a NPE.&lt;/p&gt;

&lt;p&gt;I have attached a new log file org.apache.felix.scr.integration.Felix4984Test.test_A11_B0n_delayed_B_first_ABoundToAtMostOneB-NPE-with_patch.log&lt;/p&gt;

&lt;p&gt;Please take a look at line 78622 and check the exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  78621 L=1 D=15:59:30,8 T=&lt;span class=&quot;code-quote&quot;&gt;&quot;SCR Component Actor&quot;&lt;/span&gt; (log Unexpected): Unexpected problem executing task Late binding task of reference [org.apache.felix.scr.integration.components.felix4984.A] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;         dependencyManagers [org.apache.felix.scr.impl.ComponentRegistry$Entry@4b21844c]
  78622 java.lang.NullPointerException
  78623         at org.apache.felix.scr.impl.helper.BindMethod.getServiceObject(BindMethod.java:643)
  78624         at org.apache.felix.scr.impl.manager.DependencyManager.getServiceObject(DependencyManager.java:2134)
  78625         at org.apache.felix.scr.impl.manager.DependencyManager.doInvokeBindMethod(DependencyManager.java:1648)
  78626         at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethod(DependencyManager.java:1633)
  78627         at org.apache.felix.scr.impl.manager.SingleComponentManager.invokeBindMethod(SingleComponentManager.java:370)
  78628         at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethodLate(DependencyManager.java:1577)
  78629         at org.apache.felix.scr.impl.ComponentRegistry$1.run(ComponentRegistry.java:570)
  78630         at org.apache.felix.scr.impl.ComponentActorThread.run(ComponentActorThread.java:99)
  78631         at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14711358" author="pderop" created="Tue, 25 Aug 2015 14:26:51 +0000"  >&lt;p&gt;attached org.apache.felix.scr.integration.Felix4984Test.test_A11_B0n_delayed_B_first_ABoundToAtMostOneB.log as well as org.apache.felix.scr.integration.Felix4984Test.test_A11_B0n_delayed_B_first_ABoundToAtMostOneB-NPE-with_patch.log.gz.&lt;/p&gt;

&lt;p&gt;thanks.&lt;/p&gt;</comment>
                            <comment id="14712110" author="pderop" created="Tue, 25 Aug 2015 22:39:47 +0000"  >&lt;p&gt;Ok, the NPE is caused by the fact that the test_A11_B0n_delayed_B_first_ABoundToAtMostOneB() is getting a A instance and is then immediately stopping the bundle:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            ServiceReference[] serviceReferencesA = bundleContext.getServiceReferences( A.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName(), &lt;span class=&quot;code-quote&quot;&gt;&quot;(service.pid=&quot;&lt;/span&gt; + componentNameA + &lt;span class=&quot;code-quote&quot;&gt;&quot;)&quot;&lt;/span&gt; );
            TestCase.assertEquals( 1, serviceReferencesA.length );
            ServiceReference serviceReferenceA = serviceReferencesA[0];
            &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; serviceA = bundleContext.getService( serviceReferenceA );
            assertNotNull( serviceA );

            A a = getServiceFromConfiguration(componentA, A.class);
            assertABoundToOneB(a);

            bundle.stop();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, when A is dereferenced, the invokeBindMethodLate() call is scheduled in the component actor thread in order to call B.setA(A a).&lt;br/&gt;
But since we immediately stop the bundle, then we are getting the NPE in the invokeBindMethodLate() method.&lt;/p&gt;

&lt;p&gt;Adding a short delay just before the bundle.stop() method would avoid the NPE.&lt;/p&gt;

&lt;p&gt;All this is now a corner case, but do you think it&apos;s necessary to add a protection somewhere in order to avoid the NPE ? It looks like if we add the following null check in the (already patched) DependencyManager.java, at line 1567, then we can handle such concurrent situation and avoid the NPE (see the null check on the refPair at the end of the following sample code):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void invokeBindMethodLate( &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ServiceReference&amp;lt;T&amp;gt; ref, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; trackingCount )
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( !isSatisfied() )
        {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( !isMultiple() )
        {
            Collection&amp;lt;RefPair&amp;lt;S, T&amp;gt;&amp;gt; refs = m_customizer.getRefs( &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AtomicInteger( ) );
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (refs.isEmpty())
            {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
            }
            RefPair&amp;lt;S, T&amp;gt; test = refs.iterator().next();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( ref != test.getRef())
            {
                &lt;span class=&quot;code-comment&quot;&gt;//another ref is now better
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
            }
        }
        &lt;span class=&quot;code-comment&quot;&gt;//TODO dynamic reluctant
&lt;/span&gt;        RefPair&amp;lt;S, T&amp;gt; refPair = m_tracker.getService( ref );
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (refPair == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// the tracker has been probably closed ?
&lt;/span&gt;        }
        ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(not really sure the above patch can fix the NPE in all situations ...)&lt;/p&gt;</comment>
                            <comment id="14735191" author="pderop" created="Tue, 8 Sep 2015 17:15:42 +0000"  >&lt;p&gt;David, &lt;/p&gt;

&lt;p&gt;I have an available version of the new Felix4984Test.java test for the SCR from the felix-trunk (based on maven / pax-exam).&lt;/p&gt;

&lt;p&gt;Do you want me to commit this new testcase in felix-trunk/scr/ ?&lt;/p&gt;


</comment>
                            <comment id="14735213" author="djencks" created="Tue, 8 Sep 2015 17:23:13 +0000"  >&lt;p&gt;yes, please&lt;/p&gt;</comment>
                            <comment id="14735567" author="pderop" created="Tue, 8 Sep 2015 20:39:40 +0000"  >&lt;p&gt;Just commited in revision 1701869 org.apache.felix.scr.integration.Felix4984Test.java, which seems to reproduce the issue in the felix-trunk/scr project.&lt;/p&gt;

&lt;p&gt;The problem is reproduced in DEBUG level.&lt;br/&gt;
To reproduce this issue, you can edit the pom.xml and modify the line 277, like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                    &amp;lt;includes&amp;gt;
                        &amp;lt;include&amp;gt;**/integration/Felix4984Test.java&amp;lt;/include&amp;gt;
                    &amp;lt;/includes&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;instead of &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                    &amp;lt;includes&amp;gt;
                        &amp;lt;include&amp;gt;**/integration/**&amp;lt;/include&amp;gt;
                    &amp;lt;/includes&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;then type mvn clean install &amp;gt; /tmp/log 2&amp;gt;&amp;amp;1&lt;/p&gt;

&lt;p&gt;You will normally see the test fail with a log that displays &quot;detected problem ...&quot; followed by the two following stack traces, where the A.setB(B b) method is called twice:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;log level: 2 D=22:16:51,318 T=&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[RMI TCP Connection(1)-139.54.130.12,5,RMI &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;]: detected problem ...
log level: 2 D=22:16:51,318 T=&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[RMI TCP Connection(1)-139.54.130.12,5,RMI &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;]: Stack traces when B was bound:
log level: 2 D=22:16:51,318 T=&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[RMI TCP Connection(1)-139.54.130.12,5,RMI &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;]: stack trace:
java.lang.Exception
	at org.apache.felix.scr.integration.components.felix4984.A.setB(A.java:48)
	at sun.reflect.GeneratedMethodAccessor9.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.apache.felix.scr.impl.helper.BaseMethod.invokeMethod(BaseMethod.java:222)
	at org.apache.felix.scr.impl.helper.BaseMethod.access$500(BaseMethod.java:37)
	at org.apache.felix.scr.impl.helper.BaseMethod$Resolved.invoke(BaseMethod.java:615)
	at org.apache.felix.scr.impl.helper.BaseMethod.invoke(BaseMethod.java:499)
	at org.apache.felix.scr.impl.helper.BindMethod.invoke(BindMethod.java:41)
	at org.apache.felix.scr.impl.manager.DependencyManager.doInvokeBindMethod(DependencyManager.java:1653)
	at org.apache.felix.scr.impl.manager.DependencyManager.open(DependencyManager.java:1491)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.createImplementationObject(SingleComponentManager.java:265)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.createComponent(SingleComponentManager.java:113)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.getService(SingleComponentManager.java:847)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.getServiceInternal(SingleComponentManager.java:814)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.getService(SingleComponentManager.java:763)
	at org.apache.felix.framework.ServiceRegistrationImpl.getFactoryUnchecked(ServiceRegistrationImpl.java:343)
	at org.apache.felix.framework.ServiceRegistrationImpl.getService(ServiceRegistrationImpl.java:243)
	at org.apache.felix.framework.ServiceRegistry.getService(ServiceRegistry.java:351)
	at org.apache.felix.framework.Felix.getService(Felix.java:3671)
	at org.apache.felix.framework.BundleContextImpl.getService(BundleContextImpl.java:472)
	at org.apache.felix.scr.integration.Felix4984Test.test_A11_B0n_delayed_B_first_ABoundToAtMostOneB(Felix4984Test.java:59)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:271)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:70)
	at org.ops4j.pax.exam.invoker.junit.internal.ContainerTestRunner.runChild(ContainerTestRunner.java:67)
	at org.ops4j.pax.exam.invoker.junit.internal.ContainerTestRunner.runChild(ContainerTestRunner.java:37)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:238)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:63)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:236)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:53)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:229)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:309)
	at org.junit.runner.JUnitCore.run(JUnitCore.java:160)
	at org.junit.runner.JUnitCore.run(JUnitCore.java:138)
	at org.ops4j.pax.exam.invoker.junit.internal.JUnitProbeInvoker.invokeViaJUnit(JUnitProbeInvoker.java:123)
	at org.ops4j.pax.exam.invoker.junit.internal.JUnitProbeInvoker.findAndInvoke(JUnitProbeInvoker.java:96)
	at org.ops4j.pax.exam.invoker.junit.internal.JUnitProbeInvoker.call(JUnitProbeInvoker.java:72)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.ops4j.pax.swissbox.framework.RemoteFrameworkImpl.invokeMethodOnService(RemoteFrameworkImpl.java:420)
	at org.ops4j.pax.swissbox.framework.RemoteFrameworkImpl.invokeMethodOnService(RemoteFrameworkImpl.java:393)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at sun.rmi.server.UnicastServerRef.dispatch(UnicastServerRef.java:322)
	at sun.rmi.transport.Transport$2.run(Transport.java:202)
	at sun.rmi.transport.Transport$2.run(Transport.java:199)
	at java.security.AccessController.doPrivileged(Native Method)
	at sun.rmi.transport.Transport.serviceCall(Transport.java:198)
	at sun.rmi.transport.tcp.TCPTransport.handleMessages(TCPTransport.java:567)
	at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run0(TCPTransport.java:828)
	at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.access$400(TCPTransport.java:619)
	at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler$1.run(TCPTransport.java:684)
	at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler$1.run(TCPTransport.java:681)
	at java.security.AccessController.doPrivileged(Native Method)
	at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run(TCPTransport.java:681)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

log level: 2 D=22:16:51,318 T=&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[RMI TCP Connection(1)-139.54.130.12,5,RMI &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;]: stack trace:
java.lang.Exception
	at org.apache.felix.scr.integration.components.felix4984.A.setB(A.java:48)
	at sun.reflect.GeneratedMethodAccessor9.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.apache.felix.scr.impl.helper.BaseMethod.invokeMethod(BaseMethod.java:222)
	at org.apache.felix.scr.impl.helper.BaseMethod.access$500(BaseMethod.java:37)
	at org.apache.felix.scr.impl.helper.BaseMethod$Resolved.invoke(BaseMethod.java:615)
	at org.apache.felix.scr.impl.helper.BaseMethod.invoke(BaseMethod.java:499)
	at org.apache.felix.scr.impl.helper.BindMethod.invoke(BindMethod.java:41)
	at org.apache.felix.scr.impl.manager.DependencyManager.doInvokeBindMethod(DependencyManager.java:1653)
	at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethod(DependencyManager.java:1629)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.invokeBindMethod(SingleComponentManager.java:370)
	at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethodLate(DependencyManager.java:1573)
	at org.apache.felix.scr.impl.ComponentRegistry$1.run(ComponentRegistry.java:570)
	at org.apache.felix.scr.impl.ComponentActorThread.run(ComponentActorThread.java:99)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Again, my opinion is the following:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;A.setB(B b) is first called when we dereference the A service from Felix4984Test.java, line 59 (see the first stacktrace, above).&lt;/li&gt;
	&lt;li&gt;Then A.setB(B b) is called a second time because previously, when the B service reference was dereferenced from Felix4984Test.java, line 53, then a task was internally scheduled in the ComponentActor thread, which calls invokeBindMethodLate (see the second stacktrace).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So, it looks like there is a concurrency hole in the invokeBindMethodLate method ?&lt;/p&gt;


</comment>
                            <comment id="14740972" author="djencks" created="Fri, 11 Sep 2015 15:24:41 +0000"  >&lt;p&gt;Thanks for the test case.  With my patch I could not reproduce the NPE or test failure you see, but I think your proposed NPE fix is obviously correct.  I committed my patch and your NPE fix.  Do you still see the test failure?&lt;/p&gt;

&lt;p&gt;There is still a problem if there are 2 circular references and the 2nd one prevents the component from starting now.  I&apos;m still working on a way to fix this, I think it would involve attaching all the &quot;bind late&quot; requests to the ComponentContext and only submitting them if the activation succeeds.&lt;/p&gt;</comment>
                            <comment id="14741946" author="pderop" created="Sat, 12 Sep 2015 07:19:48 +0000"  >&lt;p&gt;Ok. I don&apos;t see anymore any errors using your patch. I also checked the bndtools version in my sandbox, which is OK. thanks.&lt;/p&gt;

&lt;p&gt;But about the NPE, I wonder if there is still a problem if the service becomes unavailable immediately just right after the null check ? I mean: when we test the refPair like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-comment&quot;&gt;//TODO dynamic reluctant
&lt;/span&gt;        RefPair&amp;lt;S, T&amp;gt; refPair = m_tracker.getService( ref );
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (refPair == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// The service is no longer available, probably because the tracker has been closed
&lt;/span&gt;        }

        &lt;span class=&quot;code-comment&quot;&gt;// at &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; point, the tracker is closed or the service just becomes unavailable ...&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then, assuming that the service becomes unavailable right after the null check, the &quot; m_componentManager.invokeBindMethod( this, refPair, trackingCount );&quot; line 1580 will be invoked with an invalid refPair ? Then what will happen ?&lt;/p&gt;

&lt;p&gt;PS: I noticed a small problem in the ComponentTestBase class, which is not related to this current issue, it just concerns how &quot;ignorable warnings&quot; are handled, and there is an ArrayIndexException, which prevents some warnings to be displayed ... I will open another jira issue with a small fix about that.&lt;/p&gt;</comment>
                            <comment id="14742093" author="pderop" created="Sat, 12 Sep 2015 15:29:47 +0000"  >&lt;p&gt;David, I just created the &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5032&quot; title=&quot;IndexOutOfBoundsException in SCR ComponentTestBase class&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5032&quot;&gt;&lt;del&gt;FELIX-5032&lt;/del&gt;&lt;/a&gt; for the small issue in the ComponentTestBase that I was talking about previously.&lt;/p&gt;

&lt;p&gt;and now, with the patch attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5032&quot; title=&quot;IndexOutOfBoundsException in SCR ComponentTestBase class&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5032&quot;&gt;&lt;del&gt;FELIX-5032&lt;/del&gt;&lt;/a&gt;, I sometimes have some &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-4984&quot; title=&quot;Issues in CircularReferenceTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-4984&quot;&gt;&lt;del&gt;FELIX-4984&lt;/del&gt;&lt;/a&gt; failures, even using your patch:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.ops4j.pax.exam.invoker.junit[org.ops4j.pax.exam.invoker.junit.internal.ContainerTestRunner] : running test_A11_B0n_delayed_B_first_ABoundToAtMostOneB in reactor
log level: 1 D=17:22:28,75 T=&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[SCR Component Actor,5,main]: Unexpected problem executing task Late binding task of reference [org.apache.felix.scr.integration.components.felix4984.A] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; dependencyManagers [org.apache.felix.scr.impl.ComponentRegistry$Entry@4b48a495]
java.lang.NullPointerException
        at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethodLate(DependencyManager.java:1567)
        at org.apache.felix.scr.impl.ComponentRegistry$1.run(ComponentRegistry.java:570)
        at org.apache.felix.scr.impl.ComponentActorThread.run(ComponentActorThread.java:99)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

log level: 2 D=17:22:28,79 T=&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[FelixDispatchQueue,5,main]: FrameworkEvent: PACKAGE REFRESHED
[org.ops4j.exec.DefaultJavaRunner] : Shutdown in progress...

[org.ops4j.exec.DefaultJavaRunner] : Unwrapping stream I/O.
[org.ops4j.exec.DefaultJavaRunner] : Platform has been shutdown.
[org.ops4j.pax.exam.spi.reactors.ReactorManager] : suite finished
Tests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 5.502 sec &amp;lt;&amp;lt;&amp;lt; FAILURE!

Results :

Failed tests:   test_A11_B0n_delayed_B_first_ABoundToAtMostOneB(org.apache.felix.scr.integration.Felix4984Test): unexpected warning or error logged: Unexpected problem executing task Late binding task of reference [org.apache.felix.scr.integration.components.felix4984.A] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; dependencyManagers [org.apache.felix.scr.impl.ComponentRegistry$Entry@4b48a495]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;so, may be it&apos;s better to wait for your final patch that will submit the &quot;invoke bidn late&quot; calls only when the activation succeeds.&lt;/p&gt;
</comment>
                            <comment id="14742096" author="pderop" created="Sat, 12 Sep 2015 15:34:46 +0000"  >&lt;p&gt;I&apos;m attaching a modified version of Felix4984Test.java, which uses the patch from &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5032&quot; title=&quot;IndexOutOfBoundsException in SCR ComponentTestBase class&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5032&quot;&gt;&lt;del&gt;FELIX-5032&lt;/del&gt;&lt;/a&gt; and which defines the following ignorable warnings:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        ignoredWarnings = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] {
        		&lt;span class=&quot;code-quote&quot;&gt;&quot;Iteration #&quot;&lt;/span&gt;,
        		&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed creating the component instance; see log &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; reason&quot;&lt;/span&gt;,
        		&lt;span class=&quot;code-quote&quot;&gt;&quot;Could not get service from ref [org.apache.felix.scr.integration.components.felix4984.A]&quot;&lt;/span&gt;,
        		&lt;span class=&quot;code-quote&quot;&gt;&quot;Could not get service from ref [org.apache.felix.scr.integration.components.felix4984.B]&quot;&lt;/span&gt;,
        		&lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot create component instance due to failure to bind reference b&quot;&lt;/span&gt;,
        		&lt;span class=&quot;code-quote&quot;&gt;&quot;FrameworkEvent: ERROR&quot;&lt;/span&gt;,
        		&lt;span class=&quot;code-quote&quot;&gt;&quot;ServiceFactory.getService() resulted in a cycle&quot;&lt;/span&gt;,
        		&lt;span class=&quot;code-quote&quot;&gt;&quot;DependencyManager : invokeBindMethod : Service not available from service registry &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ServiceReference&quot;&lt;/span&gt;,
        		&lt;span class=&quot;code-quote&quot;&gt;&quot;[felix4984.A.1.1.dynamic(2)] Could not get service from ref [org.apache.felix.scr.integration.components.felix4984.B]&quot;&lt;/span&gt;
        };
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and using this version + &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5032&quot; title=&quot;IndexOutOfBoundsException in SCR ComponentTestBase class&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5032&quot;&gt;&lt;del&gt;FELIX-5032&lt;/del&gt;&lt;/a&gt; patch + your patch (already committed), then I sometimes see the NPE mentioned in the previous post:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.NullPointerException
        at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethodLate(DependencyManager.java:1567)
        at org.apache.felix.scr.impl.ComponentRegistry$1.run(ComponentRegistry.java:570)
        at org.apache.felix.scr.impl.ComponentActorThread.run(ComponentActorThread.java:99)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14966574" author="pderop" created="Wed, 21 Oct 2015 10:02:14 +0000"  >&lt;p&gt;Some updates: with debug logs, I reproduced the NPE mentioned in the previous post.&lt;br/&gt;
I&apos;m attaching the &quot;NPE_in_DependencyManager_line_279421.log.gz &quot; log file with it (see line 279421).&lt;/p&gt;</comment>
                            <comment id="15848234" author="cziegeler" created="Wed, 1 Feb 2017 11:04:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pderop&quot; class=&quot;user-hover&quot; rel=&quot;pderop&quot;&gt;pderop&lt;/a&gt; There has been no activity here for more than a year, can we assume this has been resolved?&lt;/p&gt;</comment>
                            <comment id="15885822" author="cziegeler" created="Mon, 27 Feb 2017 14:00:15 +0000"  >&lt;p&gt;assuming this is fixed, if not feel free to reopen&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12755562" name="Felix4984Test.java" size="5168" author="pderop" created="Sat, 12 Sep 2015 15:34:46 +0000"/>
                            <attachment id="12767765" name="NPE_in_DependencyManager_line_279421.log.gz" size="3058329" author="pderop" created="Wed, 21 Oct 2015 10:03:14 +0000"/>
                            <attachment id="12750096" name="felix-4984.diff" size="2815" author="djencks" created="Wed, 12 Aug 2015 15:05:44 +0000"/>
                            <attachment id="12749414" name="org.apache.felix.scr.integration.CircularReferenceTest.test_A11_B0n_delayed_B_first.log" size="200379" author="pderop" created="Sat, 8 Aug 2015 08:41:13 +0000"/>
                            <attachment id="12752244" name="org.apache.felix.scr.integration.Felix4984Test.test_A11_B0n_delayed_B_first_ABoundToAtMostOneB-NPE-with_patch.log.gz" size="455135" author="pderop" created="Tue, 25 Aug 2015 14:26:51 +0000"/>
                            <attachment id="12752243" name="org.apache.felix.scr.integration.Felix4984Test.test_A11_B0n_delayed_B_first_ABoundToAtMostOneB.log" size="517970" author="pderop" created="Tue, 25 Aug 2015 14:26:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 38 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2i4yn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>