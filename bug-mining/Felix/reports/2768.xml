<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:05:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5435] Service does not get loaded with updated properties that have been modified on file system after felix framework restart</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5435</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;In felix.scr 2.0.6, seeing an issue where a configuration for a particular Service is not loaded. &lt;/p&gt;

&lt;p&gt;We have one @Component(Componenent A) that offers one service, lets call this Service A. &lt;/p&gt;

&lt;p&gt;ComponenetA attributes are as follows: &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;(name=&quot;ServiceA&quot;, policy= ConfigurationPolicy.REQUIRE, metatype=true, immediate=true) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ServiceA has a configuration that could look like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;{
	&quot;name&quot; : &quot;ServiceA&quot;,
	&quot;description&quot; : &quot;Displays which version it has of ServiceB&quot;,
	&quot;versionRequired&quot; : &quot;1&quot;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We have a second @Component(Component B) that offers another service, lets call that Service B. &lt;/p&gt;

&lt;p&gt;The Component attributes for Component B are as follows: &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;(name:&quot;ServiceB&quot;, policy=ConfigurationPolicy.OPTIONAL, metatype=true, immediate=true).&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;(I understand with immediate=true and ConfiguraitonPolicy.OPTIONAL, Service B will be initialized without any configuration when it first gets started by the framework, however if there is configuration for it on the file system, Felix DS will reload Service B with what is on file system when it scans the directory for ServiceB configuraiton). &lt;/p&gt;

&lt;p&gt;Service B, has some properties in the configuraiton for it, that are used by ServiceA if ServiceB has been loaded with configuration. For example say we have a configuration for ServiceB that looks like this. &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;{
	&quot;name&quot; : &quot;ServiceB&quot;,
	&quot;description&quot; : &quot;is used by ServiceA&quot;
	&quot;version&quot; : &quot;1&quot;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Service A has a reference to Service B, as so:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;@Reference(policy = ReferencePolicy.DYNAMIC)
volatile ServiceB serviceB = null;

For example if we have something like this for ComponentA/ServiceA, I will keep the code short to illustrate the problem. 
	@Component(name = &quot;ServiceA&quot;,
        policy = ConfigurationPolicy.REQUIRE,
        metatype = true,
        description = &quot;ComponentA with ServiceA&quot;,
        immediate = true)
	@Service(value = {ServiceAInterface.class})
	public class ServiceA implements ServiceAInterface {

		private String version; 
		private String description; 
		private Json config = null;

		// version requested by VersionB 
		private String versionRequested;

		@Reference(policy = ReferencePolicy.DYNAMIC)
		volatile ServiceB serviceB;

		@Activate
		protected void activate(ComponentContext context) {
			this.config = getConfigFromComponentContext(context);
			this.description = config.get(&quot;description&quot;);
			this.versionRequested = config.get(&quot;versionRequested&quot;);

			// get the version that ServiceA config requests 
			serviceB.getVersionAsStringAsync(versionRequested).thenOnResult(
				this.version = versionFromServiceB; 
			);
		}

		// @Deactivate method would go here

		@override
		public String getVersion() {
			if (version != null) {
				return version;
			} else {
				return &quot;No Version has been set yet!&quot;;
			}
		}		

	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;For the scenario where this problem exists we need a configuration for both ServiceA and ServiceB. The configuration is stored on the file system in some directory that felix watches to load changes as they occur. /tmp/felixConfig/ ServiceA.json ServiceB.json.   &lt;/p&gt;

&lt;p&gt;Start up the Felix OSGi environment with the configuration and what I see is that it works as expected. ServiceA waits until it has its @Refernce to ServiceB satisfied before it attempts to activate as expected. Then if I made a call to ServiceA#getVersion(&quot;1&quot;), and ServiceB is up and running with configuration from the file that was found, ServiceA will be able to get the version. &lt;/p&gt;

&lt;p&gt;Here is where the problem is. I shutdown the OSGi Framework. Then I change the configuration to both ServiceA and ServiceB, &quot;versionRequired&quot; : &quot;2&quot; and &quot;version&quot; : &quot;2&quot;, respectively. I then start the OSGi framework back up and now ServiceA does not load correctly in the ComponentRegistry as &quot;versionRequired&quot; : &quot;2&quot;, but rather has the old version, &quot;1&quot;. I see that felix.scr picked up the changes and is attempting to notify all the ConfigurationListener(org.osgi.service.cm.ConfigurationListener) implementations. &lt;/p&gt;

&lt;p&gt;The setup I am working with picks up a change and makes a call to org.apache.felix.cm.impl.ConfigurationAdapter#update, &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	@Override 
    public void update( Dictionary&amp;lt;String, ?&amp;gt; properties ) throws IOException
    {
        delegatee.getConfigurationManager().log( LogService.LOG_DEBUG, &quot;update(properties={0})&quot;, new Object[]
            { properties } );

        checkActive();
        checkDeleted();
        delegatee.update( properties );
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;   
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;** An Important NOTE **
I set a breakpoint at `delegatee.update(properties)`. When I look here at the `configurations` inside the ConfigurationAdapter-&amp;gt;ConfigurationAdmin-&amp;gt;configurations, the configuration for ServiceA is not here! The configuration for ServiceB is in that list of configurations. IF I look at a previous version of felix.scr, 2.0.2, I see ServiceA in that list of configurations..it no longer is there, in version 2.0.4,2.0.6, and trunk and this will result in the problem because the revision number will not be updated.
**      **
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;    

&lt;p&gt;These properties are the new properties for ServiceA, that has the the versionRequested attribute in the ServiceA object updated to versionRequest = 2, because I changed it on the file system when the system was down and on startup of the framework it pick up those changes on the file system and is attempting to propagate this configuration to all necessary services that require it. &lt;/p&gt;

&lt;p&gt;Digging deeper in the call to delegatee.update( properties), is implemented in org.apache.felix.cm.impl#update(Dictionary&amp;lt;String, ?&amp;gt; properties) as so, &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  * @see org.osgi.service.cm.Configuration#update(java.util.Dictionary)
     */
    public void update( Dictionary&amp;lt;String, ?&amp;gt; properties ) throws IOException
    {
        PersistenceManager localPersistenceManager = getPersistenceManager();
        if ( localPersistenceManager != null )
        {
            CaseInsensitiveDictionary newProperties = new CaseInsensitiveDictionary( properties );

            getConfigurationManager().log( LogService.LOG_DEBUG, &quot;Updating config {0} with {1}&quot;, new Object[]
                { getPidString(), newProperties } );

            setAutoProperties( newProperties, true );

            // persist new configuration
            localPersistenceManager.store( getPidString(), newProperties );

            // finally assign the configuration for use
            configure( newProperties );

            // if this is a factory configuration, update the factory with
            // do this only after configuring with current properties such
            // that a concurrently registered ManagedServiceFactory service
            // does not receive a new/unusable configuration
            updateFactory();

            // update the service and fire an CM_UPDATED event
            getConfigurationManager().updated( this, true );
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The intresting thing here is that the reference now to &apos;this&apos; ConfigurationImpl seen on the code above `getConfigurationManager().updated( this, true );`&lt;br/&gt;
has the new revision, and properties of the ConfigurationImpl, but later on when we dig deeper in the call to getConfigurationManager().updated( this, true ); &lt;br/&gt;
we will see that we cannot find the ConfigurationImpl(with the UPDATED revision and properties) in the list of Configurations of the ConfirurationAdmin.&lt;/p&gt;

&lt;p&gt;Following the getConfigurationManager().updated( this, true ); code brings us to where the ConfigurationManager perpares the eventTread and the UpdateThread as so:&lt;/p&gt;

&lt;p&gt;org.apache.felix.cm.impl.ConfigurationManager&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	void updated( ConfigurationImpl config, boolean fireEvent )
    {
        if ( fireEvent )
        {
            fireConfigurationEvent( ConfigurationEvent.CM_UPDATED, config.getPidString(), config.getFactoryPidString() );
        }
        updateThread.schedule( new UpdateConfiguration( config ) ); // this will occur with the correct revision...
        log( LogService.LOG_DEBUG, &quot;UpdateConfiguration({0}) scheduled&quot;, new Object[]
            { config.getPid() } );
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;One very important thing to note here is that the `ConfigurationImpl config` passed into this updated(config, fireEvent) method has the correct `revision` and `properties`. &lt;br/&gt;
That ConfigurationImpl is not passed into the `fireConfigurationEvent`, but we later look it up in the ConfigAdmin...which we will see that it is not there, and this is what I believe to be the root of the problem.&lt;/p&gt;

&lt;p&gt;Before we get to the updateThread.schedule(), lets go ahead into the fireConfiguraitonEvent() which creates a new FireConfigurationEvent object for both asyncSender and for &lt;br/&gt;
syncSender, I did not have any syncSender so that could be ignored. This new object gets scheduled in the `eventThread`. This thread will then loop through each ConfigurationListener&lt;br/&gt;
and passes the ConfiguraitonEvent that it had created letting them know about the changed. &lt;/p&gt;

&lt;p&gt;Using from the sample I wrote above, ComponentA and all its properties are part of this ConfigurationEvent. The listener that is having problems actually doing anything with the ConfigurationEvent is the &lt;/p&gt;

&lt;p&gt;org.apache.felix.scr.impl.manager.RegionConfigurationSupport#configurationEvent(ConfigurationEvent event) &lt;/p&gt;

&lt;p&gt;when we look at the code inside the implementation of that we see this line that is returning &lt;br/&gt;
a ConfigurationInfo that has a revision that is revision=1, and the properties are the updatedProperties&lt;/p&gt;
{version=2,etc.} instead of returning revision=2,updatedProperties{version=2,etc.}

&lt;p&gt;around like 259&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;final ConfigurationInfo configInfo = getConfigurationInfo( pid, targetedPid, // This IS where the config returns the wrong revision
                                componentHolder, bundleContext );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If we dig deeper to understand why the ConfigurationInfo comes back with the correct updated properties but without updating the revision to 2 we will inside &lt;/p&gt;

&lt;p&gt;org.apache.felix.scr.impl.manager.RegionConfigurationSupport#getConfigurationInfo(final TargetedPID pid, TargetedPID targetedPid, ComponentHolder&amp;lt;?&amp;gt; componentHolder, final BundleContext bundleContext)&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    try
        {//final ServiceReference caRef = bundleContext.getServiceReference(ComponentRegistry.CONFIGURATION_ADMIN);
            final ConfigurationAdmin ca = getConfigAdmin( bundleContext );
            try  // this looks interesting, could be getting the wrong config admin? ?
            {
                Configuration[] configs = ca.listConfigurations( filter( pid.getRawPid() ) ); &amp;lt;----- this ca.listConfigurations() is the problem, like I mentioned earlier in the ** NOTE **
                if ( configs != null &amp;amp;&amp;amp; configs.length &amp;gt; 0 )
                {
                    Configuration config = configs[0];
                    return new ConfigurationInfo( config.getProperties(), config.getBundleLocation(), 
                        config.getChangeCount() );
                }
                ... the rest of the implementation
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The problem I am seeing is the the `ConfigurationAdmin ca` does not have the configuration in its cachedConfigs&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;     // the cache of Configuration instances mapped by their PID
    // have this always set to prevent NPE on bundle shutdown
    private final HashMap&amp;lt;String, ConfigurationImpl&amp;gt; configurations = new HashMap&amp;lt;String, ConfigurationImpl&amp;gt;();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;when it makese the call to ca.listConfigurations..&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; 				// ensure the service.pid and returned a cached config if available
                ConfigurationImpl cfg = getCachedConfiguration( pid ); &amp;lt;----- this returns null
                if ( cfg == null )
                {
                    cfg = new ConfigurationImpl( this, pmList[i], config ); 
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;it returns no configuraiton from the cache, so then we return a new ConfigurationImpl which configures a NEW implementation of `ConfigurationImpl` from what we stored in the PersistanceManager above&lt;br/&gt;
at org.apache.felix.cm.impl#update(Dictionary&amp;lt;String, ?&amp;gt; properties), but the revision, because it&apos;s a NEW object, is set to 1. and when this goes back up the stack and gets to &lt;/p&gt;

&lt;p&gt;org.apache.felix.scr.impl.manager.ConfigurableComponentHolder#configurationUpdated()&lt;/p&gt;

&lt;p&gt;The logical statement inside,&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                if (oldChangeCount != null &amp;amp;&amp;amp; changeCount &amp;lt;= oldChangeCount &amp;amp;&amp;amp; factoryPid.equals(oldTargetedPID)) {
                	return false;
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;is TRUE so the code immediately returns false and the Component(ComponentA) is not reconfigured with the new properties. &lt;/p&gt;

&lt;p&gt;This DOES NOT happen on version felix.scr 2.0.2, but tracing through that code I see a lot of code that has been refactored. The RegionConfigurationSupport has taken over what was the ConfigurationSupport. The revision changeCount has been refactored, and the CA has usage has also been refactored. &lt;/p&gt;

&lt;p&gt;It is broken in both 2.0.4, and 2.0.6. &lt;/p&gt;

&lt;p&gt;I did a manual bisect until I was able to narrow it down, here is a snapshot of when the behavior was introduced: &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
------------------------------------------------------------------------
r1747831 | djencks | 2016-06-10 18:14:36 -0700 (Fri, 10 Jun 2016) | 1 line   &amp;lt;------------- TEST HERE [   BROKEN  ]

FELIX-5270 Don&apos;t set bundle location on configurations 
------------------------------------------------------------------------
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;This only started occuring after the first commit to &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;FELIX-5270&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here a larger snapshot of the actual bisect steps I took: &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;FELIX-5270 log when bundle locations are inconsistent
------------------------------------------------------------------------
r1749929 | djencks | 2016-06-23 08:57:30 -0700 (Thu, 23 Jun 2016) | 1 line   &amp;lt;------------- TEST HERE [   BROKEN  ] AT THIS REVISION 

FELIX-5248 missing license header
------------------------------------------------------------------------
r1749927 | cziegeler | 2016-06-23 08:48:00 -0700 (Thu, 23 Jun 2016) | 1 line

Revert rev 1749869
------------------------------------------------------------------------
r1749869 | cziegeler | 2016-06-23 04:45:33 -0700 (Thu, 23 Jun 2016) | 1 line 

add missing license header
------------------------------------------------------------------------
r1748287 | djencks | 2016-06-13 10:14:22 -0700 (Mon, 13 Jun 2016) | 1 line  

FELIX-5248 test for complaint
------------------------------------------------------------------------
r1747831 | djencks | 2016-06-10 18:14:36 -0700 (Fri, 10 Jun 2016) | 1 line   &amp;lt;------------- TEST HERE [   BROKEN  ] WINNER!!!

FELIX-5270 Don&apos;t set bundle location on configurations 						
------------------------------------------------------------------------
r1747329 | djencks | 2016-06-07 17:14:12 -0700 (Tue, 07 Jun 2016) | 1 line   &amp;lt;------------- TEST HERE [ WORKS ]

FELIX-5276 track service event before changing service properties
------------------------------------------------------------------------
r1746618 | djencks | 2016-06-02 12:36:26 -0700 (Thu, 02 Jun 2016) | 1 line    &amp;lt;------------- TEST HERE [   WORKS   ]

FELIX-4417 Improve logging of circular references.  Fix some problems introduced with rev 1744827 when activate changes service properties.
------------------------------------------------------------------------
r1746617 | djencks | 2016-06-02 12:36:22 -0700 (Thu, 02 Jun 2016) | 1 line    

FELIX-5264 Introduce a single State enum and use an atomic to track it, and use some optimistic locking on state changes.  This fixes the specific issue found and should provide much easier diagnosis of any remaining or new problems.
------------------------------------------------------------------------
r1746471 | gnodet | 2016-06-01 07:36:32 -0700 (Wed, 01 Jun 2016) | 1 line &amp;lt;-------- TEST HERE [ WORKS ]

[FELIX-5243] Make ComponentContextImpl#setImplementationAccessible public, similar to setImplementationObject
------------------------------------------------------------------------
r1746470 | gnodet | 2016-06-01 07:20:03 -0700 (Wed, 01 Jun 2016) | 1 line

[FELIX-5243] Remove anonymous inner class, add a unit test to ensure package consistency
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>Java 1.7; Using Felix framework version 5.4.0. </environment>
        <key id="13024601">FELIX-5435</key>
            <summary>Service does not get loaded with updated properties that have been modified on file system after felix framework restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cziegeler">Carsten Ziegeler</assignee>
                                    <reporter username="alinbrici">Alin Brici</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 Nov 2016 22:45:48 +0000</created>
                <updated>Thu, 2 Feb 2017 10:07:36 +0000</updated>
                            <resolved>Wed, 28 Dec 2016 07:14:00 +0000</resolved>
                                    <version>configadmin-1.8.0</version>
                    <version>configadmin-1.8.8</version>
                    <version>configadmin-1.8.12</version>
                                    <fixVersion>configadmin-1.8.14</fixVersion>
                                    <component>Configuration Admin</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15710095" author="alinbrici" created="Wed, 30 Nov 2016 22:47:35 +0000"  >&lt;p&gt;After the initial commit for &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5270&quot; title=&quot;[DS] Config race between update and delete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5270&quot;&gt;&lt;del&gt;FELIX-5270&lt;/del&gt;&lt;/a&gt;, I am seeing this new behavior. &lt;/p&gt;</comment>
                            <comment id="15735933" author="djencks" created="Fri, 9 Dec 2016 18:10:03 +0000"  >&lt;p&gt;My initial impression from your analysis is that this is a configuration admin bug rather than a scr bug?  Isn&apos;t the problem  that ca is returning a change count of 1 rather than 2?&lt;/p&gt;</comment>
                            <comment id="15766142" author="alinbrici" created="Wed, 21 Dec 2016 05:06:17 +0000"  >&lt;p&gt;I followed your advice about looking at the configuration admin. After more investigating I found that if I add this patch to RegionConfigurationSupport.java, I am using 2.0.6 branch,  &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Index: src/main/java/org/apache/felix/scr/impl/manager/RegionConfigurationSupport.java
===================================================================
--- src/main/java/org/apache/felix/scr/impl/manager/RegionConfigurationSupport.java (revision 1771992)
+++ src/main/java/org/apache/felix/scr/impl/manager/RegionConfigurationSupport.java (working copy)
@@ -139,6 +139,7 @@
                             logger.log( LogService.LOG_DEBUG,
                                 &quot;Configuring holder {0} with factory configuration {1}, change count {2}&quot;,
                                 new Object[] { holder, config, config.getChangeCount() }, null );
+                            config = getConfiguration(ca, config.getPid());
                             if ( checkBundleLocation( config, bundleContext.getBundle() ) )
                             {
                                 long changeCount = config.getChangeCount();
@@ -157,6 +158,7 @@
                         Configuration singleton = findSingletonConfiguration( ca, confPid, bundleContext.getBundle() );
                         if ( singleton != null )
                         {
+                            singleton = getConfiguration(ca, singleton.getPid());
                             logger.log( LogService.LOG_DEBUG,
                                 &quot;Configuring holder {0} with configuration {1}, change count {2}&quot;,
                                 new Object[] { holder, singleton, singleton.getChangeCount() }, null );
@@ -194,6 +196,20 @@
         return false;
     }
 
+    private Configuration getConfiguration(final ConfigurationAdmin ca, final String pid)
+    {
+        try
+        {
+            return ca.getConfiguration(pid);
+        }
+        catch (IOException ioe)
+        {
+            logger.log(LogService.LOG_WARNING, &quot;Failed reading configuration for pid={0}&quot;, new Object[] {pid}, ioe);
+        }
+
+        return null;
+    }
+
     // ---------- ConfigurationListener
 
     /**

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It works as I would expect and I no longer see the problem. The current unit test also still pass. &lt;/p&gt;

&lt;p&gt;I am trying to understand why you removed the call to getConfiguration(ConfigurationAdmin ca, String PID), from my analysis, I do see that inside the implementation of the interface &apos;ConfigurationAdmin&apos;, the method itself,&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; public Configuration getConfiguration( String pid ) throws IOException
    {
        final ConfigurationManager configurationManager = getConfigurationManager();

        configurationManager.log( LogService.LOG_DEBUG, &quot;getConfiguration(pid={0})&quot;, new Object[]
            { pid } );

        ConfigurationImpl config = configurationManager.getConfiguration( pid );
        if ( config == null )
        {
            config = configurationManager.createConfiguration( pid, null );

            // FELIX-3360: configuration creation with implicit binding is dynamic
            config.setDynamicBundleLocation( getBundle().getLocation(), false );
        }
        else
        {
            if ( config.getBundleLocation() == null )
            {
                configurationManager.log( LogService.LOG_DEBUG, &quot;Binding configuration {0} (isNew: {1}) to bundle {2}&quot;,
                    new Object[]
                        { config.getPid(), config.isNew() ? Boolean.TRUE : Boolean.FALSE,
                            this.getBundle().getLocation() } );

                // FELIX-3360: first implicit binding is dynamic
                config.setDynamicBundleLocation( getBundle().getLocation(), true );
            }
            else
            {
                // CM 1.4 / 104.13.2.3
                this.checkPermission( configurationManager, config.getBundleLocation(), false );
            }
        }

        return this.wrap( config );
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;is actually making a call to the ConfigurationImpl object, &apos;config.setDynamicBundleLocation()` and this in turn triggers a &apos;ConfigurationEvent.CM_LOCATION_CHANGED&apos; event which is what &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5270&quot; title=&quot;[DS] Config race between update and delete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5270&quot;&gt;&lt;del&gt;FELIX-5270&lt;/del&gt;&lt;/a&gt; is trying to avoid. However the call to getConfiguration(ConfigurationAdmin ca, String PID) was also creating the configuration and putting it in the &apos;configurations&apos; list that is an object within the ConfigurationManager&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; config = configurationManager.createConfiguration( pid, null );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;going into that .createConfiguration(pid, null)&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ConfigurationImpl createConfiguration( String pid, String bundleLocation ) throws IOException
    {
        // check for existing (cached or persistent) configuration
        ConfigurationImpl config = getConfiguration( pid );
        if ( config != null )
        {
            return config;
        }

        // else create new configuration also setting the bundle location
        // and cache the new configuration
        config = createConfiguration( pid, null, bundleLocation );
        return cacheConfiguration( config );
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It is being added in cacheConfiguration(config)..&lt;/p&gt;


&lt;p&gt;From the my initial inquery, I raised the issue that when I looked at the &apos;configurations&apos; inside of ConfigurationManager the configuration for my particular service was not there. &lt;/p&gt;

&lt;p&gt;I also believe that the call to &apos;getConfiguration(ConfigurationAdmin ca, String PID)&apos; was removed because the &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        final Collection&amp;lt;Configuration&amp;gt; factory = findFactoryConfigurations( ca, confPid,bundleContext.getBundle() );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;is supposed to find the configuration that we need, so it seemed redundant to have to call &apos;getConfiguration(ConfigurationAdmin ca, String PID)&apos; again, however I don&apos;t see the call to `findFactoryConfigurations(ca, confPid,bundleContext.getBundle())` adding the configuration if/when it gets created, if it is not found in the &apos;configurations&apos; object inside the ConfigurationManager.&lt;/p&gt;


&lt;p&gt;`findFactoryConfigurations(ca, confPid,bundleContext.getBundle())` if we trace it down makes a call to &lt;/p&gt;

&lt;p&gt;&apos;ConfigurationManager#listConfigurations(ConfigurationAdminImpl configurationAdmin, String filterString)&apos;&lt;/p&gt;

&lt;p&gt;inside that method there is this block&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                // ensure the service.pid and returned a cached config if available
                ConfigurationImpl cfg = getCachedConfiguration( pid );
                if ( cfg == null )
                {
                    cfg = new ConfigurationImpl( this, pmList[i], config );
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Should this &apos;cfg = new ConfigurationImpl( this, pmList[ i ] , config ) ; &apos; be inserted in the `configurations` cache? It looks for it in the line above in the `configuraitons` (ConfigurationImpl cfg = getCachedConfiguration( pid ) ; ) and just creates a new one if it&apos;s not there and it looks like it is never chached. &lt;/p&gt;

&lt;p&gt;Please let me know your thoughts. Thanks in advance.&lt;/p&gt;</comment>
                            <comment id="15766480" author="djencks" created="Wed, 21 Dec 2016 08:36:48 +0000"  >&lt;p&gt;I still don&apos;t understand why you think this is a ds problem rather than a ca problem.  Could you explain without code snippets?&lt;/p&gt;

&lt;p&gt;DS doesn&apos;t  persist any information it gets from ca.  Therefore if, on restart, you see &quot;old&quot; configuration data, it must have come from ca, presumably with change count 1.  If ca then notices your changed file, I presume through fileinstall telling it that the configuration is now different, then ca should notify ds that there&apos;s a change, and the change count should be different, presumably 2. As far as I know ds deals correctly with  this sequence of events from ca.  Do you see this sequence of events?  If not, I think there&apos;s a problem with ca.&lt;/p&gt;</comment>
                            <comment id="15767092" author="alinbrici" created="Wed, 21 Dec 2016 13:50:21 +0000"  >&lt;p&gt;I am not saying that this is a direct problem with DS, I am saying the DS used to rely on a different method in ca that would store the configuration in the list of &apos;configurations&apos; inside the ConfigurationManager and now with the removal of this line &apos;config = getConfiguration(ca, config.getPid());` from rev r1747831, it doesn&apos;t. The sequence of events happens correctly, what is happening is the ConfigurationManager is now NOT storing the &apos;configuration&apos; in it&apos;s HashMap of &apos;configurations&apos; and later when DS needs to look up the service in the &apos;configurations&apos;, because it detected a change, it is not in the &apos;configurations&apos; HashMap, so it treats it as a completely new config even thought it already dealt with it on fileinstall, but because it is not longer in the &apos;configurations&apos; map due to that line being removed a new ConfigurationImpl is created and given a revision of 1. What should happen is we should be retrieving that ConfigurationImpl that we should have put in the list of &apos;configurations&apos; on file install and swap out the properties and increment the revision to 2. I will attempt to build out a sample use case to demonstrate this behavior. Can you please explain why config = getConfiguration(ca, config.getPid()); was taken out in from rev r1747831 just so my understanding is clear?  &lt;/p&gt;</comment>
                            <comment id="15767644" author="djencks" created="Wed, 21 Dec 2016 17:39:42 +0000"  >&lt;p&gt;I thought it was explained pretty clearly in &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5270&quot; title=&quot;[DS] Config race between update and delete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5270&quot;&gt;&lt;del&gt;FELIX-5270&lt;/del&gt;&lt;/a&gt;, but here&apos;s a simplified version.&lt;/p&gt;

&lt;p&gt;1. management agent creates configuration with properties.&lt;/p&gt;

&lt;p&gt;2. DS detects receives configuration event.&lt;/p&gt;

&lt;p&gt;3. management agent deletes configuration.&lt;/p&gt;

&lt;p&gt;4. DS calls getConfiguration, creating a new configuration with null properties.&lt;/p&gt;

&lt;p&gt;At this point, DS can&apos;t notice that the properties are null and delete the configuration it just accidentally created, because&lt;/p&gt;

&lt;p&gt;5. management agent sets properties on the configuration&lt;/p&gt;

&lt;p&gt;6 DS deletes the configuration....oops&lt;/p&gt;

&lt;p&gt;There are (at least theoretically) two possible strategies for writing a DS implementation&apos;s configuration-awareness: ManagedService + ManagedServiceFactory or configuration events.  Use of the MS+MSF strategy will result in CA setting the bundle location (if missing) for any configuration consumed by DS.  As seen above, use of the ConfigurationEvent strategy requires DS to not ever try to set the bundle location.  Therefore the expert group decided, in order to allow both these strategies, to not take a position on whether DS consuming a configuration should result in the bundle location being set (if missing).  Personally I don&apos;t know how to write a MS+MSF based strategy and think it would be horribly inefficient.&lt;/p&gt;</comment>
                            <comment id="15768596" author="alinbrici" created="Thu, 22 Dec 2016 00:40:04 +0000"  >&lt;p&gt;Thanks for clarifying. My main point that I am trying to make about that removal of that line, is that it no longer executes this block of code(if you follow that line to this block) which is causing the behavior I am seeing in my usecase:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ConfigurationImpl getConfiguration( String pid ) throws IOException
    {
        ConfigurationImpl config = getCachedConfiguration( pid );
        if ( config != null )
        {
            log( LogService.LOG_DEBUG, &quot;Found cached configuration {0} bound to {1}&quot;, new Object[]
                { pid, config.getBundleLocation() } );

            config.ensureFactoryConfigPersisted();

            return config;
        }

        PersistenceManager[] pmList = getPersistenceManagers();
        for ( int i = 0; i &amp;lt; pmList.length; i++ )
        {
            if ( pmList[i].exists( pid ) )
            {
                Dictionary props = pmList[i].load( pid );
                config = new ConfigurationImpl( this, pmList[i], props );
                log( LogService.LOG_DEBUG, &quot;Found existing configuration {0} bound to {1}&quot;, new Object[]
                    { pid, config.getBundleLocation() } );
                return cacheConfiguration( config ); &amp;lt;-----------modification of the ConfigurationManager#configurations 
            }
        }

        // neither the cache nor any persistence manager has configuration
        return null;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;follow that cacheConfiguration(config) to: &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ConfigurationImpl cacheConfiguration( ConfigurationImpl configuration )
    {
        synchronized ( configurations )
        {
            final String pid = configuration.getPidString();
            final Object existing = configurations.get( pid );
            if ( existing != null )
            {
                return ( ConfigurationImpl ) existing;
            }

            configurations.put( pid, configuration ); &amp;lt;--------- this is where we add the configuration to the HashMap
            return configuration;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;As you can see, we are actually modifying the ConfigurationManager, on the line cacheConfiguration() that will load the configuration from the pm into the &apos;configurations&apos; HashMap that is part of the ConfigurationManager. &lt;/p&gt;

&lt;p&gt;If you follow the code for this line &apos;findFactoryConfigurations( ca, confPid, bundleContext.getBundle() );&apos; which is what is attempting to find the configuration, you will see that if it is not found it will create a new ConfigurationImpl but it will not update the ConfigurationManager#configurations with that configuration. &lt;/p&gt;

&lt;p&gt;Are you saying that cacheConfiguration(config) is no longer necessary? Should ConfigurationAdmin not rely on &apos;configurations&apos; within the ConfigurationManager but instead only use what is in the the persistence manager? I am not saying that the bug is necessarily in DS at this point, all I am saying is that the RegionConfigurationSupport.java, in DS, relied on a piece of code executed in CA that is no longer executed and causes the issue i described above. &lt;/p&gt;</comment>
                            <comment id="15768632" author="djencks" created="Thu, 22 Dec 2016 00:54:51 +0000"  >&lt;p&gt;I don&apos;t know much about the internals of the felix config admin implementation, I&apos;ve never used it.  If you have evidence that Felix CA supplies a configuration with one set of properties and change count 1, and later supplies the configuration with different properties and change count 1, that is a bug in config admin.  I can&apos;t really tell what actual data you have on what config admin does from your code snippets.  Please concentrate on describing the externally visible behavior of config admin to establish whether or not there is a problem.&lt;/p&gt;</comment>
                            <comment id="15773228" author="alinbrici" created="Fri, 23 Dec 2016 16:33:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djencks&quot; class=&quot;user-hover&quot; rel=&quot;djencks&quot;&gt;djencks&lt;/a&gt;, I have made the modification in CA that would fix this issue. I add the configuration to the cache after it is not found in the cache because this is the behavior DS is depending on. This is the same behavior that getConfigurations() does. I believe this is the correct behavior, I also fixed the unit tests in there to reflect this change. &lt;/p&gt;

&lt;p&gt;I have read &lt;a href=&quot;http://felix.apache.org/documentation/community/contributing-source-code.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://felix.apache.org/documentation/community/contributing-source-code.html&lt;/a&gt; and I am not a Felix committer yet, so I have attached the diff, it&apos;s also below. I would love to be on the review or create the review myself if I missed the instructions on how to go about that. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: ../org.apache.felix.configadmin-1.8.12/src/test/java/org/apache/felix/cm/impl/ConfigurationManagerTest.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&amp;lt;+&amp;gt;UTF-8
===================================================================
--- ../org.apache.felix.configadmin-1.8.12/src/test/java/org/apache/felix/cm/impl/ConfigurationManagerTest.java	(revision 1770905)
+++ ../org.apache.felix.configadmin-1.8.12/src/test/java/org/apache/felix/cm/impl/ConfigurationManagerTest.java	(revision )
@@ -95,12 +95,6 @@
         assertEquals(1, conf.length);
         assertEquals(2, conf[0].getProperties(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;).size());
         
-        Field configurations = configMgr.getClass().getDeclaredField( &lt;span class=&quot;code-quote&quot;&gt;&quot;configurations&quot;&lt;/span&gt; );
-        configurations.setAccessible( &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; );
-        HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, ConfigurationImpl&amp;gt; configurationsMap = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, ConfigurationImpl&amp;gt;();
-        configurationsMap.put(pid, conf[0]);
-        configurations.set(configMgr, configurationsMap);
-        
         dictionary = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Hashtable();
         dictionary.put( &lt;span class=&quot;code-quote&quot;&gt;&quot;property1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;value2&quot;&lt;/span&gt; );
         pid = &lt;span class=&quot;code-quote&quot;&gt;&quot;testDefaultPersistenceManager&quot;&lt;/span&gt;;
@@ -110,6 +104,9 @@
         conf = configMgr.listConfigurations(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConfigurationAdminImpl(configMgr, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
         assertEquals(1, conf.length);
         assertEquals(2, conf[0].getProperties(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;).size());
+
+        &lt;span class=&quot;code-comment&quot;&gt;// verify that the property in the configurations cache was used
&lt;/span&gt;+        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;value1&quot;&lt;/span&gt;, conf[0].getProperties(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;).get(&lt;span class=&quot;code-quote&quot;&gt;&quot;property1&quot;&lt;/span&gt;));
     }    
     
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void test_listConfigurations_notcached() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
@@ -135,20 +132,18 @@
         assertEquals(1, conf.length);
         assertEquals(2, conf[0].getProperties(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;).size());
         
-        Field configurations = configMgr.getClass().getDeclaredField( &lt;span class=&quot;code-quote&quot;&gt;&quot;configurations&quot;&lt;/span&gt; );
-        configurations.setAccessible( &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; );
-        HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, ConfigurationImpl&amp;gt; configurationsMap = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, ConfigurationImpl&amp;gt;();
-        configurationsMap.put(pid, conf[0]);
-        configurations.set(configMgr, configurationsMap);
-        
         dictionary = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Hashtable();
+        dictionary.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;property1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;valueNotCached&quot;&lt;/span&gt;);
         pid = &lt;span class=&quot;code-quote&quot;&gt;&quot;testDefaultPersistenceManager&quot;&lt;/span&gt;;
         dictionary.put( Constants.SERVICE_PID, pid );
         pm.store( pid, dictionary );
  
         conf = configMgr.listConfigurations(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConfigurationAdminImpl(configMgr, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
         assertEquals(1, conf.length);
-        assertEquals(1, conf[0].getProperties(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;).size());
+        assertEquals(2, conf[0].getProperties(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;).size());
+
+        &lt;span class=&quot;code-comment&quot;&gt;// verify that the value returned was not the one from the cache
&lt;/span&gt;+        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;valueNotCached&quot;&lt;/span&gt;, conf[0].getProperties(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;).get(&lt;span class=&quot;code-quote&quot;&gt;&quot;property1&quot;&lt;/span&gt;));
     }
 
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testLogNoLogService()
Index: ../org.apache.felix.configadmin-1.8.12/src/main/java/org/apache/felix/cm/impl/ConfigurationManager.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&amp;lt;+&amp;gt;UTF-8
===================================================================
--- ../org.apache.felix.configadmin-1.8.12/src/main/java/org/apache/felix/cm/impl/ConfigurationManager.java	(revision 1770905)
+++ ../org.apache.felix.configadmin-1.8.12/src/main/java/org/apache/felix/cm/impl/ConfigurationManager.java	(revision )
@@ -683,14 +683,16 @@
                 }
 
                 &lt;span class=&quot;code-comment&quot;&gt;// ensure the service.pid and returned a cached config &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; available
&lt;/span&gt;-                ConfigurationImpl cfg = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
-                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (! (pmList[i].isNotCachablePersistenceManager())) 
-                {
+                ConfigurationImpl cfg;
+                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(pmList[i].isNotCachablePersistenceManager())) {
                     cfg = getCachedConfiguration( pid );
+                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cfg == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+                        cfg = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConfigurationImpl(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, pmList[i], config);
+                        &lt;span class=&quot;code-comment&quot;&gt;// add the to configurations cache &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it wasn&apos;t in the cache
&lt;/span&gt;+                        cacheConfiguration(cfg);
-                }
+                    }
-                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( cfg == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; )
-                {
+                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
-                    cfg = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConfigurationImpl( &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, pmList[i], config );
+                    cfg = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConfigurationImpl(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, pmList[i], config);
                 }
 
                 &lt;span class=&quot;code-comment&quot;&gt;// FELIX-611: Ignore configuration objects without props
&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt; could please take a look at this patch and let me know your thoughts on this as well. Thanks in advance! &lt;/p&gt;</comment>
                            <comment id="15782267" author="cziegeler" created="Wed, 28 Dec 2016 07:14:01 +0000"  >&lt;p&gt;Thanks for your patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alinbrici&quot; class=&quot;user-hover&quot; rel=&quot;alinbrici&quot;&gt;alinbrici&lt;/a&gt;&lt;br/&gt;
It looks good to me and I&apos;ve applied it to our code base&lt;/p&gt;</comment>
                            <comment id="15843342" author="alinbrici" created="Fri, 27 Jan 2017 19:10:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt; Do you know when a release will be cut for 1.8.14? &lt;/p&gt;

&lt;p&gt;Edit: When will it be available in a public repo? &lt;/p&gt;</comment>
                            <comment id="15849746" author="cziegeler" created="Thu, 2 Feb 2017 10:07:36 +0000"  >&lt;p&gt;Release vote is throug, it should be in a public repo in some hours from now. If you have further questions pleas use the mailing list instead&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12974396">FELIX-5270</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12844585" name="FELIX_5435.patch" size="4389" author="alinbrici" created="Fri, 23 Dec 2016 16:34:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 41 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i36zrb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>