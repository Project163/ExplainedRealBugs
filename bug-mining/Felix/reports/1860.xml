<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:48:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3907] NullPointerException in BundleWiringImpl when m_disposed is true.</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3907</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;NullPointerException caused by lines 1472-1474 of &lt;tt&gt;org.apache.felix.framework.BundleWiringImpl&lt;/tt&gt; when &lt;tt&gt;this.m_disposed == true&lt;/tt&gt;. I don&apos;t know why &lt;tt&gt;this.m_disposed&lt;/tt&gt; is true, but I&apos;m guessing it&apos;s some sort of race condition. Stack trace follows:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;(  Thread-5) [DEBUG] ntegration.NeratiDeployer java.lang.NullPointerException: null
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at org.apache.felix.framework.BundleWiringImpl.findClassOrResourceByDelegation(BundleWiringImpl.java:1472) ~[felix.jar:na]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at org.apache.felix.framework.BundleWiringImpl.access$400(BundleWiringImpl.java:75) ~[felix.jar:na]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at org.apache.felix.framework.BundleWiringImpl$BundleClassLoader.loadClass(BundleWiringImpl.java:1923) ~[felix.jar:na]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at java.lang.ClassLoader.loadClass(ClassLoader.java:247) ~[na:1.6.0_37]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at java.lang.Class.getDeclaredFields0(Native Method) ~[na:1.6.0_37]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at java.lang.Class.privateGetDeclaredFields(Class.java:2291) ~[na:1.6.0_37]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at java.lang.Class.getDeclaredField(Class.java:1880) ~[na:1.6.0_37]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at com.nerati.agent.events.RuntimeRecording.getClassId(RuntimeRecording.java:156) ~[agent-main-0.0.5-SNAPSHOT.jar:0.0.5-SNAPSHOT]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at com.nerati.agent.events.RuntimeRecording.writeAsJson(RuntimeRecording.java:118) ~[agent-main-0.0.5-SNAPSHOT.jar:0.0.5-SNAPSHOT]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at com.nerati.agent.client.ControllerClient.processRequest(ControllerClient.java:160) ~[agent-main-0.0.5-SNAPSHOT.jar:0.0.5-SNAPSHOT]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at com.nerati.agent.client.ControllerClient.putData(ControllerClient.java:131) ~[agent-main-0.0.5-SNAPSHOT.jar:0.0.5-SNAPSHOT]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at com.nerati.agent.client.ControllerManager.putData(ControllerManager.java:177) ~[agent-main-0.0.5-SNAPSHOT.jar:0.0.5-SNAPSHOT]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at com.nerati.agent.client.ControllerSendTask.run(ControllerSendTask.java:119) ~[agent-main-0.0.5-SNAPSHOT.jar:0.0.5-SNAPSHOT]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:439) [na:1.6.0_37]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317) [na:1.6.0_37]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150) [na:1.6.0_37]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98) [na:1.6.0_37]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:180) [na:1.6.0_37]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:204) [na:1.6.0_37]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886) [na:1.6.0_37]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908) [na:1.6.0_37]
(  Thread-5) [DEBUG] ntegration.NeratiDeployer  at java.lang.Thread.run(Thread.java:662) [na:1.6.0_37]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>Windows</environment>
        <key id="12632926">FELIX-3907</key>
            <summary>NullPointerException in BundleWiringImpl when m_disposed is true.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="jnaous">Jad Naous</reporter>
                        <labels>
                    </labels>
                <created>Tue, 19 Feb 2013 02:58:54 +0000</created>
                <updated>Sun, 10 Mar 2013 14:14:47 +0000</updated>
                            <resolved>Tue, 5 Mar 2013 21:19:53 +0000</resolved>
                                    <version>framework-4.2.0</version>
                                    <fixVersion>framework-4.2.1</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13589575" author="rickhall" created="Thu, 28 Feb 2013 14:47:23 +0000"  >&lt;p&gt;Yes, I think this is essentially a race condition, but I think it is a valid race condition. We really don&apos;t hold any locks while class loading, so it is possible for threads to be trying to class load while other threads are performing lifecycle operations on the bundle. If someone refreshed your bundle while you were trying to load a class from it, this could cause it to be disposed, which means it no longer has a class loader. While the NPE isn&apos;t pretty in this case, the only other thing we could do here is check for null and throw a different exception (e.g., CNFE).&lt;/p&gt;</comment>
                            <comment id="13589747" author="jnaous" created="Thu, 28 Feb 2013 18:18:45 +0000"  >&lt;p&gt;Unfortunately, I think a CNFE can be just as (if not more) confusing. If I&apos;m holding a reference to a class, how can the class suddenly become not found? Shouldn&apos;t the classloader disappear or become inaccessible only when we are certain that no other thread will access the class again (i.e. no thread has a reference to the class and ultimately the classloader)?&lt;/p&gt;</comment>
                            <comment id="13589751" author="rickhall" created="Thu, 28 Feb 2013 18:25:01 +0000"  >&lt;p&gt;Even if we allowed the class loader to remain accessible, this just leads to other errors. For example, if you invoke a method on a held instance that causes it to try to load another class from the bundle (one that hasn&apos;t been loaded yet), then it will fail with some sort of zip file not open exception (it may have even already been deleted).&lt;/p&gt;

&lt;p&gt;In other words, once you are in this state everything is really fragile. If you have threads that are still trying to do stuff, this is generally a sign that someone is either a) not stopping threads when they should (i.e., when their creating bundle is stopped) or b) not releasing objects obtained from stale bundles.&lt;/p&gt;

&lt;p&gt;You cannot expect class loading to continue normally for a refreshed bundle.&lt;/p&gt;</comment>
                            <comment id="13589768" author="jnaous" created="Thu, 28 Feb 2013 18:34:07 +0000"  >&lt;p&gt;I see. Would it be difficult to make it such that things continue to operate normally for loaded classes, but if a thread tries to do anything for a new class, then we get a CNFE? I agree this is kind of weird, and something bad is happening. I&apos;m just thinking about what can be done to minimize diversion from what is expected to happen with normal classloaders...&lt;/p&gt;</comment>
                            <comment id="13589801" author="rickhall" created="Thu, 28 Feb 2013 18:53:50 +0000"  >&lt;p&gt;We could create an internal method that continues to return the class loader in this case, but this is really just trying to address the symptoms rather than the cause. The fact that you have threads still running and expecting proper behavior from classes on a refreshed (possibly uninstalled) bundle is a major bug you need to resolve.&lt;/p&gt;

&lt;p&gt;Regarding throwing a &quot;good&quot; exception, I&apos;ve looked into trying to throw a &quot;good&quot; exception in these situations and it turned out to be more difficult than it sounds, which is why we still don&apos;t do it.&lt;/p&gt;
</comment>
                            <comment id="13589833" author="jnaous" created="Thu, 28 Feb 2013 19:26:33 +0000"  >&lt;p&gt;Agreed, we should not hold onto to classes and we know exactly where the issue in our application is arising from. I am not actually thinking about my application, but just in general. Wouldn&apos;t we want the behavior to match what happens in a non-osgi environment as much as possible? I maybe unclear here on what OSGI requires, but shouldn&apos;t all resources related to a classloader (e.g the jar file, which I assume throws the zip exception) and the related object graph remain available, but just unused to instantiate new classes from other bundles until all references to the old classloader are GC&apos;ed and only then do we make other related resources disappear (such as closing jars, deleting files, etc)?&lt;/p&gt;

&lt;p&gt;Re &quot;good&quot; exception, maybe there should be a check for m_disposed at the beginning of every method call in BundleClassLoader that throws an exception (maybe ClassLoaderNoLongerAvailableException or BundleInaccessibleException) if m_disposed is true? Or is that what you say is difficult?&lt;/p&gt;</comment>
                            <comment id="13589880" author="rickhall" created="Thu, 28 Feb 2013 20:06:33 +0000"  >&lt;p&gt;The degree of &quot;closeness&quot; just depends on the particular scenario. If a thread has already loaded all classes it will ever need, it may never notice that a refreshed bundle is gone. On the other hand, a thread that still has plenty of class loads it needs to do will immediately run into &quot;differences&quot;. There is a complete spectrum of possibilities and we can&apos;t do anything to paper over what happens when a thread stumbles into the situation.&lt;/p&gt;

&lt;p&gt;Regarding what the spec requires, let&apos;s be clear, we are talking about a situation where the bundle has been refreshed, not simply in some potential limbo state like after an update or uninstall. The whole point of &quot;refreshing&quot; is that this is when the framework let&apos;s go of everything that is currently in a limbo state. So, in short, no it won&apos;t nor can it keep stuff around (e.g., if you uninstall and refresh a bundle, it is gone, period).&lt;/p&gt;

&lt;p&gt;Regarding a &quot;good&quot; exception, the issue really is that there are race conditions all over the place since we don&apos;t hold any locks, plus there are abstractions in place that hide knowledge we need. So, it is just difficult. Granted, we&apos;ve refactored a bit since I last looked into this, so perhaps it would be possible to simply check the disposed status before trying to get any new bytes for a given class loader and simply fail at that point with a CNFE.&lt;/p&gt;

&lt;p&gt;That&apos;d be about the best we could do, perhaps. And again, to be clear, this would not eliminate weird exceptions since there is a race condition of checking the disposed state and someone else disposing of the bundle. Perhaps it makes them less likely, though.&lt;/p&gt;</comment>
                            <comment id="13589884" author="jnaous" created="Thu, 28 Feb 2013 20:10:40 +0000"  >&lt;p&gt;Thanks for the clarifications!&lt;/p&gt;</comment>
                            <comment id="13593925" author="rickhall" created="Tue, 5 Mar 2013 21:19:53 +0000"  >&lt;p&gt;Ok, I committed a patch that will allow misbehaving threads to continue to issue class loads on disposed class loaders for existing classes; however, if they try to load a class from it that hasn&apos;t already been loaded, they will get a CNFE. Not sure how much help (or if any) this will be, but it is probably the best we can do without a major effort. Please close if satisfied. Thanks.&lt;/p&gt;</comment>
                            <comment id="13594029" author="jnaous" created="Tue, 5 Mar 2013 22:33:00 +0000"  >&lt;p&gt;Looks good. Just a few comments from looking at the change.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;There might be a time-of-check-to-time-of-use bug between getClassLoader() and getClassLoaderInternal(). You probably want to check if m_disposed == true again in getClassLoaderInternal() and return null if so.&lt;/li&gt;
	&lt;li&gt;Another reason for the check: the internal code is using getClassLoaderInternal, which doesn&apos;t seem to return null if m_disposed is true (actually, I don&apos;t know what will be stored in m_classloader if m_disposed is true at that point). Don&apos;t we want to check inside that internal call for m_disposed = true again and return false?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="13594121" author="rickhall" created="Wed, 6 Mar 2013 00:00:11 +0000"  >&lt;p&gt;There is another check of m_disposed inside of getClassLoaderInternal()...&lt;/p&gt;

&lt;p&gt;The getClassLoader() method is spec and is supposed to return null if the wiring is disposed. That&apos;s what was causing the NPE for you. The whole point of this patch is to introduce an internal method that will return a non-null class loader if one exists, that&apos;s what getClassLoaderInternal() does. The only time it still returns null is if the class loader hasn&apos;t been created yet and the wiring is already disposed, which I believe can happen since we defer bundle class loader creation until someone actually loads a class from a bundle.&lt;/p&gt;

&lt;p&gt;But, in general, getClassLoaderInternal() should always return non-null and getClassLoader() will return non-null if the wiring hasn&apos;t been disposed. The wiring internals now use getClassLoaderInternal() so that classes can continue to be loaded, even after disposal of the wiring. Of course, this only applies to classes that the class loader has already loaded, any attempts to load new bytes will result in a hopefully more meaningful exception message.&lt;/p&gt;</comment>
                            <comment id="13594991" author="jnaous" created="Wed, 6 Mar 2013 19:10:45 +0000"  >&lt;p&gt;ok, but the tocttou bug remains in getClassLoader(). If m_disposed is false, m_disposed should be checked again in a synchronized block before calling getClassLoaderInternal() so that it returns null. Otherwise, right after the first unsynched check, and before calling getClassLoaderInternal(), another thread may cause m_disposed to become true, at which point we would be returning the classloader instead of null.&lt;/p&gt;</comment>
                            <comment id="13596681" author="rickhall" created="Fri, 8 Mar 2013 01:42:47 +0000"  >&lt;p&gt;Technically, you are correct, but that race condition is no different than if we serialize and a second thread disposes of the bundle wiring just after a first thread exits getClassLoaderInternal() but before it returns to the first caller. There is no way to differentiate between the two cases, so in effect it doesn&apos;t make a difference.&lt;/p&gt;</comment>
                            <comment id="13596744" author="jnaous" created="Fri, 8 Mar 2013 02:59:32 +0000"  >&lt;p&gt;I see. Thanks.&lt;/p&gt;</comment>
                            <comment id="13598176" author="ceefour" created="Sun, 10 Mar 2013 06:46:10 +0000"  >&lt;p&gt;does the fix display the requested class to be loaded? This will help resolution of #&lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3477&quot; title=&quot;NPE in BundleWiringImpl.searchImports&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3477&quot;&gt;FELIX-3477&lt;/a&gt;, #&lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3763&quot; title=&quot;Add exception context information for java.lang.NullPointerException at org.apache.felix.framework.BundleWiringImpl.findClassOrResourceByDelegation(BundleWiringImpl.java:1432)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3763&quot;&gt;FELIX-3763&lt;/a&gt; and #&lt;a href=&quot;https://issues.apache.org/jira/browse/ARIES-951&quot; title=&quot;NullPointerException at felix.framework.BundleWiringImpl.findClassOrResourceByDelegation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ARIES-951&quot;&gt;ARIES-951&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13598257" author="rickhall" created="Sun, 10 Mar 2013 14:14:47 +0000"  >&lt;p&gt;If you look at the patch associated with this issue, you can see the exception looks like this:&lt;/p&gt;

&lt;p&gt;1996                    throw new ClassNotFoundException(&lt;br/&gt;
1997	                    &quot;Unable to load class &apos;&quot;&lt;br/&gt;
1998	                    + name&lt;br/&gt;
1999	                    + &quot;&apos; because the bundle wiring for &quot;&lt;br/&gt;
2000	                    + m_wiring.m_revision.getSymbolicName()&lt;br/&gt;
2001	                    + &quot; is no longer valid.&quot;);&lt;br/&gt;
2002	 &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12552215">FELIX-3477</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12613861">ARIES-951</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12616409">FELIX-3763</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>313422</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 37 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1i34v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>313767</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>