<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:07:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-721] NPE in FilterImpl.toString()</title>
                <link>https://issues.apache.org/jira/browse/FELIX-721</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;We see this NPE occasionally, probably 10% of the time on application startup:&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; java.lang.NullPointerException&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.felix.framework.util.ldap.Parser$AndOperator.toStringInfix(Parser.java:601)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.felix.framework.util.ldap.Evaluator.toStringInfix(Evaluator.java:184)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.felix.framework.FilterImpl.toString(FilterImpl.java:242)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at java.lang.String.valueOf(String.java:2615)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at java.lang.StringBuffer.append(StringBuffer.java:220)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.springframework.osgi.service.importer.DefaultOsgiServiceDependency.&amp;lt;init&amp;gt;(DefaultOsgiServiceDependency.java:52)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.springframework.osgi.extender.internal.dependencies.startup.MandatoryImporterDependencyFactory.getServiceDependencies(MandatoryImporterDependencyFactory.java:69)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.springframework.osgi.extender.internal.dependencies.startup.DependencyServiceManager.findServiceDependencies(DependencyServiceManager.java:233)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.springframework.osgi.extender.internal.dependencies.startup.DependencyWaiterApplicationContextExecutor.stageOne(DependencyWaiterApplicationContextExecutor.java:248)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.springframework.osgi.extender.internal.dependencies.startup.DependencyWaiterApplicationContextExecutor.refresh(DependencyWaiterApplicationContextExecutor.java:172)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.springframework.osgi.context.support.AbstractDelegatedExecutionApplicationContext.refresh(AbstractDelegatedExecutionApplicationContext.java:136)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.springframework.osgi.extender.internal.activator.ContextLoaderListener$2.run(ContextLoaderListener.java:746)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at java.lang.Thread.run(Thread.java:613)&lt;/p&gt;

&lt;p&gt;My first guess would be we are constructing a filter improperly in our Spring config, but the fact that it only happens some of the time is strange.  If nothing else, it would be nice if this bit of code was a bit more defensive.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12404217">FELIX-721</key>
            <summary>NPE in FilterImpl.toString()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="karlpauls">Karl Pauls</assignee>
                                    <reporter username="mrdon">Donald J. Brown</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Sep 2008 03:03:18 +0000</created>
                <updated>Tue, 14 Oct 2008 05:34:25 +0000</updated>
                            <resolved>Fri, 12 Sep 2008 15:31:05 +0000</resolved>
                                    <version>framework-1.0.4</version>
                                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12630501" author="karlpauls" created="Fri, 12 Sep 2008 07:16:26 +0000"  >&lt;p&gt;Do you think it is possible to get me the filter that fails?&lt;/p&gt;</comment>
                            <comment id="12630502" author="mcculls" created="Fri, 12 Sep 2008 07:23:45 +0000"  >&lt;p&gt;Another option (if it is truly random) would be to locally build the FilterImpl with additional instrumentation to capture the original string used to build the filter - then when it failed with the NPE you could dump the string along with various other fields from the filter object...&lt;/p&gt;</comment>
                            <comment id="12630506" author="mcculls" created="Fri, 12 Sep 2008 07:43:00 +0000"  >&lt;p&gt;Actually I think I&apos;ve figured out the bug...&lt;/p&gt;

&lt;p&gt;org.apache.felix.framework.util.ldap.Operator has a public member field:&lt;/p&gt;

&lt;p&gt;    // Place to store the reconstructed parsetree&lt;br/&gt;
    // Vector -&amp;gt; ArrayList is using jdk1.2 or later&lt;br/&gt;
    public Operator[] children = null;&lt;/p&gt;

&lt;p&gt;and this member field gets re-assigned when the parsetree is rebuilt&lt;br/&gt;
(see the buildTree method in various Operator sub-classes in Parser)&lt;/p&gt;

&lt;p&gt;ok, now if you look at the toStringInfix method of the Evaluator class, it&lt;br/&gt;
goes through the operators in the current program and calls each one&lt;br/&gt;
to rebuild the complete parsetree.&lt;/p&gt;

&lt;p&gt;the toStringInfix method is in turn called from FilterImpl&apos;s toString:&lt;/p&gt;

&lt;p&gt;    public String toString()&lt;br/&gt;
    {&lt;br/&gt;
        if (m_toString == null)&lt;/p&gt;
        {
            m_toString = new Evaluator(m_program).toStringInfix();
        }
&lt;p&gt;        return m_toString;&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;where m_toString is a volatile field - the idea I think is to cache the&lt;br/&gt;
result. However, because there&apos;s no synchronization on this field&lt;br/&gt;
it&apos;s possible that two or more threads could be calling toStringInfix&lt;br/&gt;
at the same time.&lt;/p&gt;

&lt;p&gt;now each thread has its own Evaluator - but they are sharing the&lt;br/&gt;
same program, which means that the &quot;children&quot; member that has&lt;br/&gt;
the reconstructed parsetree could get reset by one thread while&lt;br/&gt;
it&apos;s being used by another thread - hence the NPE (null element)&lt;/p&gt;

&lt;p&gt;phew... hope that makes some sense&lt;/p&gt;</comment>
                            <comment id="12630509" author="mcculls" created="Fri, 12 Sep 2008 07:54:06 +0000"  >&lt;p&gt;simplest fix would be to make FilterImpl.toString() synchronized, but this would&lt;br/&gt;
affect performance in all cases, even when the result has already been cached.&lt;/p&gt;

&lt;p&gt;otherwise the Operator.children field somehow needs to be made thread-local&lt;/p&gt;</comment>
                            <comment id="12630512" author="karlpauls" created="Fri, 12 Sep 2008 08:02:20 +0000"  >&lt;p&gt;Hi Stuart,&lt;/p&gt;

&lt;p&gt;yes, this makes sense. It seems to be the children member. Would it be enough to make buildTree look like this:&lt;/p&gt;

&lt;p&gt;public void buildTree(Stack operands)&lt;br/&gt;
        {&lt;br/&gt;
            Operator[] tmp = new Operator&lt;span class=&quot;error&quot;&gt;&amp;#91;operandCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
            // need to preserve stack order&lt;br/&gt;
            for (int i = 0; i &amp;lt; operandCount; i++)&lt;/p&gt;
            {
                tmp[(operandCount - 1) - i] =
                    (Operator) operands.pop();
            }
&lt;p&gt;            children = tmp;&lt;br/&gt;
            operands.push(this);&lt;br/&gt;
        }&lt;/p&gt;

&lt;p&gt;this way we don&apos;t need sync and are optimistic (i.e., it might be that we do some work twice but we assume thats cheaper then to always sync). &lt;/p&gt;</comment>
                            <comment id="12630513" author="mcculls" created="Fri, 12 Sep 2008 08:08:05 +0000"  >&lt;p&gt;yes, that should work (need to update all the Operator sub-classes)&lt;br/&gt;
and we should probably also mark the children member as volatile.&lt;/p&gt;</comment>
                            <comment id="12630514" author="karlpauls" created="Fri, 12 Sep 2008 08:15:45 +0000"  >&lt;p&gt;o.k., I can do this today. &lt;/p&gt;</comment>
                            <comment id="12630523" author="karlpauls" created="Fri, 12 Sep 2008 08:47:25 +0000"  >&lt;p&gt;This patch should fix the issue by making the children member volatile and assign it optimistic. &lt;/p&gt;

&lt;p&gt;Let me know what you think. &lt;/p&gt;
</comment>
                            <comment id="12630565" author="rickhall" created="Fri, 12 Sep 2008 13:19:38 +0000"  >&lt;p&gt;Seems reasonable to me.&lt;/p&gt;</comment>
                            <comment id="12630574" author="mcculls" created="Fri, 12 Sep 2008 14:28:25 +0000"  >&lt;p&gt;+1, patch looks good to me.&lt;/p&gt;</comment>
                            <comment id="12630593" author="karlpauls" created="Fri, 12 Sep 2008 15:31:05 +0000"  >&lt;p&gt;Fixed in trunk as of revision 694713. Please close this issue if it works for you.&lt;/p&gt;</comment>
                            <comment id="12631657" author="mrdon" created="Wed, 17 Sep 2008 05:47:40 +0000"  >&lt;p&gt;Thanks for fixing it so quickly.  Any chance this could be ported into the 1.0.x branch for a 1.0.5 release?  I&apos;d like to avoid a private fork, if I can help it.&lt;/p&gt;</comment>
                            <comment id="12631944" author="karlpauls" created="Wed, 17 Sep 2008 20:57:36 +0000"  >&lt;p&gt;Could it be a 1.2.2 release as well? He have a couple of resolved issues since 1.2.1 already... I&apos;d prefer to not do a 1.0.5 unless it is absolutely needed...&lt;/p&gt;</comment>
                            <comment id="12632045" author="mrdon" created="Thu, 18 Sep 2008 01:20:50 +0000"  >&lt;p&gt;Well, I&apos;ll probably have to create an internal vendor branch anyway, as I need the fix for a release today.  Getting a 1.2.2 out in the next week or so would certainly be appreciated.&lt;/p&gt;</comment>
                            <comment id="12639297" author="mrdon" created="Tue, 14 Oct 2008 04:24:18 +0000"  >&lt;p&gt;I&apos;m still getting this exception: &lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.felix.framework.util.ldap.Parser$AndOperator.toStringInfix(Parser.java:601)&lt;br/&gt;
	at org.apache.felix.framework.util.ldap.Parser$AndOperator.toStringInfix(Parser.java:601)&lt;br/&gt;
	at org.apache.felix.framework.util.ldap.Evaluator.toStringInfix(Evaluator.java:184)&lt;br/&gt;
	at org.apache.felix.framework.FilterImpl.toString(FilterImpl.java:242)&lt;br/&gt;
	at java.lang.String.valueOf(String.java:2615)&lt;br/&gt;
	at java.lang.StringBuffer.append(StringBuffer.java:220)&lt;br/&gt;
	at org.springframework.osgi.service.importer.DefaultOsgiServiceDependency.&amp;lt;init&amp;gt;(DefaultOsgiServiceDependency.java:52)&lt;/p&gt;

&lt;p&gt;Any ideas?&lt;/p&gt;</comment>
                            <comment id="12639306" author="mcculls" created="Tue, 14 Oct 2008 05:05:57 +0000"  >&lt;p&gt;Which version of Felix are you using - 1.2.1 or trunk?&lt;/p&gt;

&lt;p&gt;That particular stack trace doesn&apos;t make sense if you&apos;re using trunk because line 601 is appending a string constant to the passed in buffer, which must be non-null according to the code path. I would have expected to see line 605 in trunk, as this line makes the recursive call to toStringInfix shown in the stack trace. But looking at the 1.2.1 sources, line 601 does make sense, so I guess you&apos;re using 1.2.1 - which also correlates because 1.2.1 doesn&apos;t contain the parser fix.&lt;/p&gt;

&lt;p&gt;So in short, the problem is fixed in trunk but is not yet available in a release.&lt;/p&gt;</comment>
                            <comment id="12639310" author="mrdon" created="Tue, 14 Oct 2008 05:34:25 +0000"  >&lt;p&gt;Nevermind, the issue was on my side - I didn&apos;t realize the main jar included all the framework classes, and I had backported the fix to the framework jar.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12389995" name="ldap.patch" size="5978" author="karlpauls" created="Fri, 12 Sep 2008 08:47:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>58268</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 7 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0vukv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>183927</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>