<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:09:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-993] Reference target filters not handled correctly</title>
                <link>https://issues.apache.org/jira/browse/FELIX-993</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;The SCR implementation does not handle references with target filter correctly. When the properties of a bound service is modified so that the service no longer matches the reference filter it isn&apos;t unbound as it should.&lt;/p&gt;

&lt;p&gt;Suppose we have an event broadcaster component defined by:&lt;/p&gt;

&lt;p&gt;	&amp;lt;component name=&quot;EventBroadcaster&quot;&amp;gt;&lt;br/&gt;
		&amp;lt;implementation class=&quot;example.EventBroadcaster&quot; /&amp;gt;&lt;br/&gt;
		&amp;lt;reference &lt;br/&gt;
			name=&quot;eventListeners&quot; &lt;br/&gt;
			interface=&quot;example.EventListener&quot;&lt;br/&gt;
			cardinality=&quot;0..n&quot;&lt;br/&gt;
			policy=&quot;dynamic&quot;&lt;br/&gt;
			bind=&quot;addListener&quot;&lt;br/&gt;
			unbind=&quot;removeListener&quot; &lt;br/&gt;
			target=&quot;(listener.state=Active)&quot; &lt;br/&gt;
		/&amp;gt;&lt;br/&gt;
	&amp;lt;/component&amp;gt;&lt;/p&gt;

&lt;p&gt;If an event listener is registered by the code&lt;/p&gt;

&lt;p&gt;	Dictionary&amp;lt;String, Object&amp;gt; props = new Hashtable&amp;lt;String, Object&amp;gt;();&lt;br/&gt;
	props.put(&quot;listener.state&quot;, &quot;Active&quot;);&lt;br/&gt;
	ServiceRegistration reg = context.registerService(EventListener.class.getName(), new EventListener(), props);&lt;/p&gt;

&lt;p&gt;the new service will be bound to our event broadcaster and the addListener method will be called. This is as it should be. Now, suppose we changed the properties of the service by executing&lt;/p&gt;

&lt;p&gt;	Dictionary&amp;lt;String, Object&amp;gt; props2 = new Hashtable&amp;lt;String, Object&amp;gt;();&lt;br/&gt;
	props2.put(&quot;listener.state&quot;, &quot;Inactive&quot;);&lt;br/&gt;
	reg.setProperties(props2);&lt;/p&gt;

&lt;p&gt;At this point, the event listener service should be unbound from the event broadcaster component since it does no longer match the target filter. However, due to a bug in org.apache.felix.scr.impl.DependencyManager, this the service stays bound and isn&apos;t even unbound if&lt;/p&gt;

&lt;p&gt;	reg.unregister();&lt;/p&gt;

&lt;p&gt;is executed.&lt;/p&gt;

&lt;p&gt;The problem is, basically, caused by the following two segments of code:&lt;/p&gt;

&lt;p&gt;	public void serviceChanged( ServiceEvent event )&lt;br/&gt;
	{&lt;br/&gt;
		switch ( event.getType() )&lt;/p&gt;
		{
			case ServiceEvent.REGISTERED:
				serviceAdded( event.getServiceReference() );
				break;

			case ServiceEvent.MODIFIED:
				serviceRemoved( event.getServiceReference() );
				serviceAdded( event.getServiceReference() );
				break;

			case ServiceEvent.UNREGISTERING:
				serviceRemoved( event.getServiceReference() );
				break;
		}
&lt;p&gt;	}&lt;/p&gt;

&lt;p&gt;and&lt;/p&gt;

&lt;p&gt;	private void serviceRemoved( ServiceReference reference )&lt;br/&gt;
	{&lt;br/&gt;
		// ignore the service, if it does not match the target filter&lt;br/&gt;
		if ( !targetFilterMatch( reference ) )&lt;/p&gt;
		{
			[...]
			return;
		}

&lt;p&gt;		&lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;br/&gt;
	}&lt;/p&gt;

&lt;p&gt;Since the properties of the service has already been modified when serviceChanged is called, the filter will no longer match the service and serviceRemoved will ignore it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12417291">FELIX-993</key>
            <summary>Reference target filters not handled correctly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fmeschbe">Felix Meschberger</assignee>
                                    <reporter username="sorenp">Soren Petersen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Mar 2009 16:01:26 +0000</created>
                <updated>Wed, 29 Apr 2009 08:12:44 +0000</updated>
                            <resolved>Wed, 29 Apr 2009 08:12:44 +0000</resolved>
                                    <version>scr-1.0.6</version>
                                    <fixVersion>scr-1.0.8</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12683521" author="sorenp" created="Thu, 19 Mar 2009 17:04:28 +0000"  >&lt;p&gt;I&apos;ve made a shot at resolving this issue. It might not live up to several of the project coding standards, but it seems to solve my problem for now.&lt;/p&gt;

&lt;p&gt;The idea is basically to keep track of the services that matched the target filter when it was fed to the serviceAdd(ServiceReference) method. Then, when serviceRemove(ServiceReference) is called, instead of checking whether the service matches the filter now, we check if the service matched the filter when added.&lt;/p&gt;

&lt;p&gt;Hope this helps.&lt;/p&gt;</comment>
                            <comment id="12695387" author="sorenp" created="Fri, 3 Apr 2009 13:43:30 +0000"  >&lt;p&gt;The first patch was a classroom example on how things can go wrong when you try to solve a problem without understanding the context in which the problem  appears...&lt;/p&gt;

&lt;p&gt;I&apos;ve made another attempt.&lt;/p&gt;

&lt;p&gt;Regards,&lt;/p&gt;

&lt;p&gt;Soren&lt;/p&gt;</comment>
                            <comment id="12700766" author="fmeschbe" created="Mon, 20 Apr 2009 11:24:04 +0000"  >&lt;p&gt;Thanks for reporting the issue and providing a patch.&lt;/p&gt;

&lt;p&gt;In Rev. 766654 I have just removed the test for the target filter: You remark correctly, that the target filter match might return a false negative. But since the check for whether the service is actually bound/used or not takes place anyway (next check after decrementing the counter), your replacement check is not actually required.&lt;/p&gt;

&lt;p&gt;Please close this issue, if this works for you. Thanks.&lt;/p&gt;</comment>
                            <comment id="12703036" author="fmeschbe" created="Mon, 27 Apr 2009 09:19:05 +0000"  >&lt;p&gt;The fix applied creates a regression with another test where services need to be replaced without the service properties being changed. See &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-1053&quot; title=&quot;SCR: Bound Service Replacement regression ?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-1053&quot;&gt;&lt;del&gt;FELIX-1053&lt;/del&gt;&lt;/a&gt; for details.&lt;/p&gt;

&lt;p&gt;Reopening for applying a new fix&lt;/p&gt;</comment>
                            <comment id="12703049" author="fmeschbe" created="Mon, 27 Apr 2009 09:48:39 +0000"  >&lt;p&gt;Committed a fix in Rev. 768910. See comment &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; in &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-1053&quot; title=&quot;SCR: Bound Service Replacement regression ?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-1053&quot;&gt;&lt;del&gt;FELIX-1053&lt;/del&gt;&lt;/a&gt; for details.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-1053?focusedCommentId=12703047&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12703047&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FELIX-1053?focusedCommentId=12703047&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12703047&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12704032" author="fmeschbe" created="Wed, 29 Apr 2009 08:12:44 +0000"  >&lt;p&gt;WIth the modifications applied as per &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-1053&quot; title=&quot;SCR: Bound Service Replacement regression ?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-1053&quot;&gt;&lt;del&gt;FELIX-1053&lt;/del&gt;&lt;/a&gt;, this issue should also be fixed by now.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12404544" name="DependencyManager.patch" size="724" author="sorenp" created="Fri, 3 Apr 2009 13:43:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>57997</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 31 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0vztr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>184777</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>