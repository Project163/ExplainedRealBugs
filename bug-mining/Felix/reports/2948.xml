<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:11:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5769] SCR should not bind prototype_required reference to bundle scope service</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5769</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;I have a consumer component that refers to a service using prototype_required service scope:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Component
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ConsumerComponent {
    @Reference(scope = ReferenceScope.PROTOTYPE_REQUIRED)
    &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; runnable;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And another component that provides the correct service type BUT uses bundle scope:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Component(scope = ServiceScope.BUNDLE)
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ProviderComponent &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; {
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;According to the OSGi R6 Compendium spec, section 112.3.5, the reference should not bind to the service because &quot;for a bound service of a reference with prototype required reference scope, only services registered with prototype service scope can be considered as target services ... A service that does not use prototype service scope cannot be used as a bound service for a reference with prototype required reference scope since the service cannot provide a distinct service object for each component instance&quot;.&lt;/p&gt;

&lt;p&gt;However in SCR 2.0.14, the consumer component is in fact bound to the service as shown below.&lt;/p&gt;

&lt;p&gt;I have used factory config to create three instances of the consumer component. All three are satisfied and active:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; [   7]   com.effectiveosgi.ConsumerComponent  enabled
    [   5] [active      ] com.effectiveosgi.ConsumerComponent.f89094ca-85d6-4f22-ae73-198e6977ba8e (com.effectiveosgi.ConsumerComponent )
    [   6] [active      ] com.effectiveosgi.ConsumerComponent.e2cb08d0-4b4d-48c8-b6cc-248bc1bfdc92 (com.effectiveosgi.ConsumerComponent )
    [   7] [active      ] com.effectiveosgi.ConsumerComponent.9b7e9c7e-be11-442e-b9c7-2c6e9ea70544 (com.effectiveosgi.ConsumerComponent )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The scr:info command shows that all three component instances are bound to the same service, and that is is bundle scope:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;g! scr:info com.effectiveosgi.ConsumerComponent
*** Bundle: example (7)
Component Description:
  Name: com.effectiveosgi.ConsumerComponent
  Implementation Class: com.effectiveosgi.ConsumerComponent
  Default State: enabled
  Activation: immediate
  Configuration Policy: optional
  Activate Method: activate
  Deactivate Method: deactivate
  Modified Method: -
  Configuration Pid: [com.effectiveosgi.ConsumerComponent]
  Reference: runnable
    Interface Name: java.lang.Runnable
    Cardinality: 1..1
    Policy: static
    Policy option: reluctant
    Reference Scope: prototype_required
  Component Description Properties:
  Component Configuration:
    ComponentId: 5
    State: active      
    SatisfiedReference: runnable
      Target: null
      Bound to:        35
      Reference Properties:
          component.id = 8
          component.name = com.effectiveosgi.ProviderComponent
          objectClass = [java.lang.Runnable]
          service.bundleid = 7
          service.id = 35
          service.scope = bundle
    Component Configuration Properties:
        _com.effectiveosgi.rt.config.filePath = /Users/neil.bartlett/Projects/eosgi-runtime/_assembly/load/http-config.yaml
        _com.effectiveosgi.rt.config.identity = tertiary
        component.id = 5
        component.name = com.effectiveosgi.ConsumerComponent
        org.osgi.service.http.port = 8081
        service.factoryPid = com.effectiveosgi.ConsumerComponent
        service.pid = com.effectiveosgi.ConsumerComponent.f89094ca-85d6-4f22-ae73-198e6977ba8e
  Component Configuration:
    ComponentId: 6
    State: active      
    SatisfiedReference: runnable
      Target: null
      Bound to:        35
      Reference Properties:
          component.id = 8
          component.name = com.effectiveosgi.ProviderComponent
          objectClass = [java.lang.Runnable]
          service.bundleid = 7
          service.id = 35
          service.scope = bundle
    Component Configuration Properties:
        _com.effectiveosgi.rt.config.filePath = /Users/neil.bartlett/Projects/eosgi-runtime/_assembly/load/http-config.yaml
        _com.effectiveosgi.rt.config.identity = secondary
        component.id = 6
        component.name = com.effectiveosgi.ConsumerComponent
        org.osgi.service.http.port = 8081
        service.factoryPid = com.effectiveosgi.ConsumerComponent
        service.pid = com.effectiveosgi.ConsumerComponent.e2cb08d0-4b4d-48c8-b6cc-248bc1bfdc92
  Component Configuration:
    ComponentId: 7
    State: active      
    SatisfiedReference: runnable
      Target: null
      Bound to:        35
      Reference Properties:
          component.id = 8
          component.name = com.effectiveosgi.ProviderComponent
          objectClass = [java.lang.Runnable]
          service.bundleid = 7
          service.id = 35
          service.scope = bundle
    Component Configuration Properties:
        _com.effectiveosgi.rt.config.filePath = /Users/neil.bartlett/Projects/eosgi-runtime/_assembly/load/http-config.yaml
        _com.effectiveosgi.rt.config.identity = primary
        component.id = 7
        component.name = com.effectiveosgi.ConsumerComponent
        org.osgi.service.http.port = 8080
        service.factoryPid = com.effectiveosgi.ConsumerComponent
        service.pid = com.effectiveosgi.ConsumerComponent.9b7e9c7e-be11-442e-b9c7-2c6e9ea70544
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13129267">FELIX-5769</key>
            <summary>SCR should not bind prototype_required reference to bundle scope service</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cziegeler">Carsten Ziegeler</assignee>
                                    <reporter username="nbartlett">Neil Bartlett</reporter>
                        <labels>
                    </labels>
                <created>Mon, 8 Jan 2018 15:11:27 +0000</created>
                <updated>Mon, 30 Apr 2018 08:13:50 +0000</updated>
                            <resolved>Tue, 9 Jan 2018 10:47:03 +0000</resolved>
                                    <version>scr-2.0.14</version>
                                    <fixVersion>scr-2.1.0</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16318027" author="nbartlett" created="Tue, 9 Jan 2018 08:34:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt; asked me to turn on SCR debug logging. Log attached. NB this is the output of the `log debug` command so is in reverse chronological order.&lt;/p&gt;</comment>
                            <comment id="16318156" author="cziegeler" created="Tue, 9 Jan 2018 09:51:57 +0000"  >&lt;p&gt;The SCR service tracker (which is a modified version of the framework service tracker) is using three filters: one to do the initial query against the service registry, one to add a service listeners and finally a filter to filter the events send to that listener.&lt;br/&gt;
The initial filter is an and combination of the listener filter and the event filter. The listener filter uses only the service interface for filtering while the event filter is used to filter based on a provided target and the prototype required option.&lt;br/&gt;
It seems, right now this event filter is not calculated correctly and only works if a target is provided in addition. If no target is provided, it&apos;s always empty&lt;/p&gt;</comment>
                            <comment id="16318162" author="nbartlett" created="Tue, 9 Jan 2018 09:56:03 +0000"  >&lt;p&gt;Confirmed: SCR works correctly according to the spec IF the reference has a target attribute.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2018.01.09 09:27:29 DEBUG - Bundle: example - [com.effectiveosgi.ConsumerComponent(3)] New service tracker for runnable, initial active: false, previous references: {}, classFilter: (objectClass=java.lang.Runnable), eventFilter (&amp;amp;(service.scope=prototype)(language=*)), initialReferenceFilter (&amp;amp;(objectClass=java.lang.Runnable)(service.scope=prototype)(language=*))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16318175" author="cziegeler" created="Tue, 9 Jan 2018 10:04:47 +0000"  >&lt;p&gt;I&apos;ve committed a potential fix in rev 1820632 (2.0.x branch) and rev 1820633 (r7 branch)&lt;/p&gt;</comment>
                            <comment id="16318226" author="nbartlett" created="Tue, 9 Jan 2018 10:37:36 +0000"  >&lt;p&gt;Thanks Carsten. I&apos;ve tested the 2.0.x version and it works correctly, i.e. the references remain unbound and I see this in the log:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2018.01.09 10:36:04 DEBUG - Bundle: example - [com.effectiveosgi.ConsumerComponent(3)] New service tracker for runnable, initial active: false, previous references: {}, classFilter: (objectClass=java.lang.Runnable), eventFilter (service.scope=prototype), initialReferenceFilter (&amp;amp;(objectClass=java.lang.Runnable)(service.scope=prototype))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="16318242" author="cziegeler" created="Tue, 9 Jan 2018 10:47:03 +0000"  >&lt;p&gt;Thanks for verifying&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12905239" name="scr-debug.log" size="41673" author="nbartlett" created="Tue, 9 Jan 2018 08:34:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 45 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3on27:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>