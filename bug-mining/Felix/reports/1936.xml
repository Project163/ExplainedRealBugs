<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:49:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-4050] Named dependencies are not injected if new dependencies are added at init phase.</title>
                <link>https://issues.apache.org/jira/browse/FELIX-4050</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;Spec says that &quot;In the Init method, you are yet allowed to add some additional dependencies (but using the API).&quot;&lt;/p&gt;

&lt;p&gt;I guess this means that I am allowed to call Component.add(). This leads to state transition for instance when new service dependency is added since it&apos;s started right away because component is already instantiated at this point. Component.dependencyAvailable() is called if service tracker finds a match right away and this in turn starts the state change calculation.&lt;/p&gt;

&lt;p&gt;Problem is that State uses components current instantiated status to determinate whether it is bound or not and not the status what the component was given to the activateService() method. State change calculation transitions to bound state prematurely because component is now instantiated. All required dependencies are available, because component is still unaware of forthcoming named dependencies at this point.&lt;/p&gt;

&lt;p&gt;I suggest that some sort of placeholder dependencies are used which the named dependencies will replace when they are created/configured. This also approach also preserves the order in which dependencies were actually added to the component. In the future there could be a new is/SetActive property to DependencyActivation which could be used to turn on/off an already added dependencies. Then named dependencies could be used as such instead of placeholders and user could even configure them directly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12646186">FELIX-4050</key>
            <summary>Named dependencies are not injected if new dependencies are added at init phase.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pderop">Pierre De Rop</assignee>
                                    <reporter username="tuomas_kiviaho">Tuomas Kiviaho</reporter>
                        <labels>
                    </labels>
                <created>Mon, 6 May 2013 09:46:43 +0000</created>
                <updated>Tue, 22 Jul 2014 08:12:33 +0000</updated>
                            <resolved>Tue, 22 Jul 2014 08:12:33 +0000</resolved>
                                    <version>dependencymanager-3.1.0</version>
                                    <fixVersion>dependencymanager.runtime-3.2.0</fixVersion>
                                    <component>Dependency Manager</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13651630" author="tuomas_kiviaho" created="Wed, 8 May 2013 05:30:39 +0000"  >&lt;p&gt;I did some proof-of-concept an found out that current implementations themselves could function as placeholder thus turning it to a dependency that has been added to the component prematurely. There dependencies only track components calling such methods as start/stop (and invokeAdded/invokeRemoved) in order to postpone activation until appropriate time when named dependency is fully configured (finally figured out what setInstanceBound was actually for &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ). &lt;/p&gt;

&lt;p&gt;I had to mark these components available until activation occurs so that init phase would not be blocked from being triggered. Other that that the state machine seemed to cope well. One curious thing is that when component goes from zero to max in one state transition, it seems to skip startTrackingRequired and go straight to activateService. This effectively skips calls to dependency activation start but luckily invokeAdded is called so that I could use it to keep track on interesting parties.&lt;/p&gt;</comment>
                            <comment id="13656128" author="pderop" created="Mon, 13 May 2013 17:12:12 +0000"  >&lt;p&gt;I&apos;m not sure I fully understand the described issue.&lt;br/&gt;
May be you could attach a sample code reproducing the exact problem you are describing ?&lt;/p&gt;

&lt;p&gt;In the mean time, here is more information about the @Init annotation, and also about the @ServiceDependency used with a &quot;name&quot; attribute:&lt;/p&gt;

&lt;p&gt;1- @Init annotation:&lt;br/&gt;
==============&lt;/p&gt;

&lt;p&gt;From the method annotated with @Init, you are allowed to dynamically add dependencies using the API.&lt;br/&gt;
For instance, assuming that S depends on S1/S2/S3, you can then declare &quot;S&quot; as in the following example:&lt;/p&gt;

&lt;p&gt;@Component&lt;br/&gt;
public class S {&lt;/p&gt;

&lt;p&gt;    // required dependency on service &quot;S1&quot;&lt;br/&gt;
    @ServiceDependency&lt;br/&gt;
    S1 _s1;&lt;/p&gt;

&lt;p&gt;    // S2, which dependency is dynamically added in init() method&lt;br/&gt;
    S2 _s2;&lt;/p&gt;

&lt;p&gt;    // S3, which dependency is dynamically added in init() mehtod&lt;br/&gt;
    S3 _s3;&lt;/p&gt;

&lt;p&gt;    // Inject the API, used by our init() method&lt;br/&gt;
    @Inject&lt;br/&gt;
    org.apache.felix.dm.Component _c;&lt;/p&gt;

&lt;p&gt;    // Atomically adds dependencies on S2/S3&lt;br/&gt;
    @Init&lt;br/&gt;
    void init() &lt;/p&gt;
{
        List l = new ArrayList();
        l.add(_c.getDependencyManager().createServiceDependency()
                .setService(S2.class)
                .setRequired(true)
                .setAutoConfig(&quot;_s2&quot;)
                .setInstanceBound(true));
        l.add(_c.getDependencyManager().createServiceDependency()
                .setService(S3.class, &quot;(foo=bar)&quot;)
                .setRequired(true)
                .setAutoConfig(&quot;_s3&quot;)
                .setInstanceBound(true));
        
         _c.add(l);
    }

&lt;p&gt;    @Start&lt;br/&gt;
    void start() &lt;/p&gt;
{
       System.out.println(&quot;started: s2=&quot; + _s2 + &quot;, s3=&quot; + _s3); 
    }
&lt;p&gt;}&lt;/p&gt;


&lt;p&gt;In the init() method, notice the following important points:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;S2/S3 dependencies are added atomically, using Component.add(List) method.&lt;br/&gt;
When more than one dependency is added from the init() method, it is better to add them using a List, because List of Dependencies are&lt;br/&gt;
added atomically: doing so prevent the @Start method to be called if the first dependency (S2) is available before we add the last dependency S3.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Here, the @Start method will be called only after S2 and S3 dependencies have been added and are available.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the S2/S3 extra dependencies are &quot;instance bound&quot;: it means that even if S2 and/or S3 are not available, then &quot;S&quot; component won&apos;t be&lt;br/&gt;
destroyed immediately.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can refer to the following post, where Marcel explains &quot;instance bound&quot; dependencies:&lt;/p&gt;

&lt;p&gt;   &lt;a href=&quot;http://www.mail-archive.com/users@felix.apache.org/msg09314.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/users@felix.apache.org/msg09314.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2- Named @ServiceDependencies&lt;br/&gt;
=========================&lt;/p&gt;

&lt;p&gt;Now, let&apos;s describe when to declare a @ServiceDependency with a &quot;name&quot; attribute:&lt;/p&gt;

&lt;p&gt;&quot;named&quot; dependencies are only available using the annotations, not using the API.&lt;br/&gt;
When you declare a @ServiceDependency with a &quot;name&quot; attribute, you can configure its &apos;required&apos; flag and its filter by returning a Map from the @Init method.&lt;/p&gt;

&lt;p&gt;For instance, assuming that you want to configure the S2 &apos;required&apos; flag and also its filter from ConfigAdmin, then you can do it like this:&lt;/p&gt;

&lt;p&gt;@Component&lt;br/&gt;
public class S {&lt;br/&gt;
    // Config Admin properties, where the S2 &apos;required&apos; flag and filter is configured&lt;br/&gt;
    private Dictionary config; &lt;/p&gt;

&lt;p&gt;    // Inject our configuration&lt;br/&gt;
    @ConfigurationDependency(pid=&quot;MyPid&quot;)&lt;br/&gt;
    void configure(Dictionary config) &lt;/p&gt;
{
         this.config = config;
    }

&lt;p&gt;    // S2 dependency, whose &apos;required&apos; flag and filter is dynamically configured from init() method.&lt;br/&gt;
    @ServiceDependency(name=&quot;S2&quot;)&lt;br/&gt;
    S2 s2;&lt;/p&gt;

&lt;p&gt;    /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Configure our &quot;S2&quot; dependency, using the already injected configuration.&lt;/li&gt;
	&lt;li&gt;The returned Map will be used to configure our &quot;S2&quot; Dependency (see above).&lt;/li&gt;
	&lt;li&gt;The convention is: each Map keys must be prefixed with a dependency name, and must then&lt;/li&gt;
	&lt;li&gt;be suffixed with either &quot;filter&quot; (for the dependency filter) or &quot;required&quot; (for the dependency &apos;required&apos; flag).&lt;br/&gt;
     */&lt;br/&gt;
    @Init&lt;br/&gt;
    Map init() {&lt;br/&gt;
        return new HashMap() {{&lt;br/&gt;
            put(&quot;S2.filter&quot;, m_config.get(&quot;filter&quot;));&lt;br/&gt;
            put(&quot;S2.required&quot;, m_config.get(&quot;required&quot;));&lt;br/&gt;
        }};&lt;br/&gt;
    }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    @Start&lt;br/&gt;
    void start() &lt;/p&gt;
{
       System.out.println(&quot;started: s2=&quot; + _s2 + &quot;, s3=&quot; + _s3); 
    }
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;You can refer to the following documentation for more information about named dependencies:&lt;/p&gt;

&lt;p&gt;       &lt;a href=&quot;http://felix.apache.org/site/apache-felix-dependency-manager-using-annotations-lifecycle.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://felix.apache.org/site/apache-felix-dependency-manager-using-annotations-lifecycle.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please, check &quot;Dynamic Dependency Configuration&quot; section.&lt;/p&gt;


&lt;p&gt;by the way, I just saw that dependencymanager documentation is somewhat broken from URL:&lt;br/&gt;
   &lt;a href=&quot;http://felix.apache.org/documentation/subprojects/apache-felix-dependency-manager/apache-felix-dependency-manager-using-annotations.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://felix.apache.org/documentation/subprojects/apache-felix-dependency-manager/apache-felix-dependency-manager-using-annotations.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please refer to the old site for dm annotation documentation:&lt;br/&gt;
   &lt;a href=&quot;http://felix.apache.org/site/apache-felix-dependency-manager-using-annotations.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://felix.apache.org/site/apache-felix-dependency-manager-using-annotations.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(I will fix the doc from &lt;a href=&quot;http://felix.apache.org/documentation&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://felix.apache.org/documentation&lt;/a&gt; asap).&lt;/p&gt;</comment>
                            <comment id="13656946" author="tuomas_kiviaho" created="Tue, 14 May 2013 10:48:35 +0000"  >&lt;p&gt;Thanks for the tips and quick response,&lt;/p&gt;

&lt;p&gt;I&apos;ve worked around this case already, but in any case here&apos;s a formal example (which is combination of both use cases) that will break as explained above. &lt;/p&gt;

&lt;p&gt;public class S {&lt;/p&gt;

&lt;p&gt;    @Inject&lt;br/&gt;
    org.apache.felix.dm.Component _c;&lt;/p&gt;

&lt;p&gt;    S2 _s2;&lt;/p&gt;

&lt;p&gt;    private Dictionary config; &lt;/p&gt;

&lt;p&gt;    @ConfigurationDependency(pid=&quot;MyPid&quot;)&lt;br/&gt;
    void configure(Dictionary config) &lt;/p&gt;
{ this.config = config; }

&lt;p&gt;    @ServiceDependency(name=&quot;S#&quot;)&lt;br/&gt;
    S3 s3;&lt;/p&gt;

&lt;p&gt;    @Init&lt;br/&gt;
    Map init() {&lt;br/&gt;
        _c.add((_c.getDependencyManager().createServiceDependency()&lt;br/&gt;
                .setService(S2.class)&lt;br/&gt;
                .setRequired(true)&lt;br/&gt;
                .setAutoConfig(&quot;_s2&quot;)&lt;br/&gt;
                .setInstanceBound(true));&lt;br/&gt;
        return new HashMap() {{&lt;br/&gt;
                put(&quot;S3.filter&quot;, m_config.get(&quot;filter&quot;));&lt;br/&gt;
                put(&quot;S3.required&quot;, m_config.get(&quot;required&quot;));&lt;br/&gt;
        }};&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;Here the a state change calculation will occur at _c.add(...) which will transition in turn transition the state prematurely from TRACKING_OPTIONAL to BOUND because name dependency because named dependencies are added behind the scenes after init() method completes. This only happens when all required dependencies are available at the time of state change calculation. &lt;/p&gt;

&lt;p&gt;I could also be mess up similarly the state change calculation of the first use case just by separating the one _c.add(...) call to two separate calls.&lt;/p&gt;</comment>
                            <comment id="13664926" author="pderop" created="Thu, 23 May 2013 06:54:53 +0000"  >&lt;p&gt;Ah Ok ! thanks; I understand now.&lt;/p&gt;

&lt;p&gt;The component state calculation is messing up if init adds some &lt;b&gt;available&lt;/b&gt; dependencies using the API and if init also returns a map for configuring other named annotated dependencies. &lt;br/&gt;
It may even also mess up if no map is returned and if several dependencies are added using the API, but not atomically (using separate Component.add(Dependency) method calls). But in the latter case, multiple dependencies should be added atomically using Component.add(List) single method call. &lt;/p&gt;

&lt;p&gt;Anyway, as you explained, adding the dependencies with the API may change the state to BOUND state &lt;b&gt;before&lt;/b&gt; the runtime possibly configures named dependencies after the init method is called (see ServiceLifecycleHandler.java, in the runtime).&lt;/p&gt;

&lt;p&gt;All this is an edge case I did not expect, because dependencies are usually declared either using annotations or using the programmatic API, but not using a mix of annotations + code using directly the API (Component.add() method).&lt;/p&gt;

&lt;p&gt;Ok, I think the easiest way to fix this issue with minimal impact consists in adding an hidden &quot;toggle&quot; dependency, which allows to activate all dependencies &lt;b&gt;after&lt;/b&gt; init method is called and also &lt;b&gt;after&lt;/b&gt; all named dependencies are possibly configured.&lt;/p&gt;

&lt;p&gt;The patch is ready and seems to work, but I prefer to write and commit a test about this issue because applying the patch.&lt;/p&gt;</comment>
                            <comment id="13664935" author="pderop" created="Thu, 23 May 2013 07:03:41 +0000"  >&lt;p&gt;Added a patch (in the dm runtime) which seems to resolve this issue. Will commit it after having committed a test case for this issue.&lt;/p&gt;</comment>
                            <comment id="13666499" author="pderop" created="Fri, 24 May 2013 17:48:32 +0000"  >&lt;p&gt;Committed a testcase in  src/test/java/org/apache/felix/dm/test/annotation/Felix4050Test.java&lt;br/&gt;
Also Committed a candidate fix for this issue in the runtime (revision r1486131).&lt;/p&gt;</comment>
                            <comment id="13666501" author="pderop" created="Fri, 24 May 2013 17:49:09 +0000"  >&lt;p&gt;I think the issue can be closed (feel free to reopen if necessary).&lt;/p&gt;</comment>
                            <comment id="14069978" author="pderop" created="Tue, 22 Jul 2014 08:12:08 +0000"  >&lt;p&gt;reopen in order to set fix-for version to 3.2.0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12584451" name="FELIX-4050.patch" size="7114" author="pderop" created="Thu, 23 May 2013 07:03:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>326544</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 18 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1kc2v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>326889</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>