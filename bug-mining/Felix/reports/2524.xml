<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:59:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5053] IllegalArgumentException when forwarding request</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5053</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;It seems to be a problem with forwarding requests in certain cases. I have the following setup:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Servlet A forwards the request to Servlet 2 (using RequestDispatcher).&lt;/li&gt;
	&lt;li&gt;Servlet B writes to the response using an output stream (HttpServletResponse.getOutputStream()).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;When this happens I get an IllegalStateException from Jetty that basically saying that the Writer cannot be closed since I have already used an OutputStream.&lt;/p&gt;

&lt;p&gt;The code that I think is wrong (or possibly not robust enough) is in RequestDispatcherImp line 84. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!request.isAsyncStarted())
{
  response.flushBuffer();
  response.getWriter().close();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The line that causes trouble is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;response.getWriter().close();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We should probably check if we can actually close this writer or just ignore the potential exception.&lt;/p&gt;


&lt;p&gt;In my setup I have one servlet that writes to OutputStream using HttpServletResponse.getOutputStream(). Then I have another servlet that forwards the request to the first servlet. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12896204">FELIX-5053</key>
            <summary>IllegalArgumentException when forwarding request</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srs">Sten Roger Sandvik</assignee>
                                    <reporter username="srs">Sten Roger Sandvik</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Sep 2015 19:13:15 +0000</created>
                <updated>Tue, 13 Oct 2015 04:38:40 +0000</updated>
                            <resolved>Fri, 9 Oct 2015 14:51:01 +0000</resolved>
                                    <version>http.base-3.0.0</version>
                                    <fixVersion>http.base-3.0.2</fixVersion>
                    <fixVersion>http.jetty-3.1.2</fixVersion>
                    <fixVersion>http.bridge-3.0.2</fixVersion>
                                    <component>HTTP Service</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14907052" author="srs" created="Thu, 24 Sep 2015 21:19:47 +0000"  >&lt;p&gt;I propose that we just ignore any exceptions comming from closing the writer. Like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!request.isAsyncStarted())
{
  response.flushBuffer();
  
  &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    response.getWriter().close();
  } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Exception e) {
    &lt;span class=&quot;code-comment&quot;&gt;// Ignore any exception. See FELIX-5053.
&lt;/span&gt;  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Any comments?&lt;/p&gt;</comment>
                            <comment id="14907586" author="cziegeler" created="Fri, 25 Sep 2015 05:06:25 +0000"  >&lt;p&gt;Not sure if the close() is needed at all - I guess it&apos;s there to ensure that no other component writes after the request has been forwarded, but if this can&apos;t be ensured (like in the described case), I think we can remove the whole statement. Jetty will close the response anyway&lt;/p&gt;</comment>
                            <comment id="14907659" author="srs" created="Fri, 25 Sep 2015 06:16:06 +0000"  >&lt;p&gt;Yes, that was my initial tought too, but was a little bit afraid to remove it (in case it&apos;s a really good reason). But, have tried a lot of cases without that statement and it seems to work just fine.&lt;/p&gt;</comment>
                            <comment id="14939481" author="srs" created="Thu, 1 Oct 2015 08:12:16 +0000"  >&lt;p&gt;I removed the response.getWriter().close() line. It works for me and it should not be there. &lt;/p&gt;</comment>
                            <comment id="14948808" author="cziegeler" created="Thu, 8 Oct 2015 15:12:25 +0000"  >&lt;p&gt;Three tests in the itest module fail now, all of them in&lt;br/&gt;
RequestDispatchTest.&lt;/p&gt;

&lt;p&gt;These tests call a servlet which:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;writes to the writer&lt;/li&gt;
	&lt;li&gt;forwards to another servlet&lt;/li&gt;
	&lt;li&gt;writes to the writer again.&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;With http.base 3.0.0 the write after the forward is simply ignored, with&lt;br/&gt;
http.base 3.0.1-SNAPSHOT it is not and ends up in the output stream.&lt;br/&gt;
Looking at the servlet spec, that seems to be wrong. However I&apos;m not&lt;br/&gt;
sure whether the writing should be ignored or actually throw an exception.&lt;br/&gt;
I seems we were wrong that the close is&lt;br/&gt;
not needed &lt;/p&gt;</comment>
                            <comment id="14949134" author="srs" created="Thu, 8 Oct 2015 18:45:17 +0000"  >&lt;p&gt;Sorry, did not notice that. Probably the best thing for now is to ignore any exceptions from the &quot;getWriter().close()&quot; operation?&lt;/p&gt;</comment>
                            <comment id="14949954" author="cziegeler" created="Fri, 9 Oct 2015 06:19:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srs&quot; class=&quot;user-hover&quot; rel=&quot;srs&quot;&gt;srs&lt;/a&gt; I&apos;ve now committed a slight variant of this: the writer is tried to be closed, if an IllegalStateException is thrown by this, it&apos;s most likely that the servlet handling the forward used an output stream. In this case, I close that one. For both, any other exception is closed&lt;br/&gt;
WDYT?&lt;/p&gt;</comment>
                            <comment id="14950458" author="srs" created="Fri, 9 Oct 2015 14:22:07 +0000"  >&lt;p&gt;Looks good. I think this will do it. Tested it agaist my setup and everything works perfectly.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 6 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2lj4n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>