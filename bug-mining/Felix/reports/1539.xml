<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:41:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3461] Re-manipulation with annotated component produces corrupted MANIFEST</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3461</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;As the manipulation process alters the annotations of original classes on generated ones. It leaves it in inconsistent state for re-manipulation. While re-manipulation process does not touch classes, re-manipulated bundle is unable to function because of a corrupted MANIFEST.&lt;/p&gt;

&lt;p&gt;Broken MANIFEST is missing some handler declarations because of the filters and have entries in manipulation section those should have been hided.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12550956">FELIX-3461</key>
            <summary>Re-manipulation with annotated component produces corrupted MANIFEST</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="clement.escoffier">Clement Escoffier</assignee>
                                    <reporter username="ggezer">G&#246;kt&#252;rk Gezer</reporter>
                        <labels>
                            <label>ipojo-manipulator</label>
                    </labels>
                <created>Sat, 14 Apr 2012 21:15:23 +0000</created>
                <updated>Mon, 4 Feb 2013 12:34:31 +0000</updated>
                            <resolved>Tue, 17 Apr 2012 16:11:20 +0000</resolved>
                                                    <fixVersion>ipojo-manipulator-1.8.6</fixVersion>
                                    <component>iPOJO</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13254203" author="ggezer" created="Sat, 14 Apr 2012 21:17:39 +0000"  >&lt;p&gt;Fix for bug.&lt;/p&gt;

&lt;p&gt;Tested against all current ipojo annotations and custom annotations to produce same MANIFEST after re-manipulation on both directory and jar-file.&lt;/p&gt;</comment>
                            <comment id="13254998" author="sauthieg" created="Mon, 16 Apr 2012 20:09:15 +0000"  >&lt;p&gt;Why did you do some changes on ConstructorCodeAdapter.java in visitParameterAnnotation() ?&lt;/p&gt;</comment>
                            <comment id="13255015" author="ggezer" created="Mon, 16 Apr 2012 20:37:56 +0000"  >&lt;p&gt;Method was not implemented before, i overrided it. Reason is to prevent parameter annotations(only @Property and @Requires) of original constructor to go into generated one. And i also changed ClassChecker.AnnotationCollector.visitParameterAnnotation() method to keep those parameter annotations in original constructor. By keeping injection annotations in original constructor, they are interpreted correctly at re-manipulation time without doing any harm to runtime semantics. Otherwise parameter indexes are interpreted in the context of generated cosntructor with additional InstanceManager reference, thus causing injection parameters to be assigned wrong type identifier at re-manipulation. (Injecting services and parameters still works in runtime with those changes).&lt;/p&gt;

&lt;p&gt;While writing this, I also noticed that this fix can be implemented another way:&lt;/p&gt;

&lt;p&gt;in ConstructorCodeAdapter.visitParameterAnnotation():&lt;/p&gt;

&lt;p&gt;if(desc.equals(&quot;Lorg/apache/felix/ipojo/annotations/Property;&quot;)&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; desc.equals(&quot;Lorg/apache/felix/ipojo/annotations/Requires;&quot;))
{
    		return null;
        }
&lt;p&gt;    	else&lt;/p&gt;
{
    		return super.visitParameterAnnotation(parameter+1, desc, visible);
    	}&lt;/th&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;returning super.visitParameterAnnotation with parameter index incremented by 1, because InstanceManager is added to the first position in argument list. Then we can remove the code i added to the ClassChecker.AnnotationCollector.visitParameterAnnotation() safely.&lt;/p&gt;</comment>
                            <comment id="13255187" author="ggezer" created="Mon, 16 Apr 2012 23:46:10 +0000"  >&lt;p&gt;Oh no! the second way that i proposed in my comment will not work. Incremented parameter index fixes the type of property at re-manipulation but because of the changed index, &quot;properties&quot; section will contain false constructor parameter index causing constructor registration code to fail.&lt;/p&gt;

&lt;p&gt;I thought it may save us from modifying code at 2 place but doing it introduces problems that can not be handled nicely. So i believe we must treat constructors differently then the other methods.&lt;/p&gt;</comment>
                            <comment id="13255393" author="sauthieg" created="Tue, 17 Apr 2012 07:29:50 +0000"  >&lt;p&gt;OK, it&apos;s definitely a different issue.&lt;br/&gt;
Can you open a new bug for that specific issue (annotations on constructor arguments are not correctly handled) ?&lt;/p&gt;

&lt;p&gt;I&apos;ll add a new patch soon just for this case, I clean metadata at the root (ie when they are produced), instead that fixing it at rendering time.&lt;/p&gt;</comment>
                            <comment id="13255400" author="sauthieg" created="Tue, 17 Apr 2012 07:57:26 +0000"  >&lt;p&gt;This new patch hide the generated methods/fields from the metadata produced in the ClassChecker.&lt;/p&gt;

&lt;p&gt;If the checker find that the class has already be manipulated, no further manipulation is done, so it should be good.&lt;/p&gt;

&lt;p&gt;Can you try it ?&lt;/p&gt;

&lt;p&gt;BTW, If possible, can you add a specific TestCase for your issue ?&lt;/p&gt;</comment>
                            <comment id="13255459" author="ggezer" created="Tue, 17 Apr 2012 10:48:30 +0000"  >&lt;p&gt;No the &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3461&quot; title=&quot;Re-manipulation with annotated component produces corrupted MANIFEST&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3461&quot;&gt;&lt;del&gt;FELIX-3461&lt;/del&gt;&lt;/a&gt;-GSA.patch didn&apos;t work. And it can&apos;t work actually. By skipping all manipulated methods and fields at re-manipulation time,You are loosing all annotations those are moved to generated ones at first manipulation time. So you loose properties, transition methods, dependency ids, almost everything on both components and handlers. &lt;/p&gt;

&lt;p&gt;If you want to do it in ClassChecking time instead of rendering time, you have to make sure all annotations of ipojo are sticked to the original methods and fields, which clearly brokes IPojo&apos;s documented behaviour. And to do that also you have to introduce lots of custom codes into ClassCheckers and GeneratorAdaptors, because you can not do that to every annotation, you have to do that for only ipojo specific annotations.&lt;/p&gt;

&lt;p&gt;The only bad-apple here is constructors, because they add an additional InstanceManager argument to generated constructor. To do that they must be manipulated in a way that renderer can handle them at re-manipulation time along with the others. And in case of rendering, the ManipulationMetadataFilter is not a viable solution. First of all it is searching all the attributes of all Elements against special headers, which is not performance wise. And it does not work correctly because you have to establish a match between manipulation methods and fields before blindly deleting them by looking at their method name. Also there is a TODO comment at the ManipulationMetadataFilter which depicts that. Also this is what ManipulationMetadataFixer at first patch is intended to do.&lt;/p&gt;
</comment>
                            <comment id="13255555" author="sauthieg" created="Tue, 17 Apr 2012 13:27:52 +0000"  >&lt;p&gt;Can we come back to the root of the issue ?&lt;/p&gt;

&lt;p&gt;The ClassChecker is only here to ensure that manipulated classes are not manipulated again.&lt;br/&gt;
It doesn&apos;t usually care about validity of its discovered metadata.&lt;/p&gt;

&lt;p&gt;I assume that what you observe is that an existing MANIFEST with an IPOJO-Components with multiple (ans equivalent) component &lt;/p&gt;
{...}
&lt;p&gt; definitions.&lt;br/&gt;
Is that the problem ?&lt;/p&gt;</comment>
                            <comment id="13255562" author="ggezer" created="Tue, 17 Apr 2012 13:43:20 +0000"  >&lt;p&gt;We already are at the root !&lt;/p&gt;

&lt;p&gt;ClassChecker is intended to to that, right. But then the metadata that ClassChecker has been collected is being used to generate MANIFEST, and that&apos;s the problem. Not also manifest by the way. ClassChecker visits the methods and while visiting, it collects the annotations and parameter annotations of the methods(including constructors) and that information is used in MethodCreator to modify constructors again. So ClassChecker&apos;s collected informations are important here, they&apos;re not just for checking whether manipulation is occured, they&apos;re used after checking process. That&apos;s why i modified ClassChecker and added exception for injection annotations. Otherwise modified constructor will not contain injection annotations. And also modified ConstructorCodeGenerator to prevent them from going into generated constructor.&lt;/p&gt;

&lt;p&gt;Process is two step:&lt;br/&gt;
First we must make sure first manipulation does not leave constructor annotations in inconsistent state for second manipulation,&lt;br/&gt;
Secondly we fix all the manifest data in rendering step so they reflect initial component state in any manipulation attempt.&lt;/p&gt;

&lt;p&gt;No your assumption is not the case. It results in a single component{} with corrupted values, not multiple component{} decleration.&lt;/p&gt;</comment>
                            <comment id="13255563" author="sauthieg" created="Tue, 17 Apr 2012 13:54:56 +0000"  >&lt;p&gt;Can you provide a JUnit TestCase that reproduce the issue ?&lt;/p&gt;</comment>
                            <comment id="13255581" author="ggezer" created="Tue, 17 Apr 2012 14:12:46 +0000"  >&lt;p&gt;Unfortunately this issue is not easy to reproduce or wrap in TestCase. At least i don&apos;t know an easy way to write it. But here is the steps for you to see it in action:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Create a simple bundle which is not manipulated with either mave-ipojo or bnd-ipojo plugin with the content:&lt;br/&gt;
@Component&lt;br/&gt;
public class TestComponent&lt;br/&gt;
{&lt;br/&gt;
  public TestComponent(@Property String hi){}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;  @Validate&lt;br/&gt;
  public void validated()&lt;br/&gt;
}&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Manipulate that jar using Pojoization.pojoization() method.&lt;br/&gt;
I did it by creating seperate project under manipulator, and using Pojoization to simply do pojoization.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Copy the MANIFEST in manipulated jar somewhere. This MANIFEST will be correct without any error.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;And then re-run pojoization on manipulated jar again.(The one manipulator extracted as &amp;lt;bundleName&amp;gt;_out.jar&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Then look into MANIFEST file of 2. manipulated jar, and you&apos;ll see &quot;validate&quot; transition is gone, and constructor argument @Property &quot;hi&quot; will be interpreted as &quot;ipojo.InstanceManager&quot; type. And you will see __M methods in manipulation section. If you try adding more annotations you&apos;ll see more errors in final MANIFEST.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13255584" author="sauthieg" created="Tue, 17 Apr 2012 14:14:52 +0000"  >&lt;p&gt;Let me try to put it differently:&lt;br/&gt;
For me, we have 2 separate issues here:&lt;br/&gt;
#1 annotations on constructor&apos;s arguments are not correctly handled&lt;br/&gt;
#2 produced metadata at the end of the manipulation is somehow incorrect when resource is manipulated a second time&lt;/p&gt;

&lt;p&gt;right ?&lt;/p&gt;</comment>
                            <comment id="13255592" author="ggezer" created="Tue, 17 Apr 2012 14:28:23 +0000"  >&lt;p&gt;Yeah, but they are heavily interconnected.&lt;/p&gt;

&lt;p&gt;#1: yeah they are not correctly handled, because they are handled the same way with other methods, while they have seperate characteristic.&lt;br/&gt;
#2: Metadata is not wrong,MANIFEST also is not wrong. They are what they should be. But for second manipulation, they must be interpreted specifically.&lt;/p&gt;

&lt;p&gt;So if #1 is solved, then #2 can be solved. Trying to solve only #2 leaves #1 and whole issue unfixed. So fixing #1 is a contribution to fixing #2.&lt;/p&gt;

&lt;p&gt;If you perform the steps i wrote, you&apos;ll see the problem. And then re-performing with patch applied will make sense.&lt;/p&gt;</comment>
                            <comment id="13255610" author="clement.escoffier" created="Tue, 17 Apr 2012 14:52:02 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I&apos;ve reproduced part (all?) of the issue.&lt;br/&gt;
I&apos;ve a class with PlentyOfAnnotations - including constructor, class, field and method annotations. It use both iPOJO core annotations but also external handler annotations.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I extract the metadata from the class - the metadata are ok&lt;/li&gt;
	&lt;li&gt;I manipulate the class a first time - manipulation metadata ok&lt;/li&gt;
	&lt;li&gt;I extract a second times the metadata from the manipulated class - the metadata are not ok... the method are wrong and the index parameters are shift by 1.&lt;/li&gt;
	&lt;li&gt;I manipulate a second time - manipulation metadata ok but including all the new methods.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;My test is checking both the manipulation (and the computation of the manipulation metadata) and the metadata collected from the classes.&lt;/p&gt;

&lt;p&gt;Do I cover everything ? &lt;/p&gt;
</comment>
                            <comment id="13255613" author="ggezer" created="Tue, 17 Apr 2012 14:56:27 +0000"  >&lt;p&gt;Yeah those are the steps i&apos;m taking.&lt;/p&gt;

&lt;p&gt;If you look into second MANIFEST you&apos;ll see transition methods &quot;invalidate&quot; &quot;validate&quot; and &quot;properties&quot; section also have gone in addition to new methods and fields.&lt;/p&gt;</comment>
                            <comment id="13255617" author="ggezer" created="Tue, 17 Apr 2012 15:01:52 +0000"  >&lt;p&gt;Here is the problem list after second manipulation on MANIFEST as i saw:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;transition methods are gone(validate,invalidate)&lt;/li&gt;
	&lt;li&gt;Bind/Unbind/Modified section on methods have gone&lt;/li&gt;
	&lt;li&gt;Constructor property indexes are shifted by 1 causing wrong type resolution&lt;/li&gt;
	&lt;li&gt;manipulation methods and fields have been introduced into MANIFEST&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13255621" author="clement.escoffier" created="Tue, 17 Apr 2012 15:07:27 +0000"  >&lt;p&gt;In my test I don&apos;t write the manifest as I just read the Element-Attribute structure (it&apos;s really a unit test).&lt;/p&gt;

&lt;p&gt;I don&apos;t see the &apos;transition methods gone&apos; effect. The metadata re not correct but still here:&lt;br/&gt;
callback transition=&quot;validate&quot; method=&quot;__M_start&quot;, instance component=&quot;test.PlentyOfAnnotations&quot;&lt;/p&gt;

&lt;p&gt;I&apos;ve all the other effects. So I can now have a look to your patch and check what it is doing &apos;for real&apos;.&lt;/p&gt;</comment>
                            <comment id="13255625" author="clement.escoffier" created="Tue, 17 Apr 2012 15:09:34 +0000"  >&lt;p&gt;For information here is the test: &lt;a href=&quot;https://gist.github.com/2406634&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/2406634&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13255628" author="ggezer" created="Tue, 17 Apr 2012 15:10:15 +0000"  >&lt;p&gt;Yeah but this line:&lt;/p&gt;

&lt;p&gt;callback transition=&quot;validate&quot; method=&quot;__M_start&quot;, instance component=&quot;test.PlentyOfAnnotations&quot; &lt;/p&gt;

&lt;p&gt;will be discarded by ManipulateMetadataFilter in rendering step because its attribute contains MethodCreator.PREFIX , thus causing it to not go into MANIFEST file...&lt;/p&gt;</comment>
                            <comment id="13255683" author="clement.escoffier" created="Tue, 17 Apr 2012 16:11:20 +0000"  >&lt;p&gt;I&apos;ve applied a mix of both patch + some spices from me.&lt;/p&gt;

&lt;p&gt;Please check with the trunk version.&lt;/p&gt;
</comment>
                            <comment id="13255842" author="ggezer" created="Tue, 17 Apr 2012 19:10:28 +0000"  >&lt;p&gt;i confirm, issue is fixed.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12522922" name="FELIX-3461-GSA.patch" size="96770" author="sauthieg" created="Tue, 17 Apr 2012 07:57:17 +0000"/>
                            <attachment id="12522688" name="org.apache.felix.ipojo.manipulator.patch" size="15358" author="ggezer" created="Sat, 14 Apr 2012 21:17:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>235820</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 32 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i07gwn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>41505</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>