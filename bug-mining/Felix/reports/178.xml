<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:06:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-550] SCR registers service component twice after stopping/starting a bundle</title>
                <link>https://issues.apache.org/jira/browse/FELIX-550</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;When stopping and starting a bundle (from the shell) that has a component which is also registered as a service, this service is registered twice from time to time.&lt;/p&gt;

&lt;p&gt;What I am seeing, is that when starting the bundle (after stopping it first), the enable method (AbstractComponentManager) is called starting an enableInternal&apos; (including an activateInternal) on the component actor thread.&lt;br/&gt;
Approximately at the same time, an update call is made from the configuration manager (on some thread from the CM, through method &apos;update&apos; in ImmediateComponentManager&apos;s anonymous ManagedService inner class) resulting eventually in a call to &apos;reactivate&apos; which first deactivates (deactivateInternal) on the current thread (CM thread). That&apos;s where things clash, I guess.&lt;/p&gt;

&lt;p&gt;I cannot reproduce this behaviour when logging level is set to debug.&lt;/p&gt;</description>
                <environment>JDK 1.6.0_03 / WinXP SP2</environment>
        <key id="12395629">FELIX-550</key>
            <summary>SCR registers service component twice after stopping/starting a bundle</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fmeschbe">Felix Meschberger</assignee>
                                    <reporter username="pneyens">Paul Neyens</reporter>
                        <labels>
                    </labels>
                <created>Thu, 8 May 2008 15:16:30 +0000</created>
                <updated>Tue, 10 Jun 2008 08:47:38 +0000</updated>
                            <resolved>Tue, 3 Jun 2008 09:59:35 +0000</resolved>
                                    <version>scr-1.0.0</version>
                                    <fixVersion>scr-1.0.2</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12601593" author="fmeschbe" created="Mon, 2 Jun 2008 11:04:02 +0000"  >&lt;p&gt;What can happen is the following:&lt;/p&gt;

&lt;p&gt;activateInternal will set the state to active &lt;em&gt;before&lt;/em&gt; the component is registered as a service. If now between setting the state to active and registering the service, the configuration comes in and reactivation is triggered, the component may be deactivated immediatly while still registering the service.&lt;/p&gt;

&lt;p&gt;Now, the component is deactivated, the service registered and the component is activated again and the service registered again.&lt;/p&gt;

&lt;p&gt;The problem is to not cycle the component while the component is being registered as a service.&lt;/p&gt;

&lt;p&gt;My first step is to investigate whether it is feasible to set the component to active only &lt;em&gt;after&lt;/em&gt; the component&apos;s state is marked active. (yes this would probably be the right thing, I have to find out, whether it is not done like that !)&lt;/p&gt;</comment>
                            <comment id="12601608" author="fmeschbe" created="Mon, 2 Jun 2008 12:00:16 +0000"  >&lt;p&gt;In Rev. 662404 I committed a tentative fix for this issue. This fix introduces a lock guarding access to the component&apos;s service registration field. This lock has the following background and working:&lt;/p&gt;

&lt;p&gt;The activateInternal method sets the component state to satisfied (aka ready) before the component is registered as a service and the internal service registration field is set. &lt;/p&gt;

&lt;p&gt;If now in the time between setting the state to satisified and the service registration field being set, the component is deactivated &amp;#8211; possibly through reconfiguration &amp;#8211; the service may not be unregistered because the field is not set, but re-activation of the component may register the service again thus resulting in two services being registered, the active and the deactivated. Which of both is being used is framework implementation dependent but chances are, the wrong is used resulting in system failure.&lt;/p&gt;

&lt;p&gt;To fix this, all access to the service registration field is guarded by a lock. Only if a thread is able to set the lock flag, can the service registration field be accessed.&lt;/p&gt;

&lt;p&gt;To circumvent the above mentioned situation, the activateInternal method locks the field &lt;em&gt;before&lt;/em&gt; setting the component satisfied. This prevents the deactivateInternal method from deactivating the component until the service has been registered and the lock been freed. Only then can the deactivateInternal method start its deactivation task by unregistering the service.&lt;/p&gt;

&lt;p&gt;I deployed a new SNAPSHOT version 1.0.1-20080602.115831-3 including this tentative fix. Please verify and provide feedback. Thanks.&lt;/p&gt;</comment>
                            <comment id="12601880" author="fmeschbe" created="Tue, 3 Jun 2008 09:59:35 +0000"  >&lt;p&gt;I am pretty confident this fix works. So I resolve this issue for now.&lt;/p&gt;</comment>
                            <comment id="12603806" author="fmeschbe" created="Tue, 10 Jun 2008 08:47:38 +0000"  >&lt;p&gt;No feedback received on this one. Assuming it works, therefore closing.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12396978">SLING-486</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>58438</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 25 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0w1kn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>185060</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>