<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:08:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-836] Deadlocks caused by Declarative Services</title>
                <link>https://issues.apache.org/jira/browse/FELIX-836</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;We experience deadlocks with Declarative Services every now and then related to the interaction between the framework and SCR. The situation most often happens when multiple bundles are uptated and packages are refreshed.&lt;/p&gt;

&lt;p&gt;One thread involved is the &quot;SCR Component Actor&quot; thread, which is the thread of SCR running asynchronous operations on registered components. The other thread is the framework PackageAdmin thread which stops and starts bundles during refresh:&lt;/p&gt;

&lt;p&gt;---- thread dump excerpt ----&lt;br/&gt;
&quot;SCR Component Actor&quot; daemon prio=5 tid=0x0107f9c0 nid=0xab2400 in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0xb18a2000..0xb18a2d90&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.lang.Object.wait(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting on &amp;lt;0x075e2d58&amp;gt; (a [Ljava.lang.Object&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
	at java.lang.Object.wait(Object.java:474)&lt;br/&gt;
	at org.apache.felix.framework.Felix.acquireBundleLock(Felix.java:4167)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x075e2d58&amp;gt; (a [Ljava.lang.Object&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
	at org.apache.felix.framework.Felix.registerService(Felix.java:2665)&lt;br/&gt;
	at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:254)&lt;br/&gt;
	at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:232)&lt;br/&gt;
	at org.apache.sling.scripting.core.impl.ScriptEngineConsolePlugin.activate(ScriptEngineConsolePlugin.java:171)&lt;br/&gt;
	at org.apache.sling.scripting.core.impl.ScriptEngineConsolePlugin.initPlugin(ScriptEngineConsolePlugin.java:52)&lt;br/&gt;
	at org.apache.sling.scripting.core.impl.SlingScriptAdapterFactory.activate(SlingScriptAdapterFactory.java:223)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:585)&lt;br/&gt;
	at org.apache.felix.scr.impl.ImmediateComponentManager.createImplementationObject(ImmediateComponentManager.java:226)&lt;br/&gt;
	at org.apache.felix.scr.impl.ImmediateComponentManager.createComponent(ImmediateComponentManager.java:133)&lt;br/&gt;
	at org.apache.felix.scr.impl.AbstractComponentManager.activateInternal(AbstractComponentManager.java:476)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x0976ca30&amp;gt; (a org.apache.felix.scr.impl.ImmediateComponentManager)&lt;br/&gt;
	at org.apache.felix.scr.impl.AbstractComponentManager.enableInternal(AbstractComponentManager.java:398)&lt;br/&gt;
	at org.apache.felix.scr.impl.AbstractComponentManager.access$000(AbstractComponentManager.java:36)&lt;br/&gt;
	at org.apache.felix.scr.impl.AbstractComponentManager$1.run(AbstractComponentManager.java:99)&lt;br/&gt;
	at org.apache.felix.scr.impl.ComponentActorThread.run(ComponentActorThread.java:85)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;&quot;FelixPackageAdmin&quot; daemon prio=5 tid=0x0106f330 nid=0xaad000 waiting for monitor entry &lt;span class=&quot;error&quot;&gt;&amp;#91;0xb171f000..0xb171fd90&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.felix.scr.impl.AbstractComponentManager.deactivateInternal(AbstractComponentManager.java:540)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x0976ca30&amp;gt; (a org.apache.felix.scr.impl.ImmediateComponentManager)&lt;br/&gt;
	at org.apache.felix.scr.impl.AbstractComponentManager.disableInternal(AbstractComponentManager.java:579)&lt;br/&gt;
	at org.apache.felix.scr.impl.AbstractComponentManager.disposeInternal(AbstractComponentManager.java:616)&lt;br/&gt;
	at org.apache.felix.scr.impl.AbstractComponentManager.dispose(AbstractComponentManager.java:272)&lt;br/&gt;
	at org.apache.felix.scr.impl.ImmediateComponentManager.dispose(ImmediateComponentManager.java:120)&lt;br/&gt;
	at org.apache.felix.scr.impl.BundleComponentActivator.dispose(BundleComponentActivator.java:258)&lt;br/&gt;
	at org.apache.felix.scr.impl.Activator.disposeComponents(Activator.java:264)&lt;br/&gt;
	at org.apache.felix.scr.impl.Activator.bundleChanged(Activator.java:177)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.invokeBundleListenerCallback(EventDispatcher.java:690)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:619)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireBundleEvent(EventDispatcher.java:532)&lt;br/&gt;
	at org.apache.felix.framework.Felix.fireBundleEvent(Felix.java:3601)&lt;br/&gt;
	at org.apache.felix.framework.Felix._stopBundle(Felix.java:1989)&lt;br/&gt;
	at org.apache.felix.framework.Felix.stopBundle(Felix.java:1954)&lt;br/&gt;
	at org.apache.felix.framework.Felix$RefreshHelper.stop(Felix.java:3972)&lt;br/&gt;
	at org.apache.felix.framework.Felix.refreshPackages(Felix.java:3257)&lt;br/&gt;
	at org.apache.felix.framework.PackageAdminImpl.run(PackageAdminImpl.java:259)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:613)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;
			&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
				&lt;li&gt;thread dump excerpt ----&lt;/li&gt;
			&lt;/ul&gt;
			&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The problem is that on the one hand we need some kind of synchronization inside SCR and on the other hand SCR has a synchronous bundle listener. This is used to hear about started bundles and bundles about to stop (which is the case in the PackageAdmin thread dump above). Since synchronous listeners are called synchronously while the framework is trying to change the bundle state, the framework bundle locks are held while the listener is called.&lt;/p&gt;

&lt;p&gt;To prevent this kind of deadlock the bundle listener should probably dispose off the components asynchronously while the framework is stopping the bundles.&lt;/p&gt;

&lt;p&gt;Looking at when components are being disabled, we find four situations:&lt;/p&gt;

&lt;p&gt;(1) A bundle is stopped and its components must be disposed off. This may be done in the SCR thread asynchronous to the actual bundle stop processing.&lt;br/&gt;
(2) A factory configuration object of a ComponentFactory instance is deleted. This may also be done asynchronously because IMHO it is not time critical to dispose off an instance of a ComponentFactory in this situation.&lt;br/&gt;
(3) A ComponentInstance explicitly disposed of by calling the ComponentInstance.dispose() method. This request must also be acted upon immediately and the component disposed off synchronously.&lt;br/&gt;
(4) The Declarative Services bundle is stopped. Here we have to immediately dispose off all components in the system. We cannot do this asynchronously.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12409383">FELIX-836</key>
            <summary>Deadlocks caused by Declarative Services</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fmeschbe">Felix Meschberger</assignee>
                                    <reporter username="fmeschbe">Felix Meschberger</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Nov 2008 09:49:49 +0000</created>
                <updated>Thu, 2 May 2013 02:29:19 +0000</updated>
                            <resolved>Fri, 6 Feb 2009 14:07:15 +0000</resolved>
                                    <version>scr-1.0.6</version>
                                    <fixVersion>scr-1.0.8</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12651304" author="fmeschbe" created="Thu, 27 Nov 2008 09:52:48 +0000"  >&lt;p&gt;Proposed patch:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Add parameter to ComponentManager.dispose method to indicate whether to dispose immediately or asynchronously&lt;/li&gt;
	&lt;li&gt;Call modified ComponentManager.dispose(boolean) method depending on the use cases listed in the issue report.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12671126" author="fmeschbe" created="Fri, 6 Feb 2009 13:31:21 +0000"  >&lt;p&gt;I have to revise, what I wrote above with respect to stopping the components of a bundle being stopped: If a bundle is stopped, its component must be immediately removed, otherwise unexpcted things may happen.&lt;/p&gt;

&lt;p&gt;In fact, it would probably be best to immediately stop components, if :&lt;/p&gt;

&lt;p&gt;  &amp;#8211; their containing bundle is stopped&lt;br/&gt;
  &amp;#8211; if a factory configuration instance is deleted&lt;br/&gt;
  &amp;#8211; if a component&apos;s deactivation is requested by ComponentInstance.dispose()&lt;br/&gt;
  &amp;#8211; if the SCR bundle is going down&lt;/p&gt;

&lt;p&gt;On the other hand a component may be (and should be) asynchronously stopped, if:&lt;/p&gt;

&lt;p&gt;  &amp;#8211; configuration has been updated&lt;br/&gt;
  &amp;#8211; a reference has changed, which causes a component to stop or by cycled&lt;/p&gt;

&lt;p&gt;We have to stop a component, for which a change in a reference (dependency) requires the component to by cycled, asynchronously to not provoke a list of deadlocks.&lt;/p&gt;</comment>
                            <comment id="12671128" author="fmeschbe" created="Fri, 6 Feb 2009 13:32:34 +0000"  >&lt;p&gt;Actually this deadlock situation is related to the case of the framework blocking on trying to register a service. Richard Hall is currently working on a fix to this situation, which is very promising.&lt;/p&gt;</comment>
                            <comment id="12671137" author="fmeschbe" created="Fri, 6 Feb 2009 14:07:15 +0000"  >&lt;p&gt;In Rev. 741567 modified asynchronicity as follows:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;deactivate() is always asynchronous&lt;br/&gt;
          (dispose() directly calls deactivateInternal() and thus remains synchronous)&lt;/li&gt;
	&lt;li&gt;reactive() is always asynchronous&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12413602">FELIX-911</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12394831" name="FELIX-836.patch" size="8612" author="fmeschbe" created="Thu, 27 Nov 2008 09:52:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>58153</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0w1qn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>185087</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>