<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:47:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3411] The implementation of org.osgi.service.startlevel.StartLevel#setStartLevel(int) does not follow the spec</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3411</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;I think that the implementation of Changing the Active Start Level is different from Spec.&lt;/p&gt;

&lt;p&gt;see:&lt;br/&gt;
OSGi Service Platform Core Specification Release 4, Version 4.3, Figure 8.2 page154&lt;/p&gt;

&lt;p&gt;Move to requested start level R, active level is A, B is a bundle&apos;s start level&lt;/p&gt;

&lt;p&gt;Spec:&lt;br/&gt;
if (A &amp;lt; R) &lt;br/&gt;
  while (A &amp;lt; R) &lt;/p&gt;
{
    A = A + 1
    Start All bundles where B = A
  }

&lt;p&gt;Implementation:&lt;br/&gt;
if (A &amp;lt; R) &lt;br/&gt;
  Start All bundles where B &amp;lt;= R&lt;br/&gt;
A = R&lt;/p&gt;

&lt;p&gt;Similarly, if A &amp;gt; R.&lt;/p&gt;

&lt;p&gt;Javadoc:&lt;br/&gt;
&lt;a href=&quot;http://www.osgi.org/javadoc/r4v43/org/osgi/service/startlevel/StartLevel.html#setStartLevel%28int%29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.osgi.org/javadoc/r4v43/org/osgi/service/startlevel/StartLevel.html#setStartLevel%28int%29&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://www.osgi.org/javadoc/r4v43/org/osgi/framework/startlevel/FrameworkStartLevel.html#setStartLevel(int&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.osgi.org/javadoc/r4v43/org/osgi/framework/startlevel/FrameworkStartLevel.html#setStartLevel(int&lt;/a&gt;, org.osgi.framework.FrameworkListener...)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12548645">FELIX-3411</key>
            <summary>The implementation of org.osgi.service.startlevel.StartLevel#setStartLevel(int) does not follow the spec</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="yasuk">Yasuhiro Kawame</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 Mar 2012 11:09:47 +0000</created>
                <updated>Tue, 5 Mar 2013 14:10:51 +0000</updated>
                            <resolved>Tue, 5 Mar 2013 14:10:51 +0000</resolved>
                                    <version>framework-4.0.2</version>
                                    <fixVersion>framework-4.2.0</fixVersion>
                    <fixVersion>framework-4.2.1</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13241348" author="rickhall" created="Thu, 29 Mar 2012 16:11:28 +0000"  >&lt;p&gt;Your description of the framework&apos;s behavior is not correct. If you check Felix.setActiveStartLevel() you can see that it takes a sorted snapshot of the existing bundles:&lt;/p&gt;

&lt;p&gt;                    // Get a sorted snapshot of all installed bundles&lt;br/&gt;
                    // to be processed during the start level change.&lt;br/&gt;
                    // We also snapshot the start level here, since it&lt;br/&gt;
                    // may change and we don&apos;t want to consider any&lt;br/&gt;
                    // changes since they will be queued for the start&lt;br/&gt;
                    // level thread.&lt;br/&gt;
                    bundles = getBundles();&lt;br/&gt;
                    for (Bundle b : bundles)&lt;/p&gt;
                    {
                        m_startLevelBundles.add(
                            new StartLevelTuple(
                                (BundleImpl) b,
                                ((BundleImpl) b).getStartLevel(
                                    getInitialBundleStartLevel())));
                    }

&lt;p&gt;It then processes this list (which is sorted by bundle start level and then bundle ID) in forward or reverse order depending on whether it is raising or lowering:&lt;/p&gt;

&lt;p&gt;                    if (lowering)&lt;/p&gt;
                    {
                        tuple = m_startLevelBundles.last();
                    }
&lt;p&gt;                    else&lt;/p&gt;
                    {
                        tuple = m_startLevelBundles.first();
                    }

&lt;p&gt;And for each bundle processed in order it counts up or down the framework&apos;s current active start level depending upon whether we are lowering or raising, e.g.:&lt;/p&gt;

&lt;p&gt;                            // Count up the active start level.&lt;br/&gt;
                            if (m_activeStartLevel != tuple.m_level)&lt;/p&gt;
                            {
                                m_activeStartLevel = tuple.m_level;
                            }

&lt;p&gt;So, while it is possible there are some bugs, it definitely is attempting to implement the spec as described. There is the potential for a bundle to be started/stopped out of order if you are manipulating its state at the same time the start level operation is going on, but it is a small window and will still end up in the proper state.&lt;/p&gt;

&lt;p&gt;At any rate, if you experience any bugs, would it be possible to create an example to demonstrate the issue? Thanks.&lt;/p&gt;</comment>
                            <comment id="13244085" author="yasuk" created="Mon, 2 Apr 2012 09:18:37 +0000"  >&lt;p&gt;Thank you for your comment.&lt;/p&gt;

&lt;p&gt;I am testing exception handling using wrong bundles. &lt;/p&gt;

&lt;p&gt;Conditions:&lt;br/&gt;
  B_N is the bundle start level.&lt;br/&gt;
  A is an active start level.&lt;br/&gt;
  R is a requested start level.&lt;/p&gt;

&lt;p&gt;  Bundle_01:&lt;br/&gt;
    B_01 = 1&lt;/p&gt;

&lt;p&gt;  Bundle_02:&lt;br/&gt;
    B_02 = 3 &lt;br/&gt;
    This BundleActivator#start method throws an exception.&lt;/p&gt;

&lt;p&gt;  Bundle_03:&lt;br/&gt;
    B_03 = 5&lt;/p&gt;

&lt;p&gt;STEP1. ActiveStartLevel = 1.&lt;br/&gt;
   (A = 1)&lt;br/&gt;
   Spec and Implementation:&lt;br/&gt;
     Bundle_01 is ACTIVE.&lt;/p&gt;

&lt;p&gt;STEP2. setStartLevel(3)&lt;br/&gt;
   (A = 1, R = 3)&lt;br/&gt;
   Spec and Implementation:&lt;br/&gt;
     Bundle_02 throws a BundleException.&lt;/p&gt;

&lt;p&gt;STEP3. setStartLevel(5)&lt;br/&gt;
   (A = 3, R = 5)&lt;br/&gt;
  Spec:&lt;br/&gt;
     Bundle_03 is ACTIVE.&lt;/p&gt;

&lt;p&gt;  Implementation:&lt;br/&gt;
     Bundle_02 throws a BundleException.&lt;br/&gt;
     Bundle_03 is ACTIVE.&lt;/p&gt;

&lt;p&gt;  This point is different from Spec.&lt;/p&gt;

&lt;p&gt;Best regards.&lt;/p&gt;</comment>
                            <comment id="13244411" author="rickhall" created="Mon, 2 Apr 2012 18:25:33 +0000"  >&lt;p&gt;So, is your issue that the framework should not attempt to start Bundle_02 again?&lt;/p&gt;

&lt;p&gt;Perhaps so, but your original issue description didn&apos;t says something completely different. If the extra attempt to start the bundle is your concern, we should edit this issue to more clearly state that fact. Let me know. Thanks.&lt;/p&gt;</comment>
                            <comment id="13248389" author="yasuk" created="Fri, 6 Apr 2012 14:24:58 +0000"  >&lt;p&gt;&amp;gt; So, is your issue that the framework should not attempt to start Bundle_02 again? &lt;br/&gt;
Yes. I do not want Bundle_02 to be started again.&lt;/p&gt;

&lt;p&gt;But my issue report is not clearly. So I would like to organize and edit this issue.&lt;/p&gt;

&lt;p&gt;Many thanks&lt;/p&gt;</comment>
                            <comment id="13249976" author="rickhall" created="Mon, 9 Apr 2012 17:18:38 +0000"  >&lt;p&gt;I have looked at the spec, but I don&apos;t see where it says bundles should be blacklisted if they throw an exception during a start level change. Could you point me to where you believe the spec says this?&lt;/p&gt;</comment>
                            <comment id="13253119" author="yasuk" created="Fri, 13 Apr 2012 05:18:02 +0000"  >&lt;p&gt;I won&apos;t say about blacklisting.&lt;/p&gt;

&lt;p&gt;I believe that the implementation is different from the the following spec.&lt;br/&gt;
R4.3 spec&lt;br/&gt;
8.3.1 Changing the Active Start Level&lt;/p&gt;

&lt;p&gt;If the requested start level is higher than the active start level, the Framework must increase the start &lt;br/&gt;
level by one and then start all bundles that meet the following criteria:&lt;br/&gt;
&#8226; Bundles that are persistently marked started, and&lt;br/&gt;
&#8226; Bundles that have a bundle start level equal to the new active start level.&lt;br/&gt;
The Framework continues increasing the active start level and starting the appropriate bundles until &lt;br/&gt;
it has started all bundles with a bundle start level that equals the requested start level.&lt;/p&gt;


&lt;p&gt;For example, assume the active start level is 3 and the Framework is requested to transition to start level &lt;br/&gt;
5. &lt;br/&gt;
I think the framework must attempt to start all bundles that have a bundle start level 4 or 5.&lt;br/&gt;
So I think Bundle_02 must not be started.&lt;/p&gt;</comment>
                            <comment id="13253359" author="rickhall" created="Fri, 13 Apr 2012 13:15:30 +0000"  >&lt;p&gt;Ok, I think I understand your point now, you think it should not attempt to restart bundles that are below the current active start level (effectively blacklisting them). I&apos;m not sure this is what the spec means. I&apos;ll investigate.&lt;/p&gt;</comment>
                            <comment id="13569081" author="rickhall" created="Fri, 1 Feb 2013 21:06:51 +0000"  >&lt;p&gt;I just committed a patch to modify start level handling such that it will not attempt to restart bundles in lower start levels if the previously didn&apos;t start when setting a new, higher framework start level. Please close if satisfied.&lt;/p&gt;</comment>
                            <comment id="13572054" author="yasuk" created="Wed, 6 Feb 2013 01:46:12 +0000"  >&lt;p&gt;Thanks for update.&lt;/p&gt;

&lt;p&gt;I would like to you correct one point.&lt;br/&gt;
When bundles that have a bundle start level equal to the previous active start level, I think their Bundle#start() is not called.&lt;/p&gt;

&lt;p&gt;&amp;#8212; src/main/java/org/apache/felix/framework/Felix.java&lt;br/&gt;
+++ src/main/java/org/apache/felix/framework/Felix.java&lt;br/&gt;
@@ -1267,7 +1267,8 @@&lt;br/&gt;
                         if (!isLowering&lt;br/&gt;
                             &amp;amp;&amp;amp; (((tuple.m_bundle.getPersistentState() == Bundle.ACTIVE)&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; (tuple.m_bundle.getPersistentState() == Bundle.STARTING))
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&amp;amp;&amp;amp; (tuple.m_level == m_activeStartLevel)))&lt;br/&gt;
+                                &amp;amp;&amp;amp; (tuple.m_level == m_activeStartLevel)&lt;br/&gt;
+                                &amp;amp;&amp;amp; ((tuple.m_level &amp;gt;= low) &amp;amp;&amp;amp; (tuple.m_level &amp;lt;= high))))&lt;br/&gt;
                         {&lt;br/&gt;
                             try&lt;br/&gt;
                             {&lt;/li&gt;
&lt;/ul&gt;
&lt;/th&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;@@ -1290,7 +1291,8 @@&lt;br/&gt;
                         else if (isLowering&lt;br/&gt;
                             &amp;amp;&amp;amp; (((tuple.m_bundle.getState() == Bundle.ACTIVE)&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; (tuple.m_bundle.getState() == Bundle.STARTING))
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&amp;amp;&amp;amp; (tuple.m_level == m_activeStartLevel)))&lt;br/&gt;
+                                &amp;amp;&amp;amp; (tuple.m_level == m_activeStartLevel)&lt;br/&gt;
+                                &amp;amp;&amp;amp; ((tuple.m_level &amp;gt;= low) &amp;amp;&amp;amp; (tuple.m_level &amp;lt;= high))))&lt;br/&gt;
                         {&lt;br/&gt;
                             try&lt;br/&gt;
                             {&lt;/li&gt;
&lt;/ul&gt;
&lt;/th&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="13572441" author="rickhall" created="Wed, 6 Feb 2013 14:23:40 +0000"  >&lt;p&gt;It is not clear to me that your patch does anything.&lt;/p&gt;

&lt;p&gt;Currently, we calculate low and high and then we either increment active level from low to high or decrement it from high to low depending on whether we are raising or lowering, respectively. At each step, we start (or stop) bundles whose start level matches the given step.&lt;/p&gt;

&lt;p&gt;In other words, m_activeStartLevel steps from low to high (or high to low) inclusive, so there is no need to verify that tuple.m_level is between low and high because if it is equal to m_activeStartLevel then by definition it is between low and high (inclusive).&lt;/p&gt;

&lt;p&gt;Unless I&apos;m missing something.&lt;/p&gt;</comment>
                            <comment id="13573401" author="yasuk" created="Thu, 7 Feb 2013 11:34:12 +0000"  >&lt;p&gt;I watched behavior in detail.&lt;/p&gt;

&lt;p&gt;When change the framework start level,though there is m_activeStartLevel outside a range, there is a possibility that BundleActivator#start() is called.&lt;/p&gt;

&lt;p&gt;I did a test in the following steps:&lt;br/&gt;
=====&lt;br/&gt;
step 1&lt;br/&gt;
  set the Framework Start Level = 1&lt;br/&gt;
  BundleA : Bundle Start Level = 3 &amp;lt;-- INSTALLED&#65288;This bundle&apos;s BundleActivator#start() throws an exception. &#65289;&lt;br/&gt;
  BundleB : Bundle Start Level = 5 &amp;lt;-- INSTALLED&lt;/p&gt;

&lt;p&gt;step 2&lt;br/&gt;
  Call the BundleA#start().&lt;br/&gt;
  Call the BundleB#start().&lt;/p&gt;

&lt;p&gt;  PersistentState is ACTIVE.&lt;/p&gt;

&lt;p&gt;step 3&lt;br/&gt;
  Set the Framework Start Level = 3.&lt;/p&gt;

&lt;p&gt;  BundleA throws Exception. &amp;lt;-- RESOLVED&lt;/p&gt;

&lt;p&gt;step 4&lt;br/&gt;
  Set the Framework Start Level = 5.&lt;/p&gt;

&lt;p&gt;  m_activeStartLevel = 3&lt;br/&gt;
  low = 4&lt;br/&gt;
  high = 5&lt;/p&gt;

&lt;p&gt;&amp;lt; loop process &amp;gt;&lt;br/&gt;
step 4-1&lt;br/&gt;
  StartLevelTuple &amp;lt;-- BundleA&lt;/p&gt;

&lt;p&gt;  ((tuple.m_level &amp;gt;= low) &amp;amp;&amp;amp; (tuple.m_level &amp;lt;= high)) is false.&lt;/p&gt;

&lt;p&gt;  m_activeStartLevel is still 3.&lt;/p&gt;

&lt;p&gt;  (((tuple.m_bundle.getPersistentState() == Bundle.ACTIVE)&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; (tuple.m_bundle.getPersistentState() == Bundle.STARTING))&lt;br/&gt;
   &amp;amp;&amp;amp; (tuple.m_level == m_activeStartLevel)) is true.&lt;/th&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;  Call startBundle().&lt;br/&gt;
  the BundleA throws Exception. &amp;lt;-- I do not want to call this bundle&apos;s BundleActivator#start().&lt;/p&gt;

&lt;p&gt;step 4-2&lt;br/&gt;
  StartLevelTuple &amp;lt;-- BundleB&lt;/p&gt;

&lt;p&gt;  ((tuple.m_level &amp;gt;= low) &amp;amp;&amp;amp; (tuple.m_level &amp;lt;= high)) is true.&lt;br/&gt;
  m_activeStartLevel is changed 5.&lt;/p&gt;

&lt;p&gt;  (((tuple.m_bundle.getPersistentState() == Bundle.ACTIVE)&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; (tuple.m_bundle.getPersistentState() == Bundle.STARTING))&lt;br/&gt;
   &amp;amp;&amp;amp; (tuple.m_level == m_activeStartLevel)) is true.&lt;/th&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;  Call startBundle().&lt;br/&gt;
  the BundleB is ACTIVE.&lt;br/&gt;
======&lt;/p&gt;

&lt;p&gt;Best regards.&lt;/p&gt;</comment>
                            <comment id="13573413" author="karlpauls" created="Thu, 7 Feb 2013 12:04:23 +0000"  >&lt;p&gt;I think you are right. &lt;/p&gt;

&lt;p&gt;When richard and I where discussing this we where assuming that m_activeStartLevel must be in-between low and high but as you point out, it doesn&apos;t have to be &amp;#8211; good catch. &lt;/p&gt;

&lt;p&gt;It looks to me like we&apos;d have to set &lt;/p&gt;

&lt;p&gt;m_activeStartLevel= isLowering ? high : low;&lt;/p&gt;

&lt;p&gt;initially. &lt;/p&gt;</comment>
                            <comment id="13573533" author="rickhall" created="Thu, 7 Feb 2013 14:26:32 +0000"  >&lt;p&gt;Right, now I see it too. And I agree with Karl&apos;s suggestion, we need to cause the active start level to take the first step into the low/high range before we start pulling off bundles and testing them. Thanks a lot for looking closely at this!&lt;/p&gt;</comment>
                            <comment id="13573540" author="rickhall" created="Thu, 7 Feb 2013 14:33:45 +0000"  >&lt;p&gt;Ok, I committed a patch to fix the active start level initialization bug. I&apos;ll assign this to 4.4.0 for now, but we&apos;ll try to do a 4.2.1 if/when any other minor bug reports come in. Please close if satisfied. Thanks!&lt;/p&gt;</comment>
                            <comment id="13574166" author="yasuk" created="Fri, 8 Feb 2013 02:05:50 +0000"  >&lt;p&gt;Thank you very much indeed for your patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>233742</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 41 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1avan:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>271536</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>