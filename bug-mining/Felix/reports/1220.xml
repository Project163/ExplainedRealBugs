<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:21:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-2791] NPE in getStartLevel due to race condition</title>
                <link>https://issues.apache.org/jira/browse/FELIX-2791</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;We are using FileInstall 3.1.4 and one of our user is seeing the following exception repeated in the directory watcher main loop continuously:&lt;/p&gt;

&lt;p&gt;java.lang.NullPointerException&lt;br/&gt;
        at org.apache.felix.fileinstall.internal.FileInstall.getStartLevel(FileInstall.java:283)&lt;br/&gt;
        at org.apache.felix.fileinstall.internal.FileInstall.getStartLevel(FileInstall.java:276)&lt;br/&gt;
        at org.apache.felix.fileinstall.internal.DirectoryWatcher.run(DirectoryWatcher.java:237)&lt;br/&gt;
In main loop, we have serious trouble: java.lang.NullPointerException&lt;/p&gt;

&lt;p&gt;NPE comes from FileInstall.java:283, which looks like this:&lt;br/&gt;
            return (StartLevel) startLevel.waitForService(timeout);&lt;/p&gt;

&lt;p&gt;It looks like a concurrency bug to me in FileInstall. The only explanation that I have so far is that in the target environment, code is getting reordered and hence directory watcher thread is spwaned before startLevel is initialzed.. Since startLevel is not declared volatile, nor is it accessed from a synchronized block, DirectoryWatcher thread continues to see the stale value.&lt;/p&gt;

&lt;p&gt;So, I suggest we change startLevel to a volatile field. Any comments?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12496021">FELIX-2791</key>
            <summary>NPE in getStartLevel due to race condition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sahoo">Sanjeeb Kumar Sahoo</assignee>
                                    <reporter username="sahoo">Sanjeeb Kumar Sahoo</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 Jan 2011 16:11:21 +0000</created>
                <updated>Tue, 17 Mar 2015 07:01:37 +0000</updated>
                            <resolved>Fri, 21 Jan 2011 01:08:43 +0000</resolved>
                                    <version>fileinstall-3.1.4</version>
                                    <fixVersion>fileinstall-3.1.6</fixVersion>
                                    <component>File Install</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12983880" author="gnt" created="Wed, 19 Jan 2011 20:46:11 +0000"  >&lt;p&gt;I don&apos;t think the code is reordered, but the ConfigAdminSupport  is actually registered before the startLevel service tracker, so if it is called synchronously during the registration , the DirectoryWatcher thread might be started before the tracker is created.&lt;/p&gt;

&lt;p&gt;So I&apos;d rather suggest that the trackers are created and started before the ConfigAdmin support, so maybe move the ConfigAdminSupport creation at the end of the FileInstall#start() method.&lt;/p&gt;

&lt;p&gt;Could you give that a try and see if it avoids the exception?&lt;/p&gt;</comment>
                            <comment id="12984040" author="sahoo" created="Thu, 20 Jan 2011 06:34:42 +0000"  >&lt;p&gt;Assigning to myself&lt;/p&gt;</comment>
                            <comment id="12984041" author="sahoo" created="Thu, 20 Jan 2011 06:37:51 +0000"  >&lt;p&gt;PFA a patch that solves the issue. It introduces a barrier and a flag to make sure watcher threads don&apos;t run until fileinstall has finished initialisation. Please review if you want to, as I plan to commit and make a new release of fileinstall ASAP. Thanks.&lt;/p&gt;</comment>
                            <comment id="12984066" author="sahoo" created="Thu, 20 Jan 2011 08:10:03 +0000"  >&lt;p&gt;PFA a patch that solves the issue. It introduces a barrier and a flag to make sure watcher threads don&apos;t run until fileinstall has finished initialisation. Unlike the previous patch, this one resets the boolean initialised field in stop(). Please review if you want to, as I plan to commit and make a new release of fileinstall ASAP. Thanks. &lt;/p&gt;</comment>
                            <comment id="12984069" author="sahoo" created="Thu, 20 Jan 2011 08:11:47 +0000"  >&lt;p&gt;I now see why the watcher thread can be started because of configuration event. In any case, introducing a barrier is better way to ensure that watcher threads are not active before fileinstall is initialized. So, I am committing the patch.&lt;/p&gt;

&lt;p&gt;Sending        fileinstall/src/main/java/org/apache/felix/fileinstall/internal/DirectoryWatcher.java&lt;br/&gt;
Sending        fileinstall/src/main/java/org/apache/felix/fileinstall/internal/FileInstall.java&lt;br/&gt;
Transmitting file data ..&lt;br/&gt;
Committed revision 1061240.&lt;/p&gt;</comment>
                            <comment id="12984515" author="sahoo" created="Fri, 21 Jan 2011 01:08:43 +0000"  >&lt;p&gt;Fixed in 1061240&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12468836" name="patch.txt" size="2489" author="sahoo" created="Thu, 20 Jan 2011 08:10:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40420</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 44 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0aqc7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>60540</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>