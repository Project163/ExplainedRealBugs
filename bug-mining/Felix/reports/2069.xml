<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:51:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-4313] Bad synchronization in scr where a lock is held while ungetting a service</title>
                <link>https://issues.apache.org/jira/browse/FELIX-4313</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;The problem is located in DependencyManeger$SingleStaticCustomizer.close()&lt;/p&gt;</description>
                <environment></environment>
        <key id="12678984">FELIX-4313</key>
            <summary>Bad synchronization in scr where a lock is held while ungetting a service</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gnodet">Guillaume Nodet</assignee>
                                    <reporter username="gnodet">Guillaume Nodet</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Nov 2013 10:13:14 +0000</created>
                <updated>Wed, 6 Aug 2014 02:21:50 +0000</updated>
                            <resolved>Wed, 20 Nov 2013 09:55:07 +0000</resolved>
                                    <version>scr-1.8.0</version>
                                    <fixVersion>scr-1.8.2</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13821151" author="gnt" created="Wed, 13 Nov 2013 10:13:49 +0000"  >&lt;p&gt;Proposed patch (under test)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/scr/src/main/java/org/apache/felix/scr/impl/manager/DependencyManager.java b/scr/src/main/java/org/apache/felix/scr/impl/manager/DependencyManager.java
index 99a87cf..c78f69b 100644
--- a/scr/src/main/java/org/apache/felix/scr/impl/manager/DependencyManager.java
+++ b/scr/src/main/java/org/apache/felix/scr/impl/manager/DependencyManager.java
@@ -979,15 +979,17 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DependencyManager&amp;lt;S, T&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Reference
 
         &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close()
         {
+            RefPair&amp;lt;T&amp;gt; ref;
             &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; ( getTracker().tracked() )
             {
-                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( refPair != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; )
-                {
-                    ungetService( refPair );
-                }
+                ref = refPair;
                 refPair = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
-                getTracker().deactivate();
             }
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( ref != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; )
+            {
+                ungetService( ref );
+            }
+            getTracker().deactivate();
         }
 
         &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Collection&amp;lt;RefPair&amp;lt;T&amp;gt;&amp;gt; getRefs( AtomicInteger trackingCount )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13821548" author="djencks" created="Wed, 13 Nov 2013 17:20:51 +0000"  >&lt;p&gt;I&apos;m pretty sure the getTracker().deactivate() needs to be in the synchronized block.  I think moving the ungetService out might be OK.&lt;/p&gt;</comment>
                            <comment id="13822236" author="gnt" created="Thu, 14 Nov 2013 07:38:38 +0000"  >&lt;p&gt;All the other implementations of AbstractCustomizer do not hold any lock while calling getTracker().deactivate(), so if a lock is needed, we&apos;d have to fix them all.&lt;br/&gt;
In addition, the getTracker() and deactivate() methods seems thread safe at first glance, as they access variables flagged as volatile and the deactivate method has itself an internal synchronization block.  It follows the same pattern as lots of other methods in the ServiceTracker, i.e. get the volatile tracked object, check for null, and process the real call while holding a lock on this object.&lt;/p&gt;</comment>
                            <comment id="13825213" author="gnt" created="Mon, 18 Nov 2013 09:21:00 +0000"  >&lt;p&gt;I still don&apos;t think deactivate needs to be synchronized, however I&apos;ve hit the following NPEs, which seems to indicate that the m_tracker property can be null while the code doesn&apos;t really support it.  &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR: Bundle org.fusesource.fabric.fabric-git [80] EventDispatcher: Error during dispatch. (java.lang.NullPointerException)
java.lang.NullPointerException
	at org.apache.felix.scr.impl.manager.DependencyManager$MultipleDynamicCustomizer.prebind(DependencyManager.java:376)
	at org.apache.felix.scr.impl.manager.DependencyManager.prebind(DependencyManager.java:1392)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.collectDependencies(AbstractComponentManager.java:1099)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.getServiceInternal(SingleComponentManager.java:804)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.activateInternal(AbstractComponentManager.java:827)
	at org.apache.felix.scr.impl.manager.DependencyManager$SingleStaticCustomizer.addedService(DependencyManager.java:907)
	at org.apache.felix.scr.impl.manager.DependencyManager$SingleStaticCustomizer.addedService(DependencyManager.java:871)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.customizerAdded(ServiceTracker.java:1477)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.customizerAdded(ServiceTracker.java:1398)
	at org.apache.felix.scr.impl.manager.ServiceTracker$AbstractTracked.trackAdding(ServiceTracker.java:1210)
	at org.apache.felix.scr.impl.manager.ServiceTracker$AbstractTracked.track(ServiceTracker.java:1148)


ERROR: Bundle org.fusesource.fabric.fabric-zookeeper [48] EventDispatcher: Error during dispatch. (java.lang.NullPointerException)
java.lang.NullPointerException
	at org.apache.felix.scr.impl.manager.DependencyManager$SingleStaticCustomizer.prebind(DependencyManager.java:954)
	at org.apache.felix.scr.impl.manager.DependencyManager.prebind(DependencyManager.java:1392)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.collectDependencies(AbstractComponentManager.java:1099)
	at org.apache.felix.scr.impl.manager.SingleComponentManager.getServiceInternal(SingleComponentManager.java:804)
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.activateInternal(AbstractComponentManager.java:827)
	at org.apache.felix.scr.impl.manager.DependencyManager$SingleStaticCustomizer.addedService(DependencyManager.java:907)
	at org.apache.felix.scr.impl.manager.DependencyManager$SingleStaticCustomizer.addedService(DependencyManager.java:871)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.customizerAdded(ServiceTracker.java:1477)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.customizerAdded(ServiceTracker.java:1398)
	at org.apache.felix.scr.impl.manager.ServiceTracker$AbstractTracked.trackAdding(ServiceTracker.java:1210)
	at org.apache.felix.scr.impl.manager.ServiceTracker$AbstractTracked.track(ServiceTracker.java:1148)
	at org.apache.felix.scr.impl.manager.ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:1429)
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:934)
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:795)
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:544)
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4666)
	at org.apache.felix.framework.Felix.registerService(Felix.java:3674)
	at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:347)
	at org.apache.felix.framework.BundleContextImpl.registerService(BundleContextImpl.java:320)
	at org.apache.felix.cm.impl.ConfigurationManager.start(ConfigurationManager.java:318)
	at org.apache.felix.framework.util.SecureAction.startActivator(SecureAction.java:645)
	at org.apache.felix.framework.Felix.doActivateBundle(Felix.java:2387)
	at org.apache.felix.framework.Felix$7.call(Felix.java:2325)
	at org.apache.felix.framework.Felix$6.call(Felix.java:2208)
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)
	at java.util.concurrent.FutureTask.run(FutureTask.java:166)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:722)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13825225" author="djencks" created="Mon, 18 Nov 2013 09:43:47 +0000"  >&lt;p&gt;I&apos;ll look into this.  Can you tell if the dependency managers that are experiencing the NPEs are &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;optional&lt;/li&gt;
	&lt;li&gt;&quot;after&quot; the SingleStatic reference that causes the activation?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13825609" author="djencks" created="Mon, 18 Nov 2013 18:48:11 +0000"  >&lt;p&gt;My theory about what is causing this would be fixed by the following patch:&lt;/p&gt;

&lt;p&gt;diff --git a/scr/src/main/java/org/apache/felix/scr/impl/manager/DependencyManager.java b/scr/src/main/java/org/apache/felix/scr/impl/manager/DependencyManager&lt;br/&gt;
index 99a87cf..87f846c 100644&lt;br/&gt;
&amp;#8212; a/scr/src/main/java/org/apache/felix/scr/impl/manager/DependencyManager.java&lt;br/&gt;
+++ b/scr/src/main/java/org/apache/felix/scr/impl/manager/DependencyManager.java&lt;br/&gt;
@@ -165,12 +165,16 @@ public class DependencyManager&amp;lt;S, T&amp;gt; implements Reference&lt;/p&gt;

&lt;p&gt;         public boolean isSatisfied()&lt;br/&gt;
         {&lt;br/&gt;
+            ServiceTracker&amp;lt;T, RefPair&amp;lt;T&amp;gt;&amp;gt; tracker = getTracker();&lt;br/&gt;
+            if ( tracker == null)&lt;br/&gt;
+            &lt;/p&gt;
{
+                return false;
+            }
&lt;p&gt;             if (isOptional())&lt;/p&gt;
             {
                 return true;
             }            
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ServiceTracker&amp;lt;T, RefPair&amp;lt;T&amp;gt;&amp;gt; tracker = getTracker();&lt;/li&gt;
	&lt;li&gt;return !(tracker == null) &amp;amp;&amp;amp; !tracker.isEmpty();&lt;br/&gt;
+            return !tracker.isEmpty();&lt;br/&gt;
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         protected ServiceTracker&amp;lt;T, RefPair&amp;lt;T&amp;gt;&amp;gt; getTracker()&lt;/p&gt;


&lt;p&gt;I think we need to prevent any attempt to activate until all the m_trackers are set.  Can you see if this fixes the problem?&lt;/p&gt;</comment>
                            <comment id="13827078" author="djencks" created="Tue, 19 Nov 2013 23:18:02 +0000"  >&lt;p&gt;I opened &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-4322&quot; title=&quot;[DS] Prevent activation attempts until all dependency managers are set up with trackers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-4322&quot;&gt;&lt;del&gt;FELIX-4322&lt;/del&gt;&lt;/a&gt; for this NPE and plan to commit the patch soon.&lt;/p&gt;</comment>
                            <comment id="13827495" author="gnt" created="Wed, 20 Nov 2013 09:53:24 +0000"  >&lt;p&gt;Also raised &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-4325&quot; title=&quot;[DS] Synchronization issue when activating component&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-4325&quot;&gt;&lt;del&gt;FELIX-4325&lt;/del&gt;&lt;/a&gt; which I&apos;ve fixed. I&apos;ll close this one.&lt;/p&gt;</comment>
                            <comment id="13827496" author="gnt" created="Wed, 20 Nov 2013 09:55:07 +0000"  >&lt;p&gt;Committing to &lt;a href=&quot;https://svn.apache.org/repos/asf/felix/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/felix/trunk&lt;/a&gt; ...&lt;br/&gt;
	M	scr/src/main/java/org/apache/felix/scr/impl/manager/DependencyManager.java&lt;br/&gt;
Committed r1543745&lt;/p&gt;</comment>
                            <comment id="14087145" author="djencks" created="Wed, 6 Aug 2014 02:21:50 +0000"  >&lt;p&gt;closing remaining 1.8.2 resolved issues&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12680059">FELIX-4322</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12680235">FELIX-4325</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>358349</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 16 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1prwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>358639</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>