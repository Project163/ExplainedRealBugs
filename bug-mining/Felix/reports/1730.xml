<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:46:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3754] Services registered from within the activate method may not be bound</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3754</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;The Sling POST Servlet registers a number of services in the activate method and expects these services to be bound to itself. With SCR 1.6.0 this worked because each component instance had its dependency managers configured with its component instance.&lt;/p&gt;

&lt;p&gt;As of SCR 1.6.2 the DependencyManager instances are shared amongst all component instances and thus don&apos;t have a reference to the component instances. Instead actually bind, unbind and update services the DependencyManager instances call the respective component manager which then dispatches to the component instances.&lt;/p&gt;

&lt;p&gt;At the point in time when the activate method is called (in the ImmediateComponentManager.createComponentInstance method) the actual component instance is not &quot;registered&quot; with the component manager yet and thus a bind call while the activate method is called cannot be satisfied.&lt;/p&gt;

&lt;p&gt;To fix this, the component instance must be &quot;registered&quot; with the component manager before calling the activate method. If the activate method fails, the instance must of course be &quot;unregistered&quot; again.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12615977">FELIX-3754</key>
            <summary>Services registered from within the activate method may not be bound</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fmeschbe">Felix Meschberger</assignee>
                                    <reporter username="fmeschbe">Felix Meschberger</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Nov 2012 23:23:46 +0000</created>
                <updated>Thu, 4 Sep 2014 08:04:09 +0000</updated>
                            <resolved>Fri, 16 Nov 2012 06:56:54 +0000</resolved>
                                    <version>scr-1.6.2</version>
                                    <fixVersion>scr-1.8.0</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13496673" author="fmeschbe" created="Tue, 13 Nov 2012 23:41:16 +0000"  >&lt;p&gt;Fixed with a test case in Rev. 1409028.&lt;/p&gt;</comment>
                            <comment id="13496695" author="djencks" created="Wed, 14 Nov 2012 00:08:36 +0000"  >&lt;p&gt;Doesn&apos;t this use case violate the spec?  A getService call cannot return an instance before it&apos;s activate method has returned.&lt;/p&gt;</comment>
                            <comment id="13496696" author="djencks" created="Wed, 14 Nov 2012 00:09:01 +0000"  >&lt;p&gt;Please convince me that this use case is spec compliant.&lt;/p&gt;</comment>
                            <comment id="13496916" author="fmeschbe" created="Wed, 14 Nov 2012 07:25:21 +0000"  >&lt;p&gt;This is not about getService. This is what happens:&lt;/p&gt;

&lt;p&gt;  Component references Service S (0..n, dynamic)&lt;br/&gt;
  Component is activated (activate is called)&lt;br/&gt;
  During activate Service S is registered&lt;br/&gt;
  ServiceEvent for S is sent&lt;br/&gt;
  DependencyManager for Component gets event and tries to bind&lt;br/&gt;
  Since the DependencyManager does not know the component instance yet, it cannot bind&lt;br/&gt;
  ServiceEvent handling terminates&lt;br/&gt;
  Component terminates activation&lt;/p&gt;

&lt;p&gt;At the end Service S registered from the Component&apos;s activation method is never bound to the Component. This is certainly not spec compliant.&lt;/p&gt;

&lt;p&gt;See the Sling POST Servlet &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; for an example.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://svn.apache.org/repos/asf/sling/trunk/bundles/servlets/post/src/main/java/org/apache/sling/servlets/post/impl/SlingPostServlet.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/sling/trunk/bundles/servlets/post/src/main/java/org/apache/sling/servlets/post/impl/SlingPostServlet.java&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13497295" author="djencks" created="Wed, 14 Nov 2012 18:09:59 +0000"  >&lt;p&gt;OK, now I see what you want.  I agree the behavior you want should work.  However your current implementation is unsatisfactory because it does expose the implementation object to getService before activate returns.&lt;/p&gt;</comment>
                            <comment id="13497859" author="fmeschbe" created="Thu, 15 Nov 2012 08:58:51 +0000"  >&lt;p&gt;Yes, but this gets tricky to solve, I would assume.&lt;/p&gt;

&lt;p&gt;In the simple immediate or delayed component use case we could just introduce another field, something like &quot;tmpImplementationObject&quot; which is considered by the ImmediateComponentManager.bind/unbind/update methods.&lt;/p&gt;

&lt;p&gt;Its getting more complicated for the service factory component case where more than one instance may exist and be &quot;in creation&quot;. So we would have a tmpImplentationObjects set for the bind/unbind/update methods ?&lt;/p&gt;

&lt;p&gt;Will try to build a patch&lt;/p&gt;</comment>
                            <comment id="13498051" author="fmeschbe" created="Thu, 15 Nov 2012 14:42:31 +0000"  >&lt;p&gt;Proposed improvement: Instead of really setting the component instances, they are placed in a temporary field. If activation succeeds, they are moved to the correct location. Otherwise they are removed again.&lt;/p&gt;

&lt;p&gt;WDYT?&lt;/p&gt;</comment>
                            <comment id="13498493" author="djencks" created="Fri, 16 Nov 2012 00:52:17 +0000"  >&lt;p&gt;The patch looks OK to me, thanks!&lt;/p&gt;</comment>
                            <comment id="13498638" author="fmeschbe" created="Fri, 16 Nov 2012 06:40:00 +0000"  >&lt;p&gt;Thanks for the feedback. I have aapplied the patch in Rev. 1410211&lt;/p&gt;</comment>
                            <comment id="13498643" author="fmeschbe" created="Fri, 16 Nov 2012 06:56:54 +0000"  >&lt;p&gt;Our testcases and the OSGi CT still pass, so this can be resolved.&lt;/p&gt;</comment>
                            <comment id="13618262" author="djencks" created="Sun, 31 Mar 2013 06:34:40 +0000"  >&lt;p&gt;I found a related problem in &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-4006&quot; title=&quot;[DS] While disposing a component, it&amp;#39;s possible to unbind a reference that wasn&amp;#39;t bound.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-4006&quot;&gt;&lt;del&gt;FELIX-4006&lt;/del&gt;&lt;/a&gt; when a component is being disposed.  Thinking about this some more I don&apos;t think that any special treatment of being-created implementation objects is needed for ServiceFactoryComponentManager because the service registry will only be calling the service factory once for each bundle, and hence once for each component.  Since there are no immediate service factory components we don&apos;t have to worry about getService accessing an under-construction object in this case.&lt;/p&gt;

&lt;p&gt;I&apos;m considering a state flag for immediate/delayed component manager since it may make some other things simpler.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12616030">SLING-2663</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12648654">SLING-2876</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12553655" name="FELIX-3754-improved.patch" size="8538" author="fmeschbe" created="Thu, 15 Nov 2012 14:42:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>257583</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 34 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0k3dz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>115366</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>