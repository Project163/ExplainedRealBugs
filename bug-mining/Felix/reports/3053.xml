<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:13:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5995] HttpService HttpServiceController should stop whiteboardManager before httpServicefactory</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5995</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;The HttpServiceController does in the register method start the httpServiceFactory and then the whiteboardManager. In the unregister method, it does stop the httpServiceFactory and then the whiteboardManager. That creates a problem as the whiteboardManager needs a started httpServiceFactory when services come in. &lt;/p&gt;

&lt;p&gt;The fix should be simple, we should stop the whiteboardManager before we stop the httpServiceFactory.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13202061">FELIX-5995</key>
            <summary>HttpService HttpServiceController should stop whiteboardManager before httpServicefactory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="karlpauls">Karl Pauls</assignee>
                                    <reporter username="karlpauls">Karl Pauls</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Dec 2018 17:52:24 +0000</created>
                <updated>Fri, 1 Mar 2019 14:13:53 +0000</updated>
                            <resolved>Tue, 26 Feb 2019 13:04:57 +0000</resolved>
                                    <version>http.jetty-4.0.6</version>
                    <version>http.base-4.0.4</version>
                    <version>http.bridge-4.0.4</version>
                                    <fixVersion>http.base-4.0.6</fixVersion>
                    <fixVersion>http.jetty-4.0.8</fixVersion>
                    <fixVersion>http.bridge-4.0.6</fixVersion>
                                    <component>HTTP Service</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="16707592" author="karlpauls" created="Mon, 3 Dec 2018 17:53:49 +0000"  >&lt;p&gt;Done in r1848078.&lt;/p&gt;</comment>
                            <comment id="16777062" author="cziegeler" created="Mon, 25 Feb 2019 16:21:03 +0000"  >&lt;p&gt;This breaks the integration tests, when the jetty bundle is stopped, the servlets are not properly destroyed&lt;/p&gt;</comment>
                            <comment id="16777591" author="cziegeler" created="Tue, 26 Feb 2019 05:40:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kpauls&quot; class=&quot;user-hover&quot; rel=&quot;kpauls&quot;&gt;kpauls&lt;/a&gt; I assume you&apos;ve experienced exceptions on shutdown, Can you add the stacktrace to this issue?&lt;/p&gt;</comment>
                            <comment id="16777787" author="karlpauls" created="Tue, 26 Feb 2019 10:16:32 +0000"  >&lt;p&gt;Right, there was an NPE sometimes. It looked like this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[FelixStartLevel] org.apache.felix.http.jetty [ServiceReference 114 from bundle 62 : org.apache.sling.startupfilter:0.0.1.Rev1764485 ref=[javax.servlet.Filter] properties={objectClass=[javax.servlet.Filter], osgi.http.whiteboard.context.select=(osgi.http.whiteboard.context.name=*), osgi.http.whiteboard.filter.pattern=/, service.bundleid=62, service.id=114, service.ranking=36864, service.scope=singleton, sling.filter.scope=REQUEST}] Exception while registering Filter service (java.lang.NullPointerException)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, I still think that it makes sense to have the whiteboard be stopped before the httpServiceFactory. Unfortunately, there is this special case namely, that services registered with the http service directly are not stopped because the whiteboard provides the default context and they end-up being in that context. The stop of the whiteboard does clean-out the context(s) but only destroys the services that it published itself. For the one added via the http service it doesn&apos;t call destroy even so it releases the context - hence, afterwords, when the http service is stopped it doesn&apos;t find the service in the context anymore and it doesn&apos;t destroy it either. &lt;/p&gt;

&lt;p&gt;Oh well, I&apos;m not familiar enough with the code to fix this - feel free to rollback the change for now and maybe push this issue out.&lt;/p&gt;</comment>
                            <comment id="16777888" author="cziegeler" created="Tue, 26 Feb 2019 13:04:57 +0000"  >&lt;p&gt;Actually after revisiting the javadocs for HttpService.unregister I think the test case is wrong. The javadoc says:&lt;br/&gt;
If the bundle which performed the registration is stopped or otherwise&lt;br/&gt;
 &quot;unget&quot;s the Http Service without calling &lt;/p&gt;
{@link #unregister(String)}
&lt;p&gt; then Http Service must automatically unregister the registration.&lt;br/&gt;
 However, if the registration was for a servlet, the &lt;/p&gt;
{@code destroy}
&lt;p&gt; method of the servlet will not be called in this case since the bundle&lt;br/&gt;
 may be stopped&lt;/p&gt;

&lt;p&gt;So when the jetty bundle is stopped, destroy must not be called. I&apos;ve corrected the test case&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 38 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s0148o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>