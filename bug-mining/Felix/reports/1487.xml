<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:33:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3345] Concurrency problems in SCR</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3345</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;We&apos;ve been encountering several exceptions thrown intermittently from DS.  They generally look like ungetting service on a disposed-of SCR BundleComponentActivator, ComponentManager, or DependencyManager.  There may be two threads trying to shut down the same bundles at the same time.  I&apos;m not sure how to investigate the root cause or if this kind of behavior is expected.  The SCR code generally doesn&apos;t look very thread safe.  It&apos;s easy to &quot;fix&quot; the specific problems we see by adding more checks to the SCR code so the NPEs are avoided, or attempted use of closed bundle contexts are caught and ignored.  I&apos;d be happy to keep looking into this but could use some hints about what should be happening.  Unless someone can come up with a better explanation and fix it would be great meanwhile to patch the code to avoid throwing the exceptions.&lt;/p&gt;

&lt;p&gt;Here are some of the typical stack traces we see:&lt;/p&gt;

&lt;p&gt;Stack Dump = org.osgi.framework.ServiceException: Exception in org.apache.felix.scr.impl.manager.DelayedComponentManager.ungetService()&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.ServiceUse.releaseService(ServiceUse.java:287)&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.ServiceRegistrationImpl.releaseService(ServiceRegistrationImpl.java:562)&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.ServiceRegistry.releaseServicesInUse(ServiceRegistry.java:665)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleContextImpl.close(BundleContextImpl.java:91)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleHost.stopWorker(BundleHost.java:514)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.AbstractBundle.suspend(AbstractBundle.java:565)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.Framework.suspendBundle(Framework.java:1161)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.StartLevelManager.decFWSL(StartLevelManager.java:595)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.StartLevelManager.doSetStartLevel(StartLevelManager.java:257)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.StartLevelManager.shutdown(StartLevelManager.java:215)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.InternalSystemBundle.suspend(InternalSystemBundle.java:284)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.Framework.shutdown(Framework.java:691)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.Framework.close(Framework.java:598)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.InternalSystemBundle$1.run(InternalSystemBundle.java:261)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:680)&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
	at org.apache.felix.scr.impl.BundleComponentActivator.log(BundleComponentActivator.java:614)&lt;br/&gt;
	at org.apache.felix.scr.impl.BundleComponentActivator.log(BundleComponentActivator.java:589)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.log(AbstractComponentManager.java:633)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$State.log(AbstractComponentManager.java:1000)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$State.ungetService(AbstractComponentManager.java:964)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DelayedComponentManager.ungetService(DelayedComponentManager.java:114)&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.ServiceUse$3.run(ServiceUse.java:277)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.ServiceUse.releaseService(ServiceUse.java:275)&lt;br/&gt;
	... 14 more&lt;/p&gt;


&lt;p&gt;Stack Dump = org.osgi.framework.ServiceException: Exception in org.apache.felix.scr.impl.manager.DelayedComponentManager.ungetService()&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.ServiceUse.releaseService(ServiceUse.java:287)&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.ServiceRegistrationImpl.releaseService(ServiceRegistrationImpl.java:562)&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:245)&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.ServiceRegistry.unregisterServices(ServiceRegistry.java:635)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleContextImpl.close(BundleContextImpl.java:88)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleHost.stopWorker(BundleHost.java:514)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.AbstractBundle.suspend(AbstractBundle.java:565)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.Framework.suspendBundle(Framework.java:1161)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.StartLevelManager.decFWSL(StartLevelManager.java:595)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.StartLevelManager.doSetStartLevel(StartLevelManager.java:257)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.StartLevelManager.shutdown(StartLevelManager.java:215)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.InternalSystemBundle.suspend(InternalSystemBundle.java:284)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.Framework.shutdown(Framework.java:691)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.Framework.close(Framework.java:598)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.InternalSystemBundle$1.run(InternalSystemBundle.java:261)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:680)&lt;br/&gt;
Caused by: java.lang.IllegalStateException: BundleContext is no longer valid&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleContextImpl.checkValid(BundleContextImpl.java:931)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleContextImpl.ungetService(BundleContextImpl.java:634)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.ungetService(DependencyManager.java:819)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.unbind(DependencyManager.java:1000)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DependencyManager.close(DependencyManager.java:880)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.ImmediateComponentManager.disposeImplementationObject(ImmediateComponentManager.java:268)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.ImmediateComponentManager.deleteComponent(ImmediateComponentManager.java:135)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DelayedComponentManager.deleteComponent(DelayedComponentManager.java:67)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$Active.ungetService(AbstractComponentManager.java:1266)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.DelayedComponentManager.ungetService(DelayedComponentManager.java:114)&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.ServiceUse$3.run(ServiceUse.java:277)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at org.eclipse.osgi.internal.serviceregistry.ServiceUse.releaseService(ServiceUse.java:275)&lt;br/&gt;
	... 15 more&lt;/p&gt;


&lt;p&gt;-------&lt;br/&gt;
This one is from &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3307&quot; title=&quot;NPE in DependencyManager.invokeBindMethod&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3307&quot;&gt;&lt;del&gt;FELIX-3307&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;java.lang.NullPointerException &lt;br/&gt;
at org.apache.felix.scr.impl.manager.DependencyManager.invokeBindMethod(DependencyManager.java:1028) &lt;br/&gt;
at org.apache.felix.scr.impl.manager.DependencyManager.serviceAdded(DependencyManager.java:308) &lt;br/&gt;
at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:170) &lt;br/&gt;
at org.eclipse.osgi.internal.serviceregistry.FilteredServiceListener.serviceChanged(FilteredServiceListener.java:104) &lt;br/&gt;
at org.eclipse.osgi.framework.internal.core.BundleContextImpl.dispatchEvent(BundleContextImpl.java:861) &lt;br/&gt;
at org.eclipse.osgi.framework.eventmgr.EventManager.dispatchEvent(EventManager.java:230) &lt;br/&gt;
at org.eclipse.osgi.framework.eventmgr.ListenerQueue.dispatchEventSynchronous(ListenerQueue.java:148) &lt;br/&gt;
at org.eclipse.osgi.internal.serviceregistry.ServiceRegistry.publishServiceEventPrivileged(ServiceRegistry.java:819) &lt;br/&gt;
at org.eclipse.osgi.internal.serviceregistry.ServiceRegistry.publishServiceEvent(ServiceRegistry.java:771) &lt;br/&gt;
at org.eclipse.osgi.internal.serviceregistry.ServiceRegistrationImpl.register(ServiceRegistrationImpl.java:130) &lt;br/&gt;
at org.eclipse.osgi.internal.serviceregistry.ServiceRegistry.registerService(ServiceRegistry.java:214) &lt;br/&gt;
at org.eclipse.osgi.framework.internal.core.BundleContextImpl.registerService(BundleContextImpl.java:433) &lt;br/&gt;
at org.eclipse.osgi.framework.internal.core.BundleContextImpl.registerService(BundleContextImpl.java:451) &lt;br/&gt;
at org.eclipse.osgi.framework.internal.core.BundleContextImpl.registerService(BundleContextImpl.java:950) &lt;/p&gt;</description>
                <environment></environment>
        <key id="12542044">FELIX-3345</key>
            <summary>Concurrency problems in SCR</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fmeschbe">Felix Meschberger</assignee>
                                    <reporter username="djencks">David Jencks</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Feb 2012 22:49:17 +0000</created>
                <updated>Sat, 1 Aug 2015 11:25:29 +0000</updated>
                            <resolved>Wed, 28 Nov 2012 23:37:30 +0000</resolved>
                                    <version> scr-1.6.0</version>
                                    <fixVersion>scr-1.6.2</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13204989" author="djencks" created="Thu, 9 Feb 2012 22:57:21 +0000"  >&lt;p&gt;Detect and avoid error conditions, without much attempt to understand their cause.&lt;/p&gt;</comment>
                            <comment id="13205009" author="djencks" created="Thu, 9 Feb 2012 23:08:15 +0000"  >&lt;p&gt;Here are a couple more stack traces:&lt;/p&gt;

&lt;p&gt;Stack Dump = java.lang.IllegalStateException: BundleContext is no longer valid&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleContextImpl.checkValid(BundleContextImpl.java:931)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleContextImpl.ungetService(BundleContextImpl.java:634)&lt;br/&gt;
	at org.apache.felix.scr.impl.config.ConfigurationSupport.configureComponentHolder(ConfigurationSupport.java:112)&lt;br/&gt;
	at org.apache.felix.scr.impl.ComponentRegistry.createComponentHolder(ComponentRegistry.java:437)&lt;br/&gt;
	at org.apache.felix.scr.impl.BundleComponentActivator.loadDescriptor(BundleComponentActivator.java:232)&lt;br/&gt;
	at org.apache.felix.scr.impl.BundleComponentActivator.initialize(BundleComponentActivator.java:147)&lt;br/&gt;
	at org.apache.felix.scr.impl.BundleComponentActivator.&amp;lt;init&amp;gt;(BundleComponentActivator.java:111)&lt;br/&gt;
	at org.apache.felix.scr.impl.Activator.loadComponents(Activator.java:274)&lt;br/&gt;
	at org.apache.felix.scr.impl.Activator.bundleChanged(Activator.java:192)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleContextImpl.dispatchEvent(BundleContextImpl.java:847)&lt;br/&gt;
	at org.eclipse.osgi.framework.eventmgr.EventManager.dispatchEvent(EventManager.java:230)&lt;br/&gt;
	at org.eclipse.osgi.framework.eventmgr.ListenerQueue.dispatchEventSynchronous(ListenerQueue.java:148)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.Framework.publishBundleEventPrivileged(Framework.java:1523)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.Framework.publishBundleEvent(Framework.java:1459)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.Framework.publishBundleEvent(Framework.java:1454)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleHost.startWorker(BundleHost.java:391)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.AbstractBundle.start(AbstractBundle.java:299)&lt;br/&gt;
//some management code is trying to start a bundle here&lt;/p&gt;

&lt;p&gt;Stack Dump = org.osgi.framework.BundleException: Exception in org.apache.felix.scr.impl.Activator.stop() of bundle org.apache.felix.scr.&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleContextImpl.stop(BundleContextImpl.java:791)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleHost.stopWorker(BundleHost.java:510)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.AbstractBundle.suspend(AbstractBundle.java:565)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.Framework.suspendBundle(Framework.java:1161)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.StartLevelManager.decFWSL(StartLevelManager.java:595)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.StartLevelManager.doSetStartLevel(StartLevelManager.java:257)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.StartLevelManager.shutdown(StartLevelManager.java:215)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.InternalSystemBundle.suspend(InternalSystemBundle.java:284)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.Framework.shutdown(Framework.java:691)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.Framework.close(Framework.java:598)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.InternalSystemBundle$1.run(InternalSystemBundle.java:261)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:680)&lt;br/&gt;
Caused by: java.lang.IllegalStateException: BundleContext is no longer valid&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleContextImpl.checkValid(BundleContextImpl.java:931)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleContextImpl.getBundle(BundleContextImpl.java:121)&lt;br/&gt;
	at org.apache.felix.scr.impl.Activator.disposeAllComponents(Activator.java:355)&lt;br/&gt;
	at org.apache.felix.scr.impl.Activator.stop(Activator.java:142)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleContextImpl$2.run(BundleContextImpl.java:771)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at org.eclipse.osgi.framework.internal.core.BundleContextImpl.stop(BundleContextImpl.java:764)&lt;br/&gt;
	... 11 more&lt;/p&gt;</comment>
                            <comment id="13205028" author="djencks" created="Thu, 9 Feb 2012 23:22:16 +0000"  >&lt;p&gt;This patch includes the previous one and works around the 2 additional problems&lt;/p&gt;</comment>
                            <comment id="13213432" author="djencks" created="Wed, 22 Feb 2012 07:53:05 +0000"  >&lt;p&gt;I&apos;ve finally managed to reproduce a similar problem in a test.  The attached includes a lot of logging additions to scr, ignores the existing integration tests, and adds one that demonstrates a similar problem.  It also always fails for unrelated reasons.  The interesting stack trace is &lt;/p&gt;

&lt;p&gt;java.lang.NullPointerException: No log service&lt;br/&gt;
        at org.apache.felix.scr.impl.BundleComponentActivator.log(BundleComponentActivator.java:623)&lt;br/&gt;
        at org.apache.felix.scr.impl.BundleComponentActivator.log(BundleComponentActivator.java:594)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.log(AbstractComponentManager.java:635)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod$Resolved.invoke(BaseMethod.java:596)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod$NotResolved.invoke(BaseMethod.java:552)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BaseMethod.invoke(BaseMethod.java:476)&lt;br/&gt;
        at org.apache.felix.scr.impl.helper.BindMethod.invoke(BindMethod.java:36)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.invokeUnbindMethod(DependencyManager.java:1142)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.unbind(DependencyManager.java:999)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.close(DependencyManager.java:886)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.ImmediateComponentManager.disposeImplementationObject(ImmediateComponentManager.java:269)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.ImmediateComponentManager.deleteComponent(ImmediateComponentManager.java:135)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager$Satisfied.deactivate(AbstractComponentManager.java:1225)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.deactivateInternal(AbstractComponentManager.java:339)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceRemoved(DependencyManager.java:346)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.DependencyManager.serviceChanged(DependencyManager.java:253)&lt;br/&gt;
        at org.eclipse.osgi.internal.serviceregistry.FilteredServiceListener.serviceChanged(FilteredServiceListener.java:104)&lt;br/&gt;
        at org.eclipse.osgi.framework.internal.core.BundleContextImpl.dispatchEvent(BundleContextImpl.java:861)&lt;br/&gt;
        at org.eclipse.osgi.framework.eventmgr.EventManager.dispatchEvent(EventManager.java:230)&lt;br/&gt;
        at org.eclipse.osgi.framework.eventmgr.ListenerQueue.dispatchEventSynchronous(ListenerQueue.java:148)&lt;br/&gt;
        at org.eclipse.osgi.internal.serviceregistry.ServiceRegistry.publishServiceEventPrivileged(ServiceRegistry.java:819)&lt;br/&gt;
        at org.eclipse.osgi.internal.serviceregistry.ServiceRegistry.publishServiceEvent(ServiceRegistry.java:771)&lt;br/&gt;
        at org.eclipse.osgi.internal.serviceregistry.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:225)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.unregisterComponentService(AbstractComponentManager.java:567)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager$Satisfied.deactivate(AbstractComponentManager.java:1224)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.disposeInternal(AbstractComponentManager.java:360)&lt;br/&gt;
        at org.apache.felix.scr.impl.manager.AbstractComponentManager.dispose(AbstractComponentManager.java:197)&lt;br/&gt;
        at org.apache.felix.scr.impl.config.ImmediateComponentHolder.disposeComponents(ImmediateComponentHolder.java:356)&lt;br/&gt;
        at org.apache.felix.scr.impl.BundleComponentActivator.dispose(BundleComponentActivator.java:312)&lt;br/&gt;
        at org.apache.felix.scr.impl.Activator.disposeComponents(Activator.java:333)&lt;br/&gt;
        at org.apache.felix.scr.impl.Activator.bundleChanged(Activator.java:198)&lt;br/&gt;
        at org.eclipse.osgi.framework.internal.core.BundleContextImpl.dispatchEvent(BundleContextImpl.java:847)&lt;br/&gt;
        at org.eclipse.osgi.framework.eventmgr.EventManager.dispatchEvent(EventManager.java:230)&lt;br/&gt;
        at org.eclipse.osgi.framework.eventmgr.ListenerQueue.dispatchEventSynchronous(ListenerQueue.java:148)&lt;br/&gt;
        at org.eclipse.osgi.framework.internal.core.Framework.publishBundleEventPrivileged(Framework.java:1523)&lt;br/&gt;
        at org.eclipse.osgi.framework.internal.core.Framework.publishBundleEvent(Framework.java:1459)&lt;br/&gt;
        at org.eclipse.osgi.framework.internal.core.Framework.publishBundleEvent(Framework.java:1454)&lt;br/&gt;
        at org.eclipse.osgi.framework.internal.core.BundleHost.stopWorker(BundleHost.java:506)&lt;br/&gt;
        at org.eclipse.osgi.framework.internal.core.AbstractBundle.stop(AbstractBundle.java:464)&lt;br/&gt;
        at org.eclipse.osgi.framework.internal.core.AbstractBundle.stop(AbstractBundle.java:456)&lt;br/&gt;
        at org.apache.felix.scr.integration.concurrency.ConcurrentShutdownTest$Worker.run(ConcurrentShutdownTest.java:185)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:680)&lt;/p&gt;

&lt;p&gt;By messing with the timing I&apos;ve gotten into a state where we&apos;re trying to log on a BundleComponentActivator that has been shut down.  The activity being logged is different, but the NPE is the same.  Admittedly I added the log statement in question....&lt;/p&gt;

&lt;p&gt;The basic scenario is two threads shutting stuff down concurrently, and an unbind method that takes a long time to return.&lt;/p&gt;

&lt;p&gt;bundle A has a service s1&lt;br/&gt;
bundle B has a service s2 with a reference to s1, and an unbind method that takes a long time.&lt;/p&gt;

&lt;p&gt;Stop A in thread 1; the thread gets stuck in unbind of s2.&lt;/p&gt;

&lt;p&gt;Stop B in thread 2; this shuts down B so it&apos;s BundleComponentActivator no longer can log (the NPE).&lt;/p&gt;

&lt;p&gt;If the unbind method in thread 1 now returns, it will try to log in B&apos;s BCA which has no log service tracker.&lt;/p&gt;

&lt;p&gt;If you comment out my added logging statement you get a different NPE.&lt;/p&gt;</comment>
                            <comment id="13214151" author="djencks" created="Thu, 23 Feb 2012 01:04:33 +0000"  >&lt;p&gt;This is the same test but I removed all the stuff that didn&apos;t work.  I had to modify ds logging to always use system.out since I don&apos;t understand how to get it to use pax-logging in the test.&lt;/p&gt;

&lt;p&gt;To be clear, this test is not in a committable form but should provide a way to see a concurrency problem repeatedly.&lt;/p&gt;</comment>
                            <comment id="13220479" author="djencks" created="Thu, 1 Mar 2012 23:23:31 +0000"  >&lt;p&gt;Patch that fixes the underlying NPE from the concurrency test, that we have also run into in production.&lt;/p&gt;</comment>
                            <comment id="13224978" author="fmeschbe" created="Thu, 8 Mar 2012 04:16:14 +0000"  >&lt;p&gt;Thanks for providing the patches. As indicated in &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; I have applied the patches as follows:&lt;/p&gt;

&lt;p&gt;   &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3345&quot; title=&quot;Concurrency problems in SCR&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3345&quot;&gt;&lt;del&gt;FELIX-3345&lt;/del&gt;&lt;/a&gt;-2.diff in Rev. 1298266&lt;br/&gt;
   &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3345&quot; title=&quot;Concurrency problems in SCR&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3345&quot;&gt;&lt;del&gt;FELIX-3345&lt;/del&gt;&lt;/a&gt;-5.diff in Rev. 1298267&lt;/p&gt;

&lt;p&gt;Patch &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3345&quot; title=&quot;Concurrency problems in SCR&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3345&quot;&gt;&lt;del&gt;FELIX-3345&lt;/del&gt;&lt;/a&gt;-6.diff referred to in the message seems to be missing. Doesn&apos;t matter, I&apos;d like to apply the comprehensive test patch as of &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3371&quot; title=&quot;update scr build to recent pax components&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3371&quot;&gt;&lt;del&gt;FELIX-3371&lt;/del&gt;&lt;/a&gt; anyway.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://markmail.org/message/zzf4tjuky6wxm3v2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://markmail.org/message/zzf4tjuky6wxm3v2&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13224986" author="fmeschbe" created="Thu, 8 Mar 2012 04:42:42 +0000"  >&lt;p&gt;What about the patches 3 and 4 ? Should these also be applied ? Are there any differences between them ?&lt;/p&gt;</comment>
                            <comment id="13286576" author="fmeschbe" created="Thu, 31 May 2012 14:00:56 +0000"  >&lt;p&gt;What is the relationship of this issue with &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3456&quot; title=&quot;Component ignores required static service addition when in Activating state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3456&quot;&gt;&lt;del&gt;FELIX-3456&lt;/del&gt;&lt;/a&gt; ?&lt;/p&gt;

&lt;p&gt;Is this still reproducible ?&lt;/p&gt;</comment>
                            <comment id="13506051" author="djencks" created="Wed, 28 Nov 2012 23:37:30 +0000"  >&lt;p&gt;The relevant patches were all applied well before 1.6.2 was released&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12538932">FELIX-3307</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12514042" name="FELIX-3345-2.diff" size="7701" author="djencks" created="Thu, 9 Feb 2012 23:22:16 +0000"/>
                            <attachment id="12515547" name="FELIX-3345-3.diff" size="90421" author="djencks" created="Wed, 22 Feb 2012 07:53:02 +0000"/>
                            <attachment id="12515670" name="FELIX-3345-4.diff" size="87212" author="djencks" created="Thu, 23 Feb 2012 01:04:33 +0000"/>
                            <attachment id="12516753" name="FELIX-3345-5.diff" size="2191" author="djencks" created="Thu, 1 Mar 2012 23:23:31 +0000"/>
                            <attachment id="12514032" name="FELIX-3345.diff" size="5128" author="djencks" created="Thu, 9 Feb 2012 22:57:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>227331</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 51 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i07go7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>41467</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>