<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:59:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5028] ServiceFactory for components might return null</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5028</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;There seems to be an uneven handling of locking/status information in getService/ungetService of the service factory registered by the SingleComponentManager. (I didn&apos;t check the other factories)&lt;br/&gt;
We have a concurrent get/ungetService for the same service. While the unget service uses a lock around decrementing the counter, incrementing the counter and other actions in getService are not using the lock. There is a partial lock there. &lt;br/&gt;
But this can lead to the problem that while the preconditions for getService are still fine, ungetService cleans up which then makes getService to return null.&lt;br/&gt;
We have a huge app where we can reproduce the problem, I&apos;ll try to trim this down to a simple test case.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12863073">FELIX-5028</key>
            <summary>ServiceFactory for components might return null</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cziegeler">Carsten Ziegeler</assignee>
                                    <reporter username="cziegeler">Carsten Ziegeler</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Sep 2015 14:37:55 +0000</created>
                <updated>Thu, 16 Mar 2017 20:32:55 +0000</updated>
                            <resolved>Tue, 15 Sep 2015 12:56:24 +0000</resolved>
                                    <version>scr-2.0.0</version>
                                    <fixVersion>scr-2.0.2</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14739355" author="cziegeler" created="Thu, 10 Sep 2015 18:54:18 +0000"  >&lt;p&gt;I&apos;m not sure, but I think if in SingleComponentManager#getService( Bundle bundle, ServiceRegistration&amp;lt;S&amp;gt; serviceRegistration )&lt;br/&gt;
  the useCount would be increased as a first statement, it would be avoided that the instance and/or the component context are cleaned up through a concurrent ungetService.&lt;br/&gt;
If something fails in getService, we can decrement the counter, and if it gets to zero, clean up.&lt;/p&gt;</comment>
                            <comment id="14740348" author="cziegeler" created="Fri, 11 Sep 2015 07:35:29 +0000"  >&lt;p&gt;This is a simple fix which might solve the problem. Not sure if this should be the final solution&lt;/p&gt;</comment>
                            <comment id="14740999" author="cziegeler" created="Fri, 11 Sep 2015 15:43:37 +0000"  >&lt;p&gt;Actually the patch does not fix the problem - so far I couldn&apos;t come up with a reproducible test case. As the patch does not fix the problem, I&apos;m wondering if the problem we&apos;re hitting is caused by something else.&lt;br/&gt;
Now, what we see is that in some circumstances getService returns null - in our case the component at hand implements two service hooks (EventListenerHook, FindHook), has no references, no activator/deactivaor and is not immediate. On startup of our app we see the NPE; we assume this is because the hooks are get/unget a lot by the framework causing a high concurrency on getService/ungetService.&lt;/p&gt;</comment>
                            <comment id="14745409" author="cziegeler" created="Tue, 15 Sep 2015 12:56:24 +0000"  >&lt;p&gt;I&apos;ve hopefully fixe this in rev 1703178 by increasing the use count on getService and protecting it through the lock. At least manual tests proof that with this in place, the problem is not occuring anymore&lt;/p&gt;</comment>
                            <comment id="14746219" author="pderop" created="Tue, 15 Sep 2015 21:14:54 +0000"  >&lt;p&gt;Carsten,&lt;/p&gt;

&lt;p&gt;I looked at the last commit from rv 1703178 and now it seems that the ungetService() is not checking anymore bad cases where the framework calls ungetService() more than it calls getServices(). So, don&apos;t you think that the following patch would be better:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void ungetService( Bundle bundle, ServiceRegistration&amp;lt;S&amp;gt; serviceRegistration, S o )
    {
        obtainStateLock( );
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
        {
            &lt;span class=&quot;code-comment&quot;&gt;// unget the service instance &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; no bundle is using it
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// any longer unless delayed component instances have to
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// be kept (FELIX-3039).
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// We also check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the useCount does not go below zero (when ungetService is
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// called more times than getService is called).
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (  m_useCount.get() &amp;gt; 0 &amp;amp;&amp;amp; m_useCount.decrementAndGet() == 0 &amp;amp;&amp;amp; !isImmediate() &amp;amp;&amp;amp; !keepInstances() )
            {
                ungetService( );
            }
        }
        &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt;
        {
            releaseStateLock(  );
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14746245" author="cziegeler" created="Tue, 15 Sep 2015 21:24:01 +0000"  >&lt;p&gt;I don&apos;t think this is needed, because this extra check assumes that the framework is wrong&lt;br/&gt;
We could change m_useCount.decrementAndGet() == 0 to m_useCount.decrementAndGet() &amp;lt;= 0 as in this processing of ungetService the count is reset to zero.&lt;br/&gt;
A simple check of m_useCount.get() &amp;gt; 0 &amp;amp;&amp;amp; m_useCount.decrementAndGet() == 0 would catch the situation where the framework calls ungetService more often, but it doesn&apos;t reset the counter to 0, so e.g. if it&apos;s -1 , the next call to getService gets it to 0 - which would be wrong&lt;br/&gt;
Forgot to mention that the previous code did check the count and then decremented it outside of the state lock, so while the count would have been higher than zero, it might have got to zero by the time decrement is called, getting it to -1&lt;/p&gt;</comment>
                            <comment id="14746309" author="pderop" created="Tue, 15 Sep 2015 21:44:51 +0000"  >&lt;p&gt;ok, I see your point; let&apos;s forget about this extra check.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12923993">FELIX-5151</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 10 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2k00n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>