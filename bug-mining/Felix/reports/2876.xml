<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:10:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5618] Cycles in DS depending on bundle order</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5618</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;Following test case:&lt;/p&gt;

&lt;p&gt;       top.jar: Top @Reference volatile List&amp;lt;Bottom&amp;gt;&lt;br/&gt;
       bottom.jar: Bottom @Reference Top&lt;/p&gt;

&lt;p&gt;In SCR 2.0.2:&lt;br/&gt;
      top.jar, bottom.jar -&amp;gt; OK, see trace&lt;br/&gt;
           new Top()&lt;br/&gt;
           Top.activate()&lt;br/&gt;
           new Bottom()&lt;br/&gt;
           Bottom.top=&amp;lt;top&amp;gt;&lt;br/&gt;
           Bottom.activate()&lt;br/&gt;
          Top.bottom +=&amp;lt;bottom&amp;gt;&lt;/p&gt;

&lt;p&gt;      bottom.jar, top.jar -&amp;gt; FAILS but recovers&lt;br/&gt;
          &lt;span class=&quot;error&quot;&gt;&amp;#91;osgi.enroute.examples.concurrency.cycle.bottom.Bottom(1)&amp;#93;&lt;/span&gt; &lt;br/&gt;
          Circular reference detected, getService returning null&lt;br/&gt;
          new Top()&lt;br/&gt;
          Top.activate()&lt;br/&gt;
          new Bottom()&lt;br/&gt;
          Bottom.top=&amp;lt;top&amp;gt;&lt;br/&gt;
          Bottom.activate()&lt;br/&gt;
          Top.bottom +=&amp;lt;bottom&amp;gt;&lt;/p&gt;

&lt;p&gt;In SCR 2.0.4 and later&lt;/p&gt;

&lt;p&gt;     top.jar,bottom.jar -&amp;gt; OK&lt;/p&gt;

&lt;p&gt;           new Top()&lt;br/&gt;
           Top.activate()&lt;br/&gt;
           new Bottom()&lt;br/&gt;
           Bottom.top=&amp;lt;top&amp;gt;&lt;br/&gt;
           Bottom.activate()&lt;br/&gt;
           Top.bottom +=&amp;lt;bottom&amp;gt;&lt;/p&gt;

&lt;p&gt;      bottom.jar, top.jar -&amp;gt; FAILS and DOES NOT RECOVER!&lt;br/&gt;
           new Bottom()&lt;br/&gt;
           new Top()&lt;br/&gt;
           Top.activate()&lt;br/&gt;
           new Bottom()&lt;/p&gt;

&lt;p&gt;The Bottom component never gets added to Top. This is a very serious problem for reliable systems. I see this behaviour on 2.0.4, 2.0.6, and 2.0.8&lt;/p&gt;

&lt;p&gt;----------&lt;br/&gt;
I&apos;ve traced the cycle problem in 2.0.2. What happens is:&lt;br/&gt;
1) The Bottom configuration is started. There is no Top, so it is not satisfied&lt;br/&gt;
2) The Top configuration is started. It is satisfied since it can live with 0 Bottoms. &lt;br/&gt;
3) The top configuration registers Top&lt;br/&gt;
4) The bottom configuration sees a Top and initiates Bottom&lt;br/&gt;
5) The bottom configuration gets Top (which is under construction)&lt;br/&gt;
6) The top configuration looks at its dependencies&lt;br/&gt;
7) The top configuration sees there is a Bottom now and tries to get it&lt;br/&gt;
8) The bottom factory is called again on the same thread and blows up&lt;/p&gt;

&lt;p&gt;I am not sure what happens in 2.0.4 and later but it does look scary that Bottom is now never added to the Top.&lt;/p&gt;

&lt;p&gt;---- Fix&lt;br/&gt;
I tried to do the activation in a background thread that but that failed. I think the cycle should be detected and and de Top should not get its dynamic dependencies after the activate method returned. But, just a guess, this is complicated stuff.&lt;/p&gt;

&lt;p&gt;---- Workaround&lt;br/&gt;
The workaround is to not let Top register as a service but manually register it at the end of the activate method. Since the service is then already initialized and registered, the Bottom will not get activated until the Top is done.&lt;/p&gt;

&lt;p&gt;There is a bnd workspace that consistently shows this output.&lt;br/&gt;
&lt;a href=&quot;https://github.com/pkriens/felix.scr.cycle&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pkriens/felix.scr.cycle&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve added 4 log files. 2.0.4 and 2.0.8 seem to act very similar&lt;/p&gt;</description>
                <environment>MacOS + Windows + Linux</environment>
        <key id="13065461">FELIX-5618</key>
            <summary>Cycles in DS depending on bundle order</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10003">Resolved</resolution>
                                        <assignee username="djencks">David Jencks</assignee>
                                    <reporter username="pkriens">Peter Kriens</reporter>
                        <labels>
                    </labels>
                <created>Thu, 20 Apr 2017 09:50:30 +0000</created>
                <updated>Mon, 29 Jan 2018 15:54:53 +0000</updated>
                            <resolved>Thu, 25 Jan 2018 18:18:00 +0000</resolved>
                                                    <fixVersion>scr-2.0.14</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15977117" author="djencks" created="Thu, 20 Apr 2017 17:35:25 +0000"  >&lt;p&gt;Without looking at this in great detail, it looks like these scenarios are very similar to the CircularReferenceTest test_A11_B0n_delayed_B_first and test_A11_B0n_delayed_A_first tests which AFAIK have both been passing.  The differences are:&lt;/p&gt;

&lt;p&gt;1. the junit tests use the event strategy rather than the field strategy.  I guess we should provide versions of all these tests using the field injection strategy.&lt;/p&gt;

&lt;p&gt;2. the junit tests have all the components in one bundle and use enable/disable rather than starting the bundles in a certain order.  Replicating the multiple bundles in the existing felix test environment would be considerably more difficult than (1).  &lt;/p&gt;</comment>
                            <comment id="15977762" author="djencks" created="Thu, 20 Apr 2017 23:12:26 +0000"  >&lt;p&gt;I&apos;d forgotten a bit about how the circular refs test was set up, but on the other hand your description of your code is quite misleading or what&apos;s in the git repo isn&apos;t what you are talking about.  The code in your linked git repo uses the event strategy, is that what you are actually testing or are your earlier hints that you are using the field strategy more correct?&lt;/p&gt;

&lt;p&gt;I locally modified one of the existing circular tests (1-1 static, 0-n dynamic) to start the two components in both orders, and they both appear to work when the components are in the same bundle.&lt;/p&gt;

&lt;p&gt;I don&apos;t see how one is supposed to run a test using the code in your git repo, could you explain what you did to demonstrate the problem?&lt;/p&gt;</comment>
                            <comment id="15978205" author="pkriens" created="Fri, 21 Apr 2017 07:16:48 +0000"  >&lt;p&gt;If you checkout the workspace in bndtools then double click the bnd.bnd file in the osgi.enrout.examples.concurrency.cycle project, select the Run tab, click on the Run or Debug icon right top of the window.&lt;/p&gt;

&lt;p&gt;You can switch the order of the bundles by going to the Source tab and reorder the -runbundles list.&lt;/p&gt;

&lt;p&gt;The problem is both in the field and event strategy. I switch to the even strategy to show the ordering with sysouts.&lt;/p&gt;

&lt;p&gt;If you want it with different versions you can change the -runbundles. Extra dependencies can be added via &lt;a href=&quot;https://github.com/pkriens/felix.scr.cycle/blob/master/cnf/central.xml&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pkriens/felix.scr.cycle/blob/master/cnf/central.xml&lt;/a&gt;, which is a normal POM. In bndtools, you need to trigger the update by modifying build.bnd to kick it. (Add a space or so)&lt;/p&gt;</comment>
                            <comment id="15980313" author="djencks" created="Sun, 23 Apr 2017 07:07:13 +0000"  >&lt;p&gt;Thanks for the info.  Using bndtools for this makes me want to use if for ds &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I have a solution for the immediate problem you identified.  In addition, I noticed that if Bottom is delayed it doesn&apos;t work in 2.0.2. I have a solution for this too.&lt;/p&gt;</comment>
                            <comment id="15980355" author="pkriens" created="Sun, 23 Apr 2017 10:35:49 +0000"  >&lt;p&gt;That would be great!&lt;/p&gt;

&lt;p&gt;And about bndtools, what&apos;s stopping you? We now fully support using a POM as repository.&lt;/p&gt;</comment>
                            <comment id="15983797" author="djencks" created="Tue, 25 Apr 2017 23:11:58 +0000"  >&lt;p&gt;I&apos;m proposing this solution: &lt;a href=&quot;https://github.com/djencks/felix/commit/764c6636cef9d02dbb869ec6e29f1754d43700da&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/djencks/felix/commit/764c6636cef9d02dbb869ec6e29f1754d43700da&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This is after a proposed code reformat.  I might be able to figure out how to apply the change to current trunk instead if necessary.&lt;/p&gt;</comment>
                            <comment id="16040897" author="pkriens" created="Wed, 7 Jun 2017 13:40:09 +0000"  >&lt;p&gt;Where are we with this?&lt;/p&gt;</comment>
                            <comment id="16107063" author="pkriens" created="Mon, 31 Jul 2017 09:56:38 +0000"  >&lt;p&gt;Help! Any progress here?&lt;/p&gt;</comment>
                            <comment id="16108097" author="djencks" created="Mon, 31 Jul 2017 22:36:38 +0000"  >&lt;p&gt;Fixed in trunk r1803592.&lt;/p&gt;</comment>
                            <comment id="16108131" author="djencks" created="Mon, 31 Jul 2017 23:09:31 +0000"  >&lt;p&gt;Fixed in r7 copy with r1803595.  I haven&apos;t been able to get eclipse to open the r7 branch so I have no idea if there have been related changes that might affect this behavior, but the tests all pass.&lt;/p&gt;</comment>
                            <comment id="16108502" author="pkriens" created="Tue, 1 Aug 2017 07:25:16 +0000"  >&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="16339309" author="pkriens" created="Thu, 25 Jan 2018 14:46:43 +0000"  >&lt;p&gt;I just verified that this is&#160;&lt;em&gt;not&lt;/em&gt; fixed in 2.0.14 yet. Is there any way we can get this fix in 2.0.14?&lt;/p&gt;

&lt;p&gt;If not, are there snapshots of a fixed version or do I need to build it myself?&lt;/p&gt;</comment>
                            <comment id="16339329" author="karlpauls" created="Thu, 25 Jan 2018 14:58:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkriens&quot; class=&quot;user-hover&quot; rel=&quot;pkriens&quot;&gt;pkriens&lt;/a&gt;, 2.0.14 has been released so that can&apos;t be changed anymore. I doubt that it is fixed in a snapshot if it wasn&apos;t fixed in 2.0.14 - unless you are talking about the upcomming R7 version. That you would need to build yourself to be sure but you could try with the SNAPSHOT first (IIRC, that would be 2.1.0-SNAPSHOT).&lt;/p&gt;</comment>
                            <comment id="16339340" author="pkriens" created="Thu, 25 Jan 2018 15:03:51 +0000"  >&lt;p&gt;I mean the main trunk. David says something about r7 copy? There are no snapshots build for that?&lt;/p&gt;</comment>
                            <comment id="16339354" author="karlpauls" created="Thu, 25 Jan 2018 15:12:09 +0000"  >&lt;p&gt;We have the scr folder in the root which is the old/stable version (just released as 2.0.14) and we have the one in osgi-r7/scr which is the implementation for the upcomming R7 version. That one we don&apos;t release right now - hence, it is only available as 2.1.0-SNAPSHOT. However, I think the latest SNAPSHOT available via maven is pretty old - hence, you are better of building it yourself.&lt;/p&gt;</comment>
                            <comment id="16339435" author="cziegeler" created="Thu, 25 Jan 2018 16:12:57 +0000"  >&lt;p&gt;I&apos;m confused, from the commit log for 2.0.12, I see:&lt;/p&gt;

&lt;p&gt;r1803592 | djencks | 2017-07-31 18:35:59 -0400 (Mo, 31 Jul 2017) | 1 line&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5618&quot; title=&quot;Cycles in DS depending on bundle order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5618&quot;&gt;&lt;del&gt;FELIX-5618&lt;/del&gt;&lt;/a&gt; Fix circular ref handling&lt;/p&gt;</comment>
                            <comment id="16339441" author="pkriens" created="Thu, 25 Jan 2018 16:16:08 +0000"  >&lt;p&gt;I&#160;can confirm that the bug is not fixed in 2.0.14 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The original workspace at &lt;a href=&quot;https://github.com/pkriens/felix.scr.cycle&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pkriens/felix.scr.cycle&lt;/a&gt;&#160;still shows the problem depending on the bundle order.&lt;/p&gt;</comment>
                            <comment id="16339445" author="pkriens" created="Thu, 25 Jan 2018 16:18:13 +0000"  >&lt;p&gt;Problem unfortunately still present in 2.0.14 after testing on &lt;a href=&quot;https://github.com/pkriens/felix.scr.cycle&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pkriens/felix.scr.cycle&lt;/a&gt;&#160;with the latest release of SCR. I did update the dependency to 2.0.14.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Sorry &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16339587" author="cziegeler" created="Thu, 25 Jan 2018 18:18:00 +0000"  >&lt;p&gt;I&apos;m closing this one again as actually there has been work for the mentioned release, unfortunately it&apos;s still not fixed, therefore I created the clone where we can continue the discussion&lt;/p&gt;</comment>
                            <comment id="16343390" author="pkriens" created="Mon, 29 Jan 2018 14:17:44 +0000"  >&lt;p&gt;Where is the clone?&lt;/p&gt;</comment>
                            <comment id="16343531" author="cziegeler" created="Mon, 29 Jan 2018 15:54:53 +0000"  >&lt;p&gt;You&apos;ll find it in the links section, its &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5780&quot; title=&quot;Cycles in DS depending on bundle order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5780&quot;&gt;&lt;del&gt;FELIX-5780&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="13133786">FELIX-5780</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12864226" name="scr-cycle-2.0.2-bottom-top.txt" size="11693" author="pkriens" created="Thu, 20 Apr 2017 09:50:30 +0000"/>
                            <attachment id="12864225" name="scr-cycle-2.0.2-top-bottom.txt" size="3467" author="pkriens" created="Thu, 20 Apr 2017 09:50:30 +0000"/>
                            <attachment id="12864227" name="scr-cycle-2.0.6-bottom-top.txt" size="21259" author="pkriens" created="Thu, 20 Apr 2017 09:50:30 +0000"/>
                            <attachment id="12864228" name="scr-cycle-2.0.6-top-bottom.txt" size="3467" author="pkriens" created="Thu, 20 Apr 2017 09:50:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 42 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3duwv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>