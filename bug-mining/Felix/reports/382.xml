<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:09:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-1027] deadlock with felix 1.6.0 ?</title>
                <link>https://issues.apache.org/jira/browse/FELIX-1027</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;I just came across a deadlock with the felix 1.6.0 candidate version for the next fwk version.  &lt;br/&gt;
I have attached to this post the corresponding &quot;kill -QUIT&quot; output.&lt;/p&gt;

&lt;p&gt;Richard, is it really an framework deadlock ? This is strange because I am testing the trunk since one month and never noticed the problem ...&lt;/p&gt;

&lt;p&gt;/pierre&lt;/p&gt;
</description>
                <environment>jdk1.5, linux</environment>
        <key id="12422107">FELIX-1027</key>
            <summary>deadlock with felix 1.6.0 ?</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="pderop">Pierre De Rop</reporter>
                        <labels>
                    </labels>
                <created>Mon, 6 Apr 2009 11:43:27 +0000</created>
                <updated>Thu, 23 Apr 2009 08:49:49 +0000</updated>
                            <resolved>Thu, 23 Apr 2009 08:35:18 +0000</resolved>
                                                    <fixVersion>framework-1.6.1</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12696053" author="mcculls" created="Mon, 6 Apr 2009 12:06:10 +0000"  >&lt;p&gt;This certainly looks like a deadlock - and afaik there was some recent work done in this area which may have introduced this.&lt;br/&gt;
Do you happen to have a reproducible testcase? or even a smallish private testcase you could send to Richard and/or me?&lt;/p&gt;</comment>
                            <comment id="12696056" author="pderop" created="Mon, 6 Apr 2009 12:18:11 +0000"  >&lt;p&gt;The bundles involved in the deadlock are not mine, but using the stacktraces, I think I could try to &lt;br/&gt;
reproduce this issue. I&apos;ll let you know asap;&lt;/p&gt;
</comment>
                            <comment id="12696060" author="mcculls" created="Mon, 6 Apr 2009 12:30:36 +0000"  >&lt;p&gt;I wonder if using another object for the Felix specific locking would solve this (ie. instead of the classloader itself) - at the moment this internal lock is conflicting with the standard classloader lock.&lt;/p&gt;</comment>
                            <comment id="12696061" author="mcculls" created="Mon, 6 Apr 2009 12:38:48 +0000"  >&lt;p&gt;Pierre, could you apply this patch to the current Felix trunk (or the 1.6.0 framework source) to see if it solves your deadlock?&lt;/p&gt;</comment>
                            <comment id="12696073" author="mcculls" created="Mon, 6 Apr 2009 13:16:36 +0000"  >&lt;p&gt;See also:  &lt;a href=&quot;http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4670071&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4670071&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Some deadlocks can happen with OSGi style classloading because of the spurious synchronization on loadClassInternal, so as Karl just pointed out to me you might still get an exception even with this patch - but the timing window should be much narrower...&lt;/p&gt;

&lt;p&gt;( BTW the solution chosen by Sun to support this sort of &apos;parallel class loading&apos; is to use a special API, but I can&apos;t seem to find the exact details at the moment... )&lt;/p&gt;</comment>
                            <comment id="12696085" author="pderop" created="Mon, 6 Apr 2009 13:49:40 +0000"  >&lt;p&gt;Stuarts, &lt;br/&gt;
Thank you for your patch and quick response.&lt;/p&gt;

&lt;p&gt;Now, I have applied your patch but got another dead lock, with a different stacktrace than without your fix (I attached it).&lt;br/&gt;
do you think I am getting the deadlock mentioned by Karl ?&lt;/p&gt;</comment>
                            <comment id="12696102" author="mcculls" created="Mon, 6 Apr 2009 14:28:06 +0000"  >&lt;p&gt;It certainly seems related, because even if you used an unrelated lock object (ie. local to the class) you would still get the second deadlock because of the synchronized loadClassInternal in the JDK ClassLoader code.&lt;/p&gt;

&lt;p&gt;There is an experimental workaround you could try if you use the Sun JDK (or you could perhaps try the IBM JDK):&lt;/p&gt;

&lt;p&gt;    -XX:+UnlockDiagnosticVMOptions -XX:+UnsyncloadClass&lt;/p&gt;

&lt;p&gt;from &lt;a href=&quot;http://underlap.blogspot.com/2006/11/experimental-fix-for-sunbug-4670071.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://underlap.blogspot.com/2006/11/experimental-fix-for-sunbug-4670071.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you could look into introducing a higher-level synchronization into your application code to avoid the situation to begin with (I know, this sucks)&lt;/p&gt;</comment>
                            <comment id="12696104" author="karlpauls" created="Mon, 6 Apr 2009 14:38:55 +0000"  >&lt;p&gt;Sometimes it helps when you check whether you can rearrange your import/export packages. Basically, for this to happen the one need to import from the other. If that is they way you want to structure your bundles then you have to try what Stuart suggests but otherwise, you could see whether you can repackage in a way that avoids this issue. &lt;/p&gt;</comment>
                            <comment id="12696151" author="pderop" created="Mon, 6 Apr 2009 16:13:07 +0000"  >&lt;p&gt;As far as I understand, the issue arises because I use class.forName from my Activators. The first Activator.start() method invokes&lt;br/&gt;
class.forName from the &quot;FelixStartLevel&quot; thread, and the other class.forName is invoked concurrently, from another thread which is &lt;br/&gt;
started by the second activator.&lt;/p&gt;

&lt;p&gt;I am actually struggling with some legacy code which is using Class.forName() ...&lt;br/&gt;
In any case, I think that using Class.ForName is definitely a poor practice in OSGi, and I will try to work around this problem&lt;br/&gt;
by just replacing the Class.forName() with the OSGi Registry ...&lt;/p&gt;

&lt;p&gt;So, if you think there is nothing to fix at all in the framework, may be I should close this fault report ?&lt;/p&gt;



</comment>
                            <comment id="12696214" author="pderop" created="Mon, 6 Apr 2009 19:08:20 +0000"  >&lt;p&gt;Stuart,&lt;br/&gt;
I just tested the &quot; -XX:+UnlockDiagnosticVMOptions -XX:+UnsyncloadClass&quot; options and it sounds to work fine.&lt;/p&gt;

&lt;p&gt;A big thanks !&lt;br/&gt;
(I will close this issue)&lt;/p&gt;
</comment>
                            <comment id="12696216" author="pderop" created="Mon, 6 Apr 2009 19:09:27 +0000"  >&lt;p&gt;issue closed because the JVM options &quot;-XX:+UnlockDiagnosticVMOptions -XX:+UnsyncloadClass&quot; seems to resolve the problem.&lt;/p&gt;</comment>
                            <comment id="12696226" author="pderop" created="Mon, 6 Apr 2009 19:37:52 +0000"  >&lt;p&gt;Stuart, &lt;br/&gt;
I forgot to ask the following:&lt;/p&gt;

&lt;p&gt;1) is it really safe to use UnsyncloadClass with Felix ? I saw that this option is unstable and &quot;calls loadClass unsynchronized. Custom classloader must call VM synchronized for findClass &amp;amp; defineClass&quot; ...&lt;/p&gt;

&lt;p&gt;2) moreover, does the option &quot;UnlockDiagnosticVMOptions&quot; affect jvm performances ?&lt;/p&gt;</comment>
                            <comment id="12696231" author="karlpauls" created="Mon, 6 Apr 2009 20:03:37 +0000"  >&lt;p&gt;In regard to 1, yes it should be save as we do our own (more finegrained locking). Not sure about 2. &lt;/p&gt;</comment>
                            <comment id="12696333" author="mrdon" created="Tue, 7 Apr 2009 01:42:42 +0000"  >&lt;p&gt;That&apos;s great that you can work around it with a set of Sun-specific command line arguments, but that does nothing to help with folks like me that have no control over what JVM the application is deployed on.  I think this issue should be reopened until it is fixed properly in Felix.&lt;/p&gt;</comment>
                            <comment id="12696383" author="mcculls" created="Tue, 7 Apr 2009 03:37:12 +0000"  >&lt;p&gt;@Pierre as Karl said using this switch should be safe because the custom Felix classloader has extra fine-grained locks to protect against collisions - also &quot;UnlockDiagnosticVMOptions&quot; just unlocks additional diagnostic options, to the best of my knowledge it doesn&apos;t affect JVM performance unless you specify further switches (think of it as a safety-catch)&lt;/p&gt;

&lt;p&gt;@Don unfortunately the deadlock in loadClassInternal cannot be fixed in Felix because the JVM can call loadClassInternal directly in certain situations which means that even introducing a global lock in Felix may not help (a global lock would also really hurt performance for everyone), if you look at &lt;a href=&quot;http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4670071&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4670071&lt;/a&gt; this is a long-standing bug in the Sun JVM that can occasionally occur during parallel classloading with any classloader that doesn&apos;t follow the parent-delegation model (the original bug was raised back in 2002 by someone using a custom JBoss classloader)&lt;/p&gt;

&lt;p&gt;Other JVMs (like IBM) don&apos;t have synchronized on loadClassInternal and therefore don&apos;t suffer from this bug - also note from the latest evaluation report on the sunbug, that Sun have finally decided on a different fix which requires custom classloaders requiring parallel classloading to use a special (currently non-standard) API - but this is only available in very recent JDK builds and afaik would require us to use some reflection magic...&lt;/p&gt;

&lt;p&gt;In practice this deadlock only affects applications with parallel classloading involving the same set of classes - because most OSGi applications load their classes during resolution or in the bundle activator, this doesn&apos;t affect them - only a sub-set of applications that use Class.forName, etc. for the same set of classes in different threads at exactly the same time may be affected.&lt;/p&gt;</comment>
                            <comment id="12696903" author="pderop" created="Wed, 8 Apr 2009 06:18:50 +0000"  >&lt;p&gt;I must say I am somewhat worried about this deadlock issue, and may we we should reopen this ticket ?&lt;br/&gt;
Stuard, Karl, I let you re-open it if you think it makes sense.&lt;/p&gt;

&lt;p&gt;Let me explain:&lt;br/&gt;
---------------------&lt;/p&gt;

&lt;p&gt;First of all, I just would like to notice that the problem I am facing here is a story of legacy code which is &lt;br/&gt;
using Class.forName, and I just can&apos;t modify this legacy code in order to replace the Class.forName by anything &lt;br/&gt;
else, like the OSGi registry. Indeed, I could rework the legacy code in order to register class implementations&lt;br/&gt;
inside the OSGi registry, and inject them in client bundles (using iPOJO, SCR, etc ...).&lt;br/&gt;
But the point is: I just can&apos;t modify the code, it&apos;s not mine.&lt;br/&gt;
Morover, I would like to notice that many third party open source libraries (like log4j for instance) rely on&lt;br/&gt;
class.forName, and we can&apos;t ignore this fact ... Think of Log4j, which loads Appenders using Class.forName ...&lt;/p&gt;

&lt;p&gt;So, now, here is my problem: Yesterday, I successfully started my app server with the options&lt;br/&gt;
&quot;UnlockDiagnosticVMOptions/UnsyncloadClass&quot;, without any deadlocks. So far so good. &lt;/p&gt;

&lt;p&gt;Now, I have made a sample code in order to be able to get the problem in a reproducible way .&lt;br/&gt;
My intent here was to make a Junit auto-test and verify that the UnlockDiagnosticVMOptions/UnsyncloadClass &lt;br/&gt;
options really resolves the issue.&lt;/p&gt;

&lt;p&gt;But Unfortunately, the sample code does not reproduce the deadlock.&lt;br/&gt;
However, and this is the point of this issue, when I run my sample code with the &lt;br/&gt;
UnlockDiagnosticVMOptions/UnsyncloadClass, then I get some abnormal ClassNotFoundException&lt;br/&gt;
(and I don&apos;t have them without the mentioned options !)&lt;/p&gt;

&lt;p&gt;I have attached to this post the sample code. May be I did a mistake ? can you look into it, please.&lt;/p&gt;

&lt;p&gt;sample code description:&lt;br/&gt;
-----------------------------------&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The bundle &quot;A&quot; export the package &quot;a&quot; with a class a.A&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The Bundle &quot;B&quot;, when started, fires some threads which perform Class.forName(&quot;a.A&quot;).newInstance()&lt;br/&gt;
  (B does an ugly &quot;DynamicImport-Package: *)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The Bundle &quot;Updater&quot; constantly updates the bundles A,B and refreshes them, using PackageAdmin.refresh(null).&lt;br/&gt;
  Hence, I ensure that wiring is re-done after each updates.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Without, the UnlockDiagnosticVMOptions/UnsyncloadClass, I get the following traces (I have activated&lt;br/&gt;
  felix.log.level=4), and I don&apos;t have any deadlocks (unfortunately ..., well ...):&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;  rm -rf felix-cache/; java -server -jar bin/felix.jar&lt;/p&gt;

&lt;p&gt;  B starting ...&lt;br/&gt;
  DEBUG: DYNAMIC WIRE: 9.0 -&amp;gt; a -&amp;gt; 8.0&lt;br/&gt;
  DEBUG: WIRE: 10.0 -&amp;gt; org.osgi.service.packageadmin -&amp;gt; 0&lt;br/&gt;
  DEBUG: WIRE: 10.0 -&amp;gt; org.osgi.framework -&amp;gt; 0&lt;br/&gt;
  DEBUG: WIRE: 9.0 -&amp;gt; org.osgi.framework -&amp;gt; 0&lt;br/&gt;
  B starting ...&lt;br/&gt;
  DEBUG: DYNAMIC WIRE: 9.0 -&amp;gt; a -&amp;gt; 8.0&lt;br/&gt;
  DEBUG: WIRE: 9.0 -&amp;gt; org.osgi.framework -&amp;gt; 0&lt;br/&gt;
  B starting ...&lt;br/&gt;
  DEBUG: DYNAMIC WIRE: 9.0 -&amp;gt; a -&amp;gt; 8.0&lt;br/&gt;
  DEBUG: WIRE: 9.0 -&amp;gt; org.osgi.framework -&amp;gt; 0&lt;/p&gt;

&lt;p&gt;  etc ...&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;With the -XX options, I then get the following abnormal exceptions:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;  rm -rf felix-cache/; java -server -XX:+UnlockDiagnosticVMOptions -XX:+UnsyncloadClass -jar bin/felix.jar&lt;/p&gt;

&lt;p&gt;  B starting ...&lt;br/&gt;
  DEBUG: DYNAMIC WIRE: 9.0 -&amp;gt; a -&amp;gt; 8.0&lt;br/&gt;
  DEBUG: WIRE: 10.0 -&amp;gt; org.osgi.service.packageadmin -&amp;gt; 0&lt;br/&gt;
  DEBUG: WIRE: 10.0 -&amp;gt; org.osgi.framework -&amp;gt; 0&lt;br/&gt;
  DEBUG: WIRE: 9.0 -&amp;gt; org.osgi.framework -&amp;gt; 0&lt;br/&gt;
  B starting ...&lt;br/&gt;
  DEBUG: DYNAMIC WIRE: 9.0 -&amp;gt; a -&amp;gt; 8.0&lt;br/&gt;
  DEBUG: WIRE: 9.0 -&amp;gt; org.osgi.framework -&amp;gt; 0&lt;br/&gt;
  B starting ...&lt;br/&gt;
  DEBUG: DYNAMIC WIRE: 9.0 -&amp;gt; a -&amp;gt; 8.0&lt;br/&gt;
  java.lang.ClassNotFoundException: *** Package &apos;a&apos; is imported by bundle 9 from bundle 8, but the exported package from bundle 8 does not contain the requested class &apos;a.A&apos;. Please verify that the class name is correct in the importing bundle 9 and/or that the exported package is correctly bundled in 8. ***&lt;br/&gt;
          at org.apache.felix.framework.searchpolicy.ModuleImpl$ModuleClassLoader.loadClass(ModuleImpl.java:1448)&lt;br/&gt;
          at java.lang.ClassLoader.loadClass(ClassLoader.java:251)&lt;br/&gt;
          at java.lang.Class.forName0(Native Method)&lt;br/&gt;
          at java.lang.Class.forName(Class.java:164)&lt;br/&gt;
          at b.Legacy.run(Legacy.java:6)&lt;br/&gt;
          at java.lang.Thread.run(Thread.java:595)&lt;br/&gt;
  Caused by: java.lang.ClassNotFoundException: a.A&lt;br/&gt;
          at org.apache.felix.framework.searchpolicy.ModuleImpl.findClassOrResourceByDelegation(ModuleImpl.java:565)&lt;br/&gt;
          at org.apache.felix.framework.searchpolicy.ModuleImpl.access$100(ModuleImpl.java:59)&lt;br/&gt;
          at org.apache.felix.framework.searchpolicy.ModuleImpl$ModuleClassLoader.loadClass(ModuleImpl.java:1434)&lt;br/&gt;
          ... 5 more&lt;/p&gt;


&lt;p&gt;-&amp;gt; Could anyone please check my sample code. I am just worried about unexpected side effects from the -XX options ...&lt;/p&gt;
</comment>
                            <comment id="12696905" author="pderop" created="Wed, 8 Apr 2009 06:20:39 +0000"  >&lt;p&gt;attached the sample code which have ClassNotFoundException, when using the &quot;-XX:+UnlockDiagnosticVMOptions -XX:+UnsyncloadClass&quot; options.&lt;/p&gt;</comment>
                            <comment id="12696918" author="mcculls" created="Wed, 8 Apr 2009 07:17:08 +0000"  >&lt;p&gt;Re-opening so we (ie. either me/Karl/Richard) can do further investigation&lt;/p&gt;</comment>
                            <comment id="12696936" author="rickhall" created="Wed, 8 Apr 2009 08:00:07 +0000"  >&lt;p&gt;Pierre, it seems that constantly updating/refreshing your bundles is always going to lead to such situations since you have a race condition between servicing the class load request and the JAR file being deleted from the file system due to a refresh.&lt;/p&gt;

&lt;p&gt;Remember that we do not try to perform any locking on a class load to hold a bundle JAR file in place because a) it would be too costly, b) the potential for deadlock would be great, and c) what&apos;s the point since if the bundle you depend on is being refreshed, then you are likely being refreshed too.&lt;/p&gt;

&lt;p&gt;You concern here seems to be based on the fact that you do not see these errors with the JVM option enabled, but perhaps that makes some sense since it leads to more concurrency, which then exposes this race condition. Just a thought.&lt;/p&gt;</comment>
                            <comment id="12696954" author="pderop" created="Wed, 8 Apr 2009 08:51:53 +0000"  >&lt;p&gt;Yes Richard, I remember, and in the sample code,  I think I don&apos;t have such race condition (though, I am now doubting ...) because:&lt;/p&gt;

&lt;p&gt;1) the Updater always stops the bundle B, before upadting/refreshing it.&lt;br/&gt;
2) In B.stop(), I ensure all started threads to be properly joined, before returning from B.stop() method.&lt;br/&gt;
3) Morover, when I refresh, I always wait for the PACKAGES_REFRESHED event, before restarting B ...&lt;/p&gt;

&lt;p&gt;Did I miss something ?&lt;/p&gt;</comment>
                            <comment id="12696956" author="rickhall" created="Wed, 8 Apr 2009 08:55:07 +0000"  >&lt;p&gt;Pierre, that sounds reasonable. I guess we will have to look into your example.&lt;/p&gt;</comment>
                            <comment id="12697600" author="sahoo" created="Thu, 9 Apr 2009 18:50:54 +0000"  >&lt;p&gt;Stuart,&lt;/p&gt;

&lt;p&gt;The classloader API changes are discussed at:&lt;br/&gt;
&lt;a href=&quot;http://openjdk.java.net/groups/core-libs/ClassLoaderProposal.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://openjdk.java.net/groups/core-libs/ClassLoaderProposal.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Sahoo&lt;/p&gt;</comment>
                            <comment id="12697728" author="rickhall" created="Fri, 10 Apr 2009 04:22:50 +0000"  >&lt;p&gt;Pierre, are the exceptions you are seeing related to the fact that update auto-refreshes? Your comment in your code mentions that the refresh isn&apos;t done when you receive the event. I guess it is clear now that your Updater was seeing the event of the auto-refresh, not its own refresh. Does this resolve this issue?&lt;/p&gt;</comment>
                            <comment id="12697735" author="pderop" created="Fri, 10 Apr 2009 05:06:38 +0000"  >&lt;p&gt;Richard,&lt;/p&gt;

&lt;p&gt;I don&apos;t think that the Auto-Refresh issue is unrelated to this one (that&apos;s why I sent the auto-refresh issue on users-list, separately).&lt;/p&gt;

&lt;p&gt;To work around the Auto-Refresh problem, I have added a sleep(10) in the Updater.Refresher inner class.&lt;br/&gt;
I just tested with a higher delay (5000), and I still have the ClassNotFound with the -XX options&lt;/p&gt;


</comment>
                            <comment id="12697738" author="pderop" created="Fri, 10 Apr 2009 05:09:45 +0000"  >&lt;p&gt;(oops, my previous message was not clear, I repost it):&lt;/p&gt;

&lt;p&gt;the Auto-Refresh is (I think) UNRELATED to the ClassNotFound (and you can replace sleep(10) by sleep(5000) in the Updated.java file -&amp;gt; you will have the same ClassNotFound with -XX options)&lt;/p&gt;

&lt;p&gt;/pierre&lt;/p&gt;</comment>
                            <comment id="12697773" author="pderop" created="Fri, 10 Apr 2009 09:09:59 +0000"  >&lt;p&gt;Richard, &lt;/p&gt;

&lt;p&gt;I reproduce the problem in a simpler way, without using the &quot;Updater&quot; bundle at all. (yon can discard it).&lt;br/&gt;
Now, in my felix config, I just start bundle A, and B:&lt;/p&gt;

&lt;p&gt;----------------------------------&lt;br/&gt;
felix.auto.start.1= \&lt;br/&gt;
 &lt;a href=&quot;file:bundle/org.apache.felix.shell-1.1.0-SNAPSHOT.jar&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:bundle/org.apache.felix.shell-1.1.0-SNAPSHOT.jar&lt;/a&gt; \&lt;br/&gt;
 &lt;a href=&quot;file:bundle/org.apache.felix.shell.tui-1.1.0-SNAPSHOT.jar&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:bundle/org.apache.felix.shell.tui-1.1.0-SNAPSHOT.jar&lt;/a&gt; \&lt;br/&gt;
 &lt;a href=&quot;file:bundle/org.apache.felix.bundlerepository-1.3.0-SNAPSHOT.jar&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:bundle/org.apache.felix.bundlerepository-1.3.0-SNAPSHOT.jar&lt;/a&gt; \&lt;br/&gt;
 &lt;a href=&quot;file:bundle/A.jar&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:bundle/A.jar&lt;/a&gt; \&lt;br/&gt;
 &lt;a href=&quot;file:bundle/B.jar&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:bundle/B.jar&lt;/a&gt; \&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;don&apos;t activate felix debug ...&lt;br/&gt;
felix.log.level=1 &lt;br/&gt;
---------------------------------------------------------------------------&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;and I start felix like this (I use jdk 1.5.0_18):&lt;/p&gt;

&lt;p&gt;rm -rf felix-cache/; &lt;br/&gt;
java -XX:+UnlockDiagnosticVMOptions -XX:+UnsyncloadClass -jar bin/felix.jar&lt;/p&gt;

&lt;p&gt;-&amp;gt; B starting ...&lt;br/&gt;
java.lang.ClassNotFoundException: a.A&lt;br/&gt;
        at org.apache.felix.framework.searchpolicy.ModuleImpl.findClassOrResourceByDelegation(ModuleImpl.java:565)&lt;br/&gt;
        at org.apache.felix.framework.searchpolicy.ModuleImpl.access$100(ModuleImpl.java:59)&lt;br/&gt;
        at org.apache.felix.framework.searchpolicy.ModuleImpl$ModuleClassLoader.loadClass(ModuleImpl.java:1434)&lt;br/&gt;
        at java.lang.ClassLoader.loadClass(ClassLoader.java:251)&lt;br/&gt;
        at java.lang.Class.forName0(Native Method)&lt;br/&gt;
        at java.lang.Class.forName(Class.java:164)&lt;br/&gt;
        at b.Legacy.run(Legacy.java:6)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:595)&lt;/p&gt;

&lt;p&gt;If you don&apos;t get the CNF, then manually stop/update/refresh/start bundle B, like this, and you will probably get the CNF:&lt;/p&gt;

&lt;p&gt;-&amp;gt; B starting ...&lt;/p&gt;

&lt;p&gt;-&amp;gt; ps&lt;br/&gt;
START LEVEL 1&lt;br/&gt;
   ID   State         Level  Name&lt;br/&gt;
[   0] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    0] System Bundle (1.7.0.SNAPSHOT)&lt;br/&gt;
[   1] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] Apache Felix Shell Service (1.1.0.SNAPSHOT)&lt;br/&gt;
[   2] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] Apache Felix Shell TUI (1.1.0.SNAPSHOT)&lt;br/&gt;
[   3] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] Apache Felix Bundle Repository (1.3.0.SNAPSHOT)&lt;br/&gt;
[   4] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] A (1.0.0)&lt;br/&gt;
[   5] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] B (1.0.0)&lt;/p&gt;

&lt;p&gt;-&amp;gt; stop 5&lt;br/&gt;
-&amp;gt; update 5&lt;br/&gt;
-&amp;gt; refresh 5&lt;br/&gt;
-&amp;gt; start 5&lt;br/&gt;
B starting ...&lt;br/&gt;
java.lang.ClassNotFoundException: a.A&lt;br/&gt;
        at org.apache.felix.framework.searchpolicy.ModuleImpl.findClassOrResourceByDelegation(ModuleImpl.java:565)&lt;br/&gt;
        at org.apache.felix.framework.searchpolicy.ModuleImpl.access$100(ModuleImpl.java:59)&lt;br/&gt;
        at org.apache.felix.framework.searchpolicy.ModuleImpl$ModuleClassLoader.loadClass(ModuleImpl.java:1434)&lt;br/&gt;
        at java.lang.ClassLoader.loadClass(ClassLoader.java:252)&lt;br/&gt;
        at java.lang.Class.forName0(Native Method)&lt;br/&gt;
        at java.lang.Class.forName(Class.java:169)&lt;br/&gt;
        at b.Legacy.run(Legacy.java:6)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;</comment>
                            <comment id="12697774" author="rickhall" created="Fri, 10 Apr 2009 09:14:48 +0000"  >&lt;p&gt;Ok, thanks for the update. We are looking into it.&lt;/p&gt;</comment>
                            <comment id="12698060" author="rickhall" created="Sat, 11 Apr 2009 07:08:04 +0000"  >&lt;p&gt;Ok, I think I know what is going on here and it is a bug in Felix which is exposed by the additional level of concurrency enabled by the new JVM flag.&lt;/p&gt;

&lt;p&gt;Basically, the situation is something like this:&lt;/p&gt;

&lt;p&gt;1. Since the bundle is dynamically importing &quot;a&quot;, there is a race condition among its threads to be the first to dynamically import it.&lt;br/&gt;
2. Assume all threads approximately finish searching their statically imported wires at the same time, none will find &quot;a.A&quot; because it hasn&apos;t been dynamically imported yet.&lt;br/&gt;
3. Further assume all threads end up trying to dynamically import &quot;a&quot; at around the same time; only one will actually be able to do so, because this operation is guarded by a global lock.&lt;br/&gt;
4. Whichever thread won the race to dynamically import the package will succeed in doing so and will load the class correctly.&lt;br/&gt;
5. All remaining threads will also &lt;span class=&quot;error&quot;&gt;&amp;#91;one at a time&amp;#93;&lt;/span&gt; try to dynamically import the package, but each will fail since the bundle now already imports the package as a result of the first thread. You are not allowed to dynamically import a package to which you are already wired.&lt;br/&gt;
6. Since the remaining bundles are all past the point where they can search their existing imports, each thread will throw a CNFE, since it looks like to them that the dynamic import failed.&lt;/p&gt;

&lt;p&gt;I am pretty sure this is what is going on. The solution? We probably need to double-check to make sure the package hasn&apos;t already been dynamically imported when we attempt to dynamic import to detect the race condition.&lt;/p&gt;

&lt;p&gt;I quickly hacked up a solution in my workspace and it looks like I am on the correct track, but I don&apos;t have a complete patch ready yet.&lt;/p&gt;</comment>
                            <comment id="12698066" author="rickhall" created="Sat, 11 Apr 2009 09:13:25 +0000"  >&lt;p&gt;I have attached a patch that performs double checking of the wire before attempting to dynamically import again. I believe this resolves the issue for this example. Not sure if the precise patch is good in general. It does result in some duplication with Resolver.isDynamicImportAllowed().&lt;/p&gt;</comment>
                            <comment id="12698815" author="pderop" created="Tue, 14 Apr 2009 15:51:54 +0000"  >&lt;p&gt;All right, I have performed a non-regression test, and it looks like everything is ok with your patch and with the -XX options ...&lt;br/&gt;
Thanks !&lt;/p&gt;

&lt;p&gt;Do you plan to commit this fix, or do you need to investigate further ?&lt;/p&gt;</comment>
                            <comment id="12699027" author="rickhall" created="Wed, 15 Apr 2009 02:13:54 +0000"  >&lt;p&gt;We will commit it or something like it. I still want to look into improving the patch so it doesn&apos;t duplicate code, but otherwise it is probably ok.&lt;/p&gt;</comment>
                            <comment id="12701846" author="rickhall" created="Thu, 23 Apr 2009 08:35:18 +0000"  >&lt;p&gt;I have committed my simple double-check patch. Please close this issue if you are satisfied. Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12405225" name="FELIX-1027-double-check.txt" size="1585" author="rickhall" created="Sat, 11 Apr 2009 09:11:25 +0000"/>
                            <attachment id="12404717" name="FELIX_1027_20090406.txt" size="1025" author="mcculls" created="Mon, 6 Apr 2009 12:38:48 +0000"/>
                            <attachment id="12404713" name="deadlock.txt" size="14205" author="pderop" created="Mon, 6 Apr 2009 11:44:15 +0000"/>
                            <attachment id="12404722" name="deadlock_after_patch_FELIX_1027_20090406.log" size="4821" author="pderop" created="Mon, 6 Apr 2009 13:50:09 +0000"/>
                            <attachment id="12404931" name="test-deadlock.tgz" size="108579" author="pderop" created="Wed, 8 Apr 2009 06:20:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>57963</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 31 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0vqyv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>183342</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>