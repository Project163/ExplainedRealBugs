<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:00:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5206] Can&apos;t load bundle entries when embedding FelixConnect in JBoss</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5206</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;I&apos;m using Apache Connect embedded in JBoss EAP 5.2.&lt;/p&gt;

&lt;p&gt;I came across the following issue: When I launch Apache Connect under jboss, the ClasspathScanner loads bundles from a jboss classloader that I pass to the scanForBundles method. The problem is that jboss ClassLoader.getResources(...) method returns a list of URL with a special jboss &quot;vfszip&quot; URL, like:&lt;/p&gt;

&lt;p&gt;vfszip:/opt/SPS_2_0_I16/jboss/common/lib/DNSClient-1.2759.01.jar/ &lt;/p&gt;

&lt;p&gt;Now, when declarative service (1.8.2) is started, it can&apos;t load the xml descriptors, because when it invokes the Bundle.findEntries(...) method, this one returns null, because the call to this method ends up calling the org.apache.felix.connect.URLRevision.getEntries() method, which is not implemented:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Enumeration&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; getEntries()
    {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Collections.enumeration(Collections.EMPTY_LIST);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I have attached a simple patch to this issue which resolves the problem.&lt;/p&gt;

&lt;p&gt;Anyone could review it and let me know if I can commit it ?&lt;/p&gt;

&lt;p&gt;thanks.&lt;/p&gt;


</description>
                <environment></environment>
        <key id="12947988">FELIX-5206</key>
            <summary>Can&apos;t load bundle entries when embedding FelixConnect in JBoss</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pderop">Pierre De Rop</assignee>
                                    <reporter username="pderop">Pierre De Rop</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Mar 2016 12:30:56 +0000</created>
                <updated>Mon, 21 Mar 2016 20:10:27 +0000</updated>
                            <resolved>Mon, 21 Mar 2016 20:10:27 +0000</resolved>
                                    <version>connect-0.1.0</version>
                                                    <component>Connect</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15184846" author="pderop" created="Tue, 8 Mar 2016 12:32:09 +0000"  >&lt;p&gt;Attached the proposed patch.&lt;br/&gt;
let me know if I can commit this ? &lt;/p&gt;

&lt;p&gt;thanks.&lt;/p&gt;</comment>
                            <comment id="15184944" author="karlpauls" created="Tue, 8 Mar 2016 14:11:37 +0000"  >&lt;p&gt;Well, I&apos;m not sure that this is the correct way of handling this problem. &lt;/p&gt;

&lt;p&gt;It seems like you are assuming that you can just read any url as a jar. This probably is not a good assumption. Granted, I never really figured out what to do in this case so your guess is as good as any but I would rather say we should special case the vfszip protocol and turn it into a JarRevision when we encounter it. Have a look at the buildRevision(BundleDescriptor desc)  method in PojoSR. There we first check if it is a file url, then we check if it is a JarURLConnection, and then we fallback to a URLRevision. It almost looks like you could just detect that it is a vfszip protocol url, wrap it into a jar: url and make it a JarRevision there, no?&lt;/p&gt;</comment>
                            <comment id="15187336" author="pderop" created="Wed, 9 Mar 2016 16:21:15 +0000"  >&lt;p&gt;I have attached a second patch which just wraps the vfszip url in the PojoSR.buildRevision(BundleDescriptor desc) method.&lt;/p&gt;

&lt;p&gt;However, I&apos;m now hesitant. Indeed, I&apos;m not a jboss expert, but looking at some links from google, it seems that vfszip is not the only URL protocol supported by jboss (there is also vfsjar, vfsfile, etc ...).&lt;/p&gt;

&lt;p&gt;Another concern is about the vfszip, which seems to be able to not only point to real jars (like in my case), but also point to some inner jars from a non-exploded ear (not my case).&lt;/p&gt;

&lt;p&gt;So, it seems that if we want to generically handle all the possible use cases, then we would need to call URL.openConnection() and get the content in a transparent way ? One option could be to try to wrap the vfszip&lt;br/&gt;
URL to a jar url in a more robust way, like using a custom URLStream Handler that would then internally call the actual vfszip URL.openConnection() in order to copy the content in a temporary file, etc ... (really similar to the RevisionAsJarURL inner class from &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;).&lt;/p&gt;

&lt;p&gt;But then, this also looks similar to what I did in the initial patch (in the URLRevision) ? by the way, what is really wrong with it ?&lt;/p&gt;

&lt;p&gt;So, what do you think ? (both patches are currently working for my use case, it&apos;s just that I would like to make sure that all use cases are correctly supported).&lt;/p&gt;

&lt;p&gt;... maybe I&apos;m rambling too much &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://svn.apache.org/viewvc/felix/trunk/framework/src/main/java/org/apache/felix/framework/BundleProtectionDomain.java?revision=1734034&amp;amp;view=co&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/felix/trunk/framework/src/main/java/org/apache/felix/framework/BundleProtectionDomain.java?revision=1734034&amp;amp;view=co&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15197598" author="pderop" created="Wed, 16 Mar 2016 16:17:59 +0000"  >&lt;p&gt;As discussed with Karl, I&apos;m attaching a new patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5206&quot; title=&quot;Can&amp;#39;t load bundle entries when embedding FelixConnect in JBoss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5206&quot;&gt;&lt;del&gt;FELIX-5206&lt;/del&gt;&lt;/a&gt;.VFS) which is now using the JBoss VFS api (if available) when loading bundles represented by &quot;vfs&quot; URLs:&lt;/p&gt;

&lt;p&gt;Added VFSRevision.java, which allows to transparently load bundles regardless of the form in which the bundles are deployed (jar, ear, or unpackaged in the jboss deployment directory).&lt;br/&gt;
And If a vfs protocol is detected but the VFS API is not there, then we use by default the URLRevision. In this case, we assume that the bundle can be loaded from the root of the bundle URL.&lt;br/&gt;
Also patched the URLRevision.getEntries() method which is using the URL connection when accessing to the URL content.&lt;/p&gt;

&lt;p&gt;Karl, are you OK with this ?&lt;/p&gt;</comment>
                            <comment id="15197632" author="pderop" created="Wed, 16 Mar 2016 16:35:14 +0000"  >&lt;p&gt;There was some problems with diff, so I replaced the &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5206&quot; title=&quot;Can&amp;#39;t load bundle entries when embedding FelixConnect in JBoss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5206&quot;&gt;&lt;del&gt;FELIX-5206&lt;/del&gt;&lt;/a&gt;.VFS with a &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5206&quot; title=&quot;Can&amp;#39;t load bundle entries when embedding FelixConnect in JBoss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5206&quot;&gt;&lt;del&gt;FELIX-5206&lt;/del&gt;&lt;/a&gt;.VFS.tgz archive, which contains the modified files.&lt;/p&gt;</comment>
                            <comment id="15199489" author="karlpauls" created="Thu, 17 Mar 2016 13:12:41 +0000"  >&lt;p&gt;I assume you tested it with old and new jboss versions and outside of jboss. If it works I&apos;m fine with the patch - nice work!&lt;/p&gt;</comment>
                            <comment id="15200307" author="pderop" created="Thu, 17 Mar 2016 20:29:18 +0000"  >&lt;p&gt;Thanks Karl, &lt;/p&gt;

&lt;p&gt;Yes I did some tests outside jboss, inside an old jboss which does not support vfs (only &quot;vfszip&quot; protocol), and tested the &quot;vfs&quot; protocol with an EAR archive inside JBoss EAP 6.4.0. The EAR contains some felix bundles (gogo , declarative service, etc ...), an EJB used to launch Connect, and then I was able to telnet to the EAR and browse my components.  &lt;/p&gt;

&lt;p&gt;I also tested the EAR in two forms of deployment:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;EAR in the form of a packaged &quot;connect.ear&quot; archive file.&lt;/li&gt;
	&lt;li&gt;EAR in the form of an unpackage ear, unjared in the jboss deployment directory (flat files).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Ok, I will commit all this soon. &lt;/p&gt;

&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15204990" author="pderop" created="Mon, 21 Mar 2016 20:02:59 +0000"  >&lt;p&gt;Committed the proposed patch in rv 1736078.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12792273" name="FELIX-5206-wrap-vfszipurl-to-jarfileurl.patch" size="2963" author="pderop" created="Wed, 9 Mar 2016 16:21:15 +0000"/>
                            <attachment id="12793778" name="FELIX-5206.VFS.tgz" size="7638" author="pderop" created="Wed, 16 Mar 2016 16:35:14 +0000"/>
                            <attachment id="12791990" name="FELIX-5206.patch" size="3671" author="pderop" created="Tue, 8 Mar 2016 12:32:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 35 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ubwn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>