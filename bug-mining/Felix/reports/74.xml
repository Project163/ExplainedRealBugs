<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:05:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-341] Intermittent exception during Felix shutdown</title>
                <link>https://issues.apache.org/jira/browse/FELIX-341</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;One of my testcases intermittently throws an exception during shutdown. I have managed to recreate the exception under a debugger, and it shows two threads trying to unregister the same service. The test fails only when declarative services are used. I am using Felix 1.0.0 framework and the latest snapshot of SCR. The test uses multiple versions of a bundle, but I am not sure if that has anything to do with the exception.&lt;/p&gt;

&lt;p&gt;The exception thrown is:&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Exception with component : Unexpected problem executing task &amp;#8212;&lt;br/&gt;
    java.lang.IllegalStateException: Service already unregistered.&lt;br/&gt;
        at org.apache.felix.framework.ServiceRegistrationImpl.unregister (ServiceRegistrationImpl.java:105)&lt;br/&gt;
        at org.apache.felix.scr.AbstractComponentManager.unregisterComponentService(AbstractComponentManager.java:503)&lt;br/&gt;
        at org.apache.felix.scr.AbstractComponentManager.deactivateInternal (AbstractComponentManager.java:369)&lt;br/&gt;
        at org.apache.felix.scr.AbstractComponentManager.access$200(AbstractComponentManager.java:55)&lt;br/&gt;
        at org.apache.felix.scr.AbstractComponentManager$3.run(AbstractComponentManager.java :176)&lt;br/&gt;
        at org.apache.felix.scr.ComponentActorThread.run(ComponentActorThread.java:81)&lt;/p&gt;

&lt;p&gt;Here is the stack trace of the two threads under the debugger (both are using the same object):&lt;/p&gt;

&lt;p&gt;                Thread &lt;span class=&quot;error&quot;&gt;&amp;#91;FelixStartLevel&amp;#93;&lt;/span&gt; (Suspended (breakpoint at line 97 in ServiceRegistrationImpl))&lt;br/&gt;
                        ServiceRegistrationImpl.unregister() line: 97&lt;br/&gt;
                        ServiceRegistry.unregisterServices (Bundle) line: 119&lt;br/&gt;
                        Felix._stopBundle(FelixBundle, boolean) line: 1946&lt;br/&gt;
                        Felix.stopBundle(FelixBundle, boolean) line: 1866&lt;br/&gt;
                        Felix.setFrameworkStartLevel (int) line: 1080&lt;br/&gt;
                        StartLevelImpl.run() line: 258&lt;br/&gt;
                        Thread.run() line: 803&lt;br/&gt;
                Thread &lt;span class=&quot;error&quot;&gt;&amp;#91;SCR Component Actor&amp;#93;&lt;/span&gt; (Suspended (breakpoint at line 97 in ServiceRegistrationImpl))&lt;br/&gt;
                        ServiceRegistrationImpl.unregister() line: 97&lt;br/&gt;
                        ImmediateComponentManager(AbstractComponentManager).unregisterComponentService() line: 503 &lt;br/&gt;
                        ImmediateComponentManager(AbstractComponentManager).deactivateInternal() line: 369&lt;br/&gt;
                        AbstractComponentManager.access$200(AbstractComponentManager) line: 55&lt;br/&gt;
                        AbstractComponentManager$3.run() line: 176 &lt;br/&gt;
                        ComponentActorThread.run() line: 81&lt;/p&gt;


&lt;p&gt;The exception thrown is the IllegalStateException from&lt;br/&gt;
    public void unregister()&lt;br/&gt;
    {&lt;br/&gt;
        if (m_svcObj != null)&lt;/p&gt;
        {
            m_registry.unregisterService(m_bundle, this);
            m_svcObj = null;
            m_factory = null;
        } 
&lt;p&gt;        else&lt;/p&gt;
        {
            throw new IllegalStateException(&quot;Service already unregistered.&quot;);
        }
&lt;p&gt;    }&lt;/p&gt;</description>
                <environment></environment>
        <key id="12376475">FELIX-341</key>
            <summary>Intermittent exception during Felix shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fmeschbe">Felix Meschberger</assignee>
                                    <reporter username="rsivaram">Rajini Sivaram</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Aug 2007 08:32:45 +0000</created>
                <updated>Fri, 30 May 2008 18:15:56 +0000</updated>
                            <resolved>Thu, 30 Aug 2007 14:56:49 +0000</resolved>
                                    <version>framework-1.0.0</version>
                                    <fixVersion>scr-1.0.0</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12521828" author="fmeschbe" created="Wed, 22 Aug 2007 15:29:16 +0000"  >&lt;p&gt;I cannot exactly tell, what is going on here. Telling from the code, the deactivate() method, which asynchronously calls the deactivateInternal() method, is only called from the createImplementationObject method to &quot;deactivate&quot; the component if activation fails. It is of course not a good thing, that this method calls component deactivation asynchronously. Instead the component should be marked inactive immediately (aka synchronously).&lt;/p&gt;

&lt;p&gt;On the other hand, the createImplementationObject method should not actually call deactivate, as all that needs to be undone is&lt;/p&gt;

&lt;p&gt;   &amp;gt; object creation: nothing to do, we just ignore the reference to the newly created object&lt;br/&gt;
   &amp;gt; reference binding: we need to unbind any bound references&lt;br/&gt;
   &amp;gt; activate method: nothing to do (if object creation fails before, activate is not called, otherwise activate failed)&lt;/p&gt;

&lt;p&gt;So, the fix is to just make sure, any bound references are unbound and that - in the case of an immediate component - the state is not set to active and - if so configured - no services are registered.&lt;/p&gt;

&lt;p&gt;Fixed like this in Rev. 568657&lt;/p&gt;</comment>
                            <comment id="12523829" author="fmeschbe" created="Thu, 30 Aug 2007 11:31:57 +0000"  >&lt;p&gt;Rajini provided me with additional testcase instructions, which showed the following behaviour:&lt;/p&gt;

&lt;p&gt;Consider Bundle B1 with Component C1 registered as a service and Bundle B2 with Component C2 registered as a service. C1 has a mandatory dependency on C2 and B1 is started before B2.&lt;/p&gt;

&lt;p&gt;When the framework is shut down, B2 is stopped before B1. While stopping B2, Component C2 is unregistered as a service and deactivated. As a result C1 is to be deactivated and hence unregistered as a service. This deactivation of C1 is launched asynchronously such that B1 will not deactivate C1 as it already is assumed to be deactivated.&lt;/p&gt;

&lt;p&gt;Due to timing issues the asynchronous deactivation of C1 may be delayed such that service registration of C1 is unregistered by the framework due to Bundle B1 stop before C1 deactivation could unregister the service. This could cause  trying to unregister the same service twice and hence the IllegalStateException.&lt;/p&gt;

&lt;p&gt;Though this seems to be a multithreading corner case, there is another catch with asynchronously deactivating components due to unregistered services: If a component has a dependency on another service, it should be notified of the removal of the service as fast as possible. Hence, this situation should be handled synchronously to the service unregistration notice. So the fix is to immediately deactivate the depending component and schedule the reactivation asynchronously.&lt;/p&gt;

&lt;p&gt;At the same time I add more logging and more security to not activate components while the owning bundle is actually shutting down.&lt;/p&gt;</comment>
                            <comment id="12523859" author="fmeschbe" created="Thu, 30 Aug 2007 14:56:49 +0000"  >&lt;p&gt;Fixed in Rev. 571194 as follows:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Enhanced logging&lt;/li&gt;
	&lt;li&gt;No activation of components when the owning bundle is (being) stopped&lt;/li&gt;
	&lt;li&gt;Synchronous Component Deactivation (Activation still asynchronous)&lt;/li&gt;
	&lt;li&gt;No more Task Scheduling while a Bundle is stopped or stopping&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Also deployed a new snapshot.&lt;/p&gt;</comment>
                            <comment id="12525368" author="fmeschbe" created="Thu, 6 Sep 2007 08:45:52 +0000"  >&lt;p&gt;This has been confirmed to be fixed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>58643</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 years, 12 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i140xb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>231612</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>