<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:05:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-338] Framework FilterImpl is not thread safe on execution</title>
                <link>https://issues.apache.org/jira/browse/FELIX-338</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;Executing a Filter implemented by the Felix Framework FilterImpl class is not thread safe, as the Filter.Implmatch() methods are not synchronized but use a Mapper and Evaluator instance fields which are modified while matching the filter.&lt;/p&gt;

&lt;p&gt;Two options seem to exist:&lt;/p&gt;

&lt;p&gt;   1. Make the match() methods synchronized&lt;br/&gt;
   2. Create Mapper and Evaluator instances on each match() call&lt;/p&gt;

&lt;p&gt;My assumption is that the second method tends to be better because of the synchronization needed with the first approach.&lt;/p&gt;

&lt;p&gt;Reported by Tom Remoleur, thanks. The full mail thread leading to this issue may be found at &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://www.mail-archive.com/users@felix.apache.org/msg00145.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/users@felix.apache.org/msg00145.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12376023">FELIX-338</key>
            <summary>Framework FilterImpl is not thread safe on execution</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="karlpauls">Karl Pauls</assignee>
                                    <reporter username="fmeschbe">Felix Meschberger</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Aug 2007 05:52:21 +0000</created>
                <updated>Wed, 12 Sep 2007 17:54:05 +0000</updated>
                            <resolved>Wed, 15 Aug 2007 20:14:56 +0000</resolved>
                                    <version>framework-0.8.0</version>
                    <version>framework-1.0.0</version>
                                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12519960" author="karlpauls" created="Wed, 15 Aug 2007 13:33:27 +0000"  >&lt;p&gt;Well, in my experience it never pays to jump to conclusions when Java&lt;br/&gt;
is involved. I actually wrote a quick test and see the following&lt;br/&gt;
(Apple, JVM 1.3 and 1.5).&lt;/p&gt;

&lt;p&gt;syncing the match method adds ~ 5% overhead in a single thread scenario.&lt;br/&gt;
syncing the match method adds ~ 40% overhead in a multi thread scenario.&lt;/p&gt;

&lt;p&gt;creating new instances adds ~ 40 % overhead in a single thread scenario.&lt;br/&gt;
creating new instances adds ~ 40 % overhead in a multi thread scenario.&lt;/p&gt;

&lt;p&gt;In other words, the new instances approach doesn&apos;t seem that good to&lt;br/&gt;
me (your mileage may vary &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;Fortunately, I wrote a solution that uses a ThreadLocal to only create&lt;br/&gt;
a new instance per Thread. I keep the instance in a SoftReference and&lt;br/&gt;
for my test the memory looks good to. This solution gives me:&lt;/p&gt;

&lt;p&gt;ThreadLocal adds ~ 5% overhead in a single thread scenario&lt;br/&gt;
ThreadLocal adds ~ 5% overhead in a multi thread scenario&lt;/p&gt;

&lt;p&gt;The downside is that it doesn&apos;t necessarily makes the code more pretty &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="12519971" author="karlpauls" created="Wed, 15 Aug 2007 13:59:16 +0000"  >&lt;p&gt;Using a combination of ThreadLocal and SoftReferences to address the issue. &lt;/p&gt;</comment>
                            <comment id="12519986" author="fmeschbe" created="Wed, 15 Aug 2007 14:52:03 +0000"  >&lt;p&gt;I have to admit, that I never touched ThreadLocals myself upto now. But It seems to be the best of all possibilities to fix the issues.&lt;/p&gt;

&lt;p&gt;On the other hand, looking at the code, it seems like the Evaluator basically just ist a single method whose only data modified during evaluation is the operand stack. So, I assume, the Evaluator.evaluate(Mapper) method might just as well be copied to the FilterImpl class and the operand stack a variable local to the method - this stack would be recreated on each call (instead of the Evaluator) and need not be cleared at the end, as this is left to the GC.&lt;/p&gt;

&lt;p&gt;The other object - the mapper - is just a facade to the actual data being used for filter matching.&lt;/p&gt;

&lt;p&gt;So besides just not reusing the instances, I would also redo the implementation.&lt;/p&gt;</comment>
                            <comment id="12519987" author="fmeschbe" created="Wed, 15 Aug 2007 14:56:00 +0000"  >&lt;p&gt;Here is a patch with what I had in mind. It expectes the following changes in the ldap package:&lt;/p&gt;

&lt;p&gt;   Parser.getProgram returns Operator[] to not use a cast on each access. I assume the parser creates&lt;br/&gt;
   a &quot;pure&quot; list anyway, so the getProgram might as well create the proper array&lt;/p&gt;

&lt;p&gt;   The Unknown class must be public for the FilterImpl.evaluate (copied from Evaluator) to see it&lt;/p&gt;

&lt;p&gt;Finally, the evaluate and toStringInfix method are copied from the Evaluator to FilterImpl.&lt;/p&gt;

&lt;p&gt;I just saw after finishing the patch, that in fact the FilterImpl class is the only LDAP related class not in the ldap package - so the separation of FilterImpl and Evaluator might make sense.... Don&apos;t know for sure.&lt;/p&gt;</comment>
                            <comment id="12519995" author="rickhall" created="Wed, 15 Aug 2007 15:14:27 +0000"  >&lt;p&gt;The LDAP package is self-contained. I don&apos;t think it is a good idea to move LDAP code outside the LDAP package, nor is it a good idea to duplicate that code elsewhere, since code duplication is a maintenance headache. Perhaps it would be possible to modify Evaluator.evaluate() method to accept both the program and the mapper so that it can be re-entrant?&lt;/p&gt;</comment>
                            <comment id="12520005" author="karlpauls" created="Wed, 15 Aug 2007 15:35:22 +0000"  >&lt;p&gt;I agree with Richard, we should try to avoid code duplication and I like the fact that the LDAP package is self-contained. &lt;/p&gt;

&lt;p&gt;Furthermore, I did re-run my tests and for me your solution doesn&apos;t help much. Still 35% overhead for both scenarios. The issue is the simple wrapper instance creations on every call - not the evaluator. &lt;/p&gt;</comment>
                            <comment id="12520069" author="fmeschbe" created="Wed, 15 Aug 2007 19:15:45 +0000"  >&lt;p&gt;In this case, of course I agree with you to stick with your patch (on my Linux with Sun JDK 1.4, the differences are not that big, but then...). Will you apply it, or should I do it ?&lt;/p&gt;</comment>
                            <comment id="12520079" author="karlpauls" created="Wed, 15 Aug 2007 19:58:34 +0000"  >&lt;p&gt;Yes, I admit that it is always tricky to do performance test. All I can say is that for me the ThreadLocal version runs faster. One issue might be how many native threads your system supports. In case you use much more threads then you really have parallelism must go done. The above, I see on a MacBook Pro with a dual core 2.4 Ghz Intel and under a SunVM under Windows (but that is under VMWare). It is almost the same for 2, 4, and 8 threads but approaches 0 quickly after (at 64 threads I don&apos;t see any difference anymore).    &lt;/p&gt;

&lt;p&gt;I&apos;ll go ahead and commit this patch now so that we have a fix in place. However, I agree with your point that we should look at the ldap code again to see whether we can clean it up some more. Let&apos;s pick that up again once we have a bug fix release out of the door.&lt;/p&gt;</comment>
                            <comment id="12520080" author="karlpauls" created="Wed, 15 Aug 2007 20:14:55 +0000"  >&lt;p&gt;The patch is in trunk as of r566323. Please try to test whether this makes your issue go away (or not appear in this case). I&apos;ll try to run the framework in the project I saw the same issue too. Hopefully, it should be gone now. I&apos;ll close this issue if I don&apos;t hear anything for some time.&lt;/p&gt;</comment>
                            <comment id="12526869" author="karlpauls" created="Wed, 12 Sep 2007 17:54:05 +0000"  >&lt;p&gt;Seems to work now.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12363849" name="FilterImpl_rewrite.patch" size="7683" author="fmeschbe" created="Wed, 15 Aug 2007 14:56:00 +0000"/>
                            <attachment id="12363845" name="filter.patch" size="8875" author="karlpauls" created="Wed, 15 Aug 2007 13:59:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>58646</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 years, 11 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i140pz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>231579</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>