<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:10:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5416] Endless loop throwing InterruptedException when shutting down framework</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5416</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;When shutting down the framework via the framework&apos;s stop method or in a gogo terminal shell via stop 0 command, the Apache Felix Declarative Services goes into a never ending loop with the following log ENTRIES:&lt;/p&gt;


&lt;p&gt;2016-11-16 17:44:22,030 | ERROR | FelixStartLevel  | scr                              | 7 - org.apache.felix.scr - 2.0.6 | Interrupted exception waiting for queue to empty&lt;br/&gt;
java.lang.InterruptedException&lt;br/&gt;
	at java.lang.Object.wait(Native Method)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.8.0_111&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.lang.Object.wait(Object.java:502)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.8.0_111&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.felix.scr.impl.ComponentActorThread.terminate(ComponentActorThread.java:131)&lt;span class=&quot;error&quot;&gt;&amp;#91;7:org.apache.felix.scr:2.0.6&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.felix.scr.impl.Activator.doStop(Activator.java:216)&lt;span class=&quot;error&quot;&gt;&amp;#91;7:org.apache.felix.scr:2.0.6&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.felix.utils.extender.AbstractExtender.stop(AbstractExtender.java:128)&lt;span class=&quot;error&quot;&gt;&amp;#91;7:org.apache.felix.scr:2.0.6&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.felix.scr.impl.Activator.stop(Activator.java:181)&lt;span class=&quot;error&quot;&gt;&amp;#91;7:org.apache.felix.scr:2.0.6&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.felix.framework.util.SecureAction.stopActivator(SecureAction.java:719)&lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.felix.framework-5.6.1.jar:&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.felix.framework.Felix.stopBundle(Felix.java:2610)&lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.felix.framework-5.6.1.jar:&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.felix.framework.Felix.setActiveStartLevel(Felix.java:1389)&lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.felix.framework-5.6.1.jar:&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.felix.framework.FrameworkStartLevelImpl.run(FrameworkStartLevelImpl.java:308)&lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.felix.framework-5.6.1.jar:&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.8.0_111&amp;#93;&lt;/span&gt;&lt;/p&gt;</description>
                <environment>OS: linux and windows&lt;br/&gt;
Java Version: 1.8.0_111&lt;br/&gt;
OSGi Impl: Apache Felix (5.6.1)&lt;br/&gt;
</environment>
        <key id="13021209">FELIX-5416</key>
            <summary>Endless loop throwing InterruptedException when shutting down framework</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tjwatson">Tom Watson</assignee>
                                    <reporter username="bokie">Jorge Cercas</reporter>
                        <labels>
                    </labels>
                <created>Wed, 16 Nov 2016 17:54:46 +0000</created>
                <updated>Fri, 22 Sep 2017 08:55:30 +0000</updated>
                            <resolved>Tue, 20 Jun 2017 20:33:33 +0000</resolved>
                                    <version>scr-2.0.6</version>
                                    <fixVersion>scr-2.0.12</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15676557" author="bokie" created="Fri, 18 Nov 2016 11:54:16 +0000"  >&lt;p&gt;A little more information...&lt;/p&gt;

&lt;p&gt;Not sure why yet, but I&apos;ve noticed that the behavior described in the description is valid when installing and starting the SCR bundle as an &quot;initial&quot; bundle. In other words, when I don&apos;t install it as an initial bundle, put the jar file in a directory watched by FileInstall, let FileInstall manage its life-cycle, I don&apos;t notice the endless loop behavior.&lt;/p&gt;</comment>
                            <comment id="15694380" author="djencks" created="Thu, 24 Nov 2016 23:05:46 +0000"  >&lt;p&gt;I&apos;m not sure there&apos;s any evidence that scr is doing anything wrong.  I suggest you figure out what is interrupting the ComponentActorThread, take a thread dump to try to see what is stopping the ComponentActorThread from getting through all it&apos;s tasks, and turn on debug logging and examine the ComponentActorThread debug messages indicating what tasks are scheduled and executed.&lt;br/&gt;
I recall running into an interrupted exception on shutdown once but unfortunately I don&apos;t recall what caused it, although for some reason I keep thinking it was something  in the equinox framework.&lt;/p&gt;</comment>
                            <comment id="15928822" author="cziegeler" created="Thu, 16 Mar 2017 20:28:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bokie&quot; class=&quot;user-hover&quot; rel=&quot;bokie&quot;&gt;bokie&lt;/a&gt; Could you please provide more info as requested by David?&lt;/p&gt;</comment>
                            <comment id="16008115" author="cnoelle" created="Fri, 12 May 2017 13:23:04 +0000"  >&lt;p&gt;Seems to be a problem in the terminate method of ComponentActorThread (see below). Suppose we run into tasks.wait(), the thread gets interrupted, and the tasks lists is not empty yet. Then the catch block is executed, we interrupt the thread, and run into tasks.wait() again. But since the thread has been interrupted, another InterruptedException is raised immediately, and we are caught in a loop.&lt;/p&gt;

&lt;p&gt;I think that there should be either a return statement at the end of the catch block (then the remaining tasks in the list will not be executed), or the interrupt() call should be moved outside the while loop.&lt;/p&gt;

&lt;p&gt;void terminate()&lt;br/&gt;
    {&lt;br/&gt;
        schedule( TERMINATION_TASK );&lt;br/&gt;
        synchronized ( tasks )&lt;br/&gt;
        {&lt;br/&gt;
            while ( !tasks.isEmpty() )&lt;br/&gt;
            {&lt;br/&gt;
                try&lt;/p&gt;
                {
                    tasks.wait();
                }
&lt;p&gt;                catch ( InterruptedException e )&lt;/p&gt;
                {
                    Thread.currentThread().interrupt();
                    logger.log( LogService.LOG_ERROR, &quot;Interrupted exception waiting for queue to empty&quot;, e );
                }
&lt;p&gt;            }&lt;br/&gt;
        }&lt;br/&gt;
    }&lt;/p&gt;</comment>
                            <comment id="16056276" author="tjwatson" created="Tue, 20 Jun 2017 18:56:12 +0000"  >&lt;p&gt;This is a real issue and SCR code is wrong.  Here is the sequence of events that happen.&lt;/p&gt;

&lt;p&gt;1) The thread stopping the framework is interrupted (in this case it was gogo, but anything could do that).&lt;br/&gt;
2) The framework proceeds to stop the bundles&lt;br/&gt;
3) The SCR bundle is stopped (current thread is still interrupted)&lt;br/&gt;
4) SCR activator cases enters org.apache.felix.scr.impl.ComponentActorThread.terminate()&lt;br/&gt;
5) a TERMINATION_TASK is scheduled and the lock on &apos;tasks&apos; is immediately obtained&lt;/p&gt;

&lt;p&gt;Here is where the failure happens.  If the consuming task code in ComponentActorThread.run() does not obtain the &apos;tasks&apos; lock in order to consume the TERMINATION_TASK before step 5 obtains the &apos;tasks&apos; lock in order to wait for tasks to be empty we will enter an endless loop of interruptions and this all happens while holding the &apos;tasks&apos; lock which then also causes deadlock and prevention of the TERMINATION_TASK from ever being consumed.&lt;/p&gt;

&lt;p&gt;The terminate() method should be updated to something like the following in order to correctly ignore interrupted exceptions.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    void terminate()
    {
        schedule( TERMINATION_TASK );
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (tasks)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!tasks.isEmpty())
            {
                &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; interrupted = &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.interrupted();
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
                {
                    tasks.wait();
                }
                &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e)
                {
                    interrupted = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
                    logger.log(LogService.LOG_ERROR,
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;Interrupted exception waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; queue to empty&quot;&lt;/span&gt;, e);
                }
                &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt;
                {
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (interrupted)
                    { &lt;span class=&quot;code-comment&quot;&gt;// restore interrupt status
&lt;/span&gt;                        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
                    }
                }
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16056279" author="cnoelle" created="Tue, 20 Jun 2017 18:58:00 +0000"  >&lt;p&gt;Thank you for your email. Kindly be informed that I will be out of the office until July 1st.      &lt;/p&gt;

&lt;p&gt;Best regards,&lt;/p&gt;

&lt;p&gt;&amp;#8211; &lt;br/&gt;
Dr. Christoph N&#246;lle&lt;br/&gt;
Fraunhofer Institut f&#252;r Windenergie und Energiesystemtechnik IWES   &lt;br/&gt;
Division Systems Engineering and Distribution Grids&lt;br/&gt;
K&#246;nigstor 59,  34119 Kassel, Germany&lt;br/&gt;
Tel: +49 561 7294 492&lt;br/&gt;
Email: christoph.noelle@iwes.fraunhofer.de&lt;br/&gt;
&lt;a href=&quot;http://www.iwes.fraunhofer.de/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.iwes.fraunhofer.de/&lt;/a&gt;&lt;br/&gt;
www.ogema.org&lt;/p&gt;



&lt;p&gt;    [ &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5416?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel&amp;amp;focusedCommentId=16056276#comment-16056276&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FELIX-5416?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel&amp;amp;focusedCommentId=16056276#comment-16056276&lt;/a&gt; ] &lt;/p&gt;

&lt;p&gt;Thomas Watson commented on &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5416&quot; title=&quot;Endless loop throwing InterruptedException when shutting down framework&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5416&quot;&gt;&lt;del&gt;FELIX-5416&lt;/del&gt;&lt;/a&gt;:&lt;br/&gt;
--------------------------------------&lt;/p&gt;

&lt;p&gt;This is a real issue and SCR code is wrong.  Here is the sequence of events that happen.&lt;/p&gt;

&lt;p&gt;1) The thread stopping the framework is interrupted (in this case it was gogo, but anything could do that).&lt;br/&gt;
2) The framework proceeds to stop the bundles&lt;br/&gt;
3) The SCR bundle is stopped (current thread is still interrupted)&lt;br/&gt;
4) SCR activator cases enters org.apache.felix.scr.impl.ComponentActorThread.terminate()&lt;br/&gt;
5) a TERMINATION_TASK is scheduled and the lock on &apos;tasks&apos; is immediately obtained&lt;/p&gt;

&lt;p&gt;Here is where the failure happens.  If the consuming task code in ComponentActorThread.run() does not obtain the &apos;tasks&apos; lock in order to consume the TERMINATION_TASK before step 5 obtains the &apos;tasks&apos; lock in order to wait for tasks to be empty we will enter an endless loop of interruptions and this all happens while holding the &apos;tasks&apos; lock which then also causes deadlock and prevention of the TERMINATION_TASK from ever being consumed.&lt;/p&gt;

&lt;p&gt;The terminate() method should be updated to something like the following in order to correctly ignore interrupted exceptions.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    void terminate()
    {
        schedule( TERMINATION_TASK );
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!tasks.isEmpty()) {
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; interrupted = &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.interrupted();
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                tasks.wait();
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
                logger.log(LogService.LOG_ERROR,
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;Interrupted exception waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; queue to empty&quot;&lt;/span&gt;, e);
            } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (interrupted) { &lt;span class=&quot;code-comment&quot;&gt;// restore interrupt status
&lt;/span&gt;                    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
                }
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;




&lt;p&gt;&amp;#8211;&lt;br/&gt;
This message was sent by Atlassian JIRA&lt;br/&gt;
(v6.4.14#64029)&lt;/p&gt;
</comment>
                            <comment id="16056283" author="tjwatson" created="Tue, 20 Jun 2017 18:59:35 +0000"  >&lt;p&gt;The org.apache.felix.scr.impl.ComponentActorThread.run() has the same issue, but is less likely to happen because that is run on a thread that is &apos;private&apos; to SCR is is far less likely to be interrupted.&lt;/p&gt;</comment>
                            <comment id="16056413" author="tjwatson" created="Tue, 20 Jun 2017 20:33:33 +0000"  >&lt;p&gt;I release a fix to both the R6 and R7 impls.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 22 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i36etj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>