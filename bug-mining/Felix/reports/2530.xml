<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:59:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-4417] Circular references detected but not resolved if one of the references in the cycle has optional cardinality</title>
                <link>https://issues.apache.org/jira/browse/FELIX-4417</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;Looks like current Apache Felix SCR implementation doesn&apos;t conform fully to Declarative Services Specification, which says (&lt;a href=&quot;http://www.osgi.org/download/r4v43/osgi.cmpn-4.3.0.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.osgi.org/download/r4v43/osgi.cmpn-4.3.0.pdf&lt;/a&gt;, 112.3.7):&lt;/p&gt;

&lt;p&gt;&quot;Circular references must be detected by SCR when it attempts to satisfy component configurations and SCR must fail to satisfy the references involved in the cycle and log an error message with the Log Service, if present. However, if one of the references in the cycle has optional cardinality SCR must break the cycle. The reference with the optional cardinality can be satisfied and bound to zero target services. Therefore the cycle is broken and the other references may be satisfied.&quot;&lt;/p&gt;

&lt;p&gt;In case of two components, A and B, where A is delayed with 1..1 static reference to B, and B is immediate with 0..n dynamic reference to A, Felix SCR should:&lt;br/&gt;
1) activate B with dynamic reference to A satisfied and bound to zero services&lt;br/&gt;
2) activate A with satisfied static reference to B&lt;br/&gt;
3) bind dynamic reference to B in component A&lt;/p&gt;

&lt;p&gt;But it seems current Felix SCR implementation can&apos;t handle this kind of circular dependency correctly and is failing with message &quot;Circular reference detected&quot;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12693349">FELIX-4417</key>
            <summary>Circular references detected but not resolved if one of the references in the cycle has optional cardinality</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="6">Invalid</resolution>
                                        <assignee username="djencks">David Jencks</assignee>
                                    <reporter username="kapyar">Victor Antonovich</reporter>
                        <labels>
                    </labels>
                <created>Wed, 5 Feb 2014 14:18:07 +0000</created>
                <updated>Fri, 8 Jul 2016 08:05:10 +0000</updated>
                            <resolved>Sat, 21 May 2016 04:50:51 +0000</resolved>
                                    <version>scr-1.8.2</version>
                                    <fixVersion>scr-2.0.4</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>4</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13892135" author="kapyar" created="Wed, 5 Feb 2014 14:19:14 +0000"  >&lt;p&gt;Integration test case attached.&lt;/p&gt;</comment>
                            <comment id="13892218" author="kapyar" created="Wed, 5 Feb 2014 15:19:00 +0000"  >&lt;p&gt;Failed test case output log attached.&lt;/p&gt;</comment>
                            <comment id="13896360" author="kapyar" created="Mon, 10 Feb 2014 09:36:36 +0000"  >&lt;p&gt;By the way, attached test case is passing successfully if definitions of A and B components in integration_test_circular.xml are swapped (B is before A).&lt;/p&gt;</comment>
                            <comment id="14055996" author="markuska" created="Wed, 9 Jul 2014 08:29:11 +0000"  >&lt;p&gt;The problem is located in AbstractComponentManager.activateInternal right at the bottom of that method:&lt;br/&gt;
            if ( !registerService() )&lt;/p&gt;
            {
                //some other thread is activating us, or we got concurrently deactivated.
                return;
            }

&lt;p&gt;            if ( ( isImmediate() || getComponentMetadata().isFactory() ) )&lt;/p&gt;
            {
                getServiceInternal();
            }&lt;br/&gt;
        }&lt;br/&gt;
        finally&lt;br/&gt;
&lt;br/&gt;
First all services are registered and then inside getServiceInternal the component instance is created, which means that there exists a time slot where a ServiceReference is existing without having an actual instance.&lt;br/&gt;
&lt;br/&gt;
So when creating the instance of the immediate component B, it&apos;s service b is registered, then getServiceInternal is called, and within there a call to collectDependencies is executed. That goes to component A for service a, which in turn goes back to component B for service b.&lt;br/&gt;
Here getServiceInternal is entered again which causes the circular reference check to be hit, spitting out the &quot;Circular reference detected, getService returning null&quot;&lt;br/&gt;
&lt;br/&gt;
To solve that problem, the registering should be done AFTER the creation of the component:&lt;br/&gt;
            if ( ( isImmediate() || getComponentMetadata().isFactory() ) )&lt;br/&gt;
            {                getServiceInternal();            }

&lt;p&gt;            registerService();&lt;br/&gt;
        }&lt;br/&gt;
        finally&lt;/p&gt;

&lt;p&gt;With that change the CircularReferenceTest attached to this Jira succeeds (and as well all other tests still succeeding).&lt;/p&gt;

&lt;p&gt;Note that the eclispe SCR implementation is doing it in exactly this way, first create the instance, then register the services&lt;br/&gt;
&lt;a href=&quot;http://git.eclipse.org/c/equinox/rt.equinox.bundles.git/tree/bundles/org.eclipse.equinox.ds/src/org/eclipse/equinox/internal/ds/InstanceProcess.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git.eclipse.org/c/equinox/rt.equinox.bundles.git/tree/bundles/org.eclipse.equinox.ds/src/org/eclipse/equinox/internal/ds/InstanceProcess.java&lt;/a&gt;&lt;br/&gt;
At line 197 buildComponent is called where the instance is created and its activate is called, and at line 213 the services are registered.&lt;/p&gt;</comment>
                            <comment id="14126627" author="eruiz" created="Tue, 9 Sep 2014 05:25:25 +0000"  >&lt;p&gt;This is a serious problem, anyone knows a workaround?&lt;/p&gt;

&lt;p&gt;Any idea when the fix will be available?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="14127186" author="djencks" created="Tue, 9 Sep 2014 16:31:45 +0000"  >&lt;p&gt;Markus: The scr spec requires that the service be registered, and then (if immediate) the implementation object be created.  Sorry the eclipse implementation isn&apos;t spec compliant.  Felix used to have this order, and that just means that different circular dependency cases don&apos;t work.&lt;/p&gt;

&lt;p&gt;I haven&apos;t had time to investigate this particular case in detail to see exactly why it fails whereas so many others succeed.&lt;/p&gt;

&lt;p&gt;Enrique: There is a very effective workaround that will in my experience improve the design of your service dependencies and certainly make it more reliable: don&apos;t have any circular dependencies in the service reference graph.  If this path is not open to you, looking at the existing circular dependency test, it looks like making either both components immediate or both delayed will also work.&lt;/p&gt;
</comment>
                            <comment id="14128189" author="eruiz" created="Wed, 10 Sep 2014 07:43:19 +0000"  >&lt;p&gt;David: I totally agree, I will check the service reference graph.&lt;/p&gt;</comment>
                            <comment id="14128201" author="markuska" created="Wed, 10 Sep 2014 07:59:26 +0000"  >&lt;p&gt;David: Your comment is right, nevertheless the original complaint is still valid.&lt;br/&gt;
&quot;However, if one of the references in the cycle has optional cardinality SCR must break the cycle. The reference with the optional cardinality can be satisfied and bound to zero target services. Therefore the cycle is broken and the other references may be satisfied.&quot;&lt;br/&gt;
Felix SCR isn&apos;t compliant to that OSGi part.&lt;/p&gt;

&lt;p&gt;We do have the following use case, using that scheme:&lt;br/&gt;
Component B is responsible for a certain functionality, and registers an interface &quot;b&quot; as a service that provides access to some information of that functionality. As the information of that functionality can change during runtime, component B also defines another interface &quot;c&quot;, which can be implemented and registered by anybody that is interested in those changes. Component B is then binding &quot;c&quot; as 0..n (optional).&lt;br/&gt;
Component A is interested in the information of &quot;b&quot;, and needs to be informed about changes during runtime, thus A is then binding &quot;b&quot; unary (1..1) and providing &quot;c&quot; as a service.&lt;/p&gt;

&lt;p&gt;According OSGi chapter 112.3.7 this is a valid use case, to be supported by the SCR.&lt;br/&gt;
With the current implementation the Felix SCR does not differentiate between mandatory and optional references within the cycle detection. From implementation point of view this is not easy to solve, as in the context of component A it is not known that component B is binding &quot;c&quot; in an optional way.&lt;/p&gt;</comment>
                            <comment id="14952071" author="djencks" created="Sat, 10 Oct 2015 22:29:23 +0000"  >&lt;p&gt;I updated the test case and committed it in r1707925 so at least it won&apos;t get out of date again.  It looks to me like the behavior is currently spec compliant, in that both components get created successfully and A has a B reference.  B still does not have an A reference; I commented out the portion of the test case that tests this.&lt;/p&gt;</comment>
                            <comment id="15294708" author="djencks" created="Sat, 21 May 2016 04:50:51 +0000"  >&lt;p&gt;I looked into this more and AFAICT everything is actually working fine. Victor&apos;s test seems to pass if I insert a delay().  The spec doesn&apos;t require us to make &lt;em&gt;any&lt;/em&gt; of the optional dependencies in a cycle.  The current implementation tries to bind the dependencies on a separate thread, which means you might have to wait for them to appear.  The problem with trying to satisfy them on the invoking thread is that you run into the service registry circular reference tracking.  The problem with trying to satisfy them on another thread but wait for completion before returning is that the initial getService call into the service registry blocks all other threads until it returns.  So, after a couple of days reminding myself of why I adopted this solution originally, I again think this is the best we can do.  In r1744827 I improved the circular reference tracking and logging, so now at least it should be very clear what the circular reference is.&lt;/p&gt;</comment>
                            <comment id="15312928" author="djencks" created="Thu, 2 Jun 2016 19:40:17 +0000"  >&lt;p&gt;In r1746618 I improved the circular reference logging and fixed at least one bug introduced in the previous change, where a bogus circular reference was &quot;found&quot; when the activate method changed the service properties, resulting in a match and getService call.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12627130" name="CircularReferenceTest-trunk.patch" size="4073" author="kapyar" created="Wed, 5 Feb 2014 14:19:14 +0000"/>
                            <attachment id="12627135" name="CircularReferenceTest.zip" size="254896" author="kapyar" created="Wed, 5 Feb 2014 15:19:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>371934</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 24 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1s3kn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>372238</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>