<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:55:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-4670] Deadlock in Felix HTTP service</title>
                <link>https://issues.apache.org/jira/browse/FELIX-4670</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;When we startup our webapplication, we sometimes run into a deadlock:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;1LKDEADLOCK    Deadlock detected !!!
NULL           ---------------------
NULL           
2LKDEADLOCKTHR  &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;server.startup : 1&quot;&lt;/span&gt; (0x0000000001DDC800)
3LKDEADLOCKWTR    is waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;:
4LKDEADLOCKMON      sys_mon_t:0x00007FFFBBB61F20 infl_mon_t: 0x00007FFFBBB61F90:
4LKDEADLOCKOBJ      org/apache/felix/http/whiteboard/internal/manager/ExtenderManager@0x00000001014B3650/0x00000001014B365C: 
3LKDEADLOCKOWN    which is owned by:
2LKDEADLOCKTHR  &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;FelixStartLevel&quot;&lt;/span&gt; (0x0000000002156100)
3LKDEADLOCKWTR    which is waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;:
4LKDEADLOCKMON      sys_mon_t:0x00007FFFBBBBA340 infl_mon_t: 0x00007FFFBBBBA3B0:
4LKDEADLOCKOBJ      org/apache/felix/http/base/internal/handler/HandlerRegistry@0x00000001070D6EA0/0x00000001070D6EAC: 
3LKDEADLOCKOWN    which is owned by:
2LKDEADLOCKTHR  &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;server.startup : 1&quot;&lt;/span&gt; (0x0000000001DDC800)
NULL         
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The stacktrace of these 2 threads as indicated by the javacore file:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;3XMTHREADINFO      &lt;span class=&quot;code-quote&quot;&gt;&quot;FelixStartLevel&quot;&lt;/span&gt; J9VMThread:0x0000000002156100, j9thread_t:0x00007FFFC938B4B0, java/lang/&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;:0x0000000101580260, state:B, prio=5
3XMJAVALTHREAD            (java/lang/&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; getId:0x70, isDaemon:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
3XMTHREADINFO1            (&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; thread ID:0x5D3A, &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; priority:0x5, &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; policy:UNKNOWN)
3XMTHREADINFO2            (&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; stack address range from:0x00007FFFC530A000, to:0x00007FFFC534B000, size:0x41000)
3XMTHREADINFO3           Java callstack:
4XESTACKTRACE                at org/apache/felix/http/base/internal/service/HttpServiceImpl.unregisterFilter(HttpServiceImpl.java:140)    
4XESTACKTRACE                at org/apache/felix/http/base/internal/service/HttpServiceImpl.unregisterFilter(HttpServiceImpl.java:76)
4XESTACKTRACE                at org/apache/felix/http/whiteboard/internal/manager/FilterMapping.unregister(FilterMapping.java:90)
4XESTACKTRACE                at org/apache/felix/http/whiteboard/internal/manager/FilterMapping.unregister(FilterMapping.java:83)
4XESTACKTRACE                at org/apache/felix/http/whiteboard/internal/manager/ExtenderManager.unregisterMapping(ExtenderManager.java:270)
4XESTACKTRACE                at org/apache/felix/http/whiteboard/internal/manager/ExtenderManager.removeMapping(ExtenderManager.java:252)      
4XESTACKTRACE                at org/apache/felix/http/whiteboard/internal/manager/ExtenderManager.remove(ExtenderManager.java:183)
4XESTACKTRACE                at org/apache/felix/http/whiteboard/internal/tracker/FilterTracker.removed(FilterTracker.java:48)
4XESTACKTRACE                at org/apache/felix/http/whiteboard/internal/tracker/FilterTracker.removed(FilterTracker.java:24)
4XESTACKTRACE                at org/apache/felix/http/whiteboard/internal/tracker/AbstractTracker.removedService(AbstractTracker.java:52)
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:956)
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:864)
4XESTACKTRACE                at org/osgi/util/tracker/AbstractTracked.untrack(AbstractTracked.java:341(Compiled Code))
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:902(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.fireEventImmediately(EventDispatcher.java:793(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.fireServiceEvent(EventDispatcher.java:543(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/Felix.fireServiceEvent(Felix.java:4401(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/Felix.access$000(Felix.java:74(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/Felix$1.serviceChanged(Felix.java:390(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/ServiceRegistry.unregisterService(ServiceRegistry.java:151(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:127(Compiled Code))
4XESTACKTRACE                at org/apache/felix/scr/impl/manager/AbstractComponentManager.unregisterComponentService(AbstractComponentManager.java:702(Compiled Code))
4XESTACKTRACE                at org/apache/felix/scr/impl/manager/AbstractComponentManager$State.doDeactivate(AbstractComponentManager.java:1301(Compiled Code))
4XESTACKTRACE                at org/apache/felix/scr/impl/manager/AbstractComponentManager$Satisfied.dispose(AbstractComponentManager.java:1617)
4XESTACKTRACE                at org/apache/felix/scr/impl/manager/AbstractComponentManager.disposeInternal(AbstractComponentManager.java:574(Compiled Code))
4XESTACKTRACE                at org/apache/felix/scr/impl/manager/AbstractComponentManager.dispose(AbstractComponentManager.java:404(Compiled Code))
4XESTACKTRACE                at org/apache/felix/scr/impl/config/ImmediateComponentHolder.disposeComponents(ImmediateComponentHolder.java:371(Compiled Code))
4XESTACKTRACE                at org/apache/felix/scr/impl/BundleComponentActivator.dispose(BundleComponentActivator.java:320(Compiled Code))
4XESTACKTRACE                at org/apache/felix/scr/impl/Activator.disposeComponents(Activator.java:316)
4XESTACKTRACE                at org/apache/felix/scr/impl/Activator.bundleChanged(Activator.java:183(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.invokeBundleListenerCallback(EventDispatcher.java:868(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.fireEventImmediately(EventDispatcher.java:789(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.fireBundleEvent(EventDispatcher.java:514(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/Felix.fireBundleEvent(Felix.java:4385(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/Felix.stopBundle(Felix.java:2508)
4XESTACKTRACE                at org/apache/felix/framework/Felix.setActiveStartLevel(Felix.java:1297(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/FrameworkStartLevelImpl.run(FrameworkStartLevelImpl.java:304)
4XESTACKTRACE                at java/lang/&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:761)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;3XMTHREADINFO      &lt;span class=&quot;code-quote&quot;&gt;&quot;server.startup : 1&quot;&lt;/span&gt; J9VMThread:0x0000000001DDC800, j9thread_t:0x00007FFFC8C61340, java/lang/&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;:0x00000001014B35A8, state:B, prio=5
3XMJAVALTHREAD            (java/lang/&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; getId:0x68, isDaemon:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
3XMTHREADINFO1            (&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; thread ID:0x5A08, &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; priority:0x5, &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; policy:UNKNOWN)
3XMTHREADINFO2            (&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; stack address range from:0x00007FFFC64D4000, to:0x00007FFFC6515000, size:0x41000)
3XMTHREADINFO3           Java callstack:
4XESTACKTRACE                at org/apache/felix/http/whiteboard/internal/manager/ExtenderManager.remove(ExtenderManager.java:183)
4XESTACKTRACE                at org/apache/felix/http/whiteboard/internal/tracker/ServletTracker.removed(ServletTracker.java:48)
4XESTACKTRACE                at org/apache/felix/http/whiteboard/internal/tracker/ServletTracker.removed(ServletTracker.java:24)
4XESTACKTRACE                at org/apache/felix/http/whiteboard/internal/tracker/AbstractTracker.removedService(AbstractTracker.java:52)
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:956)
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.customizerRemoved(ServiceTracker.java:864)
4XESTACKTRACE                at org/osgi/util/tracker/AbstractTracked.untrack(AbstractTracked.java:341(Compiled Code))
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:902(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.invokeServiceLi	stenerCallback(EventDispatcher.java:932(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.fireEventImmediately(EventDispatcher.java:793(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.fireServiceEvent(EventDispatcher.java:543(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/Felix.fireServiceEvent(Felix.java:4401(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/Felix.access$000(Felix.java:74(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/Felix$1.serviceChanged(Felix.java:390(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/ServiceRegistry.unregisterService(ServiceRegistry.java:151(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:127(Compiled Code))
4XESTACKTRACE                at org/apache/felix/inventory/impl/InventoryPrinterAdapter.unregisterConsole(InventoryPrinterAdapter.java:84)
4XESTACKTRACE                at org/apache/felix/inventory/impl/InventoryPrinterManagerImpl.addService(InventoryPrinterManagerImpl.java:196)
4XESTACKTRACE                at org/apache/felix/inventory/impl/InventoryPrinterManagerImpl.addingService(InventoryPrinterManagerImpl.java:128)
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:932(Compiled Code))
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:864(Compiled Code))
4XESTACKTRACE                at org/osgi/util/tracker/AbstractTracked.trackAdding(AbstractTracked.java:256(Compiled Code))
4XESTACKTRACE                at org/osgi/util/tracker/AbstractTracked.track(AbstractTracked.java:229(Compiled Code))
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:894(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.fireEventImmediately(EventDispatcher.java:793(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.fireServiceEvent(EventDispatcher.java:543(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/Felix.fireServiceEvent(Felix.java:4401(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/Felix.registerService(Felix.java:3411(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/BundleContextImpl.registerService(BundleContextImpl.java:346(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/BundleContextImpl.registerService(BundleContextImpl.java:320)
4XESTACKTRACE                at org/apache/felix/inventory/impl/webconsole/WebConsoleAdapter.add(WebConsoleAdapter.java:125)
4XESTACKTRACE                at org/apache/felix/inventory/impl/webconsole/WebConsoleAdapter.addingService(WebConsoleAdapter.java:155)
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:932(Compiled Code))
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:864(Compiled Code))
4XESTACKTRACE                at org/osgi/util/tracker/AbstractTracked.trackAdding(AbstractTracked.java:256(Compiled Code))
4XESTACKTRACE                at org/osgi/util/tracker/AbstractTracked.track(AbstractTracked.java:229(Compiled Code))
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:894(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.fireEventImmediately(EventDispatcher.java:793(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.fireServiceEvent(EventDispatcher.java:543(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/Felix.fireServiceEvent(Felix.java:4401(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/Felix.registerService(Felix.java:3411(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/BundleContextImpl.registerService(BundleContextImpl.java:346(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/BundleContextImpl.registerService(BundleContextImpl.java:320)
4XESTACKTRACE                at de/xxx/yyy/modules/common/servlet/dispatcher/jsp/JspTldLocationsCache.&amp;lt;init&amp;gt;(JspTldLocationsCache.java:81)
4XESTACKTRACE                at de/xxx/yyy/modules/common/servlet/dispatcher/jsp/engine/JspScriptEngineFactory.activate(JspScriptEngineFactory.java:235)
4XESTACKTRACE                at de/xxx/yyy/modules/common/servlet/ContainerServlet.init(ContainerServlet.java:96)
4XESTACKTRACE                at org/apache/felix/http/base/internal/handler/ServletHandler.init(ServletHandler.java:55)
4XESTACKTRACE                at org/apache/felix/http/base/internal/handler/HandlerRegistry.addServlet(HandlerRegistry.java:65)                     
4XESTACKTRACE                at org/apache/felix/http/base/internal/service/HttpServiceImpl.registerServlet(HttpServiceImpl.java:95)
4XESTACKTRACE                at de/xxx/yyy/modules/common/osgi/webapp/WebappModuleServiceTracker.addingService(WebappModuleServiceTracker.java:82)
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:932(Compiled Code))
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:864(Compiled Code))
4XESTACKTRACE                at org/osgi/util/tracker/AbstractTracked.trackAdding(AbstractTracked.java:256(Compiled Code))
4XESTACKTRACE                at org/osgi/util/tracker/AbstractTracked.track(AbstractTracked.java:229(Compiled Code))
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.serviceChanged(ServiceTracker.java:894(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:932(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.fireEventImmediately(EventDispatcher.java:793(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/util/EventDispatcher.fireServiceEvent(EventDispatcher.java:543(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/Felix.fireServiceEvent(Felix.java:4401(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/Felix.registerService(Felix.java:3411(Compiled Code))
4XESTACKTRACE                at org/apache/felix/framework/BundleContextImpl.registerService(BundleContextImpl.java:346(Compiled Code))
4XESTACKTRACE                at org/apache/felix/http/base/internal/HttpServiceController.register(HttpServiceController.java:135)
4XESTACKTRACE                at org/apache/felix/http/base/internal/DispatcherServlet.init(DispatcherServlet.java:48)
4XESTACKTRACE                at org/apache/felix/http/proxy/DispatcherTracker.initDispatcher(DispatcherTracker.java:97)
4XESTACKTRACE                at org/apache/felix/http/proxy/DispatcherTracker.setDispatcher(DispatcherTracker.java:77)
4XESTACKTRACE                at org/apache/felix/http/proxy/DispatcherTracker.addingService(DispatcherTracker.java:52)
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:932)
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:864)
4XESTACKTRACE                at org/osgi/util/tracker/AbstractTracked.trackAdding(AbstractTracked.java:256(Compiled Code))
4XESTACKTRACE                at org/osgi/util/tracker/AbstractTracked.trackInitial(AbstractTracked.java:183(Compiled Code))
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker.open(ServiceTracker.java:317)
4XESTACKTRACE                at org/osgi/util/tracker/ServiceTracker.open(ServiceTracker.java:261)
4XESTACKTRACE                at org/apache/felix/http/proxy/ProxyServlet.doInit(ProxyServlet.java:51)
4XESTACKTRACE                at org/apache/felix/http/proxy/ProxyServlet.init(ProxyServlet.java:39)
4XESTACKTRACE                at org/apache/sling/launchpad/base/webapp/SlingServletDelegate.init(SlingServletDelegate.java:208)
4XESTACKTRACE                at javax/servlet/GenericServlet.init(GenericServlet.java:241)
4XESTACKTRACE                at org/apache/sling/launchpad/webapp/SlingServlet.startSling(SlingServlet.java:384)
4XESTACKTRACE                at org/apache/sling/launchpad/webapp/SlingServlet.startSling(SlingServlet.java:325)
4XESTACKTRACE                at org/apache/sling/launchpad/webapp/SlingServlet.init(SlingServlet.java:118)
4XESTACKTRACE                at javax/servlet/GenericServlet.init(GenericServlet.java:241)
4XESTACKTRACE                at com/ibm/ws/webcontainer/servlet/ServletWrapper.init(ServletWrapper.java:363)
4XESTACKTRACE                at com/ibm/ws/webcontainer/servlet/ServletWrapperImpl.init(ServletWrapperImpl.java:171)
4XESTACKTRACE                at com/ibm/ws/webcontainer/servlet/ServletWrapper.initialize(ServletWrapper.java:1844)
4XESTACKTRACE                at com/ibm/wsspi/webcontainer/extension/WebExtensionProcessor.createServletWrapper(WebExtensionProcessor.java:98)
4XESTACKTRACE                at com/ibm/ws/webcontainer/webapp/WebApp.getServletWrapper(WebApp.java:1048(Compiled Code))
4XESTACKTRACE                at com/ibm/ws/webcontainer/webapp/WebApp.getServletWrapper(WebApp.java:969)
4XESTACKTRACE                at com/ibm/ws/webcontainer/webapp/WebApp.initializeTargetMappings(WebApp.java:648(Compiled Code))
4XESTACKTRACE                at com/ibm/ws/webcontainer/webapp/WebApp.commonInitializationFinally(WebApp.java:450)
4XESTACKTRACE                at com/ibm/ws/webcontainer/webapp/WebAppImpl.initialize(WebAppImpl.java:304(Compiled Code))
4XESTACKTRACE                at com/ibm/ws/webcontainer/webapp/WebGroupImpl.addWebApplication(WebGroupImpl.java:100)
4XESTACKTRACE                at com/ibm/ws/webcontainer/VirtualHostImpl.addWebApplication(VirtualHostImpl.java:166)
4XESTACKTRACE                at com/ibm/ws/webcontainer/WSWebContainer.addWebApp(WSWebContainer.java:732)
4XESTACKTRACE                at com/ibm/ws/webcontainer/WSWebContainer.addWebApplication(WSWebContainer.java:617)
4XESTACKTRACE                at com/ibm/ws/webcontainer/component/WebContainerImpl.install(WebContainerImpl.java:376)
4XESTACKTRACE                at com/ibm/ws/webcontainer/component/WebContainerImpl.start(WebContainerImpl.java:668)
4XESTACKTRACE                at com/ibm/ws/runtime/component/ApplicationMgrImpl.start(ApplicationMgrImpl.java:1128(Compiled Code))
4XESTACKTRACE                at com/ibm/ws/runtime/component/DeployedApplicationImpl.fireDeployedObjectStart(DeployedApplicationImpl.java:1319)
4XESTACKTRACE                at com/ibm/ws/runtime/component/DeployedModuleImpl.start(DeployedModuleImpl.java:611(Compiled Code))
4XESTACKTRACE                at com/ibm/ws/runtime/component/DeployedApplicationImpl.start(DeployedApplicationImpl.java:944(Compiled Code))
4XESTACKTRACE                at com/ibm/ws/runtime/component/ApplicationMgrImpl.startApplication(ApplicationMgrImpl.java:741(Compiled Code))
4XESTACKTRACE                at com/ibm/ws/runtime/component/ApplicationMgrImpl$3.run(ApplicationMgrImpl.java:2056)
4XESTACKTRACE                at com/ibm/ws/security/auth/ContextManagerImpl.runAs(ContextManagerImpl.java:5395)
4XESTACKTRACE                at com/ibm/ws/security/auth/ContextManagerImpl.runAsSystem(ContextManagerImpl.java:5483)
4XESTACKTRACE                at com/ibm/ws/security/core/SecurityContext.runAsSystem(SecurityContext.java:255)
4XESTACKTRACE                at com/ibm/ws/runtime/component/ApplicationMgrImpl.start(ApplicationMgrImpl.java:2061)
4XESTACKTRACE                at com/ibm/ws/runtime/component/CompositionUnitMgrImpl.start(CompositionUnitMgrImpl.java:389(Compiled Code))
4XESTACKTRACE                at com/ibm/ws/runtime/component/CompositionUnitImpl.start(CompositionUnitImpl.java:123)
4XESTACKTRACE                at com/ibm/ws/runtime/component/CompositionUnitMgrImpl.start(CompositionUnitMgrImpl.java:332)
4XESTACKTRACE                at com/ibm/ws/runtime/component/CompositionUnitMgrImpl.access$300(CompositionUnitMgrImpl.java:117)
4XESTACKTRACE                at com/ibm/ws/runtime/component/CompositionUnitMgrImpl$CUInitializer.run(CompositionUnitMgrImpl.java:899)
4XESTACKTRACE                at com/ibm/wsspi/runtime/component/WsComponentImpl$_AsynchInitializer.run(WsComponentImpl.java:496)
4XESTACKTRACE                at com/ibm/ws/util/ThreadPool$Worker.run(ThreadPool.java:1656(Compiled Code))

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We run into this quite often, so it&apos;s kind of reproducible. We have the same behaviour as well with other thread combinations (e.g. Sling Notifier and FelixFrameworkWiring) hitting the same locks.&lt;/p&gt;
</description>
                <environment>Websphere 7.0, IBM Java 6.0</environment>
        <key id="12748034">FELIX-4670</key>
            <summary>Deadlock in Felix HTTP service</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="joerghoh">Joerg Hoh</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Oct 2014 14:01:08 +0000</created>
                <updated>Tue, 11 Nov 2014 11:43:45 +0000</updated>
                            <resolved>Thu, 16 Oct 2014 09:37:20 +0000</resolved>
                                    <version>http-2.2.0</version>
                                    <fixVersion>http-2.3.2</fixVersion>
                                    <component>HTTP Service</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14171118" author="bosschaert" created="Tue, 14 Oct 2014 16:17:33 +0000"  >&lt;p&gt;If I look at the latest codebase, the APIs are slightly different (ExtenderManager.remove() has been replaced by ExtenderManager.removeServlet()) but in essence the locks seem to be the same.&lt;/p&gt;

&lt;p&gt;Both stack traces originate from the AbstractTracker (which calls down into ServletTracker/FilterTracker). These then call ExtenderManager.removeServlet()/removeFilter(). &lt;/p&gt;

&lt;p&gt;I&apos;m wondering whether it would help putting the calls to ExtenderManager from ServletTracker/FilterTracker in a separate thread. That would allow the initiating threads to continue and potentially release the locks that they have been holding on to. I guess there would not be any issues in relation to processing these servlet events asynchronously (note that the Trackers are synchronous in nature, see OSGi Tracker spec section 701.2.5).&lt;/p&gt;

&lt;p&gt;Any other thoughts?&lt;/p&gt;</comment>
                            <comment id="14172143" author="bosschaert" created="Wed, 15 Oct 2014 08:35:36 +0000"  >&lt;p&gt;This patch processes the handling of the tracker callbacks in a separate thread which should break the deadlock.&lt;/p&gt;

&lt;p&gt;The patch also brings the use of trackers in line with what the OSGi spec says in section 701.2.5:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Trackers use synchronous listeners; the callbacks are called on the same thread as that of the initiating event. Care should be taken to not linger in the callback and perform non-trivial work. Callbacks should return immediately and move substantial work to other threads.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="14172162" author="jajans" created="Wed, 15 Oct 2014 09:03:13 +0000"  >&lt;p&gt;I&apos;m fine with the proposed change, the only thing I would do differently is make use of an ExecutorService to manage threads for us instead of creating threads manually. This would also take care of the lifecycle of the threads when the whiteboard bundle itself is started/stopped.&lt;/p&gt;

&lt;p&gt;(The JettyService also uses an ExecutorService, in case you need a more detailed example).&lt;/p&gt;</comment>
                            <comment id="14172221" author="bosschaert" created="Wed, 15 Oct 2014 10:07:38 +0000"  >&lt;p&gt;After some further feedback I have come up with an alternative implementation (felix_4680_alt.diff) that does not involve separate threads. It removes the need for synchronization on the HandlerRegistry, one of the locks in this deadlock. &lt;/p&gt;

&lt;p&gt;This is done by using concurrent maps. Note that the atomicity to ConcurrentMap is only guaranteed per single call, therefore I had to move handler.init() in the add methods to before the putIfAbsent call. An optimistic approach if you like. However this means that if the handler cannot be added an extra destroy() call was needed.&lt;/p&gt;

&lt;p&gt;What do people think? Is this a better approach than with the threading? If there is consensus that this is a better idea I&apos;ll also provide unit tests.&lt;/p&gt;</comment>
                            <comment id="14172318" author="cziegeler" created="Wed, 15 Oct 2014 12:41:20 +0000"  >&lt;p&gt;I like this more, to more asynchronous stuff kills you eventually &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;What about doing a get() call on the concurrent map before doing handler.init() ? If get returns something, you can skip the rest. Otherwise you do the optimistic init(), putIfAbsent() stuff&lt;/p&gt;</comment>
                            <comment id="14172324" author="bosschaert" created="Wed, 15 Oct 2014 12:45:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;What about doing a get() call on the concurrent map before doing handler.init() ? If get returns something, you can skip the rest. Otherwise you do the optimistic init(), putIfAbsent() stuff&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right so that might save you from some unnecessary inits. There is still a theoretic possibility that someone else adds the servlet/filter between doing that get() and the putIfAbsent(), so I think that code should stay there but an additional get in front might be good as it should catch &amp;gt;99% of the cases.&lt;/p&gt;</comment>
                            <comment id="14172832" author="bosschaert" created="Wed, 15 Oct 2014 19:38:33 +0000"  >&lt;p&gt;I thought a little more about doing a get() call before doing the init() but I think there is an issue with that. Basically there is a window of opportunity where a servlet is removed between that get() call and the putIfAbsent() which means that a servlet/filter may not get added even though the alias/servlet (or filter) isn&apos;t there.&lt;/p&gt;

&lt;p&gt;Therefore I think it might be better to not do the additional get() and simply do the atomic putIfAbsent(). I&apos;ll put some code in that makes sure that init() doesn&apos;t get called multiple times without destroy in between.&lt;/p&gt;</comment>
                            <comment id="14172890" author="bosschaert" created="Wed, 15 Oct 2014 20:28:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;ll put some code in that makes sure that init() doesn&apos;t get called multiple times without destroy in between.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Actually, that piece turns out to be quite tricky, as you don&apos;t know from a Servlet itself whether it has been inited, which means you need to add synchronization again to check this in a separate datastructure, and the synchronization was what we were trying to remove. &lt;br/&gt;
So I think that there is a risk that init() gets called more than once if someone tries to add the actual same servlet twice, but that is an error condition anyway and an exception will get thrown, so I think it might be ok to leave it at that.&lt;/p&gt;</comment>
                            <comment id="14173379" author="cziegeler" created="Thu, 16 Oct 2014 05:17:22 +0000"  >&lt;p&gt;Yes, I agree on your previous points. But I&apos;m wondering if the code is complete anyway. I assume there is a clash if two servlets try to register for the same path. The first one succeeds, the second one fails. If now the first one is unregistered, is the second one registered?&lt;/p&gt;</comment>
                            <comment id="14173444" author="jajans" created="Thu, 16 Oct 2014 06:50:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;Actually, that piece turns out to be quite tricky, as you don&apos;t know from a Servlet itself whether it has been inited, which means you need to add synchronization again to check this in a separate datastructure, and the synchronization was what we were trying to remove. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;A trick you could use is wrapping the actual servlet in an adapter class that simply delegates all calls directly to the real servlet, but allows you to add an additional method that returns whether or not init() has been called. IIRC, this is also how Jetty does this.&lt;/p&gt;</comment>
                            <comment id="14173457" author="bosschaert" created="Thu, 16 Oct 2014 07:02:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I assume there is a clash if two servlets try to register for the same path. The first one succeeds, the second one fails. If now the first one is unregistered, is the second one registered?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The second one will receive an exception on registration. That should be enough for the registering agent to know that it failed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; There&apos;s no automatic retry in case the first one is removed. Or is that not what you meant?&lt;/p&gt;</comment>
                            <comment id="14173461" author="bosschaert" created="Thu, 16 Oct 2014 07:07:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jajans&quot; class=&quot;user-hover&quot; rel=&quot;jajans&quot;&gt;jajans&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;A trick you could use is wrapping the actual servlet in an adapter class that simply delegates all calls directly to the real servlet, but allows you to add an additional method that returns whether or not init() has been called. IIRC, this is also how Jetty does this.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Then you still need to keep track of what wrapper belongs to what servlet. User code simply calls registerServlet() with the bare servlet, so you&apos;d have to be able to find the wrapper if you created before. &lt;/p&gt;

&lt;p&gt;I think a slightly simpler solution would be to simply keep track of the servlets that have been inited in the HandlerRegistry. I think it can be done without synchronization but I wonder whether it&apos;s really worth the effort since registering the same servlet instance is an error condition and an exception is thrown directly after anyway.&lt;/p&gt;</comment>
                            <comment id="14173501" author="bosschaert" created="Thu, 16 Oct 2014 07:50:46 +0000"  >&lt;p&gt;I&apos;ve removed the attachments as I&apos;ve made a few tiny tweaks and added unit tests. If nobody complains I&apos;ll commit this soon.&lt;/p&gt;</comment>
                            <comment id="14173531" author="cziegeler" created="Thu, 16 Oct 2014 08:33:48 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14173580" author="bosschaert" created="Thu, 16 Oct 2014 09:37:20 +0000"  >&lt;p&gt;Resolved in &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1632257&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1632257&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 5 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i215kv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>