<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:03:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5302] NPE using Http Whiteboard</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5302</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;I am getting this NPE about 50% of the time after reconfiguring my servlet (causing it to unregister and re-register):&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.felix.http.jetty:3.2.0&amp;#93;&lt;/span&gt; Exception while processing request to /hello/sayHello&lt;/p&gt;

&lt;p&gt;java.lang.NullPointerException: null&lt;br/&gt;
org.apache.felix.http.base.internal.handler.ServletHandler.handle(ServletHandler.java:85)&lt;br/&gt;
org.apache.felix.http.base.internal.dispatch.InvocationChain.doFilter(InvocationChain.java:79)&lt;br/&gt;
org.apache.felix.http.base.internal.dispatch.Dispatcher.dispatch(Dispatcher.java:124)&lt;br/&gt;
org.apache.felix.http.base.internal.DispatcherServlet.service(DispatcherServlet.java:61)&lt;br/&gt;
javax.servlet.http.HttpServlet.service(HttpServlet.java:725)&lt;br/&gt;
org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:845)&lt;br/&gt;
org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:583)&lt;br/&gt;
org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:224)&lt;br/&gt;
org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1160)&lt;br/&gt;
org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:511)&lt;br/&gt;
org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)&lt;br/&gt;
org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1092)&lt;br/&gt;
org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)&lt;br/&gt;
org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)&lt;br/&gt;
org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)&lt;br/&gt;
org.eclipse.jetty.server.Server.handle(Server.java:518)&lt;br/&gt;
org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:308)&lt;br/&gt;
org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:244)&lt;br/&gt;
org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:273)&lt;br/&gt;
org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:95)&lt;br/&gt;
org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)&lt;br/&gt;
org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceAndRun(ExecuteProduceConsume.java:246)&lt;br/&gt;
org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:156)&lt;br/&gt;
org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:654)&lt;br/&gt;
org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:572)&lt;br/&gt;
java.lang.Thread.run(Thread.java:745)&lt;/p&gt;


&lt;p&gt;The servlet uses the Http Whiteboard:&lt;/p&gt;

&lt;p&gt;@Component(&lt;br/&gt;
        property = &lt;/p&gt;
{        HttpWhiteboardConstants.HTTP_WHITEBOARD_SERVLET_PATTERN + &quot;=/hello/sayHello&quot;,        HttpWhiteboardConstants.HTTP_WHITEBOARD_RESOURCE_PATTERN + &quot;=/hello/static/*&quot;,
HttpWhiteboardConstants.HTTP_WHITEBOARD_RESOURCE_PREFIX + &quot;=/static&quot;}
&lt;p&gt;)&lt;br/&gt;
public class HelloWorldServlet extends HttpServlet implements Servlet {&lt;br/&gt;
}&lt;/p&gt;


&lt;p&gt;About 50% of the time when I initially deploy the Servlet, I&apos;ve noticed that ServletRegistry.addServlet() is called twice for the same servlet with the same serviceId.&lt;/p&gt;

&lt;p&gt;I don&apos;t know why this happens, but when it does it leads to the NPE above.&lt;/p&gt;

&lt;p&gt;The second addServlet() invokes addToInactiveList().&lt;br/&gt;
The system works in this state, but it has a duplicate servlet handler in the inactive list.&lt;/p&gt;

&lt;p&gt;If the servlet is now reconfigured, causing it to unregister and re-register, we get the NPE above on the next request.&lt;/p&gt;

&lt;p&gt;This appears to be because ServletRegistry.removeServlet() fails to invoke&lt;br/&gt;
&quot;resolvers.remove(regHandler)&quot;, when the inactive list contains the argument ServletInfo.&lt;/p&gt;

&lt;p&gt;Alternatively, addServlet() should never allow a duplicate registration to be added to the inactive list.&lt;/p&gt;


</description>
                <environment></environment>
        <key id="12987167">FELIX-5302</key>
            <summary>NPE using Http Whiteboard</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cziegeler">Carsten Ziegeler</assignee>
                                    <reporter username="db82407">Derek Baum</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Jul 2016 14:42:07 +0000</created>
                <updated>Thu, 21 Jul 2016 11:48:56 +0000</updated>
                            <resolved>Fri, 8 Jul 2016 10:15:13 +0000</resolved>
                                    <version>http.base-3.0.8</version>
                    <version>http.jetty-3.2.0</version>
                    <version>http.bridge-3.0.8</version>
                                    <fixVersion>http.base-3.0.10</fixVersion>
                    <fixVersion>http.jetty-3.2.2</fixVersion>
                    <fixVersion>http.bridge-3.0.10</fixVersion>
                                    <component>HTTP Service</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15365870" author="cziegeler" created="Thu, 7 Jul 2016 09:29:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=db82407&quot; class=&quot;user-hover&quot; rel=&quot;db82407&quot;&gt;db82407&lt;/a&gt; Would it be possible to attach a bundle for testing? Or could you post the stack trace for the two addServlet calls?&lt;/p&gt;</comment>
                            <comment id="15365944" author="db82407" created="Thu, 7 Jul 2016 10:57:35 +0000"  >&lt;p&gt;Hi Carsten,&lt;/p&gt;

&lt;p&gt;I&apos;m attaching the stack traces first as it&apos;s easier.&lt;/p&gt;

&lt;p&gt;I&apos;ll look into attaching some bundles/test-case, but that will take longer.&lt;/p&gt;

&lt;p&gt;The stack trace is generated using the SVN head built locally.&lt;/p&gt;

&lt;p&gt;I&apos;ve also added two log messages so that I can determine whether it is a good or bad startup. I&apos;ve done this without affecting the line numbers.&lt;/p&gt;

&lt;p&gt;line 127 (patterns.add(pattern)&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I&apos;ve appended:&lt;br/&gt;
log(&quot;addServlet: pattern=&quot; + pattern + &quot; serviceId=&quot; + handler.getServletInfo().getServiceId()); Thread.dumpStack();&lt;/p&gt;

&lt;p&gt;line 155 (this.addToInactiveList(pattern, handler, status)&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I&apos;ve appended:&lt;br/&gt;
log(&quot;addServlet: addToInactiveList&quot;);&lt;/p&gt;

&lt;p&gt;The bad.log will fail on the next request with the NPE after the servlet is unregistered/re-registered.&lt;/p&gt;</comment>
                            <comment id="15365958" author="cziegeler" created="Thu, 7 Jul 2016 11:21:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=db82407&quot; class=&quot;user-hover&quot; rel=&quot;db82407&quot;&gt;db82407&lt;/a&gt; Thanks, that&apos;s great, would it be possible for you to check whether&lt;br/&gt;
org.apache.felix.http.base.internal.whiteboard.tracker.WhiteboardServiceTracker.addingService(WhiteboardServiceTracker.java:36)&lt;br/&gt;
is called twice with the same service in the bad case or just once?&lt;/p&gt;</comment>
                            <comment id="15366001" author="db82407" created="Thu, 7 Jul 2016 12:14:52 +0000"  >&lt;p&gt;I added logging to addingService(), modifiedService() and removedService().&lt;br/&gt;
Here is the output in the bad case, including the previous logging, but without the stack trace:&lt;/p&gt;

&lt;p&gt;WhiteboardServiceTracker: addingService: id=15 ref=&lt;span class=&quot;error&quot;&gt;&amp;#91;javax.servlet.Servlet&amp;#93;&lt;/span&gt;&lt;br/&gt;
ServletRegistry: addServlet: pattern=/hello/static/* serviceId=15&lt;br/&gt;
java.lang.Exception: Stack trace&lt;br/&gt;
ServletRegistry: addServlet: pattern=/hello/sayHello serviceId=15&lt;br/&gt;
java.lang.Exception: Stack trace&lt;br/&gt;
WhiteboardServiceTracker: addingService: id=15 ref=&lt;span class=&quot;error&quot;&gt;&amp;#91;javax.servlet.Servlet&amp;#93;&lt;/span&gt;&lt;br/&gt;
WhiteboardServiceTracker: removedService: id=15 ref=&lt;span class=&quot;error&quot;&gt;&amp;#91;javax.servlet.Servlet&amp;#93;&lt;/span&gt;&lt;br/&gt;
WhiteboardServiceTracker: removedService: id=15 ref=&lt;span class=&quot;error&quot;&gt;&amp;#91;javax.servlet.Servlet&amp;#93;&lt;/span&gt;&lt;br/&gt;
WhiteboardServiceTracker: addingService: id=15 ref=&lt;span class=&quot;error&quot;&gt;&amp;#91;javax.servlet.Servlet&amp;#93;&lt;/span&gt;&lt;br/&gt;
ServletRegistry: addServlet: pattern=/hello/sayHello serviceId=15&lt;br/&gt;
java.lang.Exception: Stack trace&lt;br/&gt;
ServletRegistry: addServlet: pattern=/hello/static/* serviceId=15&lt;br/&gt;
java.lang.Exception: Stack trace&lt;br/&gt;
ServletRegistry: addServlet: pattern=/hello/sayHello serviceId=15&lt;br/&gt;
java.lang.Exception: Stack trace&lt;br/&gt;
ServletRegistry: addServlet: addToInactiveList&lt;br/&gt;
WhiteboardServiceTracker: addingService: id=15 ref=&lt;span class=&quot;error&quot;&gt;&amp;#91;javax.servlet.Servlet&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="15366044" author="cziegeler" created="Thu, 7 Jul 2016 12:47:20 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=db82407&quot; class=&quot;user-hover&quot; rel=&quot;db82407&quot;&gt;db82407&lt;/a&gt; - so it seems addingService is called several times with the same reference - this is something the implementation doesn&apos;t expect. I&apos;ll have a look&lt;/p&gt;</comment>
                            <comment id="15366078" author="cziegeler" created="Thu, 7 Jul 2016 13:19:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=db82407&quot; class=&quot;user-hover&quot; rel=&quot;db82407&quot;&gt;db82407&lt;/a&gt; Could you give the following patch for http.base a try? (Apply patch, build http.base then http.jetty):&lt;/p&gt;

&lt;p&gt;Index: src/main/java/org/apache/felix/http/base/internal/whiteboard/tracker/WhiteboardServiceTracker.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; src/main/java/org/apache/felix/http/base/internal/whiteboard/tracker/WhiteboardServiceTracker.java	(Revision 1751622)&lt;br/&gt;
+++ src/main/java/org/apache/felix/http/base/internal/whiteboard/tracker/WhiteboardServiceTracker.java	(Arbeitskopie)&lt;br/&gt;
@@ -100,10 +100,13 @@&lt;/p&gt;

&lt;p&gt;     private void added(final ServiceReference&amp;lt;T&amp;gt; ref)&lt;br/&gt;
     {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final WhiteboardServiceInfo&amp;lt;T&amp;gt; info = this.getServiceInfo(ref);&lt;/li&gt;
	&lt;li&gt;if ( this.contextManager.addWhiteboardService(info) )&lt;br/&gt;
+        if ( this.allInfos.get(ref.getProperty(Constants.SERVICE_ID)) == null )&lt;br/&gt;
         {&lt;/li&gt;
	&lt;li&gt;this.allInfos.put((Long)ref.getProperty(Constants.SERVICE_ID), info);&lt;br/&gt;
+            final WhiteboardServiceInfo&amp;lt;T&amp;gt; info = this.getServiceInfo(ref);&lt;br/&gt;
+            if ( this.contextManager.addWhiteboardService(info) )&lt;br/&gt;
+            
{
+                this.allInfos.put((Long)ref.getProperty(Constants.SERVICE_ID), info);
+            }
&lt;p&gt;         }&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15366359" author="db82407" created="Thu, 7 Jul 2016 16:25:31 +0000"  >&lt;p&gt;I&apos;m afraid that didn&apos;t work. The duplicates are being added by different instances of the WhiteboardServiceTracker.&lt;/p&gt;

&lt;p&gt;There is a single instance of the WhiteboardManager in both cases.&lt;/p&gt;


&lt;p&gt;The &quot;good&quot; case looks like:&lt;/p&gt;

&lt;p&gt;manager.start context1&lt;br/&gt;
adding service id=24 ServletTracker@3b3af66&lt;br/&gt;
manager.stop&lt;br/&gt;
manager.start context2&lt;br/&gt;
adding service id=26 ServletTracker@6b419013&lt;/p&gt;


&lt;p&gt;while the &quot;bad&quot; case looks like:&lt;/p&gt;

&lt;p&gt;manager.start context1&lt;br/&gt;
adding service id=24 ServletTracker@7245c93a&lt;br/&gt;
adding service id=26 ServletTracker@7245c93a&lt;br/&gt;
manager.stop&lt;br/&gt;
manager.start context2&lt;br/&gt;
adding service id=26 ServletTracker@5240ac63&lt;/p&gt;


&lt;p&gt;The difference is that in the bad case, service id=26 was added by ServletTracker@7245c93a from the first start(context1) and then added again from the second start(context2) from ServletTracker@5240ac63.&lt;/p&gt;



</comment>
                            <comment id="15366432" author="cziegeler" created="Thu, 7 Jul 2016 17:17:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=db82407&quot; class=&quot;user-hover&quot; rel=&quot;db82407&quot;&gt;db82407&lt;/a&gt; Excellent, that&apos;s great help, thank you - I was already surprised that the  tracker was not behaving as expected. So I think the bug is really that we have two trackers. That shouldn&apos;t be the case. I&apos;ll investigate on why this is happening.&lt;/p&gt;</comment>
                            <comment id="15367275" author="cziegeler" created="Fri, 8 Jul 2016 06:03:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=db82407&quot; class=&quot;user-hover&quot; rel=&quot;db82407&quot;&gt;db82407&lt;/a&gt; I&apos;m not 100% sure why the clean up is not working as expected, however I just committed some extra clean up code to http.base. Could you please give this another try?&lt;/p&gt;</comment>
                            <comment id="15367402" author="db82407" created="Fri, 8 Jul 2016 08:43:35 +0000"  >&lt;p&gt;Hi Carsten,&lt;/p&gt;

&lt;p&gt;This appears to have fixed the problem.&lt;br/&gt;
I&apos;ve tried 10 times and I can no longer reproduce it. It used to occur about every other time.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;br/&gt;
Derek&lt;/p&gt;</comment>
                            <comment id="15367491" author="cziegeler" created="Fri, 8 Jul 2016 10:15:13 +0000"  >&lt;p&gt;Thanks for the great help &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=db82407&quot; class=&quot;user-hover&quot; rel=&quot;db82407&quot;&gt;db82407&lt;/a&gt;. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12816607" name="http.jetty.bad.log" size="39270" author="db82407" created="Thu, 7 Jul 2016 10:57:35 +0000"/>
                            <attachment id="12816608" name="http.jetty.good.log" size="29150" author="db82407" created="Thu, 7 Jul 2016 10:57:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30ljj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>