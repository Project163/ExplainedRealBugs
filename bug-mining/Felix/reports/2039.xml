<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:50:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-4290] [DS] Issue with factory components with required configuration</title>
                <link>https://issues.apache.org/jira/browse/FELIX-4290</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;This issue is related to the dev post at &lt;a href=&quot;http://www.mail-archive.com/dev@felix.apache.org/msg31209.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/dev@felix.apache.org/msg31209.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;While doing some non regression tests on the scr/trunk (before doing 1.8 release, I came across some problems with some of our applications using declarative service.&lt;/p&gt;

&lt;p&gt;What am I observing is that many factory components are unsatisfied and our application is not coming up at all (It was working fine with scr 1.6.2).&lt;/p&gt;

&lt;p&gt;Now, I have joined to this issue an integration test which seems to reproduce the problem, and also a candidate fix.&lt;/p&gt;

&lt;p&gt;The ComponentFactoryWithTargetFiltersTest test is using the integration_test_targetfilter_factory_components.xml and does the following:&lt;/p&gt;

&lt;p&gt;1) it enables the &quot;factory.component.reference.targetfilter&quot; component.&lt;br/&gt;
This component has a required configuration, is a factory component, and has a dynamic reference 1..1 on a SlmpleService instance.&lt;/p&gt;

&lt;p&gt;2) Then we instantiate two SimpleService instances: The first one contains a &quot;value=service1&quot; service property, and the second one contains the &quot;value=service2&quot; service property.&lt;/p&gt;

&lt;p&gt;3) at this point, we create the configuration for the component factory.&lt;br/&gt;
Notice that at this point, the factory component should transit from STATE_UNSATISFIED to STATE_FACTORY. but it seems that this is not the case and we see in logs:&lt;/p&gt;

&lt;p&gt;log level: 3 D=14:55:12,837 T=Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Configuration Updater,5,main&amp;#93;&lt;/span&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;factory.component.reference.targetfilter(0)&amp;#93;&lt;/span&gt; Configuration PID updated for Component Factory&lt;br/&gt;
log level: 3 D=14:55:12,837 T=Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Configuration Updater,5,main&amp;#93;&lt;/span&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;factory.component.reference.targetfilter(0)&amp;#93;&lt;/span&gt; Current ComponentFactory state=4&lt;br/&gt;
log level: 4 D=14:55:12,837 T=Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Configuration Updater,5,main&amp;#93;&lt;/span&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;factory.component.reference.targetfilter(0)&amp;#93;&lt;/span&gt; Attempting to activate unsatisfied component&lt;br/&gt;
log level: 4 D=14:55:12,837 T=Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Configuration Updater,5,main&amp;#93;&lt;/span&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;factory.component.reference.targetfilter(0)&amp;#93;&lt;/span&gt; ActivateInternal&lt;br/&gt;
log level: 4 D=14:55:12,837 T=Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Configuration Updater,5,main&amp;#93;&lt;/span&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;factory.component.reference.targetfilter(0)&amp;#93;&lt;/span&gt; Activating component from state 4&lt;br/&gt;
log level: 4 D=14:55:12,837 T=Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Configuration Updater,5,main&amp;#93;&lt;/span&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;factory.component.reference.targetfilter(0)&amp;#93;&lt;/span&gt; Dependency not satisfied: ref&lt;br/&gt;
log level: 4 D=14:55:12,837 T=Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Configuration Updater,5,main&amp;#93;&lt;/span&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;factory.component.reference.targetfilter(0)&amp;#93;&lt;/span&gt; Not all dependencies satisfied, cannot activate&lt;/p&gt;


&lt;p&gt;4) Then we lookup the ComponentFactory for the &quot;factory.component.reference.targetfilter&quot; component, and we pass to the CF.newInstance() method a Hashtable with the following target filter:&lt;/p&gt;

&lt;p&gt;&quot;ref.target=&quot;(value=service2)&quot;)&lt;/p&gt;

&lt;p&gt;4) and finally, we expect the component to be bound to SimpleService2 (because we have configured the target filter (ref) to &quot;(value=service2)&quot;.&lt;/p&gt;

&lt;p&gt;Initially, i though that the problem was coming from target filters. But it seems that the problem comes from the fact that the factory component stays unsatisfied, event if we provide the configuration and even when the two SImpleService instances are registered.&lt;/p&gt;

&lt;p&gt;And the test fails like this:&lt;/p&gt;

&lt;p&gt;junit.framework.AssertionFailedError: expected:&amp;lt;64&amp;gt; but was:&amp;lt;4&amp;gt;&lt;br/&gt;
        at junit.framework.Assert.fail(Assert.java:57)&lt;br/&gt;
        at junit.framework.Assert.failNotEquals(Assert.java:329)&lt;br/&gt;
        at junit.framework.Assert.assertEquals(Assert.java:78)&lt;br/&gt;
        at junit.framework.Assert.assertEquals(Assert.java:234)&lt;br/&gt;
        at junit.framework.Assert.assertEquals(Assert.java:241)&lt;br/&gt;
        at junit.framework.TestCase.assertEquals(TestCase.java:409)&lt;br/&gt;
        at org.apache.felix.scr.integration.ComponentFactoryWithTargetFiltersTest.test_component_factory(ComponentFactoryWithTargetFiltersTest.java:82)&lt;/p&gt;


&lt;p&gt;Now, if I apply the proposed attached patch, then the integration test is successful and my application is also coming up correctly.&lt;/p&gt;

&lt;p&gt;(I did not have time to try to follow what David is suggesting in the dev post, regarding a potential issue in SingleComponentManager.reconfigure() and a missing check regarding  m_factoryProperties).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12675482">FELIX-4290</key>
            <summary>[DS] Issue with factory components with required configuration</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="djencks">David Jencks</assignee>
                                    <reporter username="pderop">Pierre De Rop</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Oct 2013 13:05:49 +0000</created>
                <updated>Thu, 4 Sep 2014 08:04:07 +0000</updated>
                            <resolved>Fri, 25 Oct 2013 07:05:55 +0000</resolved>
                                    <version>scr-1.6.2</version>
                                    <fixVersion>scr-1.8.0</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13804148" author="pderop" created="Thu, 24 Oct 2013 13:08:41 +0000"  >&lt;p&gt;attached proposed patch&lt;/p&gt;</comment>
                            <comment id="13804149" author="pderop" created="Thu, 24 Oct 2013 13:09:03 +0000"  >&lt;p&gt;Attached integration test&lt;/p&gt;</comment>
                            <comment id="13805106" author="djencks" created="Fri, 25 Oct 2013 07:05:55 +0000"  >&lt;p&gt;r1535647&lt;/p&gt;

&lt;p&gt;I found a slightly less invasive place to call setTargets(getProperties()), in the ComponentFactoryImpl.  I moved your very nice test into the existing ComponentFactory test.&lt;/p&gt;

&lt;p&gt;many thanks!&lt;/p&gt;</comment>
                            <comment id="14040982" author="kmart216" created="Mon, 23 Jun 2014 17:12:37 +0000"  >&lt;p&gt;for clarification, the affects version is 1.6.2 and fix is 1.8.0, currently listing is incorrect&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12610082" name="FELIX-4290.patch" size="737" author="pderop" created="Thu, 24 Oct 2013 13:08:41 +0000"/>
                            <attachment id="12610083" name="FELIX-4290.test.tgz" size="2041" author="pderop" created="Thu, 24 Oct 2013 13:09:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>355059</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 22 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1p7mn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>355347</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>