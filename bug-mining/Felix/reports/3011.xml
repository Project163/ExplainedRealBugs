<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:12:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5908] NoClassDefFoundError for the CM Security Domain combiner</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5908</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;This is a pretty weird bug, so I&apos;ll try to explain it.&lt;/p&gt;

&lt;p&gt;When running with security on the Configuration Admin Updater thread applies an Access Control Context which, amongst other things, sets up a Domain Combiner. This Domain Combiner lazily creates a combined Protection Domain based on the target bundle.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;All of this works fine until you end up in the following situation:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The MS/MSF being called attempts to perform a checked operation (for which they may or may not have permission)&lt;/li&gt;
	&lt;li&gt;The Check causes the CM Domain Combiner to be instantiated, triggering a class load if it is the first time&lt;/li&gt;
	&lt;li&gt;The Loading of the class can then trigger&#160;&lt;b&gt;more&lt;/b&gt; security checks in some cases, for example setting the CodeSource of the class being defined can require a security check if there are multiple frameworks in the VM, or if the code was installed from a custom URL handler that has a custom toExternalForm() implementation&lt;/li&gt;
	&lt;li&gt;This security check retrievers the CM Domain Combiner, which attempts to load the class again&lt;/li&gt;
	&lt;li&gt;The Java ClassLoader detects the cycle and throws a NoClassDefFoundError&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am setting up a &quot;simple&quot; test demonstrating this (it necessarily has several moving parts) and a proposed patch.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13179060">FELIX-5908</key>
            <summary>NoClassDefFoundError for the CM Security Domain combiner</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cziegeler">Carsten Ziegeler</assignee>
                                    <reporter username="timothyjward">Timothy James Ward</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Aug 2018 12:16:06 +0000</created>
                <updated>Mon, 17 Sep 2018 08:04:05 +0000</updated>
                            <resolved>Thu, 16 Aug 2018 08:40:48 +0000</resolved>
                                    <version>configadmin-1.9.4</version>
                                    <fixVersion>configadmin-1.9.6</fixVersion>
                                    <component>Configuration Admin</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16581037" author="githubbot" created="Wed, 15 Aug 2018 12:55:48 +0000"  >&lt;p&gt;GitHub user timothyjward opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/felix/pull/150&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/felix/pull/150&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Configuration Admin Security can cause a NoClassDefFoundError&lt;/p&gt;

&lt;p&gt;    Fixes &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5908&quot; title=&quot;NoClassDefFoundError for the CM Security Domain combiner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5908&quot;&gt;&lt;del&gt;FELIX-5908&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/timothyjward/felix&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/timothyjward/felix&lt;/a&gt; config-security&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/felix/pull/150.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/felix/pull/150.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #150&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 561a99c53854c0449bd922a344f9eee513df5222&lt;br/&gt;
Author: Tim Ward &amp;lt;timothyjward@...&amp;gt;&lt;br/&gt;
Date:   2018-08-15T12:21:20Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5908&quot; title=&quot;NoClassDefFoundError for the CM Security Domain combiner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5908&quot;&gt;&lt;del&gt;FELIX-5908&lt;/del&gt;&lt;/a&gt; - Tests to demonstrate the NoClassDefFoundError that can occur with security on&lt;/p&gt;

&lt;p&gt;    Also includes general security tests to ensure that Config Admin runs correctly with Security on&lt;/p&gt;

&lt;p&gt;    Signed-off-by: Tim Ward &amp;lt;timothyjward@apache.org&amp;gt;&lt;/p&gt;

&lt;p&gt;commit 007a88b104deb92fcd890d81bbac5a0df1ec4708&lt;br/&gt;
Author: Tim Ward &amp;lt;timothyjward@...&amp;gt;&lt;br/&gt;
Date:   2018-08-15T12:52:30Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5908&quot; title=&quot;NoClassDefFoundError for the CM Security Domain combiner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5908&quot;&gt;&lt;del&gt;FELIX-5908&lt;/del&gt;&lt;/a&gt; Avoid a NoClassDefFoundError by eagerly instantiating the ProtectionDomain&lt;/p&gt;

&lt;p&gt;    Signed-off-by: Tim Ward &amp;lt;timothyjward@apache.org&amp;gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16581038" author="timothyjward" created="Wed, 15 Aug 2018 12:57:08 +0000"  >&lt;p&gt;The attached GitHub Pull Request contains two commits, the first&#160;containing tests demonstrating the issue, the second containing a fix for the issue&lt;/p&gt;</comment>
                            <comment id="16582203" author="cziegeler" created="Thu, 16 Aug 2018 08:40:40 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=timothyjward&quot; class=&quot;user-hover&quot; rel=&quot;timothyjward&quot;&gt;timothyjward&lt;/a&gt; That&apos;s really a subtle bug&lt;br/&gt;
I&apos;ve applied your fix together with the tests in rev 1838162.&lt;br/&gt;
Due to that we&apos;re now depending on a snapshot of framework.security&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kpauls&quot; class=&quot;user-hover&quot; rel=&quot;kpauls&quot;&gt;kpauls&lt;/a&gt; Can we get a release of framework.security in the near future to get rid of this snapshot dependency?&lt;/p&gt;</comment>
                            <comment id="16582211" author="karlpauls" created="Thu, 16 Aug 2018 08:45:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt;, yes, I&apos;m  planning to cut a framework 6.0.1 and a framework.security 2.6.1 release soon.&lt;/p&gt;</comment>
                            <comment id="16582235" author="timothyjward" created="Thu, 16 Aug 2018 09:02:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt; the other option would be update the ConfigurationTestBase installBundle method to add a dummy file into the generated test bundles. &lt;/p&gt;

&lt;p&gt;Adding a dummy file makes these bundles not &#8220;manifest only&#8221; and therefore avoids &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5906&quot; title=&quot;Installing Manifest only bundles causes ArrayIndexOutOfBoundsException from Felix Security&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5906&quot;&gt;&lt;del&gt;FELIX-5906&lt;/del&gt;&lt;/a&gt; blowing up the tests. If this change is made then security 2.6.0 can be used. &lt;/p&gt;

&lt;p&gt;I avoided working around that bug in the patch as it wasn&#8217;t part of the minimum necessary changes for testing/fixing, and I figured the test changes were complex enough already!&lt;/p&gt;</comment>
                            <comment id="16582318" author="cziegeler" created="Thu, 16 Aug 2018 10:11:16 +0000"  >&lt;p&gt;While a snapshot dependency is obviously not ideal and we should avoid it in general, I think it&apos;s fine for this case, especially if we get a release soon. We just need to wait with a configadmin release until the snapshot dependency is released.&lt;/p&gt;</comment>
                            <comment id="16582337" author="karlpauls" created="Thu, 16 Aug 2018 10:38:13 +0000"  >&lt;p&gt;vote is on its way &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 13 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3x2e7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>