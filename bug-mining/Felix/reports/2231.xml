<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:54:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-4523] Deadlock in URLHandlers when Felix.init and Felix.stop are called concurrently</title>
                <link>https://issues.apache.org/jira/browse/FELIX-4523</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;From time to time we are experiencing a deadlock in the URLHandlers Class in Apache Felix. We are using Felix as an embedded OSGi Container and instantiate the Felix Framework via ServiceLoader and Framework Factory ourselves. The situation is as follows: When Felix.stop and Felix.init are called by different threads, eventually URLHandlers.unregisterFrameworkListsForContextSearch and URLHandlers.registerFrameworkInstance are called by the threads. There are two locks: m_frameworks and the Class Object of URL (URL.class). registerFrameworkInstance tries to aquire m_frameworks first and via the constructor of URLHanders URL.class after that. unregisterFrameworkListsForContextSearch tries to aquire URL.class first and m_frameworks after that. This is a classic deadlock situation. The situation arises in unittests where we frequently start and stop the felix framework. &lt;/p&gt;

&lt;p&gt;Stacktracke log:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Found one Java-level deadlock:
=============================
&lt;span class=&quot;code-quote&quot;&gt;&quot;FelixShutdown&quot;&lt;/span&gt;:
  waiting to lock monitor 0x0000000000ff7710 (object 0x00000007ff33e7f0, a java.util.ArrayList),
  which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt;:
  waiting to lock monitor 0x00000000022c4a08 (object 0x0000000783b06b18, a java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;),
  which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;FelixShutdown&quot;&lt;/span&gt;

Java stack information &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the threads listed above:
===================================================
&lt;span class=&quot;code-quote&quot;&gt;&quot;FelixShutdown&quot;&lt;/span&gt;:
	at org.apache.felix.framework.URLHandlers.unregisterFrameworkListsForContextSearch(URLHandlers.java:315)
	- waiting to lock &amp;lt;0x00000007ff33e7f0&amp;gt; (a java.util.ArrayList)
	- locked &amp;lt;0x00000007ff33e840&amp;gt; (a java.util.HashMap)
	- locked &amp;lt;0x0000000783b06b18&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; java.net.URL)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.apache.felix.framework.util.SecureAction.invoke(SecureAction.java:840)
	at org.apache.felix.framework.URLHandlers.unregisterFrameworkInstance(URLHandlers.java:635)
	at org.apache.felix.framework.URLHandlersActivator.stop(URLHandlersActivator.java:76)
	at org.apache.felix.framework.util.SecureAction.stopActivator(SecureAction.java:667)
	at org.apache.felix.framework.Felix$SystemBundleActivator.stop(Felix.java:4715)
	at org.apache.felix.framework.util.SecureAction.stopActivator(SecureAction.java:667)
	at org.apache.felix.framework.Felix.stopBundle(Felix.java:2530)
	at org.apache.felix.framework.Felix$2.run(Felix.java:959)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:724)
&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt;:
	at org.apache.felix.framework.URLHandlers.&amp;lt;init&amp;gt;(URLHandlers.java:150)
	- waiting to lock &amp;lt;0x0000000783b06b18&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; java.net.URL)
	at org.apache.felix.framework.URLHandlers.registerFrameworkInstance(URLHandlers.java:600)
	- locked &amp;lt;0x00000007ff33e7f0&amp;gt; (a java.util.ArrayList)
	at org.apache.felix.framework.URLHandlersActivator.start(URLHandlersActivator.java:71)
	at org.apache.felix.framework.util.SecureAction.startActivator(SecureAction.java:645)
	at org.apache.felix.framework.Felix$SystemBundleActivator.start(Felix.java:4634)
	at org.apache.felix.framework.util.SecureAction.startActivator(SecureAction.java:645)
	at org.apache.felix.framework.Felix.init(Felix.java:783)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>linux, junittests</environment>
        <key id="12716643">FELIX-4523</key>
            <summary>Deadlock in URLHandlers when Felix.init and Felix.stop are called concurrently</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="karlpauls">Karl Pauls</assignee>
                                    <reporter username="plastic-karma">Benjamin Rogge</reporter>
                        <labels>
                    </labels>
                <created>Mon, 26 May 2014 13:16:42 +0000</created>
                <updated>Wed, 30 Jul 2014 07:16:56 +0000</updated>
                            <resolved>Wed, 9 Jul 2014 09:58:25 +0000</resolved>
                                    <version>framework-4.2.1</version>
                                    <fixVersion>framework-4.4.1</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14041961" author="karlpauls" created="Tue, 24 Jun 2014 10:44:54 +0000"  >&lt;p&gt;Can you try the attached patch (against the current trunk) and see whether that fixes your issue? That would be great...&lt;/p&gt;</comment>
                            <comment id="14042032" author="plastic-karma" created="Tue, 24 Jun 2014 12:19:45 +0000"  >&lt;p&gt;@&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=karlpauls&quot; class=&quot;user-hover&quot; rel=&quot;karlpauls&quot;&gt;karlpauls&lt;/a&gt;: Thank you very much. It might take me a couple of days (to find time to do it), but I&apos;m on it.&lt;/p&gt;</comment>
                            <comment id="14042202" author="karlpauls" created="Tue, 24 Jun 2014 14:54:52 +0000"  >&lt;p&gt;Updated patch.&lt;/p&gt;</comment>
                            <comment id="14042203" author="karlpauls" created="Tue, 24 Jun 2014 14:57:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=plastic-karma&quot; class=&quot;user-hover&quot; rel=&quot;plastic-karma&quot;&gt;plastic-karma&lt;/a&gt; cool. Please note, I uploaded a slightly modified patch (urlhandlers-2.patch). Please use that one for your testing. Looking forward to hear if it helps. Furthermore, if you manage to get this captured in reproducible test case that would be even better &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. &lt;/p&gt;</comment>
                            <comment id="14044546" author="bosschaert" created="Thu, 26 Jun 2014 10:21:20 +0000"  >&lt;p&gt;FWIW I have also tried the patch and haven&apos;t found any issues. But... I haven&apos;t run it in a context where multiple frameworks are present, which I guess is where this thing really gets hammered.&lt;/p&gt;</comment>
                            <comment id="14051408" author="karlpauls" created="Thu, 3 Jul 2014 12:55:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=plastic-karma&quot; class=&quot;user-hover&quot; rel=&quot;plastic-karma&quot;&gt;plastic-karma&lt;/a&gt; did you manage to take a look at his patch? We are moving towards cutting a new release and it be nice to know whether this patch does help or not....&lt;/p&gt;</comment>
                            <comment id="14051523" author="plastic-karma" created="Thu, 3 Jul 2014 14:47:59 +0000"  >&lt;p&gt;I tried reducing the problem to a simple unittest without success. I will have time on Monday to reproduce it with our test codebase. When is the new release coming?&lt;/p&gt;</comment>
                            <comment id="14051542" author="karlpauls" created="Thu, 3 Jul 2014 15:00:28 +0000"  >&lt;p&gt;Well, this is the last issue we are waiting for - hence, if you can try it on Monday I&apos;ll wait until next week and see. If it takes you much longer I&apos;ll probably would do the release and we&apos;d have to make this one part of the next release...&lt;/p&gt;</comment>
                            <comment id="14051552" author="plastic-karma" created="Thu, 3 Jul 2014 15:03:23 +0000"  >&lt;p&gt;Alright, apologies for the delay. What is the minimum result that you can work with? Do you need the unittest or would a simple &quot;yes, it fixes our problem&quot; be sufficient ?&lt;/p&gt;</comment>
                            <comment id="14051589" author="plastic-karma" created="Thu, 3 Jul 2014 15:36:52 +0000"  >&lt;p&gt;I added a first version of a &quot;unittest&quot; that resembles the deadlock behavior. It does not check anything (yet), but the testcase will be stuck in a deadlock. I hope this is useful to you already. I will check the patch with the test as well as our codebase until monday.&lt;/p&gt;</comment>
                            <comment id="14052561" author="plastic-karma" created="Fri, 4 Jul 2014 17:01:35 +0000"  >&lt;p&gt;I extended the test. The test fails, if there is a deadlock situation, however provoking a deadlock in a reproducible and predictable manner  is in this case rather difficult. (There also is the way of making the testcase more efficient by using the ThreadMXBean, but that basically means, implementing a full deadlock recognition)&lt;/p&gt;

&lt;p&gt;While without the patch, the test ran into a deadlock about 3/4 of the runs, after the patch, I could not observe the deadlock anymore. So, the deadlock should be fixed. Looking forward to the new version &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14056050" author="karlpauls" created="Wed, 9 Jul 2014 09:58:25 +0000"  >&lt;p&gt;I applied the patch to trunk. Will cut a new release asap.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12654126" name="ConcurrentTest.java" size="4415" author="plastic-karma" created="Fri, 4 Jul 2014 17:01:35 +0000"/>
                            <attachment id="12652203" name="urlhandlers-2.patch" size="3411" author="karlpauls" created="Tue, 24 Jun 2014 14:54:52 +0000"/>
                            <attachment id="12652177" name="urlhandlers.patch" size="3275" author="karlpauls" created="Tue, 24 Jun 2014 10:44:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>394851</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 20 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1vzfj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>394986</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>