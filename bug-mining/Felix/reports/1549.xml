<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:41:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3296] URLHandlers caches null as values for common protocols</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3296</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;A JBoss AS7 user has reported being unable to run the Apache Sling web app in AS 7. I determined that the issue is once org.apache.felix.framework.URLHandlers is installed as the JVM&apos;s URLStreamHandlerFactory, URLs with protocol &quot;jar&quot; can no longer be parsed.&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Here&apos;s the problem. Line references are to &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;:&lt;/p&gt;

&lt;p&gt;1) The singleton of this URLHandlers class gets instantiated. It attempts to load and cache standard handlers for common protocols. At L148 it does this for &quot;jar&quot;.&lt;/p&gt;

&lt;p&gt;2) At L353 it&apos;s trying to load one of the standard URLStreamHandler impls for the &quot;jar&quot; protocol, e.g. sun.net.www.protocol.jar.Handler. It uses Class.forName(&quot;sun.net.www.protocol.jar.Handler&quot;). This fails (returns null) because the JBoss Modules module for this deployment does not have visibility to this class.&lt;/p&gt;

&lt;p&gt;3) At L367 it stores &quot;null&quot; for this protocol in its m_builtIn map under key &quot;jar&quot;.&lt;/p&gt;

&lt;p&gt;4) Thereafter any call to createURLStreamHandler (L390) will call into getBuiltInStreamHandler (L413). That will return null because it will find the null in m_builtIn stored in step 3) above (L330 &amp;amp; L332).&lt;/p&gt;

&lt;p&gt;A fairly simple fix is to at L148 test the result of the getBuiltInStreamHandler call and if null remove the entry from m_builtIn. It should probably do the same kind of thing in the init(String) method (L120).&lt;/p&gt;

&lt;p&gt;An alternative is to do all the step 1) stuff between L142 and L148 after the try/catch block at L157. At that point a ref to the standard AS7 URLStreamHandlerFactory will be available in field m_streamHandlerFactory and can be used to load the standard handlers rather than relying on Class.forName.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://lists.jboss.org/pipermail/jboss-as7-dev/2012-January/004956.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://lists.jboss.org/pipermail/jboss-as7-dev/2012-January/004956.html&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://grepcode.com/file/repo1.maven.org/maven2/org.apache.felix/org.apache.felix.framework/2.0.5/org/apache/felix/framework/URLHandlers.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://grepcode.com/file/repo1.maven.org/maven2/org.apache.felix/org.apache.felix.framework/2.0.5/org/apache/felix/framework/URLHandlers.java&lt;/a&gt;&lt;/p&gt;</description>
                <environment>Apache Sling  org.apache.sling.launchpad-6.war running in build of current master branch of JBoss Application Server 7 (&lt;a href=&quot;https://github.com/jbossas/jboss-as&quot;&gt;https://github.com/jbossas/jboss-as&lt;/a&gt;). I&amp;#39;m reporting this against framework-3.0.8 as that seems to be what&amp;#39;s included in Sling, but a review of the code in 4.0.2 shows the class is the same.</environment>
        <key id="12537436">FELIX-3296</key>
            <summary>URLHandlers caches null as values for common protocols</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="karlpauls">Karl Pauls</assignee>
                                    <reporter username="bstansberry">Brian Edward Stansberry</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 Jan 2012 23:01:58 +0000</created>
                <updated>Tue, 26 Jun 2012 19:17:03 +0000</updated>
                            <resolved>Thu, 3 May 2012 20:39:03 +0000</resolved>
                                    <version>framework-3.0.8</version>
                                    <fixVersion>framework-4.0.3</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13182506" author="karlpauls" created="Mon, 9 Jan 2012 13:54:30 +0000"  >&lt;p&gt;Yes, I agree - this is a bug. Thanks for reporting - I&apos;ll try to get to it asap.&lt;/p&gt;</comment>
                            <comment id="13182719" author="tdiesler" created="Mon, 9 Jan 2012 19:13:01 +0000"  >&lt;p&gt;Related to &lt;a href=&quot;https://issues.jboss.org/browse/AS7-3228&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.jboss.org/browse/AS7-3228&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13264749" author="rmuntean" created="Mon, 30 Apr 2012 09:22:42 +0000"  >&lt;p&gt;In reply to comment #1:&lt;br/&gt;
&amp;gt; Yes, I agree - this is a bug. Thanks for reporting - I&apos;ll try to get to it asap.&lt;/p&gt;

&lt;p&gt;Karl, did you manage to look into this? I&apos;m willing to test any patches if needed.&lt;/p&gt;</comment>
                            <comment id="13267343" author="fmeschbe" created="Thu, 3 May 2012 10:09:46 +0000"  >&lt;p&gt;Proposed patch:&lt;/p&gt;

&lt;p&gt;Instead of just trying to load the well-known default handlers we have to play some tricks. The patch changes the setup as follows to load each pre-defined scheme:&lt;/p&gt;

&lt;p&gt;  1. try installed URLStreamHandlerFactory if any&lt;br/&gt;
  2. try loading well-known handler class through framework class loader&lt;br/&gt;
  3. try loading well-known handler class through system class loader (ClassLoader.getSystemClassLoader())&lt;/p&gt;

&lt;p&gt;The first step IMHO makes sense if the pre-installed factory would overwrite any well-known handler (for example the file: handler from JBoss). The last step is to circumvent the JBoss ModuleClassLoader, which effectively hides the Java Platform classes (as OSGi does).&lt;/p&gt;</comment>
                            <comment id="13267365" author="karlpauls" created="Thu, 3 May 2012 11:03:30 +0000"  >&lt;p&gt;I&apos;ll try to have a look tonight.&lt;/p&gt;</comment>
                            <comment id="13267431" author="karlpauls" created="Thu, 3 May 2012 13:42:24 +0000"  >&lt;p&gt;Well, after looking at a bit more, I&apos;m not so sure what the correct solution is. First, I disagree with the proposed fix in the description. The idea is that if there is a previous urlhandlersfactory, we should delegate to that one. If it isn&apos;t doing that, there is a bug in there. Caching the null value is what should happen.&lt;/p&gt;

&lt;p&gt;Regarding the patch of Felix Meschberger: I see the problem however, I&apos;m not sure it is a correct solution to default to the system classloader. Thing is, somebody on the outside doesn&apos;t want us to see the classes, so we shouldn&apos;t try to get them from some place else. Granted, if that is the only work to make this work we might have to but the URLHandlers are a very tricky hack to begin with so lets see whether there is a different way. &lt;/p&gt;

&lt;p&gt;Am I correct in saying that jboss installs its own urlhandlersfactory which will give us the required protocols?&lt;/p&gt;</comment>
                            <comment id="13267466" author="fmeschbe" created="Thu, 3 May 2012 14:30:47 +0000"  >&lt;p&gt;&amp;gt; The idea is that if there is a previous urlhandlersfactory, we should delegate to that one. If it&lt;br/&gt;
&amp;gt; isn&apos;t doing that, there is a bug in there. Caching the null value is what should happen.&lt;/p&gt;

&lt;p&gt;Event the platform is not expecting the URLStreamHandlerFactory to be &quot;complete&quot;. If the factory does not return anything, it checks with its known handler classes (see URL.getURLStreamHandler(String); at least in the Sun VM).&lt;/p&gt;

&lt;p&gt;&amp;gt; Caching the null value is what should happen&lt;/p&gt;

&lt;p&gt;That&apos;s still happening, if there is a null situation after all.&lt;/p&gt;

&lt;p&gt;&amp;gt; Thing is, somebody on the outside doesn&apos;t want us to see the classes, so we shouldn&apos;t try to get them from some place else&lt;/p&gt;

&lt;p&gt;Agreed. But then that somebody (URLStreamHandlerFactory) should provide the handlers. Particularly the jar: handler but probably also the other ones, at least http: and https: would be helpful.&lt;/p&gt;

&lt;p&gt;&amp;gt; but the URLHandlers are a very tricky hack to begin with so lets see whether there is a different way. &lt;/p&gt;

&lt;p&gt;I&apos;d love to have a better solution &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&amp;gt; Am I correct in saying that jboss installs its own urlhandlersfactory which will give us the required protocols? &lt;/p&gt;

&lt;p&gt;It installs, but does not give the missing handlers, which is why I did that trickery.&lt;/p&gt;

&lt;p&gt;BTW: The patch implements exactly the three steps: trying the factory, falling back to known packages in framework class loader, falling back to known packages in system class loader.&lt;/p&gt;</comment>
                            <comment id="13267476" author="karlpauls" created="Thu, 3 May 2012 14:40:47 +0000"  >&lt;p&gt;&amp;gt; Event the platform is not expecting the URLStreamHandlerFactory to be &quot;complete&quot;. If the factory does not return anything, it checks with its known handler classes (see URL.getURLStreamHandler(String); at least in the Sun &amp;gt; VM). &lt;/p&gt;

&lt;p&gt;And that is our problem. We can&apos;t get the handlers from anywhere proper but we have to get them. That is the overal story of the urlhandlers, we have to fight the system every turn just to get them to work &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt; Caching the null value is what should happen&lt;/p&gt;

&lt;p&gt;&amp;gt; That&apos;s still happening, if there is a null situation after all. &lt;/p&gt;

&lt;p&gt;Right, that wasn&apos;t in regard to your patch but in regard to the original proposal.&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt; but the URLHandlers are a very tricky hack to begin with so lets see whether there is a different way.&lt;/p&gt;

&lt;p&gt;&amp;gt; I&apos;d love to have a better solution &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;Me too &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;but as I said, we might have to resort to your patch. As of now, i can only think of stuff that is even worse :-D&lt;/p&gt;</comment>
                            <comment id="13267478" author="karlpauls" created="Thu, 3 May 2012 14:45:50 +0000"  >&lt;p&gt;Regarding your patch so, I think there are some issues with it - can we discuss it via skype?&lt;/p&gt;</comment>
                            <comment id="13267505" author="fmeschbe" created="Thu, 3 May 2012 15:36:32 +0000"  >&lt;p&gt;Extended patch:&lt;br/&gt;
  + in the init() method ensure the handler found is used to create the URL&lt;br/&gt;
  + synchronize initialization on URL.class since we fiddle with the factory field&lt;/p&gt;

&lt;p&gt;This supercedes (and includes) the previous patch&lt;/p&gt;</comment>
                            <comment id="13267522" author="karlpauls" created="Thu, 3 May 2012 15:49:10 +0000"  >&lt;p&gt;Thanks, Felix. That looks good now - I&apos;ll give it some more looking at and try to work in the other outstanding URLHandlers issues but i expect to commit something tonight.&lt;/p&gt;</comment>
                            <comment id="13267784" author="karlpauls" created="Thu, 3 May 2012 20:39:03 +0000"  >&lt;p&gt;I applied the patch. Please close if it works for you.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12525459" name="FELIX-3296-2.patch" size="9364" author="fmeschbe" created="Thu, 3 May 2012 15:36:32 +0000"/>
                            <attachment id="12525426" name="FELIX-3296.patch" size="8721" author="fmeschbe" created="Thu, 3 May 2012 10:09:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>222944</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 29 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i00x0n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3281</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>