<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:47:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3273] Possible exception when accessing headers</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3273</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR: Bundle org.ops4j.pax.logging.pax-logging-service [3] EventDispatcher: Error during dispatch. (java.util.NoSuchElementException)
java.util.NoSuchElementException
	at java.util.HashMap$HashIterator.nextEntry(HashMap.java:796)
	at java.util.HashMap$ValueIterator.next(HashMap.java:822)
	at org.apache.felix.framework.BundleImpl.getCurrentLocalizedHeader(BundleImpl.java:334)
	at org.apache.felix.framework.Felix.getBundleHeaders(Felix.java:1428)
	at org.apache.felix.framework.BundleImpl.getHeaders(BundleImpl.java:311)
	at org.apache.felix.framework.BundleImpl.getHeaders(BundleImpl.java:293)
	at org.ops4j.pax.logging.service.internal.PaxLoggerImpl.setDelegateContext(PaxLoggerImpl.java:101)
	at org.ops4j.pax.logging.service.internal.PaxLoggerImpl.debug(PaxLoggerImpl.java:131)
	at org.ops4j.pax.logging.service.internal.PaxLoggingServiceImpl.log(PaxLoggingServiceImpl.java:149)
	at org.ops4j.pax.logging.service.internal.PaxLoggingServiceImpl.log(PaxLoggingServiceImpl.java:115)
	at org.ops4j.pax.logging.service.internal.FrameworkHandler.bundleChanged(FrameworkHandler.java:93)
	at org.apache.felix.framework.util.EventDispatcher.invokeBundleListenerCallback(EventDispatcher.java:807)
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:729)
	at org.apache.felix.framework.util.EventDispatcher.run(EventDispatcher.java:949)
	at org.apache.felix.framework.util.EventDispatcher.access$000(EventDispatcher.java:54)
	at org.apache.felix.framework.util.EventDispatcher$1.run(EventDispatcher.java:106)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:680)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem happened on 3.0.9 but looking at the getLocalizedHeaders method, nothing has changed so the bug should still be valid for 4.0.x&lt;/p&gt;

&lt;p&gt;I suppose the problem is in the BundleImpl#uninstall method which may clear the cached headers without populating with the default.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12535271">FELIX-3273</key>
            <summary>Possible exception when accessing headers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="gnodet">Guillaume Nodet</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Dec 2011 08:35:46 +0000</created>
                <updated>Tue, 5 Feb 2013 14:24:58 +0000</updated>
                            <resolved>Tue, 5 Feb 2013 14:24:58 +0000</resolved>
                                    <version>framework-3.0.9</version>
                                    <fixVersion>framework-4.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13170235" author="rickhall" created="Thu, 15 Dec 2011 14:19:43 +0000"  >&lt;p&gt;Looking at the source for BundleImpl.uninstall(), it does populate with the default locale as described in the long comment. Unless there is some bug in the logic, it looks like it should be happening. If this is repeatable, perhaps you can set a breakpoint in the uninstall() and see if it does get populated or not. Issue &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-2840&quot; title=&quot;[Framework] Uninstalling an uninstalled bundle throws NoSuchElementException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-2840&quot;&gt;&lt;del&gt;FELIX-2840&lt;/del&gt;&lt;/a&gt; seems potentially related.&lt;/p&gt;</comment>
                            <comment id="13393370" author="rickhall" created="Sat, 16 Jun 2012 19:18:57 +0000"  >&lt;p&gt;Any followup on this?&lt;/p&gt;</comment>
                            <comment id="13567940" author="gnt" created="Thu, 31 Jan 2013 18:53:51 +0000"  >&lt;p&gt;I don&apos;t have any way to reproduce this issue, as I did not really track it.&lt;/p&gt;

&lt;p&gt;However, and maybe this is an edge case, what if someone calls  &lt;tt&gt;bundle.uninstall()&lt;/tt&gt; two times consecutively ?&lt;br/&gt;
Or maybe if the bundle has been modified and two threads call getHeaders() concurrently ? I see a gap between the time the cached headers are cleared and the time they are populated.&lt;/p&gt;</comment>
                            <comment id="13568020" author="rickhall" created="Thu, 31 Jan 2013 19:39:03 +0000"  >&lt;p&gt;Where is the gap? Inside BundleImpl.uninstall() we do this:&lt;/p&gt;

&lt;p&gt;        synchronized (m_cachedHeaders)&lt;br/&gt;
        {&lt;br/&gt;
            if ((m_cachedHeaders.size() &amp;gt; 1)&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; !m_cachedHeaders.containsKey(Locale.getDefault().toString()))
            {
                m_cachedHeaders.clear();
                Map map = getCurrentLocalizedHeader(Locale.getDefault().toString());
            }
&lt;p&gt;        }&lt;/p&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;So, we hold the lock while clearing the cache and populating it with the default locale. If another thread came in, it wouldn&apos;t try to cache the default locale again because cache size would be 1 and it would contain the default locale.&lt;/p&gt;

&lt;p&gt;Unless there was some weird possibility that the thread had a different default locale.&lt;/p&gt;</comment>
                            <comment id="13568083" author="gnt" created="Thu, 31 Jan 2013 20:42:25 +0000"  >&lt;p&gt;Yeah, the uninstall() path won&apos;t work, but I think the second use case I mentioned is valid.&lt;/p&gt;

&lt;p&gt;bundle.getHeaders() does not hold any lock while calling getCurrentLocalizedHeader, so if the bundle is modified, and 2 threads call getHeaders() concurrently, there may be a problem.&lt;/p&gt;

&lt;p&gt;The first one will clear the headers using&lt;br/&gt;
                else if (getLastModified() &amp;gt; m_cachedHeadersTimestamp)&lt;/p&gt;
                {
                    m_cachedHeaders.clear();
                }

&lt;p&gt;while the second one may throw an exception because the updateHeaderCache will not be called yet by the first thread, thus having an empty map and throwing the exception.&lt;/p&gt;</comment>
                            <comment id="13571332" author="rickhall" created="Tue, 5 Feb 2013 14:24:58 +0000"  >&lt;p&gt;There was one place we were accessing the headers cache without the lock, so I fixed that. Additionally, I could see that there was some issue around clearing the cache on uninstalled and trying to populate it with the default locale which always led to a check-then-act scenario. To avoid this, I decided against caching the final default locale in the header cache and instead put it in a separate variable. That way the caching of the default locale can be done atomically when uninstalling the bundle. Hopefully, that fixes this issue. Please close if satisfied, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>220955</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1auxz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>271479</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>