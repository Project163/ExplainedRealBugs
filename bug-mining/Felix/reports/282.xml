<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:07:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-819] unable to rename / delete bundle cache location on update or uninstall</title>
                <link>https://issues.apache.org/jira/browse/FELIX-819</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;Hello all,&lt;/p&gt;

&lt;p&gt;It looks like the revision.location is missing from the bundle cache after the shutdown purge. Steps:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;install bundle&lt;/li&gt;
	&lt;li&gt;update bundle&lt;/li&gt;
	&lt;li&gt;shutdown&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The next start shows a:&lt;br/&gt;
ERROR: org.apache.felix.framework.cache.BundleCache: Error creating archive. (java.io.FileNotFoundException: .\felixcache\bundle24\version2.0\revision.location (The system cannot find the file specified))&lt;/p&gt;

&lt;p&gt;Looking in the directory, the file is not there.&lt;/p&gt;

&lt;p&gt;Stepping through the code shows that the BundleArchive.purge() attempts to rename the last bundle revision to a fresh one... except that the File.rename is not platform independent (it fails on windows quite often).&lt;br/&gt;
When BundleCache.getSecureAction().renameFile(revisionDir, currentDir) returns false (rename failed), createRevisionFromLocation follows and does not include a new revision.location file.&lt;/p&gt;

&lt;p&gt;Maybe a call to setRevisionLocation() is to be made after createRevisionFromLocation (BundleArchive:866)? I&apos;ll try that out...&lt;/p&gt;</description>
                <environment>Windows (XP Pro)</environment>
        <key id="12408670">FELIX-819</key>
            <summary>unable to rename / delete bundle cache location on update or uninstall</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="wgedeon">Walid Joseph Gedeon</reporter>
                        <labels>
                    </labels>
                <created>Mon, 17 Nov 2008 18:55:28 +0000</created>
                <updated>Fri, 21 Nov 2008 13:19:23 +0000</updated>
                            <resolved>Thu, 20 Nov 2008 22:19:59 +0000</resolved>
                                    <version>framework-1.4.1</version>
                                    <fixVersion>framework-1.4.1</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12648251" author="wgedeon" created="Mon, 17 Nov 2008 18:58:25 +0000"  >&lt;p&gt;Adding a call to:&lt;br/&gt;
  setRevisionLocation(location, 0);&lt;br/&gt;
after createRevisionFromLocation seems to fix it.&lt;/p&gt;

&lt;p&gt;I&apos;ve attached a patch.&lt;br/&gt;
--w&lt;/p&gt;</comment>
                            <comment id="12648254" author="rickhall" created="Mon, 17 Nov 2008 19:02:44 +0000"  >&lt;p&gt;I wonder why there would be a failure in renaming. Typically under Windows failures occur because the file is open, but the revision.location file should not remain open. Do you have any ideas about why it is failing? Thanks for the feedback.&lt;/p&gt;</comment>
                            <comment id="12648331" author="wgedeon" created="Mon, 17 Nov 2008 21:00:36 +0000"  >&lt;p&gt;I don&apos;t have one yet, I&apos;ve seen it happen before. The directory is not open or used by the other applications...&lt;/p&gt;</comment>
                            <comment id="12648499" author="mcculls" created="Tue, 18 Nov 2008 05:01:07 +0000"  >&lt;p&gt;FYI, in various other projects I&apos;ve found File.renameTo to fail more on Windows than other platforms. Sometimes this is because of filesystem differences (you can&apos;t rename across certain boundaries) other times due to missing access rights, and now and again it seems to fail for no reason at all - the Windows OS believes that the file is open/locked and won&apos;t  let you rename or delete it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The standard fallback when File.renameTo fails (i.e. returns false) is to perform a copy-then-delete operation, which is more expensive but works in more situations. For a concrete example, take a look at the moveDirectory method from Apache Commons-IO:&lt;/p&gt;

&lt;p&gt;   &lt;a href=&quot;http://svn.apache.org/viewvc/commons/proper/io/trunk/src/java/org/apache/commons/io/FileUtils.java?view=markup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/commons/proper/io/trunk/src/java/org/apache/commons/io/FileUtils.java?view=markup&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;HTH&lt;/p&gt;</comment>
                            <comment id="12648621" author="wgedeon" created="Tue, 18 Nov 2008 15:07:12 +0000"  >&lt;p&gt;I&apos;ve managed to reproduce a similar effect in a tiny test environment (attached as &quot;test-bundles.zip&quot;).&lt;br/&gt;
Steps to reproduce:&lt;br/&gt;
#1- run&lt;br/&gt;
#2- install host&lt;br/&gt;
#3- install fragment&lt;br/&gt;
#4- start host&lt;br/&gt;
#5- shutdown&lt;br/&gt;
#6- run&lt;br/&gt;
#7- uninstall fragment&lt;br/&gt;
#8- shutdown -&amp;gt; error message&lt;/p&gt;

&lt;p&gt;I&apos;ve tried to see what happens, everything deletes fine except for the bundle jar. Could it be still locked by the BundleArchive (or the class loader?) at the moment when we&apos;re trying to delete it?&lt;br/&gt;
Anyway, still looking.&lt;/p&gt;

&lt;p&gt;Can someone please try the example to make sure it&apos;s not something that&apos;s specific to some messed-up situation in my environment? Thanks &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The logs are below:&lt;/p&gt;

&lt;p&gt;#1-run&lt;/p&gt;

&lt;p&gt;Listening for transport dt_socket at address: 8787&lt;/p&gt;

&lt;p&gt;Welcome to Felix.&lt;br/&gt;
=================&lt;/p&gt;

&lt;p&gt;-&amp;gt;&lt;br/&gt;
-&amp;gt; ps&lt;br/&gt;
START LEVEL 1&lt;br/&gt;
   ID   State         Level  Name&lt;br/&gt;
[   0] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    0] System Bundle (1.5.0.SNAPSHOT)&lt;br/&gt;
[   1] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] Apache Felix Shell Service (1.0.2)&lt;br/&gt;
[   2] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] Apache Felix Shell TUI (1.0.2)&lt;br/&gt;
[   3] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] Apache Felix Bundle Repository (1.2.1)&lt;br/&gt;
[   4] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] Java XML Binding API (2.1.7)&lt;br/&gt;
[   5] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] Java Activation API (1.1.1)&lt;br/&gt;
[   6] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] Java XML Stream API (StAX) (1.0.1)&lt;br/&gt;
[   8] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] Jaxen XPath Engine (1.1.1)&lt;br/&gt;
[   9] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] JDOM DOM Processor (1.0.0)&lt;br/&gt;
[  10] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] Apache ANT (1.7.0)&lt;br/&gt;
[  11] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] Apache Commons Lang (2.4.0)&lt;br/&gt;
[  12] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] Apache Commons Collections (3.2.0)&lt;br/&gt;
[  13] &lt;span class=&quot;error&quot;&gt;&amp;#91;Active     &amp;#93;&lt;/span&gt; [    1] Apache Velocity Engine (1.5.0)&lt;br/&gt;
-&amp;gt;&lt;br/&gt;
-&amp;gt;&lt;/p&gt;

&lt;p&gt;#2- install host&lt;/p&gt;

&lt;p&gt;-&amp;gt; install &lt;a href=&quot;file:///D&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:///D&lt;/a&gt;|/projects/drawingboard/host/target/test.host-0.0.1-SNAPSHOT.jar&lt;br/&gt;
Bundle ID: 100&lt;/p&gt;

&lt;p&gt;#3- install fragment&lt;/p&gt;

&lt;p&gt;-&amp;gt; install &lt;a href=&quot;file:///D&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:///D&lt;/a&gt;|/projects/drawingboard/fragment/target/test.fragment-0.0.1-SNAPSHOT.jar&lt;br/&gt;
Bundle ID: 101&lt;/p&gt;

&lt;p&gt;#4- start host&lt;/p&gt;

&lt;p&gt;-&amp;gt; start 100&lt;br/&gt;
bundle://100.0:2/fragment/loadme.txt&lt;br/&gt;
vvvvvvvv&lt;br/&gt;
###&lt;br/&gt;
###&lt;br/&gt;
^^^^^^^^&lt;/p&gt;

&lt;p&gt;#5- shutdown&lt;/p&gt;

&lt;p&gt;-&amp;gt; shutdown&lt;br/&gt;
-&amp;gt;&lt;/p&gt;

&lt;p&gt;#6- run&lt;/p&gt;

&lt;p&gt;C:\Programs\Development\felix-1.4.0&amp;gt;run&lt;/p&gt;

&lt;p&gt;C:\Programs\Development\felix-1.4.0&amp;gt;java -server -Xdebug -Xnoagent -Xrunjdwp:transport=dt_socket,address=8787,server=y,suspend=n -jar bin/org.apache.felix.main-1.4.0.jar&lt;br/&gt;
Listening for transport dt_socket at address: 8787&lt;/p&gt;

&lt;p&gt;Welcome to Felix.&lt;br/&gt;
=================&lt;/p&gt;

&lt;p&gt;-&amp;gt; bundle://100.0:2/fragment/loadme.txt&lt;br/&gt;
vvvvvvvv&lt;br/&gt;
###&lt;br/&gt;
###&lt;br/&gt;
^^^^^^^^&lt;/p&gt;

&lt;p&gt;#7- uninstall fragment&lt;/p&gt;

&lt;p&gt;-&amp;gt; uninstall 101&lt;/p&gt;

&lt;p&gt;#8- shutdown -&amp;gt; error message&lt;/p&gt;

&lt;p&gt;-&amp;gt; shutdown&lt;br/&gt;
-&amp;gt; ERROR: org.apache.felix.framework.cache.BundleArchive: Unable to delete archive directory - .\felix-cache\bundle101&lt;/p&gt;</comment>
                            <comment id="12648976" author="wgedeon" created="Wed, 19 Nov 2008 10:48:50 +0000"  >&lt;p&gt;I&apos;ve renamed the issue to reflect findings.&lt;/p&gt;

&lt;p&gt;PS: attached patch does not address issue resolution anymore, should it be deleted? or is there a way to invalidate it?&lt;/p&gt;</comment>
                            <comment id="12649034" author="rickhall" created="Wed, 19 Nov 2008 13:43:16 +0000"  >&lt;p&gt;I finally have Windows available to test this, so I will try to look into it more closely. Thanks.&lt;/p&gt;</comment>
                            <comment id="12649506" author="rickhall" created="Thu, 20 Nov 2008 22:19:59 +0000"  >&lt;p&gt;I have committed a fix for this. It appears the issue was how we remove uninstalled bundles during shutdown. The uninstalled fragment was getting removed, but the host bundle still had its JAR file open so it could not be successfully removed. I modified the shutdown routine to close all bundles first, then to remove uninstalled bundles to make sure all references to the bundle JAR files are closed.&lt;/p&gt;

&lt;p&gt;Walid, if this resolves the issue for you, please close it. Thanks for reporting it!&lt;/p&gt;</comment>
                            <comment id="12649669" author="wgedeon" created="Fri, 21 Nov 2008 13:19:23 +0000"  >&lt;p&gt;Yep it does. I&apos;ve closed it.&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12394172" name="test-bundles.zip" size="8736" author="wgedeon" created="Tue, 18 Nov 2008 15:07:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>58170</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1aqkf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>270770</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>