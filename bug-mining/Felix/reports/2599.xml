<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:00:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5131] UnsupportedOperationException when embedding felix in WebSphere</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5131</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;Hello, we are embedding the OSGi framework in our application (creating the framework , managing its export packages, contolling the bundles &amp;amp;c.). This works great in a lot of enviroments, but not on WebSphere (using the IBM JDK): &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.UnsupportedOperationException
	at org.apache.felix.resolver.util.CopyOnWriteList.listIterator(CopyOnWriteList.java:218)
	at java.util.Collections.binarySearch(Collections.java:1551)
	at org.apache.felix.framework.ResolveContextImpl.insertHostedCapability(ResolveContextImpl.java:103)
	at org.apache.felix.resolver.Candidates.prepare(Candidates.java:934)
	at org.apache.felix.resolver.ResolverImpl.resolve(ResolverImpl.java:233)
	at org.apache.felix.resolver.ResolverImpl.resolve(ResolverImpl.java:159)
	at org.apache.felix.framework.StatefulResolver.resolve(StatefulResolver.java:431)
	at org.apache.felix.framework.Felix.resolveBundleRevision(Felix.java:4109)
	at org.apache.felix.framework.Felix.startBundle(Felix.java:2111)
	at org.apache.felix.framework.Felix.setActiveStartLevel(Felix.java:1365)
	at org.apache.felix.framework.FrameworkStartLevelImpl.run(FrameworkStartLevelImpl.java:308)
	at java.lang.Thread.run(Thread.java:790)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem seems to be that in the IBM JDK, the Collections.binarySearch method directly uses the listIterator of the list if it is not a RandomAccess list (while the oracle JDK doesn&apos;t).&lt;/p&gt;

&lt;p&gt;A solution it to add the interface RandomAccess to the CopyOnWriteList class. I&apos;ve tested this locally and eveything runs fine.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12919607">FELIX-5131</key>
            <summary>UnsupportedOperationException when embedding felix in WebSphere</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tjwatson">Tom Watson</assignee>
                                    <reporter username="tsc">Thomas Schurins</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Dec 2015 08:39:05 +0000</created>
                <updated>Thu, 13 Oct 2016 06:39:55 +0000</updated>
                            <resolved>Tue, 8 Mar 2016 08:36:13 +0000</resolved>
                                    <version>framework-5.2.0</version>
                    <version>resolver-1.6.0</version>
                                    <fixVersion>resolver-1.10.0</fixVersion>
                                    <component>Framework</component>
                    <component>Resolver</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15092618" author="tjwatson" created="Mon, 11 Jan 2016 20:25:52 +0000"  >&lt;p&gt;I think we should implement as many of the List operations as feasible.  I don&apos;t really like the idea of implementing RandomAccess to avoid certain algorithms from using a list iterator.  But I do agree that CopyOnWriteList is in fact a random access list so I don&apos;t see any harm in adding it to the implements of CopyOnWriteList.&lt;/p&gt;

&lt;p&gt;The issue is the CopyOnWriteList object is exposed when calling out to ResolveContext.insertHostedCapability.  The javadoc for that OSGi method does not state any limitations on the operations that can be supported on that object.  But I am pretty sure any resolver implementation is going to fail badly if the method does not result in adding/inserting the specified HostedCapability into the specified List.  For example, removing anything from the list is a good way to bust the resolver impl.&lt;/p&gt;

&lt;p&gt;As a result I think we should at least implement all the add methods as well as a ListIterator that supports add and set operations.&lt;/p&gt;</comment>
                            <comment id="15092625" author="tjwatson" created="Mon, 11 Jan 2016 20:28:20 +0000"  >&lt;p&gt;Actually the ListIterator must NOT support the set operation since that would remove and replace an existing entry from the list, again a good way to bust the resolver impl.&lt;/p&gt;</comment>
                            <comment id="15092767" author="tjwatson" created="Mon, 11 Jan 2016 22:01:45 +0000"  >&lt;p&gt;Possible fix to implement more List operations and implement RandomAccess&lt;/p&gt;</comment>
                            <comment id="15092783" author="tjwatson" created="Mon, 11 Jan 2016 22:11:28 +0000"  >&lt;p&gt;When looking at the IBM VM it seems that it treats all Lists as RandomAccess for Collections.binarySearch unless it has more than 5000 elements.  When you reproduced did you really have 5000 matching capabilities?&lt;/p&gt;</comment>
                            <comment id="15093500" author="tsc" created="Tue, 12 Jan 2016 08:07:45 +0000"  >&lt;p&gt;Thanks for looking at this.&lt;br/&gt;
I&apos;m using the IBM jdk 1.6.0 (sic) coming with WebSphere. Here is the binarySearch method:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &amp;lt;T&amp;gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; binarySearch(List&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; T&amp;gt; list, T object,
		Comparator&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt; T&amp;gt; comparator) {
	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comparator == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Collections.binarySearch(
				(List&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Comparable&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt; T&amp;gt;&amp;gt;) list, object);
	}
	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(list &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; RandomAccess)) {
		ListIterator&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; T&amp;gt; it = list.listIterator();
		&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (it.hasNext()) {
			&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; result;
			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((result = -comparator.compare(it.next(), object)) &amp;lt;= 0) {
				&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (result == 0) {
					&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; it.previousIndex();
				}
				&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; -it.previousIndex() - 1;
			}
		}
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; -list.size() - 1;
	}

	&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; low = 0, mid = list.size(), high = mid - 1, result = -1;
	&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (low &amp;lt;= high) {
		mid = (low + high) &amp;gt;&amp;gt; 1;
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((result = -comparator.compare(list.get(mid),object)) &amp;gt; 0) {
			low = mid + 1;
		} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (result == 0) {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; mid;
		} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
			high = mid - 1;
		}
	}
	&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; -mid - (result &amp;lt; 0 ? 1 : 2);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="15093869" author="tjwatson" created="Tue, 12 Jan 2016 13:30:46 +0000"  >&lt;p&gt;Thanks for the info on the IBM Java 6 VM.  I was looking at the IBM Java 7 VM which looks more like the Oracle Java 7 VM for this method.&lt;/p&gt;

&lt;p&gt;That makes this defect a bit more serious for me also since I have to be able to use the resolver impl on the IBM Java 6 VM for a long while still.&lt;/p&gt;</comment>
                            <comment id="15157343" author="tjwatson" created="Mon, 22 Feb 2016 17:29:14 +0000"  >&lt;p&gt;I released the patch.  I must not have enough karma because I cannot seem to take ownership of this bug or move it along to change status to FIXED.&lt;/p&gt;</comment>
                            <comment id="15184622" author="tsc" created="Tue, 8 Mar 2016 08:03:32 +0000"  >&lt;p&gt;Great - can you at least tell in which versions it is corrected?&lt;/p&gt;</comment>
                            <comment id="15184663" author="gnt" created="Tue, 8 Mar 2016 08:36:44 +0000"  >&lt;p&gt;It has not been released yet.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12781659" name="FELIX-5131.patch" size="3727" author="tjwatson" created="Mon, 11 Jan 2016 22:01:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 37 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2pipr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>