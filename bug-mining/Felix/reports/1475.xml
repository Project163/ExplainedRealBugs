<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:33:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3336] Exceptions related to the pipe used in deployment admin</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3336</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;Sporadically getting &quot;Pipe closed&quot; exceptions. Not reproducible yet, but seemingly related to a line containing &quot;input.close()&quot; in the ExplodingOutputtingInputStream. Needs investigation.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12541045">FELIX-3336</key>
            <summary>Exceptions related to the pipe used in deployment admin</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marrs">Marcel Offermans</assignee>
                                    <reporter username="marrs">Marcel Offermans</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Feb 2012 08:51:48 +0000</created>
                <updated>Wed, 5 Jun 2013 20:57:05 +0000</updated>
                            <resolved>Wed, 24 Apr 2013 14:48:16 +0000</resolved>
                                                    <fixVersion>deploymentadmin-0.9.4</fixVersion>
                                    <component>Deployment Admin</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13199665" author="marrs" created="Fri, 3 Feb 2012 12:43:30 +0000"  >&lt;p&gt;A solution has been committed, but I&apos;m not quite sure why it works. If you do a checkout, and run &quot;mvn clean install&quot; the test succeeds. If you apply this patch:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Index: src/main/java/org/apache/felix/deploymentadmin/ExplodingOutputtingInputStream.java
===================================================================
--- src/main/java/org/apache/felix/deploymentadmin/ExplodingOutputtingInputStream.java	(revision 1240137)
+++ src/main/java/org/apache/felix/deploymentadmin/ExplodingOutputtingInputStream.java	(working copy)
@@ -73,7 +73,7 @@
         &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(inputStream, output);
         m_contentDir = root;
         m_indexFile = index;
-        m_input = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PipedInputStream(output &lt;span class=&quot;code-comment&quot;&gt;/*, 8 FELIX-3336: &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; you provide such a small buffer, the error is reproducible (see below) */&lt;/span&gt;);
+        m_input = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PipedInputStream(output , 8 &lt;span class=&quot;code-comment&quot;&gt;/* FELIX-3336: &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; you provide such a small buffer, the error is reproducible (see below) */&lt;/span&gt;);
         m_task = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Apache Felix DeploymentAdmin - ExplodingOutputtingInputStream&quot;&lt;/span&gt;);
         m_task.start();
     }
@@ -129,16 +129,16 @@
             }
         }
         &lt;span class=&quot;code-comment&quot;&gt;// FELIX-3336: &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; you include &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; code, the issue is gone
&lt;/span&gt;-        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
-            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bb = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[512];
-            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; c = m_input.read(bb);
-            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (c != -1) {
-                c = m_input.read(bb);
-            }
-        }
-        &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
-            e.printStackTrace();
-        }
+&lt;span class=&quot;code-comment&quot;&gt;//        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
&lt;/span&gt;+&lt;span class=&quot;code-comment&quot;&gt;//            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bb = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[512];
&lt;/span&gt;+&lt;span class=&quot;code-comment&quot;&gt;//            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; c = m_input.read(bb);
&lt;/span&gt;+&lt;span class=&quot;code-comment&quot;&gt;//            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (c != -1) {
&lt;/span&gt;+&lt;span class=&quot;code-comment&quot;&gt;//                c = m_input.read(bb);
&lt;/span&gt;+&lt;span class=&quot;code-comment&quot;&gt;//            }
&lt;/span&gt;+&lt;span class=&quot;code-comment&quot;&gt;//        }
&lt;/span&gt;+&lt;span class=&quot;code-comment&quot;&gt;//        &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
&lt;/span&gt;+&lt;span class=&quot;code-comment&quot;&gt;//            e.printStackTrace();
&lt;/span&gt;+&lt;span class=&quot;code-comment&quot;&gt;//        }
&lt;/span&gt;     }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And then run the test again, you get:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ cat target/surefire-reports/org.apache.felix.deploymentadmin.ExplodingOutputtingInputStreamTest.txt 
-------------------------------------------------------------------------------
Test set: org.apache.felix.deploymentadmin.ExplodingOutputtingInputStreamTest
-------------------------------------------------------------------------------
Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 1.071 sec &amp;lt;&amp;lt;&amp;lt; FAILURE!
testStream(org.apache.felix.deploymentadmin.ExplodingOutputtingInputStreamTest)  Time elapsed: 1.057 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.io.IOException: Read end dead
	at java.io.PipedInputStream.checkStateForReceive(PipedInputStream.java:246)
	at java.io.PipedInputStream.awaitSpace(PipedInputStream.java:252)
	at java.io.PipedInputStream.receive(PipedInputStream.java:215)
	at java.io.PipedOutputStream.write(PipedOutputStream.java:132)
	at org.apache.felix.deploymentadmin.OutputtingInputStream.read(OutputtingInputStream.java:58)
	at org.apache.felix.deploymentadmin.ExplodingOutputtingInputStreamTest.testStream(ExplodingOutputtingInputStreamTest.java:47)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39) [...]

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For some weird reason the read blocks and finally generates an exception because the pipe has been closed. I have no clue why the read blocks though, and why reading extra bytes from an underlying stream (m_input) that should have already been read completely (this ZipInputStream reads everything it should) unblocks the read. Admittedly, this is not the easiest piece of code to read, but I can&apos;t find a fundamental flaw in the approach. Maybe someone else can. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13199767" author="jajans" created="Fri, 3 Feb 2012 15:24:39 +0000"  >&lt;p&gt;After some debugging, it appears that a ZipInputStream does &lt;b&gt;not&lt;/b&gt; read all bytes from the underlying input stream, but stops after the last ZIP-entry (after this the central directory of the ZIP file is stored, which is not used by the implementation). Hence, the ExplodingOutputtingInputStream thinks it has read all underlying bytes, but in fact this is not the case. So, it terminates, while the other end still is processing the last couple of bytes (= central directory of ZIP-file). This explains why the above error occurs.&lt;/p&gt;

&lt;p&gt;A solution would be to read the last couple of bytes in the input stream after the ZipInputStream is finished...&lt;/p&gt;

&lt;p&gt;PS: one of the reasons why this might spuriously occur in real life is that the buffer size of PipedInputStream is large enough to read those last couple of bytes of the ZIP file...&lt;/p&gt;</comment>
                            <comment id="13640504" author="marrs" created="Wed, 24 Apr 2013 14:48:16 +0000"  >&lt;p&gt;This has been fixed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>226397</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 31 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i00yef:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3505</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>