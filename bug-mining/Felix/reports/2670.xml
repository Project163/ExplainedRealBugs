<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:03:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5315] Unexpected release of ConfigurationAdmin service in RegionConfigurationSupport </title>
                <link>https://issues.apache.org/jira/browse/FELIX-5315</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;In commit 978a710, RegionConfigurationSupport has been modified to obtain the ConfigurationAdmin service through the ConfigurationAdmin&apos;s bundle context (in getConfigAdmin(), around line 633). However, services acquired through that method are then released using the impersonated bundle&apos;s context (for example in the finally block of configureComponentHolder(ComponentHolder), around line 186, and the finally block of getConfigurationInfo(TargetedPID, TargetedPID, ComponentHolder, BundleContext), around line 465).&lt;/p&gt;

&lt;p&gt;This cause leak of service on the ConfigurationAdmin&apos;s bundle context, as well as unexpected early release of services on impersonated bundle contexts, causing an IllegalStateException(&quot;Configuration Admin service has been unregistered&quot;) being thrown in ConfigurationAdminImpl#getConfigurationManager().&lt;/p&gt;</description>
                <environment></environment>
        <key id="12994003">FELIX-5315</key>
            <summary>Unexpected release of ConfigurationAdmin service in RegionConfigurationSupport </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="djencks">David Jencks</assignee>
                                    <reporter username="mjameswh">James Watkins-Harvey</reporter>
                        <labels>
                    </labels>
                <created>Mon, 1 Aug 2016 15:45:05 +0000</created>
                <updated>Sat, 6 Aug 2016 07:09:52 +0000</updated>
                            <resolved>Tue, 2 Aug 2016 16:15:17 +0000</resolved>
                                    <version>scr-2.0.4</version>
                                    <fixVersion>scr-2.0.6</fixVersion>
                                    <component>Configuration Admin</component>
                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15402335" author="cziegeler" created="Mon, 1 Aug 2016 16:18:39 +0000"  >&lt;p&gt;We&apos;re hitting this as well, thanks for reporting!&lt;/p&gt;</comment>
                            <comment id="15403363" author="djencks" created="Tue, 2 Aug 2016 05:11:35 +0000"  >&lt;p&gt;I committed a fix in r1754817.  I&apos;d like to verify with some experts that the fix is OK since it involves calling bundleContext.getService(serviceRef) with a serviceReference obtained from a different bundleContext. This seems to work and I don&apos;t see anything in the spec saying it shouldn&apos;t but it certainly isn&apos;t a common usage.&lt;/p&gt;

&lt;p&gt;This is a pretty egregious and serious problem, I wonder after it really is fixed if we should immediately release 2.0.6?&lt;/p&gt;</comment>
                            <comment id="15403425" author="cziegeler" created="Tue, 2 Aug 2016 06:08:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djencks&quot; class=&quot;user-hover&quot; rel=&quot;djencks&quot;&gt;djencks&lt;/a&gt; Thanks for the quick fix, it seems to solve our problem and I can&apos;t see the IllegalStateException(&quot;Configuration Admin service has been unregistered&quot;) anymore.&lt;br/&gt;
The java API of ServiceReference says: &quot;A ServiceReference object may be shared between bundles and can be used to examine the properties&lt;br/&gt;
of the service and to get the service object.&quot;, so I think we&apos;re good.&lt;/p&gt;

&lt;p&gt;We should definitely get out a 2.0.6 as quickly as possible, if we agree on this fix, I can do the release asap.&lt;/p&gt;</comment>
                            <comment id="15404289" author="djencks" created="Tue, 2 Aug 2016 16:15:17 +0000"  >&lt;p&gt;That javadoc quote seems pretty conclusive &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  I think we can go ahead with the release.&lt;/p&gt;</comment>
                            <comment id="15404317" author="mjameswh" created="Tue, 2 Aug 2016 16:26:29 +0000"  >&lt;p&gt;Actually, there could be an issue if there are more than one ConfigurationAdmin services in the environment, with one being visible to the SCR bundle and another one to an impersonated bundle. Though this in itself appears to be a very unlikely configuration, I can think of some corner cases where it would be possible: 1) multiple regions with SCR being loaded in a parent region while ConfigurationAdmin is loaded in a child region; 2) manipulations on bundle/services visibility done with hooks or a custom resolver. Neither case would be less an issue with 2.0.4 though, so that should not prevent a release of the proposed fix, but maybe one may want to think a little more about these rare yet possible occurrences...&lt;/p&gt;</comment>
                            <comment id="15404635" author="djencks" created="Tue, 2 Aug 2016 19:25:55 +0000"  >&lt;p&gt;The existence of RegionConfigurationSupport is entirely to deal with this scenario, and some informal testing seems to indicate that it works (at least before I broke stuff in 978a710).  If you can think of an actual scenario where the current code doesn&apos;t work please explain.  Roughly speaking how I think I set it up is:&lt;br/&gt;
precondition: there&apos;s only one config admin api visible anywhere.  DS isn&apos;t reasonably going to be able to deal with config admin services that implement CA from a package inconsistent with the CA interfaces DS sees.&lt;br/&gt;
precondition: there is a maximum of 1 config admin service visible to each extended bundle.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;each extended bundle opens a ServiceTracker for config admin services.&lt;/li&gt;
	&lt;li&gt;When a config admin service shows up in one of these trackers, we find the bundle it&apos;s registered with and see if it&apos;s a config admin implementation we already know about.  If not, we add a new RegionConfigurationSupport for it (slightly simplified to elide the no-lock implementation). Therefore, there is a 1-1 relationship between config admin services that could possibly be relevant to an extended bundle and RegionConfigurationSupport instances.&lt;/li&gt;
	&lt;li&gt;the RegionConfigurationSupport deals with configuration events from this config admin service and distributes them to relevant components that can see the associated config admin service.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15404697" author="mjameswh" created="Tue, 2 Aug 2016 20:14:20 +0000"  >&lt;p&gt;Thanks for your clarifications! I had indeed missed a few key facts about the code&apos;s architecture, and was therefore under the impression that a &lt;tt&gt;caReference&lt;/tt&gt; could be passed to a bundle context that would not be able to resolve it. However, I see now how the code indeed ensure that 1) there is exactly one RegionConfigurationSupport for each ConfigurationAdmin implementation bundle, 2) the correct RegionConfigurationSupport is used on resolving some component, and 3) that the &lt;tt&gt;caReference&lt;/tt&gt; can consequently only be passed to a bundle context for which that reference would be valid. That sounds good for the multiple region case.&lt;/p&gt;

&lt;p&gt;As for the other case I mentioned, that is manipulation of bundle/service visibility, for example using service hooks, I&apos;m not absolutely certain that it would not be possible to create a problematic setup, but it seems indeed that the current solution should also handle pretty much any case properly, as long as the second precondition holds (that is, only one config admin service visible to each extended bundle).&lt;/p&gt;

&lt;p&gt;Good job &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 16 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i31r7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>