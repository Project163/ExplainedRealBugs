<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:04:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5450] Fragments with multiple hosts can cause java.lang.ArrayIndexOutOfBoundsException</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5450</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;The fix in &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5389&quot; title=&quot;NullPointerException in Candidates#prepare() method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5389&quot;&gt;&lt;del&gt;FELIX-5389&lt;/del&gt;&lt;/a&gt; for ShadowList is not complete.  There are still cases where the underlying ArrayList from the CandidateSelector is reused in the ShadowList when it is not intended.  This leads to exceptions like the following:&lt;/p&gt;

&lt;p&gt;java.lang.ArrayIndexOutOfBoundsException: -1&lt;br/&gt;
	at java.util.ArrayList.elementData(ArrayList.java:418)&lt;br/&gt;
	at java.util.ArrayList.set(ArrayList.java:446)&lt;br/&gt;
	at org.apache.felix.resolver.util.ShadowList.replace(ShadowList.java:81)&lt;br/&gt;
	at org.apache.felix.resolver.Candidates.prepare(Candidates.java:915)&lt;br/&gt;
	at org.apache.felix.resolver.ResolverImpl.getInitialCandidates(ResolverImpl.java:502)&lt;br/&gt;
	at org.apache.felix.resolver.ResolverImpl.doResolve(ResolverImpl.java:387)&lt;br/&gt;
	at org.apache.felix.resolver.ResolverImpl.resolve(ResolverImpl.java:375)&lt;br/&gt;
	at org.apache.felix.resolver.ResolverImpl.resolve(ResolverImpl.java:368)&lt;/p&gt;

&lt;p&gt;This is happening when there are multiple hosts for a single fragment and the fragment has a requirement that is getting resolved to a candidate from another host resource that also has at least one fragment.&lt;/p&gt;

&lt;p&gt;The issue comes up when replacing the capability from the host with a wrapped capability for the fragment requirement which is a payload requirement for more than one host.  It should do this for each WrappedRequirement that is wrapping the payload requirement from the fragment to each host.  The first WrappedRequirement has its candidates modified, but that changes the shared ArrayList of the candidates for each of the other WrappedRequirements for the other hosts.  The fix for this is to ensure the ArrayList from a CandidateSelector is never shared with a ShadowList.&lt;/p&gt;

&lt;p&gt;But once I fixed this I ran into another strange issue that ended up causing Uses constraint errors like this:&lt;/p&gt;

&lt;p&gt;org.osgi.service.resolver.ResolutionException: Uses constraint violation. Unable to resolve resource host &lt;span class=&quot;error&quot;&gt;&amp;#91;osgi.identity; host&amp;#93;&lt;/span&gt; because it is exposed to package &apos;exporter&apos; from resources exporter &lt;span class=&quot;error&quot;&gt;&amp;#91;osgi.identity; exporter&amp;#93;&lt;/span&gt; and exporter &lt;span class=&quot;error&quot;&gt;&amp;#91;osgi.identity; exporter&amp;#93;&lt;/span&gt; via two dependency chains.&lt;/p&gt;

&lt;p&gt;Chain 1:&lt;br/&gt;
  host &lt;span class=&quot;error&quot;&gt;&amp;#91;osgi.identity; host&amp;#93;&lt;/span&gt;&lt;br/&gt;
    import: (osgi.wiring.package=exporter)&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;    export: osgi.wiring.package: exporter&lt;br/&gt;
  exporter &lt;span class=&quot;error&quot;&gt;&amp;#91;osgi.identity; exporter&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Chain 2:&lt;br/&gt;
  host &lt;span class=&quot;error&quot;&gt;&amp;#91;osgi.identity; host&amp;#93;&lt;/span&gt;&lt;br/&gt;
    import: (osgi.wiring.package=exporter)&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;    export: osgi.wiring.package: exporter&lt;br/&gt;
  exporter &lt;span class=&quot;error&quot;&gt;&amp;#91;osgi.identity; exporter&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;This only happens if a fragment has more than one host and the fragment and host have a requirement for a the same package.  Additionally the capability that satisfies the payload requirement must come from a host that also has at least one fragment.  The issue here is how we are finding CandidateSelectors of depending requirements when we need to replace a capability with a wrapped capability.  There is a loop in the Candidates.prepare method which is says &quot;Copy candidates for fragment requirements to the host.&quot;.  This loop basically copies the candidates from the original requirement from the fragment to a CandidateSelector for the WrappedRequirement for the host.  But it also removes the original requirement from the dependents for the capability.  If there are multiple hosts this becomes problematic because this dependency set is used to find CandidateSelectors that need to be modified when wrapping a host.  But since we remove the original requirement from the fragment that means any other hosts the fragment is attached to will not be discovered and therefore will not have the original capability properly replaced with the WrappedCapability.  That makes the consistency check fail and give this bogus message that make it look like there are 2 identical chains leading to the identical capability.  But the two capabilities are different because one is wrapped and one is not.&lt;/p&gt;

&lt;p&gt;The fix is to separate out the inner loop that &quot;Copy candidates for fragment requirements to the host.&quot; to a outer loop that is done before the main loop over the hostResources.  This way we properly setup all the CandidateSelector for the payload WrappedRequirements before actually modifying the CandidateSelector capabilities with the WrappedCapabilities.&lt;/p&gt;

&lt;p&gt;Super long story short:  Fragments are just horribly complex. &lt;/p&gt;</description>
                <environment></environment>
        <key id="13028490">FELIX-5450</key>
            <summary>Fragments with multiple hosts can cause java.lang.ArrayIndexOutOfBoundsException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tjwatson">Tom Watson</assignee>
                                    <reporter username="tjwatson">Tom Watson</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Dec 2016 20:27:58 +0000</created>
                <updated>Thu, 16 Feb 2017 20:50:57 +0000</updated>
                            <resolved>Thu, 15 Dec 2016 21:53:41 +0000</resolved>
                                    <version>resolver-1.10.1</version>
                                    <fixVersion>resolver-1.12.0</fixVersion>
                                    <component>Resolver</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15752620" author="tjwatson" created="Thu, 15 Dec 2016 21:53:41 +0000"  >&lt;p&gt;I committed a fix along with two new tests.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 48 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37nrb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>