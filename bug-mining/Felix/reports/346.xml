<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:08:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-961] 100% CPU looping inside uses calculation</title>
                <link>https://issues.apache.org/jira/browse/FELIX-961</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;While investigating a problem report against pax-runner (&lt;a href=&quot;http://article.gmane.org/gmane.comp.java.ops4j.general/6778&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://article.gmane.org/gmane.comp.java.ops4j.general/6778&lt;/a&gt;) I found it was actually caused by a 100% CPU loop inside the &quot;uses&quot; calculation code. In Felix 1.4.1 this was stopping the shell bundle from activating, hence the lack of console. Using the trunk build I can get a console, but the looping still occurs with the testcase.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12415535">FELIX-961</key>
            <summary>100% CPU looping inside uses calculation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="mcculls">Stuart McCulloch</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Feb 2009 07:04:11 +0000</created>
                <updated>Fri, 6 Mar 2009 16:26:43 +0000</updated>
                            <resolved>Fri, 27 Feb 2009 17:34:11 +0000</resolved>
                                    <version>framework-1.4.1</version>
                                    <fixVersion>framework-1.6.0</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12676539" author="mcculls" created="Wed, 25 Feb 2009 07:14:53 +0000"  >&lt;p&gt;The attached testcase (Felix + config + bundles) reproduces the uses calculation problem while reducing the amount of bundles from the original testcase (which also included Spring-DM). Note the problem is a bit intermittent, but isn&apos;t rare.&lt;/p&gt;

&lt;p&gt;Adding more bundles to the testcase increases the chance of the problem occurring.&lt;/p&gt;</comment>
                            <comment id="12676542" author="mcculls" created="Wed, 25 Feb 2009 07:28:29 +0000"  >&lt;p&gt;Just to clarify, this is not technically a hang because the framework is still doing work - it can just take a long time to complete.&lt;br/&gt;
For example, the attached testcase can take a few minutes before everything resolves and if more bundles are added then it&lt;br/&gt;
takes much longer (perhaps exponential, but I don&apos;t have the evidence yet).&lt;/p&gt;</comment>
                            <comment id="12676550" author="mcculls" created="Wed, 25 Feb 2009 07:50:44 +0000"  >&lt;p&gt;Larger testcase that takes a very long time to resolve.&lt;/p&gt;</comment>
                            <comment id="12676634" author="bdelacretaz" created="Wed, 25 Feb 2009 12:49:12 +0000"  >&lt;p&gt;I have seen similar problems when working on the Sling jcrinstall module, framework seems to hang but is really only spending &lt;b&gt;lots&lt;/b&gt; of time in the R4SearchPolicyCore.findConsistentClassSpace() method.&lt;/p&gt;

&lt;p&gt;Looks like my problem is more likely to happen with JDK 1.6 than with JDK 1.5: the test scenario below always passes with 1.5 but &quot;hangs&quot; almost every time with 1.6 (macosx, java versions &quot;1.6.0-dp&quot; and &quot;1.5.0_16&quot;).&lt;/p&gt;

&lt;p&gt;Note that I&apos;m still running V1.0.4 of the Felix framework for those tests, so not sure if it&apos;s the same problem.&lt;/p&gt;

&lt;p&gt;Here&apos;s my test scenario FWIW.&lt;/p&gt;

&lt;p&gt;Uses the Felix webconsole mounted at /system/console.&lt;/p&gt;

&lt;p&gt;1. Install about 80 bundles (can&apos;t share those, sorry) via the console, using a loop of CURL commands like&lt;/p&gt;

&lt;p&gt;curl -F action=install -Fbundlefile=@$f &lt;a href=&quot;http://admin:admin@localhost:4502/system/console/bundles&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://admin:admin@localhost:4502/system/console/bundles&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2. Try to start all bundles using a loop of CURL commands like&lt;/p&gt;

&lt;p&gt;curl -d action=start &lt;a href=&quot;http://admin:admin@localhost:4502/system/console/bundles/N&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://admin:admin@localhost:4502/system/console/bundles/N&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;with N ranging from 20 (the number of bundles installed before 1.) to 150&lt;/p&gt;

&lt;p&gt;With JDK 1.6, step 2. very often hangs when the first bundle is started (HTTP response does not come), and jconsole shows the SCR Actor thread spending all its time inside R4SearchPolicyCore.findConsistentClassSpace() &lt;/p&gt;</comment>
                            <comment id="12676664" author="rickhall" created="Wed, 25 Feb 2009 14:36:06 +0000"  >&lt;p&gt;It is certainly a known issue that finding a consistent class space may take a long time, since the algorithm is very simplistic and the search space is potentially very big. It should not hang or loop indefinitely, however. If it is, that sounds like a bug.&lt;/p&gt;</comment>
                            <comment id="12677012" author="rickhall" created="Thu, 26 Feb 2009 14:57:12 +0000"  >&lt;p&gt;Looking at TESTCASE2, it does indeed lead to long delays, although it does appear to be making progress in all cases. Interestingly, some executions do finish quickly, which is dependent upon the ordering we get when we iterate over the entries in a hash map. In short, the algorithm is working as expected, which can be slow in some scenarios. I am looking into implementing some heuristics that may help us out, but worst case will always be bad unless we come up with a completely different algorithm. Hopefully, I can improve this case.&lt;/p&gt;</comment>
                            <comment id="12677042" author="mcculls" created="Thu, 26 Feb 2009 15:43:37 +0000"  >&lt;p&gt;FWIW, I believe Equinox now attempts the correct algorithm for a certain period and then switches to a less accurate &quot;best-effort&quot; approach if it takes too long.&lt;/p&gt;</comment>
                            <comment id="12677425" author="rickhall" created="Fri, 27 Feb 2009 17:18:26 +0000"  >&lt;p&gt;As a side note, from my understanding of how Equinox works, if it detects a resolve is taking too long, it just takes the best result it has so far and excludes any bundles that could not resolve and resolves the rest. This approach may make sense for Equinox because it resolves all unresolved bundles every time it resolves any, but Felix&apos; resolver is incremental, meaning it only resolves the bundles it needs to resolve.&lt;/p&gt;

&lt;p&gt;Thus, in Felix if you resolve bundle foo, only bundles related to foo through dependencies will be resolved. There are no other byproducts. If foo fails to resolve, then there is no change to the resolved state. This is not true for Equinox. However, we could potentially modify Felix&apos; resolver to simply fail if it starts to take too long, rather than run until it finds a solution or fails (which could take a long time).&lt;/p&gt;

&lt;p&gt;Keep in mind that Equinox&apos; &quot;best effort&quot; approach is just a way to end a long resolve, it doesn&apos;t necessarily result in a solution for a particular bundle, it just results in whatever it could accomplish, which may or may not include the bundle you wanted to resolve.&lt;/p&gt;</comment>
                            <comment id="12677426" author="rickhall" created="Fri, 27 Feb 2009 17:34:11 +0000"  >&lt;p&gt;I think TESTCASE2 was interesting, since it demonstrated that it is fairly easy to get into fairly long running &quot;uses&quot; constraint violations without a really complicated use case. In this particular case, the issue arose because bundles were overriding packages provided by the system bundle. This resulted in lots of imports that had two candidates, one from the system bundle and one from another bundle.&lt;/p&gt;

&lt;p&gt;This ended up being a worst case scenario since the system bundle export was chosen first, since it was resolved already and resolved packages are given preference. I noticed that some bundles eliminated the system bundle by including a version range on their imports, but others did not. If all bundles imported with an appropriate version range, then this issue would not have appeared, since there wouldn&apos;t have been so many imports with multiple candidates.&lt;/p&gt;

&lt;p&gt;As a result, I implemented two &quot;fixes&quot; for this:&lt;/p&gt;

&lt;p&gt;1. I noticed that some runs wouldn&apos;t take long depending on the order of the bundles when calculating uses constraints, which changed since they were pulled out of a map. If bundles with lots of potential candidates for their imports were handled first, it seemed to be quicker. Thus, I modified the resolver to first sort the bundles based the number of potential candidates they had. This change got the resolver completing consistently in about 15 seconds with testcase2.&lt;/p&gt;

&lt;p&gt;2. The algorithm for permutating from one set of potential candidates to another when a constraint violation is detected is exhaustive, but not very smart. In an effort to make it a little smarter, I thought of a way to make it permutate the candidates for a specific bundle when a constraint is detected without losing the ability to be exhaustive; now the resolver rotates the potential candidates for the bundle where the constraint violation was detected and retests. This change got the resolver completing consistently in about 1 second with testcase2.&lt;/p&gt;

&lt;p&gt;It is not clear if these fixes are general or specific to testcase2, but my intuition says they should provide general improvements. However, they have not fixed the worst case situation and it is still possible some set of bundles could cause the resolver to go on for a very long time trying to find a solution. The only solution here is to fail after a certain amount of time or to completely rewrite the resolver.&lt;/p&gt;</comment>
                            <comment id="12677427" author="rickhall" created="Fri, 27 Feb 2009 17:35:24 +0000"  >&lt;p&gt;I forgot to add, I&apos;d be interested in others reporting any results they have and for this issue to be closed if the original issue is resolved.&lt;/p&gt;</comment>
                            <comment id="12679637" author="mcculls" created="Fri, 6 Mar 2009 16:26:43 +0000"  >&lt;p&gt;Just tried the latest framework compiled from trunk with the original testcase (~40 bundles)&lt;br/&gt;
While it still takes some time resolve (around 1 minute) I think this is reasonable given this&lt;br/&gt;
particular selection of imports, uses constraints, and version ranges.&lt;/p&gt;

&lt;p&gt;So I&apos;ll close this issue, but as Richard says - if anyone has more scenarios let us know &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12400914" name="USES_TESTCASE.zip" size="5330075" author="mcculls" created="Wed, 25 Feb 2009 07:14:53 +0000"/>
                            <attachment id="12400918" name="USES_TESTCASE2.zip" size="8224858" author="mcculls" created="Wed, 25 Feb 2009 07:50:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>58029</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 38 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1aqx3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>270827</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>