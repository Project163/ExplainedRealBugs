<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:50:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3360] Bundle location is statically set for dynamically bound bundles</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3360</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;The method ConfigurationAdminImpl#getConfiguration(pid) dynamically sets the configuration&apos;s bundle location if it is null. However, it uses ConfigurationImpl#setStaticBundleLocation(location) in order to do so. This should be changed to set the dynamic location. Attached is a proposed patch.&lt;/p&gt;

&lt;p&gt;The issue I observed, that lead me to this bug, was as follows:&lt;/p&gt;

&lt;p&gt;1. Installed a number of factory configurations and the bundle (version 1.0.0, bundle location: jcrinstall:/apps/sample/install/bundle-1.0.0.jar) providing the service implementation (using SCR) via Sling&apos;s OSGi Installer&lt;br/&gt;
2. Uninstalled the bundle.&lt;br/&gt;
3. Installed the bundle (version 1.0.2, bundle location: jcrinstall:/apps/sample/install/bundle-1.0.2.jar)&lt;/p&gt;

&lt;p&gt;After this, the factory configurations were not bound to the bundle any longer, because they were still bound to the no longer existing bundle location jcrinstall:/apps/sample/install/bundle-1.0.0.jar. This basically leaves stale configurations and a badly configured system.&lt;/p&gt;

&lt;p&gt;While Sling&apos;s OSGi Installer handles updates without changing the bundle location normally, the above scenario differs in that instead of an update, there is an uninstall + re-install happening. The Configuration Admin Service Specification 1.3 clearly states (in 104.4.1 Location Binding): &quot;When this dynamically bound bundle is subsequently uninstalled, the Configuration object&apos;s bundle location must be set to null again so it can be bound again later.&quot;&lt;/p&gt;

&lt;p&gt;Note: in the patch I also changed the return type of ConfigurationImpl#tryBindLocation() from boolean to void. Before, it always returned true, so the return value is meaningless. I almost ended up using it in an if statement because of the return type, which made me believe that it returns true if the bundle location is set and false otherwise.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12543509">FELIX-3360</key>
            <summary>Bundle location is statically set for dynamically bound bundles</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fmeschbe">Felix Meschberger</assignee>
                                    <reporter username="jsedding">Julian Sedding</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Feb 2012 16:07:08 +0000</created>
                <updated>Fri, 5 Sep 2014 14:30:01 +0000</updated>
                            <resolved>Wed, 14 Aug 2013 06:50:57 +0000</resolved>
                                    <version> configadmin-1.2.8</version>
                                    <fixVersion>configadmin-1.8.0</fixVersion>
                                    <component>Configuration Admin</component>
                    <component>Specification compliance</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13212693" author="jsedding" created="Tue, 21 Feb 2012 16:08:09 +0000"  >&lt;p&gt;proposed patch&lt;/p&gt;</comment>
                            <comment id="13212730" author="fmeschbe" created="Tue, 21 Feb 2012 16:52:17 +0000"  >&lt;p&gt;Sorry, I have to decline this request because it would violate the spec.&lt;/p&gt;

&lt;p&gt;The spec states that a configuration retrieved with the single argument getConfiguration(String pid) method must be statically bound to the calling bundle. So everything works correctly.&lt;/p&gt;

&lt;p&gt;In fact your use case of uninstalling and re-installing a bundle to update it is not sensitive: You should really update the existing bundle. Not only will you keep the configuration properly bound but also will you not loose any potential bundle-private data (accessed through BundleContext.getDataFile(String)).&lt;/p&gt;

&lt;p&gt;With Configuration Admin spec 1.4 new definitions of the bundle location exist and the Apache Felix SCR bundle (I assume you refer to that when you talk of the getConfiguration(String pid) method) will be updated to actually use an explicit bundle location of &quot;?*&quot; when accessing configuration to prevent this kind of binding of unbound configuration.&lt;/p&gt;</comment>
                            <comment id="13213502" author="jsedding" created="Wed, 22 Feb 2012 10:03:03 +0000"  >&lt;p&gt;&amp;gt; The spec states that a configuration retrieved with the single argument getConfiguration(String pid)&lt;br/&gt;
&amp;gt; method must be statically bound to the calling bundle. So everything works correctly. &lt;/p&gt;

&lt;p&gt;My understanding is that the bundle location is indeed bound statically when a call to getConfiguration(String pid) &lt;b&gt;creates&lt;/b&gt; the configuration. If the configuration &lt;b&gt;already exists&lt;/b&gt; and is not yet bound (i.e. bundle location is null), it is then dynamically bound to the calling bundle, and unbound when this bundle gets uninstalled.&lt;/p&gt;

&lt;p&gt;If you don&apos;t agree, I would be grateful, if you could point me to the relevant section(s) in the spec. The rest of the argument is based on the assumption that the above understanding is correct.&lt;/p&gt;

&lt;p&gt;The scenario I observed while debugging the issue is, of course, a little more complex:&lt;br/&gt;
1. Sling&apos;s OSGi Installer (it&apos;s what the spec refers to as &quot;management bundle&quot;) creates the configuration (IMO correctly) using getConfiguration(String pid, null). &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;&lt;br/&gt;
2. Somewhere (I didn&apos;t observe where exactly) an event of type ConfigurationEvent.CM_UPDATED is fired.&lt;br/&gt;
3.The Event is handled o.a.f.scr.impl.config.ConfigurationComponentRegistry#configurationEvent, which calls #getConfiguration and finally ConfigurationAdmin#getConfiguration(String pid).&lt;/p&gt;

&lt;p&gt;In the issue description I was referring to the single argument call to getConfiguration in step three. I.e. a previously unbound Configuration object gets bound dynamically to the bundle, which retrieves the existing Configuration. In this case, I expect the Configuration to get unbound, when the bundle is uninstalled. See also &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;The changes in the patch reflect this scenario. A new Configuration object, created via one of the single argument methods, should have its staticBundleLocation field already set upon construction. So the point where the dynamicBundleLocation gets set can never be reached (it is guarded by a null check for bundle location).&lt;/p&gt;

&lt;p&gt;OSGi Enterprise Spec Release 4, Version 4.2, Configuration Admin Service Spec Version 1.3:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; 104.4.1 Location Binding: &quot;These methods &lt;span class=&quot;error&quot;&gt;&amp;#91;the two argument versions of getConfiguration and createFactoryConfiguration&amp;#93;&lt;/span&gt; are intended for management bundles.&quot;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; 104.4.1 Location Binding: &quot;A null location parameter may be used to create Configuration objects that are not bound. In this case, the objects become bound to a specific location the first time that they are used by a bundle. When this dynamically bound bundle is subsequently uninstalled, the Configuration object&#8217;s bundle location must be set to null again so it can be bound again later.&quot;&lt;/p&gt;</comment>
                            <comment id="13435062" author="fmeschbe" created="Wed, 15 Aug 2012 13:04:51 +0000"  >&lt;p&gt;Reading over this issue again, I would think, that this is rather a problem of the Declarative Services implementation, which does not let go of configurations it assigns to bundles.&lt;/p&gt;

&lt;p&gt;If you agree, I would reassign to the DS component as follows: Fix DS to make sure configurations are &quot;unassigned from bundles&quot; upon bundle uninstallation.&lt;/p&gt;</comment>
                            <comment id="13737158" author="djencks" created="Mon, 12 Aug 2013 18:21:15 +0000"  >&lt;p&gt;I am quite sure this is a CA problem not a DS problem.  I think Julian&apos;s patch looks like an improvement over the current code &amp;#8211; setting the config&apos;s bundle location by calling getConfiguration should be dynamic not static.  I don&apos;t know if Julian&apos;s patch is a complete solution.&lt;/p&gt;</comment>
                            <comment id="13737934" author="fmeschbe" created="Tue, 13 Aug 2013 07:07:32 +0000"  >&lt;p&gt;This issue was discussed again on the OSGi Developer&apos;s list. The consensus seems to be that implicit bindings are dynamic and explicit bindings are static:&lt;/p&gt;

&lt;p&gt;(a) dynamic/implicit&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;getConfiguration(pid) &amp;#8211; configuration either created or location was null previously&lt;/li&gt;
	&lt;li&gt;createFactoryConfiguration(pid) &amp;#8211; configuration is created&lt;/li&gt;
	&lt;li&gt;Configuration supplied to ManagedService&lt;span class=&quot;error&quot;&gt;&amp;#91;Factory&amp;#93;&lt;/span&gt; &amp;#8211; if location was null previsouly&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(b) static/explicit&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;getConfiguration(pid, location) &amp;#8211; location is not null and configuration is created or location of existing configuration was null before&lt;/li&gt;
	&lt;li&gt;createConfiguration(pid, location) &amp;#8211; where location is not null&lt;/li&gt;
	&lt;li&gt;Configuration.setBundleLocation(location) &amp;#8211; where location is not null&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Configuration.setBundleLocation(null) always removes any configuration binding, regardless of whether it is static or dynamic.&lt;/p&gt;</comment>
                            <comment id="13738010" author="jsedding" created="Tue, 13 Aug 2013 09:14:59 +0000"  >&lt;blockquote&gt;
&lt;p&gt; I don&apos;t know if Julian&apos;s patch is a complete solution. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think I agree that it&apos;s incomplete. I have experimented with integration tests, but could not reliably reproduce the issue (yet). In the scenario I described DS definitely also has its part, so I looked at whether DS uses ConfigurationAdmin#getConfiguration(String pid). And indeed it has one usage in the method org.apache.felix.scr.impl.config.ConfigurationSupport#getConfiguration(ConfigurationAdmin ca, String pid), which itself is called from a handful of other places.&lt;/p&gt;

&lt;p&gt;Is it correct for DS to use the single argument signature ConfigurationAdmin#getConfiguration(String pid) or should it, as a management bundle, rather use ConfigurationAdmin#getConfiguration(String pid, String location) with a null location?&lt;/p&gt;

&lt;p&gt;In any case, I think there is room for improvement regarding test coverage of ConfigurationAdmin#getConfiguration(String pid).&lt;/p&gt;
</comment>
                            <comment id="13738135" author="fmeschbe" created="Tue, 13 Aug 2013 12:29:40 +0000"  >&lt;p&gt;DS is not a management bundle and it should get the configuration using the ConfigurationAdmin service retrieved through the componet&apos;s bundle. So getConfiguration(pid) is correct and would create a dynamic location binding.&lt;/p&gt;

&lt;p&gt;Julian&apos;s patch is close to complete (configurationFactory support is missing). I am working on a complete solution including tests.&lt;/p&gt;

&lt;p&gt;As for current tests: There are no tests in the Configuration Admin no in the OSGi CT which cover these cases. I will add such tests to the OSGi CT.&lt;/p&gt;

&lt;p&gt;BTW: The OSGi-dev list discussion is at &lt;a href=&quot;http://www.mail-archive.com/osgi-dev@mail.osgi.org/msg02873.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/osgi-dev@mail.osgi.org/msg02873.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13738347" author="fmeschbe" created="Tue, 13 Aug 2013 15:20:50 +0000"  >&lt;p&gt;Proposed updated patch considering also factory configurations.&lt;/p&gt;</comment>
                            <comment id="13739300" author="fmeschbe" created="Wed, 14 Aug 2013 06:50:57 +0000"  >&lt;p&gt;I have applied my patch along with an integration test intended to validate dynamic binding semantics in Rev. 1513740:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;getConfiguration(pid) binds dynamically&lt;/li&gt;
	&lt;li&gt;createConfiguration(pid) binds dynamically&lt;/li&gt;
	&lt;li&gt;add integration tests to validate removal of dynamic bindings&lt;/li&gt;
	&lt;li&gt;make sure dynamic binding is cleared if static binding is set&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13739441" author="jsedding" created="Wed, 14 Aug 2013 09:16:40 +0000"  >&lt;p&gt;Thanks for the fix, Felix. Thinking of &quot;implicitly&quot; binding a configuration rather than &quot;dynamically&quot; binding it makes sense to me and makes it easier to understand the spec/contract.&lt;/p&gt;</comment>
                            <comment id="13780867" author="fmeschbe" created="Sat, 28 Sep 2013 15:26:59 +0000"  >&lt;p&gt;Close after release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12739135">KARAF-3204</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12560636">SLING-2510</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12597737" name="FELIX-3360.patch" size="3611" author="fmeschbe" created="Tue, 13 Aug 2013 15:20:50 +0000"/>
                            <attachment id="12515375" name="FELIX-3360.patch" size="2216" author="jsedding" created="Tue, 21 Feb 2012 16:18:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>228755</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1avdz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>271551</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>