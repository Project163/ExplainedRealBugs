<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:59:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5032] IndexOutOfBoundsException in SCR ComponentTestBase class</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5032</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;In the SCR integration tests, there is an issue in the ComponentTestBase.Log.run() method: &lt;/p&gt;

&lt;p&gt;When a warn message is logged, and if the current test includes a part of the warn message in the &quot;ignoredWarnings&quot; attributes, then the Log.run() method may get an ArrayIndexOutOfBound exception, and the message is not logged. &lt;/p&gt;

&lt;p&gt;Moreover, this exception kills the thread that is internally used by the ComponentTestBase.Log, so any further log won&apos;t be displayed at all.&lt;/p&gt;

&lt;p&gt;Here is where the bug is located (see ComponentTestBase.Log inner class, line 919):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; ...
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run()
        {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
            {
                LogEntry entry = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; ( &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; )
                {
                    entry = m_logQueue.take();
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( entry.getLevel() &amp;lt;= 2 )
                    {
                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( m_warnings.size() &amp;lt; 1024 &amp;amp;&amp;amp; acceptWarning( entry.getMessage() ) )
                        {
                            m_warnings.add( entry.getMessage() );
                        }
                        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
                        {
                            &lt;span class=&quot;code-comment&quot;&gt;// Avoid out of memory ...
&lt;/span&gt;                            m_warnings.set( 1023, &lt;span class=&quot;code-quote&quot;&gt;&quot;Unexpected errors logged. Please look at previous logs&quot;&lt;/span&gt; );
                        }
                    }
   ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here, if the test generates a warn log that can be ignored (the acceptWarning method will return false), then the m_warnings list is immediately set to 1023, and if the current size of the list is lower than 1024 (which is the case at the begining), then the logging thread will get an ArrayIndexOutOfMemory exception.&lt;/p&gt;

&lt;p&gt;(This exception was never noticed because the stdout/stderr logs are disabled.)&lt;/p&gt;

&lt;p&gt;I have attached a simple patch that corrects the problem.&lt;br/&gt;
The patch also does two new thing:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;By default, the DS_LOGLEVEL is set to &quot;warn&quot; in order to reduce output when we want to simply run all the tests before doing a release and check if eveything is ok.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;when a warn message is not accepted (is actually expected by the test), then it is not logged when DS_LOGLEVEL is set to &quot;warn&quot;. However, of course the expected warn message is logged when running with DS_LOGLEVEL=&quot;debug&quot;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Here is the patch (also attached to this issue)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( entry.getLevel() &amp;lt;= 2 )
                    {
                    	&lt;span class=&quot;code-comment&quot;&gt;// If the test does not accept &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; warning, it means &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; warning is expected by the test.
&lt;/span&gt;                    	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (acceptWarning( entry.getMessage())) {
                    		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( m_warnings.size() &amp;lt; 1024 )
                    		{
                        		&lt;span class=&quot;code-comment&quot;&gt;// Store &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; warning so any test can check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; some warnings have been generated.
&lt;/span&gt;                    			m_warnings.add( entry.getMessage() );
                    		}
                    		&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
                    		{
                    			&lt;span class=&quot;code-comment&quot;&gt;// Avoid out of memory ...
&lt;/span&gt;                    			m_warnings.set( 1023, &lt;span class=&quot;code-quote&quot;&gt;&quot;Unexpected errors logged. Please look at previous logs&quot;&lt;/span&gt; );
                    		}
                    	} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                    		&lt;span class=&quot;code-comment&quot;&gt;// The current test explicitly said that &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; warning is not accepted and is expected.
&lt;/span&gt;                    		&lt;span class=&quot;code-comment&quot;&gt;// So, unless we are in full debug, don&apos;t display &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; expected warning message.
&lt;/span&gt;                    		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (! DS_LOGLEVEL.equals(&lt;span class=&quot;code-quote&quot;&gt;&quot;debug&quot;&lt;/span&gt;)) {
                    			&lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
                    		}
                    	}
                    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="12863624">FELIX-5032</key>
            <summary>IndexOutOfBoundsException in SCR ComponentTestBase class</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="djencks">David Jencks</assignee>
                                    <reporter username="pderop">Pierre De Rop</reporter>
                        <labels>
                    </labels>
                <created>Sat, 12 Sep 2015 15:24:41 +0000</created>
                <updated>Fri, 8 Jul 2016 08:05:15 +0000</updated>
                            <resolved>Tue, 20 Oct 2015 02:14:38 +0000</resolved>
                                    <version>scr-2.0.0</version>
                                    <fixVersion>scr-2.0.4</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14742090" author="pderop" created="Sat, 12 Sep 2015 15:25:49 +0000"  >&lt;p&gt;Attached the proposed patch.&lt;/p&gt;</comment>
                            <comment id="14964396" author="djencks" created="Tue, 20 Oct 2015 02:14:38 +0000"  >&lt;p&gt;r1709501&lt;br/&gt;
I&apos;d like to see all the log output even if it&apos;s expected, so I applied a simpler change.  I also had a test failure that I think was due to an expected warn log entry that had been concealed by the bug, did all the tests pass for you with your patch?&lt;/p&gt;</comment>
                            <comment id="14966542" author="pderop" created="Wed, 21 Oct 2015 09:39:49 +0000"  >&lt;p&gt;IIRC, I think that the test failure that was hidden by the bug was ComponentConcurrencyTest and I added the following warning message in order to make it pass OK:&lt;/p&gt;

&lt;p&gt;&quot;DependencyManager : invokeBindMethod : Service not available from service registry for ServiceReference&quot;&lt;/p&gt;

&lt;p&gt;(and I saw that you also added it your recent commit).&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12755561" name="FELIX-5032.patch" size="2408" author="pderop" created="Sat, 12 Sep 2015 15:25:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2k3c7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>