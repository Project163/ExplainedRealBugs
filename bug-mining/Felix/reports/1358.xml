<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:31:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-3055] Event Admin deadlocks when sendEvent is called from within a handleEvent method</title>
                <link>https://issues.apache.org/jira/browse/FELIX-3055</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;The Felix Event Admin service doesn&apos;t correctly handle the case where EventAdmin.sendEvent(Event) is called from within an EventHandler.handleEvent(Event) implementation.  This happens whether the original event (the one being handled by the EventHandler, not the one it is dispatching) was dispatched using EventAdmin.sendEvent(Event) or EventAdmin.postEvent(Event).&lt;/p&gt;

&lt;p&gt;I have attached some sample code which should make this easy to reproduce.  Every time you invoke the &quot;dispatch foo&quot; command from the GoGo shell, it will post a &quot;foo&quot; event.  The handler for this event then attempts to send a new &quot;bar&quot; event.  Every time this happens, a thread in the event admin pool will become deadlocked.  If you run the dispatch command more times than the minimum number of threads in the pool (I think 20, by default), they will all be deadlocked and the event admin service will stop invoking event handlers (it seemed strange to me that this happens when you hit the minimum number of thread in the pool rather than the maximum, but I haven&apos;t had time to investigate that).&lt;/p&gt;

&lt;p&gt;Also attached is a thread dump from when all 20 threads have become deadlocked.  Note that they are all stuck on line 240 of SyncDeliverTasks.java waiting on a rendezvous with the timer barrier (line numbers refer to the current revision on trunk, r1074155).  I suspect that this is because the attempt to rendezvous on line 266 is met by the attempt on line 208 in the case where the event handler recursively calls sendEvent, leaving line 240 with no corresponding call to meet.&lt;/p&gt;</description>
                <environment>Win2K8 R2, Java 1.6.0_17</environment>
        <key id="12515437">FELIX-3055</key>
            <summary>Event Admin deadlocks when sendEvent is called from within a handleEvent method</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cziegeler">Carsten Ziegeler</assignee>
                                    <reporter username="mbanner">Matt Banner</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Jul 2011 18:16:00 +0000</created>
                <updated>Sat, 1 Aug 2015 11:33:27 +0000</updated>
                            <resolved>Thu, 28 Jul 2011 08:13:37 +0000</resolved>
                                    <version>eventadmin-1.2.12</version>
                                    <fixVersion>eventadmin-1.2.14</fixVersion>
                                    <component>Event Admin</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13071254" author="mbanner" created="Tue, 26 Jul 2011 18:17:59 +0000"  >&lt;p&gt;Class to help with reproducing issue.&lt;/p&gt;</comment>
                            <comment id="13071255" author="mbanner" created="Tue, 26 Jul 2011 18:18:35 +0000"  >&lt;p&gt;Attaching thread dump.&lt;/p&gt;</comment>
                            <comment id="13071849" author="cziegeler" created="Wed, 27 Jul 2011 16:46:08 +0000"  >&lt;p&gt;I can&apos;t reproduce this right now, and the implementation passes the tck which tests this as well. I even wrote a massive test for this send 2000 events where each uses your pattern from your test - so maybe there is a difference in the environment we&apos;re using?&lt;br/&gt;
What os / java version are you using?&lt;/p&gt;</comment>
                            <comment id="13071925" author="mbanner" created="Wed, 27 Jul 2011 19:11:01 +0000"  >&lt;p&gt;Sorry, I didn&apos;t think about this being platform dependent.  I am seeing the issue on Win2k8 R2 with Java 1.6.0_17 and on Windows XP with Java 1.6.0_16, but NOT on RHEL 4 with Java 1.6.0_17.&lt;/p&gt;</comment>
                            <comment id="13072001" author="cziegeler" created="Wed, 27 Jul 2011 20:54:22 +0000"  >&lt;p&gt;Yeah, actually, it&apos;s me to say sorry...I was too dumb to correctly test...my event handler was configured to be ignored for timeout handling....running a correct test reveals the exact same problem as you describe &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
I&apos;ll have a look&lt;/p&gt;</comment>
                            <comment id="13072243" author="cziegeler" created="Thu, 28 Jul 2011 08:13:37 +0000"  >&lt;p&gt;Many thanks for reporting this, Matt!&lt;/p&gt;

&lt;p&gt;Actually we had two problems: one of the this deadlock, but after fixing this I ran into starvation problems if more threads than the pool offers send cascading events. While the whole pool is processing the &quot;outer&quot; events, inner event sending is blocked as the pool has no free thread.&lt;/p&gt;

&lt;p&gt;I&apos;ve fixed both in revision 1151755 and ran some new tests on this version including&lt;br/&gt;
the tck. I couldn&apos;t detect any problems.&lt;/p&gt;

&lt;p&gt;Would be great, Matt, if you could run your tests as well to verify.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13072393" author="mbanner" created="Thu, 28 Jul 2011 15:04:49 +0000"  >&lt;p&gt;Everything looks good to me.  I tried my original test code as well as a new test that recursively calls sendEvent() a greater number of times than there are threads in the pool (to check for the starvation issue), and I also tried it out in our actual application as a sanity check.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12487874" name="TestClass.java" size="2399" author="mbanner" created="Tue, 26 Jul 2011 18:17:59 +0000"/>
                            <attachment id="12487875" name="threaddump.txt" size="29591" author="mbanner" created="Tue, 26 Jul 2011 18:18:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40373</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 17 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0b3n3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>62702</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>