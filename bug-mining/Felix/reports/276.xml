<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:07:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-765] Invalid occasional OSGi filter toString() value</title>
                <link>https://issues.apache.org/jira/browse/FELIX-765</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;Rather frequently, under the right conditions, FilterImpl.toString() will generate an invalid filter string.  In my case, this happens when Spring DM loads two bundles on two different threads simultaneously when processing a number of OSGi service imports.  The actual stracktrace isn&apos;t very useful since what Spring DM does internally is get a filter&apos;s string, pass that around a bit, then try to give that to Felix, which causes an exception.  I narrowed the problem down to the toString() method:&lt;/p&gt;

&lt;p&gt;java.lang.RuntimeException: Invalid filter string&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&amp;amp;some49(&amp;amp;(bean-name=some49)(plugins-host=true)))&lt;br/&gt;
	at org.apache.felix.framework.FilterImpl.checkFilter(FilterImpl.java:330)&lt;br/&gt;
	at org.apache.felix.framework.FilterImpl.toString(FilterImpl.java:244)&lt;br/&gt;
	at java.lang.String.valueOf(String.java:2615)&lt;br/&gt;
	at java.lang.StringBuffer.append(StringBuffer.java:220)&lt;br/&gt;
	at org.springframework.osgi.service.importer.DefaultOsgiServiceDependency.&amp;lt;init&amp;gt;(DefaultOsgiServiceDependency.java:53)&lt;br/&gt;
	at org.springframework.osgi.extender.internal.dependencies.startup.MandatoryImporterDependencyFactory.getServiceDependencies(MandatoryImporterDependencyFactory.java:69)&lt;br/&gt;
	at org.springframework.osgi.extender.internal.dependencies.startup.DependencyServiceManager.findServiceDependencies(DependencyServiceManager.java:233)&lt;br/&gt;
	at org.springframework.osgi.extender.internal.dependencies.startup.DependencyWaiterApplicationContextExecutor.stageOne(DependencyWaiterApplicationContextExecutor.java:253)&lt;br/&gt;
	at org.springframework.osgi.extender.internal.dependencies.startup.DependencyWaiterApplicationContextExecutor.refresh(DependencyWaiterApplicationContextExecutor.java:173)&lt;br/&gt;
	at org.springframework.osgi.context.support.AbstractDelegatedExecutionApplicationContext.refresh(AbstractDelegatedExecutionApplicationContext.java:136)&lt;br/&gt;
	at org.springframework.osgi.extender.internal.activator.ContextLoaderListener$2.run(ContextLoaderListener.java:741)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:613)&lt;/p&gt;

&lt;p&gt;This checkFilter() method simply looks for invalid strings where the &apos;&amp;amp;&apos; character isn&apos;t followed by a &apos;(&apos; character:&lt;/p&gt;

&lt;p&gt;public static void checkFilter(String filter)&lt;br/&gt;
    {&lt;br/&gt;
        if (filter != null)&lt;br/&gt;
        {&lt;br/&gt;
            boolean andFound = false;&lt;br/&gt;
            for (int x=0; x&amp;lt;filter.length(); x++)&lt;br/&gt;
            {&lt;br/&gt;
                char c = filter.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;br/&gt;
                if (c == &apos;&amp;amp;&apos;) &lt;/p&gt;
{
                    andFound = true;
                }
&lt;p&gt; else if (andFound &amp;amp;&amp;amp; c != &apos;(&apos;) &lt;/p&gt;
{
                    throw new RuntimeException(&quot;Invalid filter string:&quot;+filter);
                }
&lt;p&gt; else&lt;br/&gt;
                    andFound = false;&lt;br/&gt;
            }&lt;br/&gt;
        }&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;Deeper in the code, I put this check in Parser to find out when this invalid filter String was being created (line 594):&lt;/p&gt;

&lt;p&gt;                for (int x=0; x&amp;lt;tmp.length; x++) {&lt;br/&gt;
                    if (tmp&lt;span class=&quot;error&quot;&gt;&amp;#91;x&amp;#93;&lt;/span&gt; instanceof ConstOperator) &lt;/p&gt;
{
                        System.out.println(&quot;Invalid tree constructed:&quot;+tmp[x]);
                    }
&lt;p&gt;                }&lt;/p&gt;

&lt;p&gt;This detected when the const operator was incorrectly listed as a child of the AND operator, but I also saw the PUSH operator a direct child as well.  &lt;/p&gt;

&lt;p&gt;Therefore, this issue seems related to &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-721&quot; title=&quot;NPE in FilterImpl.toString()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-721&quot;&gt;&lt;del&gt;FELIX-721&lt;/del&gt;&lt;/a&gt;, although I was unable to find a direct fix.  For now, I&apos;m commenting out the program cache in FilterImpl line 64, which fixes the issue and has a negligible impact on performance from my testing.  Since we are seeing this exception between 10% and 80% of the time, a slower Felix is preferable to a frequently broken startup.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12406367">FELIX-765</key>
            <summary>Invalid occasional OSGi filter toString() value</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="4">Incomplete</resolution>
                                        <assignee username="karlpauls">Karl Pauls</assignee>
                                    <reporter username="mrdon">Donald J. Brown</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Oct 2008 08:09:52 +0000</created>
                <updated>Wed, 26 Aug 2009 13:38:11 +0000</updated>
                            <resolved>Fri, 31 Oct 2008 20:02:07 +0000</resolved>
                                    <version>framework-1.2.2</version>
                                    <fixVersion>framework-1.4.0</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12639379" author="karlpauls" created="Tue, 14 Oct 2008 11:09:43 +0000"  >&lt;p&gt;Don,&lt;/p&gt;

&lt;p&gt;I&apos;m sorry that you have so many issues with our ldap filter. It&apos;s great so, that we seem to get some of the bugs figured out. Can you please see whether the attached patch makes a difference? It&apos;s just a guess but it might be the answer already. If not then I will have to try to reproduce the error first...&lt;/p&gt;</comment>
                            <comment id="12639402" author="mrdon" created="Tue, 14 Oct 2008 12:15:01 +0000"  >&lt;p&gt;I tried making the counter final in the and operator with no effect, but I&apos;ll try the others, and let you know.  I might be able to give you the tests that I use to replicate the issue...I&apos;ll look into it tomorrow.&lt;/p&gt;</comment>
                            <comment id="12640113" author="karlpauls" created="Thu, 16 Oct 2008 09:10:10 +0000"  >&lt;p&gt;Any news on this one? If that didn&apos;t fix it then did you find out whether you can give me the tests?&lt;/p&gt;</comment>
                            <comment id="12644416" author="karlpauls" created="Fri, 31 Oct 2008 20:02:07 +0000"  >&lt;p&gt;I commited the patch as is since I didn&apos;t got any feedback. Please test it and close this issue if it fixes your problem or reopen it if not, respectively.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12392084" name="ldap.patch" size="1654" author="karlpauls" created="Tue, 14 Oct 2008 11:09:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>58224</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 4 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1apxz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>270669</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>