<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:06:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5443] Frequent Changes cause UpdateThread to ConcurrentModificationException</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5443</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;2016-11-30T10:20:15.614+0000 | ERROR | 836-1bc8-4066-963b-9b9cbccbd9d0) | configadmin | org.apache.felix.configadmin - 1.8.8 | Unexpected problem executing task java.util.ConcurrentModificationException at java.util.HashMap$HashIterator.nextNode(HashMap.java:1437)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.8.0_101&amp;#93;&lt;/span&gt; at java.util.HashMap$KeyIterator.next(HashMap.java:1461)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.8.0_101&amp;#93;&lt;/span&gt; at java.util.AbstractCollection.toArray(AbstractCollection.java:196)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.8.0_101&amp;#93;&lt;/span&gt; at org.apache.felix.cm.impl.Factory.store(Factory.java:126)&lt;span class=&quot;error&quot;&gt;&amp;#91;4:org.apache.felix.configadmin:1.8.8&amp;#93;&lt;/span&gt; at org.apache.felix.cm.impl.ConfigurationManager$DeleteConfiguration.run(ConfigurationManager.java:1851)&lt;span class=&quot;error&quot;&gt;&amp;#91;4:org.apache.felix.configadmin:1.8.8&amp;#93;&lt;/span&gt; at org.apache.felix.cm.impl.UpdateThread.run0(UpdateThread.java:143)&lt;span class=&quot;error&quot;&gt;&amp;#91;4:org.apache.felix.configadmin:1.8.8&amp;#93;&lt;/span&gt; at org.apache.felix.cm.impl.UpdateThread.run(UpdateThread.java:110)&lt;span class=&quot;error&quot;&gt;&amp;#91;4:org.apache.felix.configadmin:1.8.8&amp;#93;&lt;/span&gt; at java.lang.Thread.run(Thread.java:745)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.8.0_101&amp;#93;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13026083">FELIX-5443</key>
            <summary>Frequent Changes cause UpdateThread to ConcurrentModificationException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cziegeler">Carsten Ziegeler</assignee>
                                    <reporter username="fabianlange">Fabian Lange</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 Dec 2016 18:50:14 +0000</created>
                <updated>Thu, 2 Feb 2017 10:07:47 +0000</updated>
                            <resolved>Thu, 29 Dec 2016 07:10:28 +0000</resolved>
                                    <version>configadmin-1.8.8</version>
                                    <fixVersion>configadmin-1.8.14</fixVersion>
                                    <component>Configuration Admin</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15726379" author="fabianlange" created="Tue, 6 Dec 2016 18:58:55 +0000"  >&lt;p&gt;The root cause here seems to be that multiple threads in parallel modify the same Factory (org.apache.felix.cm.impl.Factory) (in my case probably a concurrent create and delete of a config)&lt;br/&gt;
The Factory uses a non Threadsafe datastructure (hashSet)&lt;/p&gt;

&lt;p&gt;A probably good fix is to make that HashSet a concurrent data structure.&lt;/p&gt;</comment>
                            <comment id="15726417" author="fabianlange" created="Tue, 6 Dec 2016 19:18:01 +0000"  >&lt;p&gt;However not 100% sure, probably the access needs to be guarded on a higher level, but using Collections.newSetFromMap(new ConcurrentHashMap()); should reduce the chance of problems. more problems only could occur if the store calls get reordered, so an earlier store is called later.&lt;/p&gt;</comment>
                            <comment id="15728359" author="githubbot" created="Wed, 7 Dec 2016 10:13:16 +0000"  >&lt;p&gt;GitHub user CodingFabian opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/felix/pull/78&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/felix/pull/78&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5443&quot; title=&quot;Frequent Changes cause UpdateThread to ConcurrentModificationException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5443&quot;&gt;&lt;del&gt;FELIX-5443&lt;/del&gt;&lt;/a&gt; Synchronize access to factory when updating and storing associated pids.&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/CodingFabian/felix&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/CodingFabian/felix&lt;/a&gt; config-concurrent-modification&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/felix/pull/78.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/felix/pull/78.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #78&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 8fde2e86086c437dcf52f0e6a9f4ed340cc37b74&lt;br/&gt;
Author: Fabian Lange &amp;lt;lange.fabian@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-12-07T08:02:59Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5443&quot; title=&quot;Frequent Changes cause UpdateThread to ConcurrentModificationException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5443&quot;&gt;&lt;del&gt;FELIX-5443&lt;/del&gt;&lt;/a&gt; Synchronize access to factory when updating and storing associated pids.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15728607" author="fmeschbe" created="Wed, 7 Dec 2016 12:06:42 +0000"  >&lt;p&gt;Good catch. Current uses do not seem to trigger this much concurrency in this context ...&lt;/p&gt;

&lt;p&gt;How about replacing the internal set with an immutable variant:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: Factory.java
===================================================================
--- Factory.java	(Revision 1773058)
+++ Factory.java	(Arbeitskopie)
@@ -20,6 +20,7 @@
 
 
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.IOException;
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.Collections;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.Dictionary;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.HashSet;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.Hashtable;
@@ -41,7 +42,7 @@
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; FACTORY_PID_LIST = &lt;span class=&quot;code-quote&quot;&gt;&quot;factory.pidList&quot;&lt;/span&gt;;
 
     &lt;span class=&quot;code-comment&quot;&gt;// the set of configuration PIDs belonging to &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; factory
&lt;/span&gt;-    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Set pids = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet();;
+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Set pids;
 
 
     &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; exists( PersistenceManager persistenceManager, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; factoryPid )
@@ -67,6 +68,7 @@
     Factory( ConfigurationManager configurationManager, PersistenceManager persistenceManager, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; factoryPid )
     {
         &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;( configurationManager, persistenceManager, factoryPid );
+        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.pids = Collections.unmodifiableSet( Collections.emptySet() );
     }
 
 
@@ -77,6 +79,7 @@
 
         &lt;span class=&quot;code-comment&quot;&gt;// set pids
&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] pidList = ( &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] ) props.get( FACTORY_PID_LIST );
+        HashSet pids = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet();
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( pidList != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; )
         {
             &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ( &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; pidList.length; i++ )
@@ -84,6 +87,7 @@
                 pids.add( pidList[i] );
             }
         }
+        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.pids = Collections.unmodifiableSet( pids );
     }
 
 
@@ -101,19 +105,25 @@
 
     Set getPIDs()
     {
-        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet( pids );
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.pids;
     }
 
 
     &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; addPID( &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; pid )
     {
-        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; pids.add( pid );
+        HashSet pids = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet();
+        &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; added = pids.add( pid );
+        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.pids = Collections.unmodifiableSet( pids );
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; added;
     }
 
 
     &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; removePID( &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; pid )
     {
-        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; pids.remove( pid );
+        HashSet pids = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet();
+        &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; removed = pids.remove( pid );
+        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.pids = Collections.unmodifiableSet( pids );
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; removed;
     }
 
 
@@ -120,6 +130,7 @@
     void store() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
     {
         Hashtable props = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Hashtable();
+        Set pids = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.pids;
 
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( !pids.isEmpty() )
         {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This allows us to optimize the &lt;tt&gt;getPids()&lt;/tt&gt; method which is presumably called more often than &lt;tt&gt;addPid&lt;/tt&gt; and &lt;tt&gt;removePid&lt;/tt&gt; which become more expensive.&lt;/p&gt;</comment>
                            <comment id="15729247" author="fabianlange" created="Wed, 7 Dec 2016 16:53:55 +0000"  >&lt;p&gt;yes I considered that, the problem is that you could get out of order stores:&lt;/p&gt;

&lt;p&gt;addPid()&lt;br/&gt;
store()&lt;br/&gt;
removePid()&lt;br/&gt;
store()&lt;br/&gt;
addPid()&lt;br/&gt;
store()&lt;/p&gt;

&lt;p&gt;could be reordered to:&lt;/p&gt;

&lt;p&gt;addPid()&lt;br/&gt;
store()&lt;br/&gt;
removePid()&lt;br/&gt;
addPid()&lt;br/&gt;
store()&lt;br/&gt;
store()&lt;/p&gt;

&lt;p&gt;which might be invalid intermediate state.&lt;/p&gt;</comment>
                            <comment id="15767056" author="cziegeler" created="Wed, 21 Dec 2016 13:28:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fmeschbe&quot; class=&quot;user-hover&quot; rel=&quot;fmeschbe&quot;&gt;fmeschbe&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fabianlange&quot; class=&quot;user-hover&quot; rel=&quot;fabianlange&quot;&gt;fabianlange&lt;/a&gt; What about adding a locking based on the PID? We could lock on create,update,delete ensuring that only one task modifies a single configuration. Different configs can be modified in parallel&lt;/p&gt;</comment>
                            <comment id="15767169" author="fabianlange" created="Wed, 21 Dec 2016 14:23:08 +0000"  >&lt;p&gt;That would work &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt;, but would also increase the complexity.&lt;br/&gt;
ideally the factory would only perform safe atomic operations, so its users do not care about that, but as long as users call add()+store() or remove()+store() there can be update races, which my PR prevents.&lt;br/&gt;
Making the Map not throw a concurrent modification exception would only solve half of the problem.&lt;br/&gt;
therefor i still support my PR &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15769149" author="cziegeler" created="Thu, 22 Dec 2016 05:52:27 +0000"  >&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I&apos;m not sure if locking all PID is really increasing complexity. Looking at your patch, you do a locking on the factory (pid) which is basically the same as I suggest. The difference being that your patch does it only for factory configurations&lt;/p&gt;</comment>
                            <comment id="15784720" author="cziegeler" created="Thu, 29 Dec 2016 07:10:28 +0000"  >&lt;p&gt;Thanks for your patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fabianlange&quot; class=&quot;user-hover&quot; rel=&quot;fabianlange&quot;&gt;fabianlange&lt;/a&gt;. I applied it&lt;/p&gt;</comment>
                            <comment id="15785397" author="githubbot" created="Thu, 29 Dec 2016 14:16:45 +0000"  >&lt;p&gt;Github user CodingFabian closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/felix/pull/78&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/felix/pull/78&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 46 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i378wn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>