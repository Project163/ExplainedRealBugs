<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:08:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5507] ConfigurationAdmin might not be visible to SCR implementation</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5507</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;We have one case where the extended bundles do not see the configuration admin service. Interestingly the same application runs fine everywhere else, but just on a special environment (windows, ibm java inside Websphere) we have this problem reproducibly.&lt;br/&gt;
Using the system bundle context instead of the bundle context of the extended bundle in ConfigAdminTracker solves the problem.&lt;br/&gt;
Interestingly only the bundles started last (2 out of probably 80) see the configuration admin.&lt;br/&gt;
It could also be that a faulty service hook is involved, although I&apos;m not yet aware of such a hook&lt;/p&gt;

&lt;p&gt;Update: after some discussion, some issues in the framework have been identified, but also the SCR implementation is not 100% correct: as it is using the bundle context of the extended bundle, it might get a configuration admin which interface is not visible to SCR. Therefore it should revert to reflection to access the configuration admin.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13036564">FELIX-5507</key>
            <summary>ConfigurationAdmin might not be visible to SCR implementation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cziegeler">Carsten Ziegeler</assignee>
                                    <reporter username="cziegeler">Carsten Ziegeler</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 Jan 2017 13:43:36 +0000</created>
                <updated>Mon, 30 Apr 2018 08:13:48 +0000</updated>
                            <resolved>Fri, 17 Feb 2017 08:04:50 +0000</resolved>
                                    <version>scr-2.0.8</version>
                                    <fixVersion>scr-2.1.0</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15832233" author="djencks" created="Fri, 20 Jan 2017 18:41:03 +0000"  >&lt;p&gt;what?  Why can the system bundle context find any config admins at all?  The purpose of the ConfigAdminTracker is to find the particular config admin implementation visible to the extended bundle; for instance in IBM Websphere Liberty the &quot;main&quot; config admin instance is not visible to subsystems, so an isolated subsystem will have to include it&apos;s own config admin implementation in order to have configuration.  If you are using non-Liberty Websphere you may be running into the non-spec composite bundle way of doing isolation.&lt;/p&gt;</comment>
                            <comment id="15832889" author="cziegeler" created="Sat, 21 Jan 2017 08:40:14 +0000"  >&lt;p&gt;Afaik we&apos;re not doing any isolation at all and we&apos;re using non-Liberty Websphere. But the framework is running within a webapp and should be completely isolated from the container. So we have a single bundle space with a single config admin service. As said in all other scenarios this is working fine, just this single setup does not work.&lt;br/&gt;
And interestingly restarting the config admin bundle resolves the problem and the service gets visible.&lt;br/&gt;
I&apos;m not entirely sure whether this is really a DS problem and switching to the system bundle as a workaround indicates to me that this has something to do with service hooks, but so far I couldn&apos;t find any.&lt;/p&gt;</comment>
                            <comment id="15832894" author="djencks" created="Sat, 21 Jan 2017 09:03:34 +0000"  >&lt;p&gt;what class loader does the ca interface come from?&lt;/p&gt;</comment>
                            <comment id="15832899" author="cziegeler" created="Sat, 21 Jan 2017 09:14:27 +0000"  >&lt;p&gt;from the Felix CA bundle&lt;/p&gt;</comment>
                            <comment id="15838439" author="cziegeler" created="Wed, 25 Jan 2017 19:45:45 +0000"  >&lt;p&gt;I did some further investigation, the CA api package is only exported by the Apache Felix implementation, only a single CA service is registered.&lt;br/&gt;
The extended bundle have no import of the CA api package as they are not using it directly.&lt;br/&gt;
As mentioned above, using the system bundle solves the problem, using the SCR bundle to track the configuration admin solves the problem as well.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure if the current handling RegionConfigurationSupport is really the way to go. It assumes, that there is a single SCR implementation, but different CA services per region. However it is also assumed that the CA api package is shared across the regions. Wouldn&apos;t it be easier to remove this stuff and assume that there is a local SCR service, next to the local CM service?&lt;br/&gt;
So it&apos;s either both are global or both are distributed across regions, but not a mixture which might fail due to the above problems anyway.&lt;/p&gt;</comment>
                            <comment id="15838480" author="djencks" created="Wed, 25 Jan 2017 20:03:07 +0000"  >&lt;p&gt;As of Sept 2016 IBM Websphere Liberty was using the single SCR/mutliple CA support, so removing it might result in some pushback.  As of that time I wasn&apos;t aware of any problems with it.&lt;/p&gt;

&lt;p&gt;You can run with local SCR services by setting the global extender property to false.&lt;/p&gt;

&lt;p&gt;I couldn&apos;t figure out any way to have isolated CA API.  It doesn&apos;t appear to be a problem (judging by Liberty) to share the API and not share the service implementation.&lt;/p&gt;

&lt;p&gt;Do you understand why your setup doesn&apos;t work?  I don&apos;t.  I suspect a bug outside SCR.&lt;/p&gt;</comment>
                            <comment id="15839003" author="cziegeler" created="Thu, 26 Jan 2017 01:46:46 +0000"  >&lt;p&gt;Unfortunately I have no clue what the problem is. I think it&apos;s definitely not CA because on that side everything looks fine. And now I tend to agree that it is not SCR either. At the moment I suspect something wired going on in the framework. Unfortunately I can&apos;t use a debugger in that environment, so it takes some time to get more info.&lt;/p&gt;

&lt;p&gt;Anyways, I would like to have a switch, like with the global extender, that if enabled switches to use the SCR bundle context to get configuration admin. It would be off by default&lt;/p&gt;</comment>
                            <comment id="15839294" author="djencks" created="Thu, 26 Jan 2017 05:50:12 +0000"  >&lt;p&gt;I&apos;d really prefer to find and fix the actual problem rather than introducing what is basically a bug into SCR. (in the situation where the RegionConfigurationSupport is needed, using the SCR bundle context will give the wrong result).&lt;/p&gt;

&lt;p&gt;I suspect with a little research and imagination you could find places to log in detail what is going on that will narrow down the problem quickly.&lt;/p&gt;</comment>
                            <comment id="15839427" author="fmeschbe" created="Thu, 26 Jan 2017 08:47:23 +0000"  >&lt;p&gt;I tend to agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djencks&quot; class=&quot;user-hover&quot; rel=&quot;djencks&quot;&gt;djencks&lt;/a&gt; here. IIRC the reason for using the extended bundle&apos;s context is to make sure the Configuration Admin service applies the correct permissions for the consuming bundle ! Using the system bundle completely breaks this assumption and I would even go as far as saying this is non-compliant behaviour.&lt;/p&gt;

&lt;p&gt;It really is important to find the real cause for the problem in this context.&lt;/p&gt;</comment>
                            <comment id="15839729" author="tjwatson" created="Thu, 26 Jan 2017 14:18:34 +0000"  >&lt;p&gt;I also agree with David and Felix.  The system bundle context is going to find all Config Admin services that are registered in the system.  If you are running on a system that isolates applications, like I suspect is happening on WebSphere then that may get you a CA instance that does not apply to your application.&lt;/p&gt;</comment>
                            <comment id="15839857" author="cziegeler" created="Thu, 26 Jan 2017 15:22:55 +0000"  >&lt;p&gt;I didn&apos;t say to use the system bundle, I wanted to use the SCR bundle to get the configuration admin.&lt;br/&gt;
Where in the spec is defined that the extended bundle must have permissions to use config admin if it is using DS and configurations? Is this really required?&lt;br/&gt;
So every extended bundle needs to have service permission to get CA and permission to read configuration? Do we check this?&lt;/p&gt;

&lt;p&gt;If you think about sub systems or any other isolation, we really have a strange setup now. SCR is using the system bundle to find all bundles to be extended. These could be in subsystems and it is then assuming that all of these bundles, regardless of where they are have visibility to the same CA api. It might be the most sensible setup, but it is definitely not the only one. For example, if I have a subsystem with some app bundles, no bundle in there might need CA directly, so my subsystem is not importing the CA api. Which means SCR will fail to extend these bundles. Is this what we want to do?&lt;/p&gt;

&lt;p&gt;And as said I&apos;m going to hunt the real cause - but that is independent of this discussion&lt;/p&gt;</comment>
                            <comment id="15839905" author="tjwatson" created="Thu, 26 Jan 2017 15:57:48 +0000"  >&lt;p&gt;But the SCR bundle context has the similar issue.  It may get access to a different CA than what is in the isolated region of the extendee bundle.  The reason the system bundle context works for tracking bundles to extend is because everything that the extendee consumes is being consumed from the POV (the bundle context) of the extendee bundle.  That should include consuming configurations from CA in my opinion.&lt;/p&gt;</comment>
                            <comment id="15839950" author="cziegeler" created="Thu, 26 Jan 2017 16:26:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjwatson&quot; class=&quot;user-hover&quot; rel=&quot;tjwatson&quot;&gt;tjwatson&lt;/a&gt; Yes, correct, the SCR bundle might have a similar issue - which proofs that we can&apos;t simply think that one solution fits all use cases.&lt;br/&gt;
I tend to agree that it makes sense to use a CA from the POV of the extendee bundle. however the simplest use case an app subsystem with a simple bundle and a simple DS service that is not importing the CA package will simply not work. I guess it would be fine to say, if that app wants to use configurations it requires an import of CA, however just looking at the bundle does not tell you that this import is required.&lt;br/&gt;
Or you have two app subsystems, each with their own configuration admin supporting and containing different CA versions, then the current SCR impl will break as well.&lt;br/&gt;
Looking at this, i guess my suggestion of the switch does not really make sense. It&apos;s maybe rather that the current code of using the extendee bundle context to get the CA is correct but it should then use reflection or any other trick as in fact that extendee bundle might be wired to a different CA package than SCR. Or at least we should catch the ClassCastException and provide a meaningful log message.&lt;/p&gt;</comment>
                            <comment id="15840447" author="tjwatson" created="Thu, 26 Jan 2017 20:58:35 +0000"  >&lt;p&gt;I agree, if the CM implementation visible to the extended bundle is not wired to the same cm service package as SCR then problems will happen if reflection is not being used.&lt;/p&gt;</comment>
                            <comment id="15845068" author="fmeschbe" created="Mon, 30 Jan 2017 11:15:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt; I am not sure it is explicitly stated that the CA seen by the extended bundle is to be used. But according to the principle of least surprise, that CA must be used. For example the configuration&apos;s bundle-location property is matched to the bundle location of the CA-calling bundle. If this is &lt;b&gt;not&lt;/b&gt; the extended bundle, this check might fail.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjwatson&quot; class=&quot;user-hover&quot; rel=&quot;tjwatson&quot;&gt;tjwatson&lt;/a&gt; I think it is counter-intuitive to expected an extended bundle to import Configuration Admin. After all DS is specified to provide the configuration as part of the activate method&apos;s parameters (either directly or in the ComponentContext). The DS spec says these properties must be extended with Configuration Admin configuration if available implying in my reading that the extended bundle does not need to import and directly access Configuration Admin.&lt;/p&gt;

&lt;p&gt;Last but not least, I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjwatson&quot; class=&quot;user-hover&quot; rel=&quot;tjwatson&quot;&gt;tjwatson&lt;/a&gt; that the most transparent solution indeed is to (a) use the extend bundle to retrieve the Configuration Admin service using &lt;tt&gt;BundleContext.getAllServiceReferences&lt;/tt&gt; and then reflection for &lt;tt&gt;listConfiguration&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15845168" author="cziegeler" created="Mon, 30 Jan 2017 13:13:54 +0000"  >&lt;p&gt;I think we should get clarification into the spec if possible - we have it in other specs, too, that it&apos;s explicetly stated that the extendee bundle is used to get a service. I agree that it makes sense to do so, but without that being stated in the spec, implementations can behave differently. Of course if there is only a single bundle space with a single configuration admin, it doesn&apos;t make a difference anyways.&lt;br/&gt;
Reflection for using listConfiguration is not that difficult, but SCR also registers a configuration listener, and creating that might be a little bit more tricky - but doable I guess. I personally would not go that far and make it work in all these cases but rather catch the situation and log&lt;/p&gt;</comment>
                            <comment id="15845286" author="cziegeler" created="Mon, 30 Jan 2017 14:52:37 +0000"  >&lt;p&gt;Reading the spec resovled the first question, section 112.7 : &quot;SCR must obtain the Configuration objects from the Configuration Admin service using the Bundle&lt;br/&gt;
Context of the bundle containing the component.&quot;&lt;br/&gt;
So we don&apos;t need a clarification on this one, just need to figure out how far we go in our implementation&lt;/p&gt;</comment>
                            <comment id="15846486" author="cziegeler" created="Tue, 31 Jan 2017 07:22:59 +0000"  >&lt;p&gt;&lt;br/&gt;
I could debug it down into the framework behaving differently. The method ServiceReferenceImpl#isAssignableTo is running into case 1, usually returns &quot;true&quot; from there. But in the case where it&apos;s not working it&apos;s returning false. Continue investigation and moving issue to a framework issue&lt;/p&gt;</comment>
                            <comment id="15846553" author="cziegeler" created="Tue, 31 Jan 2017 08:59:39 +0000"  >&lt;p&gt;Case 1 means: Neither the requester, nor provider have wires for the package.&lt;br/&gt;
If it works, the code &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Class requestClass =
                            ((BundleWiringImpl) requesterRevision.getWiring())
                            .getClassByDelegation(className);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;throws an Exception and the access is allowed.&lt;br/&gt;
Running in WebSphere, the first time, that above code succeeds and gets into getRegistration().isClassAccessible(requestClass).&lt;br/&gt;
This runs through until the end of the method were it compares Util.loadClassUsingClass with the class loaded earlier on.&lt;br/&gt;
The result from Util.loadClassUsingClass is correct, it returns the class loaded by the configadmin bundle, however the class loader of the previously loaded class is &quot;org.eclipse.osgi.internal.baseadaptor.DefaultClassLoader@3c746762&lt;span class=&quot;error&quot;&gt;&amp;#91;org.eclipse.osgi.services:3.3.100.v20130513-1956(id=306)&amp;#93;&lt;/span&gt;&quot;&lt;br/&gt;
And then obviously we&apos;re talking about a different class&lt;/p&gt;

&lt;p&gt;Still, the interesting part is, that refreshing the configadmin bundle solves the problem and the code mentioned at the top of this comment throws an exception&lt;/p&gt;
</comment>
                            <comment id="15846885" author="cziegeler" created="Tue, 31 Jan 2017 14:17:05 +0000"  >&lt;p&gt;The problem seems to be the implicit bootdelegation code which in some cases is able to load the ConfigurationAdmin class from outside the webapp.&lt;br/&gt;
Now, setting&lt;br/&gt;
felix.bootdelegation.implicit=false&lt;br/&gt;
does the trick.&lt;/p&gt;

&lt;p&gt;I&apos;m really wondering if that shouldn&apos;t be the default for the framework?&lt;br/&gt;
Atm, I don&apos;t see how to improve the code to make this happen with setting it to true.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rickhall&quot; class=&quot;user-hover&quot; rel=&quot;rickhall&quot;&gt;rickhall&lt;/a&gt; Do you have any ideas?&lt;/p&gt;</comment>
                            <comment id="15846971" author="rickhall" created="Tue, 31 Jan 2017 15:33:36 +0000"  >&lt;p&gt;I wouldn&apos;t think that setting felix.bootdelegation.implicit to false by default would be a good solution. That setting was there because we were running into to problems fairly easily without it because the JRE was making assumptions in quite a few places that it could get from any class via any class loader, which is not the case in OSGi. So, unless the JRE has removed such assumptions over time, then it isn&apos;t a good idea to change this.&lt;/p&gt;

&lt;p&gt;As difficult as it may be, the better choice is to try to figure how to detect the current situation so that the implicit boot delegation code can be improved. Believe me, I understand that that code is ugly.&lt;/p&gt;

&lt;p&gt;Equinox does something similar, but I doubt the two implementations agree on the details here, but it could be worthwhile to understand what it is doing.&lt;/p&gt;</comment>
                            <comment id="15848056" author="cziegeler" created="Wed, 1 Feb 2017 06:11:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rickhall&quot; class=&quot;user-hover&quot; rel=&quot;rickhall&quot;&gt;rickhall&lt;/a&gt; Thanks, ok I see. So how can we solve this?&lt;br/&gt;
I&apos;m wondering if the current behaviour is in accordence with the spec. The boot delegation property is not listing the org.osgi.service.cm package, but still it is loaded from there. We also set &quot;org.osgi.framework.bundle.parent&quot; to &quot;framework&quot;.&lt;br/&gt;
I&apos;m not quiet sure, but I&apos;m a little bit confused by the implementation of ServiceReferenceImpl#isAssignableTo. For Case 1 where both requester and provider have no wire, it tries to load the class using delegation anyway - at the moment I don&apos;t understand why this is done. Wouldn&apos;t it be enought to grant access and assume the class of the registration is used?&lt;/p&gt;</comment>
                            <comment id="15864554" author="karlpauls" created="Mon, 13 Feb 2017 22:09:57 +0000"  >&lt;p&gt;Ok, I looked at this issue a little bit more in depth and I think I can see what is going on.&lt;/p&gt;

&lt;p&gt;When we did the implicit bootdelegation we really had one specific corner case in mind namely, something outside the framework (and more specifically, classes inside the jdk) assumes it can just use the class loader of the class of an object provided to it to get access to stuff it sees. That used to be the case for example in certain scenarios with swing. In order to remedy the somewhat awkward situation that people new to OSGi constantly had problems with this kind of thing we introduced our &#8220;magic hack&#8221; that would try to detect this situation as a last resort and bootdelegate automagically.&lt;/p&gt;

&lt;p&gt;After looking at that code again I do think it could be improved but overall it still seems to be sound in regard to its original purpose (and it was always the case that in more complicated scenarios, especially around embedding, we knew it needed to be turned off - hence, the possibility to disable it). However, what happens here is that we sort of ignored the fact that it is going to happen on all classloads when we did the tests for service assignability later on (iirc, this is still code form the beginning of R4 - at least in its origins). As a consequence, we have a problem in the service lookup path when,&lt;/p&gt;

&lt;p&gt;1) the class that instigates the lookup is coming from the outside&lt;br/&gt;
2) and the service class can actually be loaded from the outside but isn&#8217;t assignable to the class of the service&lt;br/&gt;
3) and both, the requirer and the provider, don&#8217;t have a wire to the package of the service class.&lt;/p&gt;

&lt;p&gt;It is this specific case that is happening here and it goes like this:&lt;/p&gt;

&lt;p&gt;The scr looks for ConfigAdmin via the bundle context of an extended bundle. That makes it so that the extended bundle doesn&#8217;t have a wire to the ConfigAdmin package (as it doesn&#8217;t use it itself) and the ConfigAdmin bundle provides the package - hence, doesn&#8217;t have a wire either (3). Next,  scr uses a ServiceTracker to track the ConfigAdmin and is importing the org.osgi.util.tracker package from the system bundle - in other words, the ServiceTracker class instigates the lookup and is coming from the outside (1). Finally, it just so happens that there is a ConfigAdmin class  outside as well that comes with equinox in websphere (2).&lt;/p&gt;

&lt;p&gt;As a result, when the lookup happens the ConfigAdmin isn&#8217;t returned because due to the triggered boot delegation we think it might not be assignable. Now, in the second case, when the ConfigAdmin bundle gets restarted later what happens is that the tracker isn&#8217;t instigating the lookup. In that case, it gets the service via a service event which &lt;em&gt;does not&lt;/em&gt; trigger the magic and in turn makes it so that the service is delivered (thats why it works after a restart of the ConfigAdmin bundle but &lt;em&gt;not&lt;/em&gt; after a restart of the scr bundle).&lt;/p&gt;

&lt;p&gt;TL;DR For now, the workaround with the current framework is to turn of implicit bootdelegation. For the future, we need to stop trying to implicitly bootdelegate in the service lookup.&lt;/p&gt;

&lt;p&gt;If nobody complains, I will go ahead and create a new issue for making it so that we don&#8217;t implicitly bootdelegate when we lookup the class for checking assignability of services and link it to this issue. I&#8217;ll try to get to addressing it soon as I want to get this into a new framework release this week.&lt;/p&gt;</comment>
                            <comment id="15865481" author="bosschaert" created="Tue, 14 Feb 2017 09:43:15 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=karlpauls&quot; class=&quot;user-hover&quot; rel=&quot;karlpauls&quot;&gt;karlpauls&lt;/a&gt;, thanks for the analysis and explaining. I still have the feeling though that the implicit bootdelegation is too wide. You say that it was designed for certain JDK/Swing scenarios. If we cannot switch it off by default (which I think would be a better default) - can we then at least limit it to certain packages?&lt;/p&gt;</comment>
                            <comment id="15865572" author="karlpauls" created="Tue, 14 Feb 2017 10:51:45 +0000"  >&lt;p&gt;I tentatively agree with you - at least in so far as that as I said, I think the detection could be (and probably should be) improved and that it probably should be off by default. However, as regards this specific issue I do think it is irrelevant as no matter what, it should not be involved in the assignability check to begin with. Consequently, let me recoin my statement about further actions as follows:&lt;/p&gt;

&lt;p&gt;If nobody complains, I will go ahead and create 3 new issues namely,&lt;/p&gt;

&lt;p&gt;1) Set default for implicit bootdelegation to false&lt;br/&gt;
2) Improve implicit boot delegation detection&lt;br/&gt;
3) Don&apos;t take implicit boot delegation into account on service assignability check&lt;/p&gt;

&lt;p&gt;I&apos;ll try to get to address 3) asap and get it out with a new Felix release hopefully this week. This should address this issue at least as far as the framework is concerned. However, I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjwatson&quot; class=&quot;user-hover&quot; rel=&quot;tjwatson&quot;&gt;tjwatson&lt;/a&gt; comments above that there still is an SCR issue as it should (or better must) use reflection for using the service. &lt;/p&gt;

&lt;p&gt;In regard to 1) and 2), I can see 1) being part of a bigger release (Major bump) sometime later - possible with a release in which we claim compliance with R7 and we can work on 2) separately and get it out when it is ready.  &lt;/p&gt;</comment>
                            <comment id="15865981" author="cziegeler" created="Tue, 14 Feb 2017 15:42:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kpauls&quot; class=&quot;user-hover&quot; rel=&quot;kpauls&quot;&gt;kpauls&lt;/a&gt; +1 for the three issues&lt;/p&gt;</comment>
                            <comment id="15866053" author="karlpauls" created="Tue, 14 Feb 2017 16:20:40 +0000"  >&lt;p&gt;I create the issues and already committed a fix for 3) in r1782982 as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5544&quot; title=&quot;Don&amp;#39;t take implicit boot delegation into account on service assignability check&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5544&quot;&gt;&lt;del&gt;FELIX-5544&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15866181" author="cziegeler" created="Tue, 14 Feb 2017 17:26:22 +0000"  >&lt;p&gt;Thanks, I&apos;ve repurposed this issue to work in the SCR improvement&lt;/p&gt;</comment>
                            <comment id="15867106" author="djencks" created="Wed, 15 Feb 2017 02:24:27 +0000"  >&lt;p&gt;We still have to fetch the config admin service using the bundle context of the extended bundle.  I think that unless the spec explicitly requires handling the case of inconsistent config admin classes or someone complains it is not worth the extra code complexity to use reflection to communicate with config admin.  Is there any actual useful functionality provided by implementing this?&lt;/p&gt;</comment>
                            <comment id="15867331" author="cziegeler" created="Wed, 15 Feb 2017 06:25:03 +0000"  >&lt;p&gt;Well you assume that you have a shared config admin API across the whole system - which is a false assumption and can&apos;t be guaranteed at all. It&apos;s really wrong to assume that the config admin class you get using the extended bundle is the same as SCR sees. It might not be that common, but it&apos;s still possible.&lt;br/&gt;
As I&apos;ve mentioned earlier on, we should at least catch the class cast exception and provide a meaningful log entry. Atm I&apos;m not very keen on using reflection all over the place either&lt;/p&gt;</comment>
                            <comment id="15867778" author="karlpauls" created="Wed, 15 Feb 2017 12:54:24 +0000"  >&lt;p&gt;Granted, I don&apos;t know too much about how the code looks but it sounds like it shouldn&apos;t be too hard to Proxy the Configadmin with a dynamic proxy. Basically, you&apos;d have to wrap the service lookup with something that does an instanceof and if that fails wrap the result in a dynamic proxy that just delegates all calls and wraps all results of type Configuration in yet another dynamic proxy that does delegation only. That way you at least wouldn&apos;t have to introduce reflection any place else...&lt;/p&gt;</comment>
                            <comment id="15868691" author="djencks" created="Wed, 15 Feb 2017 22:25:30 +0000"  >&lt;p&gt;I certainly agree with improving error messages.&lt;br/&gt;
It is obviously possible to set up a non-working subsystem by not importing the system-wide config admin api.  However, it&apos;s also obviously possible to set up a non-working subsystem by writing ds components using e.g. ComponentServiceObjects, including the ds api in the subsystem, and not importing it. In both these cases, ca and ds apis, I think the appropriate choices are:&lt;br/&gt;
1. import the global apis&lt;br/&gt;
2. run (another) ds in the subsystem and turn off global extender.&lt;/p&gt;

&lt;p&gt;Are there any plausible use cases that one of these options doesn&apos;t cover?  Is there anything useful that you can&apos;t do with one of these choices?&lt;/p&gt;

&lt;p&gt;IMO if you are using subsystems you have probably already made a fundamental design mistake and need to accept that you may have to go to some considerable effort to configure working subsystems. I don&apos;t think adding infinite complexity to try to eliminate every possible way of shooting yourself in the foot is a reasonable goal.&lt;/p&gt;</comment>
                            <comment id="15869311" author="cziegeler" created="Thu, 16 Feb 2017 06:18:11 +0000"  >&lt;p&gt;You are subscribing a solution because you don&apos;t want to handle it in the implementation. And this is really not infinite complexity - as Karl said, it&apos;s a simple check: do I need to proxy, if no, fine, if yes, create the proxy and done&lt;br/&gt;
Why can&apos;t I have a config admin including API in a subsystem and a global DS? We nowhere say something about how you should do it. Users are free to shoot themselves in the foot in any way they like&lt;/p&gt;</comment>
                            <comment id="15869513" author="djencks" created="Thu, 16 Feb 2017 08:32:18 +0000"  >&lt;p&gt;If I thought it was a good idea I&apos;d be happy to implement it, but I really think it&apos;s useless and a bad idea. Be sure to check that the CA package version is high enough to work with ds &amp;#8211; at a minimum you need the configuration version method.&lt;/p&gt;

&lt;p&gt;I&apos;d hope config admin implementations include the api, so my suggestion is to pull in the external ca api to the subsystem, just as you are likely to have to pull in the ds apis.&lt;/p&gt;</comment>
                            <comment id="15870001" author="tjwatson" created="Thu, 16 Feb 2017 14:16:58 +0000"  >&lt;p&gt;You will also have to proxy a configuration listener which can get registered and found by the CM implementation.  I doubt you can use the SCR bundle context to do such a thing because the CM implementation likely will not see the listener and besides the framework should disallow it because the listener type is not going to be the correct type according to the SCR impl.  I&apos;m not sure what context SCR is using for the listener today, but it will likely have to be using the component bundle&apos;s context or some other bundle that the CM implementation can see and is wired to no CM package or the correct one.&lt;/p&gt;

&lt;p&gt;If you decide to do this please have it disabled by default and have an option to enable it.  I fear this complication will be full of bugs for a few releases until all the kinks worked out.  I would not want to have such a corner case impact the vast majority of users today.&lt;/p&gt;</comment>
                            <comment id="15870290" author="karlpauls" created="Thu, 16 Feb 2017 17:08:18 +0000"  >&lt;p&gt;Again, I&apos;m not sure I understand all the implications but it sounds to me like you want to have your cake and eat it too. &lt;/p&gt;

&lt;p&gt;Either SCR uses its own bundle context (whichever that is in the case of a &quot;subsystem&quot; - maybe the system bundle context) to look up the CM and register listeners with or it uses the bundle context of the extended bundle. &lt;/p&gt;

&lt;p&gt;In the former case, SCR has no problems with class loading and it just so happens that a bundle extended by SCR will get the configurations from the CM visible to the SCR. &lt;/p&gt;

&lt;p&gt;In the latter case, the bundle will get the configurations from the CM visible to the bundle but the SCR must deal with the possibility that the bundle might not be wired to the same CM the SCR can see. &lt;/p&gt;

&lt;p&gt;To basically say we want the CM visible to the bundle but we just assume it is the one the SCR can see as well sounds like an unnecessary complication to me. If that is the assumption anyways you might as well just make that explicit and use the SCR bundle context to begin with no? &lt;/p&gt;

&lt;p&gt;Again, feel free to ignore me as I likely just don&apos;t have all the info.&lt;/p&gt;</comment>
                            <comment id="15870814" author="djencks" created="Thu, 16 Feb 2017 22:47:02 +0000"  >&lt;p&gt;Philosophically I think that if OSGI has to resort to reflection to access an osgi spec interface we&apos;ve failed.&lt;/p&gt;

&lt;p&gt;On the other hand there might be a potential use case for this:&lt;br/&gt;
Commercial server based on OSGI that is not updated all that often (say stuck at R7 for the next 10 years)&lt;br/&gt;
subsystem in it that wants to use an R8 config admin (assuming R8 updates the config admin spec).  This can&apos;t be wired to the R7 config admin api from the server.  Is this a realistic scenario or will the R8 config admin also require R8 framework so not run in the R7 server anyway?&lt;/p&gt;

&lt;p&gt;Assuming my reservations about doing this are overruled:&lt;br/&gt;
Finding the bundle for the ca is already  done in RegionConfigurationSupport, so that can be used to load the SynchronousConfigurationListener and ManagedService (for configuration plugin support) interfaces in order to create dynamic proxies.&lt;/p&gt;

&lt;p&gt;Contrary to some other suggestions, I think that there should only be one code path using proxies for objects we create and reflection on stuff we get from config admin, and no separate path for compatible config admin apis.  No one is ever going to use this support, so if we want it to work we have to use the code path all the time to find the bugs.&lt;/p&gt;

&lt;p&gt;I will reiterate again:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;requiring a subsystem to import the config admin api as well as the ds api is not a large burden.&lt;/li&gt;
	&lt;li&gt;I think waiting until someone requests this feature because they actually want to use it would be wise.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Karl:&lt;/p&gt;

&lt;p&gt;&quot;In the latter case, the bundle will get the configurations from the CM visible to the bundle but the SCR must deal with the possibility that the bundle might not be wired to the same CM the SCR can see.&quot;&lt;br/&gt;
This is not quite right.  We want to look for the CM service visible to the extended bundle, but the extended bundle doesn&apos;t necessarily have any wires to the CM api.  Currently we deal with the case where the CM api is not the same as the CM api visible to DS by not using it and emitting an error message (to be improved).  I think  that&apos;s fine.&lt;/p&gt;</comment>
                            <comment id="15871273" author="cziegeler" created="Fri, 17 Feb 2017 06:40:56 +0000"  >&lt;p&gt;In rev 1783333 I&apos;ve added a little bit of code to catch the situation and log an error. If we can agree at least on this change, I think we can close this issue&lt;/p&gt;</comment>
                            <comment id="15871359" author="djencks" created="Fri, 17 Feb 2017 07:43:23 +0000"  >&lt;p&gt;rev 1783333 looks great to me, thanks!&lt;/p&gt;</comment>
                            <comment id="15871381" author="cziegeler" created="Fri, 17 Feb 2017 08:04:50 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djencks&quot; class=&quot;user-hover&quot; rel=&quot;djencks&quot;&gt;djencks&lt;/a&gt;. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13042982">FELIX-5545</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13042984">FELIX-5546</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                                                <inwardlinks description="is superceded by">
                                        <issuelink>
            <issuekey id="13042974">FELIX-5544</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 39 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i38zrb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>