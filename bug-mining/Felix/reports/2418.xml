<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:57:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-4883] ServiceComponentRuntime.getComponentConfigurationDTOs NullPointerException</title>
                <link>https://issues.apache.org/jira/browse/FELIX-4883</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;In our test automation we install a large set of bundles after our also large &apos;main&apos; app starts up. This causes significant churn as bundles and components are stopped and potentially new versions are started. Unfortunately the coded involved is not open source, so I cannot deliver the full data required to reproduce  the failure described here.&lt;/p&gt;

&lt;p&gt;What I can share is that after all this churn of bundles and components being stopped and started the ScrComponentRuntime service starts to fail with a NullPointerException in getComponentConfigurationDTOs. This was initially noticed as an NPE being reported when visiting the felix console at /system/console/components.&lt;/p&gt;

&lt;p&gt;The stack at the point of failure is:&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.felix.scr.impl.runtime.ServiceComponentRuntimeImpl.serviceReferenceToDTO(ServiceComponentRuntimeImpl.java:205)&lt;br/&gt;
	at org.apache.felix.scr.impl.runtime.ServiceComponentRuntimeImpl.satisfiedRefManagersToDTO(ServiceComponentRuntimeImpl.java:169)&lt;br/&gt;
	at org.apache.felix.scr.impl.runtime.ServiceComponentRuntimeImpl.managerToConfiguration(ServiceComponentRuntimeImpl.java:145)&lt;br/&gt;
	at org.apache.felix.scr.impl.runtime.ServiceComponentRuntimeImpl.getComponentConfigurationDTOs(ServiceComponentRuntimeImpl.java:119)&lt;br/&gt;
	at com.robr.incqtest.test.ScrTest.test(ScrTest.java:37)&lt;br/&gt;
	...&lt;/p&gt;

&lt;p&gt;The NPE occurs because a org.apache.felix.framework.ServiceRegistrationImpl.ServiceReferenceImpl being processed in org.apache.felix.scr.impl.runtime.ServiceComponentRuntimeImpl.serviceReferenceToDTO(org.osgi.framework.ServiceReference&amp;lt;?&amp;gt;) line: 205	&lt;/p&gt;

&lt;p&gt;has a m_svcObj of null. So even though the bundle is actually available in the object the getBundle() method returns null.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bosschaert&quot; class=&quot;user-hover&quot; rel=&quot;bosschaert&quot;&gt;bosschaert&lt;/a&gt; I can investigate further to ideally narrow this down further, but any pointers would be much appreciated.&lt;/p&gt;</description>
                <environment>Linux, Sling, Adobe CQ, org.apache.felix.scr version 1.8.3-R1658944</environment>
        <key id="12827787">FELIX-4883</key>
            <summary>ServiceComponentRuntime.getComponentConfigurationDTOs NullPointerException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bosschaert">David Bosschaert</assignee>
                                    <reporter username="rryan@adobe.com">Rob Ryan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 May 2015 19:50:07 +0000</created>
                <updated>Tue, 11 Aug 2015 05:09:34 +0000</updated>
                            <resolved>Thu, 28 May 2015 18:55:23 +0000</resolved>
                                                    <fixVersion>scr-2.0.0</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14531288" author="rryan@adobe.com" created="Wed, 6 May 2015 19:55:02 +0000"  >&lt;p&gt;This project is a sling remote junit test  which exhibits the NPE described &lt;b&gt;once&lt;/b&gt; an instance is in a bad state.&lt;/p&gt;

&lt;p&gt;Unfortunately I cannot yet publicly share the collateral which generates the bad state.&lt;/p&gt;</comment>
                            <comment id="14540754" author="rryan@adobe.com" created="Tue, 12 May 2015 21:13:13 +0000"  >&lt;p&gt;The root cause which led to discovery of this NPE was a component which (mis)handled its own service registration. It could at times attempt to update its service registration properties while not actually registered.&lt;/p&gt;

&lt;p&gt;I think it is appropriate for clients of ServiceReference.getBundle() to handle a null return, but that was not a root cause to our actual problem.&lt;/p&gt;

&lt;p&gt;A &apos;minor&apos; priority seems appropriate, so setting as such.&lt;/p&gt;</comment>
                            <comment id="14554007" author="bosschaert" created="Thu, 21 May 2015 09:54:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rryan%40adobe.com&quot; class=&quot;user-hover&quot; rel=&quot;rryan@adobe.com&quot;&gt;rryan@adobe.com&lt;/a&gt; how should I run your attached test case? It&apos;s a test, but it&apos;s in src/main so won&apos;t be executed by the maven test running. Moving it to the test subdirectory gives me a NPE, but I think its a different one:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;test(com.robr.incqtest.test.ScrTest)  Time elapsed: 0.008 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.sling.junit.annotations.SlingAnnotationsTestRunner.createTest(SlingAnnotationsTestRunner.java:43)
	at org.junit.runners.BlockJUnit4ClassRunner$1.runReflectiveCall(BlockJUnit4ClassRunner.java&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14554518" author="djencks" created="Thu, 21 May 2015 15:28:21 +0000"  >&lt;p&gt;I don&apos;t understand your suggestion.  The code in question:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;		Bundle[] usingBundles = serviceRef.getUsingBundles();
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (usingBundles != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
        {
            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;[] usingBundleIds = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;[usingBundles.length];
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; usingBundles.length; i++)
            {
                usingBundleIds[i] = usingBundles[i].getBundleId();  &amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;NPE!!
            }
            dto.usingBundles = usingBundleIds;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So serviceRef.getUsingBundles(); has returned an array with at least one null.&lt;/p&gt;

&lt;p&gt;This is probably incorrect, but it might be wiser to allow for this potential bug in frameworks and just ignore null bundles?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;		Bundle[] usingBundles = serviceRef.getUsingBundles();
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (usingBundles != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
        {
            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;[] usingBundleIds = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;[usingBundles.length];
            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0;
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Bundle usingBundle: usingBundles)
            {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (usingBundle != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                    usingBundleIds[i++] = usingBundle.getBundleId();
                }
            }
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (i &amp;lt; usingBundleIds.length) {
                usingBundleIds = Arrays.copyOf(usingBundleIds, i);
            }
            dto.usingBundles = usingBundleIds;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14554543" author="rryan@adobe.com" created="Thu, 21 May 2015 15:45:10 +0000"  >&lt;p&gt;The particular point where this exception was seen was:&lt;/p&gt;

&lt;p&gt;	private ServiceReferenceDTO serviceReferenceToDTO( ServiceReference&amp;lt;?&amp;gt; serviceRef)&lt;br/&gt;
	{&lt;br/&gt;
		ServiceReferenceDTO dto = new ServiceReferenceDTO();&lt;br/&gt;
		Bundle bundle = serviceRef.getBundle(); // &amp;lt;-- NPE was here.&lt;/p&gt;


&lt;p&gt;This is the kind of context where checking null may be appropriate defensiveness IMO...&lt;/p&gt;

&lt;p&gt;But in the end the bug originates with bad calling of the service registration APIs where a call to update service registration properties while the service was unregistered resulted in bad state in the SCR. I can try to reduce the proprietary code to an example which can be publicly disclosed.&lt;/p&gt;</comment>
                            <comment id="14554934" author="bosschaert" created="Thu, 21 May 2015 19:39:17 +0000"  >&lt;p&gt;I guessed that the problem may be there, but rather than guessing I prefer to run your testcase so that I can be sure that the problem is fixed. You have attached a testcase, but I can&apos;t run it. I would appreciate if you could tell me how to run the testcase (a simple &apos;mvn install&apos; didn&apos;t work as mentioned above) so that I can expose the problem and then ensure that its fixed.&lt;/p&gt;</comment>
                            <comment id="14556104" author="bosschaert" created="Fri, 22 May 2015 12:47:25 +0000"  >&lt;p&gt;I mistakenly thought that the attached zip contained a testcase. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rryan%40adobe.com&quot; class=&quot;user-hover&quot; rel=&quot;rryan@adobe.com&quot;&gt;rryan@adobe.com&lt;/a&gt;, I have put a defensive check for nulls on the line that you indicated: &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1681073&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1681073&lt;/a&gt;&lt;br/&gt;
As creating a ServiceReferenceDTO for a null ServiceReference does not make any sense, I&apos;m having it return null. I have also updated the calling side to be able to deal with the null return value: &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1681097&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1681097&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please reopen if this doesn&apos;t fix it for you.&lt;/p&gt;</comment>
                            <comment id="14556761" author="rryan@adobe.com" created="Fri, 22 May 2015 20:11:55 +0000"  >&lt;p&gt;Sorry. my previous comment was in error I was looking at a version I had made to test the behavior.&lt;/p&gt;

&lt;p&gt;The actual line which NPEs is:&lt;/p&gt;

&lt;p&gt;dto.bundle = serviceRef.getBundle().getBundleId();&lt;/p&gt;

&lt;p&gt;In this line serviceRef being null &lt;b&gt;or&lt;/b&gt; serviceRef.getBundle() returning null can cause an NPE.&lt;/p&gt;

&lt;p&gt;In our case it was serviceRef.getBundle() returning null which caused the issue.&lt;/p&gt;

&lt;p&gt;I will try to make time to abstract the proprietary code into a publicly disclosable form that can demonstrate what is happening.&lt;/p&gt;</comment>
                            <comment id="14563177" author="rryan@adobe.com" created="Thu, 28 May 2015 16:10:09 +0000"  >&lt;p&gt;It is proving difficult to provoke the failure through an isolated  test case. But code inspection and testing with variations of the code have convinced me the situation goes like this:&lt;/p&gt;

&lt;p&gt;ServiceRegistration.setProperties checks up front for a valid service object, but it lets go of its lock on the ServiceRegistrationImpl before it calls the ServiceListeners. That means that the ServiceRegistrationImpl delivered to a ServiceListener can become invalid before the serviceChanged method of a listener is called. This is coupled with an inappropriate assumption in org.apache.felix.scr.impl.manager.ServiceTracker&amp;lt;S, T&amp;gt;. In org.apache.felix.scr.impl.manager.ServiceTracker.Tracked.serviceChanged(ServiceEvent) :&lt;/p&gt;

&lt;p&gt;				case ServiceEvent.REGISTERED :&lt;br/&gt;
				case ServiceEvent.MODIFIED :&lt;br/&gt;
					track(reference, event);&lt;/p&gt;

&lt;p&gt;This means that delivery of a ServiceEvent.MODIFIED can have the same effect as a ServiceEvent.REGISTERED, and can re-track a service registration that is actually already invalid!&lt;/p&gt;

&lt;p&gt;Bottom line I think is that ServiceRegistration &lt;b&gt;and&lt;/b&gt; ServiceReference uses need to be aware that any time a lock is not held on the ServiceRegistration the object can become invalid. At which point the bundle becomes unavailable (getBundle returns null).&lt;/p&gt;

&lt;p&gt;While I haven&apos;t unraveled all the implications for the ServiceTracker implementation yet, it appears some additional synchronization is necessary within the ServiceTracker to ensure that service registration changes from separate threads don&apos;t result in an invalid state of the system.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lbyrum&quot; class=&quot;user-hover&quot; rel=&quot;lbyrum&quot;&gt;lbyrum&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14563321" author="bosschaert" created="Thu, 28 May 2015 17:43:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rryan%40adobe.com&quot; class=&quot;user-hover&quot; rel=&quot;rryan@adobe.com&quot;&gt;rryan@adobe.com&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lbyrum&quot; class=&quot;user-hover&quot; rel=&quot;lbyrum&quot;&gt;lbyrum&lt;/a&gt;, in general in the Felix codebase there are no locks held when calling into custom code (i.e. listeners) as you have no idea what this code is doing; if custom code is called while holding a lock this may increase the chances of deadlock situations. I&apos;m not sure whether it&apos;s a good idea to change this. &lt;/p&gt;

&lt;p&gt;Wrt to the ServiceTracker being incorrect. It might be good to take this discussion to &lt;a href=&quot;https://mail.osgi.org/mailman/listinfo/osgi-dev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;osgi-dev&lt;/a&gt; or &lt;a href=&quot;https://osgi.org/bugzilla/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;osgi bugzilla&lt;/a&gt;. The ServiceTracker class in scr is actually a copy of the &lt;a href=&quot;https://osgi.org/javadoc/r5/core/org/osgi/util/tracker/ServiceTracker.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;org.osgi.util.tracker.ServiceTracker&lt;/a&gt; class developed by OSGi and since this is quite a complex class it might be better to discuss it where the original authors can participate.&lt;/p&gt;

&lt;p&gt;On the actual symptom. I guess it would do no harm in changing the dto.bundle assignment to check that getBundle() does not return null. Would this help?&lt;/p&gt;</comment>
                            <comment id="14563351" author="rryan@adobe.com" created="Thu, 28 May 2015 17:54:42 +0000"  >&lt;p&gt;Yes, lets please at least harden the line:&lt;/p&gt;

&lt;p&gt;dto.bundle = serviceRef.getBundle().getBundleId();&lt;/p&gt;

&lt;p&gt;In this line serviceRef being null or serviceRef.getBundle() returning null can cause an NPE.&lt;/p&gt;

&lt;p&gt;This would allow the felix console to remain usable for non-impacted components at least.&lt;/p&gt;
</comment>
                            <comment id="14563355" author="bosschaert" created="Thu, 28 May 2015 17:58:31 +0000"  >&lt;p&gt;One other comment, from &lt;a href=&quot;https://osgi.org/javadoc/r5/core/org/osgi/framework/ServiceReference.html#getBundle():&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://osgi.org/javadoc/r5/core/org/osgi/framework/ServiceReference.html#getBundle():&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This method must return null when the service has been unregistered. This can be used to determine if the service has been unregistered.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So maybe the current behaviour is correct, although the dto.bundle assignment should be updated to take this into account.&lt;/p&gt;</comment>
                            <comment id="14563467" author="bosschaert" created="Thu, 28 May 2015 18:55:23 +0000"  >&lt;p&gt;I added the defensive check for serviceRef.getBundle() returning null as agreed. I guess that&apos;s all we can do on this one for now. If any of the other points raised need additional fixes, please raise new issues for those.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12730933" name="scrtest.zip" size="5008" author="rryan@adobe.com" created="Wed, 6 May 2015 19:55:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 25 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2edtj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>