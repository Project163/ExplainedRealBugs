<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:08:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-953] Bundle#loadClass sometimes return null instead of throwing a CNFE</title>
                <link>https://issues.apache.org/jira/browse/FELIX-953</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;Here is a patch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: src/main/java/org/apache/felix/framework/Felix.java
===================================================================
--- src/main/java/org/apache/felix/framework/Felix.java (revision 746347)
+++ src/main/java/org/apache/felix/framework/Felix.java (working copy)
@@ -1338,7 +1338,12 @@
                 &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ClassNotFoundException(name, ex);
             }
         }
-        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; bundle.getCurrentModule().getClassByDelegation(name);
+        &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; clazz = bundle.getCurrentModule().getClassByDelegation(name);
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (clazz == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
+        {
+            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ClassNotFoundException(name);
+        }
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; clazz;
     }
 
     /**
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m wondering if there any reason why ModuleImpl#getClassByDelegation(String) returns null instead of throwing a NPE.&lt;br/&gt;
Browsing through the code, it seems there are several places where a null value is checked, then a CNFE thrown.&lt;br/&gt;
This would also avoid possible NPE in felix code as in Felix#createBundleActivator.&lt;/p&gt;

&lt;p&gt;I think it would be nice to iron the definition of IModule#getClassByDelegation to either remove the thrown CNFE or never returns null, as currently both can happen.&lt;br/&gt;
The IWire interface has exactly the same problem.&lt;/p&gt;

&lt;p&gt;I will try to come up with a patch which will never return a null value for both interfaces.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12415258">FELIX-953</key>
            <summary>Bundle#loadClass sometimes return null instead of throwing a CNFE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="gnodet">Guillaume Nodet</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 Feb 2009 20:49:27 +0000</created>
                <updated>Tue, 24 Feb 2009 15:10:22 +0000</updated>
                            <resolved>Tue, 24 Feb 2009 14:51:06 +0000</resolved>
                                                    <fixVersion>framework-1.6.0</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12675471" author="gnt" created="Fri, 20 Feb 2009 20:58:15 +0000"  >&lt;p&gt;I guess that the reason for not throwing CNFE was maybe performances.&lt;br/&gt;
In such a case, both IWire and IModule should not throw CNFE at all and delegate to classes upper in the stack trace to throw exceptions.&lt;/p&gt;

&lt;p&gt;Btw, I think the exact same thing applies to resources, which sometimes throw a ResourceNotFoundException or not.&lt;/p&gt;</comment>
                            <comment id="12675473" author="gnt" created="Fri, 20 Feb 2009 21:06:09 +0000"  >&lt;p&gt;Looking at history on the ModuleImpl class:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;in 1.0.4, ModuleImpl#getClass() never throws a CNFE&lt;/li&gt;
	&lt;li&gt;in 1.2.2 and 1.4.1 ModuleImpl#getClass() never returns null and throws a CNFE&lt;/li&gt;
	&lt;li&gt;in trunk, both can happen&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12675475" author="gnt" created="Fri, 20 Feb 2009 21:12:47 +0000"  >&lt;p&gt;Ok, I&apos;ll stop digging further.&lt;br/&gt;
Should IWire and IModule behave consistently: both throwing CNFE or always return null ? Has the mixed case any value ?  Should Resource loading behave consistently too ?&lt;br/&gt;
I&apos;d be willing to help and provide a patch, but I need some directions. &lt;/p&gt;</comment>
                            <comment id="12675555" author="gnt" created="Sat, 21 Feb 2009 12:30:24 +0000"  >&lt;p&gt;Simple patch to fix the issue and a possible NPE&lt;/p&gt;</comment>
                            <comment id="12675951" author="rickhall" created="Mon, 23 Feb 2009 15:40:40 +0000"  >&lt;p&gt;The functionality around IModule.getClass() has changed a lot lately, so not everything may be so well thought out yet, but it is unclear to me if you have uncovered a specific issue or just something you see as an inconsistency?&lt;/p&gt;

&lt;p&gt;Regarding IWire.getClass(), this specifically works differently. An exception aborts the search, whereas a null continues the search. Terrible documentation on this, I know. I will use this issue to improve the JavaDoc on IWire.&lt;/p&gt;</comment>
                            <comment id="12675954" author="gnt" created="Mon, 23 Feb 2009 15:54:04 +0000"  >&lt;p&gt;There are two things.&lt;/p&gt;

&lt;p&gt;The first problem is stated by the issue description: Bundle.loadClass() sometimes returns null instead of throwing a ClassNotFoundException which is against the ClassLoader specification (it is supposed to either returns the loaded class or throw an exception, but never return a null value).  This issue, along with a possible NPE are solved in the attached patch.&lt;/p&gt;

&lt;p&gt;The second issue is more about inconsistencies / bad documentation.  Usually, I do tend to think that loading classes always follow the ClassLoader specifiation: i.e. never returns null.  So any change from that should be explicitely stated in the javadoc imho.  I guess this issue has more to deal with me not fully understanding the code though.&lt;/p&gt;</comment>
                            <comment id="12675959" author="gnt" created="Mon, 23 Feb 2009 16:02:37 +0000"  >&lt;p&gt;I might see why IWire sometimes returns null and sometimes throw an exception (though not really confident about that yet), but but afaik, IModule really represents the bundle, so I don&apos;t really see why that one would return a null value instead of throwing a CNFE.   Would that makes sense to you that IModule#getClassByDelegation() always throw an exception ?&lt;/p&gt;

&lt;p&gt;Looking deeper in the code, i&apos;ve just found another possible NPE in ServiceRegistrationImpl#isClassAccessible where the clazz parameter can be null from a call to ServiceRegistrationImpl#isAssignableTo().&lt;br/&gt;
That one is harmless because catched, but it could be avoided nevertheless (which is good when debugging when i sometimes but a breakpoint exception on NPE).&lt;/p&gt;</comment>
                            <comment id="12675980" author="rickhall" created="Mon, 23 Feb 2009 17:09:56 +0000"  >&lt;p&gt;IWire could be for an Import-Package (R4Wire) or a Require-Bundle (R4WireModule). If a class is not found from an Import-Package, then an exception is thrown because this must terminate the search. If a class is not found from a Require-Bundle, then null is returned because the search must continue.&lt;/p&gt;

&lt;p&gt;Regarding, IModule.getClassByDelegation() (this name will probably still change as part of my refactoring), I am not necessarily against making this always return an exception, but I will have to look into it some more. The reason we are a little inconsistent here is because we have boiled down two abstractions into one in the trunk, we merged IContentLoader and IModule and I believe these two handled the situation differently before. I don&apos;t think IModule.getClass() ever threw an exception previously.&lt;/p&gt;

&lt;p&gt;In short, I think you are correct we probably need to make sure we have this issue handled in a reasonable way. So, I will look into it as part of the ongoing work for &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-851&quot; title=&quot;Refactor the module abstraction layer to align more closely to OSGi concepts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-851&quot;&gt;&lt;del&gt;FELIX-851&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12676019" author="rickhall" created="Mon, 23 Feb 2009 19:08:04 +0000"  >&lt;p&gt;Guillaume, I looked at the code more closely. Could you describe the situation in which you are seeing a null being returned? The only time ModuleImpl.getClassByDelegation() should return null is if it has detected a cycle, but this is not intended to be returned to the caller, it just marks the end of the cycle. Perhaps we have a logic bug. This is part of a more recent refactoring, so it is likely the issue appeared as a result. I think the intent is that the method should always result in an exception if the class cannot be found.&lt;/p&gt;</comment>
                            <comment id="12676051" author="gnt" created="Mon, 23 Feb 2009 20:17:26 +0000"  >&lt;p&gt;I suspect the problem mainly comes from ExtensionManager.&lt;br/&gt;
The following code should return null:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;bundleContext.getBundle(0).loadClass(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo.bar&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In ServiceMix 4, we&apos;re creating our own classloaders so that we can be compliant with the JBI spec (though we do push people to use plain OSGi bundles).  In doing so, the system bundle is used as a parent for those classloaders.   &lt;/p&gt;

&lt;p&gt;It may be just about fixing ExtensionManager.ExtensionManagerModule.getClassByDelegation() to not return null.&lt;/p&gt;</comment>
                            <comment id="12676106" author="rickhall" created="Mon, 23 Feb 2009 22:51:26 +0000"  >&lt;p&gt;You are correct that the extension manager module was incorrect. It should have just been calling loadClass() on its class loader and letting the exception fly rather than catching and logging it. This could be a mistake from the refactoring. I have fixed this. I also investigated the cycle checking code and I am fairly confident it will not return a null to user code, so I think this issue is resolved. Please close it if you are satisfied.&lt;/p&gt;</comment>
                            <comment id="12676208" author="ffang" created="Tue, 24 Feb 2009 07:10:25 +0000"  >&lt;p&gt;Hi,&lt;br/&gt;
seems only change ExtensionManager can&apos;t completely fix this issue.&lt;br/&gt;
The error as Guillaume described still exist, which means the system bundle classloader still return null sometimes.&lt;br/&gt;
If I build the code myself with Guillaume&apos;s patch, then It works.&lt;br/&gt;
Freeman&lt;/p&gt;</comment>
                            <comment id="12676209" author="gnt" created="Tue, 24 Feb 2009 07:25:17 +0000"  >&lt;p&gt;Richard, I think your changes are not sufficient.&lt;br/&gt;
The current &lt;tt&gt;ExtensionManager&lt;/tt&gt; code looks like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; getClassByDelegation(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ClassNotFoundException
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!m_exportNames.contains(Util.getClassPackage(name)))
            {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            }

            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; getClass().getClassLoader().loadClass(name);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Imho, it should be:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; getClassByDelegation(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ClassNotFoundException
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!m_exportNames.contains(Util.getClassPackage(name)))
            {
                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ClassNotFoundException(name);
            }
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; getClass().getClassLoader().loadClass(name);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12676301" author="rickhall" created="Tue, 24 Feb 2009 14:51:06 +0000"  >&lt;p&gt;Yes, you are correct, I missed that. Fixed now. This should be consistent with ModuleImpl.getClassByDelegation() which will also throw an exception if you ask it for a class it cannot load. Please close if satisfied.&lt;/p&gt;</comment>
                            <comment id="12676305" author="gnt" created="Tue, 24 Feb 2009 14:59:02 +0000"  >&lt;p&gt;I have tested this patch, so I&apos;m closing this issue.&lt;br/&gt;
Would you mind deploying a snapshot please ?&lt;/p&gt;</comment>
                            <comment id="12676306" author="rickhall" created="Tue, 24 Feb 2009 15:10:22 +0000"  >&lt;p&gt;Snapshots deployed. Thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12411050">FELIX-851</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12400656" name="FELIX-953.patch" size="1036" author="gnodet" created="Sat, 21 Feb 2009 12:30:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>58037</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 40 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0vwbb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>184208</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>