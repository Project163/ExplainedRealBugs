<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:11:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5592] Maven bundle plugin does not support Java 9 Multi-Release jars</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5592</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;Log4j 2 currently packages its jars with the maven-bundle-plugin. To support Java 9 we are moving towards using Multi-Release jars to pick up the Java 9 features.  However, when the Maven bundle plugin encouters classes in META-INF/versions/9 it emits an error message saying &quot;Classes found in the wrong directory:&quot;, which is incorrect for a Multi-Release jar in Java 9.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13057364">FELIX-5592</key>
            <summary>Maven bundle plugin does not support Java 9 Multi-Release jars</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nbartlett">Neil Bartlett</assignee>
                                    <reporter username="rgoers">Ralph Goers</reporter>
                        <labels>
                    </labels>
                <created>Sun, 19 Mar 2017 17:05:55 +0000</created>
                <updated>Sat, 25 May 2024 16:50:13 +0000</updated>
                            <resolved>Thu, 14 Dec 2017 16:19:04 +0000</resolved>
                                    <version>maven-bundle-plugin-3.2.0</version>
                                    <fixVersion>maven-bundle-plugin-3.4.0</fixVersion>
                                    <component>Maven Bundle Plugin</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15931829" author="io7m" created="Sun, 19 Mar 2017 17:11:06 +0000"  >&lt;p&gt;It&apos;s the same root cause as this: &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5527&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FELIX-5527&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15931835" author="ralph.goers@dslextreme.com" created="Sun, 19 Mar 2017 17:21:13 +0000"  >&lt;p&gt;Thanks, I just read that thread. I have no plans to subscribe to the bnd-tools mailing list so I can&apos;t comment there. Java 9 is scheduled to be released in a few months. As such Log4j 2 needs to have support in place for that. The spec for multi-release jars is not going to change and if it was going to that would have happened a year or more ago. It sounds like they are sticking their heads in the sand hoping the problem will go away. Instead it is going to get worse. To be honest, supporting Java 9 is a much higher priority to me than supporting OSGi.&lt;/p&gt;</comment>
                            <comment id="15931863" author="io7m" created="Sun, 19 Mar 2017 18:12:07 +0000"  >&lt;p&gt;I think the main issue is that OSGi doesn&apos;t have any way of representing &quot;classes that are only loaded in a specific jvm environment&quot;. As I mentioned in that thread, the right way to do this is via services (both in OSGi and Java 9), but that&apos;s not much help for existing code that isn&apos;t structured as services.&lt;/p&gt;</comment>
                            <comment id="15931918" author="ralph.goers@dslextreme.com" created="Sun, 19 Mar 2017 19:59:07 +0000"  >&lt;p&gt;If I get what you are suggesting, the Java 9 replacement classes would need to have unique names or be in different packages. and then the code that wants to use these would have to use the ServiceLoader to locate the implementations and somehow pick the one for the current jdk.  This seems like a lot more work than what is required of the application for multi-release support. On the upside, I suppose it would make debugging easier. But as far as I can tell, the only reason for doing it with the service loader is to make OSGi &quot;happy&quot;.&lt;/p&gt;</comment>
                            <comment id="15931956" author="io7m" created="Sun, 19 Mar 2017 20:45:44 +0000"  >&lt;p&gt;I don&apos;t want to be seen as strongly suggesting you should or shouldn&apos;t do anything: I don&apos;t know enough about your particular case. Some projects want to use multi-release jars to deliver code that is present on both (Java &amp;lt; 9) and (Java &amp;gt;= 9). Other projects want to use multi-release jars to deliver code that has extra functionality on (Java &amp;gt;= 9). An example of the latter is the LWJGL project: They use the new stack-walking API for performance reasons if it&apos;s available, but if it isn&apos;t, the code works but more slowly.&lt;/p&gt;

&lt;p&gt;If I was dealing with situations like the above, I think I&apos;d do the following:&lt;/p&gt;

&lt;p&gt;1. Work out what kind of API my optional code needed. This is the &quot;provider&quot; API; the API that the main module uses to communicate with its own optional functionality. I&apos;d define it as a set of interfaces and publish them in an API jar (call it &quot;api.jar&quot;). I&apos;d write an OSGi manifest that exported the API, and a Java 9 module descriptor that exported the API in the same manner.&lt;/p&gt;

&lt;p&gt;2. Write a (Java &amp;lt; 9) implementation of that API and publish it in its own jar (call it &quot;jdk8.jar&quot;). I&apos;d write an OSGi manifest that publishes my implementation as providing the services declared in &quot;api.jar&quot; and declare it as requiring a runtime environment of (Java &amp;lt; 9). I&apos;d add META-INF/service/* files that publish the implementation as normal Java services.&lt;/p&gt;

&lt;p&gt;3. Write a (Java &amp;gt;= 9) implementation of that API and publish it in its own jar (call it &quot;jdk9.jar&quot;). I&apos;d write an OSGi manifest that publishes my implementation as providing the services declared in &quot;api.jar&quot; and declare it as requiring a runtime environment of (Java &amp;gt;= 9). I&apos;d add a Java 9 module descriptor that states that it provides the services defined in the API jar.&lt;/p&gt;

&lt;p&gt;I believe with this arrangement that an OSGi container would then automatically pick up the right implementation based on the current Java environment and the information in the manifest.&lt;/p&gt;

&lt;p&gt;Outside of an OSGi container, with a (Java &amp;lt; 9) environment and all of the jars placed on the class path, only the implementation in &quot;jdk8.jar&quot; will be picked up (because the &quot;jdk9.jar&quot; only declares services via the module descriptor).&lt;/p&gt;

&lt;p&gt;Outside of an OSGi container, with a (Java &amp;gt;= 9) environment and all of the jars placed on the &lt;b&gt;module&lt;/b&gt; path, I believe only the &quot;jdk9.jar&quot; implementation will be picked up. I&apos;m not exactly certain on this as there may be some interaction with Java 9&apos;s &quot;automodules&quot; system. Best case, only the (Java &amp;gt; 9) service implementation will be picked up. Worst case, they&apos;ll both be picked up and it&apos;ll be the responsibility of the service consumer to pick the &quot;better&quot; implementation. You&apos;d need a method defined on the API to allow implementations to be ranked in some manner.&lt;/p&gt;

&lt;p&gt;It&apos;s certainly more work than multi-release jars but, in my opinion it&apos;s a more disciplined approach. It makes optional and possibly platform-specific dependencies explicit and uses a well-understood API (ServiceLoader) to work with the code instead of, for example, resorting to class path and reflection hacks. This is the standard way to represent optional functionality (or multiple implementations) in OSGi and I would guess that it&apos;ll become the recommended way to do things in Java 9 as it appears to be heavily influenced by the methodologies people have arrived at on the OSGi side. Java 9&apos;s module system appears to be a simpler and far less dynamic clone of OSGi in most aspects, so the same techniques tend to apply.&lt;/p&gt;</comment>
                            <comment id="15931968" author="io7m" created="Sun, 19 Mar 2017 21:15:56 +0000"  >&lt;p&gt;Er, to clarify, ServiceLoader isn&apos;t used in OSGi. Generally though, if a piece of code is written to work well with the ServiceLoader API, then it can be made to work under OSGi with next to no effort. With OSGi&apos;s &quot;declarative services&quot;, it&apos;s just a couple of annotations that aren&apos;t retained in any form (they&apos;re used to generate a small piece of XML metadata that&apos;s injected into the jar file and used by the OSGi container).&lt;/p&gt;</comment>
                            <comment id="15931972" author="ralph.goers@dslextreme.com" created="Sun, 19 Mar 2017 21:33:19 +0000"  >&lt;p&gt;Interestingly, we want to use a multi-release jar for exactly the same reason as LWJGL. Log4j 2 has to walk the stack to get location information into the logs. &lt;/p&gt;

&lt;p&gt;A major problem with your proposal is we don&apos;t want more jars. We have an API jar and an impl jar and then jars for a whole bunch of optional things. We don&apos;t want users on Java 9 to have to include an extra jar to get better performance, nor do we want user&apos;s to have to pick and choose between jars that are compiled for their environment. Log4j 2 as a whole compiles with Java 7. To get the build to work I did have to create a maven module that compiles with Java 9, but the classes generated there are copied into either the API or impl jar as appropriate. &lt;/p&gt;

&lt;p&gt;This all works fine except for the Maven bundle plugin.&lt;/p&gt;</comment>
                            <comment id="16234719" author="dmlloyd" created="Wed, 1 Nov 2017 20:42:18 +0000"  >&lt;p&gt;We (JBoss) are also moving to multi-release JARs for many of our projects.  Those projects which use the maven-bundle-plugin will lose OSGi support until this issue is resolved.&lt;/p&gt;</comment>
                            <comment id="16234728" author="ralph.goers@dslextreme.com" created="Wed, 1 Nov 2017 20:49:22 +0000"  >&lt;p&gt;As of Log4j 2.9 Log4j has been using multi-release jars so this problem could be impacting users even if they aren&apos;t migrating to Java 9.&lt;/p&gt;</comment>
                            <comment id="16281065" author="nbartlett" created="Wed, 6 Dec 2017 22:52:50 +0000"  >&lt;p&gt;The underlying issue to be fixed is in bnd, which is consumed by maven-bundle-plugin (and other tools). I have raised the following issue: &lt;a href=&quot;https://github.com/bndtools/bnd/issues/2227&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/bndtools/bnd/issues/2227&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16281169" author="nbartlett" created="Thu, 7 Dec 2017 00:11:25 +0000"  >&lt;p&gt;You can continue using the maven-bundle-plugin with your multi-release JARs by adding the following configuration:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;          &amp;lt;configuration&amp;gt;
            &amp;lt;instructions&amp;gt;
              &amp;lt;_fixupmessages&amp;gt;&quot;Classes found in the wrong directory&quot;;is:=warning&amp;lt;/_fixupmessages&amp;gt;
            &amp;lt;/instructions&amp;gt;
          &amp;lt;/configuration&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that the Java-9-specific parts will not be visible in OSGi, because OSGi will need enhancements to its runtime (the problem is that the Java 9 parts could have different dependencies, and OSGi does not support dependencies that are conditional upon the runtime Java version). Work on addressing this limitation is underway. In the meantime, the above snippet will allow you to keep using the maven-bundle-plugin to support OSGi users running on Java 8 and below.&lt;/p&gt;</comment>
                            <comment id="16281183" author="dmlloyd" created="Thu, 7 Dec 2017 00:36:52 +0000"  >&lt;p&gt;Great tip Neil, thanks.  That at least might be enough to let our builds actually complete.&lt;/p&gt;</comment>
                            <comment id="16281871" author="ralph.goers@dslextreme.com" created="Thu, 7 Dec 2017 13:55:13 +0000"  >&lt;p&gt;I also had to add &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &amp;lt;dependencies&amp;gt;
          &amp;lt;dependency&amp;gt;
            &amp;lt;groupId&amp;gt;biz.aQute.bnd&amp;lt;/groupId&amp;gt;
            &amp;lt;artifactId&amp;gt;biz.aQute.bndlib&amp;lt;/artifactId&amp;gt;
            &amp;lt;version&amp;gt;3.5.0&amp;lt;/version&amp;gt;
          &amp;lt;/dependency&amp;gt;
        &amp;lt;/dependencies&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;to my plugin declaration to ignore the maven-info.java file.&lt;/p&gt;</comment>
                            <comment id="16281994" author="nbartlett" created="Thu, 7 Dec 2017 15:23:09 +0000"  >&lt;p&gt;Thanks Ralph. That last part is because the processing of module-info.class was fixed in bnd 3.4.0 but there has not been a release of maven-bundle-plugin. In the meantime bnd has released version 3.5.0.&lt;/p&gt;

&lt;p&gt;Can we have a new release of maven-bundle-plugin please?? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16282115" author="karlpauls" created="Thu, 7 Dec 2017 16:37:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nbartlett&quot; class=&quot;user-hover&quot; rel=&quot;nbartlett&quot;&gt;nbartlett&lt;/a&gt;, can you create an issue and do the update? If so, I can do a new release.&lt;/p&gt;</comment>
                            <comment id="16291110" author="karlpauls" created="Thu, 14 Dec 2017 16:19:04 +0000"  >&lt;p&gt;This should be fixed with the upcomming maven-bundle-plugin 3.4.0 release - where by &quot;fixed&quot; I mean it should at least allow to build with multi-release jars. Ultimately, we will need some spec level support to fully support multi-release jars (see the bnd issues mentioned) but that might be in the works.&lt;/p&gt;

&lt;p&gt;I&apos;m resolving this issue as fixed for now as the problem should have gone away. When we know how spec level support might look like we need to open a new issue to implement the changes. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13123692">FELIX-5760</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13041025">FELIX-5527</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13580464">FELIX-6708</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 48 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3chkn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>