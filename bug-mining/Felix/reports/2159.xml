<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:53:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-4190] The framework should not hold any lock while calling ServiceFactory#unget</title>
                <link>https://issues.apache.org/jira/browse/FELIX-4190</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description></description>
                <environment></environment>
        <key id="12661400">FELIX-4190</key>
            <summary>The framework should not hold any lock while calling ServiceFactory#unget</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gnodet">Guillaume Nodet</assignee>
                                    <reporter username="gnodet">Guillaume Nodet</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Aug 2013 13:20:21 +0000</created>
                <updated>Mon, 27 Apr 2015 07:05:50 +0000</updated>
                            <resolved>Wed, 12 Mar 2014 20:08:21 +0000</resolved>
                                                    <fixVersion>framework-4.4.0</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13727714" author="rickhall" created="Fri, 2 Aug 2013 14:51:32 +0000"  >&lt;p&gt;Reiterating a comment from email:&lt;/p&gt;

&lt;p&gt;Technically, I think this patch is not correct.&lt;/p&gt;

&lt;p&gt;We specifically allow for bundles that already hold the service reference to acquire the service object while a service is being unregistered (see comments in ServiceRegistry.unregisterService()). This means that a bundle that already holds the service reference could, technically, acquire the unregistering service just after you call getUsingBundles(), thus we wouldn&apos;t be forcing it to unget.&lt;/p&gt;

&lt;p&gt;The only way I think we can do what you want is to somehow acquire the registry lock (i.e., this) again and put us into some new state that doesn&apos;t allow any more bundles to acquire the unregistering service...or perhaps by adding something to the service registration to put it into a new state where it won&apos;t return anything from getService. Then we could release the registry lock and continue with what you have. &lt;/p&gt;</comment>
                            <comment id="13727733" author="rickhall" created="Fri, 2 Aug 2013 15:34:10 +0000"  >&lt;p&gt;We probably need some discussion about the issue I raised before closing this bug.&lt;/p&gt;</comment>
                            <comment id="13728091" author="gnt" created="Fri, 2 Aug 2013 20:52:13 +0000"  >&lt;p&gt;I suggest you revert the patch if you want until further discussed as I&apos;ll be in vacation for the next weeks and won&apos;t be able to actually do anything nor discuss that further.&lt;/p&gt;

&lt;p&gt;Another option might be to duplicate the loop after having invalidated the registration to get rid of possible new references acquired while processing the ServiceEvent.UNREGISTERING or just before the service registration has been invalidated.  That would avoid grabbing the lock again I think.&lt;/p&gt;</comment>
                            <comment id="13728122" author="rickhall" created="Fri, 2 Aug 2013 21:08:10 +0000"  >&lt;p&gt;I won&apos;t revert it, since I don&apos;t expect it will cause any issues in normal usage. We can just think about how to fix it when you are back. It is a little tricky, though.&lt;/p&gt;</comment>
                            <comment id="13731347" author="djencks" created="Tue, 6 Aug 2013 21:51:30 +0000"  >&lt;p&gt;I agree with Richard that this is not a satisfactory patch.  This is a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-3687&quot; title=&quot;Deadlock potential from ServiceRegistry.unregisterService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-3687&quot;&gt;&lt;del&gt;FELIX-3687&lt;/del&gt;&lt;/a&gt; where I proposed another unsatisfactory patch and determined that Richard&apos;s suggestion wouldn&apos;t work.  I have a further proposal there that I still think might work.&lt;/p&gt;</comment>
                            <comment id="13910322" author="gnt" created="Mon, 24 Feb 2014 14:03:48 +0000"  >&lt;p&gt;So I come back to my earlier proposal which is to duplicate the loop at the end after having invalidted the registration.&lt;br/&gt;
I.e. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-comment&quot;&gt;// Now forcibly unget the service object &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; all stubborn clients.
&lt;/span&gt;        Bundle[] clients = getUsingBundles(reg.getReference());
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; (clients != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &amp;amp;&amp;amp; (i &amp;lt; clients.length); i++)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (ungetService(clients[i], reg.getReference()))
                ; &lt;span class=&quot;code-comment&quot;&gt;// Keep removing until it is no longer possible
&lt;/span&gt;        }
        ((ServiceRegistrationImpl) reg).invalidate();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; (clients != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &amp;amp;&amp;amp; (i &amp;lt; clients.length); i++)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (ungetService(clients[i], reg.getReference()))
                ; &lt;span class=&quot;code-comment&quot;&gt;// Keep removing until it is no longer possible
&lt;/span&gt;        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The call to getUsingBundles does not need to be synchronized, as the method itself synchronizes on this.&lt;br/&gt;
At this point, no new bundles can acquire a service reference, so we can keep the list of bundles and iterator on it safely.&lt;br/&gt;
Then, we do a first pass on ungetService which should remove most of the references, except if a bundle is re-acquiring the service.&lt;br/&gt;
We then invalidate the registration, which will prevent any further call to getService.&lt;br/&gt;
We iterate another time on the bundles in case a bundle has acquired the service during the first loop.&lt;/p&gt;</comment>
                            <comment id="13930291" author="rickhall" created="Tue, 11 Mar 2014 12:48:03 +0000"  >&lt;p&gt;I believe duplicating the loop would work. The first loop tries to be friendly, then the call to invalidate() makes it impossible to get the service object again, and then finally the second loop deals more harshly with clients who won&apos;t let go.&lt;/p&gt;</comment>
                            <comment id="13930818" author="djencks" created="Tue, 11 Mar 2014 19:23:23 +0000"  >&lt;p&gt;I&apos;m ok with the duplicated loop.&lt;/p&gt;</comment>
                            <comment id="13932284" author="gnt" created="Wed, 12 Mar 2014 20:08:21 +0000"  >&lt;p&gt;Sending        framework/src/main/java/org/apache/felix/framework/ServiceRegistry.java&lt;br/&gt;
Transmitting file data .&lt;br/&gt;
Committed revision 1576875.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://svn.apache.org/viewvc?view=revision&amp;amp;revision=1576875&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/viewvc?view=revision&amp;amp;revision=1576875&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12609456">FELIX-3687</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>341589</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 36 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1mwtr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>341896</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>