<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:20:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-2653] LinkageError caused by duplicate class definition during implicit boot delegation</title>
                <link>https://issues.apache.org/jira/browse/FELIX-2653</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;I am seeing linkage errors caused by attempt to load duplicate classes and I think it is caused by implicit boot delegation. In our server log, we see the following exception stack:&lt;/p&gt;

&lt;p&gt;java.lang.LinkageError: loader (instance of  java/net/URLClassLoader): attempted  duplicate class definition for name: &quot;com/acme/Foo&quot;&lt;br/&gt;
	at java.lang.ClassLoader.defineClass1(Native Method)&lt;br/&gt;
	at java.lang.ClassLoader.defineClassCond(ClassLoader.java:632)&lt;br/&gt;
	at java.lang.ClassLoader.defineClass(ClassLoader.java:616)&lt;br/&gt;
	at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:141)&lt;br/&gt;
	at java.net.URLClassLoader.defineClass(URLClassLoader.java:283)&lt;br/&gt;
	at java.net.URLClassLoader.access$000(URLClassLoader.java:58)&lt;br/&gt;
	at java.net.URLClassLoader$1.run(URLClassLoader.java:197)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at java.net.URLClassLoader.findClass(URLClassLoader.java:190)&lt;br/&gt;
	at java.lang.ClassLoader.loadClass(ClassLoader.java:307)&lt;br/&gt;
	at java.lang.ClassLoader.loadClass(ClassLoader.java:248)&lt;br/&gt;
	at com.acme.Foo$Factory.bar(Foo.java:93)&lt;/p&gt;

&lt;p&gt;I tried to trace the execution to find out what causes the class to be defined for the first time and with the help of btrace (&lt;a href=&quot;http://projectkenai.com/projects/btrace/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://projectkenai.com/projects/btrace/&lt;/a&gt;), I could obtain the stack and relevant information. First time the class is defined, the stack looks like this:&lt;/p&gt;

&lt;p&gt;java.security.SecureClassLoader.defineClass(SecureClassLoader.java:141)&lt;br/&gt;
java.net.URLClassLoader.defineClass(URLClassLoader.java:283)&lt;br/&gt;
java.net.URLClassLoader.access$000(URLClassLoader.java:58)&lt;br/&gt;
java.net.URLClassLoader$1.run(URLClassLoader.java:197)&lt;br/&gt;
java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
java.net.URLClassLoader.findClass(URLClassLoader.java:190)&lt;br/&gt;
java.lang.ClassLoader.loadClass(ClassLoader.java:307)&lt;br/&gt;
java.lang.ClassLoader.loadClass(ClassLoader.java:248)&lt;br/&gt;
org.apache.felix.framework.ModuleImpl.getEnclosingClass(ModuleImpl.java:1570)&lt;br/&gt;
org.apache.felix.framework.ModuleImpl.isClassNotLoadedFromBundle(ModuleImpl.java:1545)&lt;br/&gt;
org.apache.felix.framework.ModuleImpl.doImplicitBootDelegation(ModuleImpl.java:1498)&lt;br/&gt;
org.apache.felix.framework.ModuleImpl.searchDynamicImports(ModuleImpl.java:1452)&lt;br/&gt;
org.apache.felix.framework.ModuleImpl.findClassOrResourceByDelegation(ModuleImpl.java:727)&lt;br/&gt;
org.apache.felix.framework.ModuleImpl.access$300(ModuleImpl.java:73)&lt;br/&gt;
org.apache.felix.framework.ModuleImpl$ModuleClassLoader.loadClass(ModuleImpl.java:1733)&lt;br/&gt;
java.lang.ClassLoader.loadClass(ClassLoader.java:248)&lt;br/&gt;
org.apache.felix.framework.ModuleImpl.getClassByDelegation(ModuleImpl.java:638)&lt;br/&gt;
org.apache.felix.framework.Felix.loadBundleClass(Felix.java:1599)&lt;br/&gt;
org.apache.felix.framework.BundleImpl.loadClass(BundleImpl.java:904)&lt;br/&gt;
org.jvnet.hk2.osgiadapter.OSGiModuleImpl$3$1.run(OSGiModuleImpl.java:399)&lt;br/&gt;
java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
org.jvnet.hk2.osgiadapter.OSGiModuleImpl$3.loadClass(OSGiModuleImpl.java:395)&lt;br/&gt;
java.lang.ClassLoader.loadClass(ClassLoader.java:248)&lt;br/&gt;
com.sun.enterprise.v3.server.APIClassLoaderServiceImpl$APIClassLoader.loadClass(APIClassLoaderServiceImpl.java:169)&lt;br/&gt;
java.lang.ClassLoader.loadClass(ClassLoader.java:296)&lt;br/&gt;
java.lang.ClassLoader.loadClass(ClassLoader.java:248)&lt;br/&gt;
com.acme.Foo$Factory.bar(Foo.java:93)&lt;/p&gt;

&lt;p&gt;As you can see, when bar method is called, VM tries to load com.acme.Foo.class and the call reaches org.apache.felix.framework.ModuleImpl.getEnclosingClass. getEnclosingClass actually causes the enclosing class, com.acme.Foo, to be defined. So, VM actually records this new class in loaded classes cache of the appropriate loader, but Felix does not consult the loaded classes cache again before trying to define the class. &lt;/p&gt;</description>
                <environment>java version &amp;quot;1.6.0_21&amp;quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.6.0_21-b06)&lt;br/&gt;
Java HotSpot(TM) Server VM (build 17.0-b16, mixed mode)&lt;br/&gt;
</environment>
        <key id="12477122">FELIX-2653</key>
            <summary>LinkageError caused by duplicate class definition during implicit boot delegation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rickhall">Richard S. Hall</assignee>
                                    <reporter username="sahoo">Sanjeeb Kumar Sahoo</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Oct 2010 10:19:03 +0000</created>
                <updated>Fri, 15 Oct 2010 18:03:27 +0000</updated>
                            <resolved>Tue, 12 Oct 2010 19:40:42 +0000</resolved>
                                    <version>framework-3.0.4</version>
                                    <fixVersion>framework-3.0.5</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12920190" author="rickhall" created="Tue, 12 Oct 2010 13:41:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://glassfish.dev.java.net/issues/show_bug.cgi?id=13587&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://glassfish.dev.java.net/issues/show_bug.cgi?id=13587&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12920275" author="sahoo" created="Tue, 12 Oct 2010 17:44:43 +0000"  >&lt;p&gt;Fixed the description. I had incorrectly mentioned that VM was trying to load com.acme.Foo$Factory. Instead, VM tried to load com.acme.Foo.&lt;/p&gt;</comment>
                            <comment id="12920279" author="sahoo" created="Tue, 12 Oct 2010 17:51:16 +0000"  >&lt;p&gt;Felix indeed consults loaded classes cache right before it defines the class, but despite that duplicate class error is thrown, because the class loader that actually defines the class com.acme.Foo is some other class loader. Richard told me the real issue was in &quot;implicit delegation code,&quot; as it has failed to identify certain classes in the call stack as loaded by Felix.&lt;/p&gt;</comment>
                            <comment id="12920319" author="rickhall" created="Tue, 12 Oct 2010 19:35:22 +0000"  >&lt;p&gt;I am not sure why we get the LinkageError. It seems that URLClassLoader or SecureClassLoader don&apos;t expect anyone to jump in front of them and define a class. In the case of the Felix module class loader, we do expect this and do a double-check just before calling defineClass().&lt;/p&gt;

&lt;p&gt;Regardless, while debugging I noticed it looks like we were implicitly boot delegating when we shouldn&apos;t be, which resulted in this situation. We are only supposed to implicitly boot delegate if a non-bundle-loaded class (e.g., one from the app or boot class path) is trying to load a class from a bundle. The module class loader was implicitly boot delegating as long as there was any non-bundle-loaded class on the call stack, when in reality it should have failed implicit boot delegation as soon as it found any bundle-loaded class on the stack.&lt;/p&gt;

&lt;p&gt;I have committed a patch which appears to resolve this particular issue, but it is not clear to me if the same time of LinkageError couldn&apos;t occur in a different scenario if the JRE class loaders don&apos;t double check loaded classes.&lt;/p&gt;</comment>
                            <comment id="12920320" author="rickhall" created="Tue, 12 Oct 2010 19:40:42 +0000"  >&lt;p&gt;Patch passes OSGi CT, internal tests, and GF tests. Please close if satisfied. Thanks.&lt;/p&gt;</comment>
                            <comment id="12920984" author="sahoo" created="Thu, 14 Oct 2010 15:33:21 +0000"  >&lt;p&gt;Fixed a typo in method name.&lt;/p&gt;</comment>
                            <comment id="12920997" author="rickhall" created="Thu, 14 Oct 2010 16:02:17 +0000"  >&lt;p&gt;Just some more summary, it appears that the situation is such that we are getting a request for a class that a bundle shouldn&apos;t have. However, as part of our normal processing of a failed class request we try to determine if we should implicitly boot delegate if the request was coming from external code. In this particular scenario we ended up causing the class being requested to be defined as a byproduct in getEnclosingClass(). Thus, when we get back to the original class loader, it has already checked for the class and doesn&apos;t check again, so it gets a duplicate definition error. I&apos;m not sure if we can resolve this in a general way.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40496</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 6 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ar0n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>60650</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>