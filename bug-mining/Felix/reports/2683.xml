<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:03:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5337] Filter-based dependencies working differently for annotations</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5337</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;I&apos;ve got a &quot;catch all&quot; service dependency that simply wants to see &lt;b&gt;all&lt;/b&gt; services being registered. In the activator based implementation I simply express my dependency as &lt;tt&gt;createServiceDependency().setService(&quot;(objectClass=*)&quot;).setRequired(false).setCallbacks(&quot;addService&quot;, &quot;removeService&quot;)&lt;/tt&gt; and I get all services I&apos;m interested in (I mean: each and every registered service).&lt;/p&gt;

&lt;p&gt;However, if I rewrite my code to use annotations using &lt;tt&gt;@ServiceDependency(filter=&quot;(objectClass=*)&quot;, required = false, removed = ...)&lt;/tt&gt;, I suddenly do not see all services I expect: only services that seem to be compatible with the class-space of the bundle my code lives in.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13000459">FELIX-5337</key>
            <summary>Filter-based dependencies working differently for annotations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pderop">Pierre De Rop</assignee>
                                    <reporter username="jajans">J.W. Janssen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 26 Aug 2016 17:34:58 +0000</created>
                <updated>Sat, 12 Nov 2016 23:41:29 +0000</updated>
                            <resolved>Sat, 12 Nov 2016 23:41:28 +0000</resolved>
                                    <version>dependencymanager-4.3.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15440137" author="pderop" created="Fri, 26 Aug 2016 23:06:27 +0000"  >&lt;p&gt;thanks for reporting.&lt;/p&gt;

&lt;p&gt;I have reproduced the issue in &lt;a href=&quot;https://github.com/pderop/dm.felix5337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pderop/dm.felix5337&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In the project above, the two service.v1 and service.v2  bundles provides two versions of the same service.&lt;br/&gt;
Now, the catchall.withapi bundle uses the DM api and is able to lookup all services, including service.v1, and service.v2.&lt;/p&gt;

&lt;p&gt;the catchall.withapi does this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;		dm.add(createComponent()
				.setImplementation(CatchAll.class)
				.add(createServiceDependency().setService(&lt;span class=&quot;code-quote&quot;&gt;&quot;(objectClass=*)&quot;&lt;/span&gt;).setRequired(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;).setCallbacks(&lt;span class=&quot;code-quote&quot;&gt;&quot;addService&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;this is working fine. But the catchall.withannotation bundle does not work. It only catches one service, not all the others.&lt;br/&gt;
It does this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	@ServiceDependency(filter=&lt;span class=&quot;code-quote&quot;&gt;&quot;(objectClass=*)&quot;&lt;/span&gt;, required = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) 
	void addService(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; service, Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; properties) {
		&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Got service &quot;&lt;/span&gt; + service + &lt;span class=&quot;code-quote&quot;&gt;&quot; with properties: &quot;&lt;/span&gt; + properties);
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After investigating, it turns out that the issue is the following: the runtime infers the service type using the signature of the addService method. So, it internally uses the DM api and does this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;setService(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.class, &lt;span class=&quot;code-quote&quot;&gt;&quot;(objectClass=*)&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and this does not work: we don&apos;t catch all services, only one.&lt;/p&gt;

&lt;p&gt;So, to summarize, the following works (and this is what catchall.withapi does):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;createServiceDependency().setService(&lt;span class=&quot;code-quote&quot;&gt;&quot;(objectClass=*)&quot;&lt;/span&gt;).setRequired(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;).setCallbacks(...)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but the following does not work (this is what the runtime internally does):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;createServiceDependency().setService(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.class, &lt;span class=&quot;code-quote&quot;&gt;&quot;(objectClass=*)&quot;&lt;/span&gt;).setRequired(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;).setCallbacks(...)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I will continue to investigate this WE.&lt;/p&gt;</comment>
                            <comment id="15440163" author="pderop" created="Fri, 26 Aug 2016 23:18:13 +0000"  >&lt;p&gt;Jan Willem, there is a work around:&lt;/p&gt;

&lt;p&gt;if you uses a ServiceRefernce in the method signature, instead of Object, then it should work:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Component
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;CatchAll {	
	@ServiceDependency(filter=&lt;span class=&quot;code-quote&quot;&gt;&quot;(objectClass=*)&quot;&lt;/span&gt;, required = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) 
	void addService(ServiceReference service) {
		&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Got service &quot;&lt;/span&gt; + service);
	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this case, the runtime does not infer any service dependency type from the method signature, and internally does this, which works:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;createServiceDependency().setService(&lt;span class=&quot;code-quote&quot;&gt;&quot;(objectClass=*)&quot;&lt;/span&gt;).setRequired(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;).setCallbacks(...)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I will continue to investigate in order to see if a fix can be done (probably in the dm core, not in the runtime).&lt;/p&gt;</comment>
                            <comment id="15470196" author="pderop" created="Wed, 7 Sep 2016 09:57:53 +0000"  >&lt;p&gt;Hi Jan WIllem &lt;/p&gt;

&lt;p&gt;I have committed a candidate patch in 1759575, which seems to resolve the issue.&lt;br/&gt;
Can you please test it, and if it works in your side, then move this issue to resolved state ?&lt;/p&gt;

&lt;p&gt;thank you (and sorry to be late !).&lt;/p&gt;</comment>
                            <comment id="15470260" author="pderop" created="Wed, 7 Sep 2016 10:41:03 +0000"  >&lt;p&gt;Added test case:&lt;/p&gt;

&lt;p&gt;org.apache.felix.dependencymanager.runtime.itest/src/org/apache/felix/dm/runtime/itest/components/FELIX5337.java&lt;br/&gt;
org.apache.felix.dependencymanager.runtime.itest/src/org/apache/felix/dm/runtime/itest/tests/FELIX5337Test.java&lt;/p&gt;</comment>
                            <comment id="15657899" author="pderop" created="Fri, 11 Nov 2016 19:26:16 +0000"  >&lt;p&gt;I reverted the patch from revision 1759575 and uncommitted it (in revision 1769329).&lt;/p&gt;

&lt;p&gt;Indeed, it breaks the contract of the original ServiceDependency.SetService(Class&amp;lt;?&amp;gt; serviceName, String serviceFilter) in the DM api. Indeed, Dobias reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-5403&quot; title=&quot;Improve the Javadoc for org.apache.felix.dm.ComponentStateListener&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-5403&quot;&gt;&lt;del&gt;FELIX-5403&lt;/del&gt;&lt;/a&gt; that the following code which worked well before is not working anymore with the patch from rev 1759575:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;manager.createServiceDependency()
	.setService(StoreService.class, &lt;span class=&quot;code-quote&quot;&gt;&quot;(!(objectClass=&quot;&lt;/span&gt; + ConsequenceStoreService.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;))&quot;&lt;/span&gt;)
	.setCallbacks(&lt;span class=&quot;code-quote&quot;&gt;&quot;addStoreService&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;removeStoreService&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;swapStoreService&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Indeed, with the wrong patch, the filter is not extended anymore with the type of the serviceName (StoreService).&lt;/p&gt;

&lt;p&gt;Now, I will try to find a solution for the initial problem of this issue, which is: if you want to catch all services using the following code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	@ServiceDependency(filter=&lt;span class=&quot;code-quote&quot;&gt;&quot;(objectClass=*)&quot;&lt;/span&gt;, required = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) 
	void addService(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; service) {
		&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Got service &quot;&lt;/span&gt; + service);
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;then the problem is that the type of the &quot;addService&quot; parameter (Object) is used and the runtime then uses the following DM api method with the service type (Object), and the filter like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;createServiceDependency().setService(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.class, &lt;span class=&quot;code-quote&quot;&gt;&quot;(objectClass=*)&quot;&lt;/span&gt;).setRequired(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, the setService method then uses the following filter, which is not what we want since we need to catch all services:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;(&amp;amp;(objectClass=java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)(objectClass=*))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I have to think more about this issue.&lt;/p&gt;

&lt;p&gt;currently, the only work around is to use a ServiceReference in the addServiceParameter: in this case, since we can&apos;t infer the service type, we then end up using only the following DM api method, which works:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;createServiceDependency().setService(&lt;span class=&quot;code-quote&quot;&gt;&quot;(objectClass=*)&quot;&lt;/span&gt;).setRequired(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15660449" author="pderop" created="Sat, 12 Nov 2016 23:13:04 +0000"  >&lt;p&gt;Ok; so the contract of the @ServiceDependency is the same as the &quot;ServiceDependency.setService(Class serviceType, String filter)&quot; method in the DM API. So, the serviceType is inferred from the bind method or from the class field.&lt;/p&gt;

&lt;p&gt;Now, to allow to inject all services to a &quot;bind(Object service)&quot; callback, since we need to internally use the  &quot;ServiceDependency.setService(String filter)&quot; method from the DM API, I introduced a new &quot;Any&quot; marker interface in the ServiceDependency annotation, and you can now set the &quot;service&quot; attribute to it. This will make sure that the service type won&apos;t be inferred from the bind method parameters or from the field type:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@ServiceDenpendency(service=Any.class)
void bindServices(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; allServices) {
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Of course, you can specify a filter. In the following, all services having the foo=bar property will be injected:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@ServiceDenpendency(service=Any.class, filter=&lt;span class=&quot;code-quote&quot;&gt;&quot;(foo=bar)&quot;&lt;/span&gt;)
void bindServices(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; allServices) {
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;(committed patch in  revision 1769436). &lt;/p&gt;</comment>
                            <comment id="15660484" author="pderop" created="Sat, 12 Nov 2016 23:41:29 +0000"  >&lt;p&gt;added test: org.apache.felix.dependencymanager.runtime.itest/src/org/apache/felix/dm/runtime/itest/components/FELIX5337_MatchAllServicesWithFilter.java&lt;/p&gt;

&lt;p&gt;I think this issue is resolved.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 1 week, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i32v13:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>