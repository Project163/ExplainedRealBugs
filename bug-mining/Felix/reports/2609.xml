<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:00:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5204] IllegalStateException when using custom URL handlers for bundles</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5204</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;The following exception can happen after having restarted the whole framework.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.IllegalStateException: Stream handler unavailable.
	at org.apache.felix.framework.URLHandlersStreamHandlerProxy.getDefaultPort(URLHandlersStreamHandlerProxy.java:180)
	at java.net.URLStreamHandler.sameFile(URLStreamHandler.java:407)
	at org.osgi.service.url.AbstractURLStreamHandlerService.sameFile(AbstractURLStreamHandlerService.java:131)
	at java.net.URLStreamHandler.equals(URLStreamHandler.java:333)
	at org.osgi.service.url.AbstractURLStreamHandlerService.equals(AbstractURLStreamHandlerService.java:81)
	at org.apache.felix.framework.URLHandlersStreamHandlerProxy.equals(URLHandlersStreamHandlerProxy.java:163)
	at java.net.URL.equals(URL.java:870)
	at java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:940)
	at javax.crypto.JceSecurityManager.getCryptoPermission(JceSecurityManager.java:124)
	at javax.crypto.Cipher.getConfiguredPermission(Cipher.java:2587)
	at javax.crypto.Cipher.initCryptoPermission(Cipher.java:700)
	at javax.crypto.Cipher.chooseProvider(Cipher.java:863)
	at javax.crypto.Cipher.init(Cipher.java:1396)
	at javax.crypto.Cipher.init(Cipher.java:1327)
	at org.apache.sshd.common.cipher.BaseCipher.init(BaseCipher.java:60)
	at org.apache.karaf.shell.ssh.SshUtils.buildCiphers(SshUtils.java:89)
	at org.apache.karaf.shell.ssh.Activator.createSshServer(Activator.java:183)
	at org.apache.karaf.shell.ssh.Activator.doStart(Activator.java:111)
	at org.apache.karaf.util.tracker.BaseActivator.run(BaseActivator.java:233)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problems seems to be that the ProtectionDomain of the classes loaded from bundles do use the URL handler as their code source.  This means that any access to those URL will throw IllegalStateException after the framework has been shutdown.&lt;br/&gt;
The protection domain should use the url the jar from the filesystem for the code source url instead.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12946140">FELIX-5204</key>
            <summary>IllegalStateException when using custom URL handlers for bundles</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gnodet">Guillaume Nodet</assignee>
                                    <reporter username="gnodet">Guillaume Nodet</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Mar 2016 13:06:33 +0000</created>
                <updated>Thu, 5 Dec 2019 13:34:53 +0000</updated>
                            <resolved>Tue, 8 Mar 2016 08:43:56 +0000</resolved>
                                    <version>framework-5.4.0</version>
                                    <fixVersion>framework-5.6.0</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15175573" author="karlpauls" created="Wed, 2 Mar 2016 13:22:08 +0000"  >&lt;p&gt;I&apos;m not sure I completely understand what is going on just yet. There was some reason we did the protection domain code source the way it is. It&apos;s certainly possible that there is a bug somewhere which causes this issue but I&apos;m not sure just using the jar url from the filesystem is the correct fix... Could you describe the problem in a little more depth?&lt;/p&gt;</comment>
                            <comment id="15175719" author="gnt" created="Wed, 2 Mar 2016 14:50:07 +0000"  >&lt;p&gt;We use the Mina SSHD server in Karaf.&lt;br/&gt;
The problem happens when we restart the framework without restarting the JVM.  The reason is that the javax.crypto package has some internal cache about Cipher providers.  The providers are cached by the protection domain source code url.&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;http://hg.openjdk.java.net/jdk7/jdk7/jdk/file/9b8c96f96a0f/src/share/classes/javax/crypto/JceSecurityManager.java#l79&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hg.openjdk.java.net/jdk7/jdk7/jdk/file/9b8c96f96a0f/src/share/classes/javax/crypto/JceSecurityManager.java#l79&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here&apos;s what happens:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the JVM starts, the OSGi framework starts, the SSH bundle is installed with a &lt;tt&gt;mvn:org.apache.sshd/sshd-core/1.0.0&lt;/tt&gt; url (the url handler is an OSGi url handler, so provided by a pax-url bundle)&lt;/li&gt;
	&lt;li&gt;when the SSH server starts, the JceSecurityManager caches the Cipher provider with this url&lt;/li&gt;
	&lt;li&gt;the framework is restarted&lt;/li&gt;
	&lt;li&gt;when the SSH server starts again, the JceSecurityManager calls &lt;tt&gt;get&lt;/tt&gt; on the cache indexed by the URL, but the URL in the cache is no longer valid and the &lt;tt&gt;URLHandlersStreamHandlerProxy.equals&lt;/tt&gt; throws the exception indicated&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This obviously only happen when the bundle is installed with a &lt;tt&gt;mvn:org.apache.sshd/sshd-core/1.0.0&lt;/tt&gt; and not a &lt;tt&gt;&lt;a href=&quot;file:system/org/apache/sshd/sshd-core/1.0.0/sshd-core-1.0.0.jar&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:system/org/apache/sshd/sshd-core/1.0.0/sshd-core-1.0.0.jar&lt;/a&gt;&lt;/tt&gt; url.&lt;/p&gt;

&lt;p&gt;I think it&apos;s a bad idea that the BundleProtectionDomain uses a URL which may not be valid after the framework is shutdown. My initial thinking was to use the jar bundle revision path instead, something like &lt;tt&gt;&lt;a href=&quot;file:data/cache/bundle32/11.0/bundle.jar&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:data/cache/bundle32/11.0/bundle.jar&lt;/a&gt;&lt;/tt&gt;.&lt;br/&gt;
It seems that&apos;s the way Equinox works fwiw.&lt;br/&gt;
Especially, if the bundle is updated, I think the 2 code source should be different, and using the original location used to install / update the url does not bring this guarantee.  Using the bundle revision instead seems cleaner to me.&lt;/p&gt;</comment>
                            <comment id="15179580" author="gnt" created="Fri, 4 Mar 2016 08:55:50 +0000"  >&lt;p&gt;Proposed fix&lt;br/&gt;
   &lt;a href=&quot;https://github.com/gnodet/felix/commit/6a3ef75f278319a9a0b2a380bd25bed5e38d4a0c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/gnodet/felix/commit/6a3ef75f278319a9a0b2a380bd25bed5e38d4a0c&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15182886" author="karlpauls" created="Mon, 7 Mar 2016 11:15:47 +0000"  >&lt;p&gt;I did think about this issue for a while and I agree that there seems to be no really good solution for your special case. &lt;/p&gt;

&lt;p&gt;Just to make this clear so, we are talking about a special case that is the issue here where we are up against the Java standard libraries which unfortunately, one more time, don&#8217;t play well with dynamic applications &#8212; hence, I strongly suggest that this is not a bug in felix as such but more a feature request for a workaround that makes your scenario possible.&lt;/p&gt;

&lt;p&gt;In general though, I don&apos;t think using the cached location is the right thing to do. The cached location is meaningless as a code source for the actual purpose of having a code source. I realize that there are libraries out there that are misusing the code source as a way to get access to the source resources (as is the issue in your case) and that is why we have this somewhat roundabout way of doing things the way we do them to make this possible. However, you are running into yet a more complicated scenario where the code source is not valid anymore at the time it is used and there is very little we can do about it. &lt;/p&gt;

&lt;p&gt;Personally, I&#8217;d say that this is not our problem and the correct way of fixing this on your side is to provide the url handler you need as a built-in handler (i.e. use the jvm extension property to provide the handler). That would make your scenario work and is the correct way of doing it but assumes you have control over the jvm.  &lt;/p&gt;

&lt;p&gt;Given that limitation I&#8217;m not against doing what you are proposing as a workaround but I suggest we make it a real one i.e., by default we behave like we do currently and introduce a configuration property to switch to the cached url. &lt;/p&gt;

&lt;p&gt;If that would work for you, could you modify your patch so that it introduces a property to enable using cache urls only if it is set and otherwise keeps the current behavior including the handling of the &quot;reference:&quot; protocol that your current proposal seems to remove?&lt;/p&gt;</comment>
                            <comment id="15183181" author="gnt" created="Mon, 7 Mar 2016 16:02:39 +0000"  >&lt;p&gt;I&apos;ve pushed a new PR according to your comments:&lt;br/&gt;
   &lt;a href=&quot;https://github.com/gnodet/felix/tree/FELIX-5204&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/gnodet/felix/tree/FELIX-5204&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15183628" author="karlpauls" created="Mon, 7 Mar 2016 20:16:07 +0000"  >&lt;p&gt;Looks good to me.&lt;/p&gt;</comment>
                            <comment id="16988781" author="kwin" created="Thu, 5 Dec 2019 13:06:00 +0000"  >&lt;p&gt;Another use case for that property is using a custom JCE  provider (&lt;a href=&quot;https://docs.oracle.com/cd/E19830-01/819-4712/ablsc/index.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/cd/E19830-01/819-4712/ablsc/index.html&lt;/a&gt;) because Java is internally validating it via &lt;a href=&quot;https://github.com/openjdk/jdk/blob/7bf82983443025248a22949b22e5ce9f16744b60/src/java.base/share/classes/javax/crypto/JceSecurity.java.template#L261&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/openjdk/jdk/blob/7bf82983443025248a22949b22e5ce9f16744b60/src/java.base/share/classes/javax/crypto/JceSecurity.java.template#L261&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16988789" author="kwin" created="Thu, 5 Dec 2019 13:11:44 +0000"  >&lt;p&gt;The previous comment is wrong. It should instead say: Another use case is the Sling JCR Installer (&lt;a href=&quot;https://sling.apache.org/documentation/bundles/jcr-installer-provider.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://sling.apache.org/documentation/bundles/jcr-installer-provider.html&lt;/a&gt;) which places &quot;jcrinstall:&quot; prefixed URLs in the bundle location.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=karlpauls&quot; class=&quot;user-hover&quot; rel=&quot;karlpauls&quot;&gt;karlpauls&lt;/a&gt; Any idea how to register a URL handler at run time in Felix?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12862086">KARAF-3974</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12744659">FELIX-4658</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13272503">SLING-8877</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 49 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2u11r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>