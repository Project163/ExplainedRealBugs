<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:13:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5990] DM ServiceTracker memory leak</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5990</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;We have an old memory leak that comes from dependency manager 3.0.0 version, where the dm ServiceTracker does not remove the Set used to register highest tracked services when an optional ServiceDependency becomes unavailable.&lt;/p&gt;

&lt;p&gt;Here is the old code where the memory leak happens, in&#160;org.apache.felix.dm.tracker.ServiceTracker.java:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void addHighestTrackedCache(ServiceReference reference) {
    &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; serviceId = ServiceUtil.getServiceIdObject(reference);
    TreeSet services = (TreeSet) m_highestTrackedCache.get(serviceId);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (services == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    services = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TreeSet();
    m_highestTrackedCache.put(serviceId, services);
    }
    services.add(reference);
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void removeHighestTrackedCache(ServiceReference reference) {
    &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; serviceId = ServiceUtil.getServiceIdObject(reference);
    TreeSet services = (TreeSet) m_highestTrackedCache.get(serviceId);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (services != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        services.remove(reference);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, the removeHighestTrackedCache does not remove the TreeSet from the m_highestTrackedCache when it becomes empty. &lt;/p&gt;

&lt;p&gt;So, the memory leak happens in the following situation: you have a Consumer component which has an optional dependency on a Provider, and the Provider service disappears and reappears a huge number of time.&lt;/p&gt;

&lt;p&gt;The memory can grow slowly, but may lead to an OOM in case the framework is run for a very long time and if the Provider service is registered/unregistered a lot of time.&lt;/p&gt;

</description>
                <environment></environment>
        <key id="13201110">FELIX-5990</key>
            <summary>DM ServiceTracker memory leak</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pderop">Pierre De Rop</assignee>
                                    <reporter username="pderop">Pierre De Rop</reporter>
                        <labels>
                    </labels>
                <created>Wed, 28 Nov 2018 13:46:51 +0000</created>
                <updated>Sun, 2 Dec 2018 17:16:00 +0000</updated>
                            <resolved>Wed, 28 Nov 2018 14:14:10 +0000</resolved>
                                    <version>dependencymanager-3.0.0</version>
                                    <fixVersion>org.apache.felix.dependencymanager-r14</fixVersion>
                                    <component>Dependency Manager</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="16701903" author="pderop" created="Wed, 28 Nov 2018 13:48:30 +0000"  >&lt;p&gt;Attached oom.png, which is screenshot of memoryanalyzer.&lt;/p&gt;</comment>
                            <comment id="16701909" author="pderop" created="Wed, 28 Nov 2018 13:49:48 +0000"  >&lt;p&gt;Attached  dm.memoryleak.tgz, which is a simple project that is reproducing the issue.&lt;/p&gt;</comment>
                            <comment id="16701937" author="pderop" created="Wed, 28 Nov 2018 14:14:10 +0000"  >&lt;p&gt;Committed a fix in revision 1847643.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12949840" name="dm.memoryleak.tgz" size="54552" author="pderop" created="Wed, 28 Nov 2018 13:49:10 +0000"/>
                            <attachment id="12949839" name="oom.png" size="83071" author="pderop" created="Wed, 28 Nov 2018 13:48:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 51 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00yds:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>