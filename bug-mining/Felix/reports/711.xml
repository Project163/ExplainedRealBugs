<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:13:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-1578] FileInstall issue when updating already installed bundles at startup time</title>
                <link>https://issues.apache.org/jira/browse/FELIX-1578</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;I just got caught by a subtle issue regarding the way FileInstall updates already installed&lt;br/&gt;
bundles at startup time. (I don&apos;t cleanup the cache when starting Felix).&lt;/p&gt;

&lt;p&gt;(the pb only occurs at startup time).&lt;/p&gt;

&lt;p&gt;When the fwk is started, FileInstall does a lookup on all already deployed bundles (see&lt;br/&gt;
initializeCurrentManagedBundles method). This method relies on the Bundle.getLastModified() method&lt;br/&gt;
in order to store in the Artifact the lastModified date of the bundle. &lt;/p&gt;

&lt;p&gt;-&amp;gt; The issue is that the Bundle.getLastModified() method returns the last time the bundle was&lt;br/&gt;
   installed, not the time of the bundle&apos;s location file when the bundle was installed.&lt;/p&gt;

&lt;p&gt;In our application server, we deploy our bundles using unix RPMs..&lt;br/&gt;
But unfortunately, when RPMs are installed, the date of the bundles are not updated and are left to&lt;br/&gt;
RPM build time. &lt;/p&gt;

&lt;p&gt;Let&apos;s consider a simple scenario:&lt;/p&gt;

&lt;p&gt;1) Assuming that I have two rpms:&lt;/p&gt;

&lt;p&gt;   MyBundle-jar-1.0 (build time: Sep 01)&lt;br/&gt;
   MyBundle-jar-1.1 (build time: Sep 05)&lt;/p&gt;

&lt;p&gt;2) Now (Sep 10), I install MyBundle-jar-1.0 rpm (which build date is Sep 01)&lt;/p&gt;

&lt;p&gt;3) Now, I startup my fwk and FileInstall loads the MyBundle.jar bundle.&lt;br/&gt;
    When installed, the Bundle.getLastModified() method returns Sep 10 (and not Sep 01 ...)&lt;/p&gt;

&lt;p&gt;4) I stop my fwk.&lt;/p&gt;

&lt;p&gt;4) Later on, at Sep 20, I decide to install the latest rpm (MyBundle-jar-1.1).&lt;br/&gt;
   So, in the load directory, I have now the MyBundle.jar, but with the rpm build&lt;br/&gt;
   date: Sep 05 ...&lt;/p&gt;

&lt;p&gt;5) Now, I restart my fwk and here is the problem: FileInstall compares Bundle.lastModified() with&lt;br/&gt;
   the bundle file, which is older than the time when we previously installed the bundle:&lt;/p&gt;

&lt;p&gt;     MyBundle.jar -&amp;gt; Sep 05&lt;br/&gt;
     Bundle.getLastModified() -&amp;gt; Sep 10&lt;/p&gt;

&lt;p&gt;   and the bundle is not updated at startup. Notice that if I don&apos;t stop the fwk, then it&lt;br/&gt;
   works fine, and the bundle is updated. However, in development phase (while debugging),&lt;br/&gt;
   sometimes, we have to restart the fwk ...&lt;/p&gt;


&lt;p&gt;As a suggestion, attached to this issue a patch which seems to resolve the problem:&lt;br/&gt;
Could you please take a look at it (it&apos;s attached to this issue).&lt;br/&gt;
This patch is only a suggestion, and may be there are other simpler ways to solve the problem ... ?&lt;/p&gt;

&lt;p&gt;Here is what I have done in the patch: &lt;br/&gt;
-&amp;gt;&lt;/p&gt;

&lt;p&gt;When installing/updating bundles, I store the date of the actual bundle into a file,  in the &lt;br/&gt;
FileInstall&apos;s BundleContext (using BundleContext.getDataFile()).&lt;/p&gt;

&lt;p&gt;in Util.java, I&apos;ve added two new methods:&lt;br/&gt;
------------&lt;/p&gt;

&lt;p&gt;    /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Stores a lastModified date into a bundle context data file.&lt;/li&gt;
	&lt;li&gt;@param b The bundle whose lastModifed location file must be stored&lt;/li&gt;
	&lt;li&gt;@param date the lastModified date to be stored in bc&lt;/li&gt;
	&lt;li&gt;@param bc the FileInstall&apos;s bundle context where to store the lastModified date.&lt;br/&gt;
     */&lt;br/&gt;
    public static void setLastModified( Bundle b, long date, BundleContext bc )&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;    /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Returns the lastModified date of a bundle.&lt;/li&gt;
	&lt;li&gt;@param b the bundle whose lastModifed location file must be returned&lt;/li&gt;
	&lt;li&gt;@param bc the FileInstall&apos;s bundle context.&lt;/li&gt;
	&lt;li&gt;@return the lastModified date of the bundle b&lt;br/&gt;
     */&lt;br/&gt;
    public static long getLastModified( Bundle b, BundleContext bc )&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;in DirectoryWatcher.java:&lt;br/&gt;
------------------------&lt;/p&gt;

&lt;p&gt;1) in the initializeCurrentManagedBundles() method, instead of storing Bundle.getLastModified() in the artifact,&lt;br/&gt;
I load the bundle&apos;s lastModified date from the FileInstall&apos;s bundle context:&lt;/p&gt;

&lt;p&gt;svn diff -&amp;gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;artifact.setLastModified(bundles&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.getLastModified());&lt;br/&gt;
+            artifact.setLastModified(Util.getLastModified(bundles&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;, this.context));&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;2) when a new bundle is first installed, I store its lastModifed date into the FileInstall&apos;s bundle context file:&lt;/p&gt;

&lt;p&gt;svn diff -&amp;gt;&lt;br/&gt;
              bundle = context.installBundle(location, in);&lt;br/&gt;
+             Util.setLastModified( bundle, Util.getLastModified( path ), this.context );&lt;/p&gt;

&lt;p&gt;3) when the bundle is updated, I also store its lastModifed date in the FileInstall&apos;s bundle context:&lt;/p&gt;

&lt;p&gt;svn diff -&amp;gt;&lt;br/&gt;
              bundle.update(in);&lt;br/&gt;
+             Util.setLastModified(bundle, Util.getLastModified( path ), this.context);&lt;/p&gt;

&lt;p&gt;4) Finally, I also fixed the test which compares lastModifed dates without equality:&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (artifact.getLastModified() &amp;gt; Util.getLastModified(file))&lt;br/&gt;
+                            if (artifact.getLastModified() &amp;gt;= Util.getLastModified(file))&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This last fix avoid updating the bundle each time the fwk is restarted ...&lt;/p&gt;

&lt;p&gt;WDYT ?&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12435365">FELIX-1578</key>
            <summary>FileInstall issue when updating already installed bundles at startup time</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gnodet">Guillaume Nodet</assignee>
                                    <reporter username="pderop">Pierre De Rop</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Sep 2009 22:25:05 +0000</created>
                <updated>Tue, 13 Oct 2009 19:56:59 +0000</updated>
                            <resolved>Tue, 13 Oct 2009 19:56:59 +0000</resolved>
                                                    <fixVersion>fileinstall-2.0.4</fixVersion>
                                    <component>File Install</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12753862" author="pderop" created="Thu, 10 Sep 2009 22:25:51 +0000"  >&lt;p&gt;attached patch.&lt;/p&gt;</comment>
                            <comment id="12765207" author="gnt" created="Tue, 13 Oct 2009 19:56:59 +0000"  >&lt;p&gt;Committing to &lt;a href=&quot;https://svn.apache.org/repos/asf/felix/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/felix/trunk&lt;/a&gt; ...&lt;br/&gt;
	M	fileinstall/src/main/java/org/apache/felix/fileinstall/internal/Artifact.java&lt;br/&gt;
	M	fileinstall/src/main/java/org/apache/felix/fileinstall/internal/DirectoryWatcher.java&lt;br/&gt;
	M	fileinstall/src/main/java/org/apache/felix/fileinstall/internal/Scanner.java&lt;br/&gt;
	M	fileinstall/src/main/java/org/apache/felix/fileinstall/internal/Util.java&lt;br/&gt;
Committed r824895&lt;/p&gt;

&lt;p&gt;I&apos;ve reused your idea but instead of storing the last modified date, fileinstall now store the checksum which leads to more accurate results wrt to updates.&lt;br/&gt;
Please reopen if needed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12419228" name="FileInstall.patch.tgz" size="10094" author="pderop" created="Thu, 10 Sep 2009 22:25:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>57449</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 7 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0vvlb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>184091</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>