<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:49:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-4088] [DS] NPE from SCR service unregistration</title>
                <link>https://issues.apache.org/jira/browse/FELIX-4088</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;When uninstalling a set of bundles I get the following exception.&lt;/p&gt;

&lt;p&gt;ERROR: Bundle com.paremus.dosgi.topologymanager &lt;span class=&quot;error&quot;&gt;&amp;#91;101&amp;#93;&lt;/span&gt; EventDispatcher: Error during dispatch. (java.lang.NullPointerException)&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.felix.framework.util.Util.getWire(Util.java:335)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl$ServiceReferenceImpl.isAssignableTo(ServiceRegistrationImpl.java:493)&lt;br/&gt;
	at org.apache.felix.framework.util.Util.isServiceAssignable(Util.java:280)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:916)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4401)&lt;br/&gt;
	at org.apache.felix.framework.Felix.access$000(Felix.java:74)&lt;br/&gt;
	at org.apache.felix.framework.Felix$1.serviceChanged(Felix.java:390)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:151)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:127)&lt;br/&gt;
	at com.paremus.frameworkintercept.DelegatingServiceRegistration.unregister(DelegatingServiceRegistration.java:37)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.unregisterComponentService(AbstractComponentManager.java:470)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$Satisfied.deactivate(AbstractComponentManager.java:1074)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.deactivateInternal(AbstractComponentManager.java:338)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.ImmediateComponentManager.reconfigure(ImmediateComponentManager.java:414)&lt;br/&gt;
	at org.apache.felix.scr.impl.config.ConfiguredComponentHolder.configurationDeleted(ConfiguredComponentHolder.java:152)&lt;br/&gt;
	at org.apache.felix.scr.impl.config.ConfigurationComponentRegistry.configurationEvent(ConfigurationComponentRegistry.java:247)&lt;br/&gt;
	at org.apache.felix.cm.impl.ConfigurationManager$FireConfigurationEvent.run(ConfigurationManager.java:1832)&lt;br/&gt;
	at org.apache.felix.cm.impl.UpdateThread.run(UpdateThread.java:104)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:722)&lt;br/&gt;
ERROR: Bundle org.cauldron.newton.management.monitor &lt;span class=&quot;error&quot;&gt;&amp;#91;85&amp;#93;&lt;/span&gt; EventDispatcher: Error during dispatch. (java.lang.NullPointerException)&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.felix.framework.util.Util.getWire(Util.java:335)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl$ServiceReferenceImpl.isAssignableTo(ServiceRegistrationImpl.java:493)&lt;br/&gt;
	at org.apache.felix.framework.util.Util.isServiceAssignable(Util.java:280)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.invokeServiceListenerCallback(EventDispatcher.java:916)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireEventImmediately(EventDispatcher.java:793)&lt;br/&gt;
	at org.apache.felix.framework.util.EventDispatcher.fireServiceEvent(EventDispatcher.java:543)&lt;br/&gt;
	at org.apache.felix.framework.Felix.fireServiceEvent(Felix.java:4401)&lt;br/&gt;
	at org.apache.felix.framework.Felix.access$000(Felix.java:74)&lt;br/&gt;
	at org.apache.felix.framework.Felix$1.serviceChanged(Felix.java:390)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistry.unregisterService(ServiceRegistry.java:151)&lt;br/&gt;
	at org.apache.felix.framework.ServiceRegistrationImpl.unregister(ServiceRegistrationImpl.java:127)&lt;br/&gt;
	at com.paremus.frameworkintercept.DelegatingServiceRegistration.unregister(DelegatingServiceRegistration.java:37)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.unregisterComponentService(AbstractComponentManager.java:470)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager$Satisfied.deactivate(AbstractComponentManager.java:1074)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.AbstractComponentManager.deactivateInternal(AbstractComponentManager.java:338)&lt;br/&gt;
	at org.apache.felix.scr.impl.manager.ImmediateComponentManager.reconfigure(ImmediateComponentManager.java:414)&lt;br/&gt;
	at org.apache.felix.scr.impl.config.ConfiguredComponentHolder.configurationDeleted(ConfiguredComponentHolder.java:152)&lt;br/&gt;
	at org.apache.felix.scr.impl.config.ConfigurationComponentRegistry.configurationEvent(ConfigurationComponentRegistry.java:247)&lt;br/&gt;
	at org.apache.felix.cm.impl.ConfigurationManager$FireConfigurationEvent.run(ConfigurationManager.java:1832)&lt;br/&gt;
	at org.apache.felix.cm.impl.UpdateThread.run(UpdateThread.java:104)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;

&lt;p&gt;One of the bundles is an extender, that publishes a Configuration using Config Admin. This configuration is picked up by DS to create a new Service using a ManagedServiceFactory.&lt;/p&gt;

&lt;p&gt;At some point in the teardown I seem to be in the state where:&lt;/p&gt;

&lt;p&gt;1. The configuration is being deleted because the target bundle is being uninstalled&lt;br/&gt;
2. The Bundle containing the SCR component is being uninstalled&lt;br/&gt;
3. SCR is attempting to unregister the managed service because of the asynchronous notification from config admin.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure whether the fault lies with the core framework or with scr, or with config admin. My guess is that SCR is at fault for trying to unregister a service for an uninstalled bundle, but that the framework shouldn&apos;t be blowing up either. Config Admin is probably an innocent bystander. &lt;/p&gt;</description>
                <environment>MacOSX 8 processors; Felix Configuration Admin 1.2.8</environment>
        <key id="12649966">FELIX-4088</key>
            <summary>[DS] NPE from SCR service unregistration</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="djencks">David Jencks</assignee>
                                    <reporter username="timothyjward">Timothy James Ward</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 May 2013 17:39:26 +0000</created>
                <updated>Wed, 6 Aug 2014 02:35:58 +0000</updated>
                            <resolved>Wed, 6 Aug 2014 02:35:58 +0000</resolved>
                                    <version>framework-4.2.0</version>
                    <version> scr-1.6.0</version>
                                    <fixVersion>scr-1.8.0</fixVersion>
                                    <component>Declarative Services (SCR)</component>
                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13669555" author="djencks" created="Wed, 29 May 2013 18:38:32 +0000"  >&lt;p&gt;1. can you try using the current 1.8.0-SNAPSHOT ds?  1.6.0 isn&apos;t going to have anything fixed.&lt;br/&gt;
2. It looks like you&apos;ve interposed some paremus code in between DS and the felix framework (at com.paremus.frameworkintercept.DelegatingServiceRegistration.unregister(DelegatingServiceRegistration.java:37) ).  Can this be causing the problem?  For instance maybe the bundle stopping event isn&apos;t getting propagated correctly to DS due to wrapping.&lt;br/&gt;
3. do you really mean &quot;This configuration is picked up by DS to create a new Service using a ManagedServiceFactory&quot;?  Or do you mean the configuration has a pid or factory pid matching a DS component so DS uses the configuration to configure a component, sort of like a MSF?&lt;/p&gt;

&lt;p&gt;From your description I&apos;d expect that the bundle stopping event (synchronous) would be seen by DS and that would unregister the services for the bundle so that by the time the async configuration deleted event arrived there would be no more services for the bundle.  Can you make sure you have ds.loglevel=DEBUG and look in your logs to see if there&apos;s evidence of this happening?&lt;/p&gt;</comment>
                            <comment id="13669616" author="timothyjward" created="Wed, 29 May 2013 19:45:41 +0000"  >&lt;p&gt;1. I&apos;ll have a go with the latest snapshot and see what happens.&lt;/p&gt;

&lt;p&gt;2. The Paremus code doesn&apos;t do anything much beyond logging the call and then delegating. I don&apos;t see a way in which it could be introducing a thread switch, a delay, or that it could filter the event from DS. I&apos;ll make sure to keep an eye on it while continuing to debug.&lt;/p&gt;

&lt;p&gt;3. The configuration has a factory pid matching the name of the DS component, and the DS component has a configuration-policy of require:&lt;/p&gt;

&lt;p&gt;&amp;lt;scr:component xmlns:scr=&quot;http://www.osgi.org/xmlns/scr/v1.1.0&quot; name=&quot;com.paremus.packager.demos.derby.guard&quot; configuration-policy=&quot;require&quot; activate=&quot;activate&quot;&amp;gt;&lt;/p&gt;

&lt;p&gt;I&apos;ll try to collect some useful logs.&lt;/p&gt;

&lt;p&gt;Even if this does turn out to be fixed in a more recent SCR release it still might be worth putting a null check in the core framework. I was quite surprised to be able to get something so deep in the core to NPE!&lt;/p&gt;</comment>
                            <comment id="13669662" author="timothyjward" created="Wed, 29 May 2013 20:14:58 +0000"  >&lt;p&gt;It looks like it probably is a threading problem...&lt;/p&gt;

&lt;p&gt;I see the same error using the 1.7.0-SNAPSHOT build from this morning, but only sometimes.&lt;/p&gt;

&lt;p&gt;Most of the time I see the following instead:&lt;/p&gt;

&lt;p&gt;ERROR: &lt;span class=&quot;error&quot;&gt;&amp;#91;com.paremus.packager.demos.derby.guard(53)&amp;#93;&lt;/span&gt; Bundle is shut down for dependency driverHosting to (&amp;amp;(database.driver=derby)(version=10.9.1.0))&lt;br/&gt;
&lt;b&gt;ERROR&lt;/b&gt; Unexpected problem delivery configuration event to &lt;span class=&quot;error&quot;&gt;&amp;#91;org.osgi.service.cm.ConfigurationListener, id=199, bundle=158&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.felix.scr.impl.config.ConfigurationSupport.configureComponentHolder(ConfigurationSupport.java:113)&lt;br/&gt;
	at org.apache.felix.scr.impl.config.ConfigurationSupport.configurationEvent(ConfigurationSupport.java:246)&lt;br/&gt;
	at org.apache.felix.cm.impl.ConfigurationManager$FireConfigurationEvent.run(ConfigurationManager.java:1832)&lt;br/&gt;
	at org.apache.felix.cm.impl.UpdateThread.run(UpdateThread.java:104)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;


&lt;p&gt;If I turn on debug trace then I no longer see the problem at all, if I turn on info trace then I occasionally see the problem. Sorry, I know this isn&apos;t the most helpful of debug information!&lt;/p&gt;</comment>
                            <comment id="13669730" author="djencks" created="Wed, 29 May 2013 20:52:31 +0000"  >&lt;p&gt;I fixed the immediate problem in DS in your last stack trace, rev 1487635, have not tried again to upload a snapshot.  There might be further NPEs or problems in DS, if you could test that would be great &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;I think there is also a race in the framework between unregistering the service and shutting down the bundle.  I&apos;m hoping a more-framework-expert will take a look at this.&lt;/p&gt;</comment>
                            <comment id="13673330" author="timothyjward" created="Mon, 3 Jun 2013 17:16:17 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djencks&quot; class=&quot;user-hover&quot; rel=&quot;djencks&quot;&gt;djencks&lt;/a&gt; - I have run the scenario again with a local build of the latest SCR code and I&apos;m no longer seeing errors. Previously they were occurring about 75% of the time, and I&apos;ve run through 10 times since the update. This obviously doesn&apos;t guarantee that there isn&apos;t another race condition in the framework, but the fix you added has definitely improved things.&lt;/p&gt;</comment>
                            <comment id="13739376" author="fmeschbe" created="Wed, 14 Aug 2013 07:59:47 +0000"  >&lt;p&gt;I think this is not related to Config Admin 1.2.8. Do you mind if I move the reference from the &quot;affects&quot; field to the &quot;environment&quot; field ?&lt;/p&gt;</comment>
                            <comment id="13739450" author="timothyjward" created="Wed, 14 Aug 2013 09:42:28 +0000"  >&lt;p&gt;That&apos;s fine with me.&lt;/p&gt;</comment>
                            <comment id="13739454" author="fmeschbe" created="Wed, 14 Aug 2013 09:45:33 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=timothyjward&quot; class=&quot;user-hover&quot; rel=&quot;timothyjward&quot;&gt;timothyjward&lt;/a&gt;. Done.&lt;/p&gt;</comment>
                            <comment id="14087156" author="djencks" created="Wed, 6 Aug 2014 02:35:34 +0000"  >&lt;p&gt;need to set fix version&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>330293</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 16 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1kzen:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>330627</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>