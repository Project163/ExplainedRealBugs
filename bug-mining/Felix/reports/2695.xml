<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 16:03:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-5363] new URL(string) suffers under concurrency</title>
                <link>https://issues.apache.org/jira/browse/FELIX-5363</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;Under moderate concurrency (25threads) and frequent use of new java.net.URL(string) a bottleneck was seen with yourkit.  In one test involving HTML page generation new URL(url) was seen to take 20% of time (via yourkit).&lt;/p&gt;

&lt;p&gt;This was tracked to org.apache.felix.framework.URLHandlers.getFrameworkFromContext() URLHandlers.java which accounted for 99% of the time used by new URL(url).&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13007191">FELIX-5363</key>
            <summary>new URL(string) suffers under concurrency</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="karlpauls">Karl Pauls</assignee>
                                    <reporter username="rryan@adobe.com">Rob Ryan</reporter>
                        <labels>
                    </labels>
                <created>Fri, 23 Sep 2016 16:13:32 +0000</created>
                <updated>Fri, 24 Feb 2017 12:24:46 +0000</updated>
                            <resolved>Sun, 25 Sep 2016 22:17:26 +0000</resolved>
                                    <version>framework-5.4.0</version>
                                    <fixVersion>framework-5.6.1</fixVersion>
                                    <component>Framework</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15516867" author="rryan@adobe.com" created="Fri, 23 Sep 2016 16:14:22 +0000"  >&lt;p&gt;callees report from new URL(string) under moderate concurrency.&lt;/p&gt;</comment>
                            <comment id="15517219" author="karlpauls" created="Fri, 23 Sep 2016 18:38:19 +0000"  >&lt;p&gt;Hm, maybe I&apos;m reading this wrong but it looks to me like it isn&apos;t actually URLHandlersStreamHandlerProxy.getStreamHandlerService()  but rather URLHandlers.getFrameworkFromContext() which is the culprit (time v.s. own time). That would make sense to me as it is potentially a expensive call (depending on what you are doing, you might be able to disable the url handlers with felix.service.urlhandlers=false but that likely has to many sideeffects). &lt;/p&gt;

&lt;p&gt;However, you shouldn&apos;t necessarily run into the expensive part of it - are you running more than one framework at the same time? &lt;/p&gt;

&lt;p&gt;. &lt;/p&gt;</comment>
                            <comment id="15517245" author="rryan@adobe.com" created="Fri, 23 Sep 2016 18:49:36 +0000"  >&lt;p&gt;yes it is about getFrameworkFromContext. true. &lt;/p&gt;

&lt;p&gt;There is only one framework in this case.&lt;/p&gt;

&lt;p&gt;It doesn&apos;t appear to be a matter of expensive work, per se, rather expensive synchronization.  No time under getFrameworkFromContext is attributed to any called methods, and it starts with a synchronized block.  It appears likely that this call simply gets called enough that there are collisions enough to have java expand this particular synchronized block into a full (expensive) lock vs its usual cheaper treatment of synchronized blocks with low to no concurrency.&lt;/p&gt;


&lt;p&gt;Note: the raw yourkit data lists plently of java.* things so it isn&apos;t likely that any significant time is being misattributed to getFrameworkFromContext as opposed to a callee.&lt;/p&gt;</comment>
                            <comment id="15517287" author="karlpauls" created="Fri, 23 Sep 2016 19:06:22 +0000"  >&lt;p&gt;Yeah, thats why I was asking if you had more than one framework. As you don&apos;t, it pretty much must be just the double lock that needs to be acquired. This code was written before we had java.util.concurrent (or at least while we where still targeting &amp;lt; 1.5) but as we are past that it should be easy to make this bottleneck go away. &lt;/p&gt;

&lt;p&gt;Will you be able to run your set-up in question with a patched version of felix (if so, I&apos;ll try to get you a patch that hopefully performs better)? &lt;/p&gt;</comment>
                            <comment id="15517325" author="rryan@adobe.com" created="Fri, 23 Sep 2016 19:20:00 +0000"  >&lt;p&gt;I won&apos;t have availability for a few days, so no rush, but yes I&apos;m in a position to test a patch.&lt;/p&gt;</comment>
                            <comment id="15521509" author="karlpauls" created="Sun, 25 Sep 2016 22:17:26 +0000"  >&lt;p&gt;I did some testing on my local machine having some 25 threads create and connect about 4M urls in a tight loop and yes, while my system has 8 cores it never gets above 400%. &lt;/p&gt;

&lt;p&gt;I reworked the URLHandlers and related classes all the way down to the service lookup to be lock free on the lookup up path (i.e., the one needed for URL creation and usage) and now the test runs in about half the time. More importantly, it does max out all my cores - in other words, it probably would do even better with more cores available. &lt;/p&gt;

&lt;p&gt;As the ct and some other tests I run still pass I committed this in r1762242. &lt;/p&gt;

&lt;p&gt;Please try it out and if it works for you close this issue - otherwise, feel free to reopen with updated info on performance problems.&lt;/p&gt;

&lt;p&gt;In any case, good catch - this is definitely a good improvement. Thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                            <outwardlinks description="contains">
                                        <issuelink>
            <issuekey id="12723623">FELIX-4544</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12830079" name="Merged-callees.csv" size="1826" author="rryan@adobe.com" created="Fri, 23 Sep 2016 16:14:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 8 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i340hj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>