<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:17:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-1776] FileInstall starts already installed bundles twice</title>
                <link>https://issues.apache.org/jira/browse/FELIX-1776</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;This issue is described here: &lt;a href=&quot;http://www.mail-archive.com/dev@felix.apache.org/msg13194.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/dev@felix.apache.org/msg13194.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;When the fwk is started without cleaning the cache, and when some bundles are already installed,&lt;br/&gt;
then fileinstall starts them twice.&lt;/p&gt;

&lt;p&gt;Here is what I did in order to reproduce the problem&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I first did a simple &quot;Test&quot; bundle with the following activator:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;public class Activator implements BundleActivator {&lt;br/&gt;
  public void start(BundleContext ctx) throws Exception &lt;/p&gt;
{
    System.out.printlnp(&quot;start/version 1.0&quot;);
  }

&lt;p&gt;  public void stop(BundleContext ctx) throws Exception &lt;/p&gt;
{
    System.out.printlnp(&quot;stop/version 1.0&quot;);
  }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;in my &quot;bundle&quot; directory, I have:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;org.apache.felix.shell.tui-1.5.0-SNAPSHOT.jar&lt;br/&gt;
org.apache.felix.shell-1.5.0-SNAPSHOT.jar&lt;br/&gt;
org.apache.felix.bundlerepository-1.5.0-SNAPSHOT.jar&lt;br/&gt;
org.apache.felix.fileinstall-2.0.3-SNAPSHOT.jar&lt;br/&gt;
org.apache.felix.configadmin-1.2.7-SNAPSHOT.jar&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;in the directory which fileinstall polls for updated bundles, I only have my simple test.jar bundle:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;ls ./deploy&lt;br/&gt;
test.jar&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Now, I start the fwk (from the trunk) with a cleaned cache:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;rm -rf felix-cache&lt;br/&gt;
java -jar bin/felix.jar&lt;/p&gt;

{felix.fileinstall.poll (ms) = 2000, felix.fileinstall.dir = /home/nxuser/work/osgi/felix-trunk/main/deploy, felix.fileinstall.debug = -1, felix.fileinstall.bundles.new.start = true, felix.fileinstall.tmpdir = ./tmp, felix.fileinstall.filter = null}&lt;br/&gt;
-&amp;gt;&lt;br/&gt;
-&amp;gt; Installed deploy/test.jar&lt;br/&gt;
start/version 1.0&lt;br/&gt;
Started bundle: &lt;a href=&quot;file:/home/nxuser/work/osgi/felix-trunk/main/deploy/test.jar&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:/home/nxuser/work/osgi/felix-trunk/main/deploy/test.jar&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
- I stop the fwk, and recompile my test bundle&lt;br/&gt;
&lt;br/&gt;
- I restart the fwk, without cleaning the cache, and I have this&lt;br/&gt;
&lt;br/&gt;
java -jar bin/felix.jar&lt;br/&gt;
&lt;br/&gt;
Welcome to Felix&lt;br/&gt;
================&lt;br/&gt;
{felix.fileinstall.poll (ms) = 2000, felix.fileinstall.dir = /home/nxuser/work/osgi/felix-trunk/main/deploy, felix.fileinstall.debug = -1, felix.fileinstall.bundles.new.start = true, felix.fileinstall.tmpdir = ./tmp, felix.fileinstall.filter = null}
&lt;p&gt;Updated /home/nxuser/work/osgi/felix-trunk/main/deploy/test.jar&lt;br/&gt;
start/version 1.1&lt;br/&gt;
Started bundle: &lt;a href=&quot;file:/home/nxuser/work/osgi/felix-trunk/main/deploy/test.jar&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:/home/nxuser/work/osgi/felix-trunk/main/deploy/test.jar&lt;/a&gt;&lt;br/&gt;
-&amp;gt; A bundle with the same symbolic name (test.dm) and version (1.0) is already installed.  Updating this bundle instead.&lt;br/&gt;
stop/1.1&lt;br/&gt;
start/1.1&lt;br/&gt;
Installed deploy/test.jar&lt;br/&gt;
Started bundle: &lt;a href=&quot;file:/home/nxuser/work/osgi/felix-trunk/main/deploy/test.jar&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:/home/nxuser/work/osgi/felix-trunk/main/deploy/test.jar&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;I have attached a proposed patch to this issue, but please read it carefully because I am not sure about it.&lt;br/&gt;
Indeed, I suspect that the problem comes from the Scanner.run method, where the &quot;storedChecksums&quot; is removed from the map:&lt;/p&gt;


&lt;p&gt;        for (Iterator it = removed.iterator(); it.hasNext()&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
        {
            File file = (File) it.next();
            // Make sure we&apos;ll handle a file that has been deleted
            files.addAll(removed);
            // Remove no longer used checksums
            lastChecksums.remove(file);
            storedChecksums.remove(file); -&amp;gt; why doing so ? The getChecksum methods will returns 0
        }

&lt;p&gt;Because of the &quot;storedChecksums.remove(file)&quot; call, the scanner.getChecksum(File f) method always returns 0.&lt;br/&gt;
However, I&apos;m not sure if this is really the bug, but because of this checksum removal, DIrectoryWatcher is no longer able to retrieve the correct checksum for tracked bundles.&lt;/p&gt;

&lt;p&gt;So, I did the following safe patches in DirectoryWatcher.java and everything sounds to work fine now:&lt;br/&gt;
(in fact, I always call scanner.checksum(File) instead of scanner.getChecksum(File) ...)&lt;/p&gt;

&lt;p&gt;svn diff src/main/java/org/apache/felix/fileinstall/internal/DirectoryWatcher.java&lt;br/&gt;
@@ -297,7 +297,11 @@                                                                             &lt;br/&gt;
                 // File has been modified                                                       &lt;br/&gt;
                 if (exists &amp;amp;&amp;amp; artifact != null)                                                 &lt;br/&gt;
                 {                                                                               &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;artifact.setChecksum(scanner.getChecksum(file));&lt;br/&gt;
+                    if (artifact.getChecksum() == scanner.checksum(file)) 
{                     
+                        continue;                                                               
+                    }
&lt;p&gt;                                                                           &lt;br/&gt;
+                                                                                                &lt;br/&gt;
+                    artifact.setChecksum(scanner.checksum(file));                               &lt;br/&gt;
                     // If there&apos;s no listener, this is because this artifact has been installed before&lt;br/&gt;
                     // fileinstall has been restarted.  In this case, try to find a listener.         &lt;br/&gt;
                     if (artifact.getListener() == null)                                               &lt;br/&gt;
@@ -355,7 +359,7 @@&lt;br/&gt;
                     artifact.setJaredDirectory(jar);&lt;br/&gt;
                     artifact.setJaredUrl(jaredUrl);&lt;br/&gt;
                     artifact.setListener(listener);&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;artifact.setChecksum(scanner.getChecksum(file));&lt;br/&gt;
+                    artifact.setChecksum(scanner.checksum(file));&lt;br/&gt;
                     if (transformArtifact(artifact))&lt;br/&gt;
                     {&lt;br/&gt;
                         created.add(artifact);&lt;/li&gt;
&lt;/ul&gt;








&lt;p&gt;Now, there is another issue I noticed.&lt;br/&gt;
It&apos;s not related to the current issue, and it&apos;s another one:&lt;br/&gt;
in the Utils.java, the getBundleKey(Bundle b) returns a string which is supposed to uniquely identify the bundle &lt;br/&gt;
(that is: Bundle-SymbolicName/Bundle Version).&lt;/p&gt;

&lt;p&gt;However, it may happen that a bundle is updated with a new bundle version ... that&apos;s why I reworked this method,&lt;br/&gt;
in order to just simply return the path name of the bundle:&lt;/p&gt;

&lt;p&gt;svn diff src/main/java/org/apache/felix/fileinstall/internal/Util.java &lt;br/&gt;
     private static String getBundleKey(Bundle b)&lt;/p&gt;
     {
-        StringBuffer sb = new StringBuffer();
-        sb.append(b.getSymbolicName()).append(&quot;_&quot;);
-        String version = (String) b.getHeaders().get(Constants.BUNDLE_VERSION);
-        sb.append(version != null ? version : Version.emptyVersion.toString());
-        return sb.toString();
+        return getFile(b).getPath().replace(File.separator, &quot;_&quot;);
     }

&lt;p&gt;+    private static File getFile(Bundle b)&lt;br/&gt;
+    {&lt;br/&gt;
+        try&lt;br/&gt;
+        {&lt;br/&gt;
+            String location = b.getLocation();&lt;br/&gt;
+            if (location.startsWith(&quot;file:&quot;))&lt;br/&gt;
+            &lt;/p&gt;
{
+                return new File(location.substring(&quot;file:&quot;.length()));
+            }
&lt;p&gt;+            return new File(new URL(location).getFile());&lt;br/&gt;
+        }&lt;br/&gt;
+        catch (MalformedURLException e)&lt;br/&gt;
+        &lt;/p&gt;
{
+            throw new RuntimeException(&quot;Could not get location from bundle &quot;
+                + b.getLocation(), e);
+        }
&lt;p&gt;+    }&lt;/p&gt;


&lt;p&gt;Hope this helps;&lt;br/&gt;
/pierre&lt;/p&gt;</description>
                <environment></environment>
        <key id="12438531">FELIX-1776</key>
            <summary>FileInstall starts already installed bundles twice</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gnodet">Guillaume Nodet</assignee>
                                    <reporter username="pderop">Pierre De Rop</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Oct 2009 06:46:03 +0000</created>
                <updated>Tue, 17 Mar 2015 07:04:38 +0000</updated>
                            <resolved>Mon, 26 Apr 2010 16:31:39 +0000</resolved>
                                                    <fixVersion>fileinstall-3.0.0</fixVersion>
                                    <component>File Install</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12767729" author="pderop" created="Tue, 20 Oct 2009 06:48:12 +0000"  >&lt;p&gt;attached the proposed patch&lt;/p&gt;</comment>
                            <comment id="12767740" author="gnt" created="Tue, 20 Oct 2009 07:52:07 +0000"  >&lt;p&gt;I think the real problem is not in the call to Scanner.getChecksum().&lt;br/&gt;
The scanner forgets about checksums only for files that have been deleted from the file system, in which case the only thing to do is to uninstall the bundle (and we don&apos;t need the checksum anymore).&lt;/p&gt;

&lt;p&gt;I&apos;m not sure that your proposed patch for the getBundleKey is a good idea.   The reason is that fileinstall is  able to override already installed bundles with updated version copied to the watched folder, so we could end up with urls in very different formats (maven, war, etc...).  I think using the bundle id should actually be sufficient.&lt;/p&gt;

&lt;p&gt;I&apos;ve just committed a fix for that.  Could you please have a look and see if it works for you ?&lt;/p&gt;

&lt;p&gt;Committing to &lt;a href=&quot;https://svn.apache.org/repos/asf/felix/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/felix/trunk&lt;/a&gt; ...&lt;br/&gt;
	M	fileinstall/src/main/java/org/apache/felix/fileinstall/internal/DirectoryWatcher.java&lt;br/&gt;
	M	fileinstall/src/main/java/org/apache/felix/fileinstall/internal/Util.java&lt;br/&gt;
Committed r826986&lt;/p&gt;</comment>
                            <comment id="12768464" author="pderop" created="Wed, 21 Oct 2009 21:19:38 +0000"  >&lt;p&gt;Hello Guillaume;&lt;/p&gt;

&lt;p&gt;You are right, there&apos;s no problem with the Scanner.getChecksum() method.&lt;br/&gt;
Now, I did some further testing with your commit r826986 and I noticed the following:&lt;br/&gt;
The issue sounds to be resolved ... but only if I configure fileinstall like this:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;set the &quot;felix.fileinstall.dir&quot; option to an ABSOLUTE path (not a RELATIVE path)&lt;/li&gt;
	&lt;li&gt;set the &quot;felix.fileinstall.noInitialDelay=true&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;1) working scenario:&lt;br/&gt;
everything works fine with the following scenario:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;felix.fileinstall.dir=/home/pierre/felix-trunk/main/deploy&quot;&lt;/li&gt;
	&lt;li&gt;&quot;felix.fileinstall.noInitialDelay=true&quot;&lt;/li&gt;
	&lt;li&gt;I have a test bundle inside my deploy dir&lt;/li&gt;
	&lt;li&gt;I start the fwk -&amp;gt; the bundle is INSTALLED&lt;/li&gt;
	&lt;li&gt;I stop the fwk and recompile my test bundle&lt;/li&gt;
	&lt;li&gt;I restart the fwk -&amp;gt; the test bundle is UPDATED/STARTED&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;1) problematic scenario:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;felix.fileinstall.dir=./deploy&quot; (this is a relative path)&lt;/li&gt;
	&lt;li&gt;I don&apos;t set the &quot;felix.fileinstall.noInitialDelay&quot; option, so the default value is &quot;false&quot;&lt;/li&gt;
	&lt;li&gt;I have a test bundle inside my deploy dir&lt;/li&gt;
	&lt;li&gt;I start the fwk -&amp;gt; the bundle is INSTALLED&lt;/li&gt;
	&lt;li&gt;I stop the fwk and recompile my test bundle&lt;/li&gt;
	&lt;li&gt;I restart the fwk -&amp;gt; the test bundle is UPDATED/STARTED/UPDATED/STARTED (but the test bundle should only be UPDATED/STARTED)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Now I think that, in the Scanner.scan() method, normalizing the scanned files seems to resolve the problem when the deploy dir&lt;br/&gt;
is configured to a RELATIVE path:&lt;/p&gt;

&lt;p&gt;svn diff src/main/java/org/apache/felix/fileinstall/internal/Scanner.java &lt;br/&gt;
@@ -106,6 +106,7 @@&lt;br/&gt;
         for (int i = 0; i &amp;lt; list.length; i++)&lt;br/&gt;
         {&lt;br/&gt;
             File file  = list&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;;&lt;br/&gt;
+            file = new File(file.toURI().normalize());&lt;br/&gt;
             long lastChecksum = lastChecksums.get(file) != null ? ((Long) lastChecksums.get(file)).longValue() : 0;&lt;/p&gt;


&lt;p&gt;... But:, when the  &quot;fileinstall.noInitialDelay&quot; option is not set, and when I restart the fwk with a modified test bundle, the bundle is still started/updated/started.&lt;/p&gt;

&lt;p&gt;In any case, now, I know that using an absolute path and noInitialDelay=true, then the issue does not arise anymore, so may be you could close this issue ?&lt;/p&gt;

&lt;p&gt;What do you think ?&lt;/p&gt;</comment>
                            <comment id="12860984" author="gnt" created="Mon, 26 Apr 2010 16:31:39 +0000"  >&lt;p&gt;Committing to &lt;a href=&quot;https://svn.apache.org/repos/asf/felix/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/felix/trunk&lt;/a&gt; ...&lt;br/&gt;
	M	fileinstall/src/main/java/org/apache/felix/fileinstall/internal/Scanner.java&lt;br/&gt;
Committed r938115&lt;/p&gt;

&lt;p&gt;I&apos;ve fixed the relative directory issue, so i&apos;m closing this one.  Please reopen if needed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12422655" name="fileinstall-patch.tgz" size="11578" author="pderop" created="Tue, 20 Oct 2009 06:48:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>57259</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 31 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0vuxj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>183984</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>