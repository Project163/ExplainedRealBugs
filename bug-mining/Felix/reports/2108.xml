<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:52:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-4374] IPOJO: ConcurrentModificationException in ProvidedService</title>
                <link>https://issues.apache.org/jira/browse/FELIX-4374</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;I have a problem with a ManagedServices and IPOJO. &lt;br/&gt;
We have a service that provides externally configured properties. We want to use the managed service approach to get automatic refreshs of changed properties. The properties are read from a file &lt;/p&gt;
{karaf}
&lt;p&gt;/etc/na.default.properties containing ~500 properties and are injected into the service by @Updated, see code below. &lt;br/&gt;
Basically the code works fine, but from time to time the service startup fails with a ConcurrentModificationException in class ProvidedService. The exception does not show always, but it is reproducible by starting and stopping the bundle various times. The code has been stripped down to be very simple and the problem could still be reproduced. &lt;/p&gt;

&lt;p&gt;IPOJO version is 1.11.0, Karaf version 2.3.3 &lt;/p&gt;

&lt;p&gt;Short stacktrace: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2014-01-03 16:17:41,357 | INFO  |  pool-1-thread-1 | product-properties-services      | ?                                   ? | 64 - product-properties-services - 0.0.1.SNAPSHOT | [INFO] com.nextaudience.clustor.product.properties.services.DefaultPropertiesResolverService : An error occurred when creating an instance of com.nextaudience.clustor.product.properties.services.DefaultPropertiesResolverService 
java.util.ConcurrentModificationException 
        at java.util.TreeMap$PrivateEntryIterator.nextEntry(TreeMap.java:1115)[:1.7.0_45] 
        at java.util.TreeMap$ValueIterator.next(TreeMap.java:1160)[:1.7.0_45] 
        at org.apache.felix.ipojo.handlers.providedservice.ProvidedService.getServiceProperties(ProvidedService.java:447)[55:org.apache.felix.ipojo:1.11.0] 
        at org.apache.felix.ipojo.handlers.providedservice.ProvidedService.registerService(ProvidedService.java:357)[55:org.apache.felix.ipojo:1.11.0] 
        at org.apache.felix.ipojo.handlers.providedservice.ProvidedServiceHandler.__M_stateChanged(ProvidedServiceHandler.java:484)[55:org.apache.felix.ipojo:1.11.0] 
        at org.apache.felix.ipojo.handlers.providedservice.ProvidedServiceHandler.stateChanged(ProvidedServiceHandler.java)[55:org.apache.felix.ipojo:1.11.0] 
        at org.apache.felix.ipojo.InstanceManager.setState(InstanceManager.java:536)[55:org.apache.felix.ipojo:1.11.0] 
        at org.apache.felix.ipojo.InstanceManager.start(InstanceManager.java:418)[55:org.apache.felix.ipojo:1.11.0] 
        at org.apache.felix.ipojo.ComponentFactory.createInstance(ComponentFactory.java:179)[55:org.apache.felix.ipojo:1.11.0] 
        at org.apache.felix.ipojo.IPojoFactory.createComponentInstance(IPojoFactory.java:319)[55:org.apache.felix.ipojo:1.11.0] 
        at org.apache.felix.ipojo.IPojoFactory.createComponentInstance(IPojoFactory.java:240)[55:org.apache.felix.ipojo:1.11.0] 
        at org.apache.felix.ipojo.extender.internal.linker.ManagedType$InstanceSupport$1.call(ManagedType.java:312)[55:org.apache.felix.ipojo:1.11.0] 
        at org.apache.felix.ipojo.extender.internal.linker.ManagedType$InstanceSupport$1.call(ManagedType.java:306)[55:org.apache.felix.ipojo:1.11.0] 
        at org.apache.felix.ipojo.extender.internal.queue.JobInfoCallable.call(JobInfoCallable.java:114)[55:org.apache.felix.ipojo:1.11.0] 
        at java.util.concurrent.FutureTask.run(FutureTask.java:262)[:1.7.0_45] 
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)[:1.7.0_45] 
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)[:1.7.0_45] 
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744)[:1.7.0_45] 
2014-01-03 16:17:41,357 | ERROR |  pool-1-thread-1 | product-properties-services      | ?                                   ? | 64 - product-properties-services - 0.0.1.SNAPSHOT | [ERROR] com.nextaudience.clustor.product.properties.services.DefaultPropertiesResolverService : &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Our service: &lt;/p&gt;

&lt;p&gt;{code&lt;br/&gt;
@Component(managedservice = &quot;na.default.properties&quot;, publicFactory = false) &lt;br/&gt;
@Instantiate &lt;br/&gt;
@Provides &lt;br/&gt;
public class DefaultPropertiesResolverService implements ObservablePropertiesResolver { &lt;/p&gt;

&lt;p&gt;    private static final Logger LOG = LoggerFactory.getLogger(DefaultPropertiesResolverService.class); &lt;/p&gt;

&lt;p&gt;    @ServiceController &lt;br/&gt;
    private boolean ready; &lt;br/&gt;
    private Dictionary&amp;lt;String, String&amp;gt; properties; &lt;/p&gt;

&lt;p&gt;    @Validate &lt;br/&gt;
    synchronized private void startService() { &lt;br/&gt;
        LOG.info(&quot;startService start...&quot;); &lt;br/&gt;
        if (getProperties() == null) &lt;/p&gt;
{ 
            LOG.warn(&quot;No properties for &quot; + getClass().getName()); 
            return; 
        }
&lt;p&gt; &lt;br/&gt;
        if (getProperties().isEmpty()) &lt;/p&gt;
{ 
            LOG.warn(&quot;Empty properties for &quot; + getClass().getName()); 
            return; 
        }
&lt;p&gt; &lt;br/&gt;
        ready = true; &lt;br/&gt;
        LOG.info(DefaultPropertiesResolverService.class.getName() + &quot;::Start&quot;); &lt;br/&gt;
    } &lt;/p&gt;

&lt;p&gt;    @Invalidate &lt;br/&gt;
    synchronized private void stopService() &lt;/p&gt;
{ 
        ready = false; 
        LOG.info(DefaultPropertiesResolverService.class.getName() + &quot;::Stop&quot;); 
    }
&lt;p&gt; &lt;/p&gt;

&lt;p&gt;    synchronized public Dictionary&amp;lt;String, String&amp;gt; getProperties() &lt;/p&gt;
{ 
        return properties; 
    }
&lt;p&gt; &lt;/p&gt;

&lt;p&gt;    @Updated &lt;br/&gt;
    synchronized public void updateLocalProperties(Dictionary&amp;lt;String, String&amp;gt; cfgProperties) &lt;/p&gt;
{ 
        LOG.info(&quot;DefaultProperties: updateLocalProperties start...&quot;); 
        properties = cfgProperties; 
        LOG.info(&quot;DefaultProperties: updateLocalProperties end&quot;); 
    }
&lt;p&gt; &lt;br/&gt;
} &lt;br/&gt;
{code&lt;/p&gt;</description>
                <environment>Karaf 2.3.3</environment>
        <key id="12687405">FELIX-4374</key>
            <summary>IPOJO: ConcurrentModificationException in ProvidedService</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="clement.escoffier">Clement Escoffier</assignee>
                                    <reporter username="klasch42@gmail.com">Klaus Schr&#246;der</reporter>
                        <labels>
                    </labels>
                <created>Mon, 6 Jan 2014 08:03:05 +0000</created>
                <updated>Fri, 7 Mar 2014 08:27:15 +0000</updated>
                            <resolved>Mon, 6 Jan 2014 10:43:37 +0000</resolved>
                                    <version>ipojo-runtime-1.11.0</version>
                                    <fixVersion>ipojo-runtime-1.11.1</fixVersion>
                                    <component>iPOJO</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13862906" author="clement.escoffier" created="Mon, 6 Jan 2014 10:43:25 +0000"  >&lt;p&gt;I&apos;ve committed a fix in the trunk, could you try it ?&lt;/p&gt;</comment>
                            <comment id="13874558" author="klasch42@gmail.com" created="Fri, 17 Jan 2014 08:23:54 +0000"  >&lt;p&gt;Sorry for the late response. Meanwhile I have build a snapshot based on trunk containing your fix and I can confirm that I do not see the ConcurrentModificationExceptions anymore. Anyway, we still see weird unstable behavior with our managed services, that read properties via @Updated. Right it looks like the service sometimes gets stalled (or deadlocked). We have no reproducible scenario yet, it just happens from time to time. After restarting the service or restarting Karaf the problem disappears, but shows up again randomly.&lt;br/&gt;
We will keep an eye on this issue and come back as sonn as we have some more hints to reproduce it.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>366406</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 44 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1r5pz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>366717</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>