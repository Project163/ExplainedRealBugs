<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 15:11:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FELIX-1165] When restarting a bundle, the config admin reports &quot;Configuration ... has already been delivered&quot;, and the bundle receives no configuration.</title>
                <link>https://issues.apache.org/jira/browse/FELIX-1165</link>
                <project id="12310100" key="FELIX">Felix</project>
                    <description>&lt;p&gt;When restarting a bundle, the configuration admin reports &quot;Configuration ... has already been delivered&quot;, and the bundle receives no configuration.&lt;/p&gt;

&lt;p&gt;As far as I can tell this only occurs if a bundle is installed and started by the felix.auto.start.1 property in the config.properties.  If Felix is restarted and the bundle is loaded from the cache, the problem disappears.&lt;/p&gt;

&lt;p&gt;Test setup:&lt;/p&gt;

&lt;p&gt;Create a &quot;configurable&quot; bundle, implement ManagedService and register as a ManagedService with a PID from the BundleActivator start() method.&lt;br/&gt;
Create a &quot;configurator&quot; bundle and send a configuration to the PID.&lt;br/&gt;
Extract Felix and add the Felix config admin bundle to the felix.auto.start.1 property in conf/config.properties&lt;br/&gt;
Add the two new bundles to the felix.auto.start.1 property.&lt;br/&gt;
Start Felix.&lt;br/&gt;
Stop the &quot;configurable&quot; bundle, and start it again.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;If the configuration is sent from the &quot;configurator&quot;, the bundle receives it.&lt;/li&gt;
	&lt;li&gt;If felix is restarted, the problem disappears unless the felix-cache is deleted.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This can be reproduced with felix 1.8.0 using the example at:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.dynamicjava.org/articles/osgi-compendium/configuration-admin-service&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.dynamicjava.org/articles/osgi-compendium/configuration-admin-service&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;See also bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FELIX-516&quot; title=&quot;ManagedService[Factory] may be updated twice with the same Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FELIX-516&quot;&gt;&lt;del&gt;FELIX-516&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment>Windows XP, JDK 1.6.0_10, Felix 1.8.0, configadmin 1.0.10</environment>
        <key id="12425823">FELIX-1165</key>
            <summary>When restarting a bundle, the config admin reports &quot;Configuration ... has already been delivered&quot;, and the bundle receives no configuration.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fmeschbe">Felix Meschberger</assignee>
                                    <reporter username="james.hanson">James Hanson</reporter>
                        <labels>
                    </labels>
                <created>Tue, 19 May 2009 13:13:26 +0000</created>
                <updated>Tue, 25 Aug 2009 08:09:16 +0000</updated>
                            <resolved>Fri, 14 Aug 2009 21:50:24 +0000</resolved>
                                    <version>configadmin-1.0.1</version>
                    <version>configadmin-1.0.4</version>
                    <version>configadmin-1.0.8</version>
                    <version>configadmin-1.0.10</version>
                                    <fixVersion>configadmin-1.2.0</fixVersion>
                                    <component>Configuration Admin</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12710833" author="fmeschbe" created="Tue, 19 May 2009 18:57:31 +0000"  >&lt;p&gt;Can you attach the source of your sample bundles to this issue, please ? Thanks.&lt;/p&gt;

&lt;p&gt;The problem might be a subtle bug in your configurator bundle: This should use the ConfigurationAdmin.getConfiguration(String pid, String location) method and either set the location parameter to the actual bundle location of the configurable bundle or &amp;#8211; better yet, IMHO &amp;#8211; to null to not create a bound configuration at all.&lt;/p&gt;</comment>
                            <comment id="12712707" author="james.hanson" created="Mon, 25 May 2009 12:20:13 +0000"  >&lt;p&gt;The key points are PropertiesConfigManager:61 in the configurator project, and ServletManager:37 and 79 in the configurable project.&lt;/p&gt;</comment>
                            <comment id="12716668" author="james.hanson" created="Fri, 5 Jun 2009 16:55:15 +0000"  >&lt;p&gt;When the configurator bundle sends the new configuration via Configuration.update(props), the update is processed by ConfigurationManager$UpdateConfiguration.run().  This method doesn&apos;t set the ConfigurationImpl.serviceReference.  When the configured bundle is stopped, the ConfigurationManager$AbstractManagedServiceTracker.removedService() method will not call ConfigurationImpl.setDelivered(false), because it first checks that the serviceReference being removed equals the ConfigurationImpl.serviceReference (which is null).&lt;/p&gt;

&lt;p&gt;If the configuration is found by the PersistenceManager, the ConfigurationImpl.serviceReference is set in ConfigurationManager$ManagedServiceUpdate.run().&lt;/p&gt;

&lt;p&gt;Suggested solution - set the ConfigurationImpl.serviceReference in ConfigurationManager$UpdateConfiguration.run().&lt;/p&gt;</comment>
                            <comment id="12722940" author="thiloplanz" created="Tue, 23 Jun 2009 02:59:42 +0000"  >&lt;p&gt;I think I am running into the same problem, even without using felix.auto.start.&lt;/p&gt;

&lt;p&gt;I have both bundles and configuration managed by Felix FileInstall &lt;br/&gt;
(and I am using org.osgi.framework.storage.clean = onFirstInit to get a fresh bundle cache every time).&lt;/p&gt;

&lt;p&gt;When a bundle gets updated, it does not receive configuration information.&lt;/p&gt;

&lt;p&gt;I need to &quot;touch&quot; the configuration file to trigger configuration.&lt;/p&gt;

&lt;p&gt;Could this be related to the weird bundle location that FileInstall sets &lt;br/&gt;
(  /C:/bundles/org.osgi.compendium-1.2.0.jar without any protocol, so that the bundle cannot be updated the update shell command) ?&lt;/p&gt;

&lt;p&gt;Please raise the priority to something more than &quot;minor&quot;.&lt;/p&gt;</comment>
                            <comment id="12743461" author="fmeschbe" created="Fri, 14 Aug 2009 21:50:24 +0000"  >&lt;p&gt;Thanks for tracking down this issue - this helped a lot.&lt;/p&gt;

&lt;p&gt;And here is the actual way to reproduce the problem:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;start a bundle registering a ManagedService&lt;/li&gt;
	&lt;li&gt;create and update configuration for the ManagedService&lt;/li&gt;
	&lt;li&gt;--&amp;gt; the ManagedService gets the configuration&lt;/li&gt;
	&lt;li&gt;stop the bundle unregistering the ManagedService &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
	&lt;li&gt;start the bundle registering a ManagedService&lt;/li&gt;
	&lt;li&gt;--&amp;gt; the ManagedService does &lt;b&gt;not&lt;/b&gt; get the configuration&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;the problem effectively is, that when the configuration is first handed to the ManagedService through the UpdateConfiguration task, the service reference field is not set. Thus the delivered flag is not rest on ManagedService unregistration. When the bundle is restarted and the ManagedService registered again, the ConfigurationAdmin falsely assumes the configuration has already been delivered.&lt;/p&gt;

&lt;p&gt;This problem does not occurr if the configuration is created &lt;b&gt;before&lt;/b&gt; the ManagedService is registered for the first time because then the ManagedServiceUpdate task is called which in fact sets the service reference field and thus on service unregistration, the delivered flag is reset as expected.&lt;/p&gt;

&lt;p&gt;In Rev. 804387 I committed the fix along with a new integration test ensuring this behaviour.&lt;/p&gt;

&lt;p&gt;Can you please verify and close this issue. Thanks.&lt;/p&gt;</comment>
                            <comment id="12747286" author="fmeschbe" created="Tue, 25 Aug 2009 08:09:16 +0000"  >&lt;p&gt;Close all issues now this version has been released&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12408945" name="sample.zip" size="8764" author="james.hanson" created="Mon, 25 May 2009 12:20:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>57853</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 14 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1aru7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>270976</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>