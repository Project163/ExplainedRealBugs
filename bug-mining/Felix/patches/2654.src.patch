diff --git a/scr/src/main/java/org/apache/felix/scr/impl/Activator.java b/scr/src/main/java/org/apache/felix/scr/impl/Activator.java
index cd6c10b670..cd65bf71ea 100644
--- a/scr/src/main/java/org/apache/felix/scr/impl/Activator.java
+++ b/scr/src/main/java/org/apache/felix/scr/impl/Activator.java
@@ -468,13 +468,13 @@ public class Activator extends AbstractExtender implements SimpleLogger
         log(LogService.LOG_DEBUG, m_bundle, msg, t);
     }
 
-    @Override
+//    @Override
     public void log(int level, String message, Throwable ex)
     {
         log(level, null, message, ex);
     }
 
-    @Override
+//    @Override
     public void log(int level, String pattern, Object[] arguments, Throwable ex)
     {
         if (isLogEnabled(level))
diff --git a/scr/src/main/java/org/apache/felix/scr/impl/ComponentRegistry.java b/scr/src/main/java/org/apache/felix/scr/impl/ComponentRegistry.java
index cead9c2154..e632e28d73 100644
--- a/scr/src/main/java/org/apache/felix/scr/impl/ComponentRegistry.java
+++ b/scr/src/main/java/org/apache/felix/scr/impl/ComponentRegistry.java
@@ -479,21 +479,31 @@ public class ComponentRegistry
         return false;
     }
     
-    private final ThreadLocal<List<ServiceReference<?>>> circularInfos = new ThreadLocal<List<ServiceReference<?>>> (); 
+    private final ThreadLocal<List<ServiceReference<?>>> circularInfos = new ThreadLocal<List<ServiceReference<?>>> ()
+    {
+
+        @Override
+        protected List<ServiceReference<?>> initialValue()
+        {
+            return new ArrayList<ServiceReference<?>>();
+        }
+    }; 
     
     
+    /**
+     * Track getService calls by service reference.
+     * @param serviceReference
+     * @return true is we have encountered a circular dependency, false otherwise.
+     */
     public <T> boolean enterCreate(final ServiceReference<T> serviceReference)
     {
         List<ServiceReference<?>> info = circularInfos.get();
-        if (info == null) {
-            circularInfos.set(info = new ArrayList<ServiceReference<?>>());
-        }
         if (info.contains(serviceReference))
         {
             m_logger.log(LogService.LOG_ERROR,
-                "Circular reference detected trying to get service {0}: stack of references: {1}",
-                new Object[] {serviceReference, info},
-                null);
+                "Circular reference detected trying to get service {0}\n stack of references: {1}",
+                new Object[] {serviceReference, new Info(info)},
+                new Exception("stack trace"));
             return true;
         }
         m_logger.log(LogService.LOG_DEBUG,
@@ -504,6 +514,40 @@ public class ComponentRegistry
         return false;
     }
     
+
+    private class Info 
+    {
+        
+        private final List<ServiceReference<?>> info;
+        
+        
+        public Info(List<ServiceReference<?>> info)
+        {
+            this.info = info;
+        }
+
+
+        @Override
+        public String toString()
+        {
+            StringBuffer sb = new StringBuffer();
+            for (ServiceReference<?> sr: info)
+            {
+                sb.append("ServiceReference: ").append(sr).append("\n");
+                List<Entry<?, ?>> entries = m_missingDependencies.get(sr);
+                if (entries != null)
+                {
+                    for (Entry<?, ?> entry: entries)
+                    {
+                        sb.append("    Dependency: ").append(entry.getDm()).append("\n");
+                    }
+                }
+            }
+            return sb.toString();
+        }
+        
+    }
+        
     public <T> void leaveCreate(final ServiceReference<T> serviceReference)
     {
         List<ServiceReference<?>> info = circularInfos.get();
diff --git a/scr/src/main/java/org/apache/felix/scr/impl/manager/AbstractComponentManager.java b/scr/src/main/java/org/apache/felix/scr/impl/manager/AbstractComponentManager.java
index 6e5a4ac013..c6e93e8bc5 100644
--- a/scr/src/main/java/org/apache/felix/scr/impl/manager/AbstractComponentManager.java
+++ b/scr/src/main/java/org/apache/felix/scr/impl/manager/AbstractComponentManager.java
@@ -221,7 +221,8 @@ public abstract class AbstractComponentManager<S> implements SimpleLogger, Compo
     final long getLockTimeout()
     {
         ComponentActivator activator = getActivator();
-        if ( activator != null )
+        //for tests....
+        if ( activator != null && activator.getConfiguration() != null )
         {
             return activator.getConfiguration().lockTimeout();
         }
diff --git a/scr/src/main/java/org/apache/felix/scr/impl/manager/SingleComponentManager.java b/scr/src/main/java/org/apache/felix/scr/impl/manager/SingleComponentManager.java
index 7f94981b74..144f814bbe 100644
--- a/scr/src/main/java/org/apache/felix/scr/impl/manager/SingleComponentManager.java
+++ b/scr/src/main/java/org/apache/felix/scr/impl/manager/SingleComponentManager.java
@@ -313,6 +313,13 @@ public class SingleComponentManager<S> extends AbstractComponentManager<S> imple
         else
         {
             componentContext.setImplementationAccessible( true );
+            ComponentActivator activator = getActivator();
+            if ( activator != null )
+            {
+                //call to leaveCreate must be done here since the change in service properties may cause a getService,
+                //so the threadLocal must be cleared first.
+                activator.leaveCreate(getServiceReference());
+            }
             //this may cause a getService as properties now match a filter.
             setServiceProperties( result );
         }
@@ -807,17 +814,30 @@ public class SingleComponentManager<S> extends AbstractComponentManager<S> imple
         }
         boolean decrement = true;
         try {
-            boolean success = getServiceInternal(serviceRegistration);
-            ComponentContextImpl<S> componentContext = m_componentContext;
-            if ( success && componentContext != null)
+            if ( getActivator().enterCreate(serviceRegistration.getReference()))
             {
-                decrement = false;
-                return componentContext.getImplementationObject( true );
+                return null;
             }
-            else
+            try
             {
-                return null;
+                boolean success = getServiceInternal(serviceRegistration);
+                ComponentContextImpl<S> componentContext = m_componentContext;
+                if ( success && componentContext != null)
+                {
+                    decrement = false;
+                    return componentContext.getImplementationObject( true );
+                }
+                else
+                {
+                    return null;
+                }
             }
+            finally
+            {
+                //This is backup.  Normally done in createComponent.
+                getActivator().leaveCreate(serviceRegistration.getReference());
+            }
+            
         }
         finally
         {
@@ -832,61 +852,47 @@ public class SingleComponentManager<S> extends AbstractComponentManager<S> imple
     @Override
     boolean getServiceInternal(ServiceRegistration<S> serviceRegistration)
     {
-        if ( serviceRegistration != null && getActivator().enterCreate(serviceRegistration.getReference()))
-        {
-            return false;
-        }
-        try
+        boolean success = true;
+        if ( m_componentContext == null )
         {
-            boolean success = true;
-            if ( m_componentContext == null )
+            ComponentContextImpl<S> componentContext = new ComponentContextImpl<S>(this, this.getBundle(), serviceRegistration);
+            if ( collectDependencies(componentContext))
             {
-                ComponentContextImpl<S> componentContext = new ComponentContextImpl<S>(this, this.getBundle(), serviceRegistration);
-                if ( collectDependencies(componentContext))
-                {
-                    log( LogService.LOG_DEBUG,
-                        "getService (single component manager) dependencies collected.",
-                        null );
-                }
-                else
-                {
-                    log( LogService.LOG_INFO,
-                            "Could not obtain all required dependencies, getService returning null",
-                            null );
-                    success = false;
-                }
-                obtainStateLock(  );
-                try
+                log( LogService.LOG_DEBUG,
+                    "getService (single component manager) dependencies collected.",
+                    null );
+            }
+            else
+            {
+                log( LogService.LOG_INFO,
+                    "Could not obtain all required dependencies, getService returning null",
+                    null );
+                success = false;
+            }
+            obtainStateLock(  );
+            try
+            {
+                if ( m_componentContext == null )
                 {
-                    if ( m_componentContext == null )
+                    State previousState = getState();
+                    //state should be "Registered"
+                    S result = getService(componentContext );
+                    if ( result == null )
                     {
-                        State previousState = getState();
-                        //state should be "Registered"
-                        S result = getService(componentContext );
-                        if ( result == null )
-                        {
-                            success = false;;
-                        }
-                        else
-                        {
-                            setState(previousState, State.active);
-                        }
+                        success = false;;
+                    }
+                    else
+                    {
+                        setState(previousState, State.active);
                     }
-                }
-                finally
-                {
-                    releaseStateLock(  );
                 }
             }
-            return success;
-        }
-        finally
-        {
-            if (serviceRegistration != null)
+            finally
             {
-                getActivator().leaveCreate(serviceRegistration.getReference());
+                releaseStateLock(  );
             }
         }
+        return success;
     }
 
     private S getService(ComponentContextImpl<S> componentContext)
diff --git a/scr/src/test/java/org/apache/felix/scr/impl/manager/SingleComponentManagerTest.java b/scr/src/test/java/org/apache/felix/scr/impl/manager/SingleComponentManagerTest.java
index 78f9a5cb7d..e76a36d8a4 100644
--- a/scr/src/test/java/org/apache/felix/scr/impl/manager/SingleComponentManagerTest.java
+++ b/scr/src/test/java/org/apache/felix/scr/impl/manager/SingleComponentManagerTest.java
@@ -25,6 +25,8 @@ import static org.junit.Assert.assertSame;
 import java.lang.reflect.Field;
 import java.util.concurrent.atomic.AtomicInteger;
 
+import javax.imageio.spi.ServiceRegistry;
+
 import org.apache.felix.scr.impl.helper.ComponentMethods;
 import org.apache.felix.scr.impl.inject.ComponentMethodsImpl;
 import org.apache.felix.scr.impl.manager.AbstractComponentManager.State;
@@ -34,10 +36,138 @@ import org.junit.Test;
 import org.mockito.Mockito;
 import org.osgi.framework.Bundle;
 import org.osgi.framework.BundleContext;
+import org.osgi.framework.Filter;
+import org.osgi.framework.ServiceReference;
 import org.osgi.framework.ServiceRegistration;
+import org.osgi.service.cm.ConfigurationAdmin;
 
 public class SingleComponentManagerTest
 {
+    
+    private ServiceRegistration serviceRegistration = Mockito.mock(ServiceRegistration.class);
+    private ServiceReference serviceReference = Mockito.mock(ServiceReference.class);
+    private ComponentActivator componentActivator = new ComponentActivator() {
+
+        public boolean isLogEnabled(int level)
+        {
+            // TODO Auto-generated method stub
+            return false;
+        }
+
+        public void log(int level, String pattern, Object[] arguments, ComponentMetadata metadata, Long componentId,
+            Throwable ex)
+        {
+            // TODO Auto-generated method stub
+            
+        }
+
+        public void log(int level, String message, ComponentMetadata metadata, Long componentId, Throwable ex)
+        {
+            // TODO Auto-generated method stub
+            
+        }
+
+        public void addServiceListener(String className, Filter filter,
+            ExtendedServiceListener<ExtendedServiceEvent> listener)
+        {
+            // TODO Auto-generated method stub
+            
+        }
+
+        public void removeServiceListener(String className, Filter filter,
+            ExtendedServiceListener<ExtendedServiceEvent> listener)
+        {
+            // TODO Auto-generated method stub
+            
+        }
+
+        public BundleContext getBundleContext()
+        {
+            // TODO Auto-generated method stub
+            return null;
+        }
+
+        public boolean isActive()
+        {
+            // TODO Auto-generated method stub
+            return false;
+        }
+
+        public ScrConfiguration getConfiguration()
+        {
+            // TODO Auto-generated method stub
+            return null;
+        }
+
+        public void schedule(Runnable runnable)
+        {
+            // TODO Auto-generated method stub
+            
+        }
+
+        public long registerComponentId(AbstractComponentManager<?> sAbstractComponentManager)
+        {
+            // TODO Auto-generated method stub
+            return 0;
+        }
+
+        public void unregisterComponentId(AbstractComponentManager<?> sAbstractComponentManager)
+        {
+            // TODO Auto-generated method stub
+            
+        }
+
+        public <T> boolean enterCreate(ServiceReference<T> reference)
+        {
+            // TODO Auto-generated method stub
+            return false;
+        }
+
+        public <T> void leaveCreate(ServiceReference<T> reference)
+        {
+            // TODO Auto-generated method stub
+            
+        }
+
+        public <S, T> void registerMissingDependency(DependencyManager<S, T> dependencyManager,
+            ServiceReference<T> serviceReference, int trackingCount)
+        {
+            // TODO Auto-generated method stub
+            
+        }
+
+        public <T> void missingServicePresent(ServiceReference<T> serviceReference)
+        {
+            // TODO Auto-generated method stub
+            
+        }
+
+        public void enableComponent(String name)
+        {
+            // TODO Auto-generated method stub
+            
+        }
+
+        public void disableComponent(String name)
+        {
+            // TODO Auto-generated method stub
+            
+        }
+
+        public RegionConfigurationSupport setRegionConfigurationSupport(ServiceReference<ConfigurationAdmin> reference)
+        {
+            // TODO Auto-generated method stub
+            return null;
+        }
+
+        public void unsetRegionConfigurationSupport(RegionConfigurationSupport rcs)
+        {
+            // TODO Auto-generated method stub
+            
+        }
+        
+    };
+    
     @Test
     public void testGetService() throws Exception {
         ComponentMetadata cm = new ComponentMetadata(DSVersion.DS13);
@@ -47,6 +177,7 @@ public class SingleComponentManagerTest
         @SuppressWarnings("unchecked")
         ComponentContainer<Object> cc = Mockito.mock(ComponentContainer.class);
         Mockito.when(cc.getComponentMetadata()).thenReturn(cm);
+        Mockito.when(cc.getActivator()).thenReturn(componentActivator);
 
         SingleComponentManager<Object> scm = new SingleComponentManager<Object>(cc, new ComponentMethodsImpl()) {
             @Override
@@ -70,7 +201,7 @@ public class SingleComponentManagerTest
         f.set(scm, cci);
 
         scm.setState(scm.getState(), State.unsatisfiedReference);
-        assertSame(implObj, scm.getService(null, null));
+        assertSame(implObj, scm.getService(b, serviceRegistration));
 
         Field u = SingleComponentManager.class.getDeclaredField("m_useCount");
         u.setAccessible(true);
@@ -88,6 +219,7 @@ public class SingleComponentManagerTest
         @SuppressWarnings("unchecked")
         ComponentContainer<Object> cc = Mockito.mock(ComponentContainer.class);
         Mockito.when(cc.getComponentMetadata()).thenReturn(cm);
+        Mockito.when(cc.getActivator()).thenReturn(componentActivator);
 
         SingleComponentManager<?> scm = new SingleComponentManager<Object>(cc, new ComponentMethodsImpl()) {
             @Override
@@ -96,9 +228,13 @@ public class SingleComponentManagerTest
                 return true;
             }
         };
+        BundleContext bc = Mockito.mock(BundleContext.class);
+        Bundle b = Mockito.mock(Bundle.class);
+        Mockito.when(b.getBundleContext()).thenReturn(bc);
+
         scm.setState(scm.getState(), State.unsatisfiedReference);
         assertNull("m_componentContext is null, this should not cause an NPE",
-                scm.getService(null, null));
+                scm.getService(b, serviceRegistration));
 
         Field u = SingleComponentManager.class.getDeclaredField("m_useCount");
         u.setAccessible(true);
diff --git a/scr/src/test/java/org/apache/felix/scr/integration/ActivateSignatureTest.java b/scr/src/test/java/org/apache/felix/scr/integration/ActivateSignatureTest.java
index 8f18edbbfe..5b9193bba8 100644
--- a/scr/src/test/java/org/apache/felix/scr/integration/ActivateSignatureTest.java
+++ b/scr/src/test/java/org/apache/felix/scr/integration/ActivateSignatureTest.java
@@ -64,7 +64,7 @@ public class ActivateSignatureTest extends ComponentTestBase
             TestCase.assertTrue( "Expecting component " + component.name + " to be enabled", component
                 .defaultEnabled );
 
-            ComponentConfigurationDTO cc = findComponentConfigurationByName(component.name, -1);
+            ComponentConfigurationDTO cc = findComponentConfigurationByName(component.name, 0);
             TestCase.assertEquals( "Expecting component " + component.name + " to be active",
             		ComponentConfigurationDTO.ACTIVE, cc.state );
             
diff --git a/scr/src/test/java/org/apache/felix/scr/integration/CircularReferenceTest.java b/scr/src/test/java/org/apache/felix/scr/integration/CircularReferenceTest.java
index de33fe7d1b..f93a0bc35a 100644
--- a/scr/src/test/java/org/apache/felix/scr/integration/CircularReferenceTest.java
+++ b/scr/src/test/java/org/apache/felix/scr/integration/CircularReferenceTest.java
@@ -71,10 +71,11 @@ public class CircularReferenceTest extends ComponentTestBase
     public void test_A11_B0n_immediate_A_first() throws InvalidSyntaxException
     {
         String componentNameA = "2.A.1.1.dynamic";
-        final ComponentConfigurationDTO componentA = findComponentConfigurationByName( componentNameA, ComponentConfigurationDTO.ACTIVE );
+        final ComponentConfigurationDTO componentA = findComponentConfigurationByName( componentNameA, ComponentConfigurationDTO.SATISFIED | ComponentConfigurationDTO.ACTIVE );
         A a = getServiceFromConfiguration(componentA, A.class);
         assertEquals( 1, a.getBs().size());
 
+        delay();
         String componentNameB = "2.B.0.n.dynamic";
         final ComponentConfigurationDTO componentB = findComponentConfigurationByName( componentNameB, ComponentConfigurationDTO.ACTIVE );
         B b = getServiceFromConfiguration(componentB, B.class);
@@ -92,6 +93,7 @@ public class CircularReferenceTest extends ComponentTestBase
         A a = getServiceFromConfiguration(componentA, A.class);
         assertEquals( 1, a.getBs().size());
 
+        delay();
         String componentNameB = "3.B.0.n.dynamic";
         final ComponentConfigurationDTO componentB = findComponentConfigurationByName( componentNameB, ComponentConfigurationDTO.ACTIVE );
         B b = getServiceFromConfiguration(componentB, B.class);
@@ -171,7 +173,7 @@ public class CircularReferenceTest extends ComponentTestBase
     public void test_A11_B01_immediate_A_first() throws InvalidSyntaxException
     {
         String componentNameA = "5.A.1.1.dynamic";
-        final ComponentConfigurationDTO componentA = findComponentConfigurationByName( componentNameA, ComponentConfigurationDTO.ACTIVE );
+        final ComponentConfigurationDTO componentA = findComponentConfigurationByName( componentNameA, ComponentConfigurationDTO.SATISFIED | ComponentConfigurationDTO.ACTIVE );
         A a = getServiceFromConfiguration(componentA, A.class);
         assertEquals( 1, a.getBs().size());
 
@@ -276,14 +278,14 @@ public class CircularReferenceTest extends ComponentTestBase
     public void test_A11_immediate_B0n_delayed_B_first() throws InvalidSyntaxException
     {
     	String componentNameB = "8.B.0.n.dynamic";
-        final ComponentConfigurationDTO componentB = findComponentConfigurationByName( componentNameB, ComponentConfigurationDTO.ACTIVE );
+        final ComponentConfigurationDTO componentB = findComponentConfigurationByName( componentNameB, ComponentConfigurationDTO.SATISFIED | ComponentConfigurationDTO.ACTIVE );
         ServiceReference[] serviceReferencesB = bundleContext.getServiceReferences( B.class.getName(), "(service.pid=" + componentNameB + ")" );
         TestCase.assertEquals( 1, serviceReferencesB.length );
         ServiceReference<B> serviceReferenceB = serviceReferencesB[0];
         B b = bundleContext.getService( serviceReferenceB );
 
         String componentNameA = "8.A.1.1.static";
-        ComponentConfigurationDTO componentA = findComponentConfigurationByName( componentNameA, ComponentConfigurationDTO.SATISFIED );
+        ComponentConfigurationDTO componentA = findComponentConfigurationByName( componentNameA, ComponentConfigurationDTO.SATISFIED | ComponentConfigurationDTO.ACTIVE );
         ServiceReference[] serviceReferencesA = bundleContext.getServiceReferences( A.class.getName(), "(service.pid=" + componentNameA + ")" );
         TestCase.assertEquals( 1, serviceReferencesA.length );
         ServiceReference<A> serviceReferenceA = serviceReferencesA[0];
diff --git a/scr/src/test/java/org/apache/felix/scr/integration/ComponentTestBase.java b/scr/src/test/java/org/apache/felix/scr/integration/ComponentTestBase.java
index 2ee0f10627..2f44318773 100644
--- a/scr/src/test/java/org/apache/felix/scr/integration/ComponentTestBase.java
+++ b/scr/src/test/java/org/apache/felix/scr/integration/ComponentTestBase.java
@@ -43,6 +43,7 @@ import java.lang.reflect.InvocationTargetException;
 import java.lang.reflect.Method;
 import java.text.SimpleDateFormat;
 import java.util.ArrayList;
+import java.util.Arrays;
 import java.util.Collection;
 import java.util.Collections;
 import java.util.Date;
@@ -51,6 +52,7 @@ import java.util.HashMap;
 import java.util.Hashtable;
 import java.util.List;
 import java.util.Map;
+import java.util.Set;
 import java.util.concurrent.LinkedBlockingQueue;
 
 import javax.inject.Inject;
@@ -118,7 +120,7 @@ public abstract class ComponentTestBase
     protected static String paxRunnerVmOption = null;
 
     //To investigate any problems at all set to "debug"
-    protected static String DS_LOGLEVEL = "warn";
+    protected static String DS_LOGLEVEL = "debug";
 
     protected static String bsnVersionUniqueness = "single";
 
@@ -264,11 +266,24 @@ public abstract class ComponentTestBase
         }
         ComponentDescriptionDTO cd = scr.getComponentDescriptionDTO(b, name);
         Collection<ComponentConfigurationDTO> ccs = scr.getComponentConfigurationDTOs(cd);
-        if (expected != -1)
+        
+        if (expected != 0)
         {
+            String sep = "[";
+            StringBuffer sb = new StringBuffer();
+            for (Map.Entry<Integer, String> entry: STATES.entrySet()) 
+            {
+                if ((expected & entry.getKey()) != 0)
+                {
+                    sb.append(sep).append(entry.getValue());
+                    sep = ", ";
+                }
+            }
+            sb.append("]");
         	for (ComponentConfigurationDTO cc: ccs)
         	{
-        		Assert.assertEquals( "for ComponentConfiguration name: " + cc.description.name + " properties" + cc.properties + "Expected state " + STATES.get(expected) + " but was " + STATES.get(cc.state), expected, cc.state);
+        		Assert.assertTrue( "for ComponentConfiguration name: " + cc.description.name + " properties" + cc.properties + "Expected one of state " + sb.toString() + " but was " + STATES.get(cc.state), 
+        		    (expected & cc.state) == cc.state);
         	}
         }
         return ccs;
