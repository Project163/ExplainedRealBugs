diff --git a/bundlerepository/src/main/java/org/apache/felix/bundlerepository/impl/FelixResourceAdapter.java b/bundlerepository/src/main/java/org/apache/felix/bundlerepository/impl/FelixResourceAdapter.java
index 21f767100b..90689f6fbd 100644
--- a/bundlerepository/src/main/java/org/apache/felix/bundlerepository/impl/FelixResourceAdapter.java
+++ b/bundlerepository/src/main/java/org/apache/felix/bundlerepository/impl/FelixResourceAdapter.java
@@ -42,8 +42,7 @@ public class FelixResourceAdapter implements Resource, RepositoryContent
         {
             // TODO cater for null request
             Object type = resource.getProperties().get(IdentityNamespace.CAPABILITY_TYPE_ATTRIBUTE);
-            OSGiCapabilityImpl c = OSGiRepositoryImpl.newOSGiIdentityCapability(resource.getSymbolicName(),
-                type != null ? type.toString() : IdentityNamespace.TYPE_BUNDLE, resource.getVersion());
+            OSGiCapabilityImpl c = OSGiRepositoryImpl.newOSGiIdentityCapability(resource);
             c.setResource(this);
             return Collections.<Capability>singletonList(c);
         }
diff --git a/bundlerepository/src/main/java/org/apache/felix/bundlerepository/impl/OSGiRepositoryImpl.java b/bundlerepository/src/main/java/org/apache/felix/bundlerepository/impl/OSGiRepositoryImpl.java
index 2f75be7f3c..b5c9fcab82 100644
--- a/bundlerepository/src/main/java/org/apache/felix/bundlerepository/impl/OSGiRepositoryImpl.java
+++ b/bundlerepository/src/main/java/org/apache/felix/bundlerepository/impl/OSGiRepositoryImpl.java
@@ -37,7 +37,6 @@ import org.apache.felix.bundlerepository.RepositoryAdmin;
 import org.apache.felix.bundlerepository.impl.LazyHashMap.LazyValue;
 import org.osgi.framework.Filter;
 import org.osgi.framework.FrameworkUtil;
-import org.osgi.framework.Version;
 import org.osgi.framework.namespace.IdentityNamespace;
 import org.osgi.resource.Capability;
 import org.osgi.resource.Namespace;
@@ -108,9 +107,7 @@ class OSGiRepositoryImpl implements Repository
     private void addResourceForIdentity(final org.apache.felix.bundlerepository.Resource res, Filter filter, List<Capability> caps)
         throws Exception
     {
-        Object type = res.getProperties().get(IdentityNamespace.CAPABILITY_TYPE_ATTRIBUTE);
-        OSGiCapabilityImpl idCap = newOSGiIdentityCapability(res.getSymbolicName(),
-            type != null ? type.toString() : IdentityNamespace.TYPE_BUNDLE, res.getVersion());
+        OSGiCapabilityImpl idCap = newOSGiIdentityCapability(res);
         if (filter != null)
         {
             if (!filter.matches(idCap.getAttributes()))
@@ -131,12 +128,15 @@ class OSGiRepositoryImpl implements Repository
         caps.add(idCap);
     }
 
-    static OSGiCapabilityImpl newOSGiIdentityCapability(String symbolicName, String type, Version version)
-    {
-        Map<String, Object> idAttrs = new HashMap<String, Object>();
-        idAttrs.put(IdentityNamespace.IDENTITY_NAMESPACE, symbolicName);
-        idAttrs.put(IdentityNamespace.CAPABILITY_TYPE_ATTRIBUTE, type);
-        idAttrs.put(IdentityNamespace.CAPABILITY_VERSION_ATTRIBUTE, version);
+    static OSGiCapabilityImpl newOSGiIdentityCapability(org.apache.felix.bundlerepository.Resource res) {
+        @SuppressWarnings("unchecked")
+        Map<String, Object> idAttrs = new HashMap<String, Object>(res.getProperties());
+
+        // Set a number of specific properties that need to be translated
+        idAttrs.put(IdentityNamespace.IDENTITY_NAMESPACE, res.getSymbolicName());
+
+        if (idAttrs.get(IdentityNamespace.CAPABILITY_TYPE_ATTRIBUTE) == null)
+            idAttrs.put(IdentityNamespace.CAPABILITY_TYPE_ATTRIBUTE, IdentityNamespace.TYPE_BUNDLE);
 
         return new OSGiCapabilityImpl(IdentityNamespace.IDENTITY_NAMESPACE, idAttrs, Collections.<String, String> emptyMap());
     }
diff --git a/bundlerepository/src/test/java/org/apache/felix/bundlerepository/impl/OSGiRepositoryImplTest.java b/bundlerepository/src/test/java/org/apache/felix/bundlerepository/impl/OSGiRepositoryImplTest.java
index 87f0888933..c00a2ccdf3 100644
--- a/bundlerepository/src/test/java/org/apache/felix/bundlerepository/impl/OSGiRepositoryImplTest.java
+++ b/bundlerepository/src/test/java/org/apache/felix/bundlerepository/impl/OSGiRepositoryImplTest.java
@@ -44,34 +44,6 @@ import org.osgi.service.repository.RepositoryContent;
 
 public class OSGiRepositoryImplTest extends TestCase
 {
-    public void testRepositoryContent() throws Exception {
-        RepositoryAdminImpl repoAdmin = createRepositoryAdmin();
-        URL url = getClass().getResource("/another_repository.xml");
-        repoAdmin.addRepository(url);
-
-        Repository repo = new OSGiRepositoryImpl(repoAdmin);
-        Requirement req = new OSGiRequirementImpl("osgi.wiring.package",
-                "(&(osgi.wiring.package=org.apache.commons.logging)(version>=1.0.1)(!(version>=2)))");
-
-        Map<Requirement, Collection<Capability>> result = repo.findProviders(Collections.singleton(req));
-        assertEquals(1, result.size());
-        Collection<Capability> caps = result.values().iterator().next();
-        assertEquals(1, caps.size());
-        Capability cap = caps.iterator().next();
-        assertEquals("osgi.wiring.package", cap.getNamespace());
-        assertEquals("org.apache.commons.logging", cap.getAttributes().get("osgi.wiring.package"));
-        assertEquals(Version.parseVersion("1.0.4"), cap.getAttributes().get("version"));
-
-        Resource resource = cap.getResource();
-        RepositoryContent rc = (RepositoryContent) resource; // Repository Resources must implement this interface
-        byte[] actualBytes = Streams.suck(rc.getContent());
-
-        URL actualURL = getClass().getResource("/repo_files/test_file_1.jar");
-        byte[] expectedBytes = Streams.suck(actualURL.openStream());
-
-        assertTrue(Arrays.equals(expectedBytes, actualBytes));
-    }
-
     public void testIdentityAndContentCapabilities() throws Exception
     {
         RepositoryAdminImpl repoAdmin = createRepositoryAdmin();
@@ -178,6 +150,34 @@ public class OSGiRepositoryImplTest extends TestCase
         assertEquals(expected, identities);
     }
 
+    public void testRepositoryContent() throws Exception {
+        RepositoryAdminImpl repoAdmin = createRepositoryAdmin();
+        URL url = getClass().getResource("/another_repository.xml");
+        repoAdmin.addRepository(url);
+
+        Repository repo = new OSGiRepositoryImpl(repoAdmin);
+        Requirement req = new OSGiRequirementImpl("osgi.wiring.package",
+                "(&(osgi.wiring.package=org.apache.commons.logging)(version>=1.0.1)(!(version>=2)))");
+
+        Map<Requirement, Collection<Capability>> result = repo.findProviders(Collections.singleton(req));
+        assertEquals(1, result.size());
+        Collection<Capability> caps = result.values().iterator().next();
+        assertEquals(1, caps.size());
+        Capability cap = caps.iterator().next();
+        assertEquals("osgi.wiring.package", cap.getNamespace());
+        assertEquals("org.apache.commons.logging", cap.getAttributes().get("osgi.wiring.package"));
+        assertEquals(Version.parseVersion("1.0.4"), cap.getAttributes().get("version"));
+
+        Resource resource = cap.getResource();
+        RepositoryContent rc = (RepositoryContent) resource; // Repository Resources must implement this interface
+        byte[] actualBytes = Streams.suck(rc.getContent());
+
+        URL actualURL = getClass().getResource("/repo_files/test_file_1.jar");
+        byte[] expectedBytes = Streams.suck(actualURL.openStream());
+
+        assertTrue(Arrays.equals(expectedBytes, actualBytes));
+    }
+
     private RepositoryAdminImpl createRepositoryAdmin() throws Exception
     {
         Bundle sysBundle = Mockito.mock(Bundle.class);
diff --git a/bundlerepository/src/test/java/org/apache/felix/bundlerepository/impl/OSGiRepositoryXMLTest.java b/bundlerepository/src/test/java/org/apache/felix/bundlerepository/impl/OSGiRepositoryXMLTest.java
index 669d2949bf..a70fe17d3a 100644
--- a/bundlerepository/src/test/java/org/apache/felix/bundlerepository/impl/OSGiRepositoryXMLTest.java
+++ b/bundlerepository/src/test/java/org/apache/felix/bundlerepository/impl/OSGiRepositoryXMLTest.java
@@ -63,6 +63,25 @@ public class OSGiRepositoryXMLTest extends TestCase
         assertEquals("osgi.subsystem.feature", cap.getAttributes().get(IdentityNamespace.CAPABILITY_TYPE_ATTRIBUTE));
     }
 
+    public void testOtherIdentityAttribute() throws Exception
+    {
+        RepositoryAdminImpl repoAdmin = createRepositoryAdmin();
+        URL url = getClass().getResource("/spec_repository.xml");
+        repoAdmin.addRepository(url);
+
+        Repository repo = new OSGiRepositoryImpl(repoAdmin);
+        Requirement req = new OSGiRequirementImpl("osgi.identity",
+                "(license=http://www.opensource.org/licenses/mytestlicense)");
+
+        Map<Requirement, Collection<Capability>> result = repo.findProviders(Collections.singleton(req));
+        assertEquals(1, result.size());
+        Collection<Capability> caps = result.values().iterator().next();
+        assertEquals(1, caps.size());
+        Capability cap = caps.iterator().next();
+        assertEquals("org.apache.felix.bundlerepository.test_file_3", cap.getAttributes().
+                get(IdentityNamespace.IDENTITY_NAMESPACE));
+    }
+
     public void testContentCapability() throws Exception
     {
         RepositoryAdminImpl repoAdmin = createRepositoryAdmin();
diff --git a/bundlerepository/src/test/resources/spec_repository.xml b/bundlerepository/src/test/resources/spec_repository.xml
index ff95b9ef4c..99ce2a13c4 100644
--- a/bundlerepository/src/test/resources/spec_repository.xml
+++ b/bundlerepository/src/test/resources/spec_repository.xml
@@ -23,6 +23,7 @@
       <attribute name='osgi.identity' value='org.apache.felix.bundlerepository.test_file_3'/>
       <attribute name='type' value='osgi.bundle'/>
       <attribute name='version' type='Version' value='1.2.3.something'/>
+      <attribute name='license' value='http://www.opensource.org/licenses/mytestlicense' />
     </capability>
     <capability namespace='osgi.content'>
       <attribute name='osgi.content' value='a1c64578808c38a63cd6563e9936f025638aeaf9de70f36765367db81c0afc38'/>
