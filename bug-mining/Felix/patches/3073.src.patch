diff --git a/scr/src/main/java/org/apache/felix/scr/impl/manager/AbstractPrototypeRefPair.java b/scr/src/main/java/org/apache/felix/scr/impl/manager/AbstractPrototypeRefPair.java
new file mode 100644
index 0000000000..1832b228af
--- /dev/null
+++ b/scr/src/main/java/org/apache/felix/scr/impl/manager/AbstractPrototypeRefPair.java
@@ -0,0 +1,109 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *  http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied.  See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+
+
+package org.apache.felix.scr.impl.manager;
+
+import java.util.Collection;
+import java.util.Map;
+import java.util.Map.Entry;
+
+import org.osgi.framework.BundleContext;
+import org.osgi.framework.ServiceReference;
+import org.osgi.service.log.LogService;
+
+/**
+ * @version $Rev$ $Date$
+ */
+public abstract class AbstractPrototypeRefPair<S, T> extends RefPair<S, T>
+{
+    public AbstractPrototypeRefPair( ServiceReference<T> ref )
+    {
+        super(ref);
+    }
+
+    @Override
+    public abstract T getServiceObject(ComponentContextImpl<S> key);
+
+    @Override
+    public abstract boolean setServiceObject(ComponentContextImpl<S> key, T serviceObject);
+
+    protected abstract T remove(ComponentContextImpl<S> key);
+
+    protected abstract Collection<Entry<ComponentContextImpl<S>, T>> clearEntries();
+
+    @Override
+    public final T ungetServiceObject(ComponentContextImpl<S> key)
+    {
+        if ( key == null )
+        {
+            Collection<Map.Entry<ComponentContextImpl<S>,T>> keys = clearEntries();
+            for (Map.Entry<ComponentContextImpl<S>,T> e : keys)
+            {
+                doUngetService( e.getKey(), e.getValue() );
+            }
+            return null ;
+        }
+        T service = remove( key );
+        if(service != null) {
+        	doUngetService( key, service );
+        }
+		return service;
+    }
+
+    @Override
+    public final void ungetServiceObjects(BundleContext bundleContext) {
+        ungetServiceObject(null);
+    }
+
+    @Override
+    public abstract String toString();
+
+    @Override
+    public final boolean getServiceObject(ComponentContextImpl<S> key, BundleContext context)
+    {
+        final T service = key.getComponentServiceObjectsHelper().getPrototypeRefInstance(this.getRef());
+        if ( service == null )
+        {
+            setFailed();
+            key.getLogger().log(
+                 LogService.LOG_WARNING,
+                 "Could not get service from serviceobjects for ref {0}", null, getRef() );
+            return false;
+        }
+        if (!setServiceObject(key, service))
+        {
+            // Another thread got the service before, so unget our
+        	doUngetService( key, service );
+        }
+        return true;
+    }
+
+	@SuppressWarnings("unchecked")
+    private void doUngetService(ComponentContextImpl<S> key, final T service) {
+		try 
+		{
+			key.getComponentServiceObjectsHelper().getServiceObjects(getRef()).ungetService( service );
+		}
+		catch ( final IllegalStateException ise )
+		{
+			// ignore
+		}
+	}
+}
diff --git a/scr/src/main/java/org/apache/felix/scr/impl/manager/MultiplePrototypeRefPair.java b/scr/src/main/java/org/apache/felix/scr/impl/manager/MultiplePrototypeRefPair.java
index 8e827381ed..96ca5b9116 100644
--- a/scr/src/main/java/org/apache/felix/scr/impl/manager/MultiplePrototypeRefPair.java
+++ b/scr/src/main/java/org/apache/felix/scr/impl/manager/MultiplePrototypeRefPair.java
@@ -20,19 +20,18 @@
 
 package org.apache.felix.scr.impl.manager;
 
-import java.util.Iterator;
+import java.util.ArrayList;
+import java.util.Collection;
 import java.util.Map.Entry;
 import java.util.concurrent.ConcurrentHashMap;
 import java.util.concurrent.ConcurrentMap;
 
-import org.osgi.framework.BundleContext;
 import org.osgi.framework.ServiceReference;
-import org.osgi.service.log.LogService;
 
 /**
  * @version $Rev$ $Date$
  */
-public class MultiplePrototypeRefPair<S, T> extends RefPair<S, T>
+public class MultiplePrototypeRefPair<S, T> extends AbstractPrototypeRefPair<S, T>
 {
     private final ConcurrentMap<ComponentContextImpl<S>, T> instances = new ConcurrentHashMap<>();
 
@@ -42,77 +41,30 @@ public class MultiplePrototypeRefPair<S, T> extends RefPair<S, T>
     }
 
     @Override
-    public T getServiceObject(ComponentContextImpl<S> key)
-    {
-        return instances.get( key );
-    }
-
-    @Override
-    public boolean setServiceObject(ComponentContextImpl<S> key, T serviceObject)
+    public String toString()
     {
-        return instances.putIfAbsent( key, serviceObject ) == null;
+        return "[MultiplePrototypeRefPair: ref: [" + getRef() + "] has service: [" + !instances.isEmpty() + "]]";
     }
 
     @Override
-    public T ungetServiceObject(ComponentContextImpl<S> key)
-    {
-    	if ( key == null )
-    	{
-			final Iterator<Entry<ComponentContextImpl<S>, T>> iter = instances.entrySet().iterator();
-			while ( iter.hasNext() ) 
-			{
-				Entry<ComponentContextImpl<S>, T> e = iter.next();
-				doUngetService( e.getKey(), e.getValue() );
-   			} 
-    		instances.clear();
-    		return null ;
-    	}
-        T service = instances.remove( key );
-        if(service != null) {
-        	doUngetService( key, service );
-        }
-		return service;
+    public T getServiceObject(ComponentContextImpl<S> key) {
+        return instances.get(key);
     }
 
     @Override
-    public void ungetServiceObjects(BundleContext bundleContext) {
-        ungetServiceObject(null);
+    public boolean setServiceObject(ComponentContextImpl<S> key, T serviceObject) {
+        return instances.putIfAbsent(key, serviceObject) == null;
     }
 
     @Override
-    public String toString()
-    {
-        return "[MultiplePrototypeRefPair: ref: [" + getRef() + "] has service: [" + !instances.isEmpty() + "]]";
+    protected T remove(ComponentContextImpl<S> key) {
+        return instances.remove(key);
     }
 
     @Override
-    public boolean getServiceObject(ComponentContextImpl<S> key, BundleContext context)
-    {
-        final T service = key.getComponentServiceObjectsHelper().getPrototypeRefInstance(this.getRef());
-        if ( service == null )
-        {
-            setFailed();
-            key.getLogger().log(
-                 LogService.LOG_WARNING,
-                 "Could not get service from serviceobjects for ref {0}", null, getRef() );
-            return false;
-        }
-        if (!setServiceObject(key, service))
-        {
-            // Another thread got the service before, so unget our
-        	doUngetService( key, service );
-        }
-        return true;
+    protected Collection<Entry<ComponentContextImpl<S>, T>> clearEntries() {
+        Collection<Entry<ComponentContextImpl<S>, T>> result = new ArrayList<>(instances.entrySet());
+        instances.clear();
+        return result;
     }
-
-	private void doUngetService(ComponentContextImpl<S> key, final T service) {
-		try 
-		{
-			key.getComponentServiceObjectsHelper().getServiceObjects(getRef()).ungetService( service );
-		}
-		catch ( final IllegalStateException ise )
-		{
-			// ignore
-		}
-	}
 }
diff --git a/scr/src/main/java/org/apache/felix/scr/impl/manager/SinglePrototypeRefPair.java b/scr/src/main/java/org/apache/felix/scr/impl/manager/SinglePrototypeRefPair.java
index 76f552058c..2da0a14d54 100644
--- a/scr/src/main/java/org/apache/felix/scr/impl/manager/SinglePrototypeRefPair.java
+++ b/scr/src/main/java/org/apache/felix/scr/impl/manager/SinglePrototypeRefPair.java
@@ -20,26 +20,21 @@
 
 package org.apache.felix.scr.impl.manager;
 
+import java.util.Collection;
+import java.util.Collections;
+import java.util.Map;
+import java.util.AbstractMap.SimpleImmutableEntry;
+import java.util.Map.Entry;
 import java.util.concurrent.atomic.AtomicReference;
 
-import org.osgi.framework.BundleContext;
 import org.osgi.framework.ServiceReference;
-import org.osgi.service.log.LogService;
 
 /**
  * @version $Rev$ $Date$
  */
-public class SinglePrototypeRefPair<S, T> extends RefPair<S, T>
+public class SinglePrototypeRefPair<S, T> extends AbstractPrototypeRefPair<S, T>
 {
-    class SingleKeyService {
-        final ComponentContextImpl<S> key;
-        final T serviceObject;
-        SingleKeyService(ComponentContextImpl<S> key, T serviceObject) {
-            this.key = key;
-            this.serviceObject = serviceObject;
-        }
-    }
-    protected AtomicReference<SingleKeyService> serviceObjectRef = new AtomicReference<>();
+    private final AtomicReference<SimpleImmutableEntry<ComponentContextImpl<S>, T>> instance = new AtomicReference<>();
 
     public SinglePrototypeRefPair( ServiceReference<T> ref )
     {
@@ -47,71 +42,42 @@ public class SinglePrototypeRefPair<S, T> extends RefPair<S, T>
     }
 
     @Override
-    public T getServiceObject(ComponentContextImpl<S> key)
+    public String toString()
     {
-        SingleKeyService service = serviceObjectRef.get();
-        return service == null ? null : service.serviceObject;
+        return "[SinglePrototypeRefPair: ref: [" + getRef() + "] service: [" + getServiceObject(null) + "]]";
     }
 
     @Override
-    public boolean setServiceObject(ComponentContextImpl<S> key, T serviceObject)
-    {
-        return serviceObjectRef.compareAndSet(null, new SingleKeyService(key, serviceObject ));
+    public T getServiceObject(ComponentContextImpl<S> key) {
+        return internalGetServiceObject(key, false);
     }
 
     @Override
-    public T ungetServiceObject(ComponentContextImpl<S> key)
-    {
-        SingleKeyService service = serviceObjectRef.getAndSet(null);
-        if (service != null) {
-            if (key == null) {
-                key = service.key;
-            }
-            doUngetService(key, service.serviceObject);
-            return service.serviceObject;
-        }
-		return null;
+    public boolean setServiceObject(ComponentContextImpl<S> key, T serviceObject) {
+        return instance.compareAndSet(null, new SimpleImmutableEntry<>(key, serviceObject));
     }
 
     @Override
-    public void ungetServiceObjects(BundleContext bundleContext) {
-        ungetServiceObject(null);
+    protected T remove(ComponentContextImpl<S> key) {
+        return internalGetServiceObject(key, true);
     }
 
-    @Override
-    public String toString()
-    {
-        return "[SinglePrototypeRefPair: ref: [" + getRef() + "] service: [" + getServiceObject(null) + "]]";
+    private T internalGetServiceObject(ComponentContextImpl<S> key, boolean remove) {
+        SimpleImmutableEntry<ComponentContextImpl<S>, T> entry = instance.get();
+        if (entry == null) {
+            return null;
+        }
+        T result = key == null || entry.getKey().equals(key) ? entry.getValue() : null;
+        if (remove && result != null) {
+            instance.compareAndSet(entry, null);
+        }
+        return result;
     }
 
     @Override
-    public boolean getServiceObject(ComponentContextImpl<S> key, BundleContext context)
-    {
-    	final T service = key.getComponentServiceObjectsHelper().getPrototypeRefInstance(this.getRef());
-        if ( service == null )
-        {
-            setFailed();
-            key.getLogger().log(
-                 LogService.LOG_WARNING,
-                 "Could not get service from serviceobjects for ref {0}", null, getRef() );
-            return false;
-        }
-        if (!setServiceObject(key, service))
-        {
-            // Another thread got the service before, so unget our
-        	doUngetService( key, service );
-        }
-        return true;
+    protected Collection<Entry<ComponentContextImpl<S>, T>> clearEntries() {
+        Map.Entry<ComponentContextImpl<S>, T> entry = instance.getAndSet(null);
+        return entry == null ? Collections.<Entry<ComponentContextImpl<S>, T>>emptyList() : Collections.singleton(entry);
     }
 
-	private void doUngetService(ComponentContextImpl<S> key, final T service) {
-		try 
-		{
-			key.getComponentServiceObjectsHelper().getServiceObjects(getRef()).ungetService( service );
-		}
-		catch ( final IllegalStateException ise )
-		{
-			// ignore
-		}
-	}
 }
diff --git a/scr/src/main/java/org/apache/felix/scr/impl/manager/SingleRefPair.java b/scr/src/main/java/org/apache/felix/scr/impl/manager/SingleRefPair.java
index f9b8df5528..eec52d1263 100644
--- a/scr/src/main/java/org/apache/felix/scr/impl/manager/SingleRefPair.java
+++ b/scr/src/main/java/org/apache/felix/scr/impl/manager/SingleRefPair.java
@@ -31,7 +31,7 @@ import org.osgi.service.log.LogService;
  */
 public class SingleRefPair<S, T> extends RefPair<S, T>
 {
-    protected AtomicReference<T> serviceObjectRef = new AtomicReference<>();
+    private final AtomicReference<T> serviceObjectRef = new AtomicReference<>();
 
     public SingleRefPair( ServiceReference<T> ref )
     {
