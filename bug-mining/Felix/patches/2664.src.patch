diff --git a/configadmin/changelog.txt b/configadmin/changelog.txt
index a930821683..132fe9830b 100644
--- a/configadmin/changelog.txt
+++ b/configadmin/changelog.txt
@@ -1,3 +1,13 @@
+Changes from 1.8.8 to 1.8.10
+----------------------------
+
+** Improvement
+    * [FELIX-5088] - CaseSensitiveDictionary should implement equals()
+
+** Bug
+    * [FELIX-5301] - ConfigurationPlugin support is not spec compliant
+
+
 Changes from 1.8.6 to 1.8.8
 ---------------------------
 
diff --git a/configadmin/src/main/java/org/apache/felix/cm/impl/CaseInsensitiveDictionary.java b/configadmin/src/main/java/org/apache/felix/cm/impl/CaseInsensitiveDictionary.java
index b41ee56fbe..3433eef14d 100644
--- a/configadmin/src/main/java/org/apache/felix/cm/impl/CaseInsensitiveDictionary.java
+++ b/configadmin/src/main/java/org/apache/felix/cm/impl/CaseInsensitiveDictionary.java
@@ -414,6 +414,82 @@ public class CaseInsensitiveDictionary extends Dictionary<String, Object>
         return true;
     }
 
+    public static Dictionary<String, Object> unmodifiable(Dictionary<String, Object> dict) {
+        return new UnmodifiableDictionary(dict);
+    }
+
+    public static final class UnmodifiableDictionary extends Dictionary<String, Object>
+    {
+        private final Dictionary<String, Object> delegatee;
+
+        public UnmodifiableDictionary(final Dictionary<String, Object> delegatee)
+        {
+            this.delegatee = delegatee;
+        }
+
+        @Override
+        public Object put(String key, Object value)
+        {
+            // prevent put
+            return null;
+        }
+
+        @Override
+        public Object remove(Object key)
+        {
+            // prevent remove
+            return null;
+        }
+
+        @Override
+        public int hashCode()
+        {
+            return delegatee.hashCode();
+        }
+
+        @Override
+        public boolean equals(Object obj)
+        {
+            return delegatee.equals(obj);
+        }
+
+        @Override
+        public String toString()
+        {
+            return delegatee.toString();
+        }
+
+        @Override
+        public int size()
+        {
+            return delegatee.size();
+        }
+
+        @Override
+        public boolean isEmpty()
+        {
+            return delegatee.isEmpty();
+        }
+
+        @Override
+        public Enumeration<String> keys()
+        {
+            return delegatee.keys();
+        }
+
+        @Override
+        public Enumeration<Object> elements()
+        {
+            return delegatee.elements();
+        }
+
+        @Override
+        public Object get(Object key)
+        {
+            return delegatee.get(key);
+        }
+    }
+
     public static final Comparator<String> CASE_INSENSITIVE_ORDER = new CaseInsensitiveComparator();
 
     private static class CaseInsensitiveComparator implements Comparator<String>
diff --git a/configadmin/src/main/java/org/apache/felix/cm/impl/ConfigurationManager.java b/configadmin/src/main/java/org/apache/felix/cm/impl/ConfigurationManager.java
index ce37e97408..a8f9e25215 100644
--- a/configadmin/src/main/java/org/apache/felix/cm/impl/ConfigurationManager.java
+++ b/configadmin/src/main/java/org/apache/felix/cm/impl/ConfigurationManager.java
@@ -818,7 +818,7 @@ public class ConfigurationManager implements BundleActivator, BundleListener
             List pmList = new ArrayList();
             CachingPersistenceManagerProxy[] pm;
 
-            ServiceReference[] refs = persistenceManagerTracker.getServiceReferences();
+            ServiceReference<?>[] refs = persistenceManagerTracker.getServiceReferences();
             if ( refs == null || refs.length == 0 )
             {
                 pm = new CachingPersistenceManagerProxy[0];
@@ -1110,7 +1110,7 @@ public class ConfigurationManager implements BundleActivator, BundleListener
     public void callPlugins( final Dictionary props, final ServiceReference sr, final String configPid,
         final String factoryPid )
     {
-        ServiceReference[] plugins = null;
+        ServiceReference<?>[] plugins = null;
         try
         {
             final String targetPid = (factoryPid == null) ? configPid : factoryPid;
@@ -1137,13 +1137,22 @@ public class ConfigurationManager implements BundleActivator, BundleListener
         // call the plugins in order
         for ( int i = 0; i < plugins.length; i++ )
         {
-            ServiceReference pluginRef = plugins[i];
+            ServiceReference<?> pluginRef = plugins[i];
             ConfigurationPlugin plugin = ( ConfigurationPlugin ) bundleContext.getService( pluginRef );
             if ( plugin != null )
             {
+                // if cmRanking is below 0 or above 1000, ignore modifications from the plugin
+                boolean ignore = false;
+                Object rankObj = pluginRef.getProperty( ConfigurationPlugin.CM_RANKING );
+                if ( rankObj instanceof Integer )
+                {
+                    final int ranking = ( ( Integer ) rankObj ).intValue();
+                    ignore = (ranking < 0 ) || (ranking > 1000);
+                }
+
                 try
                 {
-                    plugin.modifyConfiguration( sr, props );
+                    plugin.modifyConfiguration( sr, ignore ? CaseInsensitiveDictionary.unmodifiable(props) : props );
                 }
                 catch ( Throwable t )
                 {
diff --git a/configadmin/src/main/java/org/apache/felix/cm/impl/RankingComparator.java b/configadmin/src/main/java/org/apache/felix/cm/impl/RankingComparator.java
index 627e5446fb..cca19ba2af 100644
--- a/configadmin/src/main/java/org/apache/felix/cm/impl/RankingComparator.java
+++ b/configadmin/src/main/java/org/apache/felix/cm/impl/RankingComparator.java
@@ -29,10 +29,10 @@ import org.osgi.service.cm.ConfigurationPlugin;
 /**
  * The <code>RankingComparator</code> may be used to maintain sorted
  * sets or to sort arrays such that the first element in the set or
- * array is the one to use first and the last elementis the one to
+ * array is the one to use first and the last elements the one to
  * use last.
  */
-public abstract class RankingComparator implements Comparator
+public abstract class RankingComparator implements Comparator<ServiceReference<?>>
 {
 
     /**
@@ -47,20 +47,20 @@ public abstract class RankingComparator implements Comparator
      * <li><code>&gt; 0</code> if obj1 has lower ranking than obj2</li>
      * </ul>
      */
-    public static Comparator SRV_RANKING = new RankingComparator()
+    public static Comparator<ServiceReference<?>> SRV_RANKING = new RankingComparator()
     {
-        public int compare( Object obj1, Object obj2 )
+        public int compare( ServiceReference<?> obj1, ServiceReference<?> obj2 )
         {
-            final long id1 = this.getLong( ( ServiceReference ) obj1, Constants.SERVICE_ID );
-            final long id2 = this.getLong( ( ServiceReference ) obj2, Constants.SERVICE_ID );
+            final long id1 = this.getLong( obj1, Constants.SERVICE_ID );
+            final long id2 = this.getLong( obj2, Constants.SERVICE_ID );
 
             if ( id1 == id2 )
             {
                 return 0;
             }
 
-            final long rank1 = this.getLong( ( ServiceReference ) obj1, Constants.SERVICE_RANKING );
-            final long rank2 = this.getLong( ( ServiceReference ) obj2, Constants.SERVICE_RANKING );
+            final int rank1 = this.getInteger( obj1, Constants.SERVICE_RANKING );
+            final int rank2 = this.getInteger( obj2, Constants.SERVICE_RANKING );
 
             if ( rank1 == rank2 )
             {
@@ -79,7 +79,8 @@ public abstract class RankingComparator implements Comparator
      * the Configuration Admin specification. This results in collections
      * where the first element has the lowest ranking value and the last
      * element has the highest ranking value. Order amongst elements with
-     * the same ranking value is left undefined. Thus the results of this
+     * the same ranking value is left undefined, however we order it
+     * by service id, lowest last. Thus the results of this
      * comparator are as follows:
      * <ul>
      * <li><code>&lt; 0</code> if obj1 has lower ranking than obj2</li>
@@ -87,16 +88,24 @@ public abstract class RankingComparator implements Comparator
      * <li><code>&gt; 0</code> if obj1 has higher ranking than obj2</li>
      * </ul>
      */
-    public static Comparator CM_RANKING = new RankingComparator()
+    public static Comparator<ServiceReference<?>> CM_RANKING = new RankingComparator()
     {
-        public int compare( Object obj1, Object obj2 )
+        public int compare( ServiceReference<?> obj1, ServiceReference<?> obj2 )
         {
-            final long rank1 = this.getLong( ( ServiceReference ) obj1, ConfigurationPlugin.CM_RANKING );
-            final long rank2 = this.getLong( ( ServiceReference ) obj2, ConfigurationPlugin.CM_RANKING );
+            final long id1 = this.getLong( obj1, Constants.SERVICE_ID );
+            final long id2 = this.getLong( obj2, Constants.SERVICE_ID );
+
+            final int rank1 = this.getInteger( obj1, ConfigurationPlugin.CM_RANKING );
+            final int rank2 = this.getInteger( obj2, ConfigurationPlugin.CM_RANKING );
 
             if ( rank1 == rank2 )
             {
-                return 0;
+                if ( id1 == id2 )
+                {
+                    return 0;
+                }
+
+                return ( id1 > id2 ) ? -1 : 1;
             }
 
             return ( rank1 < rank2 ) ? -1 : 1;
@@ -104,16 +113,28 @@ public abstract class RankingComparator implements Comparator
 
     };
 
-    protected long getLong( ServiceReference sr, String property )
+
+    protected int getInteger( ServiceReference<?> sr, String property )
     {
         Object rankObj = sr.getProperty( property );
-        if ( rankObj instanceof Number )
+        if ( rankObj instanceof Integer )
         {
-            return ( ( Number ) rankObj ).longValue();
+            return ( ( Integer ) rankObj ).intValue();
         }
 
         // null or not an integer
         return 0;
     }
 
+    protected long getLong( ServiceReference<?> sr, String property )
+    {
+        Object rankObj = sr.getProperty( property );
+        if ( rankObj instanceof Long )
+        {
+            return ( ( Long ) rankObj ).longValue();
+        }
+
+        // null or not a long
+        return 0;
+    }
 }
diff --git a/configadmin/src/test/java/org/apache/felix/cm/impl/RankingComparatorTest.java b/configadmin/src/test/java/org/apache/felix/cm/impl/RankingComparatorTest.java
index 1fe4d1091d..5d648f4dc9 100644
--- a/configadmin/src/test/java/org/apache/felix/cm/impl/RankingComparatorTest.java
+++ b/configadmin/src/test/java/org/apache/felix/cm/impl/RankingComparatorTest.java
@@ -27,26 +27,26 @@ import java.util.Map;
 import java.util.Set;
 import java.util.TreeSet;
 
-import junit.framework.TestCase;
-
 import org.osgi.framework.Bundle;
 import org.osgi.framework.Constants;
 import org.osgi.framework.ServiceReference;
 import org.osgi.service.cm.ConfigurationPlugin;
 
+import junit.framework.TestCase;
+
 
 public class RankingComparatorTest extends TestCase
 {
 
-    private final Comparator srvRank = RankingComparator.SRV_RANKING;
-    private final Comparator cmRank = RankingComparator.CM_RANKING;
+    private final Comparator<ServiceReference<?>> srvRank = RankingComparator.SRV_RANKING;
+    private final Comparator<ServiceReference<?>> cmRank = RankingComparator.CM_RANKING;
 
 
     public void test_service_ranking_no_property()
     {
-        ServiceReference r1 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, null );
-        ServiceReference r2 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, null );
-        ServiceReference r3 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, null );
+        ServiceReference<?> r1 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, null );
+        ServiceReference<?> r2 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, null );
+        ServiceReference<?> r3 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, null );
 
         assertTrue( srvRank.compare( r1, r1 ) == 0 );
         assertTrue( srvRank.compare( r1, r2 ) < 0 );
@@ -61,24 +61,24 @@ public class RankingComparatorTest extends TestCase
         assertTrue( srvRank.compare( r3, r3 ) == 0 );
 
         assertTrue( cmRank.compare( r1, r1 ) == 0 );
-        assertTrue( cmRank.compare( r1, r2 ) == 0 );
-        assertTrue( cmRank.compare( r1, r3 ) == 0 );
+        assertTrue( cmRank.compare( r1, r2 ) > 0 );
+        assertTrue( cmRank.compare( r1, r3 ) > 0 );
 
-        assertTrue( cmRank.compare( r2, r1 ) == 0 );
+        assertTrue( cmRank.compare( r2, r1 ) < 0 );
         assertTrue( cmRank.compare( r2, r2 ) == 0 );
-        assertTrue( cmRank.compare( r2, r3 ) == 0 );
+        assertTrue( cmRank.compare( r2, r3 ) > 0 );
 
-        assertTrue( cmRank.compare( r3, r1 ) == 0 );
-        assertTrue( cmRank.compare( r3, r2 ) == 0 );
+        assertTrue( cmRank.compare( r3, r1 ) < 0 );
+        assertTrue( cmRank.compare( r3, r2 ) < 0 );
         assertTrue( cmRank.compare( r3, r3 ) == 0 );
     }
 
 
     public void test_service_ranking_property()
     {
-        ServiceReference r1 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, new Integer( 100 ) );
-        ServiceReference r2 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, new Integer( -100 ) );
-        ServiceReference r3 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, null );
+        ServiceReference<?> r1 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, new Integer( 100 ) );
+        ServiceReference<?> r2 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, new Integer( -100 ) );
+        ServiceReference<?> r3 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, null );
 
         assertTrue( srvRank.compare( r1, r1 ) == 0 );
         assertTrue( srvRank.compare( r1, r2 ) < 0 );
@@ -96,11 +96,11 @@ public class RankingComparatorTest extends TestCase
 
     public void test_service_cm_ranking_property()
     {
-        ServiceReference r1 = new MockServiceReference()
+        ServiceReference<?> r1 = new MockServiceReference()
             .setProperty( ConfigurationPlugin.CM_RANKING, new Integer( 100 ) );
-        ServiceReference r2 = new MockServiceReference().setProperty( ConfigurationPlugin.CM_RANKING,
+        ServiceReference<?> r2 = new MockServiceReference().setProperty( ConfigurationPlugin.CM_RANKING,
             new Integer( -100 ) );
-        ServiceReference r3 = new MockServiceReference().setProperty( ConfigurationPlugin.CM_RANKING, null );
+        ServiceReference<?> r3 = new MockServiceReference().setProperty( ConfigurationPlugin.CM_RANKING, null );
 
         assertTrue( cmRank.compare( r1, r1 ) == 0 );
         assertTrue( cmRank.compare( r1, r2 ) > 0 );
@@ -118,10 +118,10 @@ public class RankingComparatorTest extends TestCase
 
     public void test_service_ranking_sort()
     {
-        ServiceReference r1 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, new Integer( 100 ) );
-        ServiceReference r2 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, new Integer( -100 ) );
-        ServiceReference r3 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, null );
-        ServiceReference[] refs =
+        ServiceReference<?> r1 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, new Integer( 100 ) );
+        ServiceReference<?> r2 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, new Integer( -100 ) );
+        ServiceReference<?> r3 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, null );
+        ServiceReference<?>[] refs =
             { r1, r2, r3 };
 
         assertSame( r1, refs[0] );
@@ -138,16 +138,16 @@ public class RankingComparatorTest extends TestCase
 
     public void test_service_ranking_set()
     {
-        ServiceReference r1 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, new Integer( 100 ) );
-        ServiceReference r2 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, new Integer( -100 ) );
-        ServiceReference r3 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, null );
+        ServiceReference<?> r1 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, new Integer( 100 ) );
+        ServiceReference<?> r2 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, new Integer( -100 ) );
+        ServiceReference<?> r3 = new MockServiceReference().setProperty( Constants.SERVICE_RANKING, null );
 
-        Set refSet = new TreeSet( srvRank );
+        Set<ServiceReference<?>> refSet = new TreeSet<ServiceReference<?>>( srvRank );
         refSet.add( r1 );
         refSet.add( r2 );
         refSet.add( r3 );
 
-        Iterator refIter = refSet.iterator();
+        Iterator<ServiceReference<?>> refIter = refSet.iterator();
         assertSame( r1, refIter.next() );
         assertSame( r3, refIter.next() );
         assertSame( r2, refIter.next() );
@@ -156,12 +156,12 @@ public class RankingComparatorTest extends TestCase
 
     public void test_service_cm_ranking_sort()
     {
-        ServiceReference r1 = new MockServiceReference()
+        ServiceReference<?> r1 = new MockServiceReference()
             .setProperty( ConfigurationPlugin.CM_RANKING, new Integer( 100 ) );
-        ServiceReference r2 = new MockServiceReference().setProperty( ConfigurationPlugin.CM_RANKING,
+        ServiceReference<?> r2 = new MockServiceReference().setProperty( ConfigurationPlugin.CM_RANKING,
             new Integer( -100 ) );
-        ServiceReference r3 = new MockServiceReference().setProperty( ConfigurationPlugin.CM_RANKING, null );
-        ServiceReference[] refs =
+        ServiceReference<?> r3 = new MockServiceReference().setProperty( ConfigurationPlugin.CM_RANKING, null );
+        ServiceReference<?>[] refs =
             { r1, r2, r3 };
 
         assertSame( r1, refs[0] );
@@ -178,29 +178,29 @@ public class RankingComparatorTest extends TestCase
 
     public void test_service_cm_ranking_set()
     {
-        ServiceReference r1 = new MockServiceReference()
+        ServiceReference<?> r1 = new MockServiceReference()
             .setProperty( ConfigurationPlugin.CM_RANKING, new Integer( 100 ) );
-        ServiceReference r2 = new MockServiceReference().setProperty( ConfigurationPlugin.CM_RANKING,
+        ServiceReference<?> r2 = new MockServiceReference().setProperty( ConfigurationPlugin.CM_RANKING,
             new Integer( -100 ) );
-        ServiceReference r3 = new MockServiceReference().setProperty( ConfigurationPlugin.CM_RANKING, null );
+        ServiceReference<?> r3 = new MockServiceReference().setProperty( ConfigurationPlugin.CM_RANKING, null );
 
-        Set refSet = new TreeSet( cmRank );
+        Set<ServiceReference<?>> refSet = new TreeSet<ServiceReference<?>>( cmRank );
         refSet.add( r1 );
         refSet.add( r2 );
         refSet.add( r3 );
 
-        Iterator refIter = refSet.iterator();
+        Iterator<ServiceReference<?>> refIter = refSet.iterator();
         assertSame( r2, refIter.next() );
         assertSame( r3, refIter.next() );
         assertSame( r1, refIter.next() );
     }
 
-    private static class MockServiceReference implements ServiceReference
+    private static class MockServiceReference implements ServiceReference<Object>
     {
 
         static long id = 0;
 
-        private final Map props = new HashMap();
+        private final Map<String, Object> props = new HashMap<String, Object>();
 
         {
             props.put( Constants.SERVICE_ID, new Long( id ) );
@@ -230,7 +230,7 @@ public class RankingComparatorTest extends TestCase
 
         public String[] getPropertyKeys()
         {
-            return ( String[] ) props.keySet().toArray( new String[props.size()] );
+            return props.keySet().toArray( new String[props.size()] );
         }
 
 
@@ -258,6 +258,7 @@ public class RankingComparatorTest extends TestCase
         }
 
 
+        @Override
         public String toString()
         {
             return "ServiceReference " + getProperty( Constants.SERVICE_ID );
