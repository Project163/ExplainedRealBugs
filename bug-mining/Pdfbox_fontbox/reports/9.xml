<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:48:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-808] PDTrueTypeFont.loadTTF() freezes (at TTFDataStream.java:195)</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-808</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;Sometimes (not always), my app &quot;freezes&quot;. When I look into jVisualVM thread dump, I see this stack trace:&lt;/p&gt;

&lt;p&gt;   java.lang.Thread.State: RUNNABLE&lt;br/&gt;
	at org.apache.fontbox.ttf.TTFDataStream.read(TTFDataStream.java:195)&lt;br/&gt;
	at org.apache.fontbox.ttf.TTFDataStream.readString(TTFDataStream.java:69)&lt;br/&gt;
	at org.apache.fontbox.ttf.TTFDataStream.readString(TTFDataStream.java:57)&lt;br/&gt;
	at org.apache.fontbox.ttf.PostScriptTable.initData(PostScriptTable.java:104)&lt;br/&gt;
	at org.apache.fontbox.ttf.TTFParser.parseTTF(TTFParser.java:140)&lt;br/&gt;
	at org.apache.fontbox.ttf.TTFParser.parseTTF(TTFParser.java:87)&lt;br/&gt;
	at org.apache.pdfbox.pdmodel.font.PDTrueTypeFont.loadDescriptorDictionary(PDTrueTypeFont.java:206)&lt;br/&gt;
	at org.apache.pdfbox.pdmodel.font.PDTrueTypeFont.loadTTF(PDTrueTypeFont.java:167)&lt;br/&gt;
	at org.apache.pdfbox.pdmodel.font.PDTrueTypeFont.loadTTF(PDTrueTypeFont.java:143)&lt;br/&gt;
	at org.apache.pdfbox.pdmodel.font.PDTrueTypeFont.loadTTF(PDTrueTypeFont.java:130)&lt;/p&gt;

&lt;p&gt;It never returns and blocks the application from continuing. This hapend several times now every few hours.&lt;/p&gt;</description>
                <environment>PDFBox 1.2.1, JDK 1.6.0_21, Windows XP 32 Bit.</environment>
        <key id="12473023">PDFBOX-808</key>
            <summary>PDTrueTypeFont.loadTTF() freezes (at TTFDataStream.java:195)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jukkaz">Jukka Zitting</assignee>
                                    <reporter username="mhilpert">MH</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 Sep 2010 11:05:11 +0000</created>
                <updated>Tue, 26 Oct 2010 09:34:29 +0000</updated>
                            <resolved>Fri, 3 Sep 2010 12:31:16 +0000</resolved>
                                    <version>1.2.1</version>
                                    <fixVersion>1.3.1</fixVersion>
                                    <component>FontBox</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12905003" author="lehmi" created="Wed, 1 Sep 2010 11:53:59 +0000"  >&lt;p&gt;Is this issue always triggered by the same pdf? What exactly are you doing, text extrcation, rendering, creating a new pdf?&lt;/p&gt;</comment>
                            <comment id="12905449" author="mhilpert" created="Thu, 2 Sep 2010 08:24:27 +0000"  >&lt;p&gt;Nope, it happens occasionally for arbitrary PDFs (that are generated before with Apache FOP). I load a PDF file and try to add additional text to it - with a custom font.&lt;/p&gt;

&lt;p&gt;Okay, I am able to reproduce it: it&apos;s a specific TTF font! PDTrueTypeFont.loadTTF() blocks with the stack trace I posted above. The font is called &quot;nbrm____.ttf&quot; (&quot;NewBaskervilleEF-Roman (TrueType&quot;).&lt;/p&gt;

&lt;p&gt;By the way: this font make no problems in other applications. E.g. another application still use iText 2.1.7 to also add text to PDFs. And this application use the same font source directory. The very same font file has no probelm there.&lt;/p&gt;</comment>
                            <comment id="12905472" author="mhilpert" created="Thu, 2 Sep 2010 11:12:30 +0000"  >&lt;p&gt;When I look at org.apache.fontbox.ttf.TTFDataStream.java:&lt;/p&gt;

&lt;p&gt;-------------&lt;br/&gt;
    public byte[] read( int numberOfBytes ) throws IOException&lt;br/&gt;
    {&lt;br/&gt;
        byte[] data = new byte[ numberOfBytes ];&lt;br/&gt;
        int amountRead = 0;&lt;br/&gt;
        int totalAmountRead = 0;&lt;br/&gt;
        while( (amountRead = read( data, totalAmountRead, numberOfBytes-totalAmountRead ) ) != -1 &amp;amp;&amp;amp; &lt;br/&gt;
               totalAmountRead &amp;lt; numberOfBytes )&lt;/p&gt;
        {
            totalAmountRead += amountRead;    //&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt; HERE !!!!!!!!
            //read at most numberOfBytes bytes from the stream.
        }
&lt;p&gt;        return data;&lt;br/&gt;
    }&lt;br/&gt;
-----------------&lt;/p&gt;

&lt;p&gt;The thread dump shows &lt;/p&gt;

&lt;p&gt; totalAmountRead += amountRead&lt;/p&gt;

&lt;p&gt;as the place where it &quot;hangs&quot;. When I look at jVisualVM&apos;s monitors, it shows 50% CPU usage (as the VM only has this 1 thread, it means that PDFBox uses 100% of 1 of the 2 cores). So this seems like an endless loop. Memory consumption slowly increases just to drop after 7 minutes (probably when the garbage collector cleans up).&lt;/p&gt;

&lt;p&gt;The file &quot;nbrm____.ttf&quot; is only 97 KB of size. Something seems to be broken ...&lt;/p&gt;</comment>
                            <comment id="12905873" author="jukkaz" created="Fri, 3 Sep 2010 12:31:16 +0000"  >&lt;p&gt;There was indeed a potential for an endless loop. I fixed that in revision 992278 by switching the order of the loop conditions.&lt;/p&gt;</comment>
                            <comment id="12906049" author="mhilpert" created="Fri, 3 Sep 2010 20:03:10 +0000"  >&lt;p&gt;Ehm, you just exchanged&lt;/p&gt;

&lt;p&gt;        while( (amountRead = read( data, totalAmountRead, numberOfBytes-totalAmountRead ) ) != -1 &amp;amp;&amp;amp;  totalAmountRead &amp;lt; numberOfBytes ) &lt;br/&gt;
        { &lt;br/&gt;
            totalAmountRead += amountRead; &lt;/p&gt;

&lt;p&gt;with&lt;/p&gt;

&lt;p&gt;        while(totalAmountRead &amp;lt; numberOfBytes &amp;amp;&amp;amp; (amountRead = read( data, totalAmountRead, numberOfBytes-totalAmountRead ) ) != -1 ) &lt;br/&gt;
        { &lt;br/&gt;
            totalAmountRead += amountRead; &lt;/p&gt;

&lt;p&gt;How should this change anything? This is a boolean AND operation so both operands need to be true. And even though &quot;amountRead&quot; might be changed, this doesn&apos;t change anything for the whole loop condition. Can you supply a current JAR so that I can test it? (Then I don&apos;t have to go through the process of learning how to check the source out, compile it hopefully without erros.)&lt;/p&gt;</comment>
                            <comment id="12906119" author="jukkaz" created="Fri, 3 Sep 2010 21:44:10 +0000"  >&lt;p&gt;You&apos;re right, that was some sloppy thinking by me. I was just looking at protecting against the &quot;numberOfBytes-totalAmountRead&quot; argument being zero, but of course even in such cases the second half of the AND condition would have broken the loop after one unnecessary read() call.&lt;/p&gt;

&lt;p&gt;It turns out that the problem was in the MemoryTTFDataStream class that would return 0 instead of -1 when the end of the stream is reached. That shouldn&apos;t normally be a problem given the way TTF files are parsed, but will cause the infinite loop when dealing with a truncated or otherwise malformed file. I fixed this problem in revision 992483, and made TTFDataStream.read(int) throw an IOException in case such an unexpected end of the TTF stream is encountered.&lt;/p&gt;

&lt;p&gt;You can get the latest snapshot jars from &lt;a href=&quot;https://repository.apache.org/content/groups/snapshots-group/org/apache/pdfbox/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/groups/snapshots-group/org/apache/pdfbox/&lt;/a&gt;. Our CI build will push a new version up there within an hour or so.&lt;/p&gt;</comment>
                            <comment id="12906447" author="mhilpert" created="Mon, 6 Sep 2010 08:10:29 +0000"  >&lt;p&gt;I teste with &lt;/p&gt;

&lt;p&gt;pdfbox-1.3.0-20100905.174656-31.jar&lt;br/&gt;
fontbox-1.3.0-20100905.174656-32.jar&lt;/p&gt;

&lt;p&gt;and now I get this Exception:&lt;/p&gt;

&lt;p&gt;----------------------------------------------------&lt;br/&gt;
    java.io.IOException: Unexpected end of TTF stream reached&lt;br/&gt;
    	at org.apache.fontbox.ttf.TTFDataStream.read(TTFDataStream.java:200)&lt;br/&gt;
    	at org.apache.fontbox.ttf.TTFDataStream.readString(TTFDataStream.java:69)&lt;br/&gt;
    	at org.apache.fontbox.ttf.TTFDataStream.readString(TTFDataStream.java:57)&lt;br/&gt;
    	at org.apache.fontbox.ttf.PostScriptTable.initData(PostScriptTable.java:104)&lt;br/&gt;
    	at org.apache.fontbox.ttf.TTFParser.parseTTF(TTFParser.java:140)&lt;br/&gt;
    	at org.apache.fontbox.ttf.TTFParser.parseTTF(TTFParser.java:87)&lt;br/&gt;
    	at org.apache.pdfbox.pdmodel.font.PDTrueTypeFont.loadDescriptorDictionary(PDTrueTypeFont.java:206)&lt;br/&gt;
    	at org.apache.pdfbox.pdmodel.font.PDTrueTypeFont.loadTTF(PDTrueTypeFont.java:167)&lt;br/&gt;
    	at org.apache.pdfbox.pdmodel.font.PDTrueTypeFont.loadTTF(PDTrueTypeFont.java:143)&lt;br/&gt;
    	at org.apache.pdfbox.pdmodel.font.PDTrueTypeFont.loadTTF(PDTrueTypeFont.java:130)&lt;br/&gt;
------------------------------------------------&lt;/p&gt;

&lt;p&gt;which is of course better than freezing. But it doesn&apos;t help me much further as other apps don&apos;t have problems with this font. So I guess, there might be some other problem in PDFBox reading fonts.&lt;/p&gt;</comment>
                            <comment id="12906453" author="jukkaz" created="Mon, 6 Sep 2010 08:16:31 +0000"  >&lt;p&gt;Can you attach the troublesome ttf file?&lt;/p&gt;</comment>
                            <comment id="12906986" author="jukkaz" created="Tue, 7 Sep 2010 21:58:24 +0000"  >&lt;p&gt;Thanks for the attachment! I debugged the parsing process and found out that the font file uses glyph name indexes in the reserved range from 32768 to 65535 (see version 2.0 in &lt;a href=&quot;http://www.microsoft.com/typography/otspec/post.htm&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.microsoft.com/typography/otspec/post.htm&lt;/a&gt;). The parsing algorithm in FontBox was not prepared to handle such reserved glyph name indexes,  which is why it ended up trying to read past the end of the font file. I fixed that in revision 993541 by making the parser explicitly ignore such reserved glyph name indexes.&lt;/p&gt;</comment>
                            <comment id="12907194" author="mhilpert" created="Wed, 8 Sep 2010 12:42:11 +0000"  >&lt;p&gt;Tested with&lt;/p&gt;

&lt;p&gt;pdfbox-1.3.0-20100907.220349-33.jar&lt;br/&gt;
fontbox-1.3.0-20100907.220349-34.jar&lt;/p&gt;

&lt;p&gt;=&amp;gt; yahoo! Works! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12453935" name="nbrm____.zip" size="55509" author="mhilpert" created="Mon, 6 Sep 2010 10:02:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>163506</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 11 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0zfvb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>204873</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>