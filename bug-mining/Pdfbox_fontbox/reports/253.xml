<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:50:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-4242] Fontbox does not close file descriptor when loading fonts.</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-4242</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;My app has been getting &quot;java.io.FileNotFoundException (No file descriptors available)&quot; and I&apos;ve confirmed that&#160;it&apos;s because fontbox isn&apos;t closing it&apos;s file descriptors.&lt;/p&gt;

&lt;p&gt;In&#160;org.apache.fontbox.ttf.TTFParser there&apos;s this method:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;public TrueTypeFont parse(File ttfFile) throws IOException {&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; RAFDataStream raf = new RAFDataStream(ttfFile, &quot;r&quot;);&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160; try {&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; return this.parse((TTFDataStream)raf);&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; } catch (IOException var4) {&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; // close only on error (file is still being accessed later)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; raf.close();&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; throw var4;&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;}&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;}&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I would have expected to see the close() in a finally block so that the file is always closed, not just on exceptions. Presumably, you can keep it in memory without leaving the file descriptor open?&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;public TrueTypeFont parse(File ttfFile) throws IOException {&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; RAFDataStream raf = new RAFDataStream(ttfFile, &quot;r&quot;);&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160; try {&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; return this.parse((TTFDataStream)raf);&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; } catch (IOException var4) {&lt;/tt&gt;&lt;tt&gt;&#160; &#160; raf.close();&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; throw var4;&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; } finally {&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; raf.close();&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;}&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;}&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I tried performing this in a lazy initialization, but it blew up:&lt;/p&gt;

&lt;p&gt;java.lang.RuntimeException: java.io.IOException: The TrueType font null does not contain a &apos;cmap&apos; tableCaused by: java.io.IOException: The TrueType font null does not contain a &apos;cmap&apos; table&lt;br/&gt;
  at org.apache.fontbox.ttf.TrueTypeFont.getUnicodeCmapImpl(TrueTypeFont.java:548)&lt;br/&gt;
  at org.apache.fontbox.ttf.TrueTypeFont.getUnicodeCmapLookup(TrueTypeFont.java:528)&lt;br/&gt;
  at org.apache.fontbox.ttf.TrueTypeFont.getUnicodeCmapLookup(TrueTypeFont.java:514)&lt;br/&gt;
  at org.apache.fontbox.ttf.TTFSubsetter.&amp;lt;init&amp;gt;(TTFSubsetter.java:91)&lt;br/&gt;
  at org.apache.pdfbox.pdmodel.font.TrueTypeEmbedder.subset(TrueTypeEmbedder.java:321)&lt;br/&gt;
  at org.apache.pdfbox.pdmodel.font.PDType0Font.subset(PDType0Font.java:239)&lt;br/&gt;
  at org.apache.pdfbox.pdmodel.PDDocument.save(PDDocument.java:1271)&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;

&lt;p&gt;Thanks for PDFBox - it&apos;s been really helpful!&lt;/p&gt;</description>
                <environment></environment>
        <key id="13164743">PDFBOX-4242</key>
            <summary>Fontbox does not close file descriptor when loading fonts.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tilman">Tilman Hausherr</assignee>
                                    <reporter username="glen@organicdesign.org">Glen Peterson</reporter>
                        <labels>
                            <label>file_leak</label>
                    </labels>
                <created>Thu, 7 Jun 2018 17:28:14 +0000</created>
                <updated>Fri, 5 Oct 2018 04:53:26 +0000</updated>
                            <resolved>Thu, 5 Jul 2018 17:37:25 +0000</resolved>
                                    <version>2.0.9</version>
                                    <fixVersion>2.0.12</fixVersion>
                    <fixVersion>3.0.0 PDFBox</fixVersion>
                                    <component>FontBox</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16505041" author="glen@organicdesign.org" created="Thu, 7 Jun 2018 18:16:38 +0000"  >&lt;p&gt;If you&apos;re running on Linux, you can see the number of open file handles increase by finding the processID and calling in between each PDF:&lt;/p&gt;

&lt;p&gt;$ ls /proc/14205/fd | wc -l&lt;br/&gt;
101&lt;br/&gt;
$ ls /proc/14205/fd | wc -l&lt;br/&gt;
109&lt;br/&gt;
$ ls /proc/14205/fd | wc -l&lt;br/&gt;
117&lt;br/&gt;
$ ls /proc/14205/fd | wc -l&lt;br/&gt;
125&lt;/p&gt;

&lt;p&gt;I&apos;m loading 8 fonts.  I swapped the fonts for HELVETICA, recompiled, and performed the same test:&lt;br/&gt;
$ ls /proc/17083/fd | wc -l&lt;br/&gt;
97&lt;br/&gt;
$ ls /proc/17083/fd | wc -l&lt;br/&gt;
97&lt;br/&gt;
$ ls /proc/17083/fd | wc -l&lt;br/&gt;
97&lt;/p&gt;</comment>
                            <comment id="16505059" author="tilman" created="Thu, 7 Jun 2018 18:33:18 +0000"  >&lt;p&gt;You&apos;re expected to close the&#160;&lt;font color=&quot;#333333&quot;&gt;TrueTypeFont &lt;/font&gt;object after you&apos;re done.&lt;/p&gt;

&lt;p&gt;Are you using&#160;&lt;font color=&quot;#333333&quot;&gt;TrueTypeFont &lt;/font&gt;objects yourself, or are you suspecting that PDFBox doesn&apos;t close these?&lt;/p&gt;</comment>
                            <comment id="16505162" author="glen@organicdesign.org" created="Thu, 7 Jun 2018 19:46:28 +0000"  >&lt;p&gt;I&apos;m just calling PDType0Font.load(doc, fontFile).&lt;/p&gt;

&lt;p&gt;ttf is private in org.apache.pdfbox.pdmodel.font.PDType0Font, so I don&apos;t see how I would manually close it.&lt;/p&gt;

&lt;p&gt;Oh, you&apos;re saying I should call (new TTFParser()).parse(file) so that I have access to the TrueTypeFont so that I can close it?  It looks like the PDType0Font constructor should be closing it for me, no?  I&apos;m looking at the decompiled source to pdfbox-2.0.9.jar&lt;/p&gt;</comment>
                            <comment id="16505173" author="tilman" created="Thu, 7 Jun 2018 19:52:46 +0000"  >&lt;p&gt;Yes if you call &lt;tt&gt;new TTFParser()).parse(file)&lt;/tt&gt; then you can close it yourself. But if you use &lt;tt&gt;PDType0Font.load(doc, fontFile)&lt;/tt&gt;, then PDFBox should do it for you and if it doesn&apos;t, then maybe it is indeed a bug &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16505207" author="glen@organicdesign.org" created="Thu, 7 Jun 2018 20:24:34 +0000"  >&lt;p&gt;PDType0Font is &lt;b&gt;not&lt;/b&gt; closing it. I looked again here:&lt;br/&gt;
 &lt;a href=&quot;https://github.com/apache/pdfbox/blob/trunk/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/font/PDType0Font.java#L112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pdfbox/blob/trunk/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/font/PDType0Font.java#L112&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It&apos;s only closed automatically if closeOnSubset=true and embedSubset=false.&#160; They are both true&#160;when using the load() method I used.&lt;/p&gt;

&lt;p&gt;To close them, you&apos;d probably have to keep a list of open fonts, and close them when the document is closed.&#160; I&#160;can&#160;make my code do that.&#160; Thanks for talking me through this - it really helped!&lt;/p&gt;</comment>
                            <comment id="16506095" author="glen@organicdesign.org" created="Fri, 8 Jun 2018 14:43:54 +0000"  >&lt;p&gt;Thanks to the clarity from this discussion I was able to quickly eliminate my file descriptor leakage problem this morning.  To see how I worked around this issue, search for &apos;openFontFiles&apos; on this page:&lt;br/&gt;
&lt;a href=&quot;https://github.com/PlanBase/PdfLayoutMgr2/blob/master/src/main/java/com/planbase/pdf/layoutmanager/PdfLayoutMgr.kt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/PlanBase/PdfLayoutMgr2/blob/master/src/main/java/com/planbase/pdf/layoutmanager/PdfLayoutMgr.kt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I don&apos;t know if I can work on this, but if I submit a patch, would it be OK to just load each font into memory and close the file descriptor right away?  I don&apos;t know why it ever kept the file descriptor open, or if the reasons for that are still valid.  If you still need the file descriptors open, we could keep track of them inside PdType0Font.load() and free them inside PDDocument.close() so that clients don&apos;t have to, similar to what I did above, but in Java 6.&lt;/p&gt;

&lt;p&gt;I checked the usage example and it does the same thing I did, so it has a file descriptor leak.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/pdfbox/blob/trunk/examples/src/main/java/org/apache/pdfbox/examples/pdmodel/EmbeddedFonts.java#L49&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pdfbox/blob/trunk/examples/src/main/java/org/apache/pdfbox/examples/pdmodel/EmbeddedFonts.java#L49&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16509219" author="tilman" created="Tue, 12 Jun 2018 06:03:06 +0000"  >&lt;p&gt;But it is closed here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void subset() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
&#160;&#160;&#160; {
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!willBeSubset())
&#160;&#160;&#160;&#160;&#160;&#160;&#160; {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(&lt;span class=&quot;code-quote&quot;&gt;&quot;This font was created with subsetting disabled&quot;&lt;/span&gt;);
&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160; embedder.subset();
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ttf != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ttf.close();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ttf = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;tt&gt;subset()&lt;/tt&gt; is called by &lt;tt&gt;PDDocument.save()&lt;/tt&gt;.&lt;br/&gt;
You mentioned that you&apos;re creating your fonts by calling &lt;tt&gt;PDType0Font.load(doc, fontFile)&lt;/tt&gt;. This means that embedsubset and closeonsubset are true, so it won&apos;t be closed at the beginning, only when you subset, which is done on save. (This brings an interesting problem: what if somebody creates a PDDocument with subsetted fonts but doesn&apos;t save?)&lt;/p&gt;</comment>
                            <comment id="16515894" author="rototor" created="Mon, 18 Jun 2018 15:37:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; subset() will only be called when fonts are used in the document. If for whatever reason you are loading but not using a font, you will leak file handles...&#160;which can / will bring your (web-)server down when the file handle limit is exhausted...&lt;/p&gt;

&lt;p&gt;This can happen if you load all possible needed fonts upfront, but if they are used depends on the data you put in the PDF. (e.g. a Chinese font is only used when they are really Chinese characters etc.). I had this in production with OpenHTMLToPDF, see also&#160;&lt;a href=&quot;https://github.com/danfickle/openhtmltopdf/pull/215&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/danfickle/openhtmltopdf/pull/215&lt;/a&gt;. The workaround was to subset() all loaded fonts manually. As we had a handle on the TrueTypeFont I tried to close() it directly. But this causes a NPE as RAFDataStream.close() violates the close() contract, namely that calling close() twice should have no effect. But when called the second time RAFDataStream.close() will just throw a NPE.&#160;&lt;/p&gt;

&lt;p&gt;It would be nice if RAFDataStream.close() could be fixed (i.e. putting a if(raf!=null) before the raf.close()).&lt;/p&gt;</comment>
                            <comment id="16515911" author="tilman" created="Mon, 18 Jun 2018 15:47:26 +0000"  >&lt;p&gt;Thank you, I&apos;ll investigate. This won&apos;t be in time for 2.0.10 which is due for build today.&lt;/p&gt;</comment>
                            <comment id="16517260" author="jira-bot" created="Tue, 19 Jun 2018 16:01:07 +0000"  >&lt;p&gt;Commit 1833856 from tilman@apache.org in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1833856&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1833856&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4242&quot; title=&quot;Fontbox does not close file descriptor when loading fonts.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4242&quot;&gt;&lt;del&gt;PDFBOX-4242&lt;/del&gt;&lt;/a&gt;: fulfill the close() contract, as suggested by Emmeran Seehuber&lt;/p&gt;</comment>
                            <comment id="16517261" author="jira-bot" created="Tue, 19 Jun 2018 16:01:14 +0000"  >&lt;p&gt;Commit 1833857 from tilman@apache.org in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1833857&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1833857&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4242&quot; title=&quot;Fontbox does not close file descriptor when loading fonts.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4242&quot;&gt;&lt;del&gt;PDFBOX-4242&lt;/del&gt;&lt;/a&gt;: fulfill the close() contract, as suggested by Emmeran Seehuber&lt;/p&gt;</comment>
                            <comment id="16517271" author="tilman" created="Tue, 19 Jun 2018 16:10:33 +0000"  >&lt;p&gt;We could add a finalizer in TrueTypeFont. However &quot;Effective Java&quot; advises against doing this because there is no guarantee that the finalizer will run in time, or it could run on one JVM and not on another. (&quot;Item 8: Avoid finalizers and cleaners&quot;)&lt;/p&gt;

&lt;p&gt;So it&apos;s a design flaw... one possibility would be to attach fonts to a document as soon as it is created. However &lt;tt&gt;PDDocument.getFontsToSubset()&lt;/tt&gt; is package-local.&lt;/p&gt;

&lt;p&gt;A workaround for users is simple - for each font opened there should be at least be in one call to &lt;tt&gt;PDAbstractContentStream.setFont&lt;/tt&gt;. Or call &lt;tt&gt;PDDocument.subset()&lt;/tt&gt; for unused fonts only. (However this can go bad. I tried calling it twice and got an exception)&lt;/p&gt;

&lt;p&gt;I&apos;m thinking about making &lt;tt&gt;PDDocument.getFontsToSubset()&lt;/tt&gt; public and add the fonts to that list when they are loaded, not when they are used.&lt;/p&gt;</comment>
                            <comment id="16521927" author="rototor" created="Mon, 25 Jun 2018 06:57:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; Yes, using a finalizer is a no go, as it will likely never run. The way to go here is to use a PhantomReference and a ReferenceQueue to close the file handle. E.g.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TTFPhantomReference &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; PhantomReference&amp;lt;TrueTypeFont&amp;gt; {
  TTFPhantomReference(TrueTypeFont font) {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(font, TTFReferenceQueue.INSTANCE);
    dataToClose = font.data;
    &lt;span class=&quot;code-comment&quot;&gt;// Pin &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; reference, otherwise it will be GCed before it can &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; it&apos;s magic...
&lt;/span&gt;    TTFReferenceQueue.referencePin.add(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
  }

  TTFDataStream dataToClose;
}

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TTFReferenceQueue {
  &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TTFReferenceQueue INSTANCE = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TTFReferenceQueue();
 &lt;span class=&quot;code-comment&quot;&gt;/* Pin list, to not have the Referencer GCed before it could cleanup the objects */&lt;/span&gt;
 ConcurrentLinkedDeque&amp;lt;TTFPhantomReference&amp;gt; referencePin = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConcurrentLinkedDeque&amp;lt;TTFPhantomReference&amp;gt;();

  &lt;span class=&quot;code-comment&quot;&gt;/* The ugly part, we need a thread to poll the queue */&lt;/span&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; ttfPollThread = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(){
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run(){
  &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
    &lt;span class=&quot;code-comment&quot;&gt;// Block till we get a reference.   
&lt;/span&gt;    TTFPhantomReference ref =  INSTANCE.remove();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(ref != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ) {
      ref.close();
      referencePin.remove(ref);
    }
  }
}
};
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; {
  ttfPollThread.setDeamon(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
  ttfPollThread.start();
}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;No idea if the TrueTypeFont should be the object&#160;that is referenced in the PhantomReference, or if it should be a parent object (e.g. PDFont). The Phantom Reference just needs a reference to the resource that should be closed but of course not a reference to the owner object. This avoids the finalizer() resurrection problem, as the reference object will already be gone.&lt;/p&gt;

&lt;p&gt;The problem with this code is: It creates a static thread, which in turn may lead to a class loader leak.&#160;&lt;/p&gt;

&lt;p&gt;Guava does some special magic to avoid this problem and make it work correctly with container environments. If you could use Guava you would just make this code look like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TTFFileCloser {
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; FinalizableReferenceQueue queue = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FinalizableReferenceQueue();
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ConcurrentLinkedDeque&amp;lt;FinalizablePhantomReference&amp;lt;TrueTypeFont&amp;gt;&amp;gt; phantomReferencePinner = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConcurrentLinkedDeque&amp;lt;&amp;gt;();

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void closeFileIfNotReachable(TrueTypeFont owner, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TTFDataStream data) {
    FinalizablePhantomReference&amp;lt;TrueTypeFont&amp;gt; finalizablePhantomReference = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FinalizablePhantomReference&amp;lt;TrueTypeFont&amp;gt;(owner, queue) {
       @Override
       &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void finalizeReferent() {  
         data.close();
         phantomReferencePinner.remove(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
       }
    };
    &lt;span class=&quot;code-comment&quot;&gt;// Pin the reference to avoid it beeing GCed 
&lt;/span&gt;    phantomReferencePinner.add(finalizablePhantomReference);
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;PhantomReferences are queued very fast after the owner object is no longer reachable. I use this (with the Guava base classes) very successful to cleanup all my temp files. As you can&apos;t use Guava I don&apos;t know if you want to go this route, as getting this right in a servlet context is not that easy... Note: You don&apos;t need to create a background thread to do the cleanup, Guava has a fallback that it just will cleanup all references that are queued if a new reference is added to the list. But it only uses this if it can&apos;t create a background thread.&lt;/p&gt;</comment>
                            <comment id="16522498" author="tilman" created="Mon, 25 Jun 2018 16:30:59 +0000"  >&lt;p&gt;Surprisingly, phantomreference is not mentioned in &quot;Effective Java&quot;. However I don&apos;t see how it would help:&lt;br/&gt;
 &lt;a href=&quot;http://mindprod.com/jgloss/phantom.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mindprod.com/jgloss/phantom.html&lt;/a&gt;&lt;br/&gt;
 &quot;Lets you clean up after finalization but before the space is reclaimed (replaces or augments the use of finalize())&quot;&lt;/p&gt;


&lt;p&gt; So it brings the same troubles: we don&apos;t know if an object will ever be finalized. If there is enough memory, it might never be finalized.&lt;br/&gt;
 Re &quot;As you can&apos;t use Guava&quot; - indeed, it needs jdk8.&lt;/p&gt;


&lt;p&gt; Is there anything in your opinion that speaks against doing what I wrote in the second and last paragraph of my previous comment?&lt;/p&gt;</comment>
                            <comment id="16522518" author="rototor" created="Mon, 25 Jun 2018 16:49:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; PhantomReferences of course do not&#160;guarantee that the cleanup will run (which you have to do yourself in your own thread or whenever you like). If you terminate the JVM before the GC had a chance to run, the cleanup will&#160;of course not run.&lt;/p&gt;

&lt;p&gt;But there is a big difference to finalization: They can not resurrect the object. This means that the JVM does not need to wait some full GC cycles before it can start to call the finalizers, make some dances around the references etc. Instead the PhantomReference of an object is queued as soon as it is GCed - which can also happen with minor collects. So the time between &quot;object is no longer reachable&quot; to &quot;PhantomReference is queued&quot; is very short usually.&#160;&#160;&#160;&lt;/p&gt;

&lt;p&gt;Registering the font directly in the PDDocument&#160;and also ensuring that the font resources are freed as soon as close() is called on the document seems the sane thing to do here. I would not make getFontsToSubset() public, but rather add a registerFont() method - which must be of course public but should be marked as &quot;internal use only&quot;.&lt;/p&gt;</comment>
                            <comment id="16523968" author="tilman" created="Tue, 26 Jun 2018 16:46:44 +0000"  >&lt;p&gt;OK, I&apos;ll do something like this after the 2.0.11 release in a few days. It would be called by &lt;tt&gt;PDType0Font.load()&lt;/tt&gt; &lt;del&gt;and &lt;tt&gt;PDTrueTypeFont.load()&lt;/tt&gt;&lt;/del&gt; when the &lt;tt&gt;ttf&lt;/tt&gt; is left open:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    /**
     * For internal PDFBox use when creating PDF documents: register a TrueTypeFont to make sure it
     * is closed when the PDDocument is closed to avoid memory leaks. Users don&apos;t have to call &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
     * method, it is done by the appropriate PDFont classes.
     *
     * @param ttf
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void registerTrueTypeFont(TrueTypeFont ttf)
    {
        fontsToClose.add(ttf);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16532998" author="jira-bot" created="Wed, 4 Jul 2018 18:22:14 +0000"  >&lt;p&gt;Commit 1835076 from tilman@apache.org in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1835076&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1835076&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4242&quot; title=&quot;Fontbox does not close file descriptor when loading fonts.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4242&quot;&gt;&lt;del&gt;PDFBOX-4242&lt;/del&gt;&lt;/a&gt;: register fonts and close them when closing the document to avoid memory leaks&lt;/p&gt;</comment>
                            <comment id="16532999" author="jira-bot" created="Wed, 4 Jul 2018 18:22:19 +0000"  >&lt;p&gt;Commit 1835077 from tilman@apache.org in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1835077&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1835077&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4242&quot; title=&quot;Fontbox does not close file descriptor when loading fonts.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4242&quot;&gt;&lt;del&gt;PDFBOX-4242&lt;/del&gt;&lt;/a&gt;: register fonts and close them when closing the document to avoid memory leaks&lt;/p&gt;</comment>
                            <comment id="16533022" author="jira-bot" created="Wed, 4 Jul 2018 19:27:06 +0000"  >&lt;p&gt;Commit 1835081 from tilman@apache.org in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1835081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1835081&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4242&quot; title=&quot;Fontbox does not close file descriptor when loading fonts.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4242&quot;&gt;&lt;del&gt;PDFBOX-4242&lt;/del&gt;&lt;/a&gt;: fix javadoc&lt;/p&gt;</comment>
                            <comment id="16533940" author="jira-bot" created="Thu, 5 Jul 2018 17:36:12 +0000"  >&lt;p&gt;Commit 1835161 from tilman@apache.org in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1835161&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1835161&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4242&quot; title=&quot;Fontbox does not close file descriptor when loading fonts.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4242&quot;&gt;&lt;del&gt;PDFBOX-4242&lt;/del&gt;&lt;/a&gt;: better method name&lt;/p&gt;</comment>
                            <comment id="16533941" author="jira-bot" created="Thu, 5 Jul 2018 17:36:18 +0000"  >&lt;p&gt;Commit 1835162 from tilman@apache.org in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1835162&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1835162&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4242&quot; title=&quot;Fontbox does not close file descriptor when loading fonts.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4242&quot;&gt;&lt;del&gt;PDFBOX-4242&lt;/del&gt;&lt;/a&gt;: better method name&lt;/p&gt;</comment>
                            <comment id="16533944" author="tilman" created="Thu, 5 Jul 2018 17:37:25 +0000"  >&lt;p&gt;Done. Thanks both for the report and/or for the help!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 19 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3umnr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>