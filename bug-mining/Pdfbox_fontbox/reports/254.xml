<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:50:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-4219] Multithreading problem when rendering several documents with Standard 14 fonts</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-4219</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;I get rendering errors and sometimes exceptions in my regression tests. It is somehow related to several threads initializing standard 14 fonts. It happens only about every 25 times in a test program I created. That one renders 2 files in 4 threads and compares the result with the existing result.&lt;/p&gt;

&lt;p&gt;My theory is that one thread accesses the naming table and another accesses the glyf table, and both change the stream position. I tried several things in the last months to avoid it, all were unsuccessful and I lost my notes about it last winter due to a static discharge on a usb stick. (Thank you KINGSTON!)&lt;/p&gt;

&lt;p&gt;Here&apos;s the output when it doesn&apos;t go well:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;11.05.2018 10:54:26.322 WARN  [pool-1-thread-4] org.apache.pdfbox.pdmodel.font.PDType1Font:296 - Using fallback font TimesNewRomanPS-BoldMT for Galliard-Bold
11.05.2018 10:54:26.323 WARN  [pool-1-thread-2] org.apache.pdfbox.pdmodel.font.PDType1Font:296 - Using fallback font TimesNewRomanPS-BoldMT for Galliard-Bold
11.05.2018 10:54:26.386 WARN  [pool-1-thread-2] org.apache.pdfbox.pdmodel.font.PDType1Font:296 - Using fallback font TimesNewRomanPSMT for Galliard-Roman
11.05.2018 10:54:26.421 WARN  [pool-1-thread-4] org.apache.pdfbox.pdmodel.font.PDType1Font:296 - Using fallback font TimesNewRomanPSMT for Galliard-Roman
11.05.2018 10:54:26.697 WARN  [pool-1-thread-2] org.apache.pdfbox.pdmodel.font.PDType1Font:296 - Using fallback font TimesNewRomanPS-ItalicMT for Galliard-Italic
11.05.2018 10:54:26.818 WARN  [pool-1-thread-4] org.apache.pdfbox.pdmodel.font.PDType1Font:296 - Using fallback font TimesNewRomanPS-ItalicMT for Galliard-Italic
C:\Users\XXX\Documents\Java\PDFBox reactor\pdfbox\src\test\resources\input\rendering\166292-fi-ligature.pdf
oh oh
C:\Users\XXX\Documents\Java\PDFBox reactor\pdfbox\src\test\resources\input\rendering\166292-fi-ligature.pdf
oh oh
C:\Users\XXX\Documents\Java\PDFBox reactor\pdfbox\src\test\resources\input\rendering\014261-p3-ccitt.pdf
oh oh
C:\Users\XXX\Documents\Java\PDFBox reactor\pdfbox\src\test\resources\input\rendering\014261-p3-ccitt.pdf
oh oh
done
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Sometimes in the past I got exceptions:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Exception in thread &quot;Thread-2&quot; java.lang.RuntimeException: java.io.IOException: Unexpected end of TTF stream reached
	at pdfboxpageimageextraction.MulithreadTest.run(MulithreadTest.java:87)
Caused by: java.io.IOException: Unexpected end of TTF stream reached
	at org.apache.fontbox.ttf.TTFDataStream.read(TTFDataStream.java:274)
	at org.apache.fontbox.ttf.TTFDataStream.readString(TTFDataStream.java:91)
	at org.apache.fontbox.ttf.NamingTable.read(NamingTable.java:113)
	at org.apache.fontbox.ttf.TrueTypeFont.readTable(TrueTypeFont.java:373)
	at org.apache.fontbox.ttf.TrueTypeFont.getTable(TrueTypeFont.java:163)
	at org.apache.fontbox.ttf.TrueTypeFont.getNaming(TrueTypeFont.java:179)
	at org.apache.fontbox.ttf.TrueTypeFont.getName(TrueTypeFont.java:471)
	at org.apache.pdfbox.pdmodel.font.PDType1Font.&amp;lt;init&amp;gt;(PDType1Font.java:296)
	at org.apache.pdfbox.pdmodel.font.PDFontFactory.createFont(PDFontFactory.java:62)
	at org.apache.pdfbox.pdmodel.PDResources.getFont(PDResources.java:143)
	at org.apache.pdfbox.contentstream.operator.text.SetFontAndSize.process(SetFontAndSize.java:60)
	at org.apache.pdfbox.contentstream.PDFStreamEngine.processOperator(PDFStreamEngine.java:853)
	at org.apache.pdfbox.contentstream.PDFStreamEngine.processStreamOperators(PDFStreamEngine.java:506)
	at org.apache.pdfbox.contentstream.PDFStreamEngine.processStream(PDFStreamEngine.java:478)
	at org.apache.pdfbox.contentstream.PDFStreamEngine.processPage(PDFStreamEngine.java:156)
	at org.apache.pdfbox.rendering.PageDrawer.drawPage(PageDrawer.java:258)
	at org.apache.pdfbox.rendering.PDFRenderer.renderImage(PDFRenderer.java:225)
	at org.apache.pdfbox.rendering.PDFRenderer.renderImageWithDPI(PDFRenderer.java:164)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Sometimes I get an AIOOBE:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Exception in thread &quot;Thread-1&quot; java.lang.ArrayIndexOutOfBoundsException
	at org.apache.fontbox.ttf.BufferedRandomAccessFile.read(BufferedRandomAccessFile.java:158)
	at org.apache.fontbox.ttf.RAFDataStream.read(RAFDataStream.java:167)
	at org.apache.fontbox.ttf.TTFDataStream.read(TTFDataStream.java:264)
	at org.apache.fontbox.ttf.TTFDataStream.readString(TTFDataStream.java:91)
	at org.apache.fontbox.ttf.NamingTable.read(NamingTable.java:113)
	at org.apache.fontbox.ttf.TrueTypeFont.readTable(TrueTypeFont.java:373)
	at org.apache.fontbox.ttf.TrueTypeFont.getTable(TrueTypeFont.java:163)
	at org.apache.fontbox.ttf.TrueTypeFont.getNaming(TrueTypeFont.java:179)
	at org.apache.fontbox.ttf.TrueTypeFont.getName(TrueTypeFont.java:471)
	at org.apache.pdfbox.pdmodel.font.PDType1Font.&amp;lt;init&amp;gt;(PDType1Font.java:296)
	at org.apache.pdfbox.pdmodel.font.PDFontFactory.createFont(PDFontFactory.java:62)
	at org.apache.pdfbox.pdmodel.PDResources.getFont(PDResources.java:143)
	at org.apache.pdfbox.contentstream.operator.text.SetFontAndSize.process(SetFontAndSize.java:60)
	at org.apache.pdfbox.contentstream.PDFStreamEngine.processOperator(PDFStreamEngine.java:853)
	at org.apache.pdfbox.contentstream.PDFStreamEngine.processStreamOperators(PDFStreamEngine.java:506)
	at org.apache.pdfbox.contentstream.PDFStreamEngine.processStream(PDFStreamEngine.java:478)
	at org.apache.pdfbox.contentstream.PDFStreamEngine.processPage(PDFStreamEngine.java:156)
	at org.apache.pdfbox.rendering.PageDrawer.drawPage(PageDrawer.java:258)
	at org.apache.pdfbox.rendering.PDFRenderer.renderImage(PDFRenderer.java:225)
	at org.apache.pdfbox.rendering.PDFRenderer.renderImageWithDPI(PDFRenderer.java:164)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>Windows 7&lt;br/&gt;
jdk1.8.0_172</environment>
        <key id="13158683">PDFBOX-4219</key>
            <summary>Multithreading problem when rendering several documents with Standard 14 fonts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tilman">Tilman Hausherr</assignee>
                                    <reporter username="tilman">Tilman Hausherr</reporter>
                        <labels>
                            <label>multi-threading</label>
                            <label>multithreading</label>
                    </labels>
                <created>Fri, 11 May 2018 09:06:11 +0000</created>
                <updated>Thu, 16 Jun 2022 16:29:02 +0000</updated>
                            <resolved>Sun, 26 Aug 2018 09:17:14 +0000</resolved>
                                    <version>2.0.9</version>
                    <version>3.0.0 PDFBox</version>
                                    <fixVersion>2.0.12</fixVersion>
                    <fixVersion>3.0.0 PDFBox</fixVersion>
                                    <component>FontBox</component>
                    <component>Rendering</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16471692" author="tilman" created="Fri, 11 May 2018 09:31:13 +0000"  >&lt;p&gt;I added examples of bad renderings. The third (&quot;bad3&quot;) is the worst, in all cases the glyph shapes get messed up.&lt;/p&gt;</comment>
                            <comment id="16472366" author="jahewson" created="Fri, 11 May 2018 17:58:00 +0000"  >&lt;p&gt;I can&apos;t reproduce this on my Mac which uses &lt;tt&gt;Times-Roman&lt;/tt&gt; as the fallback font instead.&lt;/p&gt;</comment>
                            <comment id="16472451" author="jahewson" created="Fri, 11 May 2018 18:34:24 +0000"  >&lt;blockquote&gt;
&lt;p&gt;My theory is that one thread accesses the naming table and another accesses the glyf table, and both change the stream position. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Access to read these tables is via getTable which is synchronized, so that shouldn&apos;t be happening. But readTable looks very strange to me:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    void readTable(TTFTable table) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
    {
        &lt;span class=&quot;code-comment&quot;&gt;// save current position
&lt;/span&gt;        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; currentPosition = data.getCurrentPosition();
        data.seek(table.getOffset());
        table.read(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, data);
        &lt;span class=&quot;code-comment&quot;&gt;// restore current position
&lt;/span&gt;        data.seek(currentPosition);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Why would the current position need saving? No subsequent calls to readTable should rely on this!?&lt;/p&gt;</comment>
                            <comment id="16472562" author="jahewson" created="Fri, 11 May 2018 19:55:16 +0000"  >&lt;p&gt;Hmm, looks like this is to support nested reading of tables, such as the HorizontalMetricsTable.read which starts by calling getHorizontalHeader&lt;/p&gt;</comment>
                            <comment id="16517269" author="tilman" created="Tue, 19 Jun 2018 16:09:01 +0000"  >&lt;p&gt;I&apos;ve tried setting a synchronization on &lt;tt&gt;data&lt;/tt&gt; in &lt;tt&gt;GlyphTable.getGlyph()&lt;/tt&gt; AND in &lt;tt&gt;TrueTypeFont.readTable()&lt;/tt&gt;. The next weeks will show whether that works...&lt;/p&gt;</comment>
                            <comment id="16592841" author="jira-bot" created="Sun, 26 Aug 2018 08:57:12 +0000"  >&lt;p&gt;Commit 1839175 from tilman@apache.org in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1839175&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1839175&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4219&quot; title=&quot;Multithreading problem when rendering several documents with Standard 14 fonts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4219&quot;&gt;&lt;del&gt;PDFBOX-4219&lt;/del&gt;&lt;/a&gt;:  synchronize on data because it is accessed by several threads when PDFBox is accessing a standard 14 font for the first time&lt;/p&gt;</comment>
                            <comment id="16592842" author="jira-bot" created="Sun, 26 Aug 2018 08:57:18 +0000"  >&lt;p&gt;Commit 1839176 from tilman@apache.org in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1839176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1839176&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4219&quot; title=&quot;Multithreading problem when rendering several documents with Standard 14 fonts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4219&quot;&gt;&lt;del&gt;PDFBOX-4219&lt;/del&gt;&lt;/a&gt;:  synchronize on data because it is accessed by several threads when PDFBox is accessing a standard 14 font for the first time&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13450313">PDFBOX-5460</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12922986" name="014261-p3-ccitt.pdf" size="106586" author="tilman" created="Fri, 11 May 2018 08:56:06 +0000"/>
                            <attachment id="12922994" name="014261-p3-ccitt.pdf-1-bad1.png" size="204114" author="tilman" created="Fri, 11 May 2018 09:30:15 +0000"/>
                            <attachment id="12922991" name="014261-p3-ccitt.pdf-1-bad2.png" size="185055" author="tilman" created="Fri, 11 May 2018 09:30:17 +0000"/>
                            <attachment id="12922993" name="014261-p3-ccitt.pdf-1-bad3.png" size="75038" author="tilman" created="Fri, 11 May 2018 09:30:13 +0000"/>
                            <attachment id="12922985" name="014261-p3-ccitt.pdf-1.png" size="184846" author="tilman" created="Fri, 11 May 2018 08:56:11 +0000"/>
                            <attachment id="12922983" name="166292-fi-ligature.pdf" size="40285" author="tilman" created="Fri, 11 May 2018 08:56:39 +0000"/>
                            <attachment id="12922995" name="166292-fi-ligature.pdf-1-bad1.png" size="348737" author="tilman" created="Fri, 11 May 2018 09:30:18 +0000"/>
                            <attachment id="12922990" name="166292-fi-ligature.pdf-1-bad2.png" size="331531" author="tilman" created="Fri, 11 May 2018 09:30:17 +0000"/>
                            <attachment id="12922992" name="166292-fi-ligature.pdf-1-bad3.png" size="215543" author="tilman" created="Fri, 11 May 2018 09:30:14 +0000"/>
                            <attachment id="12922984" name="166292-fi-ligature.pdf-1.png" size="331000" author="tilman" created="Fri, 11 May 2018 08:56:42 +0000"/>
                            <attachment id="12922982" name="MulithreadTest.java" size="2677" author="tilman" created="Fri, 11 May 2018 09:00:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 11 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3tlr3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>