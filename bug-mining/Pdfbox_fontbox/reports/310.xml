<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:50:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-5056] Double checked locking done wrong in several places</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-5056</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;There&apos;s several places inside pdfbox where double-checked locking is done wrong. Specifically, double checked locking is the pattern of:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; doneInit = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!doneInit) {
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!doneInit) {
            ... &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; init
            doneInit = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        }
    }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Common issues are - lack of &lt;tt&gt;volatile&lt;/tt&gt; or the volatile set not being last. Here are the cases I found so far:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/pdfbox/blob/e409f25009702be8889ce586b8f6dd7274201f0a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/graphics/color/PDDeviceCMYK.java#L60&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pdfbox/blob/e409f25009702be8889ce586b8f6dd7274201f0a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/graphics/color/PDDeviceCMYK.java#L60&lt;/a&gt;&#160;- &lt;tt&gt;volatile&lt;/tt&gt; set isn&apos;t the last statement in the block.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/pdfbox/blob/e409f25009702be8889ce586b8f6dd7274201f0a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/graphics/color/PDDeviceRGB.java#L48&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pdfbox/blob/e409f25009702be8889ce586b8f6dd7274201f0a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/graphics/color/PDDeviceRGB.java#L48&lt;/a&gt;&#160;- &lt;tt&gt;volatile&lt;/tt&gt; set isn&apos;t the last statement in the block.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/pdfbox/blob/e409f25009702be8889ce586b8f6dd7274201f0a/fontbox/src/main/java/org/apache/fontbox/ttf/TrueTypeFont.java#L162-L167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pdfbox/blob/e409f25009702be8889ce586b8f6dd7274201f0a/fontbox/src/main/java/org/apache/fontbox/ttf/TrueTypeFont.java#L162-L167&lt;/a&gt;&#160;- &lt;tt&gt;initialized&lt;/tt&gt; isn&apos;t &lt;tt&gt;volatile&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/pdfbox/blob/947966ea830ff91c61a6740ca1787eb795b5ca95/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/font/encoding/Encoding.java#L132-L149&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pdfbox/blob/947966ea830ff91c61a6740ca1787eb795b5ca95/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/font/encoding/Encoding.java#L132-L149&lt;/a&gt;&#160;- &lt;tt&gt;names&lt;/tt&gt; isn&apos;t &lt;tt&gt;volatile&lt;/tt&gt; and the second check is missing (which might be harmless)&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/pdfbox/blob/6c8526bab8b7ca399721e067d065c1f272f97644/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/font/Standard14Fonts.java#L172-L190&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pdfbox/blob/6c8526bab8b7ca399721e067d065c1f272f97644/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/font/Standard14Fonts.java#L172-L190&lt;/a&gt;&#160;- &lt;tt&gt;fonts&lt;/tt&gt; isn&apos;t even locked and it&apos;s a vanilla hashmap that can be modified by other threads.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/pdfbox/blob/7984a52ad4d475886568593614ce566a88bf6bdd/pdfbox/src/main/java/org/apache/pdfbox/cos/COSName.java#L632-L637&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pdfbox/blob/7984a52ad4d475886568593614ce566a88bf6bdd/pdfbox/src/main/java/org/apache/pdfbox/cos/COSName.java#L632-L637&lt;/a&gt;&#160;- (tricky to see, but the constructor adds itself to the map) - the map isn&apos;t locked before the blind &lt;tt&gt;put&lt;/tt&gt;, so unclear which invocation &quot;wins&quot; (not sure if this is an issue, logic wise).&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/pdfbox/blob/61d6a53eacdee6a40d352509105e1c8d51cfb5dc/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/font/FontMapperImpl.java#L415-L419&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pdfbox/blob/61d6a53eacdee6a40d352509105e1c8d51cfb5dc/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/font/FontMapperImpl.java#L415-L419&lt;/a&gt;&#160;- &lt;tt&gt;fontProvider&lt;/tt&gt; isn&apos;t volatile, though is used as a double checked lock marker. (Not sure if this an issue, concurrency wise).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Fixing these one-by-one is possible and what I started doing around &lt;a href=&quot;https://github.com/apache/pdfbox/pull/90&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pdfbox/pull/90&lt;/a&gt;&#160;- but would it make sense to make a class that does this properly? Guava has &lt;tt&gt;Suppliers.memoize&lt;/tt&gt; which does the right thing - it&apos;s trivial to make an equivalent without the dep in pdfbox as well if necessary.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13347466">PDFBOX-5056</key>
            <summary>Double checked locking done wrong in several places</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mikekap">Mike Kaplinskiy</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 Dec 2020 02:42:50 +0000</created>
                <updated>Tue, 29 Dec 2020 12:15:43 +0000</updated>
                                            <version>2.0.22</version>
                                                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17254479" author="msahyoun" created="Thu, 24 Dec 2020 09:09:48 +0000"  >&lt;p&gt;for some of these such as &lt;tt&gt;Standard14Fonts&lt;/tt&gt; and &lt;tt&gt;COSName&lt;/tt&gt; we could look into utilizing Enums - maybe as part of PDFBox 3.0 - thoughts? OTOH I&apos;d like to get it out of the door so postponing it to another major release and fixing it inline with the current code might be the better option&lt;/p&gt;</comment>
                            <comment id="17254492" author="tilman" created="Thu, 24 Dec 2020 09:57:36 +0000"  >&lt;p&gt;I don&apos;t know. But the first two (those from the PR) are a good solution, and the last comment in each change makes clear why.&lt;/p&gt;</comment>
                            <comment id="17254758" author="lars t" created="Fri, 25 Dec 2020 07:20:23 +0000"  >&lt;p&gt;@Mike Reviewing your pull request I came up with the question, is the new value of awtColorSpace immediately visible to other threads when the synchronized blocks ends? initDone is, because it is volatile but awtColorSpace isn&#8216;t.&lt;/p&gt;</comment>
                            <comment id="17254760" author="mikekap" created="Fri, 25 Dec 2020 07:42:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lars+t&quot; class=&quot;user-hover&quot; rel=&quot;lars t&quot;&gt;lars t&lt;/a&gt; &lt;tt&gt;volatile&lt;/tt&gt; isn&apos;t a machine instruction - it&apos;s a compiler instruction. Specifically, it prevents the JVM from taking the double checked locking code above:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; doneInit = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!doneInit) {
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!doneInit) {
            ... &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; init
            doneInit = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        }
    }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and turning it into, effectively:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; doneInit = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!doneInit) {
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
        dontInit = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        ... &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; init
    }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Normally the JVM can do this kind of transformation when it knows the value of &lt;tt&gt;doneInit&lt;/tt&gt; isn&apos;t used in the code in the middle &amp;amp; there is an instruction-level parallelism to be gained.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In the correct version above, other variables are protected by the &lt;tt&gt;volatile&lt;/tt&gt;&#160;set&#160;- the volatile set is guaranteed to not be reordered relative to other instructions above or below it - which means anyone bypassing the &lt;tt&gt;synchronized&lt;/tt&gt; block will already see all the results. It&apos;s also why you might not want to make something play a double-role as your &lt;tt&gt;volaitile&lt;/tt&gt; marker - it prevents JVM optimizations.&#160;You can read more about the Java memory model @ &lt;a href=&quot;https://www.cs.umd.edu/~pugh/java/memoryModel/jsr-133-faq.html#reordering&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.cs.umd.edu/~pugh/java/memoryModel/jsr-133-faq.html#reordering&lt;/a&gt;&#160;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;To look at it from another perspective - if &lt;tt&gt;awtColorSpace&lt;/tt&gt; needed to be &lt;tt&gt;volatile&lt;/tt&gt; then simple single-checked locking wouldn&apos;t work correctly, i.e.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ICC_ColorSpace awtColorSpace;

&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (awtColorSpace == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }
    awtColorSpace = ...
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Separately though, using an object rather than a primitive as a &lt;tt&gt;volatile&lt;/tt&gt; might end poorly - I do not know what Java&apos;s guarantees are around a half-constructed object being stored in the pointer (in C++ it definitely doesn&apos;t work).&lt;/p&gt;</comment>
                            <comment id="17254800" author="lars t" created="Fri, 25 Dec 2020 10:57:32 +0000"  >&lt;p&gt;JSR-133 is the excelent answer to my  assertion. And the FAQ is linking to one of my favorite articals &lt;br/&gt;
&lt;a href=&quot;https://www.cs.umd.edu/~pugh/java/memoryModel/DoubleCheckedLocking.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.cs.umd.edu/~pugh/java/memoryModel/DoubleCheckedLocking.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17254801" author="tilman" created="Fri, 25 Dec 2020 11:16:52 +0000"  >&lt;p&gt;IMHO the real answer to the question is elsewhere in the link&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.cs.umd.edu/users/pugh/java/memoryModel/jsr-133-faq.html#synchronization&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.cs.umd.edu/users/pugh/java/memoryModel/jsr-133-faq.html#synchronization&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;i.e. that &quot;synchronize&quot; also synchronizes memory. (But the other aspects were also very important and interesting!)&lt;/p&gt;</comment>
                            <comment id="17254802" author="jira-bot" created="Fri, 25 Dec 2020 11:22:16 +0000"  >&lt;p&gt;Commit 1884795 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1884795&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1884795&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5056&quot; title=&quot;Double checked locking done wrong in several places&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5056&quot;&gt;PDFBOX-5056&lt;/a&gt;: fix double-checked locking, as suggested by Mike Kaplinskiy; closes #90&lt;/p&gt;</comment>
                            <comment id="17254803" author="jira-bot" created="Fri, 25 Dec 2020 11:22:19 +0000"  >&lt;p&gt;Commit 1884796 from Tilman Hausherr in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1884796&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1884796&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5056&quot; title=&quot;Double checked locking done wrong in several places&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5056&quot;&gt;PDFBOX-5056&lt;/a&gt;: fix double-checked locking, as suggested by Mike Kaplinskiy; closes #90&lt;/p&gt;</comment>
                            <comment id="17254809" author="tilman" created="Fri, 25 Dec 2020 11:50:44 +0000"  >&lt;p&gt;We all missed something obvious in PDDeviceRGB, but Sonar pointed me to it: awtColorSpace doesn&apos;t have to be a class field, it can be local. (The initialization is only done to avoid a JVM bug)&lt;/p&gt;

&lt;p&gt;Any reason not to make it local?&lt;/p&gt;</comment>
                            <comment id="17254821" author="lehmi" created="Fri, 25 Dec 2020 12:38:59 +0000"  >&lt;p&gt;Looks like awtColorSpace isn&apos;t needed at all, at least in PDDeviceRGB. With &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3897&quot; title=&quot;Avoid sRGB self-conversions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3897&quot;&gt;&lt;del&gt;PDFBOX-3897&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2092&quot; title=&quot;Very slow rendering of scanned document&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2092&quot;&gt;&lt;del&gt;PDFBOX-2092&lt;/del&gt;&lt;/a&gt; the usage was removed so that the whole init stuff can be removed, or am I missing something?&lt;/p&gt;</comment>
                            <comment id="17254822" author="jira-bot" created="Fri, 25 Dec 2020 12:43:04 +0000"  >&lt;p&gt;Commit 1884800 from Tilman Hausherr in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1884800&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1884800&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5056&quot; title=&quot;Double checked locking done wrong in several places&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5056&quot;&gt;PDFBOX-5056&lt;/a&gt;: remove unneeded field&lt;/p&gt;</comment>
                            <comment id="17254823" author="jira-bot" created="Fri, 25 Dec 2020 12:43:07 +0000"  >&lt;p&gt;Commit 1884801 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1884801&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1884801&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5056&quot; title=&quot;Double checked locking done wrong in several places&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5056&quot;&gt;PDFBOX-5056&lt;/a&gt;: remove unneeded field&lt;/p&gt;</comment>
                            <comment id="17254824" author="tilman" created="Fri, 25 Dec 2020 12:44:16 +0000"  >&lt;p&gt;Yeah.&lt;/p&gt;

&lt;p&gt;I was asking mostly because this double-checked locking is so full of surprises that I was wondering if I had missed something &#128514;&lt;/p&gt;</comment>
                            <comment id="17255230" author="lehmi" created="Sun, 27 Dec 2020 13:28:07 +0000"  >&lt;p&gt;W.r.t. refactorings we should wait until 3.0.0 is released, otherwise that release will become a never ending story &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17255561" author="jira-bot" created="Mon, 28 Dec 2020 12:30:18 +0000"  >&lt;p&gt;Commit 1884862 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1884862&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1884862&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5056&quot; title=&quot;Double checked locking done wrong in several places&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5056&quot;&gt;PDFBOX-5056&lt;/a&gt;: fix double-checked locking (in TrueTypeFont.getTable()), as suggested by Mike Kaplinskiy&lt;/p&gt;</comment>
                            <comment id="17255562" author="jira-bot" created="Mon, 28 Dec 2020 12:30:22 +0000"  >&lt;p&gt;Commit 1884863 from Tilman Hausherr in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1884863&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1884863&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5056&quot; title=&quot;Double checked locking done wrong in several places&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5056&quot;&gt;PDFBOX-5056&lt;/a&gt;: fix double-checked locking (in TrueTypeFont.getTable()), as suggested by Mike Kaplinskiy&lt;/p&gt;</comment>
                            <comment id="17255571" author="jira-bot" created="Mon, 28 Dec 2020 12:49:53 +0000"  >&lt;p&gt;Commit 1884865 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1884865&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1884865&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5056&quot; title=&quot;Double checked locking done wrong in several places&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5056&quot;&gt;PDFBOX-5056&lt;/a&gt;: fix double-checked locking, as suggested by Mike Kaplinskiy&lt;/p&gt;</comment>
                            <comment id="17255572" author="jira-bot" created="Mon, 28 Dec 2020 12:49:56 +0000"  >&lt;p&gt;Commit 1884866 from Tilman Hausherr in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1884866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1884866&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5056&quot; title=&quot;Double checked locking done wrong in several places&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5056&quot;&gt;PDFBOX-5056&lt;/a&gt;: fix double-checked locking, as suggested by Mike Kaplinskiy&lt;/p&gt;</comment>
                            <comment id="17255584" author="tilman" created="Mon, 28 Dec 2020 13:16:34 +0000"  >&lt;p&gt;I&apos;m trying to solve the ones that don&apos;t require a refactoring.&lt;/p&gt;

&lt;p&gt;Sonar isn&apos;t happy with the last change (in Encoding.java). Claims that &apos;adding &quot;volatile&quot; is not enough to make this field thread-safe&apos;, because &apos;the array itself will always be read fresh and never thread cached, but the items &lt;em&gt;in&lt;/em&gt; the array will not be&apos;, see &lt;a href=&quot;https://sonarcloud.io/project/issues?id=pdfbox-reactor&amp;amp;issues=AXapb33qHxHw-RQVEFiD&amp;amp;open=AXapb33qHxHw-RQVEFiD&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. But IMHO the HashSet is fully initialized at that time and doesn&apos;t change later.&lt;/p&gt;</comment>
                            <comment id="17255715" author="mikekap" created="Mon, 28 Dec 2020 20:22:20 +0000"  >&lt;p&gt;My knowledge is a little iffy here - but it seems like the unsafe publication problem applies. Technically Java/JVM is free to reorder the constructor code to happen AFTER the assignment to the volatile. See &lt;a href=&quot;https://stackoverflow.com/questions/16178020/uninitialized-object-leaked-to-another-thread-despite-no-code-explicitly-leaking&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/16178020/uninitialized-object-leaked-to-another-thread-despite-no-code-explicitly-leaking&lt;/a&gt; for an example. Generally it seems like using an non-primitive field as a volatile in a double checked lock can yield issues.&lt;/p&gt;

&lt;p&gt;I do want to bring up two solutions. The first is - don&#8217;t use double checked locking at all. Just use a synchronized block (with a check to skip if initialization is complete inside the block) all the time. Using double checked locking at all is dangerous given how many ways there are to get it wrong, and this might be a premature optimization.&lt;/p&gt;

&lt;p&gt;For that particular piece of code though - it seems like all the synchronization can be removed by just checking the &lt;tt&gt;inverted&lt;/tt&gt; map that already has the keys. You wouldn&#8217;t even need to construct a hashset at all this way.&lt;/p&gt;</comment>
                            <comment id="17255849" author="tilman" created="Tue, 29 Dec 2020 07:30:48 +0000"  >&lt;p&gt;We were having deadlocks, see &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3404&quot; title=&quot;Threads using PDFBox getting stuck when using standard 14 fonts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3404&quot;&gt;&lt;del&gt;PDFBOX-3404&lt;/del&gt;&lt;/a&gt;. Before that, the code was&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; contains(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name)
    {
        &lt;span class=&quot;code-comment&quot;&gt;// we have to wait until all add() calls are done before building the name cache
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// otherwise /Differences won&apos;t be accounted &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (names == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
        {
            names = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;(codeToName.size());
            names.addAll(codeToName.values());
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; names.contains(name);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17255852" author="msahyoun" created="Tue, 29 Dec 2020 07:36:36 +0000"  >&lt;p&gt;Havn&apos;t looked into this in detail but can we just wrap with &lt;tt&gt;Collections.synchronizedSet&lt;/tt&gt; and make sure that we only access the wrapped Set?&lt;/p&gt;</comment>
                            <comment id="17255857" author="tilman" created="Tue, 29 Dec 2020 07:53:28 +0000"  >&lt;p&gt;Maybe, but that one is similar to one of the failed attempts from &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3404&quot; title=&quot;Threads using PDFBox getting stuck when using standard 14 fonts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3404&quot;&gt;&lt;del&gt;PDFBOX-3404&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
names = Collections.newSetFromMap(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConcurrentHashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;&amp;gt;());
names.addAll(codeToName.values());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17255866" author="tilman" created="Tue, 29 Dec 2020 08:34:47 +0000"  >&lt;p&gt;I just tried the &quot;bad&quot; code from my previous comment and no deadlock. This is bad because it means we can no longer reproduce the problem. Maybe because of newer jdk, or faster computer.&lt;/p&gt;</comment>
                            <comment id="17255895" author="mikekap" created="Tue, 29 Dec 2020 09:20:53 +0000"  >&lt;p&gt;If you just mark contains synchronized that will work. The &#8220;bad&#8221; code is still broken, assuming there are multiple threads involved (I&#8217;m not sure exactly how that can happen - I don&#8217;t know pdfbox well enough).&lt;/p&gt;

&lt;p&gt;The solution you committed seems correct. I think sonar just isn&#8217;t smart enough to figure out the set is immutable after assignment. There&#8217;s several other ways to fix the problem that might also please sonar. Here&#8217;s some ideas:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; contains(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; inverted.contains(name);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Because &lt;tt&gt;inverted&lt;/tt&gt; has keys that are the values in &lt;tt&gt;codeToName&lt;/tt&gt;. I&#8217;m a little suspect of synchronization in the entire class (Encoding) generally - like why puts and other gets aren&#8217;t synchronized - but that&#8217;s a separate problem. I don&#8217;t have enough context to know whether instances of encoding are mutable shared between threads.&lt;/p&gt;

&lt;p&gt;Other solutions:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; names;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; contains(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name)
    {
        &lt;span class=&quot;code-comment&quot;&gt;// we have to wait until all add() calls are done before building the name cache
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// otherwise /Differences won&apos;t be accounted &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (names == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
        {
            names = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;(codeToName.values());
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; names.contains(name);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That is - don&#8217;t do double checked locking. Realistically this is testing an element in a set - the critical section is tiny cpu time wise and the lock is unlikely to hurt.&lt;/p&gt;</comment>
                            <comment id="17255930" author="lehmi" created="Tue, 29 Dec 2020 10:54:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; I had a look at PDDeviceRGB. You have removed the unneeded field, but shouldn&apos;t it be safe to remove the whole init stuff? We don&apos;t need a preinitialized colorspace anymore neither in toRGB nor in toRGBImage. This seems to be a relic from older implementations. Or am I missing something?&lt;/p&gt;</comment>
                            <comment id="17255938" author="tilman" created="Tue, 29 Dec 2020 11:10:25 +0000"  >&lt;p&gt;Yes, good idea, lets try it. The code at the time of &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2184&quot; title=&quot;CMMException: Invalid profile data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2184&quot;&gt;&lt;del&gt;PDFBOX-2184&lt;/del&gt;&lt;/a&gt; was different, toRGB() used the sRGB colorspace directly.&lt;/p&gt;</comment>
                            <comment id="17255939" author="jira-bot" created="Tue, 29 Dec 2020 11:11:47 +0000"  >&lt;p&gt;Commit 1884898 from Tilman Hausherr in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1884898&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1884898&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5056&quot; title=&quot;Double checked locking done wrong in several places&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5056&quot;&gt;PDFBOX-5056&lt;/a&gt;: remove JVM bug related workaround that is no longer needed, as suggested by Andreas Lehmk&#252;hler&lt;/p&gt;</comment>
                            <comment id="17255940" author="jira-bot" created="Tue, 29 Dec 2020 11:11:51 +0000"  >&lt;p&gt;Commit 1884899 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1884899&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1884899&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5056&quot; title=&quot;Double checked locking done wrong in several places&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5056&quot;&gt;PDFBOX-5056&lt;/a&gt;: remove JVM bug related workaround that is no longer needed, as suggested by Andreas Lehmk&#252;hler&lt;/p&gt;</comment>
                            <comment id="17255941" author="jira-bot" created="Tue, 29 Dec 2020 11:14:34 +0000"  >&lt;p&gt;Commit 1884900 from Tilman Hausherr in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1884900&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1884900&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5056&quot; title=&quot;Double checked locking done wrong in several places&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5056&quot;&gt;PDFBOX-5056&lt;/a&gt;: remove unused imports&lt;/p&gt;</comment>
                            <comment id="17255942" author="jira-bot" created="Tue, 29 Dec 2020 11:14:37 +0000"  >&lt;p&gt;Commit 1884901 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1884901&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1884901&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5056&quot; title=&quot;Double checked locking done wrong in several places&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5056&quot;&gt;PDFBOX-5056&lt;/a&gt;: remove unused imports&lt;/p&gt;</comment>
                            <comment id="17255944" author="tilman" created="Tue, 29 Dec 2020 11:22:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mikekap&quot; class=&quot;user-hover&quot; rel=&quot;mikekap&quot;&gt;mikekap&lt;/a&gt; I&apos;ll use the first suggestion in a few minutes. The names &quot;cache&quot; was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2262&quot; title=&quot;Remove usage of AWT fonts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2262&quot;&gt;&lt;del&gt;PDFBOX-2262&lt;/del&gt;&lt;/a&gt; as part of a huge commit and there&apos;s no text why it was needed.&lt;/p&gt;</comment>
                            <comment id="17255966" author="jira-bot" created="Tue, 29 Dec 2020 12:14:20 +0000"  >&lt;p&gt;Commit 1884902 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1884902&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1884902&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5056&quot; title=&quot;Double checked locking done wrong in several places&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5056&quot;&gt;PDFBOX-5056&lt;/a&gt;: remove double-checked locking, as suggested by Mike Kaplinskiy&lt;/p&gt;</comment>
                            <comment id="17255967" author="jira-bot" created="Tue, 29 Dec 2020 12:14:23 +0000"  >&lt;p&gt;Commit 1884903 from Tilman Hausherr in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1884903&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1884903&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5056&quot; title=&quot;Double checked locking done wrong in several places&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5056&quot;&gt;PDFBOX-5056&lt;/a&gt;: remove double-checked locking, as suggested by Mike Kaplinskiy&lt;/p&gt;</comment>
                            <comment id="17255969" author="tilman" created="Tue, 29 Dec 2020 12:15:43 +0000"  >&lt;p&gt;I&apos;ve also adding comments warning not to modify after construction, although I don&apos;t see a reason to do so.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 45 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0lrfc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>