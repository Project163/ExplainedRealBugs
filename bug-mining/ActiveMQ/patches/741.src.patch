diff --git a/activemq-core/src/test/java/org/apache/activemq/transport/stomp/StompTest.java b/activemq-core/src/test/java/org/apache/activemq/transport/stomp/StompTest.java
index a072b0493..5dc3e21b5 100644
--- a/activemq-core/src/test/java/org/apache/activemq/transport/stomp/StompTest.java
+++ b/activemq-core/src/test/java/org/apache/activemq/transport/stomp/StompTest.java
@@ -85,8 +85,9 @@ public class StompTest extends CombinationTestSupport {
         + "}}";
 
     protected void setUp() throws Exception {
-        // The order of the entries is different when using the ibm jdk.
-        if (System.getProperty("java.vendor").equals("IBM Corporation")) {
+        // The order of the entries is different when using ibm jdk 5.
+        if (System.getProperty("java.vendor").equals("IBM Corporation")
+            && System.getProperty("java.version").startsWith("1.5")) {
             xmlMap = "<map>\n" 
                 + "  <entry>\n" 
                 + "    <string>city</string>\n"
diff --git a/activemq-xmpp/pom.xml b/activemq-xmpp/pom.xml
index ad262563f..2b83b5006 100755
--- a/activemq-xmpp/pom.xml
+++ b/activemq-xmpp/pom.xml
@@ -145,15 +145,13 @@
     <dependency>
       <groupId>jivesoftware</groupId>
       <artifactId>smack</artifactId>
-      <version>1.5.0</version>
-      <!--<version>2.2.1</version>-->
+      <version>3.1.0</version>
       <scope>test</scope>
     </dependency>
     <dependency>
       <groupId>jivesoftware</groupId>
       <artifactId>smackx</artifactId>
-      <version>1.5.0</version>
-      <!--<version>2.2.1</version>-->
+      <version>3.1.0</version>
     </dependency>
 
     <dependency>
diff --git a/activemq-xmpp/src/test/java/org/apache/activemq/transport/xmpp/XmppTest.java b/activemq-xmpp/src/test/java/org/apache/activemq/transport/xmpp/XmppTest.java
index cebd1fc28..7cf02181a 100644
--- a/activemq-xmpp/src/test/java/org/apache/activemq/transport/xmpp/XmppTest.java
+++ b/activemq-xmpp/src/test/java/org/apache/activemq/transport/xmpp/XmppTest.java
@@ -19,8 +19,11 @@ package org.apache.activemq.transport.xmpp;
 import junit.framework.TestCase;
 import junit.textui.TestRunner;
 import org.jivesoftware.smack.Chat;
+import org.jivesoftware.smack.ConnectionConfiguration;
+import org.jivesoftware.smack.MessageListener;
 import org.jivesoftware.smack.XMPPConnection;
 import org.jivesoftware.smack.XMPPException;
+import org.jivesoftware.smack.packet.Message;
 
 /**
  * @version $Revision$
@@ -37,21 +40,27 @@ public class XmppTest extends TestCase {
     }
 
     public void testConnect() throws Exception {
-        // ConnectionConfiguration config = new
-        // ConnectionConfiguration("localhost", 61222);
+        ConnectionConfiguration config = new
+            ConnectionConfiguration("localhost", 61222);
         // config.setDebuggerEnabled(true);
 
         try {
             // SmackConfiguration.setPacketReplyTimeout(1000);
-            // XMPPConnection con = new XMPPConnection(config);
-            XMPPConnection con = new XMPPConnection("localhost", 61222);
+            XMPPConnection con = new XMPPConnection(config);
+            con.connect(); 
             con.login("amq-user", "amq-pwd");
-            Chat chat = con.createChat("test@localhost");
+            Chat chat = con.getChatManager().createChat("test@localhost",
+                new MessageListener() {
+                    public void processMessage(Chat chat, Message message) {
+                        //
+                    }
+                });
             for (int i = 0; i < 10; i++) {
                 System.out.println("Sending message: " + i);
                 chat.sendMessage("Hello from Message: " + i);
             }
             System.out.println("Sent all messages!");
+            con.disconnect();
         } catch (XMPPException e) {
             if (block) {
                 System.out.println("Caught: " + e);
