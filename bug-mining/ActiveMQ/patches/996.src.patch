diff --git a/activemq-core/src/main/java/org/apache/activemq/store/amq/AMQMessageStore.java b/activemq-core/src/main/java/org/apache/activemq/store/amq/AMQMessageStore.java
index cce6ffdc0..2ce84738e 100644
--- a/activemq-core/src/main/java/org/apache/activemq/store/amq/AMQMessageStore.java
+++ b/activemq-core/src/main/java/org/apache/activemq/store/amq/AMQMessageStore.java
@@ -159,7 +159,10 @@ public class AMQMessageStore extends AbstractMessageStore {
         lock.lock();
         try {
             lastLocation = location;
-            messages.put(message.getMessageId(), data);
+            ReferenceData prev = messages.put(message.getMessageId(), data);
+            if (prev != null) {
+                AMQMessageStore.this.peristenceAdapter.removeInProgressDataFile(AMQMessageStore.this, prev.getFileId());
+            }
         } finally {
             lock.unlock();
         }
diff --git a/activemq-core/src/test/java/org/apache/activemq/bugs/AMQ2584Test.java b/activemq-core/src/test/java/org/apache/activemq/bugs/AMQ2584Test.java
index 243a7a99f..ea8638227 100644
--- a/activemq-core/src/test/java/org/apache/activemq/bugs/AMQ2584Test.java
+++ b/activemq-core/src/test/java/org/apache/activemq/bugs/AMQ2584Test.java
@@ -57,7 +57,7 @@ public class AMQ2584Test extends org.apache.activemq.TestSupport {
     public void initCombosForTestSize() throws Exception {
         this.addCombinationValues("defaultPersistenceAdapter",
                 new Object[]{
-                        // PersistenceAdapterChoice.AMQ,
+                        PersistenceAdapterChoice.AMQ,
                         PersistenceAdapterChoice.KahaDB
                 });
     }
