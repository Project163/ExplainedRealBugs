diff --git a/activemq-core/src/main/java/org/apache/activemq/store/kahadb/MessageDatabase.java b/activemq-core/src/main/java/org/apache/activemq/store/kahadb/MessageDatabase.java
index 95b3f5e33..0c497f643 100644
--- a/activemq-core/src/main/java/org/apache/activemq/store/kahadb/MessageDatabase.java
+++ b/activemq-core/src/main/java/org/apache/activemq/store/kahadb/MessageDatabase.java
@@ -218,26 +218,25 @@ public class MessageDatabase {
 	 * @throws IOException
 	 */
 	public void open() throws IOException {
+		File lockFileName = new File(directory, "lock");
+		lockFile = new LockFile(lockFileName, true);
+		if (failIfDatabaseIsLocked) {
+		    lockFile.lock();
+		} else {
+		    while (true) {
+		        try {
+		            lockFile.lock();
+		            break;
+		        } catch (IOException e) {
+		            LOG.info("Database "+lockFileName+" is locked... waiting " + (DATABASE_LOCKED_WAIT_DELAY / 1000) + " seconds for the database to be unlocked. Reason: " + e);
+		            try {
+		                Thread.sleep(DATABASE_LOCKED_WAIT_DELAY);
+		            } catch (InterruptedException e1) {
+		            }
+		        }
+		    }
+		}
 		if( opened.compareAndSet(false, true) ) {
-            File lockFileName = new File(directory, "lock");
-            lockFile = new LockFile(lockFileName, true);
-	        if (failIfDatabaseIsLocked) {
-	            lockFile.lock();
-	        } else {
-	            while (true) {
-	                try {
-	                    lockFile.lock();
-	                    break;
-	                } catch (IOException e) {
-	                    LOG.info("Database "+lockFileName+" is locked... waiting " + (DATABASE_LOCKED_WAIT_DELAY / 1000) + " seconds for the database to be unlocked. Reason: " + e);
-	                    try {
-	                        Thread.sleep(DATABASE_LOCKED_WAIT_DELAY);
-	                    } catch (InterruptedException e1) {
-	                    }
-	                }
-	            }
-	        }
-	        
             getJournal().start();
             
 	        loadPageFile();
@@ -312,7 +311,7 @@ public class MessageDatabase {
 	
     public void unload() throws IOException, InterruptedException {
         synchronized (indexMutex) {
-            if( pageFile.isLoaded() ) {
+            if( pageFile != null && pageFile.isLoaded() ) {
                 metadata.state = CLOSED_STATE;
                 metadata.firstInProgressTransactionLocation = getFirstInProgressTxLocation();
     
diff --git a/activemq-core/src/test/java/org/apache/activemq/store/kahadb/KahaDBStoreBrokerTest.java b/activemq-core/src/test/java/org/apache/activemq/store/kahadb/KahaDBStoreBrokerTest.java
index aa8793681..3051764c7 100644
--- a/activemq-core/src/test/java/org/apache/activemq/store/kahadb/KahaDBStoreBrokerTest.java
+++ b/activemq-core/src/test/java/org/apache/activemq/store/kahadb/KahaDBStoreBrokerTest.java
@@ -17,11 +17,9 @@
 package org.apache.activemq.store.kahadb;
 
 import java.io.File;
-import java.net.URI;
 
 import junit.framework.Test;
 
-import org.apache.activemq.broker.BrokerFactory;
 import org.apache.activemq.broker.BrokerService;
 import org.apache.activemq.broker.BrokerTest;
 
