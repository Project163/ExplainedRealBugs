diff --git a/activemq-core/src/main/java/org/apache/activemq/broker/region/cursors/TopicStorePrefetch.java b/activemq-core/src/main/java/org/apache/activemq/broker/region/cursors/TopicStorePrefetch.java
index 839f48541..333058160 100755
--- a/activemq-core/src/main/java/org/apache/activemq/broker/region/cursors/TopicStorePrefetch.java
+++ b/activemq-core/src/main/java/org/apache/activemq/broker/region/cursors/TopicStorePrefetch.java
@@ -16,7 +16,6 @@
  */
 package org.apache.activemq.broker.region.cursors;
 
-import java.io.IOException;
 import org.apache.activemq.broker.region.Subscription;
 import org.apache.activemq.broker.region.Topic;
 import org.apache.activemq.command.Message;
@@ -75,8 +74,7 @@ class TopicStorePrefetch extends AbstractStoreCursor {
     @Override
     protected synchronized int getStoreSize() {
         try {
-            this.store.recoverNextMessages(clientId, subscriberName, maxBatchSize, this);
-            return size;
+            return store.getMessageCount(clientId, subscriberName);
         } catch (Exception e) {
             LOG.error(this + " Failed to get the outstanding message count from the store", e);
             throw new RuntimeException(e);
diff --git a/activemq-core/src/main/java/org/apache/activemq/store/kahadb/KahaDBStore.java b/activemq-core/src/main/java/org/apache/activemq/store/kahadb/KahaDBStore.java
index 5671acbe4..f472aaa8d 100644
--- a/activemq-core/src/main/java/org/apache/activemq/store/kahadb/KahaDBStore.java
+++ b/activemq-core/src/main/java/org/apache/activemq/store/kahadb/KahaDBStore.java
@@ -38,6 +38,8 @@ import java.util.concurrent.TimeUnit;
 import java.util.concurrent.atomic.AtomicBoolean;
 import java.util.concurrent.atomic.AtomicInteger;
 
+import javax.jms.InvalidSelectorException;
+
 import org.apache.activemq.broker.ConnectionContext;
 import org.apache.activemq.command.ActiveMQDestination;
 import org.apache.activemq.command.ActiveMQQueue;
@@ -51,8 +53,11 @@ import org.apache.activemq.command.MessageId;
 import org.apache.activemq.command.SubscriptionInfo;
 import org.apache.activemq.command.TransactionId;
 import org.apache.activemq.command.XATransactionId;
+import org.apache.activemq.filter.BooleanExpression;
+import org.apache.activemq.filter.MessageEvaluationContext;
 import org.apache.activemq.openwire.OpenWireFormat;
 import org.apache.activemq.protobuf.Buffer;
+import org.apache.activemq.selector.SelectorParser;
 import org.apache.activemq.store.AbstractMessageStore;
 import org.apache.activemq.store.MessageRecoveryListener;
 import org.apache.activemq.store.MessageStore;
@@ -75,6 +80,7 @@ import org.apache.activemq.store.kahadb.data.KahaXATransactionId;
 import org.apache.activemq.store.kahadb.data.KahaDestination.DestinationType;
 import org.apache.activemq.usage.MemoryUsage;
 import org.apache.activemq.usage.SystemUsage;
+import org.apache.activemq.util.IOExceptionSupport;
 import org.apache.activemq.util.ServiceStopper;
 import org.apache.activemq.wireformat.WireFormat;
 import org.apache.commons.logging.Log;
@@ -612,6 +618,7 @@ public class KahaDBStore extends MessageDatabase implements PersistenceAdapter {
 
         public int getMessageCount(String clientId, String subscriptionName) throws IOException {
             final String subscriptionKey = subscriptionKey(clientId, subscriptionName);
+            final SubscriptionInfo info = lookupSubscription(clientId, subscriptionName);
             synchronized (indexMutex) {
                 return pageFile.tx().execute(new Transaction.CallableClosure<Integer, IOException>() {
                     public Integer execute(Transaction tx) throws IOException {
@@ -626,8 +633,24 @@ public class KahaDBStore extends MessageDatabase implements PersistenceAdapter {
                         int counter = 0;
                         for (Iterator<Entry<Long, MessageKeys>> iterator = sd.orderIndex.iterator(tx, cursorPos); iterator
                                 .hasNext();) {
-                            iterator.next();
-                            counter++;
+                            Entry<Long, MessageKeys> entry = iterator.next();
+                            String selector = info.getSelector();
+                            if (selector != null) {
+                                try {
+                                    if (selector != null) { 
+                                        BooleanExpression selectorExpression = SelectorParser.parse(selector);
+                                        MessageEvaluationContext ctx = new MessageEvaluationContext();
+                                        ctx.setMessageReference(loadMessage(entry.getValue().location));
+                                        if (selectorExpression.matches(ctx)) {
+                                            counter++;
+                                        }
+                                    }
+                                } catch (Exception e) {
+                                    throw IOExceptionSupport.create(e);
+                                }
+                            } else {
+                                counter++;
+                            }
                         }
                         return counter;
                     }
diff --git a/activemq-core/src/test/java/org/apache/activemq/usecases/SubscriptionSelectorTest.java b/activemq-core/src/test/java/org/apache/activemq/usecases/DurableSubscriptionSelectorTest.java
similarity index 95%
rename from activemq-core/src/test/java/org/apache/activemq/usecases/SubscriptionSelectorTest.java
rename to activemq-core/src/test/java/org/apache/activemq/usecases/DurableSubscriptionSelectorTest.java
index 52f0d4e72..4e1490d7b 100644
--- a/activemq-core/src/test/java/org/apache/activemq/usecases/SubscriptionSelectorTest.java
+++ b/activemq-core/src/test/java/org/apache/activemq/usecases/DurableSubscriptionSelectorTest.java
@@ -31,9 +31,9 @@ import org.apache.activemq.ActiveMQConnection;
 import org.apache.activemq.ActiveMQConnectionFactory;
 import org.apache.activemq.broker.BrokerService;
 import org.apache.activemq.command.ActiveMQTopic;
-import org.apache.activemq.store.amq.AMQPersistenceAdapter;
+import org.apache.activemq.store.PersistenceAdapter;
 
-public class SubscriptionSelectorTest extends org.apache.activemq.TestSupport {
+abstract public class DurableSubscriptionSelectorTest extends org.apache.activemq.TestSupport {
 
     MBeanServer mbs;
     BrokerService broker = null;
@@ -127,8 +127,6 @@ public class SubscriptionSelectorTest extends org.apache.activemq.TestSupport {
         broker = new BrokerService();
         broker.setBrokerName("test-broker");
         
-        //TODO create variants for different stores
-        //broker.setPersistenceAdapter(new AMQPersistenceAdapter());
         if (deleteMessages) {
             broker.setDeleteAllMessagesOnStartup(true);
         }
@@ -140,6 +138,8 @@ public class SubscriptionSelectorTest extends org.apache.activemq.TestSupport {
             broker.stop();
         broker = null;
     }
+    
+    abstract public PersistenceAdapter createPersistenceAdapter() throws Exception;
 
     protected ActiveMQConnectionFactory createConnectionFactory() throws Exception {
         return new ActiveMQConnectionFactory("vm://test-broker?jms.watchTopicAdvisories=false&waitForStart=5000&create=false");
diff --git a/activemq-core/src/test/java/org/apache/activemq/usecases/KahaDBDurableSubscriptionSelectorTest.java b/activemq-core/src/test/java/org/apache/activemq/usecases/KahaDBDurableSubscriptionSelectorTest.java
new file mode 100644
index 000000000..5e91337f9
--- /dev/null
+++ b/activemq-core/src/test/java/org/apache/activemq/usecases/KahaDBDurableSubscriptionSelectorTest.java
@@ -0,0 +1,31 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.activemq.usecases;
+
+import org.apache.activemq.store.PersistenceAdapter;
+import org.apache.activemq.store.kahadb.KahaDBPersistenceAdapter;
+
+public class KahaDBDurableSubscriptionSelectorTest extends
+        DurableSubscriptionSelectorTest {
+
+    @Override
+    public PersistenceAdapter createPersistenceAdapter() throws Exception {
+        return new KahaDBPersistenceAdapter();
+    }
+
+}
