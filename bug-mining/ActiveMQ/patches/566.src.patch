diff --git a/activemq-core/src/main/java/org/apache/activemq/broker/BrokerService.java b/activemq-core/src/main/java/org/apache/activemq/broker/BrokerService.java
index a1cade945..1e1183d2b 100644
--- a/activemq-core/src/main/java/org/apache/activemq/broker/BrokerService.java
+++ b/activemq-core/src/main/java/org/apache/activemq/broker/BrokerService.java
@@ -510,13 +510,13 @@ public class BrokerService implements Service {
         // to avoid timimg issue with discovery (spinning up a new instance)
         BrokerRegistry.getInstance().unbind(getBrokerName());
         VMTransportFactory.stopped(getBrokerName());        
-        stopper.stop(persistenceAdapter);
         if (broker != null) {
             stopper.stop(broker);
         }
         if (tempDataStore != null) {
             tempDataStore.close();
         }
+        stopper.stop(persistenceAdapter);
         if (isUseJmx()) {
             MBeanServer mbeanServer = getManagementContext().getMBeanServer();
             if (mbeanServer != null) {
diff --git a/activemq-jpa-store/src/main/java/org/apache/activemq/store/jpa/JPAPersistenceAdapter.java b/activemq-jpa-store/src/main/java/org/apache/activemq/store/jpa/JPAPersistenceAdapter.java
index e225351b7..066bc32e9 100755
--- a/activemq-jpa-store/src/main/java/org/apache/activemq/store/jpa/JPAPersistenceAdapter.java
+++ b/activemq-jpa-store/src/main/java/org/apache/activemq/store/jpa/JPAPersistenceAdapter.java
@@ -210,7 +210,7 @@ public class JPAPersistenceAdapter implements PersistenceAdapter {
     }
 
     public void stop() throws Exception {
-        if (entityManagerFactory != null) {
+        if (entityManagerFactory != null && entityManagerFactory.isOpen()) {
             entityManagerFactory.close();
         }
     }
diff --git a/pom.xml b/pom.xml
index 5e41de5bb..08dc7f81e 100755
--- a/pom.xml
+++ b/pom.xml
@@ -46,7 +46,7 @@
     <cglib-version>2.0</cglib-version>
     <commons-beanutils-version>1.6.1</commons-beanutils-version>
     <commons-collections-version>3.1</commons-collections-version>
-    <openjpa-version>1.0.0</openjpa-version>
+    <openjpa-version>1.2.0</openjpa-version>
     <commons-dbcp-version>1.2.2</commons-dbcp-version>
     <commons-httpclient-version>2.0.1</commons-httpclient-version>
     <commons-logging-version>1.1</commons-logging-version>
