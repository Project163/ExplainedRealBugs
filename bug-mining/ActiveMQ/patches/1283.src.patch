diff --git a/activemq-core/src/test/java/org/apache/activemq/usecases/DurableUnsubscribeTest.java b/activemq-core/src/test/java/org/apache/activemq/usecases/DurableUnsubscribeTest.java
index 8a3970322..b42ce52d3 100644
--- a/activemq-core/src/test/java/org/apache/activemq/usecases/DurableUnsubscribeTest.java
+++ b/activemq-core/src/test/java/org/apache/activemq/usecases/DurableUnsubscribeTest.java
@@ -104,6 +104,7 @@ public class DurableUnsubscribeTest extends org.apache.activemq.TestSupport {
         //broker.setPersistent(false);
         broker.setUseJmx(true);
         broker.setBrokerName(getName());
+        broker.deleteAllMessages();
         broker.start();
 
         connection = createConnection();
diff --git a/kahadb/src/main/java/org/apache/kahadb/page/PageFile.java b/kahadb/src/main/java/org/apache/kahadb/page/PageFile.java
index 40642f649..5ba3c147b 100644
--- a/kahadb/src/main/java/org/apache/kahadb/page/PageFile.java
+++ b/kahadb/src/main/java/org/apache/kahadb/page/PageFile.java
@@ -131,6 +131,8 @@ public class PageFile {
     // Persistent settings stored in the page file. 
     private MetaData metaData;
 
+    private ArrayList<File> tmpFilesForRemoval = new ArrayList<File>();
+
     /**
      * Use to keep track of updated pages which have not yet been committed.
      */
@@ -1042,6 +1044,12 @@ public class PageFile {
                      // the write cache.
                      if (w.isDone()) {
                          writes.remove(w.page.getPageId());
+                         if (w.tmpFile != null && tmpFilesForRemoval.contains(w.tmpFile)) {
+                             if (!w.tmpFile.delete()) {
+                                 throw new IOException("Can't delete temporary KahaDB transaction file:" + w.tmpFile);
+                             }
+                             tmpFilesForRemoval.remove(w.tmpFile);
+                         }
                      }
                  }
              }
@@ -1052,6 +1060,10 @@ public class PageFile {
          }
      }
 
+    public void removeTmpFile(File file) {
+        tmpFilesForRemoval.add(file);
+    }
+
     private long recoveryFileSizeForPages(int pageCount) {
         return RECOVERY_FILE_HEADER_SIZE+((pageSize+8)*pageCount);
     }
diff --git a/kahadb/src/main/java/org/apache/kahadb/page/Transaction.java b/kahadb/src/main/java/org/apache/kahadb/page/Transaction.java
index a327927ec..e71297501 100644
--- a/kahadb/src/main/java/org/apache/kahadb/page/Transaction.java
+++ b/kahadb/src/main/java/org/apache/kahadb/page/Transaction.java
@@ -636,6 +636,12 @@ public class Transaction implements Iterable<Page> {
      */
     public void commit() throws IOException {
         if( writeTransactionId!=-1 ) {
+            if (tmpFile != null) {
+                tmpFile.close();
+                pageFile.removeTmpFile(getTempFile());
+                tmpFile = null;
+                txFile = null;
+            }
             // Actually do the page writes...
             pageFile.write(writes.entrySet());
             // Release the pages that were freed up in the transaction..
@@ -645,14 +651,6 @@ public class Transaction implements Iterable<Page> {
             allocateList.clear();
             writes.clear();
             writeTransactionId = -1;
-            if (tmpFile != null) {
-                tmpFile.close();
-                if (!getTempFile().delete()) {
-                    throw new IOException("Can't delete temporary KahaDB transaction file:"  + getTempFile());
-                }
-                tmpFile = null;
-                txFile = null;
-            }
         }
         size = 0;
     }
@@ -662,6 +660,12 @@ public class Transaction implements Iterable<Page> {
      */
     public void rollback() throws IOException {
         if( writeTransactionId!=-1 ) {
+            if (tmpFile != null) {
+                tmpFile.close();
+                pageFile.removeTmpFile(getTempFile());
+                tmpFile = null;
+                txFile = null;
+            }
             // Release the pages that were allocated in the transaction...
             freePages(allocateList);
 
@@ -669,14 +673,6 @@ public class Transaction implements Iterable<Page> {
             allocateList.clear();
             writes.clear();
             writeTransactionId = -1;
-            if (tmpFile != null) {
-                tmpFile.close();
-                if (getTempFile().delete()) {
-                    throw new IOException("Can't delete temporary KahaDB transaction file:"  + getTempFile());
-                }
-                tmpFile = null;
-                txFile = null;
-            }
         }
         size = 0;
     }
