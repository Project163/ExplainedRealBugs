diff --git a/activemq-core/src/main/java/org/apache/activemq/broker/TransportConnector.java b/activemq-core/src/main/java/org/apache/activemq/broker/TransportConnector.java
index 892208ef8..85628b15a 100755
--- a/activemq-core/src/main/java/org/apache/activemq/broker/TransportConnector.java
+++ b/activemq-core/src/main/java/org/apache/activemq/broker/TransportConnector.java
@@ -280,7 +280,6 @@ public class TransportConnector implements Connector, BrokerServiceAware {
         }
         if (server != null) {
             ss.stop(server);
-            server = null;
         }
         if (this.statusDector != null) {
             this.statusDector.stop();
@@ -290,6 +289,7 @@ public class TransportConnector implements Connector, BrokerServiceAware {
             TransportConnection c = iter.next();
             ss.stop(c);
         }
+        server = null;
         ss.throwFirstException();
         LOG.info("Connector " + getName() + " Stopped");
     }
diff --git a/activemq-core/src/main/java/org/apache/activemq/security/JaasDualAuthenticationBroker.java b/activemq-core/src/main/java/org/apache/activemq/security/JaasDualAuthenticationBroker.java
index d9a6f80ad..7264cabbe 100644
--- a/activemq-core/src/main/java/org/apache/activemq/security/JaasDualAuthenticationBroker.java
+++ b/activemq-core/src/main/java/org/apache/activemq/security/JaasDualAuthenticationBroker.java
@@ -106,9 +106,9 @@ public class JaasDualAuthenticationBroker extends BrokerFilter {
     public void removeConnection(ConnectionContext context, ConnectionInfo info, Throwable error) throws Exception {
         boolean isSSL;
         Connector connector = context.getConnector();
-        if (connector instanceof ManagedTransportConnector) {
-            ManagedTransportConnector managedTransportConnector = (ManagedTransportConnector) connector;
-            isSSL = (managedTransportConnector.getServer() instanceof SslTransportServer);
+        if (connector instanceof TransportConnector) {
+            TransportConnector transportConnector = (TransportConnector) connector;
+            isSSL = (transportConnector.getServer() instanceof SslTransportServer);
         } else {
             isSSL = false;
         }
diff --git a/activemq-core/src/test/java/org/apache/activemq/transport/stomp/ConnectTest.java b/activemq-core/src/test/java/org/apache/activemq/transport/stomp/ConnectTest.java
index 928caa905..f656afb2d 100644
--- a/activemq-core/src/test/java/org/apache/activemq/transport/stomp/ConnectTest.java
+++ b/activemq-core/src/test/java/org/apache/activemq/transport/stomp/ConnectTest.java
@@ -16,8 +16,14 @@
  */
 package org.apache.activemq.transport.stomp;
 
+import java.net.InetAddress;
+import java.net.InetSocketAddress;
+import java.net.ServerSocket;
 import java.util.Vector;
+import javax.net.ServerSocketFactory;
+import org.apache.activemq.broker.BrokerPlugin;
 import org.apache.activemq.broker.BrokerService;
+import org.apache.activemq.security.JaasDualAuthenticationPlugin;
 import org.apache.activemq.util.Wait;
 import org.junit.After;
 import org.junit.Before;
@@ -40,8 +46,6 @@ public class ConnectTest {
         brokerService = new BrokerService();
         brokerService.setPersistent(false);
         brokerService.setAdvisorySupport(false);
-        brokerService.addConnector("stomp://0.0.0.0:61612?transport.soLinger=0");
-        brokerService.start();
     }
 
     @After
@@ -54,12 +58,15 @@ public class ConnectTest {
     @Test
     public void testStompConnectLeak() throws Exception {
 
+        brokerService.addConnector("stomp://0.0.0.0:0?transport.soLinger=0");
+        brokerService.start();
+
         Thread t1 = new Thread() {
             StompConnection connection = new StompConnection();
 
             public void run() {
                 try {
-                    connection.open("localhost", 61612);
+                    connection.open("localhost", brokerService.getTransportConnectors().get(0).getConnectUri().getPort());
                     connection.connect("system", "manager");
                     connection.disconnect();
                 } catch (Exception ex) {
@@ -70,7 +77,7 @@ public class ConnectTest {
         };
 
         int i = 0;
-        long done = System.currentTimeMillis() + (60 * 1000 * 2);
+        long done = System.currentTimeMillis() + (15 * 1000);
         while (System.currentTimeMillis() < done) {
             t1.run();
             if (++i % 5000 == 0) {
@@ -86,4 +93,47 @@ public class ConnectTest {
         }));
         assertTrue("no exceptions", exceptions.isEmpty());
     }
+
+    @Test
+    public void testJaasDualStopWithOpenConnection() throws Exception {
+
+        brokerService.setPlugins(new BrokerPlugin[]{new JaasDualAuthenticationPlugin()});
+        brokerService.addConnector("stomp://0.0.0.0:0?transport.closeAsync=false");
+        brokerService.start();
+
+        final int listenPort = brokerService.getTransportConnectors().get(0).getConnectUri().getPort();
+        Thread t1 = new Thread() {
+            StompConnection connection = new StompConnection();
+
+            public void run() {
+                try {
+                    connection.open("localhost", listenPort);
+                    connection.connect("system", "manager");
+                } catch (Exception ex) {
+                    LOG.error("unexpected exception on connect/disconnect", ex);
+                    exceptions.add(ex);
+                }
+            }
+        };
+
+        t1.run();
+
+        assertTrue("one connection", Wait.waitFor(new Wait.Condition() {
+            @Override
+            public boolean isSatisified() throws Exception {
+                return 1 == brokerService.getTransportConnectors().get(0).connectionCount();
+            }
+        }));
+
+        brokerService.stop();
+
+        // server socket should be available after stop
+        ServerSocket socket = ServerSocketFactory.getDefault().createServerSocket();
+        socket.setReuseAddress(true);
+        InetAddress address = InetAddress.getLocalHost();
+        socket.bind(new InetSocketAddress(address, listenPort));
+        LOG.info("bound address: " + socket);
+        socket.close();
+        assertTrue("no exceptions", exceptions.isEmpty());
+    }
 }
\ No newline at end of file
