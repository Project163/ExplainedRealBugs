diff --git a/activemq-broker/src/main/java/org/apache/activemq/broker/region/Queue.java b/activemq-broker/src/main/java/org/apache/activemq/broker/region/Queue.java
index dccd29636..04488a26d 100644
--- a/activemq-broker/src/main/java/org/apache/activemq/broker/region/Queue.java
+++ b/activemq-broker/src/main/java/org/apache/activemq/broker/region/Queue.java
@@ -774,11 +774,11 @@ public class Queue extends BaseDestination implements Task, UsageListener, Index
         }
     }
 
-    public void rollbackPendingCursorAdditions(MessageContext messageContext) {
+    public void rollbackPendingCursorAdditions(MessageId messageId) {
         synchronized (indexOrderedCursorUpdates) {
             for (int i = indexOrderedCursorUpdates.size() - 1; i >= 0; i--) {
                 MessageContext mc = indexOrderedCursorUpdates.get(i);
-                if (mc.message.getMessageId().equals(messageContext.message.getMessageId())) {
+                if (mc.message.getMessageId().equals(messageId)) {
                     indexOrderedCursorUpdates.remove(mc);
                     if (mc.onCompletion != null) {
                         mc.onCompletion.run();
@@ -854,7 +854,7 @@ public class Queue extends BaseDestination implements Task, UsageListener, Index
         @Override
         public void afterRollback() throws Exception {
             if (store != null && messageContext.message.isPersistent()) {
-                rollbackPendingCursorAdditions(messageContext);
+                rollbackPendingCursorAdditions(messageContext.message.getMessageId());
             }
             messageContext.message.decrementReferenceCount();
         }
@@ -888,6 +888,7 @@ public class Queue extends BaseDestination implements Task, UsageListener, Index
                     // before restarting normal broker operations
                     resetNeeded = true;
                     pendingSends.decrementAndGet();
+                    rollbackPendingCursorAdditions(message.getMessageId());
                     throw e;
                 }
             }
diff --git a/activemq-unit-tests/src/test/java/org/apache/activemq/store/jdbc/JmsTransactionCommitFailureTest.java b/activemq-unit-tests/src/test/java/org/apache/activemq/store/jdbc/JmsTransactionCommitFailureTest.java
index 3e423a89c..db7d156de 100644
--- a/activemq-unit-tests/src/test/java/org/apache/activemq/store/jdbc/JmsTransactionCommitFailureTest.java
+++ b/activemq-unit-tests/src/test/java/org/apache/activemq/store/jdbc/JmsTransactionCommitFailureTest.java
@@ -182,7 +182,7 @@ public class JmsTransactionCommitFailureTest {
         // Set failure flag on persistence adapter
         persistenceAdapter.setCommitFailureEnabled(true);
         try {
-            for (int i = 0; i < 1000; i++) {
+            for (int i = 0; i < 10; i++) {
                 try {
                     sendMessage(queueName, 2);
                 } catch (JMSException jmse) {
@@ -202,10 +202,44 @@ public class JmsTransactionCommitFailureTest {
         }
     }
 
+
+    @Test
+    public void testQueueMemoryLeakNoTx() throws Exception {
+        String queueName = "testMemoryLeak";
+
+        sendMessage(queueName, 1);
+
+        // Set failure flag on persistence adapter
+        persistenceAdapter.setCommitFailureEnabled(true);
+        try {
+            for (int i = 0; i < 10; i++) {
+                try {
+                    sendMessage(queueName, 2, false);
+                } catch (JMSException jmse) {
+                    // Expected
+                }
+            }
+        } finally {
+            persistenceAdapter.setCommitFailureEnabled(false);
+        }
+        Destination destination = broker.getDestination(new ActiveMQQueue(queueName));
+        if (destination instanceof org.apache.activemq.broker.region.Queue) {
+            org.apache.activemq.broker.region.Queue queue = (org.apache.activemq.broker.region.Queue) destination;
+            Field listField = org.apache.activemq.broker.region.Queue.class.getDeclaredField("indexOrderedCursorUpdates");
+            listField.setAccessible(true);
+            List<?> list = (List<?>) listField.get(queue);
+            Assert.assertEquals(0, list.size());
+        }
+    }
+
     private void sendMessage(String queueName, int count) throws JMSException {
+        sendMessage(queueName, count, true);
+    }
+
+    private void sendMessage(String queueName, int count, boolean transacted) throws JMSException {
         Connection con = connectionFactory.createConnection();
         try {
-            Session session = con.createSession(true, Session.SESSION_TRANSACTED);
+            Session session = con.createSession(transacted, transacted ? Session.SESSION_TRANSACTED : Session.AUTO_ACKNOWLEDGE);
             try {
                 Queue destination = session.createQueue(queueName);
                 MessageProducer producer = session.createProducer(destination);
@@ -216,7 +250,9 @@ public class JmsTransactionCommitFailureTest {
                         message.setText("Message-" + messageCounter++);
                         producer.send(message);
                     }
-                    session.commit();
+                    if (transacted) {
+                        session.commit();
+                    }
                 } finally {
                     producer.close();
                 }
