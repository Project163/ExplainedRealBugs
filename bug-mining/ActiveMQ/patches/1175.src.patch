diff --git a/activemq-core/src/main/java/org/apache/activemq/store/kahadb/MessageDatabase.java b/activemq-core/src/main/java/org/apache/activemq/store/kahadb/MessageDatabase.java
index 721fc7906..e975393f7 100644
--- a/activemq-core/src/main/java/org/apache/activemq/store/kahadb/MessageDatabase.java
+++ b/activemq-core/src/main/java/org/apache/activemq/store/kahadb/MessageDatabase.java
@@ -1142,7 +1142,10 @@ public class MessageDatabase extends ServiceSupport implements BrokerServiceAwar
      */
     void checkpointUpdate(Transaction tx, boolean cleanup) throws IOException {
         LOG.debug("Checkpoint started.");
-        
+
+        // reflect last update exclusive of current checkpoint
+        Location firstTxLocation = metadata.lastUpdate;
+
         metadata.state = OPEN_STATE;
         metadata.producerSequenceIdTrackerLocation = checkpointProducerAudit();
         metadata.firstInProgressTransactionLocation = getFirstInProgressTxLocation();
@@ -1153,16 +1156,19 @@ public class MessageDatabase extends ServiceSupport implements BrokerServiceAwar
 
             final TreeSet<Integer> completeFileSet = new TreeSet<Integer>(journal.getFileMap().keySet());
             final TreeSet<Integer> gcCandidateSet = new TreeSet<Integer>(completeFileSet);
-        	
+
+            LOG.trace("Last update: " + firstTxLocation + ", full gc candidates set: " + gcCandidateSet);
+
         	// Don't GC files under replication
         	if( journalFilesBeingReplicated!=null ) {
         		gcCandidateSet.removeAll(journalFilesBeingReplicated);
         	}
-        	
-        	// Don't GC files after the first in progress tx
-        	Location firstTxLocation = metadata.lastUpdate;
+
+            // Don't GC files after the first in progress tx
             if( metadata.firstInProgressTransactionLocation!=null ) {
-                firstTxLocation = metadata.firstInProgressTransactionLocation;
+                if (metadata.firstInProgressTransactionLocation.getDataFileId() < firstTxLocation.getDataFileId()) {
+                   firstTxLocation = metadata.firstInProgressTransactionLocation;
+                };
             }
             
             if( firstTxLocation!=null ) {
diff --git a/activemq-core/src/test/java/org/apache/activemq/bugs/AMQ3120Test.java b/activemq-core/src/test/java/org/apache/activemq/bugs/AMQ3120Test.java
index 0681eac09..bfff0fd95 100644
--- a/activemq-core/src/test/java/org/apache/activemq/bugs/AMQ3120Test.java
+++ b/activemq-core/src/test/java/org/apache/activemq/bugs/AMQ3120Test.java
@@ -109,8 +109,8 @@ public class AMQ3120Test {
 
     @Test
     public void testCleanupOfFiles() throws Exception {
-
-        startBroker(false);
+        final int messageCount = 500;
+        startBroker(true);
         int fileCount = getFileCount(kahaDbDir);
         assertEquals(4, fileCount);
 
@@ -126,9 +126,11 @@ public class AMQ3120Test {
                 return sess.createTextMessage(payload + "::" + i);
             }
         };
-        producer.setSleep(1500);
+        producer.setSleep(650);
+        producer.setMessageCount(messageCount);
         ConsumerThread consumer = new ConsumerThread(consumerSess, destination);
         consumer.setBreakOnNull(false);
+        consumer.setMessageCount(messageCount);
 
         producer.start();
         consumer.start();
@@ -136,6 +138,7 @@ public class AMQ3120Test {
         producer.join();
         consumer.join();
 
+        assertEquals("consumer got all produced messages", producer.getMessageCount(), consumer.getReceived());
 
         broker.stop();
         broker.waitUntilStopped();
