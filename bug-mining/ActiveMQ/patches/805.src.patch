diff --git a/activemq-core/src/main/java/org/apache/activemq/ActiveMQMessageConsumer.java b/activemq-core/src/main/java/org/apache/activemq/ActiveMQMessageConsumer.java
index 751da8636..d4d718d10 100755
--- a/activemq-core/src/main/java/org/apache/activemq/ActiveMQMessageConsumer.java
+++ b/activemq-core/src/main/java/org/apache/activemq/ActiveMQMessageConsumer.java
@@ -729,6 +729,8 @@ public class ActiveMQMessageConsumer implements MessageAvailableConsumer, StatsC
                     deliveredMessages.clear();
                 }
             }
+            unconsumedMessages.close();
+            this.session.removeConsumer(this);
             List<MessageDispatch> list = unconsumedMessages.removeAll();
             if (!this.info.isBrowser()) {
                 for (MessageDispatch old : list) {
@@ -736,8 +738,6 @@ public class ActiveMQMessageConsumer implements MessageAvailableConsumer, StatsC
                     session.connection.rollbackDuplicate(this, old.getMessage());
                 }
             }
-            unconsumedMessages.close();
-            this.session.removeConsumer(this);
         }
     }
 
diff --git a/activemq-core/src/main/java/org/apache/activemq/broker/region/Queue.java b/activemq-core/src/main/java/org/apache/activemq/broker/region/Queue.java
index 6403b30e0..2c479b3ca 100755
--- a/activemq-core/src/main/java/org/apache/activemq/broker/region/Queue.java
+++ b/activemq-core/src/main/java/org/apache/activemq/broker/region/Queue.java
@@ -1160,7 +1160,10 @@ public class Queue extends BaseDestination implements Task, UsageListener {
                     LOG.error("Failed to page in more queue messages ", e);
                 }
             }
-            return pendingWakeups.decrementAndGet() > 0;
+            if (pendingWakeups.get() > 0) {
+                pendingWakeups.decrementAndGet();
+            }
+            return pendingWakeups.get() > 0;
         }
     }
 
@@ -1333,7 +1336,7 @@ public class Queue extends BaseDestination implements Task, UsageListener {
             int toPageIn = Math.min(getMaxPageSize(), messages.size());
             if (LOG.isDebugEnabled()) {
                 LOG.debug(destination.getPhysicalName() + " toPageIn: " + toPageIn + ", Inflight: " + destinationStatistics.getInflight().getCount() + ", pagedInMessages.size "
-                        + pagedInMessages.size());
+                        + pagedInMessages.size() + ", enqueueSize: " + destinationStatistics.getEnqueues().getCount());
             }
 
             if (isLazyDispatch() && !force) {
diff --git a/activemq-core/src/test/java/org/apache/activemq/bugs/AMQ2102Test.java b/activemq-core/src/test/java/org/apache/activemq/bugs/AMQ2102Test.java
index 839136421..0a81ee87a 100644
--- a/activemq-core/src/test/java/org/apache/activemq/bugs/AMQ2102Test.java
+++ b/activemq-core/src/test/java/org/apache/activemq/bugs/AMQ2102Test.java
@@ -63,7 +63,7 @@ public class AMQ2102Test extends CombinationTestSupport implements UncaughtExcep
         private boolean running;
         private org.omg.CORBA.IntHolder startup;
         private Thread thread;
-        private int numToProcessPerIteration;
+        private final int numToProcessPerIteration;
 
         Consumer(ActiveMQConnectionFactory connectionFactory, String queueName, org.omg.CORBA.IntHolder startup, int id, int numToProcess) {
             this.connectionFactory = connectionFactory;
@@ -206,12 +206,15 @@ public class AMQ2102Test extends CombinationTestSupport implements UncaughtExcep
                     try {
                         processMessage(session, producer, message);
                         session.commit();
+                        numToProcess--;
                     } catch (Throwable t) {
                         error("message=" + message + " failure", t);
                         session.rollback();
                     }
+                } else {
+                    info("got null message on: " + numToProcess);
                 }
-            } while ((numToProcess == CONSUME_ALL || --numToProcess > 0) && isRunning());
+            } while ((numToProcessPerIteration == CONSUME_ALL || numToProcess > 0) && isRunning());
         }
 
         public void run() {
@@ -360,7 +363,7 @@ public class AMQ2102Test extends CombinationTestSupport implements UncaughtExcep
                                     error("Failed to commit with count: " + messageCount.value, e);
                                 }
                             }
-                            messageCount.notify();
+                            messageCount.notifyAll();
                         }
                     } else {
                         error("Producer cannot process " + reply.getClass().getSimpleName());
@@ -441,7 +444,7 @@ public class AMQ2102Test extends CombinationTestSupport implements UncaughtExcep
     String masterUrl;
 
     public void setUp() throws Exception {
-        setMaxTestTime(10 * 60 * 1000);
+        setMaxTestTime(6 * 60 * 1000);
         setAutoFail(true);
         super.setUp();
         master.setBrokerName("Master");
