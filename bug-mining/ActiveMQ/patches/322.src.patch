diff --git a/activemq-core/src/main/java/org/apache/activemq/kaha/impl/container/ContainerKeySetIterator.java b/activemq-core/src/main/java/org/apache/activemq/kaha/impl/container/ContainerKeySetIterator.java
index 11f5607df..3ae9ee9fc 100644
--- a/activemq-core/src/main/java/org/apache/activemq/kaha/impl/container/ContainerKeySetIterator.java
+++ b/activemq-core/src/main/java/org/apache/activemq/kaha/impl/container/ContainerKeySetIterator.java
@@ -54,6 +54,9 @@ public class ContainerKeySetIterator implements Iterator {
     public void remove() {
         if (currentItem != null) {
             container.remove(currentItem);
+            if (nextItem != null) {
+                list.refreshEntry(nextItem);
+            }
         }
     }
 }
diff --git a/activemq-core/src/main/java/org/apache/activemq/store/kahadaptor/KahaReferenceStore.java b/activemq-core/src/main/java/org/apache/activemq/store/kahadaptor/KahaReferenceStore.java
index d73818419..899286589 100644
--- a/activemq-core/src/main/java/org/apache/activemq/store/kahadaptor/KahaReferenceStore.java
+++ b/activemq-core/src/main/java/org/apache/activemq/store/kahadaptor/KahaReferenceStore.java
@@ -17,6 +17,8 @@
 package org.apache.activemq.store.kahadaptor;
 
 import java.io.IOException;
+import java.util.HashSet;
+import java.util.Set;
 import java.util.concurrent.locks.Lock;
 import java.util.concurrent.locks.ReentrantLock;
 
@@ -192,11 +194,15 @@ public class KahaReferenceStore implements ReferenceStore {
     public void removeAllMessages(ConnectionContext context) throws IOException {
         lock.lock();
         try {
+            Set<MessageId> tmpSet = new HashSet(messageContainer.keySet());
+            for (MessageId id:tmpSet) {
+                removeMessage(id);
+            }
+            resetBatching();
             messageContainer.clear();
         }finally {
             lock.unlock();
         }
-        
     }
 
     public ActiveMQDestination getDestination() {
diff --git a/activemq-core/src/main/java/org/apache/activemq/store/kahadaptor/KahaTopicReferenceStore.java b/activemq-core/src/main/java/org/apache/activemq/store/kahadaptor/KahaTopicReferenceStore.java
index 53e12f75d..5c156f3d4 100644
--- a/activemq-core/src/main/java/org/apache/activemq/store/kahadaptor/KahaTopicReferenceStore.java
+++ b/activemq-core/src/main/java/org/apache/activemq/store/kahadaptor/KahaTopicReferenceStore.java
@@ -17,8 +17,10 @@
 package org.apache.activemq.store.kahadaptor;
 
 import java.io.IOException;
+import java.util.HashSet;
 import java.util.Iterator;
 import java.util.Map;
+import java.util.Set;
 import java.util.concurrent.ConcurrentHashMap;
 import java.util.concurrent.locks.Lock;
 
@@ -300,6 +302,23 @@ public class KahaTopicReferenceStore extends KahaReferenceStore implements Topic
             lock.unlock();
         }
     }
+    
+    public void removeAllMessages(ConnectionContext context) throws IOException {
+        lock.lock();
+        try {
+            Set<String> tmpSet = new HashSet<String>(subscriberContainer.keySet());
+            for (String key:tmpSet) {
+                TopicSubContainer container = subscriberMessages.get(key);
+                if (container != null) {
+                    container.clear();
+                }
+            }
+            ackContainer.clear();
+        }finally {
+            lock.unlock();
+        }
+        super.removeAllMessages(context);
+    }
 
     protected void removeSubscriberMessageContainer(String clientId, String subscriptionName) throws IOException {
         String subscriberKey = getSubscriptionKey(clientId, subscriptionName);
