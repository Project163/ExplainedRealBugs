diff --git a/activemq-core/src/main/java/org/apache/activemq/TransactionContext.java b/activemq-core/src/main/java/org/apache/activemq/TransactionContext.java
index 31f946ad5..c84fae26d 100755
--- a/activemq-core/src/main/java/org/apache/activemq/TransactionContext.java
+++ b/activemq-core/src/main/java/org/apache/activemq/TransactionContext.java
@@ -35,6 +35,7 @@ import org.apache.activemq.command.LocalTransactionId;
 import org.apache.activemq.command.TransactionId;
 import org.apache.activemq.command.TransactionInfo;
 import org.apache.activemq.command.XATransactionId;
+import org.apache.activemq.command.DataStructure;
 import org.apache.activemq.transaction.Synchronization;
 import org.apache.activemq.util.JMSExceptionSupport;
 import org.apache.activemq.util.LongSequenceGenerator;
@@ -514,7 +515,16 @@ public class TransactionContext implements XAResource {
 			this.connection.ensureConnectionInfoSent();
 
 			DataArrayResponse receipt = (DataArrayResponse) this.connection.syncSendPacket(info);
-            return (XATransactionId[]) receipt.getData();
+            DataStructure[] data = receipt.getData();
+            XATransactionId[] answer = null;
+            if (data instanceof XATransactionId[]) {
+                answer = (XATransactionId[]) data;
+            }
+            else {
+                answer = new XATransactionId[data.length];
+                System.arraycopy(data, 0, answer, 0, data.length);
+            }
+            return answer;
         } catch (JMSException e) {
             throw toXAException(e);
         }
diff --git a/activemq-test-atomikos/pom.xml b/activemq-test-atomikos/pom.xml
new file mode 100755
index 000000000..4edab0fa5
--- /dev/null
+++ b/activemq-test-atomikos/pom.xml
@@ -0,0 +1,101 @@
+<?xml version="1.0" encoding="UTF-8"?>
+
+<!--
+    Licensed to the Apache Software Foundation (ASF) under one or more
+    contributor license agreements.  See the NOTICE file distributed with
+    this work for additional information regarding copyright ownership.
+    The ASF licenses this file to You under the Apache License, Version 2.0
+    (the "License"); you may not use this file except in compliance with
+    the License.  You may obtain a copy of the License at
+   
+    http://www.apache.org/licenses/LICENSE-2.0
+   
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+
+<project
+        xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"
+        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+        xmlns="http://maven.apache.org/POM/4.0.0">
+
+  <modelVersion>4.0.0</modelVersion>
+
+  <parent>
+    <groupId>org.apache.activemq</groupId>
+    <artifactId>activemq-parent</artifactId>
+    <version>4.2-incubator-SNAPSHOT</version>
+  </parent>
+
+  <artifactId>activemq-test-atomikos</artifactId>
+  <packaging>jar</packaging>
+  <name>ActiveMQ :: Atomikos System Test</name>
+
+  <repositories>
+    <!-- for the Atomikos jars -->
+    <repository>
+      <id>logicblaze.deps</id>
+      <url>http://repo.logicblaze.com/maven2-all</url>
+      <snapshots>
+        <enabled>true</enabled>
+      </snapshots>
+      <releases>
+        <enabled>true</enabled>
+      </releases>
+    </repository>
+  </repositories>
+
+  <dependencies>
+    <!-- activemq -->
+    <dependency>
+      <groupId>${pom.groupId}</groupId>
+      <artifactId>activemq-core</artifactId>
+    </dependency>
+    <dependency>
+      <groupId>${pom.groupId}</groupId>
+      <artifactId>activemq-core</artifactId>
+      <scope>compile</scope>
+      <type>test-jar</type>
+    </dependency>
+    <dependency>
+      <groupId>${pom.groupId}</groupId>
+      <artifactId>activeio-core</artifactId>
+    </dependency>
+    <dependency>
+      <groupId>org.apache.derby</groupId>
+      <artifactId>derby</artifactId>
+      <optional>true</optional>
+    </dependency>
+
+    <dependency>
+      <groupId>com.atomikos</groupId>
+      <artifactId>transactions</artifactId>
+      <version>3.1.0</version>
+    </dependency>
+    <dependency>
+      <groupId>com.atomikos</groupId>
+      <artifactId>transactions-api</artifactId>
+      <version>3.1.0</version>
+    </dependency>
+    <dependency>
+      <groupId>com.atomikos</groupId>
+      <artifactId>transactions-jta</artifactId>
+      <version>3.1.0</version>
+    </dependency>
+    <dependency>
+      <groupId>com.atomikos</groupId>
+      <artifactId>atomikos-util</artifactId>
+      <version>3.1.0</version>
+    </dependency>
+
+    <dependency>
+      <groupId>junit</groupId>
+      <artifactId>junit</artifactId>
+      <scope>compile</scope>
+    </dependency>
+
+  </dependencies>
+</project>
diff --git a/activemq-test-atomikos/src/test/java/org/apache/activemq/atomikos/XATest.java b/activemq-test-atomikos/src/test/java/org/apache/activemq/atomikos/XATest.java
new file mode 100644
index 000000000..c087b25a0
--- /dev/null
+++ b/activemq-test-atomikos/src/test/java/org/apache/activemq/atomikos/XATest.java
@@ -0,0 +1,66 @@
+/**
+ *
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.activemq.atomikos;
+
+import com.atomikos.datasource.xa.DefaultXidFactory;
+import org.apache.activemq.ActiveMQXAConnectionFactory;
+import org.apache.activemq.command.ActiveMQQueue;
+
+import javax.jms.MessageConsumer;
+import javax.jms.XAConnection;
+import javax.jms.XASession;
+import javax.transaction.xa.XAResource;
+import javax.transaction.xa.Xid;
+
+import junit.framework.TestCase;
+
+
+/**
+ * @version $Revision$
+ */
+public class XATest extends TestCase {
+
+    public void testXA() throws Exception {
+        //String url = "tcp://localhost:61616";
+        String url = "vm://localhost";
+        String qName = "MyQueue";
+        int timeout = 5;
+        DefaultXidFactory xidFactory = new DefaultXidFactory();
+        ActiveMQXAConnectionFactory xacf = new ActiveMQXAConnectionFactory();
+        xacf.setBrokerURL(url);
+        ActiveMQQueue queue = new ActiveMQQueue();
+        queue.setPhysicalName(qName);
+        XAConnection xaconn = xacf.createXAConnection();
+        xaconn.start();
+        XASession session = xaconn.createXASession();
+        XAResource xares = session.getXAResource();
+        MessageConsumer receiver = session.getSession().createConsumer(queue);
+        xares.recover(XAResource.TMSTARTRSCAN);
+        xares.recover(XAResource.TMNOFLAGS);
+        xares.setTransactionTimeout(timeout);
+        xares.isSameRM(xares);
+        Xid xid = xidFactory.createXid("part1", "part2");
+        xares.start(xid, XAResource.TMNOFLAGS);
+        receiver.receive(timeout);
+        xares.end(xid, XAResource.TMSUCCESS);
+        xares.rollback(xid);
+
+        System.out.println("Done!");
+    }
+
+}
diff --git a/pom.xml b/pom.xml
index e1ef802f5..7ab574313 100755
--- a/pom.xml
+++ b/pom.xml
@@ -126,20 +126,21 @@
   </distributionManagement>
 
   <modules>
-    <module>activemq-jaas</module>
     <module>activemq-core</module>
     <module>activemq-console</module>
+    <module>activemq-jaas</module>
+    <module>activemq-jpa-store</module>
+    <module>activemq-openwire-generator</module>
+    <module>activemq-optional</module>
     <module>activemq-ra</module>
     <module>activemq-rar</module>
+    <module>activemq-test-atomikos</module>
+    <module>activemq-tooling</module>
     <module>activemq-web</module>
     <module>activemq-web-demo</module>
     <module>activemq-web-console</module>
-    <module>activemq-optional</module>
-    <module>activemq-tooling</module>
-    <module>activemq-openwire-generator</module>
     <module>activemq-xmpp</module>
     <module>assembly</module>
-    <module>activemq-jpa-store</module>
   </modules>
 
   <scm>
