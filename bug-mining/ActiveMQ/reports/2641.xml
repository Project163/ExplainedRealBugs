<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:22:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5568] Deleting lock file on broker shut down can take a master broker down</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5568</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;This problem may only occur on a shared file system master/slave setup. &lt;br/&gt;
I can reproduce reliably on a NFSv4 mount using a persistence adapter configuration like &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;levelDB directory=&lt;span class=&quot;code-quote&quot;&gt;&quot;/nfs/activemq/data/leveldb&quot;&lt;/span&gt; lockKeepAlivePeriod=&lt;span class=&quot;code-quote&quot;&gt;&quot;5000&quot;&lt;/span&gt;&amp;gt;
  &amp;lt;locker&amp;gt;
    &amp;lt;shared-file-locker lockAcquireSleepInterval=&lt;span class=&quot;code-quote&quot;&gt;&quot;10000&quot;&lt;/span&gt;/&amp;gt;
  &amp;lt;/locker&amp;gt;
&amp;lt;/levelDB&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However the problem is also reproducible using kahaDB.&lt;br/&gt;
Two broker instances competing for the lock on the shared storage (e.g. leveldb or kahadb). Lets say brokerA becomes master, broker B slave.&lt;/p&gt;

&lt;p&gt;If brokerA looses access to the NFS share, it will shut down. As part of shutting down, it tries delete the lock file of the persistence adapter. Now since the NFS share is gone, all file i/o calls hang for a good while before returning errors. As such the broker shut down gets delayed.&lt;/p&gt;

&lt;p&gt;In the meantime the slave broker B (not affected by the NFS problem) grabs the lock and becomes master.&lt;/p&gt;

&lt;p&gt;If the NFS mount is restored while broker A (the previous master) still hangs on the file i/o operations (as part of its shutdown routine), the attempt to delete the persistence adapter lock file will finally succeed and broker A shuts down. &lt;/p&gt;

&lt;p&gt;Deleting the lock file however also affects the new master broker B who periodically runs a keepAlive() check on the lock. That check verifies the file still exists and the FileLock is still valid. As the lock file got deleted, keepAlive() fails on broker B and that broker shuts down as well. &lt;br/&gt;
The overall result is that both broker instances have shut down despite an initially successful failover.&lt;/p&gt;

&lt;p&gt;Using restartAllowed=true is not an option either as this can cause other problems in an NFS based master/slave setup.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12772996">AMQ-5568</key>
            <summary>Deleting lock file on broker shut down can take a master broker down</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="tmielke">Torsten Mielke</reporter>
                        <labels>
                            <label>persistence</label>
                    </labels>
                <created>Fri, 6 Feb 2015 12:58:26 +0000</created>
                <updated>Tue, 22 Sep 2015 11:56:30 +0000</updated>
                            <resolved>Thu, 5 Mar 2015 13:29:40 +0000</resolved>
                                    <version>5.11.0</version>
                                    <fixVersion>5.12.0</fixVersion>
                                    <component>Broker</component>
                    <component>Message Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14309092" author="tmielke" created="Fri, 6 Feb 2015 13:04:48 +0000"  >&lt;p&gt;The keepAlive() check is needed due to &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4705&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;AMQ-4705&lt;/a&gt;, otherwise you may get two master broker instances.&lt;/p&gt;</comment>
                            <comment id="14309106" author="tmielke" created="Fri, 6 Feb 2015 13:19:54 +0000"  >&lt;p&gt;It seems the broker simply deletes the lock file on the persistence adapter without any further checks. &lt;br/&gt;
Perhaps a fix is to delete the lock file only if the broker still holds the lock and otherwise just shut down without deleting the file. &lt;/p&gt;</comment>
                            <comment id="14348734" author="gtully" created="Thu, 5 Mar 2015 13:29:40 +0000"  >&lt;p&gt;fix in &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/activemq/commit/8c66fba0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/activemq/commit/8c66fba0&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14485443" author="clebertsuconic" created="Wed, 8 Apr 2015 16:04:03 +0000"  >&lt;p&gt;I just sent a fix that could be related to this:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/activemq/commit/ab8f54b0661755a3b5d8afbd18341e15ab4fe38c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/commit/ab8f54b0661755a3b5d8afbd18341e15ab4fe38c&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14741440" author="erik.wramner" created="Fri, 11 Sep 2015 19:44:01 +0000"  >&lt;p&gt;I&apos;m surprised that I haven&apos;t seen others with the same issue, but the unit test LockFileTest#testNoDeleteOnUnlockIfNotLocked always fails for me on Windows. It works on Linux. The problem is that Windows refuses to delete open files and the file is open, so lockFile.delete() returns false and does nothing, hence the no-longer-valid check fails as the file still exists and is valid.&lt;/p&gt;

&lt;p&gt;Am I the only one seeing this, or should I fix the test (check the return code from delete and skip the rest of the test on failure)?&lt;/p&gt;</comment>
                            <comment id="14902447" author="jira-bot" created="Tue, 22 Sep 2015 11:56:30 +0000"  >&lt;p&gt;Commit 86c826c4615d5f4d90cc3f75fef845640369458d in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=86c826c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=86c826c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5568&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5568&lt;/a&gt; - verify delete return code for win platform failure. Thanks to Erik Wramner for the heads up&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12770925">AMQ-5549</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12666328">AMQ-4705</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 9 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i25adj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>