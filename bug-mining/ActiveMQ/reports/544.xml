<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:39:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1807] Activemq stops dispatching messages aborting transaction (STOMP)</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1807</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;As requested by Dejan Bosanac, I&apos;m adding this ticket. I&apos;m willing to help fix it, ie. I can get my hands dirty, but I must have some pointers on where to look because (unfortunately) I don&apos;t have much time to learn ActiveMQ&apos;s internals and architecture.&lt;/p&gt;

&lt;p&gt;A copy of the email I sent to the users mailing-list:&lt;br/&gt;
=============================================&lt;/p&gt;

&lt;p&gt;I&apos;m currently struggling to understand the reason behind that&apos;s causing the behaviour described in the subject: I&apos;m connecting to activemq via stomp on a python app. Because I need to have the messages rolled back in case of some processing failure I&apos;m wrapping the message processing in the following way:&lt;/p&gt;

&lt;p&gt; message received -&amp;gt; start transaction -&amp;gt; ack message in transaction -&amp;gt;&lt;br/&gt;
process message -&amp;gt; if no exception commit tx, else rollback transaction&lt;/p&gt;


&lt;p&gt;AFAIK, this is the only way of making message unacknowledgement possible with stomp. Also, this is a single client connection, ie. I&apos;m using a&lt;br/&gt;
single client connection to create a message processing daemon, all messages are sent and received via this single connection to the MQ server.&lt;/p&gt;

&lt;p&gt;Here&apos;s a telnet session that can be used to reproduce the problem (open jconsole and send 5 text messages to the queue):&lt;/p&gt;

&lt;p&gt;% telnet localhost 61613&lt;br/&gt;
Trying 127.0.0.1...&lt;br/&gt;
Connected to localhost.&lt;br/&gt;
Escape character is &apos;^]&apos;.&lt;br/&gt;
CONNECT&lt;/p&gt;

&lt;p&gt;^@&lt;br/&gt;
CONNECTED&lt;br/&gt;
session:ID:starfish-53281-1213736462979-2:2&lt;/p&gt;


&lt;p&gt;SUBSCRIBE&lt;br/&gt;
destination: /queue/testq&lt;br/&gt;
ack: client&lt;br/&gt;
activemq.prefetchSize: 1&lt;/p&gt;

&lt;p&gt;^@&lt;br/&gt;
MESSAGE&lt;br/&gt;
message-id:ID:starfish-53281-1213736462979-3:3:1:1:1&lt;br/&gt;
destination:/queue/testq&lt;br/&gt;
timestamp:1213736837743&lt;br/&gt;
expires:0&lt;br/&gt;
priority:0&lt;/p&gt;

&lt;p&gt;1&lt;br/&gt;
BEGIN&lt;br/&gt;
transaction: 1&lt;/p&gt;

&lt;p&gt;^@&lt;br/&gt;
ACK&lt;br/&gt;
message-id:ID:starfish-53281-1213736462979-3:3:1:1:1&lt;br/&gt;
transaction: 1&lt;/p&gt;

&lt;p&gt;^@&lt;br/&gt;
MESSAGE&lt;br/&gt;
message-id:ID:starfish-53281-1213736462979-3:4:1:1:1&lt;br/&gt;
destination:/queue/testq&lt;br/&gt;
timestamp:1213736840224&lt;br/&gt;
expires:0&lt;br/&gt;
priority:0&lt;/p&gt;

&lt;p&gt;2&lt;br/&gt;
MESSAGE&lt;br/&gt;
message-id:ID:starfish-53281-1213736462979-3:5:1:1:1&lt;br/&gt;
destination:/queue/testq&lt;br/&gt;
timestamp:1213736842611&lt;br/&gt;
expires:0&lt;br/&gt;
priority:0&lt;/p&gt;

&lt;p&gt;3&lt;br/&gt;
ABORT   &lt;br/&gt;
transaction: 1&lt;/p&gt;

&lt;p&gt;^@&lt;br/&gt;
BEGIN &lt;br/&gt;
transaction:2&lt;/p&gt;

&lt;p&gt;^@&lt;br/&gt;
ACK&lt;br/&gt;
message-id:ID:starfish-53281-1213736462979-3:4:1:1:1&lt;br/&gt;
transaction:2&lt;/p&gt;

&lt;p&gt;^@&lt;br/&gt;
ABORT&lt;br/&gt;
transaction:2&lt;/p&gt;

&lt;p&gt;^@&lt;br/&gt;
ACK&lt;br/&gt;
message-id:ID:starfish-53281-1213736462979-3:5:1:1:1&lt;/p&gt;

&lt;p&gt;^@&lt;/p&gt;


&lt;p&gt;I see a couple of issues here:&lt;/p&gt;

&lt;p&gt;#1) even though I specified activemq.prefetchSize to 1 in the subscription command, the connector dispatches two messages in a row&lt;/p&gt;

&lt;p&gt;#2) no more messages are dispatched after aborting the transaction/acknowledging the last received message. Even if the second message isn&apos;t wrapped in a transaction, message dispatch stops there.&lt;/p&gt;

&lt;p&gt;To add to the confusion, if I don&apos;t use transactions &lt;em&gt;at all&lt;/em&gt;, my client keeps getting messages, one by one, ie. no two messages are sent together, I only get a new message after ACK&apos;ing the previous one.&lt;/p&gt;

&lt;p&gt;I think I may be stepping into the realms of a buggy STOMP connector. Please tell me if I&apos;m missing something obvious that fixes this issue&lt;br/&gt;
(hence making it a non-issue) or if indeed the STOMP connector has problems.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux, JDK 1.6_06b2&lt;/p&gt;</environment>
        <key id="12483069">AMQ-1807</key>
            <summary>Activemq stops dispatching messages aborting transaction (STOMP)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="cpinto">Celso Pinto</reporter>
                        <labels>
                    </labels>
                <created>Wed, 18 Jun 2008 10:12:36 +0000</created>
                <updated>Wed, 19 Aug 2009 11:37:03 +0000</updated>
                            <resolved>Wed, 5 Aug 2009 14:48:10 +0000</resolved>
                                    <version>5.1.0</version>
                                    <fixVersion>5.3.0</fixVersion>
                                    <component>Transport</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="12939893" author="cpinto" created="Tue, 1 Jul 2008 00:00:43 +0000"  >&lt;p&gt;This test uncovers two messages being dispatched on client ACK&lt;/p&gt;</comment>
                            <comment id="12939907" author="cpinto" created="Tue, 1 Jul 2008 00:06:50 +0000"  >&lt;p&gt;I&apos;ve attached a patch for tests that displays the error described on #1. Digging through the code, I found it is related with the following piece of code in activemq-core/src/main/java/org/apache/activemq/broker/region/PrefetchSubscription.java at line 230:&lt;/p&gt;

&lt;p&gt;prefetchExtension = Math.max(prefetchExtension, index + 1);&lt;/p&gt;

&lt;p&gt;This code is broken because when the first message is dispatched to the client, prefetchExtension isn&apos;t incremented so when the client ACKs the first message, index is incremented to 1 and Math.max() returns 2 so two messages are dispatched.&lt;/p&gt;

&lt;p&gt;Can anyone please explain what prefetchExtension is supposed to do and how changing it impacts the rest of the code? I&apos;ve asked on IRC and received no replies, same thing on activemq-devel mailing list. &lt;/p&gt;</comment>
                            <comment id="12940545" author="dejanb" created="Tue, 16 Dec 2008 11:12:17 +0000"  >&lt;p&gt;I&apos;ve committed a change (along with a test case) regarding the prefetch size problem. I&apos;ve changed &quot;index + 1&quot; with &quot;index&quot;, since it is being incremented earlier. All tests are passing. If anyone else can take a look at this as well it would be great.&lt;/p&gt;</comment>
                            <comment id="12940691" author="dejanb" created="Thu, 29 Jan 2009 16:19:54 +0000"  >&lt;p&gt;The problem with dispatch stopping after transaction abort was due to the fact that messages were acked at the moment they were dispatched and we didn&apos;t have any logic to redeliver them after the rollback. I implemented some additional logic (Committed revision 738904), that acks messages received in the transaction on commit, and redeliver them after the abort. This helps in this usecase, as you can see in the StompTest.testPrefetchSize().&lt;/p&gt;

&lt;p&gt;I still can imagine certain scenarios where this would not work well, mostly because we dispatch messages as they come to the transport and don&apos;t care whether some of already dispatched messages should be redelivered before, but this requires quite a big refactoring, so I leave it for the future enhancements.&lt;/p&gt;</comment>
                            <comment id="12940803" author="dejanb" created="Thu, 19 Feb 2009 14:45:46 +0000"  >&lt;p&gt;It seems that acking a messages before an abort, still makes the client hang on the next receive.&lt;/p&gt;</comment>
                            <comment id="12941574" author="gtully" created="Wed, 24 Jun 2009 11:23:11 +0000"  >&lt;p&gt;pushing this out to 5.4.0 as more work is needed&lt;/p&gt;</comment>
                            <comment id="12941641" author="ervandew" created="Tue, 30 Jun 2009 00:35:23 +0000"  >&lt;p&gt;I just wanted to offer a bit of feedback on the current state of this as of the 20090620 snapshot (which includes Dejan&apos;s 738904 revision).  For message redelivery, when aborting the transaction, the redelivery policy is not currently honored.  This results in an infinite number of immediate retries to deliver the unacknowledged messages.&lt;/p&gt;</comment>
                            <comment id="12940937" author="dejanb" created="Wed, 5 Aug 2009 14:48:10 +0000"  >&lt;p&gt;Just looked at the test case again and it seems that this is working fine now (modified test case proves it).&lt;/p&gt;

&lt;p&gt;As for the redelivery policy, it is not implemented for Stomp. I created another issue for this: &lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-2345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-2345&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12941227" author="dejanb" created="Tue, 18 Aug 2009 08:13:48 +0000"  >&lt;p&gt;The final comment on this issue: redelivery of messages after abort is not supported by Stomp protocol (thanks Hiram for the tip), so I reverted some of the delivery logic that was implemented for this issue. The test case is StompTest.testPrefetchSize() is now modified to reflect these changes and some fixes are implemented to make it work. Please take a look at &lt;a href=&quot;http://activemq.apache.org/how-do-i-unack-the-message-with-stomp.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/how-do-i-unack-the-message-with-stomp.html&lt;/a&gt; for more info on this topic.&lt;/p&gt;</comment>
                            <comment id="12941288" author="cpinto" created="Tue, 18 Aug 2009 13:11:22 +0000"  >&lt;p&gt;I&apos;m sorry but that is just wrong, if the consumer dies out of an unexpected/unhandled error (think OOM) then the message is gone for good. The STOMP protocol does define transactions, it just doesn&apos;t specify how a consumer transaction must work. I personally see that as an oversight of the specification. You should do The Right Thing and rollback the messages if the transaction is a) explicitly aborted or b) the client connection is dropped, independently of the lack of completeness in the STOMP specification, anything else is unnacceptable and unexpected behavior of the message broker.&lt;/p&gt;</comment>
                            <comment id="12941294" author="dejanb" created="Wed, 19 Aug 2009 11:37:03 +0000"  >&lt;p&gt;Hi Celso,&lt;/p&gt;

&lt;p&gt;I think you&apos;re confusing transaction rollback and death of consumer.&lt;/p&gt;

&lt;p&gt;In case when consumer dies, the broker will detect it and will append all messages that are dispatched but not acknowledged by that consumer (all the messages you have acked in the transaction that hasn&apos;t been committed) to the end of the dispatch list. So these messages will be redelivered again to another consumer eventually. This works now in the same way for JMS and Stomp clients.&lt;/p&gt;

&lt;p&gt;But when we rollback the transaction, we say to the broker that we haven&apos;t yet consumed messages that were delivered to us. So the broker will wait for those messages to be acked before sending more messages. This also works in the same way for Java and Stomp clients, it&apos;s just that JMS Java client has built-in logic that will try to redeliver those messages first (locally) when you start a new transaction. You can also implement the same logic in your Stomp client (or application).&lt;/p&gt;

&lt;p&gt;The whole point is that redelivery of messages after the rollback, is the task for the client, since there&apos;s no need for the broker to resend those messages over the network again.&lt;/p&gt;

&lt;p&gt;Hope this helps,&lt;br/&gt;
Dejan&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461213" name="stomp_test.patch" size="3003" author="cpinto" created="Tue, 1 Jul 2008 00:00:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>43750</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 14 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rzvb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161455</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>