<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:59:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-9436] StoreQueueCursor creates different audits for persistent and non persistent cursors</title>
                <link>https://issues.apache.org/jira/browse/AMQ-9436</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;While working on &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9435&quot; title=&quot;KahaDB durable sub tracking breaks on duplicate messages&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9435&quot;&gt;&lt;del&gt;AMQ-9435&lt;/del&gt;&lt;/a&gt; I noticed that StoreQueueCursor incorrectly sets the start flag to true first before calling calling super.start() in the start method. This means that when super is called the message audit is never initialized as it thinks it was already started so it stays null forever. This causes both the persistent and non-persistent cursors to create their own audits which ends up duplicating objects when they should share the same audit so we get duplicate detection across persistent and non persistent messages and also so that we save memory by not duplicating the objects and allowing audit depth config to control how large the audit is.&#160;&lt;/p&gt;

&lt;p&gt;Something else I noticed is that the start/stop methods do not protect against calling them more than once and they should to prevent duplicate initialization so I also will fix that.&lt;/p&gt;

&lt;p&gt;I checked and durables are already correct with their audit tracking (the audit is passed down to all of the sub prefetches and shared)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13568656">AMQ-9436</key>
            <summary>StoreQueueCursor creates different audits for persistent and non persistent cursors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="cshannon">Christopher L. Shannon</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Feb 2024 22:27:16 +0000</created>
                <updated>Thu, 15 Feb 2024 23:21:55 +0000</updated>
                            <resolved>Thu, 15 Feb 2024 23:21:55 +0000</resolved>
                                    <version>5.18.3</version>
                    <version>6.0.1</version>
                                    <fixVersion>6.1.0</fixVersion>
                    <fixVersion>5.18.4</fixVersion>
                    <fixVersion>5.17.7</fixVersion>
                    <fixVersion>6.0.2</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17817808" author="jira-bot" created="Thu, 15 Feb 2024 23:16:08 +0000"  >&lt;p&gt;Commit 75de9321162ae096de4a3c0b5a325865d514e5a0 in activemq&apos;s branch refs/heads/main from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=75de93211&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=75de93211&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9436&quot; title=&quot;StoreQueueCursor creates different audits for persistent and non persistent cursors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9436&quot;&gt;&lt;del&gt;AMQ-9436&lt;/del&gt;&lt;/a&gt; - Ensure message audit in queue store cursor is shared&lt;/p&gt;

&lt;p&gt;This commit fixes the initialization of the StoreQueueCursor message&lt;br/&gt;
audit object to make sure it&apos;s shared between the persistent and non&lt;br/&gt;
persistent cursors. It also adds a check to ensure that duplicate calls&lt;br/&gt;
to start will not try and init more than once.&lt;/p&gt;</comment>
                            <comment id="17817809" author="jira-bot" created="Thu, 15 Feb 2024 23:16:09 +0000"  >&lt;p&gt;Commit 65a6b805a04766ab0523033634c00cc338090217 in activemq&apos;s branch refs/heads/main from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=65a6b805a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=65a6b805a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #1154 from cshannon/&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9436&quot; title=&quot;StoreQueueCursor creates different audits for persistent and non persistent cursors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9436&quot;&gt;&lt;del&gt;AMQ-9436&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9436&quot; title=&quot;StoreQueueCursor creates different audits for persistent and non persistent cursors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9436&quot;&gt;&lt;del&gt;AMQ-9436&lt;/del&gt;&lt;/a&gt; - Ensure message audit in queue store cursor is shared&lt;/p&gt;</comment>
                            <comment id="17817812" author="jira-bot" created="Thu, 15 Feb 2024 23:20:04 +0000"  >&lt;p&gt;Commit 3741f3e7fdf02d5233db1bbefd477704f2e0059e in activemq&apos;s branch refs/heads/activemq-6.0.x from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=3741f3e7f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=3741f3e7f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9436&quot; title=&quot;StoreQueueCursor creates different audits for persistent and non persistent cursors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9436&quot;&gt;&lt;del&gt;AMQ-9436&lt;/del&gt;&lt;/a&gt; - Ensure message audit in queue store cursor is shared&lt;/p&gt;

&lt;p&gt;This commit fixes the initialization of the StoreQueueCursor message&lt;br/&gt;
audit object to make sure it&apos;s shared between the persistent and non&lt;br/&gt;
persistent cursors. It also adds a check to ensure that duplicate calls&lt;br/&gt;
to start will not try and init more than once.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 75de9321162ae096de4a3c0b5a325865d514e5a0)&lt;/p&gt;</comment>
                            <comment id="17817813" author="jira-bot" created="Thu, 15 Feb 2024 23:20:53 +0000"  >&lt;p&gt;Commit 4bae9df5bdd2b992a716300c70e35dc892f26bd2 in activemq&apos;s branch refs/heads/activemq-5.18.x from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=4bae9df5b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=4bae9df5b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9436&quot; title=&quot;StoreQueueCursor creates different audits for persistent and non persistent cursors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9436&quot;&gt;&lt;del&gt;AMQ-9436&lt;/del&gt;&lt;/a&gt; - Ensure message audit in queue store cursor is shared&lt;/p&gt;

&lt;p&gt;This commit fixes the initialization of the StoreQueueCursor message&lt;br/&gt;
audit object to make sure it&apos;s shared between the persistent and non&lt;br/&gt;
persistent cursors. It also adds a check to ensure that duplicate calls&lt;br/&gt;
to start will not try and init more than once.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 75de9321162ae096de4a3c0b5a325865d514e5a0)&lt;/p&gt;</comment>
                            <comment id="17817815" author="jira-bot" created="Thu, 15 Feb 2024 23:21:43 +0000"  >&lt;p&gt;Commit 761c5bbdecde019833031122eb1585e3bf1b2949 in activemq&apos;s branch refs/heads/activemq-5.17.x from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=761c5bbde&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=761c5bbde&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9436&quot; title=&quot;StoreQueueCursor creates different audits for persistent and non persistent cursors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9436&quot;&gt;&lt;del&gt;AMQ-9436&lt;/del&gt;&lt;/a&gt; - Ensure message audit in queue store cursor is shared&lt;/p&gt;

&lt;p&gt;This commit fixes the initialization of the StoreQueueCursor message&lt;br/&gt;
audit object to make sure it&apos;s shared between the persistent and non&lt;br/&gt;
persistent cursors. It also adds a check to ensure that duplicate calls&lt;br/&gt;
to start will not try and init more than once.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 75de9321162ae096de4a3c0b5a325865d514e5a0)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 38 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1nfhk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>