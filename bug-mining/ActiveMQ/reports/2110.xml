<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:02:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4485] Skipped message dispatch with concurrent transacted sends at cursor memory limit</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4485</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;With multiple concurrent transacted sends, transaction synchronisation after completions are used to update the cursors.&lt;br/&gt;
These happen independent of the order that the store is updated, and hence the store order index.&lt;br/&gt;
When the cache is exhausted, a callback to the store to mark the end of caching assumes matching order. If scheduling has swapped the order, it is possible to mark the order index past what is cached and it is possible to skip a dispatch. Alternatively it is possible to mark too early which results in duplicate dispatch if the audit is disabled or exhausted.&lt;/p&gt;

&lt;p&gt;The senario that exposed this occurrence used concurrent transacted sends to 100 destinations with slow consumers. Leaving scope for out of order processing and ensuring that the cache is exhausted.&lt;/p&gt;

&lt;p&gt;Using a large destination memory limit or systemUsage limit or useCache=false policy entry will avoid this problem. The order is only important when the cache is exhausted.&lt;br/&gt;
In the skipped case, the message appears on the queue but is not consumable, however it is consumable after a restart.&lt;/p&gt;

&lt;p&gt;The proper fix is to ensure cursors are updated in the same order as the store.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12644590">AMQ-4485</key>
            <summary>Skipped message dispatch with concurrent transacted sends at cursor memory limit</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="gtully">Gary Tully</reporter>
                        <labels>
                            <label>dispatch</label>
                            <label>limit</label>
                            <label>message</label>
                            <label>missing</label>
                            <label>order</label>
                            <label>skipped</label>
                            <label>usecache</label>
                    </labels>
                <created>Thu, 25 Apr 2013 12:31:28 +0000</created>
                <updated>Tue, 9 Feb 2016 12:54:49 +0000</updated>
                            <resolved>Mon, 18 Nov 2013 15:32:56 +0000</resolved>
                                    <version>5.8.0</version>
                                    <fixVersion>5.9.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13641738" author="gtully" created="Thu, 25 Apr 2013 12:54:51 +0000"  >&lt;p&gt;fix in &lt;a href=&quot;http://svn.apache.org/r1475734&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1475734&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;idea is to have a beforeCompletion in a per destination sync that is called with the store index exclusive lock. This tracks the required cursor update oder. The first afterCompletion thread that is in order executes all pending updates in the correct order. Out of order completions queue their work or see it already complete. The batch update of pending work prevents further contention/race on the queue sendlock.&lt;br/&gt;
We may want to introduce blocking for an ordered execution slot if multiple sync after completions have strict ordered dependencies. For the moment in the broker, after completions are only  used for cursor updates.&lt;/p&gt;</comment>
                            <comment id="13747911" author="gtully" created="Thu, 22 Aug 2013 21:37:11 +0000"  >&lt;p&gt;The fix was reworked/improved for leveldb use case.&lt;/p&gt;</comment>
                            <comment id="13823599" author="gtully" created="Fri, 15 Nov 2013 12:31:28 +0000"  >&lt;p&gt;There are still some gremlins in here, seems to be contention between concurrent commits with composite dests and contention with non transactional work. &lt;/p&gt;</comment>
                            <comment id="13825403" author="gtully" created="Mon, 18 Nov 2013 15:32:56 +0000"  >&lt;p&gt;fix in &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/activemq/commit/511b60c6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/activemq/commit/511b60c6&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;non transactional work could interleave with ordered transactional work. that resulted in the cursor and index being out of sync and skipping a dispatch&lt;/p&gt;</comment>
                            <comment id="14116580" author="gtully" created="Sat, 30 Aug 2014 23:02:55 +0000"  >&lt;p&gt;further rework - jdbc store showed contention was not limited to transactions but to interleaving transactional and non transactional work. Contention between the cursor fill and store scan and for kahadb concurrentStoreAndDispatch - contention with async work queue.&lt;br/&gt;
Fix that introduces ordered interplay between store index and destination cursor update on a per message basis:&lt;br/&gt;
&lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=54e2e3be&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=54e2e3be&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12937851">AMQ-6164</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12482179">AMQ-2868</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12519938">AMQ-3470</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                            <outwardlinks description="requires">
                                        <issuelink>
            <issuekey id="12647495">AMQ-4535</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>324955</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 12 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1k2a7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325300</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>