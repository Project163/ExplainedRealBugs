<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:59:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-9721] Fix performance issues with non-persistent message removal from topic/durable subscriptions</title>
                <link>https://issues.apache.org/jira/browse/AMQ-9721</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;While testing various scenarios with expiration on subscriptions I noticed that when there is a large backlog of non-persistent messages the CPU usage would spike in some cases for removing messages. This only happened when non persistent messages were using the pending disk list and not in memory.&lt;/p&gt;

&lt;p&gt;After investigation, it turns out there are a couple of problems that need to be resolved.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;FilePendingMessageCursor flushes messages to disk when memory is full. The disk cursor uses a linked list as an index which has O&amp;#40;n) performance for random access. This is not an issue because the broker is going to append messages to the front/end and then page them in from the front for dispatch, expire, discard, etc. Except...it turns out in a couple spots the broker is actually incorrectly calling remove twice on the cursor for the same message. (Happens on discard for topic subs, also during expiration for durable subs). Usually when remove is called it finds the message pretty quickly as it was recently dispatched or paged in, except since it&apos;s called twice it iterates over the entire linked list for no reason and finds nothing. This causes a huge performance problem if there&apos;s a large backup (ie millions)&lt;/li&gt;
	&lt;li&gt;The second problem is specific to durable subscriptions. The durable sub cursor contains a list of cursors for its topic stores and also for it&apos;s non-persistent cursor. The problem is that when the expiration task runs and calls the remove method, it is being delegated to all cursors, including non persistent. So even though it will never find the message in the cursor if there&apos;s a huge non-persistent backlog it causes a lot of CPU usage to search. This can be fixed by checking the persistent type and only calling the right prefetches for remove, similar to how the add method works and how queue subscriptions work.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13619958">AMQ-9721</key>
            <summary>Fix performance issues with non-persistent message removal from topic/durable subscriptions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="cshannon">Christopher L. Shannon</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Jun 2025 16:22:10 +0000</created>
                <updated>Wed, 4 Jun 2025 13:04:31 +0000</updated>
                            <resolved>Wed, 4 Jun 2025 13:04:31 +0000</resolved>
                                    <version>6.1.6</version>
                    <version>5.18.7</version>
                                    <fixVersion>6.2.0</fixVersion>
                    <fixVersion>5.19.1</fixVersion>
                    <fixVersion>6.1.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17956095" author="jira-bot" created="Wed, 4 Jun 2025 12:26:37 +0000"  >&lt;p&gt;Commit 5a3abbc877bff6d73c2ab6cecec81d50dd18c839 in activemq&apos;s branch refs/heads/main from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=5a3abbc877&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=5a3abbc877&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9721&quot; title=&quot;Fix performance issues with non-persistent message removal from topic/durable subscriptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9721&quot;&gt;&lt;del&gt;AMQ-9721&lt;/del&gt;&lt;/a&gt; - Fix performance issues during non-persistent cursor removal (#1447)&lt;/p&gt;

&lt;p&gt;This fixes the broker so multiple removals are no longer done for the&lt;br/&gt;
same message leading to having to search the entire non persistent&lt;br/&gt;
pending list. Durable subscriptions now check the persistence type of&lt;br/&gt;
the message so the cursor will no longer search everything in a&lt;br/&gt;
non-persistent pending list when the message is persistent.&lt;/p&gt;</comment>
                            <comment id="17956098" author="jira-bot" created="Wed, 4 Jun 2025 12:35:36 +0000"  >&lt;p&gt;Commit ab99e5c41d2257ca8e41f3677c9375cb5613aa1b in activemq&apos;s branch refs/heads/activemq-6.1.x from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=ab99e5c41d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=ab99e5c41d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9721&quot; title=&quot;Fix performance issues with non-persistent message removal from topic/durable subscriptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9721&quot;&gt;&lt;del&gt;AMQ-9721&lt;/del&gt;&lt;/a&gt; - Fix performance issues during non-persistent cursor removal (#1447)&lt;/p&gt;

&lt;p&gt;This fixes the broker so multiple removals are no longer done for the&lt;br/&gt;
same message leading to having to search the entire non persistent&lt;br/&gt;
pending list. Durable subscriptions now check the persistence type of&lt;br/&gt;
the message so the cursor will no longer search everything in a&lt;br/&gt;
non-persistent pending list when the message is persistent.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 5a3abbc877bff6d73c2ab6cecec81d50dd18c839)&lt;/p&gt;</comment>
                            <comment id="17956107" author="jira-bot" created="Wed, 4 Jun 2025 13:04:29 +0000"  >&lt;p&gt;Commit cf19b850b78eaa7b14295df4262bf800fe82f1ad in activemq&apos;s branch refs/heads/activemq-5.19.x from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=cf19b850b7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=cf19b850b7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9721&quot; title=&quot;Fix performance issues with non-persistent message removal from topic/durable subscriptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9721&quot;&gt;&lt;del&gt;AMQ-9721&lt;/del&gt;&lt;/a&gt; - Fix performance issues during non-persistent cursor removal (#1447)&lt;/p&gt;

&lt;p&gt;This fixes the broker so multiple removals are no longer done for the&lt;br/&gt;
same message leading to having to search the entire non persistent&lt;br/&gt;
pending list. Durable subscriptions now check the persistence type of&lt;br/&gt;
the message so the cursor will no longer search everything in a&lt;br/&gt;
non-persistent pending list when the message is persistent.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 5a3abbc877bff6d73c2ab6cecec81d50dd18c839)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13617186">AMQ-9698</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            22 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1w620:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>