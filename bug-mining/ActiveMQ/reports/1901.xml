<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:59:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4413] Persistent message loss when JMS durable subscriber reconnects regardless of message store impl.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4413</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Persistent message is lost intermittently when JMS durable topic subscriber reconnects to the broker service.  From the log observation, it seems that the internal states of the store cursor (i.e. AbstractStoreCursor) is not well guarded by race condition between message sending/directly-dispatching-pending thread (from publisher) and subscription deactivating thread (from subscriber&apos;s closing), especially when subscriber&apos;s closing (javax.jms.MessageConsumer#close) and message publishing happen simultaneously.&lt;/p&gt;

&lt;p&gt;Observations and the test scenario are described at below in detail:&lt;br/&gt;
&lt;a href=&quot;http://activemq.2283324.n4.nabble.com/persistent-message-missing-to-a-durable-subscriber-when-it-reconnects-restarts-td4665130.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.2283324.n4.nabble.com/persistent-message-missing-to-a-durable-subscriber-when-it-reconnects-restarts-td4665130.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Attached please find Test.java that I used to verify this issue.  I found the issue initially with activemq-core-5.7.0.jar then confirmed that it&apos;s reproducible with other upper versions (i.e. apache-activemq-5.8-SNAPSHOT, apache-activemq-5.9-SNAPSHOT).&lt;/p&gt;

&lt;p&gt;This &quot;message loss&quot; issue is pretty critical as it can happen whenever durable subscriber reconnects either purposely or unexpectedly, and it could be violating the one of primitive features that messaging platform guarantees: &quot;no message loss&quot;,  if happens, whereas it&apos;s so easy to reproduce the trouble.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12639492">AMQ-4413</key>
            <summary>Persistent message loss when JMS durable subscriber reconnects regardless of message store impl.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="choijw1">Jaewoong Choi</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Mar 2013 00:04:26 +0000</created>
                <updated>Thu, 30 May 2013 09:16:10 +0000</updated>
                            <resolved>Wed, 15 May 2013 22:23:24 +0000</resolved>
                                    <version>5.7.0</version>
                    <version>5.8.0</version>
                                    <fixVersion>5.9.0</fixVersion>
                                    <component>Broker</component>
                    <component>JMS client</component>
                    <component>Message Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13615911" author="choijw1" created="Thu, 28 Mar 2013 00:09:12 +0000"  >&lt;p&gt;Compilation only requires activemq-core-5.7.0.jar or any corresponding dependency of upper versions (e.g. activemq-all-5.9-20130327.044852-30.jar from apache-activemq-5.9-SNAPSHOT.zip).&lt;/p&gt;</comment>
                            <comment id="13617330" author="ceposta" created="Fri, 29 Mar 2013 13:30:39 +0000"  >&lt;p&gt;Won&apos;t have time to get into this one right now, but updated the test case to be a unit test and ran it to make sure it failed (and it does). &lt;/p&gt;</comment>
                            <comment id="13653206" author="tabish121" created="Thu, 9 May 2013 21:07:45 +0000"  >&lt;p&gt;In the supplied test case the message loss is expect since persistence is not enabled and the option to keep durable subs active is not enabled.  If you enable keepDurableSubsActive it would work as expected.  What&apos;s the real configuration you use when you encounter this problem.  &lt;/p&gt;</comment>
                            <comment id="13653273" author="choijw1" created="Thu, 9 May 2013 21:53:04 +0000"  >&lt;p&gt;keepDurableSubsActive is enabled by default and it didn&apos;t changed in the test case.  Where/how do you see it&apos;s disabled?  Anyway, you&apos;ll see it won&apos;t help even with an explicit enablement of that option with the following line of code:&lt;/p&gt;

&lt;p&gt;brokerService.setKeepDurableSubsActive(true);&lt;/p&gt;</comment>
                            <comment id="13653286" author="tabish121" created="Thu, 9 May 2013 22:00:22 +0000"  >&lt;p&gt;You&apos;re right my bad, so many broker options to remember.  &lt;/p&gt;</comment>
                            <comment id="13653314" author="tabish121" created="Thu, 9 May 2013 22:18:30 +0000"  >&lt;p&gt;Further refined the test case so it actually fails if the expectations aren&apos;t met.  Also removed hard coded port 61616&lt;/p&gt;</comment>
                            <comment id="13657178" author="tabish121" created="Tue, 14 May 2013 16:25:16 +0000"  >&lt;p&gt;Updated test to make message seq numbers make the MessageId sequence for easier debug.  Turned off advisory messages to make logs less verbose.&lt;/p&gt;</comment>
                            <comment id="13657179" author="tabish121" created="Tue, 14 May 2013 16:25:55 +0000"  >&lt;p&gt;I think you can work around this by setting a lower prefetch limit, seems to be related and test passes always for me with a value of one. &lt;/p&gt;</comment>
                            <comment id="13657564" author="tabish121" created="Tue, 14 May 2013 21:56:10 +0000"  >&lt;p&gt;Have you ever reproduced this with persistence enabled using this test case?&lt;/p&gt;</comment>
                            <comment id="13658768" author="choijw1" created="Wed, 15 May 2013 20:34:47 +0000"  >&lt;p&gt;&amp;gt;&amp;gt; Have you ever reproduced this with persistence enabled using this test case?&lt;br/&gt;
Yes. I observed the bug with persistence enabled first, then tried &amp;amp; reproduced with persistence disabled (which uses memory-based persistent adapter) which means the trouble is unrelated to any specific message store implementation.&lt;/p&gt;</comment>
                            <comment id="13658777" author="tabish121" created="Wed, 15 May 2013 20:39:59 +0000"  >&lt;p&gt;If you can provide a test that reproduces with a store it would be more useful.&lt;/p&gt;</comment>
                            <comment id="13658802" author="choijw1" created="Wed, 15 May 2013 20:51:53 +0000"  >&lt;p&gt;Unfortunately it&apos;s not possible because the persistence adapter/store I tested with is a custom one outside the AMQ code base. FYI, it&apos;s Apache BookKeeper-based and can&apos;t be shared outside my company, yet.  The reason I tested with persistence option disabled is because of this reason: I needed to verify it&apos;s persistence-store independent problem.&lt;/p&gt;</comment>
                            <comment id="13658834" author="tabish121" created="Wed, 15 May 2013 21:18:06 +0000"  >&lt;p&gt;Ok.  I know why its happening and we are trying out a fix.  Have to ensure we don&apos;t break any other use cases though. &lt;/p&gt;</comment>
                            <comment id="13658893" author="tabish121" created="Wed, 15 May 2013 22:23:24 +0000"  >&lt;p&gt;Fixed on trunk, to workaround the issue you can set keepDurableSubsActive to false and you shouldn&apos;t see this.  &lt;/p&gt;</comment>
                            <comment id="13658994" author="choijw1" created="Wed, 15 May 2013 23:16:04 +0000"  >&lt;p&gt;Thanks for the fix.  Any impact to the persistence message consumption of durable subscribers by turning keepDurableSubsActive option off?&lt;/p&gt;</comment>
                            <comment id="13659414" author="gtully" created="Thu, 16 May 2013 10:19:01 +0000"  >&lt;p&gt;@Jaewoong - a reconnect does a little bit more work when keepDurableSubsActive=false but durability of messages is not effected. The messages were not actually lost, they were not dispatched. &lt;/p&gt;</comment>
                            <comment id="13670172" author="wangyin" created="Thu, 30 May 2013 09:16:10 +0000"  >&lt;p&gt;Can anyone ensure whether the issue also affects 5.5.0?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12576065" name="AMQ4413-testcase.patch" size="8544" author="ceposta" created="Fri, 29 Mar 2013 13:30:39 +0000"/>
                            <attachment id="12583149" name="AMQ4413Test.java" size="8689" author="tabish" created="Tue, 14 May 2013 16:25:16 +0000"/>
                            <attachment id="12582529" name="AMQ4413Test.java" size="8474" author="tabish" created="Thu, 9 May 2013 22:18:30 +0000"/>
                            <attachment id="12575802" name="Test.java" size="7240" author="choijw1" created="Thu, 28 Mar 2013 00:09:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>319961</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 25 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1j7gn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320302</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>