<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:38:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1956] NPE during broker shutdown when useDatabaseLock=&quot;false&quot;</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1956</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Steps:&lt;/p&gt;

&lt;p&gt;1. Create a broker with the persistence adapter set to not use database locking (useDatabaseLock=&quot;false&quot;)&lt;br/&gt;
2. Start broker&lt;br/&gt;
3. Stop broker (but keep the process running, as in a servlet container)&lt;/p&gt;

&lt;p&gt;Result:&lt;/p&gt;

&lt;p&gt;In the logs, I see the following error every 30 seconds:&lt;/p&gt;

&lt;p&gt;2008/09/25 15:23:55.506 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.activemq.store.jdbc.JDBCPersistenceAdapter&amp;#93;&lt;/span&gt; No longer able to keep the exclusive lock so giving up being a master&lt;br/&gt;
2008/09/25 15:23:55.506 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.activemq.store.jdbc.JDBCPersistenceAdapter&amp;#93;&lt;/span&gt; Failed to stop broker&lt;br/&gt;
2008/09/25 15:24:25.504 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.activemq.store.jdbc.DefaultDatabaseLocker&amp;#93;&lt;/span&gt; Failed to update database lock: java.lang.NullPointerException&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at org.apache.activemq.store.jdbc.DefaultDatabaseLocker.keepAlive(DefaultDatabaseLocker.java:102)&lt;br/&gt;
        at org.apache.activemq.store.jdbc.JDBCPersistenceAdapter.databaseLockKeepAlive(JDBCPersistenceAdapter.java:458)&lt;br/&gt;
        at org.apache.activemq.store.jdbc.JDBCPersistenceAdapter$3.run(JDBCPersistenceAdapter.java:260)&lt;br/&gt;
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:417)&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:280)&lt;br/&gt;
        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:135)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:65)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:142)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:166)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:613)&lt;/p&gt;


&lt;p&gt;Analysis:&lt;/p&gt;

&lt;p&gt;During startup, JDBCPersistenceAdapter only initializes the database locker if useDatabaseLock if true. This is done through lazy initialization by calling getDatabaseLocker (at ~ line 172):&lt;/p&gt;

&lt;p&gt;        if (isUseDatabaseLock()) {&lt;br/&gt;
            DatabaseLocker service = getDatabaseLocker();&lt;br/&gt;
            if (service == null) &lt;/p&gt;
{
                LOG.warn(&quot;No databaseLocker configured for the JDBC Persistence Adapter&quot;);
            }
&lt;p&gt; else &lt;/p&gt;
{
                service.start();
            }
&lt;p&gt;        }&lt;/p&gt;

&lt;p&gt;During shutdown, JDBCPersistenceAdapter calls getDatabaseLocker() to shut it down, but it does not check if isUseDatabaseLock() is true in this case:&lt;/p&gt;

&lt;p&gt;    public synchronized void stop() throws Exception {&lt;br/&gt;
        if (clockTicket != null) &lt;/p&gt;
{
            clockTicket.cancel(true);
            clockTicket = null;
        }
&lt;p&gt;        if (clockDaemon != null) &lt;/p&gt;
{
            clockDaemon.shutdown();
            clockDaemon = null;
        }
&lt;p&gt;        DatabaseLocker service = getDatabaseLocker();&lt;br/&gt;
        if (service != null) &lt;/p&gt;
{
            service.stop();
        }
&lt;p&gt;    }&lt;/p&gt;

&lt;p&gt;This actually causes database locker to be initialized and it subsequently lazy-initializes an executor to run a task which calls keepAlive(...). The executor threads are set as daemon threads which prevents this issue from showing up when the lifetime of the process is the same as the broker. When the broker is deployed in an app server which can outlive the broker then the above error is logged every 30 seconds.&lt;/p&gt;

&lt;p&gt;I&apos;m attaching one way to solve this problem without having to check everywhere if useDatabaseLock=&quot;false&quot;.&lt;/p&gt;

&lt;p&gt;Attached:&lt;/p&gt;

&lt;p&gt;BrokerStopFailure.java - sample program that reproduces this bug&lt;br/&gt;
NoLockerJDBCPersistenceAdapter.java - sample extension to JDBCPersistenceAdapter that fixes this bug&lt;/p&gt;</description>
                <environment></environment>
        <key id="12482357">AMQ-1956</key>
            <summary>NPE during broker shutdown when useDatabaseLock=&quot;false&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="cpettitt">Chris Pettitt</reporter>
                        <labels>
                    </labels>
                <created>Fri, 26 Sep 2008 17:37:04 +0000</created>
                <updated>Wed, 8 Oct 2008 08:49:55 +0000</updated>
                            <resolved>Thu, 2 Oct 2008 11:50:04 +0000</resolved>
                                    <version>5.1.0</version>
                                    <fixVersion>5.2.0</fixVersion>
                                    <component>Message Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12940279" author="gtully" created="Thu, 2 Oct 2008 11:50:04 +0000"  >&lt;p&gt;Committed revision 701088.&lt;/p&gt;

&lt;p&gt;thanks for the analysis Chris. Since the users of getDatabaseLocker already check for null i simply return null if a lock is not to be used.&lt;br/&gt;
note for future reference: ensure you check the &quot;grant ASF License&quot; check box when you submit a patch or enhancement, otherwise your contribution cannot be used. thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461220" name="ASF.LICENSE.NOT.GRANTED--BrokerStopFailure.java" size="1385" author="cpettitt" created="Fri, 26 Sep 2008 17:37:04 +0000"/>
                            <attachment id="12461111" name="ASF.LICENSE.NOT.GRANTED--NoLockerJDBCPersistenceAdapter.java" size="800" author="cpettitt" created="Fri, 26 Sep 2008 17:37:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>75157</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 8 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14blj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>233342</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>