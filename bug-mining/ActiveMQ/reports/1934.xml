<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:00:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4487] java.lang.OutOfMemoryError: Java heap space</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4487</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;When we browse a queue in webconsole we are getting java.lang.OutOfMemoryError: Java heap space. &lt;br/&gt;
Memory allocation -----&amp;gt; -Xms512m -Xmx3G&lt;/p&gt;

&lt;p&gt;When we try to click the queue to view the messages below error is occurring. We recently moved from 5.7 to 5.8 version. We dint face this issue in 5.7 version.&lt;/p&gt;

&lt;p&gt;Kindly help in fixing the issue.&lt;/p&gt;

&lt;p&gt;java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;
        at java.util.Arrays.copyOf(Arrays.java:2882)&lt;br/&gt;
        at java.io.CharArrayWriter.write(CharArrayWriter.java:88)&lt;br/&gt;
        at java.io.PrintWriter.write(PrintWriter.java:382)&lt;br/&gt;
        at com.opensymphony.module.sitemesh.filter.RoutablePrintWriter.write(RoutablePrintWriter.java:144)&lt;br/&gt;
        at org.apache.jasper.runtime.JspWriterImpl.flushBuffer(JspWriterImpl.java:181)&lt;br/&gt;
        at org.apache.jasper.runtime.JspWriterImpl.write(JspWriterImpl.java:449)&lt;br/&gt;
        at org.apache.jasper.runtime.JspWriterImpl.write(JspWriterImpl.java:462)&lt;br/&gt;
        at org.apache.jsp.browse_jsp$browse_jspHelper.invoke0(org.apache.jsp.browse_jsp:382)&lt;br/&gt;
        at org.apache.jsp.browse_jsp$browse_jspHelper.invoke(org.apache.jsp.browse_jsp:450)&lt;br/&gt;
        at org.apache.jsp.tag.web.jms.forEachMessage_tag.doTag(org.apache.jsp.tag.web.jms.forEachMessage_tag:89)&lt;br/&gt;
        at org.apache.jsp.browse_jsp._jspx_meth_jms_forEachMessage_0(org.apache.jsp.browse_jsp:170)&lt;br/&gt;
        at org.apache.jsp.browse_jsp._jspService(org.apache.jsp.browse_jsp:100)&lt;br/&gt;
        at org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:109)&lt;br/&gt;
        at javax.servlet.http.HttpServlet.service(HttpServlet.java:806)&lt;br/&gt;
        at org.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:389)&lt;br/&gt;
        at org.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:486)&lt;br/&gt;
        at org.apache.jasper.servlet.JspServlet.service(JspServlet.java:380)&lt;br/&gt;
        at javax.servlet.http.HttpServlet.service(HttpServlet.java:806)&lt;br/&gt;
        at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:652)&lt;br/&gt;
        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1329)&lt;br/&gt;
        at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:83)&lt;br/&gt;
        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:76)&lt;br/&gt;
        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1300)&lt;br/&gt;
        at org.apache.activemq.web.SessionFilter.doFilter(SessionFilter.java:45)&lt;br/&gt;
        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1300)&lt;br/&gt;
        at org.apache.activemq.web.filter.ApplicationContextFilter.doFilter(ApplicationContextFilter.java:102)&lt;br/&gt;
        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1300)&lt;br/&gt;
        at com.opensymphony.sitemesh.webapp.SiteMeshFilter.obtainContent(SiteMeshFilter.java:129)&lt;br/&gt;
        at com.opensymphony.sitemesh.webapp.SiteMeshFilter.doFilter(SiteMeshFilter.java:77)&lt;br/&gt;
        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1300)&lt;br/&gt;
        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:445)&lt;br/&gt;
        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137)&lt;/p&gt;


&lt;p&gt;Thank you.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Subathra.&lt;/p&gt;</description>
                <environment>&lt;p&gt;OS - Linux 2.6.18-238.el5 #1 SMP Sun Dec 19 14:22:44 EST 2010 x86_64 x86_64 x86_64 GNU/Linux&lt;br/&gt;
Activemq - 5.8&lt;/p&gt;</environment>
        <key id="12644624">AMQ-4487</key>
            <summary>java.lang.OutOfMemoryError: Java heap space</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="subathra1985">Subathra Jayaraman</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Apr 2013 16:16:06 +0000</created>
                <updated>Thu, 11 Jul 2013 16:24:20 +0000</updated>
                            <resolved>Wed, 5 Jun 2013 17:35:59 +0000</resolved>
                                    <version>5.8.0</version>
                                    <fixVersion>5.9.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13648272" author="subathra1985" created="Fri, 3 May 2013 08:56:00 +0000"  >&lt;p&gt;Hi, Please provide a fix for this issue.&lt;/p&gt;</comment>
                            <comment id="13648457" author="jerrinot" created="Fri, 3 May 2013 14:40:14 +0000"  >&lt;p&gt;Hi Subathra, could you provide a bit more information about the issue? Any idea how many messages is in the queue? What are the conditions to reproduce it?&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                            <comment id="13648467" author="subathra1985" created="Fri, 3 May 2013 14:46:22 +0000"  >&lt;p&gt;Hi Jaromir,&lt;/p&gt;

&lt;p&gt;We are not able to browse the queues if the messages are near to 100.&lt;/p&gt;

&lt;p&gt;When we click a queue with more than 100 messages in it, we end up in java heap space error.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Subathra.&lt;/p&gt;</comment>
                            <comment id="13651802" author="subathra1985" created="Wed, 8 May 2013 11:29:36 +0000"  >&lt;p&gt;Hi; Another thread same problem: &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4372&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-4372&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="13651803" author="subathra1985" created="Wed, 8 May 2013 11:32:03 +0000"  >&lt;p&gt;Has anyone managed to look into this please? We have had to upgrade to active mq 5.8 due to the persistent DB locking problem with lease time with 5.7. After upgrading to 5.8, the DB locking issue was resolved, however, this problem of not being able to browse messages more than 99 in queue is causing a huge problem for us, anyone? Please assist....&lt;/p&gt;</comment>
                            <comment id="13651821" author="subathra1985" created="Wed, 8 May 2013 12:01:54 +0000"  >&lt;p&gt;Does not happen on 5.7. Tested on 1.6 and 1.7 JDK.&lt;/p&gt;

&lt;p&gt;If you click on &apos;active consumers&apos; in the console when this is happening, you can see an enormous amount of enqueue and dequeues from the MQ host itself which seems to eat the box.&lt;/p&gt;

&lt;p&gt;A few more details on our setup;&lt;/p&gt;

&lt;p&gt;ActiveMQ 5.8.0, Running on Java 1.6.x&lt;br/&gt;
Backend Storage is Multi-Master Percona 5.5.x&lt;/p&gt;</comment>
                            <comment id="13658212" author="subathra1985" created="Wed, 15 May 2013 10:08:44 +0000"  >&lt;p&gt;Can you please provide us an update on this issue.&lt;/p&gt;</comment>
                            <comment id="13658461" author="ceposta" created="Wed, 15 May 2013 15:31:33 +0000"  >&lt;p&gt;What&apos;s the size of your messages?&lt;br/&gt;
Have you tried on a 5.9 SNAPSHOT?&lt;/p&gt;
</comment>
                            <comment id="13662298" author="ilia_stepanov" created="Mon, 20 May 2013 19:18:55 +0000"  >&lt;p&gt;I have same issue with 5.8.0. I checked the heap dump and debugged the web console, hope this will help to fix it. Please provide an update.&lt;/p&gt;

&lt;p&gt;In the heap dump I found an instance of VMPendingMessageCursor holding 18+ millions of PendingNode elements (the queue had actually just two hundreds message). &lt;/p&gt;

&lt;p&gt;I did debugging - the method Queue.iterate() is repeated in an endless loop.&lt;/p&gt;

&lt;p&gt;In first run it adds 200 messages to the browser. The second run should normally add no new messages and remove the browserDispatch from the browserDispatches. However this does not happen &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the if (!node.isAcked() &amp;amp;&amp;amp; !browser.getPending().getMessageAudit().isDuplicate(node.getMessageId()))  returns true again and messages are added again.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The third run adds messages again and so on. Messages are added until OOM occurs.&lt;br/&gt;
I found it strange that method ActiveMQMessageAuditNoSync.isDuplicate() returns false in the second iteration and checked it. &lt;/p&gt;

&lt;p&gt;    public boolean isDuplicate(final MessageId id) {&lt;br/&gt;
        boolean answer = false;&lt;/p&gt;

&lt;p&gt;        if (id != null) {&lt;br/&gt;
            ProducerId pid = id.getProducerId();&lt;br/&gt;
            if (pid != null) {&lt;br/&gt;
                BitArrayBin bab = map.get(pid);  &amp;lt;&amp;lt; here the bab is null in the second iteration. why? it should been added in the first iteration&lt;br/&gt;
                if (bab == null) &lt;/p&gt;
{
                    bab = new BitArrayBin(auditDepth);
                    map.put(pid, bab);           &amp;lt;&amp;lt; here new entry is added to the map, but the size of keySet() is NOT increased!
                    modified = true;             &amp;lt;&amp;lt; here  map.get(pid) returns a coorect value in the debugger. 
						 &amp;lt;&amp;lt; However in the next iteration it returns null again...
                }
&lt;p&gt;                answer = bab.setBit(id.getProducerSequenceId(), true);&lt;br/&gt;
            }&lt;br/&gt;
        }&lt;br/&gt;
        return answer;&lt;br/&gt;
    }&lt;br/&gt;
It looks like a collision in the map. Does ProducerId comes with a proper hashCode() and equals() methods? &lt;/p&gt;
</comment>
                            <comment id="13662300" author="tabish121" created="Mon, 20 May 2013 19:20:53 +0000"  >&lt;p&gt;Create a unit test that can reproduce the issue if possible. &lt;/p&gt;</comment>
                            <comment id="13671566" author="ilia_stepanov" created="Fri, 31 May 2013 15:20:13 +0000"  >&lt;p&gt;Hello,&lt;br/&gt;
The issue is caused by too high number of different producers (&amp;gt;64). When the number of producers exceeds 64, it is not possible to use QueueBrowser for this queue.&lt;/p&gt;

&lt;p&gt;Two problems cause the issue.&lt;br/&gt;
1. ActiveMQMessageAuditNoSync has a default max number of producers of 64. (field maximumNumberOfProducersToTrack)&lt;br/&gt;
When the actual number of producers exceeds this value, the isDuplicate() does not work anymore correctly and sometimes returns false instead of true. This leads to infinite loop in Queue.iterate method and thus to an out-of-memory situation. &lt;br/&gt;
Ideally Queue.iterate() should recognize that the audit class does not work correctly and fail. For example the ActiveMQMessageAuditNoSync.isDuplicate can throw an exception if map is full.&lt;/p&gt;

&lt;p&gt;2. It is not possible to increase the default max value via PolicyEntry. The PolicyEntry&apos;s configure() method does not populate MaxProducersToAudit to PrefetchSubscription ( sub.setMaxProducersToAudit(getMaxProducersToAudit()); is missing)&lt;br/&gt;
The PrefetchSubscription also does not populate the value to the underlying PendingMessageCursor .&lt;br/&gt;
     public void setMaxProducersToAudit(int maxProducersToAudit) {&lt;br/&gt;
         this.maxProducersToAudit = maxProducersToAudit;&lt;br/&gt;
+        if (pending!=null) &lt;/p&gt;
{
+               pending.setMaxProducersToAudit(maxProducersToAudit);
+        }
&lt;p&gt;     }&lt;/p&gt;

&lt;p&gt;How can I create a unit test for the second issue?&lt;/p&gt;

&lt;p&gt;regards,&lt;br/&gt;
ilya&lt;/p&gt;
</comment>
                            <comment id="13671623" author="guim78" created="Fri, 31 May 2013 16:26:53 +0000"  >&lt;p&gt;Simple reproducer (however, I am not sure it happens every time).&lt;br/&gt;
1/ I used default server config, except changing producerFlowControl to false&lt;br/&gt;
2/ I used activemq 5.3.2 tool to send 100k messages (used JMX to check number of messages)&lt;br/&gt;
java -classpath activemq-all-5.3.2.jar org.apache.activemq.benchmark.Producer tcp://localhost:61616 false TEST.FOO false 1&lt;br/&gt;
3/ I used activemq 5.3.2 tool to dequeue messages, still 9k messages in the queue (used JMX to check number of messages)&lt;br/&gt;
4/ I used the code below to browse messages - it slowed down over time with the jvm keeping doing full GC&lt;br/&gt;
I stopped after 100k iterations, on a queue with 9k messages...&lt;/p&gt;

&lt;p&gt;import java.util.Date;&lt;br/&gt;
import java.util.Enumeration;&lt;/p&gt;

&lt;p&gt;import javax.jms.Connection;&lt;br/&gt;
import javax.jms.ConnectionFactory;&lt;br/&gt;
import javax.jms.JMSException;&lt;br/&gt;
import javax.jms.Message;&lt;br/&gt;
import javax.jms.Queue;&lt;br/&gt;
import javax.jms.QueueBrowser;&lt;br/&gt;
import javax.jms.Session;&lt;/p&gt;

&lt;p&gt;import org.apache.activemq.ActiveMQConnectionFactory;&lt;br/&gt;
import org.apache.activemq.command.ActiveMQQueue;&lt;/p&gt;

&lt;p&gt;public class QBrowse {&lt;br/&gt;
	ConnectionFactory connectionFactory;&lt;br/&gt;
	Connection connection;&lt;br/&gt;
	Session session;&lt;/p&gt;

&lt;p&gt;	static public void main(String[] parms) throws JMSException &lt;/p&gt;
{
		QBrowse qb = new QBrowse();
		qb.initCli();
		qb.oldestMsgInQueue(&quot;BENCHMARK.FEED0&quot;);
		qb.endCli();
	}

&lt;p&gt;	public void initCli() throws JMSException &lt;/p&gt;
{
		connectionFactory = new ActiveMQConnectionFactory(&quot;tcp://localhost:61616&quot;);
		connection = connectionFactory.createConnection();
		connection.start();
		session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);
	}

&lt;p&gt;	public void endCli() throws JMSException &lt;/p&gt;
{
		session.close();
		connection.close();
	}


&lt;p&gt;	public void oldestMsgInQueue(String qname) throws JMSException{&lt;br/&gt;
		Queue q1= new ActiveMQQueue(qname );&lt;br/&gt;
		QueueBrowser br = session.createBrowser(q1,null);&lt;br/&gt;
		int iter = 0;&lt;br/&gt;
		Enumeration e = br.getEnumeration();&lt;br/&gt;
		while(e.hasMoreElements())&lt;/p&gt;
{
			if((iter % 1000) == 0)
				System.out.println(iter);
			iter = iter+1;
			Message m = (Message) e.nextElement();
		}
&lt;p&gt;		br.close();&lt;br/&gt;
		}&lt;br/&gt;
}&lt;/p&gt;</comment>
                            <comment id="13671629" author="guim78" created="Fri, 31 May 2013 16:33:51 +0000"  >&lt;p&gt;Please also note that while browsing the queue, cpu went very high mainly comparing a message id with all the message ids from the OrderedPendingList (method org.apache.activemq.broker.region.cursors.OrderedPendingList.contains(..))&lt;/p&gt;

&lt;p&gt;I have not read the whole server code, so I may be wrong, still:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I do not see the relationship between the pending status of a message and the message browsing work&lt;/li&gt;
	&lt;li&gt;while not having read all the code in detail (I may be wrong), I got huge performance improvments by rewriting the method:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;  public boolean contains(MessageReference message)&lt;br/&gt;
  {&lt;br/&gt;
    if (message != null)&lt;br/&gt;
    	return map.containsKey(message.getMessageId());    	&lt;br/&gt;
    return false;&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;(but I still had that infinite loop and memory spike)&lt;/p&gt;</comment>
                            <comment id="13671630" author="tabish121" created="Fri, 31 May 2013 16:38:59 +0000"  >&lt;p&gt;activemq-unit-tests/src/test/java/org.apache.activemq.usecases.QueueBrowsingTest could be a good place to start if you want to try to and help by creating a real JUnit test case. &lt;/p&gt;</comment>
                            <comment id="13673129" author="ilia_stepanov" created="Mon, 3 Jun 2013 14:05:04 +0000"  >&lt;p&gt;Please use following test case to reproduce the problem. The test case illustrates two problems: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;it is not possible to use Web Console (and QueueBrowser) if a queue contains messages from more then &lt;b&gt;64&lt;/b&gt; producers. The enumeration gives endless number of messages in the queue which causes out of memory in case of the Web Console.&lt;/li&gt;
	&lt;li&gt;it is not possible to increase this threshold of 64 via PolicyEntry (the value does not get propagated properly to ActiveMQMessageAuditNoSync class). Check my comment 31/May/13 16:20 for a possible fix.&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;package org.apache.activemq.bugs;&lt;/p&gt;

&lt;p&gt;import static org.junit.Assert.assertEquals;&lt;/p&gt;

&lt;p&gt;import java.net.URI;&lt;br/&gt;
import java.util.Enumeration;&lt;/p&gt;

&lt;p&gt;import javax.jms.Connection;&lt;br/&gt;
import javax.jms.JMSException;&lt;br/&gt;
import javax.jms.Message;&lt;br/&gt;
import javax.jms.MessageProducer;&lt;br/&gt;
import javax.jms.QueueBrowser;&lt;br/&gt;
import javax.jms.Session;&lt;/p&gt;

&lt;p&gt;import org.apache.activemq.ActiveMQConnectionFactory;&lt;br/&gt;
import org.apache.activemq.broker.BrokerService;&lt;br/&gt;
import org.apache.activemq.broker.TransportConnector;&lt;br/&gt;
import org.apache.activemq.broker.region.policy.PolicyEntry;&lt;br/&gt;
import org.apache.activemq.broker.region.policy.PolicyMap;&lt;br/&gt;
import org.apache.activemq.command.ActiveMQQueue;&lt;br/&gt;
import org.junit.After;&lt;br/&gt;
import org.junit.Before;&lt;br/&gt;
import org.junit.Test;&lt;br/&gt;
import org.slf4j.Logger;&lt;br/&gt;
import org.slf4j.LoggerFactory;&lt;/p&gt;

&lt;p&gt;/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@author Ilya Stepanov&lt;br/&gt;
 */&lt;br/&gt;
public class AMQ4487Test {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;	private static final Logger LOG = LoggerFactory&lt;br/&gt;
			.getLogger(AMQ4487Test.class);&lt;/p&gt;

&lt;p&gt;	private BrokerService broker;&lt;br/&gt;
	private URI connectUri;&lt;br/&gt;
	private ActiveMQConnectionFactory factory;&lt;/p&gt;

&lt;p&gt;	@Before&lt;br/&gt;
	public void startBroker() throws Exception &lt;/p&gt;
{
		broker = new BrokerService();
		TransportConnector connector = broker.addConnector(&quot;tcp://0.0.0.0:0&quot;);
		broker.deleteAllMessages();
		broker.start();
		broker.waitUntilStarted();
		connectUri = connector.getConnectUri();
		factory = new ActiveMQConnectionFactory(connectUri);
	}

&lt;p&gt;	@After&lt;br/&gt;
	public void stopBroker() throws Exception &lt;/p&gt;
{
		broker.stop();
		broker.waitUntilStopped();
	}

&lt;p&gt;	@Test&lt;br/&gt;
	public void testBrowsing() throws JMSException {&lt;/p&gt;

&lt;p&gt;		PolicyEntry policy = new PolicyEntry();&lt;br/&gt;
		policy.setQueue(&quot;&amp;gt;&quot;);&lt;br/&gt;
		policy.setMaxProducersToAudit(400);&lt;br/&gt;
		PolicyMap pMap = new PolicyMap();&lt;br/&gt;
		pMap.setDefaultEntry(policy);&lt;br/&gt;
		broker.setDestinationPolicy(pMap);&lt;/p&gt;

&lt;p&gt;		int messageToSend = 370;&lt;/p&gt;

&lt;p&gt;		ActiveMQQueue queue = new ActiveMQQueue(&quot;TEST&quot;);&lt;br/&gt;
		Connection connection = factory.createConnection();&lt;br/&gt;
		connection.start();&lt;br/&gt;
		Session session = connection.createSession(false,&lt;br/&gt;
				Session.AUTO_ACKNOWLEDGE);&lt;/p&gt;

&lt;p&gt;		String data = &quot;&quot;;&lt;br/&gt;
		for (int i = 0; i &amp;lt; 1024 * 2; i++) &lt;/p&gt;
{
			data += &quot;x&quot;;
		}

&lt;p&gt;		for (int i = 0; i &amp;lt; messageToSend; i++) &lt;/p&gt;
{
			Connection msg_connection = factory.createConnection();
			msg_connection.start();
			Session msg_session = msg_connection.createSession(false,
					Session.AUTO_ACKNOWLEDGE);
			MessageProducer msg_producer = msg_session.createProducer(queue);
			msg_producer.send(msg_session.createTextMessage(data));
		}

&lt;p&gt;		QueueBrowser browser = session.createBrowser(queue);&lt;br/&gt;
		Enumeration enumeration = browser.getEnumeration();&lt;br/&gt;
		int received = 0;&lt;br/&gt;
		while (enumeration.hasMoreElements()) &lt;/p&gt;
{
			Message m = (Message) enumeration.nextElement();
			received++;
			if (received &amp;gt; messageToSend)
				break;
		}

&lt;p&gt;		browser.close();&lt;/p&gt;

&lt;p&gt;		assertEquals(messageToSend, received);&lt;br/&gt;
	}&lt;/p&gt;

&lt;p&gt;}&lt;/p&gt;





</comment>
                            <comment id="13673328" author="tabish121" created="Mon, 3 Jun 2013 17:15:36 +0000"  >&lt;p&gt;Expanded the test case a bit, will look into it and get it fixed in v5.9.0&lt;/p&gt;</comment>
                            <comment id="13673581" author="tabish121" created="Mon, 3 Jun 2013 21:14:07 +0000"  >&lt;p&gt;I&apos;ve submitted the fix that allows for maxProducersToAudit to be configured which can help to work around the underlying issue.  We will still look for a better solution here though since we can&apos;t expect everyone to know how many producers they will have.  &lt;/p&gt;</comment>
                            <comment id="13676154" author="tabish121" created="Wed, 5 Jun 2013 17:35:59 +0000"  >&lt;p&gt;Fixed on trunk, use the next v5.9.0 SNAPSHOT to test.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12654150">AMQ-4595</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="12637024">AMQ-4372</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12585896" name="AMQ4487Test.java" size="4512" author="tabish" created="Mon, 3 Jun 2013 17:15:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>324989</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 24 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1k2hr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325334</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>