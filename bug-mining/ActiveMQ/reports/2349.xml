<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:05:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5220] Advisory messages are still empty when received with a Stomp subscription</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5220</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;The subject of this task similiar as &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2098&quot; title=&quot;Advisory messages are empty when received with a Stomp subscription&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2098&quot;&gt;&lt;del&gt;AMQ-2098&lt;/del&gt;&lt;/a&gt;. Bug still exists, and it can be reproduced according to steps below.&lt;/p&gt;

&lt;p&gt;This simple script written in PHP uses standard Stomp client&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$stomp       = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; \Stomp(&lt;span class=&quot;code-quote&quot;&gt;&apos;tcp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:61613&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;admin&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;admin&apos;&lt;/span&gt;);
&lt;/span&gt;$stomp-&amp;gt;subscribe(&lt;span class=&quot;code-quote&quot;&gt;&apos;/topic/stats&apos;&lt;/span&gt;);

$stomp-&amp;gt;begin($transaction = microtime(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;));
$status = $stomp-&amp;gt;send(&lt;span class=&quot;code-quote&quot;&gt;&apos;/queue/ActiveMQ.Statistics.Destination.testqueue&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;&apos;, Array(&apos;&lt;/span&gt;reply-to&lt;span class=&quot;code-quote&quot;&gt;&apos; =&amp;gt; &apos;&lt;/span&gt;/topic/stats&lt;span class=&quot;code-quote&quot;&gt;&apos;, &apos;&lt;/span&gt;persistent&lt;span class=&quot;code-quote&quot;&gt;&apos; =&amp;gt; &apos;&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;));

$message = $stomp-&amp;gt;readFrame();
$stomp-&amp;gt;ack($message-&amp;gt;headers[&lt;span class=&quot;code-quote&quot;&gt;&apos;message-id&apos;&lt;/span&gt;]);
$stomp-&amp;gt;commit($transaction);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And in $message we&apos;ll have empty body paramter. It&apos;s because ActiveMQ returned message without body that&apos;s show in a captured packets between ActiveMQ and PHP communication below&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;T 127.0.0.1:53988 -&amp;gt; 127.0.0.1:61613 [AP]
CONNECT
login:admin
passcode:admin

T 127.0.0.1:53988 -&amp;gt; 127.0.0.1:61613 [AP]
.

T 127.0.0.1:61613 -&amp;gt; 127.0.0.1:53988 [AP]
CONNECTED
heart-beat:0,0
session:ID:amneziac-59996-1402320672417-5:8
server:ActiveMQ/5.9.1
version:1.0
.

T 127.0.0.1:53988 -&amp;gt; 127.0.0.1:61613 [AP]
SUBSCRIBE
ack:client
destination:/topic/stats
activemq.prefetchSize:1

T 127.0.0.1:53988 -&amp;gt; 127.0.0.1:61613 [AP]
.

T 127.0.0.1:53988 -&amp;gt; 127.0.0.1:61613 [AP]
BEGIN
transaction:1402321825.9952

T 127.0.0.1:53988 -&amp;gt; 127.0.0.1:61613 [AP]
.

T 127.0.0.1:53988 -&amp;gt; 127.0.0.1:61613 [AP]
SEND
reply-to:/topic/stats
persistent:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
destination:/queue/ActiveMQ.Statistics.Destination.testqueue

T 127.0.0.1:53988 -&amp;gt; 127.0.0.1:61613 [AP]
.

T 127.0.0.1:61613 -&amp;gt; 127.0.0.1:53988 [AP]
MESSAGE
message-id:ID:amneziac-59996-1402320672417-2:1:0:0:8
type:Advisory
destination:/topic/stats
timestamp:1402321826311
expires:0
priority:4
.

T 127.0.0.1:53988 -&amp;gt; 127.0.0.1:61613 [AP]
ACK
message-id:ID:amneziac-59996-1402320672417-2:1:0:0:8

T 127.0.0.1:53988 -&amp;gt; 127.0.0.1:61613 [AP]
.

T 127.0.0.1:53988 -&amp;gt; 127.0.0.1:61613 [AP]
COMMIT
transaction:1402321825.9952

T 127.0.0.1:53988 -&amp;gt; 127.0.0.1:61613 [AFP]
.
DISCONNECT
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;ActiveMQ 5.9.1, Sun Java 1.7.0_51, Ubuntu Linux&lt;/p&gt;</environment>
        <key id="12720308">AMQ-5220</key>
            <summary>Advisory messages are still empty when received with a Stomp subscription</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="vchampion">Vladislav Krakhalev</reporter>
                        <labels>
                    </labels>
                <created>Tue, 10 Jun 2014 09:31:24 +0000</created>
                <updated>Thu, 18 Dec 2014 00:24:04 +0000</updated>
                            <resolved>Thu, 7 Aug 2014 18:20:02 +0000</resolved>
                                    <version>5.x</version>
                                    <fixVersion>5.10.1</fixVersion>
                    <fixVersion>5.11.0</fixVersion>
                                    <component>Transport</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14031097" author="tabish121" created="Fri, 13 Jun 2014 20:10:11 +0000"  >&lt;p&gt;Try creating a new unit test in activemq-stomp that demonstrates your issue.  &lt;/p&gt;</comment>
                            <comment id="14040601" author="vchampion" created="Mon, 23 Jun 2014 10:26:49 +0000"  >&lt;p&gt;I&apos;m sorry, but now I haven&apos;t enough time to make unit test in java.. because I&apos;m not java programmist. Can anybody make this test? &lt;br/&gt;
May be I will make it later when I learn java basics and unit test creation. &lt;/p&gt;

&lt;p&gt;For my task I replaced usage of STOMP request by reading information from xml information page of Active MQ.&lt;/p&gt;</comment>
                            <comment id="14087544" author="nannou9" created="Wed, 6 Aug 2014 11:04:14 +0000"  >&lt;p&gt;I have quickly written some messy unit test for this scenario.&lt;/p&gt;

&lt;p&gt;Same stats message consumed from topic by TCP connector is ok while the one received by STOMP is 0- length.&lt;/p&gt;

&lt;p&gt;So I can confirm that it is some stomp related problem.&lt;/p&gt;

&lt;p&gt;Will try to look core of this issue.&lt;/p&gt;</comment>
                            <comment id="14087616" author="vchampion" created="Wed, 6 Aug 2014 12:51:13 +0000"  >&lt;p&gt;Thank you Piotr! May be you create task with unit test in activemeq-stomp as Timothy suggested?&lt;/p&gt;</comment>
                            <comment id="14087659" author="nannou9" created="Wed, 6 Aug 2014 13:30:11 +0000"  >&lt;p&gt;Yes, sure.&lt;br/&gt;
But just was curious what was the reason.&lt;br/&gt;
So the problem is combination of 2 reasons:&lt;br/&gt;
1. Stomp ProtocolConverter expects the stomp client to directly subscribe advisory addresses. So it will work when subscribing topic is prefixed with &quot;ActiveMQ.Advisory.&quot;&lt;br/&gt;
2. Statistics plugin is kind of unique advisory system, as instead if directly subscribing advisory topic, you need to send a message with reply-to header. So when reply-to header and your reply topic has a name without &quot;ActiveMQ.Advisory.&quot; prefix, then it fails as translator finder is assuming that destination (or rather source) is not and advisory one. It simply ueses wrong frame translator. It thinks that it is a byte or string message while it is map message.&lt;/p&gt;

&lt;p&gt;So this method is source of this issue:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; FrameTranslator findTranslator(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; header, ActiveMQDestination destination) {
        FrameTranslator translator = frameTranslator;
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (header != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                translator = (FrameTranslator) FRAME_TRANSLATOR_FINDER
                        .newInstance(header);
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (destination != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; AdvisorySupport.isAdvisoryTopic(destination)) {
                    translator = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JmsFrameTranslator();
                }
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception ignore) {
            &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; anything goes wrong use the &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; translator
&lt;/span&gt;        }

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (translator &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; BrokerContextAware) {
            ((BrokerContextAware)translator).setBrokerContext(brokerContext);
        }

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; translator;
    }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So I will try to prepare both: unit test and fix for this problem.&lt;/p&gt;

&lt;p&gt;Greetings&lt;br/&gt;
Piotr Klimczak&lt;/p&gt;</comment>
                            <comment id="14087878" author="nannou9" created="Wed, 6 Aug 2014 16:38:18 +0000"  >&lt;p&gt;Problem fixed, Test written.&lt;br/&gt;
All working.&lt;br/&gt;
Regression test passed for STOMP.&lt;br/&gt;
Also fixed some NPE hell in JmsFrameTranslator.&lt;/p&gt;

&lt;p&gt;Code submitted to my forked repo: &lt;a href=&quot;https://github.com/PiotrKlimczak/activemq/commit/d294ba0c095d8f3116e4b2c03bc35bf8251e381a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/PiotrKlimczak/activemq/commit/d294ba0c095d8f3116e4b2c03bc35bf8251e381a&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;All we need now is to push it to trunk.&lt;/p&gt;

&lt;p&gt;Patch submitted on behalf of WM Promus by Piotr Klimczak&lt;/p&gt;</comment>
                            <comment id="14087902" author="githubbot" created="Wed, 6 Aug 2014 17:01:39 +0000"  >&lt;p&gt;GitHub user PiotrKlimczak opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/41&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/41&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5220&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5220&lt;/a&gt; Empty body for Statistics&lt;/p&gt;

&lt;p&gt;    Advisory Messages when using STOMP protocol&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/PiotrKlimczak/activemq&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/PiotrKlimczak/activemq&lt;/a&gt; trunk-5220&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/41.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/41.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #41&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 5a616e1b581c3a2942d63424b10891a7c5066137&lt;br/&gt;
Author: PiotrKlimczak &amp;lt;nannou9@gmail.com&amp;gt;&lt;br/&gt;
Date:   2014-08-06T16:30:26Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5220&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5220&lt;/a&gt; Empty body for Statistics&lt;br/&gt;
    Advisory Messages when using STOMP protocol&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14089558" author="tabish121" created="Thu, 7 Aug 2014 18:20:02 +0000"  >&lt;p&gt;Thanks for the patch, applied it with some additional cleanups and tweaks. &lt;/p&gt;</comment>
                            <comment id="14089559" author="githubbot" created="Thu, 7 Aug 2014 18:20:53 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/41&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/41&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12482906">AMQ-2098</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>398507</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1wlw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>398632</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>