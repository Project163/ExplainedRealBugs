<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:45:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2696] DefaultJDBCAdapter returns incorrect value that prevents ActiveMQ from starting.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2696</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;org.apache.activemq.store.jdbcJDBCPersistenceAdapter.getLastMessageBrokerSequenceId() calls:&lt;/p&gt;

&lt;p&gt;org.apache.activemq.store.jdbc.adapter.DefaultJDBCAdapter:&lt;/p&gt;

&lt;p&gt;The call to doGetLastMessageStoreSequenceId will return the max acks table id if the max msgs id is less.&lt;/p&gt;

&lt;p&gt;The result is used to seed the sequenceGenerator:&lt;/p&gt;

&lt;p&gt;long seq =  getAdapter().doGetLastMessageStoreSequenceId(c);&lt;br/&gt;
sequenceGenerator.setLastSequenceId(seq);&lt;/p&gt;

&lt;p&gt;However the next call to set the brokerSeq variable will fail if the seq variable has been seeded with the max acks id, as &apos;doGetMessageById&apos; expects a valid msgs id.&lt;/p&gt;

&lt;p&gt;long brokerSeq = 0;&lt;br/&gt;
            if (seq != 0) &lt;/p&gt;
{
            	Message last = (Message)wireFormat.unmarshal(new ByteSequence(getAdapter().doGetMessageById(c, seq)));
            	brokerSeq = last.getMessageId().getBrokerSequenceId();
            }
&lt;p&gt;            return brokerSeq;&lt;/p&gt;

&lt;p&gt;If &apos;seq&apos; is not a valid msgs id (I presume because the message has expired and/or been removed) then this causes a NullPointerException in ByteSequence, which is not caught, and this leads to a complete failure to start ActiveMQ.&lt;/p&gt;

&lt;p&gt;The solution is not simple if the tables are in production, and is compounded even further by durable subscribers that cannot simply be deleted from the acks table.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Vista 64bit&lt;/p&gt;</environment>
        <key id="12483433">AMQ-2696</key>
            <summary>DefaultJDBCAdapter returns incorrect value that prevents ActiveMQ from starting.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="andyg">Andy Gumbrecht</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Apr 2010 12:29:32 +0000</created>
                <updated>Tue, 17 May 2011 21:29:18 +0000</updated>
                            <resolved>Thu, 15 Apr 2010 13:56:52 +0000</resolved>
                                    <version>5.3.1</version>
                                    <fixVersion>5.4.0</fixVersion>
                                    <component>Message Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12942407" author="andyg" created="Thu, 15 Apr 2010 06:33:46 +0000"  >&lt;p&gt;Also in trunk&lt;/p&gt;</comment>
                            <comment id="12942398" author="dejanb" created="Thu, 15 Apr 2010 08:42:40 +0000"  >&lt;p&gt;Hi Andy,&lt;/p&gt;

&lt;p&gt;just wondering if you can create a test case that can reproduce the issue? Or this is something you encountered in production?&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Dejan&lt;/p&gt;</comment>
                            <comment id="12942410" author="andyg" created="Thu, 15 Apr 2010 12:18:56 +0000"  >&lt;p&gt;Hi Dejan,&lt;/p&gt;

&lt;p&gt;It&apos;s going to be difficult to create a test case, but is easy to reproduce if you have any JDBC adapter configured.&lt;/p&gt;

&lt;p&gt;&amp;lt;persistenceAdapter&amp;gt;&lt;br/&gt;
&amp;lt;jdbcPersistenceAdapter dataSource=&quot;#postgresql-activemq-ds&quot;&amp;gt;&lt;br/&gt;
&amp;lt;adapter&amp;gt;&lt;br/&gt;
&amp;lt;postgresql-jdbc-adapter/&amp;gt;&lt;br/&gt;
&amp;lt;/adapter&amp;gt;&lt;br/&gt;
&amp;lt;/jdbcPersistenceAdapter&amp;gt;&lt;br/&gt;
&amp;lt;/persistenceAdapter&amp;gt;&lt;/p&gt;

&lt;p&gt;Just change the DataSource database to an empty test database and let ActiveMQ create new empty tables.&lt;/p&gt;

&lt;p&gt;Stop ActiveMQ.&lt;/p&gt;

&lt;p&gt;Manually add one dummy row to the empty &apos;activemq_acks&apos; table:&lt;/p&gt;

&lt;p&gt;INSERT INTO activemq_acks(container, sub_dest, client_id, sub_name, selector, last_acked_id) VALUES (&apos;topic://a&apos;, &apos;topic://a&apos;, &apos;a&apos;, &apos;a&apos;, &apos;a&apos;, 555);&lt;/p&gt;

&lt;p&gt;Start ActiveMQ.&lt;/p&gt;

&lt;p&gt;It will try to load message id 555 - which does not exist, and will drop a NullPointerException.&lt;/p&gt;

&lt;p&gt;The code in doGetLastMessageStoreSequenceId uses Math.max(seq1, seq2) to determine the next sequence id, so this is then definitely not safe to use in getLastMessageBrokerSequenceId() to load a message by id.&lt;/p&gt;

&lt;p&gt;I suppose a test case using something like Derby could be created - without looking, is Derby on the default test classpath?&lt;/p&gt;

&lt;p&gt;Andy. &lt;/p&gt;</comment>
                            <comment id="12942417" author="dejanb" created="Thu, 15 Apr 2010 12:46:14 +0000"  >&lt;p&gt;Hi Andy,&lt;/p&gt;

&lt;p&gt;no worries, I created a test case and will commit a fix soon.&lt;/p&gt;

&lt;p&gt;Cheers&lt;/p&gt;</comment>
                            <comment id="12942403" author="andyg" created="Thu, 15 Apr 2010 13:28:38 +0000"  >&lt;p&gt;Great stuff, many thanks!&lt;/p&gt;</comment>
                            <comment id="12942416" author="dejanb" created="Thu, 15 Apr 2010 13:56:52 +0000"  >&lt;p&gt;This should be fixed on now with svn revision 934408.&lt;/p&gt;

&lt;p&gt;JDBC store postpones deleting messages with min last seq id to the next iteration cycle. Also getting last broker sequence id procedure is also made resilient on these cases as they can still happen due to expired messages.&lt;/p&gt;</comment>
                            <comment id="12942444" author="andyg" created="Mon, 19 Apr 2010 14:55:18 +0000"  >
&lt;p&gt;   [[ Old comment, sent by email on Thu, 15 Apr 2010 11:33:28 +0200 ]]&lt;/p&gt;

&lt;p&gt;Hi Dejan,&lt;/p&gt;

&lt;p&gt;It&apos;s going to be difficult to create a test case, but is easy to &lt;br/&gt;
reproduce if you have any JDBC adapter configured.&lt;/p&gt;

&lt;p&gt;&amp;lt;persistenceAdapter&amp;gt;&lt;br/&gt;
&amp;lt;jdbcPersistenceAdapter dataSource=&quot;#postgresql-activemq-ds&quot;&amp;gt;&lt;br/&gt;
&amp;lt;adapter&amp;gt;&lt;br/&gt;
&amp;lt;postgresql-jdbc-adapter/&amp;gt;&lt;br/&gt;
&amp;lt;/adapter&amp;gt;&lt;br/&gt;
&amp;lt;/jdbcPersistenceAdapter&amp;gt;&lt;br/&gt;
&amp;lt;/persistenceAdapter&amp;gt;&lt;/p&gt;

&lt;p&gt;Just change the DataSource database to an empty test database and let &lt;br/&gt;
ActiveMQ create new empty tables.&lt;/p&gt;

&lt;p&gt;Stop ActiveMQ.&lt;/p&gt;

&lt;p&gt;Manually add one dummy row to the empty &apos;activemq_acks&apos; table:&lt;/p&gt;

&lt;p&gt;INSERT INTO activemq_acks(container, sub_dest, client_id, sub_name, &lt;br/&gt;
selector, last_acked_id) VALUES (&apos;topic://a&apos;, &apos;topic://a&apos;, &apos;a&apos;, &apos;a&apos;, &lt;br/&gt;
&apos;a&apos;, 555);&lt;/p&gt;

&lt;p&gt;Start ActiveMQ.&lt;/p&gt;

&lt;p&gt;It will try to load message id 555 - which does not exist, and will drop &lt;br/&gt;
a NullPointerException.&lt;/p&gt;

&lt;p&gt;The code in doGetLastMessageStoreSequenceId uses Math.max(seq1, seq2) to &lt;br/&gt;
determine the next sequence id, so this is then definitely not safe to &lt;br/&gt;
use in getLastMessageBrokerSequenceId() to load a message by id.&lt;/p&gt;

&lt;p&gt;I suppose a test case using something like Derby could be created - &lt;br/&gt;
without looking, is Derby on the default test classpath?&lt;/p&gt;

&lt;p&gt;Andy.&lt;/p&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12483844">AMQ-2956</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>74840</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 32 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rpov:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>159806</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>