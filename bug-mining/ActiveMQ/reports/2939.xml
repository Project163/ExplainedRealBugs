<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:38:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6477] ReduceMemoryFootprint should apply to non-persistent messages and subscriptions</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6477</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;There is a flag called reduceMemoryFootprint which will clear out the unmarshalled state of a message after it is added to a queue/topic because that state isn&apos;t counted towards the size and can lead to OOM errors.&lt;/p&gt;

&lt;p&gt;However, even setting this flag, I am still seeing some brokers run out of memory.  After analyzing the heap dumps I have found 2 reasons for this:&lt;/p&gt;

&lt;p&gt;1) Non-persistent messages do not have their unmarshalled state cleared.  This was done because when a message is persisted it is guaranteed to have the marshalled state.  However we can still clear the memory for non-persistent messages as long as we check to make sure the marshalled state exists first, which it will for transports like TCP but won&apos;t exist for the VM transport.&lt;/p&gt;

&lt;p&gt;2) When a message is added to a subscription the properties are needed to check which subscription messages can be dispatched to.  This causes the memory to be unmarshalled again.  &lt;/p&gt;

&lt;p&gt;In the topic case, we should probably defer the clearing of the state until after the message is added to a subscription because messages are immediately dispatched to topic subs so we don&apos;t unnecessarily have to convert the data twice.  In the queue case it probably makes sense to clear memory on add to the queue and on add to the subscription.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13014728">AMQ-6477</key>
            <summary>ReduceMemoryFootprint should apply to non-persistent messages and subscriptions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="cshannon">Christopher L. Shannon</reporter>
                        <labels>
                    </labels>
                <created>Mon, 24 Oct 2016 13:57:31 +0000</created>
                <updated>Tue, 1 Nov 2016 14:32:10 +0000</updated>
                            <resolved>Tue, 25 Oct 2016 14:21:07 +0000</resolved>
                                    <version>5.14.1</version>
                                    <fixVersion>5.15.0</fixVersion>
                    <fixVersion>5.14.2</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15602083" author="christopher.l.shannon" created="Mon, 24 Oct 2016 14:06:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Mind taking a quick look at this patch I created?  I haven&apos;t written tests yet but this should give you an idea the direction I am going with this and I wanted to see if you thought I was overlooking anything.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/cshannon/activemq/commit/85efac7c2f5d95a8ae75f8daa4a9478186d25d31&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cshannon/activemq/commit/85efac7c2f5d95a8ae75f8daa4a9478186d25d31&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15602237" author="gtully" created="Mon, 24 Oct 2016 15:00:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; looks good &lt;/p&gt;


&lt;p&gt;one thought: &lt;br/&gt;
I guess it also means that on each dispatch, so when prefetched messages are redelivered, there will be an unmarshall/clear.&lt;br/&gt;
it makes me think that maybe doing something to ensure that properties in both states are part of the size. That would tackle directly the OOM.&lt;/p&gt;

&lt;p&gt;However the non persistent case is valid and I guess the selector case is less common.&lt;/p&gt;

&lt;p&gt;One important aspect is ensuring no sharing of a message when the destructive change to clear the state is made. With composite sends or virtual topics (mostly there is copy) but some care there may be needed. Also consumer that use a composite dest to subscribe to multiple dests. Recall the test that had us add/remove some sync in message in the past.&lt;/p&gt;

&lt;p&gt;I think it will be fine, just be sure there is some existing sync point that will protect you in the case of sharing.&lt;/p&gt;</comment>
                            <comment id="15602290" author="christopher.l.shannon" created="Mon, 24 Oct 2016 15:20:45 +0000"  >&lt;p&gt;That&apos;s a good point about not sharing the message while doing the clearing which I think could be an issue with topic subscriptions since the message will potentially be passed to multiple subs.&lt;/p&gt;

&lt;p&gt;When doing the clear in the subscriptions maybe we need to do something like add a synchronize around the clear block:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if (isReduceMemoryFootprint()) {
  synchronized(node) {
    if (node.getMessage().isMarshalled()) {
      node.getMessage().clearUnMarshalledState();
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ultimately, I agree about having the size count both states.  That would protect form OOM errors for when the message contains both of the states while also trying to save memory when it can.  The hard part is trying to estimate the size of the properties map.&lt;/p&gt;</comment>
                            <comment id="15602395" author="christopher.l.shannon" created="Mon, 24 Oct 2016 15:54:31 +0000"  >&lt;p&gt;May not need the sync after all since the dispatch happens in the same thread sequentially (the dispatch policy just iterates over each subscription 1 at a time)&lt;/p&gt;

&lt;p&gt;Also, really it needs to clear out only after it finishes dispatching to all subscriptions that match.  Otherwise it will clear the memory and then the next call to matches() for the next consume there will be another unmarshal.&lt;/p&gt;

&lt;p&gt;So I think I might need to think about this a little bit more to see if/where it makes sense to do this in the subscription.  At the very least we can make the change for non-persistent messages to start.&lt;/p&gt;</comment>
                            <comment id="15605338" author="christopher.l.shannon" created="Tue, 25 Oct 2016 13:34:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;,  I&apos;ve decided to be slightly more conservative for this patch.  I don&apos;t feel super comfortable putting the memory clearing into the add method of the subscription like I did in my original patch because we would get into a state where we have to unmarshall/marshal the properties over and over again for each sub if there is a selector.  Plus there could be race condition issues at that point since the message has now been handed off to the different subscriptions.  So the new plan is to:&lt;/p&gt;

&lt;p&gt;1) Still handle clearing the memory for non-persistent messages by checking if content and marshalledProperties are not null (or if both marshalledProperties and properties are null)&lt;br/&gt;
2) For topics, move the clear memory method call from doMessageSend to the dispatch method and put it after the subscriptionRecoveryPolicy check (which needs to use the properties and triggers and unmarshal) but before the dispatch itself.&lt;/p&gt;

&lt;p&gt;This will at least fix non-persistent messages and it will also clear memory for topic subscriptions as long as there are no selectors (which is a less common case).  For the selector case where the dispatch policy triggers an unmarshall I would need to think about it a bit more or maybe we&apos;d just need to do something like you mentioned earlier where we actually count the size of both objects in memory.&lt;/p&gt;</comment>
                            <comment id="15605442" author="jira-bot" created="Tue, 25 Oct 2016 14:19:51 +0000"  >&lt;p&gt;Commit 7c3bb401007b4047c540287b53b435b20d3161c0 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=7c3bb40&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=7c3bb40&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6477&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6477&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ReduceMemoryFootprint now applies to non-persistent messages if they&lt;br/&gt;
have been marshalled and topics now clear memory after the recovery&lt;br/&gt;
policy check&lt;/p&gt;</comment>
                            <comment id="15605444" author="jira-bot" created="Tue, 25 Oct 2016 14:20:43 +0000"  >&lt;p&gt;Commit e0116d0458769881396d9f848d63496421fd59d5 in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e0116d0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e0116d0&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6477&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6477&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ReduceMemoryFootprint now applies to non-persistent messages if they&lt;br/&gt;
have been marshalled and topics now clear memory after the recovery&lt;br/&gt;
policy check&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 7c3bb401007b4047c540287b53b435b20d3161c0)&lt;/p&gt;</comment>
                            <comment id="15613017" author="jira-bot" created="Thu, 27 Oct 2016 19:53:52 +0000"  >&lt;p&gt;Commit 0a80165a99bff33bfaeeb8fe1dc7b5a8e6f50830 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=0a80165&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=0a80165&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6477&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6477&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;simplifying isMarshalled method&lt;/p&gt;</comment>
                            <comment id="15613019" author="jira-bot" created="Thu, 27 Oct 2016 19:54:26 +0000"  >&lt;p&gt;Commit 4cbe692bccb5bb246a2099f8504e103ac90079be in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=4cbe692&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=4cbe692&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6477&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6477&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;simplifying isMarshalled method&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 0a80165a99bff33bfaeeb8fe1dc7b5a8e6f50830)&lt;/p&gt;</comment>
                            <comment id="15625570" author="jira-bot" created="Tue, 1 Nov 2016 14:31:54 +0000"  >&lt;p&gt;Commit 5c80eda321e7edb5f34ffd62c71523310d26b2ca in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=5c80eda&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=5c80eda&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6477&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6477&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fixing potential concurrent modification exception&lt;/p&gt;</comment>
                            <comment id="15625572" author="jira-bot" created="Tue, 1 Nov 2016 14:32:10 +0000"  >&lt;p&gt;Commit fc3206864d895a469af39ec2f3f6808ad936b908 in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=fc32068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=fc32068&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6477&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6477&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fixing potential concurrent modification exception&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 5c80eda321e7edb5f34ffd62c71523310d26b2ca)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 3 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35auf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>