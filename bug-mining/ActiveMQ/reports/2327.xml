<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:05:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5198] MessageConsumer and Producer are not thread safe</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5198</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;We currently have an object that acts both as a consumer and as a producer over the same queue.&lt;/p&gt;

&lt;p&gt;Lazy initialization of the scheduler is not 100% thread safe when a consumer and a producer are created sharing the same connection.&lt;/p&gt;


&lt;p&gt;We encountered the following sporadic NPE when a rollback() is invoked:&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
        at org.apache.activemq.thread.Scheduler.executeAfterDelay(Scheduler.java:64)&lt;br/&gt;
        at org.apache.activemq.ActiveMQMessageConsumer.rollback(ActiveMQMessageConsumer.java:1278)&lt;br/&gt;
        at org.apache.activemq.ActiveMQMessageConsumer$5.afterRollback(ActiveMQMessageConsumer.java:1054)&lt;br/&gt;
        at org.apache.activemq.TransactionContext.afterRollback(TransactionContext.java:157)&lt;br/&gt;
        ... 11 more&lt;/p&gt;



&lt;p&gt;We believe that the lazy initialized getScheduler() is open for a race condition when a publish and rollback are happening concurrently.&lt;/p&gt;

&lt;p&gt;try &lt;/p&gt;
{
                        result = scheduler = new Scheduler(&quot;ActiveMQConnection[&quot;+info.getConnectionId().getValue()+&quot;] Scheduler&quot;);
                        scheduler.start();
                    }
&lt;p&gt; catch(Exception e) &lt;/p&gt;
{
                        throw JMSExceptionSupport.create(e);
                    }

&lt;p&gt;The suggested fix is to simply invoke the start within the constructor of the Scheduler class.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12716030">AMQ-5198</key>
            <summary>MessageConsumer and Producer are not thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Malli">Enrico Musuruana</reporter>
                        <labels>
                    </labels>
                <created>Thu, 22 May 2014 09:24:55 +0000</created>
                <updated>Fri, 25 Sep 2015 19:15:23 +0000</updated>
                            <resolved>Fri, 18 Jul 2014 14:13:02 +0000</resolved>
                                    <version>5.9.0</version>
                                    <fixVersion>5.10.1</fixVersion>
                    <fixVersion>5.11.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14006011" author="tabish121" created="Thu, 22 May 2014 15:25:52 +0000"  >&lt;p&gt;Do you have a test case that can reproduce this &lt;/p&gt;</comment>
                            <comment id="14006965" author="malli" created="Fri, 23 May 2014 08:23:41 +0000"  >&lt;p&gt;Hi Timothy,&lt;/p&gt;

&lt;p&gt;unfortunately, as you might understand, it&apos;s pretty hard to trigger a race condition reliably. &lt;br/&gt;
Please let me know if you need anyway a small test set up anyway.&lt;/p&gt;</comment>
                            <comment id="14006996" author="malli" created="Fri, 23 May 2014 09:17:03 +0000"  >&lt;p&gt;Hi Timothy,&lt;/p&gt;

&lt;p&gt;I&apos;ve attached a testcase that successfully hits the NPE when the scheduler.start() method is delayed.&lt;/p&gt;

&lt;p&gt;The first consumer enters the block and while it still has to perform the start() the second will find the first if condition if (result == null) false, hence it won&apos;t have the Timer object initialised and an exception is thrown.&lt;/p&gt;

&lt;p&gt;I hope this explanation is clear enough&lt;/p&gt;</comment>
                            <comment id="14015236" author="malli" created="Mon, 2 Jun 2014 07:56:14 +0000"  >&lt;p&gt;Hi Timothy,&lt;/p&gt;

&lt;p&gt;any update on this?&lt;/p&gt;</comment>
                            <comment id="14017707" author="tabish121" created="Wed, 4 Jun 2014 13:48:31 +0000"  >&lt;p&gt;Haven&apos;t had time to investigate as the test is quite large.  A simpler JUnit test case would be quicker to investigate otherwise this will have to wait.  In JMS land the Session is meant to be a single threaded resource to you can probably work around any issue here by giving each it&apos;s own Session instance. &lt;/p&gt;</comment>
                            <comment id="14041896" author="malli" created="Tue, 24 Jun 2014 09:06:02 +0000"  >&lt;p&gt;Hi Timothy,&lt;/p&gt;

&lt;p&gt;As I mentioned the problem is not related to the Session, but the Connection itself not being thread safe. We currently make use of a single Session per thread.&lt;/p&gt;

&lt;p&gt;We both agree that an &apos;in frequently triggered&apos; race condition doesnt exactly lend itself to a simple junit, but I believe that the test case I provided you with the actual patch should be quite straight-forward to test.&lt;/p&gt;</comment>
                            <comment id="14066162" author="malli" created="Fri, 18 Jul 2014 08:28:36 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;is there any update on this?&lt;/p&gt;</comment>
                            <comment id="14066381" author="tabish121" created="Fri, 18 Jul 2014 14:13:02 +0000"  >&lt;p&gt;Fixed the assignment of the member variable to occur after the created scheduler is initialized so that the initialization doesn&apos;t allow the instance to escape the synchronized block.  &lt;/p&gt;</comment>
                            <comment id="14908544" author="jahlborn" created="Fri, 25 Sep 2015 19:15:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt; - just came across this bug and looked at the fix.  This isn&apos;t actually correctly thread-safe at this point.  The new code is using the broken version of double-checked locking.  In order for this to be fixed correctly, the scheduler reference must be made volatile.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12646480" name="ActiveMq.zip" size="22496" author="Malli" created="Fri, 23 May 2014 09:17:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>394234</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1vvon:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>394372</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>