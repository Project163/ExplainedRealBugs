<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:55:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3887] Occasional Null Pointer Exception during NetworkConnector connection</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3887</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;While starting a duplex NetworkConnector an NPE can be observed on the receiving side.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2012-06-18 17:34:24,571 INFO  .DemandForwardingBridgeSupport - Network connection between vm:&lt;span class=&quot;code-comment&quot;&gt;//proxy-cbpi001#8 and tcp:///169.254.
&lt;/span&gt;0.5:59412(cbox-56BU101117) has been established. [StartLocalBridge: localBroker=vm:&lt;span class=&quot;code-comment&quot;&gt;//proxy-cbpi001#8]
&lt;/span&gt;2012-06-18 17:34:24,577 WARN  .DemandForwardingBridgeSupport - Caught an exception processing local command [BrokerService[proxy-c
bpi001] Task-19]
java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
        at org.apache.activemq.network.DemandForwardingBridgeSupport.configureMessage(DemandForwardingBridgeSupport.java:644) ~[ac
tivemq-core-5.6.0.jar:5.6.0]
        at org.apache.activemq.network.DemandForwardingBridgeSupport.serviceLocalCommand(DemandForwardingBridgeSupport.java:675) ~
[activemq-core-5.6.0.jar:5.6.0]
        at org.apache.activemq.network.DemandForwardingBridgeSupport$1.onCommand(DemandForwardingBridgeSupport.java:139) [activemq
-core-5.6.0.jar:5.6.0]
        at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:116) [activemq-core-5.6.0.jar:5.6.0]
        at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50) [activemq-core-5.6.0.jar:5.6.0]
        at org.apache.activemq.transport.vm.VMTransport.doDispatch(VMTransport.java:135) [activemq-core-5.6.0.jar:5.6.0]
        at org.apache.activemq.transport.vm.VMTransport.dispatch(VMTransport.java:124) [activemq-core-5.6.0.jar:5.6.0]
        at org.apache.activemq.transport.vm.VMTransport.oneway(VMTransport.java:103) [activemq-core-5.6.0.jar:5.6.0]
        at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:68) [activemq-core-5.6.0.jar:5.6.0]
        at org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60) [activemq-core-5.6.0.jar:5.6.0]
        at org.apache.activemq.broker.TransportConnection.dispatch(TransportConnection.java:1307) [activemq-core-5.6.0.jar:5.6.0]
        at org.apache.activemq.broker.TransportConnection.processDispatch(TransportConnection.java:837) [activemq-core-5.6.0.jar:5
.6.0]
        at org.apache.activemq.broker.TransportConnection.iterate(TransportConnection.java:872) [activemq-core-5.6.0.jar:5.6.0]
        at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:122) [activemq-core-5.6.0.jar:5.6.0]
        at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:43) [activemq-core-5.6.0.jar:5.6.0]
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source) [na:1.6.0_20]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source) [na:1.6.0_20]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source) [na:1.6.0_20]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The other broker will eventually connect, but with about a hundred of connecting brokers this occurs too often to ignore.&lt;/p&gt;

&lt;p&gt;As this seems to be a race condition it is quite difficult to reproduce reliably. I assume producerInfo is accessed in configureMessage before it is initialized in startRemoteBridge.&lt;/p&gt;</description>
                <environment>&lt;p&gt;SLES 10&lt;/p&gt;</environment>
        <key id="12594957">AMQ-3887</key>
            <summary>Occasional Null Pointer Exception during NetworkConnector connection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="ron.koerner">Ron Koerner</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Jun 2012 16:02:55 +0000</created>
                <updated>Tue, 21 Aug 2012 11:26:35 +0000</updated>
                            <resolved>Tue, 21 Aug 2012 10:31:45 +0000</resolved>
                                    <version>5.6.0</version>
                                    <fixVersion>5.7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13397564" author="tabish121" created="Wed, 20 Jun 2012 14:57:03 +0000"  >&lt;p&gt;Fix applied on trunk.&lt;/p&gt;</comment>
                            <comment id="13413720" author="ron.koerner" created="Fri, 13 Jul 2012 13:26:45 +0000"  >&lt;p&gt;With the latest 5.7-SNAPSHOT the problem is still there:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2012-07-13 15:02:25,987 INFO  .DemandForwardingBridgeSupport - Network connection between vm:&lt;span class=&quot;code-comment&quot;&gt;//smcufs02#32 and tcp:///127.0.0.1:43274(cbox-000000005300653612) has been established. [StartLocalBridge: localBroker=vm://smcufs02#32]
&lt;/span&gt;2012-07-13 15:02:25,988 INFO  emq.broker.TransportConnection - Started responder end of duplex bridge cBox 000000005300653612 to cBox Proxy@ID:000000005300653612-48838-1341420908942-0:1 [ActiveMQ NIO Worker 1]
2012-07-13 15:02:25,989 INFO  .ConnectorAuthenticationBroker - checked login of checkit:xdev-000000005300653612 [ActiveMQ NIO Worker 1]
2012-07-13 15:02:26,021 WARN  .DemandForwardingBridgeSupport - Caught an exception processing local command [BrokerService[smcufs02] Task-147]
java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
        at org.apache.activemq.network.DemandForwardingBridgeSupport.configureMessage(DemandForwardingBridgeSupport.java:673) ~[activemq-core-5.7-SNAPSHOT.jar:5.7-SNAPSHOT]
        at org.apache.activemq.network.DemandForwardingBridgeSupport.serviceLocalCommand(DemandForwardingBridgeSupport.java:707) ~[activemq-core-5.7-SNAPSHOT.jar:5.7-SNAPSHOT]
        at org.apache.activemq.network.DemandForwardingBridgeSupport$1.onCommand(DemandForwardingBridgeSupport.java:165) [activemq-core-5.7-SNAPSHOT.jar:5.7-SNAPSHOT]
        at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:116) [activemq-core-5.7-SNAPSHOT.jar:5.7-SNAPSHOT]
        at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50) [activemq-core-5.7-SNAPSHOT.jar:5.7-SNAP
SHOT]
        at org.apache.activemq.transport.vm.VMTransport.doDispatch(VMTransport.java:137) [activemq-core-5.7-SNAPSHOT.jar:5.7-SNAPSHOT]
        at org.apache.activemq.transport.vm.VMTransport.dispatch(VMTransport.java:126) [activemq-core-5.7-SNAPSHOT.jar:5.7-SNAPSHOT]
        at org.apache.activemq.transport.vm.VMTransport.oneway(VMTransport.java:103) [activemq-core-5.7-SNAPSHOT.jar:5.7-SNAPSHOT]
        at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:68) [activemq-core-5.7-SNAPSHOT.jar:5.7-SNAPSHOT]
        at org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60) [activemq-core-5.7-SNAPSHOT.jar:5.7-SNAPSHOT]
        at org.apache.activemq.broker.TransportConnection.dispatch(TransportConnection.java:1307) [activemq-core-5.7-SNAPSHOT.jar:5.7-SNAPSHOT]
        at org.apache.activemq.broker.TransportConnection.processDispatch(TransportConnection.java:837) [activemq-core-5.7-SNAPSHOT.jar:5.7-SNAPSHOT]
        at org.apache.activemq.broker.TransportConnection.iterate(TransportConnection.java:872) [activemq-core-5.7-SNAPSHOT.jar:5.7-SNAPSHOT]
        at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:122) [activemq-core-5.7-SNAPSHOT.jar:5.7-SNAPSHOT]
        at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:43) [activemq-core-5.7-SNAPSHOT.jar:5.7-SNAPSHOT]
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886) [na:1.6.0_20]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908) [na:1.6.0_20]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:619) [na:1.6.0_20]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13413822" author="tabish121" created="Fri, 13 Jul 2012 15:35:26 +0000"  >&lt;p&gt;I&apos;d recommend that you try and crate a JUnit test case to show how this is happening.&lt;/p&gt;</comment>
                            <comment id="13417003" author="ron.koerner" created="Wed, 18 Jul 2012 11:36:50 +0000"  >&lt;p&gt;I tried, but it seems the problem only manifests in a live system.&lt;br/&gt;
Anyway, I think it is a race condition introduced by the following facts&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;DemandForwardingBridgeSupport.start&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;synchronously connects the &lt;tt&gt;local/remoteBroker&lt;/tt&gt; Transports to &lt;tt&gt;serviceLocal/RemoteCommand&lt;/tt&gt;&lt;/li&gt;
		&lt;li&gt;asynchronously runs &lt;tt&gt;startRemoteBride&lt;/tt&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;someone sends a messageDispatch command to &lt;tt&gt;localBroker&lt;/tt&gt; (whenever, maybe even before DFBS.start)&lt;/li&gt;
	&lt;li&gt;[BrokerService&lt;span class=&quot;error&quot;&gt;&amp;#91;smcufs02&amp;#93;&lt;/span&gt; Task-147] delivers the message after &lt;tt&gt;DemandForwardingBridgeSupport.start&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;to &lt;tt&gt;DemandForwardingBridgeSupport.serviceLocalCommand&lt;/tt&gt;&lt;/li&gt;
		&lt;li&gt;which calls &lt;tt&gt;configureMessage&lt;/tt&gt; which uses &lt;tt&gt;producerInfo&lt;/tt&gt; which is not yet set&lt;/li&gt;
		&lt;li&gt;and &lt;tt&gt;startLocalBridge&lt;/tt&gt; may not even be started yet&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;startRemoteBridge&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;eventually creates &lt;tt&gt;producerInfo&lt;/tt&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I don&apos;t think &lt;tt&gt;serviceLocalCommand&lt;/tt&gt; should handle message dispatches before the bridge is completely started. Therefore a &lt;tt&gt;waitStarted()&lt;/tt&gt; after &lt;tt&gt;if (command.isMessageDispatch())&lt;/tt&gt; in &lt;tt&gt;serviceLocalCommand&lt;/tt&gt; should solve the problem.&lt;/p&gt;

&lt;p&gt;It is to note that &lt;tt&gt;serviceRemoteCommand&lt;/tt&gt; already includes a &lt;tt&gt;waitStarted()&lt;/tt&gt; for message dispatches.&lt;/p&gt;

&lt;p&gt;Maybe both methods should make a checked for &lt;tt&gt;disposed&lt;/tt&gt; after waiting. They do check at the beginning, but if &lt;tt&gt;waitStarted&lt;/tt&gt; really blocks, that may change in the meantime.&lt;/p&gt;</comment>
                            <comment id="13417086" author="tabish121" created="Wed, 18 Jul 2012 13:43:34 +0000"  >&lt;p&gt;Have you tried these changes on a build of ActiveMQ?  Without a test case we have no way of knowing whether this fixes anything, so if you want to create a SNAPSHOT build locally and try out you ideas that would be a start. &lt;/p&gt;</comment>
                            <comment id="13417863" author="tabish121" created="Wed, 18 Jul 2012 23:47:35 +0000"  >&lt;p&gt;I&apos;d ask that you at least attach your Broker configuration so that if someone wants to take a stab at creating a unit test for this they will know what your setup is. &lt;/p&gt;</comment>
                            <comment id="13418183" author="ron.koerner" created="Thu, 19 Jul 2012 09:37:51 +0000"  >&lt;p&gt;My broker configuration contains some proprietary code which enables us to allow local connections for everyone, but remote connections need to be authenticated. I&apos;ll probably have to ask our legal department if I&apos;m allowed to open source these.&lt;br/&gt;
I built a SNAPSHOT with &lt;tt&gt;waitStarted()&lt;/tt&gt; and will monitor the behaviour.&lt;/p&gt;</comment>
                            <comment id="13438568" author="gtully" created="Tue, 21 Aug 2012 09:55:27 +0000"  >&lt;p&gt;fyi: I have seen this exception on occasion with: org.apache.activemq.network.BrokerNetworkWithStuckMessagesTest#testBrokerNetworkWithStuckMessages&lt;/p&gt;</comment>
                            <comment id="13438585" author="gtully" created="Tue, 21 Aug 2012 10:31:45 +0000"  >&lt;p&gt;fix in &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1375459&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1375459&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;essentially the wait till the remote setup is complete before responding to a local dispatch.&lt;/p&gt;</comment>
                            <comment id="13438598" author="ron.koerner" created="Tue, 21 Aug 2012 10:48:07 +0000"  >&lt;p&gt;That seems to help.&lt;br/&gt;
Anyway, I think there is another lurking bug. When safeWaitUntilStarted() returns because of disposed.get() is true it is the same as when it returns because of the latch was unblocked.&lt;br/&gt;
Wherever safeWaitUntilStarted() is used should be a check afterwards whether disposed.get() is true and act accordingly.&lt;br/&gt;
Otherwise, thanks for your help.&lt;/p&gt;</comment>
                            <comment id="13438616" author="gtully" created="Tue, 21 Aug 2012 11:26:35 +0000"  >&lt;p&gt;@Ron, the &apos;safety&apos; aspect of safeWaitUntilStarted is that it won&apos;t block forever in the event of a failure of one of the transports. Any subsequent failure will result in the exception handling stopping the bridge. We can keep an eye on that, thanks for the feedback.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>246252</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 14 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i07jbb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>41896</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>