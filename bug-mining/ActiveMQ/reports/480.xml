<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:38:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1979] Temporary queue on slave not removed in Pure Master/Slave setup</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1979</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Maybe not the most logical client code, but it happened here and I guess it will happen somewhere again:&lt;/p&gt;

&lt;p&gt;  TemporaryQueue reply = session.createTemporaryQueue();      	&lt;br/&gt;
  MessageConsumer consumer = session.createConsumer(reply);&lt;br/&gt;
  Message received = consumer.receive(timeout);&lt;br/&gt;
  ...&lt;br/&gt;
  reply.delete();&lt;br/&gt;
  consumer.close();&lt;/p&gt;

&lt;p&gt;I&apos;ve removed try/finally blocks to keep it simple.&lt;/p&gt;

&lt;p&gt;See the attached source code.&lt;/p&gt;

&lt;p&gt;It works fine, but set &lt;/p&gt;

&lt;p&gt;  JmsMessageHandler.REVERSE_ORDER=true&lt;/p&gt;

&lt;p&gt;and the slave will not be cleaned up properly.&lt;/p&gt;

&lt;p&gt;It means that the number of threads is increasing and at some time it will get an OutOfMemoryError (see &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1849&quot; title=&quot;Slave threads increasing when sending to temporary queue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1849&quot;&gt;&lt;del&gt;AMQ-1849&lt;/del&gt;&lt;/a&gt;) and the slave dies.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12482194">AMQ-1979</key>
            <summary>Temporary queue on slave not removed in Pure Master/Slave setup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="hansb">Hans Bausewein</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Oct 2008 12:56:37 +0000</created>
                <updated>Thu, 6 Nov 2008 10:47:07 +0000</updated>
                            <resolved>Fri, 17 Oct 2008 13:02:56 +0000</resolved>
                                    <version>5.2.0</version>
                                    <fixVersion>5.2.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                                                            <comments>
                            <comment id="12940375" author="gtully" created="Wed, 15 Oct 2008 14:20:17 +0000"  >&lt;p&gt;not sure about the validity of the test case here. I tried to reproduce using an existing test case and I get an exception because the temp destination is in use till the consumer is closed. so it is not possible to delete before the close; can you concur.&lt;br/&gt;
I see an exception in your test case also. In the exception case, the temp destination is not deleted at all!&lt;/p&gt;

&lt;p&gt;see the simple code mod to TempQueueMemoryTest:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: activemq-core/src/test/java/org/apache/activemq/advisory/TempQueueMemoryTest.java
===================================================================
--- activemq-core/src/test/java/org/apache/activemq/advisory/TempQueueMemoryTest.java	(revision 704890)
+++ activemq-core/src/test/java/org/apache/activemq/advisory/TempQueueMemoryTest.java	(working copy)
@@ -37,7 +37,7 @@
     &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; Connection clientConnection;
     &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; Session clientSession;
     &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; Destination serverDestination;
-    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; COUNT = 2000;
+    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; COUNT = 1; &lt;span class=&quot;code-comment&quot;&gt;// 2000
&lt;/span&gt; 
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testLoadRequestReply() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
         MessageConsumer serverConsumer = serverSession.createConsumer(serverDestination);
@@ -63,8 +63,9 @@
             msg.setJMSReplyTo(replyTo);
             producer.send(msg);
             Message reply = consumer.receive();
+            &lt;span class=&quot;code-comment&quot;&gt;//consumer.close();
&lt;/span&gt;+            replyTo.delete();
             consumer.close();
-            replyTo.delete();
         }
         
         clientSession.close();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12940361" author="gtully" created="Wed, 15 Oct 2008 14:22:15 +0000"  >&lt;p&gt;exception from your test case:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2008-10-15 15:16:10,551 [MQ Session Task] ERROR JmsMessageHandler              - Failed to delete reply queue ID:gtullyd810-51430-1224080169714-3:2:1
javax.jms.JMSException: A consumer is consuming from the temporary destination
	at org.apache.activemq.ActiveMQConnection.deleteTempDestination(ActiveMQConnection.java:1869)
	at org.apache.activemq.command.ActiveMQTempDestination.delete(ActiveMQTempDestination.java:51)
	at org.activemq.jms.JmsMessageHandler.forwardToNext(JmsMessageHandler.java:236)
	at org.activemq.jms.JmsMessageHandler.onMessage(JmsMessageHandler.java:167)
	at org.apache.activemq.ActiveMQMessageConsumer.dispatch(ActiveMQMessageConsumer.java:1021)
	at org.apache.activemq.ActiveMQSessionExecutor.dispatch(ActiveMQSessionExecutor.java:122)
	at org.apache.activemq.ActiveMQSessionExecutor.iterate(ActiveMQSessionExecutor.java:192)
	at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:122)
	at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:43)
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:595)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12940362" author="hansb" created="Wed, 15 Oct 2008 14:34:06 +0000"  >&lt;p&gt;Maybe it&apos;s removed later by some other cleanup method?&lt;/p&gt;

&lt;p&gt;The application, where I&apos;ve found it is running in JBoss and I suppose JBoss keeps the open connection in a pool, so then the temporary destinations are not removed.&lt;/p&gt;

&lt;p&gt;Problem is that it causes a difference between the master and the slave: on the master the queue is removed, but on the slave it still exists.&lt;br/&gt;
I can reproduce that with this code.&lt;/p&gt;

&lt;p&gt;I don&apos;t have a problem with this issue anymore, because I&apos;ve fixed our client code, but I suppose the same error will be made again and will keep causing headaches. (it was worse in our case, because the exception on the failing delete attempt was not logged)&lt;/p&gt;

</comment>
                            <comment id="12940348" author="hansb" created="Thu, 16 Oct 2008 16:39:10 +0000"  >&lt;p&gt;Remove the &quot;reply.delete()&quot; code entirely. It indeed does not matter.&lt;/p&gt;

&lt;p&gt;The issue is that the TemporaryQueue is removed in the Master and not in the Slave.&lt;/p&gt;

&lt;p&gt;If it would not be removed in the Master (until the Connection is closed) that would be okay.&lt;/p&gt;</comment>
                            <comment id="12940370" author="gtully" created="Fri, 17 Oct 2008 13:02:56 +0000"  >&lt;p&gt;resolved in 705592.&lt;br/&gt;
Slave connection now knows about temp destinations so it can delete on close rather than just on an explicit delete command. It now behaves like the master in the absence of a tempDestination.delete call.&lt;/p&gt;</comment>
                            <comment id="12940468" author="gtully" created="Thu, 6 Nov 2008 10:47:07 +0000"  >&lt;p&gt;These fixes will now make 5.2.0 rc3&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461154" name="ASF.LICENSE.NOT.GRANTED--activemqjee-0.0.6-src.tar.gz" size="8053" author="hansb" created="Tue, 14 Oct 2008 12:56:37 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12482689">AMQ-1849</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>75140</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 3 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0jxfz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>114348</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>