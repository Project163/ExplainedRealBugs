<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:51:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3457] temp destinations should only be deleted once all users of a pooled connection call close</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3457</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2349&quot; title=&quot;Temporary destinations created with PooledConnectionFactory never get deleted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2349&quot;&gt;&lt;del&gt;AMQ-2349&lt;/del&gt;&lt;/a&gt; added some code to clean up temp destinations once close() is called on a pooled connection. This caused pretty much all the JMS request-reply tests to fail in Camel with &quot;javax.jms.InvalidDestinationException: Cannot publish to a deleted Destination&quot; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;The problem is that with a pooled connection, multiple users can be using a Connection at the same time (a reference count is kept of how many there are) so if once calls close() the temp destinations of several others could be deleted while they are still using them. I think the correct behavior would be to only delete the temp destinations when all connection users call close() (i.e. when the reference count becomes zero).&lt;/p&gt;

&lt;p&gt;Attaching a proposed fix for this shortly for review.&lt;/p&gt;</description>
                <environment>&lt;p&gt;5.6-SNAPSHOT&lt;/p&gt;</environment>
        <key id="12519109">AMQ-3457</key>
            <summary>temp destinations should only be deleted once all users of a pooled connection call close</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="janstey">Jonathan Anstey</assignee>
                                    <reporter username="janstey">Jonathan Anstey</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Aug 2011 13:11:08 +0000</created>
                <updated>Wed, 25 Jan 2012 00:48:22 +0000</updated>
                            <resolved>Wed, 5 Oct 2011 17:17:42 +0000</resolved>
                                    <version>5.x</version>
                                    <fixVersion>5.6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13086304" author="tabish121" created="Wed, 17 Aug 2011 13:29:58 +0000"  >&lt;p&gt;Patch applied, thanks for catching that.&lt;/p&gt;</comment>
                            <comment id="13086308" author="janstey" created="Wed, 17 Aug 2011 13:36:45 +0000"  >&lt;p&gt;Awesome. Thanks for the quick review!&lt;/p&gt;</comment>
                            <comment id="13121162" author="janstey" created="Wed, 5 Oct 2011 17:13:41 +0000"  >&lt;p&gt;Found another issue with this... so in the original bug multiple clients were using the same pooled connection and if one of those clients called close, it could potentially delete another client&apos;s temporary destination since they all shared the same connection. The fix was to wait until all clients had called close before deleting the temp destination.&lt;/p&gt;

&lt;p&gt;Now, in the case where there is a large pool of connections available, every client gets their own connection so the previous issue isn&apos;t a problem anymore. However, the AdvisoryConsumer holds on to a copy of all temp destinations and also adds each of these temp destinations to the connection it uses. So now, 2 connections have a reference to the same temp destination... which is a problem. If this connection is also used by a client and the client calls close, then the temp destinations will be deleted even though they are still used by another connection. &lt;/p&gt;

&lt;p&gt;Will commit a fix shortly for this.&lt;/p&gt;</comment>
                            <comment id="13125307" author="joed" created="Tue, 11 Oct 2011 19:17:35 +0000"  >&lt;p&gt;To confirm the last comment, yup. You&apos;ll delete other clients destinations and in an active system this cleanup really will not hit...&lt;/p&gt;</comment>
                            <comment id="13125710" author="tabish121" created="Wed, 12 Oct 2011 10:50:48 +0000"  >&lt;p&gt;Jon&apos;s fix was committed, see: &lt;a href=&quot;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=1179328&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=rev&amp;amp;rev=1179328&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13188941" author="artnaseef" created="Thu, 19 Jan 2012 05:54:04 +0000"  >&lt;p&gt;Is this a complete fix, or will it lead to temporary destinations that linger on a heavily reused connection?&lt;/p&gt;

&lt;p&gt;Doesn&apos;t the PooledConnection need to keep track of the temporary destinations created by its sessions and specifically delete those on close()?&lt;/p&gt;</comment>
                            <comment id="13189117" author="janstey" created="Thu, 19 Jan 2012 14:04:50 +0000"  >&lt;p&gt;Possibly. Though I&apos;m just going on memory here - haven&apos;t looked at the latest code &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Are you seeing this behavior in your application?&lt;/p&gt;</comment>
                            <comment id="13189122" author="tabish121" created="Thu, 19 Jan 2012 14:10:11 +0000"  >&lt;p&gt;ActiveMQConnection keeps track of the temp destinations, and the patch causes the PooledConnection to ask the connection to deletes the temp destinations it created once the PooledConnection is closed, so no need to deplicate that logic in the PooledConnection.&lt;/p&gt;

&lt;p&gt;If you are still seeing an issue then a JUnit test case to demonstrate the problem would be appropriate.&lt;/p&gt;</comment>
                            <comment id="13189171" author="artnaseef" created="Thu, 19 Jan 2012 16:13:25 +0000"  >&lt;p&gt;Below is my understanding.  I&apos;ll work on a JUnit case, and send a proposal that I believe fixes the issue, a little later today.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The PooledConnection no longer cleans up the temp destinations itself&lt;/li&gt;
	&lt;li&gt;ConnectionPool removes the temp destinations after all references to the ConnectionPool are dropped (meaning that the underlying ActiveMQConnection is also no longer used)&lt;/li&gt;
	&lt;li&gt;PooledConnection gets its ConnectionPool from the PooledConnectionFactory when instantiated.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;PooledConnectionFactory keeps a cache of ConnectionPool objects in a hash-map keyed on the user-name + passsword.
	&lt;ul&gt;
		&lt;li&gt;On createConnection(), if the ConnectionPool (with the matching username + password) is already in the cache, it is passed to the newly created PooledConnection.&lt;/li&gt;
		&lt;li&gt;If it&apos;s not already in the cache, a new one is added to the cache and used for the newly created PooledConnection.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Here are the changes to ConnectionPool and PooledConnection for this bug that I believe back this up.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: trunk/activemq-pool/src/main/java/org/apache/activemq/pool/ConnectionPool.java
===================================================================
diff -u -N -r1071256 -r1158694
--- trunk/activemq-pool/src/main/java/org/apache/activemq/pool/ConnectionPool.java	(.../ConnectionPool.java)	(revision 1071256)
+++ trunk/activemq-pool/src/main/java/org/apache/activemq/pool/ConnectionPool.java	(.../ConnectionPool.java)	(revision 1158694)
@@ -144,6 +144,12 @@
         lastUsed = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis();
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (referenceCount == 0) {
             expiredCheck();
+            
+            &lt;span class=&quot;code-comment&quot;&gt;// only clean up temp destinations when all users 
&lt;/span&gt;+            &lt;span class=&quot;code-comment&quot;&gt;// of &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; connection have called close
&lt;/span&gt;+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getConnection() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+                getConnection().cleanUpTempDestinations();
+            }
         }
     }
 
Index: trunk/activemq-pool/src/main/java/org/apache/activemq/pool/PooledConnection.java
===================================================================
diff -u -N -r1142267 -r1158694
--- trunk/activemq-pool/src/main/java/org/apache/activemq/pool/PooledConnection.java	(.../PooledConnection.java)	(revision 1142267)
+++ trunk/activemq-pool/src/main/java/org/apache/activemq/pool/PooledConnection.java	(.../PooledConnection.java)	(revision 1158694)
@@ -16,9 +16,6 @@
  */
 &lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.apache.activemq.pool;
 
-&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.Iterator;
-&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.concurrent.ConcurrentHashMap;
-
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.Connection;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.ConnectionConsumer;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.ConnectionMetaData;
@@ -39,7 +36,6 @@
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.activemq.AlreadyClosedException;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.activemq.EnhancedConnection;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.activemq.advisory.DestinationSource;
-&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.activemq.command.ActiveMQTempDestination;
 
 /**
  * Represents a proxy {@link Connection} which is-a {@link TopicConnection} and
@@ -73,9 +69,6 @@
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; JMSException {
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.pool != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
             &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.pool.decrementReferenceCount();
-            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.pool.getConnection() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
-                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.pool.getConnection().cleanUpTempDestinations();
-            }
             &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.pool = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
         }
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;By the way, for a JUnit test - do you have any recommendation on testing whether a temporary destination has been deleted?  My plan is to produce to it from another connection and expect an exception.&lt;/p&gt;</comment>
                            <comment id="13189183" author="artnaseef" created="Thu, 19 Jan 2012 16:35:27 +0000"  >&lt;p&gt;Proposal for correcting the potential for lingering temporary destinations.&lt;/p&gt;

&lt;p&gt;This has not yet been tested; I&apos;m posting it now to demonstrate my thinking.  Unit test is being written now.&lt;/p&gt;</comment>
                            <comment id="13189226" author="artnaseef" created="Thu, 19 Jan 2012 17:38:02 +0000"  >&lt;p&gt;Producing to the temporary destination to test for its existence is not working.  Any tips on how I can check if the temporary destination is deleted?&lt;/p&gt;</comment>
                            <comment id="13189233" author="artnaseef" created="Thu, 19 Jan 2012 17:49:50 +0000"  >&lt;p&gt;JUnit test case which shows the temporary destinations of closed PooledConnection objects linger.&lt;/p&gt;

&lt;p&gt;Uses the destinationExists() method from the advisory/TempDestDeleteTest.java source - thanks!&lt;/p&gt;</comment>
                            <comment id="13189248" author="artnaseef" created="Thu, 19 Jan 2012 18:08:01 +0000"  >&lt;p&gt;Corrected patch - the original missed the all-important change to the PooledConnection.close() method itself.&lt;/p&gt;

&lt;p&gt;This was tested with the JUnit case provided and is working.&lt;/p&gt;</comment>
                            <comment id="13189252" author="artnaseef" created="Thu, 19 Jan 2012 18:12:25 +0000"  >&lt;p&gt;Third try - better remove the temp dests before decrementing the count on the connection pool in case that causes the underlying ActiveMQConnection to close.&lt;/p&gt;</comment>
                            <comment id="13189258" author="artnaseef" created="Thu, 19 Jan 2012 18:22:21 +0000"  >&lt;p&gt;More thorough JUnit - supercedes the TestConnectionPoolLingeringTemps.&lt;/p&gt;

&lt;p&gt;Corrects the assertion comments and adds a test that closing one PooledConnection does not delete the temporary destinations of a second one.&lt;/p&gt;</comment>
                            <comment id="13189878" author="artnaseef" created="Fri, 20 Jan 2012 16:34:49 +0000"  >&lt;p&gt;New source file that&apos;s missing from the patch and is needed for the solution.&lt;/p&gt;</comment>
                            <comment id="13192684" author="artnaseef" created="Wed, 25 Jan 2012 00:20:24 +0000"  >&lt;p&gt;Is there more I can do to facilitate this?  I know I updated several times; I apologize for not providing cleaner packaging.&lt;/p&gt;

&lt;p&gt;Should I reopen this ticket, or open a new one?&lt;/p&gt;</comment>
                            <comment id="13192700" author="tabish121" created="Wed, 25 Jan 2012 00:29:55 +0000"  >&lt;p&gt;You are welcome to reopen or create a new issue with your additional work.  When someone has time to review the issue they will be able to determine the correct course of action.&lt;/p&gt;</comment>
                            <comment id="13192728" author="artnaseef" created="Wed, 25 Jan 2012 00:48:22 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3680&quot; title=&quot;Cleanup of temporary destinations by PooledConnection and ConnectionPool either leaks temp dests or deletes too many&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3680&quot;&gt;&lt;del&gt;AMQ-3680&lt;/del&gt;&lt;/a&gt; to follow up.  It turns out I can&apos;t re-open this ticket.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12511271" name="PooledSessionTempDestEventListener.java" size="524" author="artnaseef" created="Fri, 20 Jan 2012 16:34:49 +0000"/>
                            <attachment id="12511147" name="TestConnectionPoolLingeringTemps.java" size="5980" author="artnaseef" created="Thu, 19 Jan 2012 17:49:50 +0000"/>
                            <attachment id="12511152" name="TestConnectionPoolTempCleanup.java" size="7795" author="artnaseef" created="Thu, 19 Jan 2012 18:22:21 +0000"/>
                            <attachment id="12490646" name="amqpool.diff" size="3360" author="janstey" created="Wed, 17 Aug 2011 13:11:39 +0000"/>
                            <attachment id="12511150" name="pooledConnCleanupOwnTemps.patch" size="7597" author="artnaseef" created="Thu, 19 Jan 2012 18:12:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14534</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 44 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0aj1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59358</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>