<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:47:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2556] Memory leaks with XA Transactions (case of read-only transactions)</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2556</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Some transaction related information are not released in case of read-only transactions (where not messages have been consumed or produced) by broker and client, that causes an OutOfMemory after running some time.&lt;/p&gt;

&lt;p&gt;Fields that hold these &quot;transaction related information&quot; are (at least) :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;org.apache.activemq.state.ConnectionState.transactions&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;org.apache.activemq.TransactionContext.ENDED_XA_TRANSACTION_CONTEXTS&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;After serach, it seems that the case of read-only XA transactions (that terminates at prepare time) has been missed in some code like :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;org.apache.activemq.broker.TransportConnection&lt;/tt&gt; that puts TransactionState in &lt;tt&gt;org.apache.activemq.state.ConnectionState.transactions&lt;/tt&gt; at the beginning, release them at commit (or rollback) time &lt;b&gt;but not at prepare time where result is &lt;tt&gt;XAResource.XA_RDONLY&lt;/tt&gt;&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;org.apache.activemq.TransactionContext&lt;/tt&gt; that do the same mistake via ENDED_XA_TRANSACTION_CONTEXTS in prepare()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;_Note that the case of read-only transactions seems correctly done by &lt;tt&gt;org.apache.activemq.transaction.XATransaction&lt;/tt&gt; (very interesting comment here &lt;a href=&quot;http://fisheye6.atlassian.com/browse/activemq/trunk/activemq-core/src/main/java/org/apache/activemq/transaction/XATransaction.java?r=809940#l175)_&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://fisheye6.atlassian.com/browse/activemq/trunk/activemq-core/src/main/java/org/apache/activemq/transaction/XATransaction.java?r=809940#l175)_&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;ActiveMQ 5.3.0&lt;br/&gt;
Atomikos Transactions Essentials 3.5.8&lt;br/&gt;
Spring 2.5.6&lt;br/&gt;
Oracle 11g (thin driver version 11.1.0.7.0)&lt;/p&gt;</environment>
        <key id="12483514">AMQ-2556</key>
            <summary>Memory leaks with XA Transactions (case of read-only transactions)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="daniel.santos">Daniel Santos</reporter>
                        <labels>
                    </labels>
                <created>Mon, 4 Jan 2010 14:01:27 +0000</created>
                <updated>Thu, 9 Sep 2010 12:27:35 +0000</updated>
                            <resolved>Thu, 1 Apr 2010 23:27:19 +0000</resolved>
                                    <version>5.1.0</version>
                    <version>5.2.0</version>
                    <version>5.3.0</version>
                                    <fixVersion>5.4.0</fixVersion>
                                    <component>Broker</component>
                    <component>JMS client</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12941963" author="daniel.santos" created="Mon, 4 Jan 2010 14:20:14 +0000"  >&lt;p&gt;TO REPRODUCE :&lt;br/&gt;
1- Launch a broker&lt;br/&gt;
2- Launch this ready to use app (consumer in a XA transaction, implemented as a Spring&apos;s MessageListenner. The config is taken from atomikos &lt;a href=&quot;http://www.atomikos.com/Documentation/SpringIntegration&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.atomikos.com/Documentation/SpringIntegration&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;No producer nor another XAResource is needed to show the problem&lt;/p&gt;

&lt;p&gt;Simply use a debugger, (j)visualvm, jmap/jhat or another memory profiler tool to see grow up indefinitly (at each receiveTimeout unit of time : 3s) the number of TransactionContext instances on client and TransactionState instances on broker&lt;/p&gt;</comment>
                            <comment id="12942076" author="tkrah" created="Wed, 31 Mar 2010 12:42:50 +0000"  >&lt;p&gt;5.3.1 is still affected.&lt;br/&gt;
Using Spring 3.0.1, Atomikos 3.6.0 and Springs Message Listener i can see this too. &lt;br/&gt;
The ActiveMQXASession and ActiveMQTopicSubscriber Instances are growing also until OOM.&lt;/p&gt;

&lt;p&gt;Looking the ActiveMQMessageConsumer in calls to close this is done:&lt;/p&gt;

&lt;p&gt;new Synchronization() {&lt;br/&gt;
                    public void afterCommit() throws Exception &lt;/p&gt;
{
                        doClose();
                    }&lt;br/&gt;
&lt;br/&gt;
                    public void afterRollback() throws Exception {                        doClose();                    }
&lt;p&gt;                });&lt;/p&gt;

&lt;p&gt;But what about not being commited or rollbacked at all in case of XA_RDONLY - doClose will never be called - don&apos;t know if this does matter for this memory leak but it seems inconsistent that resource cleanup is only done fpr commit + rollback.&lt;/p&gt;</comment>
                            <comment id="12942073" author="gtully" created="Thu, 1 Apr 2010 23:27:19 +0000"  >&lt;p&gt;thanks for the great test case, issue resolved on trunk in r930135&lt;br/&gt;
state on the client, broker and failover transport needed to be reclaimed on prepare readonly.&lt;/p&gt;</comment>
                            <comment id="12942673" author="mcarpella" created="Wed, 19 May 2010 09:26:51 +0000"  >&lt;p&gt;Is the fix-version 5.4.0 correct, i.e. fix is not included in 5.3.2?&lt;/p&gt;</comment>
                            <comment id="12942672" author="gtully" created="Wed, 19 May 2010 10:09:11 +0000"  >&lt;p&gt;afraid so, 5.4 will be out by the end of the summer. It was rolled into a &lt;a href=&quot;http://repo.fusesource.com/maven2/org/apache/activemq/apache-activemq/5.3.1-fuse-01-00/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fuse release&lt;/a&gt; so u can get it there in the mean time, if a 5.4-SNAPSHOT does not work for you. &lt;/p&gt;</comment>
                            <comment id="12942737" author="mlayer" created="Thu, 27 May 2010 13:23:48 +0000"  >&lt;p&gt;Even with the fix (r930135), is it not still possible that &lt;tt&gt;TransactionContexts&lt;/tt&gt; remain indefinitely in &lt;tt&gt;TransactionContext.ENDED_XA_TRANSACTION_CONTEXTS&lt;/tt&gt;? &lt;tt&gt;syncSendPacketWithInterruptionHandling&lt;/tt&gt; could throw a &lt;tt&gt;JMSException&lt;/tt&gt; before the context is removed from the Map, if I am not mistaken.&lt;/p&gt;</comment>
                            <comment id="12942888" author="gtully" created="Thu, 9 Sep 2010 12:27:35 +0000"  >&lt;p&gt;marc, think r995397 will resolve the possibility of dangling refs in ENDED_XA_TRANSACTION_CONTEXTS if prepare fails with an exception and rollback is not subsequently called, as it need not be.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461579" name="XAConsumer.zip" size="3414" author="daniel.santos" created="Mon, 4 Jan 2010 14:20:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14817</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 11 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ba6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63762</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>