<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:37:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1244] DatabaseLocker implementation impedes database replication</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1244</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;The current implementation of the JDBC Master/Slave feature makes one broker (the master) acquire a lock on a database object. In Sybase, this has been implemented with the command:&lt;/p&gt;

&lt;p&gt;LOCK TABLE foo IN EXCLUSIVE MODE&lt;/p&gt;

&lt;p&gt;This command can only be executed within a transaction, see:&lt;br/&gt;
&lt;a href=&quot;http://manuals.sybase.com/onlinebooks/group-as/asg1250e/sqlug/@Generic__BookTextView/54552;pt=54651&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://manuals.sybase.com/onlinebooks/group-as/asg1250e/sqlug/@Generic__BookTextView/54552;pt=54651&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This implies that for the whole lifespan of the ActiveMQ-process there is an open transaction in the RDBMS. This is a problem in a professional environment making use of a database replication server: The open transaction impedes that the transaction log in the active database is emptied, then the stable queue at the replication server won&apos;t be purged and will steadily grow up to infinitum. We have been able to observe this behaviour.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Latest ActiveMQ snapshot, Sybase ASE 12.5.x&lt;/p&gt;</environment>
        <key id="12482281">AMQ-1244</key>
            <summary>DatabaseLocker implementation impedes database replication</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="marsangr">Marcos Sanz</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 May 2007 06:33:05 +0000</created>
                <updated>Thu, 19 Jun 2008 22:45:43 +0000</updated>
                            <resolved>Thu, 19 Jun 2008 22:45:43 +0000</resolved>
                                    <version>4.1.1</version>
                                    <fixVersion>5.2.0</fixVersion>
                                    <component>Message Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12936484" author="jstrachan" created="Tue, 12 Jun 2007 08:25:45 +0000"  >&lt;p&gt;A few thoughts. Firstly note that this locking transaction never updates any data and never needs to be replicated.&lt;/p&gt;

&lt;p&gt;Couldn&apos;t the replication server just ignore the lock table? Or we could allow the lock table to be in a different schema (logical database) if that helps?&lt;/p&gt;

&lt;p&gt;There needs to be some table used for locking; as we need to ensure multiple brokers don&apos;t write to the same logical database. Though by all means suggest a suitable workaround that works for you with database replication; would ignoring the table, or moving it to a separate logical database/schema work?&lt;/p&gt;

&lt;p&gt;Worst case scenario; we could use a completely separate database entirely (even a different JDBC provider! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; but I&apos;d rather reuse the same DataSource if we can (it makes things much simpler to code and removes a multitude of possible issues such as folks using a local Derby DB for the lock &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12936334" author="marsangr" created="Tue, 3 Jul 2007 12:00:22 +0000"  >&lt;p&gt;Our DBAs confirm that configuring the replication server to ignore the lock-table is a possible workaround with our system. This might be manufacturer-dependent. Using a lock table in a different logical database (not to be replicated) is another possible solution.&lt;/p&gt;

&lt;p&gt;Wouldn&apos;t it though be easier and much more portable to actually insert a (dummy) row in the lock-table as the inter-broker communication mechanism? This wouldn&apos;t require a transaction to be kept open for the whole lifetime of the broker.&lt;/p&gt;</comment>
                            <comment id="12936378" author="jstrachan" created="Tue, 3 Jul 2007 14:51:51 +0000"  >&lt;p&gt;The idea of keeping the transaction open is to keep a lock; so that if the connection/transaction fails, the broker stops being the master, then all the brokers fight to get the lock again.&lt;/p&gt;

&lt;p&gt;Inserting a row in a database doesn&apos;t really help; if the master dies; how do the slaves know?&lt;/p&gt;

&lt;p&gt;If you can come up with a workable alternative I&apos;m all ears. (Especially if its with &lt;a href=&quot;http://activemq.apache.org/contributing.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a patch&lt;/a&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; but until then, I think the long transaction is the only real alternative we have. &lt;/p&gt;

&lt;p&gt;You could experiement with the SQL (the Statements class)  so that the lock table is named to be in a different logical database; yet using the same DataSource .&lt;/p&gt;</comment>
                            <comment id="12936381" author="marsangr" created="Wed, 4 Jul 2007 08:57:18 +0000"  >&lt;p&gt;I assume that the only communication channel that two brokers have in common is the database. What about leveraging on the usual concept of a heartbeat? Let the Lock-Table have a datetime row and let the active broker update periodically the row with the current (database) time. If the standby broker detects that the row value diverges from the current time more than a delta, then the active broker is stalled/dead. Advantages of this technique:&lt;br/&gt;
a) No transaction kept open for an undetermined time window&lt;br/&gt;
b) To my eyes, this is even more effective in detecting a failure that the current mechanism, for it requires now the active broker to actually undertake an action,and not just remain inactive holding a token.&lt;/p&gt;

&lt;p&gt;Comments?&lt;/p&gt;</comment>
                            <comment id="12939867" author="jasonrtheune" created="Thu, 19 Jun 2008 18:17:54 +0000"  >&lt;p&gt;We have addressed an issue mentioned in &lt;a href=&quot;https://issues.apache.org/jira/browse/TS-1244&quot; title=&quot;Crash report: cores in Arena::reset &quot; class=&quot;issue-link&quot; data-issue-key=&quot;TS-1244&quot;&gt;&lt;del&gt;TS-1244&lt;/del&gt;&lt;/a&gt; with a snippet of code.&lt;br/&gt;
We would like to contribute our fix to the ActiveMQ 5.2 code base for consideration for permanent inclusion.&lt;/p&gt;

&lt;p&gt;This fix has proven out in our customer environment, and our customer is happy with the code.&lt;br/&gt;
We would now like to be sure our fix gets into the main branch so we do not have to patch a one off version with every release.&lt;/p&gt;

&lt;p&gt;Any chance in getting this patch accepted to the community through any channel that works?  &lt;br/&gt;
The fix is fairly simple in that it basically does what James Strachan suggests in the ticket...&lt;br/&gt;
   (i.e., optionally use a different data source for the lock).  &lt;/p&gt;

&lt;p&gt;This code change is submitted by Jason Theune on behalf of Rod Cope.&lt;/p&gt;

&lt;p&gt;Here&apos;s the changed and added code in JDBCPersistenceAdapter.java:&lt;br/&gt;
 ======================================================&lt;br/&gt;
    // Added by Rod Cope of OpenLogic to allow the lock table to&lt;br/&gt;
    // reside in a separate database.  This makes sure that the&lt;br/&gt;
    // main database&apos;s transaction logs don&apos;t fill up because&lt;br/&gt;
    // the ActiveMQ lock transaction never closes.&lt;br/&gt;
    private DataSource lockDataSource;&lt;/p&gt;

&lt;p&gt;    // Modified by Rod Cope of OpenLogic to allow the lock table to&lt;br/&gt;
    // reside in a separate database.  This makes sure that the&lt;br/&gt;
    // main database&apos;s transaction logs don&apos;t fill up because&lt;br/&gt;
    // the ActiveMQ lock transaction never closes. &lt;br/&gt;
    protected DatabaseLocker createDatabaseLocker() throws IOException &lt;/p&gt;
{
        return new DefaultDatabaseLocker(getLockDataSource(), getStatements());
    }


&lt;p&gt;    // Added by Rod Cope of OpenLogic to allow the lock table to&lt;br/&gt;
    // reside in a separate database.  This makes sure that the&lt;br/&gt;
    // main database&apos;s transaction logs don&apos;t fill up because&lt;br/&gt;
    // the ActiveMQ lock transaction never closes.&lt;br/&gt;
    public DataSource getLockDataSource() throws IOException {&lt;br/&gt;
        if (lockDataSource == null) {&lt;br/&gt;
            lockDataSource = getDataSource();&lt;br/&gt;
            if (lockDataSource == null) &lt;/p&gt;
{
                throw new IllegalArgumentException(&quot;No dataSource property has been configured&quot;);
            }
&lt;p&gt;        } else &lt;/p&gt;
{
            LOG.info(&quot;Using a separate dataSource for locking: &quot; + lockDataSource);
        }
&lt;p&gt;        return lockDataSource;&lt;br/&gt;
    }&lt;br/&gt;
    // Added by Rod Cope of OpenLogic to allow the lock table to&lt;br/&gt;
    // reside in a separate database.  This makes sure that the&lt;br/&gt;
    // main database&apos;s transaction logs don&apos;t fill up because&lt;br/&gt;
    // the ActiveMQ lock transaction never closes.&lt;br/&gt;
    public void setLockDataSource(DataSource dataSource) &lt;/p&gt;
{
        this.lockDataSource = dataSource;
    }

&lt;p&gt;Of course, it&apos;s fine if they resolve the issue in some other way that makes sense and/or change any comments.  &lt;br/&gt;
I&apos;d just like to avoid having our customer on a forked version because support efforts would be complicated.&lt;/p&gt;</comment>
                            <comment id="12939846" author="rajdavies" created="Thu, 19 Jun 2008 22:45:43 +0000"  >&lt;p&gt;Fixed by SVN revision 669733&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84578</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 23 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14blz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>233344</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>