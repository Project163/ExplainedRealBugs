<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:03:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4970] Deletion of a queue inaffective across broker restart</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4970</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Deleting a queue, it is revived from persistent store after a broker restart.  The following steps reproduce the problem:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Create a queue (confirmed using the REST client I/F)&lt;/li&gt;
	&lt;li&gt;Shutdown the broker&lt;/li&gt;
	&lt;li&gt;Startup the broker&lt;/li&gt;
	&lt;li&gt;Confirm queue still exists via the hawtio ui (correct operation so far)&lt;/li&gt;
	&lt;li&gt;Delete the queue&lt;/li&gt;
	&lt;li&gt;Confirm queue removed via the hawtio ui&lt;/li&gt;
	&lt;li&gt;Shutdown the broker&lt;/li&gt;
	&lt;li&gt;Startup the broker&lt;/li&gt;
	&lt;li&gt;Confirm queue was not recreated via hawtio ui (failed: queue still exists)&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>&lt;p&gt;mac osx/mavericks&lt;/p&gt;</environment>
        <key id="12689094">AMQ-4970</key>
            <summary>Deletion of a queue inaffective across broker restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="artnaseef">Arthur Naseef</assignee>
                                    <reporter username="artnaseef">Arthur Naseef</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Jan 2014 21:29:18 +0000</created>
                <updated>Wed, 11 Jun 2014 01:22:57 +0000</updated>
                            <resolved>Mon, 20 Jan 2014 15:44:38 +0000</resolved>
                                    <version>5.9.0</version>
                                    <fixVersion>5.9.1</fixVersion>
                    <fixVersion>5.10.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13872637" author="tabish121" created="Wed, 15 Jan 2014 21:39:08 +0000"  >&lt;p&gt;Recommend you create a JUnit test to reproduce.&lt;/p&gt;</comment>
                            <comment id="13872664" author="artnaseef" created="Wed, 15 Jan 2014 22:05:20 +0000"  >&lt;p&gt;Thanks. I am working on it. Any good way to unit test this without actually creating files on disk?  I plan to put files in a subdir of target. &lt;/p&gt;

&lt;p&gt;Sent from my iPhone&lt;/p&gt;
</comment>
                            <comment id="13872672" author="tabish121" created="Wed, 15 Jan 2014 22:09:56 +0000"  >&lt;p&gt;Since you are testing persistence you kind of have to write to disk.  That said there&apos;s a ton of unit tests to work from, I&apos;d recommend you take a peek at QueuePurgeTest.java in activemq-unit-tests&lt;/p&gt;</comment>
                            <comment id="13872677" author="gtully" created="Wed, 15 Jan 2014 22:12:45 +0000"  >&lt;p&gt;@Arthur - there is no problem with creating files in the target dir. that is what most of the store unit tests do. Peek at: org.apache.activemq.store.kahadb.*&lt;/p&gt;</comment>
                            <comment id="13872996" author="artnaseef" created="Thu, 16 Jan 2014 02:52:44 +0000"  >&lt;p&gt;@Timothy Bish - thank you for the reference to QueuePurgeTest.&lt;/p&gt;</comment>
                            <comment id="13872997" author="artnaseef" created="Thu, 16 Jan 2014 02:55:26 +0000"  >&lt;p&gt;AMQ4970Test.zip - Attached  zip file with a self-contained test project.  &quot;mvn test&quot; runs the test.&lt;/p&gt;

&lt;p&gt;I&apos;m not reproducing the failures with this test.  Trying to consider what may be different.  One thing coming to mind is that my earlier test involved running the broker in console mode and using ctrl-c to stop it.&lt;/p&gt;</comment>
                            <comment id="13873004" author="artnaseef" created="Thu, 16 Jan 2014 03:25:32 +0000"  >&lt;p&gt;Looks like the difference is ActiveMQConnection.destroyDestination() versus BrokerView.removeQueue().&lt;/p&gt;</comment>
                            <comment id="13873538" author="artnaseef" created="Thu, 16 Jan 2014 16:06:28 +0000"  >&lt;p&gt;Updated AMQ4970Test.zip so it now tests both the ActiveMQConnection.destroyDestination() and BrokerView.deleteQueue() methods.&lt;/p&gt;

&lt;p&gt;Still not reproducing the problem this way.&lt;/p&gt;

&lt;p&gt;Tried another approach (capturing kahadb snapshots):&lt;/p&gt;

&lt;p&gt;== part 1 ==&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Clear the kahadb&lt;/li&gt;
	&lt;li&gt;Start the broker&lt;/li&gt;
	&lt;li&gt;Create two destinations&lt;/li&gt;
	&lt;li&gt;Stop the broker&lt;/li&gt;
	&lt;li&gt;Take snapshot 1 of the kahadb&lt;/li&gt;
	&lt;li&gt;Start the broker&lt;/li&gt;
	&lt;li&gt;Remove one destination&lt;/li&gt;
	&lt;li&gt;Stop the broker&lt;/li&gt;
	&lt;li&gt;Take snapshot 2 of the kahadb&lt;/li&gt;
	&lt;li&gt;Start the broker&lt;/li&gt;
	&lt;li&gt;Confirm errant operation (removed destination recreated)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;== part 2 ==&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Stop the broker&lt;/li&gt;
	&lt;li&gt;Clear the kahadb&lt;/li&gt;
	&lt;li&gt;Start the broker&lt;/li&gt;
	&lt;li&gt;Create 2 destinations&lt;/li&gt;
	&lt;li&gt;Remove 1 destination&lt;/li&gt;
	&lt;li&gt;Stop the broker&lt;/li&gt;
	&lt;li&gt;Capture snapshot 3 of the kahadb&lt;/li&gt;
	&lt;li&gt;Start the broker&lt;/li&gt;
	&lt;li&gt;Confirm correct operation (destination remains removed)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Comparing Snapshots 2 and 3, there are differences (as expected):&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The db.redo file contains the removed destination name in the errant process path.&lt;/li&gt;
	&lt;li&gt;The db.redo file in the normal path does not contain the removed destination name.&lt;/li&gt;
	&lt;li&gt;And the normal path has a db.free file.&lt;/li&gt;
	&lt;li&gt;The errant path does not.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m wondering if something in the out-of-the-box configs differing from the internal broker in the AMQ4970Test is contributing to the problem.&lt;/p&gt;

&lt;p&gt;Any ideas would be welcome.&lt;/p&gt;</comment>
                            <comment id="13874414" author="artnaseef" created="Fri, 17 Jan 2014 04:13:19 +0000"  >&lt;p&gt;Trying the exact same config with leveldb, the problem does not happen.&lt;/p&gt;</comment>
                            <comment id="13874446" author="artnaseef" created="Fri, 17 Jan 2014 05:15:55 +0000"  >&lt;p&gt;This is interesting - turned on DEBUG logging on org.apache.activemq.broker.region and found this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2014-01-16 22:10:18,028 | DEBUG | localhost removing destination: queue://TEST2 | org.apache.activemq.broker.region.AbstractRegion | ActiveMQ Transport: tcp:///127.0.0.1:49946@61616
2014-01-16 22:10:18,033 | DEBUG | localhost adding destination: topic://ActiveMQ.Advisory.Queue | org.apache.activemq.broker.region.AbstractRegion | ActiveMQ Transport: tcp:///127.0.0.1:49946@61616
2014-01-16 22:10:18,044 | DEBUG | localhost removing consumer: ID:Arthur-Naseefs-MacBook-Pro.local-49945-1389935417793-1:1:-1:1 for destination: ActiveMQ.Advisory.TempQueue,ActiveMQ.Advisory.TempTopic | org.apache.activemq.broker.region.AbstractRegion | ActiveMQ Transport: tcp:///127.0.0.1:49946@61616
2014-01-16 22:10:38,199 | DEBUG | queue://TEST2 expiring messages .. | org.apache.activemq.broker.region.Queue | ActiveMQ Broker[localhost] Scheduler
2014-01-16 22:10:38,201 | DEBUG | TEST2 toPageIn: 0, Inflight: 0, pagedInMessages.size 0, enqueueCount: 0, dequeueCount: 0 | org.apache.activemq.broker.region.Queue | ActiveMQ Broker[localhost] Scheduler
2014-01-16 22:10:38,203 | DEBUG | queue://TEST2 expiring messages done. | org.apache.activemq.broker.region.Queue | ActiveMQ Broker[localhost] Scheduler
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Watching the contents of the db.redo file, I see the destination name removed, and then return.&lt;/p&gt;</comment>
                            <comment id="13874456" author="artnaseef" created="Fri, 17 Jan 2014 05:35:53 +0000"  >&lt;p&gt;The GC of the destination appears to be the missing link.  Adding a Thread.sleep(60000) to the test causes 100% failure - of both forms of deletion.&lt;/p&gt;</comment>
                            <comment id="13874864" author="artnaseef" created="Fri, 17 Jan 2014 15:26:57 +0000"  >&lt;p&gt;Attaching updated test project - this one fails 100% of the time with a 2 second delay added to the process.&lt;/p&gt;

&lt;p&gt;Message expiration is causing revival of the destination.&lt;/p&gt;</comment>
                            <comment id="13874873" author="gtully" created="Fri, 17 Jan 2014 15:32:36 +0000"  >&lt;p&gt;great work tracking this down. How does the expiration thread/task have a reference to a deleted destination? Must still be suck in some list or there is a race between the start of the task execution and the removal.&lt;/p&gt;</comment>
                            <comment id="13875177" author="tabish121" created="Fri, 17 Jan 2014 19:40:22 +0000"  >&lt;p&gt;Tried the test using trunk code, could not reproduce after quite a few runs.  &lt;/p&gt;</comment>
                            <comment id="13875232" author="artnaseef" created="Fri, 17 Jan 2014 20:26:54 +0000"  >&lt;p&gt;Huh, that&apos;s interesting Timothy.  I wonder what&apos;s different.  I&apos;m working with a version of the trunk that can&apos;t be more than a couple of weeks old.  I&apos;m running this on a mac.  I think jdk 1.7 - need to verify.&lt;/p&gt;

&lt;p&gt;With a little debug logging, I see that the task for expiring messages continues to be called even though the cancel method is called on the scheduler for the task.  I haven&apos;t had a chance to do any more than that today due to other priorities.&lt;/p&gt;</comment>
                            <comment id="13875480" author="artnaseef" created="Sat, 18 Jan 2014 01:39:09 +0000"  >&lt;p&gt;Hmm:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG | localhost adding destination: queue://TEST1
 INFO | TBD ASN: scheduling queue://TEST1
DEBUG | TEST1 toPageIn: 0, Inflight: 0, pagedInMessages.size 0, enqueueCount: 0, dequeueCount: 0
 INFO | TBD ASN: scheduling queue://TEST1
DEBUG | TEST1 toPageIn: 0, Inflight: 0, pagedInMessages.size 0, enqueueCount: 0, dequeueCount: 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Two of these tasks are being scheduled?  Next check - is it one Queue instance or two?&lt;/p&gt;</comment>
                            <comment id="13875540" author="artnaseef" created="Sat, 18 Jan 2014 04:17:24 +0000"  >&lt;p&gt;Two starts of the queue.  FIRST STACK is the trace on the first call to &lt;tt&gt;Queue.start&lt;/tt&gt; and the SECOND is, well, the second.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2014-01-17 21:15:07,071 ERROR [main] org.apache.activemq.broker.region.Queue - TBD ASN XXX: first start
java.lang.Exception: FIRST STACK
	at org.apache.activemq.broker.region.Queue.start(Queue.java:1008)
	at org.apache.activemq.broker.region.AbstractRegion.addDestination(AbstractRegion.java:140)
	at org.apache.activemq.broker.region.RegionBroker.addDestination(RegionBroker.java:321)
	at org.apache.activemq.broker.BrokerFilter.addDestination(BrokerFilter.java:167)
	at org.apache.activemq.advisory.AdvisoryBroker.addDestination(AdvisoryBroker.java:169)
	at org.apache.activemq.broker.BrokerFilter.addDestination(BrokerFilter.java:167)
	at org.apache.activemq.broker.BrokerFilter.addDestination(BrokerFilter.java:167)
	at org.apache.activemq.broker.MutableBrokerFilter.addDestination(MutableBrokerFilter.java:172)
	at org.apache.activemq.broker.region.AbstractRegion.start(AbstractRegion.java:98)
	at org.apache.activemq.broker.region.RegionBroker.start(RegionBroker.java:190)
	at org.apache.activemq.broker.jmx.ManagedRegionBroker.start(ManagedRegionBroker.java:120)
	at org.apache.activemq.broker.BrokerFilter.start(BrokerFilter.java:182)
	at org.apache.activemq.broker.BrokerFilter.start(BrokerFilter.java:182)
	at org.apache.activemq.broker.TransactionBroker.start(TransactionBroker.java:120)
	at org.apache.activemq.broker.BrokerService$5.start(BrokerService.java:2150)
	at org.apache.activemq.broker.BrokerService.doStartBroker(BrokerService.java:648)
	at org.apache.activemq.broker.BrokerService.startBroker(BrokerService.java:632)
	at org.apache.activemq.broker.BrokerService.start(BrokerService.java:568)
	at org.apache.activemq.AMQ4970Test.setupBroker(AMQ4970Test.java:90)
	at org.apache.activemq.AMQ4970Test.restartBroker(AMQ4970Test.java:221)
	at org.apache.activemq.AMQ4970Test.runOneTestQueueRemoval(AMQ4970Test.java:184)
	at org.apache.activemq.AMQ4970Test.testQueueDeletionViaBrokerViewRemoveQueueInKahaDBStore(AMQ4970Test.java:128)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:31)
	at org.junit.runners.BlockJUnit4ClassRunner.runNotIgnored(BlockJUnit4ClassRunner.java:79)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:71)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:49)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:193)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:52)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:191)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:42)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:184)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:236)
	at org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:252)
	at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:141)
	at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:112)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.apache.maven.surefire.util.ReflectionUtils.invokeMethodWithArray(ReflectionUtils.java:189)
	at org.apache.maven.surefire.booter.ProviderFactory$ProviderProxy.invoke(ProviderFactory.java:165)
	at org.apache.maven.surefire.booter.ProviderFactory.invokeProvider(ProviderFactory.java:85)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:115)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:75)
2014-01-17 21:15:07,074 ERROR [main] org.apache.activemq.broker.region.Queue - TBD ASN XXX: second start
java.lang.Exception: SECOND STACK
	at org.apache.activemq.broker.region.Queue.start(Queue.java:1005)
	at org.apache.activemq.broker.region.AbstractRegion.start(AbstractRegion.java:104)
	at org.apache.activemq.broker.region.RegionBroker.start(RegionBroker.java:190)
	at org.apache.activemq.broker.jmx.ManagedRegionBroker.start(ManagedRegionBroker.java:120)
	at org.apache.activemq.broker.BrokerFilter.start(BrokerFilter.java:182)
	at org.apache.activemq.broker.BrokerFilter.start(BrokerFilter.java:182)
	at org.apache.activemq.broker.TransactionBroker.start(TransactionBroker.java:120)
	at org.apache.activemq.broker.BrokerService$5.start(BrokerService.java:2150)
	at org.apache.activemq.broker.BrokerService.doStartBroker(BrokerService.java:648)
	at org.apache.activemq.broker.BrokerService.startBroker(BrokerService.java:632)
	at org.apache.activemq.broker.BrokerService.start(BrokerService.java:568)
	at org.apache.activemq.AMQ4970Test.setupBroker(AMQ4970Test.java:90)
	at org.apache.activemq.AMQ4970Test.restartBroker(AMQ4970Test.java:221)
	at org.apache.activemq.AMQ4970Test.runOneTestQueueRemoval(AMQ4970Test.java:184)
	at org.apache.activemq.AMQ4970Test.testQueueDeletionViaBrokerViewRemoveQueueInKahaDBStore(AMQ4970Test.java:128)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:31)
	at org.junit.runners.BlockJUnit4ClassRunner.runNotIgnored(BlockJUnit4ClassRunner.java:79)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:71)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:49)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:193)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:52)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:191)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:42)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:184)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:236)
	at org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:252)
	at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:141)
	at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:112)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.apache.maven.surefire.util.ReflectionUtils.invokeMethodWithArray(ReflectionUtils.java:189)
	at org.apache.maven.surefire.booter.ProviderFactory$ProviderProxy.invoke(ProviderFactory.java:165)
	at org.apache.maven.surefire.booter.ProviderFactory.invokeProvider(ProviderFactory.java:85)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:115)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:75)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13875543" author="artnaseef" created="Sat, 18 Jan 2014 04:49:06 +0000"  >&lt;p&gt;Thanks for the input Gary (sorry I missed it earlier).&lt;/p&gt;</comment>
                            <comment id="13875562" author="artnaseef" created="Sat, 18 Jan 2014 06:07:25 +0000"  >&lt;p&gt;Last of the small updates.&lt;/p&gt;

&lt;p&gt;After pulling down the head and testing, the test passes.  I&apos;m trying to track down the change that appears to fix the problem to understand why it makes the test pass - in case it doesn&apos;t truly fix the root cause.&lt;/p&gt;</comment>
                            <comment id="13875800" author="artnaseef" created="Sun, 19 Jan 2014 03:36:26 +0000"  >&lt;p&gt;Here&apos;s the finding:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The issue is caused, at least in part, by redundant starts of the Queue (i.e. two calls to Queue.start)&lt;/li&gt;
	&lt;li&gt;On the head, this still happens&lt;/li&gt;
	&lt;li&gt;On the older code, the redundant start causes redundant exipred-message scheduling which appears to cause the Queue to revive after a removeDestination
	&lt;ul&gt;
		&lt;li&gt;The revival only takes affect on broker restart&lt;/li&gt;
		&lt;li&gt;So, the kahadb remembers the destination, but it doesn&apos;t revive in broker memory&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;On the head, the redundant start doesn&apos;t lead to the revival; not sure why.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I recommend protecting against redundant starts by adding a flag and check to the Queue - using encapsulation to have the Queue keep itself robust.  Even without the queue revival, redundant starts of the Queue can only lead to problems (such as a scheduler task leak).  I&apos;ll submit a patch. &lt;/p&gt;</comment>
                            <comment id="13875834" author="artnaseef" created="Sun, 19 Jan 2014 07:01:15 +0000"  >&lt;p&gt;Attaching a patch that prevents duplicate starts and stops of a single org.apache.broker.region.Queue.  Failures during startup or shutdown of the Queue are ignored, so the results will be the same as they were before.&lt;/p&gt;</comment>
                            <comment id="13876527" author="tabish121" created="Mon, 20 Jan 2014 15:44:38 +0000"  >&lt;p&gt;Fixed on trunk. &lt;/p&gt;</comment>
                            <comment id="13877188" author="jahlborn" created="Tue, 21 Jan 2014 04:49:36 +0000"  >&lt;p&gt;Hey Arthur,&lt;br/&gt;
thanks for tracking this down and figuring out how to fix it.  just curious, though, should there be a similar fix applied to Topic.java as well?&lt;/p&gt;</comment>
                            <comment id="13879017" author="jahlborn" created="Wed, 22 Jan 2014 19:01:58 +0000"  >&lt;p&gt;Actually, i may have figured this out myself.  topics don&apos;t seem to be reloaded at startup like queues.&lt;/p&gt;</comment>
                            <comment id="13879168" author="artnaseef" created="Wed, 22 Jan 2014 20:54:12 +0000"  >&lt;p&gt;I think it&apos;s worth adding the protection - the extra processing only adds an infrequent operation that can only prevent problems.&lt;/p&gt;</comment>
                            <comment id="14027309" author="artnaseef" created="Wed, 11 Jun 2014 01:22:57 +0000"  >&lt;p&gt;Fix revision: &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=f7cbe9fa173f1f3cf91d016ed340f90a2bd61242&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=f7cbe9fa173f1f3cf91d016ed340f90a2bd61242&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12623668" name="AMQ4970Test.zip" size="7514" author="artnaseef" created="Fri, 17 Jan 2014 15:26:57 +0000"/>
                            <attachment id="12623409" name="AMQ4970Test.zip" size="4924" author="artnaseef" created="Thu, 16 Jan 2014 16:06:28 +0000"/>
                            <attachment id="12623300" name="AMQ4970Test.zip" size="4263" author="artnaseef" created="Thu, 16 Jan 2014 02:55:26 +0000"/>
                            <attachment id="12623852" name="amq4970.patch" size="1696" author="artnaseef" created="Sun, 19 Jan 2014 07:01:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>368061</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 24 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1rfvj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>368367</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>