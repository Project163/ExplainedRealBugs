<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:36:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1509] Duplicate topic messages received with network of brokers and selectors</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1509</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;If you create a network of two brokers, A and B, one publisher publishing to A, and n (where n is &amp;gt; 1) receivers with selectors, each receiver recieves n messages for every 1 message sent.  The key here is to have a selector.   It would appear that the conduitSubscriptions flag does not work when using selectors.  The conduit does not properly reconcile consumers if they have selectors.  A suggested soltuion would be that ather than process each selector independantly, each selector should be or&apos;ed together and if any selector results in true then a single message should be sent to the other broker.&lt;/p&gt;

&lt;p&gt;In doing research, it would appear that this problem was introduced with bug fix &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-810&quot; title=&quot;When using Topics with consumers with selectors over a network of brokers, only the first consumer gets messages delivered.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-810&quot;&gt;&lt;del&gt;AMQ-810&lt;/del&gt;&lt;/a&gt;.  Another user reported it via email back to the assignee of &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-810&quot; title=&quot;When using Topics with consumers with selectors over a network of brokers, only the first consumer gets messages delivered.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-810&quot;&gt;&lt;del&gt;AMQ-810&lt;/del&gt;&lt;/a&gt; and a short dialog transpired.  See &lt;a href=&quot;http://www.mail-archive.com/activemq-users@geronimo.apache.org/msg05198.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/activemq-users@geronimo.apache.org/msg05198.html&lt;/a&gt;.  &lt;/p&gt;
</description>
                <environment></environment>
        <key id="12482544">AMQ-1509</key>
            <summary>Duplicate topic messages received with network of brokers and selectors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="hoorner">Howard Orner</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 Nov 2007 17:59:06 +0000</created>
                <updated>Wed, 9 Nov 2011 11:59:52 +0000</updated>
                            <resolved>Thu, 19 Feb 2009 09:14:27 +0000</resolved>
                                    <version>4.1.1</version>
                                    <fixVersion>5.3.0</fixVersion>
                                    <component>Broker</component>
                    <component>Transport</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12937721" author="hoorner" created="Fri, 11 Jan 2008 02:18:43 +0000"  >&lt;p&gt;I do not see any subversion commits listed nor do I see code changes in files I would have expected to change on the main subversion trunk.  Is there a way to get the code changes associated with this resolution?   Thanks!&lt;/p&gt;
</comment>
                            <comment id="12939308" author="vuinguyen" created="Wed, 16 Jan 2008 19:53:20 +0000"  >&lt;p&gt;Hello Rob. I have been assigned to fix this bug for a version of activemq at work. Since we need this fix fairly soon and it would be a shame to have to reinvent the wheel, I&apos;d really appreciate it if you could share your solution to this bug. I&apos;m actually working on this task for Howard Orner, who submitted the previous comments. Thanks.&lt;/p&gt;</comment>
                            <comment id="12939542" author="gtoff" created="Thu, 24 Apr 2008 14:57:42 +0000"  >&lt;p&gt;Hi all,&lt;/p&gt;

&lt;p&gt;I&apos;m also wondering how to get to the patch for this issue, it seems it&apos;s not included in the RC4 release of 5.1.0 as I can still reproduce it using 4 brokers.&lt;br/&gt;
Did anybody manage to solve the problem?&lt;/p&gt;

&lt;p&gt;Thank you.&lt;/p&gt;</comment>
                            <comment id="12939616" author="hoorner" created="Fri, 25 Apr 2008 23:58:42 +0000"  >&lt;p&gt;Here&apos;s a description of how to fix it.  Sorry, I don&apos;t have the source available to me right now to upload it, but it&apos;s pretty straight forward.  I&apos;m also doing this from memory so you may have to look at the code a bit and make sure I&apos;m not missing anything.&lt;/p&gt;

&lt;p&gt;The ideal solution would actually apply an &apos;or&apos; of all selectors before forwarding message between brokers.  However that appears very difficult to do because of all the classes involved and the fact that the selector is parsed and cached where its used in other places.  So instead, the org.apache.activemq.network.ConduitBridge and DurableConduitBridge were modified to change all incoming subscription selectors to null before adding the subscription to the list of interested consumers.  This results in excess network traffic because all messages get forwarded regardless of whether the &apos;other&apos; brokers will actually deliver them after they apply individual selectors.  But it works.&lt;/p&gt;

&lt;p&gt;In ConduitBridge.addToAlreadyInterestedConsumers() remove the lines that check for a selector.  Then put in a line that sets the selector to null before doCreateDemandSubscrition is called in createDemandSubcription.  Do basically the same in DurableConduitBridge.&lt;/p&gt;

&lt;p&gt;Rob - If this hasn&apos;t really been fixed (it appears not to be), I and I&apos;m sure others would appreciate it if you would incorporate this into the code.  It would be better to take my original suggestion of &apos;or&apos;ing selectors together, but that looks like a lot of code changes, so this at least fixes the bug with just a few lines of code.  &lt;/p&gt;

</comment>
                            <comment id="12939526" author="gtoff" created="Sat, 26 Apr 2008 15:53:14 +0000"  >&lt;p&gt;Thank you Howard.&lt;/p&gt;

&lt;p&gt;I&apos;m afraid the temporary fix you propose wouldn&apos;t be of much use in my case. I am currently working at comparing how well our in-house distributed pub/sub solution routes packets  with respect to ActiveMQ on a generic network of brokers: if I implement the temporary fix ActiveMQ performance wouldn&apos;t probably be as good as it should invalidating my test. I guess I&apos;ll have to find another MOM for the experiments while ActiveMQ gets fixed. Did any of you ever use any other JMS implementation supporting generic (cyclic) networks of brokers? &lt;/p&gt;

&lt;p&gt;Using pub/sub on networks of brokers must not be so common after all, I would have expected this bug to receive much more comments.&lt;/p&gt;

&lt;p&gt;Thank you again.&lt;/p&gt;</comment>
                            <comment id="12939571" author="rajdavies" created="Tue, 29 Apr 2008 10:55:12 +0000"  >&lt;p&gt;Yep - not fixed&lt;/p&gt;</comment>
                            <comment id="12939626" author="rajdavies" created="Wed, 30 Apr 2008 06:25:34 +0000"  >&lt;p&gt;The only &apos;safe&apos; way to do this is the simple fix suggested by Howard. If we try and OR selectors together - we have to deal with the timing around updating  that selector state - and this could be prone to some difficult to track down timing issues.&lt;/p&gt;

&lt;p&gt;If you want to shape the traffic across networks, the best way would be to use destinations, wilcards and network filters.&lt;/p&gt;</comment>
                            <comment id="12939710" author="gtoff" created="Fri, 23 May 2008 13:21:57 +0000"  >&lt;p&gt;Hi Rob,&lt;/p&gt;

&lt;p&gt;I saw you committed the changes to fix issue &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1509&quot; title=&quot;Duplicate topic messages received with network of brokers and selectors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1509&quot;&gt;&lt;del&gt;AMQ-1509&lt;/del&gt;&lt;/a&gt;. I downloaded the latest svn snapshot on may the 8th and tested it  on the (for me usual) 4-nodes-in-a-cycle topology. It seems your patch improves the whole thing as now my test runs end nicely (before the duplication was so massive clients were not able to finish their workload), alas, my clients keep receiving duplicate messages.&lt;/p&gt;

&lt;p&gt;I will attach the code of my clients for completeness, either there&apos;s something wrong with them or the bug is still there for bigger cyclic topologies. &lt;/p&gt;</comment>
                            <comment id="12939688" author="gtoff" created="Fri, 23 May 2008 13:23:23 +0000"  >&lt;p&gt;This are the clients I use to reproduce the bug on cyclic topologies.&lt;/p&gt;</comment>
                            <comment id="12940779" author="dejanb" created="Thu, 19 Feb 2009 09:14:27 +0000"  >&lt;p&gt;We did some refactoring in this area for another issue, but this generally should be working.&lt;/p&gt;

&lt;p&gt;Here&apos;s the test case that tries to reproduce the problem (org.apache.activemq.usecases.ThreeBrokerQueueNetworkTest)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testABandBCbrokerNetworkWithSelectors() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-comment&quot;&gt;// Setup broker networks
&lt;/span&gt;        bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerB&quot;&lt;/span&gt;, dynamicOnly, 2, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerB&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, dynamicOnly, 2, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);

        startAllBrokers();

        &lt;span class=&quot;code-comment&quot;&gt;// Setup destination
&lt;/span&gt;        Destination dest = createDestination(&lt;span class=&quot;code-quote&quot;&gt;&quot;TEST.FOO&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);

        &lt;span class=&quot;code-comment&quot;&gt;// Setup consumers
&lt;/span&gt;        MessageConsumer clientA = createConsumer(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, dest, &lt;span class=&quot;code-quote&quot;&gt;&quot;dummy = 33&quot;&lt;/span&gt;);
        MessageConsumer clientB = createConsumer(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, dest, &lt;span class=&quot;code-quote&quot;&gt;&quot;dummy &amp;gt; 30&quot;&lt;/span&gt;);
        MessageConsumer clientC = createConsumer(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, dest, &lt;span class=&quot;code-quote&quot;&gt;&quot;dummy = 34&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-comment&quot;&gt;// let consumers propogate around the network
&lt;/span&gt;        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(2000);
        &lt;span class=&quot;code-comment&quot;&gt;// Send messages
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// Send messages &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; broker A
&lt;/span&gt;        HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; props = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt;();
        props.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;dummy&quot;&lt;/span&gt;, 33);
        sendMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, dest, MESSAGE_COUNT, props);
        props.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;dummy&quot;&lt;/span&gt;, 34);
        sendMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, dest, MESSAGE_COUNT * 2, props);

        &lt;span class=&quot;code-comment&quot;&gt;// Get message count
&lt;/span&gt;        MessageIdList msgsA = getConsumerMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, clientA);
        MessageIdList msgsB = getConsumerMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, clientB);
        MessageIdList msgsC = getConsumerMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, clientC);

        msgsA.waitForMessagesToArrive(MESSAGE_COUNT);
        msgsB.waitForMessagesToArrive(MESSAGE_COUNT * 3);
        msgsC.waitForMessagesToArrive(MESSAGE_COUNT * 2) ;

        assertEquals(MESSAGE_COUNT, msgsA.getMessageCount());
        assertEquals(MESSAGE_COUNT * 3, msgsB.getMessageCount());
        assertEquals(MESSAGE_COUNT *2, msgsC.getMessageCount());
    }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you find it still not working, please submit the test case similar to the one above&lt;/p&gt;</comment>
                            <comment id="13146959" author="gtoff" created="Wed, 9 Nov 2011 11:50:38 +0000"  >&lt;p&gt;Hi Dejan,&lt;/p&gt;

&lt;p&gt;just by chance I started looking again at this issue. I don&apos;t think the problem is fixed: as soon as there are more than one ( at least 2 hops ) paths between brokers message duplication occurs.&lt;/p&gt;

&lt;p&gt;Here&apos;s a little example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;FourBrokerTopicNetworkTest&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;FourBrokerTopicNetworkTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; JmsMultipleBrokersTestSupport &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; MessageListener {
	&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; MESSAGE_COUNT = 5;
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; dynamicOnly;

	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void initCombosForTestABandBCbrokerNetworkWithSelectors() {
		addCombinationValues(&lt;span class=&quot;code-quote&quot;&gt;&quot;dynamicOnly&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] { &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; });
	}

	/**
	 * A simple square topology BrokerA &amp;lt;-&amp;gt; BrokerB BrokerA &amp;lt;-&amp;gt; BrokerC BrokerB
	 * &amp;lt;-&amp;gt; BrokerD BrokerD &amp;lt;-&amp;gt; BrokerC
	 * 
	 */
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testSquareConnectedBrokerNetwork2() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; networkTTL = 2;
		&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; conduitSubs = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
		&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; dynamicOnly = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

		&lt;span class=&quot;code-comment&quot;&gt;// Setup broker networks
&lt;/span&gt;		bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerB&quot;&lt;/span&gt;, dynamicOnly, networkTTL,
				conduitSubs);
		bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerB&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, dynamicOnly, networkTTL,
				conduitSubs);
		bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, dynamicOnly, networkTTL,
				conduitSubs);
		bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, dynamicOnly, networkTTL,
				conduitSubs);

		bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerD&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, dynamicOnly, networkTTL,
				conduitSubs);
		bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerD&quot;&lt;/span&gt;, dynamicOnly, networkTTL,
				conduitSubs);
		bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerD&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerB&quot;&lt;/span&gt;, dynamicOnly, networkTTL,
				conduitSubs);
		bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerB&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerD&quot;&lt;/span&gt;, dynamicOnly, networkTTL,
				conduitSubs);

		startAllBrokers();

		&lt;span class=&quot;code-comment&quot;&gt;// Setup destination
&lt;/span&gt;		Destination dest = createDestination(&lt;span class=&quot;code-quote&quot;&gt;&quot;TEST.FOO&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);

		&lt;span class=&quot;code-comment&quot;&gt;// Setup consumers
&lt;/span&gt;		MessageConsumer clientA = createConsumer(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, dest, &lt;span class=&quot;code-quote&quot;&gt;&quot;msgId &amp;gt; 0&quot;&lt;/span&gt;);
		MessageConsumer clientB = createConsumer(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerB&quot;&lt;/span&gt;, dest, &lt;span class=&quot;code-quote&quot;&gt;&quot;msgId &amp;gt; 0&quot;&lt;/span&gt;);
		MessageConsumer clientC = createConsumer(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, dest, &lt;span class=&quot;code-quote&quot;&gt;&quot;msgId &amp;gt; 0&quot;&lt;/span&gt;);
		MessageConsumer clientD = createConsumer(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerD&quot;&lt;/span&gt;, dest, &lt;span class=&quot;code-quote&quot;&gt;&quot;msgId &amp;gt; 0&quot;&lt;/span&gt;);
		&lt;span class=&quot;code-comment&quot;&gt;// let consumers propogate around the network
&lt;/span&gt;		&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(5000);
		
		clientD.setMessageListener(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);

		&lt;span class=&quot;code-comment&quot;&gt;// Send messages
&lt;/span&gt;		&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] brokers = { &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerB&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerD&quot;&lt;/span&gt; };
		HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; props = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt;();
		&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; broker : brokers) {
			props.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;sender&quot;&lt;/span&gt;, broker);
			&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 1; i &amp;lt;= MESSAGE_COUNT; i++) {
				props.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;msgId&quot;&lt;/span&gt;, i);
				sendMessages(broker, dest, 1, props);
			}
		}

		&lt;span class=&quot;code-comment&quot;&gt;// Get message count
&lt;/span&gt;		MessageIdList msgsA = getConsumerMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, clientA);
		MessageIdList msgsB = getConsumerMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerB&quot;&lt;/span&gt;, clientB);
		MessageIdList msgsC = getConsumerMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, clientC);
		MessageIdList msgsD = getConsumerMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerD&quot;&lt;/span&gt;, clientD);

		msgsA.waitForMessagesToArrive(MESSAGE_COUNT * 4);
		msgsB.waitForMessagesToArrive(MESSAGE_COUNT * 4);
		msgsC.waitForMessagesToArrive(MESSAGE_COUNT * 4);
		msgsD.waitForMessagesToArrive(MESSAGE_COUNT * 4);
		
		&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(msgsA.toString());

		assertEquals(MESSAGE_COUNT * 4, msgsA.getMessageCount());
		assertEquals(MESSAGE_COUNT * 4, msgsB.getMessageCount());
		assertEquals(MESSAGE_COUNT * 4, msgsC.getMessageCount());
		assertEquals(MESSAGE_COUNT * 4, msgsD.getMessageCount());
	}

	/**
	 * A simple square topology BrokerA &amp;lt;-&amp;gt; BrokerB BrokerA &amp;lt;-&amp;gt; BrokerC BrokerB
	 * &amp;lt;-&amp;gt; BrokerD BrokerD &amp;lt;-&amp;gt; BrokerC
	 * 
	 */
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testSquareConnectedBrokerNetwork() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; networkTTL = 2;
		&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; conduitSubs = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
		&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; dynamicOnly = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

		&lt;span class=&quot;code-comment&quot;&gt;// Setup broker networks
&lt;/span&gt;		bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerB&quot;&lt;/span&gt;, dynamicOnly, networkTTL,
				conduitSubs);
		bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerB&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, dynamicOnly, networkTTL,
				conduitSubs);
		bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, dynamicOnly, networkTTL,
				conduitSubs);
		bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, dynamicOnly, networkTTL,
				conduitSubs);

		bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerD&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, dynamicOnly, networkTTL,
				conduitSubs);
		bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerD&quot;&lt;/span&gt;, dynamicOnly, networkTTL,
				conduitSubs);
		bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerD&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerB&quot;&lt;/span&gt;, dynamicOnly, networkTTL,
				conduitSubs);
		bridgeBrokers(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerB&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerD&quot;&lt;/span&gt;, dynamicOnly, networkTTL,
				conduitSubs);

		startAllBrokers();

		&lt;span class=&quot;code-comment&quot;&gt;// Setup destination
&lt;/span&gt;		Destination dest = createDestination(&lt;span class=&quot;code-quote&quot;&gt;&quot;TEST.FOO&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);

		&lt;span class=&quot;code-comment&quot;&gt;// Setup consumers
&lt;/span&gt;		MessageConsumer clientA = createConsumer(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, dest);
		MessageConsumer clientB = createConsumer(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerB&quot;&lt;/span&gt;, dest);
		MessageConsumer clientC = createConsumer(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, dest);
		MessageConsumer clientD = createConsumer(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerD&quot;&lt;/span&gt;, dest);
		&lt;span class=&quot;code-comment&quot;&gt;// let consumers propogate around the network
&lt;/span&gt;		&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(5000);

		&lt;span class=&quot;code-comment&quot;&gt;// Send messages
&lt;/span&gt;		sendMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, dest, MESSAGE_COUNT);
		sendMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerB&quot;&lt;/span&gt;, dest, MESSAGE_COUNT);
		sendMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, dest, MESSAGE_COUNT);
		sendMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerD&quot;&lt;/span&gt;, dest, MESSAGE_COUNT);

		&lt;span class=&quot;code-comment&quot;&gt;// Get message count
&lt;/span&gt;		MessageIdList msgsA = getConsumerMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerA&quot;&lt;/span&gt;, clientA);
		MessageIdList msgsB = getConsumerMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerB&quot;&lt;/span&gt;, clientB);
		MessageIdList msgsC = getConsumerMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerC&quot;&lt;/span&gt;, clientC);
		MessageIdList msgsD = getConsumerMessages(&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerD&quot;&lt;/span&gt;, clientD);

		msgsA.waitForMessagesToArrive(MESSAGE_COUNT * 4);
		msgsB.waitForMessagesToArrive(MESSAGE_COUNT * 4);
		msgsC.waitForMessagesToArrive(MESSAGE_COUNT * 4);
		msgsD.waitForMessagesToArrive(MESSAGE_COUNT * 4);

		assertEquals(MESSAGE_COUNT * 4, msgsA.getMessageCount());
		assertEquals(MESSAGE_COUNT * 4, msgsB.getMessageCount());
		assertEquals(MESSAGE_COUNT * 4, msgsC.getMessageCount());
		assertEquals(MESSAGE_COUNT * 4, msgsD.getMessageCount());
	}

	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setUp() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		&lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.setAutoFail(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
		&lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.setUp();
		&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; options = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;?persistent=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&amp;amp;useJmx=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;);
		createBroker(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URI(&lt;span class=&quot;code-quote&quot;&gt;&quot;broker:(tcp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:61616)/BrokerA&quot;&lt;/span&gt; + options));
&lt;/span&gt;		createBroker(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URI(&lt;span class=&quot;code-quote&quot;&gt;&quot;broker:(tcp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:61617)/BrokerB&quot;&lt;/span&gt; + options));
&lt;/span&gt;		createBroker(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URI(&lt;span class=&quot;code-quote&quot;&gt;&quot;broker:(tcp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:61618)/BrokerC&quot;&lt;/span&gt; + options));
&lt;/span&gt;		createBroker(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URI(&lt;span class=&quot;code-quote&quot;&gt;&quot;broker:(tcp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:61619)/BrokerD&quot;&lt;/span&gt; + options));
&lt;/span&gt;	}

	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Test suite() {
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; suite(FourBrokerTopicNetworkTest.class);
	}

	@Override
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onMessage(Message message) {
		&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
			&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(message.getStringProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;sender&quot;&lt;/span&gt;) + &lt;span class=&quot;code-quote&quot;&gt;&quot; msgID:&quot;&lt;/span&gt; + message.getIntProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;msgId&quot;&lt;/span&gt;) );
		} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (JMSException e) {
			&lt;span class=&quot;code-comment&quot;&gt;// TODO Auto-generated &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; block
&lt;/span&gt;			e.printStackTrace();
		}
		
	}
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I don&apos;t know if there&apos;s anything wrong with this test, or if I should use different configurations of TTL, conduit, and dynamicOnly. I tested it with the latest AMQ I could get (5.5.1).&lt;/p&gt;

&lt;p&gt;As you can see delivered messages are more than 20, they are 25. The reason behind it can be seen in the testSquareConnectedBrokerNetwork2 method: clientD will print all messages coming from BrokerA twice as they are forwarded by both BrokerB and BrokerC on two different paths.&lt;br/&gt;
And of course this is a major problem whenever a broker network has multiple paths as message duplication becomes so severe that it basically kills the whole thing.&lt;/p&gt;

&lt;p&gt;Please let me know if the test is correct as I&apos;d like to have some more insight about why this is happening. Also my colleagues and I have some ideas about the correct way to fix it.&lt;/p&gt;

&lt;p&gt;Regards,&lt;/p&gt;

&lt;p&gt;g&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="12530867">AMQ-3582</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12461031" name="ActiveMQActor.java" size="10715" author="gtoff" created="Fri, 23 May 2008 13:23:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84524</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 2 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s0en:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161542</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>