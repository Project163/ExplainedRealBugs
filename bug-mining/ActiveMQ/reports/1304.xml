<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:51:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3506] Access to ConnectionPool.createSession needs to be synchronized </title>
                <link>https://issues.apache.org/jira/browse/AMQ-3506</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;When configuring a PooledConnectionFactory with maximumActive=1 and blockIfSessionPoolIsFull=true (default behavior for latter config) it is possible that multiple threads that concurrently try to use the same JMS connection to create a new session might create more sessions than the configured maximumActive limit.&lt;/p&gt;

&lt;p&gt;That&apos;s because the call to ConnectionPool.createSession() is not synchronized and if multiple threads try to call this method concurrently (on the same underlying JMS connection) then the if-condition in &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SessionKey key = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SessionKey(transacted, ackMode);
SessionPool pool = cache.get(key);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pool == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
  pool = createSessionPool(key);
  cache.put(key, pool);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;will evaluate to true for &lt;b&gt;all&lt;/b&gt; threads and they all end up creating their own sessionPool using the same SessionKey properties. &lt;br/&gt;
Access to the if-condition needs to be synchronized so that only one session pool gets created. That will ensure that not more than the configured maximumActive number of sessions can get created. &lt;/p&gt;</description>
                <environment>&lt;p&gt;activemq-pool, PooledConnectionFactory with maximumActive=1 and blockIfSessionPoolIsFull=true (default behavior)&lt;/p&gt;</environment>
        <key id="12523721">AMQ-3506</key>
            <summary>Access to ConnectionPool.createSession needs to be synchronized </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="tmielke">Torsten Mielke</reporter>
                        <labels>
                            <label>activemq-pool</label>
                            <label>maximumActive</label>
                            <label>sessionPool</label>
                    </labels>
                <created>Tue, 20 Sep 2011 14:03:09 +0000</created>
                <updated>Wed, 21 Sep 2011 13:57:31 +0000</updated>
                            <resolved>Wed, 21 Sep 2011 13:57:30 +0000</resolved>
                                    <version>5.5.0</version>
                                    <fixVersion>5.6.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="10800">3h</timeoriginalestimate>
                            <timeestimate seconds="10800">3h</timeestimate>
                                        <comments>
                            <comment id="13108724" author="tmielke" created="Tue, 20 Sep 2011 14:04:13 +0000"  >&lt;p&gt;Attaching possible fix and corresponding JUnit test&lt;/p&gt;</comment>
                            <comment id="13108727" author="tmielke" created="Tue, 20 Sep 2011 14:05:46 +0000"  >&lt;p&gt;IMHO the fix is to synchronize access to the cache and the creation of the session pool.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Session createSession(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; transacted, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; ackMode) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; JMSException {
        SessionKey key = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SessionKey(transacted, ackMode);
        SessionPool pool = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (cache) {
        	pool = cache.get(key);
        	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pool == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
	            pool = createSessionPool(key);
	            cache.put(key, pool);
	        }
        }
        PooledSession session = pool.borrowSession();
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; session;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13108855" author="ccorsi" created="Tue, 20 Sep 2011 17:48:24 +0000"  >&lt;p&gt;We might consider redefining the cache field from Map to ConcurrentMap and change the code somewhat.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Session createSession(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; transacted, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; ackMode) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; JMSException {
        SessionKey key = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SessionKey(transacted, ackMode);
        SessionPool pool = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        pool = cache.get(key);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pool == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
	    SessionPool newPool = createSessionPool(key);
	    SessionPool prevPool = cache.putIfAbsent(key, newPool);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (prevPool != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; prevPool != newPool) {
              &lt;span class=&quot;code-comment&quot;&gt;// newPool was not the first one to be associated with &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; key... close created session pool
&lt;/span&gt;              newPool.destroy(); &lt;span class=&quot;code-comment&quot;&gt;// don&apos;t remember the method call
&lt;/span&gt;            }
            pool = cache.get(key); &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; a non-&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; value...
&lt;/span&gt;	}
        PooledSession session = pool.borrowSession();
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; session;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13109338" author="tmielke" created="Wed, 21 Sep 2011 08:29:22 +0000"  >&lt;p&gt;Claudio&apos;s suggestion should also work (using newPool.close() to discard the pool). I tested it against the JUnit tests of activemq-pool and against a Camel route that consumes from JMS.&lt;br/&gt;
It has the advantage that once the cache contains a pool object, there is no additional overhead. All overhead is only in the case when the cache does not yet contain the key.&lt;br/&gt;
In my solution there is a synchronized call for every createSession() invocation.&lt;/p&gt;</comment>
                            <comment id="13109512" author="tabish121" created="Wed, 21 Sep 2011 13:57:30 +0000"  >&lt;p&gt;Applied supplied test case and used the concurrent map approach over the synchronization option.  Please review and reopen if an issue is found with the fix.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12495224" name="AMQ-3506.patch" size="6109" author="tmielke" created="Tue, 20 Sep 2011 14:04:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>39712</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 9 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0aivj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59331</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>