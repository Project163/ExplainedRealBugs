<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:50:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3214] &quot;InactivityMonitor Async Task&quot; threads leaking</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3214</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;-Have a multi-thread consumers running to consumer messages&lt;br/&gt;
-Have Connection to have these :&lt;br/&gt;
       		ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(brokerUrl);&lt;br/&gt;
		connectionFactory.setUseAsyncSend(false);&lt;br/&gt;
		connectionFactory.setDispatchAsync(false);&lt;br/&gt;
		connectionFactory.setAlwaysSessionAsync(false);&lt;br/&gt;
		connectionFactory.setAlwaysSyncSend(true);&lt;/p&gt;

&lt;p&gt;-Run the consumers for several hours and profile it&lt;br/&gt;
-You will see there are threads with the name &quot;InactivityMonitor Async Task&quot; being spawning continuously&lt;/p&gt;

&lt;p&gt;This will cause the entire consumer system to slow down eventually due to thread context switching.  &lt;/p&gt;

&lt;p&gt;Suggestion to fix: we should not put a limit on the number of &quot;InactivityMonitor Async Task&quot; threads to be Max Integer.  There is a bug in Java lib that&lt;br/&gt;
it will not stop a thread after a given idle time-to-live. We could fix this in the file InactivityMonitor.java&lt;/p&gt;</description>
                <environment></environment>
        <key id="12500963">AMQ-3214</key>
            <summary>&quot;InactivityMonitor Async Task&quot; threads leaking</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="timiblossom">Minh Do</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Mar 2011 23:52:29 +0000</created>
                <updated>Tue, 20 Sep 2011 10:42:12 +0000</updated>
                            <resolved>Wed, 29 Jun 2011 23:42:20 +0000</resolved>
                                                    <fixVersion>5.6.0</fixVersion>
                                    <component>JMS client</component>
                    <component>Transport</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="3600">1h</timeoriginalestimate>
                            <timeestimate seconds="3600">1h</timeestimate>
                                        <comments>
                            <comment id="13012017" author="gtully" created="Mon, 28 Mar 2011 12:04:58 +0000"  >&lt;p&gt;do you have a reference to the JDK bug that will not timeout idle threads?&lt;/p&gt;</comment>
                            <comment id="13036504" author="timiblossom" created="Thu, 19 May 2011 21:40:02 +0000"  >&lt;p&gt;Hi Gary,&lt;/p&gt;

&lt;p&gt;I used java version &quot;1.6.0_20&quot;.  However, I do think this issue is on ThreadPoolExecutor so it will happen on all 1.6.x.&lt;br/&gt;
The problem is that if we construct a ThreadPoolExecutor like the way the InactivityMonitor.java does, all threads will become core threads and they will not get discarded as they become idle unless we set  ThreadPoolExecutor.allowCoreThreadTimeOut to be true (it is false be default).&lt;/p&gt;

&lt;p&gt;I think both ActiveMQ client and server are using the InactivityMonitor class and both will be slow down to a complete stop after a while.&lt;/p&gt;

&lt;p&gt;I had a patch on this in our development and I could see the problem is gone.  What I did was the change the way InactivityMonitory construct the asynch task threadpool.&lt;/p&gt;

</comment>
                            <comment id="13036506" author="timiblossom" created="Thu, 19 May 2011 21:41:25 +0000"  >&lt;p&gt;This image is on the ActiveMQ client library after I ran using it stress test the ActiveMQ server&lt;/p&gt;</comment>
                            <comment id="13036527" author="tabish121" created="Thu, 19 May 2011 22:11:31 +0000"  >&lt;p&gt;I tried to replicate this sort of behaviour from AMQ but can&apos;t using JDK 1.6.0_21 also couldn&apos;t find any open bugs for the JDK that sound like this.  Perhaps you should try an JDK update and if that fails to help maybe provide a stress test example that demonstrates the problem.  &lt;/p&gt;

&lt;p&gt;The way the executor is created now should prevent any threads from being treated as Core threads so they should timeout according to the set idle time.&lt;/p&gt;</comment>
                            <comment id="13037111" author="timiblossom" created="Fri, 20 May 2011 22:02:33 +0000"  >&lt;p&gt;Hi Timothy,&lt;/p&gt;

&lt;p&gt;We actually had this issue in a few different enviroments here running ActiveMQ server or ActiveMQ client.  &lt;/p&gt;

&lt;p&gt;In my previous company, they opted out to purchase SonicMQ after deploying ActiveMQ server to production and having to restart ActiveMQ almost every week with a noticeable slow-down day after day.  &lt;/p&gt;

&lt;p&gt;I would not say that it is JDK&apos;s bug.  The way ThreadPoolExecutor being used in that InactivityMonitor is the problem.&lt;br/&gt;
I can repeat this every time.  Otherwise, could you please explain why there are so many InactivityMonitor  threads in my attached image?  I was using YourKit to do the profiling.&lt;/p&gt;</comment>
                            <comment id="13057552" author="tabish121" created="Wed, 29 Jun 2011 23:42:20 +0000"  >&lt;p&gt;Added the call to allowCoreThreadTimeOut(true) since it shouldn&apos;t affect the code regardless.  &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12479844" name="threadleak.png" size="118235" author="timiblossom" created="Thu, 19 May 2011 21:41:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14590</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 21 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ajq7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59469</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>