<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:57:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4171] KahaDB / Journal rotateWriteFIle() sometimes too fast?</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4171</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;On very fast test machines we got predictable FileNotFoundExceptions when a KahaDB data file was to be replaced by its successor.&lt;/p&gt;

&lt;p&gt;See this from the log file:&lt;/p&gt;

&lt;p&gt;30.10.2012 21:00:56.359 &lt;span class=&quot;error&quot;&gt;&amp;#91;ActiveMQ Transport: tcp:///192.168.111.128:3134&amp;#93;&lt;/span&gt; [  ]  master-My-Company-S1-kellner20-vm Message ID:kellner20-vm-3125-1351618296390-23:1:1:2086:1 sent to queue://My-Company.dxm.request.provisionToTS&lt;br/&gt;
30.10.2012 21:00:56.359 [BrokerService&lt;span class=&quot;error&quot;&gt;&amp;#91;master-My-Company-S1-kellner20-vm&amp;#93;&lt;/span&gt; Task-197] [  ]  My-Company.dxm.request.provisionToTS toPageIn: 1, Inflight: 0, pagedInMessages.size 0, enqueueCount: 2125, dequeueCount: 2124&lt;/p&gt;

&lt;p&gt;-------------------------------------------------------------------------------&lt;br/&gt;
30.10.2012 21:00:56.390 &lt;span class=&quot;error&quot;&gt;&amp;#91;ConcurrentQueueStoreAndDispatch&amp;#93;&lt;/span&gt; [  ] *** SEVERE ***&lt;br/&gt;
Called from org.apache.activemq.store.kahadb.MessageDatabase.store()&lt;br/&gt;
 KahaDB failed to store to Journal&lt;br/&gt;
-------------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;java.io.FileNotFoundException: activemq-data\master-My-Company-S1-kellner20-vm\KahaDB\db-2.log (The system cannot find the path specified)&lt;br/&gt;
	at java.io.RandomAccessFile.open(Native Method)&lt;br/&gt;
	at java.io.RandomAccessFile.&amp;lt;init&amp;gt;(Unknown Source)&lt;br/&gt;
	at org.apache.kahadb.journal.DataFile.openRandomAccessFile(DataFile.java:70)&lt;br/&gt;
	at org.apache.kahadb.journal.DataFileAppender.processQueue(DataFileAppender.java:309)&lt;br/&gt;
	at org.apache.kahadb.journal.DataFileAppender$1.run(DataFileAppender.java:188)&lt;/p&gt;

&lt;p&gt;30.10.2012 21:00:56.375 [BrokerService&lt;span class=&quot;error&quot;&gt;&amp;#91;master-My-Company-S1-kellner20-vm&amp;#93;&lt;/span&gt; Task-197] [  ]  org.apache.activemq.broker.region.cursors.QueueStorePrefetch@1afd356:My-Company.dxm.request.provisionToTS,batchResetNeeded=false,storeHasMessages=true,size=0,cacheEnabled=true - fillBatch&lt;br/&gt;
30.10.2012 21:00:56.421 &lt;span class=&quot;error&quot;&gt;&amp;#91;ConcurrentQueueStoreAndDispatch&amp;#93;&lt;/span&gt; [  ] NOTIFICATION:  HighWater of SEVERE exceeded (value=1, highwater=1)!&lt;br/&gt;
30.10.2012 21:00:56.437 &lt;span class=&quot;error&quot;&gt;&amp;#91;ConcurrentQueueStoreAndDispatch&amp;#93;&lt;/span&gt; [  ]  Stopping the broker due to IO exception, java.io.FileNotFoundException: activemq-data\master-My-Company-S1-kellner20-vm\KahaDB\db-2.log (The system cannot find the path specified)&lt;br/&gt;
java.io.FileNotFoundException: activemq-data\master-My-Company-S1-kellner20-vm\KahaDB\db-2.log (The system cannot find the path specified)&lt;br/&gt;
	at java.io.RandomAccessFile.open(Native Method)&lt;br/&gt;
	at java.io.RandomAccessFile.&amp;lt;init&amp;gt;(Unknown Source)&lt;br/&gt;
	at org.apache.kahadb.journal.DataFile.openRandomAccessFile(DataFile.java:70)&lt;br/&gt;
	at org.apache.kahadb.journal.DataFileAppender.processQueue(DataFileAppender.java:309)&lt;br/&gt;
	at org.apache.kahadb.journal.DataFileAppender$1.run(DataFileAppender.java:188)&lt;/p&gt;

&lt;p&gt;********************&lt;br/&gt;
(end of log file quotation)&lt;br/&gt;
********************&lt;/p&gt;

&lt;p&gt;Having evaluated all possibilities of the failure, we finally patched the following method of the class Journal::&lt;/p&gt;


&lt;p&gt;synchronized DataFile rotateWriteFile() {&lt;br/&gt;
        int nextNum = !dataFiles.isEmpty() ? dataFiles.getTail().getDataFileId().intValue() + 1 : 1;&lt;br/&gt;
        File file = getFile(nextNum);&lt;br/&gt;
        DataFile nextWriteFile = new DataFile(file, nextNum, preferedFileLength);&lt;br/&gt;
PATCH START       try &lt;/p&gt;
{
   			Thread.sleep(10000);
		}
&lt;p&gt; catch (InterruptedException e) &lt;/p&gt;
{
			e.printStackTrace();
		}
&lt;p&gt;PATCH END&lt;br/&gt;
        // actually allocate the disk space&lt;br/&gt;
        fileMap.put(nextWriteFile.getDataFileId(), nextWriteFile);&lt;br/&gt;
        fileByFileMap.put(file, nextWriteFile);&lt;br/&gt;
        dataFiles.addLast(nextWriteFile);&lt;br/&gt;
        return nextWriteFile;&lt;br/&gt;
    }&lt;br/&gt;
*************&lt;/p&gt;

&lt;p&gt;This helped, the IO Exception never occurred again after this patch.&lt;br/&gt;
It seems that the &quot;nextWriteFile&quot;-object was  returned, while the allocating of the new Data File wasn&apos;t finished yet. &lt;br/&gt;
Anyway, it is very strange that we should have detected this problem, and it never occurred earlier - at least no similar bug (???) seems to have been reported. Therefore, a critical examination of possibly deeper causes could be useful.&lt;br/&gt;
Best regards, &lt;br/&gt;
Matthias Vetter&lt;br/&gt;
ATOS, Frankfurt&lt;/p&gt;</description>
                <environment>&lt;p&gt;Tested on Windows XP&lt;/p&gt;</environment>
        <key id="12615693">AMQ-4171</key>
            <summary>KahaDB / Journal rotateWriteFIle() sometimes too fast?</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="mtmvetter">Matthias Vetter</reporter>
                        <labels>
                    </labels>
                <created>Mon, 12 Nov 2012 09:53:48 +0000</created>
                <updated>Fri, 7 Dec 2012 21:30:27 +0000</updated>
                            <resolved>Fri, 7 Dec 2012 21:30:27 +0000</resolved>
                                    <version>5.6.0</version>
                                    <fixVersion>5.8.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13496244" author="tabish121" created="Tue, 13 Nov 2012 15:15:16 +0000"  >&lt;p&gt;This artificial delay is probably just masking some other issue as the allocation of the DataFile object doesn&apos;t actually cause a file to be created or read, only when DataFile.openRandomAccessFile is called is the file going to get created.  &lt;/p&gt;</comment>
                            <comment id="13496252" author="mtmvetter" created="Tue, 13 Nov 2012 15:28:11 +0000"  >&lt;p&gt;Hi Timothy, &lt;br/&gt;
you are right, and I am sorry for having created an issue entry too early. Nevertheless, the delay really helped for some time. But today we detected an fileNotFound Exception inspite the delay, eventually. &lt;br/&gt;
So we have to keep on searching for the real problem..&lt;br/&gt;
Thanks! &lt;/p&gt;

&lt;p&gt;Best regards, &lt;br/&gt;
Matthias Vetter&lt;/p&gt;
</comment>
                            <comment id="13503146" author="mtmvetter" created="Fri, 23 Nov 2012 10:31:44 +0000"  >&lt;p&gt;After deeper examination of the above described failure, we still have no solution to the problem:&lt;br/&gt;
It is always possible to create the first file db-1.log. But the creation of its successor always fails, always with the same exception: file not found, the system cannot find the path specified. &lt;br/&gt;
The DataFileAppender gets the next DataFile-object (from the method we suspected to be too fast) and then this DataFile object&#8216;s method openRandomAccessFile is called. At this moment, the physical file is not yet existing, the RandomAccessFile-constructor called by the open-method is supposed to create the file. It did so, when db-1.log was created. The path to the files, naturally, wasn&#8217;t changed after that, and the same rights in the file system still are granted. &lt;br/&gt;
The only difference we see is, that now another file is already present and is about to be deleted. But should this have such an effect?&lt;br/&gt;
We also suspected the whitespaces in the absolute path to the file to be a problem &#8211; but why not in the first case with db-1.log?&lt;br/&gt;
Even more irritating is that obviously no one else faced such kind of FileNotFound problem with the KahaDB. &lt;br/&gt;
Finally, the problem seems to occur not on Windows 7, as initially reported, but on Windows XP. It also didn&#8217;t occur on a Solaris machine. &lt;br/&gt;
Please, has anyone an idea what could be going on here?  Any comment is welcome!!!!&lt;/p&gt;</comment>
                            <comment id="13503866" author="tabish121" created="Mon, 26 Nov 2012 16:21:28 +0000"  >&lt;p&gt;Suggest moving to a later patch release of the JDK could be an issue there with Windows XP.&lt;/p&gt;</comment>
                            <comment id="13504729" author="mtmvetter" created="Tue, 27 Nov 2012 16:27:34 +0000"  >&lt;p&gt;In the meantime we found out, that all depends on the way we start our server, in which the broker is embedded. Using Windows (Win7 or xp, JDK 6 or 7 - all this doesn&apos;t matter), we can start the server either as a Windows service, using a .ini-file, from which jre/bin/server/jvm.dll is called, &lt;br/&gt;
either manually using a .bat-file, calling java.exe. The jvm-parameters we pass are both times the same.&lt;br/&gt;
Starting java.exe never leads to the described failures, starting with java.dll always. Needless to say, it stays a riddle how the start methods are related to the fileNotFound problem.&lt;br/&gt;
Anyone experienced something like this?&lt;br/&gt;
m.v.&lt;/p&gt;</comment>
                            <comment id="13506465" author="mtmvetter" created="Thu, 29 Nov 2012 13:22:45 +0000"  >&lt;p&gt;Although it is strange that the file not found behaviour depends on the starting mode, there is a possibility to prevent the exception: &lt;br/&gt;
org.apache.kahadb.journal.DataFile.openRandomAccessFile &lt;br/&gt;
calls: new RandomAccessFile(file, &quot;rw&quot;);. Replacing this by&lt;br/&gt;
new RandomAccessFile(file.getCanonicalPath(), &quot;rw&quot;); helped!&lt;/p&gt;

&lt;p&gt;Whatever the deeper causes for the problem may be, the kahaDB would gain stability by opening RandomAccessFiles generally with os-proof pathnames rather than with file objects.&lt;/p&gt;
</comment>
                            <comment id="13507405" author="tabish121" created="Fri, 30 Nov 2012 16:16:51 +0000"  >&lt;p&gt;The getCanonicalPath change makes sense and I&apos;ve applied that on trunk, not sure what else can be done here. &lt;/p&gt;</comment>
                            <comment id="13526785" author="tabish121" created="Fri, 7 Dec 2012 21:30:27 +0000"  >&lt;p&gt;The fix for the canonical file name use on open is in, not sure what else can be done here if anything.  The issue seems to be OS and JVM related not broker related. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>256998</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 50 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0j1bz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>109146</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>