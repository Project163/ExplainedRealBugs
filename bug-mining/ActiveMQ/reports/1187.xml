<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:50:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2929] Compressed text message received by consumer uncompressed</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2929</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I have a queue setup to send and consume compressed text messages.  This is done via Spring setting ActiveMQConnectionFactory.useCompression to true.  If the consumer connects to this queue before the first message is arrives, everything works great.&lt;/p&gt;

&lt;p&gt;If the messages are sent to this queue before the consumer connects, those early messages will cause ZipException &quot;unknown compression method&quot; when consumed by the belated consumer. Debugger shows that the ActiveMQTextMessage.content already contains the uncompressed text (with 4 leading length bytes) when ActiveMQTextMessage.getText() is called.&lt;/p&gt;

&lt;p&gt;If I set useCompression to false, early messages are consumed with no problems.  Please look into this.&lt;/p&gt;

&lt;p&gt;I notice that after ActiveMQTextMessage.getText() decompress the message, it does not set compressed to false. Not sure if that is the cause.&lt;/p&gt;</description>
                <environment>&lt;p&gt;ActiveMQ 5.3.2 / Camel 2.2.0&lt;/p&gt;</environment>
        <key id="12483860">AMQ-2929</key>
            <summary>Compressed text message received by consumer uncompressed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="mwc_tonesoft">Michael Chen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 22 Sep 2010 00:23:52 +0000</created>
                <updated>Fri, 25 Feb 2011 22:34:17 +0000</updated>
                            <resolved>Fri, 25 Feb 2011 22:34:17 +0000</resolved>
                                    <version>5.3.2</version>
                                    <fixVersion>5.5.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12942949" author="mwc_tonesoft" created="Wed, 22 Sep 2010 10:13:38 +0000"  >&lt;p&gt;Here is how the connection factory defined:&lt;/p&gt;

&lt;p&gt;    &amp;lt;bean id=&quot;jmsXmlFactory&quot; class=&quot;org.apache.activemq.pool.PooledConnectionFactory&quot;&lt;br/&gt;
          destroy-method=&quot;stop&quot;&amp;gt;&lt;br/&gt;
        &amp;lt;property name=&quot;connectionFactory&quot;&amp;gt;&lt;br/&gt;
            &amp;lt;bean class=&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;&amp;gt;&lt;br/&gt;
                &amp;lt;property name=&quot;brokerURL&quot; value=&quot;${brokerConnectionURL}&quot;/&amp;gt;&lt;br/&gt;
                &amp;lt;property name=&quot;userName&quot; value=&quot;${activemq.username}&quot;/&amp;gt;&lt;br/&gt;
                &amp;lt;property name=&quot;password&quot; value=&quot;${activemq.password}&quot;/&amp;gt;&lt;br/&gt;
                &amp;lt;property name=&quot;clientIDPrefix&quot; value=&quot;${processUniqueName}Xml-${serverId}-${pid}&quot;/&amp;gt;&lt;br/&gt;
                &amp;lt;property name=&quot;transformer&quot;&amp;gt;&lt;br/&gt;
                    &amp;lt;bean class=&quot;org.apache.activemq.util.xstream.XStreamMessageTransformer&quot;/&amp;gt;&lt;br/&gt;
                &amp;lt;/property&amp;gt;&lt;br/&gt;
                &amp;lt;property name=&quot;useCompression&quot; value=&quot;true&quot;/&amp;gt;&lt;br/&gt;
            &amp;lt;/bean&amp;gt;&lt;br/&gt;
        &amp;lt;/property&amp;gt;&lt;br/&gt;
    &amp;lt;/bean&amp;gt;&lt;/p&gt;</comment>
                            <comment id="12942950" author="mwc_tonesoft" created="Wed, 22 Sep 2010 10:20:32 +0000"  >&lt;p&gt;Another observation is that while the message is enqueued with no consumer, using JConsole &lt;span class=&quot;error&quot;&gt;&amp;#91;browseMessages&amp;#93;&lt;/span&gt; button on that queue shows the decompressed message text. I would expect it to be unreadable compressed binary.&lt;/p&gt;</comment>
                            <comment id="12942956" author="mwc_tonesoft" created="Wed, 22 Sep 2010 16:51:28 +0000"  >&lt;p&gt;Debugger shows the mistake came off the wire. When the client reads the message from the wire, ActiveMQTextMessageMarshaller created the ActiveMQTextMessage with command.Message.compressed == true and Message.content contains decompressed text.&lt;/p&gt;

&lt;p&gt;Therefore, there two ActiveMQ broker bugs:&lt;/p&gt;

&lt;p&gt;1) The message queued with no consumer should not be decompressed.&lt;/p&gt;

&lt;p&gt;2) When the message is decompressed, the compressed flag should be set to false before sending the message to the belated consumer.&lt;/p&gt;</comment>
                            <comment id="12942944" author="mwc_tonesoft" created="Wed, 22 Sep 2010 18:42:41 +0000"  >&lt;p&gt;Indeed adding the following line between line 88 and 89 of ActiveMQTextMessage.java fixed the second bug and offer a temporary workaround for the problem as a whole:&lt;/p&gt;

&lt;p&gt;diff ActiveMQTextMessage.java patch/ActiveMQTextMessage.java &lt;br/&gt;
88a89&lt;br/&gt;
&amp;gt;                     setCompressed(false);&lt;/p&gt;

&lt;p&gt;The first bug mentioned above needs to be fixed, i.e. the broker must not call ActiveMQTextMessage.getText() to avoid decompressing the message when no consumer is available when the message is enqueued.&lt;/p&gt;</comment>
                            <comment id="12942943" author="tabish121" created="Wed, 22 Sep 2010 18:47:52 +0000"  >&lt;p&gt;Can you provide a unit test or sample that demonstrates the issue, it would help to ensure the problem gets fixed and stays fixed.&lt;/p&gt;</comment>
                            <comment id="12942941" author="mwc_tonesoft" created="Thu, 23 Sep 2010 00:17:31 +0000"  >&lt;p&gt;Attached the test source program and its Spring xml. A producer is needed that uses the same jmsFactory defined in this XML to pump some messages (compressed) to the &quot;test.registration&quot; queue before running the test program. No message will be retrieved due to the ZipException.&lt;/p&gt;</comment>
                            <comment id="12942964" author="tabish121" created="Fri, 24 Sep 2010 19:30:41 +0000"  >&lt;p&gt;Perhaps you could create a JUnit test case that reproduces this?  Or at least provide the source for  your producer?&lt;/p&gt;</comment>
                            <comment id="12943052" author="mwc_tonesoft" created="Thu, 14 Oct 2010 22:19:00 +0000"  >&lt;p&gt;The producer code you asked for. Please fix the broker.&lt;/p&gt;</comment>
                            <comment id="12943181" author="mwc_tonesoft" created="Tue, 9 Nov 2010 01:56:04 +0000"  >&lt;p&gt;Latest findings&lt;br/&gt;
============&lt;br/&gt;
An unconsumed message in a queue is decompressed when a JMX client code calls &quot;browse()&quot; on that Queue&apos;s MBean. Below is a stack trace captured by Eclipse (sorry about not having full class names).&lt;/p&gt;

&lt;p&gt;&quot;ActiveMQMonitorModule ... line: 86&quot; is where our code calls the &quot;browse&quot; method of the Queue&apos;s MBean. This led to &quot;ActiveMQTextMessage.getText() line: 83&quot;, which decompressed the message, allocating large amount of memory, and possibly killing the broker altogether.&lt;/p&gt;

&lt;p&gt;Another side effect is that the message is permanently decompressed in the queue, and due to the other bug mentioned in my 9/22 comment, the consumer receives a message that is decompressed but with the wrong (isCompressed() == true) result.&lt;/p&gt;

&lt;p&gt;Our work-around is to call the MBean&apos;s &quot;browseMessages()&quot; with the patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3023&quot; title=&quot;DestinationView.browseMessages(String) must not call OpenTypeSupport.convert()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3023&quot;&gt;&lt;del&gt;AMQ-3023&lt;/del&gt;&lt;/a&gt;. However, if you use JConsole to browse the unconsumed messages, it too will trigger the decompression of messages (possibly killing the broker due to out of memory). A nasty booby trap.&lt;/p&gt;

&lt;p&gt;One possible fix is for OpenTypeSupport.TextMessageOpenTypeFactory.getFields(Object) to check for m.isCompressed(), and if true not to call m.getText().  See line 367 of OpenTypeSupport.java.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; [SelfMonitor] (Evaluating)	
	InflaterInputStream(InputStream) line: 91 [local variables unavailable]
	ActiveMQTextMessage.getText() line: 83 [local variables unavailable]	
	OpenTypeSupport$TextMessageOpenTypeFactory.getFields(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) line: 367	
	OpenTypeSupport.convert(Message) line: 397	
	QueueView(DestinationView).browse(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) line: 151	
	QueueView(DestinationView).browse() line: 132	
	GeneratedMethodAccessor43.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: not available	
	DelegatingMethodAccessorImpl.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 25	
	Method.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 597	
	StandardMBeanIntrospector.invokeM2(Method, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) line: 93	
	StandardMBeanIntrospector.invokeM2(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) line: 27	
	StandardMBeanIntrospector(MBeanIntrospector&amp;lt;M&amp;gt;).invokeM(M, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) line: 208	
	PerInterface&amp;lt;M&amp;gt;.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) line: 120	
	StandardMBeanSupport(MBeanSupport&amp;lt;M&amp;gt;).invoke(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[]) line: 262	
	AnnotatedMBean(StandardMBean).invoke(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[]) line: 391	
	DefaultMBeanServerInterceptor.invoke(ObjectName, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[]) line: 836	
	JmxMBeanServer.invoke(ObjectName, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[]) line: 761	
	ActiveMQMonitorModule$1QueueValueAccessor.getValue() line: 86	
	ActiveMQMonitorModule$1QueueValueAccessor.getValue() line: 67	
	BaseModuleAttribute&amp;lt;D&amp;gt;.getCurrentValue() line: 106	
	ActiveMQMonitorModule(BaseMonitorModule).getCurrentModuleData() line: 105	
	MonitorData.populateModuleData(MonitorModule) line: 195	
	MonitorGenerator.process() line: 135	
	BaseRouteBuilder$1.run() line: 81	
	BaseRouteBuilder$2.run() line: 176	
	TimerThread.mainLoop() line: 512	
	TimerThread.run() line: 462	
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12999610" author="tabish121" created="Fri, 25 Feb 2011 22:34:17 +0000"  >&lt;p&gt;TextMessage class now clears the compressed flag when its body is uncompressed to avoid receiving a message in an invalid state.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461870" name="ActiveMQConsumerTest.java" size="499" author="mwc_tonesoft" created="Thu, 23 Sep 2010 00:17:30 +0000"/>
                            <attachment id="12461871" name="ActiveMQConsumerTest.xml" size="2631" author="mwc_tonesoft" created="Thu, 23 Sep 2010 00:17:31 +0000"/>
                            <attachment id="12461869" name="ActiveMQProducerTest.java" size="876" author="mwc_tonesoft" created="Thu, 14 Oct 2010 22:19:00 +0000"/>
                            <attachment id="12461821" name="ActiveMQProducerTest.xml" size="2450" author="mwc_tonesoft" created="Thu, 14 Oct 2010 22:19:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14692</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 39 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0akdb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59573</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>