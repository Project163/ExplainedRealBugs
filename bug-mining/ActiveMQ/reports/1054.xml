<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:48:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2955] Message getting stuck on queue, leading to KahaDB log files not being deleted and disk running out of space</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2955</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Using the following test client, we see a single message getting stuck on the queue. This then prevents the KahaDB files from being cleaned up. Once this message gets stuck, we need to restart the broker before it can be consumed. This is a total show stopper for us, as when this occurs in our system the large number of messages that we produce and consume each second causes the disk to run out of space within the space of an hour. We also see the same behaviour using synchronous sending and without failover.&lt;/p&gt;

&lt;p&gt;This doesn&apos;t happen every time with the test client - the most reliable way I have found to reproduce it is to start the broker and wait for the first MessageDatabase checkpoint to finish before starting the test client. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Test Client&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.BufferedWriter;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.FileWriter;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.Random;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.Connection;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.Message;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.MessageConsumer;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.MessageListener;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.MessageProducer;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.Queue;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.Session;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.ConnectionFactory;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.activemq.ActiveMQConnectionFactory;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Test {
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                ConnectionFactory cf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ActiveMQConnectionFactory(&lt;span class=&quot;code-quote&quot;&gt;&quot;failover:(tcp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:61616)?jms.useAsyncSend=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;trackMessages=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;);
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Connection producerConn = cf.createConnection();
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Connection consumerConn = cf.createConnection();

                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; BufferedWriter producerLog = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferedWriter(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileWriter(&lt;span class=&quot;code-quote&quot;&gt;&quot;produced.log&quot;&lt;/span&gt;));
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; BufferedWriter consumerLog = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferedWriter(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileWriter(&lt;span class=&quot;code-quote&quot;&gt;&quot;consumed.log&quot;&lt;/span&gt;));

                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;() {
                        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
                                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                                        producerConn.start();
                                        Session session = producerConn.createSession(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, Session.CLIENT_ACKNOWLEDGE);
                                        Queue queue = session.createQueue(&lt;span class=&quot;code-quote&quot;&gt;&quot;TEST_QUEUE&quot;&lt;/span&gt;);
                                        MessageProducer producer = session.createProducer(queue);
                                        Random random = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random();
                                        &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] messageBytes = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[1024];

                                        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 100000; i++) {
                                        &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
&lt;/span&gt;                                                random.nextBytes(messageBytes);
                                                Message message = session.createObjectMessage(messageBytes);
                                                producer.send(message);
                                                producerLog.write(message.getJMSMessageID());
                                                producerLog.newLine();
                                                producerLog.flush();
                                        }
                                        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Produced 100000 messages...&quot;&lt;/span&gt;);
                                        producerLog.close();
                                }
                                &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
                                        e.printStackTrace();
                                }
                        }
                }).start();

                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Started producer...&quot;&lt;/span&gt;);

                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;() {
                        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
                                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                                        consumerConn.start();
                                        Session session = consumerConn.createSession(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, Session.CLIENT_ACKNOWLEDGE);
                                        Queue queue = session.createQueue(&lt;span class=&quot;code-quote&quot;&gt;&quot;TEST_QUEUE&quot;&lt;/span&gt;);
                                        MessageConsumer consumer = session.createConsumer(queue);
                                        consumer.setMessageListener(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MessageListener() {
                                                &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onMessage(Message message) {
                                                        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                                                                message.acknowledge();
                                                                consumerLog.write(message.getJMSMessageID());
                                                                consumerLog.newLine();
                                                                consumerLog.flush();
                                                        }
                                                        &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
                                                                e.printStackTrace();
                                                        }
                                                }
                                        });
                                }
                                &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
                                        e.printStackTrace();
                                }
                        }
                }).start();

                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Started consumer...&quot;&lt;/span&gt;);
        }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After the 100,000 messages have been produced, we can see the following difference in the log files:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[pblackburn@xxxx test]$ diff produced.log consumed.log
10394d10393
&amp;lt; ID:xxxx-35451-1285948546531-0:0:1:1:10394
[pblackburn@xxxx test]$
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looking in the activemq log file, at around this point we see:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2010-10-01 15:55:51 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 205, pagedInMessages.size 349, enqueueSize: 10390
2010-10-01 15:55:51 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 205, pagedInMessages.size 350, enqueueSize: 10391
2010-10-01 15:55:51 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 205, pagedInMessages.size 351, enqueueSize: 10392
2010-10-01 15:55:51 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 205, pagedInMessages.size 352, enqueueSize: 10393
2010-10-01 15:55:51 Usage [DEBUG] Main:memory:queue://TEST_QUEUE:memory: usage change from: 69% of available memory, to: 70% of available memory
2010-10-01 15:55:51 Usage [DEBUG] Main:memory:queue://TEST_QUEUE:memory: usage change from: 70% of available memory, to: 69% of available memory
2010-10-01 15:55:51 AbstractStoreCursor [DEBUG] TEST_QUEUE disabling cache on size:0, lastCachedIdSeq: 10398 current node seqId: 10399
2010-10-01 15:55:51 Usage [DEBUG] Main:memory:queue://TEST_QUEUE:memory: usage change from: 69% of available memory, to: 70% of available memory
2010-10-01 15:55:51 Queue [DEBUG] TEST_QUEUE toPageIn: 2, Inflight: 353, pagedInMessages.size 353, enqueueSize: 10395
2010-10-01 15:55:51 Usage [DEBUG] Main:memory:queue://TEST_QUEUE:memory: usage change from: 70% of available memory, to: 69% of available memory
2010-10-01 15:55:51 Usage [DEBUG] Main:memory:queue://TEST_QUEUE:memory: usage change from: 69% of available memory, to: 70% of available memory
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At the end of the log file, where we have a single message stuck on the queue, we see:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2010-10-01 15:56:10 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 0, pagedInMessages.size 0, enqueueSize: 100000
2010-10-01 15:56:10 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 0, pagedInMessages.size 0, enqueueSize: 100000
2010-10-01 15:56:10 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 0, pagedInMessages.size 0, enqueueSize: 100000
2010-10-01 15:56:10 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 0, pagedInMessages.size 0, enqueueSize: 100000
2010-10-01 15:56:10 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 0, pagedInMessages.size 0, enqueueSize: 100000
2010-10-01 15:56:10 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 0, pagedInMessages.size 0, enqueueSize: 100000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can see the checkpoint failing to clean up the log files:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2010-10-01 15:56:36 MessageDatabase [DEBUG] Checkpoint started.
2010-10-01 15:56:36 MessageDatabase [DEBUG] not removing data file: 2 as contained ack(s) refer to referenced file: [1, 2]
2010-10-01 15:56:36 MessageDatabase [DEBUG] not removing data file: 3 as contained ack(s) refer to referenced file: [2, 3]
2010-10-01 15:56:36 MessageDatabase [DEBUG] not removing data file: 4 as contained ack(s) refer to referenced file: [3, 4]
2010-10-01 15:56:36 MessageDatabase [DEBUG] not removing data file: 5 as contained ack(s) refer to referenced file: [4, 5]
2010-10-01 15:56:36 MessageDatabase [DEBUG] Checkpoint done.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At this point our consumer had consumed all of the messages except the single stuck message.&lt;/p&gt;

&lt;p&gt;We are using a clean out of the box set up - we have made no changes to the default activemq.xml file,&lt;/p&gt;
</description>
                <environment>&lt;p&gt;Red Hat Enterprise Linux 5&lt;/p&gt;</environment>
        <key id="12483849">AMQ-2955</key>
            <summary>Message getting stuck on queue, leading to KahaDB log files not being deleted and disk running out of space</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="pblackburn">Peter Blackburn</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Oct 2010 16:46:53 +0000</created>
                <updated>Wed, 20 Nov 2024 17:30:06 +0000</updated>
                            <resolved>Tue, 19 Apr 2011 12:49:08 +0000</resolved>
                                    <version>5.4.1</version>
                                    <fixVersion>5.5.0</fixVersion>
                                    <component>Message Store</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="12943043" author="pblackburn" created="Mon, 11 Oct 2010 17:07:17 +0000"  >&lt;p&gt;With a different test harness, we can get this failure to occur at the same point every time (for 1K message size always happens at  the 286th message sent, for 10K message size  at the 45th message sent nd for 100K message size at the 5th message sent).&lt;/p&gt;

&lt;p&gt;Further investigation shows that when this occurs, the following conditions hold:&lt;/p&gt;

&lt;p&gt;In class &lt;tt&gt;Queue&lt;/tt&gt;, method &lt;tt&gt;doPageIn&lt;/tt&gt;, the following loop body does not get executed as &lt;tt&gt;messages.hasNext()&lt;/tt&gt; is returning false:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (messages.hasNext() &amp;amp;&amp;amp; count &amp;lt; toPageIn) {
    MessageReference node = messages.next();
    messages.remove();
&lt;span class=&quot;code-comment&quot;&gt;// snipped &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; brevity&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At this point, &lt;tt&gt;count=0&lt;/tt&gt;, &lt;tt&gt;toPageIn=1&lt;/tt&gt; and &lt;tt&gt;messages.size()=1&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Following the code through to the &lt;tt&gt;BTreeNode&lt;/tt&gt; class, we find that the leaf node contains a single key with value 44.  When the &lt;tt&gt;BTreeNode.BTreeIterator&lt;/tt&gt; class is instantiated, it is being passed in a value of 535 for the value of the default cursor position as the &lt;tt&gt;batchResetNeeded&lt;/tt&gt; flag is false. This causes the loop body in the &lt;tt&gt;findNextPage&lt;/tt&gt; method to exit before it sets the &lt;tt&gt;nextEntry&lt;/tt&gt; field, leaving it null.&lt;/p&gt;

&lt;p&gt;If we stick a quick hack into the &lt;tt&gt;doPageIn&lt;/tt&gt; method in class &lt;tt&gt;Queue&lt;/tt&gt; then the problem seems to go away, but we still don&apos;t know what the underlying cause was and we are wary of changing code that we don&apos;t fully understand:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (messages.size() &amp;gt; 0 &amp;amp;&amp;amp; !messages.hasNext()) {
    store.resetBatching();
}

&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (messages.hasNext() &amp;amp;&amp;amp; count &amp;lt; toPageIn) {
    MessageReference node = messages.next();
    messages.remove();
&lt;span class=&quot;code-comment&quot;&gt;// snipped &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; brevity&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


</comment>
                            <comment id="12943036" author="gtully" created="Tue, 12 Oct 2010 10:41:17 +0000"  >&lt;p&gt;My suspicion is the operation of the setBatch method, disabling the cache will help pinpoint (policy entry useCache=false).&lt;/p&gt;

&lt;p&gt;One thing that looks odd is in org.apache.activemq.store.kahadb.KahaDBStore.KahaDBMessageStore#resetBatching,&lt;br/&gt;
that does not obtain the indexLock, it should be comparable to org.apache.activemq.store.kahadb.KahaDBStore.KahaDBMessageStore#setBatch in this regard. It looks like this could be related to your problem, if an batch rest was missed from contention.&lt;/p&gt;

&lt;p&gt;btw: What is the difference between your test case above and the other test harness?&lt;/p&gt;</comment>
                            <comment id="12943049" author="pblackburn" created="Tue, 12 Oct 2010 12:50:56 +0000"  >&lt;p&gt;Attached test harness. &lt;/p&gt;

&lt;p&gt;Compile with following:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;javac -cp .activemq-core-5.4.1.jar:geronimo-j2ee-management_1.1_spec-1.0.1.jar:log4j-1.2.15.jar:commons-logging.jar:jms.jar *.java
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When producing the error, we restart the activemq server and wait until we see the MessageDatabase &quot;Checkpoint done&quot; message in the log, then kick off the enquer as follows:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java -cp .:jms.jar:activemq-core-5.4.1.jar:geronimo-j2ee-management_1.1_spec-1.0.1.jar:log4j-1.2.15.jar:commons-logging.jar jms.TrackedMessageEnqueuer &apos;tcp://localhost:61616&apos; 1 10 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and then immediately kick off the dequeuer as follows:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java -cp .:jms.jar:lib/activemq-core-5.4.1.jar:geronimo-j2ee-management_1.1_spec-1.0.1.jar:log4j-1.2.15.jar:commons-logging.jar jms.TrackedMessageDequeuer &apos;tcp://localhost:61616&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We don&apos;t always get the error, but when it occurs it is always on the 45th message sent, using the 10K message size as shown.&lt;/p&gt;</comment>
                            <comment id="12942848" author="pblackburn" created="Tue, 12 Oct 2010 15:18:03 +0000"  >&lt;p&gt;Thanks for that Gary, I added some additional debug - the method &lt;tt&gt;KahaDBStore.KahaDMMessageStore#resetBatching&lt;/tt&gt; is called once as the broker starts up and is not called again during my test run (I removed my hack from the &lt;tt&gt;Queue&lt;/tt&gt; class).&lt;/p&gt;

&lt;p&gt;I then tried the following three variations of this method:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Added call to &lt;tt&gt;indexLock.readLock().lock()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Added call to &lt;tt&gt;lockAsyncJobQueue&lt;/tt&gt; and &lt;tt&gt;indexLock.readLock().lock()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Added call to &lt;tt&gt;indexLock.writeLock().lock()&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The stuck message is still observed with each variation.&lt;/p&gt;

&lt;p&gt;I&apos;ll keep digging.&lt;/p&gt;</comment>
                            <comment id="12943060" author="pblackburn" created="Wed, 13 Oct 2010 09:41:50 +0000"  >&lt;p&gt;As suggested, I tried adding &lt;tt&gt;useCache=&quot;false&quot;&lt;/tt&gt; to the queues&apos; &lt;tt&gt;policyEntry&lt;/tt&gt; element in &lt;tt&gt;activemq.xml&lt;/tt&gt;. After doing this I have been unable to reproduce the issue.&lt;/p&gt;</comment>
                            <comment id="12943066" author="gtully" created="Wed, 13 Oct 2010 12:07:26 +0000"  >&lt;p&gt;that is good, in that it points to org.apache.activemq.store.kahadb.KahaDBStore.KahaDBMessageStore#setBatch and the cursor and store being out of sync. The intention is that when the cache is full and eventually exhausted, reading from the store can commence from the point in the store that corresponds to the last entry in the cache. &lt;br/&gt;
can you attach your activemq.xml?&lt;/p&gt;</comment>
                            <comment id="12943017" author="pblackburn" created="Wed, 13 Oct 2010 12:58:15 +0000"  >&lt;p&gt;Attached &lt;tt&gt;activemq.xml&lt;/tt&gt; file used.&lt;/p&gt;</comment>
                            <comment id="13021566" author="dejanb" created="Tue, 19 Apr 2011 12:49:08 +0000"  >&lt;p&gt;I cannot reproduce this problem in 5.5.0 version (while it is easily reproduced in 5.4.1 and 5.4.2). There was some work in this area for 5.5.0 release, so it seems that this has been fixed as well.&lt;/p&gt;

&lt;p&gt;Can you please retest and reopen the issue if you still experience problems.&lt;/p&gt;</comment>
                            <comment id="17899823" author="christopher.l.shannon" created="Wed, 20 Nov 2024 17:29:37 +0000"  >&lt;p&gt;This is a super old issue but the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9625&quot; title=&quot;Messages can become stuck on Queues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9625&quot;&gt;&lt;del&gt;AMQ-9625&lt;/del&gt;&lt;/a&gt; should hopefully fix this once and for all.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                                                <inwardlinks description="is fixed by">
                                        <issuelink>
            <issuekey id="13599419">AMQ-9625</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12461810" name="TrackedMessageDequeuer.java" size="3109" author="pblackburn" created="Tue, 12 Oct 2010 12:50:56 +0000"/>
                            <attachment id="12461809" name="TrackedMessageEnqueuer.java" size="3224" author="pblackburn" created="Tue, 12 Oct 2010 12:50:56 +0000"/>
                            <attachment id="12461837" name="activemq.xml" size="5601" author="pblackburn" created="Wed, 13 Oct 2010 12:58:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14832</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0akcv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59571</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>