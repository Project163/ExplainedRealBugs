<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:01:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4092] ConcurrentModificationException when using message groups</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4092</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;seeing these WARN messages frequently while consuming (maxConcurrentConsumers=5) from a queue with the message groups header (JMSXGroupID) set.  If I disable the message groups header, these errors go away...  &lt;/p&gt;

&lt;p&gt;That said, I don&apos;t see any specific errors with my application (at this point), just these messages in my logs.&lt;/p&gt;

&lt;p&gt;2012-10-04 02:34:02,552 |  WARN - Service              - | Async error occurred: java.util.concurrent.ExecutionException: java.util.ConcurrentModificationException&lt;br/&gt;
java.util.concurrent.ExecutionException: java.util.ConcurrentModificationException&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:222)&lt;br/&gt;
	at java.util.concurrent.FutureTask.get(FutureTask.java:83)&lt;br/&gt;
	at org.apache.activemq.broker.region.Queue.doMessageSend(Queue.java:785)&lt;br/&gt;
	at org.apache.activemq.broker.region.Queue.send(Queue.java:707)&lt;br/&gt;
	at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:407)&lt;br/&gt;
	at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:503)&lt;br/&gt;
	at org.apache.activemq.broker.jmx.ManagedRegionBroker.send(ManagedRegionBroker.java:305)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:129)&lt;br/&gt;
	at org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:96)&lt;br/&gt;
	at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:306)&lt;br/&gt;
	at org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:135)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:453)&lt;br/&gt;
	at org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:681)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:292)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:150)&lt;br/&gt;
	at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:116)&lt;br/&gt;
	at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)&lt;br/&gt;
	at org.apache.activemq.transport.vm.VMTransport.iterate(VMTransport.java:231)&lt;br/&gt;
	at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:122)&lt;br/&gt;
	at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:43)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:680)&lt;br/&gt;
Caused by: java.util.ConcurrentModificationException&lt;br/&gt;
	at java.util.HashMap$HashIterator.nextEntry(HashMap.java:793)&lt;br/&gt;
	at java.util.HashMap$KeyIterator.next(HashMap.java:828)&lt;br/&gt;
	at org.apache.activemq.util.MarshallingSupport.marshalPrimitiveMap(MarshallingSupport.java:64)&lt;br/&gt;
	at org.apache.activemq.command.Message.beforeMarshall(Message.java:210)&lt;br/&gt;
	at org.apache.activemq.command.ActiveMQObjectMessage.beforeMarshall(ActiveMQObjectMessage.java:199)&lt;br/&gt;
	at org.apache.activemq.openwire.v6.MessageMarshaller.looseMarshal(MessageMarshaller.java:277)&lt;br/&gt;
	at org.apache.activemq.openwire.v6.ActiveMQMessageMarshaller.looseMarshal(ActiveMQMessageMarshaller.java:111)&lt;br/&gt;
	at org.apache.activemq.openwire.v6.ActiveMQObjectMessageMarshaller.looseMarshal(ActiveMQObjectMessageMarshaller.java:111)&lt;br/&gt;
	at org.apache.activemq.openwire.OpenWireFormat.marshal(OpenWireFormat.java:168)&lt;br/&gt;
	at org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore.addMessage(KahaDBStore.java:429)&lt;br/&gt;
	at org.apache.activemq.store.kahadb.KahaDBStore$StoreQueueTask.run(KahaDBStore.java:1177)&lt;br/&gt;
	... 3 more&lt;/p&gt;</description>
                <environment>&lt;p&gt;ActiveMQ 5.6.0 standalone, kahadb persistence, Spring JMSTemplate producer (ObjectMessage), Camel 2.9.2 route consumer (AMQ connection pool, vm transport)&lt;/p&gt;</environment>
        <key id="12610178">AMQ-4092</key>
            <summary>ConcurrentModificationException when using message groups</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="boday">Benjamin P. O&apos;Day</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Oct 2012 02:56:44 +0000</created>
                <updated>Tue, 17 Sep 2013 10:19:52 +0000</updated>
                            <resolved>Tue, 17 Sep 2013 10:06:47 +0000</resolved>
                                    <version>5.6.0</version>
                                    <fixVersion>5.9.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13469275" author="gtully" created="Thu, 4 Oct 2012 10:23:41 +0000"  >&lt;p&gt;message groups, makes sense, the problem is in&lt;br/&gt;
org.apache.activemq.broker.region.Queue#assignGroup where the JMSXGroupFirstForConsumer property is set, but the message is being stored concurrently.&lt;br/&gt;
A workaround is to disable kahadb concurrentStoreAndDispatchQueues, set to false. This will ensure that the dispatch (which can set the property) and store do not occur in parallel.&lt;/p&gt;

&lt;p&gt;Need to check up on the need to set that property and see if we can do it after the message  is persisted such that it will work with concurrent store and dispatch.&lt;/p&gt;</comment>
                            <comment id="13469457" author="boday" created="Thu, 4 Oct 2012 15:29:50 +0000"  >&lt;p&gt;thanks Gary, testing with concurrentStoreAndDispatchQueues=false now...so far so good&lt;/p&gt;</comment>
                            <comment id="13469480" author="boday" created="Thu, 4 Oct 2012 16:24:16 +0000"  >&lt;p&gt;alright, concurrentStoreAndDispatchQueues=false appears to have resolved the issue...not sure if we should close this given the work around of if there is a code change to better handle this case w/o that setting...I&apos;ll leave it open for now...thanks again&lt;/p&gt;</comment>
                            <comment id="13506849" author="boday" created="Thu, 29 Nov 2012 21:49:16 +0000"  >&lt;p&gt;After doing some burnin/performance testing with concurrentStoreAndDispatchQueues=&quot;false&quot;...this setting if proving problematic and is causing unacceptable throttling of our application.  Is this issue addressed in a 5.7.0?  if not, any plan to address it?  thanks...&lt;/p&gt;</comment>
                            <comment id="13572630" author="gtully" created="Wed, 6 Feb 2013 18:15:36 +0000"  >&lt;p&gt;line this up for the next release&lt;/p&gt;</comment>
                            <comment id="13629918" author="can_do" created="Fri, 12 Apr 2013 08:21:15 +0000"  >&lt;p&gt;I have the same error in AMQ 5.7.0.&lt;br/&gt;
The detail log is as the following:&lt;br/&gt;
////////////////begin////////////&lt;br/&gt;
javax.jms.JMSException: java.util.ConcurrentModificationException&lt;br/&gt;
        at com.rf.emq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:49)&lt;br/&gt;
        at com.rf.emq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1377)&lt;br/&gt;
        at com.rf.emq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1305)&lt;br/&gt;
        at com.rf.emq.ActiveMQSession.send(ActiveMQSession.java:2060)&lt;br/&gt;
        at com.rf.emq.ActiveMQMessageProducer.send(ActiveMQMessageProducer.java:277)&lt;br/&gt;
        at com.rf.emq.ActiveMQMessageProducer.send(ActiveMQMessageProducer.java:212)&lt;br/&gt;
        at com.rf.emq.ActiveMQMessageProducerSupport.send(ActiveMQMessageProducerSupport.java:241)&lt;br/&gt;
        at com.rf.emq.product.message.ByteMessageSender.produceMessageInFragmentWithReturnValue(ByteMessageSender.java:166)&lt;br/&gt;
        at com.rf.emq.product.web.AutoSplitLargeFileAndSendTimerTask.splitLargeFile(AutoSplitLargeFileAndSendTimerTask.java:693)&lt;br/&gt;
        at com.rf.emq.product.web.AutoSplitLargeFileAndSendTimerTask$SplitLargFileSubTask.run(AutoSplitLargeFileAndSendTimerTask.j&lt;br/&gt;
ava:879)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:722)&lt;br/&gt;
Caused by: java.util.concurrent.ExecutionException: java.util.ConcurrentModificationException&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:252)&lt;br/&gt;
        at java.util.concurrent.FutureTask.get(FutureTask.java:111)&lt;br/&gt;
        at com.rf.emq.broker.region.Queue.doMessageSend(Queue.java:795)&lt;br/&gt;
        at com.rf.emq.broker.region.Queue.send(Queue.java:717)&lt;br/&gt;
        at com.rf.emq.broker.region.AbstractRegion.send(AbstractRegion.java:407)&lt;br/&gt;
        at com.rf.emq.broker.region.RegionBroker.send(RegionBroker.java:503)&lt;br/&gt;
        at com.rf.emq.broker.jmx.ManagedRegionBroker.send(ManagedRegionBroker.java:311)&lt;br/&gt;
        at com.rf.emq.broker.BrokerFilter.send(BrokerFilter.java:129)&lt;br/&gt;
        at com.rf.emq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:96)&lt;br/&gt;
        at com.rf.emq.broker.TransactionBroker.send(TransactionBroker.java:317)&lt;br/&gt;
        at com.rf.emq.broker.BrokerFilter.send(BrokerFilter.java:129)&lt;br/&gt;
        at com.rf.emq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:135)&lt;br/&gt;
        at com.rf.emq.broker.TransportConnection.processMessage(TransportConnection.java:450)&lt;br/&gt;
        at com.rf.emq.command.ActiveMQMessage.visit(ActiveMQMessage.java:680)&lt;br/&gt;
        at com.rf.emq.broker.TransportConnection.service(TransportConnection.java:294)&lt;br/&gt;
        at com.rf.emq.broker.TransportConnection$1.onCommand(TransportConnection.java:152)&lt;br/&gt;
        at com.rf.emq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:116)&lt;br/&gt;
        at com.rf.emq.transport.MutexTransport.onCommand(MutexTransport.java:50)&lt;br/&gt;
        at com.rf.emq.transport.vm.VMTransport.iterate(VMTransport.java:241)&lt;br/&gt;
        at com.rf.emq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:129)&lt;br/&gt;
        at com.rf.emq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:47)&lt;br/&gt;
        ... 3 more&lt;br/&gt;
Caused by: java.util.ConcurrentModificationException&lt;br/&gt;
        at java.util.HashMap$HashIterator.nextEntry(HashMap.java:806)&lt;br/&gt;
        at java.util.HashMap$KeyIterator.next(HashMap.java:841)&lt;br/&gt;
        at com.rf.emq.util.MarshallingSupport.marshalPrimitiveMap(MarshallingSupport.java:64)&lt;br/&gt;
        at com.rf.emq.command.Message.beforeMarshall(Message.java:215)&lt;br/&gt;
        at com.rf.emq.openwire.v6.MessageMarshaller.looseMarshal(MessageMarshaller.java:277)&lt;br/&gt;
        at com.rf.emq.openwire.v6.ActiveMQMessageMarshaller.looseMarshal(ActiveMQMessageMarshaller.java:111)&lt;br/&gt;
        at com.rf.emq.openwire.v6.ActiveMQBytesMessageMarshaller.looseMarshal(ActiveMQBytesMessageMarshaller.java:111)&lt;br/&gt;
        at com.rf.emq.openwire.OpenWireFormat.marshal(OpenWireFormat.java:168)&lt;br/&gt;
        at com.rf.emq.store.kahadb.KahaDBStore$KahaDBMessageStore.addMessage(KahaDBStore.java:431)&lt;br/&gt;
        at com.rf.emq.store.kahadb.KahaDBStore$StoreQueueTask.run(KahaDBStore.java:1192)&lt;br/&gt;
        ... 3 more&lt;br/&gt;
////////////////end///////////////&lt;/p&gt;</comment>
                            <comment id="13629921" author="can_do" created="Fri, 12 Apr 2013 08:26:40 +0000"  >&lt;p&gt;I have set the message property such as msg.setGroupID(&quot;GROUPBEGIN_&quot; + encodedName + &quot;&lt;em&gt;GROUPEND&lt;/em&gt;&quot;&lt;br/&gt;
				+ file.length()) and msg.setGroupSequence(++i);&lt;br/&gt;
From message property,I see the value of JMSXGroupFirstForConsumer is true.&lt;/p&gt;

&lt;p&gt;Whether this extensive property JMSXGroupFirstForConsumer can be set to false and problem can be eliminated or not.&lt;/p&gt;</comment>
                            <comment id="13660857" author="boday" created="Fri, 17 May 2013 16:59:51 +0000"  >&lt;p&gt;when this ConcurrentModificationException event occurs...does an exception get thrown back to the producer or consumer of this message or is the issue just with setting the JMSXGroupFirstForConsumer property?&lt;/p&gt;</comment>
                            <comment id="13727342" author="the_amol" created="Fri, 2 Aug 2013 05:16:54 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;i am not an expert using Activemq..but i am facing the same issue. Gary Tully can you please suggest where to add, i.e. under which section, the fix code i.e. &quot;concurrentStoreAndDispatchQueues=false&quot; in activemq.xml? or please provide sample activemq.xml file with this workaround.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
amol&lt;/p&gt;</comment>
                            <comment id="13727530" author="gtully" created="Fri, 2 Aug 2013 10:08:51 +0000"  >&lt;p&gt;@Amol google is always your friend. It is an option on kahadb - &lt;a href=&quot;http://activemq.apache.org/kahadb.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/kahadb.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;so &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;broker brokerName=&lt;span class=&quot;code-quote&quot;&gt;&quot;broker&quot;&lt;/span&gt; ... &amp;gt;
   &amp;lt;persistenceAdapter&amp;gt;
     &amp;lt;kahaDB ... concurrentStoreAndDispatchQueues =&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;/&amp;gt;
   &amp;lt;/persistenceAdapter&amp;gt;
   ...
 &amp;lt;/broker&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13727557" author="the_amol" created="Fri, 2 Aug 2013 10:47:47 +0000"  >&lt;p&gt;Gary, thanks for replying. I used the settings..but still i am getting the&lt;br/&gt;
same exception and failure for same file but at random occasions i.e. the&lt;br/&gt;
same file is working fine most of time and some time it is failing. I am&lt;br/&gt;
using latest release of activemq i.e.5.8.0&lt;/p&gt;

&lt;p&gt;Please suggest.&lt;/p&gt;
</comment>
                            <comment id="13768717" author="gtully" created="Mon, 16 Sep 2013 20:29:25 +0000"  >&lt;p&gt;@Amol - are you using composite destinations in your producers?&lt;/p&gt;</comment>
                            <comment id="13769387" author="gtully" created="Tue, 17 Sep 2013 10:06:47 +0000"  >&lt;p&gt;fix in &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/activemq/commit/dd91e859&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/activemq/commit/dd91e859&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;JMSXGroupFirstForConsumer property is now backed by a message attribute which avoids contention. requires v10 wireformat&lt;/p&gt;</comment>
                            <comment id="13769398" author="the_amol" created="Tue, 17 Sep 2013 10:19:52 +0000"  >&lt;p&gt;thanks Gary..i will give it a try.&lt;/p&gt;






&lt;p&gt;&amp;#8211; &lt;br/&gt;
Thanks &amp;amp; Regards&lt;br/&gt;
Amol Verma&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>240208</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 10 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i00yhb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3518</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>