<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:39:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1940] Negative queue size (reproducible)</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1940</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;When you &quot;purge&quot; queue from web admin console, it zeroes queue message&lt;br/&gt;
counter. But if you have an active consumer at that time which&lt;br/&gt;
pre-fetched messages than your consumer will keep sending ack as it&lt;br/&gt;
process messages from its buffer. ActiveMQ will keep decrement counter&lt;br/&gt;
upon receiving each ack. So when consumer is done queue will show&lt;br/&gt;
MINUS&amp;lt;consumer buffer size&amp;gt;.&lt;/p&gt;
</description>
                <environment>&lt;p&gt;Found on Windows but reproduced under Linux&lt;/p&gt;</environment>
        <key id="12482508">AMQ-1940</key>
            <summary>Negative queue size (reproducible)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="vchekan">Vadim Chekan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Sep 2008 07:14:12 +0000</created>
                <updated>Tue, 24 Jan 2017 13:49:20 +0000</updated>
                            <resolved>Tue, 24 Jan 2017 13:49:20 +0000</resolved>
                                    <version>5.2.0</version>
                                    <fixVersion>5.15.0</fixVersion>
                    <fixVersion>5.14.4</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>5</votes>
                                    <watches>14</watches>
                                                                                                                                                            <comments>
                            <comment id="12940208" author="vchekan" created="Wed, 17 Sep 2008 07:16:47 +0000"  >&lt;p&gt;Attached program reproduces a queue with -100 messages.&lt;/p&gt;</comment>
                            <comment id="12940244" author="bsnyder" created="Wed, 17 Sep 2008 08:36:16 +0000"  >&lt;p&gt;I&apos;ve created the following test case out of the attached &lt;tt&gt;Main.java&lt;/tt&gt; class: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.apache.activemq.broker.region;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.Connection;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.ConnectionFactory;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.JMSException;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.Message;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.MessageConsumer;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.MessageProducer;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.Queue;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.Session;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.TextMessage;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.management.MBeanServerInvocationHandler;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.management.MalformedObjectNameException;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.management.ObjectName;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; junit.framework.TestCase;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.activemq.ActiveMQConnectionFactory;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.activemq.broker.BrokerService;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.activemq.broker.jmx.QueueViewMBean;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;QueuePurgeTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; TestCase {
    
    BrokerService broker; 
    ConnectionFactory factory; 
    Connection connection;
    Session session;
    Queue queue;
    MessageConsumer consumer;

    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void setUp() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        broker = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BrokerService();
        broker.setUseJmx(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        broker.setPersistent(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        broker.addConnector(&lt;span class=&quot;code-quote&quot;&gt;&quot;tcp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:0&quot;&lt;/span&gt;);
&lt;/span&gt;        broker.start();
        
        factory = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ActiveMQConnectionFactory(&lt;span class=&quot;code-quote&quot;&gt;&quot;vm:&lt;span class=&quot;code-comment&quot;&gt;//localhost&quot;&lt;/span&gt;);
&lt;/span&gt;        
        connection = factory.createConnection();
        connection.start();
    }

    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void tearDown() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        consumer.close();
        session.close();
        connection.stop();
        connection.close();
        broker.stop();
    }
    
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testPurgeQueueWithActiveConsumer() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        createProducerAndSendMessages();        
        QueueViewMBean proxy = getProxyToQueueViewMBean();
        createConsumer();
        proxy.purge();
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Queue size is not zero, it&apos;s &quot;&lt;/span&gt; + proxy.getQueueSize(), 0, proxy.getQueueSize());
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; QueueViewMBean getProxyToQueueViewMBean()
            &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; MalformedObjectNameException, JMSException {
        ObjectName queueViewMBeanName = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ObjectName(&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.activemq&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;:Type=Queue,Destination=&quot;&lt;/span&gt; + 
                queue.getQueueName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;,BrokerName=localhost&quot;&lt;/span&gt;);
        QueueViewMBean proxy = (QueueViewMBean)MBeanServerInvocationHandler.newProxyInstance(
                broker.getManagementContext().getMBeanServer(), 
                queueViewMBeanName, QueueViewMBean.class, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
         
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; proxy;
    }
    
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void createProducerAndSendMessages() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        session =  connection.createSession(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, Session.CLIENT_ACKNOWLEDGE);
        queue = session.createQueue(&lt;span class=&quot;code-quote&quot;&gt;&quot;test1&quot;&lt;/span&gt;);
        MessageProducer producer = session.createProducer(queue);
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0; i&amp;lt;10000; i++) {
            TextMessage message = session.createTextMessage(&lt;span class=&quot;code-quote&quot;&gt;&quot;message &quot;&lt;/span&gt;+i);
            producer.send(message);
        }
        producer.close();
    }
    
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void createConsumer() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        consumer = session.createConsumer(queue);
        &lt;span class=&quot;code-comment&quot;&gt;// wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; buffer fill out
&lt;/span&gt;        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(5*1000);
        
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 100; ++i) {
            Message message = consumer.receive();
            message.acknowledge();
        }
    }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What I&apos;m finding is that failure is intermittent, but I am able to see it once in a while: &lt;/p&gt;

&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;junit.framework.AssertionFailedError: Queue size is not zero expected:&amp;lt;0&amp;gt; but was:&amp;lt;-60&amp;gt;&lt;br/&gt;
	at junit.framework.Assert.fail(Assert.java:47)&lt;br/&gt;
	at junit.framework.Assert.failNotEquals(Assert.java:282)&lt;br/&gt;
	at junit.framework.Assert.assertEquals(Assert.java:64)&lt;br/&gt;
	at junit.framework.Assert.assertEquals(Assert.java:136)&lt;br/&gt;
	at org.apache.activemq.broker.region.QueuePurgeTest.testPurgeQueueWithActiveConsumer(QueuePurgeTest.java:56)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:585)&lt;br/&gt;
	at junit.framework.TestCase.runTest(TestCase.java:154)&lt;br/&gt;
	at junit.framework.TestCase.runBare(TestCase.java:127)&lt;br/&gt;
	at junit.framework.TestResult$1.protect(TestResult.java:106)&lt;br/&gt;
	at junit.framework.TestResult.runProtected(TestResult.java:124)&lt;br/&gt;
	at junit.framework.TestResult.run(TestResult.java:109)&lt;br/&gt;
	at junit.framework.TestCase.run(TestCase.java:118)&lt;br/&gt;
	at junit.framework.TestSuite.runTest(TestSuite.java:208)&lt;br/&gt;
	at junit.framework.TestSuite.run(TestSuite.java:203)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.junit3.JUnit3TestReference.run(JUnit3TestReference.java:130)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:460)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:673)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:386)&lt;br/&gt;
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:196)&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12940240" author="vchekan" created="Wed, 17 Sep 2008 17:48:19 +0000"  >&lt;p&gt;Perhaps it can be made more reproducible if purge is run in a thread parallel to the consumer. I&apos;ll try to rewrite it later tonight.&lt;/p&gt;</comment>
                            <comment id="12940201" author="rajdavies" created="Mon, 22 Sep 2008 18:15:58 +0000"  >&lt;p&gt;Fixed by SVN revision 697921&lt;/p&gt;</comment>
                            <comment id="12940416" author="ghopper" created="Tue, 4 Nov 2008 17:24:51 +0000"  >&lt;p&gt;1693 displays the same symptom of negative message counts.&lt;/p&gt;</comment>
                            <comment id="12940950" author="bmoran" created="Tue, 10 Mar 2009 22:09:18 +0000"  >&lt;p&gt;I can reproduce this in 5.2.0. &lt;br/&gt;
I am going to attach a screenshot.&lt;/p&gt;</comment>
                            <comment id="12940944" author="bmoran" created="Tue, 10 Mar 2009 22:10:35 +0000"  >&lt;p&gt;Screenshot of negative messages, reproducible in 5.2.0 after purging the message queue, STOMP clients.&lt;/p&gt;</comment>
                            <comment id="12941067" author="deathemperor" created="Fri, 27 Mar 2009 09:24:47 +0000"  >&lt;p&gt;I can reproduct this in 5.2.0. This happens to me because there are too many receivers, each of them try to recevie 500 messages but the total messages in queue is smaller, hence negative number.&lt;/p&gt;</comment>
                            <comment id="12941075" author="yuriushakov" created="Fri, 27 Mar 2009 10:37:03 +0000"  >&lt;p&gt;We have the same problem with 5.2.0.  A queue, single consumer, single producer.  We have -1 pending now, 1616 sent, 1617 received.&lt;/p&gt;</comment>
                            <comment id="12941109" author="deathemperor" created="Thu, 2 Apr 2009 08:55:13 +0000"  >&lt;p&gt;I can reproduce this on 5.2.0 too. I have 7 consumers getting 150 messages each. The negative number I receive is -123 at lowest.&lt;/p&gt;</comment>
                            <comment id="12941340" author="wfrag" created="Wed, 20 May 2009 04:44:19 +0000"  >&lt;p&gt;I had the same issue today. &lt;/p&gt;

&lt;p&gt;We are running two AMQ brokers in network of brokers, each one talking to the other one (the duplex is set to false). Under a high load after few hours I&apos;ve noted that one of our queues started growing on both nodes, several thousand of pending messages in about 20 minutes (and the cursor memory usage was quite large). After I accidentally stopped the second node, the network bridge stopped on the first node and the queue size on the first node immediately became &quot;-8&quot;.&lt;/p&gt;

&lt;p&gt;So in my case this probably somehow related to the instability of network of brokers implementation, because if I disable the network connector the system runs stable for several days under the load.&lt;/p&gt;</comment>
                            <comment id="12941375" author="rajdavies" created="Tue, 26 May 2009 08:51:02 +0000"  >&lt;p&gt;Fixed for the 5.3&lt;/p&gt;</comment>
                            <comment id="13715175" author="hubbitus" created="Mon, 22 Jul 2013 12:50:41 +0000"  >&lt;p&gt;We seen such issue on 5.6.0 ActiveMQ.&lt;/p&gt;</comment>
                            <comment id="14049673" author="wschlich" created="Wed, 2 Jul 2014 06:56:30 +0000"  >&lt;p&gt;We also experience this currently with ActiveMQ 5.8.0.&lt;/p&gt;</comment>
                            <comment id="14315643" author="cp123" created="Wed, 11 Feb 2015 06:18:30 +0000"  >&lt;p&gt;Still have this issue in 5.10.0. Moreover, sometime I can see number of pending messages groving, but if I try to browse queue, I see nothing there. I.e. this numbers are all wrong.&lt;/p&gt;</comment>
                            <comment id="14316080" author="cp123" created="Wed, 11 Feb 2015 11:32:45 +0000"  >&lt;p&gt;What I can see in JMX using Hawtio:&lt;br/&gt;
Total dequeue count 2474137&lt;br/&gt;
Total enqueue count 1795563&lt;br/&gt;
Total message count -678584&lt;/p&gt;

&lt;p&gt;BTW, I have camel route within broker, where incoming messages are duplicated in two queues. And, at the moment, web console displays something like:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;queue&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;pending&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;enqueued&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dequeued&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;algo250a&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;856725&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;906471&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1552909&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;algo250b&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;-23451&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;906472&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;929923&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;highwayQueue&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	0&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Last one is inbound queue, algoxxx are outbound. I expect that number of enqueued messages for inbound Q should be equal to number of dequeued. But its always zero.&lt;/p&gt;</comment>
                            <comment id="14316120" author="gtully" created="Wed, 11 Feb 2015 12:06:04 +0000"  >&lt;p&gt;@Sergey - can you make a junit test case that can reproduce - peek at the activemq-camel module if you need to use camel routes&lt;/p&gt;</comment>
                            <comment id="14316127" author="cp123" created="Wed, 11 Feb 2015 12:14:08 +0000"  >&lt;p&gt;I&apos;ve just created &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5576&quot; title=&quot;Reported queue sizes and counters are wrong in many cases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5576&quot;&gt;AMQ-5576&lt;/a&gt;, and where is a route test case.&lt;/p&gt;

&lt;p&gt;Just deploy this route, and send 1 message into inbound queue using web console, it should be enough to reproduce some of issues with counters/sizes.&lt;/p&gt;</comment>
                            <comment id="15830358" author="christopher.l.shannon" created="Thu, 19 Jan 2017 18:14:13 +0000"  >&lt;p&gt;I noticed this issue today when doing a purge.  I believe the issue is that after the messages are removed in the do/while loop inside the queue purge method the statistics counter is reset to 0.  This is a problem because there is nothing preventing messages from being added to the Queue in between message removal and resetting of the counters.  This means it&apos;s possible to have new messages in the queue but the counter is set to 0 such that the count will now go negative when those messages acked.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;, I think the fix is as simple as removing two lines of code on line 1267 and 1268.  &lt;a href=&quot;https://github.com/apache/activemq/blob/activemq-5.14.3/activemq-broker/src/main/java/org/apache/activemq/broker/region/Queue.java#L1267&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/activemq-5.14.3/activemq-broker/src/main/java/org/apache/activemq/broker/region/Queue.java#L1267&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I don&apos;t see any reason why we should need to reset the messages cursor or the messages statistics counter to 0 at the end if the purge behaves properly as the counter should already be properly decremented when each message is dropped.  What do you think?&lt;/p&gt;</comment>
                            <comment id="15831541" author="gtully" created="Fri, 20 Jan 2017 10:57:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; that is interesting.. I agree, setting to zero does seem wrong.  Also, I think it makes sense to sync some more such that both sending and dispatch is locked out.&lt;br/&gt;
Seems there two issues: &lt;br/&gt;
 1) the concurrent send issue&lt;br/&gt;
 2) removing messages that may be dispatched and the ack doing a double decrement&lt;/p&gt;

&lt;p&gt;for 1) locking is the answer&lt;br/&gt;
for 2) locking and then a) ensuring that an ack does not decrement if the message cannot be found or b) purge ignoring inflight messages or c) ensuring the stat cannot go negative. &lt;/p&gt;

&lt;p&gt;2b may be the cleanest but may be difficult to implement, on balance maybe go for 2a. 2c would potentially hide later problems &lt;/p&gt;</comment>
                            <comment id="15831571" author="christopher.l.shannon" created="Fri, 20 Jan 2017 11:30:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;, Thanks for the feedback.  I was going to try for option 2a) (and possibly 2b) initially because it seems like some of that work might have already been done over the years to prevent handling acks for messages that don&apos;t exist.  I will check the ack handling to verify and see what changes are needed.&lt;/p&gt;

&lt;p&gt;In terms of locking I thought about this but was concerned about it being a bit slow if the purge took a long time.  My initial thought was to just grab a write lock on the pagedInMessagesLock for the entire purge() method and release when purge is done.  This should prevent new messages from being sent to the Queue.  Off the top of my head I don&apos;t remember if that is sufficient for preventing dispatch or if we need to grab another lock such as the messages lock or pagedInPendingDispatchLock. &lt;/p&gt;</comment>
                            <comment id="15831728" author="gtully" created="Fri, 20 Jan 2017 13:12:34 +0000"  >&lt;p&gt;I don&apos;t think perf is a problem with the purge operation. an all out destination pause is sensible to maintain consistent state. I think purge needs to take  the sendLock and pagedInPendingDispatchLock. It is like purge a snapshot. Inflight sends can still be inflight. &lt;/p&gt;</comment>
                            <comment id="15831736" author="christopher.l.shannon" created="Fri, 20 Jan 2017 13:27:40 +0000"  >&lt;p&gt;Makes sense, I don&apos;t think I&apos;ll get a chance today but hopefully Monday I&apos;ll take a look at a patch for this.&lt;/p&gt;</comment>
                            <comment id="15835130" author="christopher.l.shannon" created="Mon, 23 Jan 2017 19:53:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;, I don&apos;t think we need to do anything here other than to grab the sendLock to prevent new messages from coming in while the purge is running and works its way through all the pending messages in the queue including already dispatched messages (we can also remove the line of code that sets the count to 0 which isn&apos;t necessary)&lt;/p&gt;

&lt;p&gt;For messages that are already dispatched we don&apos;t seem to need to worry about the ack doing a double decrement.  If the Queue has been purged and the already dispatched messages are acked later the metrics don&apos;t double decrement because in dropMessage() there is a dropIfLive() check that will fail.  This scenario is already shown if you look at QueuePurgeTest and run testPurgeLargeQueueWithConsumer.  This test shows that after a purge if the consumer acks the messages already in prefetch the messages count doesn&apos;t go negative.&lt;/p&gt;

&lt;p&gt;I suppose an argument could be made that we should clear out the dispatch list in each subscription to save memory but then if messages are acked we&apos;d get a bunch of unmatched acknowledge warnings in the log because assertAckMatchesDispatched() in PrefetchSubscription would throw a bunch of exceptions when the acks came in.&lt;/p&gt;</comment>
                            <comment id="15836148" author="jira-bot" created="Tue, 24 Jan 2017 13:48:20 +0000"  >&lt;p&gt;Commit 56bb079c8227a2beee609b205c001d66597db98a in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=56bb079&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=56bb079&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1940&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-1940&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Queue purge now acquires the sendLock to prevent new messages from&lt;br/&gt;
coming in while purging.  The statistics are no longer zeroed out as&lt;br/&gt;
they should properly decrement as messages are removed.  These changes&lt;br/&gt;
should prevent the statistics from going negative.&lt;/p&gt;</comment>
                            <comment id="15836149" author="jira-bot" created="Tue, 24 Jan 2017 13:48:35 +0000"  >&lt;p&gt;Commit 1811d191afa91d15e6a37d13dbfd7fd8ef32690e in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1811d19&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1811d19&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1940&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-1940&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Queue purge now acquires the sendLock to prevent new messages from&lt;br/&gt;
coming in while purging.  The statistics are no longer zeroed out as&lt;br/&gt;
they should properly decrement as messages are removed.  These changes&lt;br/&gt;
should prevent the statistics from going negative.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 56bb079c8227a2beee609b205c001d66597db98a)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12482854">AMQ-1693</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12461247" name="Main.java" size="3675" author="vchekan" created="Wed, 17 Sep 2008 07:16:46 +0000"/>
                            <attachment id="12461388" name="Picture 6.png" size="123479" author="bmoran" created="Tue, 10 Mar 2009 22:10:35 +0000"/>
                            <attachment id="12461132" name="QueuePurgeTest.java.diff.txt" size="3768" author="bsnyder" created="Wed, 17 Sep 2008 14:45:04 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12482854">AMQ-1693</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>75166</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 43 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rzw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161459</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310080" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Regression</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10091"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>