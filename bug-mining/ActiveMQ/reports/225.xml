<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:33:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1254] Kaha Store puts a non-string into System properties</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1254</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;KahaStore puts a hashmap into SystemProperties, which causes problems with programs that expect only strings as properties.  In particular some versions of Hibernate assume all system properties are strings: this is causing difficulties running roller in geronimo 2.0&lt;/p&gt;

&lt;p&gt;Attached is a proposed solution.  I have no idea how to test it.  I get the same 7 failures and one error building amq with and without the change.&lt;/p&gt;

&lt;p&gt;The proposal stores the list of locked directories in a string and converts it back and forth to a map whenever it is accessed.  I use a constant string as the vm-wide lock monitor formerly provided by the HashSet.  According to the String javadoc constant strings are intern()ed and the same instance is provided in any classloader: this makes it suitable for a vm-wide lock monitor.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12482414">AMQ-1254</key>
            <summary>Kaha Store puts a non-string into System properties</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="djencks">David Jencks</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 May 2007 22:39:36 +0000</created>
                <updated>Wed, 9 Apr 2008 08:24:48 +0000</updated>
                            <resolved>Wed, 9 Apr 2008 08:24:48 +0000</resolved>
                                    <version>4.1.2</version>
                                    <fixVersion>5.1.0</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="12936346" author="djencks" created="Thu, 7 Jun 2007 22:10:46 +0000"  >&lt;p&gt;Apparently there&apos;s a similar problem with a property called org.apache.activeio.journal.active.lockMap&lt;/p&gt;</comment>
                            <comment id="12936603" author="solprovider" created="Wed, 13 Jun 2007 16:37:26 +0000"  >&lt;p&gt;These issues are both related to locking systems.  The HashSet and HashMap contain a list of locked items.  This sounds troublesome because the classes are not synchronized.  System.Properties is a HashTable (automatically synchronized.)  System.Properties is being violated: &quot;Each key and its corresponding value in the property list is a string.&quot; from &lt;a href=&quot;http://java.sun.com/j2se/1.4.2/docs/api/java/util/Properties.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://java.sun.com/j2se/1.4.2/docs/api/java/util/Properties.html&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;Test Code&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; test(){  &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; = passes, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; = failed.
&lt;/span&gt;      &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; test = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
      java.util.Properties properties = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getProperties();
      java.util.Enumeration enumeration = properties.elements();
      &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(test &amp;amp; enumeration.hasMoreElements()) test= &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;equals(enumeration.nextElement().getClass());
      enumeration = properties.keys();
      &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(test &amp;amp; enumeration.hasMoreElements()) test= &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;equals(enumeration.nextElement().getClass());
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; test;
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;The typical algorithm for locking is to put an identifier as a key into the central location.  No objects are stored; use a static class if necessary, but this typically indicates poor design.  The property value is not needed for the locking system and typically contains information about the lock such as who created it and when. So locking C:Windows\Temp\badcode.java could create:&lt;br/&gt;
KEY: org.apache.activeio.journal.active.lockMap.C%3aWindows%2cTemp%2cbadcode%2ejava&lt;br/&gt;
VALUE: 20070613T122219Z solprovider reason&lt;/p&gt;

&lt;p&gt;Set locks with System.setProperty(key, informationString);&lt;br/&gt;
Get the information about a lock with System.getProperty(key);&lt;br/&gt;
Check locks with System.getProperties().containsKey(key);&lt;br/&gt;
Remove locks with System.getProperties().remove(key);&lt;/p&gt;


</comment>
                            <comment id="12936235" author="djencks" created="Tue, 19 Jun 2007 23:01:21 +0000"  >&lt;p&gt;See also &lt;a href=&quot;https://issues.apache.org/jira/browse/GERONIMO-3243&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/GERONIMO-3243&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The reason amq is using this peculiar design is that they need a lock across the entire vm, not just within one classloader.  Putting something in System.getProperties is a simple way to do that and it&apos;s not too easy to think of another way.  However it is possible to change what the locked object is to a string, although at a slight cost.&lt;/p&gt;</comment>
                            <comment id="12936490" author="solprovider" created="Sat, 23 Jun 2007 21:54:40 +0000"  >&lt;p&gt;The reason amq is using this poor design is a programmer did not read the docs for the System and Properties classes: &quot;Because Properties inherits from Hashtable, the put and putAll methods can be applied to a Properties object. Their use is strongly discouraged as they allow the caller to insert entries whose keys or values are not Strings. The setProperty method should be used instead.&quot;  ActiveMQ even contains code that will break if System.Properties contains elements that cannot be cast to String.&lt;/p&gt;

&lt;p&gt;To fix this:&lt;br/&gt;
1. Discard function getVmLockSet().  The locks cannot use a Set.&lt;br/&gt;
2. Change lock() and unlock() to this code:&lt;br/&gt;
(These functions are in KahaStore.java from the trunk today 20070623.)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;Good Locking&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void lock() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!disableLocking &amp;amp;&amp;amp; directory != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; lock == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
		&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key = getPropertyKey();
		&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; property = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getProperty(key);
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; == property) {
			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!brokenFileLock) {
				lock = rootIndexManager.getLock();
				&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lock == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StoreLockedExcpetion(&lt;span class=&quot;code-quote&quot;&gt;&quot;Kaha Store &quot;&lt;/span&gt; + directory.getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;  is already opened by another application&quot;&lt;/span&gt;);
				} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
					&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setProperty(key, &lt;span class=&quot;code-quote&quot;&gt;&quot;LOCK&quot;&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;//Could store datetime of lock.
&lt;/span&gt;			}
		} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; { &lt;span class=&quot;code-comment&quot;&gt;//already locked
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StoreLockedExcpetion(&lt;span class=&quot;code-quote&quot;&gt;&quot;Kaha Store &quot;&lt;/span&gt; + directory.getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot; is already opened by &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; application.&quot;&lt;/span&gt;);
		}
	}
}
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void unlock() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!disableLocking &amp;amp;&amp;amp; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != directory) &amp;amp;&amp;amp; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != lock)) {
		&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getProperties().remove(getPropertyKey());
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lock.isValid()) {
			lock.release();
		}
		lock = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
	}
}
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getPropertyKey(){
	&lt;span class=&quot;code-comment&quot;&gt;//Is replaceAll() needed?  Should test without it.
&lt;/span&gt;	&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; getClass().getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;.lock.&quot;&lt;/span&gt; + directory.getCanonicalPath().replaceAll(&lt;span class=&quot;code-quote&quot;&gt;&quot;[:/\\\\]&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;.&quot;&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This should be faster since we are not retrieving a Set&amp;lt;String&amp;gt; (but it will slow code that checks every System.Property.) This should use less memory since we do not have the overhead of one Set&amp;lt;String&amp;gt;. This does not violate System.Properties by bypassing its functions to use the parent HashMap functions.&lt;/p&gt;

&lt;p&gt;Warning: I am not set up to work with Java 1.5 (required by this class) so this needs to be tested.&lt;/p&gt;</comment>
                            <comment id="12936269" author="qsu" created="Mon, 16 Jul 2007 23:44:15 +0000"  >&lt;p&gt;Is there an estimated time to fix for setting property org.apache.activeio.journal.active.lockMap to String? Thx!&lt;/p&gt;</comment>
                            <comment id="12936265" author="rajdavies" created="Mon, 23 Jul 2007 15:28:25 +0000"  >&lt;p&gt;SVN  revision 558774&lt;/p&gt;</comment>
                            <comment id="12936221" author="qsu" created="Mon, 23 Jul 2007 18:30:37 +0000"  >&lt;p&gt;Does release 5 come with the fixed version of activeio, i.e. property org.apache.activeio.journal.active.lockMap is set to string properly? As far as I know, release 4.1.1 comes with activeio-3.0.0-incubator which has the bug and their current trunk has it fixed.&lt;/p&gt;

&lt;p&gt;Thx!&lt;/p&gt;</comment>
                            <comment id="12939436" author="djencks" created="Tue, 25 Mar 2008 00:52:55 +0000"  >&lt;p&gt;Committed improved fix in 4.1 branch rev 640659.&lt;/p&gt;

&lt;p&gt;The trunk fix completely ignores the main point of the lock, which is to prevent copies of activemq in the same vm but in different classloaders from attempting to use the same file.  The branch fix locks on a constant string, which according to the java docs is interned and thus guaranteed to be the same object across classloaders.&lt;/p&gt;</comment>
                            <comment id="12939417" author="rajdavies" created="Wed, 9 Apr 2008 08:24:48 +0000"  >&lt;p&gt;Fixed by SVN revision 646219&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461013" name="ASF.LICENSE.NOT.GRANTED--Kaha-Store.patch" size="4382" author="djencks" created="Mon, 28 May 2007 22:39:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84594</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 33 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s1u7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161774</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>