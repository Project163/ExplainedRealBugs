<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:54:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3669] Pending producer with qMirror, messages are not spooled to disk</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3669</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;We fill a queue that is backed by a qmirror with data (persistent) that exceeds the configured memory limit.&lt;br/&gt;
The producer (producerFlowControl=&quot;true&quot; at queue and qmirror) will be throttled when the the limit is reached, no messages are spooled to disk.&lt;br/&gt;
As an overall result, we are not able to write a lot of messages into amq.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Configuration:&lt;/b&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt; 
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;destinationInterceptors&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;mirroredQueue copyMessage = &lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt; postfix=&lt;span class=&quot;code-quote&quot;&gt;&quot;.qmirror&quot;&lt;/span&gt; prefix=&quot;&quot;/&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/destinationInterceptors&amp;gt;&lt;/span&gt;

	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;destinationPolicy&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;policyMap&amp;gt;&lt;/span&gt;
		  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;policyEntries&amp;gt;&lt;/span&gt;
			&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;policyEntry topic=&lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;gt;&lt;/span&gt;&quot;&lt;/span&gt; producerFlowControl=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt; memoryLimit=&lt;span class=&quot;code-quote&quot;&gt;&quot;2mb&quot;&lt;/span&gt; /&amp;gt;
			&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;policyEntry queue=&lt;span class=&quot;code-quote&quot;&gt;&quot;created.static.for.persistent&quot;&lt;/span&gt; producerFlowControl=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt; memoryLimit=&lt;span class=&quot;code-quote&quot;&gt;&quot;1mb&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
		  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/policyEntries&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/policyMap&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/destinationPolicy&amp;gt;&lt;/span&gt; 

	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;destinations&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;queue physicalName=&lt;span class=&quot;code-quote&quot;&gt;&quot;created.static.for.persistent&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/destinations&amp;gt;&lt;/span&gt;

	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;persistenceAdapter&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;kahaDB directory=&lt;span class=&quot;code-quote&quot;&gt;&quot;${activemq.base}/data/kahadb&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/persistenceAdapter&amp;gt;&lt;/span&gt;
	
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;systemUsage&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;systemUsage&amp;gt;&lt;/span&gt;
			&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;memoryUsage&amp;gt;&lt;/span&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;memoryUsage limit=&lt;span class=&quot;code-quote&quot;&gt;&quot;10 mb&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/memoryUsage&amp;gt;&lt;/span&gt;
			&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;storeUsage&amp;gt;&lt;/span&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;storeUsage limit=&lt;span class=&quot;code-quote&quot;&gt;&quot;100 mb&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/storeUsage&amp;gt;&lt;/span&gt;
			&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;tempUsage&amp;gt;&lt;/span&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;tempUsage limit=&lt;span class=&quot;code-quote&quot;&gt;&quot;100 mb&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/tempUsage&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/systemUsage&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/systemUsage&amp;gt;&lt;/span&gt;
	
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;transportConnectors&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;transportConnector name=&lt;span class=&quot;code-quote&quot;&gt;&quot;openwire&quot;&lt;/span&gt; uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;tcp://0.0.0.0:61616&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/transportConnectors&amp;gt;&lt;/span&gt;
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Java test code:&lt;/b&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
    ActiveMQConnectionFactory factory = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ActiveMQConnectionFactory(&lt;span class=&quot;code-quote&quot;&gt;&quot;tcp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:61616&quot;&lt;/span&gt;);
&lt;/span&gt;    Connection connection = factory.createConnection(&lt;span class=&quot;code-quote&quot;&gt;&quot;user&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;pwd&quot;&lt;/span&gt;);
    connection.start();
    Session session = connection.createSession(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, Session.CLIENT_ACKNOWLEDGE);
    Destination destination = session.createQueue(&lt;span class=&quot;code-quote&quot;&gt;&quot;created.&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;.persistent&quot;&lt;/span&gt;);
    MessageProducer producer = session.createProducer(destination);
    producer.setDeliveryMode(DeliveryMode.PERSISTENT);
    &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;[] m = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;[1024];
    Arrays.fill(m, &lt;span class=&quot;code-quote&quot;&gt;&apos;x&apos;&lt;/span&gt;);
    &lt;span class=&quot;code-comment&quot;&gt;// create some messages that have 1k each
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 12000; i++) {
      ActiveMQTextMessage message = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ActiveMQTextMessage();
      message.setText(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;(m));
      producer.send(message);
    }
    connection.stop();
    connection.close();
  }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;&lt;b&gt;Expectation:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Messages should be written to disk when the memory limit exceeds, all messages should be available within the queue/topic.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Result:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt; INFO | Usage Manager memory limit (2097152) reached for topic://created.static.for.persistent.qmirror. Producers will be throttled to the rate at which messages are removed from this destination to prevent flooding it. See &lt;a href=&quot;http://activemq.apache.org/producer-flow-control.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/producer-flow-control.html&lt;/a&gt; for more info&lt;/p&gt;

&lt;p&gt;Store percent used  : 10 &lt;br/&gt;
Memory percent used : 20&lt;br/&gt;
Temp percent used   : 0&lt;/p&gt;

&lt;p&gt;Interesting: The smaller flow control for the queue (1mb) does not seem to catch but the qmirror does (2mb).&lt;/p&gt;</description>
                <environment>&lt;p&gt;local test on windows, happens also on linux remotely&lt;/p&gt;</environment>
        <key id="12539109">AMQ-3669</key>
            <summary>Pending producer with qMirror, messages are not spooled to disk</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="darius.schier">Darius Schier</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 Jan 2012 09:37:16 +0000</created>
                <updated>Fri, 2 Jun 2017 09:35:40 +0000</updated>
                            <resolved>Wed, 23 May 2012 20:27:50 +0000</resolved>
                                    <version>5.5.1</version>
                                    <fixVersion>5.7.0</fixVersion>
                                    <component>Broker</component>
                    <component>Message Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13189863" author="darius.schier" created="Fri, 20 Jan 2012 16:06:48 +0000"  >&lt;p&gt;One more information: If we set &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;policyEntry topic=&quot;&amp;gt;&quot; producerFlowControl=&quot;false&quot; memoryLimit=&quot;2mb&quot; /&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;we get &lt;/p&gt;

&lt;p&gt;Memory percent used: 100&lt;/p&gt;

&lt;p&gt;after inserting 5111 messages. Console tells&lt;/p&gt;

&lt;p&gt; INFO | Started SelectChannelConnector@0.0.0.0:8161&lt;br/&gt;
 INFO | Usage Manager Memory Limit (1048576) reached on queue://created.static.for.persistent. Producers will be throttled to the rate at which messages are removed from this destination to prevent flooding it. See &lt;a href=&quot;http://activemq.apache.org/producer-flow-control.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/producer-flow-control.html&lt;/a&gt; for more info&lt;/p&gt;

&lt;p&gt;Another indication that no messages are spooled to disk?&lt;/p&gt;</comment>
                            <comment id="13208297" author="pse" created="Wed, 15 Feb 2012 09:21:24 +0000"  >&lt;p&gt;We ran into a similar problem. Disabling flow control for the mirror topics helped.&lt;/p&gt;

&lt;p&gt;I&apos;m still not exactly sure what happens &amp;#8211; &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3671&quot; title=&quot;qMirror without (durable) consumer does not need to strain memory limits&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3671&quot;&gt;&lt;del&gt;AMQ-3671&lt;/del&gt;&lt;/a&gt; suggest that the mirrored Messages are cached in the mirrored Topic, even if no subscribers are present. I&apos;m not sure about that, since I did not observe an increase in memomry usage in the same amount as I piped messagues through my mirrored queues. Anyway, it DOES seem like a bug to me that flow control is applied in this case.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &amp;lt;destinationPolicy&amp;gt;
    &amp;lt;policyMap&amp;gt;
      &amp;lt;policyEntries&amp;gt;
        ...
        &amp;lt;policyEntry topic=&lt;span class=&quot;code-quote&quot;&gt;&quot;*.qmirror&quot;&lt;/span&gt; producerFlowControl=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;/&amp;gt;
      &amp;lt;/policyEntries&amp;gt;
    &amp;lt;/policyMap&amp;gt;
  &amp;lt;/destinationPolicy&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13279665" author="ccorsi" created="Sun, 20 May 2012 05:19:49 +0000"  >&lt;p&gt;I was able to determine what the problem was with this issue.&lt;/p&gt;

&lt;p&gt;It is that when we initially forward the message to the mirrored topic.  The message memory usage instance is set to the topic.&lt;/p&gt;

&lt;p&gt;When the message is sent to the queue, the memory usage instance is not set to the queue memory usage but it still uses the topic memory usage.&lt;/p&gt;

&lt;p&gt;The message setRegionDestination method is used to set the message memory usage but this is only performed if and only if the current message memory usage instance is null.  This is not the case when forwarding the message to the queue and that is why the memory usage of the topic gets affected causing the producer flow control to throttle the topic/queue when that is not the case.&lt;/p&gt;</comment>
                            <comment id="13279666" author="ccorsi" created="Sun, 20 May 2012 05:21:21 +0000"  >&lt;p&gt;This patch contains a test and the fix to this issue.&lt;/p&gt;

&lt;p&gt;btw, this patch was applied against trunk and I have not tried to apply this on an earlier version.&lt;/p&gt;</comment>
                            <comment id="13281879" author="tabish121" created="Wed, 23 May 2012 20:27:50 +0000"  >&lt;p&gt;Patch applied with thanks. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13076754">AMQ-6695</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12528300" name="mirroredqueue.diffs" size="8479" author="ccorsi" created="Sun, 20 May 2012 05:21:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>224611</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 26 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0aibz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59243</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>