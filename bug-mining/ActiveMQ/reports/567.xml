<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:39:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2109] Proxy Consumers are not closed when a consumer closes on a networked broker </title>
                <link>https://issues.apache.org/jira/browse/AMQ-2109</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;This error occurs, when we have two brokers BrokerA and BrokerB. The simplest case is BrokerA being networked to BrokerB with a static network connector. If a consumer is created on BrokerB for a queue TEST, we will also note a consumer being established on BrokerA for that Queue, which is the intended behavior. If the consumer is closed on BrokerB, the proxy consumer on BrokerA continues to exist. Now consider the client reconnects due to failover reasons to BrokerA this time. BrokerA would then have 2 consumers on TEST, causing a portion of the messages being consumed by the proxy consumer. &lt;/p&gt;

&lt;p&gt;So, when a consumer is closed for a queue, the proxy consumers in the peer brokers should also be closed.&lt;/p&gt;</description>
                <environment>&lt;p&gt;This is not related to a specific environment, but could be reproduced on Linux based machines, Windows machines using  different JDK&apos;s.&lt;/p&gt;</environment>
        <key id="12482548">AMQ-2109</key>
            <summary>Proxy Consumers are not closed when a consumer closes on a networked broker </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="atooni">Andreas Gies</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Feb 2009 08:01:47 +0000</created>
                <updated>Tue, 24 Feb 2009 15:10:45 +0000</updated>
                            <resolved>Tue, 24 Feb 2009 15:10:45 +0000</resolved>
                                    <version>5.2.0</version>
                                    <fixVersion>5.3.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12940758" author="atooni" created="Fri, 13 Feb 2009 08:03:48 +0000"  >&lt;p&gt;This is a test case for the error. &lt;/p&gt;</comment>
                            <comment id="12940808" author="atooni" created="Thu, 19 Feb 2009 12:32:58 +0000"  >&lt;p&gt;Analyzing the problem further it seems that the proxy consumer cannot be found once the remote consumer closes. Though the close event is propagated, it is not processed. &lt;br/&gt;
The following diff addresses the problem. It seems, that the consumer id is being changed once the proxy consumer is created both for queues and topics. This makes sense&lt;br/&gt;
in case of topics and durable subscribers as those must survive when the consumer disconnects. For queues that does not make sense as a durable subscriber is not needed &lt;br/&gt;
to trigger a desired persistence mechanism. For these reasons the class DurableConduitBridge has been modified according to the following diff:&lt;/p&gt;

&lt;p&gt;++++ Snip &lt;/p&gt;

&lt;p&gt;Index: src/main/java/org/apache/activemq/network/DurableConduitBridge.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; src/main/java/org/apache/activemq/network/DurableConduitBridge.java	(revision 745834)&lt;br/&gt;
+++ src/main/java/org/apache/activemq/network/DurableConduitBridge.java	(working copy)&lt;br/&gt;
@@ -82,17 +82,11 @@&lt;br/&gt;
         }&lt;br/&gt;
         //add our original id to ourselves&lt;br/&gt;
         info.addNetworkConsumerId(info.getConsumerId());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// not matched so create a new one&lt;/li&gt;
	&lt;li&gt;// but first, if it&apos;s durable - changed set the&lt;/li&gt;
	&lt;li&gt;// ConsumerId here - so it won&apos;t be removed if the&lt;/li&gt;
	&lt;li&gt;// durable subscriber goes away on the other end&lt;/li&gt;
	&lt;li&gt;if (info.isDurable() || (info.getDestination().isQueue() &amp;amp;&amp;amp; !info.getDestination().isTemporary())) 
{  
-            info.setConsumerId(new ConsumerId(localSessionInfo.getSessionId(), consumerIdGenerator
-                .getNextSequenceId()));
-        }
&lt;p&gt;+&lt;br/&gt;
         if (info.isDurable()) &lt;/p&gt;
{
             // set the subscriber name to something reproducible
-
+            info.setConsumerId(new ConsumerId(localSessionInfo.getSessionId(), consumerIdGenerator
+                    .getNextSequenceId()));
             info.setSubscriptionName(getSubscriberName(info.getDestination()));
         }
&lt;p&gt;         info.setSelector(null);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;++++ snap&lt;/p&gt;

&lt;p&gt;This patch didn&apos;t break any existing test and also succeeded with the NetworkBrokerDetachTest provided earlier. &lt;/p&gt;
</comment>
                            <comment id="12940774" author="atooni" created="Thu, 19 Feb 2009 12:34:54 +0000"  >&lt;p&gt;This file contains the patch that presumably fixes the issue. It has been created based on the ActiveMQ 5.3.0 trunk.&lt;/p&gt;</comment>
                            <comment id="12940804" author="gtully" created="Tue, 24 Feb 2009 15:10:45 +0000"  >&lt;p&gt;patch applied with thanks to trunk: r747384&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461275" name="NetworkBrokerDetachTest.java" size="6973" author="atooni" created="Fri, 13 Feb 2009 08:03:48 +0000"/>
                            <attachment id="12461286" name="amq-2109.txt" size="1309" author="atooni" created="Thu, 19 Feb 2009 12:34:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>75071</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 40 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14cpz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>233524</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>