<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:51:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-7298] failover duplicate detection in error with batched local transactions</title>
                <link>https://issues.apache.org/jira/browse/AMQ-7298</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Messages can get poisonAcked in error as duplicate deliveries when a local transaction rollback during/after a failover (auto reconnect) event.&lt;br/&gt;
The interaction between rollback and failover redelivery has a bunch of timing issues and did create duplicates in-error that resulted in over eager suppression.&lt;br/&gt;
There are a bunch of related tests that validate expected behaviour, the related fixes needed to be revisited to better manage the delivered and unconsumed messages in the context of a local transaction and to avoid the real duplication of delivery in the client.&lt;br/&gt;
There is an additional new test that demonstrates the additional dlq or duplicates behaviour.&lt;/p&gt;

&lt;p&gt;a nice cross section from the unit test suite is:&lt;br/&gt;
mvn clean install -Dtest=CloseRollbackRedeliveryQueueTest,AMQ2149Test,JMSQueueRedeliverTest,RedeliveryPolicyTest,FailoverTransactionTest,FailoverDurableSubTransactionTest,JMSConsumerTest,JmsSessionRecoverTest,AMQ2751Test&lt;/p&gt;</description>
                <environment></environment>
        <key id="13254685">AMQ-7298</key>
            <summary>failover duplicate detection in error with batched local transactions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="gtully">Gary Tully</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Sep 2019 11:14:15 +0000</created>
                <updated>Wed, 21 Apr 2021 05:29:31 +0000</updated>
                            <resolved>Wed, 4 Sep 2019 11:30:17 +0000</resolved>
                                    <version>5.15.0</version>
                                    <fixVersion>5.16.0</fixVersion>
                    <fixVersion>5.17.0</fixVersion>
                                    <component>JMS client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="16922390" author="gtully" created="Wed, 4 Sep 2019 11:16:09 +0000"  >&lt;p&gt;The root cause of &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2751&quot; title=&quot;session.recover does not result in repeated redelivery - duplicate is detected and auto-acked in error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2751&quot;&gt;&lt;del&gt;AMQ-2751&lt;/del&gt;&lt;/a&gt; was duplicate redelivery from rollback delayed redelivery, that has been now revisited&lt;/p&gt;</comment>
                            <comment id="16922394" author="jira-bot" created="Wed, 4 Sep 2019 11:25:00 +0000"  >&lt;p&gt;Commit 02548777c2954f5ccad918df8b1280fd601f8fd6 in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=0254877&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=0254877&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7298&quot; title=&quot;failover duplicate detection in error with batched local transactions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7298&quot;&gt;&lt;del&gt;AMQ-7298&lt;/del&gt;&lt;/a&gt; - rework redelivery message tracking to ensure no duplicate suppression (and dlq) in error for local transaction batches that failover&lt;/p&gt;</comment>
                            <comment id="16922397" author="gtully" created="Wed, 4 Sep 2019 11:30:17 +0000"  >&lt;p&gt;The key observation was that local rollback delayed redelivery (with the default 1s retry delay) could produce duplicates. Messages were visible in the unconsumed list (so could be picked up in error by the async dispatcher) and would get replayed after the delay. Using a non default redeliverypolicy.initialRedeliveryDelay=0 to immediately replay could avoid some of the problems so it may be a sensible workaround.&lt;/p&gt;</comment>
                            <comment id="16922424" author="jira-bot" created="Wed, 4 Sep 2019 12:06:10 +0000"  >&lt;p&gt;Commit f155e92e58da5882ff83414cbe31abad6e4e2e26 in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=f155e92&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=f155e92&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7298&quot; title=&quot;failover duplicate detection in error with batched local transactions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7298&quot;&gt;&lt;del&gt;AMQ-7298&lt;/del&gt;&lt;/a&gt; - use final modifier in test to preserve older jdk builds&lt;/p&gt;</comment>
                            <comment id="17273141" author="lichtin" created="Wed, 27 Jan 2021 21:05:20 +0000"  >&lt;p&gt;I assume with this change now merged into 5.16.x, I&apos;m seeing a regression when upgrading from 5.15.14.&lt;/p&gt;

&lt;p&gt;Server-side redeliveries triggered by the redeliveryPlugin are no longer coming thru, but are (incorrectly) suppressed.&lt;/p&gt;

&lt;p&gt;The output from my test with 5.16.1 shows this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;       RedeliveryPlugin  175 | 40 - org.apache.activemq.activemq-osgi - 5.16.1 | redelivery #1 of: ID:mlipc2-4159-1611768583683-1:15:1:1:41 with delay: 1000, dest: queue://TEST2.msgin
ActiveMQMessageConsumer 1485 | 40 - org.apache.activemq.activemq-osgi - 5.16.1 | ID:mlipc2-4159-1611768583683-1:16:1:1 suppressing duplicate delivery on connection, poison acking: MessageDispatch {commandId = 0, responseRequired = false, consumerId = ID:mlipc2-4159-1611768583683-1:16:1:1, destination = queue://TEST2.msgin, message = ActiveMQTextMessage {commandId = 125, responseRequired = true, messageId = ID:mlipc2-4159-1611768583683-1:15:1:1:41, originalDestination = null, originalTransactionId = null, producerId = ID:mlipc2-4159-1611768583683-1:15:1:1, destination = queue://TEST2.msgin, transactionId = null, expiration = 0, timestamp = 1611768605501, arrival = 0, brokerInTime = 1611768607001, brokerOutTime = 1611768607012, correlationId = null, replyTo = null, persistent = true, type = null, priority = 0, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = org.apache.activemq.util.ByteSequence@5f105a66, marshalledProperties = org.apache.activemq.util.ByteSequence@5b2fd55c, dataStructure = null, redeliveryCounter = 1, size = 0, properties = {redeliveryDelay=1000, scheduledJobId=ID:mlipc2-4159-1611768583683-1:15:1:1:2}, readOnlyProperties = true, readOnlyBody = true, droppable = false, jmsXGroupFirstForConsumer = false, text = XXX}, redeliveryCounter = 1}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17274437" author="gtully" created="Fri, 29 Jan 2021 13:28:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lichtin&quot; class=&quot;user-hover&quot; rel=&quot;lichtin&quot;&gt;lichtin&lt;/a&gt; would you have a test case handy? does your scenarion fail on master? there are a bunch of related tests referenced in the description that could provide a start point to create a test.&lt;/p&gt;</comment>
                            <comment id="17275724" author="lichtin" created="Sat, 30 Jan 2021 21:21:44 +0000"  >&lt;p&gt;I&apos;ve a test but the code is embedded in our infrastructure, so it will take a while to extract it.&lt;/p&gt;

&lt;p&gt;In general, what I see is unrelated to failover. It&apos;s a simple server-side redelivery case, configuring the broker with the redeliveryPlugin.&lt;br/&gt;
For example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      &amp;lt;redeliveryPlugin fallbackToDeadLetter=&quot;true&quot; sendToDlqIfMaxRetriesExceeded=&quot;true&quot;&amp;gt;
        &amp;lt;redeliveryPolicyMap&amp;gt;
          &amp;lt;redeliveryPolicyMap&amp;gt;
            &amp;lt;redeliveryPolicyEntries&amp;gt;
              &amp;lt;redeliveryPolicy queue=&quot;TEST.&amp;gt;&quot; maximumRedeliveries=&quot;5&quot; initialRedeliveryDelay=&quot;2000&quot; redeliveryDelay=&quot;2000&quot; /&amp;gt;
            &amp;lt;/redeliveryPolicyEntries&amp;gt;
          &amp;lt;/redeliveryPolicyMap&amp;gt;
        &amp;lt;/redeliveryPolicyMap&amp;gt;
      &amp;lt;/redeliveryPlugin&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;then consuming a message from a &apos;TEST.abc&apos; queue, the test code throwing an exception to let it go back to server so it gets redelivered after 2 seconds. With 5.16.1 this no longer works, as the re-delivery is for some reason is considered a duplicate and suppressed. Of course it is a duplicate, but JMSRedelivered will be set to true, and another header tells the consumer the redelivery count.&lt;/p&gt;</comment>
                            <comment id="17292431" author="lichtin" created="Sun, 28 Feb 2021 16:05:16 +0000"  >&lt;p&gt;To reproduce the issue I&apos;m reporting above, use existing test &quot;BrokerRedeliveryTest&quot; and modify slightly, so it&apos;s using a failover connection.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; diff --git a/activemq-unit-tests/src/test/java/org/apache/activemq/broker/BrokerRedeliveryTest.java b/activemq-unit-tests/src/test/java/org/apache/activemq/broker/BrokerRedeliveryTest.java
index fbc0212f5..aecc54591 100644
--- a/activemq-unit-tests/src/test/java/org/apache/activemq/broker/BrokerRedeliveryTest.java
+++ b/activemq-unit-tests/src/test/java/org/apache/activemq/broker/BrokerRedeliveryTest.java
@@ -231,7 +233,7 @@ public class BrokerRedeliveryTest extends org.apache.activemq.TestSupport {   @Override
   protected ActiveMQConnectionFactory createConnectionFactory() throws Exception {
-        return new ActiveMQConnectionFactory(&quot;vm://localhost&quot;);
+        return new ActiveMQConnectionFactory(&quot;failover:(vm://localhost)&quot;);
   }   @Override&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Most of the tests start to fail and you&apos;ll see the symptom logged as:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;... suppressing duplicate delivery on connection, poison acking ... &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17322768" author="gtully" created="Fri, 16 Apr 2021 10:36:08 +0000"  >&lt;p&gt;for a potential workaround:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ActiveMQConnectionFactory(&lt;span class=&quot;code-quote&quot;&gt;&quot;failover:(....)?jms.checkForDuplicates=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17323767" author="jira-bot" created="Fri, 16 Apr 2021 12:12:32 +0000"  >&lt;p&gt;Commit c4d2ddfce9944cff6ec4003242ce79a2e843aac8 in activemq&apos;s branch refs/heads/main from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=c4d2ddf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=c4d2ddf&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7298&quot; title=&quot;failover duplicate detection in error with batched local transactions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7298&quot;&gt;&lt;del&gt;AMQ-7298&lt;/del&gt;&lt;/a&gt; - fix regression with broker redelivery plugin, fix and test relates to &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-8168&quot; title=&quot;Server-side redelivery no longer working with 5.16.1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-8168&quot;&gt;&lt;del&gt;AMQ-8168&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17323770" author="gtully" created="Fri, 16 Apr 2021 12:16:21 +0000"  >&lt;p&gt;there was a missing call to rollback the duplicate id cache, and duplicate detection is enabled only for the failover transport. Hense disabling the duplicate detection makes failover work like a normal client. I think the workaround is sensible b/c the duplicate cache is never 100%. The fix can in 5.17.0&lt;/p&gt;</comment>
                            <comment id="17323877" author="jbonofre" created="Fri, 16 Apr 2021 14:52:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&#160;should we cherry pick the commit to 5.16.x branch ? I guess yes.&lt;/p&gt;</comment>
                            <comment id="17326265" author="jira-bot" created="Wed, 21 Apr 2021 05:29:31 +0000"  >&lt;p&gt;Commit 818d885d6cf5ac4e482888073826d2f41d6cb899 in activemq&apos;s branch refs/heads/activemq-5.16.x from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=818d885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=818d885&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7298&quot; title=&quot;failover duplicate detection in error with batched local transactions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7298&quot;&gt;&lt;del&gt;AMQ-7298&lt;/del&gt;&lt;/a&gt; - fix regression with broker redelivery plugin, fix and test relates to &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-8168&quot; title=&quot;Server-side redelivery no longer working with 5.16.1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-8168&quot;&gt;&lt;del&gt;AMQ-8168&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(cherry picked from commit c4d2ddfce9944cff6ec4003242ce79a2e843aac8)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13362296">AMQ-8168</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="12483262">AMQ-2751</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 30 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z06bcw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>