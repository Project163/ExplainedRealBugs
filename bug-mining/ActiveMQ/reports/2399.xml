<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:07:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5381] ActiveMQBytesMessage mishandles restoration of old message contents</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5381</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Changes made in ActiveMQ 5.9.1, &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4887&quot; title=&quot;ActiveMQBytesMessage will lost content if message&amp;#39;s property was set before copy &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4887&quot;&gt;&lt;del&gt;AMQ-4887&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/activemq/commit/cb5c29d02d02dc7f7fa4f5c1a97bd2a59078bccd#diff-c0b18b235652457c810fe322bce65e31]&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;[cb5c29d02d02dc7f7fa4f5c1a97bd2a59078bccd&lt;/a&gt; introduced a bug in &lt;tt&gt;ActiveMQBytesMessage&lt;/tt&gt; which results in a &lt;tt&gt;java.util.zip.ZipException: incorrect header check&lt;/tt&gt; being thrown at &lt;tt&gt;org.apache.activemq.command.ActiveMQBytesMessage.restoreOldContent(ActiveMQBytesMessage.java:883)&lt;/tt&gt; when a consumer attempts to reuse a received &lt;tt&gt;ActiveMQBytesMessage&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This bug is triggered under a unique set of circumstances:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;A message is published by a JMS client with compression &lt;b&gt;&lt;em&gt;disabled&lt;/em&gt;&lt;/b&gt; on its &lt;tt&gt;ActiveMQConnection&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;The message is consumed by a JMS client with compression &lt;b&gt;&lt;em&gt;enabled&lt;/em&gt;&lt;/b&gt; on its &lt;tt&gt;ActiveMQConnection&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;The JMS consumer makes the received message writable in order to modify and reuse it:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;message.setReadOnlyProperties(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
message.setReadOnlyBody(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;The JMS consumer modifies the message, triggering a call to &lt;tt&gt;ActiveMQBytesMessage.initializeWriting()&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The problem within &lt;tt&gt;ActiveMQBytesMessage.initializeWriting()&lt;/tt&gt; is that the method determines whether the message should be compressed &lt;em&gt;when it is published&lt;/em&gt; (based on its current connection) BEFORE it has restored the message&apos;s original content.  In the example above, the message&apos;s original &lt;tt&gt;compressed&lt;/tt&gt; flag is changed from &lt;tt&gt;false&lt;/tt&gt; to &lt;tt&gt;true&lt;/tt&gt;, resulting in &lt;tt&gt;restoreOldContent()&lt;/tt&gt; trying to decompress message contents which were never compressed.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void initializeWriting() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; JMSException {
        checkReadOnlyBody();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataOut == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.bytesOut = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayOutputStream();
            OutputStream os = bytesOut;
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataOut = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DataOutputStream(os);
        }

        &lt;span class=&quot;code-comment&quot;&gt;// should compression be used when publishing &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; message??
&lt;/span&gt;        ActiveMQConnection connection = getConnection();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (connection != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; connection.isUseCompression()) {
            compressed = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        }

        &lt;span class=&quot;code-comment&quot;&gt;// restore the message&apos;s old content
&lt;/span&gt;        restoreOldContent();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;del&gt;A simple solution would be to move the &lt;tt&gt;restoreOldContent()&lt;/tt&gt; method call before the &lt;tt&gt;connection.isUseCompression()&lt;/tt&gt; conditional in &lt;tt&gt;ActiveMQBytesMessage.initializeWriting()&lt;/tt&gt;.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&lt;ins&gt;Had a chance to look into this problem further.  The best fix would be to only set the &apos;compressed&apos; flag when the message&apos;s &apos;contents&apos; are stored, instead of whenever the message is initialized for writing.&lt;/ins&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12745506">AMQ-5381</key>
            <summary>ActiveMQBytesMessage mishandles restoration of old message contents</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="brianjohnson">Brian D. Johnson</reporter>
                        <labels>
                            <label>easyfix</label>
                    </labels>
                <created>Thu, 2 Oct 2014 14:15:47 +0000</created>
                <updated>Wed, 11 Feb 2015 10:43:38 +0000</updated>
                            <resolved>Tue, 21 Oct 2014 21:15:52 +0000</resolved>
                                    <version>5.9.1</version>
                    <version>5.10.0</version>
                                    <fixVersion>5.10.1</fixVersion>
                    <fixVersion>5.11.0</fixVersion>
                                    <component>JMS client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14157998" author="tabish121" created="Fri, 3 Oct 2014 14:04:42 +0000"  >&lt;p&gt;Recommend you create a JUnit test case to reproduce your problem so that any fix is sure to be preserved in the future.&lt;/p&gt;</comment>
                            <comment id="14166752" author="githubbot" created="Fri, 10 Oct 2014 12:48:22 +0000"  >&lt;p&gt;GitHub user letM3in opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/47&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5381&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5381&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Modified ActiveMQBytesMessage so that the &apos;compressed&apos; flag is only set when the &apos;content&apos; is stored, instead of whenever writing is initialized.  This resolves &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5381&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5381&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Added unit test to test for &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5381&quot; title=&quot;ActiveMQBytesMessage mishandles restoration of old message contents&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5381&quot;&gt;&lt;del&gt;AMQ-5381&lt;/del&gt;&lt;/a&gt; condition.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/letM3in/activemq&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/letM3in/activemq&lt;/a&gt; trunk&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/47.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/47.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #47&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ebc4304f45293f72cab4aeab881d38c0d53ad47d&lt;br/&gt;
Author: Brian D. Johnson &amp;lt;brian@thejohnsonfamily.name&amp;gt;&lt;br/&gt;
Date:   2014-10-03T16:56:49Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5381&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5381&lt;/a&gt; - Fix ActiveMQBytesMessage&apos;s &apos;compressed&apos; flag so that it is only set when the message content is actually compressed/stored&lt;/p&gt;

&lt;p&gt;commit 63722a45d8f0827c762f3f880569bffaa9be7901&lt;br/&gt;
Author: Brian D. Johnson &amp;lt;brian@thejohnsonfamily.name&amp;gt;&lt;br/&gt;
Date:   2014-10-10T11:56:55Z&lt;/p&gt;

&lt;p&gt;    Merge remote-tracking branch &apos;upstream/trunk&apos; into trunk&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14166758" author="brianjohnson" created="Fri, 10 Oct 2014 12:53:23 +0000"  >&lt;p&gt;Created a pull request, as shown above with a unit test and fix to ActiveMQBytesMessage&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/activemq/pull/47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/47&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14175042" author="brianjohnson" created="Fri, 17 Oct 2014 13:18:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt; - how can I get the pull request above reviewed and merged?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="14179117" author="tabish121" created="Tue, 21 Oct 2014 21:15:52 +0000"  >&lt;p&gt;Fixed on trunk. &lt;/p&gt;</comment>
                            <comment id="14212210" author="brianjohnson" created="Fri, 14 Nov 2014 12:13:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt; can this fix be included in 5.10.1?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="14225229" author="tabish121" created="Tue, 25 Nov 2014 21:24:15 +0000"  >&lt;p&gt;There is no plan for a 5.10.1 release at this time. &lt;/p&gt;</comment>
                            <comment id="14315994" author="githubbot" created="Wed, 11 Feb 2015 10:43:38 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/47&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20q9r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>