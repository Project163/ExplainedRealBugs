<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:50:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3185] Closing a VMTransport can cause all other VMTransports to be prematurely closed</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3185</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Symptom&lt;br/&gt;
=======&lt;br/&gt;
We have eight servers running AMQ 5.3.1 connected in a network-of-brokers over HTTP.  Each broker maintains local connections to internal consumers using the VM transport.  We were noticing that about once every day, all the local VM connections on a broker and the outbound network bridge connections would fail with the following error:&lt;/p&gt;

&lt;p&gt;2010-12-10 04:29:11,663 &lt;span class=&quot;error&quot;&gt;&amp;#91;processBroker-process-pool-thread-4&amp;#93;&lt;/span&gt; ERROR - The worker encountered an exception and will pause for 5 seconds before continuing.&lt;br/&gt;
javax.jms.JMSException: Peer (vm://broker-mbus-200005#1052452) disposed.&lt;br/&gt;
	at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:62)&lt;br/&gt;
	at org.apache.activemq.ActiveMQMessageConsumer.dequeue(ActiveMQMessageConsumer.java:453)&lt;br/&gt;
	at org.apache.activemq.ActiveMQMessageConsumer.receive(ActiveMQMessageConsumer.java:570)&lt;br/&gt;
	at com.invoqsystems.foundation.component.communication.jms.source.JMSMessageSource.getMessage(JMSMessageSource.java:33)&lt;br/&gt;
	at com.invoqsystems.foundation.component.communication.jms.source.JMSMessageSource.getMessage(JMSMessageSource.java:95)&lt;br/&gt;
	at com.invoqsystems.foundation.component.communication.jms.worker.MessageProcessingWorker.getTask(MessageProcessingWorker.java:9)&lt;br/&gt;
	at com.invoqsystems.foundation.component.communication.jms.worker.AbstractWorker.iterate(AbstractWorker.java:14)&lt;br/&gt;
	at com.invoqsystems.foundation.component.communication.jms.worker.AbstractWorker.runUntilStop(AbstractWorker.java:17)&lt;br/&gt;
	at com.invoqsystems.foundation.component.communication.jms.worker.AbstractWorker.run(AbstractWorker.java:41)&lt;br/&gt;
	at java.lang.Thread.run(Unknown Source)&lt;br/&gt;
Caused by: org.apache.activemq.transport.TransportDisposedIOException: Peer (vm://broker-mbus-200005#1052452) disposed.&lt;br/&gt;
	at org.apache.activemq.transport.vm.VMTransport.stop(VMTransport.java:70)&lt;br/&gt;
	at org.apache.activemq.transport.TransportFilter.stop(TransportFilter.java:64)&lt;br/&gt;
	at org.apache.activemq.transport.TransportFilter.stop(TransportFilter.java:64)&lt;br/&gt;
	at org.apache.activemq.transport.ResponseCorrelator.stop(ResponseCorrelator.java:132)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.doStop(TransportConnection.java:956)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection$3.run(TransportConnection.java:918)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)&lt;br/&gt;
	... 1 more&lt;/p&gt;

&lt;p&gt;This was quite unexpected since we create the VM transport connection at broker startup and maintain it (the single connection) throughout the life of the application.  The connection is only closed when the process terminates and the broker is stopped.&lt;/p&gt;

&lt;p&gt;Since we wrote our consumers against the JMS spec, we handle periodic connection failures by creating a new connection.  This works fine sometimes; however, because of &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3127&quot; title=&quot;Network bridge causes deadlock on queue/topic when message dispatch and consumer registration overlap.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3127&quot;&gt;&lt;del&gt;AMQ-3127&lt;/del&gt;&lt;/a&gt;, the sudden reregistration of our consumers simultaneously occurring with bridge re-creation causes frequent deadlock that can only be resolved by restarting the systems.&lt;/p&gt;

&lt;p&gt;Cause&lt;br/&gt;
=====&lt;br/&gt;
We were unable to reliably recreate the failure, so it became clear that a timing issue was involved.  Eventually, we determined the cause of the VM transport failure was due to the following code in VMTransportServer:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;VMTransportServer.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; VMTransport connect() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        TransportAcceptListener al;
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (disposed) {
                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Server has been disposed.&quot;&lt;/span&gt;);
            }
            al = acceptListener;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (al == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Server TransportAcceptListener is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;.&quot;&lt;/span&gt;);
        }

        connectionCount.incrementAndGet();
        VMTransport client = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; VMTransport(location) {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void stop() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (disposed) {
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
                }
                &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.stop();
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (connectionCount.decrementAndGet() == 0 &amp;amp;&amp;amp; disposeOnDisconnect) {
                    VMTransportServer.&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.stop();
                }
            };
        };

        VMTransport server = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; VMTransport(location);
        client.setPeer(server);
        server.setPeer(client);
        al.onAccept(configure(server));
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; client;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At issue is the override VMTransport.stop() method:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;VMTransportServer.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void stop() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (disposed) {
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
                }
                &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.stop();
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (connectionCount.decrementAndGet() == 0 &amp;amp;&amp;amp; disposeOnDisconnect) {
                    VMTransportServer.&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.stop();
                }
            };
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that VMTransport.disposed is used to protect against multiple calls and subsequently multiple decrements of connectionCount.  However, in the implementation of super.stop(), the disposed flag is only set after the peer transport is informed of the stop:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;VMTransport.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void stop() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        stopping.set(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        
        &lt;span class=&quot;code-comment&quot;&gt;// If stop() is called &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; being start()ed.. then we can&apos;t stop until we &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; to the start() method.
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( enqueueValve.isOn() ) {
        	
            &lt;span class=&quot;code-comment&quot;&gt;// let the peer know that we are disconnecting..
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
&amp;gt;&amp;gt;&amp;gt;                peer.transportListener.onCommand(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ShutdownInfo());
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception ignore) {
            }
        	
        	
            TaskRunner tr = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                enqueueValve.turnOff();
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!disposed) {
                    started = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&amp;gt;&amp;gt;&amp;gt;                    disposed = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (taskRunner != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                        tr = taskRunner;
                        taskRunner = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                    }
                }
            } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
                stopping.set(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
                enqueueValve.turnOn();
            }
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tr != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                tr.shutdown(1000);
            }
            

        }
        
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;TransportConnection implements of peer.transportListener.onCommand(new ShutdownInfo()) by launching a asynchronous task that eventually calls back to the same transport that initiated the closure.  If the timing is right, VMTransportServer&apos;s VMTransport.stop() method is called a second time before the disposed flag is set to true.  As a result, the connectionCount is decremented &lt;b&gt;TWICE&lt;/b&gt; instead of just once.&lt;/p&gt;

&lt;p&gt;In other words, the diposed check and decrement as implemented by VMTransport&apos;s anonymous VMTransport subclass are not thread-safe.  If VMTransportServer miscounts the connections, it can end up stopping itself while there are still live connections.  The result is that the live connections see their peer (the server part of the VMTransport) unexpectedly closed.&lt;/p&gt;

&lt;p&gt;Solution&lt;br/&gt;
========&lt;br/&gt;
The attached patch prevents multiple decrements of the connectionCount by preventing reentrant calls to VMTransportServer&apos;s VMTransport stop() method.&lt;/p&gt;

&lt;p&gt;A patch is included which demonstrates the problem with the existing AMQ trunk code.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12499175">AMQ-3185</key>
            <summary>Closing a VMTransport can cause all other VMTransports to be prematurely closed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="stirlingc">Stirling Chow</reporter>
                        <labels>
                    </labels>
                <created>Sun, 20 Feb 2011 19:14:39 +0000</created>
                <updated>Thu, 24 Feb 2011 16:52:52 +0000</updated>
                            <resolved>Thu, 24 Feb 2011 16:52:52 +0000</resolved>
                                    <version>5.4.2</version>
                                    <fixVersion>5.5.0</fixVersion>
                                    <component>Transport</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12997194" author="stirlingc" created="Sun, 20 Feb 2011 19:15:51 +0000"  >&lt;p&gt;Patch that prevents VMTransportServer/VMTransport from mistakenly decrementing connectionCount more than once per VMTransport.&lt;/p&gt;</comment>
                            <comment id="12997195" author="stirlingc" created="Sun, 20 Feb 2011 19:17:17 +0000"  >&lt;p&gt;Unit test that demonstrates the premature closure of VMTransport.  The test is timing dependent, but on our systems it fails nearly always within 10 iterations of the loop.&lt;/p&gt;

&lt;p&gt;After the patch is applied, the test passes 100% of the time.&lt;/p&gt;</comment>
                            <comment id="12997197" author="stirlingc" created="Sun, 20 Feb 2011 19:22:27 +0000"  >&lt;p&gt;It should be noted that we originally encountered this error on AMQ 5.3.1.  While the bug was in VMTransport/VMTransportServer, it was exposed by the existence of broker-to-broker bridges that frequently failed (i.e., in our network of brokers, several brokers are for failover and are not started during normal operations).  A number of changes in AMQ 5.4.2, specifically the modification of VMTransport&apos;s stop() method to send a ShutdownInfo to the peer rather than triggering its exception handler, prevented the bug from appearing in our runtime environments.  However, further analysis of the AMQ trunk source revealed that the root cause, even though no longer triggered in our runtime environment, was still present &amp;#8212; specifically the ability of VMTransportServer to mistakenly decrement connectionCount multiple times.&lt;/p&gt;

&lt;p&gt;Given the reported deadlock with bridge creation, this turned out to be a significant issue with the stability of our system.  We would like the root cause addressed to prevent possible reintroduction in subsequent versions.&lt;/p&gt;</comment>
                            <comment id="12997198" author="stirlingc" created="Sun, 20 Feb 2011 19:23:29 +0000"  >&lt;p&gt;When combined with &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3127&quot; title=&quot;Network bridge causes deadlock on queue/topic when message dispatch and consumer registration overlap.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3127&quot;&gt;&lt;del&gt;AMQ-3127&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3185&quot; title=&quot;Closing a VMTransport can cause all other VMTransports to be prematurely closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3185&quot;&gt;&lt;del&gt;AMQ-3185&lt;/del&gt;&lt;/a&gt; created a major problem with the stability of our systems.&lt;/p&gt;</comment>
                            <comment id="12998930" author="tabish121" created="Thu, 24 Feb 2011 16:52:52 +0000"  >&lt;p&gt;Applied patch, thanks for the great test case.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12495173">AMQ-3127</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12471530" name="VMTransportClosureTest.java" size="4576" author="stirlingc" created="Sun, 20 Feb 2011 19:17:17 +0000"/>
                            <attachment id="12471527" name="patch.diff" size="1732" author="stirlingc" created="Sun, 20 Feb 2011 19:15:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14695</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 39 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ajuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59490</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>