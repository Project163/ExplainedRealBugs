<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:56:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3485] Transacted Session returns invalid MessageConsumer after the first MessageConsumer for the same destiantion. Bug introduced in 5.5.0 - working ok in 4.1.2</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3485</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;When I have a transacted Session, as it is single threaded I can&apos;t create two MessageConsumer to the same Destination. But if I create a MessageConsumer to a Destination and then I close it, then I should be able to create a new MessageConsumer to the same Destination. This is working fine in active mq 4.1.2 but it doesn&apos;t work in 5.5.0. It allows to create a second MessageConsumer but that seconde MessageConsumer always returns null when the queue has messages.&lt;/p&gt;

&lt;p&gt;i.e:&lt;br/&gt;
Session session = .... //transacted session&lt;br/&gt;
Destination dest = .... &lt;br/&gt;
MessageConsumer mc = session.createMessageConsumer(dest);&lt;br/&gt;
Message message = mc.receive(); // message received ok&lt;br/&gt;
mc.close();&lt;br/&gt;
mc = session.createMessageConsumer(dest);&lt;br/&gt;
Message message = mc.receive(); // message is null&lt;/p&gt;

&lt;p&gt;Thanks, Pablo.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12521530">AMQ-3485</key>
            <summary>Transacted Session returns invalid MessageConsumer after the first MessageConsumer for the same destiantion. Bug introduced in 5.5.0 - working ok in 4.1.2</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10101">Abandoned</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="pablolagreca">Pablo La Greca</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Sep 2011 02:37:31 +0000</created>
                <updated>Sun, 13 Mar 2022 14:02:24 +0000</updated>
                            <resolved>Sun, 13 Mar 2022 14:02:24 +0000</resolved>
                                    <version>5.5.0</version>
                                                    <component>JMS client</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13098940" author="tabish121" created="Wed, 7 Sep 2011 13:33:15 +0000"  >&lt;p&gt;I&apos;d recommend creating a JUnit test case that reproduces your issue and attaching it here.&lt;/p&gt;</comment>
                            <comment id="13099584" author="pablolagreca" created="Wed, 7 Sep 2011 21:44:17 +0000"  >&lt;p&gt;App showing bug&lt;/p&gt;</comment>
                            <comment id="13099586" author="pablolagreca" created="Wed, 7 Sep 2011 21:45:01 +0000"  >&lt;p&gt;Attached you can found a maven project with a test reproducing this issue. It seems to be working in 5.2.0 and failing after that release.&lt;/p&gt;

&lt;p&gt;Thanks, Pablo.&lt;/p&gt;</comment>
                            <comment id="13104932" author="tabish121" created="Wed, 14 Sep 2011 22:16:01 +0000"  >&lt;p&gt;Working as designed.  The second consumer would not receive the message as the session has not been rolled back, called rollback after consumer.close() and your second consumer would receive the message.&lt;/p&gt;</comment>
                            <comment id="13106710" author="pablolagreca" created="Fri, 16 Sep 2011 19:01:18 +0000"  >&lt;p&gt;Thanks Timothy. But I really don&apos;t understand. &lt;/p&gt;

&lt;p&gt;If the session is not close, why I&apos;m not able to create one consumer, close it, and then create another. And in the end commit()/rollback() the session?. This should be allowed as it is in previous ActiveMQ releases.&lt;/p&gt;</comment>
                            <comment id="13106714" author="tabish121" created="Fri, 16 Sep 2011 19:04:17 +0000"  >&lt;p&gt;You can create as many consumers as you&apos;d like but they won&apos;t consumer messages that have already been consumed in that transaction, you need to first rollback the transaction before a message will be redelivered.&lt;/p&gt;</comment>
                            <comment id="13108811" author="pablolagreca" created="Tue, 20 Sep 2011 16:29:54 +0000"  >&lt;p&gt;I&apos;m don&apos;t want that. What I want is that if I have a queue QUEUEA with 2 messages, and I have a session SESSIONA, I should be able to create one consumer with SESSIONA and consume the first message, close that consumer, and then create another consumer with SESSIONA and consume the second message. Once more, as I was able to do in previous versions of ActiveMQ.&lt;/p&gt;

&lt;p&gt;If after that I commit SESSIONA both message will be removed.&lt;/p&gt;</comment>
                            <comment id="13480132" author="sbtourist" created="Fri, 19 Oct 2012 17:02:38 +0000"  >&lt;p&gt;The problem is not about consuming from &lt;b&gt;multiple consumers&lt;/b&gt; the &lt;b&gt;same&lt;/b&gt; message: it is about consuming &lt;b&gt;different messages&lt;/b&gt;.&lt;br/&gt;
That is, subsequent consumers always return null if there&apos;s a previous consumer with a non committed message, which doesn&apos;t make sense, as if you want to preserve ordering with that, you should really throw an exception rather than fail silently.&lt;br/&gt;
Is it clearer now?&lt;/p&gt;</comment>
                            <comment id="13480246" author="pablolagreca" created="Fri, 19 Oct 2012 18:48:36 +0000"  >&lt;p&gt;I disagree. Message ordering processing should only be preserved if I&apos;m using only one consumer.&lt;/p&gt;

&lt;p&gt;It&apos;s ok to not preserve order if I decide to have more than one consumer. And I should also be able to have more than one consumer from the same QUEUE at the same time.&lt;/p&gt;</comment>
                            <comment id="13480278" author="sbtourist" created="Fri, 19 Oct 2012 19:14:09 +0000"  >&lt;p&gt;I agree with you obviously.&lt;/p&gt;

&lt;p&gt;I&apos;m just saying if that&apos;s the case, it shouldn&apos;t fail silently by the way.&lt;/p&gt;</comment>
                            <comment id="13481291" author="dejanb" created="Mon, 22 Oct 2012 10:30:37 +0000"  >&lt;p&gt;It looks like a bug. The expectation that you can close and open new consumers in the same transaction and receive messages is valid.&lt;/p&gt;

&lt;p&gt;I&apos;ll play with the test a bit to see if I can find the problem.&lt;/p&gt;</comment>
                            <comment id="13482288" author="dejanb" created="Tue, 23 Oct 2012 12:33:50 +0000"  >&lt;p&gt;So we investigated this in more details. The problem was introduced with a fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2034&quot; title=&quot;consumer close with active XA transaction results in java.lang.IllegalArgumentException: The subscription does not exist: ...&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2034&quot;&gt;&lt;del&gt;AMQ-2034&lt;/del&gt;&lt;/a&gt;, when we started postponing the closing of the actual consumer until transaction ends (either commit or rollback). This leads us to the problem where the messages that were already prefetched by the consumer are stuck on that consumer until the end of the transaction.&lt;/p&gt;

&lt;p&gt;The easiest workaround for this is to turn of prefetching, with something like&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Destination dest = session.createQueue(&lt;span class=&quot;code-quote&quot;&gt;&quot;TEST?consumer.prefetchSize=0&quot;&lt;/span&gt;);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And frankly turning of the prefetch in use cases where you want to have multiple consumers coming and going inside the single transaction make the only sense, as every other approach will mess the order of messages.&lt;/p&gt;

&lt;p&gt;To support closing consumers with prefetched messages inside the transaction we&apos;d need to refactor the whole thing. Ideally the consumer would close immediately and on transaction end, broker would know how to redeliver unconsumed messages.&lt;/p&gt;

&lt;p&gt;Let me know if this workaround works for you.&lt;/p&gt;</comment>
                            <comment id="13482339" author="pablolagreca" created="Tue, 23 Oct 2012 14:04:20 +0000"  >&lt;p&gt;To be honest it&apos;s not a solution for me. The thing is that I have a generic layer on top of activemq that I can&apos;t specialize for a particular case.&lt;/p&gt;

&lt;p&gt;I don&apos;t need this fix right now but would be nice to have it fix in a future release.&lt;/p&gt;

&lt;p&gt;Thanks Dejan.&lt;/p&gt;</comment>
                            <comment id="13482347" author="dejanb" created="Tue, 23 Oct 2012 14:12:02 +0000"  >&lt;p&gt;Thanks for the comment Pablo. We&apos;ll try to make a fix. The thing is, it&apos;s not that trivial and will affect how we process transactions, so it requires some work. &lt;/p&gt;

&lt;p&gt;As for the workaround, you just need to change a destination name when creating a consumer, so it should be easy one. But again, it might be impossible to do in your system.&lt;/p&gt;</comment>
                            <comment id="13482369" author="gtully" created="Tue, 23 Oct 2012 14:51:33 +0000"  >&lt;p&gt;or you can set the prefetch on the broker via a destinationPolicy to set the prefetch for all or a matching set, of destinations.&lt;/p&gt;</comment>
                            <comment id="17505530" author="christopher.l.shannon" created="Sun, 13 Mar 2022 14:02:24 +0000"  >&lt;p&gt;Closing very old jiras that were created more than 10 years ago&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12493512" name="activemq-issue-test-case.zip" size="64146" author="pablolagreca" created="Wed, 7 Sep 2011 21:44:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59991</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 35 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0anjz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>60089</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>