<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:04:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5092] MQTT uses duplicate packet IDs for PUBLISH messages</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5092</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;MQTT protocol converters does not correctly generate unique packet ids for retained and non-retained publish messages sent to clients. MQTT requires that all Publish messages with QoS &amp;gt; 0 must have a unique packet id which can be used by clients to coordinate the PUBACK, PUBREC, PUBREL and PUBCOMP messages depending upon the QoS flow. &lt;/p&gt;

&lt;p&gt;Although retained messages published on creation of client subscriptions are copies of retained messages, they must carry a unique packet id when dispatched to clients. ActiveMQ re-uses the retained message&apos;s packet id, which makes it difficult to acknowledge these messages when wildcard topics are used. &lt;/p&gt;

&lt;p&gt;ActiveMQ also sends the same non-retained message multiple times for every matching subscription for overlapping subscriptions. These messages also re-use the publisher&apos;s message id as the packet id, which breaks client acknowledgment. &lt;/p&gt;

&lt;p&gt;A patch is included, which fixes all the above scenarios. It generates a unique packet id for every publish (retained and non-retained), and also ensures that redelivery on the same connection will re-use message ids, with the dup flag set. The patch also maps JMS redelivery status for a subscription to the MQTT Dup flag to indicate duplicate messages. Unit tests are included to test correct packet id generation. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12700632">AMQ-5092</key>
            <summary>MQTT uses duplicate packet IDs for PUBLISH messages</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="dhirajsb">Dhiraj Sureshkumar Bokde</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Mar 2014 03:48:55 +0000</created>
                <updated>Fri, 2 May 2014 10:13:50 +0000</updated>
                            <resolved>Fri, 2 May 2014 10:13:50 +0000</resolved>
                                    <version>5.9.0</version>
                                    <fixVersion>5.10.0</fixVersion>
                                    <component>MQTT</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13929922" author="dhirajsb" created="Tue, 11 Mar 2014 03:58:56 +0000"  >&lt;p&gt;Patch to fix MQTT publish packet id generation&lt;/p&gt;</comment>
                            <comment id="13930338" author="dejanb" created="Tue, 11 Mar 2014 13:57:47 +0000"  >&lt;p&gt;Hi Dhiraj,&lt;/p&gt;

&lt;p&gt;I ran the tests with the patch and I think I see a regression.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;testResendMessageId(org.apache.activemq.transport.mqtt.MQTTSSLTest)  Time elapsed: 0.039 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.net.ProtocolException: Command from server contained an invalid message id: 2&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Wonder if you can reproduce this on your side?&lt;/p&gt;</comment>
                            <comment id="13930863" author="dhirajsb" created="Tue, 11 Mar 2014 20:04:52 +0000"  >&lt;p&gt;Hi Dejan,&lt;/p&gt;

&lt;p&gt;I was able to reproduce the error, but the failure doesn&apos;t happen every time the tests are run. I investigated a little more and looks like its related to &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4712&quot; title=&quot;MQTT unit tests fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4712&quot;&gt;&lt;del&gt;AMQ-4712&lt;/del&gt;&lt;/a&gt;. The tests fail when the client apparently reads the same SUBACK packet twice, even though the server only sends it once. &lt;/p&gt;

&lt;p&gt;Since the same tests have no issues in the non-SSL MQTTTest, it seems like an issue in SslProtocolCodec.secure_read(). But I am not familiar with the code so can&apos;t narrow it down further. &lt;/p&gt;

&lt;p&gt;Can we mark the failing test as ignored in MQTTSSLTest for now, and get the fix in for non-SSL case? &lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Dhiraj. &lt;/p&gt;</comment>
                            <comment id="13930915" author="dhirajsb" created="Tue, 11 Mar 2014 20:35:28 +0000"  >&lt;p&gt;On further testing, it doesn&apos;t seem to be happening in SslProtocolCodec.secure_read(). Its hard to pin down where its happening, MQTTProtocolCodec seems to be reading the same buffer twice, but I can&apos;t determine why its doing so. &lt;/p&gt;</comment>
                            <comment id="13930926" author="dhirajsb" created="Tue, 11 Mar 2014 20:48:48 +0000"  >&lt;p&gt;I am attaching an updated patch with a fix in a unit test for another intermittent failure when messages arrive slightly out of order for overlapping subscriptions. I have also refined the tests to add a slight delay after removing and creating subscriptions in testResendMessageId(), which seems to let the test pass now. &lt;/p&gt;

&lt;p&gt;Please test with the updated patch instead of the previous one. &lt;/p&gt;</comment>
                            <comment id="13931727" author="gtully" created="Wed, 12 Mar 2014 13:01:36 +0000"  >&lt;p&gt;patch applied with thanks in &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/activemq/commit/67f151fe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/activemq/commit/67f151fe&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13943475" author="dhirajsb" created="Fri, 21 Mar 2014 19:58:28 +0000"  >&lt;p&gt;Packet id generation must resume id sequence after client reconnects&lt;/p&gt;</comment>
                            <comment id="13943528" author="dhirajsb" created="Fri, 21 Mar 2014 20:53:07 +0000"  >&lt;p&gt;Attaching patch3 to fix packet id generation, resolves resendMessageId() test failures, also adds a couple of extra unit tests to check id generation for cleansession=0 and cleansession=1&lt;/p&gt;</comment>
                            <comment id="13943550" author="tabish121" created="Fri, 21 Mar 2014 21:11:36 +0000"  >&lt;p&gt;patch applied on trunk with thanks.  Tests are all passing here.&lt;/p&gt;</comment>
                            <comment id="13945111" author="dhirajsb" created="Mon, 24 Mar 2014 13:56:34 +0000"  >&lt;p&gt;Thanks Tim. I pulled from masterrep/trunk and see that the changes to MQTTTest in .patch3 were not merged. &lt;/p&gt;</comment>
                            <comment id="13945119" author="dhirajsb" created="Mon, 24 Mar 2014 14:01:49 +0000"  >&lt;p&gt;Adding patch4 for unit tests for cleansession 0 and 1 id generation&lt;/p&gt;</comment>
                            <comment id="13945144" author="tabish121" created="Mon, 24 Mar 2014 14:17:10 +0000"  >&lt;p&gt;Added in the missing test. &lt;/p&gt;</comment>
                            <comment id="13984394" author="tabish121" created="Tue, 29 Apr 2014 15:17:18 +0000"  >&lt;p&gt;Dhiraj, can we consider this resolved now?&lt;/p&gt;</comment>
                            <comment id="13987305" author="dhirajsb" created="Fri, 2 May 2014 04:04:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt; Yes, we can mark this resolved&lt;/p&gt;</comment>
                            <comment id="13987556" author="tabish121" created="Fri, 2 May 2014 10:13:50 +0000"  >&lt;p&gt;Fixed on trun&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12633848" name="AMQ-5092.patch" size="15805" author="dhirajsb" created="Tue, 11 Mar 2014 03:58:56 +0000"/>
                            <attachment id="12634001" name="AMQ-5092.patch2" size="18210" author="dhirajsb" created="Tue, 11 Mar 2014 20:48:48 +0000"/>
                            <attachment id="12636107" name="AMQ-5092.patch3" size="25654" author="dhirajsb" created="Fri, 21 Mar 2014 20:53:07 +0000"/>
                            <attachment id="12636331" name="AMQ-5092.patch4" size="8805" author="dhirajsb" created="Mon, 24 Mar 2014 14:01:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>378349</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 29 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1t6zb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>378641</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>