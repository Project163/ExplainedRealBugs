<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:55:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3557] Performance of consumption with JDBC persistance and Microsoft SQL Server</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3557</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;We are trying to upgrade our ActiveMQ installation and have run into some performance issues. I&apos;ll attached our activemq.xml file to this bug.&lt;/p&gt;

&lt;p&gt;I&apos;ve setup a fresh SQLServer database for our upgrade tests and using the example Ant tools in the distribution, I&apos;ve populated a persistent queue with 1,000,000 messages. I then consume those messages using the example Ant consumption script. The producing side works fine. However the performance of the consumption side is extremely poor. To consume just 10,000 of those messages takes over 5 minutes.&lt;/p&gt;

&lt;p&gt;The consumer will pause for 4-5 seconds every 200 messages. This is easily visible in the output of the Ant script. We have also traced the DB to see what is happening there and have found that the findNextMessagesStatement takes 4-5 seconds every time it is executed. The statement&apos;s ID parameter is increased by 200 every time it is executed.  We also noticed the use of the &quot;SET ROWCOUNT 10000&quot; statement setting the maximum number of rows returned from a query at 10000. We also traced previous versions of ActiveMQ and found that SET ROWCOUNT was used much more often, with much smaller values (often 10, 20 or 30).&lt;/p&gt;

&lt;p&gt;We have also tested the same setup with version 5.4.0 and did not have the same issues. Consumption speeds with 5.4.0 were normal, with no pauses. Version 5.4.3 did have the problem, however. So there seems to be a regression somewhere between 5.4.0 and 5.4.3 (also affects 5.5.0 and later).&lt;/p&gt;

&lt;p&gt;Please let me know if you need more information, including the database traces.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Microsoft SQL Server 2005, Debian Linux, &lt;/p&gt;</environment>
        <key id="12528266">AMQ-3557</key>
            <summary>Performance of consumption with JDBC persistance and Microsoft SQL Server</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ravv">Nicholas Rahn</reporter>
                        <labels>
                            <label>jdbc</label>
                            <label>performance</label>
                            <label>sqlserver</label>
                    </labels>
                <created>Fri, 21 Oct 2011 12:49:01 +0000</created>
                <updated>Wed, 8 Nov 2017 16:58:32 +0000</updated>
                            <resolved>Fri, 24 Aug 2012 14:30:12 +0000</resolved>
                                    <version>5.4.3</version>
                    <version>5.5.0</version>
                    <version>5.5.1</version>
                                    <fixVersion>5.7.0</fixVersion>
                                    <component>Message Store</component>
                    <component>Performance Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13132628" author="ravv" created="Fri, 21 Oct 2011 12:53:54 +0000"  >&lt;p&gt;Configuration file we are using.&lt;/p&gt;</comment>
                            <comment id="13416048" author="tmielke" created="Tue, 17 Jul 2012 09:55:19 +0000"  >&lt;p&gt;There was recently an improvement made to the JDBC persistence adapter to remove an unneeded synchronization point. See the last comment of &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2868&quot; title=&quot;NegativeQueueTest and JDBC variant - intermittent failure - missing message when cache exhausted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2868&quot;&gt;&lt;del&gt;AMQ-2868&lt;/del&gt;&lt;/a&gt;. This fix improves performance of the JDBC persistence adapter in case of using multiple consumers. &lt;/p&gt;</comment>
                            <comment id="13419251" author="gtully" created="Fri, 20 Jul 2012 15:23:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://fisheye6.atlassian.com/changelog/activemq?cs=1035202&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://fisheye6.atlassian.com/changelog/activemq?cs=1035202&lt;/a&gt;&lt;br/&gt;
seems to be the culprit but the use case is durable subs with a selector and low prefetch. Think that fix needs a revisit.&lt;br/&gt;
the maxRowSize should be a max, not a min. maxRowSize can be configured on the jdbcpersistnceadapter to set it to a more reasonable value like 400.&lt;br/&gt;
re durables, setting batch size based on prefetch should be avoided, probably.&lt;/p&gt;</comment>
                            <comment id="13420596" author="ravv" created="Mon, 23 Jul 2012 12:16:23 +0000"  >&lt;p&gt;Setting maxRows=200 on the jdbcPersistenceAdapter looks like it solves the problem. My quick testing showed a normal consumption without any pauses. I will run some other tests to be sure, but so far it looks good.&lt;/p&gt;

&lt;p&gt;I had seen the maxRows variable in the JDBC code, but was not aware that it could be set in the XML file. I might suggest that this be documented somewhere.&lt;/p&gt;

&lt;p&gt;I might also suggest that the default value for maxRows be set to whatever the default batch size is. That is, AMQ/jdbcAdapter seems to process messages in batches of 200. Setting the default value of maxRows to be the same as this batch size (i.e. 200) would seem to make better sense as a default setting. I don&apos;t know all of the usecases, but setting this value to anything greater than the batch size would seem to make the DB do needless work.&lt;/p&gt;</comment>
                            <comment id="13441176" author="gtully" created="Fri, 24 Aug 2012 14:17:11 +0000"  >&lt;p&gt;The jdbc version of test: org.apache.activemq.usecases.DurableSubscriptionSelectorTest#testSubscription &lt;br/&gt;
demonstrates the need to setMaxRows to a large value in the sparse selector case. Using a large destination page size via policy is a better solution as it is more specific.&lt;/p&gt;</comment>
                            <comment id="13441192" author="gtully" created="Fri, 24 Aug 2012 14:30:12 +0000"  >&lt;p&gt;fix in &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1376934&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1376934&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12500173" name="activemq.xml" size="3561" author="ravv" created="Fri, 21 Oct 2011 12:53:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>97626</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 13 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0aio7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59298</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310080" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Regression</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10091"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>