<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:31:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-732] Infinite recovery loop.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-732</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;The simplest way to reproduce the problem:&lt;br/&gt;
1. Remove storage directory. &lt;br/&gt;
2. Start broker using the following code:&lt;/p&gt;


&lt;p&gt; public static void main(String[] args)  throws Exception &lt;/p&gt;
{
           BrokerService broker = new BrokerService();
           broker.setPersistent(true);
           DefaultPersistenceAdapterFactory pFactory = new DefaultPersistenceAdapterFactory();
           pFactory.setJournalLogFiles(1);
           pFactory.setJournalLogFileSize(2048);
           broker.setPersistenceFactory(pFactory);
           broker.setUseJmx(false);
           broker.addConnector(&quot;tcp://localhost:61616&quot;);
           broker.start();
           Thread.sleep(1000000000000l);
   }
&lt;p&gt;3. Shutdown the broker.&lt;br/&gt;
4. Start broker.&lt;br/&gt;
It enters infinite loop&lt;/p&gt;

&lt;p&gt;[                          main] BrokerService                  INFO  ActiveMQ null JMS Message Broker (localhost) is starting&lt;br/&gt;
[                          main] BrokerService                  INFO  For help or more information please see: &lt;a href=&quot;http://incubator.apache.org/activemq/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://incubator.apache.org/activemq/&lt;/a&gt;&lt;br/&gt;
[                          main] JDBCPersistenceAdapter         INFO  Database driver recognized: &lt;span class=&quot;error&quot;&gt;&amp;#91;apache_derby_embedded_jdbc_driver&amp;#93;&lt;/span&gt;&lt;br/&gt;
[                          main] DefaultJDBCAdapter             DEBUG Executing SQL: CREATE TABLE ACTIVEMQ_MSGS(ID INTEGER NOT NULL, CONTAINER VARCHAR(250), MSGID_PROD VARCHAR(250), MSGID_SEQ INTEGER, EXPIRATION BIGINT, MSG BLOB, PRIMARY KEY ( ID ) )&lt;br/&gt;
[                          main] DefaultJDBCAdapter             DEBUG Could not create JDBC tables; The message table already existed. Failure was: CREATE TABLE ACTIVEMQ_MSGS(ID INTEGER NOT NULL, CONTAINER VARCHAR(250), MSGID_PROD VARCHAR(250), MSGID_SEQ INTEGER, EXPIRATION BIGINT, MSG BLOB, PRIMARY KEY ( ID ) ) Message: Table/View &apos;ACTIVEMQ_MSGS&apos; already exists in Schema &apos;APP&apos;. SQLState: X0Y32 Vendor code: 20000&lt;br/&gt;
[                          main] DefaultJDBCAdapter             DEBUG Executing SQL: CREATE INDEX ACTIVEMQ_MSGS_MIDX ON ACTIVEMQ_MSGS (MSGID_PROD,MSGID_SEQ)&lt;br/&gt;
[                          main] DefaultJDBCAdapter             DEBUG Executing SQL: CREATE INDEX ACTIVEMQ_MSGS_CIDX ON ACTIVEMQ_MSGS (CONTAINER)&lt;br/&gt;
[                          main] DefaultJDBCAdapter             DEBUG Executing SQL: CREATE INDEX ACTIVEMQ_MSGS_EIDX ON ACTIVEMQ_MSGS (EXPIRATION)&lt;br/&gt;
[                          main] DefaultJDBCAdapter             DEBUG Executing SQL: CREATE TABLE ACTIVEMQ_ACKS(CONTAINER VARCHAR(250) NOT NULL, CLIENT_ID VARCHAR(250) NOT NULL, SUB_NAME VARCHAR(250) NOT NULL, SELECTOR VARCHAR(250), LAST_ACKED_ID INTEGER, PRIMARY KEY ( CONTAINER, CLIENT_ID, SUB_NAME))&lt;br/&gt;
[                          main] DefaultJDBCAdapter             DEBUG Could not create JDBC tables; The message table already existed. Failure was: CREATE TABLE ACTIVEMQ_ACKS(CONTAINER VARCHAR(250) NOT NULL, CLIENT_ID VARCHAR(250) NOT NULL, SUB_NAME VARCHAR(250) NOT NULL, SELECTOR VARCHAR(250), LAST_ACKED_ID INTEGER, PRIMARY KEY ( CONTAINER, CLIENT_ID, SUB_NAME)) Message: Table/View &apos;ACTIVEMQ_ACKS&apos; already exists in Schema &apos;APP&apos;. SQLState: X0Y32 Vendor code: 20000&lt;br/&gt;
[                          main] JDBCPersistenceAdapter         DEBUG Cleaning up old messages.&lt;br/&gt;
[                          main] DefaultJDBCAdapter             DEBUG Executing SQL: DELETE FROM ACTIVEMQ_MSGS WHERE ( EXPIRATION&amp;lt;&amp;gt;0 AND EXPIRATION&amp;lt;?) OR ID &amp;lt;= ( SELECT min(ACTIVEMQ_ACKS.LAST_ACKED_ID) FROM ACTIVEMQ_ACKS WHERE ACTIVEMQ_ACKS.CONTAINER=ACTIVEMQ_MSGS.CONTAINER)&lt;br/&gt;
[                          main] DefaultJDBCAdapter             DEBUG Deleted 0 old message(s).&lt;br/&gt;
[                          main] JDBCPersistenceAdapter         DEBUG Cleanup done.&lt;br/&gt;
[                          main] JournalPersistenceAdapter      INFO  Journal Recovery Started from: Active Journal: using 1 x 0.001953125 Megs at: /workplace/fateev/install/activemq-4.0-SNAPSHOT/activemq-core/activemq-data/journal&lt;br/&gt;
[                          main] JournalPersistenceAdapter      DEBUG TRACE Entry: RECOVERED&lt;br/&gt;
[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation offset=53&lt;br/&gt;
[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation offset=97&lt;br/&gt;
[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=0&lt;br/&gt;
[                          main] JournalPersistenceAdapter      DEBUG TRACE Entry: RECOVERED&lt;br/&gt;
[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation offset=53&lt;br/&gt;
[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation offset=97&lt;br/&gt;
[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=0&lt;br/&gt;
[                          main] JournalPersistenceAdapter      DEBUG TRACE Entry: RECOVERED&lt;br/&gt;
[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation offset=53&lt;br/&gt;
[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation offset=97&lt;br/&gt;
[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=0&lt;/p&gt;

&lt;p&gt;The log entry from getNextDataRecordLocation is coming from log statement I&apos;ve added to LogFileManager.getNextDataRecordLocation:&lt;/p&gt;

&lt;p&gt;   public Location getNextDataRecordLocation(Location lastLocation) throws IOException, InvalidRecordLocationException {&lt;br/&gt;
        RecordInfo ri = readRecordInfo(lastLocation);&lt;br/&gt;
        while (true) {&lt;/p&gt;

&lt;p&gt;            int logFileId = ri.getLocation().getLogFileId();&lt;br/&gt;
            int offset = ri.getNextLocation();&lt;br/&gt;
            log.debug(&quot;getNextDataRecordLocation offset=&quot; + offset);&lt;br/&gt;
            // Are we overflowing into next logFile?&lt;br/&gt;
            if (offset &amp;gt;= ri.getLogFileState().getAppendOffset()) {&lt;br/&gt;
                LogFileNode nextActive = ri.getLogFileState().getNextActive();&lt;br/&gt;
                log.debug(&quot;getNextDataRecordLocation overflowing into next logFile=&quot; + (nextActive == null ? &quot;null&quot;  : String.valueOf(nextActive.getId())));&lt;br/&gt;
                if (nextActive == null) &lt;/p&gt;
{
                    return null;
                }
&lt;p&gt;                logFileId = nextActive.getId();&lt;br/&gt;
                offset = 0;&lt;br/&gt;
            }&lt;/p&gt;

&lt;p&gt;            try &lt;/p&gt;
{
                ri = readRecordInfo(new Location(logFileId, offset));
            }
&lt;p&gt; catch (InvalidRecordLocationException e) &lt;/p&gt;
{
                return null;
            }

&lt;p&gt;            // Is the next record the right record type?&lt;br/&gt;
            if (ri.getHeader().getRecordType() == DATA_RECORD_TYPE) &lt;/p&gt;
{
                return ri.getLocation();
            }
&lt;p&gt;            // No? go onto the next record.&lt;br/&gt;
        }&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;It looks like recovery doesn&apos;t take into account that journaling storage file should have some end at some point. &lt;/p&gt;

&lt;p&gt;Similar problem happens if multiple files of bigger size are used. It happens every time one of the log files grows bigger then size specified in pFactory.setJournalLogFileSize(...) call.&lt;/p&gt;
</description>
                <environment>&lt;p&gt;Linux RHEL 3&lt;/p&gt;</environment>
        <key id="12481606">AMQ-732</key>
            <summary>Infinite recovery loop.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mfateev">Maxim Fateev</reporter>
                        <labels>
                    </labels>
                <created>Wed, 31 May 2006 05:08:27 +0000</created>
                <updated>Thu, 10 Apr 2008 17:42:25 +0000</updated>
                            <resolved>Thu, 10 Apr 2008 17:42:25 +0000</resolved>
                                    <version>4.0</version>
                                    <fixVersion>5.1.0</fixVersion>
                    <fixVersion>4.0.3</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12937943" author="mfateev" created="Thu, 1 Jun 2006 01:53:34 +0000"  >&lt;p&gt;I was able to reproduce problem with default journal configuration. &lt;br/&gt;
1. Remove content of storage directory.&lt;br/&gt;
2. Start broker. &lt;br/&gt;
3. Enqueue 30000 messages.&lt;br/&gt;
4. Stop broker.&lt;br/&gt;
5. Start broker.&lt;br/&gt;
6. Dequeue 30000 messages.&lt;br/&gt;
7. Stop broker.&lt;br/&gt;
8. Start broker.&lt;br/&gt;
9. Enqueue 30000 messages.&lt;br/&gt;
10. Stop broker.&lt;br/&gt;
11. Recovery never ends looping through log files:&lt;/p&gt;

&lt;p&gt;fateev@fateev:/workplace/fateev/install/activemq-4.0-SNAPSHOT/activemq-core/activemq-data&amp;gt; grep overflowing server.log&lt;br/&gt;
[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=4&lt;br/&gt;
57352 &lt;span class=&quot;error&quot;&gt;&amp;#91;Journal Writer&amp;#93;&lt;/span&gt; DEBUG org.apache.activeio.journal.active.LogFileManager  - getNextDataRecordLocation overflowing into next logFile=4&lt;br/&gt;
[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=3&lt;br/&gt;
73287 &lt;span class=&quot;error&quot;&gt;&amp;#91;Journal Writer&amp;#93;&lt;/span&gt; DEBUG org.apache.activeio.journal.active.LogFileManager  - getNextDataRecordLocation overflowing into next logFile=3&lt;br/&gt;
[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=4&lt;br/&gt;
118821 &lt;span class=&quot;error&quot;&gt;&amp;#91;Journal Writer&amp;#93;&lt;/span&gt; DEBUG org.apache.activeio.journal.active.LogFileManager  - getNextDataRecordLocation overflowing into next logFile=4&lt;br/&gt;
[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=3&lt;br/&gt;
122112 &lt;span class=&quot;error&quot;&gt;&amp;#91;Journal Writer&amp;#93;&lt;/span&gt; DEBUG org.apache.activeio.journal.active.LogFileManager  - getNextDataRecordLocation overflowing into next logFile=3&lt;br/&gt;
[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=4&lt;br/&gt;
164157 &lt;span class=&quot;error&quot;&gt;&amp;#91;Journal Writer&amp;#93;&lt;/span&gt; DEBUG org.apache.activeio.journal.active.LogFileManager  - getNextDataRecordLocation overflowing into next logFile=4&lt;br/&gt;
[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=3&lt;br/&gt;
166746 &lt;span class=&quot;error&quot;&gt;&amp;#91;Journal Writer&amp;#93;&lt;/span&gt; DEBUG org.apache.activeio.journal.active.LogFileManager  - getNextDataRecordLocation overflowing into next logFile=3&lt;/p&gt;</comment>
                            <comment id="12938025" author="chirino" created="Mon, 5 Jun 2006 22:32:13 +0000"  >&lt;p&gt;How big were the messages?  Can the shiped example producer and consumer in the examples directory reproduce the issue?&lt;/p&gt;</comment>
                            <comment id="12938079" author="mfateev" created="Wed, 7 Jun 2006 02:15:10 +0000"  >&lt;p&gt;I don&apos;t know message size as I use shipped producer and consumer. Here are commands used to enqueue and dequeue messages:&lt;/p&gt;

&lt;p&gt;activemq/assembly/target/activemq-4.0-SNAPSHOT/bin/activemq-4.0-SNAPSHOT/example&amp;gt; ant producer -Ddurable=true -Dmax=10000&lt;br/&gt;
activemq/assembly/target/activemq-4.0-SNAPSHOT/bin/activemq-4.0-SNAPSHOT/example&amp;gt; ant consumer -Ddurable=true -Dmax=10000&lt;/p&gt;</comment>
                            <comment id="12937887" author="mfateev" created="Wed, 7 Jun 2006 02:17:13 +0000"  >&lt;p&gt;Also note that my first entry shows how to reproduce the problem without ANY consumers and producers.&lt;/p&gt;</comment>
                            <comment id="12938086" author="mfateev" created="Thu, 8 Jun 2006 01:32:31 +0000"  >&lt;p&gt;One possible clue is that I&apos;m running broker from eclipse. And eclipse kills processes without running their shutdown handlers. So it might be that to reproduce you&apos;ll need to kill broker with kill -9.&lt;/p&gt;</comment>
                            <comment id="12938102" author="mfateev" created="Thu, 8 Jun 2006 05:34:56 +0000"  >&lt;p&gt;After more testing it looks like the root cause is not executing usual shutdown sequence of a broker. When I stop broker in normal way I cannot reproduce the problem. When I stop it through &quot;kill -9&quot; or through eclipse it fails in the way described in contact. &lt;/p&gt;

&lt;p&gt;For me it looks like Journal design issue. It has to tolerate catastrofic shutdown but by design shutdown code has to be executed to leave journal in consistent state. Is any way to force journal into consistent state after every modification?&lt;/p&gt;</comment>
                            <comment id="12937757" author="jstrachan" created="Thu, 8 Jun 2006 17:47:21 +0000"  >&lt;p&gt;Great investigation Maxim; sounds like you are on to something.&lt;/p&gt;

&lt;p&gt;In an ideal world we&apos;d have an automated system test which did a kill -9 on a running broker and tested it recovers fine and so forth.&lt;/p&gt;

&lt;p&gt;In the meantime, I wonder if you could give us a tarball of the journal files created after a kill -9 and we can use recovery of those files as an automated test case.&lt;/p&gt;</comment>
                            <comment id="12937717" author="jstrachan" created="Thu, 8 Jun 2006 17:51:08 +0000"  >&lt;p&gt;BTW you should be able to attach a zipped up tarball of the activemq-data directory for a broker which can&apos;t recover and we can get it working&lt;/p&gt;</comment>
                            <comment id="12937813" author="mfateev" created="Fri, 9 Jun 2006 03:45:29 +0000"  >&lt;p&gt;storage of first failure case when single log file is used an no messages where published.&lt;/p&gt;</comment>
                            <comment id="12936200" author="mfateev" created="Fri, 9 Jun 2006 03:47:07 +0000"  >&lt;p&gt;Storage that reproduces infinite recovery loop with two files configured through the following code:&lt;/p&gt;

&lt;p&gt;            DefaultPersistenceAdapterFactory pFactory = new DefaultPersistenceAdapterFactory();&lt;br/&gt;
            pFactory.setJournalLogFiles(2);&lt;br/&gt;
            pFactory.setJournalLogFileSize(10240);&lt;br/&gt;
            broker.setPersistenceFactory(pFactory);&lt;/p&gt;</comment>
                            <comment id="12937959" author="mfateev" created="Fri, 9 Jun 2006 03:48:36 +0000"  >&lt;p&gt;I&apos;ve attached storatge files. &lt;/p&gt;</comment>
                            <comment id="12937915" author="chirino" created="Mon, 12 Jun 2006 02:34:51 +0000"  >&lt;p&gt;Thanks Maxim,&lt;/p&gt;

&lt;p&gt;Those journal files helped me reproduce and fix the problem!  I&apos;ve committed the fix against the 4.1 and 4.0 branch.  A subsequent nighly snapshot should include the fix.&lt;/p&gt;</comment>
                            <comment id="12937905" author="mfateev" created="Mon, 12 Jun 2006 23:38:56 +0000"  >&lt;p&gt;Thanks for quick fix. &lt;br/&gt;
Could you provide more info on the root cause? It would be nice to include such information as well as check in number every time you close an issue.&lt;/p&gt;</comment>
                            <comment id="12937928" author="chirino" created="Tue, 13 Jun 2006 00:41:25 +0000"  >&lt;p&gt;Here&apos;s the diff:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/viewvc/incubator/activemq/trunk/activeio/activeio-core/src/main/java/org/apache/activeio/journal/active/LogFileManager.java?view=diff&amp;amp;r1=413520&amp;amp;r2=413521&amp;amp;pathrev=413521&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/incubator/activemq/trunk/activeio/activeio-core/src/main/java/org/apache/activeio/journal/active/LogFileManager.java?view=diff&amp;amp;r1=413520&amp;amp;r2=413521&amp;amp;pathrev=413521&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We were iterating though all the records in the journal, when we got to the last record, and ask for the subsequent record, instead of getting null, we would get the first record in the journal again.  This only happened when all the files in the journal were &apos;active&apos;, they held records that were recorded after the mark.  Fixed the logic so that we don&apos;t go past the last record.&lt;/p&gt;</comment>
                            <comment id="12938027" author="chirino" created="Mon, 19 Jun 2006 23:24:01 +0000"  >&lt;p&gt;ah.. just noticed that 4.0.1 did not build a new activeio and ship with the new version.  I guess this will make it into 4.0.2 then.&lt;/p&gt;</comment>
                            <comment id="12938020" author="chirino" created="Tue, 11 Jul 2006 21:49:40 +0000"  >&lt;p&gt;We need to build activeio beta-4 and ship with that.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12460681" name="activemq-data-1-journal.tar.gz" size="84287" author="mfateev" created="Fri, 9 Jun 2006 03:45:29 +0000"/>
                            <attachment id="12460824" name="activemq-data-2-journal.tar.gz" size="722518" author="mfateev" created="Fri, 9 Jun 2006 03:47:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84345</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            19 years, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s0i7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161558</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>