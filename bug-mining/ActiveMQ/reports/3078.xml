<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:41:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6700] Leak of &quot;ActiveMQ Connection Executor&quot; threads and ActiveMQConnection objects in JCA</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6700</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;The ActiveMQ JCA layer may leak threads of name &lt;tt&gt;&quot;ActiveMQ Connection Executor&quot;&lt;/tt&gt; and instances of &lt;tt&gt;org.apache.activemq.ActiveMQConnection&lt;/tt&gt; when there are problems with establishing the connection. &lt;br/&gt;
If the initial openwire connection cannot be established, it may run an &quot;ActiveMQ Connection Executor&quot; thread to deal with the error leading to a code path that does not close the connection and does not clear up the &quot;ActiveMQ Connection Executor&quot; thread.&lt;br/&gt;
Low level details in further comments.&lt;/p&gt;

&lt;p&gt;This problem can be reproduced by running &lt;tt&gt;ActiveMQResourceAdapter.TransactionContext.recover()&lt;/tt&gt; but potentially other code paths in the resource adapter are effected as well.&lt;/p&gt;</description>
                <environment>&lt;p&gt;JCA&lt;/p&gt;</environment>
        <key id="13079131">AMQ-6700</key>
            <summary>Leak of &quot;ActiveMQ Connection Executor&quot; threads and ActiveMQConnection objects in JCA</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tmielke">Torsten Mielke</assignee>
                                    <reporter username="tmielke">Torsten Mielke</reporter>
                        <labels>
                            <label>jca</label>
                    </labels>
                <created>Mon, 12 Jun 2017 07:29:59 +0000</created>
                <updated>Mon, 12 Jun 2017 08:14:59 +0000</updated>
                            <resolved>Mon, 12 Jun 2017 08:14:59 +0000</resolved>
                                    <version>5.14.5</version>
                                    <fixVersion>5.14.6</fixVersion>
                                    <component>JCA Container</component>
                    <component>RAR</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16046282" author="tmielke" created="Mon, 12 Jun 2017 07:30:50 +0000"  >&lt;p&gt;Here are the low level details that will lead to leaking ActiveMQConnection objects and threads:&lt;/p&gt;

&lt;p&gt;The Arjuna transaction manager of JBoss EAP runs a periodic recovery and calls &lt;tt&gt;ActiveMQResourceAdapter.TransactionContext.recover()&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
  original = setConnection(newConnection());
  ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note around the same code path would be executed when Arjuna calls &lt;tt&gt;commit()&lt;/tt&gt; or &lt;tt&gt;rollback()&lt;/tt&gt; on the resource adapter.&lt;br/&gt;
The call to &lt;tt&gt;ActiveMQResourceAdapter.newConnection()&lt;/tt&gt; is implemented as&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ActiveMQConnection newConnection() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; JMSException {
                            ActiveMQConnection connection = makeConnection();
                            connection.start();
                            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; connection;
                        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Method &lt;tt&gt;makeConnection()&lt;/tt&gt; calls into &lt;tt&gt;ActiveMQConnectionFacotry.createActiveMQConnection()&lt;/tt&gt; which contains&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            connection = createActiveMQConnection(transport, factoryStats);
...
            transport.start();

...
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; connection;
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (JMSException e) {
            &lt;span class=&quot;code-comment&quot;&gt;// Clean up!
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                connection.close();
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable ignore) {
            }
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            &lt;span class=&quot;code-comment&quot;&gt;// Clean up!
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                connection.close();
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable ignore) {
            }
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; JMSExceptionSupport.create(&lt;span class=&quot;code-quote&quot;&gt;&quot;Could not connect to broker URL: &quot;&lt;/span&gt; + brokerURL + &lt;span class=&quot;code-quote&quot;&gt;&quot;. Reason: &quot;&lt;/span&gt; + e, e);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now if transport.start() raises an errror, this may not result in an exception in this method. Instead the &quot;ActiveMQ Connection Executor&quot; thread is used to call &lt;tt&gt;ActiveMQConnection.transportFailed()&lt;/tt&gt;. So the handling of the error happens in a different thread. Meanwhile above method &lt;tt&gt;ActiveMQConnectionFacotry.createActiveMQConnection()&lt;/tt&gt; finishes (without exceptions) and we are back in &lt;tt&gt;ActiveMQResourceAdapter.$2.newConnection()&lt;/tt&gt; where we call &lt;tt&gt;connection.start()&lt;/tt&gt; (See code sample above). &lt;/p&gt;

&lt;p&gt;In the meantime the &quot;ActiveMQ Connection Executor&quot; thread has most likely finished and marked the connection as failed (ActiveMQConnection.transportFailed = true).&lt;br/&gt;
&lt;tt&gt;ActiveMQConnection.start()&lt;/tt&gt; calls method &lt;tt&gt;ActiveMQConnectioncheckClosedOrFailed()&lt;/tt&gt; which checks for the value of property &lt;tt&gt;transportFailed&lt;/tt&gt;, which will be true by now and an exception will be raised.&lt;/p&gt;

&lt;p&gt;That exception is only caught in &lt;tt&gt;ActiveMQResourceAdapter.recover()&lt;/tt&gt; which in its &lt;tt&gt;finally&lt;/tt&gt; clause calls &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                            } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
                                closeConnection(original);
                            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but original is null at this stage, so the ActiveMQConnection instance does not get closed and the &quot;ActiveMQ Connection Executor&quot; thread is not shut down! Both, the thread and the instance are leaked!&lt;/p&gt;</comment>
                            <comment id="16046283" author="tmielke" created="Mon, 12 Jun 2017 07:31:37 +0000"  >&lt;p&gt;A fix for this bug is to catch and deal with these Exceptions in method &lt;tt&gt;ActiveMQResourceAdapter.$2.newConnection()&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ActiveMQConnection newConnection() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; JMSException {
                            ActiveMQConnection connection = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                                connection = makeConnection();
                                connection.start();
                            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (JMSException ex) {
                                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (connection != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                                    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                                        connection.close();
                                    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (JMSException ignore) { }
                                }
                                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; ex;
                            }
                            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; connection;
                        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16046308" author="jira-bot" created="Mon, 12 Jun 2017 08:09:55 +0000"  >&lt;p&gt;Commit a1e595c18fbfb8a21e632b665f180005f1daf053 in activemq&apos;s branch refs/heads/&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6700&quot; title=&quot;Leak of &amp;quot;ActiveMQ Connection Executor&amp;quot; threads and ActiveMQConnection objects in JCA&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6700&quot;&gt;&lt;del&gt;AMQ-6700&lt;/del&gt;&lt;/a&gt; from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tmielke&quot; class=&quot;user-hover&quot; rel=&quot;tmielke&quot;&gt;tmielke&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=a1e595c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=a1e595c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6700&quot; title=&quot;Leak of &amp;quot;ActiveMQ Connection Executor&amp;quot; threads and ActiveMQConnection objects in JCA&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6700&quot;&gt;&lt;del&gt;AMQ-6700&lt;/del&gt;&lt;/a&gt; Leak of ActiveMQ Connection Executor threads and ActiveMQConnection objects in JCA layer&lt;/p&gt;</comment>
                            <comment id="16046309" author="jira-bot" created="Mon, 12 Jun 2017 08:10:21 +0000"  >&lt;p&gt;Commit a1e595c18fbfb8a21e632b665f180005f1daf053 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tmielke&quot; class=&quot;user-hover&quot; rel=&quot;tmielke&quot;&gt;tmielke&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=a1e595c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=a1e595c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6700&quot; title=&quot;Leak of &amp;quot;ActiveMQ Connection Executor&amp;quot; threads and ActiveMQConnection objects in JCA&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6700&quot;&gt;&lt;del&gt;AMQ-6700&lt;/del&gt;&lt;/a&gt; Leak of ActiveMQ Connection Executor threads and ActiveMQConnection objects in JCA layer&lt;/p&gt;</comment>
                            <comment id="16046316" author="tmielke" created="Mon, 12 Jun 2017 08:14:59 +0000"  >&lt;p&gt;Fixed with commit &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=blobdiff;f=activemq-ra/src/main/java/org/apache/activemq/ra/ActiveMQResourceAdapter.java;h=b17674e88a9cec7ea5c95dd229dad5c143215833;hp=fd16603865d90c8f2ded3cfaa268056bca1a3731;hb=a1e595c18fbfb8a21e632b665f180005f1daf053;hpb=a6782443c1695f54176afecfda6c5c423bc18a84&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a1e595c18fbfb8a21e632b665f180005f1daf053&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 23 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3g5k7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>