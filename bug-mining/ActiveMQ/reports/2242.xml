<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:04:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5107] In-flight queue message redelivered to multiple listeners upon broker shutdown</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5107</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>
&lt;p&gt;To reproduce: &lt;/p&gt;

&lt;p&gt;1) Start 3 or more listener processes (see listener code below)&lt;/p&gt;

&lt;p&gt;2) Run producer to push one message on queue (see producer code below)&lt;/p&gt;

&lt;p&gt;3) One of the listeners will pick-up the message and sleep for one minute before auto acknowledging the message&lt;/p&gt;

&lt;p&gt;4) Start a shutdown sequence of the broker within the 60 second window (Ctrl-C or issue Terminate jvm(int) command from Hawtio console) &lt;/p&gt;

&lt;p&gt;5) All other idle listeners should get the same message redelivered simultaneously, each one having deliveryCount incremented &lt;/p&gt;



&lt;p&gt;Listener code:&lt;br/&gt;
--------------&lt;/p&gt;

&lt;p&gt;package com.test;&lt;br/&gt;
import javax.jms.Connection;&lt;br/&gt;
import javax.jms.Destination;&lt;br/&gt;
import javax.jms.Message;&lt;br/&gt;
import javax.jms.MessageConsumer;&lt;br/&gt;
import javax.jms.MessageListener;&lt;br/&gt;
import javax.jms.Session;&lt;br/&gt;
import javax.jms.TextMessage;&lt;br/&gt;
import org.apache.activemq.ActiveMQConnectionFactory;&lt;/p&gt;

&lt;p&gt;public class TestListener {&lt;br/&gt;
	public static void main(String[] args) {&lt;br/&gt;
		try {	&lt;br/&gt;
			ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(&quot;tcp://localhost:61616&quot;);&lt;br/&gt;
			Connection connection = connectionFactory.createConnection();&lt;br/&gt;
			Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);&lt;br/&gt;
			Destination destination = session.createQueue(&quot;TEST.QUEUE&quot;);&lt;br/&gt;
			MessageConsumer consumer = session.createConsumer(destination);&lt;/p&gt;

&lt;p&gt;			consumer.setMessageListener(new MessageListener() {&lt;br/&gt;
				public void onMessage(Message message) {&lt;br/&gt;
					try	&lt;/p&gt;
{
						TextMessage textMessage = (TextMessage) message;
						System.out.print(&quot;\nReceived &quot; + textMessage.getText());
						System.out.print(&quot;, Redelivery: &quot; + message.getJMSRedelivered());
						System.out.print(&quot;, Count: &quot; + message.getLongProperty(&quot;JMSXDeliveryCount&quot;));
						Thread.sleep(60000);			
						System.out.print(&quot;... finished after sleep&quot;);
					}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
						e.printStackTrace();
					}
&lt;p&gt;				}&lt;br/&gt;
			});&lt;/p&gt;

&lt;p&gt;			connection.start();&lt;br/&gt;
		} catch (Exception e) &lt;/p&gt;
{
			e.printStackTrace();
		}&lt;br/&gt;
	}&lt;br/&gt;
&lt;br/&gt;
	public TestListener() {
		super();
	}&lt;br/&gt;
}&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
Producer code:&lt;br/&gt;
--------------&lt;br/&gt;
&lt;br/&gt;
package com.test;&lt;br/&gt;
import java.util.Date;&lt;br/&gt;
import javax.jms.Connection;&lt;br/&gt;
import javax.jms.Destination;&lt;br/&gt;
import javax.jms.MessageProducer;&lt;br/&gt;
import javax.jms.Session;&lt;br/&gt;
import javax.jms.TextMessage;&lt;br/&gt;
&lt;br/&gt;
import org.apache.activemq.ActiveMQConnectionFactory;&lt;br/&gt;
&lt;br/&gt;
public class TestProducer {&lt;br/&gt;
	public static void main(String[] args) {&lt;br/&gt;
		try {
			thread(new HelloWorldProducer(), false);
		} catch (Exception e) {			e.printStackTrace();		}
&lt;p&gt;	}&lt;/p&gt;

&lt;p&gt;	public static class HelloWorldProducer implements Runnable {&lt;br/&gt;
		public void run() {&lt;br/&gt;
			try &lt;/p&gt;
{
				ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(&quot;tcp://localhost:61616&quot;);
				Connection connection = connectionFactory.createConnection();
				connection.start();
				Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);
				Destination destination = session.createQueue(&quot;TEST.QUEUE&quot;);
				MessageProducer producer = session.createProducer(destination);

				String text = &quot;test message created on &quot; + new Date();
				TextMessage message = session.createTextMessage(text);
				System.out.println(&quot;Sent &quot; + text);
				producer.send(message);

				session.close();
				connection.close();
			}
&lt;p&gt;			catch (Exception e) &lt;/p&gt;
{
				e.printStackTrace();
			}
&lt;p&gt;		}&lt;br/&gt;
		public HelloWorldProducer() {}&lt;br/&gt;
	}&lt;/p&gt;

&lt;p&gt;	public static void thread(Runnable runnable, boolean daemon) &lt;/p&gt;
{
		Thread brokerThread = new Thread(runnable);
		brokerThread.setDaemon(daemon);
		brokerThread.start();
	}

&lt;p&gt;	public TestProducer() &lt;/p&gt;
{
		super();
	}
&lt;p&gt;}&lt;/p&gt;

</description>
                <environment>&lt;p&gt;Windows 7 64Bit - Java &quot;1.6.0_20&quot;&lt;br/&gt;
CentOS 6.0 - Java &quot;1.7.0_09-icedtea&quot; &lt;/p&gt;</environment>
        <key id="12702213">AMQ-5107</key>
            <summary>In-flight queue message redelivered to multiple listeners upon broker shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="artnaseef">Arthur Naseef</assignee>
                                    <reporter username="gregg">Greg Garlak</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Mar 2014 18:32:10 +0000</created>
                <updated>Thu, 27 Mar 2014 15:16:03 +0000</updated>
                            <resolved>Thu, 27 Mar 2014 15:16:02 +0000</resolved>
                                    <version>5.9.0</version>
                                    <fixVersion>5.10.0</fixVersion>
                                    <component>Transport</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13939910" author="artnaseef" created="Tue, 18 Mar 2014 22:43:09 +0000"  >&lt;p&gt;Are the duplicates only as the broker shuts down, or do they occur after the broker restarts as well?&lt;/p&gt;</comment>
                            <comment id="13939935" author="artnaseef" created="Tue, 18 Mar 2014 23:02:30 +0000"  >&lt;p&gt;I reproduced this.  I also tried using the failover transport, shutting down the broker, restarting all the clients, bringing the broker back up, and then shutting it down again.&lt;/p&gt;

&lt;p&gt;In this second test case, the message was only redelivered one time.  Since the multiple deliveries only happen as the broker is shutting down, the shutdown of each connection is leading to redelivery to another consumer on another connection, and in the errant case, the second connection to shutdown (out of 3) happens to be the next one to which the message is delivered.  Therefore, the last connection remaining also gets the message.  Like this:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Consumer 1 gets message&lt;/li&gt;
	&lt;li&gt;Consumer 1 connection shuts down&lt;/li&gt;
	&lt;li&gt;Consumer 2 gets message&lt;/li&gt;
	&lt;li&gt;Consumer 2 connection shuts down&lt;/li&gt;
	&lt;li&gt;Consumer 3 gets message&lt;/li&gt;
	&lt;li&gt;Consumer 3 connection shuts down&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Bottom line - the broker should not be redelivering (or even delivering) any messages during shutdown.  Not sure if this will be an easy fix though, since the broker sends messages (advisories) to advise of things like shutting down consumers.&lt;/p&gt;
</comment>
                            <comment id="13939940" author="artnaseef" created="Tue, 18 Mar 2014 23:05:06 +0000"  >&lt;p&gt;Problem exists on 5.10-SNAPSHOT.&lt;/p&gt;</comment>
                            <comment id="13940096" author="artnaseef" created="Wed, 19 Mar 2014 02:48:48 +0000"  >&lt;p&gt;Looking at this more closely, I&apos;m leaning toward this being a non-problem.&lt;/p&gt;

&lt;p&gt;The JMS specification states this for AUTO_ACKNOWLEDGE:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;AUTO_ACKNOWLEDGE - With this option, the session automatically acknowledges a client&#8217;s receipt of a message when it has either successfully returned from a call to receive or the MessageListener it has called to process the message successfully returns.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This means that MessageListener &lt;b&gt;must&lt;/b&gt; be prepared to handle duplicates coming into the &lt;tt&gt;onMessage&lt;/tt&gt; call because (a) the message does not get acknowledged until the handler returns, and (b) there&apos;s always the chance that client application will fail between the &lt;tt&gt;onMessage&lt;/tt&gt; call and the message ACK (leading to redeliveries).&lt;/p&gt;

&lt;p&gt;Really, all client apps should be prepared to handle duplicates, although transacted applications are best positioned to avoid them.&lt;/p&gt;

&lt;p&gt;While it may be possible to improve this one case, such a change is not trivial, and such a change would not prevent the same condition from requiring handling in the client.&lt;/p&gt;</comment>
                            <comment id="13940447" author="gtully" created="Wed, 19 Mar 2014 13:04:13 +0000"  >&lt;p&gt;there may be an easy fix in org.apache.activemq.broker.region.Queue#removeSubscription. Don&apos;t do further dispatch if the broker is shutting down. this would avoid the cascade effect of dispatch to each closing connection in order. essentially gate the call to wakeup with a check on broker shutdown.&lt;/p&gt;</comment>
                            <comment id="13940463" author="artnaseef" created="Wed, 19 Mar 2014 13:34:11 +0000"  >&lt;p&gt;Thanks Gary - I&apos;ll take a look at that; if it proves to be straight-forward and effective, I&apos;ll put it in there.&lt;/p&gt;</comment>
                            <comment id="13949439" author="artnaseef" created="Thu, 27 Mar 2014 15:16:03 +0000"  >&lt;p&gt;Fixed Queue handling to avoid re-dispatch of unacked messages on removal of a consumer when the broker is shutting down.&lt;/p&gt;

&lt;p&gt;Commit: &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=29f34f4dab68ceb3138a6194617fa8f13f4d3875&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=29f34f4dab68ceb3138a6194617fa8f13f4d3875&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Includes a unit test.  There is a race condition in the tests which appears to be in between removal of all the queue&apos;s consumers and the resend logic on the Queue which causes false positives (i.e. failure to detect a problem), so the test runs up to 3 iterations in an attempt to increase reliability.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>380553</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 34 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1tkgn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>380833</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>