<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:05:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5258] Connection reference leak in PooledConnectionFactory leading to expired connections stuck in the pool</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5258</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;org.apache.activemq.jms.pool.PooledConnectionFactory creates a connection on startup without giving it back to the pool:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void start() {
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Staring the PooledConnectionFactory: create on start = {}&quot;&lt;/span&gt;, isCreateConnectionOnStartup());
        stopped.set(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isCreateConnectionOnStartup()) {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                &lt;span class=&quot;code-comment&quot;&gt;// warm the pool by creating a connection during startup
&lt;/span&gt;                createConnection();
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (JMSException e) {
                LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Create pooled connection during start failed. This exception will be ignored.&quot;&lt;/span&gt;, e);
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So no close() method of PooledConnection is called and so no decrementReferenceCount is called on ConnectionPool. So referenceCount never becomes 0.&lt;br/&gt;
Later on if an exception occurs and hasExpired of ConnectionPool is set to true, the connection will not be closed since expiredCheck() method of ConnectionPool always compares referenceCount with 0 and does close() only if it is 0.&lt;/p&gt;

&lt;p&gt;So we have a dead ConnectionPool instance and all usages result in &quot;XXX closed&quot; errors.&lt;/p&gt;

&lt;p&gt;The fix would be to add call to close() just after doing createConnection() in PooledConnectionFactory#start() to make referenceCount go to 0. Something like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void start() {
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Staring the PooledConnectionFactory: create on start = {}&quot;&lt;/span&gt;, isCreateConnectionOnStartup());
        stopped.set(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isCreateConnectionOnStartup()) {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                &lt;span class=&quot;code-comment&quot;&gt;// warm the pool by creating a connection during startup
&lt;/span&gt;                createConnection().close(); &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;--- makes sure referenceCount goes to 0
&lt;/span&gt;            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (JMSException e) {
                LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Create pooled connection during start failed. This exception will be ignored.&quot;&lt;/span&gt;, e);
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12725221">AMQ-5258</key>
            <summary>Connection reference leak in PooledConnectionFactory leading to expired connections stuck in the pool</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="barlabanov">Sergiy Barlabanov</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Jul 2014 09:51:23 +0000</created>
                <updated>Tue, 16 Dec 2014 00:02:52 +0000</updated>
                            <resolved>Mon, 7 Jul 2014 18:30:34 +0000</resolved>
                                    <version>5.9.1</version>
                    <version>5.10.0</version>
                                    <fixVersion>5.10.1</fixVersion>
                    <fixVersion>5.11.0</fixVersion>
                                    <component>Pool</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14053982" author="tabish121" created="Mon, 7 Jul 2014 18:30:34 +0000"  >&lt;p&gt;Fixed, connection is created and closed to allow it to reside in the pool as unused and error out or time out as expect. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>403404</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 20 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xfi7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>403452</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>