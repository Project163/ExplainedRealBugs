<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:09:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4705] Add keep alive support to shared file locker</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4705</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;issue on nsfv4 with a master slave configuration, where both the slave and the master could obtain a lock.&lt;br/&gt;
The following events occurred:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;master locks the file - does no more i/o to it &#8211; it&apos;s passive wrt the lock&lt;/li&gt;
	&lt;li&gt;slave asks every 10 seconds if it can get the lock nfs come back and say no, someone has it&lt;/li&gt;
	&lt;li&gt;nfs dies not nicely
	&lt;ul&gt;
		&lt;li&gt;nfsv4 is stateful - no callback for locks.&lt;/li&gt;
		&lt;li&gt;It has a grace period of 30 seconds to let all clients that had locks reclaim them as locked&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;master does not realize it needs to reclaim the lock and continues under the assumption it has the lock.&lt;/li&gt;
	&lt;li&gt;After 30 sec grace period, slave comes in and asks for the lock and it receives it.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12666328">AMQ-4705</key>
            <summary>Add keep alive support to shared file locker</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="gtully">Gary Tully</reporter>
                        <labels>
                            <label>kahadb</label>
                            <label>netapp</label>
                            <label>nfsv4</label>
                            <label>shared-file-lock</label>
                    </labels>
                <created>Fri, 30 Aug 2013 14:19:21 +0000</created>
                <updated>Wed, 14 Oct 2015 14:19:44 +0000</updated>
                            <resolved>Fri, 3 Jul 2015 11:40:44 +0000</resolved>
                                    <version>5.8.0</version>
                                    <fixVersion>5.12.0</fixVersion>
                                    <component>Message Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13754718" author="gtully" created="Fri, 30 Aug 2013 14:21:40 +0000"  >&lt;p&gt;currently keepAlive is a no op for the shared file locker. It does not delegate to channel fileLock isValid so it does not see any failure of even the acquisition by the slave.&lt;br/&gt;
having it check validity will help in this case and cause the master to die.&lt;/p&gt;</comment>
                            <comment id="13756272" author="gtully" created="Mon, 2 Sep 2013 23:55:57 +0000"  >&lt;p&gt;fix in &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/activemq/commit/0525f886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/activemq/commit/0525f886&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13757064" author="gtully" created="Tue, 3 Sep 2013 21:01:29 +0000"  >&lt;p&gt;use error for log message and check for file.exists&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=74b35bc5dd75edb9d9e3250a4362b85d78023d76&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=74b35bc5dd75edb9d9e3250a4362b85d78023d76&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14309094" author="tmielke" created="Fri, 6 Feb 2015 13:05:36 +0000"  >&lt;p&gt;Kind of follow up problem: &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5568&quot; title=&quot;Deleting lock file on broker shut down can take a master broker down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5568&quot;&gt;&lt;del&gt;AMQ-5568&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14539911" author="gtully" created="Tue, 12 May 2015 14:35:03 +0000"  >&lt;p&gt;The check for file existence is not bullet proof, b/c a slave can recreate the file if it is deleted and the master can still think it is valid.&lt;br/&gt;
This needs some more thought.&lt;/p&gt;</comment>
                            <comment id="14540364" author="ganeshmurthy" created="Tue, 12 May 2015 18:02:25 +0000"  >&lt;p&gt;Checking of the file exists and comparing the lastModified date  (time since epoch) of the lock file should take care of the following cases. &lt;/p&gt;

&lt;p&gt;1. Single broker configuration -The lock file is deleted - The file.exists() returns false and the broker stops&lt;br/&gt;
2. A master slave broker configuration - The master starts up, creates the lock file and locks it. The slave broker is constantly polling to see if it can obtain a lock. Now, the lock file is deleted, the slave starts up as the master (polling times specified by the lockKeepAlivePeriod and lockAcquireSleepInterval) and the master compares the date modified on the lock file and then shuts down.&lt;/p&gt;

&lt;p&gt;Please see attachment .&lt;/p&gt;</comment>
                            <comment id="14540902" author="gtully" created="Tue, 12 May 2015 22:23:55 +0000"  >&lt;p&gt;patch applied with thanks in &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/activemq/commit/ccbbecb4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/activemq/commit/ccbbecb4&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14957010" author="jira-bot" created="Wed, 14 Oct 2015 14:19:44 +0000"  >&lt;p&gt;Commit b285d1018803ceb4fdf7ea14c178de1e0abc9c8a in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=b285d10&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=b285d10&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4705&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-4705&lt;/a&gt; - ensure jvm lock system property is cleared in the event of lock release throwing exception.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12772996">AMQ-5568</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12770925">AMQ-5549</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12732306" name="AMQ-4705-GMURTHY-PATCH.TXT" size="2704" author="gmurthy" created="Tue, 12 May 2015 18:04:06 +0000"/>
                            <attachment id="12732307" name="KahaDBDeleteLockTest.java" size="2388" author="gmurthy" created="Tue, 12 May 2015 18:04:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>346267</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 5 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1nplr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>346568</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>