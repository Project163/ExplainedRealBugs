<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:01:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4753] amqp+nio+ssl: infinite loop during inital handshake with SSL + client certs</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4753</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Start with a client application running qpid v0.24 connecting to activemq v5.8.0 server over amqps. Configure the activemq server to use client SSL certificates for authentication.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                &amp;lt;!-- aqmp with SSL client certs --&amp;gt;
         &amp;lt;transportConnector name=&lt;span class=&quot;code-quote&quot;&gt;&quot;amqps&quot;&lt;/span&gt; uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;amqp+ssl:&lt;span class=&quot;code-comment&quot;&gt;//0.0.0.0:5672?maximumConnections=1000&amp;amp;amp;wireformat.maxFrameSize=104857600&amp;amp;amp;transport.transformer=jms&amp;amp;amp;needClientAuth=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This works and messages successfully flow from server to client. Qpid however has a fatal bug where it cannot recover from broken connections, and so attempt to switch to the activemq amqp client to work around this problem.&lt;/p&gt;

&lt;p&gt;On the client, we initialise activemq-amqp with the following parameters:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;!-- activemq --&amp;gt;
  &amp;lt;Parameter name=&lt;span class=&quot;code-quote&quot;&gt;&quot;java.naming.factory.initial&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.activemq.jndi.ActiveMQInitialContextFactory&quot;&lt;/span&gt; /&amp;gt;
  &amp;lt;Parameter name=&lt;span class=&quot;code-quote&quot;&gt;&quot;connectionFactoryNames&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;ConnectionFactory, QueueConnectionFactory, TopicConnectionFactory&quot;&lt;/span&gt; /&amp;gt;

  &amp;lt;!-- Server to connect to --&amp;gt;
&amp;lt;!-- activemq --&amp;gt;
  &amp;lt;Parameter name=&lt;span class=&quot;code-quote&quot;&gt;&quot;java.naming.provider.url&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;amqp+nio+ssl:&lt;span class=&quot;code-comment&quot;&gt;//amqp.${env:SERVER_ENV}.example.com:5672&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With activemq-amqp in place instead of qpid, the client starts up, but no messages are processed. Instead, it is found that the aqmp+nio+ssl provider is spinning the CPU at 100% part of the way through the SSL handshake process.&lt;/p&gt;

&lt;p&gt;A thread dump of the spinning thread is as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Full thread dump Java HotSpot(TM) 64-Bit Server VM (23.25-b01 mixed mode):

&lt;span class=&quot;code-quote&quot;&gt;&quot;localhost-startStop-1&quot;&lt;/span&gt; daemon prio=10 tid=0x000000000179b800 nid=0x638e runnable [0x00007fd1fd84a000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
        at sun.nio.ch.FileDispatcherImpl.read0(Native Method)
        at sun.nio.ch.SocketDispatcher.read(SocketDispatcher.java:39)
        at sun.nio.ch.IOUtil.readIntoNativeBuffer(IOUtil.java:225)
        at sun.nio.ch.IOUtil.read(IOUtil.java:198)
        at sun.nio.ch.SocketChannelImpl.read(SocketChannelImpl.java:375)
        - locked &amp;lt;0x00000000c4da50e8&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)
        at org.apache.activemq.transport.nio.NIOSSLTransport.secureRead(NIOSSLTransport.java:285)
        at org.apache.activemq.transport.nio.NIOSSLTransport.doHandshake(NIOSSLTransport.java:333)
        at org.apache.activemq.transport.nio.NIOSSLTransport.initializeStreams(NIOSSLTransport.java:128)
        at org.apache.activemq.transport.amqp.AmqpNioSslTransport.initializeStreams(AmqpNioSslTransport.java:43)
        at org.apache.activemq.transport.tcp.TcpTransport.connect(TcpTransport.java:514)
        at org.apache.activemq.transport.nio.NIOTransport.doStart(NIOTransport.java:156)
        at org.apache.activemq.transport.nio.NIOSSLTransport.doStart(NIOSSLTransport.java:356)
        at org.apache.activemq.util.ServiceSupport.start(ServiceSupport.java:55)
        at org.apache.activemq.transport.TransportFilter.start(TransportFilter.java:58)
        at org.apache.activemq.transport.TransportFilter.start(TransportFilter.java:58)
        at org.apache.activemq.transport.TransportFilter.start(TransportFilter.java:58)
        at org.apache.activemq.ActiveMQConnectionFactory.createActiveMQConnection(ActiveMQConnectionFactory.java:273)
        at org.apache.activemq.ActiveMQConnectionFactory.createActiveMQConnection(ActiveMQConnectionFactory.java:238)
        at org.apache.activemq.ActiveMQConnectionFactory.createConnection(ActiveMQConnectionFactory.java:184)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If an attempt is made to restart the activemq server, despite the spinning thread on the client the server side disconnection is detected by the client and the following exception is logged and the connection is successfully aborted:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Caused by: java.io.IOException: javax.net.ssl.SSLException: Received close_notify during handshake
        at org.apache.activemq.transport.nio.NIOSSLTransport.initializeStreams(NIOSSLTransport.java:130)
        at org.apache.activemq.transport.amqp.AmqpNioSslTransport.initializeStreams(AmqpNioSslTransport.java:43)
        at org.apache.activemq.transport.tcp.TcpTransport.connect(TcpTransport.java:514)
        at org.apache.activemq.transport.nio.NIOTransport.doStart(NIOTransport.java:156)
        at org.apache.activemq.transport.nio.NIOSSLTransport.doStart(NIOSSLTransport.java:356)
        at org.apache.activemq.util.ServiceSupport.start(ServiceSupport.java:55)
        at org.apache.activemq.transport.TransportFilter.start(TransportFilter.java:58)
        at org.apache.activemq.transport.TransportFilter.start(TransportFilter.java:58)
        at org.apache.activemq.transport.TransportFilter.start(TransportFilter.java:58)
        at org.apache.activemq.ActiveMQConnectionFactory.createActiveMQConnection(ActiveMQConnectionFactory.java:273)
        ... 33 more
Caused by: javax.net.ssl.SSLException: Received close_notify during handshake
        at sun.security.ssl.Alerts.getSSLException(Alerts.java:208)
        at sun.security.ssl.SSLEngineImpl.fatal(SSLEngineImpl.java:1619)
        at sun.security.ssl.SSLEngineImpl.fatal(SSLEngineImpl.java:1587)
        at sun.security.ssl.SSLEngineImpl.recvAlert(SSLEngineImpl.java:1732)
        at sun.security.ssl.SSLEngineImpl.readRecord(SSLEngineImpl.java:1060)
        at sun.security.ssl.SSLEngineImpl.readNetRecord(SSLEngineImpl.java:884)
        at sun.security.ssl.SSLEngineImpl.unwrap(SSLEngineImpl.java:758)
        at javax.net.ssl.SSLEngine.unwrap(SSLEngine.java:624)
        at org.apache.activemq.transport.nio.NIOSSLTransport.secureRead(NIOSSLTransport.java:304)
        at org.apache.activemq.transport.nio.NIOSSLTransport.doHandshake(NIOSSLTransport.java:333)
        at org.apache.activemq.transport.nio.NIOSSLTransport.initializeStreams(NIOSSLTransport.java:128)
        ... 42 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What seems to be happening is that amqp+nio+ssl gets part of the way through the handshake fails and goes into a spin, continuing the spin until the TCP connection is killed from the other side, at which point the client aborts and continues as if nothing had happened.&lt;/p&gt;</description>
                <environment>&lt;p&gt;java version &quot;1.7.0_25&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.7.0_25-b15)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 23.25-b01, mixed mode)&lt;/p&gt;</environment>
        <key id="12671230">AMQ-4753</key>
            <summary>amqp+nio+ssl: infinite loop during inital handshake with SSL + client certs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="minfrin">Graham Leggett</reporter>
                        <labels>
                            <label>amqp</label>
                            <label>nio</label>
                            <label>ssl</label>
                    </labels>
                <created>Sun, 29 Sep 2013 00:08:13 +0000</created>
                <updated>Thu, 25 Sep 2014 07:46:00 +0000</updated>
                            <resolved>Wed, 9 Oct 2013 15:13:21 +0000</resolved>
                                    <version>5.8.0</version>
                                    <fixVersion>5.9.0</fixVersion>
                                    <component>JMS client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13781380" author="tabish121" created="Sun, 29 Sep 2013 14:06:46 +0000"  >&lt;p&gt;Did you try a 5.9 SNAPSHOT?  There are many AMQP fixes in there so testing on 5.8 at this point doesn&apos;t really tell us if its really an issue any more.  Provide a unit test if you want us to look at it.  &lt;/p&gt;</comment>
                            <comment id="13781533" author="minfrin" created="Sun, 29 Sep 2013 23:44:32 +0000"  >&lt;p&gt;I just tried to build 5.9-SNAPSHOT, but the build is currently broken using a completely fresh repository:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[INFO] ------------------------------------------------------------------------
[INFO] Reactor Summary:
[INFO] 
[INFO] ActiveMQ .......................................... SUCCESS [16.037s]
[INFO] ActiveMQ :: Openwire Generator .................... SUCCESS [20.278s]
[INFO] ActiveMQ :: Client ................................ SUCCESS [54.251s]
[INFO] ActiveMQ :: Openwire Legacy Support ............... SUCCESS [9.361s]
[INFO] ActiveMQ :: JAAS .................................. SUCCESS [23.332s]
[INFO] ActiveMQ :: Broker ................................ SUCCESS [18.701s]
[INFO] ActiveMQ :: KahaDB Store .......................... SUCCESS [11.139s]
[INFO] ActiveMQ :: STOMP Protocol ........................ SUCCESS [2.583s]
[INFO] ActiveMQ :: MQTT Protocol ......................... SUCCESS [34.112s]
[INFO] ActiveMQ :: JDBC Store ............................ SUCCESS [13.440s]
[INFO] ActiveMQ :: LevelDB Store ......................... SUCCESS [6:16.778s]
[INFO] ActiveMQ :: RA .................................... SUCCESS [28.812s]
[INFO] ActiveMQ :: Pool .................................. SUCCESS [11.768s]
[INFO] ActiveMQ :: Spring ................................ SUCCESS [2:15.342s]
[INFO] ActiveMQ :: AMQP .................................. SUCCESS [31.109s]
[INFO] ActiveMQ :: Console ............................... SUCCESS [13.578s]
[INFO] ActiveMQ :: Unit Tests ............................ SUCCESS [34.303s]
[INFO] ActiveMQ :: Camel ................................. FAILURE [54.012s]
[INFO] ActiveMQ :: HTTP Protocol Support ................. SKIPPED
[INFO] ActiveMQ :: All JAR bundle ........................ SKIPPED
[INFO] ActiveMQ :: File Server ........................... SKIPPED
[INFO] ActiveMQ :: Log4j Appender ........................ SKIPPED
[INFO] ActiveMQ :: Apache Karaf .......................... SKIPPED
[INFO] ActiveMQ :: RAR ................................... SKIPPED
[INFO] ActiveMQ :: Run Jar ............................... SKIPPED
[INFO] ActiveMQ :: &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt; Configuration ................. SKIPPED
[INFO] ActiveMQ :: Tooling ............................... SKIPPED
[INFO] ActiveMQ :: Memory Usage Test Plugin .............. SKIPPED
[INFO] ActiveMQ :: Performance Test Plugin ............... SKIPPED
[INFO] ActiveMQ :: StartUp Plugin ........................ SKIPPED
[INFO] ActiveMQ :: Web ................................... SKIPPED
[INFO] ActiveMQ :: OSGi bundle ........................... SKIPPED
[INFO] ActiveMQ :: Blueprint ............................. SKIPPED
[INFO] ActiveMQ :: Web Demo .............................. SKIPPED
[INFO] ActiveMQ :: Web Console ........................... SKIPPED
[INFO] ActiveMQ :: Karaf Integration Tests ............... SKIPPED
[INFO] ActiveMQ :: Integration Test :: Spring 3.1 ........ SKIPPED
[INFO] ActiveMQ :: Assembly .............................. SKIPPED
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 15:03.987s
[INFO] Finished at: Sun Sep 29 15:39:32 GMT+00:00 2013
[INFO] Final Memory: 98M/235M
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal on project activemq-camel: Could not resolve dependencies &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; project org.apache.activemq:activemq-camel:bundle:5.9-SNAPSHOT: Could not find artifact org.apache.activemq:activemq-unit-tests:jar:tests:5.9-SNAPSHOT in com.fusesource.m2.snapshot (http:&lt;span class=&quot;code-comment&quot;&gt;//repo.fusesource.com/nexus/content/repositories/snapshots/) -&amp;gt; [Help 1]&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It looks like the activemq-unit-tests project is build without a classifier, but the dependency above requires the classifier:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[minfrin@localhost activemq]$ pushd ~/.m2/repository/org/apache/activemq/activemq-unit-tests/5.9-SNAPSHOT/ 
[minfrin@localhost 5.9-SNAPSHOT]$ ls -al
total 100
drwxrwxr-x 2 minfrin minfrin  4096 Sep 29 16:39 .
drwxrwxr-x 3 minfrin minfrin  4096 Sep 29 15:38 ..
-rw-rw-r-- 1 minfrin minfrin   210 Sep 29 16:38 _maven.repositories
-rw-rw-r-- 1 minfrin minfrin   412 Sep 29 16:39 activemq-unit-tests-5.9-SNAPSHOT-tests.jar.lastUpdated
-rw-rw-r-- 1 minfrin minfrin 17159 Sep 29 16:38 activemq-unit-tests-5.9-SNAPSHOT.jar
-rw-rw-r-- 1 minfrin minfrin 59725 Sep 29 13:23 activemq-unit-tests-5.9-SNAPSHOT.pom
-rw-rw-r-- 1 minfrin minfrin   718 Sep 29 16:38 maven-metadata-local.xml
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It seems the current build is relying on stale SNAPSHOT jars in order to build successfully.&lt;/p&gt;</comment>
                            <comment id="13781548" author="minfrin" created="Mon, 30 Sep 2013 00:24:40 +0000"  >&lt;p&gt;Commenting out the activemq-camel module allows the build to get far enough to build the activemq-amqp module, and this is enough to swap the jar in and test. From this I found that there was no difference in behaviour, NIO still spins at 100% as before.&lt;/p&gt;

&lt;p&gt;Looking closer in the code, I am not seeing any kind of clear mechanism to switch from a read to a write, or a write to a read during the handshake, as required by the SSL protocol. I suspect this lack of support is causing the spin as an attempt is made to read when SSL wants us to write instead. I am going to have to get this code up onto a debugger first to see what it is doing in detail.&lt;/p&gt;</comment>
                            <comment id="13783918" author="kearls" created="Wed, 2 Oct 2013 13:29:41 +0000"  >&lt;p&gt;Here&apos;s a unit test which should reproduce this.  (Note the test hangs using qpid 0.22, I haven&apos;t tried it with 0.24 yet)&lt;/p&gt;</comment>
                            <comment id="13789661" author="tabish121" created="Tue, 8 Oct 2013 20:33:07 +0000"  >&lt;p&gt;From a brief glance it looks as though the NIOSSL AMQP Transport is not complete, it appears to be passing a raw ByteBuffer onto the protocol converter before processing it into an AMQPHeader so an IllegalStateException is being thrown. &lt;/p&gt;</comment>
                            <comment id="13789753" author="tabish121" created="Tue, 8 Oct 2013 21:55:30 +0000"  >&lt;p&gt;Submitted a patch to the AmqpNIOSSLTransport to get things working a bit better.  There&apos;s still no real tests there for this one so wouldn&apos;t count on this being a complete fix but it gets past the initial protocol discriminator phase and starts passing down proper Buffers to the protocol converter.  &lt;/p&gt;</comment>
                            <comment id="13790298" author="kearls" created="Wed, 9 Oct 2013 12:31:12 +0000"  >&lt;p&gt;This runs the JoramJmsTests with amqp+nio+ssl&lt;/p&gt;</comment>
                            <comment id="13790447" author="tabish121" created="Wed, 9 Oct 2013 15:13:21 +0000"  >&lt;p&gt;Test patch applied with thanks.  Tests are passing.  &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12606287" name="AMQ-4753.patch" size="7188" author="kearls" created="Wed, 2 Oct 2013 13:29:41 +0000"/>
                            <attachment id="12607547" name="AMQ-4753Joram.patch" size="10112" author="kearls" created="Wed, 9 Oct 2013 12:31:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>350936</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 6 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1oiav:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>351227</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>