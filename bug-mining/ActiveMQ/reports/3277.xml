<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:48:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5486] Thread synchronization overhead is unexpectedly high</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5486</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;There&apos;s about 20 topics with virtual topic enabled, hundreds of comsumers/producers connected to MQ on NIO transport connector. During the run there&apos;re about 12000 msg flow in per second, not a very high rate, but ActiveMQ consumes a lot of CPU resource (about 600%~1000%). To find out what&apos;s the most CPU consuming code path, I use JProfiler to dig into the process. &lt;/p&gt;

&lt;p&gt;Among all the NIO worker threads, most of them were frequently blocked and did a little job between the &apos;unblocked&apos; time. While they&apos;re expected spend most of their time slices on waiting for work item and processed them.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12686801/12686801_nio_worker_blocked_frequently.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;After reviewing the monitor usage history and stats, I think these NIO workers were competing fiercely with each other on executing a synchronized method (DestinationMap::get), which is also the most hot spot in the program . I also notice that the caller AbstractRegion::getDestinations acquires a read lock before calling it, so I guess this could be a left out, read lock is the actual lock type required here.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12686802/12686802_monitor_usage_stats.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12686799/12686799_nio_worker_blocked_1.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12686800/12686800_nio_worker_blocked_2.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;It&apos;s too difficult for me to list all critical sections between NIO workers, or between NIO workers and BrokerService which adds up to the overall synchronize overhead. So I attach the relevant info, with the hope of finding a complete solution to this.&lt;/p&gt;</description>
                <environment>&lt;p&gt;UbuntuServer 12.04 x86_64, Linux Kernel 3.20.23, OpenJDK 1.7.0_51 64-Bit Server VM, Xms 2G, Xms 8G, CPU: E5-2620 v2 X 2, 64 GB RAM&lt;/p&gt;</environment>
        <key id="12761268">AMQ-5486</key>
            <summary>Thread synchronization overhead is unexpectedly high</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="benjaminhuang">Benjamin  Huang</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Dec 2014 08:23:25 +0000</created>
                <updated>Mon, 25 Nov 2019 12:13:28 +0000</updated>
                            <resolved>Mon, 28 Mar 2016 17:56:20 +0000</resolved>
                                    <version>5.9.1</version>
                                    <fixVersion>5.14.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14257893" author="benjaminhuang" created="Wed, 24 Dec 2014 03:26:01 +0000"  >&lt;p&gt;one of my idea is to make thread pool behavior tunable, please refer to attachment &apos;tunable_threadpool_options.patch&apos; and avoid worker thread from being created too actively ( use CallerRunsPolicy as RejectionHandler)&lt;/p&gt;</comment>
                            <comment id="15046777" author="gtully" created="Tue, 8 Dec 2015 11:40:23 +0000"  >&lt;p&gt;that looks like a sensible enhancement. my only comment would be the current MAX_INT default  appears to be being replaced with 10, as the default value when the property is referenced. I guess it would be best to retain the current defaults.&lt;/p&gt;</comment>
                            <comment id="15101989" author="tabish121" created="Fri, 15 Jan 2016 16:16:27 +0000"  >&lt;p&gt;Adds the last configuration option that was missing from this request, all the TaskRunnerFactory and SelectorManager values are configurable now.  &lt;/p&gt;</comment>
                            <comment id="15214570" author="jira-bot" created="Mon, 28 Mar 2016 17:55:51 +0000"  >&lt;p&gt;Commit 9a866cf5673c03f5b2a324ec81802fd986a0ad72 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=9a866cf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=9a866cf&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5486&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5486&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Default to caller runs policy on task rejection.&lt;/p&gt;</comment>
                            <comment id="15214572" author="tabish121" created="Mon, 28 Mar 2016 17:56:20 +0000"  >&lt;p&gt;Most of the idea here along with other enhancements have made it into the code at this point.  &lt;/p&gt;</comment>
                            <comment id="15529299" author="jira-bot" created="Wed, 28 Sep 2016 11:16:20 +0000"  >&lt;p&gt;Commit 634b42016a4c347217129d49a4175afaba9666ed in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=634b420&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=634b420&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5486&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5486&lt;/a&gt; - allow selector manager to reject tasks - org.apache.activemq.transport.nio.SelectorManager.rejectWork leaving the default to caller runs policy. This allows a broker to implement qos for existing connections by forcing others away&lt;/p&gt;</comment>
                            <comment id="16981504" author="jira-bot" created="Mon, 25 Nov 2019 12:13:28 +0000"  >&lt;p&gt;Commit 3f5bb9710a4d4c88e9f88cb5c4dc83c1755cb72c in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=3f5bb97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=3f5bb97&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5486&quot; title=&quot;Thread synchronization overhead is unexpectedly high&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5486&quot;&gt;&lt;del&gt;AMQ-5486&lt;/del&gt;&lt;/a&gt; - fix intermittent failure in the test, reallign assertions&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12930168">AMQ-6126</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12944454">AMQ-6184</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12686803" name="Method_Statistics.html" size="527163" author="benjaminhuang" created="Fri, 12 Dec 2014 08:28:36 +0000"/>
                            <attachment id="12686804" name="Monitor_History.zip" size="1211651" author="benjaminhuang" created="Fri, 12 Dec 2014 08:28:36 +0000"/>
                            <attachment id="12686805" name="Monitor_Usage_Statistics.html" size="90622" author="benjaminhuang" created="Fri, 12 Dec 2014 08:28:36 +0000"/>
                            <attachment id="12686802" name="monitor_usage_stats.png" size="354901" author="benjaminhuang" created="Fri, 12 Dec 2014 08:28:36 +0000"/>
                            <attachment id="12686799" name="nio_worker_blocked_1.png" size="418511" author="benjaminhuang" created="Fri, 12 Dec 2014 08:24:20 +0000"/>
                            <attachment id="12686800" name="nio_worker_blocked_2.png" size="414470" author="benjaminhuang" created="Fri, 12 Dec 2014 08:24:20 +0000"/>
                            <attachment id="12686801" name="nio_worker_blocked_frequently.png" size="405235" author="benjaminhuang" created="Fri, 12 Dec 2014 08:24:20 +0000"/>
                            <attachment id="12688980" name="tunable_threadpool_options.patch" size="6174" author="benjaminhuang" created="Wed, 24 Dec 2014 03:26:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 51 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23ctz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>