<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:07:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4107] Message order can be broken for Topic under a high load when topicPrefetch=1 and comsumer is slow</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4107</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;For &amp;lt;amq:policyEntry topic=&quot;&amp;gt;&quot; producerFlowControl=&quot;true&quot; memoryLimit=&quot;30mb&quot; &lt;font color=&quot;red&quot;&gt;topicPrefetch=&quot;1&quot;&lt;/font&gt; blockedProducerWarningInterval=&quot;30&quot;&amp;gt;&lt;/p&gt;

&lt;p&gt;Short excerpt from TopicSubscription class:&lt;br/&gt;
public void add(MessageReference node) throws Exception {&lt;/p&gt;

&lt;p&gt;&#8230;..&lt;br/&gt;
              if (&lt;font color=&quot;red&quot;&gt;!isFull()&lt;/font&gt; &amp;amp;&amp;amp; matched.isEmpty()  &amp;amp;&amp;amp; !isSlave()) {&lt;br/&gt;
            // if maximumPendingMessages is set we will only discard messages which&lt;br/&gt;
            // have not been dispatched (i.e. we allow the prefetch buffer to be filled)&lt;br/&gt;
       &lt;font color=&quot;red&quot;&gt;dispatch(node);&lt;/font&gt;                   &amp;lt;- Second message will go this way and might be dispatched sooner than first one.&lt;br/&gt;
            setSlowConsumer(false);&lt;br/&gt;
        } else {&lt;br/&gt;
&#8230;&#8230;.&lt;br/&gt;
if (&lt;font color=&quot;red&quot;&gt;matched.tryAddMessageLast(node, 10))&lt;/font&gt; &lt;/p&gt;
{    &amp;lt;- first message will be put in the VMCursor queue and might be dispatched later 
        
break;
                        }
&lt;p&gt;.....&lt;br/&gt;
 &lt;font color=&quot;red&quot;&gt;dispatchMatched();&lt;/font&gt;   &amp;lt;- First message won&apos;t be dispatched immediately because !isFull() is still false&lt;br/&gt;
}&lt;br/&gt;
Possible scenario as I can see it from logs:&lt;br/&gt;
1. First message has arrived and !isFull() is false because consumer didn&apos;t take some previous message yet.&lt;br/&gt;
2. First message will be processed by tryAddMessageLast in VMPendingMessageCursor class and will be dispatched very lately because !isFull() is still false.&lt;br/&gt;
3. Meanwhile consumer reads some previous message and !isFull() will return true.    &lt;br/&gt;
4. Second message will be dispatched immediately and might be first to be delivered. &lt;br/&gt;
5. Then first message is dispatched.&lt;br/&gt;
6. Message order is broken.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12611796">AMQ-4107</key>
            <summary>Message order can be broken for Topic under a high load when topicPrefetch=1 and comsumer is slow</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="sdcf">Yuriy Sidelnikov</reporter>
                        <labels>
                    </labels>
                <created>Mon, 15 Oct 2012 08:09:15 +0000</created>
                <updated>Mon, 12 Jan 2015 12:02:13 +0000</updated>
                            <resolved>Mon, 12 Jan 2015 12:02:13 +0000</resolved>
                                    <version>5.6.0</version>
                                    <fixVersion>5.11.0</fixVersion>
                                    <component>Transport</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13492208" author="sdcf" created="Wed, 7 Nov 2012 09:08:32 +0000"  >&lt;p&gt;Please have a look at the attachment for the patch to fix wrong message order issue.The patch synchronizes a message processing and remove excess syncs inside added sync block.&lt;/p&gt;</comment>
                            <comment id="13850427" author="nickolay_martinov" created="Tue, 17 Dec 2013 13:11:11 +0000"  >&lt;p&gt;Problem reproduces on 5.9.&lt;/p&gt;</comment>
                            <comment id="13866493" author="alexanderz" created="Thu, 9 Jan 2014 10:01:53 +0000"  >&lt;p&gt;A patch to fix the problem on ActiveMQ 5.9&lt;/p&gt;</comment>
                            <comment id="13867772" author="gtully" created="Fri, 10 Jan 2014 13:08:56 +0000"  >&lt;p&gt;@Alexander that patch looks good but it would be great if it included a junit test case that shows the problem can protect the change into the future.&lt;/p&gt;</comment>
                            <comment id="14149593" author="tbain98" created="Fri, 26 Sep 2014 16:14:50 +0000"  >&lt;p&gt;Will this patch only be applied if a unit test is added for it?&lt;/p&gt;</comment>
                            <comment id="14151958" author="nickolay_martinov" created="Mon, 29 Sep 2014 17:55:37 +0000"  >&lt;p&gt;Sorry. We have used JMeter based tests for fix proof and don&apos;t plan to contribute unit tests at the moment.&lt;/p&gt;</comment>
                            <comment id="14273501" author="gtully" created="Mon, 12 Jan 2015 11:30:17 +0000"  >&lt;p&gt;seems the intermittent failure of org.apache.activemq.usecases.TwoMulticastDiscoveryBrokerTopicSendReceiveTest shows this problem&lt;/p&gt;</comment>
                            <comment id="14273524" author="gtully" created="Mon, 12 Jan 2015 12:02:13 +0000"  >&lt;p&gt;fix in &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/activemq/commit/8dbb48a2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/activemq/commit/8dbb48a2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;TwoMulticastDiscoveryBrokerTopicSendReceiveTest provided the test&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12552440" name="4107.diff" size="2857" author="sdcf" created="Wed, 7 Nov 2012 09:08:32 +0000"/>
                            <attachment id="12622146" name="ActiveMQ-5.9-AMQ-4107.patch" size="3366" author="alexanderz" created="Thu, 9 Jan 2014 10:01:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>248654</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 45 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i09xjj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>55875</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>