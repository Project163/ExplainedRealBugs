<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:45:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-7135] Deleting a destination with a large number of page files cause OOM. </title>
                <link>https://issues.apache.org/jira/browse/AMQ-7135</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;When removing (delete) a destination using the console an error is reported. It appears all the page files are batched into memory.&#160; If you have a large set of page files and a relatively small heap, this will cause the system to run out of memory. &lt;/p&gt;

&lt;p&gt;This can be reproduced by doing the following:&lt;/p&gt;

&lt;p&gt;env: heap size: 384MB&lt;/p&gt;

&lt;p&gt;1. Create a &#8220;test&#8221; queue and send more than 2 millions of persistent messages with size of 100KB to the &#8220;test&#8221;queue (this take some times). &lt;br/&gt;
2. Delete &#8220;test&#8221; queue by clicking &#8220;delete&#8221; button on ActiveMQ Console. &lt;br/&gt;
3. Wait and broker will die eventually. &lt;br/&gt;
4. Broker won&#8217;t reboot successfully&lt;/p&gt;

&lt;p&gt;The observed error below can be seen in the logs.&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;org.springframework.web.util.NestedServletException: Handler dispatch failed; nested exception is java.lang.OutOfMemoryError: GC overhead limit exceeded&lt;/tt&gt;&lt;br/&gt;
{{ at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:982)&lt;span class=&quot;error&quot;&gt;&amp;#91;spring-webmvc-4.3.18.RELEASE.jar:4.3.18.RELEASE&amp;#93;&lt;/span&gt;}}&lt;/p&gt;</description>
                <environment></environment>
        <key id="13209200">AMQ-7135</key>
            <summary>Deleting a destination with a large number of page files cause OOM. </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jgoodyear">Jamie Mark Goodyear</assignee>
                                    <reporter username="heathkesler">Heath Kesler</reporter>
                        <labels>
                    </labels>
                <created>Sat, 12 Jan 2019 21:27:57 +0000</created>
                <updated>Mon, 28 Jan 2019 21:46:31 +0000</updated>
                            <resolved>Mon, 14 Jan 2019 17:20:22 +0000</resolved>
                                    <version>5.15.8</version>
                                    <fixVersion>5.15.9</fixVersion>
                    <fixVersion>5.16.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16741675" author="heathkesler" created="Sun, 13 Jan 2019 22:39:23 +0000"  >&lt;p&gt;Here is a link to the PR: &lt;a href=&quot;https://github.com/apache/activemq/pull/337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/337&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16742024" author="heathkesler" created="Mon, 14 Jan 2019 12:49:02 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jgoodyear&quot; class=&quot;user-hover&quot; rel=&quot;jgoodyear&quot;&gt;jgoodyear&lt;/a&gt;, I&#8217;ve made a change&#8230;. can you please have a look at it?&lt;br/&gt;
This will protect the broker when &lt;a href=&quot;https://github.com/apache/activemq/blob/activemq-5.15.x/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/disk/page/PageFile.java#L1121&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/activemq-5.15.x/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/disk/page/PageFile.java#L1121&lt;/a&gt; tries to read into memory all the pageFiles during a destination delete.&#160; Let me know what you think when you have time.&lt;/p&gt;</comment>
                            <comment id="16742067" author="jgoodyear" created="Mon, 14 Jan 2019 13:31:30 +0000"  >&lt;p&gt;Purging a destination before deleting it seems fare. The purge operation for a destination appears to perform the remove message per pageFile instead of reading all pageFiles into memory before taking action (preferable memory wise).&#160;&lt;/p&gt;

&lt;p&gt;Looking closer at PageFile, the routine (writeBatch) appears to pick up the PageFiles, do a recovery check for all pageFiles, then process the pageFiles. The only way i see to reduce the memory load would be to stream pageFile by pageFile through or use small batches of the batch... perhaps a bit too much extra complexity (introducing a potential&#160;tuning area for delete performance - batch size).&#160;&lt;/p&gt;</comment>
                            <comment id="16742325" author="jgoodyear" created="Mon, 14 Jan 2019 17:19:53 +0000"  >&lt;p&gt;I&apos;ve merged &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=heathkesler&quot; class=&quot;user-hover&quot; rel=&quot;heathkesler&quot;&gt;heathkesler&lt;/a&gt;&apos;s&#160;PR into Activemq-5.15.x and cherry picked it into Master.&lt;/p&gt;

&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=heathkesler&quot; class=&quot;user-hover&quot; rel=&quot;heathkesler&quot;&gt;heathkesler&lt;/a&gt; for the patch! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16742326" author="jgoodyear" created="Mon, 14 Jan 2019 17:20:23 +0000"  >&lt;p&gt;Thank you Heath Kesler for the patch.&lt;/p&gt;</comment>
                            <comment id="16754384" author="jira-bot" created="Mon, 28 Jan 2019 21:38:18 +0000"  >&lt;p&gt;Commit ec9daee6c3e7831ebb851be65feaf93575771265 in activemq&apos;s branch refs/heads/master from Jamie Mark Goodyear&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=ec9daee&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=ec9daee&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7135&quot; title=&quot;Deleting a destination with a large number of page files cause OOM. &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7135&quot;&gt;&lt;del&gt;AMQ-7135&lt;/del&gt;&lt;/a&gt; Update AMQ2832 unit test expectation post 7135 fix&lt;/p&gt;</comment>
                            <comment id="16754397" author="jira-bot" created="Mon, 28 Jan 2019 21:46:31 +0000"  >&lt;p&gt;Commit fcfb059c878f86c0f00686cd768f0ff3e6454ece in activemq&apos;s branch refs/heads/activemq-5.15.x from Jamie Mark Goodyear&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=fcfb059&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=fcfb059&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7135&quot; title=&quot;Deleting a destination with a large number of page files cause OOM. &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7135&quot;&gt;&lt;del&gt;AMQ-7135&lt;/del&gt;&lt;/a&gt; Update AMQ2832 unit test expectation post 7135 fix&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|u00s28:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>