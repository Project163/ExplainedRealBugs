<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:42:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2280] stomp: Transport failed: java.io.IOException: Unexpected error occured</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2280</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>
&lt;p&gt;This does not happen in 5.2.0, only in 5.3..SNAPSHOT &lt;/p&gt;

&lt;p&gt;I&apos;m getting the above exception with the following STOMP session&lt;/p&gt;


&lt;p&gt;&amp;gt; telnet localhost 61613&lt;br/&gt;
Trying 127.0.0.1...&lt;br/&gt;
Connected to localhost.&lt;br/&gt;
Escape character is &apos;^]&apos;.&lt;br/&gt;
CONNECT&lt;br/&gt;
passcode:password&lt;br/&gt;
login:login&lt;/p&gt;

&lt;p&gt;^@&lt;br/&gt;
CONNECTED&lt;br/&gt;
session:ID:alex-60773-1244124360289-2:2&lt;/p&gt;


&lt;p&gt;SUBSCRIBE&lt;br/&gt;
activemq.prefetchSize:1&lt;br/&gt;
ack:client&lt;br/&gt;
destination:/queue/COMMAND.HOST.alex&lt;br/&gt;
activemq.exclusive:true&lt;/p&gt;

&lt;p&gt;^@&lt;br/&gt;
BEGIN&lt;br/&gt;
destination:/queue/COMMANDREPLY.HOST.alex&lt;br/&gt;
transaction:ID:alex-58262-1244123488785-2:1-1&lt;br/&gt;
persistent:true&lt;/p&gt;

&lt;p&gt;^@&lt;br/&gt;
SEND&lt;br/&gt;
destination:/queue/COMMANDREPLY.HOST.alex&lt;br/&gt;
transaction:ID:alex-58262-1244123488785-2:1-1&lt;br/&gt;
receipt:ID:alex-58262-1244123488785-2:1-2&lt;br/&gt;
persistent:true&lt;/p&gt;

&lt;p&gt;replytext&lt;br/&gt;
^@&lt;br/&gt;
RECEIPT&lt;br/&gt;
receipt-id:ID:alex-58262-1244123488785-2:1-2&lt;/p&gt;


&lt;p&gt;COMMIT&lt;br/&gt;
destination:/queue/COMMANDREPLY.HOST.alex&lt;br/&gt;
transaction:ID:alex-58262-1244123488785-2:1-1&lt;/p&gt;

&lt;p&gt;^@&lt;br/&gt;
Connection closed by foreign host.&lt;/p&gt;


&lt;p&gt;at this point AMQ closses the TCP connection and I see the following in the log (DEBUG root log level):&lt;/p&gt;

&lt;p&gt;DEBUG TransportConnection            - Setting up new connection: /127.0.0.1:44692&lt;br/&gt;
DEBUG AMQPersistenceAdapter          - dataFilesInProgress.values: (0) []&lt;br/&gt;
DEBUG AMQPersistenceAdapter          - lastDataFile: 1&lt;br/&gt;
DEBUG AsyncDataManager               - lastFileId=0, purgeList: (0) []&lt;br/&gt;
DEBUG AbstractRegion                 - localhost adding consumer: ID:alex-60773-1244124360289-2:2:-1:1 for destination: queue://COMMAND.HOST.alex&lt;br/&gt;
DEBUG AMQPersistenceAdapter          - Checkpoint started.&lt;br/&gt;
DEBUG AMQPersistenceAdapter          - Checkpoint done.&lt;br/&gt;
DEBUG AMQPersistenceAdapter          - Checkpoint started.&lt;br/&gt;
DEBUG AMQPersistenceAdapter          - Checkpoint done.&lt;br/&gt;
DEBUG AMQPersistenceAdapter          - dataFilesInProgress.values: (0) []&lt;br/&gt;
DEBUG AMQPersistenceAdapter          - lastDataFile: 1&lt;br/&gt;
DEBUG AsyncDataManager               - lastFileId=0, purgeList: (0) []&lt;br/&gt;
DEBUG AMQPersistenceAdapter          - Checkpoint started.&lt;br/&gt;
DEBUG AMQPersistenceAdapter          - Checkpoint done.&lt;br/&gt;
DEBUG AMQMessageStore                - Journalled transacted message add for: ID:alex-60773-1244124360289-2:2:-1:1:1, at: offset = 10973, file = 1, size = 375, type = 1&lt;br/&gt;
DEBUG AMQPersistenceAdapter          - dataFilesInProgress.values: (0) []&lt;br/&gt;
DEBUG AMQPersistenceAdapter          - lastDataFile: 1&lt;br/&gt;
DEBUG AsyncDataManager               - lastFileId=0, purgeList: (0) []&lt;br/&gt;
DEBUG AMQPersistenceAdapter          - Checkpoint started.&lt;br/&gt;
DEBUG AMQPersistenceAdapter          - Checkpoint done.&lt;br/&gt;
DEBUG Transport                      - Transport failed: java.io.IOException: Unexpected error occured&lt;br/&gt;
java.io.IOException: Unexpected error occured&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:192)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
Caused by: java.util.NoSuchElementException&lt;br/&gt;
	at java.util.LinkedList.getFirst(LinkedList.java:109)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.StompSubscription.onStompCommit(StompSubscription.java:130)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommit(ProtocolConverter.java:337)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommand(ProtocolConverter.java:179)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.StompTransportFilter.onCommand(StompTransportFilter.java:67)&lt;br/&gt;
	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:203)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:185)&lt;br/&gt;
	... 1 more&lt;br/&gt;
DEBUG TransportConnection            - Stopping connection: /127.0.0.1:44692&lt;br/&gt;
DEBUG TcpTransport                   - Stopping transport tcp:///127.0.0.1:44692&lt;br/&gt;
DEBUG TransportConnection            - Stopped transport: /127.0.0.1:44692&lt;br/&gt;
DEBUG TransportConnection            - Cleaning up connection resources: /127.0.0.1:44692&lt;br/&gt;
DEBUG AbstractRegion                 - localhost removing consumer: ID:alex-60773-1244124360289-2:2:-1:1 for destination: queue://COMMAND.HOST.alex&lt;br/&gt;
DEBUG LocalTransaction               - rollback: TX:ID:alex-60773-1244124360289-2:2:1 syncCount: 3&lt;br/&gt;
DEBUG AMQMessageStore                - Transacted message add rollback for: ID:alex-60773-1244124360289-2:2:-1:1:1, at: offset = 10973, file = 1, size = 375, type = 1&lt;br/&gt;
DEBUG TransportConnection            - Connection Stopped: /127.0.0.1:44692&lt;/p&gt;</description>
                <environment>&lt;p&gt;linux  2.6.26.8, Fedora Core 8&lt;/p&gt;

&lt;p&gt;java version &quot;1.6.0_11&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.6.0_11-b03)&lt;br/&gt;
Java HotSpot(TM) Client VM (build 11.0-b16, mixed mode, sharing)&lt;/p&gt;

&lt;p&gt;apache-activemq-5.3-SNAPSHOT-bin.gz   	 Fri May 29 06:12:47 GMT+00:00 2009  	 34977374  	   &lt;/p&gt;</environment>
        <key id="12483075">AMQ-2280</key>
            <summary>stomp: Transport failed: java.io.IOException: Unexpected error occured</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="aivanise">Aleksandar Ivanisevic</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Jun 2009 14:12:35 +0000</created>
                <updated>Fri, 7 Aug 2009 09:20:28 +0000</updated>
                            <resolved>Fri, 7 Aug 2009 09:20:28 +0000</resolved>
                                    <version>5.3.0</version>
                                    <fixVersion>5.3.0</fixVersion>
                                    <component>Broker</component>
                    <component>Connector</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12941740" author="gseben" created="Tue, 14 Jul 2009 20:33:42 +0000"  >&lt;p&gt;I was reviewing this report and I found the problem that generates this exception. &lt;/p&gt;

&lt;p&gt;In the particular case shown here, when commiting a transaction the broker will attempt to commit messages received by the subscriber created before the transaction. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SUBSCRIBE
activemq.prefetchSize:1
ack:client
destination:/queue/COMMAND.HOST.alex
activemq.exclusive:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Since there are no messages there to be commited it fails when doing a lookup on the message subscription linked list. &lt;/p&gt;

&lt;p&gt;Stomp transactions are based only on the transaction ID. The sample here assumes that the transaction is tied to the destination which is not the case. In this case the destination parameter passed in the BEGIN and COMMIT statements is simply ignored by the stomp transport. They are not part of the protocol specification AFAIK. Since mixing multiple transacted and non-transacted destinations within the same stomp connection will cause problems I added a simple check that will warn the user about this issue.  &lt;/p&gt;</comment>
                            <comment id="12941742" author="aivanise" created="Thu, 16 Jul 2009 17:43:48 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Many thanks for the patch, I&apos;ll try to test as soon as it gets comitted or i find the time to build amq myself, whichever comes first &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Sending destination in BEGIN frame was an error, I have since corrected that.&lt;/p&gt;

&lt;p&gt;However I&apos;m intrigued by your statement that &quot;Mixing multiple transacted and non-transacted destinations within the same stomp connection will cause problems&quot;&lt;/p&gt;

&lt;p&gt;Can you elaborate on this? What is a &quot;transacted destination&quot; if, as you said, transactions are not dependent on the destinations?&lt;/p&gt;

&lt;p&gt;What kind of problems can I expect? Can you point me to some documentation? I thought that, like in SQL, i can BEGIN, send MESSAGEs and then either COMMIT or ABORT and all the messages in between will either be sent or discarded.&lt;/p&gt;

&lt;p&gt;Many thanks for your insights.&lt;/p&gt;</comment>
                            <comment id="12940993" author="gseben" created="Thu, 6 Aug 2009 20:03:02 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;The patch that I&apos;m suggesting is a simple check on the code to try to avoid this situation since in my opinion without a more fine grained definition of transactions with Stomp would be required.&lt;/p&gt;

&lt;p&gt;Let me try to explain this a bit better. &lt;br/&gt;
The particular problem with the snippet of stomp code that you attached to this report is that it first subscribes to destination &quot;/queue/COMMAND.HOST.alex&quot; and then you tries to send transacted messages to &quot;/queue/COMMANDREPLY.HOST.alex&quot;.  Since stomp transactions are bound only by the transactionID the logic in the code needs to check &lt;b&gt;all&lt;/b&gt; destinations used in a connection for messages to commit. In this case the exception happens because there is nothing to be commited at &quot;/queue/COMMAND.HOST.alex&quot;.&lt;/p&gt;

&lt;p&gt;The bottom line is that since BEGIN doesn&apos;t take a destination as a parameter there is no way to identify for which destination you are starting a transaction and that&apos;s the reason why all destinations for the current connection have to be checked for messages to be commited.&lt;/p&gt;

&lt;p&gt;My recommendation is that if you use transactions, don&apos;t use more than one destination per connection. This way you avoid the confusion of which destination the transaction is actually supposed to be for.&lt;/p&gt;

&lt;p&gt;Hope that this clarifies some of your questions.&lt;/p&gt;</comment>
                            <comment id="12941015" author="aivanise" created="Fri, 7 Aug 2009 08:21:59 +0000"  >
&lt;p&gt;Just to confirm that I have split the sending and receiving part of my client into separate connections and that appears to have &quot;fixed&quot; the problem.&lt;/p&gt;

&lt;p&gt;I still don&apos;t see anything both in the STOMP spec and common sense that would be against mixing transacted and non-transacted statements in one connection, so IMO this is a bug in AMQ STOMP, not in my usage (if we don&apos;t count sending a destination in BEGIN frame which is clearly an error).&lt;/p&gt;</comment>
                            <comment id="12940998" author="dejanb" created="Fri, 7 Aug 2009 09:20:28 +0000"  >&lt;p&gt;Fixed in SVN revision 801916, by checking if the subscriber has some messages in the tx, before sending ack. Please check it out by building the current trunk (or trying the next nightly build).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461557" name="AMQ-2280.patch" size="1175" author="gseben" created="Tue, 14 Jul 2009 20:35:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>74998</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 16 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s1dz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161701</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>