<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:50:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3312] Queue&apos;s moveMatchingMessagesTo method is extremely slow to the point of being unusable as Queue size increases</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3312</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Symptom&lt;br/&gt;
=======&lt;br/&gt;
We have a system based on ActiveMQ that stores messages in a non-peristent queue.  Frequently, we have to move a specific message from this queue to another queue.  The message to be moved may be anywhere in the queue, and is identified by a selector on a custom JMS integer property.&lt;/p&gt;

&lt;p&gt;To facilitate the selection and move, we use org.apache.activemq.broker.region.Queue#moveMatchingMessagesTo(ConnectionContext context, String selector, ActiveMQDestination dest)&lt;/p&gt;

&lt;p&gt;We&apos;ve found that once our queue grows past 10K messages, moving a single message takes over 10s.  When the queue grows past 20K messages, a move takes 70s.  It&apos;s clear from testing that the time to move a message grows exponentially as the queue size increases, to the point that moveMatchingMessagesTo becomes unusable.&lt;/p&gt;

&lt;p&gt;Cause&lt;br/&gt;
=====&lt;br/&gt;
AMQ 5.5.0 has this implementation for moveMatchingMessagesTo:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Queue#moveMatchingMessagesTo(ConnectionContext context, MessageReferenceFilter filter&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; moveMatchingMessagesTo(ConnectionContext context, MessageReferenceFilter filter,
            ActiveMQDestination dest, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maximumMessages) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; movedCounter = 0;
        Set&amp;lt;QueueMessageReference&amp;gt; set = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CopyOnWriteArraySet&amp;lt;QueueMessageReference&amp;gt;();
        &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; {
            doPageIn(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            pagedInMessagesLock.readLock().lock();
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;{
                set.addAll(pagedInMessages.values());
            }&lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
                pagedInMessagesLock.readLock().unlock();
            }
            List&amp;lt;QueueMessageReference&amp;gt; list = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;QueueMessageReference&amp;gt;(set);
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (QueueMessageReference ref : list) {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (filter.evaluate(context, ref)) {
                    &lt;span class=&quot;code-comment&quot;&gt;// We should only move messages that can be locked.
&lt;/span&gt;                    moveMessageTo(context, ref, dest);
                    set.remove(ref);
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (++movedCounter &amp;gt;= maximumMessages &amp;amp;&amp;amp; maximumMessages &amp;gt; 0) {
                        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; movedCounter;
                    }
                }
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (set.size() &amp;lt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.destinationStatistics.getMessages().getCount() &amp;amp;&amp;amp; set.size() &amp;lt; maximumMessages);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; movedCounter;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the context that we use, maximumMessages is Integer.MAXINT:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;moveMatchingMessagesTo(ConnectionContext context, String selector, ActiveMQDestination dest)&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; moveMatchingMessagesTo(ConnectionContext context, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; selector, ActiveMQDestination dest)
            &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; moveMatchingMessagesTo(context, selector, dest, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since moveMatchingMessagesTo instantiates the set variable as a CopyOnWriteArraySet, each doPageIn loop creates a new array, copies the existing set members, and then linearly scans the array for the insertion.  The result is that moveMatchingMessagesTo is an O(n^2) algorithm with respect to message copying, where n is the size of the queue.&lt;/p&gt;

&lt;p&gt;Solution&lt;br/&gt;
========&lt;br/&gt;
set is scoped to a single call of moveMatchingMessagesTo, and is only accessed by a single thread, so there is no benefit to using CopyOnWriteArraySet.  Simply changing set to a HashSet prevents the need for the doPageIn loop to copy the set on each iteration, and insertion becomes an O(1) operation.&lt;/p&gt;

&lt;p&gt;Attached is a unit test that demonstrates how moving the last message from a queue of 10K messages takes 8s (on our machine).  Included is a patch Queue that changes set from a CopyOnWriteArraySet to a HashSet; with this patch, the same unit test completes in under 200ms.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12506666">AMQ-3312</key>
            <summary>Queue&apos;s moveMatchingMessagesTo method is extremely slow to the point of being unusable as Queue size increases</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="stirlingc">Stirling Chow</reporter>
                        <labels>
                    </labels>
                <created>Mon, 9 May 2011 23:50:35 +0000</created>
                <updated>Tue, 20 Sep 2011 10:42:11 +0000</updated>
                            <resolved>Fri, 20 May 2011 15:17:13 +0000</resolved>
                                    <version>5.5.0</version>
                                    <fixVersion>5.6.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13030960" author="stirlingc" created="Mon, 9 May 2011 23:52:04 +0000"  >&lt;p&gt;Unit test that can be run against the unpatched AMQ trunk to demonstrate how long moving a message from a queue can take.  The same unit test can be used to verify that the patch improves performance of this operation by a considerable amount.&lt;/p&gt;</comment>
                            <comment id="13030961" author="stirlingc" created="Mon, 9 May 2011 23:54:27 +0000"  >&lt;p&gt;Patch that changes Queue#moveMatchingMessagesTo to use HashSet rather than CopyOnWriteArraySet&lt;/p&gt;</comment>
                            <comment id="13036842" author="tabish121" created="Fri, 20 May 2011 14:11:50 +0000"  >&lt;p&gt;This appears to also affect the methods, copyMatchingMessages and removeMatchingMessages.  In each case the Thread locality of the set object in use is limited to one thread so I don&apos;t see why a CopyOnWriteArraySet is needed for any of these methods.&lt;/p&gt;
</comment>
                            <comment id="13036868" author="tabish121" created="Fri, 20 May 2011 15:17:13 +0000"  >&lt;p&gt;Fixed, patch applied along with fixing the other two methods that had this same issue.  Test updated to cover all three.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12478654" name="AMQ3312.patch" size="795" author="stirlingc" created="Mon, 9 May 2011 23:54:27 +0000"/>
                            <attachment id="12478653" name="LargeQueueSparseDeleteTest.java" size="3258" author="stirlingc" created="Mon, 9 May 2011 23:52:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14572</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 27 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ajfb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59420</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>