<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:28:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6062] Broker goes 100% CPU on multi-queue command line browse</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6062</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Hello,&lt;br/&gt;
The Broker may enter a state of high CPU consumption (100% or 200% if 2 browse enter the infinite loop in the same time on a multi-core) when a command line browse on multiple queues is issued. When that arrives the only way we found to restore the situation was to kill the broker and restart because he was not responding anymore to clients. Killing the clients and the browse process does not lower the CPU usage of the broker.&lt;br/&gt;
I assume the infinite loop based on successive thread dumps that show the browse thread remaines in the same code zone:&lt;/p&gt;

&lt;p&gt;Here is an example of the Browse thread call stack trace, when Broker is in high CPU usage state:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;at java/util/HashMap.rehash(HashMap.java:782(Compiled Code))&lt;br/&gt;
at java/util/HashMap.rehash(HashMap.java:819(Compiled Code))&lt;br/&gt;
at java/util/HashMap.putImpl(HashMap.java:702(Compiled Code))&lt;br/&gt;
at java/util/HashMap.put(HashMap.java:680(Compiled Code))&lt;br/&gt;
at org/apache/activemq/broker/region/&lt;b&gt;QueueBrowserSubscription.isDuplicate(QueueBrowserSubscription.java:72&lt;/b&gt;(Compiled Code))&lt;br/&gt;
at org/apache/activemq/broker/region/&lt;b&gt;Queue.iterate(Queue.java:1688&lt;/b&gt;(Compiled Code))&lt;br/&gt;
at org/apache/activemq/thread/PooledTaskRunner.runTask(PooledTaskRunner.java:133(Compiled Code)).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Tested ActiveMQ versions: 5.9.1 and the last, 5.12.0, but of course I suppose all in beetwen are affected.&lt;/p&gt;

&lt;p&gt;The cause seems to be the non-threadsafe usage of the &lt;b&gt;audit HashMap&lt;/b&gt; member of &lt;b&gt;QueueBrowserSubscription.java&lt;/b&gt; class.&lt;br/&gt;
Here are some facts on non thread-safe HashMap use problems:&lt;br/&gt;
&lt;b&gt;High CPU / Hang on java.util.HashMap.findNonNullKeyEntry() due to non-thread-safe usage of HashMap&lt;/b&gt;&lt;br/&gt;
&lt;a href=&quot;http://www-01.ibm.com/support/docview.wss?uid=swg21597581&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www-01.ibm.com/support/docview.wss?uid=swg21597581&lt;/a&gt;&lt;br/&gt;
&lt;b&gt;IZ73767: INFINITE LOOP CAN OCCUR IN HASHMAP&lt;/b&gt;&lt;br/&gt;
&lt;a href=&quot;http://www-01.ibm.com/support/docview.wss?uid=swg1IZ73767&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www-01.ibm.com/support/docview.wss?uid=swg1IZ73767&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I must underline that &lt;b&gt;this is not an IBM JDK specific problem as the IBM JDK is based on Oracle JDK&lt;/b&gt; and changing the JDK or JRE is not a solution.&lt;/p&gt;

&lt;p&gt;The scenario may be produced with a fresh non modified install (default config) of ActiveMQ broker:&lt;br/&gt;
1. set ACTIVEMQ_HOME, JAVA_HOME and PATH to point accordingly to the right activemq, and Java version.&lt;br/&gt;
2. cd $ACTIVEMQ_HOME/bin; ./activemq start&lt;br/&gt;
3. inject at least 2000 messages in each of two ques, say QA.ONE and QA.TWO&lt;br/&gt;
4. $ $ACTIVEMQ_HOME/bin/activemq browse --view JMSDestination,JMSMessageID --amqurl tcp://localhost:61616 QA.*&lt;/p&gt;

&lt;p&gt;The simplest fix that I suggest is to change in the &lt;b&gt;QueueBrowserSubscription.java&lt;/b&gt; class the type of &lt;b&gt;audit&lt;/b&gt; member to &lt;b&gt;ConcurrentHashMap&lt;/b&gt;.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux Ubuntu, Aix, with both Java 6 and Java 7 (either IBM or Oracle)&lt;/p&gt;</environment>
        <key id="12916122">AMQ-6062</key>
            <summary>Broker goes 100% CPU on multi-queue command line browse</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="doomytroo">Dumitru HUSLEAG</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Nov 2015 11:22:27 +0000</created>
                <updated>Wed, 2 Dec 2015 17:51:35 +0000</updated>
                            <resolved>Wed, 2 Dec 2015 15:59:18 +0000</resolved>
                                    <version>5.9.1</version>
                    <version>5.12.0</version>
                                    <fixVersion>5.12.2</fixVersion>
                    <fixVersion>5.13.1</fixVersion>
                    <fixVersion>5.14.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="86400">24h</timeoriginalestimate>
                            <timeestimate seconds="86400">24h</timeestimate>
                                        <comments>
                            <comment id="15026733" author="doomytroo" created="Wed, 25 Nov 2015 13:11:06 +0000"  >&lt;p&gt;JMeter test plan to produce the bug&lt;/p&gt;</comment>
                            <comment id="15026744" author="doomytroo" created="Wed, 25 Nov 2015 13:19:34 +0000"  >&lt;p&gt;Thread dump analysis screenshot&lt;/p&gt;</comment>
                            <comment id="15027349" author="tabish121" created="Wed, 25 Nov 2015 18:43:13 +0000"  >&lt;p&gt;Have you tried reproducing this with a JMS client in a Unit test, would be a useful validation of any fixes.  &lt;/p&gt;</comment>
                            <comment id="15028380" author="doomytroo" created="Thu, 26 Nov 2015 08:59:41 +0000"  >&lt;p&gt;I already attached a JMeter test plan that injects messages in 2 queues and after that starts calling browse in 2 threads.&lt;br/&gt;
You just have to adapt the paths to your ActiveMQ.&lt;/p&gt;

&lt;p&gt;If you meant a JUnit test, no I have none. I tried first but I found it was complicated to create the QueueBrowseSubscription with all the right parameters, contexts etc. embeded Broker etc. etc.&lt;/p&gt;

&lt;p&gt;With JMeter it was pretty easy to reproduce.&lt;/p&gt;</comment>
                            <comment id="15035801" author="doomytroo" created="Wed, 2 Dec 2015 13:41:34 +0000"  >&lt;p&gt;I attached the JUnit test that produces the bug and a thread dump when it occurs.&lt;br/&gt;
Just put it in /activemq-parent-5.9.1/activemq-unit-tests/src/test/java/org/apache/activemq/console/command/&lt;br/&gt;
and test it.&lt;br/&gt;
It works for me with 5.9.1 tag sources and IBM java6 on Ubuntu 12.04 LTS.&lt;br/&gt;
The test is a bit complicated because I tried to make it fail() and fail fast, do a thread dump and not block or kill the JVM without a JUnit failure.&lt;/p&gt;

&lt;p&gt;I run the test from Eclipse. I just came to realise you might test from command line or other ways (in Jenkins, etc) and I did a test on command line and JUnit does not fail because the kill is faster and maven test is in success in spite of the bug detection.&lt;br/&gt;
Anyway the thread dump is generated to prove the bug.&lt;/p&gt;</comment>
                            <comment id="15035831" author="doomytroo" created="Wed, 2 Dec 2015 14:08:06 +0000"  >&lt;p&gt;The log is captured in /activemq-parent-5.9.1/activemq-unit-tests/target/activemq-test.log&lt;/p&gt;</comment>
                            <comment id="15035833" author="tabish121" created="Wed, 2 Dec 2015 14:08:50 +0000"  >&lt;p&gt;Have you tested it against the code on master, there is no support for 5.9.x releases so if you are looking for a fix there you will be disappointed.  Would be good for you to confirm that you see the same problem when you checkout the master branch code and run your test there.  &lt;/p&gt;</comment>
                            <comment id="15035840" author="doomytroo" created="Wed, 2 Dec 2015 14:11:08 +0000"  >&lt;p&gt;I&apos;ll try and I&apos;ll keep you informed.&lt;/p&gt;</comment>
                            <comment id="15035906" author="doomytroo" created="Wed, 2 Dec 2015 14:56:11 +0000"  >&lt;p&gt;I attached a fixed version of the test that produces the bug on the current master sources with IBM java 7. Also the test log and a thread dump made with Java 7.&lt;br/&gt;
Copy the new test in the same place in activemq-unit-tests and give it a try.&lt;/p&gt;</comment>
                            <comment id="15035917" author="tabish121" created="Wed, 2 Dec 2015 15:00:45 +0000"  >&lt;p&gt;Did you also try it using the Oracle JDK or OpenJDK ?  most of use don&apos;t have a system with IBM JDK installed&lt;/p&gt;</comment>
                            <comment id="15035968" author="doomytroo" created="Wed, 2 Dec 2015 15:31:37 +0000"  >&lt;p&gt;I modified again the test to increase the number of browse tasks and the timeout because on command line it is faster.&lt;br/&gt;
And yes I reproduced the bug wit HotSpot java and I attached the thread dump. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ java -version
java version &lt;span class=&quot;code-quote&quot;&gt;&quot;1.7.0_51&quot;&lt;/span&gt;
Java(TM) SE &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt; Environment (build 1.7.0_51-b13)
Java HotSpot(TM) 64-Bit Server VM (build 24.51-b03, mixed mode)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15036003" author="jira-bot" created="Wed, 2 Dec 2015 15:53:35 +0000"  >&lt;p&gt;Commit d346a765e3064a951c5d55119b80b8432a45bcb6 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=d346a76&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=d346a76&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6062&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6062&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Updated QueueBrowserSubscription to use a ConcurrentMap to avoid a&lt;br/&gt;
potential race condition when multiple queue browsers browse&lt;br/&gt;
multiple queues.&lt;/p&gt;</comment>
                            <comment id="15036006" author="jira-bot" created="Wed, 2 Dec 2015 15:55:29 +0000"  >&lt;p&gt;Commit 819e512138f55d70197949a4fae208a81ea86502 in activemq&apos;s branch refs/heads/activemq-5.13.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=819e512&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=819e512&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6062&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6062&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Updated QueueBrowserSubscription to use a ConcurrentMap to avoid a&lt;br/&gt;
potential race condition when multiple queue browsers browse&lt;br/&gt;
multiple queues.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit d346a765e3064a951c5d55119b80b8432a45bcb6)&lt;/p&gt;</comment>
                            <comment id="15036010" author="jira-bot" created="Wed, 2 Dec 2015 15:56:28 +0000"  >&lt;p&gt;Commit 58359a85d86f1d578fd706c06763ca6b0cec0a2d in activemq&apos;s branch refs/heads/activemq-5.12.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=58359a8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=58359a8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6062&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6062&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Updated QueueBrowserSubscription to use a ConcurrentMap to avoid a&lt;br/&gt;
potential race condition when multiple queue browsers browse&lt;br/&gt;
multiple queues.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit d346a765e3064a951c5d55119b80b8432a45bcb6)&lt;/p&gt;</comment>
                            <comment id="15036017" author="christopher.l.shannon" created="Wed, 2 Dec 2015 15:59:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=doomytroo&quot; class=&quot;user-hover&quot; rel=&quot;doomytroo&quot;&gt;doomytroo&lt;/a&gt;, Thanks for the test case and suggested fix.  I was able to see with the test case and your description that there is indeed a race condition so I went ahead and updated to use a ConcurrentMap to avoid the issue going forward.&lt;/p&gt;</comment>
                            <comment id="15036224" author="doomytroo" created="Wed, 2 Dec 2015 17:40:15 +0000"  >&lt;p&gt;Thank you very much. I tested your fix with HotSpot and IBM and it&apos;s OK.&lt;br/&gt;
In case you want to add the test on Git repo you&apos;ll have to work on it because it is not deterministic depending on timeout and browse task count parameters when the timeout arrives before all browse finish. It needs to be fixed to be fast enough but nut so fast &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; (to produce the bug), and deterministic.&lt;/p&gt;</comment>
                            <comment id="15036248" author="christopher.l.shannon" created="Wed, 2 Dec 2015 17:51:35 +0000"  >&lt;p&gt;Yeah, since the test wasn&apos;t completely reliable I left it out for now.  If I get time I can go back and look at it but there are already a bunch of other queue browser tests that exist which should catch any problems with this commit.  It was a pretty straight forward fix so it should be fine.&lt;/p&gt;

&lt;p&gt;5.12.2 should hopefully be released pretty soon (maybe a week or 2) and it will have the fix.  5.13.1 will also have it and that will go out in probably 1-2 months.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12775318" name="AMQ6062Test.java" size="9071" author="doomytroo" created="Wed, 2 Dec 2015 15:31:37 +0000"/>
                            <attachment id="12774337" name="ActiveMQ_BrowseInfiniteLoopUseCase.jmx" size="14524" author="doomytroo" created="Wed, 25 Nov 2015 13:11:06 +0000"/>
                            <attachment id="12775319" name="HotSpotThreadDump.txt" size="48304" author="doomytroo" created="Wed, 2 Dec 2015 15:31:37 +0000"/>
                            <attachment id="12775321" name="IBMjava7AndAMQMaster.javacore.20151202.161643.18441.0001.txt" size="442745" author="doomytroo" created="Wed, 2 Dec 2015 15:35:44 +0000"/>
                            <attachment id="12774338" name="ThreadStatusAnalysis_2015-11-25_14h13m33s.png" size="270562" author="doomytroo" created="Wed, 25 Nov 2015 13:19:34 +0000"/>
                            <attachment id="12775308" name="activemq-test.log" size="10543" author="doomytroo" created="Wed, 2 Dec 2015 14:56:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311020" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>External issue URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[http://www-01.ibm.com/support/docview.wss?uid=swg1IZ73767]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ox8f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>