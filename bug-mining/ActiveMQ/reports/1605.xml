<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:55:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3988] PooledSession throw Exception at closing</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3988</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Using ActiveMQ library 5.6.0 with Camel 2.10, the PooledSession is throwing IllegalStateException at shutdown application time.&lt;/p&gt;

&lt;p&gt;With the version 5.4.2 of ActiveMQ library there is not such behavior.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2012-08-23 12:08:48,274 [WARN] PooledSession(122): Caught exception trying close() when putting session back into the pool, will invalidate. javax.jms.IllegalStateException: The Session is closed 
javax.jms.IllegalStateException: The Session is closed
	at org.apache.activemq.ActiveMQSession.checkClosed(ActiveMQSession.java:731) ~[activemq-core-5.6.0.jar:5.6.0]
	at org.apache.activemq.ActiveMQSession.setMessageListener(ActiveMQSession.java:813) ~[activemq-core-5.6.0.jar:5.6.0]
	at org.apache.activemq.pool.PooledSession.close(PooledSession.java:99) ~[activemq-pool-5.6.0.jar:5.6.0]
	at org.springframework.jms.support.JmsUtils.closeSession(JmsUtils.java:108) [spring-jms-3.0.7.RELEASE.jar:3.0.7.RELEASE]
	at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.clearResources(DefaultMessageListenerContainer.java:1099) [spring-jms-3.0.7.RELEASE.jar:3.0.7.RELEASE]
	at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.run(DefaultMessageListenerContainer.java:999) [spring-jms-3.0.7.RELEASE.jar:3.0.7.RELEASE]
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886) [na:1.6.0_33]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908) [na:1.6.0_33]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:680) [na:1.6.0_33]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Pool Connection Declaration:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	&amp;lt;bean id=&lt;span class=&quot;code-quote&quot;&gt;&quot;jmsConnectionFactory&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;&lt;/span&gt;&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerURL&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;${amq.url}&quot;&lt;/span&gt; /&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;userName&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;${amq.username}&quot;&lt;/span&gt; /&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;password&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;${amq.password}&quot;&lt;/span&gt; /&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;watchTopicAdvisories&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;${amq.watchTopicAdv}&quot;&lt;/span&gt; /&amp;gt;
	&amp;lt;/bean&amp;gt;

	&amp;lt;bean id=&lt;span class=&quot;code-quote&quot;&gt;&quot;pooledConnectionFactory&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.activemq.pool.PooledConnectionFactory&quot;&lt;/span&gt;&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;maxConnections&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;${amq.maxConnections}&quot;&lt;/span&gt; /&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;maximumActive&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;${amq.maximumActive}&quot;&lt;/span&gt; /&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;connectionFactory&quot;&lt;/span&gt; ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;jmsConnectionFactory&quot;&lt;/span&gt; /&amp;gt;
	&amp;lt;/bean&amp;gt;

	&amp;lt;bean id=&lt;span class=&quot;code-quote&quot;&gt;&quot;jmsConfig&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.camel.component.jms.JmsConfiguration&quot;&lt;/span&gt;&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;connectionFactory&quot;&lt;/span&gt; ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;pooledConnectionFactory&quot;&lt;/span&gt; /&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;transacted&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt; /&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;testConnectionOnStartup&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt; /&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;concurrentConsumers&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;${amq.concurrentConsumers}&quot;&lt;/span&gt; /&amp;gt;
	&amp;lt;/bean&amp;gt;

	&amp;lt;bean id=&lt;span class=&quot;code-quote&quot;&gt;&quot;activemq&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.activemq.camel.component.ActiveMQComponent&quot;&lt;/span&gt;&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;configuration&quot;&lt;/span&gt; ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;jmsConfig&quot;&lt;/span&gt; /&amp;gt;
	&amp;lt;/bean&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Maven Dependencies:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;		&amp;lt;dependency&amp;gt;
			&amp;lt;groupId&amp;gt;org.apache.activemq&amp;lt;/groupId&amp;gt;
			&amp;lt;artifactId&amp;gt;activemq-camel&amp;lt;/artifactId&amp;gt;
			&amp;lt;version&amp;gt;5.6.0&amp;lt;/version&amp;gt;
		&amp;lt;/dependency&amp;gt;
		&amp;lt;dependency&amp;gt;
			&amp;lt;groupId&amp;gt;org.apache.activemq&amp;lt;/groupId&amp;gt;
			&amp;lt;artifactId&amp;gt;activemq-pool&amp;lt;/artifactId&amp;gt;
			&amp;lt;version&amp;gt;5.6.0&amp;lt;/version&amp;gt;
		&amp;lt;/dependency&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment>&lt;p&gt;Mac OSX Snow Leopard, Java 6, ActiveMQ 5.6.0, Camel 2.10, Spring 3.0.7.RELEASE&lt;/p&gt;</environment>
        <key id="12604624">AMQ-3988</key>
            <summary>PooledSession throw Exception at closing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="harley">Jorge Davison</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Aug 2012 15:22:57 +0000</created>
                <updated>Tue, 20 Nov 2012 14:00:59 +0000</updated>
                            <resolved>Thu, 30 Aug 2012 11:16:59 +0000</resolved>
                                    <version>5.6.0</version>
                                    <fixVersion>5.7.0</fixVersion>
                                    <component>Camel</component>
                    <component>JMS client</component>
                    <component>Pool</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13444812" author="davsclaus" created="Thu, 30 Aug 2012 09:11:32 +0000"  >&lt;p&gt;Ah you are shutting down the application. Do you have an embedded AMQ broker, or do you connect to a remote broker?&lt;/p&gt;

&lt;p&gt;Since its Spring that shutdown, then make sure to set the order in the XML files using depends-on attributes. So Spring will shutdown Camel first.&lt;/p&gt;

&lt;p&gt;You should also use the start|stop method on the pook as documented here&lt;br/&gt;
&lt;a href=&quot;http://camel.apache.org/activemq&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.apache.org/activemq&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;bean id=&lt;span class=&quot;code-quote&quot;&gt;&quot;pooledConnectionFactory&quot;&lt;/span&gt; 
   class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.activemq.pool.PooledConnectionFactory&quot;&lt;/span&gt; init-method=&lt;span class=&quot;code-quote&quot;&gt;&quot;start&quot;&lt;/span&gt; destroy-method=&lt;span class=&quot;code-quote&quot;&gt;&quot;stop&quot;&lt;/span&gt;&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But the &quot;depends-on&quot; attribute should be set on these &amp;lt;bean&amp;gt; to depend on &amp;lt;camelContext&amp;gt; so Spring can shutdown Camel before them etc.&lt;/p&gt;



&lt;p&gt;Looking at the source in 5.4.2 vs 5.6.0 then in 5.6.0 there is a try  .. catch now with a log WARN.&lt;br/&gt;
As the logic is clearing the session listener, we could possible enhance AMQ to allow setting the listener to null, even if its already closed. &lt;/p&gt;</comment>
                            <comment id="13444873" author="davsclaus" created="Thu, 30 Aug 2012 11:05:04 +0000"  >&lt;p&gt;Patch in activemq-core, to allow setting the listener to null if the session has been prior closed.&lt;/p&gt;</comment>
                            <comment id="13444877" author="davsclaus" created="Thu, 30 Aug 2012 11:16:59 +0000"  >&lt;p&gt;We now allows setting the listener to null, even if the session has prior been closed. This should allow nicer shutdown of apps.&lt;/p&gt;

&lt;p&gt;However still you should configure those depends-on to help Spring shutdown the app in correct order.&lt;/p&gt;</comment>
                            <comment id="13444881" author="robinsk" created="Thu, 30 Aug 2012 11:20:34 +0000"  >&lt;p&gt;Just wondering, how exactly should depends-on be configured? We&apos;re experiencing the same issue, and I&apos;ve tried setting the depends-on attribute on the camelContext, the ActiveMQComponent, the PooledConnectionFactory, but none of those seem to have any effect.&lt;/p&gt;</comment>
                            <comment id="13444897" author="davsclaus" created="Thu, 30 Aug 2012 12:06:16 +0000"  >&lt;p&gt;Yeah it can be tricky to get spring to shutdown in the order you want.&lt;/p&gt;

&lt;p&gt;There is an example in Apache Camel - camel-example-management that has an embedded AMQ broker, that shutdown in correct order (AFAIR).&lt;br/&gt;
Also it may depend a bit on if embedded AMQ in the same JVM as the client (eg Camel) or use a remote AMQ broker etc.&lt;/p&gt;

&lt;p&gt;@Jorge, fell free to try with 5.7-SNAPSHOT to see if the WARNs is gone now. &lt;/p&gt;</comment>
                            <comment id="13444899" author="robinsk" created="Thu, 30 Aug 2012 12:09:19 +0000"  >&lt;p&gt;In our case we&apos;re using a remote broker in another JVM, so we can&apos;t &quot;depends-on&quot; the broker instance. Hmm.&lt;/p&gt;</comment>
                            <comment id="13444938" author="harley" created="Thu, 30 Aug 2012 13:18:59 +0000"  >&lt;p&gt;This issue happens when Camel is shutting down. My Camel connects to a remote broker and my configuration is shutting down Camel first, then the ActiveMQ. I used start/stop methods for init and destroy but i received the same WARNs. Also i try setting the correct depend-on attributes in Camel and ActiveMQ but there is no change.&lt;/p&gt;

&lt;p&gt;I will try with the 5.7-SNAPSHOT to see if the WARNs is gone now.&lt;/p&gt;

&lt;p&gt;Thank you very much &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12543072" name="AMQ-3988.patch" size="1410" author="davsclaus" created="Thu, 30 Aug 2012 11:05:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>249773</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 12 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ahev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59094</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>