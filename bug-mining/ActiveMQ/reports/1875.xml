<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:59:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4351] Deadlock when unsubscribing durable subscriber</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4351</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;We started using durable subscribers a week ago, and after the 4th durable subscriber unsubscribed (due to 1 hour inactivity), the system deadlocked. If the &quot;Durable Subscriber Cleanup Timer&quot; goes of at the wrong time, your entire server locks up. &lt;/p&gt;

&lt;p&gt;Setup: &lt;br/&gt;
Active MQ 5.7.0 with master/slave using JDBC store &lt;br/&gt;
Approx 3 - 5 concurrent durable subscribers &lt;br/&gt;
Approx 5 messages / sec &lt;/p&gt;

&lt;p&gt;Active MQ checks every 1 minute for subscribers which have been offline for 1 hour. &lt;/p&gt;

&lt;p&gt;Locked threads: &lt;br/&gt;
&quot;ActiveMQ Transport: tcp:///79.125.71.104:48082@8090&quot;: &lt;br/&gt;
        at org.apache.activemq.broker.region.Topic.doMessageSend(Topic.java:446) &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00000000c6228480&amp;gt; (a org.apache.activemq.broker.region.Topic)&lt;br/&gt;
        at org.apache.activemq.broker.region.Topic.send(Topic.java:427) &lt;br/&gt;
        at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:407) &lt;br/&gt;
        at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:503) &lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;&quot;ActiveMQ Transport: tcp:///79.125.71.104:47590@8090&quot;: &lt;br/&gt;
        at org.apache.activemq.broker.region.PrefetchSubscription.add(PrefetchSubscription.java:142) &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00000000c66ba050&amp;gt; (a java.lang.Object)&lt;br/&gt;
        at org.apache.activemq.broker.region.DurableTopicSubscription.add(DurableTopicSubscription.java:243) &lt;br/&gt;
        at org.apache.activemq.broker.region.policy.StrictOrderDispatchPolicy.dispatch(StrictOrderDispatchPolicy.java:58) &lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;&quot;ActiveMQ Durable Subscriber Cleanup Timer&quot;: &lt;br/&gt;
        at org.apache.activemq.broker.region.Topic.deactivate(Topic.java:288) &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00000000c6250670&amp;gt; (a java.util.concurrent.CopyOnWriteArrayList)&lt;br/&gt;
        at org.apache.activemq.broker.region.DurableTopicSubscription.deactivate(DurableTopicSubscription.java:184) &lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000000c66ba060&amp;gt; (a java.lang.Object)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000000c66ba050&amp;gt; (a java.lang.Object)&lt;br/&gt;
        at org.apache.activemq.broker.region.Topic.deleteSubscription(Topic.java:195) &lt;br/&gt;
        at org.apache.activemq.broker.region.TopicRegion.removeSubscription(TopicRegion.java:199) &lt;br/&gt;
        at org.apache.activemq.broker.region.TopicRegion.doCleanup(TopicRegion.java:99) &lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;I have attached a patch which fixes the problem.&lt;br/&gt;
Since there is only one dispatch policy per Topic, synchronisation can happen on the DispatchPolicy instead of on the consumers object which causes the deadlock.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Setup: &lt;br/&gt;
Active MQ 5.7.0 with master/slave using JDBC store &lt;br/&gt;
Approx 3 - 5 concurrent durable subscribers &lt;br/&gt;
Approx 5 messages / sec &lt;/p&gt;</environment>
        <key id="12634386">AMQ-4351</key>
            <summary>Deadlock when unsubscribing durable subscriber</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="tlammens">Tim Lammens</reporter>
                        <labels>
                            <label>patch</label>
                    </labels>
                <created>Wed, 27 Feb 2013 10:07:36 +0000</created>
                <updated>Fri, 26 Apr 2013 22:52:15 +0000</updated>
                            <resolved>Fri, 26 Apr 2013 22:52:15 +0000</resolved>
                                    <version>5.7.0</version>
                    <version>5.8.0</version>
                                    <fixVersion>5.9.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13589535" author="gtully" created="Thu, 28 Feb 2013 13:37:21 +0000"  >&lt;p&gt;@Tim, thanks for the report and patch. Is there any chance you could provide a unit test that can demonstrate so that we can protect the change?&lt;/p&gt;

&lt;p&gt;My suspicion is that the cleanup safety should not come down to sync on the consumers list, but should be handled at a higher level.&lt;/p&gt;</comment>
                            <comment id="13589553" author="frederikcolardyn" created="Thu, 28 Feb 2013 14:13:37 +0000"  >&lt;p&gt;Hi Gary,&lt;/p&gt;

&lt;p&gt;It&apos;s easy to reproduce, and we&apos;ve got a unit test for it (see attach), but it&apos;s not very well suited to include in an automated build system as it produces high load over &#177; 4 minutes in order to trigger the deadlock. It&apos;s reliable though, always deadlocking without the patch.&lt;/p&gt;

&lt;p&gt;Scenario:&lt;br/&gt;
1. 100 durable consumers, of which 97 go inactive after receiving the first message&lt;br/&gt;
2. producer sends messages as fast as possible&lt;br/&gt;
3. after 3 minutes, broker tries to clean up the 97 inactive producers =&amp;gt; always deadlocks. No more messages are being sent to the active produces. kill -3 of the jms broker always shows the same deadlock.&lt;/p&gt;

&lt;p&gt;We took 100 durable consumers in our test in order to provoke the deadlock quickly, but in our production system it occurred with only 4 consumers (of which 1 was cleaned up after 1 hour inactivity).&lt;/p&gt;</comment>
                            <comment id="13590217" author="wangyin" created="Fri, 1 Mar 2013 03:53:38 +0000"  >&lt;p&gt;I&apos;m interesting in the issue.It seems the thread stack does not reveal the deadlock threads and the test is not an unit test as there are many special objects rather than pure AMQ objects.&lt;/p&gt;</comment>
                            <comment id="13599679" author="ceposta" created="Tue, 12 Mar 2013 04:11:27 +0000"  >&lt;p&gt;Looks like Hiram fixed this one w/ r1455290. Can you verify the fix in the next nightly build?&lt;/p&gt;</comment>
                            <comment id="13600030" author="chirino" created="Tue, 12 Mar 2013 13:30:53 +0000"  >&lt;p&gt;I&apos;ve fixed the dead lock and included a leaner vesion of the test case at: &lt;a href=&quot;https://github.com/apache/activemq/commit/846cf7df3fdea5c27030ed77473aba3b5a4699aa&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13643041" author="tabish121" created="Fri, 26 Apr 2013 17:15:13 +0000"  >&lt;p&gt;Changes for this issue have affected the destination stats for Topics depending on whether keep durable subs active is true or not. &lt;/p&gt;</comment>
                            <comment id="13643338" author="tabish121" created="Fri, 26 Apr 2013 22:52:15 +0000"  >&lt;p&gt;Fixed the stats issue on trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12571413" name="ActiveMQUnsubscribeTest.java" size="6132" author="frederikcolardyn" created="Thu, 28 Feb 2013 14:13:37 +0000"/>
                            <attachment id="12571177" name="dispatcher.patch" size="765" author="tlammens" created="Wed, 27 Feb 2013 10:08:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>314879</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 30 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ic4f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>315223</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>