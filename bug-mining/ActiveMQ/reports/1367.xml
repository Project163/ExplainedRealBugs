<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:52:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3454] Contention on a mutex during a stress when using SimpleAuthenticationPlugin</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3454</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>
&lt;p&gt;I am testing ActiveMQ 5.5 with my own stress test. I tried to implement a stress test that use jms ressource in the same fashion that my application would do. &lt;/p&gt;

&lt;p&gt;For that, I used jms template (from Spring) and  a pooled connection factory (as recommended). I run a fixed number of thread that plublish on fixed number of topics. Each thread pick up a topic and enter a loop that will send a message on the choosen topic.&lt;/p&gt;

&lt;p&gt;The issue is reproductible with SimpleAuthenticationPlugin active.  &lt;/p&gt;

&lt;p&gt;Configuration of the test : &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;100 topics&lt;/li&gt;
	&lt;li&gt;more than one thread per topic (actually 1500 producer threads)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Common connection properties :&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;alwaysSessionAsync=false&lt;/li&gt;
	&lt;li&gt;dispatchAsync=false&lt;/li&gt;
	&lt;li&gt;optimizeAcknowledge=true&lt;/li&gt;
	&lt;li&gt;socketBufferSize=131072&amp;amp;trace=true&amp;amp;wireFormat.cacheSize=2048&amp;amp;wireFormat.tcpNoDelayEnabled=true&amp;amp;wireFormat.tightEncodingEnabled=true&amp;amp;keepAlive=true&amp;amp;soTimeout=10000&amp;amp;connectionTimeout=10000\&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Producers : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Message are not persistent&lt;/li&gt;
	&lt;li&gt;There is no transaction&lt;/li&gt;
	&lt;li&gt;Message expiration time is 30s&lt;/li&gt;
	&lt;li&gt;Unsing JMS template singleton with a PooledConnectionFactory&lt;/li&gt;
	&lt;li&gt;3 JVM running&lt;/li&gt;
	&lt;li&gt;connection options alwaysSyncSend=true,copyMessageOnSend=false&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Consumers :&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;just listening to each topic with a SimpleMessageListenerContainer and count messages received&lt;/li&gt;
	&lt;li&gt;3 JVM running&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;In attachment, you will find activemq config file and thread dumps. I can attach the producer/consumers code if you need it but I think you have your own tests.&lt;/p&gt;

&lt;p&gt;This Jira is critical for me because security is mandatory for our use.&lt;/p&gt;

&lt;p&gt;If you need more information, please ask.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12519007">AMQ-3454</key>
            <summary>Contention on a mutex during a stress when using SimpleAuthenticationPlugin</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="williamd">William</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Aug 2011 15:21:38 +0000</created>
                <updated>Wed, 25 Jul 2018 15:40:46 +0000</updated>
                            <resolved>Mon, 28 Nov 2011 14:35:17 +0000</resolved>
                                    <version>5.5.0</version>
                                    <fixVersion>5.6.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13085778" author="williamd" created="Tue, 16 Aug 2011 15:24:20 +0000"  >&lt;p&gt;Broker configuration used for the test&lt;/p&gt;</comment>
                            <comment id="13085884" author="tabish121" created="Tue, 16 Aug 2011 18:20:32 +0000"  >&lt;p&gt;I was actually looking at that code yesterday and noticed that the locking on the destinationsMutex could result in unnecessary waits.  I am attaching a fix that I was testing, if you&apos;d like to try it out just apply it to a trunk checkout and build your own broker.  &lt;/p&gt;</comment>
                            <comment id="13086396" author="williamd" created="Wed, 17 Aug 2011 15:39:13 +0000"  >&lt;p&gt;I want to test with activemq 5.5 base code so I should checkout the 5.5 tag right (activemq/tags/activemq-5.5.0) ?&lt;/p&gt;

&lt;p&gt;Is it easy for you build a activemq-core-5.5.0.jar with your patch so that I will only have to replace the jar in the broker installation ?&lt;/p&gt;</comment>
                            <comment id="13086402" author="tabish121" created="Wed, 17 Aug 2011 15:45:06 +0000"  >&lt;p&gt;Easiest to apply to trunk and can&apos;t make any promises it will apply cleanly to 5.5 code.  The trunk code is quite a bit improved over 5.5 release so it&apos;d be good to test there.  You will need to checkout the code and do a build via maven, which will create the broker distribution archives in the assembly/target folder.  You can extract those files and get access to the built Jars.&lt;/p&gt;</comment>
                            <comment id="13086419" author="williamd" created="Wed, 17 Aug 2011 16:01:25 +0000"  >&lt;p&gt;ok I will try to patch 5.5. &lt;/p&gt;

&lt;p&gt;From what I understood from the patch, you change the synchronize by a ReentrantReadWriteLock. If the patch doesn&apos;t work I will try to modify it by myself.&lt;/p&gt;

&lt;p&gt;Is it possible to ask for a patch on 5.5 if it works ?&lt;/p&gt;</comment>
                            <comment id="13089797" author="tabish121" created="Tue, 23 Aug 2011 21:51:56 +0000"  >&lt;p&gt;Fix applied to trunk, should show up in a SNAPSHOT build soon.  &lt;/p&gt;</comment>
                            <comment id="13090080" author="williamd" created="Wed, 24 Aug 2011 08:18:09 +0000"  >&lt;p&gt;I have made some tests on 5.5.0 (patch it myself) and it works better. &lt;/p&gt;

&lt;p&gt;But there is still a copy of the map when getDesinationMap() is called which can be heavy if you you have hundreds (or thousands) of topics and I think unnecessary since the Map is a ConcurrentHashMap that can handle concurrency if it is used properly.&lt;/p&gt;

&lt;p&gt;Do you plan to release 5.6.0 soon ? I&apos;ll try to make the patch on 5.5 when I have some time.&lt;/p&gt;</comment>
                            <comment id="13157911" author="gtully" created="Sun, 27 Nov 2011 15:08:12 +0000"  >&lt;p&gt;Think the hashmap copy is too much.&lt;/p&gt;</comment>
                            <comment id="13157931" author="dejanb" created="Sun, 27 Nov 2011 16:52:40 +0000"  >&lt;p&gt;Just a note that after a brief look, it seems that only &lt;tt&gt;RegionBroker.getDestinationMap()&lt;/tt&gt; method should be refactored, so we can remove a copy&lt;/p&gt;</comment>
                            <comment id="13158468" author="gtully" created="Mon, 28 Nov 2011 14:35:17 +0000"  >&lt;p&gt;removed the copy from AbstractRegion (Region) .getDestinationMap&lt;/p&gt;

&lt;p&gt;30% improvement on a simple non persistent send test with 10000 destinations.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/viewvc?rev=1207224&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1207224&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13158526" author="williamd" created="Mon, 28 Nov 2011 16:00:08 +0000"  >&lt;p&gt;Hi guys,&lt;/p&gt;

&lt;p&gt;It&apos;s great you made improvement about performance by removing this unnecessary copy and thank your for taking into account my comment.&lt;/p&gt;

&lt;p&gt;Do you plan to make a patch for 5.5.1 ? I&apos;d like to have something proper in order to use it production. This gain of performance can really help me...&lt;/p&gt;

&lt;p&gt;Or perhaps in 5.6.0, will it come out soon ?&lt;/p&gt;

&lt;p&gt;Futhermore, in my understanding of getDestinationMap method, it is used to determine the presence of a destination and BrokerRegion class still makes a copy of queue&apos;s map and topic&apos;s map ? Tell me if I am wrong.... &lt;/p&gt;

&lt;p&gt;So, if I&apos;m right about the hypothesis, can&apos;t you improve the performance again by adding a new method destinationExists(String destinationName) that just makes a containsKey in the hashmap. Thus we can also remove the copy in all the use cases in which you try to find out if a destination exists or not.&lt;/p&gt;

&lt;p&gt;In any case, even a get() in multiple hashmap is better than a copy, specially when the hashmap is big.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="13158721" author="gtully" created="Mon, 28 Nov 2011 20:21:23 +0000"  >&lt;p&gt;I think a copy is now only created when it is needed, so in cases where the map is modified to included more destinations. But please peek at the code and the call stacks or method usage and improve it.&lt;/p&gt;</comment>
                            <comment id="13410224" author="yrey" created="Tue, 10 Jul 2012 10:41:06 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;looks like I faced that same issue with 5.5.0. and after doing basic verifications, I thought that the problem was still on 5.6.0, thus I started fixing 5.5.0 myself.&lt;/p&gt;

&lt;p&gt;I just discovered about that fix in 5.6.0, but I think there is still room for improvement, thus I&apos;d like to expose my ideas about fixing that issue:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I did not work on the mutexes themselves, I&apos;m not sure how much gain we can get by using different type of mutex, I believe not much as the trouble is not really on the mutexes but rather on the time it takes to make a copy of hash maps.&lt;/li&gt;
	&lt;li&gt;I think the problem is rather that getDestinationMap should not be used at all in this case (I actually wonder why would it be ever needed. I did not check who uses it). AuthorizationBroker uses it only to test if a destination already exists.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thus I simply added a method on the base class to do that check directly on the base hash map.&lt;/p&gt;

&lt;p&gt;If you want I can send my patch.&lt;/p&gt;

&lt;p&gt;Best Regards,&lt;br/&gt;
Yves.&lt;/p&gt;</comment>
                            <comment id="13410251" author="gtully" created="Tue, 10 Jul 2012 11:21:44 +0000"  >&lt;p&gt;@Yves, it is now ok to use org.apache.activemq.broker.region.Region#getDestinationMap b/c it does not involve a copy of the hashmap any more. It returns a direct reference to the underlying concurrent hash map.&lt;/p&gt;</comment>
                            <comment id="13410271" author="williamd" created="Tue, 10 Jul 2012 11:48:56 +0000"  >&lt;p&gt;I have integrated those changes (first mutex and then the remove of the copy of the map) in a 5.5.1 and it works a lot better under load. This may not be the best pattern by it makes ActiveMQ usable and more performant.&lt;/p&gt;

&lt;p&gt;I have tested the 2 fix successively and my findings are : &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;chaning mutex by read/write lock remove contentions between thread and improve performance a lot (no more red on theads  in jvisualwm)&lt;/li&gt;
	&lt;li&gt;removing the copy of the map improve memory usage and performance&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Tested with 2000 topics on a single broker with one message every 5 seconds. Without those fixes it wasn&apos;t performant.&lt;/p&gt;</comment>
                            <comment id="13410277" author="yrey" created="Tue, 10 Jul 2012 12:00:44 +0000"  >&lt;p&gt;Hi Gary,&lt;/p&gt;

&lt;p&gt;Yes, I saw your changes and I agree they will significantly reduce the contention on the mutex, but there is still a copy made in RegionBroker#getDestinationMap. That copy is now out of the mutex thus will not trigger contention, but is still much heavier than doing a hash lookup.&lt;br/&gt;
Also, since you are returning a reference of the map, I believe the read lock in getDestinationMap is likely useless. And I wonder that even if it is not the case currently, some code could modify the content of the returned map outside the mutex mechanism that guarantees integrity of the list of destinations.&lt;/p&gt;

&lt;p&gt;Yves.&lt;/p&gt;</comment>
                            <comment id="14022253" author="gtully" created="Mon, 9 Jun 2014 11:38:32 +0000"  >&lt;p&gt;further update in &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/activemq/commit/27b3a7c3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/activemq/commit/27b3a7c3&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13174391">AMQ-7021</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12490559" name="RWLockDestinations.txt" size="16465" author="tabish" created="Tue, 16 Aug 2011 18:20:32 +0000"/>
                            <attachment id="12490543" name="amq-config.zip" size="2452" author="williamd" created="Tue, 16 Aug 2011 15:24:20 +0000"/>
                            <attachment id="12490542" name="amq-dump" size="240360" author="williamd" created="Tue, 16 Aug 2011 15:22:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>60086</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 24 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0agtr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>58999</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>