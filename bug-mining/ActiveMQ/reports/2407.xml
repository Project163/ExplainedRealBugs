<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:07:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5394] Incorrect handling of duplicate update message commands in KahaDB can lead to broker startup errors</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5394</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;When using the new (in 5.10) persistJMSRedelivered option to make sure all duplicates are marked as redelivered (the activemq.xml config file used &amp;lt;policyEntry queue=&quot;&amp;gt;&quot; persistJMSRedelivered=&quot;true&quot;&amp;gt;&amp;lt;/policyEntry&amp;gt;), we occasionally had a broker fail to start up with the following error:&lt;/p&gt;

&lt;p&gt;2014-10-07 17:31:15,117 | ERROR | Looking for key 7 but not found in fileMap: &lt;/p&gt;
{8=db-8.log number = 8 , length = 9132256}
&lt;p&gt; | org.apache.activemq.store.kahadb.disk.journal.Journal | main&lt;/p&gt;

&lt;p&gt;2014-10-07 17:31:15,117 | ERROR | Failed to start Apache ActiveMQ (&lt;span class=&quot;error&quot;&gt;&amp;#91;broker0, null&amp;#93;&lt;/span&gt;, java.io.IOException: Could not locate data file /local/temp/apache-activemq-5.10.0/data/kahadb/db-7.log) | org.apache.activemq.broker.BrokerService | main&lt;/p&gt;


&lt;p&gt;The root cause seems to be when KahaDB processes a &quot;duplicate&quot; update message command or if it processes an update message command after the message has been removed from kahadb.  The code in KahaDB logs a warning when this occurs from the following else statement and then updates the metadata location and then exits the function as shown below:&lt;/p&gt;

&lt;p&gt;...&lt;br/&gt;
} else {&lt;br/&gt;
            LOG.warn(&quot;Non existent message update attempt rejected. Destination: {}://{}, Message id: {}&quot;, command.getDestination().getType(), command.getDestination().getName(), command.getMessageId());&lt;br/&gt;
        }&lt;br/&gt;
metadata.lastUpdate = location;&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;It turns out that the metadata.lastUpdate = location; line should not run if we took the else branch above so the simple fix is to move that line up into the if block so that it will not run after the log warning.  Once we did that, we no longer see the broker startup errors.  Note that this log warning does not always lead to a broker startup error as it is also related to writing at the end of a transaction log file or the checkpoint timer interval so it is not simple to reproduce but we have not see the startup error once the metadata.lastUpdate line was moved to the correct location.&lt;/p&gt;

&lt;p&gt;A patch will be provided to show the change.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12748048">AMQ-5394</key>
            <summary>Incorrect handling of duplicate update message commands in KahaDB can lead to broker startup errors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="jfugitt">Jesse Fugitt</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Oct 2014 14:37:16 +0000</created>
                <updated>Thu, 18 Jun 2015 19:58:07 +0000</updated>
                            <resolved>Fri, 24 Oct 2014 13:43:37 +0000</resolved>
                                    <version>5.10.0</version>
                                    <fixVersion>5.11.0</fixVersion>
                                    <component>Message Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14173992" author="jfugitt" created="Thu, 16 Oct 2014 17:24:13 +0000"  >&lt;p&gt;After further testing, it looks like the metadata.lastUpdate location in KahaDB is being set incorrectly in more places than just the function that handles update message (the add message and remove message functions also appear to have branches where this can happen).  A more complete patch will be needed to catch all the cases where this could occur.&lt;/p&gt;</comment>
                            <comment id="14174048" author="jfugitt" created="Thu, 16 Oct 2014 18:18:38 +0000"  >&lt;p&gt;Updated patch to fix add/update/remove message command in KahaDB that incorrectly sets metadata lastUpdate location in places.&lt;/p&gt;</comment>
                            <comment id="14182773" author="gtully" created="Fri, 24 Oct 2014 13:43:37 +0000"  >&lt;p&gt;patch applied with thanks &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12786968">AMQ-5695</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12675318" name="AMQ5394.patch" size="3591" author="jfugitt" created="Thu, 16 Oct 2014 18:18:38 +0000"/>
                            <attachment id="12674775" name="AMQ5394.patch" size="1090" author="jfugitt" created="Tue, 14 Oct 2014 14:39:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 4 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i215nz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>