<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:50:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3153] An expired message that is consumed and resent with an updated expiration never expires again.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3153</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Symptom&lt;br/&gt;
========&lt;br/&gt;
We have a use case where a producer sends a message to a queue with an expiration.  When the message expires to the DLQ, a consumer on the DLQ receives the message, modifies it, and resends it to the original queue with an updated expiration.&lt;/p&gt;

&lt;p&gt;When the expired message is resent, it is given a new JMS message ID, so is, for all intents and purposes, a new message.  However, althought the resent message has an updated expiration, it never expires to the DLQ.&lt;/p&gt;

&lt;p&gt;Cause&lt;br/&gt;
=====&lt;br/&gt;
When a message expires, an &quot;originalExpiration&quot; property is added to the message by RegionBroker.stampAsExpired:&lt;/p&gt;

&lt;p&gt;    private boolean stampAsExpired(Message message) throws IOException {&lt;br/&gt;
        boolean stamped=false;&lt;br/&gt;
        if (message.getProperty(ORIGINAL_EXPIRATION) == null) &lt;/p&gt;
{
            long expiration=message.getExpiration();     
            message.setProperty(ORIGINAL_EXPIRATION,new Long(expiration));
            stamped = true;
        }
&lt;p&gt;        return stamped;&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;When the consumer receives and resends the expired message, ActiveMQSession gives the message a new ID and updates its expiration:&lt;/p&gt;

&lt;p&gt;    protected void send(ActiveMQMessageProducer producer, ActiveMQDestination destination, Message message, int deliveryMode, int priority, long timeToLive,&lt;br/&gt;
                        MemoryUsage producerWindow, int sendTimeout) throws JMSException {&lt;br/&gt;
..&lt;br/&gt;
            long expiration = 0L;&lt;br/&gt;
            if (!producer.getDisableMessageTimestamp()) {&lt;br/&gt;
                long timeStamp = System.currentTimeMillis();&lt;br/&gt;
                message.setJMSTimestamp(timeStamp);&lt;br/&gt;
                if (timeToLive &amp;gt; 0) &lt;/p&gt;
{
                    expiration = timeToLive + timeStamp;
                }
&lt;p&gt;            }&lt;br/&gt;
            message.setJMSExpiration(expiration);&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;            // Set the message id.&lt;br/&gt;
            if (msg == message) &lt;/p&gt;
{
                msg.setMessageId(new MessageId(producer.getProducerInfo().getProducerId(), sequenceNumber));
            }
&lt;p&gt; else &lt;/p&gt;
{
                msg.setMessageId(new MessageId(producer.getProducerInfo().getProducerId(), sequenceNumber));
                message.setJMSMessageID(msg.getMessageId().toString());
            }
&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;At this point the resent message has a new ID and a new expiration, so it should be allowed to reexpire.  However, the resent message still carries the originalExpiration property, which makes RegionBroker report the message has not expired (even though it may have):&lt;/p&gt;

&lt;p&gt;    @Override&lt;br/&gt;
    public boolean isExpired(MessageReference messageReference) {&lt;br/&gt;
        boolean expired = false;&lt;br/&gt;
        if (messageReference.isExpired()) {&lt;br/&gt;
            try {&lt;br/&gt;
                // prevent duplicate expiry processing&lt;br/&gt;
                Message message = messageReference.getMessage();&lt;br/&gt;
                synchronized (message) &lt;/p&gt;
{
                    expired = stampAsExpired(message);
                }
&lt;p&gt;            } catch (IOException e) &lt;/p&gt;
{
                LOG.warn(&quot;unexpected exception on message expiry determination for: &quot; + messageReference, e);
            }
&lt;p&gt;        }&lt;br/&gt;
        return expired;&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;Since the broker is not reporting the message as expired, the expired message processing in Queue bypasses the message (from Queue.doBrowse()):&lt;/p&gt;

&lt;p&gt;                                if (broker.isExpired(node)) &lt;/p&gt;
{
                                    LOG.debug(&quot;expiring from messages: &quot; + node);
                                    messageExpired(connectionContext, createMessageReference(node.getMessage()));
                                }
&lt;p&gt;                                messages.remove();&lt;/p&gt;

&lt;p&gt;Solution&lt;br/&gt;
=======&lt;br/&gt;
Whenever a message is sent to a broker from a message producer, it should have its originalExpiration property cleared.  I&apos;ve provided a patch in ActiveMQSession to do this, but I&apos;m not familiar enough with the workflow to know if this is the appropriate place &amp;#8212; I&apos;m specifically unhappy with the need to case the javax.jms.Message to an ActiveMQMessage in order to clear the readonly properties.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12496459">AMQ-3153</key>
            <summary>An expired message that is consumed and resent with an updated expiration never expires again.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="stirlingc">Stirling Chow</reporter>
                        <labels>
                    </labels>
                <created>Sun, 23 Jan 2011 21:03:43 +0000</created>
                <updated>Thu, 24 Feb 2011 21:02:06 +0000</updated>
                            <resolved>Thu, 24 Feb 2011 21:02:06 +0000</resolved>
                                    <version>5.4.2</version>
                                    <fixVersion>5.5.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12985414" author="stirlingc" created="Sun, 23 Jan 2011 21:06:34 +0000"  >&lt;p&gt;Patch that clears the originalExpiration property when a message is re-sent and a unit test that fails with AMQ 5.4.2 and passes once the patch is applied.&lt;/p&gt;</comment>
                            <comment id="12985644" author="gtully" created="Mon, 24 Jan 2011 12:15:54 +0000"  >&lt;p&gt;patch looks good and it is great to have a testcase &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;One thought, I wonder if it makes sense to have the originalExpiration property omitted from a message copy. There is by default a copy of a message before sending by a session.&lt;br/&gt;
So I am thinking it may be better to remove that property towards the end of:&lt;br/&gt;
org.apache.activemq.command.Message#copy&lt;/p&gt;

&lt;p&gt;In org.apache.activemq.broker.region.RegionBroker#sendToDeadLetterQueue the message is stamped after a copy and there is no further copy when it is sent to the DQL.&lt;/p&gt;

&lt;p&gt;It may be worth a try.&lt;/p&gt;</comment>
                            <comment id="12999042" author="tabish121" created="Thu, 24 Feb 2011 21:01:39 +0000"  >&lt;p&gt;Agree with Gary on this one, the Message class copy method is a good place to remove the original expiration property as it really only makes sense when message is on the DLQ.  I&apos;ve added the supplied unit test along with that fix, tests passing fine now.&lt;/p&gt;</comment>
                            <comment id="12999043" author="tabish121" created="Thu, 24 Feb 2011 21:02:06 +0000"  >&lt;p&gt;Fix in trunk, test added, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12469103" name="AMQ3513.patch" size="6614" author="stirlingc" created="Sun, 23 Jan 2011 21:06:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14691</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 39 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0agwv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59013</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>