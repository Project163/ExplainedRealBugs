<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:11:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5872] MQTT subscribe fails after unsubscribe</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5872</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;We have a problem subscribing after unsubscribing (same topic). The messages are put in a queue, but not delivered to the client (the queue is created on the server).&lt;/p&gt;

&lt;p&gt;We use .NET M2MQTT as our client library.&lt;/p&gt;

&lt;p&gt;Full scenario:&lt;/p&gt;

&lt;p&gt;1) Connect to server.&lt;br/&gt;
2) Subscribe to topic &quot;TEST&quot;&lt;br/&gt;
3) Publish message &quot;TEST 1&quot; to topic &quot;TEST&quot; =&amp;gt; message is received&lt;br/&gt;
4) Unsubscribe from topic &quot;TEST&quot;&lt;br/&gt;
5) Subscribe to topic &quot;TEST&quot;&lt;br/&gt;
6) Publish message &quot;TEST 2&quot; to topic &quot;TEST&quot; =&amp;gt; message is not received&lt;br/&gt;
7) Subscribe to topic &quot;TEST&quot; =&amp;gt; message &quot;TEST 2&quot; is received&lt;br/&gt;
8) Publish message &quot;TEST 3&quot; to topic &quot;TEST&quot; =&amp;gt; message is received&lt;/p&gt;

&lt;p&gt;On our server, we see the following error:&lt;br/&gt;
2015-07-02 10:57:05,621 | WARN  | Error subscribing to TEST | org.apache.activemq.transport.mqtt.strategy.AbstractMQTTSubscriptionStrategy | ActiveMQ Transport: tcp:///10.2.6.86:56778@8884&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.activemq.store.kahadb.MessageDatabase.addAckLocationForRetroactiveSub(MessageDatabase.java:2220)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-kahadb-store-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.store.kahadb.MessageDatabase.updateIndex(MessageDatabase.java:1472)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-kahadb-store-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.store.kahadb.MessageDatabase$15.execute(MessageDatabase.java:1207)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-kahadb-store-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.store.kahadb.disk.page.Transaction.execute(Transaction.java:779)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-kahadb-store-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.store.kahadb.MessageDatabase.process(MessageDatabase.java:1204)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-kahadb-store-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.store.kahadb.MessageDatabase$10.visit(MessageDatabase.java:1103)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-kahadb-store-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.store.kahadb.data.KahaSubscriptionCommand.visit(KahaSubscriptionCommand.java:187)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-kahadb-store-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.store.kahadb.MessageDatabase.process(MessageDatabase.java:1070)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-kahadb-store-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.store.kahadb.MessageDatabase.store(MessageDatabase.java:977)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-kahadb-store-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.store.kahadb.MessageDatabase.store(MessageDatabase.java:957)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-kahadb-store-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.store.kahadb.KahaDBStore$KahaDBTopicMessageStore.addSubscription(KahaDBStore.java:796)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-kahadb-store-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.store.ProxyTopicMessageStore.addSubscription(ProxyTopicMessageStore.java:98)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-broker-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic.activate(Topic.java:258)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-broker-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.broker.region.DurableTopicSubscription.add(DurableTopicSubscription.java:121)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-broker-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic.addSubscription(Topic.java:160)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-broker-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.broker.region.AbstractRegion.addConsumer(AbstractRegion.java:319)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-broker-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.broker.region.TopicRegion.addConsumer(TopicRegion.java:163)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-broker-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.broker.region.RegionBroker.addConsumer(RegionBroker.java:427)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-broker-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.broker.jmx.ManagedRegionBroker.addConsumer(ManagedRegionBroker.java:244)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-broker-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.addConsumer(BrokerFilter.java:102)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-broker-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.advisory.AdvisoryBroker.addConsumer(AdvisoryBroker.java:104)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-broker-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.addConsumer(BrokerFilter.java:102)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-broker-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.addConsumer(BrokerFilter.java:102)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-broker-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.broker.MutableBrokerFilter.addConsumer(MutableBrokerFilter.java:107)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-broker-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.processAddConsumer(TransportConnection.java:663)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-broker-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.command.ConsumerInfo.visit(ConsumerInfo.java:348)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-client-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:334)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-broker-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:188)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-broker-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:45)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-client-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.transport.mqtt.MQTTInactivityMonitor.onCommand(MQTTInactivityMonitor.java:147)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-mqtt-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.transport.mqtt.MQTTTransportFilter.sendToActiveMQ(MQTTTransportFilter.java:106)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-mqtt-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.transport.mqtt.MQTTProtocolConverter.sendToActiveMQ(MQTTProtocolConverter.java:173)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-mqtt-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.transport.mqtt.strategy.AbstractMQTTSubscriptionStrategy.doSubscribe(AbstractMQTTSubscriptionStrategy.java:200)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-mqtt-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.transport.mqtt.strategy.MQTTDefaultSubscriptionStrategy.onSubscribe(MQTTDefaultSubscriptionStrategy.java:87)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-mqtt-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.transport.mqtt.strategy.AbstractMQTTSubscriptionStrategy.onSubscribe(AbstractMQTTSubscriptionStrategy.java:108)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-mqtt-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.transport.mqtt.MQTTProtocolConverter.onSubscribe(MQTTProtocolConverter.java:352)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-mqtt-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.transport.mqtt.MQTTProtocolConverter.onMQTTCommand(MQTTProtocolConverter.java:204)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-mqtt-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.transport.mqtt.MQTTTransportFilter.onCommand(MQTTTransportFilter.java:94)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-mqtt-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-client-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:214)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-client-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:196)&lt;span class=&quot;error&quot;&gt;&amp;#91;activemq-client-5.11.1.jar:5.11.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.lang.Thread.run(Unknown Source)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.8.0_31&amp;#93;&lt;/span&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows server 2012&lt;/p&gt;</environment>
        <key id="12842266">AMQ-5872</key>
            <summary>MQTT subscribe fails after unsubscribe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="mathia.vandepoel">Mathia Van De Poel</reporter>
                        <labels>
                    </labels>
                <created>Thu, 2 Jul 2015 09:38:18 +0000</created>
                <updated>Thu, 16 Jul 2015 17:43:37 +0000</updated>
                            <resolved>Thu, 2 Jul 2015 21:07:02 +0000</resolved>
                                    <version>5.11.1</version>
                                    <fixVersion>5.12.0</fixVersion>
                                    <component>KahaDB</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14611982" author="tabish121" created="Thu, 2 Jul 2015 13:53:50 +0000"  >&lt;p&gt;Would first suggest trying the latest 5.12-SNAPSHOT and see if your issue is resolved.  If not a test case would be needed that can reproduce this so we can track down what it going on.  &lt;/p&gt;</comment>
                            <comment id="14611995" author="mathia.vandepoel" created="Thu, 2 Jul 2015 14:07:07 +0000"  >&lt;p&gt;Hey, thanks for responding this quickly! We will try the 5.12 snapshot.&lt;/p&gt;

&lt;p&gt;If it does not work, I will try working on a test case, but I am not a java developer, so maybe you can point me in the right direction?&lt;/p&gt;

&lt;p&gt;Cheers!&lt;/p&gt;</comment>
                            <comment id="14611999" author="tabish121" created="Thu, 2 Jul 2015 14:12:16 +0000"  >&lt;p&gt;There are a number of tests in the activemq-mqtt module that you can work from.  &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/activemq/tree/master/activemq-mqtt/src/test/java/org/apache/activemq/transport/mqtt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/tree/master/activemq-mqtt/src/test/java/org/apache/activemq/transport/mqtt&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14612133" author="christopher.l.shannon" created="Thu, 2 Jul 2015 16:04:57 +0000"  >&lt;p&gt;I played around with this a little and I couldn&apos;t reproduce this using the exact same steps as described. So I tried a few things and I was able to get the null pointer after restarting the broker and then switching the topic to a wildcard on the new consumer.  I uploaded my test case as an attachment and if it is run the same exception is printed as described in this ticket.&lt;/p&gt;

&lt;p&gt;A null pointer check can always be added but I&apos;m not sure what the underlying issue is yet that causes this.&lt;/p&gt;</comment>
                            <comment id="14612271" author="tabish121" created="Thu, 2 Jul 2015 17:39:23 +0000"  >&lt;p&gt;Updated test so that it does not use fixed ports, they cause havoc if used in CI.&lt;/p&gt;</comment>
                            <comment id="14612522" author="tabish121" created="Thu, 2 Jul 2015 21:07:02 +0000"  >&lt;p&gt;Updated the code to account for the fact that there may not be a message reference value for the last ack location marker as that is always the next to use value.  &lt;/p&gt;</comment>
                            <comment id="14614887" author="mathia.vandepoel" created="Mon, 6 Jul 2015 11:14:34 +0000"  >&lt;p&gt;Hey, thanks to both of you for figuring out our problem.&lt;/p&gt;

&lt;p&gt;We have succesfully installed v5.12 snapshot on our development environment, and our issue is resolved!&lt;/p&gt;

&lt;p&gt;I will close the issue, but I have one more question: do you have any ETA on the 5.12 final release? Because we don&apos;t want to use a development snapshot in our production environment.&lt;/p&gt;

&lt;p&gt;Kind regards,&lt;br/&gt;
Mathia&lt;/p&gt;</comment>
                            <comment id="14629406" author="mathia.vandepoel" created="Thu, 16 Jul 2015 08:08:26 +0000"  >&lt;p&gt;Snapshot build fixed our problem in DEV, still need to wait for final release for PRD.&lt;/p&gt;</comment>
                            <comment id="14630065" author="christopher.l.shannon" created="Thu, 16 Jul 2015 17:43:37 +0000"  >&lt;p&gt;I don&apos;t have an exact date but I believe the plan is to try and wrap up 5.12 soon.  A good amount of work has already gone into it.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12743355" name="MQTTNullPointerTest.java" size="4203" author="tabish" created="Thu, 2 Jul 2015 17:39:23 +0000"/>
                            <attachment id="12743335" name="MQTTNullPointerTest.java" size="4273" author="cshannon" created="Thu, 2 Jul 2015 16:03:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 18 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2gs7z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>