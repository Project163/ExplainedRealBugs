<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:52:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3588] PooledSession - Can cause memory leak in case many consumers is created by the session</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3588</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;See (&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-4657&quot; title=&quot;camel-jms - Request/Reply - Leak in ActiveMQSessionPool causing it to eat up memory, when using fixed replyTo queue names&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-4657&quot;&gt;&lt;del&gt;CAMEL-4657&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In the activemq-pool we have a memory leak when a PooledSession is used to create many consumers. As each consumer is added to an internal list, which in case the session is closed, the list is used to ensure all previously created consumers gets closed as well.&lt;/p&gt;

&lt;p&gt;However if the session is used to create many consumers, then that internal list just keep growing, and causing OOME. See attached screenshots of a before vs after with the bug fix.&lt;/p&gt;

&lt;p&gt;So to remedy this situation, we should ensure any closed consumer gets removed from that internal list. As its already closed, and therefore the session do not need to keep track of it anymore.&lt;/p&gt;

&lt;p&gt;This bug have existed ever since &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-615&quot; title=&quot;org.apache.activemq.pool sessions should not allow you to create consumers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-615&quot;&gt;&lt;del&gt;AMQ-615&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The impact of this bug can be seen in &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-4657&quot; title=&quot;camel-jms - Request/Reply - Leak in ActiveMQSessionPool causing it to eat up memory, when using fixed replyTo queue names&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-4657&quot;&gt;&lt;del&gt;CAMEL-4657&lt;/del&gt;&lt;/a&gt;, which essentially makes using Camel for request/reply over JMS with AMQ and with named replyTo queues (eg not temporary) will cause this problem. The problem manifests due Spring DMLC, which uses a MessageSelector to only pickup expected reply messages. And because the MessageSelector is created once when the consumer is created. We need to create a new Consumer, every time a new message is doing request/reply, to ensure the Message Selector gets updated. So in that situation many consumers get created, which leads to OOME as the list in PooledSession keeps growing.&lt;/p&gt;

&lt;p&gt;It would be great if this bug fix can be backported to the 5.5 branch as well.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12531028">AMQ-3588</key>
            <summary>PooledSession - Can cause memory leak in case many consumers is created by the session</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="davsclaus">Claus Ibsen</reporter>
                        <labels>
                            <label>activemq-pool</label>
                            <label>camel,</label>
                    </labels>
                <created>Thu, 10 Nov 2011 17:07:50 +0000</created>
                <updated>Wed, 20 Mar 2013 12:01:19 +0000</updated>
                            <resolved>Thu, 10 Nov 2011 20:28:42 +0000</resolved>
                                                    <fixVersion>5.6.0</fixVersion>
                                    <component>Camel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13147824" author="davsclaus" created="Thu, 10 Nov 2011 17:08:46 +0000"  >&lt;p&gt;Before is a test with 50.000 messages showing a memory leak of about 200mb&lt;/p&gt;</comment>
                            <comment id="13147826" author="davsclaus" created="Thu, 10 Nov 2011 17:09:12 +0000"  >&lt;p&gt;After is the same test with 50.000 messages and this time no memory leak&lt;/p&gt;</comment>
                            <comment id="13147828" author="davsclaus" created="Thu, 10 Nov 2011 17:09:34 +0000"  >&lt;p&gt;The patch&lt;/p&gt;</comment>
                            <comment id="13147983" author="tabish121" created="Thu, 10 Nov 2011 20:28:42 +0000"  >&lt;p&gt;Patch looks good, applied in trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                                                <inwardlinks description="Is contained by">
                                        <issuelink>
            <issuekey id="12636844">AMQ-4370</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12530985">CAMEL-4657</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12503256" name="AMQ-3588.patch" size="4921" author="davsclaus" created="Thu, 10 Nov 2011 17:09:34 +0000"/>
                            <attachment id="12503255" name="after.png" size="75318" author="davsclaus" created="Thu, 10 Nov 2011 17:09:12 +0000"/>
                            <attachment id="12503254" name="before.png" size="61697" author="davsclaus" created="Thu, 10 Nov 2011 17:08:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>216766</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 2 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0aikn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59282</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>