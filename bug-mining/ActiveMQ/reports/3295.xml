<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:49:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-7424] NPE under very high database load</title>
                <link>https://issues.apache.org/jira/browse/AMQ-7424</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Under abnormally heavy database loads we get a lot of transactions timeouts in our application as one would expect. Our application uses XA with Postgres and ActiveMQ. The problem is that after the abnormality goes away the system does not recover.&#160;&lt;/p&gt;

&lt;p&gt;During these failures we get an NPE that causes ActiveMQ to lose a database connection and the connection is never returned to the connection pool (Hikari). After the abnormality is removed and the database is responsive again the system never recovers as the connection pool is out-of-resources.&#160;&lt;/p&gt;

&lt;p&gt;Through debugging, we believe the following causes the connection leak in ActiveMQs handing:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: javax.jms.JMSException: java.lang.NullPointerException
 at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:54) ~[activemq-client-5.15.11.jar:5.15.11]
 at org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1403) ~[activemq-client-5.15.11.jar:5.15.11]
 at org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1436) ~[activemq-client-5.15.11.jar:5.15.11]
 at org.apache.activemq.TransactionContext.rollback(TransactionContext.java:538) ~[activemq-client-5.15.11.jar:5.15.11]
 ... 134 more
 Caused by: java.lang.NullPointerException
 at org.apache.activemq.store.jdbc.JDBCPersistenceAdapter.commitRemove(JDBCPersistenceAdapter.java:795) ~[activemq-jdbc-store-5.15.11.jar:5.15.11]
 at org.apache.activemq.store.jdbc.JdbcMemoryTransactionStore.rollback(JdbcMemoryTransactionStore.java:171) ~[activemq-jdbc-store-5.15.11.jar:5.15.11]
 at org.apache.activemq.transaction.XATransaction.rollback(XATransaction.java:146) ~[activemq-broker-5.15.11.jar:5.15.11]
 at org.apache.activemq.broker.TransactionBroker.rollbackTransaction(TransactionBroker.java:257) ~[activemq-broker-5.15.11.jar:5.15.11]
 at org.apache.activemq.broker.BrokerFilter.rollbackTransaction(BrokerFilter.java:149) ~[activemq-broker-5.15.11.jar:5.15.11]
 at org.apache.activemq.broker.BrokerFilter.rollbackTransaction(BrokerFilter.java:149) ~[activemq-broker-5.15.11.jar:5.15.11]
 at org.apache.activemq.broker.TransportConnection.processRollbackTransaction(TransportConnection.java:553) ~[activemq-broker-5.15.11.jar:5.15.11]
 at org.apache.activemq.command.TransactionInfo.visit(TransactionInfo.java:104) ~[activemq-client-5.15.11.jar:5.15.11]
 at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:336) ~[activemq-broker-5.15.11.jar:5.15.11]
 at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:200) ~[activemq-broker-5.15.11.jar:5.15.11]
 at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50) ~[activemq-client-5.15.11.jar:5.15.11]
 at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:125) ~[activemq-client-5.15.11.jar:5.15.11]
 at org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:301) ~[activemq-client-5.15.11.jar:5.15.11]
 at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83) ~[activemq-client-5.15.11.jar:5.15.11]
 at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:233) ~[activemq-client-5.15.11.jar:5.15.11]
 at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:215) ~[activemq-client-5.15.11.jar:5.15.11]
 ... 1 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;By overloading the method &lt;tt&gt;commitRemoved(...)&lt;/tt&gt; in &lt;tt&gt;JDBCPersistenceAdapter&lt;/tt&gt; and converting the &lt;tt&gt;NullPointerException&lt;/tt&gt; above to an &lt;tt&gt;IOException&lt;/tt&gt;, the connection handling code behaves as expected. We see no connection leak, and the system recovers correctly after the load abnormality has passed.&lt;/p&gt;

&lt;p&gt;There is a very large number of things going wrong when these NPEs occur and its near impossible for us (not being experts at ActiveMQ) to see what the underlying cause for these exceptions are. However, for us, the most important is that we recover.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13288123">AMQ-7424</key>
            <summary>NPE under very high database load</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbonofre">Jean-Baptiste Onofr&#233;</assignee>
                                    <reporter username="terjestrand">Terje Strand</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Feb 2020 18:39:37 +0000</created>
                <updated>Mon, 2 Dec 2024 19:21:01 +0000</updated>
                            <resolved>Sat, 29 Feb 2020 06:15:17 +0000</resolved>
                                    <version>5.15.11</version>
                                    <fixVersion>5.16.0</fixVersion>
                    <fixVersion>5.15.12</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17046918" author="jbonofre" created="Thu, 27 Feb 2020 19:16:08 +0000"  >&lt;p&gt;Do you have lot of pending messages under load ?&lt;/p&gt;</comment>
                            <comment id="17046919" author="jbonofre" created="Thu, 27 Feb 2020 19:18:12 +0000"  >&lt;p&gt;It could be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7368&quot; title=&quot;Performance issue on PostgreSQL when we have lot of pending messages&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7368&quot;&gt;&lt;del&gt;AMQ-7368&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17046934" author="terjestrand" created="Thu, 27 Feb 2020 19:39:01 +0000"  >&lt;p&gt;Never more than approx 250 total across all queues, though the main active queue (3-20 msgs per sec) there is typically 0-10 pending messages. I do not quite see how the NPE is related to the mentioned bug above&lt;/p&gt;</comment>
                            <comment id="17046951" author="jbonofre" created="Thu, 27 Feb 2020 20:05:29 +0000"  >&lt;p&gt;You are right, it&apos;s not the same. However, I&apos;ve never seen this issue on my productions. Anyway, let me do a fix to avoid this NPE.&lt;/p&gt;</comment>
                            <comment id="17048209" author="jira-bot" created="Sat, 29 Feb 2020 06:10:05 +0000"  >&lt;p&gt;Commit d8ae8734a9f6da41e206d33322048aedf5491e8e in activemq&apos;s branch refs/heads/master from jbonofre&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=d8ae873&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=d8ae873&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7424&quot; title=&quot;NPE under very high database load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7424&quot;&gt;&lt;del&gt;AMQ-7424&lt;/del&gt;&lt;/a&gt; Prevent NPE during commitRemove() on JDBC adapter&lt;/p&gt;</comment>
                            <comment id="17048210" author="jira-bot" created="Sat, 29 Feb 2020 06:10:07 +0000"  >&lt;p&gt;Commit 80d06fc186ab1b73cced2b949462a120aadcfbf7 in activemq&apos;s branch refs/heads/master from Jean-Baptiste Onofr&#233;&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=80d06fc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=80d06fc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #481 from jbonofre/&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7424&quot; title=&quot;NPE under very high database load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7424&quot;&gt;&lt;del&gt;AMQ-7424&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7424&quot; title=&quot;NPE under very high database load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7424&quot;&gt;&lt;del&gt;AMQ-7424&lt;/del&gt;&lt;/a&gt; Prevent NPE during commitRemove() on JDBC adapter&lt;/p&gt;</comment>
                            <comment id="17048211" author="jira-bot" created="Sat, 29 Feb 2020 06:10:09 +0000"  >&lt;p&gt;Commit 80d06fc186ab1b73cced2b949462a120aadcfbf7 in activemq&apos;s branch refs/heads/master from Jean-Baptiste Onofr&#233;&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=80d06fc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=80d06fc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #481 from jbonofre/&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7424&quot; title=&quot;NPE under very high database load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7424&quot;&gt;&lt;del&gt;AMQ-7424&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7424&quot; title=&quot;NPE under very high database load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7424&quot;&gt;&lt;del&gt;AMQ-7424&lt;/del&gt;&lt;/a&gt; Prevent NPE during commitRemove() on JDBC adapter&lt;/p&gt;</comment>
                            <comment id="17048213" author="jira-bot" created="Sat, 29 Feb 2020 06:15:04 +0000"  >&lt;p&gt;Commit 1daf347f90286c880c160ec136e07d133b424503 in activemq&apos;s branch refs/heads/activemq-5.15.x from jbonofre&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=1daf347&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=1daf347&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7424&quot; title=&quot;NPE under very high database load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7424&quot;&gt;&lt;del&gt;AMQ-7424&lt;/del&gt;&lt;/a&gt; Prevent NPE during commitRemove() on JDBC adapter&lt;/p&gt;

&lt;p&gt;(cherry picked from commit d8ae8734a9f6da41e206d33322048aedf5491e8e)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 37 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0bz1s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>