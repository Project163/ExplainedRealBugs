<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:44:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2561] Subscriber receives messages that sent by itself even if noLocal is true.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2561</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;1, use org.springframework.jms.connection.SingleConnectionFactory to wrap org.apache.activemq.spring.ActiveMQConnectionFactory so that we only use single connection.&lt;br/&gt;
2, use org.springframework.jms.core.JmsTemplate to send a simple text message.&lt;br/&gt;
3, use org.springframework.jms.listener.DefaultMessageListenerContainer to receive message,&lt;br/&gt;
	&amp;lt;bean id=&quot;defaultMessageListenerContainer&quot; class=&quot;org.springframework.jms.listener.DefaultMessageListenerContainer&quot;&amp;gt;&lt;br/&gt;
		&amp;lt;property name=&quot;connectionFactory&quot; ref=&quot;connectionFactory&quot;/&amp;gt;&lt;br/&gt;
		&amp;lt;property name=&quot;sessionTransacted&quot; value=&quot;true&quot;/&amp;gt;&lt;br/&gt;
		&amp;lt;property name=&quot;pubSubDomain&quot; value=&quot;true&quot;/&amp;gt;&lt;br/&gt;
		&amp;lt;property name=&quot;pubSubNoLocal&quot; value=&quot;true&quot;/&amp;gt;&lt;br/&gt;
		&amp;lt;property name=&quot;destination&quot; ref=&quot;topicDestination&quot;/&amp;gt;&lt;br/&gt;
		&amp;lt;property name=&quot;subscriptionDurable&quot; value=&quot;true&quot;/&amp;gt;&lt;br/&gt;
		&amp;lt;property name=&quot;durableSubscriptionName&quot; value=&quot;bus.topic&quot;/&amp;gt;&lt;br/&gt;
		&amp;lt;property name=&quot;messageListener&quot;&amp;gt;&lt;br/&gt;
			&amp;lt;bean class=&quot;com.sinosoft.activemq.listener.DefaultMessageListener&quot;/&amp;gt;&lt;br/&gt;
		&amp;lt;/property&amp;gt;&lt;/p&gt;

&lt;p&gt;	&amp;lt;/bean&amp;gt;&lt;br/&gt;
4, messageListener receive messages sent by itself.&lt;/p&gt;

&lt;p&gt;Also,to reproduce:&lt;/p&gt;

&lt;p&gt;package test;&lt;/p&gt;

&lt;p&gt;import javax.jms.Connection;&lt;br/&gt;
import javax.jms.ConnectionFactory;&lt;br/&gt;
import javax.jms.Message;&lt;br/&gt;
import javax.jms.MessageListener;&lt;br/&gt;
import javax.jms.MessageProducer;&lt;br/&gt;
import javax.jms.Session;&lt;br/&gt;
import javax.jms.TextMessage;&lt;br/&gt;
import javax.jms.Topic;&lt;br/&gt;
import javax.jms.TopicSubscriber;&lt;/p&gt;

&lt;p&gt;import org.apache.activemq.ActiveMQConnectionFactory;&lt;br/&gt;
import org.apache.activemq.command.ActiveMQTopic;&lt;/p&gt;

&lt;p&gt;public final class Producer implements MessageListener{&lt;/p&gt;

&lt;p&gt;    private Producer() {&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;    public static void main(String[] args) {&lt;br/&gt;
        String url = &quot;failover:(tcp://172.31.0.82:61610)&quot;;&lt;br/&gt;
        ConnectionFactory connectionFactory = new ActiveMQConnectionFactory(url);&lt;br/&gt;
        Topic destination = new ActiveMQTopic(&quot;bus.topic&quot;);&lt;/p&gt;

&lt;p&gt;        Connection connection = null;&lt;br/&gt;
        try&lt;/p&gt;
{
	        connection = connectionFactory.createConnection();
	        connection.setClientID(&quot;112234&quot;);
	        
	        Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);
	        
	        TopicSubscriber subscriber = session.createDurableSubscriber(destination, &quot;topicUser2&quot;, null, true);
	        System.out.println(subscriber + &quot; getNoLocal()= &quot; + subscriber.getNoLocal());
	        Producer listener = new Producer();
	        subscriber.setMessageListener(listener);
	        
	        connection.start();
	        
	        MessageProducer producer = session.createProducer(destination);
	        TextMessage message = session.createTextMessage(&quot;THIS IS A TEST&quot;);
	        producer.send(message);
	        producer.close();
	        System.out.println(&quot;Send a message &quot; + message);
        }
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
        	e.printStackTrace();
        }
&lt;p&gt;    }&lt;/p&gt;

&lt;p&gt;	public void onMessage(Message msg)&lt;/p&gt;
{
		System.out.println(&quot;Receive a message &quot; + msg);
	}
&lt;p&gt;}&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12483642">AMQ-2561</key>
            <summary>Subscriber receives messages that sent by itself even if noLocal is true.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="4">Incomplete</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="wangyin">SuoNayi</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Jan 2010 05:59:16 +0000</created>
                <updated>Mon, 2 Sep 2013 03:56:57 +0000</updated>
                            <resolved>Tue, 12 Jul 2011 21:42:24 +0000</resolved>
                                    <version>5.2.0</version>
                                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12942008" author="rajdavies" created="Thu, 14 Jan 2010 14:06:01 +0000"  >&lt;p&gt;Added test case - org.apache.activemq.bugs.JMSDurableTopicNoLocalTest - SVN revision 899205&lt;br/&gt;
Cannot reproduce on trunk&lt;/p&gt;</comment>
                            <comment id="12942015" author="wangyin" created="Sat, 16 Jan 2010 11:07:17 +0000"  >&lt;p&gt;Thanks Davies!&lt;br/&gt;
To reproduce, I deploy a completely new AMQ 5.2.0 application on server  and drop all tables created by AMQ automatically.&lt;br/&gt;
then I start AMQ  and run the test case Producer.java.&lt;br/&gt;
It works fine. Subscriber does not receive message sent by the same connection.&lt;br/&gt;
The information displayed in the console:&lt;br/&gt;
----------------------------------------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;
Send a message ActiveMQTextMessage &lt;/p&gt;
{commandId = 0, responseRequired = false, messageId = ID:suonayi-826da47-5000-1263649149250-0:0:1:1:1, originalDestination = null, originalTransactionId = null, producerId = null, destination = topic://topicA, transactionId = null, expiration = 0, timestamp = 1263649150000, arrival = 0, brokerInTime = 0, brokerOutTime = 0, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 0, properties = null, readOnlyProperties = false, readOnlyBody = false, droppable = false, text = THIS IS A TEST}
&lt;p&gt;-----------------------------------------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;
I restart Producer.java again. Subscriber does receive message sent by itself this time.&lt;br/&gt;
The information displayed in the console:&lt;br/&gt;
-----------------------------------------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;
Send a message ActiveMQTextMessage &lt;/p&gt;
{commandId = 0, responseRequired = false, messageId = ID:suonayi-826da47-1046-1263649222250-0:0:1:1:1, originalDestination = null, originalTransactionId = null, producerId = null, destination = topic://topicA, transactionId = null, expiration = 0, timestamp = 1263649223250, arrival = 0, brokerInTime = 0, brokerOutTime = 0, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 0, properties = null, readOnlyProperties = false, readOnlyBody = false, droppable = false, text = THIS IS A TEST}

&lt;p&gt;Receive a message ActiveMQTextMessage &lt;/p&gt;
{commandId = 6, responseRequired = true, messageId = ID:suonayi-826da47-1046-1263649222250-0:0:1:1:1, originalDestination = null, originalTransactionId = null, producerId = ID:suonayi-826da47-1046-1263649222250-0:0:1:1, destination = topic://topicA, transactionId = null, expiration = 0, timestamp = 1263649223250, arrival = 0, brokerInTime = 1263649053526, brokerOutTime = 1263649053531, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 0, properties = null, readOnlyProperties = true, readOnlyBody = true, droppable = false, text = THIS IS A TEST}
&lt;p&gt;-----------------------------------------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;
Please notice that messageId  is same with the message sent to broker and received by messagelistener.&lt;/p&gt;</comment>
                            <comment id="12942044" author="wangyin" created="Wed, 20 Jan 2010 05:23:27 +0000"  >&lt;p&gt;I hava figured out what is incorrect in AMQ Broker.&lt;br/&gt;
When a new subscriber comes Broker will create a new one and initialize it&apos;s selector.&lt;br/&gt;
But when an existing subscriber comes Broker will just active it and do not initialize it&apos;s selector again.&lt;br/&gt;
So the bug occurs.&lt;br/&gt;
I hava fixed it but I&apos;m not able to commit it to trunk.&lt;br/&gt;
&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12942057" author="rajdavies" created="Fri, 22 Jan 2010 06:56:48 +0000"  >&lt;p&gt;You can always provide a patch &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13064159" author="tabish121" created="Tue, 12 Jul 2011 21:42:24 +0000"  >&lt;p&gt;No test case given to reproduce the problem.&lt;/p&gt;</comment>
                            <comment id="13755892" author="fangyong" created="Mon, 2 Sep 2013 03:56:57 +0000"  >&lt;p&gt;@SuoNayi,I hava change TopicRegion.hasDurableSubChanged to this:&lt;br/&gt;
private boolean hasDurableSubChanged(ConsumerInfo info1, ConsumerInfo info2) {&lt;br/&gt;
	if (info1.getSelector() != null ^ info2.getSelector() != null) &lt;/p&gt;
{
		return true;
	}&lt;br/&gt;
	if (info1.getSelector() != null &amp;amp;&amp;amp; !info1.getSelector().equals(info2.getSelector())) {		return true;	}
&lt;p&gt;	// if noLocal is true ,create this consumer again.&lt;br/&gt;
	if(info1.isNoLocal()||info2.isNoLocal())&lt;/p&gt;
{
		return true;
	}
&lt;p&gt;	return !info1.getDestination().equals(info2.getDestination());&lt;br/&gt;
}&lt;br/&gt;
=======================================================================&lt;br/&gt;
In this case,the noLocal is right,but if you restart the broker,the Durable Subscription can not receive the message send before it&apos;s create again.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461589" name="Producer.java" size="1827" author="wangyin" created="Mon, 11 Jan 2010 14:16:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>43793</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 12 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0tuk7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>172260</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310080" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Regression</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10091"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>