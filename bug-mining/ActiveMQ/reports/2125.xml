<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:02:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4887] ActiveMQBytesMessage will lost content if message&apos;s property was set before copy </title>
                <link>https://issues.apache.org/jira/browse/AMQ-4887</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;ActiveMQBytesMessage will lost content if message&apos;s property was set before copy. Here is the test code:&lt;/p&gt;

&lt;p&gt;Producer:&lt;br/&gt;
MessageProducer producer;  &lt;br/&gt;
//initialize Connection, Session, MessageProducer    &lt;br/&gt;
byte[] bs = &quot;bytes message&quot;.getBytes();  &lt;br/&gt;
BytesMessage message = session.createBytesMessage();  &lt;br/&gt;
message.writeBytes(bs);  //write bytes to message 1&lt;/p&gt;

&lt;p&gt;for(int i=0; i&amp;lt; 0; i++){  &lt;br/&gt;
  // then set message&apos;s propery   2&lt;br/&gt;
    message.setLongProperty(&quot;sendTime&quot;, System.currentTimeMillis());  &lt;br/&gt;
    try&lt;/p&gt;
{  
        producer.send(message);  
    }
&lt;p&gt;catch()&lt;/p&gt;
{  
         e.printStackTrace();  
    }
&lt;p&gt;}  &lt;/p&gt;

&lt;p&gt;Consumer:&lt;/p&gt;

&lt;p&gt;MessageConsumer consumer  &lt;br/&gt;
//initailize Connection, Session, MessageConsumer  &lt;br/&gt;
for(int i=0; i&amp;lt;10; i++){  &lt;br/&gt;
    ActiveMQBytesMessage msg = (ActiveMQBytesMessage)consumer.receive(60*1000);  &lt;br/&gt;
    long sendTime = message.getLongProperty(&quot;sendTime&quot;);  &lt;br/&gt;
    System.out.println(&quot;sendtime:&quot; + sendTime);  &lt;br/&gt;
    ByteSequence bs = message.getMessage().getContent();  &lt;br/&gt;
    System.out.println(&quot;bytes data:&quot; + new String(bs.getData()));  &lt;br/&gt;
}  &lt;/p&gt;

&lt;p&gt;Expected result:&lt;br/&gt;
consumer gets bytes data in all received messages&lt;/p&gt;

&lt;p&gt;Actual result:&lt;br/&gt;
only the fisrt message has bytes data, all other messages lost bytes data, while long property value is not lost;&lt;/p&gt;

&lt;p&gt;Analysization:&lt;br/&gt;
message gets copied when send, it will call storeContent() before copy,  DataOutputStream dataOut will be closed and the data in dataOut will be set to conent. This works correctly if there are no property was set.&lt;/p&gt;

&lt;p&gt;when setLongProperty was called, it will call setObjectProperty() then will call  initializeWriting(), here DataOutputStream dataOut  will be create AGAIN. &lt;/p&gt;

&lt;p&gt;So when message was copied in second time, DataOutputStream dataOut is NOT null, but EMPTY, it will clear the value in content.&lt;/p&gt;

&lt;p&gt;suggestion:&lt;br/&gt;
restore the content data to DataOutputStream dataOut when nitializeWriting()&lt;/p&gt;

&lt;p&gt;my fix:&lt;br/&gt;
ActiveMQBytesMessage :&lt;br/&gt;
 private void  initializeWriting() throws JMSException {&lt;br/&gt;
669        The original code&lt;br/&gt;
                ......&lt;br/&gt;
701        &lt;br/&gt;
            //fix code&lt;br/&gt;
            if(this.content !=null &amp;amp;&amp;amp; this.content.length &amp;gt;0){&lt;br/&gt;
                try&lt;/p&gt;
{
                    this.dataOut.write(this.content.getData());
                }
&lt;p&gt;catch(IOException ioe)&lt;/p&gt;
{
                    throw JMSExceptionSupport.create(ioe);
                }
&lt;p&gt;            }&lt;br/&gt;
702    }&lt;/p&gt;</description>
                <environment></environment>
        <key id="12679335">AMQ-4887</key>
            <summary>ActiveMQBytesMessage will lost content if message&apos;s property was set before copy </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="caoyunfei">caoyunfei</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Nov 2013 04:02:33 +0000</created>
                <updated>Tue, 26 Jan 2016 09:29:01 +0000</updated>
                            <resolved>Fri, 13 Dec 2013 15:55:48 +0000</resolved>
                                    <version>5.9.0</version>
                                    <fixVersion>5.9.1</fixVersion>
                    <fixVersion>5.10.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="86400">24h</timeoriginalestimate>
                            <timeestimate seconds="86400">24h</timeestimate>
                                        <comments>
                            <comment id="13831544" author="tabish121" created="Mon, 25 Nov 2013 15:25:16 +0000"  >&lt;p&gt;Recommend you create a proper JUnit test case and a patch with your fix for use to review.  &lt;/p&gt;</comment>
                            <comment id="13837232" author="caoyunfei" created="Tue, 3 Dec 2013 01:57:15 +0000"  >&lt;p&gt;patch for bug &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4887&quot; title=&quot;ActiveMQBytesMessage will lost content if message&amp;#39;s property was set before copy &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4887&quot;&gt;&lt;del&gt;AMQ-4887&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13837241" author="tabish121" created="Tue, 3 Dec 2013 02:08:26 +0000"  >&lt;p&gt;Still needs a unit test.&lt;/p&gt;</comment>
                            <comment id="13837429" author="caoyunfei" created="Tue, 3 Dec 2013 07:52:37 +0000"  >&lt;p&gt;unit test for bug &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4887&quot; title=&quot;ActiveMQBytesMessage will lost content if message&amp;#39;s property was set before copy &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4887&quot;&gt;&lt;del&gt;AMQ-4887&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13839956" author="kearls" created="Thu, 5 Dec 2013 09:02:06 +0000"  >&lt;p&gt;This is a slightly modified version of the original patch.  Tim, can you review this?&lt;/p&gt;

&lt;p&gt;I have also added a test, AMQ4887Test.java to activemq-unit-tests&lt;/p&gt;</comment>
                            <comment id="13840030" author="tabish121" created="Thu, 5 Dec 2013 11:32:55 +0000"  >&lt;p&gt;I&apos;ll review in a bit&lt;/p&gt;</comment>
                            <comment id="13840214" author="tabish121" created="Thu, 5 Dec 2013 16:13:37 +0000"  >&lt;p&gt;The fix seems reasonable but I think there&apos;s still a problem here if the content is stored compressed.  If you simply rewrite the contents into the output stream and message compression is enabled you&apos;d be writing compressed data with an output stream that&apos;s doing compression again so that&apos;s not good, plus you be adding new data onto already compressed content if you use any of the write methods so you are doubly corrupted.  &lt;/p&gt;</comment>
                            <comment id="13840219" author="tabish121" created="Thu, 5 Dec 2013 16:19:02 +0000"  >&lt;p&gt;I&apos;m also going to guess that the StreamMessage implementation suffers from the same problem and the test should be expanded to check that message too, as well as the compressed case.  &lt;/p&gt;</comment>
                            <comment id="13840559" author="tabish121" created="Thu, 5 Dec 2013 21:00:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kearls&quot; class=&quot;user-hover&quot; rel=&quot;kearls&quot;&gt;kearls&lt;/a&gt; Updated the test case to show the other bits that are broken.  I patched the bytes message and started Stream Message.  Thought you might want to take a crack at addressing the compressed case in StreamMessage and seeing if there&apos;s anything else needed.&lt;/p&gt;</comment>
                            <comment id="13840560" author="tabish121" created="Thu, 5 Dec 2013 21:00:57 +0000"  >&lt;p&gt;Updated patch that fixes bytes message and the uncompressed case in stream message.&lt;/p&gt;</comment>
                            <comment id="13847595" author="tabish121" created="Fri, 13 Dec 2013 15:55:48 +0000"  >&lt;p&gt;Wrapped this one up as I was afraid I might be seeing this in some AMQP dispatch scenarios.  &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12933814">AMQ-6142</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12617239" name="AMQ-4887.patch" size="10386" author="tabish" created="Thu, 5 Dec 2013 21:00:57 +0000"/>
                            <attachment id="12617133" name="AMQ-4887.patch" size="1056" author="kearls" created="Thu, 5 Dec 2013 09:02:06 +0000"/>
                            <attachment id="12616672" name="ActiveMQBytesMessage.java.patch" size="669" author="caoyunfei" created="Tue, 3 Dec 2013 01:57:15 +0000"/>
                            <attachment id="12616713" name="ActiveMQBytesMessageTest.java" size="368" author="caoyunfei" created="Tue, 3 Dec 2013 07:52:37 +0000"/>
                            <attachment id="12616714" name="Consumer.java" size="1837" author="caoyunfei" created="Tue, 3 Dec 2013 07:52:37 +0000"/>
                            <attachment id="12616712" name="Producer.java" size="2071" author="caoyunfei" created="Tue, 3 Dec 2013 07:52:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>358697</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 49 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1pu1r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>358987</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>