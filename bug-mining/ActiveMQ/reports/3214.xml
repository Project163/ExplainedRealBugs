<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:45:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-7009] ActiveMQ stop delivering messages</title>
                <link>https://issues.apache.org/jira/browse/AMQ-7009</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;We have a problem with ActiveMQ 5.15.4, it stop deliver messages to clients.&lt;/p&gt;

&lt;p&gt;This happens completely randomly and we are not able to give a test case that reproduce the problem&lt;/p&gt;

&lt;p&gt;Activemq is configured to use the &#171;&#160;memoryPersistenceAdapter&#160;&#187;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When examining memory dumps, we identified incoherent situation in the class MemoryMessageStore that can lead to stop delivering messages. When&#160;:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;MemoryMessageStore.recoverNextMessages(...) is called&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&#171;&#160;lastBatchId&#160;&#187; is not null&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&#171;&#160;messageTable&#160;&#187; does not contains any entry with &#171;&#160;lastBatchId&#160;&#187; as key&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;no messages are recovered&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We added logs to try to understand how it is possible to have a non null &#171;&#160;lastBatchId&#160;&#187; and &#171;&#160;&#160;messageTable&#160;&#187; with no entry having &#171;&#160;lastBatchId&#160;&#187; as key.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We noticed that the method setBatch is called with a non null &#171;&#160;messageId&#160;&#187; parameter, but no message with this id is inserted in &#171;&#160;messageTable&#160;&#187;. After that, when the method MemoryMessageStore.recoverNextMessages(...) is called, it does nothing and no messages are recoverd. And the system go in a what looks like an endless loop.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We are testing a temporary solution by resetting &#171;&#160;lastBatchId&#160;&#187; to null when the incoherent situation is detected.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Can you help us resolving the problem at the source and not just get around.&lt;/p&gt;

&lt;p&gt;I joined modified source code of the class&#160;MemoryMessageStore and an extract of the log file.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13171170">AMQ-7009</key>
            <summary>ActiveMQ stop delivering messages</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="nezih">Nezih BEN FREDJ</reporter>
                        <labels>
                    </labels>
                <created>Tue, 10 Jul 2018 14:50:07 +0000</created>
                <updated>Wed, 14 Nov 2018 14:23:21 +0000</updated>
                            <resolved>Wed, 14 Nov 2018 14:23:21 +0000</resolved>
                                    <version>5.15.4</version>
                                    <fixVersion>5.16.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16540036" author="tabish121" created="Wed, 11 Jul 2018 12:43:30 +0000"  >&lt;p&gt;The version you are using is old an not a supported release, please upgrade to the latest release and then report back if the problem persists.&lt;/p&gt;</comment>
                            <comment id="16545272" author="nezih" created="Mon, 16 Jul 2018 14:44:46 +0000"  >&lt;p&gt;We have done the upgrade to the latest version 5.15.4 and the problem does persist. So I updated the description of the problem above.&lt;/p&gt;

&lt;p&gt;In attachement, the new version of the class modified to generate some helpful logs.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12931803/12931803_MemoryMessageStore.java&quot; title=&quot;MemoryMessageStore.java attached to AMQ-7009&quot;&gt;MemoryMessageStore.java&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16545338" author="realitix" created="Mon, 16 Jul 2018 15:27:00 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I encounter the same problem as Nezih on the last version too.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Jean-S&#233;bastien&lt;/p&gt;</comment>
                            <comment id="16545355" author="tabish121" created="Mon, 16 Jul 2018 15:32:58 +0000"  >&lt;p&gt;You should work on providing a unit test to reproduce the issue.&#160;&lt;/p&gt;</comment>
                            <comment id="16546177" author="nezih" created="Tue, 17 Jul 2018 08:23:36 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Unfortunately, we already spent a lot of time trying to understand why AMQ stop deliver messages, and we don&apos;t have resources and time to do more analysis (The problam has began 3 years ago).&lt;/p&gt;

&lt;p&gt;We should get by, by uncommenting the line 135 of the method &quot;recoverNextMessages(...)&quot;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Nezih&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16555745" author="nezih" created="Wed, 25 Jul 2018 14:21:07 +0000"  >&lt;p&gt;In attachment, a unit test reproducing the issue.&lt;span class=&quot;error&quot;&gt;&amp;#91;^MemoryMessageStoreQueueCursor.java&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;To make the memoryMessageStore more robust we can modify methods setBatch and recoverNextMessages as follow :&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160; @Override&lt;br/&gt;
&#160;&#160;&#160; public void setBatch(MessageId messageId) {&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; synchronized (messageTable) {&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160; &#160;&#160;&#160; &#160;lastBatchId = messageId;&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160; &#160;&#160;&#160; &#160;if(!messageTable.containsKey(lastBatchId)) &lt;/p&gt;
{
&#160;&#160;&#160;&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;lastBatchId = null;
&#160;&#160;&#160;&#160;&#160;&#160; &#160;&#160;&#160; &#160;}&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&lt;br/&gt;
&#160;&#160;&#160; }&lt;br/&gt;
&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;br/&gt;
&#160;&#160;&#160; @Override&lt;br/&gt;
&#160;&#160;&#160; public void recoverNextMessages(int maxReturned, MessageRecoveryListener listener) throws Exception {&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; synchronized (messageTable) {&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160; &#160;&#160;&#160; &#160;boolean containsLastBatchId = messageTable.containsKey(lastBatchId);&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160; &#160;&#160;&#160; &#160;if(!containsLastBatchId) {
&#160;&#160;&#160;&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;lastBatchId = null;
&#160;&#160;&#160;&#160;&#160;&#160; &#160;&#160;&#160; &#160;}
&lt;p&gt;&#160;&#160;&#160;&#160;&#160;&#160; &#160;&#160;&#160; &#160;&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160; &#160;&#160;&#160; &#160;boolean pastLackBatch = lastBatchId == null;&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; for (Map.Entry&amp;lt;MessageId, Message&amp;gt; entry : messageTable.entrySet()) {&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (pastLackBatch) {&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Object msg = entry.getValue();&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; lastBatchId = entry.getKey();&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (msg.getClass() == MessageId.class) &lt;/p&gt;
{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; listener.recoverMessageReference((MessageId) msg);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&lt;p&gt; else &lt;/p&gt;
{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; listener.recoverMessage((Message) msg);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&lt;p&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } else &lt;/p&gt;
{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pastLackBatch = entry.getKey().equals(lastBatchId);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&lt;p&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; }&lt;br/&gt;
&#160;&#160;&#160; }&lt;/p&gt;</comment>
                            <comment id="16558093" author="nezih" created="Thu, 26 Jul 2018 09:20:25 +0000"  >&lt;p&gt;Explanation :&lt;br/&gt;
when activating TRACE level logs for the class &quot;AbstractStoreCursor&quot;, I noticed the next two lines in the log file :&lt;/p&gt;

&lt;p&gt;2018-07-18 12:02:06,136 | TRACE | org.apache.activemq.broker.region.cursors.QueueStorePrefetch@3a5f8f9a:retour.event.box4,batchResetNeeded=false,size=0,cacheEnabled=true,maxBatchSize:1,hasSpace:false,pendingCachedIds.size:0,lastSyncCachedId:ID:vhqve41.pprod.helios.cp-54155-1531902423423-1:10:2:1:282,lastSyncCachedId-seq:75,lastAsyncCachedId:null,lastAsyncCachedId-seq:null,store=org.apache.activemq.store.memory.MemoryMessageStore@349876a1 - disabling cache on add ID:vhqve41.pprod.helios.cp-54155-1531902423423-1:3:1:1:370 76 | org.apache.activemq.broker.region.cursors.AbstractStoreCursor | ActiveMQ Transport: tcp:///174.4.111.217:35610@6666&lt;br/&gt;
2018-07-18 12:02:06,136 | WARN&#160; | @@@NBF@@@ setBatch called with param messageId : (ID:vhqve41.pprod.helios.cp-54155-1531902423423-1:10:2:1:282). lastBatchId : (null) the new lastBatchId : (ID:vhqve41.pprod.helios.cp-54155-1531902423423-1:10:2:1:282) is NOT in messageTable | org.apache.activemq.store.memory.MemoryMessageStore | ActiveMQ Transport: tcp:///174.4.111.217:35610@6666&lt;/p&gt;

&lt;p&gt;The second line shows that setBatch is called with a parameter &quot;messageId&quot; corresponding to a probably old message that is already removed from store.&lt;br/&gt;
The first line shows that just befor calling setBatch, we had (hasSpace:false while size=0) which mean : there is no messages in the queue but there is no free space too !!!.&lt;br/&gt;
It seems like messages are consumed but their space is not rendered or not yet rendered at that moment.&lt;/p&gt;</comment>
                            <comment id="16686570" author="jira-bot" created="Wed, 14 Nov 2018 14:21:54 +0000"  >&lt;p&gt;Commit bc8c78cd32b27dd1806fe2246c21241ab68a1fde in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=bc8c78c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=bc8c78c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7009&quot; title=&quot;ActiveMQ stop delivering messages&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7009&quot;&gt;&lt;del&gt;AMQ-7009&lt;/del&gt;&lt;/a&gt; - apply fix to memorymessagestore setBatch with thanks to Nezih BEN FREDJ for test and suggestion&lt;/p&gt;</comment>
                            <comment id="16686571" author="gtully" created="Wed, 14 Nov 2018 14:23:21 +0000"  >&lt;p&gt;Thanks for the test case and suggested fix. A little tweak to the test case to better manage memory usage made it clear that your fix is good.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12931803" name="MemoryMessageStore.java" size="8251" author="nezih" created="Mon, 16 Jul 2018 14:34:44 +0000"/>
                            <attachment id="12933171" name="MemoryMessageStoreQueueCursorTest.java" size="5276" author="nezih" created="Thu, 26 Jul 2018 09:29:55 +0000"/>
                            <attachment id="12931809" name="activemq.log" size="97172" author="nezih" created="Mon, 16 Jul 2018 15:16:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vq8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>