<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:05:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5262] ActiveMQ hangs on shutdown when JMS Bridge is created</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5262</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;We are having a problem with ActiveMQ hanging on shutdown.  Here is the scenario, we have a stand alone application that runs an embedded ActiveMQ which creates a JMS Queue Bridge via Spring configs. When we call shutdown, the TCPTransport that connects the JMS Queue Bridge does not shutdown, it hangs on java.net.SocketInputStream.socketRead0(). &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.Thread.State: RUNNABLE
	at java.net.SocketInputStream.socketRead0(Native Method)
	at java.net.SocketInputStream.read(SocketInputStream.java:129)
	at org.apache.activemq.transport.tcp.TcpBufferedInputStream.fill(TcpBufferedInputStream.java:50)
	at org.apache.activemq.transport.tcp.TcpTransport$2.fill(TcpTransport.java:604)
	at org.apache.activemq.transport.tcp.TcpBufferedInputStream.read(TcpBufferedInputStream.java:58)
	at org.apache.activemq.transport.tcp.TcpTransport$2.read(TcpTransport.java:589)
	at java.io.DataInputStream.readInt(DataInputStream.java:370)
	at org.apache.activemq.openwire.OpenWireFormat.unmarshal(OpenWireFormat.java:275)
	at org.apache.activemq.transport.tcp.TcpTransport.readCommand(TcpTransport.java:221)
	at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:213)
	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:196)
	at java.lang.Thread.run(Thread.java:662)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Digging around on the forums and the issue tracker, the work around seems to add a parameter to the URI (Ex - tcp://localhost:60606?daemon=true).  &lt;/p&gt;

&lt;p&gt;According to this StackOverflow posting (&lt;a href=&quot;http://stackoverflow.com/questions/2213340/what-is-daemon-thread-in-java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/2213340/what-is-daemon-thread-in-java&lt;/a&gt;) which quotes from Java Concurrency in Practice &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;When a new thread is created it inherits the daemon status of its parent.&lt;/li&gt;
	&lt;li&gt;Normal thread and daemon threads differ in what happens when they exit. When the JVM halts any remaining daemon threads are abandoned: *&lt;b&gt;finally blocks are not executed&lt;/b&gt;*, stacks are not unwound - JVM just exits. Due to this reason daemon threads should be used sparingly and it is dangerous to use them for tasks that might perform any sort of I/O.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So, making the Socket that connects the JMS Queue Bridge a Daemon thread, seems to be the wrong solution.  &lt;/p&gt;

&lt;p&gt;I was trying to debug the initialization of ActiveMQ, and noticed the org.apache.activemq.network.jms.JmsConnector class has a stop() method on it.  I believe this class creates the connection for the JMS Bridge, right?  If so, the stop method does not seem to shutdown the connection properly. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void stop() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (started.compareAndSet(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)) {

            ThreadPoolUtils.shutdown(connectionSerivce);
            connectionSerivce = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;

            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (DestinationBridge bridge : inboundBridges) {
                bridge.stop();
            }
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (DestinationBridge bridge : outboundBridges) {
                bridge.stop();
            }
            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;JMS Connector {} stopped&quot;&lt;/span&gt;, getName());
        }
        
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The question I have is why is the stop() method relying on the ThreadPoolUtils.shutdown(connectionSerivce) and NOT calling close() on the Connections first? For example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void stop() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (started.compareAndSet(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)) {

			foreignConnection.get().close();
			localConnection.get().close();
			
            ThreadPoolUtils.shutdown(connectionSerivce);
            connectionSerivce = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;

            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (DestinationBridge bridge : inboundBridges) {
                bridge.stop();
            }
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (DestinationBridge bridge : outboundBridges) {
                bridge.stop();
            }
            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;JMS Connector {} stopped&quot;&lt;/span&gt;, getName());
        }
        
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It was a little difficult to follow the code, so I may be missing something.  BUT shouldn&apos;t the connections close first?  Or am I looking in the wrong place.  &lt;/p&gt;

&lt;p&gt;I have created a small project that creates this scenario.&lt;br/&gt;
&lt;a href=&quot;https://github.com/pminearo/activemq-shutdown-bug.git&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pminearo/activemq-shutdown-bug.git&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This was done with ActiveMQ 5.9.  Though, since this bug has been around for quite some time, it most likely is still in 5.10, 5.11, and 6.0.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12725879">AMQ-5262</key>
            <summary>ActiveMQ hangs on shutdown when JMS Bridge is created</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="pminearo">Peter Minearo</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Jul 2014 23:15:29 +0000</created>
                <updated>Tue, 16 Dec 2014 00:08:16 +0000</updated>
                            <resolved>Tue, 8 Jul 2014 20:21:23 +0000</resolved>
                                    <version>5.9.0</version>
                    <version>5.9.1</version>
                    <version>5.10.0</version>
                                    <fixVersion>5.10.1</fixVersion>
                    <fixVersion>5.11.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14055421" author="tabish121" created="Tue, 8 Jul 2014 20:10:41 +0000"  >&lt;p&gt;It does seems like there should be a close there, although probably after the connectionService is stopped to prevent any attempts at reconnect from contending with the close.  &lt;/p&gt;

&lt;p&gt;In reality we recommend using Camel as the Bridging technology as it has proven itself to be far better at doing this sort of thing.  See: &lt;a href=&quot;http://activemq.apache.org/jms-to-jms-bridge.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/jms-to-jms-bridge.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14055447" author="tabish121" created="Tue, 8 Jul 2014 20:21:23 +0000"  >&lt;p&gt;Close connections when the connector is stopped. &lt;/p&gt;</comment>
                            <comment id="14055462" author="pminearo" created="Tue, 8 Jul 2014 20:28:15 +0000"  >&lt;p&gt;The JMS Bridge so far has been working great.  The only issue we have seen is this hanging resource.  So, cleaning up the resources properly would fix the issue and make the use of Camel no longer a needed option.  Are there more technical reasons to not use the JMS Bridge the way it is set up in the Test project I included?  Is this functionality a legacy spec and no longer supported?  Did it change in 6.0? etc? &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>404037</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 20 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xjcv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>404078</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>