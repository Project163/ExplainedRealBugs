<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:46:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2070] activemq process does not exit after stop() and other stop related issue</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2070</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;There are a few issues to stop activemq&lt;br/&gt;
1. using jconsole and call broker.stop(), the java process of activemq will not quit, the root cause is when jetty is configured using xbean in activemq.xml, the broker.stop() does not stop jetty server so the java process will not quit, however the web admin will not work after broker.stop() and will display jsp exceptions.&lt;br/&gt;
2. the current activemq-console code which activemq-admin is using to do stop broker is calling terminateJVM and does not handle exceptions thrown&lt;br/&gt;
3. we have a use case when we stop a broker, we don&apos;t want any pending messages stuck in the broker, because it requires us to restart the broker immediately to not to lose those pending messages.It will be a problem if in real world we cannot restart it right away and those pending messages are critical. &lt;br/&gt;
The solution we thought is as follows:&lt;br/&gt;
What we want is to use the current network of brokers forwarding mechanism to forward those pending messages to other broker which has a related consumer, then stop the broker completely and we don&apos;t need to restart the stopped broker right away. for example, we have a network of two brokers, A, and B, the client(producer/consumer) is using failover://(tcp:brokerA:port1, tcp:brokerB:port1), then when we want to stop A and it has 10 pending messages, we want stop A&apos;s transport that the client is connecting to, so client will failover to broker B, then 10 pending messages will be forwarded to broker B, then we can stop the broker A completely.&lt;/p&gt;

&lt;p&gt;To address the above issues, attached are two patches, one for activemq-core and one for activemq-console, both patches are based on tags/activemq-5.2.0 please review them and I will appreciate if it can be applied to trunk. If you have any question regarding these changes, please let me know. Thank you.&lt;/p&gt;

&lt;p&gt;With the patches:&lt;/p&gt;

&lt;p&gt;Here is a sample usage:&lt;br/&gt;
./activemq-admin stopGracefully --connectorName ssl --queueName test*? --timeout 120 --pollInterval 20 --jmxurl service:jmx:rmi:///jndi/rmi://localhost:3616/jmxrmi&lt;/p&gt;

&lt;p&gt;this command will stop connector ssl, and it will check queues starting with test (queueName takes regex) to make sure they have no pending messages then stop the broker. It will check the queuesize every 20 seconds and timeout in 120 seconds. If after timeout, there are still pending messages in the queues, it will not stop the broker and it will need manual check to stop the broker properly.&lt;/p&gt;

&lt;p&gt;ADDED: &lt;br/&gt;
1. the patches fix more issues for stopping the broker. if broker starts as master and waitForslave, stop will not let the java quit the process. Also if slave is started first and use failover to talk to the master, you can also stop it before it establish the connection with the master.&lt;/p&gt;

&lt;p&gt;2. added to use localProcessId to get jmxurl, that way, activemq-admin can access jmx as a local jconsole, without jmxuser and jmxpassword, while remote jconsole still needs authentication when it is turned on. for this you need -Dcom.sun.management.jmxremote when starting activemq&lt;/p&gt;

&lt;p&gt;There is a known issue of jmx rmi is two ports, one can be configured and the other is using random ports when a remote jconsole connects. this is not acceptable in a firewall environment. If concerned, please check my other post &lt;a href=&quot;http://www.nabble.com/JMX-remote-managmentContext-and-firewall-to21969017.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.nabble.com/JMX-remote-managmentContext-and-firewall-to21969017.html&lt;/a&gt; you can use a custom agent to be able to configure two fixed ports.&lt;/p&gt;</description>
                <environment>&lt;p&gt;windows xp and solaris&lt;/p&gt;</environment>
        <key id="12482679">AMQ-2070</key>
            <summary>activemq process does not exit after stop() and other stop related issue</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="yinghe0101">ying</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Jan 2009 18:41:04 +0000</created>
                <updated>Sun, 11 Jul 2010 16:34:02 +0000</updated>
                            <resolved>Sun, 11 Jul 2010 16:34:02 +0000</resolved>
                                    <version>5.2.0</version>
                                    <fixVersion>5.4.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="12940678" author="yinghe0101" created="Fri, 16 Jan 2009 18:42:38 +0000"  >&lt;p&gt;activemq-core patch&lt;/p&gt;</comment>
                            <comment id="12940685" author="yinghe0101" created="Fri, 16 Jan 2009 18:43:29 +0000"  >&lt;p&gt;activemq-console patch&lt;/p&gt;</comment>
                            <comment id="12940644" author="yinghe0101" created="Fri, 16 Jan 2009 18:44:39 +0000"  >&lt;p&gt;this class belong to activemq-console org.apache.activemq.console.command package&lt;/p&gt;</comment>
                            <comment id="12940767" author="yinghe0101" created="Fri, 13 Feb 2009 15:44:33 +0000"  >&lt;p&gt;added --localProcessId to use &amp;lt;pid&amp;gt; to connect to jmx&lt;/p&gt;</comment>
                            <comment id="12940759" author="yinghe0101" created="Fri, 13 Feb 2009 15:46:53 +0000"  >&lt;p&gt;add --localProcessId to use pid to connect to jmx&lt;/p&gt;</comment>
                            <comment id="12940825" author="yinghe0101" created="Fri, 20 Feb 2009 15:21:41 +0000"  >&lt;p&gt;updated fix more stopping issue&lt;/p&gt;</comment>
                            <comment id="12940812" author="yinghe0101" created="Fri, 20 Feb 2009 15:22:08 +0000"  >&lt;p&gt;updated fix more stop issue&lt;/p&gt;</comment>
                            <comment id="12941259" author="rajdavies" created="Thu, 10 Sep 2009 09:32:25 +0000"  >&lt;p&gt;Nice patch! &lt;br/&gt;
Any chance you can update against the latest in trunk ?&lt;br/&gt;
Also - not sure about introducing dependency on jetty into activemq-core package - maybe better to derive a class in activemq-optional ?&lt;/p&gt;</comment>
                            <comment id="12941337" author="rajdavies" created="Thu, 10 Sep 2009 13:21:59 +0000"  >&lt;p&gt;Fixed by revision 813422 and revision 813424&lt;/p&gt;</comment>
                            <comment id="12942147" author="yinghe0101" created="Thu, 8 Apr 2010 17:50:04 +0000"  >&lt;p&gt;It seems that last time when the patch is applied, a line of code is merged incorrectly. &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2070&quot; title=&quot;activemq process does not exit after stop() and other stop related issue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2070&quot;&gt;&lt;del&gt;AMQ-2070&lt;/del&gt;&lt;/a&gt;-5.3.1.patch will fix that and make stopGracefully work properly&lt;/p&gt;</comment>
                            <comment id="12942486" author="rajdavies" created="Sun, 11 Jul 2010 16:34:02 +0000"  >&lt;p&gt;Fixed by SVN revision 963104&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461614" name="AMQ-2070-5.3.1.patch" size="914" author="yinghe0101" created="Thu, 8 Apr 2010 17:50:31 +0000"/>
                            <attachment id="12461299" name="StopGracefullyCommand.java" size="5966" author="yinghe0101" created="Fri, 20 Feb 2009 15:22:19 +0000"/>
                            <attachment id="12461254" name="patchActiveMQConsole5.2.0" size="8899" author="yinghe0101" created="Fri, 20 Feb 2009 15:22:08 +0000"/>
                            <attachment id="12461276" name="patchActiveMQCore5.2.0" size="18637" author="yinghe0101" created="Fri, 20 Feb 2009 15:21:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>75092</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 20 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rq6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>159886</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>