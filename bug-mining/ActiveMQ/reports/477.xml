<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:38:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1976] Network of brokers gets out of sync for dispatched messages causing a shutdown of the bridge connections and stalling the brokers</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1976</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Running 5.2.0 RC2 + patch &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1971&quot; title=&quot;ConcurrentModificationException in high volume broker &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1971&quot;&gt;&lt;del&gt;AMQ-1971&lt;/del&gt;&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;I have a network of 5 brokers, running around 50,000 messages per minute per broker within each broker and sending across a total of around 20,000 messages per minute to one of the 5 brokers via a bridge connection.  The configuration is the 5.2.0 default with broker names changed on each config and with a network connector set for autodiscovery.  &lt;/p&gt;

&lt;p&gt;The system runs for a while then eventually on one broker (the receiving broker that is the only one with the consumers for this queue) these errors appear:&lt;/p&gt;

&lt;p&gt;ERROR RecoveryListenerAdapter        - Message id ID:ingest1.mag.ss.com-54179-1223898804441-0:6:1:1:6134 could not be recovered from the data store - already dispatched&lt;br/&gt;
ERROR RecoveryListenerAdapter        - Message id ID:query1.mag.ss.com-38822-1223898893819-0:58:16388:1:48 could not be recovered from the data store - already dispatched&lt;/p&gt;

&lt;p&gt;They appear in really high counts.&lt;/p&gt;

&lt;p&gt;On the sending side brokers (publishers but no consumers on these brokers for this queue), these errors appear:&lt;/p&gt;

&lt;p&gt;INFO  DemandForwardingBridge         - query2.mag.ss.com bridge to query1.mag.ss.com stopped&lt;br/&gt;
INFO  DiscoveryNetworkConnector      - Establishing network connection between from vm://query2.mag.ss.com to tcp://query1.mag.ss.com:61616&lt;br/&gt;
INFO  DemandForwardingBridge         - Network connection between vm://query2.mag.ss.com#30 and tcp://query1.mag.ss.com/10.100.0.101:61616(query1.mag.ss.com) has been established.&lt;br/&gt;
ERROR Service                        - Async error occurred: javax.jms.JMSException: Unmatched acknowledege: Expected message count (1) differs from count in dispatched-list (732)&lt;br/&gt;
javax.jms.JMSException: Unmatched acknowledege: Expected message count (1) differs from count in dispatched-list (732)&lt;br/&gt;
	at org.apache.activemq.broker.region.PrefetchSubscription.assertAckMatchesDispatched(PrefetchSubscription.java:445)&lt;br/&gt;
	at org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:187)&lt;br/&gt;
	at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:373)&lt;br/&gt;
	at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:462)&lt;br/&gt;
	at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)&lt;br/&gt;
	at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:85)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:456)&lt;br/&gt;
	at org.apache.activemq.command.MessageAck.visit(MessageAck.java:205)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:305)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)&lt;br/&gt;
	at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:104)&lt;br/&gt;
	at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)&lt;br/&gt;
	at org.apache.activemq.transport.vm.VMTransport.oneway(VMTransport.java:113)&lt;br/&gt;
	at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:40)&lt;br/&gt;
	at org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60)&lt;br/&gt;
	at org.apache.activemq.network.DemandForwardingBridgeSupport$8.onCompletion(DemandForwardingBridgeSupport.java:643)&lt;br/&gt;
	at org.apache.activemq.transport.FutureResponse.set(FutureResponse.java:61)&lt;br/&gt;
	at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:97)&lt;br/&gt;
	at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)&lt;br/&gt;
	at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:143)&lt;br/&gt;
	at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:206)&lt;br/&gt;
	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:202)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:184)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
INFO  DemandForwardingBridge         - Network connection between vm://query2.mag.ss.com#30 and tcp://query1.mag.ss.com/10.100.0.101:61616 shutdown due to a local error: javax.jms.JMSException: Unmatched acknowledege: Expected message count (1) differs from count in dispatched-list (732)&lt;br/&gt;
INFO  DemandForwardingBridge         - query2.mag.ss.com bridge to query1.mag.ss.com stopped&lt;br/&gt;
INFO  DiscoveryNetworkConnector      - Establishing network connection between from vm://query2.mag.ss.com to tcp://query1.mag.ss.com:61616&lt;br/&gt;
INFO  DemandForwardingBridge         - Network connection between vm://query2.mag.ss.com#32 and tcp://query1.mag.ss.com/10.100.0.101:61616(query1.mag.ss.com) has been established.&lt;br/&gt;
ERROR Service                        - Async error occurred: javax.jms.JMSException: Unmatched acknowledege: Expected message count (1) differs from count in dispatched-list (730)&lt;br/&gt;
javax.jms.JMSException: Unmatched acknowledege: Expected message count (1) differs from count in dispatched-list (730)&lt;br/&gt;
	at org.apache.activemq.broker.region.PrefetchSubscription.assertAckMatchesDispatched(PrefetchSubscription.java:445)&lt;br/&gt;
	at org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:187)&lt;br/&gt;
	at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:373)&lt;br/&gt;
	at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:462)&lt;br/&gt;
	at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)&lt;br/&gt;
	at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:85)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:456)&lt;br/&gt;
	at org.apache.activemq.command.MessageAck.visit(MessageAck.java:205)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:305)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)&lt;br/&gt;
	at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:104)&lt;br/&gt;
	at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)&lt;br/&gt;
	at org.apache.activemq.transport.vm.VMTransport.oneway(VMTransport.java:113)&lt;br/&gt;
	at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:40)&lt;br/&gt;
	at org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60)&lt;br/&gt;
	at org.apache.activemq.network.DemandForwardingBridgeSupport$8.onCompletion(DemandForwardingBridgeSupport.java:643)&lt;br/&gt;
	at org.apache.activemq.transport.FutureResponse.set(FutureResponse.java:61)&lt;br/&gt;
	at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:97)&lt;br/&gt;
	at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)&lt;br/&gt;
	at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:143)&lt;br/&gt;
	at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:206)&lt;br/&gt;
	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:202)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:184)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
INFO  DemandForwardingBridge         - Network connection between vm://query2.mag.ss.com#32 and tcp://query1.mag.ss.com/10.100.0.101:61616 shutdown due to a local error: javax.jms.JMSException: Unmatched acknowledege: Expected message count (1) differs from count in dispatched-list (730)&lt;br/&gt;
ERROR Service                        - Async error occurred: javax.jms.JMSException: Unmatched acknowledege: Expected message count (1) differs from count in dispatched-list (729)&lt;br/&gt;
javax.jms.JMSException: Unmatched acknowledege: Expected message count (1) differs from count in dispatched-list (729)&lt;br/&gt;
	at org.apache.activemq.broker.region.PrefetchSubscription.assertAckMatchesDispatched(PrefetchSubscription.java:445)&lt;br/&gt;
	at org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:187)&lt;br/&gt;
	at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:373)&lt;br/&gt;
	at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:462)&lt;br/&gt;
	at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194)&lt;br/&gt;
...&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12482721">AMQ-1976</key>
            <summary>Network of brokers gets out of sync for dispatched messages causing a shutdown of the bridge connections and stalling the brokers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="jayson.minard">Jayson Minard</reporter>
                        <labels>
                    </labels>
                <created>Mon, 13 Oct 2008 12:22:26 +0000</created>
                <updated>Thu, 6 Nov 2008 10:47:08 +0000</updated>
                            <resolved>Thu, 16 Oct 2008 16:56:18 +0000</resolved>
                                    <version>5.2.0</version>
                                    <fixVersion>5.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12940341" author="gtully" created="Wed, 15 Oct 2008 16:24:29 +0000"  >&lt;p&gt;are the producers using asyncSend?&lt;/p&gt;

&lt;p&gt;I don&apos;t know the relevance of ERROR RecoveryListenerAdapter ... but I think the assertAckMatchesDispatched is being a little harsh. My problem is reproducing the behavior.&lt;br/&gt;
messages that passe through a network are acked one by one. The error is telling us that the ack is ocurring out of order; since the message was dispatched, 730 other messages have been dispatched and it looks like the ack is for the 730th message. It is a valid ack though.&lt;br/&gt;
I think this can only happen in asyncSend, otherwise, each dispatched message is synchronously acked through to its next hop.&lt;/p&gt;

&lt;p&gt;Ideally, it would be great if you could produce a test case. I have been trying variants of the NetworkLoadTest but am not reproducing the problem.&lt;br/&gt;
What does your producer look like, from the text above, it seems like there is a bunch of activity on each broker?&lt;/p&gt;





</comment>
                            <comment id="12940357" author="gtully" created="Wed, 15 Oct 2008 16:45:06 +0000"  >&lt;p&gt;ah, scrap that, producers must not be asyncSend, with asyncSend this problem should not occur as in that case, the acks are immediate.&lt;/p&gt;</comment>
                            <comment id="12940371" author="gtully" created="Wed, 15 Oct 2008 17:02:59 +0000"  >&lt;p&gt;One possibility is that the consuming broker is hovering about its memory limit. Which causes out of order message delivery to the forwarded queue. There are advisories on full that would help verify this. I can produce a memory full test that can also verify this suspicion. &lt;br/&gt;
This being the case, the assertAckMatches.. needs to be changed.&lt;/p&gt;

&lt;p&gt;Could you the apply the following patch (that just removes the failing check) to a trunk checkout, build and re run your test?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: activemq-core/src/main/java/org/apache/activemq/broker/region/PrefetchSubscription.java
===================================================================
--- activemq-core/src/main/java/org/apache/activemq/broker/region/PrefetchSubscription.java	(revision 704890)
+++ activemq-core/src/main/java/org/apache/activemq/broker/region/PrefetchSubscription.java	(working copy)
@@ -440,10 +440,10 @@
 			&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JMSException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unmatched acknowledege: Could not find Message-ID &quot;&lt;/span&gt;+firstAckedMsg+&lt;span class=&quot;code-quote&quot;&gt;&quot; in dispatched-list (start of ack)&quot;&lt;/span&gt;);
 		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!checkFoundEnd &amp;amp;&amp;amp; lastAckedMsg != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
 			&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JMSException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unmatched acknowledege: Could not find Message-ID &quot;&lt;/span&gt;+lastAckedMsg+&lt;span class=&quot;code-quote&quot;&gt;&quot; in dispatched-list (end of ack)&quot;&lt;/span&gt;);
-		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ack.getMessageCount() != checkCount) {
-			&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JMSException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unmatched acknowledege: Expected message count (&quot;&lt;/span&gt;+ack.getMessageCount()+
-					&lt;span class=&quot;code-quote&quot;&gt;&quot;) differs from count in dispatched-list (&quot;&lt;/span&gt;+checkCount+&lt;span class=&quot;code-quote&quot;&gt;&quot;)&quot;&lt;/span&gt;);
-		}
+&lt;span class=&quot;code-comment&quot;&gt;//		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ack.getMessageCount() != checkCount) {
&lt;/span&gt;+&lt;span class=&quot;code-comment&quot;&gt;//			&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JMSException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unmatched acknowledege: Expected message count (&quot;&lt;/span&gt;+ack.getMessageCount()+
&lt;/span&gt;+&lt;span class=&quot;code-comment&quot;&gt;//					&lt;span class=&quot;code-quote&quot;&gt;&quot;) differs from count in dispatched-list (&quot;&lt;/span&gt;+checkCount+&lt;span class=&quot;code-quote&quot;&gt;&quot;)&quot;&lt;/span&gt;);
&lt;/span&gt;+&lt;span class=&quot;code-comment&quot;&gt;//		}
&lt;/span&gt; 	}
 
     /**
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12940374" author="gtully" created="Thu, 16 Oct 2008 15:06:02 +0000"  >&lt;p&gt;the problem appears to be related to memory full issues. I have a reproducible test case now based on the consuming broker hovering near full memory utilisation.&lt;/p&gt;</comment>
                            <comment id="12940359" author="gtully" created="Thu, 16 Oct 2008 16:56:17 +0000"  >&lt;p&gt;fixed in r705281.&lt;br/&gt;
Problem related to the ack type used by a network bridge. It needs to be an Individual ack as the message has to be consumed by the forward broker before the ack is produced and if memory limits are effecting message delivery to a forward queue, the exact order of message delivery is not guaranteed.&lt;br/&gt;
With an individual ack, out of order consumption by a forward queue does not cause an error. &lt;/p&gt;</comment>
                            <comment id="12940449" author="gtully" created="Thu, 6 Nov 2008 10:47:08 +0000"  >&lt;p&gt;These fixes will now make 5.2.0 rc3&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>75142</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 3 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s25j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161825</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>