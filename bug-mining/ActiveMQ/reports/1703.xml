<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:57:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4159] Race condition in SimpleDiscoveryAgent creates multiple concurrent threads attempting to connect to the same bridge --- can result in deadlock</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4159</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Symptom&lt;br/&gt;
=======&lt;br/&gt;
I was diagnosing a deadlock issue in &lt;tt&gt;DiscoveryNetworkConnector&lt;/tt&gt; and noticed that during one of the tests, concurrent calls were being made to &lt;tt&gt;DiscoveryNetworkConnector.onServiceAdd(...)&lt;/tt&gt; for the same &lt;tt&gt;DiscoveryEvent&lt;/tt&gt;.  This was unexpected because only a single service (URL) had been given to &lt;tt&gt;SimpleDiscoveryAgent&lt;/tt&gt;.  In fact, during one of the tests I observed dozens of concurrent calls.&lt;/p&gt;

&lt;p&gt;Concurrent attempts to establish a bridge to the &lt;b&gt;same&lt;/b&gt; remote broker are problematic because they expose a number of race conditions in &lt;tt&gt;DiscoveryNetworkConnector&lt;/tt&gt; and &lt;tt&gt;RegionBroker&lt;/tt&gt; that can lead to permanent bridge failure (see &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4160&quot; title=&quot;DiscoveryNetworkConnector can lose track of active bridges, resulting in permanent bridge failure or continued attempts to re-connect existing bridges&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4160&quot;&gt;&lt;del&gt;AMQ-4160&lt;/del&gt;&lt;/a&gt;), as well as unnecessary thread pool execution/resource usage and logging.&lt;/p&gt;

&lt;p&gt;The issues with &lt;tt&gt;DiscoveryNetworkConnector&lt;/tt&gt; and &lt;tt&gt;RegionBroker&lt;/tt&gt; will be filed as separate issues.  This issue specifically addresses the bug that causes &lt;tt&gt;SimpleDiscoveryAgent&lt;/tt&gt; to uncontrollably multiply bridge connection attempts.&lt;/p&gt;

&lt;p&gt;Cause&lt;br/&gt;
=====&lt;br/&gt;
When &lt;tt&gt;DemandForwardingBridgeSupport&lt;/tt&gt; handles exceptions from either the local or remote sides of the the bridge, it fires a &quot;bridge failed&quot; event:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;DemandForwardingBridgeSupport.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void serviceLocalException(Throwable error) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!disposed.get()) {
        LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Network connection between &quot;&lt;/span&gt; + localBroker + &lt;span class=&quot;code-quote&quot;&gt;&quot; and &quot;&lt;/span&gt; + remoteBroker + &lt;span class=&quot;code-quote&quot;&gt;&quot; shutdown due to a local error: &quot;&lt;/span&gt; + error);
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;The local Exception was:&quot;&lt;/span&gt; + error, error);
        brokerService.getTaskRunnerFactory().execute(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;() {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
                ServiceSupport.dispose(getControllingService());
            }
        });
        fireBridgeFailed();
    }
}


&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void serviceRemoteException(Throwable error) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!disposed.get()) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (error &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; SecurityException || error &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; GeneralSecurityException) {
            LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Network connection between &quot;&lt;/span&gt; + localBroker + &lt;span class=&quot;code-quote&quot;&gt;&quot; and &quot;&lt;/span&gt; + remoteBroker + &lt;span class=&quot;code-quote&quot;&gt;&quot; shutdown due to a remote error: &quot;&lt;/span&gt; + error);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Network connection between &quot;&lt;/span&gt; + localBroker + &lt;span class=&quot;code-quote&quot;&gt;&quot; and &quot;&lt;/span&gt; + remoteBroker + &lt;span class=&quot;code-quote&quot;&gt;&quot; shutdown due to a remote error: &quot;&lt;/span&gt; + error);
        }
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;The remote Exception was: &quot;&lt;/span&gt; + error, error);
        brokerService.getTaskRunnerFactory().execute(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;() {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
                ServiceSupport.dispose(getControllingService());
            }
        });
        fireBridgeFailed();
    }
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void fireBridgeFailed() {
    NetworkBridgeListener l = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.networkBridgeListener;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (l != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        l.bridgeFailed();
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;tt&gt;DiscoveryNetworkConnector&lt;/tt&gt; is the &lt;tt&gt;NetworkBridgeListener&lt;/tt&gt;, and its &lt;tt&gt;bridgeFailed()&lt;/tt&gt; method calls back to &lt;tt&gt;SimpleDiscoveryAgent.serviceFailed(...)&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;DiscoveryNetworkConnectol.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; NetworkBridge createBridge(Transport localTransport, Transport remoteTransport, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; DiscoveryEvent event) {
    &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DiscoverNetworkBridgeListener &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; MBeanNetworkListener {

        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; DiscoverNetworkBridgeListener(BrokerService brokerService, ObjectName connectorName) {
            &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(brokerService, connectorName);
        }

        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void bridgeFailed() {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!serviceSupport.isStopped()) {
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    discoveryAgent.serviceFailed(event);
                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
                }
            }

        }
    }
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In response, &lt;tt&gt;SimpleDiscoveryAgent.serviceFailed(...)&lt;/tt&gt; pauses for the &lt;tt&gt;reconnectDelay&lt;/tt&gt; before attempting to re-establish the bridge via &lt;tt&gt;DiscoveryNetworkConnector.onServiceAdd(...)&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;SimpleDiscoveryAgent.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void serviceFailed(DiscoveryEvent devent) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {

    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SimpleDiscoveryEvent event = (SimpleDiscoveryEvent)devent;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sevent.failed.compareAndSet(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)) {

        listener.onServiceRemove(sevent);
        taskRunner.execute(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;() {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
                &lt;span class=&quot;code-comment&quot;&gt;// We detect a failed connection attempt because the service
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// fails right
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// away.
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (event.connectTime + minConnectTime &amp;gt; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis()) {
                    LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failure occurred soon after the discovery event was generated.  It will be classified as a connection failure: &quot;&lt;/span&gt;+event);
...
                    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (sleepMutex) {
                        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!running.get()) {
                                LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Reconnecting disabled: stopped&quot;&lt;/span&gt;);
                                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
                            }

                            LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Waiting &quot;&lt;/span&gt;+event.reconnectDelay+&lt;span class=&quot;code-quote&quot;&gt;&quot; ms before attempting to reconnect.&quot;&lt;/span&gt;);
                            sleepMutex.wait(event.reconnectDelay);
                        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException ie) {
                            LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Reconnecting disabled: &quot;&lt;/span&gt; + ie);
                            &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
                            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
                        }
                    }
...
                event.connectTime = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis();
                event.failed.set(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
                listener.onServiceAdd(event);
            }
        }, &lt;span class=&quot;code-quote&quot;&gt;&quot;Simple Discovery Agent&quot;&lt;/span&gt;);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;NOTE&lt;/b&gt;: the call to &lt;tt&gt;listener.onServiceAdd(...)&lt;/tt&gt; is made by a new thread!&lt;/p&gt;

&lt;p&gt;There are two race conditions that allow &lt;tt&gt;SimpleDiscoveryAgent.serviceFailed(...)&lt;/tt&gt; to launch more than one thread, each attempting to re-restablish the same bridge.&lt;/p&gt;

&lt;p&gt;First, note that &lt;tt&gt;DemandForwardingBridgeSupport.serviceLocal/RemoteException(...)&lt;/tt&gt; launches a separate thread that stops the bridge:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;DemandForwardingBridgeSupport.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void serviceRemoteException(Throwable error) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!disposed.get()) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (error &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; SecurityException || error &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; GeneralSecurityException) {
            LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Network connection between &quot;&lt;/span&gt; + localBroker + &lt;span class=&quot;code-quote&quot;&gt;&quot; and &quot;&lt;/span&gt; + remoteBroker + &lt;span class=&quot;code-quote&quot;&gt;&quot; shutdown due to a remote error: &quot;&lt;/span&gt; + error);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Network connection between &quot;&lt;/span&gt; + localBroker + &lt;span class=&quot;code-quote&quot;&gt;&quot; and &quot;&lt;/span&gt; + remoteBroker + &lt;span class=&quot;code-quote&quot;&gt;&quot; shutdown due to a remote error: &quot;&lt;/span&gt; + error);
        } 
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;The remote Exception was: &quot;&lt;/span&gt; + error, error);
        brokerService.getTaskRunnerFactory().execute(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;() {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
                ServiceSupport.dispose(getControllingService());
            }
        });
        fireBridgeFailed();
    }
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void stop() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (started.compareAndSet(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (disposed.compareAndSet(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)) {
            LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot; stopping &quot;&lt;/span&gt; + configuration.getBrokerName() + &lt;span class=&quot;code-quote&quot;&gt;&quot; bridge to &quot;&lt;/span&gt; + remoteBrokerName);
            NetworkBridgeListener l = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.networkBridgeListener;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (l != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                l.onStop(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When the bridge stops, the &lt;tt&gt;disposed&lt;/tt&gt; flag is set, which prevents subsequent calls to &lt;tt&gt;serviceLocal/RemoteException(...)&lt;/tt&gt; from calling &lt;tt&gt;fireBridgeFailed()&lt;/tt&gt;.  However, since the call to &lt;tt&gt;DemandForwardingBridgeSupport.stop()&lt;/tt&gt; is made by a separate thread, multiple &lt;tt&gt;serviceLocal/RemoteException(...)&lt;/tt&gt; calls that are made in quick succession can result in multiple calls to &lt;tt&gt;fireBridgeFailed()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This is the first race condition: multiple calls can be made to &lt;tt&gt;DiscoveryNetworkConnector.bridgeFailed()&lt;/tt&gt; for the same bridge.  By transitivity, this results in multiple calls to &lt;tt&gt;SimpleDiscoveryAgent.serviceFailed(...)&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;SimpleDiscoveryAgent.serviceFailed(...)&lt;/tt&gt; has a guard class, &lt;tt&gt;event.failed.compareAndSet(false, true)&lt;/tt&gt;, which should only allow the first call to launch a bridge reconnect thread.  However, once the &lt;tt&gt;reconnectDelay&lt;/tt&gt; expires, &lt;tt&gt;event.failed&lt;/tt&gt; is reset to &lt;tt&gt;false&lt;/tt&gt;, which allows re-entry to the failure handling logic, and the possibile launching of additional bridge reconnect threads if the &lt;tt&gt;reconnectDelay&lt;/tt&gt; is short or the threads calling &lt;tt&gt;serviceFailed(...)&lt;/tt&gt; are delayed.&lt;/p&gt;

&lt;p&gt;This is the second race condition: the guard clause in &lt;tt&gt;SimpleDiscoveryAgent.serviceFailed(...)&lt;/tt&gt; can be reset before the subsequent redundant calls have been filtered out.&lt;/p&gt;

&lt;p&gt;These two race conditions allow a single call to &lt;tt&gt;DiscoveryNetworkConnector.onServiceAdd(...)&lt;/tt&gt; to result in multiple subsequent concurrent (re)calls, and these concurrent calls can spawn their own multiple concurrent calls.  The result can be an unlimited number of concurrent calls to &lt;tt&gt;onServiceAdd(...)&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Unit Test&lt;br/&gt;
=========&lt;br/&gt;
The attached unit test demonstrates this bug by simulating a bridge failure that has yet to be detected by the remote broker (i.e., before the &lt;tt&gt;InactivityMonitor&lt;/tt&gt; closes the connection).  The local broker attempts to re-establish the bridge, but its call to &lt;tt&gt;DemandForwardingBridge.startRemoteBroker()&lt;/tt&gt; fails because the remote broker rejects the new connection since the old one still exists.  Since &lt;tt&gt;startRemoteBroker&lt;/tt&gt; sends multiple messages to the remote broker, multiple exceptions are generated:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;DemandForwardingBridgeSupport.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void startRemoteBridge() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
...
                remoteBroker.oneway(brokerInfo);
...
            remoteBroker.oneway(remoteConnectionInfo);
...
            remoteBroker.oneway(producerInfo);
...
                remoteBroker.oneway(demandConsumerInfo);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The multiple exceptions result in multiple calls to &lt;tt&gt;DemandForwardingBridgeSupport.serviceRemoteException(...)&lt;/tt&gt;, which allows the first race condition to be exhibited.  &lt;/p&gt;

&lt;p&gt;The first unit test has a 1s &lt;tt&gt;reconnectDelay&lt;/tt&gt;, which is sufficient to make the second race condition improbable; therefore, this test generally passes. &lt;/p&gt;

&lt;p&gt;The second unit test has a 0s &lt;tt&gt;reconnectDelay&lt;/tt&gt;; on my system, this makes the timing of multiple calls to &lt;tt&gt;DemandForwardingBridgeSupport.serviceRemoteException(...)&lt;/tt&gt; such that the second race condition is reliably exhibited, resulting in the unit test failing because it detects concurrent calls to &lt;tt&gt;DiscoveryNetworkConnector.onServiceAdd(...)&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Solution&lt;br/&gt;
========&lt;br/&gt;
While it would be possible to add a &lt;tt&gt;failed.compareAndSet(false,true)&lt;/tt&gt; guard clause to &lt;tt&gt;DemandForwardingBridgeSupport.fireBridgeFailed()&lt;/tt&gt;, and prevent the first race condition from allowing multiple calls to &lt;tt&gt;SimpleDiscoveryAgent.serviceFailed()&lt;/tt&gt;, the root problem is the race condition in &lt;tt&gt;serviceFailed&lt;/tt&gt;.  This can be trivially addressed by making a copy of the &lt;tt&gt;DiscoveryEvent&lt;/tt&gt;, which prevents the original &lt;tt&gt;event.failed&lt;/tt&gt; guard clause from being reset:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Patched SimpleDiscoveryAgent.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void serviceFailed(DiscoveryEvent devent) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {

    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SimpleDiscoveryEvent sevent = (SimpleDiscoveryEvent)devent;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sevent.failed.compareAndSet(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)) {

        listener.onServiceRemove(sevent);
        taskRunner.execute(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;() {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
                SimpleDiscoveryEvent event = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleDiscoveryEvent(sevent);

...
                event.connectTime = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis();
                event.failed.set(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
                listener.onServiceAdd(event);
            }
        }, &lt;span class=&quot;code-quote&quot;&gt;&quot;Simple Discovery Agent&quot;&lt;/span&gt;);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; </description>
                <environment></environment>
        <key id="12614669">AMQ-4159</key>
            <summary>Race condition in SimpleDiscoveryAgent creates multiple concurrent threads attempting to connect to the same bridge --- can result in deadlock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="stirlingc">Stirling Chow</reporter>
                        <labels>
                    </labels>
                <created>Sat, 3 Nov 2012 22:40:25 +0000</created>
                <updated>Thu, 2 May 2013 02:30:56 +0000</updated>
                            <resolved>Thu, 13 Dec 2012 23:36:41 +0000</resolved>
                                    <version>5.8.0</version>
                                    <fixVersion>5.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13490127" author="stirlingc" created="Sat, 3 Nov 2012 23:45:53 +0000"  >&lt;p&gt;Unit test that fails prior to patch, and passes after patch.&lt;/p&gt;</comment>
                            <comment id="13490677" author="tabish121" created="Mon, 5 Nov 2012 15:07:37 +0000"  >&lt;p&gt;This seems sensible.  Nice catch.&lt;/p&gt;</comment>
                            <comment id="13490688" author="tabish121" created="Mon, 5 Nov 2012 15:33:03 +0000"  >&lt;p&gt;Patch applied tests all passing locally. &lt;/p&gt;</comment>
                            <comment id="13490725" author="stirlingc" created="Mon, 5 Nov 2012 16:45:04 +0000"  >&lt;p&gt;Thanks for the fast turnaround, Timothy.  I linked &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4159&quot; title=&quot;Race condition in SimpleDiscoveryAgent creates multiple concurrent threads attempting to connect to the same bridge --- can result in deadlock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4159&quot;&gt;&lt;del&gt;AMQ-4159&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4160&quot; title=&quot;DiscoveryNetworkConnector can lose track of active bridges, resulting in permanent bridge failure or continued attempts to re-connect existing bridges&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4160&quot;&gt;&lt;del&gt;AMQ-4160&lt;/del&gt;&lt;/a&gt; together as they are related (at least the symptoms were observed during the same test that we were running).  Now that I think about it, the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4160&quot; title=&quot;DiscoveryNetworkConnector can lose track of active bridges, resulting in permanent bridge failure or continued attempts to re-connect existing bridges&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4160&quot;&gt;&lt;del&gt;AMQ-4160&lt;/del&gt;&lt;/a&gt; relies on &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4159&quot; title=&quot;Race condition in SimpleDiscoveryAgent creates multiple concurrent threads attempting to connect to the same bridge --- can result in deadlock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4159&quot;&gt;&lt;del&gt;AMQ-4159&lt;/del&gt;&lt;/a&gt; (i.e., one-to-one relationship between DiscoveryEvent and a bridge creation attempt).  It would be great if &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4160&quot; title=&quot;DiscoveryNetworkConnector can lose track of active bridges, resulting in permanent bridge failure or continued attempts to re-connect existing bridges&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4160&quot;&gt;&lt;del&gt;AMQ-4160&lt;/del&gt;&lt;/a&gt; could also be fixed for AMQ 5.8.0.&lt;/p&gt;</comment>
                            <comment id="13492345" author="gtully" created="Wed, 7 Nov 2012 13:43:45 +0000"  >&lt;p&gt;test org.apache.activemq.bugs.AMQ4159Test hangs on trunk from nov 6&lt;/p&gt;</comment>
                            <comment id="13493576" author="stirlingc" created="Thu, 8 Nov 2012 22:41:40 +0000"  >&lt;p&gt;I will look into this.  We run a local AMQ build on our build server and experienced the same hanging on AMQ4159Test.  Initial diagnosis indicates a timing issue between stopping the network connector and start it again &amp;#8212; it appears the restart is happening before the connections from the original bridge are fully-closed.&lt;/p&gt;</comment>
                            <comment id="13496681" author="stirlingc" created="Tue, 13 Nov 2012 23:53:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4159&quot; title=&quot;Race condition in SimpleDiscoveryAgent creates multiple concurrent threads attempting to connect to the same bridge --- can result in deadlock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4159&quot;&gt;&lt;del&gt;AMQ-4159&lt;/del&gt;&lt;/a&gt; stops the network connector and restarts it.  I just patched &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4160&quot; title=&quot;DiscoveryNetworkConnector can lose track of active bridges, resulting in permanent bridge failure or continued attempts to re-connect existing bridges&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4160&quot;&gt;&lt;del&gt;AMQ-4160&lt;/del&gt;&lt;/a&gt; to address an issue where activeEvents was not being cleared on DiscoveryNetworkConnector.handleStop &amp;#8212; as a result, the restart would be ignored.  This could have caused the hanging test, although I believe it occurred prior to the change for &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4160&quot; title=&quot;DiscoveryNetworkConnector can lose track of active bridges, resulting in permanent bridge failure or continued attempts to re-connect existing bridges&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4160&quot;&gt;&lt;del&gt;AMQ-4160&lt;/del&gt;&lt;/a&gt; that would have caused the restart to be ignored.&lt;/p&gt;

&lt;p&gt;I&apos;ve periodically seen bridge formation stop when the network connector is stopped and restarted in quick succession.  I&apos;m continuing to investigate.&lt;/p&gt;</comment>
                            <comment id="13531630" author="tabish121" created="Thu, 13 Dec 2012 23:36:41 +0000"  >&lt;p&gt;The issue described here seems to have been fully resolved.  The test isn&apos;t really showing much so I removed it from the build.  If you run into more problems along this line I&apos;d recommend trying to get a test working and reopen or create a new issue&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12614725">AMQ-4160</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12605058">AMQ-3993</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12552004" name="AMQ4159.patch" size="2345" author="stirlingc" created="Sat, 3 Nov 2012 23:47:24 +0000"/>
                            <attachment id="12552003" name="AMQ4159Test.java" size="6013" author="stirlingc" created="Sat, 3 Nov 2012 23:45:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>255090</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 49 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0eozr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>83811</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>