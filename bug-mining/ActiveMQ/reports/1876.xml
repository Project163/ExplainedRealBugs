<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:59:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4467] Memory usage percent can be exceeded much if PFC is disabled</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4467</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;If PFC is disabled, when the store cursor checks limits, it checks only the memory percentage of its own MemoryUsage and compares it to the high water mark. Otherwise if PFC is enabled, it checks whether the MemoryUsage is &quot;full&quot; but the &quot;isFull&quot; method also checks its parents.&lt;br/&gt;
This issue arrises when you have memory limits set on queues higher than the overall system limit, as well as if you have multiple queues who&apos;s memory limits combined are higher than the overall system limit. These settings must be taken into account.&lt;br/&gt;
The original form can be found at &lt;br/&gt;
&lt;a href=&quot;http://activemq.2283324.n4.nabble.com/What-can-be-reason-of-460-memory-usage-limit-td4665651.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.2283324.n4.nabble.com/What-can-be-reason-of-460-memory-usage-limit-td4665651.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12641980">AMQ-4467</key>
            <summary>Memory usage percent can be exceeded much if PFC is disabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="wangyin">SuoNayi</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Apr 2013 05:44:03 +0000</created>
                <updated>Thu, 25 May 2017 11:48:26 +0000</updated>
                            <resolved>Tue, 10 Jan 2017 11:22:38 +0000</resolved>
                                    <version>5.x</version>
                                    <fixVersion>5.15.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13628696" author="wangyin" created="Thu, 11 Apr 2013 05:49:41 +0000"  >&lt;p&gt;The test case is here,&lt;a href=&quot;http://activemq.2283324.n4.nabble.com/file/n4665800/MemoryUsageBrokerTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.2283324.n4.nabble.com/file/n4665800/MemoryUsageBrokerTest.java&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13628700" author="wangyin" created="Thu, 11 Apr 2013 05:55:22 +0000"  >&lt;p&gt;One simple solution is when the cursor calls the hasSpace method to see if it has space to cache messages we also check it&apos;s parent to see if it&apos;s full.&lt;br/&gt;
The patch is based on 5.6 codebase.&lt;/p&gt;</comment>
                            <comment id="13645498" author="dejanb" created="Tue, 30 Apr 2013 11:47:19 +0000"  >&lt;p&gt;This is now fixed with svn revision 1477574. Thanks for raising the issue and providing the test case.&lt;/p&gt;</comment>
                            <comment id="15812160" author="gtully" created="Mon, 9 Jan 2017 16:26:25 +0000"  >&lt;p&gt;The fix applies the cursor high water mark value to the shared system usage limit in error.&lt;br/&gt;
When checking if the shared or parent system usage is exhausted a value of 100% should be used while the per destination limit can be validated against the memoryUsageHighWaterMark via the perDestination percentUsage.&lt;/p&gt;

&lt;p&gt;This becomes apparent with low values for memoryUsageHighWaterMark. With N destinations, the shared system usage can easily exceed this low per destination value and starve dispatch/pageIn for subsequent destinations.&lt;/p&gt;</comment>
                            <comment id="15814697" author="jira-bot" created="Tue, 10 Jan 2017 11:18:27 +0000"  >&lt;p&gt;Commit c76f109692749b8bf7d7cd39ed75022875c39213 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=c76f109&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=c76f109&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4467&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-4467&lt;/a&gt; - modify fix check full against shared limit and high water mark against local limit, additional test&lt;/p&gt;</comment>
                            <comment id="15814705" author="gtully" created="Tue, 10 Jan 2017 11:22:38 +0000"  >&lt;p&gt;shared limit check now independent of the per destination watermark.&lt;/p&gt;</comment>
                            <comment id="15814885" author="christopher.l.shannon" created="Tue, 10 Jan 2017 12:48:58 +0000"  >&lt;p&gt;Good catch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;.  A couple things...., First, if memory usage now properly goes up to 100% usage across all destinations instead of stopping at the high water mark (typically 70%) will that ever effect paging in for dispatch?  I&apos;m pretty sure the pending cursors will still page in for dispatch and that the memory usage is just used for producers and not consumers but want to see if you could think of any scenarios where dispatch would stop.&lt;/p&gt;

&lt;p&gt;Second, should Topics honor this value as well? I.e. on this line in Topic &lt;a href=&quot;https://github.com/apache/activemq/blob/activemq-5.14.3/activemq-broker/src/main/java/org/apache/activemq/broker/region/Topic.java#L376&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/activemq-5.14.3/activemq-broker/src/main/java/org/apache/activemq/broker/region/Topic.java#L376&lt;/a&gt; memory usage is checked for full but should it honor the high water mark instead?&lt;/p&gt;</comment>
                            <comment id="15814953" author="gtully" created="Tue, 10 Jan 2017 13:21:25 +0000"  >&lt;p&gt;Thanks for the feedback @Christopher L], It can stop dispatch which is a little worrying alright. The reasoning is more from the intent of the linked issue: &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4494&quot; title=&quot;Cursor hasSpace() doesn&amp;#39;t check system usage&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4494&quot;&gt;&lt;del&gt;AMQ-4494&lt;/del&gt;&lt;/a&gt;, it there is no room for dispatch (due to bad configuration) then rather than OOM the vm, the limits are enforced and some in-memory messages need to be consumed before more can be paged in.&lt;br/&gt;
To have a better solution in this scenario - having a mechanism to purge the cache for inactive destinations would be needed. I guess gcInactiveDestinations would do it with a variant that just purged the cursor rather than deleted the messages.&lt;/p&gt;

&lt;p&gt;Peek at the additional test - it failed due to not being able to page in at 50% ( its high water mark) of the system limit. Now it will fail at 100% of the shared limit.&lt;/p&gt;

&lt;p&gt;Note: hasSpace is queried by the cursor prior to pageIn: &lt;a href=&quot;https://github.com/apache/activemq/blob/activemq-5.14.3/activemq-broker/src/main/java/org/apache/activemq/broker/region/cursors/QueueStorePrefetch.java#L118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/activemq-5.14.3/activemq-broker/src/main/java/org/apache/activemq/broker/region/cursors/QueueStorePrefetch.java#L118&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Topics use only the shared limit to gate pageIn for subscriptions.&lt;/p&gt;</comment>
                            <comment id="15815002" author="christopher.l.shannon" created="Tue, 10 Jan 2017 13:45:59 +0000"  >&lt;p&gt;Ah ok, I understand better now thanks for the explanation.  So the core behavior hasn&apos;t changed and now the usage just goes up to 100% if using multiple destinations.  Now that I think about it, I&apos;m pretty sure I&apos;ve seen this behavior happen where dispatch slows to a crawl down when memory usage hits the high water mark because future dispatched messages have to wait for messages to be acked as shown in your test at 50%.&lt;/p&gt;

&lt;p&gt;Purging the cursor is an interesting idea and I think would be a nice improvement.  Clearing out the the cursor cache if the destination is inactive so other active destinations get access to all of the memory certainly seems like the ideal solution.  If I get some time I will play around with this a little bit as a feature for the 5.15 release.&lt;/p&gt;</comment>
                            <comment id="16024604" author="jira-bot" created="Thu, 25 May 2017 11:44:07 +0000"  >&lt;p&gt;Commit 25f112c5c9a843f162296ad38eb79be47183e0be in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=25f112c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=25f112c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6687&quot; title=&quot;destination memory usage incorrect after flow control (PFC) sendTimeout and rollback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6687&quot;&gt;&lt;del&gt;AMQ-6687&lt;/del&gt;&lt;/a&gt; ensure transacted sends blocked on pfc do not resume after tx completion. &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4467&quot; title=&quot;Memory usage percent can be exceeded much if PFC is disabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4467&quot;&gt;&lt;del&gt;AMQ-4467&lt;/del&gt;&lt;/a&gt; refine the fix such that PFC kicks in such that the cache will accept messsages that push it over it&apos;s limit while it is still under the limit&lt;/p&gt;</comment>
                            <comment id="16024609" author="gtully" created="Thu, 25 May 2017 11:48:26 +0000"  >&lt;p&gt;With transactions or concurrentStoreAndDispatch - memory is accounted for before it reaches the cache which typically means that the cursor cache stops accepting messages early. If we want the cache and PFC we have to let the cache consume &amp;gt;100% of memory. To achieve this we must set the cursorHighWaterMark&amp;gt;100% something like 120% such that it will still allow a message to be cached while is is &amp;lt;100 that will put it over the 100% (full) limit.&lt;br/&gt;
Ie: we check is full and we are at 99%, we accept another message that pushes us to 101%, without a cursorHighWaterMark &amp;gt; 101 the cursor won&apos;t cache and will stick at 99% and producer flow control (PFC) won&apos;t kick in.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12645233">AMQ-4494</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="13074810">AMQ-6687</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12578163" name="AMQ-4467.patch" size="391" author="wangyin" created="Thu, 11 Apr 2013 05:55:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>322394</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 25 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1jmhr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>322739</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>