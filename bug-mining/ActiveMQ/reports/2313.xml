<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:05:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5125] Broker and clients hang</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5125</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;JMS clients start to hang after a while in calls such as session.createObjectMessage(). Both the broker and the hanging clients can&apos;t be easily shut down when this happens - only forcefully applied kill&apos;s do the job.&lt;/p&gt;

&lt;p&gt;I&apos;m using queues and transactional sessions. All clients (producers and consumers) are in the same Java VM. There is only one JMS connection between the application and the broker. Each client has its own session, but they all share the same connection.&lt;/p&gt;

&lt;p&gt;Normally, the data directory of the LevelDb contains only a few log files. But in my case, the number of log files is steadily increasing.&lt;/p&gt;

&lt;p&gt;Furthermore, I was able to track down the issue to following circumstance: The problem only occurs, when consumers do a rollback instead of a commit when they receive the message. The rollback / redelivery works as expected - the same message is received again after a previous rollback.&lt;/p&gt;

&lt;p&gt;As far as I can tell, the problem does not occur with KahaDb.&lt;/p&gt;

&lt;p&gt;I&apos;ll attach a test program that provokes the error. It sets up a few hundred queues, consumers and producers. The consumers just receive the message and commit the session, but they also do &quot;random&quot; rollbacks. It can be observed immediately that the number of files starts increasing in the data directory. After a few minutes, the clients hang - sometimes sooner, sometimes later. I&apos;ll also attach the config file for the broker.&lt;/p&gt;

&lt;p&gt;I am aware, that heavy rollbacking should not happen in normal operation. But from a long term stability perspective, this is a blocker for us.&lt;/p&gt;
</description>
                <environment>&lt;p&gt;Windows 7, Linux&lt;br/&gt;
JAVA_HOME=C:\Program Files\Java\jdk1.7.0_07&lt;br/&gt;
ActiveMQ 5.9.0 with LevelDB storage adapter enabled&lt;/p&gt;</environment>
        <key id="12704250">AMQ-5125</key>
            <summary>Broker and clients hang</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Albert Barmettler">Albert Barmettler</reporter>
                        <labels>
                    </labels>
                <created>Fri, 28 Mar 2014 13:45:08 +0000</created>
                <updated>Tue, 16 Dec 2014 00:07:01 +0000</updated>
                            <resolved>Mon, 7 Jul 2014 21:55:33 +0000</resolved>
                                    <version>5.9.0</version>
                    <version>5.10.0</version>
                                    <fixVersion>5.10.1</fixVersion>
                    <fixVersion>5.11.0</fixVersion>
                                        <due></due>
                            <votes>4</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="13950718" author="albert barmettler" created="Fri, 28 Mar 2014 13:49:12 +0000"  >&lt;p&gt;Test program&lt;/p&gt;</comment>
                            <comment id="13950720" author="albert barmettler" created="Fri, 28 Mar 2014 13:50:23 +0000"  >&lt;p&gt;Default configuration file as shipped with ActiveMQ. LevelDb enabled.&lt;/p&gt;</comment>
                            <comment id="13950724" author="albert barmettler" created="Fri, 28 Mar 2014 13:52:46 +0000"  >&lt;p&gt;The last minutes of the Java VM of the ActiveMQ.&lt;/p&gt;</comment>
                            <comment id="13950727" author="tabish121" created="Fri, 28 Mar 2014 13:54:13 +0000"  >&lt;p&gt;Recommend you test against a recent 5.10-SNAPSHOT which contains a great many fixes for LevelDB, you can make it simpler by turning your test into a JUnit test and drop it into the ActiveMQ source or create a simple maven project that allows you to quickly change version numbers. &lt;/p&gt;</comment>
                            <comment id="13958980" author="albert barmettler" created="Thu, 3 Apr 2014 17:08:09 +0000"  >&lt;p&gt;The problem seems to exist in the recent 5.10 snapshot as well. After a few minutes of brokering, the system comes to a halt. I attached the thread dumps of the broker and the clients. The broker seems to hang in a rollback.&lt;/p&gt;

&lt;p&gt;I observed that the number of LevelDB log files does &lt;b&gt;not&lt;/b&gt; steadily increase anymore as it did in 5.9.0. &lt;/p&gt;

&lt;p&gt;Regarding the operating system: I ran reproduced the issue on Windows 7 with the attached test program. We observed the problem on Linux as well, but I haven&apos;t ran my test program on this platform.&lt;/p&gt;</comment>
                            <comment id="14018713" author="blondacz" created="Thu, 5 Jun 2014 11:57:06 +0000"  >&lt;p&gt;Same issue happening to us not every time but quite often on very small load and even with just one rollback. The all threads are BLOCKED. The version is  5.9.0.&lt;/p&gt;</comment>
                            <comment id="14019717" author="saket" created="Fri, 6 Jun 2014 09:51:37 +0000"  >&lt;p&gt;We  have a similar issue for which I posted a message on the user forums. There is a performance test attached there which can be used to reproduce this.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://activemq.2283324.n4.nabble.com/ActiveMQ-message-dequeuing-hangs-td4681366.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.2283324.n4.nabble.com/ActiveMQ-message-dequeuing-hangs-td4681366.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14047662" author="ceposta" created="Mon, 30 Jun 2014 13:44:00 +0000"  >&lt;p&gt;Any chance you can see if having producers/consumers on separate connections make a difference?&lt;/p&gt;</comment>
                            <comment id="14053690" author="jameshome" created="Mon, 7 Jul 2014 14:19:48 +0000"  >&lt;p&gt;I believe the issue that this ticket was raised against is the same one described here (same link as above), which badavis has analysed in his recent post:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://activemq.2283324.n4.nabble.com/ActiveMQ-message-dequeuing-hangs-td4681366.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.2283324.n4.nabble.com/ActiveMQ-message-dequeuing-hangs-td4681366.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve gone through the code, and I agree with his findings.&lt;/p&gt;

&lt;p&gt;I&apos;ve attached a patch to 5.9.2 based on this, in which LevelDBStore uses an internal private lock variable instead of &lt;em&gt;this&lt;/em&gt;, which removes the deadlock that can happen when the LocalTransaction synchronises externally on the transactionStore during a rollback.&lt;/p&gt;

&lt;p&gt;Using this patch, the original (attached) test runs for hours without deadlocking, as do my own tests that previously deadlocked after a few thousand messages.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;James&lt;/p&gt;
</comment>
                            <comment id="14053788" author="blondacz" created="Mon, 7 Jul 2014 15:57:35 +0000"  >&lt;p&gt;Nice!!! &lt;/p&gt;


&lt;p&gt;&amp;#8211; &lt;br/&gt;
Sent from my Android device with K-9 Mail. Please excuse my brevity.&lt;/p&gt;</comment>
                            <comment id="14054203" author="tabish121" created="Mon, 7 Jul 2014 21:55:33 +0000"  >&lt;p&gt;Reviewed all the mailing list discussion and the threads dumps and the analysis is correct, the lock cannot be the LevelDBStore object since that can lead to  a lock in the hawtDispatch serialization thread runner if a task is modifying mutable state and needs to protect data that also accessible on the public store API. &lt;/p&gt;

&lt;p&gt;Patch applied with thanks. &lt;/p&gt;</comment>
                            <comment id="14054450" author="badavis" created="Tue, 8 Jul 2014 02:54:28 +0000"  >&lt;p&gt;Awesome that this is getting fixed.  Thank you James for fixing this.  I apologize if this is the wrong form for this, I am new to this type of development.  The other issue I noticed from my analysis is the GCPolling job and the rollback job got scheduled to the same thread at the same time in the hawtdispatcher.  It just so happens that the GCPoll job got ran first.  My system had many dispatch threads available but all the jobs only went to the one dispatch thread causing the deadlock.  Could you tell me the reasoning this is not a concern?  I personally would like to understand this better.  Thank you.&lt;/p&gt;

&lt;p&gt;Brian&lt;/p&gt;</comment>
                            <comment id="14054964" author="tabish121" created="Tue, 8 Jul 2014 14:07:23 +0000"  >&lt;p&gt;The reason is simple, the serial execution of tasks protects from concurrent modification of mutable state in the LeveDB store.  If the tasks executed on multiple threads concurrently then the code would need to be drastically more protective of all mutable state in the store and you&apos;d see a lot more locking and most likely threading related bugs. The reason for the small number of synchronized areas is to protect those bits that are exposed by the persistence adapter API which need to read or modify some things that are also modified on the dispatch thread.  &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12654320" name="AMQ-5125_made_synchronization_in_LevelDBStore_use_private_lock.5.9.2.patch" size="3403" author="jameshome" created="Mon, 7 Jul 2014 14:19:48 +0000"/>
                            <attachment id="12638520" name="Broker-threaddump-1396544622970.tdump" size="48180" author="Albert Barmettler" created="Thu, 3 Apr 2014 17:08:09 +0000"/>
                            <attachment id="12638519" name="Clients-threaddump-1396544622970.tdump" size="306160" author="Albert Barmettler" created="Thu, 3 Apr 2014 17:08:09 +0000"/>
                            <attachment id="12637401" name="VM.PNG" size="46973" author="Albert Barmettler" created="Fri, 28 Mar 2014 13:52:46 +0000"/>
                            <attachment id="12637400" name="activemq.xml" size="5801" author="Albert Barmettler" created="Fri, 28 Mar 2014 13:50:23 +0000"/>
                            <attachment id="12648470" name="broker-threads-blocked.tdump" size="79320" author="blondacz" created="Thu, 5 Jun 2014 11:57:06 +0000"/>
                            <attachment id="12637399" name="src.zip" size="6107" author="Albert Barmettler" created="Fri, 28 Mar 2014 13:49:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>382584</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 20 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1twuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>382852</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>