<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:33:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-724] Stomp client is not removed from the broker on client disconnect</title>
                <link>https://issues.apache.org/jira/browse/AMQ-724</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;If Stomp client crashes (or disconnects unexpectedly) when there are unconsumed messages in the broker, the subscriptions are not removed from the broker and some phantom consumer is still consuming messages. If you connect other client, it receives only half messages (other half messages goes to that phantom consumer still left afrter client disconnect). There are no error logs in activemq logs. We are using stomp client, whith client acknowledge mode, so on broker restart, all messages are delivered properly. You can also see in jmx console, that subscription still exists whithout any connection left.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux, Java 1.5.0_06&lt;/p&gt;</environment>
        <key id="12482206">AMQ-724</key>
            <summary>Stomp client is not removed from the broker on client disconnect</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="jurna">Danielius Jurna</reporter>
                        <labels>
                    </labels>
                <created>Fri, 26 May 2006 00:13:36 +0000</created>
                <updated>Fri, 12 Dec 2008 12:41:48 +0000</updated>
                            <resolved>Mon, 7 Jul 2008 19:25:28 +0000</resolved>
                                    <version>4.0</version>
                                    <fixVersion>5.2.0</fixVersion>
                                    <component>Transport</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>4</watches>
                                                                                                                                                            <comments>
                            <comment id="12937882" author="jurna" created="Mon, 29 May 2006 07:17:49 +0000"  >&lt;p&gt;TestCase which shows this bug - takes time to complete.&lt;/p&gt;</comment>
                            <comment id="12938048" author="jurna" created="Mon, 29 May 2006 07:24:44 +0000"  >&lt;p&gt;The problem I found is whith both stomp transport and broker iself.&lt;br/&gt;
Somehow Stomp subscription starts prefetching and sending messages before it adds Consumer to the broker. If connection during this prefetching is lost, connection is removed, but subscription is still added.&lt;/p&gt;

&lt;p&gt;There is quick  hack for that in AbstractConnection.processAddConsumer(): &lt;/p&gt;

&lt;p&gt;    public Response processAddConsumer(ConsumerInfo info) throws Exception {&lt;br/&gt;
        SessionId sessionId = info.getConsumerId().getParentId();&lt;br/&gt;
        ConnectionId connectionId = sessionId.getParentId();&lt;br/&gt;
        ConnectionState cs = lookupConnectionState(connectionId);&lt;br/&gt;
        SessionState ss = cs.getSessionState(sessionId);&lt;br/&gt;
        if( ss == null )&lt;br/&gt;
            throw new IllegalStateException(&quot;Cannot add a consumer to a session that had not been registered: &quot;+sessionId);&lt;br/&gt;
        log.trace(&quot;Adding consumer to broker. Stomp client blocks here - waiting for prefetching to complete.&quot;);&lt;br/&gt;
        broker.addConsumer(cs.getContext(), info);&lt;br/&gt;
        try &lt;/p&gt;
{
        		lookupConnectionState(connectionId);
        }
&lt;p&gt; catch (IllegalStateException ex) &lt;/p&gt;
{
        		// If during broker.addConsumer() exception occures, connection is destroyed. We need to remove consumer
        		log.warn(&quot;Cannot find connection after adding subscription! Probably error when prefetching messages&quot;, ex);
        		broker.removeConsumer(cs.getContext(), info);
        		throw ex;
        }
&lt;p&gt;        ss.addConsumer(info);&lt;br/&gt;
        return null;&lt;br/&gt;
    }&lt;/p&gt;</comment>
                            <comment id="12937810" author="chirino" created="Sun, 2 Jul 2006 20:43:32 +0000"  >&lt;p&gt;Expanded your &apos;hack&apos; so that it&apos;s less hacky.  The connection and session state now keep track if they are being shutdown.&lt;/p&gt;

&lt;p&gt;Fix committed to trunk revision 418592.&lt;/p&gt;</comment>
                            <comment id="12936304" author="chirino" created="Sun, 2 Jul 2006 21:30:46 +0000"  >&lt;p&gt;Fix apply to 4.0 trunk also.&lt;/p&gt;</comment>
                            <comment id="12938432" author="snacktime" created="Fri, 13 Oct 2006 04:37:24 +0000"  >&lt;p&gt;This is not fixed as of 4.0.2 RC4, or at least there is another bug with the exact same behavior.  Wasn&apos;t hard to duplicate either, just kill a stomp connection while it&apos;s reading and bam, phantom consumer. &lt;/p&gt;</comment>
                            <comment id="12938670" author="jurna" created="Tue, 5 Dec 2006 06:44:14 +0000"  >&lt;p&gt;I wonder how this bug has slipped through unit tests. I&apos;m adding patch for org.apache.activemq.state.SessionState&lt;/p&gt;</comment>
                            <comment id="12938657" author="jurna" created="Tue, 5 Dec 2006 06:45:57 +0000"  >&lt;p&gt;This patch is against 4.0 branch. This bug is also in 4.1 branch&lt;/p&gt;</comment>
                            <comment id="12936760" author="jurna" created="Fri, 12 Jan 2007 06:23:02 +0000"  >&lt;p&gt;Is is possible for the provided patch to be applied for 4.2 version?&lt;/p&gt;</comment>
                            <comment id="12938759" author="tvijlbrief" created="Sun, 28 Jan 2007 11:44:53 +0000"  >&lt;p&gt;When using the C++ Openwire client I&apos;m having the same problems when the client crashes.&lt;/p&gt;

&lt;p&gt;I&apos;m testing against the current SVN repo version.&lt;/p&gt;

&lt;p&gt;After 5 runs I have 5 pending openwire connections, although &quot;netstat -t&quot;&lt;br/&gt;
shows that they are closed.&lt;/p&gt;
</comment>
                            <comment id="12938813" author="tvijlbrief" created="Sun, 28 Jan 2007 11:46:07 +0000"  >&lt;p&gt;Pending connections although the TCP connections are really closed&lt;/p&gt;</comment>
                            <comment id="12938734" author="tvijlbrief" created="Sun, 28 Jan 2007 14:26:23 +0000"  >&lt;p&gt;PATCH&lt;br/&gt;
======&lt;/p&gt;

&lt;p&gt;Not sure if it is this simple but this patch seems to work OK.&lt;/p&gt;

&lt;p&gt;The connections are now freeed when a fresh client connects...&lt;/p&gt;
</comment>
                            <comment id="12938753" author="tvijlbrief" created="Mon, 29 Jan 2007 05:41:33 +0000"  >&lt;p&gt;Retried the tests without the patch applied but see no difference now, so you can ignore it.&lt;br/&gt;
Apparently a fix was already in the SVN version, my  patch is a no-op. :-/&lt;/p&gt;

&lt;p&gt;Terminating the Stomp connections in the current SVN version seems to work OK.&lt;/p&gt;

&lt;p&gt;Terminating OpenWire connections from a  CPP client still leaves connections hanging.&lt;/p&gt;

&lt;p&gt;I&apos;ll try to investigate this problem further.&lt;/p&gt;</comment>
                            <comment id="12938793" author="jurna" created="Mon, 29 Jan 2007 06:40:30 +0000"  >&lt;p&gt;There is a clear bug in SessionState class. EIther you have to fix this bug, o remove SessionState functionality, if it&apos;s not used.&lt;br/&gt;
When broker shuts down session, it sets shutdown flag on session state. But currently in the code instead of true it sets false (which means that session is not shut down).&lt;br/&gt;
The bug is not releted with connections which are not removed. The problem occures when connection is removed, but subscription is not. It&apos;s not easy to reproduce this bug. You have to kill stomp connection during message prefetch (within a second after connection is established and subscribtion is made).&lt;/p&gt;</comment>
                            <comment id="12938702" author="mronner" created="Mon, 29 Jan 2007 14:25:12 +0000"  >&lt;p&gt;That&apos;s how you can reproduce it:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;$ netcat -v -c localhost 61613 &amp;lt; StompScriptComplete.txt&lt;/tt&gt;&lt;br/&gt;
&lt;b&gt;CONNECT&lt;/b&gt;, &lt;b&gt;SEND&lt;/b&gt; a message and &lt;b&gt;DISCONNECT&lt;/b&gt; properly.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;$ netcat -v -c localhost 61613 &amp;lt; StompScriptNoDisconnect.txt&lt;/tt&gt;&lt;br/&gt;
&lt;b&gt;CONNECT&lt;/b&gt;, &lt;b&gt;SEND&lt;/b&gt; a message and closes the connection &lt;font color=&quot;red&quot;&gt;without&lt;/font&gt; &lt;b&gt;DISCONNECT&lt;/b&gt;.&lt;/p&gt;</comment>
                            <comment id="12938742" author="mronner" created="Tue, 30 Jan 2007 10:40:45 +0000"  >&lt;p&gt;Try &lt;tt&gt;netcat&lt;/tt&gt; also without &lt;tt&gt;-c&lt;/tt&gt; (close connection on EOF from stdin)...&lt;/p&gt;

&lt;p&gt;The connection will be closed by the server in the first example.&lt;br/&gt;
In the second example you have to break it &lt;tt&gt;^C&lt;/tt&gt; manually. This leaves an open session on the server.&lt;/p&gt;</comment>
                            <comment id="12936439" author="tvijlbrief" created="Tue, 30 Jan 2007 18:29:02 +0000"  >&lt;p&gt;I&apos;m confused. When I try the netcat example with NoDisconnect in the current SVN version&lt;br/&gt;
everything is rock solid.&lt;/p&gt;

&lt;p&gt;When I interrupt a C++ OpenWire client than I get non closed connections.&lt;/p&gt;

&lt;p&gt;I found a possible cure for the last problem. The InactivityMonitor code reads:&lt;/p&gt;

&lt;p&gt;public void onException(IOException error) {&lt;br/&gt;
    	if( monitorStarted.get() ) &lt;/p&gt;
{
	        stopMonitorThreads();
	        getTransportListener().onException(error);
    	}
&lt;p&gt;    }&lt;/p&gt;

&lt;p&gt;So if monitorStarted is false the EOFException is completely ignored!&lt;br/&gt;
I assume it should be:&lt;/p&gt;

&lt;p&gt;public void onException(IOException error) {&lt;br/&gt;
    	if( monitorStarted.get() ) &lt;/p&gt;
{
	        stopMonitorThreads();
    	}
&lt;p&gt;    	getTransportListener().onException(error); // tom.vijlbrief&lt;br/&gt;
    }&lt;/p&gt;


&lt;p&gt;Attached a patch. With this patch the OpenWire sessions are closed.&lt;/p&gt;</comment>
                            <comment id="12938752" author="tvijlbrief" created="Tue, 30 Jan 2007 18:30:07 +0000"  >&lt;p&gt;Patch for pending OpenWire connections&lt;/p&gt;</comment>
                            <comment id="12936375" author="jstrachan" created="Fri, 23 Feb 2007 06:04:25 +0000"  >&lt;p&gt;I&apos;ve just applied Tom&apos;s latest patch for OpenWire connections - thanks Tom!&lt;/p&gt;</comment>
                            <comment id="12939935" author="rajdavies" created="Mon, 7 Jul 2008 19:25:28 +0000"  >&lt;p&gt;The associated patches no longer look valid for the current 5.2/trunk codebase.&lt;br/&gt;
You can on the broker url in the broker config to define options to directly close the sockets - instead of using a separate thread in 5.2 - &lt;br/&gt;
e.g tcp://localhost:61616?socket.closeAsync=false&lt;/p&gt;</comment>
                            <comment id="12940551" author="kfrugia" created="Wed, 10 Dec 2008 19:27:12 +0000"  >&lt;p&gt;Is there a similar option to socket.closeAsync for activemq cpp?  Is this documented anywhere?&lt;/p&gt;</comment>
                            <comment id="12940580" author="dejanb" created="Thu, 11 Dec 2008 14:37:01 +0000"  >&lt;p&gt;socket.closeAsync is a broker-side configuration option, so it should work with cpp as well.&lt;/p&gt;</comment>
                            <comment id="12940557" author="kfrugia" created="Thu, 11 Dec 2008 16:48:29 +0000"  >&lt;p&gt;Ok.  It would be nice if this was documented in the activemq cpp documentation.  Other URI options are documented.  I was looking for something like this, but was unaware this was an option.&lt;/p&gt;</comment>
                            <comment id="12940553" author="dejanb" created="Fri, 12 Dec 2008 12:41:48 +0000"  >&lt;p&gt;I&apos;ve updated tcp transport reference page (&lt;a href=&quot;http://cwiki.apache.org/confluence/display/ACTIVEMQ/TCP+Transport+Reference&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cwiki.apache.org/confluence/display/ACTIVEMQ/TCP+Transport+Reference&lt;/a&gt;). Thanks&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12482841">AMQ-844</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12482231">AMQ-1067</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12482239">AMQ-1805</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12460888" name="SessionState.patch" size="321" author="jurna" created="Tue, 5 Dec 2006 06:45:57 +0000"/>
                            <attachment id="12460763" name="StompScriptComplete.txt" size="119" author="mronner" created="Mon, 29 Jan 2007 14:25:10 +0000"/>
                            <attachment id="12460545" name="StompScriptNoDisconnect.txt" size="105" author="mronner" created="Mon, 29 Jan 2007 14:25:11 +0000"/>
                            <attachment id="12460784" name="StompSubscriptionRemoveTest.java" size="6906" author="jurna" created="Mon, 29 May 2006 07:17:49 +0000"/>
                            <attachment id="12460793" name="dumpemu4.png" size="40538" author="tvijlbrief" created="Sun, 28 Jan 2007 11:46:07 +0000"/>
                            <attachment id="12460819" name="patch.txt" size="633" author="tvijlbrief" created="Sun, 28 Jan 2007 14:26:19 +0000"/>
                            <attachment id="12460572" name="patchInactivityMonitor.txt" size="769" author="tvijlbrief" created="Tue, 30 Jan 2007 18:30:07 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12482078">AMQ-1300</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84348</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 50 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s1lj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161735</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>