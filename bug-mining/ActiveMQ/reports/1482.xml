<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:53:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3681] DatabaseLocker should first cancel locking SQL statement before closing the SQL connection</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3681</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;ActiveMQ is configured in a Master/Slave configuration with an Oracle database :&lt;br/&gt;
&lt;a href=&quot;http://activemq.apache.org/jdbc-master-slave.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/jdbc-master-slave.html&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://servicemix.apache.org/clustering.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://servicemix.apache.org/clustering.html&lt;/a&gt;&lt;br/&gt;
When the slave node is stopping, &quot;activemq-broker&quot; stays forever in the &quot;Stopping&quot; state.&lt;br/&gt;
This is because the locking SQL statement cannot be interrupted by just closing the JDBC connection.  It is also needed to &quot;cancel&quot; the SQL statement.&lt;br/&gt;
Here is a patch to DefaultDatabaseLocker which makes it compatible with Oracle.&lt;br/&gt;
Thanks.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-92&quot;&lt;/span&gt; prio=10 tid=0x08c4d800 nid=0x1036 waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; monitor entry [0x8ab3a000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: BLOCKED (on object monitor)
	at oracle.jdbc.driver.PhysicalConnection.isClosed(PhysicalConnection.java:1223)
	- waiting to lock &amp;lt;0xad4367e0&amp;gt; (a oracle.jdbc.driver.T4CConnection)
	at org.apache.commons.dbcp.DelegatingConnection.isClosed(DelegatingConnection.java:386)
	at org.apache.commons.dbcp.DelegatingConnection.isClosed(DelegatingConnection.java:386)
	at org.apache.commons.dbcp.PoolingDataSource$PoolGuardConnectionWrapper.isClosed(PoolingDataSource.java:201)
	at org.apache.activemq.store.jdbc.DefaultDatabaseLocker.stop(DefaultDatabaseLocker.java:137)
	at com.mycompany.PoolCloser.close(PoolCloser.java:77)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at java.lang.reflect.Method.invoke(Method.java:597)
	at org.apache.aries.blueprint.utils.ReflectionUtils.invoke(ReflectionUtils.java:221)
	at org.apache.aries.blueprint.container.ServiceListener.invokeMethod(ServiceListener.java:98)
	at org.apache.aries.blueprint.container.ServiceListener.unregister(ServiceListener.java:65)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;ServiceMix 4.3&lt;/p&gt;</environment>
        <key id="12539772">AMQ-3681</key>
            <summary>DatabaseLocker should first cancel locking SQL statement before closing the SQL connection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="metatech">metatech</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Jan 2012 14:41:47 +0000</created>
                <updated>Mon, 16 Apr 2012 13:29:57 +0000</updated>
                            <resolved>Mon, 16 Apr 2012 13:29:57 +0000</resolved>
                                    <version>5.4.2</version>
                                    <fixVersion>5.6.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="3600">1h</timeoriginalestimate>
                            <timeestimate seconds="3600">1h</timeestimate>
                                        <comments>
                            <comment id="13193872" author="metatech" created="Thu, 26 Jan 2012 14:49:33 +0000"  >&lt;p&gt;Another problem that can occur : &lt;br/&gt;
when the network cable is unplugged, the ActiveMQ shutdown hook freezes because it cannot close the connection, which is locked by the &quot;DefaultDatabaseLocker.keepAlive&quot; method.  The &quot;kill&quot; command does not work, &quot;kill -9&quot; is needed.&lt;br/&gt;
Here is a second patch that also fixes this problem.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;ActiveMQ ShutdownHook&quot;&lt;/span&gt; daemon prio=5 &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; id=73 BLOCKED
	oracle.jdbc.driver.PhysicalConnection.isClosed(PhysicalConnection.java:1223)
	org.apache.commons.dbcp.DelegatingConnection.isClosed(DelegatingConnection.java:386)
	org.apache.commons.dbcp.DelegatingConnection.isClosed(DelegatingConnection.java:386)
	org.apache.commons.dbcp.PoolingDataSource$PoolGuardConnectionWrapper.isClosed(PoolingDataSource.java:201)
	org.apache.activemq.store.jdbc.DefaultDatabaseLocker.stop(DefaultDatabaseLocker.java:137)
	org.apache.activemq.store.jdbc.JDBCPersistenceAdapter.stop(JDBCPersistenceAdapter.java:328)
	org.apache.activemq.util.ServiceStopper.stop(ServiceStopper.java:41)
	org.apache.activemq.broker.BrokerService.stop(BrokerService.java:583)
	org.apache.activemq.broker.BrokerService.containerShutdown(BrokerService.java:1971)
	org.apache.activemq.broker.BrokerService$4.run(BrokerService.java:1938)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13253148" author="rajdavies" created="Fri, 13 Apr 2012 05:58:26 +0000"  >&lt;p&gt;patch applied in SVN revision 1325621&lt;/p&gt;</comment>
                            <comment id="13254660" author="gtully" created="Mon, 16 Apr 2012 12:43:07 +0000"  >&lt;p&gt;Unfortunately the embedded derby jdbc store used in the unit tests does not support java.sql.Statement#setQueryTimeout&lt;/p&gt;

&lt;p&gt;We need to use it in an oracle specific lock implementation of make its use configurable&lt;/p&gt;

&lt;p&gt;org.apache.activemq.usecases.JdbcDurableSubDupTest demonstrates&lt;/p&gt;</comment>
                            <comment id="13254663" author="gtully" created="Mon, 16 Apr 2012 12:54:01 +0000"  >&lt;p&gt;hmm. well derby should have it once we upgrade&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, can any one easily validate mysql or mssqlserver?&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-31&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DERBY-31&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13254682" author="gtully" created="Mon, 16 Apr 2012 13:29:57 +0000"  >&lt;p&gt;junit tests are ok with the latest derby and looks like current versions of mysql and mssqlserver have support but not postgresql.&lt;br/&gt;
Making this conditional on queryTimeout attribute &amp;gt; 0 to that it can be disabled via configuration on the default database locker. Default value 10seconds.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/viewvc?rev=1326610&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1326610&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12537523">AMQ-3654</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12541076">AMQ-3696</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12511840" name="amq_stopping_slave.patch" size="2445" author="metatech" created="Wed, 25 Jan 2012 14:43:00 +0000"/>
                            <attachment id="12511985" name="amq_stopping_slave_2.patch" size="4436" author="metatech" created="Thu, 26 Jan 2012 14:50:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>225275</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 32 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0agqn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>58985</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>