<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:45:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2670] ClassCast Exception in JBoss when using XA </title>
                <link>https://issues.apache.org/jira/browse/AMQ-2670</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;When deploying the rar under JBoss, the connectionfactory bound in de JNDI tree is always of type &apos;ActiveMQConnectionFactory&apos;., while it should be ActiveMQXAConnectionFactory (which implements XAConnectionFactory).&lt;/p&gt;

&lt;p&gt;I attached a new class that creates the correct type of factory, and this can be configured in the ra.xml (also attached).&lt;/p&gt;</description>
                <environment>&lt;p&gt;activemq-rar-5.3.0.rar deployed in jboss-5.1.0-GA&lt;/p&gt;</environment>
        <key id="12483181">AMQ-2670</key>
            <summary>ClassCast Exception in JBoss when using XA </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="edwin@finalist.com">Edwin van der Elst</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Mar 2010 11:33:49 +0000</created>
                <updated>Tue, 30 Mar 2010 14:23:13 +0000</updated>
                            <resolved>Tue, 30 Mar 2010 14:03:59 +0000</resolved>
                                    <version>5.3.0</version>
                                    <fixVersion>5.4.0</fixVersion>
                                    <component>Connector</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12942251" author="edwin@finalist.com" created="Thu, 25 Mar 2010 11:36:52 +0000"  >&lt;p&gt;Note, for recovery to work (and for the original error to occur), a configuration in jbossts-properties.xml must be added, like this:&lt;br/&gt;
	&amp;lt;property name=&quot;com.arjuna.ats.jta.recovery.XAResourceRecovery.ACTIVEMQ&quot;&lt;br/&gt;
       value=&quot;org.jboss.jms.server.recovery.MessagingXAResourceRecovery;java:/ActiveMQJMSProvider&quot;/&amp;gt;&lt;/p&gt;</comment>
                            <comment id="12942204" author="gtully" created="Thu, 25 Mar 2010 12:07:06 +0000"  >&lt;p&gt;can you post an ejb or mdb descriptor that uses this. This looks like a use case where the RAR provides the connection factory but not the recovery contract, is that correct? With the RAR contract, the XAResource would normally be accessed via the javax.resource.spi.ResourceAdapter#getXAResources&lt;/p&gt;

&lt;p&gt;With the new class, the RAR can be bypassed w.r.t to recovery, or just used as an easy way to deploy ActiveMQ to jboss. Am I missing something?&lt;/p&gt;</comment>
                            <comment id="12942261" author="edwin@finalist.com" created="Thu, 25 Mar 2010 12:42:55 +0000"  >&lt;p&gt;An mdb:&lt;br/&gt;
@MessageDriven(mappedName = &quot;jms/SimpleMDB&quot;, messageListenerInterface = javax.jms.MessageListener.class, activationConfig = &lt;/p&gt;
{
        @ActivationConfigProperty(propertyName = &quot;destination&quot;, propertyValue = &quot;queue.test&quot;),
        @ActivationConfigProperty(propertyName = &quot;destinationType&quot;, propertyValue = &quot;javax.jms.Queue&quot;),
        @ActivationConfigProperty(propertyName = &quot;subscriptionDurability&quot;, propertyValue = &quot;NonDurable&quot;),
        @ActivationConfigProperty(propertyName = &quot;maximumRedeliveries&quot;, propertyValue = &quot;0&quot;) }
&lt;p&gt;)&lt;br/&gt;
@ResourceAdapter(value = &quot;activemq-rar-5.3.0.rar&quot;)&lt;br/&gt;
public class SimpleMDB implements MessageListener {&lt;br/&gt;
...&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;But it is not related to the MDB. The problem is that the connectionfactory is not the XA variant. This is deployed in a -ds.xml ike this:&lt;br/&gt;
&amp;lt;connection-factories&amp;gt;&lt;/p&gt;

&lt;p&gt;   &amp;lt;tx-connection-factory&amp;gt;&lt;br/&gt;
      &amp;lt;jndi-name&amp;gt;activemq/QueueConnectionFactory&amp;lt;/jndi-name&amp;gt;&lt;br/&gt;
      &amp;lt;xa-transaction/&amp;gt;&lt;br/&gt;
      &amp;lt;track-connection-by-tx/&amp;gt;&lt;br/&gt;
      &amp;lt;rar-name&amp;gt;activemq-rar-5.3.0.rar&amp;lt;/rar-name&amp;gt;&lt;br/&gt;
      &amp;lt;connection-definition&amp;gt;javax.jms.QueueConnectionFactory&amp;lt;/connection-definition&amp;gt;&lt;br/&gt;
      &amp;lt;ServerUrl&amp;gt;tcp://localhost:61616&amp;lt;/ServerUrl&amp;gt;&lt;br/&gt;
      &amp;lt;min-pool-size&amp;gt;10&amp;lt;/min-pool-size&amp;gt;&lt;br/&gt;
      &amp;lt;max-pool-size&amp;gt;200&amp;lt;/max-pool-size&amp;gt;&lt;br/&gt;
      &amp;lt;blocking-timeout-millis&amp;gt;30000&amp;lt;/blocking-timeout-millis&amp;gt;&lt;br/&gt;
      &amp;lt;idle-timeout-minutes&amp;gt;3&amp;lt;/idle-timeout-minutes&amp;gt;&lt;br/&gt;
   &amp;lt;/tx-connection-factory&amp;gt;&lt;/p&gt;

&lt;p&gt;   &amp;lt;mbean code=&quot;org.jboss.jms.jndi.JMSProviderLoader&quot;&lt;br/&gt;
          name=&quot;activemq:service=JMSProviderLoader,name=ActiveMQJMSProvider&quot;&amp;gt;&lt;br/&gt;
      &amp;lt;attribute name=&quot;ProviderName&quot;&amp;gt;ActiveMQJMSProvider&amp;lt;/attribute&amp;gt;&lt;br/&gt;
      &amp;lt;attribute name=&quot;ProviderAdapterClass&quot;&amp;gt;org.jboss.jms.jndi.JNDIProviderAdapter&amp;lt;/attribute&amp;gt;&lt;br/&gt;
      &amp;lt;attribute name=&quot;FactoryRef&quot;&amp;gt;java:/activemq/QueueConnectionFactory&amp;lt;/attribute&amp;gt;&lt;br/&gt;
      &amp;lt;attribute name=&quot;QueueFactoryRef&quot;&amp;gt;java:/activemq/QueueConnectionFactory&amp;lt;/attribute&amp;gt;&lt;br/&gt;
      &amp;lt;attribute name=&quot;TopicFactoryRef&quot;&amp;gt;java:/activemq/QueueConnectionFactory&amp;lt;/attribute&amp;gt;&lt;br/&gt;
   &amp;lt;/mbean&amp;gt;&lt;/p&gt;

&lt;p&gt;...&lt;br/&gt;
/&amp;gt;&lt;/p&gt;

&lt;p&gt;This will result in a call to ActiveMQManagedConnectionFactory.createConnectionFactory during startup of JBoss (as configured in the ra.xml). But that will always create a ActiveMQConnectionFactory and never the ActiveMQXAConnectionFactory. &lt;br/&gt;
And therefore, a ConnectionFactory instance is always bound in the JNDI and not an XAConnectionFactory.&lt;br/&gt;
So, it is not a bypass for the rar (it is still needed).&lt;/p&gt;

&lt;p&gt;I see in the sources for ActiveMQXAConnectionFactory that all work is handled by the superclass (ActiveMQConnectionFactory), so it is only in JBoss actually performing the cast on the connectionfactory that causes a problem.&lt;/p&gt;</comment>
                            <comment id="12942216" author="gtully" created="Thu, 25 Mar 2010 17:27:27 +0000"  >&lt;p&gt;ok, I see how this will work but it is a bit of a hack, all be it, one that is of value.&lt;/p&gt;

&lt;p&gt;I would expect some sort of generic RAR com.arjuna.ats.jta.recovery.XAResourceRecovery impl that is aware of a resource adapter in jndi and can make calls on javax.resource.spi.ResourceAdapter#getXAResources to do recovery.&lt;/p&gt;

&lt;p&gt;It looks like no such thing exists in jboss or arjuna atm, Having an option to publish an XA connection factory in jndi looks like a reasonable workaround.&lt;/p&gt;</comment>
                            <comment id="12942215" author="gtully" created="Thu, 25 Mar 2010 17:40:52 +0000"  >&lt;p&gt;patch applied to trunk with thanks in r927520&lt;/p&gt;</comment>
                            <comment id="12942286" author="gtully" created="Fri, 26 Mar 2010 17:03:52 +0000"  >&lt;p&gt;this breaks regular XA, the RAR needs to handle the XAResource and an XAConnectionFactory should not be created.&lt;br/&gt;
We need another mechanism to integrate with the periodic recovery of jboss. Possibly implement their recovery interface or a wrapper to it.&lt;/p&gt;</comment>
                            <comment id="12942249" author="gtully" created="Mon, 29 Mar 2010 10:11:12 +0000"  >&lt;p&gt;Seems like the issue of of JCA XA recovery registration has come up in jboss land, and it is correctly seen as something that should be handled under the covers between JCA and the TransactionManager, but this has not been completed yet. See: &lt;a href=&quot;https://jira.jboss.org/jira/browse/JBJCA-39&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jira.jboss.org/jira/browse/JBJCA-39&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There may be some way to workaround this with JMS apis in the short term, but the real solution is to let the appserver work though registering the XA resource from JCA with the underlying transaction services of the container.&lt;/p&gt;</comment>
                            <comment id="12942372" author="gtully" created="Tue, 30 Mar 2010 13:54:48 +0000"  >&lt;p&gt;Using JMS apis for out of band recovery will work, there is one relevant jboss fix .w.r.t restarted the broker service that may also help &lt;a href=&quot;https://jira.jboss.org/jira/browse/JBMESSAGING-1608&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jira.jboss.org/jira/browse/JBMESSAGING-1608&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Background: The RAR should not create or use an XA connection factory, XA interaction is managed by the RAR implementation in response to calls from the appserver in accordance with the JCA transaction contract.&lt;br/&gt;
The appserver should also negotiate with the RAR to facilitate recovery using the JCA spi and that is what will be addressed by &lt;a href=&quot;https://jira.jboss.org/jira/browse/JBJCA-39&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jira.jboss.org/jira/browse/JBJCA-39&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In the mean time, using the JMS api to deal with recovery is a necessary and a reasonable workaround.&lt;/p&gt;

&lt;p&gt;Recovery is configured in the transaction manager properties using a resource wrapper from jboss messaging. In jboss 5.0.1_GA, the relevant addition to the transaction manager properties file: &lt;b&gt;conf/jbossjta-properties.xml&lt;/b&gt; is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &amp;lt;properties depends=&lt;span class=&quot;code-quote&quot;&gt;&quot;arjuna&quot;&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;jta&quot;&lt;/span&gt;&amp;gt;
        &amp;lt;!--
        Support subtransactions in the JTA layer?
        Default is NO.
      --&amp;gt;
        &amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;com.arjuna.ats.jta.supportSubtransactions&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;NO&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;com.arjuna.ats.jta.jtaTMImplementation&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;com.arjuna.ats.internal.jta.transaction.arjunacore.TransactionManagerImple&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;!--
                        com.arjuna.ats.internal.jta.transaction.jts.TransactionManagerImple
                        --&amp;gt;
        &amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;com.arjuna.ats.jta.jtaUTImplementation&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;com.arjuna.ats.internal.jta.transaction.arjunacore.UserTransactionImple&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;!--
                        com.arjuna.ats.internal.jta.transaction.jts.UserTransactionImple
                        --&amp;gt;
       &amp;lt;!-- recovery &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ActiveMQ XA pending automated RAR recovery https:&lt;span class=&quot;code-comment&quot;&gt;//jira.jboss.org/jira/browse/JBJCA-39 --&amp;gt;
&lt;/span&gt;       &amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;com.arjuna.ats.jta.recovery.XAResourceRecovery.ActiveMQ&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.jboss.jms.server.recovery.MessagingXAResourceRecovery;java:/ActiveMQRAR&quot;&lt;/span&gt;/&amp;gt;

    &amp;lt;/properties&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; Note this is a modification to the &lt;b&gt;jta&lt;/b&gt; configuration, &lt;em&gt;not&lt;/em&gt; the recovery manager.&lt;/p&gt;


&lt;p&gt;The JNDI name referenced needs to be provided by the ActiveMQ RAR *-ds.xml&quot; descriptor using a JMSProviderLoader. The addition is as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   &amp;lt;mbean code=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.jboss.jms.jndi.JMSProviderLoader&quot;&lt;/span&gt;
          name=&lt;span class=&quot;code-quote&quot;&gt;&quot;activemq:service=JMSProviderLoader,name=ActiveMQRAR&quot;&lt;/span&gt;&amp;gt;
      &amp;lt;attribute name=&lt;span class=&quot;code-quote&quot;&gt;&quot;ProviderName&quot;&lt;/span&gt;&amp;gt;ActiveMQRAR&amp;lt;/attribute&amp;gt;
      &amp;lt;attribute name=&lt;span class=&quot;code-quote&quot;&gt;&quot;ProviderAdapterClass&quot;&lt;/span&gt;&amp;gt;org.jboss.jms.jndi.JNDIProviderAdapter&amp;lt;/attribute&amp;gt;
      &amp;lt;attribute name=&lt;span class=&quot;code-quote&quot;&gt;&quot;Properties&quot;&lt;/span&gt;&amp;gt;xa=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
       java.naming.factory.initial=org.apache.activemq.jndi.ActiveMQInitialContextFactory
       java.naming.provider.url=tcp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:61616
&lt;/span&gt;&amp;lt;/attribute&amp;gt;
      &amp;lt;attribute name=&lt;span class=&quot;code-quote&quot;&gt;&quot;QueueFactoryRef&quot;&lt;/span&gt;&amp;gt;ConnectionFactory&amp;lt;/attribute&amp;gt;
      &amp;lt;attribute name=&lt;span class=&quot;code-quote&quot;&gt;&quot;TopicFactoryRef&quot;&lt;/span&gt;&amp;gt;ConnectionFactory&amp;lt;/attribute&amp;gt;
      &amp;lt;attribute name=&lt;span class=&quot;code-quote&quot;&gt;&quot;FactoryRef&quot;&lt;/span&gt;&amp;gt;ConnectionFactory&amp;lt;/attribute&amp;gt;
   &amp;lt;/mbean&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This depends on &lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-2656&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-2656&lt;/a&gt; to allow the ActiveMQ initial context to return an XA connection factory. Note the property, xa=true in the &quot;Properties&quot; attribute which ensures that an XAConnectionFactory is created.&lt;/p&gt;</comment>
                            <comment id="12942361" author="gtully" created="Tue, 30 Mar 2010 14:03:59 +0000"  >&lt;p&gt;r929145&lt;br/&gt;
removed the XA version of the managed connection factory and added some additional logging to the transaction broker so it is easy to verify when recovery is configured. To see it, add the following to the log4j config: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;log4j.logger.org.apache.activemq.broker.TransactionBroker=DEBUG&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; and a message will be output on every call to recover outstanding XA prepared transactions.&lt;/p&gt;</comment>
                            <comment id="12942367" author="gtully" created="Tue, 30 Mar 2010 14:05:32 +0000"  >&lt;p&gt;Add dependency link to &lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-2656&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-2656&lt;/a&gt; as this needs ActiveMQ initial context to return an XA capable connection factory for out of band recovery using JMS api&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12483476">AMQ-2656</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12461662" name="ActiveMQXAManagedConnectionFactory.java" size="1271" author="edwin@finalist.com" created="Thu, 25 Mar 2010 11:35:45 +0000"/>
                            <attachment id="12461661" name="ra.xml" size="20525" author="edwin@finalist.com" created="Thu, 25 Mar 2010 11:35:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>74853</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 35 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rqdb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>159916</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>