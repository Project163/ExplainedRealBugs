<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:47:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2880] Exception thrown during commit leads to message loss</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2880</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;In cases where JDBC persistence is used and the database server is under a fair bit of load it&apos;s sometimes possible for table/row locks to time out, which means you&apos;ll see exceptions such as:&lt;/p&gt;

&lt;p&gt;java.sql.BatchUpdateException: Lock wait timeout exceeded; try restarting transaction&lt;br/&gt;
at com.mysql.jdbc.PreparedStatement.executeBatchSerially(PreparedStatement.java:1693)&lt;br/&gt;
at com.mysql.jdbc.PreparedStatement.executeBatch(PreparedStatement.java:1108)&lt;br/&gt;
at org.apache.commons.dbcp.DelegatingStatement.executeBatch(DelegatingStatement.java:297)&lt;br/&gt;
at org.apache.commons.dbcp.DelegatingStatement.executeBatch(DelegatingStatement.java:297)&lt;br/&gt;
at org.apache.activemq.store.jdbc.TransactionContext.executeBatch(TransactionContext.java:98)&lt;br/&gt;
at org.apache.activemq.store.jdbc.TransactionContext.executeBatch(TransactionContext.java:80)&lt;br/&gt;
at org.apache.activemq.store.jdbc.TransactionContext.commit(TransactionContext.java:161)&lt;br/&gt;
at org.apache.activemq.store.jdbc.JDBCPersistenceAdapter.commitTransaction(JDBCPersistenceAdapter.java:504)&lt;br/&gt;
at org.apache.activemq.store.memory.MemoryTransactionStore$Tx.commit(MemoryTransactionStore.java:109)&lt;br/&gt;
at org.apache.activemq.store.memory.MemoryTransactionStore.commit(MemoryTransactionStore.java:220)&lt;br/&gt;
at org.apache.activemq.transaction.XATransaction.commit(XATransaction.java:73)&lt;br/&gt;
at org.apache.activemq.broker.TransactionBroker.commitTransaction(TransactionBroker.java:176)&lt;br/&gt;
at org.apache.activemq.broker.MutableBrokerFilter.commitTransaction(MutableBrokerFilter.java:103)&lt;br/&gt;
at org.apache.activemq.broker.TransportConnection.processCommitTransactionTwoPhase(TransportConnection.java:430)&lt;br/&gt;
at org.apache.activemq.command.TransactionInfo.visit(TransactionInfo.java:102)&lt;br/&gt;
at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:309)&lt;br/&gt;
at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:185)&lt;br/&gt;
at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:69)&lt;br/&gt;
at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113)&lt;br/&gt;
at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:217)&lt;br/&gt;
at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)&lt;br/&gt;
at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:219)&lt;br/&gt;
at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:201)&lt;br/&gt;
at java.lang.Thread.run(Thread.java:636)&lt;/p&gt;

&lt;p&gt;In this case the connection to the database is fine and what we should do is retry the transaction as it&apos;s a temporary failure condition.  Instead what happens is the broker moves to the next message in the queue, leaving the current message in the database.  The message won&apos;t show up in the web console and cannot be consumed by any consumers until the broker is restarted.&lt;/p&gt;

&lt;p&gt;Attached is a test case that simulates the error condition in a controlled fashion by using a subclassed JDBCPersistenceAdapter that will throw an exception in commitTransaction as necessary.  So the producer sends 10 messages and then the consumer tries to consume them, during this time the persistence adapter will throw an exception during commitTransaction.  Then the condition is cleared and the consumer can consume all 10 messages, however the consumer only consumes 9 messages, the 1st message in the sequence is still in the database.  Hopefully the logging makes this clear.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12483508">AMQ-2880</key>
            <summary>Exception thrown during commit leads to message loss</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="slewis">Stanley J. Lewis</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 Aug 2010 12:36:59 +0000</created>
                <updated>Wed, 8 Sep 2010 16:37:21 +0000</updated>
                            <resolved>Wed, 8 Sep 2010 16:31:15 +0000</resolved>
                                    <version>5.4.0</version>
                                    <fixVersion>5.4.1</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                                                            <comments>
                            <comment id="12942765" author="slewis" created="Thu, 26 Aug 2010 15:15:38 +0000"  >&lt;p&gt;Just a note to simulate the real lock timeout exception using MySQL you can just lock some rows in the table, for example:&lt;/p&gt;

&lt;p&gt;start transaction;&lt;br/&gt;
select id from activemq_msgs limit 10 for update;&lt;/p&gt;

&lt;p&gt;then try and consume some messages.  ActiveMQ will get block and then get a lock timeout when it hits these locked rows.  Then release the lock with:&lt;/p&gt;

&lt;p&gt;commit;&lt;/p&gt;

&lt;p&gt;after consuming all of the messages in the queue that you can you&apos;ll see those locked rows are still in the table and hadn&apos;t been consumed.&lt;/p&gt;</comment>
                            <comment id="12942764" author="slewis" created="Thu, 26 Aug 2010 19:37:38 +0000"  >&lt;p&gt;This shows the problem better, as each time a new consumer is created to receive a message from the queue a message is lost.&lt;/p&gt;</comment>
                            <comment id="12942793" author="gtully" created="Mon, 30 Aug 2010 13:03:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-2551&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-2551&lt;/a&gt; - can result from the checkpoint thread, the fix to this issue ensures that there are no adverse effects to it occurring save the failure of the current operation.&lt;/p&gt;</comment>
                            <comment id="12942796" author="gtully" created="Tue, 31 Aug 2010 15:31:17 +0000"  >&lt;p&gt;resolved in r991218&lt;/p&gt;

&lt;p&gt;a jms transaction rollback was needed in the even of a store failure on an ack. in addition test case needed maxredeliveries &amp;gt; numMessages to ensure replayed messages were not sent to dlq.&lt;br/&gt;
fix an test from patch applied with thanks.&lt;/p&gt;</comment>
                            <comment id="12942875" author="slewis" created="Tue, 7 Sep 2010 16:13:27 +0000"  >&lt;p&gt;This problem also occurs with XA transactions (like in the example stack trace) so we need a similar fix for this scenario.&lt;/p&gt;</comment>
                            <comment id="12942836" author="slewis" created="Tue, 7 Sep 2010 17:33:43 +0000"  >&lt;p&gt;This should take care of XA transactions.&lt;/p&gt;</comment>
                            <comment id="12942837" author="slewis" created="Tue, 7 Sep 2010 20:48:02 +0000"  >&lt;p&gt;Here&apos;s a test for XATransaction.  I&apos;m finding however that catching the exception within commit and calling rollback() from there doesn&apos;t seem to fix the issue.  Instead it seems like the message is effectively lost, as when the dummy persistent store throws it&apos;s exception the message is out of the database, I wouldn&apos;t have expected that.  Also to properly rollback in the client I had to call XAResource.start() for some reason, also a bit unexpected.  Anyway, am also attaching the changes I had done to XATransaction.java.&lt;/p&gt;</comment>
                            <comment id="12942872" author="gtully" created="Wed, 8 Sep 2010 16:31:15 +0000"  >&lt;p&gt;r995119 &lt;br/&gt;
new xa test variant from patch applied. thanks for the work on this one. XA case is now sorted.&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461842" name="patch_for_xa_transaction.txt" size="2154" author="slewis" created="Tue, 7 Sep 2010 20:48:02 +0000"/>
                            <attachment id="12461775" name="test-case.txt" size="7696" author="slewis" created="Thu, 26 Aug 2010 19:37:38 +0000"/>
                            <attachment id="12461774" name="test-case.txt" size="7685" author="slewis" created="Thu, 26 Aug 2010 12:37:19 +0000"/>
                            <attachment id="12461841" name="xa-test-case.txt" size="11926" author="slewis" created="Tue, 7 Sep 2010 20:48:02 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12483705">AMQ-2551</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14716</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 11 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0b9sn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63699</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>