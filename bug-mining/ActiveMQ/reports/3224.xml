<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:45:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-7129] Durable subscription messages can be orphaned when using individual ack mode with KahaDB</title>
                <link>https://issues.apache.org/jira/browse/AMQ-7129</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;While not a common use case it is possible for a client to use individual acknowledge mode on a durable subscription.&#160; This allows the following scenario:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;durable subscription is created on a topic&lt;/li&gt;
	&lt;li&gt;10 messages are published to the topic&lt;/li&gt;
	&lt;li&gt;durable subscription consumes the messages but only acks the 5th message&lt;/li&gt;
	&lt;li&gt;Broker is restarted&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;What should happen is there should be 9 messages left that are recovered when the subscription comes back online.&#160; What actually happens though is that messages 1-4 are stuck forever because the KahaDB index will not load them on activation. The problem is that the lackAck value that is stored in the index is for message 5 so it starts on message 5 for recovery and ignores messages 1-4 even though those values are still tracked as part of the ackPositions sequence set.&lt;/p&gt;

&lt;p&gt;The solution is that when the subscription is loaded to check if there are any ackPositions for that subscription that are earlier than the lastAck value and if they are we need to reset the cursor to the first ackPosition. Then we need to verify on recovery that any message iterated over actually exists as part of the sequence set so we don&apos;t load duplicates (this scenario happens if multiple subscriptions exist on the topic)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13208618">AMQ-7129</key>
            <summary>Durable subscription messages can be orphaned when using individual ack mode with KahaDB</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="cshannon">Christopher L. Shannon</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Jan 2019 19:29:46 +0000</created>
                <updated>Thu, 16 May 2019 11:56:53 +0000</updated>
                            <resolved>Fri, 11 Jan 2019 11:44:09 +0000</resolved>
                                    <version>5.15.8</version>
                                    <fixVersion>5.15.9</fixVersion>
                    <fixVersion>5.16.0</fixVersion>
                                    <component>KahaDB</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16738576" author="jira-bot" created="Wed, 9 Jan 2019 19:34:23 +0000"  >&lt;p&gt;Commit 25de20c77ec0bf6cdc699cac2ad50e34ec707453 in activemq&apos;s branch refs/heads/master from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=25de20c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=25de20c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7129&quot; title=&quot;Durable subscription messages can be orphaned when using individual ack mode with KahaDB&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7129&quot;&gt;&lt;del&gt;AMQ-7129&lt;/del&gt;&lt;/a&gt; - Properly recover messages from KahaDB for a durable when there are&lt;br/&gt;
messages to recover before the stored lastAck value&lt;/p&gt;

&lt;p&gt;With individual ack mode we need to check the durable ackPosition&lt;br/&gt;
sequence set in the KahaDB index on subsription load to see if there are&lt;br/&gt;
earlier messages before the lastAck value that still haven&apos;t been acked.&lt;br/&gt;
While this normally wouldn&apos;t happen it is possible in individual ack&lt;br/&gt;
mode&lt;/p&gt;</comment>
                            <comment id="16738577" author="christopher.l.shannon" created="Wed, 9 Jan 2019 19:35:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; - Can you take a look at this to make sure it looks good to you? If there is an issue we can fix it but I went ahead and pushed it against master so Jenkins could run the tests&lt;/p&gt;</comment>
                            <comment id="16738591" author="jira-bot" created="Wed, 9 Jan 2019 19:39:32 +0000"  >&lt;p&gt;Commit 703b8cbda39f4a1263e7ecfbb1eb1ec247f91162 in activemq&apos;s branch refs/heads/master from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=703b8cb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=703b8cb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7129&quot; title=&quot;Durable subscription messages can be orphaned when using individual ack mode with KahaDB&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7129&quot;&gt;&lt;del&gt;AMQ-7129&lt;/del&gt;&lt;/a&gt; - minor junit test fix&lt;/p&gt;</comment>
                            <comment id="16740285" author="gtully" created="Fri, 11 Jan 2019 11:00:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; I never got a handle on the need for individual ack on a durable sub b/c it is not shared in jms 1.0, for a long time it was only the last ack id that was tracked which meant that this use case did not work historically. With priority support and individual message tracking in the index it is possible now.&lt;br/&gt;
There is some redelivery count logic in: org.apache.activemq.broker.region.DurableTopicSubscription#deactivate that will probably break with individual ack if the messages are acked out of order and keepDurableSubsActive is true. In other words, there may be more issues related to this use case b/c it has not been common in the past.&lt;br/&gt;
this is forward progress though &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Actually - I think in the jdbc store it is just the last ack sequence id per priority that is tracked, so it may be that individual ack on the jdbc store with durable subs won&apos;t fly at all b/c there is no separate index.&lt;/p&gt;</comment>
                            <comment id="16740308" author="christopher.l.shannon" created="Fri, 11 Jan 2019 11:39:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; - thanks for the feedback.&#160; I agree that this is not perfect but&#160;is a bit of progress that should at least help.&#160; I don&apos;t recommend using individual ack mode with durables at all but there are a couple cases where I manage some brokers where a user had done this and messages got stuck like this.&#160; I told&#160;them to quit doing that which solved the issue but figured I would at least try and help the recovery case...at least for KahaDB.&#160;&#160;&lt;/p&gt;

&lt;p&gt;I will also merge the fix into the 5.15.x branch and close this as completed as the CI tests seem to have passed.&lt;/p&gt;</comment>
                            <comment id="16740311" author="jira-bot" created="Fri, 11 Jan 2019 11:43:21 +0000"  >&lt;p&gt;Commit 24b5944ecbf315866ce227862fb2d264f5b1654f in activemq&apos;s branch refs/heads/activemq-5.15.x from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=24b5944&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=24b5944&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7129&quot; title=&quot;Durable subscription messages can be orphaned when using individual ack mode with KahaDB&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7129&quot;&gt;&lt;del&gt;AMQ-7129&lt;/del&gt;&lt;/a&gt; - Properly recover messages from KahaDB for a durable when there are&lt;br/&gt;
messages to recover before the stored lastAck value&lt;/p&gt;

&lt;p&gt;With individual ack mode we need to check the durable ackPosition&lt;br/&gt;
sequence set in the KahaDB index on subsription load to see if there are&lt;br/&gt;
earlier messages before the lastAck value that still haven&apos;t been acked.&lt;br/&gt;
While this normally wouldn&apos;t happen it is possible in individual ack&lt;br/&gt;
mode&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 25de20c77ec0bf6cdc699cac2ad50e34ec707453)&lt;/p&gt;</comment>
                            <comment id="16740312" author="jira-bot" created="Fri, 11 Jan 2019 11:43:22 +0000"  >&lt;p&gt;Commit 602e382f1deb52002986ba7e308111088cc249a8 in activemq&apos;s branch refs/heads/activemq-5.15.x from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=602e382&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=602e382&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7129&quot; title=&quot;Durable subscription messages can be orphaned when using individual ack mode with KahaDB&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7129&quot;&gt;&lt;del&gt;AMQ-7129&lt;/del&gt;&lt;/a&gt; - minor junit test fix&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 703b8cbda39f4a1263e7ecfbb1eb1ec247f91162)&lt;/p&gt;</comment>
                            <comment id="16740459" author="jira-bot" created="Fri, 11 Jan 2019 14:57:28 +0000"  >&lt;p&gt;Commit fa2daa25e9acd3f37bb1ee0d37717d2383e67a85 in activemq&apos;s branch refs/heads/master from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=fa2daa2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=fa2daa2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7129&quot; title=&quot;Durable subscription messages can be orphaned when using individual ack mode with KahaDB&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7129&quot;&gt;&lt;del&gt;AMQ-7129&lt;/del&gt;&lt;/a&gt; - fix durable message size statistics with individual ack&lt;/p&gt;

&lt;p&gt;Make sure that the pending message size for a durable sub only includes&lt;br/&gt;
messages part of the ack range&lt;/p&gt;</comment>
                            <comment id="16740460" author="jira-bot" created="Fri, 11 Jan 2019 14:58:00 +0000"  >&lt;p&gt;Commit 0b88dabb40c7c29a1b86d9413a701cf31cc2ceda in activemq&apos;s branch refs/heads/activemq-5.15.x from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=0b88dab&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=0b88dab&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7129&quot; title=&quot;Durable subscription messages can be orphaned when using individual ack mode with KahaDB&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7129&quot;&gt;&lt;del&gt;AMQ-7129&lt;/del&gt;&lt;/a&gt; - fix durable message size statistics with individual ack&lt;/p&gt;

&lt;p&gt;Make sure that the pending message size for a durable sub only includes&lt;br/&gt;
messages part of the ack range&lt;/p&gt;

&lt;p&gt;(cherry picked from commit fa2daa25e9acd3f37bb1ee0d37717d2383e67a85)&lt;/p&gt;</comment>
                            <comment id="16740462" author="christopher.l.shannon" created="Fri, 11 Jan 2019 14:58:38 +0000"  >&lt;p&gt;The submission of&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7132&quot; title=&quot;ActiveMQ reads lots of index pages upon startup (after a graceful or ungraceful shutdown)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7132&quot;&gt;&lt;del&gt;AMQ-7132&lt;/del&gt;&lt;/a&gt; made me realize I forgot to make sure the pending size metrics for durables also work properly with individual ack which my latest commit fixes&lt;/p&gt;</comment>
                            <comment id="16740485" author="jira-bot" created="Fri, 11 Jan 2019 15:32:19 +0000"  >&lt;p&gt;Commit a16b227808bec2977f1d3323bf29257b3c8ca9f6 in activemq&apos;s branch refs/heads/master from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=a16b227&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=a16b227&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7129&quot; title=&quot;Durable subscription messages can be orphaned when using individual ack mode with KahaDB&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7129&quot;&gt;&lt;del&gt;AMQ-7129&lt;/del&gt;&lt;/a&gt; - code cleanup&lt;/p&gt;</comment>
                            <comment id="16740490" author="jira-bot" created="Fri, 11 Jan 2019 15:33:08 +0000"  >&lt;p&gt;Commit 5acd9303a53cd11f5109bfa96591d8d6dbf853bc in activemq&apos;s branch refs/heads/activemq-5.15.x from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=5acd930&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=5acd930&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7129&quot; title=&quot;Durable subscription messages can be orphaned when using individual ack mode with KahaDB&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7129&quot;&gt;&lt;del&gt;AMQ-7129&lt;/del&gt;&lt;/a&gt; - code cleanup&lt;/p&gt;

&lt;p&gt;(cherry picked from commit a16b227808bec2977f1d3323bf29257b3c8ca9f6)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="12862989">AMQ-5960</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 44 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|u00ohs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>