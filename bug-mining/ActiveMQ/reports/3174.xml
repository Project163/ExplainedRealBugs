<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:44:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-7006] STOMP protocol converter tracks pending ACKS in Client mode but doesn&apos;t remove all ACK&apos;d IDs, just the one submitted.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-7006</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;The patch referenced in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5423&quot; title=&quot;STOMP protocol converter tracks pending ACKS but doesn&amp;#39;t remove the state once ACK&amp;#39;d&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5423&quot;&gt;&lt;del&gt;AMQ-5423&lt;/del&gt;&lt;/a&gt;&#160;only&#160;addressed the memory leak for&#160;Client-Individual mode. Client mode is still affected as multiple messages are acknowledged with a single ACK.&#160; The single ACK is removed from memory but all the rest remain which grows over time until AMQ crashes or until the client session ends and all the pending ACKs are cleaned up at that point.&#160; At the moment we are having to regularly restart our STOMP clients to prevent the memory leak from causing a crash.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13169695">AMQ-7006</key>
            <summary>STOMP protocol converter tracks pending ACKS in Client mode but doesn&apos;t remove all ACK&apos;d IDs, just the one submitted.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Avikash Mishra">Avikash Mishra</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Jul 2018 04:52:21 +0000</created>
                <updated>Thu, 19 Jul 2018 21:02:28 +0000</updated>
                            <resolved>Thu, 19 Jul 2018 21:02:28 +0000</resolved>
                                    <version>5.15.3</version>
                                    <fixVersion>5.15.5</fixVersion>
                                    <component>STOMP</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16545100" author="christopher.l.shannon" created="Mon, 16 Jul 2018 11:44:02 +0000"  >&lt;p&gt;This patch looks ok to me but for the logging you should use the SLF4J logger and not System.out.println statements.&#160; In general it&apos;s also good to add a test or two (if possible, might be&#160;tricky to verify in this case because&#160;the behavior is not broken just a memory leak) to show the patch works and to prevent future issues.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt; - Before I&#160;merge&#160;does since you worked on&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5423&quot; title=&quot;STOMP protocol converter tracks pending ACKS but doesn&amp;#39;t remove the state once ACK&amp;#39;d&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5423&quot;&gt;&lt;del&gt;AMQ-5423&lt;/del&gt;&lt;/a&gt; can you take a quick look and make sure this looks good to you as well?&lt;/p&gt;</comment>
                            <comment id="16545728" author="avikash mishra" created="Mon, 16 Jul 2018 21:01:40 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I have had trouble writing unit tests for this patch. We have it running on our test environment for a few weeks with no issues so far.&#160;&lt;/p&gt;</comment>
                            <comment id="16545746" author="tabish121" created="Mon, 16 Jul 2018 21:25:35 +0000"  >&lt;p&gt;The patch on the surface looks ok as it does seem we are not properly cleaning up.&#160; The cleanUpPendingAcks method seems a bit off as it&apos;s comparing every value in the pending map to the values to be removed instead of just trying to remove the values given and reporting the removal if successful which would probably be more performant in the presence of many subscriptions.&#160;&lt;/p&gt;

&lt;p&gt;You might be able to write a test that show you can send an ack for something that should have been ack&apos;d already and compare the ERROR response to see if the message matches expectations as before the fix the message Ack IDs seems to be retained so I&apos;d expect a difference error before and after the fix.&#160;&lt;/p&gt;

&lt;p&gt;The code should be updated to follow the style of the surrounding code instead of introducing your own style and the logging should use the SLF4J loggers and not System.out calls.&#160;&lt;/p&gt;</comment>
                            <comment id="16545907" author="avikash mishra" created="Tue, 17 Jul 2018 00:57:17 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I did think of looping through the values just given. But at the point where I am adding elements to my removeMessageIds I don&apos;t have access to the &apos;ackId&apos; which is the key for the pedingAcks array. So all I have is the messageId which is a property of ActEntry. ActEntry is the value of the pedingAcks array.&#160;&lt;/p&gt;

&lt;p&gt;For the unit tests I did try to check against different ERROR responses. The issue is&#160;line 445 in ProtocolConverter.java. The method call to pendingAck.onMessageAck(activemqTx); always returns null if we are &apos;acking&apos; a message that as already been acked because inside that method it checks&#160;whether the message is in the dispatchedMessage array (which it isn&apos;t because it removes it correctly). So the response always returns &apos;Unexpected ACK received for message-id 123&apos;&lt;/p&gt;

&lt;p&gt;If you have any other ideas of how to write a unit test for this let me know.&#160;&lt;/p&gt;

&lt;p&gt;I have just updated the patch with the&#160;logging changes. Please review as we would like to push this to our prod environment in the next release.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16549855" author="jira-bot" created="Thu, 19 Jul 2018 20:59:05 +0000"  >&lt;p&gt;Commit 9abbe826ecc47596fb43fd42e094d403c56b158d in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=9abbe82&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=9abbe82&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7006&quot; title=&quot;STOMP protocol converter tracks pending ACKS in Client mode but doesn&amp;#39;t remove all ACK&amp;#39;d IDs, just the one submitted.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7006&quot;&gt;&lt;del&gt;AMQ-7006&lt;/del&gt;&lt;/a&gt; Remove STOMP pending acks after client acknowledge&lt;/p&gt;

&lt;p&gt;Reworked patch from Avikash Mishra to remove tracked pending acks from a&lt;br/&gt;
STOMP subscription that has acked.&lt;/p&gt;</comment>
                            <comment id="16549858" author="jira-bot" created="Thu, 19 Jul 2018 20:59:50 +0000"  >&lt;p&gt;Commit 4bcc991d72c6b8bccc764ce2a704324ec9544803 in activemq&apos;s branch refs/heads/activemq-5.15.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=4bcc991&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=4bcc991&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7006&quot; title=&quot;STOMP protocol converter tracks pending ACKS in Client mode but doesn&amp;#39;t remove all ACK&amp;#39;d IDs, just the one submitted.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7006&quot;&gt;&lt;del&gt;AMQ-7006&lt;/del&gt;&lt;/a&gt; Remove STOMP pending acks after client acknowledge&lt;/p&gt;

&lt;p&gt;Reworked patch from Avikash Mishra to remove tracked pending acks from a&lt;br/&gt;
STOMP subscription that has acked.&lt;br/&gt;
(cherry picked from commit 9abbe826ecc47596fb43fd42e094d403c56b158d)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                            <outwardlinks description="is a clone of">
                                        <issuelink>
            <issuekey id="13161645">AMQ-6975</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12931869" name="AMQ-7006_Remove_all_pending_acks_that_have_been_dispatched.patch" size="3109" author="Avikash Mishra" created="Tue, 17 Jul 2018 01:03:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 17 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vh7r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>