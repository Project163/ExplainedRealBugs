<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:59:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-9698] Fix expiration of persistent messages on durable subscriptions</title>
                <link>https://issues.apache.org/jira/browse/AMQ-9698</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;There are several bugs related the broker handling expiration of persistent messages on Durable topic subscriptions, both when the client expires and also the broker expires. The bugs are related specifically to durables in both the expiration thread and the pending message cursor and don&apos;t apply to Topic subs because topic subs A) go away when offline and B) when online don&apos;t keep references after dispatch and C) there&apos;s no topic store to ack. &lt;/p&gt;

&lt;p&gt;&lt;b&gt;Note:&lt;/b&gt; This issue is specifically for fixing persistent messages on durable topic subs...the expiration of non-persistent messages is handled completely differently as part of the pending cursor so that would be something else to investigate separately if that is working. I also noticed that Topic subs may not handle advisories quite correctly when new messages are added and there is an eviction policy set, there might be an issue there that needs investigation. &lt;/p&gt;

&lt;p&gt;The following issues exist:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;b&gt;Skipping client expired acks:&lt;/b&gt; If a client expires a message and sends back an expiration ack, the broker marks the message reference as expired. This means if multiple durable subs try and expire the same message and are using the same reference (this can happen when using caching in PendingMessageCursor) the first one will ack and the rest of the messages never get acked in the store.  Furthermore, memory usage tracking is impacted as the counter isn&apos;t decremented.&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Memory tracking by the cursor:&lt;/b&gt; AbstractStoreCursor does not decrement the usage counter on the message reference if removed using the cursor.remove(message) method. This causes the usage tracker to not decrement even after removal in some cases.&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Expiry thread:&lt;/b&gt; The topic expiration thread has multiple problems.
	&lt;ul&gt;
		&lt;li&gt;The thread is inefficient. It uses the browse method and just loads messages into the browse map even if there are no offline durables and iterates over every subscription.&lt;/li&gt;
		&lt;li&gt;The thread will just expire the message on any offline durable or any durable that is marked to expire if online without taking into account whether the durable has already acked the message. This can lead to lots of warnings in the logs for unmatched acks if acking multiple times (which could happen if there was another online sub preventing the entire removal of the message)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13617186">AMQ-9698</key>
            <summary>Fix expiration of persistent messages on durable subscriptions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="cshannon">Christopher L. Shannon</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 May 2025 23:03:09 +0000</created>
                <updated>Tue, 3 Jun 2025 16:25:55 +0000</updated>
                            <resolved>Wed, 7 May 2025 15:37:50 +0000</resolved>
                                    <version>5.19.0</version>
                    <version>6.1.6</version>
                                    <fixVersion>6.2.0</fixVersion>
                    <fixVersion>5.19.1</fixVersion>
                    <fixVersion>6.1.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6000">1h 40m</timespent>
                                <comments>
                            <comment id="17950019" author="jira-bot" created="Wed, 7 May 2025 14:39:16 +0000"  >&lt;p&gt;Commit 4abcfa1ad6808ba6786cf402b4feedef3659d0a2 in activemq&apos;s branch refs/heads/main from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=4abcfa1ad6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=4abcfa1ad6&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9698&quot; title=&quot;Fix expiration of persistent messages on durable subscriptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9698&quot;&gt;&lt;del&gt;AMQ-9698&lt;/del&gt;&lt;/a&gt; - Fix message expiration on durable subs (#1423)&lt;/p&gt;

&lt;p&gt;This commit fixes multiple problems with handling message expiration on&lt;br/&gt;
durable topic subscriptions.&lt;/p&gt;

&lt;p&gt;1) Memory usage tracking is fixed on expiration by correctly&lt;br/&gt;
decrementing the counter inside AbstractStoreCursor when calling the&lt;br/&gt;
remove(message) method, which was previously missed.&lt;br/&gt;
2) A new refrence type is used to wrap references in TopicStorePrefetch&lt;br/&gt;
so that if multiple subscriptions share a reference in their cursors&lt;br/&gt;
each one can expire the message. Previously only one would expire as the&lt;br/&gt;
message would be marked as expired and skipped.&lt;br/&gt;
3) On client expiration, the references are properly decremented so&lt;br/&gt;
memory tracking is correct.&lt;br/&gt;
4) The expiration thread for Topics has been improved to be much more&lt;br/&gt;
efficient for KahaDB by only scanning for expired messages if there are&lt;br/&gt;
durables eligible for expiration. The thread also now checks the index&lt;br/&gt;
to see if expired messages are associated with the subs still so we&lt;br/&gt;
don&apos;t expire the same sub multiple times. Only messages that need to&lt;br/&gt;
still be processed are returned which further cuts down memory usage.&lt;/p&gt;</comment>
                            <comment id="17950020" author="jira-bot" created="Wed, 7 May 2025 14:42:58 +0000"  >&lt;p&gt;Commit 9a1f00b0f0b44e8dd781367fdf32d311e4f75fd3 in activemq&apos;s branch refs/heads/activemq-6.1.x from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=9a1f00b0f0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=9a1f00b0f0&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9698&quot; title=&quot;Fix expiration of persistent messages on durable subscriptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9698&quot;&gt;&lt;del&gt;AMQ-9698&lt;/del&gt;&lt;/a&gt; - Fix message expiration on durable subs (#1423)&lt;/p&gt;

&lt;p&gt;This commit fixes multiple problems with handling message expiration on&lt;br/&gt;
durable topic subscriptions.&lt;/p&gt;

&lt;p&gt;1) Memory usage tracking is fixed on expiration by correctly&lt;br/&gt;
decrementing the counter inside AbstractStoreCursor when calling the&lt;br/&gt;
remove(message) method, which was previously missed.&lt;br/&gt;
2) A new refrence type is used to wrap references in TopicStorePrefetch&lt;br/&gt;
so that if multiple subscriptions share a reference in their cursors&lt;br/&gt;
each one can expire the message. Previously only one would expire as the&lt;br/&gt;
message would be marked as expired and skipped.&lt;br/&gt;
3) On client expiration, the references are properly decremented so&lt;br/&gt;
memory tracking is correct.&lt;br/&gt;
4) The expiration thread for Topics has been improved to be much more&lt;br/&gt;
efficient for KahaDB by only scanning for expired messages if there are&lt;br/&gt;
durables eligible for expiration. The thread also now checks the index&lt;br/&gt;
to see if expired messages are associated with the subs still so we&lt;br/&gt;
don&apos;t expire the same sub multiple times. Only messages that need to&lt;br/&gt;
still be processed are returned which further cuts down memory usage.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 4abcfa1ad6808ba6786cf402b4feedef3659d0a2)&lt;/p&gt;</comment>
                            <comment id="17950025" author="jira-bot" created="Wed, 7 May 2025 14:56:33 +0000"  >&lt;p&gt;Commit 54775454fbcd47b9d8176974461c65dc089a7af4 in activemq&apos;s branch refs/heads/activemq-5.19.x from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=54775454fb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=54775454fb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9698&quot; title=&quot;Fix expiration of persistent messages on durable subscriptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9698&quot;&gt;&lt;del&gt;AMQ-9698&lt;/del&gt;&lt;/a&gt; - Fix message expiration on durable subs (#1423)&lt;/p&gt;

&lt;p&gt;This commit fixes multiple problems with handling message expiration on&lt;br/&gt;
durable topic subscriptions.&lt;/p&gt;

&lt;p&gt;1) Memory usage tracking is fixed on expiration by correctly&lt;br/&gt;
decrementing the counter inside AbstractStoreCursor when calling the&lt;br/&gt;
remove(message) method, which was previously missed.&lt;br/&gt;
2) A new refrence type is used to wrap references in TopicStorePrefetch&lt;br/&gt;
so that if multiple subscriptions share a reference in their cursors&lt;br/&gt;
each one can expire the message. Previously only one would expire as the&lt;br/&gt;
message would be marked as expired and skipped.&lt;br/&gt;
3) On client expiration, the references are properly decremented so&lt;br/&gt;
memory tracking is correct.&lt;br/&gt;
4) The expiration thread for Topics has been improved to be much more&lt;br/&gt;
efficient for KahaDB by only scanning for expired messages if there are&lt;br/&gt;
durables eligible for expiration. The thread also now checks the index&lt;br/&gt;
to see if expired messages are associated with the subs still so we&lt;br/&gt;
don&apos;t expire the same sub multiple times. Only messages that need to&lt;br/&gt;
still be processed are returned which further cuts down memory usage.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 4abcfa1ad6808ba6786cf402b4feedef3659d0a2)&lt;br/&gt;
(cherry picked from commit 9a1f00b0f0b44e8dd781367fdf32d311e4f75fd3)&lt;/p&gt;</comment>
                            <comment id="17950267" author="jira-bot" created="Thu, 8 May 2025 13:03:43 +0000"  >&lt;p&gt;Commit 6dac231f8d4da64ac160b6ff790bd543aaa70428 in activemq&apos;s branch refs/heads/main from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=6dac231f8d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=6dac231f8d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9698&quot; title=&quot;Fix expiration of persistent messages on durable subscriptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9698&quot;&gt;&lt;del&gt;AMQ-9698&lt;/del&gt;&lt;/a&gt; - Add recovery listener to store recoverExpired() method&lt;/p&gt;

&lt;p&gt;This allows the store to check if the memory usage is full in the system&lt;br/&gt;
before continuing to try and load messages to expire on durable subs&lt;/p&gt;</comment>
                            <comment id="17950270" author="jira-bot" created="Thu, 8 May 2025 13:11:11 +0000"  >&lt;p&gt;Commit ea2b81808f00dfaad4b774c3edcd00db0a22208d in activemq&apos;s branch refs/heads/activemq-5.19.x from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=ea2b81808f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=ea2b81808f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9698&quot; title=&quot;Fix expiration of persistent messages on durable subscriptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9698&quot;&gt;&lt;del&gt;AMQ-9698&lt;/del&gt;&lt;/a&gt; - Add recovery listener to store recoverExpired() method&lt;/p&gt;

&lt;p&gt;This allows the store to check if the memory usage is full in the system&lt;br/&gt;
before continuing to try and load messages to expire on durable subs&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 6dac231f8d4da64ac160b6ff790bd543aaa70428)&lt;/p&gt;</comment>
                            <comment id="17950271" author="jira-bot" created="Thu, 8 May 2025 13:11:30 +0000"  >&lt;p&gt;Commit 04c125e35b547562dd56dc8fc57ef4a0c3adaefe in activemq&apos;s branch refs/heads/activemq-6.1.x from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=04c125e35b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=04c125e35b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9698&quot; title=&quot;Fix expiration of persistent messages on durable subscriptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9698&quot;&gt;&lt;del&gt;AMQ-9698&lt;/del&gt;&lt;/a&gt; - Add recovery listener to store recoverExpired() method&lt;/p&gt;

&lt;p&gt;This allows the store to check if the memory usage is full in the system&lt;br/&gt;
before continuing to try and load messages to expire on durable subs&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 6dac231f8d4da64ac160b6ff790bd543aaa70428)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13619958">AMQ-9721</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            26 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1voy0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>