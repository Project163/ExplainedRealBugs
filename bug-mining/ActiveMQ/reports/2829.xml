<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:34:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6288] Message ack compaction needs to acquire the checkpoint lock</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6288</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;The AckCompactionRunner task needs to acquire the checkpiont lock to prevent other threads from running a checkpoint while the task is running. Normally this task runs on the same executor as the checkpoint task so the ack compaction task wouldn&apos;t run at the same time as the checkpoint task as they are processed one at a time.&lt;/p&gt;

&lt;p&gt;However, there are two cases where this isn&apos;t always true.  First, the checkpoint() method is public and can be called through the PersistenceAdapter interface by someone at the same time the ack compaction is running.  Second, a checkpoint is called during shutdown without using the executor and could also run while the ack compaction is running.&lt;/p&gt;

&lt;p&gt;The main reason for this fix is because when doing some testing I was seeing an occasional error from journal.getNextLocation() in the forwardAllAcks method because a journal file was missing which I believe was cleaned up by the cleanup task.  I was testing scenarios such as shutdown and also manually triggering the task at the same time as an ack compaction.&lt;/p&gt;

&lt;p&gt;Also, while we are at it, we should have a try/catch around the journal.getNextLocation calls to catch any IOException so we can abort gracefully. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12967407">AMQ-6288</key>
            <summary>Message ack compaction needs to acquire the checkpoint lock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="cshannon">Christopher L. Shannon</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 May 2016 13:04:50 +0000</created>
                <updated>Mon, 6 Feb 2017 14:05:49 +0000</updated>
                            <resolved>Thu, 12 May 2016 14:42:40 +0000</resolved>
                                    <version>5.13.3</version>
                                    <fixVersion>5.14.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15280094" author="jira-bot" created="Wed, 11 May 2016 13:17:04 +0000"  >&lt;p&gt;Commit e53e340262d5e57a11464c323606529430e9b832 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e53e340&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e53e340&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6288&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6288&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The ack compaction task now acquires the checkpoint lock while it runs&lt;br/&gt;
to prevent a checkpoint from running at the same time unintentionally.&lt;br/&gt;
Also, getJournalLocation is now protected by a try/catch to handle&lt;br/&gt;
errors.&lt;/p&gt;</comment>
                            <comment id="15280099" author="christopher.l.shannon" created="Wed, 11 May 2016 13:20:11 +0000"  >&lt;p&gt;This has been resolved.  In the future it may make sense to get rid of the checkpoint lock entirely and only run the tasks on the executor.  The existing points in the code that run the checkpoint as sync could just use a future and wait for it to finish, etc.  I think this would work ok without the lock but would still need to look closer at it and make sure no issues would pop up.&lt;/p&gt;</comment>
                            <comment id="15281553" author="christopher.l.shannon" created="Thu, 12 May 2016 14:26:48 +0000"  >&lt;p&gt;We need to grab the readlock, not the writelock because the journal requires the readlock to store to it.  With the writelock everything grinds to a halt when rewriting acks which we don&apos;t want.&lt;/p&gt;</comment>
                            <comment id="15281566" author="christopher.l.shannon" created="Thu, 12 May 2016 14:42:40 +0000"  >&lt;p&gt;Fixed updated with a readlock: &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=c8a6171d04303da18d9e19ded30146643d7cbad6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=c8a6171d04303da18d9e19ded30146643d7cbad6&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15851727" author="jira-bot" created="Fri, 3 Feb 2017 16:59:22 +0000"  >&lt;p&gt;Commit 9b64e188b59a395300a2f5d6022df9dbbae2f426 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=9b64e18&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=9b64e18&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6432&quot; title=&quot;Improve &amp;#39;Failed to load next journal location: null&amp;#39; warning output&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6432&quot;&gt;&lt;del&gt;AMQ-6432&lt;/del&gt;&lt;/a&gt; issue was journal scan on newly created ack file. I left the relevant braces from &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6288&quot; title=&quot;Message ack compaction needs to acquire the checkpoint lock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6288&quot;&gt;&lt;del&gt;AMQ-6288&lt;/del&gt;&lt;/a&gt; in place. Fix and test&lt;/p&gt;</comment>
                            <comment id="15854044" author="jira-bot" created="Mon, 6 Feb 2017 14:05:49 +0000"  >&lt;p&gt;Commit 93715d1bd605bc61149505d4df2ebc223ae371af in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=93715d1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=93715d1&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6432&quot; title=&quot;Improve &amp;#39;Failed to load next journal location: null&amp;#39; warning output&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6432&quot;&gt;&lt;del&gt;AMQ-6432&lt;/del&gt;&lt;/a&gt; issue was journal scan on newly created ack file. I left the relevant braces from &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6288&quot; title=&quot;Message ack compaction needs to acquire the checkpoint lock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6288&quot;&gt;&lt;del&gt;AMQ-6288&lt;/del&gt;&lt;/a&gt; in place. Fix and test&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 9b64e188b59a395300a2f5d6022df9dbbae2f426)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13005879">AMQ-6432</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12948419">AMQ-6203</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 41 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2xkmf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>