<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:31:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-755] possible bug with temporary queues and networks?</title>
                <link>https://issues.apache.org/jira/browse/AMQ-755</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;We have been experiencing some fairly serious problems with timeouts using&lt;br/&gt;
Spring, Lingo and a network of ActiveMQ brokers.&lt;/p&gt;

&lt;p&gt;As I understand it, lingo creates temporary queues to transport the remote&lt;br/&gt;
procedure calls across JMS.&lt;/p&gt;

&lt;p&gt;We are suspicious that the messaging roundtrip gets interrupted or lost when&lt;br/&gt;
using broker networks.&lt;/p&gt;

&lt;p&gt;We integrated ActiveMQ 4.0 into our project this week and ran the JMX&lt;br/&gt;
jconsole to look at our broker network.&lt;/p&gt;

&lt;p&gt;We see temporary queues come and go, and what we are expecting is complete&lt;br/&gt;
replication of the queues on each broker. Is this expectation correct?&lt;br/&gt;
This is not what we are seeing.&lt;/p&gt;

&lt;p&gt;We believe that two things are happening:&lt;/p&gt;

&lt;p&gt;1) Temporary queues are not being cleaned up properly on all brokers.&lt;/p&gt;

&lt;p&gt;2) Temporary queues are not being created on a new broker when it is taken&lt;br/&gt;
down and then restarted.&lt;/p&gt;

&lt;p&gt;Your feedback on these apparent issues would be appreciated.&lt;/p&gt;

&lt;p&gt;To substantiate our theory we created a couple of JUnit tests. (Our test&lt;br/&gt;
cases do not include Lingo - just ActiveMQ client to broker.)&lt;/p&gt;

&lt;p&gt;TEST 1&lt;/p&gt;

&lt;p&gt;We create a network of brokers, create a message queue, send a message and&lt;br/&gt;
then take a broker down. We are expecting that the temporary message queue&lt;br/&gt;
created will be removed from both brokers. It is not.&lt;/p&gt;

&lt;p&gt;The test fails on the last assert with:&lt;/p&gt;

&lt;p&gt;junit.framework.AssertionFailedError: No queues on broker 3 expected:&amp;lt;1&amp;gt; but&lt;br/&gt;
was:&amp;lt;0&amp;gt;&lt;/p&gt;

&lt;p&gt;Source code follows:&lt;/p&gt;


&lt;p&gt; public void testTempQueueCleanup() throws Exception {&lt;br/&gt;
   ActiveMQConnectionFactory cf;&lt;br/&gt;
   Connection conn = null;&lt;br/&gt;
   Session sess = null;&lt;br/&gt;
   try &lt;/p&gt;
{
     cf = new ActiveMQConnectionFactory(

&quot;failover:(tcp://localhost:61626%3FsoTimeout=5000,tcp://localhost:61627%3FsoTimeout=5000)?maximumRetries=0&amp;amp;establishConnectionTimeout=21000&amp;amp;keepAliveTimeout=300000&quot;);
     conn = cf.createConnection();

     sess = conn.createSession(false, Session.AUTO_ACKNOWLEDGE);

     TemporaryQueue q = sess.createTemporaryQueue();

     BrokerService broker2 = createBroker(&quot;broken2&quot;,
&quot;tcp://localhost:61627&quot;, &quot;static:(tcp://localhost:61626)&quot;);

     Thread.sleep(5000);

     assertEquals(&quot;No queues on broker 1&quot;, 1,
broker1.getAdminView().getTemporaryQueues().length);
     assertEquals(&quot;No queues on broker 2&quot;, 1,
broker2.getAdminView().getTemporaryQueues().length);

     q.delete();

     assertEquals(&quot;Temp queue left behind on broker 1&quot;, 0,
broker1.getAdminView().getTemporaryQueues().length);
     assertEquals(&quot;Temp queue left behind on broker 2&quot;, 0,
broker2.getAdminView().getTemporaryQueues().length);

     broker2.stop();

   }
&lt;p&gt; finally &lt;/p&gt;
{
     if (sess!=null)
       sess.close();
     if (conn!=null)
       conn.close();
   }&lt;br/&gt;
 }&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
TEST 2&lt;br/&gt;
When stopping a broker and then restarting it, we expect to see all queues&lt;br/&gt;
replicated on the new broker.&lt;br/&gt;
&lt;br/&gt;
This test fails with:&lt;br/&gt;
&lt;br/&gt;
junit.framework.AssertionFailedError: No queues on broker 3 expected:&amp;lt;1&amp;gt; but&lt;br/&gt;
was:&amp;lt;0&amp;gt;&lt;br/&gt;
&lt;br/&gt;
Source code:&lt;br/&gt;
&lt;br/&gt;
 public void testTempQueueRecovery() throws Exception {&lt;br/&gt;
   ActiveMQConnectionFactory cf;&lt;br/&gt;
   Connection conn = null;&lt;br/&gt;
   Session sess = null;&lt;br/&gt;
   try {
     cf = new ActiveMQConnectionFactory(

&quot;failover:(tcp://localhost:61626%3FsoTimeout=5000,tcp://localhost:61627%3FsoTimeout=5000)?maximumRetries=0&amp;amp;establishConnectionTimeout=21000&amp;amp;keepAliveTimeout=300000&quot;);
     conn = cf.createConnection();

     sess = conn.createSession(false, Session.AUTO_ACKNOWLEDGE);

     TemporaryQueue q = sess.createTemporaryQueue();

     BrokerService broker2 = createBroker(&quot;broken2&quot;,
&quot;tcp://localhost:61627&quot;,
&quot;static:(tcp://localhost:61626,tcp://localhost:61628)&quot;);

     Thread.sleep(5000);

     assertEquals(&quot;No queues on broker 1&quot;, 1,
broker1.getAdminView().getTemporaryQueues().length);
     assertEquals(&quot;No queues on broker 2&quot;, 1,
broker2.getAdminView().getTemporaryQueues().length);

     BrokerService broker3 = createBroker(&quot;broken3&quot;,
&quot;tcp://localhost:61628&quot;,
&quot;static:(tcp://localhost:61626,tcp://localhost:61627)&quot;);

     assertEquals(&quot;No queues on broker 3&quot;, 1,
broker3.getAdminView().getTemporaryQueues().length);

     Thread.sleep(5000);

     q.delete();

     Thread.sleep(5000);

     assertEquals(&quot;Temp queue left behind on broker 1&quot;, 0,
broker1.getAdminView().getTemporaryQueues().length);
     assertEquals(&quot;Temp queue left behind on broker 2&quot;, 0,
broker2.getAdminView().getTemporaryQueues().length);
     assertEquals(&quot;Temp queue left behind on broker 3&quot;, 0,
broker3.getAdminView().getTemporaryQueues().length);

     broker3.stop();
     broker2.stop();

   } finally {     if (sess!=null)       sess.close();     if (conn!=null)       conn.close();   }
&lt;p&gt; }&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12481763">AMQ-755</key>
            <summary>possible bug with temporary queues and networks?</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="jstrachan">James Strachan</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Jun 2006 15:13:41 +0000</created>
                <updated>Wed, 28 Jun 2006 20:02:38 +0000</updated>
                            <resolved>Wed, 28 Jun 2006 20:02:38 +0000</resolved>
                                    <version>4.0</version>
                                    <fixVersion>4.0.2</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12938104" author="rajdavies" created="Wed, 28 Jun 2006 20:02:38 +0000"  >&lt;p&gt;I&apos;ve added a test case to demonstrate this working:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://svn.apache.org/repos/asf/incubator/activemq/trunk/assembly/src/test/java/org/apache/activemq/usecases/ThreeBrokerTempQueueNetworkTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/incubator/activemq/trunk/assembly/src/test/java/org/apache/activemq/usecases/ThreeBrokerTempQueueNetworkTest.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Some things to note - (why this test case works)&lt;/p&gt;

&lt;p&gt;Firstly - networkTTL - subscription and destination infomation is sensitive to the the networkTTL - which is the number of broker hops this infomation is allowed to be propogated. The default is one - and I couldn&apos;t see this parameter being used on the network connector.&lt;/p&gt;

&lt;p&gt;Secondly - the asychronous nature that infomation is propagated. When a tempoaray destination is created by a client - it&apos;s a synchronous call to it&apos;s local broker. Destination infomation (passed around as advisory messages using an embedded DestinationInfo command) are dispatched asynchronously - primarily to avoided issues with network locks.&lt;/p&gt;

&lt;p&gt;So you&apos;ll notice I&apos;ve added a sleep for a few seconds between the temporary destination delete and the assertion that the temporary destination is in fact removed from all the connected brokers.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84337</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            19 years, 22 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s2pb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161914</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>