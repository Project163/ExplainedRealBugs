<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:50:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3211] JMSXUserId Can be spoofed by client</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3211</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;It seems the JMSXUserId can be spoofed by client contrary to what &lt;a href=&quot;http://activemq.apache.org/jmsxuserid.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/jmsxuserid.html&lt;/a&gt; says.&lt;/p&gt;

&lt;p&gt;My test setup is populateJMSXUserID=&quot;true set in a single broker, a JAAS config org.apache.activemq.jaas.TextFileCertificateLoginModule and using mutual auth SSL (i.e., ?needClientAuth=true for transportConnector setup), and a single consumer and producer based on small modifications of the ConsumerTool and ProducerTool examples in the 5.4.2 distro.  See attached the changes to the distro package to demonstrate the bug. Just do&lt;br/&gt;
1. run apache-activemq-5.4.2/bin/activemq-admin start&lt;br/&gt;
2. in apache-activemq-5.4.2/example run ant consumer -Durl=ssl://localhost:61617 -Dmax=3 -Dverbose=true&lt;br/&gt;
3. in another shell in apache-activemq-5.4.2/example run ant producer -Durl=ssl://localhost:61617 -Dmax=3 -Dverbose=true&lt;br/&gt;
4. look at the output of the consumer for the properties printed after each received message (the producer spoofs only on even numbered messages)&lt;/p&gt;

&lt;p&gt;When the client does not set the property, then i get the properly authenticated DN as JMSXUserID using message.getStringProperty(&quot;JMSXUserID&quot;). However, when the client sets it, i get the value set by the client.  The only difference i notice is that in the former case, message.getPropertyNames() does not return JMSXUserID whereas in the spoofed case it does. &lt;/p&gt;

&lt;p&gt;i wonder whether in the context of &lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-943&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/QPID-943&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2840&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-2840&lt;/a&gt; (which interestingly doesn&apos;t list JMSXUserID as supported in a comment even though it is?) something got messed up?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12500835">AMQ-3211</key>
            <summary>JMSXUserId Can be spoofed by client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="michsteiner">Michael Steiner</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Mar 2011 03:28:55 +0000</created>
                <updated>Tue, 15 Mar 2011 11:53:25 +0000</updated>
                            <resolved>Thu, 10 Mar 2011 13:27:34 +0000</resolved>
                                    <version>5.4.2</version>
                                    <fixVersion>5.5.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13004607" author="michsteiner" created="Wed, 9 Mar 2011 15:30:30 +0000"  >&lt;p&gt;The files from apache-activemq-5.4.2/conf and apache-activemq-5.4.2/examples which include all changes i&apos;ve done to demonstrate problem (see for comments with MSTEINER in it ...)&lt;/p&gt;</comment>
                            <comment id="13004609" author="michsteiner" created="Wed, 9 Mar 2011 15:31:20 +0000"  >&lt;p&gt;The diff from the standard apache-activemq-5.4.2 distribution which demonstrates the bug&lt;/p&gt;</comment>
                            <comment id="13005050" author="gtully" created="Thu, 10 Mar 2011 12:49:32 +0000"  >&lt;p&gt;This seems broken to me. ActiveMQ does allow setting the JMSXUserId property but it should only be used in the absence of any other setting of user credentials.&lt;br/&gt;
Currently, the call to get JMSXUserId looks first at the existing properties and then at the internal userId attribute. That logic should be reversed.&lt;/p&gt;

&lt;p&gt;Typically, users should not set the JMSXUserId value, but if they do, it should be ignored if there is an alternative policy in place, ie: when BrokerService.populateJMSXUserID is specified and either the user id is set on the ActiveMQConnectionFactory or found through Authentication.&lt;/p&gt;</comment>
                            <comment id="13005053" author="gtully" created="Thu, 10 Mar 2011 13:27:34 +0000"  >&lt;p&gt;resolved in &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1080212&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1080212&amp;amp;view=rev&lt;/a&gt;&lt;br/&gt;
Can you validate the next 5.5-SNAPSHOT to ensure the fix captures your use case.&lt;br/&gt;
A client supplied JMSXUserID value is only used as a last resort. I think it is better from an interop and backward compatibility perspective to not explicitly disallow setting this property.&lt;/p&gt;</comment>
                            <comment id="13005383" author="michsteiner" created="Thu, 10 Mar 2011 23:03:41 +0000"  >&lt;p&gt;&amp;gt; Can you validate the next 5.5-SNAPSHOT to ensure the fix captures your use case.&lt;/p&gt;

&lt;p&gt;Thanks for the quick turn-around!!&lt;/p&gt;

&lt;p&gt;I did not find a new built SNAPSHOT version but i saw changes in the&lt;br/&gt;
source and so built the version from svn.  While a few tests failed, &lt;br/&gt;
(e.g., org.apache.activemq.network.DuplexNetworkMBeanTest and&lt;br/&gt;
org.apache.activemq.bugs.AMQ2021Test), i could successfully run my&lt;br/&gt;
tests and confirm that with the change JMSXUserID could not be spoofed&lt;br/&gt;
anymore (at least not the way i did in the past &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. &lt;/p&gt;

&lt;p&gt;&amp;gt; A client supplied JMSXUserID value is only used as a last resort. I&lt;br/&gt;
&amp;gt; think it is better from an interop and backward compatibility&lt;br/&gt;
&amp;gt; perspective to not explicitly disallow setting this property. &lt;/p&gt;

&lt;p&gt;I&apos;m not sure whether there is really a good use case for having clients&lt;br/&gt;
providing it, at least my security mindset would make opt for erring&lt;br/&gt;
on the safe side.  However, some of the the scenarios mentioned in&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/QPID-943&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/QPID-943&lt;/a&gt; might need that&lt;br/&gt;
(although the original request still required validation at the broker&lt;br/&gt;
side which would be fail-safe).  However, I see at least two potentially&lt;br/&gt;
problematic cases:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;whether application code would see correct or potentially spoofed&lt;br/&gt;
  fields would depend on a config.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;what happens if the config must allow unauthenticated clients?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The former is maybe more a stylic/robustness issue, i.e., multiple&lt;br/&gt;
lines of defense.   The latter though is a clear security issue. And&lt;br/&gt;
after a quick test with non-x509 based JAAS config  and&lt;/p&gt;

&lt;p&gt;    org.apache.activemq.jaas.GuestLoginModule sufficient&lt;br/&gt;
       debug=true&lt;br/&gt;
       org.apache.activemq.jaas.guest.user=&quot;guest&quot;&lt;br/&gt;
       org.apache.activemq.jaas.guest.group=&quot;guests&quot;;&lt;/p&gt;

&lt;p&gt;it seems anonymous guest result in no JMXSUserID (ie.d., above&lt;br/&gt;
guest.user/group seem to be ignored as far as JMSXUserID is&lt;br/&gt;
concerned) and i can still spoof ids.&lt;/p&gt;

&lt;p&gt;So ideally, not allowing clients from setting it at all would be&lt;br/&gt;
best. Alternatives, i see (in decreasing orders of desirability )&lt;/p&gt;

&lt;p&gt;(a) provide an option which allows passing through only validated&lt;br/&gt;
    JMSXUserID  (or to be on the fail-safe side, an option which &lt;br/&gt;
    would have to be explicitly provided to allow a pass-through)&lt;/p&gt;

&lt;p&gt;(b) Garantuee that an anonymous user has always a well-identified&lt;br/&gt;
    broker-provided JMSXUserID value&lt;/p&gt;

&lt;p&gt;(c)  provide a way for the code to check where the value come from.&lt;/p&gt;

&lt;p&gt;(Arguably, all together might even be better &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Regarding (c), there is actually a way by which it can be safely&lt;br/&gt;
determined that the field is not spoofed: if&lt;br/&gt;
message.getPropertyNames() does not include JMSXUserID but&lt;br/&gt;
.getStringProperty(&quot;JMSXUserID&quot;) is returned, it will not have been&lt;br/&gt;
set by JMS client code. Not sure, though, whether one couldn&apos;t modify&lt;br/&gt;
the JMS client library to change that behaviour and it might also&lt;br/&gt;
provide false alerts if the client has set the value but the broker&lt;br/&gt;
has overridden/corrected it.&lt;/p&gt;</comment>
                            <comment id="13005593" author="gtully" created="Fri, 11 Mar 2011 10:51:47 +0000"  >&lt;p&gt;there is an additional broker attribute: useAuthenticatedPrincipalForJMSXUserID which will ensure that the authenticated principal is placed in the JMSXUserId, such that it is explicitly set or overridden in the authenticated case. &lt;/p&gt;</comment>
                            <comment id="13006531" author="michsteiner" created="Mon, 14 Mar 2011 17:44:39 +0000"  >&lt;p&gt;Thanks! Indeed, that field forces now the guest ids of JAAS into JMSXUserID. Incidentally, it also makes JMSXUserID now return mapped identities rather than X509 DNs for the SSL case.   &lt;/p&gt;

&lt;p&gt;BTW: Given the spoofing potential without that option (and the bug in &amp;lt;5.5), i tried to update  &lt;a href=&quot;http://activemq.apache.org/jmsxuserid.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/jmsxuserid.html&lt;/a&gt; correspondingly. But i guess just signing up to confluence is not enough to update these pages?&lt;/p&gt;</comment>
                            <comment id="13006538" author="gtully" created="Mon, 14 Mar 2011 18:00:08 +0000"  >&lt;p&gt;yeah, confluence is restricted to committers,&lt;br/&gt;
can you add (via comment or diff/patch) any doco updates to this jira and I will update confluence. &lt;/p&gt;</comment>
                            <comment id="13006569" author="michsteiner" created="Mon, 14 Mar 2011 18:51:44 +0000"  >&lt;p&gt;i kindof assumed that i wouldn&apos;t be allowed to change but as i saw an edit button and could sign up, i thought i should give it try instead of offloading everything to you &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Anyway, what i would have added is along the lines of below: the disclaimer of the second paragraph certainly needs some editing regarding version references &amp;#8211; not sure how you handle that &amp;#8211; but i thought it would be good to document the vulnerability. Arguably, one could also mention the  getPropertyNames() test i outlined above as temporary workaround for older versions but i&apos;m not 100% sure whether it secure, so i omitted that.&lt;/p&gt;

&lt;p&gt;``If you allow anonymous access, you MUST also add the &lt;em&gt;useAuthenticatedPrincipalForJMSXUserID&lt;/em&gt;  property of the broker element and set it to true. Otherwise,  anonymous clients can spoof identities. Note, though, that for SSL certificate based authentication, e.g., when using TextFileCertificateLoginModule JAAS module, this will change the semantics of the broker-provided JMSXUserID. Instead of returning the DN of the certificate, it will provide the name the DN is mapped to by the JAAS module.&lt;/p&gt;

&lt;p&gt;Also note that versions up to (and including) 5.4.2 are vulnerable to spoofing. A fix is included in 5.5-SNAPSHOT &amp;gt; March 12th, 2011.&apos;&apos;&lt;/p&gt;</comment>
                            <comment id="13006882" author="gtully" created="Tue, 15 Mar 2011 11:53:25 +0000"  >&lt;p&gt;updated the doco, &lt;a href=&quot;https://cwiki.apache.org/confluence/display/ACTIVEMQ/JMSXUserID&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/ACTIVEMQ/JMSXUserID&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;thanks for the feedback &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                            <outwardlinks description="requires">
                                        <issuelink>
            <issuekey id="12498776">AMQ-3183</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12473150" name="JMSXUserID-bug.conf-src.tar.bz2" size="34844" author="michsteiner" created="Wed, 9 Mar 2011 15:30:29 +0000"/>
                            <attachment id="12473151" name="JMSXUserID-bug.diff" size="43283" author="michsteiner" created="Wed, 9 Mar 2011 15:31:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14666</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ajqn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59471</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>