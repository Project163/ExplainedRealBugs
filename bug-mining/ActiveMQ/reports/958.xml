<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:46:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2475] If tmp message store fills up, broker can deadlock due to while producers wait on disk space and consumers wait on acks</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2475</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I will attach a simple project that shows this. In the test the tmp space is set to 32 MB and two threads are created. One thread will constantly produce 1KB messages and the other consumes these, but sleeps for 100ms, note that producer flow control is turned off as well. The goal here is to ensure that the producers block while the consumers read the rest of the messages from the broker and catch up, this in turn frees up the disk space and allows the producer to send more messages. This config means that you can bound the broker based on disk space rather than memory usage.&lt;/p&gt;

&lt;p&gt;Unfortunately in this test using topics while the broker is reading in the message from the producer it has to lock the matched list it is adding it to. This is an abstract from the Topic&apos;s point of view and doesn&apos;t realize that the file may block based on the file system. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void add(MessageReference node) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception { &lt;span class=&quot;code-comment&quot;&gt;//... snip ...
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (maximumPendingMessages != 0) {
                &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (matchedListMutex) {   &lt;span class=&quot;code-comment&quot;&gt;// We have &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; mutex
&lt;/span&gt;                    matched.addMessageLast(node); &lt;span class=&quot;code-comment&quot;&gt;// ends up waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; space
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// NOTE - be careful about the slaveBroker!
&lt;/span&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (maximumPendingMessages &amp;gt; 0) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Meanwhile the consumer is sending acknowledgements for the 10 messages it just read in (the configured prefetch) from the same topic, but since they also modify the same list in the topic this waits as well on the mutex held to service the producer:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void dispatchMatched() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {       
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (matchedListMutex) {  &lt;span class=&quot;code-comment&quot;&gt;// never gets passed here.
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!matched.isEmpty() &amp;amp;&amp;amp; !isFull()) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is a fairly classic deadlock. The trick is now how to resolve this given the fact that the topic isn&apos;t aware that it&apos;s list may need to wait for the file system to clean up.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Tested on Windows XP with JDK 1.60_13, but fairly sure it will be an issue on all platforms&lt;/p&gt;</environment>
        <key id="12482818">AMQ-2475</key>
            <summary>If tmp message store fills up, broker can deadlock due to while producers wait on disk space and consumers wait on acks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="martinmurphy">Martin Murphy</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Nov 2009 10:02:46 +0000</created>
                <updated>Sun, 11 Jul 2010 17:53:17 +0000</updated>
                            <resolved>Sun, 11 Jul 2010 17:53:17 +0000</resolved>
                                    <version>5.3.0</version>
                                    <fixVersion>5.3.1</fixVersion>
                    <fixVersion>5.4.0</fixVersion>
                                    <component>Broker</component>
                    <component>Message Store</component>
                    <component>Transport</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12940910" author="martinmurphy" created="Tue, 3 Nov 2009 20:41:01 +0000"  >&lt;p&gt;Oops, didn&apos;t realize that the test never attached properly last time&lt;/p&gt;</comment>
                            <comment id="12941383" author="dominict" created="Sat, 7 Nov 2009 15:11:13 +0000"  >&lt;p&gt;I had an investigate into attempted to patch this locally in activemq-core, on a fusesource 5.3.0.4 (MacOSX 10.6.1).&lt;/p&gt;

&lt;p&gt;I&apos;ve run the following tests on the patch, will I&apos;ll attach: (the patch diffs, the patched .java and the broker xml I used in testing):&lt;/p&gt;

&lt;p&gt;The test cases I&apos;ve run overnight and this morning/afternoon are:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Virtual Topic (  VirtualTopic.iplayer  -&amp;gt; Consumer.A.VirtualTopic.iplayer)&lt;/li&gt;
	&lt;li&gt;3 x Producer, 4,000,000 messages each onto Virtual Topic (12million in total)&lt;/li&gt;
	&lt;li&gt;1 x Consumer&lt;/li&gt;
	&lt;li&gt;100mb tmp_store limit&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Virtual Topic (  VirtualTopic.iplayer  -&amp;gt; Consumer.A.VirtualTopic.iplayer)&lt;/li&gt;
	&lt;li&gt;6 x Producer, 2,000,000 messages each onto Virtual Topic (12million in total)&lt;/li&gt;
	&lt;li&gt;1 x Consumer&lt;/li&gt;
	&lt;li&gt;512mb tmp_store limit&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The tmp_storage was definitely limiting ok, and niether the broker, producer or consumer blocked:&lt;/p&gt;

&lt;p&gt;du -sh of the tmp_storage area:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;dominic-tootells-macbook-pro:data dominict$ du -sh *
 96M	journal
 48K	kr-store
  0B	lock
512M	tmp-test-broker

dominic-tootells-macbook-pro:data dominict$ du -sh *
 96M	journal
 48K	kr-store
  0B	lock
483M	tmp-test-broker

dominic-tootells-macbook-pro:data dominict$ du -sh *
 96M	journal
 48K	kr-store
  0B	lock
490M	tmp-test-broker

dominic-tootells-macbook-pro:data dominict$ du -sh *
 64M	journal
 48K	kr-store
  0B	lock
 38M	tmp-test-broker

dominic-tootells-macbook-pro:data dominict$ 

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;I&apos;ve also run the junit provided by Martin; this ran ok too; with no blockage.&lt;/p&gt;

&lt;p&gt;I shall attach the potential patches.  I haven&apos;t run any other tests against the patches; to see if they potentially cause any other unforeseen issues (i.e. normal persistent queue - will do this later on)&lt;/p&gt;

&lt;p&gt;cheers&lt;br/&gt;
/dom&lt;/p&gt;


</comment>
                            <comment id="12941382" author="dominict" created="Sat, 7 Nov 2009 15:15:11 +0000"  >&lt;p&gt;all in package org.apache.activemq.broker.region&lt;/p&gt;


&lt;p&gt;TopicSubscription.patchfile.txt      (Changes to TopicSubscription.java)&lt;br/&gt;
Topic.patchfile.txt                          (Changes to Topic.java)&lt;br/&gt;
Queue.patchfile.txt                       (Changes to Queue.java)&lt;/p&gt;

</comment>
                            <comment id="12941381" author="dominict" created="Sat, 7 Nov 2009 15:17:15 +0000"  >&lt;p&gt;The patched java files:&lt;/p&gt;

&lt;p&gt;Queue.java&lt;br/&gt;
Topic.java&lt;br/&gt;
TopicSubscription.java&lt;/p&gt;
</comment>
                            <comment id="12941388" author="dominict" created="Sat, 7 Nov 2009 15:19:18 +0000"  >&lt;p&gt;activemq.xml test broker configuration I was using to test the scenario&lt;/p&gt;</comment>
                            <comment id="12941479" author="dominict" created="Sun, 8 Nov 2009 20:00:29 +0000"  >&lt;p&gt;I&apos;ve ran some more tests on the patch I uploaded yesterday, and come across a small issue with  sendFailIfNoSpace=&quot;true&quot;.  The ResourceAllocationException would only be thrown if the producer noticed the out of space condition before the message was added to the cursor.  However, there was a slight chance space would be available when producer 1 checked, but this space was then eaten by producer 2.  Producer 1 would then be within the waiting for space loop; and not send a ResourceAllocationException.  &lt;/p&gt;

&lt;p&gt;I have added checks within the waiting for space loop, to check if a ResourceAllocationException should be thrown if sendFailIfNoSpace=&quot;true&quot;.   &lt;/p&gt;

&lt;p&gt;I shall update the patches attached yesterday, to reflect this.&lt;/p&gt;

&lt;p&gt;apologies,&lt;br/&gt;
/dom&lt;/p&gt;

&lt;p&gt;I&apos;m also currently running the test against a normal persistent queue; to make sure all is ok with that; I&apos;ll comment back once the run has finished.&lt;/p&gt;</comment>
                            <comment id="12941529" author="dominict" created="Mon, 9 Nov 2009 09:03:11 +0000"  >&lt;p&gt;Test for a normal persistent queue ran ok:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;1 consumer&lt;/li&gt;
	&lt;li&gt;5 * producer&lt;/li&gt;
	&lt;li&gt;10,000,000 * 1k messages&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;hope this helps,&lt;br/&gt;
/dom&lt;/p&gt;</comment>
                            <comment id="12941784" author="rajdavies" created="Fri, 13 Nov 2009 19:46:19 +0000"  >&lt;p&gt;I applied the patch to trunk - but got some JUnit test failures -  org.apache.activemq.broker.BrokerTest is the main one (a few JUnit tests are derived from this one).&lt;br/&gt;
Going to try resolve the dead lock differently.&lt;br/&gt;
I&apos;m not clear if you are experiencing the same problem with Queues ?&lt;/p&gt;</comment>
                            <comment id="12941603" author="dominict" created="Tue, 17 Nov 2009 11:54:51 +0000"  >&lt;p&gt;I wasn&apos;t experiencing the same issue with queue&apos;s, just topics (non persistent when they overflowed to tmp_storage)&lt;/p&gt;

&lt;p&gt;What test was failing in the org.apache.activemq.broker.BrokerTest? out of interest.&lt;br/&gt;
/dom&lt;/p&gt;</comment>
                            <comment id="12941623" author="rajdavies" created="Tue, 17 Nov 2009 12:00:12 +0000"  >&lt;p&gt;the failing tests were org.apache.activemq.broker.BrokerTest (a few are derived from this - so causes multiple failures) and org.apache.activemq.bugs.AMQ2314Test&lt;/p&gt;</comment>
                            <comment id="12941819" author="dominict" created="Tue, 17 Nov 2009 13:36:28 +0000"  >&lt;p&gt;Thanks for the info Rob,&lt;/p&gt;

&lt;p&gt;I&apos;ll give it a run through here, and see what I come up with here.&lt;/p&gt;

&lt;p&gt;I was running on a fusesource 5.3.0.4 broker.  I&apos;ve recently updated this to the fusesource 5.3.0.5 broker which included that AMQ2314Test (&lt;a href=&quot;http://fusesource.com/wiki/display/ProdInfo/FUSE+Message+Broker+v5.3+Release+Notes&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://fusesource.com/wiki/display/ProdInfo/FUSE+Message+Broker+v5.3+Release+Notes&lt;/a&gt;).  I&apos;ll run a test suite on a base source distro and a 5.3.0.5 with above patches and see what I get out of it.&lt;/p&gt;

&lt;p&gt;If I get chance I&apos;ll grab a trunk and test on that too (most likely an evening this week I&apos;m guessing though) and see if I spot anything.  &lt;/p&gt;

&lt;p&gt;Thanks for commenting back.&lt;br/&gt;
/dom&lt;/p&gt;</comment>
                            <comment id="12941827" author="rajdavies" created="Tue, 17 Nov 2009 15:48:44 +0000"  >&lt;p&gt;dead lock fixed by svn revision 881313 and 881340&lt;/p&gt;</comment>
                            <comment id="12942050" author="gtully" created="Wed, 20 Jan 2010 18:20:29 +0000"  >&lt;p&gt;also on 5.3.1 branch&lt;/p&gt;</comment>
                            <comment id="12942591" author="mcooper" created="Thu, 17 Jun 2010 06:10:34 +0000"  >&lt;p&gt;I am still able to consistently see this deadlock behavior on our system with both version 5.3.0 and 5.3.2.  The patch loops in the TopicSubscription add method while holding the matchedListMutex until thePendingMessageCursor &quot;matched&quot; is not full.  The code then attempts to call addMessageLast on the &quot;matched&quot; instance assuming that the matchedListMutex will prevent any additional threads from taking that space.  This assumption is wrong, because I have found that when using a filePendingMessageCursor, the addMessageLast method will end up calling systemUsage.getTempUsage().waitForSpace() which for whatever reason can be full when it is called and without the ability to reduce in size due to monitors already held earlier in the stack.  Therefore, the code loops infinitely and the system is deadlocked.&lt;/p&gt;

&lt;p&gt;To workaround this issue, I switched to using vm cursors, which don&apos;t rely on this shared pool of temp file storage, and haven&apos;t seen the deadlock.&lt;/p&gt;

&lt;p&gt;I am new to this project and still trying to understand the code completely, but this is what I have found.  I think the looping that is happening to wait for space is happening to early in the stack.  The matchedListMutex does not seem to lock out other threads that use temp storage.  I&apos;m not sure what the correct fix is, but without a significant reworking of the code, the best I can think to do would be to have the addMessageLast method throw some kind of exception or have a return value if space is not available, so the calling method can again release its the matchedListMutext by calling wait, and try again.  And addMessageLast wold also not call waitForSpace with an infinite timeout, but instead specify a small timeout.&lt;/p&gt;</comment>
                            <comment id="12942596" author="rajdavies" created="Thu, 17 Jun 2010 07:46:18 +0000"  >&lt;p&gt;Hi Michael  - thx for the analysis - is this something you can reproduce on your system easily ?&lt;/p&gt;</comment>
                            <comment id="12942561" author="rajdavies" created="Thu, 17 Jun 2010 08:25:42 +0000"  >&lt;p&gt;Fixed by SVN revision 955504&lt;/p&gt;</comment>
                            <comment id="12942582" author="mcooper" created="Thu, 17 Jun 2010 16:25:00 +0000"  >&lt;p&gt;Rob, wow, quick response!  I reviewed the change carefully, and it looks good for the most part.  A couple potential issues though:&lt;/p&gt;

&lt;p&gt;In FilePendingMessageCursor:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Why did you add a &quot;throws Exception&quot; clause to original and try versions of the method?  Doesn&apos;t seem to be used.&lt;/li&gt;
	&lt;li&gt;The end of the tryAddMessageLast method returns false.  I think this should probably be true instead, because if the caller passes an expired message, it will now loop forever retrying to add it.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In TopicSubscription:&lt;/p&gt;

&lt;p&gt;While the fix you made is probably the safest fix, I think the ideal fix would not have to even make a check for  matched.isFull() since the tryAddMessageLast method should return false if it is full and cannot add the message.  However, this requires implementing tryAddMessageLast in all implementations of PendingMessageCursor.&lt;/p&gt;

&lt;p&gt;Also, the fix version of the bug may need to be updated.&lt;/p&gt;</comment>
                            <comment id="12942566" author="mcooper" created="Fri, 18 Jun 2010 19:27:24 +0000"  >&lt;p&gt;Just reopening the issue to make sure the last code review doesn&apos;t get missed.  Ignore what I said about the &quot;throws Exception&quot; part, as I realize it was part of another change.  My biggest concern is over the &quot;return false&quot; which could introduce an infinite loop for expired messages.&lt;/p&gt;</comment>
                            <comment id="12942484" author="rajdavies" created="Sun, 11 Jul 2010 17:53:17 +0000"  >&lt;p&gt;Thanks Michael  - resolved by SVN revision 963118&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461480" name="Queue.java" size="67348" author="dominict" created="Sun, 8 Nov 2009 20:04:37 +0000"/>
                            <attachment id="12461477" name="Queue.patchfile.txt" size="2982" author="dominict" created="Sun, 8 Nov 2009 20:01:34 +0000"/>
                            <attachment id="12461479" name="Topic.java" size="26724" author="dominict" created="Sun, 8 Nov 2009 20:04:37 +0000"/>
                            <attachment id="12461476" name="Topic.patchfile.txt" size="1267" author="dominict" created="Sun, 8 Nov 2009 20:01:35 +0000"/>
                            <attachment id="12461482" name="TopicSubscription.java" size="20597" author="dominict" created="Sun, 8 Nov 2009 20:04:37 +0000"/>
                            <attachment id="12461478" name="TopicSubscription.patchfile.txt" size="1970" author="dominict" created="Sun, 8 Nov 2009 20:01:35 +0000"/>
                            <attachment id="12461377" name="activemq.xml" size="4614" author="dominict" created="Sat, 7 Nov 2009 15:19:18 +0000"/>
                            <attachment id="12461475" name="hangtest.zip" size="8049" author="martinmurphy" created="Tue, 3 Nov 2009 20:41:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>74928</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 20 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rq4n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>159877</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>