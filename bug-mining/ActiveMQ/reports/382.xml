<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:37:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1790] Memory leak in broker - Temporary Queue related (fix proposal included)</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1790</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;ActiveMQ broker leaks memory when using temp queues.&lt;br/&gt;
This is critical for projects that use spring based synchronous messaging because each message creates &amp;amp; destroys new temp queue,&lt;br/&gt;
however because of the leak they are not completely cleaned up resulting in OutOfMemory exception.&lt;/p&gt;

&lt;p&gt;First these are the classes that are leaked:&lt;br/&gt;
org.apache.activemq.usage.MemoryUsage&lt;br/&gt;
org.apache.activemq.management.PollCountStatisticImpl&lt;br/&gt;
org.apache.activemq.usage.DefaultUsageCapacity&lt;/p&gt;

&lt;p&gt;Cause:&lt;br/&gt;
org.apache.activemq.broker.region.BaseDestination is a base class for queues and by extension TempQueues.&lt;br/&gt;
When TempQueue is created it will call BaseDestination constructor which will allocate some memory usage and statistics objects.&lt;br/&gt;
However, the cleanup operation is missing - when TempQueue is destroyed these resources are not removed, and because these objects form a tree with the root being the root SystemUsage object they are never deleted.&lt;/p&gt;

&lt;p&gt;Solution:&lt;br/&gt;
BaseDestination should implement dispose() method - this method is already defined in Destination interface but not implemented in BaseDestination.&lt;br/&gt;
This method should cleanup all the resources allocated during it&apos;s creation. For example, see Queue.dispose().&lt;/p&gt;

</description>
                <environment>&lt;p&gt;ActiveMQ broker 5.1 &lt;br/&gt;
Spring based application with synchronous messages (temp queue based)&lt;/p&gt;</environment>
        <key id="12482583">AMQ-1790</key>
            <summary>Memory leak in broker - Temporary Queue related (fix proposal included)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="gregory.mostizky">Gregory Mostizky</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Jun 2008 10:24:44 +0000</created>
                <updated>Thu, 6 Nov 2008 16:58:29 +0000</updated>
                            <resolved>Thu, 19 Jun 2008 23:12:19 +0000</resolved>
                                    <version>5.1.0</version>
                                    <fixVersion>5.2.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12939800" author="rajdavies" created="Wed, 11 Jun 2008 10:54:56 +0000"  >&lt;p&gt;Fixed by SVN revision 666617&lt;/p&gt;</comment>
                            <comment id="12939813" author="gregory.mostizky" created="Thu, 12 Jun 2008 10:16:03 +0000"  >&lt;p&gt;It turns that there is additional source of memory leak in the above scenario.&lt;/p&gt;

&lt;p&gt;Class org.apache.activemq.broker.region.AbstractTempRegion in it&apos;s dispose() method doesnt dispose it&apos;s destinations when it&apos;s running in CacheTempDestinations=false mode (which is default). I fixed the method and used the fixed version on overnight stress test and it so far it seems ok.&lt;/p&gt;

&lt;p&gt;The fix (I added the else part):&lt;/p&gt;

&lt;p&gt;    protected final synchronized void dispose(ConnectionContext context,&lt;br/&gt;
            Destination dest) throws Exception {&lt;br/&gt;
        // add to cache&lt;br/&gt;
        if (this.doCacheTempDestinations) &lt;/p&gt;
{
            cachedDestinations.put(new CachedDestination(dest
                    .getActiveMQDestination()), dest);
        }
&lt;p&gt; else {&lt;br/&gt;
            try &lt;/p&gt;
{
                dest.dispose(context);
                dest.stop();
            }
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
                LOG.warn(&quot;Failed to dispose of &quot; + dest, e);
            }
&lt;p&gt;        }&lt;br/&gt;
    }&lt;/p&gt;</comment>
                            <comment id="12939811" author="gregory.mostizky" created="Thu, 12 Jun 2008 10:18:02 +0000"  >&lt;p&gt;Fixed the formating:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;org.apache.activemq.broker.region.AbstractTempRegion.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void dispose(ConnectionContext context,
            Destination dest) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-comment&quot;&gt;// add to cache
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.doCacheTempDestinations) {
            cachedDestinations.put(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CachedDestination(dest
                    .getActiveMQDestination()), dest);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                dest.dispose(context);
                dest.stop();
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
                LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to dispose of &quot;&lt;/span&gt; + dest, e);
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; </comment>
                            <comment id="12939868" author="rajdavies" created="Thu, 19 Jun 2008 23:12:19 +0000"  >&lt;p&gt;Fixed by svn revision 669511&lt;/p&gt;</comment>
                            <comment id="12940460" author="nnzz" created="Thu, 6 Nov 2008 16:41:00 +0000"  >&lt;p&gt;Hi there,&lt;/p&gt;

&lt;p&gt;I just installed ActiveMQ 5.2, especially for the fix of the above problem, but the above issue is still occurring.&lt;/p&gt;

&lt;p&gt;After instantiating circa 1300 temp queues I am getting the following error: java.lang.OutOfMemoryError : unable to create new native thread&lt;/p&gt;

&lt;p&gt;Also if I go to the web admin (&lt;a href=&quot;http://localhost:8161/admin/topics.jsp&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8161/admin/topics.jsp&lt;/a&gt;) I can see a long list of temp queues that don&apos;t go anywhere...&lt;/p&gt;

&lt;p&gt;Would you be able to advise us when the fix for this issue will be released.&lt;/p&gt;

&lt;p&gt;Many thanks&lt;/p&gt;

&lt;p&gt;N&lt;/p&gt;</comment>
                            <comment id="12940442" author="gtully" created="Thu, 6 Nov 2008 16:58:29 +0000"  >&lt;p&gt;N, can you post your test case, how does it compare with &lt;a href=&quot;http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/test/java/org/apache/activemq/advisory/TempQueueMemoryTest.java?view=markup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/test/java/org/apache/activemq/advisory/TempQueueMemoryTest.java?view=markup&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84770</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 3 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s05z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161503</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>