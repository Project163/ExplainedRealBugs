<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:01:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4196] Race condition between removal of subscriptions and removal of destinations in a network of brokers</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4196</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;n a broker network like this: A &amp;lt;-&lt;del&gt;&amp;gt; B &amp;lt;&lt;/del&gt;--&amp;gt; C&lt;/p&gt;

&lt;p&gt;Scenario:&lt;/p&gt;

&lt;p&gt;A producer to BrokerA creates a message, sets its replyTo header to a temp destination that it creates and listens on, then sends the message off to broker A. The message is demand forwarded to BrokerC because there is a consumer there that consumes the message and replies to the temp dest in the replyTo header.&lt;/p&gt;

&lt;p&gt;As the number of concurrent producers on BrokerA sending these messages increases, the subscription to the temp destination that was demand forwarded will not be cleaned up properly on BrokerC. The reason for this is the DemandForwardingBridge runs the remove consumer code in a separate thread. But if a &quot;remove destination&quot; advisory messages comes in, it will remove the destination from the AdvisoryBroker&apos;s destination map. So if this happens before the code for removeConsumer runs (in AdvisoryBroker), then the destination will not be in the destination map and the advisory for removeConsumer will not fire.&lt;/p&gt;

&lt;p&gt;The net result is a subscription leak in the network bridge on B &amp;amp; C&lt;/p&gt;

&lt;p&gt;The junit test shows two issues:&lt;/p&gt;

&lt;p&gt;1) the subscriptions leaked when concurrent producers using request/reply and correctly closing the consumer and connection&lt;br/&gt;
2) all subscriptions leaked when using a single producer with request/reply and closing only the connection, and not the consumer explicitly&lt;/p&gt;

&lt;p&gt;Issue 2 is related to temp destinations only and is compounded by &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3879&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-3879&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12618151">AMQ-4196</key>
            <summary>Race condition between removal of subscriptions and removal of destinations in a network of brokers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="gtully">Gary Tully</reporter>
                        <labels>
                            <label>Temp</label>
                            <label>networkBridge</label>
                    </labels>
                <created>Thu, 29 Nov 2012 13:16:54 +0000</created>
                <updated>Thu, 2 May 2013 02:30:56 +0000</updated>
                            <resolved>Thu, 29 Nov 2012 22:11:54 +0000</resolved>
                                    <version>5.6.0</version>
                    <version>5.7.0</version>
                                    <fixVersion>5.8.0</fixVersion>
                                    <component>Broker</component>
                    <component>Connector</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13506462" author="gtully" created="Thu, 29 Nov 2012 13:18:52 +0000"  >&lt;p&gt;The deletion of temp destinations before close cause a problem when there are active consumers. The broker will remove the consumers but will not fire advisories for their removal because the destination is already gone.&lt;br/&gt;
The broker side will remove the temp destinations so it is not necessary in the normal case. Only for a pooled connection, where the connection is not closed broker side. The pool ensures that sessions are closed so removing temps is fine in that case.&lt;/p&gt;</comment>
                            <comment id="13506478" author="gtully" created="Thu, 29 Nov 2012 13:59:36 +0000"  >&lt;p&gt;This may be the root cause of the lack of advisories when connection.close is called with active consumes. Clearing out the list is sufficient for the client side memory issue. The broker handles cleanup of the temp dests broker side.&lt;/p&gt;</comment>
                            <comment id="13506870" author="gtully" created="Thu, 29 Nov 2012 22:11:54 +0000"  >&lt;p&gt;fix in &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1415406&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1415406&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;two different problems uncovered by the two test case variants&lt;/p&gt;

&lt;p&gt;1) order of removedest and remove sub advisory handling. serialized that&lt;br/&gt;
2) deleting temp dests as part of close (client side) caused dropped advisories if there were pending consumers. Left removal of temps to the broker shutdown connection processing.&lt;/p&gt;</comment>
                            <comment id="13506888" author="ceposta" created="Thu, 29 Nov 2012 22:29:17 +0000"  >&lt;p&gt;I like it! Nice fix.&lt;/p&gt;</comment>
                            <comment id="13509052" author="artnaseef" created="Mon, 3 Dec 2012 21:18:57 +0000"  >&lt;p&gt;Is this a fully robust solution?  Given the impact of missing consumers on removal of a temporary destination (memory leak, leaked destinations, and leaked threads), the removal of all consumers when the temporary destination is deleted seems important to keep all the way around.&lt;/p&gt;

&lt;p&gt;In addition, the nature of advisories includes sending destination removals and consumer removals through different destinations, and therefore different threads (dest remove on ActiveMQ.Advisory.TempQueue/TempTopic and consumer remove on ActiveMQ.Advisory.Consumer.ID...) which also leads to out-of-order processing.  In this case, the change here will have no impact.&lt;/p&gt;</comment>
                            <comment id="13509145" author="gtully" created="Mon, 3 Dec 2012 22:35:50 +0000"  >&lt;p&gt;@Arthur - any outstanding consumers will be network bridge local forwarding consumers that will be removed when the remote destination is removed. Following the normal, respond to advisories approach.&lt;/p&gt;

&lt;p&gt;On the threading - dispatch occurs in the sending thread and so long as only one network bridge is dealing with temp destinations, a single consumer will be dealing with all advisories in the order in which they are produced.&lt;/p&gt;

&lt;p&gt;Feel free to provide more test cases that can demonstrate that there still is a problem.&lt;/p&gt;</comment>
                            <comment id="13509275" author="artnaseef" created="Mon, 3 Dec 2012 22:38:06 +0000"  >&lt;p&gt;Working on the test cases.&lt;/p&gt;

&lt;p&gt;Can you please point to the code paths for (a) the removal of consumers in the &quot;normal, respond to advisories approach&quot; and, (b) the dispatching in a single thread?&lt;/p&gt;</comment>
                            <comment id="13509315" author="ceposta" created="Mon, 3 Dec 2012 23:15:46 +0000"  >&lt;p&gt;Art,&lt;/p&gt;

&lt;p&gt;for (b), remove consumer (for a temp) and remove destination (for a temp) can only come from one place (the connection it originated from), ie, another connection cannot remove the temp or the consumer to the temp. When that connection makes a call to remove the consumer for the temp, the thread that handles it for that connection handles the remove in the broker and sends to the advisory topic as well as sends to the subscription for the advisory topic. Topics don&apos;t have a separate &quot;dispatch thread&quot; like queues do, so the ordering for this case cannot race. The same thread that handled the connection is also used in the TopicSubscription. If there were two separate connections involved with sending the remove info and remove destination, then there could be a race. &lt;/p&gt;

&lt;p&gt;The only other thread involved is the thread for the consumer&apos;s connection. When a topic sub dispatches to the consumer&apos;s connection it will do this by default async. So it will be put into a &quot;worker queue&quot; for the connection thread to finally send it over the wire. but the messages are put there by the same thread and in order for this async dispatch. &lt;/p&gt;

&lt;p&gt;If i&apos;ve mispoken, I&apos;m open to corrections &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13509899" author="artnaseef" created="Tue, 4 Dec 2012 17:51:28 +0000"  >&lt;p&gt;Only 1 dispatch thread for all Topics?  Then what were all those leaked threads we came across as one of the consequences of this consumer leak?  We had threads for every temporary topic and for every advisory destination.&lt;/p&gt;

&lt;p&gt;Also, what is wrong with adding the more robust solution that makes sure that no consumers ever linger after deletion of the temporary destination?  That is a nice, clean, easy-to-verify fix that should eliminate all possible causes of an issue - unless somehow a consumer gets created without attaching to the temporary destination.  I&apos;m all for fixing the cause by serializing the operations as well, but I see 0 downside to this more robust fix.&lt;/p&gt;

&lt;p&gt;Oh, and btw - shouldn&apos;t the DestinationInfo get copied in Gary&apos;s patch since it&apos;s being processed asynchronously, and changes to the object could lead to Null Pointer Exceptions?&lt;/p&gt;

&lt;p&gt;Robust please.  I  need ActiveMQ to stop having so many problems.&lt;/p&gt;</comment>
                            <comment id="13509923" author="ceposta" created="Tue, 4 Dec 2012 18:26:32 +0000"  >&lt;p&gt;@Arthur&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Only 1 dispatch thread for all Topics? Then what were all those leaked threads we came across as one of the consequences of this consumer leak? We had threads for every temporary topic and for every advisory destination.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, that&apos;s correct. There is a thread for the topic, but it&apos;s used for dispatching messages that were set aside because of producer flow control when sent with a producer window or sent synchronous. That&apos;s the only purpose for that thread. It does not dispatch the messages in normal cases. Even in the PFC case, it will not race because the Usage#usageMutex would allow the messages waiting for space to fire first before any new messages are sent.&lt;/p&gt;

&lt;p&gt;However, I agree to the extent that consumers to temporary destinations should be tied to the life of the temporary destination (whether a network sub or real sub). In other words, if somehow there is a consumer for a temp dest around when the temp dest is being removed, then that consumer too should be removed. &lt;/p&gt;

&lt;p&gt;I think Gary&apos;s patch will enforce this at the bridge level, but further assurances should be fine.&lt;/p&gt;

</comment>
                            <comment id="13509938" author="artnaseef" created="Tue, 4 Dec 2012 18:49:27 +0000"  >&lt;p&gt;So, the brokers guarantee ordering across more than 1 Topic?&lt;/p&gt;

&lt;p&gt;The following can never happen - even if PFC is hit on on Topic?&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;subscription S to composite ActiveMQ.Advisory.TempTopic,ActiveMQ.Advisory.Consumer.&amp;gt;&lt;/li&gt;
	&lt;li&gt;message A produced to ActiveMQ.Advisory.TempTopic&lt;/li&gt;
	&lt;li&gt;message B produced to ActiveMQ.Advisory.Consumer.ID:xyz&lt;/li&gt;
	&lt;li&gt;message B consumed by S&lt;/li&gt;
	&lt;li&gt;message A consumed by S&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In other words, once the ActiveMQ.Advisory.TempTopic destination hits PFC, dispatches to ActiveMQ.Advisory.Consumer.ID:xyz will block as well?&lt;/p&gt;

&lt;p&gt;This is starting to shed light on potential circumstances under which I was seeing more out-or-order processing issues.&lt;/p&gt;</comment>
                            <comment id="13509954" author="gtully" created="Tue, 4 Dec 2012 19:27:44 +0000"  >&lt;p&gt;@Arthur - please build the test case. If there is need for a further fix (demonstrated by a concrete test case) we can do it.&lt;/p&gt;

&lt;p&gt;There is no ordering guarantee (across topics) in general but for advisories, pfc is disabled, and all dispatch is async such that a send never blocks, so each sub has guaranteed ordering. The network bridges depend on this behavior.&lt;/p&gt;</comment>
                            <comment id="13509957" author="artnaseef" created="Tue, 4 Dec 2012 19:43:57 +0000"  >&lt;p&gt;Alright.  Just keep in mind that I&apos;m tired of providing concrete test cases for issues that aren&apos;t getting fixed.  So, I&apos;m going to stop doing so if they don&apos;t start yielding results.&lt;/p&gt;

&lt;p&gt;For example, I still have (&amp;gt; 1 year now) issues with transacted sends failing and the clients never notice.&lt;/p&gt;

&lt;p&gt;And then there&apos;s the partner to this issue in which a request message with JMSReplyTo = temp topic sent across a network of brokers, the producer can actually start sending messages before it&apos;s broker knows of the existence of the temporary destination.&lt;/p&gt;

&lt;p&gt;So, when I produce a concerete test case for this, I expect immediate action.&lt;/p&gt;</comment>
                            <comment id="13528165" author="artnaseef" created="Mon, 10 Dec 2012 18:48:07 +0000"  >&lt;p&gt;I ran tests with a broker filter designed to detect out-of-order operations on temporary destinations.  It ran into a problem in which one broker in the network saw a &quot;DELETE DESTINATION&quot; first rather than the &quot;CREATE DESTINATION&quot;.&lt;/p&gt;

&lt;p&gt;Digging into that problem resulted in finding a problem resolved as a part of the changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3253&quot; title=&quot;Support Temporary Destinations in a network without advisories&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3253&quot;&gt;&lt;del&gt;AMQ-3253&lt;/del&gt;&lt;/a&gt; (copying the DestinationInfo before sending in an advisory).&lt;/p&gt;

&lt;p&gt;After applying that fix, I&apos;m not seeing out-of-order operations, with the exception of occassional &quot;destination ... does not exist&quot; errors when using a temporary destination as the JMSReplyTo address due to a race between the request message and the temp advisories.&lt;/p&gt;

&lt;p&gt;Note that this thread has been very illuminating.  PFC doesn&apos;t really handle all of the cases I thought it would handle, and that needs careful consideration.&lt;/p&gt;

&lt;p&gt;Lists of &quot;what does ActiveMQ guarantee&quot; (with a broker network and without), and &quot;what ActiveMQ does not guarantee&quot; would be extremely useful.&lt;/p&gt;</comment>
                            <comment id="13528294" author="gtully" created="Mon, 10 Dec 2012 21:09:16 +0000"  >&lt;p&gt;that is good news. &lt;br/&gt;
One thought, if you are getting a race between messages with replyTo and temp destination creation/propagation via advisories, ensure that the network bridge that propagates the target destination of the request message is also the bridge that propagates temp destinations. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12483879">AMQ-3038</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12560394">AMQ-3879</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>292773</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 50 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0se3z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>163762</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>