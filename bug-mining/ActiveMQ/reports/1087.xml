<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:48:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3021] HttpTunnelServlet leaks BlockingQueueTransport objects, causing eventual OOM on heap space</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3021</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Symptom&lt;br/&gt;
========&lt;br/&gt;
We have a production system involving a network of 8 Brokers connected over HTTP.  The Brokers discover each other using SimpleDiscoveryAgent.  Our network experienced a period of instability during which time numerous Broker-to-Broker bridges were created and failed repeatedly.  Over the course of about 7 hours, two of the Brokers crashed with OOM heap space errors.&lt;/p&gt;

&lt;p&gt;We analyzed the heap dump and discovered several thousand instances of org.apache.activemq.transport.http.BlockingQueueTransport.  These transports were associated with bridges that had failed, however, they were not being garbage collected because HttpTunnelServlet was maintaining references to them.&lt;/p&gt;

&lt;p&gt;This issue was easily replicated in a test environment were we repeatedly broke the connection between a pair of Brokers connected over HTTP.  In each case, both Brokers maintained &lt;b&gt;indefinitely&lt;/b&gt; a number of instances of BlockingQueueTransport equal to the number of times the network was interrupted.&lt;/p&gt;

&lt;p&gt;Cause&lt;br/&gt;
=====&lt;br/&gt;
When a bridge is first created over HTTP, the client broker&apos;s HttpClientTransport sends a HEAD command to the server broker, which is processed by an instance of HttpTunnelServlet.  In response,e HttpTunnelServlet creates an instance of BlockingQueueTransport to represent the connection to the client broker.  This instance of BlockingQueueTransport is stored in a private hash map managed by HttpTunnelServlet and indexed by the client&apos;s unique ID:&lt;/p&gt;

&lt;p&gt;public class HttpTunnelServlet extends HttpServlet {&lt;br/&gt;
...&lt;br/&gt;
    private final Map&amp;lt;String, BlockingQueueTransport&amp;gt; clients = new HashMap&amp;lt;String, BlockingQueueTransport&amp;gt;();&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;    protected BlockingQueueTransport createTransportChannel(HttpServletRequest request, HttpServletResponse response) throws IOException {&lt;br/&gt;
        String clientID = request.getHeader(&quot;clientID&quot;);&lt;br/&gt;
...&lt;br/&gt;
            answer = createTransportChannel();&lt;br/&gt;
            clients.put(clientID, answer);&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;Every time a client broker reestablishes a bridge, it generates a new clientID.  As a result, the clients hash map accumulates instances of BlockingQueueTransport, one for each bridge created.  Nowhere in the implementation of HttpTunnelServlet is there any code that removes the instance when a client broker is no longer connected.  In an environment with multiple brokers and an unreliable network, the client hash  map can accumulate thousands of instances of BlockingQueueTransport.&lt;/p&gt;

&lt;p&gt;Solution&lt;br/&gt;
=======&lt;br/&gt;
HttpTunnelServlet needs to remove an instance of BlockingQueueTransport from the clients hash map whenever that instance is no longer being used.  The addition of InactivityMonitor as a default interceptor for the BlockingQueueTransport (see &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2764&quot; title=&quot;For &amp;quot;duplex&amp;quot; network connection,  after restart one ActiveMQ,  message is missing.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2764&quot;&gt;&lt;del&gt;AMQ-2764&lt;/del&gt;&lt;/a&gt;) is a partial solution in that it triggers the closure of unused BlockingQueueTransport instances; however, HttpTunnelServlet does not detect these closures.&lt;/p&gt;

&lt;p&gt;The solution is included a patch and involves the following changes to HttpTunnelServlet (not all changes are directly related to the OOM):&lt;br/&gt;
1) The addition of a ServiceListener to the BlockingQueueTransport, which is triggered when the transport is closed and causes the removal of the transport from the clients hash map&lt;br/&gt;
2) Refactoring of the access to the clients hash map to simplify thread safety (in particularly, removal of explicit synchronization in lieue of ConcurrentHashMap)&lt;br/&gt;
3) An additional check on the BlockingQueueTransport to ensure that it was not prematurely closed (the previous code ignored this possibility)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12483840">AMQ-3021</key>
            <summary>HttpTunnelServlet leaks BlockingQueueTransport objects, causing eventual OOM on heap space</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="stirlingc">Stirling Chow</reporter>
                        <labels>
                    </labels>
                <created>Fri, 5 Nov 2010 23:03:55 +0000</created>
                <updated>Mon, 8 Nov 2010 18:09:08 +0000</updated>
                            <resolved>Mon, 8 Nov 2010 18:09:08 +0000</resolved>
                                    <version>5.4.1</version>
                                    <fixVersion>5.4.2</fixVersion>
                                    <component>Broker</component>
                    <component>Transport</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                                                            <comments>
                            <comment id="12943185" author="stirlingc" created="Fri, 5 Nov 2010 23:18:11 +0000"  >&lt;p&gt;Patch for HttpTunnelServlet.java&lt;/p&gt;</comment>
                            <comment id="12943180" author="stirlingc" created="Fri, 5 Nov 2010 23:19:20 +0000"  >&lt;p&gt;A unit test (requires slightly modified BlockingQueueTransport) that demonstrates the leak.  The unit test fails with unpatched HttpTunnelServlet.&lt;/p&gt;</comment>
                            <comment id="12943190" author="dejanb" created="Mon, 8 Nov 2010 10:49:32 +0000"  >&lt;p&gt;Committed with svn revision 1032539. Thanks for the patch!&lt;/p&gt;</comment>
                            <comment id="12943197" author="stirlingc" created="Mon, 8 Nov 2010 16:52:23 +0000"  >&lt;p&gt;Dejan, the addition of the CountdownLatch to BlockingQueueTransport should not be checked in &amp;#8212; it was only there to demonstrate the issue through the unit test.  In its present state, a NullPointerException is likely to occur at runtime because the finalize() method will be triggered, but finalizeLatch will not have been initialized.&lt;/p&gt;

&lt;p&gt;If you want to include the unit test, the existing code will need to be changed to use a different technique for determining the leaking BlockingQueueTransport.  Somehow you&apos;ll need access to the instance of HttpTunnelServlet, publically expose the clients hashmap, and then assert against the number of elements in the hashmap.&lt;/p&gt;

&lt;p&gt;Unfortunately, the HttpTunnelServlet/BlockingQueueTransport class structure was not set up to support this kind of unit test, so unless you know a way to determine the number of instances of a class that are loaded in the heap, you&apos;ll have to add some testing specific code, which seems rather invasive.&lt;/p&gt;

&lt;p&gt;======&lt;/p&gt;

&lt;p&gt;To summarize, the patch that I submitted should be applied, and it should only affect HttpTunnelServlet.  BlockingQueueTransport should be left as-is and the unit test should not be checked in.&lt;/p&gt;</comment>
                            <comment id="12943182" author="dejanb" created="Mon, 8 Nov 2010 18:09:08 +0000"  >&lt;p&gt;Removed unnecessary stuff. Thanks. Would be good to have a test to protect this in the future though!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461850" name="BlockingQueueTransport.java" size="2667" author="stirlingc" created="Fri, 5 Nov 2010 23:19:20 +0000"/>
                            <attachment id="12461851" name="BlockingQueueTransportLeakTest.java" size="5825" author="stirlingc" created="Fri, 5 Nov 2010 23:19:20 +0000"/>
                            <attachment id="12461849" name="patch.txt" size="6791" author="stirlingc" created="Fri, 5 Nov 2010 23:18:11 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12483855">AMQ-2764</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14746</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 3 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0b9xb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63720</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>