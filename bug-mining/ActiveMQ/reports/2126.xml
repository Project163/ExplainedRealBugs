<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:02:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1063] Journaled JDBC checkpoint fails with java.io.IOException: Already started.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1063</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I am running trunk using JDBC against MySQL 5.0.27.  I am seeing the above mentioned IOException.  Do not have specific instructions on how to reproduce at the current time, but I was using durable subscriptions with the store durable cursor if that helps.  (I&apos;ll post if I find out more information.)&lt;/p&gt;

&lt;p&gt;      &amp;lt;persistenceAdapter&amp;gt;&lt;/p&gt;

&lt;p&gt;      &amp;lt;journaledJDBC journalLogFiles=&quot;5&quot; dataDirectory=&quot;../activemq-data&quot; dataSource=&quot;#mysql-ds&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;    &amp;lt;/persistenceAdapter&amp;gt;&lt;/p&gt;

&lt;p&gt;  &amp;lt;bean id=&quot;mysql-ds&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&amp;gt;&lt;br/&gt;
    &amp;lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&amp;gt;&lt;br/&gt;
    &amp;lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost/activemq?relaxAutoCommit=true&quot;/&amp;gt;&lt;br/&gt;
    &amp;lt;property name=&quot;username&quot; value=&quot;*** OMITTED ***&quot;/&amp;gt;&lt;br/&gt;
    &amp;lt;property name=&quot;password&quot; value=&quot;*** OMITTED *** &quot;/&amp;gt;&lt;br/&gt;
    &amp;lt;property name=&quot;poolPreparedStatements&quot; value=&quot;true&quot;/&amp;gt;&lt;br/&gt;
  &amp;lt;/bean&amp;gt;  &lt;/p&gt;

&lt;p&gt;Log trace:&lt;/p&gt;

&lt;p&gt;2006-11-19 19:19:48,078 &lt;span class=&quot;error&quot;&gt;&amp;#91;/127.0.0.1:4898&amp;#93;&lt;/span&gt; DEBUG JournalPersistenceAdapter      - Waking for checkpoint to complete.&lt;br/&gt;
2006-11-19 19:19:48,078 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; DEBUG JournalPersistenceAdapter      - Checkpoint started.&lt;br/&gt;
2006-11-19 19:19:48,078 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; ERROR JournalPersistenceAdapter      - Failed to checkpoint a message store: java.util.concurrent.ExecutionException: java.io.IOException: Already started.&lt;br/&gt;
java.util.concurrent.ExecutionException: java.io.IOException: Already started.&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:205)&lt;br/&gt;
	at java.util.concurrent.FutureTask.get(FutureTask.java:80)&lt;br/&gt;
	at org.apache.activemq.store.journal.JournalPersistenceAdapter.doCheckpoint(JournalPersistenceAdapter.java:386)&lt;br/&gt;
	at org.apache.activemq.store.journal.JournalPersistenceAdapter$2.iterate(JournalPersistenceAdapter.java:129)&lt;br/&gt;
	at org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:88)&lt;br/&gt;
	at org.apache.activemq.thread.DedicatedTaskRunner.access$0(DedicatedTaskRunner.java:76)&lt;br/&gt;
	at org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:39)&lt;br/&gt;
Caused by: java.io.IOException: Already started.&lt;br/&gt;
	at org.apache.activemq.store.jdbc.TransactionContext.begin(TransactionContext.java:145)&lt;br/&gt;
	at org.apache.activemq.store.jdbc.JDBCPersistenceAdapter.beginTransaction(JDBCPersistenceAdapter.java:358)&lt;br/&gt;
	at org.apache.activemq.store.journal.JournalPersistenceAdapter.beginTransaction(JournalPersistenceAdapter.java:189)&lt;br/&gt;
	at org.apache.activemq.util.TransactionTemplate.run(TransactionTemplate.java:41)&lt;br/&gt;
	at org.apache.activemq.store.journal.JournalMessageStore.checkpoint(JournalMessageStore.java:247)&lt;br/&gt;
	at org.apache.activemq.store.journal.JournalTopicMessageStore.checkpoint(JournalTopicMessageStore.java:162)&lt;br/&gt;
	at org.apache.activemq.store.journal.JournalPersistenceAdapter$5.call(JournalPersistenceAdapter.java:373)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:269)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:123)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:595)&lt;br/&gt;
2006-11-19 19:19:48,109 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; DEBUG JournalPersistenceAdapter      - Checkpoint done.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows XP Professional, JVM 1.5.0_09, MySQL 5.0.27&lt;/p&gt;</environment>
        <key id="12483810">AMQ-1063</key>
            <summary>Journaled JDBC checkpoint fails with java.io.IOException: Already started.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="jk@penguinsfan.com">jk@penguinsfan.com</reporter>
                        <labels>
                    </labels>
                <created>Mon, 20 Nov 2006 00:28:56 +0000</created>
                <updated>Wed, 2 Apr 2014 22:20:30 +0000</updated>
                            <resolved>Mon, 9 Dec 2013 17:04:31 +0000</resolved>
                                    <version>5.0.0</version>
                                    <fixVersion>5.9.1</fixVersion>
                    <fixVersion>5.10.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>19</votes>
                                    <watches>17</watches>
                                                                                                                <comments>
                            <comment id="12938484" author="kgallo" created="Mon, 20 Nov 2006 06:24:31 +0000"  >&lt;p&gt;Do you have the mysql-connector-java.jar in the lib folder?&lt;br/&gt;
Do you have an activemq schema in your db?&lt;/p&gt;

&lt;p&gt;It works in my Windows XP, Java 1.5.0_06, MySQL 5.0.24 environment.&lt;/p&gt;</comment>
                            <comment id="12938739" author="arboz" created="Tue, 26 Dec 2006 22:03:17 +0000"  >&lt;p&gt;I have the same problem with MS SQL 2005. &lt;br/&gt;
Symptomis the same as was described - plus &lt;br/&gt;
many durable queue produsers and consumers, large queue size.&lt;br/&gt;
Exception occurs suddenly, after 6-7-24 hours of fine work.&lt;/p&gt;</comment>
                            <comment id="12938728" author="arboz" created="Tue, 26 Dec 2006 22:09:22 +0000"  >&lt;p&gt;Can I use JDBC Persistence without Journaling as walkaround? &lt;br/&gt;
Thank you for replay, It&apos;s very critical for me. Thank you.&lt;/p&gt;
</comment>
                            <comment id="12938902" author="frank1russo" created="Wed, 14 Feb 2007 14:49:19 +0000"  >&lt;p&gt;We are having the same issue using Oracle. Here is our config:&lt;/p&gt;

&lt;p&gt;        &amp;lt;persistenceAdapter&amp;gt;&lt;br/&gt;
                &amp;lt;journaledJDBC journalLogFiles=&quot;5&quot; dataDirectory=&quot;${activemq.home}/activemq-data&quot; dataSource=&quot;#oracle-ds&quot;/&amp;gt;&lt;br/&gt;
        &amp;lt;/persistenceAdapter&amp;gt;&lt;/p&gt;

&lt;p&gt;        &amp;lt;bean id=&quot;oracle-ds&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&amp;gt;&lt;br/&gt;
                &amp;lt;property name=&quot;driverClassName&quot; value=&quot;oracle.jdbc.driver.OracleDriver&quot;/&amp;gt;&lt;br/&gt;
                &amp;lt;property name=&quot;url&quot; value=&quot;***&quot;/&amp;gt;&lt;br/&gt;
                &amp;lt;property name=&quot;username&quot; value=&quot;***&quot;/&amp;gt;&lt;br/&gt;
                &amp;lt;property name=&quot;password&quot; value=&quot;***&quot;/&amp;gt;&lt;br/&gt;
                &amp;lt;property name=&quot;poolPreparedStatements&quot; value=&quot;true&quot;/&amp;gt;&lt;br/&gt;
        &amp;lt;/bean&amp;gt;&lt;/p&gt;

&lt;p&gt;Any ideas what could cause this?&lt;/p&gt;

&lt;p&gt;Thanks...&lt;/p&gt;</comment>
                            <comment id="12936404" author="jstrachan" created="Tue, 12 Jun 2007 10:28:54 +0000"  >&lt;p&gt;updated affected version&lt;/p&gt;</comment>
                            <comment id="12936631" author="vpesochi" created="Tue, 31 Jul 2007 19:44:04 +0000"  >&lt;p&gt;And we also have been having &quot;this&quot; issue since Feb 2007 in 4.1.0 on Derby&lt;/p&gt;

&lt;p&gt;Other people, also having this issue:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.nabble.com/failed-to-checkpoint-a-message-store--tf3156345s2354.html#a8752776&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.nabble.com/failed-to-checkpoint-a-message-store--tf3156345s2354.html#a8752776&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://www.nabble.com/Failed-to-checkpoint-a-messaeg-store-tf1758021s2354.html#a4781889&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.nabble.com/Failed-to-checkpoint-a-messaeg-store-tf1758021s2354.html#a4781889&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Config:&lt;/p&gt;

&lt;p&gt;        &amp;lt;persistenceAdapter&amp;gt;&lt;br/&gt;
            &amp;lt;journaledJDBC journalLogFiles=&quot;5&quot; dataDirectory=&quot;${messageStoreDir}&quot; dataSource=&quot;#derby-ds&quot;/&amp;gt;&lt;br/&gt;
        &amp;lt;/persistenceAdapter&amp;gt;&lt;br/&gt;
    &amp;lt;bean id=&quot;derby-ds&quot; class=&quot;org.apache.derby.jdbc.EmbeddedDataSource&quot;&amp;gt;&lt;br/&gt;
        &amp;lt;property name=&quot;databaseName&quot; value=&quot;derbydb&quot;/&amp;gt;&lt;br/&gt;
        &amp;lt;property name=&quot;createDatabase&quot; value=&quot;create&quot;/&amp;gt;&lt;br/&gt;
    &amp;lt;/bean&amp;gt;&lt;/p&gt;

&lt;p&gt;SEVERE: Failed to checkpoint a message store: edu.emory.mathcs.backport.java.util.concurrent.ExecutionException: java.io.IOException: Not started.&lt;br/&gt;
edu.emory.mathcs.backport.java.util.concurrent.ExecutionException: java.io.IOException: Not started.&lt;br/&gt;
 at edu.emory.mathcs.backport.java.util.concurrent.FutureTask.getResult(FutureTask.java:299)&lt;br/&gt;
 at edu.emory.mathcs.backport.java.util.concurrent.FutureTask.get(FutureTask.java:118)&lt;br/&gt;
 at org.apache.activemq.store.journal.JournalPersistenceAdapter.doCheckpoint(JournalPersistenceAdapter.java:386)&lt;br/&gt;
 at org.apache.activemq.store.journal.JournalPersistenceAdapter$2.iterate(JournalPersistenceAdapter.java:129)&lt;br/&gt;
 at org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:88)&lt;br/&gt;
 at org.apache.activemq.thread.DedicatedTaskRunner.access$000(DedicatedTaskRunner.java:25)&lt;br/&gt;
 at org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:39)&lt;br/&gt;
Caused by: java.io.IOException: Not started.&lt;br/&gt;
 at org.apache.activemq.store.jdbc.TransactionContext.rollback(TransactionContext.java:168)&lt;br/&gt;
 at org.apache.activemq.store.jdbc.JDBCPersistenceAdapter.rollbackTransaction(JDBCPersistenceAdapter.java:368)&lt;br/&gt;
 at org.apache.activemq.store.journal.JournalPersistenceAdapter.rollbackTransaction(JournalPersistenceAdapter.java:197)&lt;br/&gt;
 at org.apache.activemq.util.TransactionTemplate.run(TransactionTemplate.java:62)&lt;br/&gt;
 at org.apache.activemq.store.journal.JournalMessageStore.checkpoint(JournalMessageStore.java:247)&lt;br/&gt;
 at org.apache.activemq.store.journal.JournalMessageStore.checkpoint(JournalMessageStore.java:221)&lt;br/&gt;
 at org.apache.activemq.store.journal.JournalPersistenceAdapter$4.call(JournalPersistenceAdapter.java:356)&lt;br/&gt;
 at edu.emory.mathcs.backport.java.util.concurrent.FutureTask.run(FutureTask.java:176)&lt;br/&gt;
 at edu.emory.mathcs.backport.java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)&lt;br/&gt;
 at edu.emory.mathcs.backport.java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)&lt;br/&gt;
 at java.lang.Thread.run(Thread.java:595)&lt;br/&gt;
org.apache.activemq.store.journal.JournalPersistenceAdapter doCheckpoint&lt;/p&gt;</comment>
                            <comment id="12936545" author="vpesochi" created="Tue, 31 Jul 2007 19:50:42 +0000"  >&lt;p&gt;After that happens the first time I keep seeing this every second or so about 30 times and after that AMQ is dead. No messages are delivered anymore. Once in this state I cannot pull up messages via jconsole / operations / Browse As Table.&lt;/p&gt;</comment>
                            <comment id="12939169" author="twalters" created="Fri, 12 Oct 2007 22:06:23 +0000"  >&lt;p&gt;I&apos;ve been looking at the 4.1.1 code for checkpointing and think I&apos;ve found a problem.&lt;/p&gt;

&lt;p&gt;JDBC statements for copying messages to the longterm storage are handled by a TransactionContext object. If a SQLException is raised during execution of TransactionContext.commit(), the finally clause will close the JDBC connection and clear the &apos;inTx&apos; flag showing a current transaction. However the exception will cause a TransactionContext.rollback() to be called, which will see the cleared &apos;inTx&apos; flag and throw an exception with the &apos;Not started&apos; message in the logs above. Also, the JDBC rollback() and statement close() methods won&apos;t be called correctly which could cause leaks or partial data commits.&lt;/p&gt;

&lt;p&gt;JDBCPersistenceAdapter.log only logs SQL errors at the debug level, so the root cause of this problem is likely to be missing from the logs. My guess is that the different reports above might each reflect a different SQL error.&lt;/p&gt;

&lt;p&gt;It looks like the minimal changes which should be made here are:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Log SQL errors during commit() at a error level&lt;/li&gt;
	&lt;li&gt;Make sure rollback() can be called after the commit() error.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12940471" author="guillon" created="Mon, 10 Nov 2008 16:39:49 +0000"  >&lt;p&gt;Is there any known workaround to this issue ?&lt;/p&gt;

&lt;p&gt;I currently use this configuration for persistence:&lt;/p&gt;

&lt;p&gt;&amp;lt;persistenceAdapter&amp;gt;&lt;br/&gt;
      &amp;lt;journaledJDBC journalLogFiles=&quot;5&quot; dataDirectory=&quot;/data/activemq-data&quot; dataSource=&quot;#datasource&quot; createTablesOnStartup=&quot;false&quot; useDatabaseLock=&quot;false&quot;/&amp;gt;&lt;br/&gt;
&amp;lt;/persistenceAdapter&amp;gt;&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="12941123" author="vkothiyal" created="Wed, 9 Sep 2009 15:34:46 +0000"  >&lt;p&gt;I am getting same error messages with mysql as message store &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; with AMQ 5.2.0. any workaround for this issue?&lt;/p&gt;</comment>
                            <comment id="12941267" author="vkothiyal" created="Thu, 10 Sep 2009 09:50:30 +0000"  >&lt;p&gt;Using Jdbc persistence without jornaling seems to ahve done the trick, I know it&apos;s BAD for performace but better then the whole meesage queue getting frozen.&lt;br/&gt;
Any better suggestions?&lt;/p&gt;

&lt;p&gt;Cheers&lt;br/&gt;
V&lt;/p&gt;</comment>
                            <comment id="12940666" author="subendu" created="Tue, 22 Sep 2009 14:44:59 +0000"  >&lt;p&gt;I am facing the same issue with MySql 5.1 and activemq 5.3 (on Fuse 3.4.04) lib folder. Here is my configuration.&lt;/p&gt;

&lt;p&gt;&amp;lt;amq:persistenceAdapter&amp;gt;&lt;br/&gt;
	  &amp;lt;amq:journaledJDBC journalLogFiles=&quot;5&quot; dataDirectory=&quot;./data/activemq-data&quot; dataSource=&quot;#ors-activemq-ds&quot; createTablesOnStartup=&quot;true&quot; useDatabaseLock=&quot;false&quot;/&amp;gt; &lt;br/&gt;
&amp;lt;/amq:persistenceAdapter&amp;gt;&lt;/p&gt;

&lt;p&gt;&amp;lt;bean id=&quot;ors-activemq-ds&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&amp;gt;&lt;br/&gt;
 		&amp;lt;property name=&quot;driverClassName&quot; value=&quot;${activemq.jdbc.driver}&quot; /&amp;gt; &lt;br/&gt;
		&amp;lt;property name=&quot;url&quot; value=&quot;${activemq.jdbc.url}&quot; /&amp;gt; &lt;br/&gt;
		&amp;lt;property name=&quot;username&quot; value=&quot;${activemq.jdbc.username}&quot; /&amp;gt; &lt;br/&gt;
		&amp;lt;property name=&quot;password&quot; value=&quot;${activemq.jdbc.password}&quot; /&amp;gt; &lt;br/&gt;
		&amp;lt;property name=&quot;poolPreparedStatements&quot; value=&quot;true&quot; /&amp;gt; &lt;br/&gt;
&amp;lt;/bean&amp;gt; &lt;/p&gt;

&lt;p&gt;java.util.concurrent.ExecutionException: java.io.IOException: Already started.&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:222)&lt;br/&gt;
        at java.util.concurrent.FutureTask.get(FutureTask.java:83)&lt;br/&gt;
        at org.apache.activemq.store.journal.JournalPersistenceAdapter.doCheckpoint(JournalPersistenceAdapter.java:421)&lt;br/&gt;
        at org.apache.activemq.store.journal.JournalPersistenceAdapter$1.iterate(JournalPersistenceAdapter.java:124)&lt;br/&gt;
        at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:122)&lt;br/&gt;
        at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:43)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
Caused by: java.io.IOException: Already started.&lt;br/&gt;
        at org.apache.activemq.store.jdbc.TransactionContext.begin(TransactionContext.java:148)&lt;br/&gt;
        at org.apache.activemq.store.jdbc.JDBCPersistenceAdapter.beginTransaction(JDBCPersistenceAdapter.java:399)&lt;br/&gt;
        at org.apache.activemq.store.journal.JournalPersistenceAdapter.beginTransaction(JournalPersistenceAdapter.java:216)&lt;br/&gt;
        at org.apache.activemq.util.TransactionTemplate.run(TransactionTemplate.java:41)&lt;br/&gt;
        at org.apache.activemq.store.journal.JournalMessageStore.checkpoint(JournalMessageStore.java:258)&lt;br/&gt;
        at org.apache.activemq.store.journal.JournalMessageStore.checkpoint(JournalMessageStore.java:233)&lt;br/&gt;
        at org.apache.activemq.store.journal.JournalPersistenceAdapter$4.call(JournalPersistenceAdapter.java:391)&lt;br/&gt;
        at org.apache.activemq.store.journal.JournalPersistenceAdapter$4.call(JournalPersistenceAdapter.java:390)&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
        at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;/p&gt;</comment>
                            <comment id="12941763" author="bananeman" created="Wed, 28 Oct 2009 09:20:05 +0000"  >&lt;p&gt;&lt;a href=&quot;http://www.nabble.com/failed-to-checkpoint-a-message-store--td8752776.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Here&lt;/a&gt; I read that a workaround is to just not pool prepared statements. So I have now put:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;poolPreparedStatements&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;/&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in our (Oracle) datasource definition in activemq.xml.&lt;/p&gt;

&lt;p&gt;Has anyone else tried this? And does it really solve the issue?&lt;/p&gt;</comment>
                            <comment id="12941764" author="bananeman" created="Wed, 28 Oct 2009 10:09:56 +0000"  >&lt;p&gt;I am confused. Is this the same issue as &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1611&quot; title=&quot;edu.emory.mathcs.backport.java.util.concurrent.ExecutionException: java.io.IOException: Already started.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1611&quot;&gt;&lt;del&gt;AMQ-1611&lt;/del&gt;&lt;/a&gt; or not?&lt;/p&gt;

&lt;p&gt;And if so, will upgrading to ActiveMQ to 5.3.0 (we are now at 5.2.0) simply fix this issue?&lt;/p&gt;</comment>
                            <comment id="12942402" author="vkothiyal" created="Thu, 15 Apr 2010 14:59:06 +0000"  >&lt;p&gt;^^no upgrade to 5.3.0 doesn&apos;t fix it. also &amp;lt;property name=&quot;poolPreparedStatements&quot; value=&quot;false&quot;/&amp;gt; doesn&apos;t fix it.&lt;/p&gt;</comment>
                            <comment id="12942409" author="gtully" created="Thu, 15 Apr 2010 15:30:13 +0000"  >&lt;p&gt;Vipul, is it reproducible? Can you upload the output of the broker with debug logging enabled, that may help&lt;/p&gt;</comment>
                            <comment id="12942397" author="vkothiyal" created="Thu, 15 Apr 2010 15:36:49 +0000"  >&lt;p&gt;Hi Gary,&lt;br/&gt;
It&apos;s an intermittent issue for us, happens every now and then, a restart of the broker fixes till next occurrence. We don&apos;t have debugging enabled in our logs, but I&apos;ll do and post the output when it happens next time around. &lt;br/&gt;
Cheers&lt;br/&gt;
V&lt;/p&gt;</comment>
                            <comment id="12942570" author="hondong" created="Wed, 5 May 2010 05:14:55 +0000"  >&lt;p&gt;We even have the same Issue under ActiveMQ 4.1.2 and Oracle DS&lt;br/&gt;
It seems, that it appear under heavy Load?&lt;/p&gt;

&lt;p&gt;I&#180;ll try to reproduce it with debugging enabled...&lt;/p&gt;</comment>
                            <comment id="12942589" author="hondong" created="Thu, 6 May 2010 17:55:01 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;here is the Log with this error in Debug Mode. &lt;br/&gt;
I&#180;ll Attach it to this issue, but I think this is the interesting part for you:&lt;/p&gt;

&lt;p&gt;2010-05-06 19:20:49,275 &lt;span class=&quot;error&quot;&gt;&amp;#91;5fda:6db0:61938&amp;#93;&lt;/span&gt; DEBUG AbstractRegion                 - Removing consumer: aa82a0e0-dc97-47ef-b34a-6d89a9826915:399:45359&lt;br/&gt;
2010-05-06 19:20:50,289 &lt;span class=&quot;error&quot;&gt;&amp;#91;5fda:6db0:61938&amp;#93;&lt;/span&gt; DEBUG AbstractRegion                 - Adding consumer: aa82a0e0-dc97-47ef-b34a-6d89a9826915:399:45360&lt;br/&gt;
2010-05-06 19:20:50,382 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; DEBUG JournalPersistenceAdapter      - Checkpoint started.&lt;br/&gt;
2010-05-06 19:20:50,398 &lt;span class=&quot;error&quot;&gt;&amp;#91;5fda:6db0:61938&amp;#93;&lt;/span&gt; DEBUG AbstractRegion                 - Removing consumer: aa82a0e0-dc97-47ef-b34a-6d89a9826915:399:45360&lt;br/&gt;
2010-05-06 19:20:50,585 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; ERROR JournalPersistenceAdapter      - Failed to checkpoint a message store: edu.emory.mathcs.backport.java.util.concurrent.ExecutionException: java.io.IOException: Already started.&lt;br/&gt;
edu.emory.mathcs.backport.java.util.concurrent.ExecutionException: java.io.IOException: Already started.&lt;br/&gt;
	at edu.emory.mathcs.backport.java.util.concurrent.FutureTask.getResult(FutureTask.java:299)&lt;br/&gt;
	at edu.emory.mathcs.backport.java.util.concurrent.FutureTask.get(FutureTask.java:118)&lt;br/&gt;
	at org.apache.activemq.store.journal.JournalPersistenceAdapter.doCheckpoint(JournalPersistenceAdapter.java:386)&lt;br/&gt;
	at org.apache.activemq.store.journal.JournalPersistenceAdapter$2.iterate(JournalPersistenceAdapter.java:129)&lt;br/&gt;
	at org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:101)&lt;br/&gt;
	at org.apache.activemq.thread.DedicatedTaskRunner.access$000(DedicatedTaskRunner.java:25)&lt;br/&gt;
	at org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:39)&lt;br/&gt;
Caused by: java.io.IOException: Already started.&lt;br/&gt;
	at org.apache.activemq.store.jdbc.TransactionContext.begin(TransactionContext.java:145)&lt;br/&gt;
	at org.apache.activemq.store.jdbc.JDBCPersistenceAdapter.beginTransaction(JDBCPersistenceAdapter.java:358)&lt;br/&gt;
	at org.apache.activemq.store.journal.JournalPersistenceAdapter.beginTransaction(JournalPersistenceAdapter.java:189)&lt;br/&gt;
	at org.apache.activemq.util.TransactionTemplate.run(TransactionTemplate.java:41)&lt;br/&gt;
	at org.apache.activemq.store.journal.JournalMessageStore.checkpoint(JournalMessageStore.java:247)&lt;br/&gt;
	at org.apache.activemq.store.journal.JournalMessageStore.checkpoint(JournalMessageStore.java:221)&lt;br/&gt;
	at org.apache.activemq.store.journal.JournalPersistenceAdapter$4.call(JournalPersistenceAdapter.java:356)&lt;br/&gt;
	at edu.emory.mathcs.backport.java.util.concurrent.FutureTask.run(FutureTask.java:176)&lt;br/&gt;
	at edu.emory.mathcs.backport.java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)&lt;br/&gt;
	at edu.emory.mathcs.backport.java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
2010-05-06 19:20:50,585 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; DEBUG JournalPersistenceAdapter      - Marking journal at: 190:18104176&lt;br/&gt;
2010-05-06 19:20:50,585 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; ERROR JournalPersistenceAdapter      - Failed to mark the Journal: org.apache.activeio.journal.InvalidRecordLocationException: The location is less than the last mark.&lt;br/&gt;
org.apache.activeio.journal.InvalidRecordLocationException: The location is less than the last mark.&lt;br/&gt;
	at org.apache.activeio.journal.active.JournalImpl.setMark(JournalImpl.java:340)&lt;br/&gt;
	at org.apache.activemq.store.journal.JournalPersistenceAdapter.doCheckpoint(JournalPersistenceAdapter.java:403)&lt;br/&gt;
	at org.apache.activemq.store.journal.JournalPersistenceAdapter$2.iterate(JournalPersistenceAdapter.java:129)&lt;br/&gt;
	at org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:101)&lt;br/&gt;
	at org.apache.activemq.thread.DedicatedTaskRunner.access$000(DedicatedTaskRunner.java:25)&lt;br/&gt;
	at org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:39)&lt;br/&gt;
2010-05-06 19:20:50,585 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; DEBUG JDBCPersistenceAdapter         - Cleaning up old messages.&lt;br/&gt;
2010-05-06 19:20:50,585 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; DEBUG DefaultJDBCAdapter             - Executing SQL: DELETE FROM ACTIVEMQ_MSGS WHERE ( EXPIRATION&amp;lt;&amp;gt;0 AND EXPIRATION&amp;lt;?) OR ID &amp;lt;= ( SELECT min(ACTIVEMQ_ACKS.LAST_ACKED_ID) FROM ACTIVEMQ_ACKS WHERE ACTIVEMQ_ACKS.CONTAINER=ACTIVEMQ_MSGS.CONTAINER)&lt;br/&gt;
2010-05-06 19:20:50,585 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; DEBUG DefaultJDBCAdapter             - Deleted 0 old message(s).&lt;br/&gt;
2010-05-06 19:20:50,585 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; DEBUG JDBCPersistenceAdapter         - Cleanup done.&lt;br/&gt;
2010-05-06 19:20:50,585 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; DEBUG JournalPersistenceAdapter      - Checkpoint done.&lt;/p&gt;</comment>
                            <comment id="12942595" author="hondong" created="Thu, 6 May 2010 18:06:05 +0000"  >&lt;p&gt;Here are the Debug Log Files...&lt;/p&gt;</comment>
                            <comment id="13481287" author="pnidl" created="Mon, 22 Oct 2012 10:16:29 +0000"  >&lt;p&gt;I&apos;ve analyzed the problem for 5.6.0 release. It happens when org.apache.activemq.store.journal.JournalPersistenceAdapter starts new transaction during checkpoint and fails to retrieve the database connection for this task. The main cause is in org.apache.activemq.store.jdbc.TransactionContext.begin() method (lines 153-159):&lt;/p&gt;

&lt;p&gt;public void begin() throws IOException {&lt;br/&gt;
  if (inTx) &lt;/p&gt;
{
    throw new IOException(&quot;Already started.&quot;);
  }
&lt;p&gt;  inTx = true;&lt;br/&gt;
  connection = getConnection();&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;Lines 157 and 158 should be switched because currently the TransactionContext instance is marked as &quot;inTx&quot; even though the getConnection() method throws an exception. From that moment the TransactionContext instance is marked as &quot;inTx&quot; forever and will never start new transaction again.&lt;/p&gt;</comment>
                            <comment id="13812324" author="davsclaus" created="Sun, 3 Nov 2013 10:56:00 +0000"  >&lt;p&gt;Thanks for reporting.&lt;/p&gt;

&lt;p&gt;And Petr N&#237;dl for the suggested fix.&lt;/p&gt;</comment>
                            <comment id="13812666" author="rkraus" created="Mon, 4 Nov 2013 07:53:03 +0000"  >&lt;p&gt;I&apos;m sorry for comment to fixed issue. But IMHO the fix suggested by Petr Nidl isn&apos;t 100% correct. We already tried to use this fix. It seams, that really solved the &lt;tt&gt;java.io.IOException: Already started.&lt;/tt&gt; problem. But after this fix we faced to new problems:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;invoke a commit on Firebird connection, which is set as &lt;tt&gt;autocommit = true&lt;/tt&gt; (already reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4836&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;AMQ-4836&lt;/a&gt; by Jiri Patera)&lt;/li&gt;
	&lt;li&gt;(&lt;b&gt;most important&lt;/b&gt;) possibility to set the connection as &lt;tt&gt;autocommit = true&lt;/tt&gt;, even if the connection is configured as &lt;tt&gt;autocommit = false&lt;/tt&gt; on datasource level, when transaction is started (&lt;tt&gt;TransactionContext.begin()&lt;/tt&gt; method is invoked), see the &lt;tt&gt;getConnection()&lt;/tt&gt; method. The reason for this behavior is &quot;line switching&quot;  in suggested fix. I don&apos;t know all places and ways, where transactions are used, but IMHO it seams as problem, when the transaction is started and connection is configured as &lt;tt&gt;autocommit = true&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Maybe I miss something, but thought that this comment can be useful.&lt;/p&gt;</comment>
                            <comment id="13843306" author="gtully" created="Mon, 9 Dec 2013 16:40:05 +0000"  >&lt;p&gt;there is indeed a problem with this fix as pointed out above.&lt;/p&gt;

&lt;p&gt;getConnection depends on the inTx flag.&lt;/p&gt;

&lt;p&gt;maybe the correct fix is to clear the inTx flag in TransactionContext.getConnection() before we throw the ioe.&lt;/p&gt;</comment>
                            <comment id="13843321" author="gtully" created="Mon, 9 Dec 2013 17:04:31 +0000"  >&lt;p&gt;the change to the inTx flag is sorted in&lt;br/&gt;
&lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=b7c430d0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=b7c430d0&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461693" name="activemq.log.zip" size="377329" author="hondong" created="Thu, 6 May 2010 18:06:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84728</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 50 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0am6v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59868</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>