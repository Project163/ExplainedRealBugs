<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:43:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2439] KahaDB + Network of Brokers + Restart = Duplicate Messages that cannot be removed from the data store</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2439</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Every time the broker is restarted, the same set of duplicate messages get redelivered to consumers.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12483096">AMQ-2439</key>
            <summary>KahaDB + Network of Brokers + Restart = Duplicate Messages that cannot be removed from the data store</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cmacnaug">Colin MacNaughton</assignee>
                                    <reporter username="chirino">Hiram R. Chirino</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Oct 2009 16:27:32 +0000</created>
                <updated>Fri, 13 Nov 2009 16:13:48 +0000</updated>
                            <resolved>Fri, 13 Nov 2009 03:04:55 +0000</resolved>
                                                    <fixVersion>5.3.1</fixVersion>
                    <fixVersion>5.4.0</fixVersion>
                                    <component>Broker</component>
                    <component>Message Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12941807" author="chirino" created="Fri, 2 Oct 2009 16:32:35 +0000"  >&lt;p&gt;How to reproduce:&lt;br/&gt;
Start broker 1 with config:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&amp;lt;beans
  xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://www.springframework.org/schema/beans&quot;&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;xmlns:amq&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://activemq.apache.org/schema/core&quot;&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;xmlns:xsi&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&lt;/span&gt;
  xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
  http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd&quot;&amp;gt;

    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;bean class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;locations&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;value&amp;gt;&lt;/span&gt;file:${activemq.base}/conf/credentials.properties&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/value&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/property&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/bean&amp;gt;&lt;/span&gt;

    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;broker xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://activemq.apache.org/schema/core&quot;&lt;/span&gt;  brokerName=&lt;span class=&quot;code-quote&quot;&gt;&quot;activemq1&quot;&lt;/span&gt; dataDirectory=&lt;span class=&quot;code-quote&quot;&gt;&quot;${activemq.base}/data&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;networkConnectors&amp;gt;&lt;/span&gt;
                &amp;lt;networkConnector
                        uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;static://(tcp://localhost:61617)&quot;&lt;/span&gt;
                        name=&lt;span class=&quot;code-quote&quot;&gt;&quot;Connection to 61617&quot;&lt;/span&gt;
                        dynamicOnly=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;/&amp;gt;

        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/networkConnectors&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;persistenceAdapter&amp;gt;&lt;/span&gt;
                &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;kahaDB directory=&lt;span class=&quot;code-quote&quot;&gt;&quot;${activemq.base}/data/kaha&quot;&lt;/span&gt; journalMaxFileLength=&lt;span class=&quot;code-quote&quot;&gt;&quot;32mb&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/persistenceAdapter&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;systemUsage&amp;gt;&lt;/span&gt;
          &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;systemUsage&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;memoryUsage&amp;gt;&lt;/span&gt;
              &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;memoryUsage limit=&lt;span class=&quot;code-quote&quot;&gt;&quot;50 mb&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/memoryUsage&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;storeUsage&amp;gt;&lt;/span&gt;
              &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;storeUsage limit=&lt;span class=&quot;code-quote&quot;&gt;&quot;4 gb&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/storeUsage&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;tempUsage&amp;gt;&lt;/span&gt;
              &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;tempUsage limit=&lt;span class=&quot;code-quote&quot;&gt;&quot;200 mb&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/tempUsage&amp;gt;&lt;/span&gt;
          &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/systemUsage&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/systemUsage&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;transportConnectors&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;transportConnector name=&lt;span class=&quot;code-quote&quot;&gt;&quot;openwire&quot;&lt;/span&gt; uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;tcp://0.0.0.0:61616&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/transportConnectors&amp;gt;&lt;/span&gt;

    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/broker&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;jetty xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://mortbay.com/schemas/jetty/1.0&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;connectors&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;nioConnector port=&lt;span class=&quot;code-quote&quot;&gt;&quot;8161&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/connectors&amp;gt;&lt;/span&gt;

        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;handlers&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;webAppContext contextPath=&lt;span class=&quot;code-quote&quot;&gt;&quot;/admin&quot;&lt;/span&gt; resourceBase=&lt;span class=&quot;code-quote&quot;&gt;&quot;${activemq.base}/webapps/admin&quot;&lt;/span&gt; logUrlOnStart=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/handlers&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/jetty&amp;gt;&lt;/span&gt;

&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/beans&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and broker 2 with config:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&amp;lt;beans
  xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://www.springframework.org/schema/beans&quot;&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;xmlns:amq&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://activemq.apache.org/schema/core&quot;&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;xmlns:xsi&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&lt;/span&gt;
  xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
  http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd&quot;&amp;gt;

    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;bean class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;locations&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;value&amp;gt;&lt;/span&gt;file:${activemq.base}/conf/credentials.properties&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/value&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/property&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/bean&amp;gt;&lt;/span&gt;

    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;broker xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://activemq.apache.org/schema/core&quot;&lt;/span&gt;  brokerName=&lt;span class=&quot;code-quote&quot;&gt;&quot;activemq2&quot;&lt;/span&gt; dataDirectory=&lt;span class=&quot;code-quote&quot;&gt;&quot;${activemq.base}/data&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;networkConnectors&amp;gt;&lt;/span&gt;
                &amp;lt;networkConnector
                        uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;static://(tcp://localhost:61616)&quot;&lt;/span&gt;
                        name=&lt;span class=&quot;code-quote&quot;&gt;&quot;Connection to 61616&quot;&lt;/span&gt;
                        dynamicOnly=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;/&amp;gt;

        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/networkConnectors&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;persistenceAdapter&amp;gt;&lt;/span&gt;
                &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;kahaDB directory=&lt;span class=&quot;code-quote&quot;&gt;&quot;${activemq.base}/data/kaha&quot;&lt;/span&gt; journalMaxFileLength=&lt;span class=&quot;code-quote&quot;&gt;&quot;32mb&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/persistenceAdapter&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;systemUsage&amp;gt;&lt;/span&gt;
          &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;systemUsage&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;memoryUsage&amp;gt;&lt;/span&gt;
              &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;memoryUsage limit=&lt;span class=&quot;code-quote&quot;&gt;&quot;50 mb&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/memoryUsage&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;storeUsage&amp;gt;&lt;/span&gt;
              &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;storeUsage limit=&lt;span class=&quot;code-quote&quot;&gt;&quot;4 gb&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/storeUsage&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;tempUsage&amp;gt;&lt;/span&gt;
              &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;tempUsage limit=&lt;span class=&quot;code-quote&quot;&gt;&quot;200 mb&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/tempUsage&amp;gt;&lt;/span&gt;
          &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/systemUsage&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/systemUsage&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;transportConnectors&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;transportConnector name=&lt;span class=&quot;code-quote&quot;&gt;&quot;openwire&quot;&lt;/span&gt; uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;tcp://0.0.0.0:61617&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/transportConnectors&amp;gt;&lt;/span&gt;

    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/broker&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;jetty xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://mortbay.com/schemas/jetty/1.0&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;connectors&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;nioConnector port=&lt;span class=&quot;code-quote&quot;&gt;&quot;8162&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/connectors&amp;gt;&lt;/span&gt;

        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;handlers&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;webAppContext contextPath=&lt;span class=&quot;code-quote&quot;&gt;&quot;/admin&quot;&lt;/span&gt; resourceBase=&lt;span class=&quot;code-quote&quot;&gt;&quot;${activemq.base}/webapps/admin&quot;&lt;/span&gt; logUrlOnStart=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/handlers&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/jetty&amp;gt;&lt;/span&gt;

&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/beans&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Use the example producer and consumer in the distribution examples dir:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ant producer -Durl=tcp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:61616  -Dtopic=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; -Ddurable=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; -Dmax=1000&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ant consumer -Durl=tcp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:61617 -Dtopic=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; -Ddurable=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; -Dmax=500&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;run the producer once.&lt;br/&gt;
run that consumer 2 times.&lt;br/&gt;
then restart the broker on port 61617&lt;br/&gt;
and run the consumer again.&lt;/p&gt;

&lt;p&gt;The 3rd run of the consumer should get no messages but it receives multiple messages.  What&apos;s worse is that restarting the broker and consumer will result in the same duplicates getting delivered again.&lt;/p&gt;</comment>
                            <comment id="12941799" author="chirino" created="Fri, 2 Oct 2009 16:36:55 +0000"  >&lt;p&gt;I confirmed that KahaDB indexes were inconsistent on a restart and that is the reason the same duplicate message kept getting re-delivered.&lt;br/&gt;
I seems the reason the indexes were becoming inconsistent is because it was not being defensive when it add new messages.  If a duplicate message was added to kahadb it&apos;s two of it&apos;s btrees would no longer be consistent.&lt;/p&gt;</comment>
                            <comment id="12941798" author="chirino" created="Fri, 2 Oct 2009 16:38:56 +0000"  >&lt;p&gt;I will work on message store unit test to see if there are any other store which also are not being defensive about dup messages.&lt;/p&gt;

&lt;p&gt;We still need to work out why the broker is tryping to store a dup message in the first place.&lt;/p&gt;</comment>
                            <comment id="12941815" author="chirino" created="Fri, 2 Oct 2009 18:00:47 +0000"  >&lt;p&gt;Rob want to take a crack at figuring out whats causing the dup on the network?&lt;/p&gt;</comment>
                            <comment id="12940915" author="gtully" created="Tue, 6 Oct 2009 11:21:17 +0000"  >&lt;p&gt;the dups are coming from ignored acks from the network bridge.&lt;br/&gt;
The network consumer with default prefetch is happy to take all of the messages and they are dispatched async. During the dispatch, the remove consumer is happy with its 500 messages and closes. The close propagates back to the network consumer but between the consumer remove operation and the disposing of the bridge a few messages are dispatched but cannot be acked.&lt;/p&gt;

&lt;p&gt;Some logic in: org.apache.activemq.broker.region.AbstractRegion.acknowledge(ConsumerBrokerExchange, MessageAck) is happy to silently ignore the ack and the result is a resend.&lt;/p&gt;

&lt;p&gt;The remove signal should terminate dispatch and await any outstanding ack but not hang forever. need to investigate a bit more to see if there is a solution.&lt;/p&gt;</comment>
                            <comment id="12941110" author="gtully" created="Wed, 7 Oct 2009 16:09:44 +0000"  >&lt;p&gt;patch that resolves the duplicate issue, worth a quick review (as I am just doing a test run atm) of the org.apache.activemq.network.DemandSubscription.waitForCompletion() implementation.&lt;br/&gt;
I pulled the existing logic for dealing with acks for no subscriptions in AbstractRegion that was the root cause. With the changes, any acks that don&apos;t have a sub should be considered an error and result in an exception.&lt;br/&gt;
will commit pending no issues showing up in my local test run.&lt;/p&gt;</comment>
                            <comment id="12941113" author="gtully" created="Wed, 7 Oct 2009 17:46:07 +0000"  >&lt;p&gt;resolved in r822811&lt;/p&gt;

&lt;p&gt;async dispatch of messages by the bridge was resulting in acks to removed subs as the response to a remove advisory did not know about outstanding requests, the sub now waits till outstanding delivered messages have been acked such that it will not deliver duplicates.&lt;/p&gt;</comment>
                            <comment id="12941149" author="chirino" created="Wed, 7 Oct 2009 18:38:31 +0000"  >&lt;p&gt;applied my kahadb changes to the 5.3 branch.&lt;/p&gt;</comment>
                            <comment id="12941363" author="gtully" created="Thu, 8 Oct 2009 10:02:22 +0000"  >&lt;p&gt;dito. merged duplicate message fix to 5.3 branch: r822811&lt;/p&gt;</comment>
                            <comment id="12941606" author="cmacnaug" created="Fri, 13 Nov 2009 01:17:47 +0000"  >&lt;p&gt;Seeing the exception below in a 2 broker cluster with this fix which is causing the cluster network connection to be dropped. When an MessageDispatch that was sent async is sent through the bridge, it is sent oneway over the transport and then acked back to the local broker in the sending thread. The problem is that peer broker might concurrently be closing the subscription during the send, and the resulting ack now generates an IllegalStateException when the subscription isn&apos;t found. To fix, I&apos;m adding tighter synchronization around subscription tear down to avoid this case. (See attached patch)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;22:19:55 [REMOTE] BROKER1: 22:19:55 WARN  AbstractRegion: Ack &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; non existent subscription, ack:MessageAck {commandId = 8392, responseRequired = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, ackType = 4, 
consumerId = ID:nbcmacnaug1-3881-1257920362625-5:1:1:6, firstMessageId = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, lastMessageId = ID:nbcmacnaug1-3919-1257920382750-1:14:1:1:1236, 
destination = queue:&lt;span class=&quot;code-comment&quot;&gt;//QUEUE-Profile-6, transactionId = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, messageCount = 1} 
&lt;/span&gt;22:19:55 [REMOTE] BROKER1: 22:19:55 WARN  Service: Async error occurred: java.lang.IllegalArgumentException: The subscription does not exist: ID:nbcmacnaug1-3881-1257920362625-5:1:1:6 
22:19:55 [REMOTE] BROKER1: java.lang.IllegalArgumentException: The subscription does not exist: ID:nbcmacnaug1-3881-1257920362625-5:1:1:6 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:363) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:470) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:85) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:449) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.command.MessageAck.visit(MessageAck.java:205) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:297) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:175) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:109) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.transport.vm.VMTransport.oneway(VMTransport.java:112) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:40) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.network.DemandForwardingBridgeSupport.serviceLocalCommand(DemandForwardingBridgeSupport.java:708) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.network.DemandForwardingBridgeSupport$1.onCommand(DemandForwardingBridgeSupport.java:159) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:109) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.transport.vm.VMTransport.oneway(VMTransport.java:112) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:40) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.broker.TransportConnection.dispatch(TransportConnection.java:1190) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.broker.TransportConnection.processDispatch(TransportConnection.java:779) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.broker.TransportConnection.iterate(TransportConnection.java:815) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:122) 
22:19:55 [REMOTE] BROKER1: 	at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:43) 
22:19:55 [REMOTE] BROKER1: 	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650) 
22:19:55 [REMOTE] BROKER1: 	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675) 
22:19:55 [REMOTE] BROKER1: 	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:595) 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12941688" author="cmacnaug" created="Fri, 13 Nov 2009 02:59:45 +0000"  >&lt;p&gt;Patch for IllegalState Issue  (against revision 835714)&lt;/p&gt;</comment>
                            <comment id="12941689" author="cmacnaug" created="Fri, 13 Nov 2009 03:04:55 +0000"  >&lt;p&gt;Fixed IllegalStateException issue in revision 835715.&lt;/p&gt;</comment>
                            <comment id="12941690" author="cmacnaug" created="Fri, 13 Nov 2009 03:06:04 +0000"  >&lt;p&gt;Changing fix to 5.3.1/5.4.0&lt;/p&gt;</comment>
                            <comment id="12941776" author="gtully" created="Fri, 13 Nov 2009 16:13:48 +0000"  >&lt;p&gt;nice catch, looks good. that is the final bit of the puzzle. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461334" name="AMQ-2439patch.txt" size="33055" author="cmacnaug" created="Fri, 13 Nov 2009 02:59:45 +0000"/>
                            <attachment id="12461445" name="amq2439-patch.diff" size="12788" author="gtully" created="Wed, 7 Oct 2009 16:09:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>74947</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rqbb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>159907</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310080" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Regression</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10091"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>