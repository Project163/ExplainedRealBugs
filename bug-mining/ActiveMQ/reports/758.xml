<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:43:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2478] Too many files open error, after no space left on device occurs; if producer carries on sending messages.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2478</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;The problem seem to be that open the persistence store (disk) has run out of space, if the producer keeps on sending messages to the broker the brokers end up eating up the file descriptors for the process (default 1024), and you get the error &quot;too many open files&quot;.  The only way to fix this is a broker restart.&lt;/p&gt;

&lt;p&gt;1) Producer is sending to the broker&lt;br/&gt;
2) Disk Space on the broker runs out&lt;br/&gt;
3) The producer gets the error:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2009.11.02 23:05:30&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO  ProducerTool -  Sent Message:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;18973 : ^@^@OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO...&amp;#93;&lt;/span&gt;, took: 1ms&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2009.11.02 23:05:30&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; WARN  ProducerTool -  Error sending&lt;br/&gt;
message:18974 : &lt;sup&gt;@&lt;/sup&gt;@OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO...&lt;br/&gt;
javax.jms.JMSException: No space left on device&lt;br/&gt;
      at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:49)&lt;br/&gt;
      at org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1255)&lt;/p&gt;

&lt;p&gt;4)  The broker gets the error:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DEBUG Service                        - Error occured &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing
async command: MessageAck {commandId = 53297, responseRequired =
&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, ackType = 2, consumerId =
ID:dominic-tootells-macbook-pro.local-57138-1257203010059-0:0:-1:2,
firstMessageId =
ID:dominic-tootells-macbook-pro.local-57143-1257203033952-0:0:1:1:17751,
lastMessageId =
ID:dominic-tootells-macbook-pro.local-57143-1257203033952-0:0:1:1:17751,
destination = queue:&lt;span class=&quot;code-comment&quot;&gt;//iplayer, transactionId =
&lt;/span&gt;TX:ID:dominic-tootells-macbook-pro.local-57138-1257203010059-0:0:17751,
messageCount = 1}, exception: java.io.IOException: No space left on
device
java.io.IOException: No space left on device
       at java.io.RandomAccessFile.setLength(Native Method)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;5) All is good if you spot this and go clear up some space quick&lt;br/&gt;
sharp; both the broker and the producer recover and can carry one.&lt;br/&gt;
However, if you don&apos;t notice and react quick enough, and the producer&lt;br/&gt;
keeps on sending messages to the broker, then broker ends up with the&lt;br/&gt;
error &quot;too many open files&quot;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Id = ID:dominic-tootells-macbook-pro.local-57143-1257203033952-0:0:1:1:35920,
lastMessageId =
ID:dominic-tootells-macbook-pro.local-57143-1257203033952-0:0:1:1:35920,
destination = queue:&lt;span class=&quot;code-comment&quot;&gt;//iplayer, transactionId =
&lt;/span&gt;TX:ID:dominic-tootells-macbook-pro.local-57138-1257203010059-0:0:52674,
messageCount = 1}, exception: java.io.FileNotFoundException:
/Volumes/SSD/data/journal/data-4 (Too many open files)
java.io.FileNotFoundException: /Volumes/SSD/data/journal/data-4 (Too
many open files)
       at java.io.RandomAccessFile.open(Native Method)
       at java.io.RandomAccessFile.&amp;lt;init&amp;gt;(RandomAccessFile.java:212)
       at org.apache.activemq.kaha.impl.async.DataFile.openRandomAccess
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Trying the following combinations:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;no failover protocol&lt;/li&gt;
	&lt;li&gt;no send sendFailIfNoSpace being sent to the producer&lt;/li&gt;
	&lt;li&gt;recreating the producer connection after the error&lt;/li&gt;
	&lt;li&gt;no consumer attached to the broker&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In the end I attached JProfiler to the broker (via a small junit), and&lt;br/&gt;
noticed that upon the &quot;No space left on device&quot; error the number of&lt;br/&gt;
File objects and FileDescriptor objects would grow, and not shrink.&lt;br/&gt;
Upon looking at the below stack trace:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Caused by: java.io.IOException: No space left on device
       at java.io.RandomAccessFile.setLength(Native Method)
       at org.apache.activemq.kaha.impl.async.DataFile.openRandomAccessFile(DataFile.java:96)
       at org.apache.activemq.kaha.impl.async.AsyncDataManager.allocateLocation(AsyncDataManager.java:276)
       at org.apache.activemq.kaha.impl.async.DataFileAppender.storeItem(DataFileAppender.java:169)
       at org.apache.activemq.kaha.impl.async.AsyncDataManager.write(AsyncDataManager.java:647)
       at org.apache.activemq.store.amq.AMQPersistenceAdapter.writeCommand(AMQPersistenceAdapter.java:697)
       at org.apache.activemq.store.amq.AMQPersistenceAdapter.writeCommand(AMQPersistenceAdapter.java:693)
       at org.apache.activemq.store.amq.AMQMessageStore.addMessage(AMQMessageStore.java:106)
       at org.apache.activemq.broker.region.Queue.doMessageSend(Queue.java:503)
       at org.apache.activemq.broker.region.Queue.send(Queue.java:480)
       at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:354)
       at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:443)
       at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:224)
       at org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:95)
       at org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:133)
       at org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:455)
       at org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:639)
       at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:308)
       at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:182)
       at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)
       at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113)
       at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:210)
       at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)
       at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:203)
       at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:185)
       at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:637)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I took a look at:&lt;/p&gt;

&lt;p&gt;org.apache.activemq.kaha.impl.async.DataFile.openRandomAccessFile(DataFile.java:96):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; RandomAccessFile openRandomAccessFile(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;
appender) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
       RandomAccessFile rc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RandomAccessFile(file, &lt;span class=&quot;code-quote&quot;&gt;&quot;rw&quot;&lt;/span&gt;);
       &lt;span class=&quot;code-comment&quot;&gt;// When we start to write files size them up so that the OS has a chance
&lt;/span&gt;       &lt;span class=&quot;code-comment&quot;&gt;// to allocate the file contigously.
&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (appender) {
           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (length &amp;lt; preferedSize) {
                       rc.setLength(preferedSize);
           }
       }
       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; rc;
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;  The problem is the rc.setLength(preferedSize);  without a try/catch&lt;br/&gt;
block to close the opened file incase of a IOException, that can&lt;br/&gt;
result from the setLength on empty filesystem.&lt;/p&gt;

&lt;p&gt;  Changing the method to, contain a try/catch as follows, from my testing appears to fix the&lt;br/&gt;
issue (have tried on my local broker, and this works).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; RandomAccessFile openRandomAccessFile(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;
appender) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
       RandomAccessFile rc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RandomAccessFile(file, &lt;span class=&quot;code-quote&quot;&gt;&quot;rw&quot;&lt;/span&gt;);
       &lt;span class=&quot;code-comment&quot;&gt;// When we start to write files size them up so that the OS has a chance
&lt;/span&gt;       &lt;span class=&quot;code-comment&quot;&gt;// to allocate the file contigously.
&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (appender) {
           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (length &amp;lt; preferedSize) {
               &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
               {
                       rc.setLength(preferedSize);
               }
               &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(IOException e)
               {
                       &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
                       {
                               rc.close();
                       }
                       &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(Exception closeException){}
                       &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
               }

           }
       }
       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; rc;
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;I shall attach a junit for testing (it is hard coded to write to my small removal disk /Volumes/SSD/data), so this you will need to change.  I need somewhere where I could fill the disk up.  The Junit just does:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Producer writes to a persistent queue until the disk space fills up and keeps on going.  After a while you see the &quot;too many open files&quot; exception.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;ve looked at trunk&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://svn.apache.org/repos/asf/activemq/trunk/activemq-core/src/main/java/org/apache/activemq/kaha/impl/async/DataFile.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/activemq/trunk/activemq-core/src/main/java/org/apache/activemq/kaha/impl/async/DataFile.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;And this has the same code as the 5.3.0.4 so I&apos;m guessing that would have the same issue.&lt;/p&gt;

&lt;p&gt;I&apos;ll attach the junit, the patch diff and the patch file.&lt;br/&gt;
/dom&lt;/p&gt;
</description>
                <environment>&lt;p&gt;MacOSX 10.6.1, fusesource broker 5.3.0.4.&lt;/p&gt;</environment>
        <key id="12481607">AMQ-2478</key>
            <summary>Too many files open error, after no space left on device occurs; if producer carries on sending messages.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="dominict">Dominic Tootell</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 Nov 2009 13:51:00 +0000</created>
                <updated>Thu, 12 Nov 2009 11:31:10 +0000</updated>
                            <resolved>Thu, 5 Nov 2009 16:32:35 +0000</resolved>
                                    <version>5.3.0</version>
                                    <fixVersion>5.3.1</fixVersion>
                    <fixVersion>5.4.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12941449" author="dominict" created="Thu, 5 Nov 2009 13:56:44 +0000"  >&lt;p&gt;patchfile.txt&lt;br/&gt;
DataFile.java (which was the patch in)&lt;br/&gt;
TooManyFilesTest.java (JUnit)&lt;/p&gt;</comment>
                            <comment id="12941475" author="gtully" created="Thu, 5 Nov 2009 16:32:35 +0000"  >&lt;p&gt;patch applied with thanks in r833074 - left test case with the jira as it requires a small disk. Works ok with the new kahaDB also which is good.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461333" name="DataFile.java" size="4263" author="dominict" created="Thu, 5 Nov 2009 13:56:44 +0000"/>
                            <attachment id="12461331" name="TooManyFilesTest.java" size="9899" author="dominict" created="Thu, 5 Nov 2009 13:56:44 +0000"/>
                            <attachment id="12461332" name="patchfile.txt" size="8652" author="dominict" created="Thu, 5 Nov 2009 13:56:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38748</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 3 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rqnj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>159962</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>