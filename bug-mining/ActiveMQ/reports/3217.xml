<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:45:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-7115] Deadlock between MQTTInactivityMonitor and BrokerService Threads</title>
                <link>https://issues.apache.org/jira/browse/AMQ-7115</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;MQTT with nio+ssl, thread dead lock on concurrent processing socket read error and inactivity monitor exception.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Found one Java-level deadlock:
=============================
&lt;span class=&quot;code-quote&quot;&gt;&quot;MQTTInactivityMonitor Async Task: java.util.concurrent.ThreadPoolExecutor$Worker@7e51223f[State = -1, empty queue]&quot;&lt;/span&gt;:
 waiting to lock monitor 0x00007fd54c06d268 (object 0x00000003f63c3d50, a org.apache.activemq.broker.jmx.ManagedTransportConnection),
 which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;ActiveMQ BrokerService[AMQ2] Task-38733&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;ActiveMQ BrokerService[AMQ2] Task-38733&quot;&lt;/span&gt;:
 waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ownable synchronizer 0x0000000436d5d458, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),
 which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;MQTTInactivityMonitor Async Task: java.util.concurrent.ThreadPoolExecutor$Worker@7e51223f[State = -1, empty queue]&quot;&lt;/span&gt;

Java stack information &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the threads listed above:
===================================================
&lt;span class=&quot;code-quote&quot;&gt;&quot;MQTTInactivityMonitor Async Task: java.util.concurrent.ThreadPoolExecutor$Worker@7e51223f[State = -1, empty queue]&quot;&lt;/span&gt;:
 at org.apache.activemq.broker.TransportConnection.processRemoveConnection(TransportConnection.java:870)
 - waiting to lock &amp;lt;0x00000003f63c3d50&amp;gt; (a org.apache.activemq.broker.jmx.ManagedTransportConnection)
 at org.apache.activemq.command.RemoveInfo.visit(RemoveInfo.java:73)
 at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:326)
 at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:190)
 at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:45)
 at org.apache.activemq.transport.mqtt.MQTTInactivityMonitor.onCommand(MQTTInactivityMonitor.java:162)
 at org.apache.activemq.transport.mqtt.MQTTTransportFilter.sendToActiveMQ(MQTTTransportFilter.java:106)
 at org.apache.activemq.transport.mqtt.MQTTProtocolConverter.sendToActiveMQ(MQTTProtocolConverter.java:181)
 at org.apache.activemq.transport.mqtt.MQTTProtocolConverter.onTransportError(MQTTProtocolConverter.java:650)
 at org.apache.activemq.transport.mqtt.MQTTInactivityMonitor.onException(MQTTInactivityMonitor.java:194)
 at org.apache.activemq.transport.mqtt.MQTTInactivityMonitor$2$1.run(MQTTInactivityMonitor.java:128)
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
 at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;span class=&quot;code-quote&quot;&gt;&quot;ActiveMQ BrokerService[AMQ2] Task-38733&quot;&lt;/span&gt;:
 at sun.misc.Unsafe.park(Native Method)
 - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &amp;lt;0x0000000436d5d458&amp;gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)
 at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
 at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)
 at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:870)
 at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1199)
 at java.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:209)
 at java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:285)
 at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:43)
 at org.apache.activemq.transport.mqtt.MQTTInactivityMonitor.onCommand(MQTTInactivityMonitor.java:162)
 at org.apache.activemq.transport.mqtt.MQTTTransportFilter.sendToActiveMQ(MQTTTransportFilter.java:106)
 at org.apache.activemq.transport.mqtt.MQTTProtocolConverter.sendToActiveMQ(MQTTProtocolConverter.java:181)
 at org.apache.activemq.transport.mqtt.MQTTProtocolConverter.onTransportError(MQTTProtocolConverter.java:650)
 at org.apache.activemq.transport.mqtt.MQTTTransportFilter.onException(MQTTTransportFilter.java:206)
 at org.apache.activemq.transport.TransportSupport.onException(TransportSupport.java:96)
 at org.apache.activemq.transport.nio.NIOSSLTransport.serviceRead(NIOSSLTransport.java:225)
 at org.apache.activemq.transport.mqtt.MQTTNIOSSLTransport.initializeStreams(MQTTNIOSSLTransport.java:48)
 at org.apache.activemq.transport.tcp.TcpTransport.connect(TcpTransport.java:519)
 at org.apache.activemq.transport.nio.NIOTransport.doStart(NIOTransport.java:160)
 at org.apache.activemq.transport.nio.NIOSSLTransport.doStart(NIOSSLTransport.java:412)
 at org.apache.activemq.util.ServiceSupport.start(ServiceSupport.java:55)
 at org.apache.activemq.transport.TransportFilter.start(TransportFilter.java:58)
 at org.apache.activemq.transport.mqtt.MQTTTransportFilter.start(MQTTTransportFilter.java:157)
 at org.apache.activemq.transport.mqtt.MQTTInactivityMonitor.start(MQTTInactivityMonitor.java:148)
 at org.apache.activemq.transport.TransportFilter.start(TransportFilter.java:58)
 at org.apache.activemq.broker.TransportConnection.start(TransportConnection.java:1066)
 - locked &amp;lt;0x00000003f63c3d50&amp;gt; (a org.apache.activemq.broker.jmx.ManagedTransportConnection)
 at org.apache.activemq.broker.TransportConnector$1$1.run(TransportConnector.java:218)
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
 at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)\{code}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;&amp;lt;transportConnector name=&quot;mqtt+nio+ssl&quot; uri=&quot;mqtt+nio+ssl://0.0.0.0:62062?maximumConnections=200000&amp;amp;wireFormat.maxFrameSize=104857600&amp;amp;transport.subscriptionStrategy=mqtt-virtual-topic-subscriptions&quot;/&amp;gt;&lt;/p&gt;</environment>
        <key id="13201120">AMQ-7115</key>
            <summary>Deadlock between MQTTInactivityMonitor and BrokerService Threads</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="gtully">Gary Tully</reporter>
                        <labels>
                    </labels>
                <created>Wed, 28 Nov 2018 14:22:53 +0000</created>
                <updated>Thu, 29 Nov 2018 11:51:34 +0000</updated>
                            <resolved>Wed, 28 Nov 2018 15:06:29 +0000</resolved>
                                    <version>5.15.0</version>
                                    <fixVersion>5.16.0</fixVersion>
                                    <component>MQTT</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16701953" author="gtully" created="Wed, 28 Nov 2018 14:25:29 +0000"  >&lt;p&gt;The serviceRead with the start lock held can only occur if it wins the race with the async serviceRead introduced via: &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6414&quot; title=&quot;The nio+ssl transports can block and hang on connection in certain situations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6414&quot;&gt;&lt;del&gt;AMQ-6414&lt;/del&gt;&lt;/a&gt; - however it should never be servicing the error twice.&lt;/p&gt;</comment>
                            <comment id="16701955" author="jira-bot" created="Wed, 28 Nov 2018 14:28:14 +0000"  >&lt;p&gt;Commit 6d4459a00c2441822297b06221bb107c5843c390 in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=6d4459a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=6d4459a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7115&quot; title=&quot;Deadlock between MQTTInactivityMonitor and BrokerService Threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7115&quot;&gt;&lt;del&gt;AMQ-7115&lt;/del&gt;&lt;/a&gt; - ensure transport error handling is a one shot for a connection - avoid contention and possible dead lock - fix and test&lt;/p&gt;</comment>
                            <comment id="16703070" author="gtully" created="Thu, 29 Nov 2018 11:51:34 +0000"  >&lt;p&gt;TLS session resume avoiding an rtt allows application data to piggyback on handshake completion tcp frames, this change in choreography is the root cause of the difference leading to deadlock. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13002097">AMQ-6414</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 50 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00yg0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>