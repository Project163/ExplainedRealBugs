<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:38:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3166] client calls to createProducer() and send() successful even though BrokerFilter methods throw exceptions</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3166</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Client calls to createProducer() always return without an error even though a BrokerFilter&apos;s addProducer() method throws an exception on the request. In contrast, createConsumer() throws an exception, as expected, when BrokerFilter&apos;s addConsumer() throws an exception.&lt;/p&gt;

&lt;p&gt;Clients using transacted sessions always return successfully from send() when a BrokerFilter&apos;s send() method throws an exception.&lt;/p&gt;

&lt;p&gt;Below is a broker configuration file using &amp;lt;authorizationPlugin&amp;gt; to illustrate the problem.&lt;/p&gt;

&lt;p&gt;To reproduce the problem With this configuration, a test client only needs to connect with user = &quot;user&quot; and password = &quot;password&quot;, and then attempt to produce messages with a transacted session to any queue other than ABC (e.g. DEF).&lt;/p&gt;

&lt;p&gt;Tracing the cause of the issue has lead to finding that the client code for creating a producer uses an Async send for the producer information.  The analogous code for consumers uses a Sync send.&lt;/p&gt;

&lt;p&gt;I will work on a patch.  It would be very helpful to have feedback on the operation of the bus and the best way to resolve this problem.  Based on my research, it seems that createProducer() should be using a Sync send in place of the Async one.  Not yet sure about send().  Another possibility is to move the security operations to earlier in the internal broker flow.&lt;/p&gt;

&lt;p&gt;=== SAMPLE BROKER XML ===&lt;/p&gt;

&lt;p&gt;&amp;lt;beans&lt;br/&gt;
  xmlns=&quot;http://www.springframework.org/schema/beans&quot;&lt;br/&gt;
  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&lt;br/&gt;
  xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans &lt;a href=&quot;http://www.springframework.org/schema/beans/spring-beans-2.0.xsd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.springframework.org/schema/beans/spring-beans-2.0.xsd&lt;/a&gt;&lt;br/&gt;
  &lt;a href=&quot;http://activemq.apache.org/schema/core&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/schema/core&lt;/a&gt; &lt;a href=&quot;http://activemq.apache.org/schema/core/activemq-core.xsd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/schema/core/activemq-core.xsd&lt;/a&gt;&quot;&amp;gt;&lt;/p&gt;

&lt;p&gt;    &amp;lt;broker xmlns=&quot;http://activemq.apache.org/schema/core&quot;&lt;br/&gt;
            brokerName=&quot;localhost&quot;&lt;br/&gt;
            dataDirectory=&quot;${activemq.base}/data&quot;&lt;br/&gt;
            destroyApplicationContextOnStop=&quot;true&quot; &amp;gt;&lt;/p&gt;

&lt;p&gt;        &amp;lt;persistenceAdapter&amp;gt;&lt;br/&gt;
            &amp;lt;kahaDB directory=&quot;${activemq.base}/data/kahadb&quot;/&amp;gt;&lt;br/&gt;
        &amp;lt;/persistenceAdapter&amp;gt;&lt;/p&gt;

&lt;p&gt;        &amp;lt;plugins&amp;gt;&lt;br/&gt;
          &amp;lt;simpleAuthenticationPlugin anonymousAccessAllowed=&quot;true&quot;&amp;gt;&lt;br/&gt;
              &amp;lt;users&amp;gt;&lt;br/&gt;
                  &amp;lt;authenticationUser username=&quot;user&quot; password=&quot;password&quot;&lt;br/&gt;
                      groups=&quot;users&quot;/&amp;gt;&lt;br/&gt;
              &amp;lt;/users&amp;gt;&lt;br/&gt;
          &amp;lt;/simpleAuthenticationPlugin&amp;gt;&lt;/p&gt;

&lt;p&gt;          &amp;lt;authorizationPlugin&amp;gt;&lt;br/&gt;
              &amp;lt;map&amp;gt;&lt;br/&gt;
                  &amp;lt;authorizationMap&amp;gt;&lt;br/&gt;
                    &amp;lt;authorizationEntries&amp;gt;&lt;br/&gt;
                      &amp;lt;authorizationEntry queue=&quot;ABC&quot; read=&quot;users&quot; write=&quot;users&quot; admin=&quot;users&quot; /&amp;gt;&lt;br/&gt;
                      &amp;lt;authorizationEntry topic=&quot;ActiveMQ.Advisory.&amp;gt;&quot; read=&quot;users&quot; write=&quot;users&quot; admin=&quot;users&quot; /&amp;gt;&lt;br/&gt;
                    &amp;lt;/authorizationEntries&amp;gt;&lt;br/&gt;
                  &amp;lt;/authorizationMap&amp;gt;&lt;br/&gt;
              &amp;lt;/map&amp;gt;&lt;br/&gt;
          &amp;lt;/authorizationPlugin&amp;gt;&lt;br/&gt;
        &amp;lt;/plugins&amp;gt;&lt;/p&gt;

&lt;p&gt;        &amp;lt;transportConnectors&amp;gt;&lt;br/&gt;
            &amp;lt;transportConnector name=&quot;openwire&quot; uri=&quot;tcp://0.0.0.0:61616&quot;/&amp;gt;&lt;br/&gt;
        &amp;lt;/transportConnectors&amp;gt;&lt;br/&gt;
    &amp;lt;/broker&amp;gt;&lt;br/&gt;
&amp;lt;/beans&amp;gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12497014">AMQ-3166</key>
            <summary>client calls to createProducer() and send() successful even though BrokerFilter methods throw exceptions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="artnaseef">Arthur Naseef</reporter>
                        <labels>
                    </labels>
                <created>Fri, 28 Jan 2011 05:35:45 +0000</created>
                <updated>Tue, 22 Nov 2016 16:27:50 +0000</updated>
                            <resolved>Wed, 25 May 2016 10:39:34 +0000</resolved>
                                    <version>5.4.2</version>
                    <version>5.5.0</version>
                                    <fixVersion>5.14.0</fixVersion>
                                    <component>Broker</component>
                    <component>JMS client</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="12989833" author="artnaseef" created="Wed, 2 Feb 2011 22:24:13 +0000"  >&lt;p&gt;Research found the following:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The exceptions are being sent over the transport from the broker to the client&lt;/li&gt;
	&lt;li&gt;Client handling does not propogate the exception back through send() or commit() calls&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It appears this is caused by the producer using async sends.  Looking at ActiveMQSession:&lt;/p&gt;

&lt;p&gt;            if (sendTimeout &amp;lt;= 0 &amp;amp;&amp;amp; !msg.isResponseRequired() &amp;amp;&amp;amp; !connection.isAlwaysSyncSend() &amp;amp;&amp;amp;&lt;br/&gt;
                (!msg.isPersistent() || connection.isUseAsyncSend() || txid != null)) {&lt;br/&gt;
                this.connection.asyncSendPacket(msg);&lt;/p&gt;

&lt;p&gt;msg.isResponseRequire() defaults to false for most transport commands, including Message.  Taking advantage of the &quot;isAlwaysSyncSend()&quot; logic above, the following works-around the issue (when clients can be modified to use it):&lt;/p&gt;

&lt;p&gt;                org.apache.activemq.ActiveMQConnectionFactory   conn_fact;&lt;br/&gt;
                ...&lt;br/&gt;
                conn_fact.setAlwaysSyncSend(true);&lt;/p&gt;

&lt;p&gt;Attempts to use URI parameters, and searches through the code for URI parameters, have yielded no working solutions there.  If the connection URL could include a setting such as &quot;?connection.alwaysSyncSend=true&quot; would make this problem easier to solve since most clients use a configurable connection string.&lt;/p&gt;

&lt;p&gt;However, with all of that said, it seems that transacted sends - as well as creating producers - should be synchronous.  That can be solved by taking out the &quot;txid != null&quot; logic.&lt;/p&gt;

&lt;p&gt;For further performance improvement over transacted sends, if a client wants batch sending, which is not part of the JMS standard, it makes sense to require clients to use ActiveMQ-specific features.  Perhaps a batchSend() method followed by batchComplete().&lt;/p&gt;</comment>
                            <comment id="12994586" author="artnaseef" created="Tue, 15 Feb 2011 00:21:58 +0000"  >&lt;p&gt;JUnit test program with 3 test cases:&lt;br/&gt;
   1. Transacted sends which illustrate the problem&lt;br/&gt;
   2. Transacted sends using a work-around&lt;br/&gt;
   3. Non-transacted sends which do not have this problem&lt;/p&gt;</comment>
                            <comment id="12994589" author="artnaseef" created="Tue, 15 Feb 2011 00:31:30 +0000"  >&lt;p&gt;Corrected source.  The previous one contained a typo.&lt;/p&gt;</comment>
                            <comment id="13041766" author="artnaseef" created="Tue, 31 May 2011 19:17:48 +0000"  >&lt;p&gt;Confirmed with 5.5.0 as well.  Note that an activemq-cpp client was tested with the same results.&lt;/p&gt;</comment>
                            <comment id="13041991" author="artnaseef" created="Wed, 1 Jun 2011 05:40:24 +0000"  >&lt;p&gt;I finally walked through the entire IntrospectionSupport and query handling for an ActiveMQConnection and found that the following on the URL works around the issue as well:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;...?jms.alwaysSyncSend=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;         (JAVA CLIENT)
...?connection.alwaysSyncSend=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;  (C++ CLIENT: activemq-cpp)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For TRANSACTIONS, I recommend that the extra logic be added to use sync sends by default because that matches the the JMS standard - and what I believe clients expect across all JMS providers - but with a setting that allows clients to override that operation.  Perhaps the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;...?jms.transactionAsyncSend=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;    =&amp;gt; (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;) don&apos;t use async sends with transactions
...?jms.transactionAsyncSend=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;     =&amp;gt; use async sends with transactions
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;By the way, shouldn&apos;t the activemq-cpp library support &quot;jms.&quot; as the prefix for connection parameters in the same way the Java code does?  Otherwise, we have to make sure URL&apos;s are client-implementation-specific.&lt;/p&gt;

&lt;p&gt;The subset of logic for async sends on transactions would be as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;IF (session IS transacted ) AND ( not alwaysSyncSend ) AND ( transactionAsyncSend )
THEN
  SEND async
ELSE
  SEND sync
END IF
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A patch with this update will be coming soon.&lt;/p&gt;</comment>
                            <comment id="13042113" author="gtully" created="Wed, 1 Jun 2011 11:25:07 +0000"  >&lt;p&gt;I agree, it would be better if the cpp client respected the same naming convention, not sure why that is not the case.&lt;/p&gt;

&lt;p&gt;The logic for async send with transactions follows from a commit/rollback being sent sync. There is no real work done on the broker till the transaction completes, this sort of batching is expected with multiple message sends in a transaction.&lt;br/&gt;
For the use case where a broker filter throws an exception, having commit fail would make some sense for the transacted case.&lt;br/&gt;
For a producer, I am not sure of the value of local transactions unless there is batching.&lt;br/&gt;
Having said that, having a transacted send respect alwaysSyncSend is no harm as it defaults to false. &lt;/p&gt;</comment>
                            <comment id="13042158" author="tabish121" created="Wed, 1 Jun 2011 13:18:56 +0000"  >&lt;p&gt;The C&amp;#43;&amp;#43; client doesn&apos;t respect the jms option prefix for a few reasons, foremost being that its not a JMS client it implements CMS a JMS-like API that can and does vary somewhat from the JMS spec.  Also because the options vary between the C&amp;#43;&amp;#43;, .NET and Java client having the URI syntax be identical presents a false equivalence about what behaviour your URI options will produce in the case where you specify options that don&apos;t currently exist in the client of your choosing.   In the .NET client we prefix URI options with nms.* for the same reason.  It could be argued that the C&amp;#43;&amp;#43; client should offer its options as cms.* and that would be fine with me, however nobody has stepped up to do the work involved in writing a better URI option parser so its remained as it is now.&lt;/p&gt;</comment>
                            <comment id="13054547" author="artnaseef" created="Fri, 24 Jun 2011 17:00:11 +0000"  >&lt;p&gt;Broker Filter which remembers failures on transactions and fails all subsequent operations (except rollbacks), including commit().&lt;/p&gt;</comment>
                            <comment id="13054548" author="artnaseef" created="Fri, 24 Jun 2011 17:00:33 +0000"  >&lt;p&gt;BrokerPlugin for the filter.&lt;/p&gt;</comment>
                            <comment id="13054554" author="artnaseef" created="Fri, 24 Jun 2011 17:05:32 +0000"  >&lt;p&gt;Sorry for the slow response.&lt;/p&gt;

&lt;p&gt;I think the fail-on-commit is a feasible solution and have attached a Broker Filter which makes that happen.  There are a couple of non-optimal aspects to this solution, but I wanted to put it out for consideration/feedback.&lt;/p&gt;

&lt;p&gt;The two concerns I have with this solution are:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Only failures that occur after the filter in the broker&apos;s filter chain will be detected and handled.&lt;/li&gt;
	&lt;li&gt;Clients may continue for a while after a failure, likely performing throw-away work.
	&lt;ul&gt;
		&lt;li&gt;I would like to address this with a new message back to the client specifically indicating the transaction failure.&lt;/li&gt;
		&lt;li&gt;Client logic would then be needed to check the transaction on send() and receive()/acknowledge() calls.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Please let me know.  If this looks like a feasible solution, I&apos;ll create JUnit tests that incorporate this feature.&lt;/p&gt;</comment>
                            <comment id="13054555" author="artnaseef" created="Fri, 24 Jun 2011 17:07:44 +0000"  >&lt;p&gt;Corrected the package name.&lt;/p&gt;</comment>
                            <comment id="13054556" author="artnaseef" created="Fri, 24 Jun 2011 17:08:01 +0000"  >&lt;p&gt;Corrected the package name.&lt;/p&gt;</comment>
                            <comment id="13526810" author="tabish121" created="Fri, 7 Dec 2012 21:49:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4213&quot; title=&quot;ActiveMQMessageProducer sends producer registration async which causes it to miss possible exceptions on creation like security exceptions.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4213&quot;&gt;&lt;del&gt;AMQ-4213&lt;/del&gt;&lt;/a&gt; - This resolves the complaint that the createProducer should be sync.  &lt;/p&gt;</comment>
                            <comment id="13915454" author="artnaseef" created="Fri, 28 Feb 2014 04:39:34 +0000"  >&lt;p&gt;Let&apos;s get this fixed.  It&apos;s a violation of the JMS spec that transactions are not reliable.&lt;/p&gt;

&lt;p&gt;I see two options.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Make the client libraries perform sends synchronously.&lt;/li&gt;
	&lt;li&gt;Have the broker retain state of failures and propogate failed sends to failed commits.
	&lt;ul&gt;
		&lt;li&gt;Consider a way to propogate failures quickly so that a producer with large numbers of messages does not waste all that effort only to have the commit fail a long time later.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The downside of the first option is a likely loss of performance.  However, the second option is more complex to code and prevents possible intelligence in clients to perform better handling of issues like individual failed sends in a transaction (consider a client wanting to have logic to recover from a single failed send in a larger transaction).&lt;/p&gt;</comment>
                            <comment id="13915455" author="artnaseef" created="Fri, 28 Feb 2014 04:40:41 +0000"  >&lt;p&gt;Anyone with thoughts on (a) the best approach to resolving this, and (b) avoiding reduced performance, please speak up.&lt;/p&gt;</comment>
                            <comment id="13915706" author="gtully" created="Fri, 28 Feb 2014 12:03:11 +0000"  >&lt;p&gt;thinking just in terms of sends and acks, if a request (sync or sync) results in an exception, then the transaction should be marked rollbackOnly. There may be wasted work but at least the outcome will be deterministic. all of nothing.&lt;br/&gt;
this can probably be handled in org.apache.activemq.broker.TransportConnection#service with some additional rollbackOnly logic in transaction. Or maybe just a rollback immediately will do it.&lt;/p&gt;</comment>
                            <comment id="13917639" author="artnaseef" created="Mon, 3 Mar 2014 00:21:59 +0000"  >&lt;p&gt;Thanks Gary - I&apos;ll look at TransportConnection&apos;s service method.&lt;/p&gt;

&lt;p&gt;While I tend to agree the extra work may not be a problem, I&apos;d like to see if there&apos;s a simple, straight-forward way to solve it.  I&apos;ve seen this lead to thousands of errors logged in an application for a single request.  One idea is to propogate the failure by sending a transport command back to the client that says the transaction failed so the client library can then respond immediately to any subsequent operations on the transaction.  The biggest downside I see is the added transport command and iterating the protocol.&lt;/p&gt;</comment>
                            <comment id="13917743" author="artnaseef" created="Mon, 3 Mar 2014 04:57:14 +0000"  >&lt;p&gt;I tried forcing a rollback on the transaction and that causes the commit to fail, but the exception seems misleading to me, stating transaction has not been started:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;javax.jms.JMSException: Transaction &apos;TX:ID:Arthur-Naseefs-MacBook-Pro.local-58321-1393821595757-5:1:1&apos; has not been started.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here&apos;s my patch:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;diff --git a/activemq-broker/src/main/java/org/apache/activemq/broker/TransportConnection.java b/activemq-broker/src/mai
index 65d044b..fc4a674 100755
--- a/activemq-broker/src/main/java/org/apache/activemq/broker/TransportConnection.java
+++ b/activemq-broker/src/main/java/org/apache/activemq/broker/TransportConnection.java
@@ -306,6 +306,9 @@ public class TransportConnection implements Connection, Task, CommandVisitor {
                 responseRequired = false;
             }
 
+            // AMQ-3166: remember and propogate transaction failures.
+            serviceTransactionExceptions(command, e);
+
             if (responseRequired) {
                 response = new ExceptionResponse(e);
             } else {
@@ -1608,4 +1611,44 @@ public class TransportConnection implements Connection, Task, CommandVisitor {
     public WireFormatInfo getRemoteWireFormatInfo() {
         return wireFormatInfo;
     }
+
+    protected void  serviceTransactionExceptions(Command command, Throwable thrown) {
+        if ( command instanceof Message ) {
+            Message msg = (Message) command;
+
+            if ( msg.isInTransaction() ) {
+                LOG.debug(&quot;marking transaction {} failed on message {} due to {}&quot;, msg.getTransactionId(),
+                          msg.getMessageId(), thrown.getMessage());
+                this.markTransactionFailure(msg.getConnection().getConnectionInfo().getConnectionId(),
+                                            msg.getTransactionId(), thrown);
+            }
+        } else if ( command instanceof MessageAck ) {
+            MessageAck ack = (MessageAck) command;
+
+            if ( ack.isInTransaction() ) {
+                LOG.debug(&quot;marking transaction {} failed on ack for messages {}..{} due to {}&quot;, ack.getTransactionId(),
+                          ack.getFirstMessageId(), ack.getLastMessageId(), thrown.getMessage());
+                this.markTransactionFailure(ack.getConsumerId().getParentId().getParentId(), ack.getTransactionId(),
+                                            thrown);
+            }
+        }
+
+        // TBD: any other commands?  MessagePull doesn&apos;t contain transaction info, and I suspect that it doesn&apos;t need
+        // it since it must be synchronous.
+    }
+
+    protected void  markTransactionFailure(ConnectionId connId, TransactionId tId, Throwable thrown) {
+        TransactionInfo rollback = new TransactionInfo();
+        rollback.setConnectionId(connId);
+        rollback.setTransactionId(tId);
+        rollback.setType(TransactionInfo.ROLLBACK);
+
+        try {
+            // Reuse the rollback existing logic.
+            this.processRollbackTransaction(rollback);
+        } catch ( Throwable err ) {
+            LOG.warn(&quot;failed to force rollack on transaction {} after initial failure {}&quot;, tId, thrown.getMessage(),
+                     err);
+        }
+    }
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m looking at adding a &quot;failed&quot; status to TransactionState - that appears to be a feasible approach, and seems more correct as well.&lt;/p&gt;</comment>
                            <comment id="13917981" author="gtully" created="Mon, 3 Mar 2014 11:50:26 +0000"  >&lt;p&gt;the behaviour makes sense b/c of the use of the rollback logic so the transaction goes away.&lt;br/&gt;
I was thinking more along the lines of a new rollbackOnly flag/state in transaction. that would only kick in on commit in the event of a previous failure.&lt;br/&gt;
tracking send/create producer-consumer failures should use syncSends and exception handlers clients side. Broker side they would flip the rollbackOnly flag. So any broker side failure that occurs within a transaction would set the rollbackonly flag and optionally a client can trap individual failures and call rollback. In any event, the transaction aborts.&lt;/p&gt;</comment>
                            <comment id="13918453" author="artnaseef" created="Mon, 3 Mar 2014 19:16:24 +0000"  >&lt;p&gt;If transacted-sends were always sent Synchronously from the client to the broker, this problem would go away as the clients would immediately receive the exception on the send.  In that case, I wouldn&apos;t bother with marking the transaction as failed since (a) there&apos;s really no need, and (b) the client could easily decide to go forward and commit in spite of the single send failure (i.e. more complex transacted use-cases would be supported).&lt;/p&gt;

&lt;p&gt;My only concern with making that change is the potential impact to performance.  I&apos;ll give it a try and see how much impact it has.&lt;/p&gt;</comment>
                            <comment id="13923932" author="artnaseef" created="Fri, 7 Mar 2014 14:53:38 +0000"  >&lt;p&gt;Doing a quick test, I found &lt;tt&gt;alwaysSyncSend&lt;/tt&gt; on the connection drops performance for message production.&lt;/p&gt;

&lt;p&gt;In fact, the benefit of using a transaction for faster throughput appears to be eliminated.&lt;/p&gt;

&lt;p&gt;Here&apos;s the test and results.  Note that increasing transaction sizes improves throughput in the async-case (desirable) but not the sync case.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Test&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# Transacted async send of 1000 persistent messages with 100 messages per transaction to queue asn.test
echo &quot;=== TRANSACTED ASYNC SEND ===&quot;
time javarun Flood -t -m 1000 -o 250 -c 100 -u &apos;tcp://localhost:61616&apos; queue asn.test

# Transacted sync send of 1000 persistent messages with 100 messages per transaction to queue asn.test
echo
echo &quot;=== TRANSACTED SYNC SEND ===&quot;
time javarun Flood -t -m 1000 -o 250 -c 100 -u &apos;tcp://localhost:61616?jms.alwaysSyncSend=true&apos; queue asn.test

# Non-transacted send of 1000 persistent messages to queue asn.test
echo
echo &quot;=== NON-TRANSACTED SEND ===&quot;
time javarun Flood -m 1000 -o 250 -u &apos;tcp://localhost:61616&apos; queue asn.test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Results&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;=== TRANSACTED ASYNC SEND ===
log4j:WARN No appenders could be found for logger (org.apache.activemq.transport.WireFormatNegotiator).
log4j:WARN Please initialize the log4j system properly.
Set producer window size to 0
Running Producer
250
500
750
1000
Producer Terminating

real    0m0.927s
user    0m0.030s
sys     0m0.060s

=== TRANSACTED SYNC SEND ===
log4j:WARN No appenders could be found for logger (org.apache.activemq.transport.WireFormatNegotiator).
log4j:WARN Please initialize the log4j system properly.
Set producer window size to 0
Running Producer
250
500
750
1000
Producer Terminating

real    0m2.403s
user    0m0.015s
sys     0m0.061s

=== NON-TRANSACTED SEND ===
log4j:WARN No appenders could be found for logger (org.apache.activemq.transport.WireFormatNegotiator).
log4j:WARN Please initialize the log4j system properly.
Set producer window size to 0
Running Producer
250
500
750
1000
Producer Terminating

real    0m2.508s
user    0m0.015s
sys     0m0.045s
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Based on this, I won&apos;t force all transacted sends to be synchronous.&lt;/p&gt;</comment>
                            <comment id="13923936" author="mez" created="Fri, 7 Mar 2014 14:56:46 +0000"  >&lt;p&gt;I&apos;m out of the office and will return on Monday, Mar. 10th.&lt;/p&gt;



</comment>
                            <comment id="13962827" author="ld4711" created="Tue, 8 Apr 2014 12:47:15 +0000"  >&lt;p&gt;We had an issue in production with lost messages in a transacted batch, due to server memory limit settings (producer flow control). Setting an exception handler on the connection factory is not enough to be on the safe side, as we were able to construct a test case that builds a race condition between the producer thread and the exception handler thread such that the commit is done before the asynchronous exception callback is fired by the server response.&lt;/p&gt;

&lt;p&gt;E.g. set server memory limit to 1 MB only, send batch of 100 messages, server can handle only 95 messages, commit is done before callback is triggered: 5 messages are lost, 95 messages appear in the queue.&lt;/p&gt;

&lt;p&gt;As lost messages within a transaction are really a bad thing we would appreciate Gary Tully&apos;s approach of setting a flag in the transaction context, so that any exception will always and reliably yield a JMS rollback. Besides that, an exception should be thrown in the commit thread such that there is no chance of having a silent failure from the client perspective. Otherwise the rollback may go unnoticed.&lt;br/&gt;
Transaction handling should also be safe for those users that forget to set the exception handler at all.&lt;/p&gt;

&lt;p&gt;I do not favor the option of doing a commit for only a part of my message batch, i.e. when you have a failure after message 101 you should not be able to commit messages 1 to 100. For me transactions are always an all-or-nothing matter. As with asynchronous sends you have a delay of several send operations until the exception handler gets fired it would require significant client logic to determine which messages survived and which got lost.&lt;/p&gt;</comment>
                            <comment id="13962931" author="mez" created="Tue, 8 Apr 2014 12:51:16 +0000"  >&lt;p&gt;I&apos;m out of the office and will return on Monday, Apr. 13th.&lt;/p&gt;


</comment>
                            <comment id="15299829" author="jira-bot" created="Wed, 25 May 2016 10:30:10 +0000"  >&lt;p&gt;Commit fe9d99e7a071c4c09c78dfd95630036b86a8a05b in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=fe9d99e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=fe9d99e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3166&quot; title=&quot;client calls to createProducer() and send() successful even though BrokerFilter methods throw exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3166&quot;&gt;&lt;del&gt;AMQ-3166&lt;/del&gt;&lt;/a&gt; - implement rollbackOnlyOnAsyncException such that async exceptions on transactional sends or acks result in the transaction being marked rollback only and commit failing with an exception. Test that shows current state of play using alwaySendSync or AsyncCallback. rollbackOnlyOnAsyncException enabled by default.&lt;/p&gt;</comment>
                            <comment id="15299843" author="gtully" created="Wed, 25 May 2016 10:39:35 +0000"  >&lt;p&gt;async exceptions on transactional ops - message send and message ack will result in the transaction being marked rollback-only. Commit will fail with an exception.&lt;br/&gt;
In the event that folks want to have partial transactions in the event of failures, the behaviour can be disabled with &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;broker rollbackOnlyOnAsyncException=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt; ... &amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;using setAlwaysSyncSend or using the AsyncCallback api variants provide workarounds for the current code base.&lt;/p&gt;</comment>
                            <comment id="15657441" author="jahlborn" created="Fri, 11 Nov 2016 16:20:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; just curious, is there a reason that the Transaction does not remember the original cause in setRollbackOnly and include that on the resulting XAException?  I ran into this bug when using producer flow control on a jms transacted connection (on an older version of activemq).  the patch for this bug fixes the problem, however, you have to dig through the logs to find the ultimate cause of the send failure (a ResourceAllocationException).  seems like it would be useful to include that in the failure returned to the client?  &lt;/p&gt;

&lt;p&gt;e.g.:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/activemq-broker/src/main/java/org/apache/activemq/transaction/Transaction.java b/activemq-broker/src/main/j
index f891c89..99b8c1f 100755
--- a/activemq-broker/src/main/java/org/apache/activemq/transaction/Transaction.java
+++ b/activemq-broker/src/main/java/org/apache/activemq/transaction/Transaction.java
@@ -45,6 +45,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Transaction {
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; FINISHED_STATE = 3;
     &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; committed = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
     &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; rollbackOnly = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Throwable rollbackOnlyCause;
 
     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ArrayList&amp;lt;Synchronization&amp;gt; synchronizations = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;Synchronization&amp;gt;();
     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; state = START_STATE;
@@ -112,6 +113,9 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Transaction {
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rollbackOnly) {
             XAException xae = newXAException(&lt;span class=&quot;code-quote&quot;&gt;&quot;COMMIT FAILED: Transaction marked rollback only&quot;&lt;/span&gt;, XAException.XA_RBROLLBA
             TransactionRolledBackException transactionRolledBackException = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TransactionRolledBackException(xae.getL
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(rollbackOnlyCause != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+                transactionRolledBackException.initCause(rollbackOnlyCause);
+            }
             xae.initCause(transactionRolledBackException);
             &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; xae;
         }
@@ -216,6 +220,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Transaction {
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!rollbackOnly) {
             getLog().trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;setting rollback only, cause:&quot;&lt;/span&gt;, cause);
             rollbackOnly = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
+            rollbackOnlyCause = cause;
         }
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15657444" author="mez" created="Fri, 11 Nov 2016 16:21:40 +0000"  >&lt;p&gt;I&apos;m out of the office and will return on Wed, Nov 16th.&lt;br/&gt;
&lt;a href=&quot;https://www.netcracker.com/assets/img/netcracker-social-final.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.netcracker.com/assets/img/netcracker-social-final.png&lt;/a&gt; &#405;&lt;/p&gt;


</comment>
                            <comment id="15687132" author="jira-bot" created="Tue, 22 Nov 2016 16:08:20 +0000"  >&lt;p&gt;Commit 7077d2b910405dea7a60c5140824966ffebc66a8 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=7077d2b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=7077d2b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3166&quot; title=&quot;client calls to createProducer() and send() successful even though BrokerFilter methods throw exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3166&quot;&gt;&lt;del&gt;AMQ-3166&lt;/del&gt;&lt;/a&gt; init rollbackonly exception cause such that xaexception has meaning, thanks to james (jtahlborn) for the suggestion&lt;/p&gt;</comment>
                            <comment id="15687138" author="gtully" created="Tue, 22 Nov 2016 16:11:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jahlborn&quot; class=&quot;user-hover&quot; rel=&quot;jahlborn&quot;&gt;jahlborn&lt;/a&gt; thanks for the suggestion. I swapped the boolean for a throwable and now capture the root cause. &lt;/p&gt;</comment>
                            <comment id="15687173" author="jira-bot" created="Tue, 22 Nov 2016 16:27:50 +0000"  >&lt;p&gt;Commit 99b7a28ccbb5435ef5bdba3ceac9995996dfbbed in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=99b7a28&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=99b7a28&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3166&quot; title=&quot;client calls to createProducer() and send() successful even though BrokerFilter methods throw exceptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3166&quot;&gt;&lt;del&gt;AMQ-3166&lt;/del&gt;&lt;/a&gt; fix typo that removed class name, sorry&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12697125">AMQCPP-535</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12622927">AMQ-4213</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12471043" name="AMQ3166Test.java" size="7754" author="artnaseef" created="Tue, 15 Feb 2011 00:31:30 +0000"/>
                            <attachment id="12471042" name="AMQ3166Test.java" size="7767" author="artnaseef" created="Tue, 15 Feb 2011 00:21:58 +0000"/>
                            <attachment id="12483740" name="FailedTransactionTracking.java" size="14098" author="artnaseef" created="Fri, 24 Jun 2011 17:07:44 +0000"/>
                            <attachment id="12483741" name="FailedTransactionTrackingPlugin.java" size="919" author="artnaseef" created="Fri, 24 Jun 2011 17:08:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>70097</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0eaon:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>81493</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>