<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:58:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-9187] Queue Advisory message not sent when new queue created via Message which has AMQ_SCHEDULED_DELAY Header</title>
                <link>https://issues.apache.org/jira/browse/AMQ-9187</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;When a message is sent to a queue which does not currently exist, we expect the queue to be created on the fly. If Advisory Support is turned on, then a subscriber to the &apos;ActiveMQ.Advisory.Queue&apos; should be notified any time a new queue is created.&lt;/p&gt;

&lt;p&gt;When sending the first message to a new queue &lt;b&gt;using an Anonymous JMS Producer&lt;/b&gt;, and the AMQ_SCHEDULED_DELAY Header is present (for delayed delivery), the message is put on the queue after the delay timeout and the queue created for the first time.&lt;/p&gt;

&lt;p&gt;The bug is that the Advisory Message for the queue being created does &lt;b&gt;not&lt;/b&gt; get published.&lt;/p&gt;

&lt;p&gt;I will submit a PR of a broken unit test demonstrating the issue. Also, I have a fix which I&apos;ll submit in the same PR.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13516257">AMQ-9187</key>
            <summary>Queue Advisory message not sent when new queue created via Message which has AMQ_SCHEDULED_DELAY Header</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbonofre">Jean-Baptiste Onofr&#233;</assignee>
                                    <reporter username="martindevlin">Martin Devlin</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Jan 2023 04:59:11 +0000</created>
                <updated>Fri, 20 Oct 2023 15:58:15 +0000</updated>
                            <resolved>Fri, 20 Oct 2023 15:58:15 +0000</resolved>
                                    <version>5.16.1</version>
                    <version>5.17.0</version>
                    <version>5.18.0</version>
                                    <fixVersion>6.0.0</fixVersion>
                    <fixVersion>5.18.3</fixVersion>
                    <fixVersion>5.17.6</fixVersion>
                                    <component>Job Scheduler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6600">1h 50m</timespent>
                                <comments>
                            <comment id="17653788" author="JIRAUSER298623" created="Tue, 3 Jan 2023 05:07:45 +0000"  >&lt;p&gt;This bug is caused by the ordering of these BrokerFilters:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;1. org.apache.activemq.advisory.AdvisoryBroker
2. org.apache.activemq.broker.scheduler.SchedulerBroker&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When the message is sent, the SchedulerBroker intercepts it and stores it in JobSchedulerStore. Then after the delay timeout, the SchedulerBroker (org.apache.activemq.broker.scheduler.SchedulerBroker#scheduledJob) forwards the message via org.apache.activemq.broker.BrokerFilter#send.&#160; But the &apos;producerExchange&apos; object contains the &apos;context&apos; of SchedulerBroker not the original context. So when the RegionBroker creates the Destination for the first time (org.apache.activemq.broker.region.RegionBroker#send) it doesn&apos;t see the AvisoryBroker. So the AdvisoryBroker#addDestination method never gets invoked. This is why the advisory message never gets sent.&lt;/p&gt;

&lt;p&gt;My fix is to simply swap the order of these to BrokerFilters. Initial testing shows that this fixes it but I&apos;m currently doing more testing to ensure nothing gets broken as a result of this change.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17653789" author="JIRAUSER298623" created="Tue, 3 Jan 2023 05:13:05 +0000"  >&lt;p&gt;BTW Anonymous JMS Producers are used by default internally inside the PooledSession object even when users use the named producer API. See&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.activemq.jms.pool.PooledSession#getMessageProducer(javax.jms.Destination)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So this bug would happen when anyone uses the org.apache.activemq.jms.pool.ConnectionPool on the client side.&lt;/p&gt;</comment>
                            <comment id="17653804" author="JIRAUSER298623" created="Tue, 3 Jan 2023 06:11:57 +0000"  >&lt;p&gt;PR is here: &lt;a href=&quot;https://github.com/apache/activemq/pull/947&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/947&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17777848" author="jira-bot" created="Fri, 20 Oct 2023 15:52:29 +0000"  >&lt;p&gt;Commit 573ae71ec9197ae7392941239912bd62e7db2c87 in activemq&apos;s branch refs/heads/main from Martin Devlin&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=573ae71ec&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=573ae71ec&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9187&quot; title=&quot;Queue Advisory message not sent when new queue created via Message which has AMQ_SCHEDULED_DELAY Header&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9187&quot;&gt;&lt;del&gt;AMQ-9187&lt;/del&gt;&lt;/a&gt; - Queue Advisory message not sent&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;a test case which demonstrates the bug.&lt;/li&gt;
	&lt;li&gt;the first test case sendDelayedMessage_usingNormalProducer works fine because it is using a normal named JMS MessageProducer. Included just for comparison purposes.&lt;/li&gt;
	&lt;li&gt;the 2nd test case sendDelayedMessage_usingAnonymousProducer shows the bug.&lt;/li&gt;
	&lt;li&gt;the bug fix: swap the order of the AdvisoryBroker and SchedulerBroker BrokerFilters.&lt;/li&gt;
	&lt;li&gt;make AdvisoryBroker come after SchedulerBroker but before RegionBroker&lt;/li&gt;
	&lt;li&gt;this ensures that when a delayed message gets eventually forwarded to the RegionBroker, the RegionBroker will &quot;see&quot; the AdvisoryBroker when it invokes &apos;addDestination&apos;. Thus, the AdvisoryBroker gets to send out the advisory message as expected.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17777850" author="jira-bot" created="Fri, 20 Oct 2023 15:55:57 +0000"  >&lt;p&gt;Commit 7ed319e99d39b820a7ddfa6f5548f2ccec72c06d in activemq&apos;s branch refs/heads/activemq-5.18.x from Martin Devlin&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=7ed319e99&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=7ed319e99&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9187&quot; title=&quot;Queue Advisory message not sent when new queue created via Message which has AMQ_SCHEDULED_DELAY Header&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9187&quot;&gt;&lt;del&gt;AMQ-9187&lt;/del&gt;&lt;/a&gt; - Queue Advisory message not sent&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;a test case which demonstrates the bug.&lt;/li&gt;
	&lt;li&gt;the first test case sendDelayedMessage_usingNormalProducer works fine because it is using a normal named JMS MessageProducer. Included just for comparison purposes.&lt;/li&gt;
	&lt;li&gt;the 2nd test case sendDelayedMessage_usingAnonymousProducer shows the bug.&lt;/li&gt;
	&lt;li&gt;the bug fix: swap the order of the AdvisoryBroker and SchedulerBroker BrokerFilters.&lt;/li&gt;
	&lt;li&gt;make AdvisoryBroker come after SchedulerBroker but before RegionBroker&lt;/li&gt;
	&lt;li&gt;this ensures that when a delayed message gets eventually forwarded to the RegionBroker, the RegionBroker will &quot;see&quot; the AdvisoryBroker when it invokes &apos;addDestination&apos;. Thus, the AdvisoryBroker gets to send out the advisory message as expected.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(cherry picked from commit 573ae71ec9197ae7392941239912bd62e7db2c87)&lt;/p&gt;</comment>
                            <comment id="17777852" author="jira-bot" created="Fri, 20 Oct 2023 15:58:04 +0000"  >&lt;p&gt;Commit d069ff77bdb8d3065264d525cbbd679274a68e31 in activemq&apos;s branch refs/heads/activemq-5.17.x from Martin Devlin&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=d069ff77b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=d069ff77b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9187&quot; title=&quot;Queue Advisory message not sent when new queue created via Message which has AMQ_SCHEDULED_DELAY Header&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9187&quot;&gt;&lt;del&gt;AMQ-9187&lt;/del&gt;&lt;/a&gt; - Queue Advisory message not sent&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;a test case which demonstrates the bug.&lt;/li&gt;
	&lt;li&gt;the first test case sendDelayedMessage_usingNormalProducer works fine because it is using a normal named JMS MessageProducer. Included just for comparison purposes.&lt;/li&gt;
	&lt;li&gt;the 2nd test case sendDelayedMessage_usingAnonymousProducer shows the bug.&lt;/li&gt;
	&lt;li&gt;the bug fix: swap the order of the AdvisoryBroker and SchedulerBroker BrokerFilters.&lt;/li&gt;
	&lt;li&gt;make AdvisoryBroker come after SchedulerBroker but before RegionBroker&lt;/li&gt;
	&lt;li&gt;this ensures that when a delayed message gets eventually forwarded to the RegionBroker, the RegionBroker will &quot;see&quot; the AdvisoryBroker when it invokes &apos;addDestination&apos;. Thus, the AdvisoryBroker gets to send out the advisory message as expected.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(cherry picked from commit 573ae71ec9197ae7392941239912bd62e7db2c87)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ehq0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>