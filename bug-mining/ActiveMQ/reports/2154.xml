<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:03:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4977] Memory leak in ConnectionStateTracker when browsing non-empty queues</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4977</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I think I found case that is not handled by the fix &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3316&quot; title=&quot;Memory leak in ConnectionStateTracker with MessagePull objects&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3316&quot;&gt;&lt;del&gt;AMQ-3316&lt;/del&gt;&lt;/a&gt;. We see memory leaks connected to this bug and after good amount of headbanging I think the problem is in how two methods work together - processMessagePull and trackBack. The first one has this piece of code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-comment&quot;&gt;// leave a single instance in the cache
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; id = pull.getDestination() + &lt;span class=&quot;code-quote&quot;&gt;&quot;::&quot;&lt;/span&gt; + pull.getConsumerId();
            messageCache.put(id.intern(), pull);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;while the second one unconditionally increases the currentCacheSize - regardless if the previous method added or replaced entry in the cache.&lt;/p&gt;

&lt;p&gt;The situation where entries will be replaced (and not added) and the currentCacheSize will grow very fast until it wraps around and becomes negative is the following:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;have some logic that frequently creates queue browser and iterates through all the entries&lt;/li&gt;
	&lt;li&gt;have the queue most of the time with at least one message. The more messages in the queue the faster currentCacheSize grows.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The reason is that processMessagePull reuses the consumer and destination ID for each browsed message in the queue when org.apache.activemq.ActiveMQQueueBrowser#hasMoreElements is invoked. trackBack is ignorant of this and keeps adding to the size regardless that the cache size stays the same.&lt;/p&gt;

&lt;p&gt;Here is log from reproducing the issue as a proof:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 10000, 5 elements, pending scans:10, memory: 8951KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 20000, 10 elements, pending scans:10, memory: 10845KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 30000, 15 elements, pending scans:10, memory: 12645KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 40000, 20 elements, pending scans:10, memory: 10363KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 50000, 25 elements, pending scans:10, memory: 12169KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 60000, 30 elements, pending scans:10, memory: 9852KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 70000, 35 elements, pending scans:10, memory: 11657KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 80000, 40 elements, pending scans:10, memory: 9401KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 90000, 45 elements, pending scans:10, memory: 11222KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 100000, 50 elements, pending scans:10, memory: 13047KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 110000, 55 elements, pending scans:10, memory: 10767KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 120000, 60 elements, pending scans:10, memory: 12567KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 130000, 65 elements, pending scans:10, memory: 10256KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 138800, 67 elements, pending scans:10, memory: 12085KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 146800, 67 elements, pending scans:10, memory: 9745KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 154800, 67 elements, pending scans:10, memory: 11566KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 162800, 67 elements, pending scans:10, memory: 9225KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 170800, 67 elements, pending scans:10, memory: 11013KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 178800, 67 elements, pending scans:10, memory: 12812KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 186800, 67 elements, pending scans:10, memory: 10522KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 194800, 67 elements, pending scans:10, memory: 12328KB
2014-01-16 23:05:14  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 202800, 67 elements, pending scans:10, memory: 9999KB
2014-01-16 23:05:15  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 210800, 67 elements, pending scans:10, memory: 11805KB
2014-01-16 23:05:15  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 218800, 67 elements, pending scans:10, memory: 9496KB
2014-01-16 23:05:15  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 226800, 67 elements, pending scans:10, memory: 11316KB
2014-01-16 23:05:15  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 234800, 67 elements, pending scans:10, memory: 13100KB
2014-01-16 23:05:15  WARN ActiveMqMemoryLeakTest - MaxCacheSize: 131072, currentCacheSize: 242800, 67 elements, pending scans:10, memory: 10754KB
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;One can see that the garbage collection works well (cache does not grow) but the currentCacheSize keeps increasing&lt;br/&gt;
Unfortunately I cannot easily extract the original code and provide it. Hope the explanation is clear enough. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12689388">AMQ-4977</key>
            <summary>Memory leak in ConnectionStateTracker when browsing non-empty queues</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="gdanov">Georgi Danov</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Jan 2014 22:53:42 +0000</created>
                <updated>Tue, 27 May 2014 15:20:45 +0000</updated>
                            <resolved>Fri, 17 Jan 2014 17:31:43 +0000</resolved>
                                    <version>5.6.0</version>
                    <version>5.7.0</version>
                    <version>5.8.0</version>
                    <version>5.9.0</version>
                                    <fixVersion>5.9.1</fixVersion>
                    <fixVersion>5.10.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13874140" author="tabish121" created="Thu, 16 Jan 2014 23:24:40 +0000"  >&lt;p&gt;Could you work up a JUnit test case against the ConnectionStateTracker to prove the problem exists?  &lt;/p&gt;</comment>
                            <comment id="13874189" author="gdanov" created="Fri, 17 Jan 2014 00:06:51 +0000"  >&lt;p&gt;I have one. The dump is from it. But it is coupled to tons of classes from our project which I cannot easily extract. I believe I have described the scenario in good detail for anybody who is intimate with the class to understand. I understand test would be much more comfortable for whoever wants to fix it, however I need to get some sleep so I have to stop here.&lt;/p&gt;

&lt;p&gt;As for proving - I have heapdumps from our production servers showing both the negative sizecounter and the map containing gazillions of pullCommands, I have our custom test, I have spent 6 hours today debugging to nail it down. It is there, and I am confident about the scenario I have described.&lt;/p&gt;</comment>
                            <comment id="13874980" author="tabish121" created="Fri, 17 Jan 2014 17:31:43 +0000"  >&lt;p&gt;I&apos;ve committed a small test and fix for the cache size value growing when nothing is actually added into the map.  Since there was no test provided to confirm this fixes the underlying issue you&apos;ll need to test and report back at some point if there is still more going on.  &lt;/p&gt;</comment>
                            <comment id="13875597" author="01sas" created="Sat, 18 Jan 2014 08:57:44 +0000"  >&lt;p&gt;Here is a test which shows this memory leak.&lt;/p&gt;</comment>
                            <comment id="13875686" author="tabish121" created="Sat, 18 Jan 2014 16:37:38 +0000"  >&lt;p&gt;Make sure you test on trunk now as the conditions of negative current cache size and continuous addition to the current size are now fixed.  &lt;/p&gt;</comment>
                            <comment id="13876117" author="01sas" created="Mon, 20 Jan 2014 04:10:35 +0000"  >&lt;p&gt;Test shows that cache size now stable, does not grow with time as before:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Now&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2014-01-20 11:05:26  WARN ConnectionStateTrackerMemoryLeakTest - Cache size: 131200, 328 elements, memory: 21556KB
2014-01-20 11:05:31  WARN ConnectionStateTrackerMemoryLeakTest - Cache size: 131200, 328 elements, memory: 15535KB
2014-01-20 11:05:36  WARN ConnectionStateTrackerMemoryLeakTest - Cache size: 131200, 328 elements, memory: 17671KB
2014-01-20 11:05:41  WARN ConnectionStateTrackerMemoryLeakTest - Cache size: 131200, 328 elements, memory: 33767KB
2014-01-20 11:05:46  WARN ConnectionStateTrackerMemoryLeakTest - Cache size: 131200, 328 elements, memory: 43187KB
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Before&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2014-01-20 11:08:28  WARN ConnectionStateTrackerMemoryLeakTest - Cache size: 6398000, 31 elements, memory: 10546KB
2014-01-20 11:08:33  WARN ConnectionStateTrackerMemoryLeakTest - Cache size: 21079200, 31 elements, memory: 16294KB
2014-01-20 11:08:38  WARN ConnectionStateTrackerMemoryLeakTest - Cache size: 40870000, 31 elements, memory: 15740KB
2014-01-20 11:08:43  WARN ConnectionStateTrackerMemoryLeakTest - Cache size: 60265200, 31 elements, memory: 27111KB
2014-01-20 11:08:48  WARN ConnectionStateTrackerMemoryLeakTest - Cache size: 79071200, 31 elements, memory: 8817KB
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13882842" author="gdanov" created="Mon, 27 Jan 2014 14:31:09 +0000"  >&lt;p&gt;Thanks for the prompt reaction!&lt;br/&gt;
Can you give us basic estimation of two things:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;when will release 5.10 go out&lt;/li&gt;
	&lt;li&gt;do we need to also upgrade our AMQ server to be on same version as the client?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14009724" author="gdanov" created="Tue, 27 May 2014 14:45:15 +0000"  >&lt;p&gt;I desperately need update when is any of the 5.9.1 or 5.10 releases going out.&lt;br/&gt;
We will be upgrading from 5.6 and I want to avoid patching the client jar again&lt;/p&gt;</comment>
                            <comment id="14009768" author="tabish121" created="Tue, 27 May 2014 15:16:11 +0000"  >&lt;p&gt;v5.9.1 was released quite some time ago. &lt;/p&gt;</comment>
                            <comment id="14009777" author="gdanov" created="Tue, 27 May 2014 15:20:45 +0000"  >&lt;p&gt;thanks. found it &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12506889">AMQ-3316</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12623785" name="ConnectionStateTrackerMemoryLeakTest.java" size="7528" author="01sas" created="Sat, 18 Jan 2014 08:57:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>368355</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1rhnj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>368660</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>