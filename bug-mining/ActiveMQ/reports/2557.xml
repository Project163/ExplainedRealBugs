<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:10:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5310] activemq-client - Throws IllegalStateException in receive method which should be a JMSException</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5310</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;There is a change in activemq-client in the receive method, where it does a checkClosed call that throws an IllegalStateException which is not supposed according to JMS spec. This causes camel-jms / spring jms to not shutdown nicely and causes the JMS listener to hang, and also other side-effects.&lt;/p&gt;

&lt;p&gt;For example the camel example pojo messaging demonstrates that. Just start the example according to its readme, and then shutdown the JVM with ctrl + c, and it hangs&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; [Thu Aug 07 10:33:27 CEST 2014]; root of context hierarchy]
2014-08-07 10:33:42,965 [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-1       ] INFO  SpringCamelContext             - Apache Camel 2.14-SNAPSHOT (CamelContext: camel-1) is shutting down
2014-08-07 10:33:42,971 [sonnel.records]] WARN  ultJmsMessageListenerContainer - Setup of JMS message listener invoker failed &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; destination &lt;span class=&quot;code-quote&quot;&gt;&apos;personnel.records&apos;&lt;/span&gt; - trying to recover. Cause: The Consumer is closed
javax.jms.IllegalStateException: The Consumer is closed
	at org.apache.activemq.ActiveMQMessageConsumer.checkClosed(ActiveMQMessageConsumer.java:861)
	at org.apache.activemq.ActiveMQMessageConsumer.receive(ActiveMQMessageConsumer.java:618)
	at org.apache.activemq.jms.pool.PooledMessageConsumer.receive(PooledMessageConsumer.java:67)
	at org.springframework.jms.listener.AbstractPollingMessageListenerContainer.receiveMessage(AbstractPollingMessageListenerContainer.java:430)
	at org.springframework.jms.listener.AbstractPollingMessageListenerContainer.doReceiveAndExecute(AbstractPollingMessageListenerContainer.java:310)
	at org.springframework.jms.listener.AbstractPollingMessageListenerContainer.receiveAndExecute(AbstractPollingMessageListenerContainer.java:263)
	at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.invokeListener(DefaultMessageListenerContainer.java:1101)
	at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.executeOngoingLoop(DefaultMessageListenerContainer.java:1093)
	at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.run(DefaultMessageListenerContainer.java:990)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744)
2014-08-07 10:33:42,975 [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-1       ] DEBUG BeanComponent                  - Clearing BeanInfo cache[size=2, hits=0, misses=2, evicted=0]
2014-08-07 10:33:42,975 [sonnel.records]] ERROR ultJmsMessageListenerContainer - Could not refresh JMS Connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; destination &lt;span class=&quot;code-quote&quot;&gt;&apos;personnel.records&apos;&lt;/span&gt; - retrying in 5000 ms. Cause: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
java.lang.NullPointerException
	at org.springframework.jms.listener.AbstractJmsListeningContainer.refreshSharedConnection(AbstractJmsListeningContainer.java:392)
	at org.springframework.jms.listener.DefaultMessageListenerContainer.refreshConnectionUntilSuccessful(DefaultMessageListenerContainer.java:885)
	at org.springframework.jms.listener.DefaultMessageListenerContainer.recoverAfterListenerSetupFailure(DefaultMessageListenerContainer.java:861)
	at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.run(DefaultMessageListenerContainer.java:1012)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744)
2014-08-07 10:33:42,975 [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-1       ] DEBUG TimerListenerManager           - Removed TimerListener: org.apache.camel.management.mbean.ManagedCamelContext@2a2bc16
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As you can see from this stacktrace there is a NPE error inside spring jms which causes it not to shutdown correctly also.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12732500">AMQ-5310</key>
            <summary>activemq-client - Throws IllegalStateException in receive method which should be a JMSException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="davsclaus">Claus Ibsen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Aug 2014 08:42:51 +0000</created>
                <updated>Thu, 4 Jun 2015 21:08:44 +0000</updated>
                            <resolved>Thu, 4 Jun 2015 21:08:44 +0000</resolved>
                                    <version>5.10.0</version>
                                    <fixVersion>5.12.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14089012" author="davsclaus" created="Thu, 7 Aug 2014 08:49:18 +0000"  >&lt;p&gt;The API on receive is&lt;br/&gt;
&lt;a href=&quot;http://docs.oracle.com/javaee/6/api/javax/jms/MessageConsumer.html#receive(long&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javaee/6/api/javax/jms/MessageConsumer.html#receive(long&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Throws:&lt;br/&gt;
JMSException - if the JMS provider fails to receive the next message due to some internal error.&lt;/p&gt;

&lt;p&gt;Though you can argue that if the consumer is closed is that an internal error? And should a runtime exception be thrown for other kind of exceptions?&lt;/p&gt;

&lt;p&gt;Nevertheless we got a critical issue as camel-jms / spring jms / cannot shutdown reliably due changes in ActiveMQ.&lt;/p&gt;</comment>
                            <comment id="14089063" author="davsclaus" created="Thu, 7 Aug 2014 09:32:13 +0000"  >&lt;p&gt;We can help on this problem in camel-jms to detect CamelContext is being stopped and more quickly disallow the spring message listener container to run, and therefore for it to not try to refresh and re-create the connection which will cause activemq-client to throw that exception -&amp;gt; a NPE exception inside spring-jms in a final method we cannot change.&lt;/p&gt;</comment>
                            <comment id="14089076" author="davsclaus" created="Thu, 7 Aug 2014 09:42:10 +0000"  >&lt;p&gt;Logged a ticket to improve shutdown quicker on the camel-jms side&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-7667&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-7667&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14089111" author="davsclaus" created="Thu, 7 Aug 2014 10:25:01 +0000"  >&lt;p&gt;Ah re-read the java doc api, and it clearly states that we should return null if the consumer is closed&lt;/p&gt;

&lt;p&gt;Returns:&lt;br/&gt;
the next message produced for this message consumer, or null if this message consumer is concurrently closed&lt;/p&gt;</comment>
                            <comment id="14089163" author="davsclaus" created="Thu, 7 Aug 2014 12:09:16 +0000"  >&lt;p&gt;Attached is a patch I got started with. There is also a chance that in the dequeue method we got closed and should return null IMHO. I found that from a stacktrace error I got while testing.&lt;/p&gt;</comment>
                            <comment id="14090277" author="davsclaus" created="Fri, 8 Aug 2014 04:02:45 +0000"  >&lt;p&gt;Lowered to major as current behavior has been like this from the very start. Though we should get this fixed so AMQ is aligned with the JMS spec.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dejanb&quot; class=&quot;user-hover&quot; rel=&quot;dejanb&quot;&gt;dejanb&lt;/a&gt; you said you wanted to take a look. I have attached a patch with some fixes. There could be similar issues in other JMS APIs, such as the Session / Connection etc too.&lt;/p&gt;</comment>
                            <comment id="14571615" author="tabish121" created="Wed, 3 Jun 2015 20:41:30 +0000"  >&lt;p&gt;Not sure it is really wrong for the client code to throw the javax.jms.IllegalStateException which is what it currently does as the definition of that exception is &quot;This exception is thrown when a method is invoked at an illegal or inappropriate time&quot; and it is an extension of JMSException so any catch handler expecting JMSException would work.  So in the cases where it is throwing that exception type it is probably ok.&lt;/p&gt;

&lt;p&gt;As far as the receive calls go I&apos;m not sure it must always return null or only when the receive has entered a blocking mode as the API states that it returns null when the consumer is &quot;concurrently&quot; closed which you could read as meaning that it throws an exception if called &quot;after&quot; the consumer has been closed.  &lt;/p&gt;</comment>
                            <comment id="14572511" author="gemmellr" created="Thu, 4 Jun 2015 10:26:56 +0000"  >&lt;p&gt;The spec clarified in JMS 1.1 that a pending receive should return null when the consumer is closed. i.e when receive was called and then the close occurs, but it does not say that should happen if you call receive after the close occurs.&lt;/p&gt;

&lt;p&gt;An IllegalStateException getting thrown when receive() is called after the consumer closed is consistent among 5 different JMS clients I have either worked on or looked at the source of. Upon checking, it is in fact a poorly documented requirement of the spec itself, since JMS 1.01:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&quot;The IllegalStateException has been noted as a required exception for several&lt;br/&gt;
more error conditions. they are acknowledging a message received from a&lt;br/&gt;
closed session; attempting to call the recover method of a transacted session;&lt;br/&gt;
attempting to call any method of a closed connection, session, consumer or&lt;br/&gt;
producer (with the exception of the close method itself); attempting to set a&lt;br/&gt;
connection&#8217;s client identifier at the wrong time or when it has been&lt;br/&gt;
administratively configured.&quot;&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="14573582" author="tabish121" created="Thu, 4 Jun 2015 21:08:44 +0000"  >&lt;p&gt;From review of the spec the current behaviour matches the spec so I don&apos;t think we should change it since we want to follow the specification defined behaviour.  I&apos;ve added some tests to validate that we do indeed throw or return null in the cases defined by the spec.  &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12660374" name="amq-5310.patch" size="2881" author="davsclaus" created="Thu, 7 Aug 2014 12:09:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>410528</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 24 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ympj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>410522</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>