<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:38:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6454] Message is redelivered after succesfull acknowledge()</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6454</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;JMS message is redelivered after successful call of acknowledge().&lt;/p&gt;

&lt;p&gt;The following methods are invoked:&lt;br/&gt;
Thread1 : Message message = consumer.receive();&lt;br/&gt;
Thread2 : consumer.close();&lt;br/&gt;
Thread1: message.acknowledge();&lt;/p&gt;

&lt;p&gt;All the methods return successfully but the  message is redelivered on the next receive() call. Note that consumer.close() is typically used to force  consumer.receive() to return. &lt;/p&gt;

&lt;p&gt;According to JMS specification the scope of message acknowledge() call is session (not message consumer):&lt;br/&gt;
&lt;a href=&quot;https://docs.oracle.com/javaee/7/api/javax/jms/Message.html#acknowledge--&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javaee/7/api/javax/jms/Message.html#acknowledge--&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;A simple program to reproduce the bug is attached.&lt;/p&gt;

&lt;p&gt;Observed behavior: &lt;br/&gt;
Message is redelivered.&lt;br/&gt;
Program output:&lt;br/&gt;
============&lt;br/&gt;
Message sent. Id=ID:comp-63860-1475602285903-1:1:1:1:1&lt;br/&gt;
Message received. Id=ID:comp-63860-1475602285903-1:1:1:1:1. Text=Welcome!&lt;br/&gt;
Message succesfully acknowledged&lt;br/&gt;
Message received. Id=ID:comp-63860-1475602285903-1:1:1:1:1. Text=Welcome!&lt;br/&gt;
Message succesfully acknowledged&lt;/p&gt;

&lt;p&gt;Expected behavior:&lt;br/&gt;
Message should be delivered only once.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13009812">AMQ-6454</key>
            <summary>Message is redelivered after succesfull acknowledge()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10101">Abandoned</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="yuriyc">Yuriy</reporter>
                        <labels>
                    </labels>
                <created>Wed, 5 Oct 2016 09:19:28 +0000</created>
                <updated>Sun, 13 Mar 2022 14:16:11 +0000</updated>
                            <resolved>Sun, 13 Mar 2022 14:16:11 +0000</resolved>
                                    <version>5.14.1</version>
                                                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15548175" author="yuriyc" created="Wed, 5 Oct 2016 09:22:03 +0000"  >&lt;p&gt;Program to reproduce the issue&lt;/p&gt;</comment>
                            <comment id="15548264" author="gtully" created="Wed, 5 Oct 2016 09:59:48 +0000"  >&lt;p&gt;What you describe does look like the correct behaviour w.r.t the java doc. &lt;br/&gt;
For reference, broker side, messages are retained in the subscription that matches the consumer. On close, any unacked messages are replayed back to the queue for delivery to another consumer.&lt;br/&gt;
It looks like the close needs to be deferred till the session closes in this client ack case. That is the behaviour in a transaction. However we would need a new callback on the session to track this. Not a trivial fix but doable.&lt;br/&gt;
For your use case, is a transacted session an option?&lt;/p&gt;</comment>
                            <comment id="15549130" author="yuriyc" created="Wed, 5 Oct 2016 15:52:14 +0000"  >&lt;p&gt;Gary, thank you for the quick response.&lt;br/&gt;
I know that transacted session will work and it does, but in our case there is an explicit requirement to use a non-transacted JMS session.&lt;br/&gt;
By the way this sequence works for other JMS providers like IBM WebSphere MQ, OpenMQ and WebLogic.&lt;br/&gt;
Another issue here is acknowledge() returns successfully, which in general means that message was acknowledged on JMS server side.&lt;/p&gt;</comment>
                            <comment id="15549300" author="gtully" created="Wed, 5 Oct 2016 16:52:07 +0000"  >&lt;p&gt;actually the fix may be a simple as deferring the close in this case, the session close will cleanup in any event. Will give the unit tests a whirl to see if this change breaks any existing use case.&lt;/p&gt;</comment>
                            <comment id="15551708" author="gtully" created="Thu, 6 Oct 2016 11:44:11 +0000"  >&lt;p&gt;This essentially comes down to being able to do the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        consumer.close();
        message.acknowledge();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Deferring the close till the session closes makes this work but there are many tests that demo uses cases where close is expected to release un-acked messages. I think we can&apos;t break this expectation so it would need to be configurable (yet another option).&lt;br/&gt;
As an alternative, we can make message.acknowledge(); fail if the consumer is closed. This will ensure that the is no false positive from the acknowledge call.&lt;br/&gt;
Would that be sufficient for your use case?&lt;/p&gt;
</comment>
                            <comment id="15551722" author="christopher.l.shannon" created="Thu, 6 Oct 2016 11:53:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;, I&apos;ve been watching this thread and my first thoughts were what you discovered, that things would break if this behavior changed.  I know I have written code that relies on this behavior (ie closing the consumer will cause redelivery without closing the session)&lt;/p&gt;

&lt;p&gt;To me this use case seems a bit odd as a JMS session should not be shared across threads.  The spec is clear in that a session should be single threaded.  So having two different threads receive a message and then try to call acknowledge should be considered invalid anyways in my opinion based on the spec.&lt;/p&gt;

&lt;p&gt;That seems to be the fundamental issue in this use case is the timing with the two threads.  If it was a single thread receiving and acknowledge then it could be written in such a way to always call acknowledge before closing.&lt;/p&gt;

&lt;p&gt;So based on that, I would think having message.acknowledge() fail if a consumer was already closed being the best solution.&lt;/p&gt;</comment>
                            <comment id="15551871" author="yuriyc" created="Thu, 6 Oct 2016 12:59:02 +0000"  >&lt;p&gt;Gary, I think having message.acknowledge() fail if a consumer was already closed can be considered as workaround, which prevents unexpected redelivery (in other words duplication of messages).&lt;/p&gt;

&lt;p&gt;But this type of fix will not make behavior compliant to JMS specification.&lt;br/&gt;
You are right: JMS session should not be shared across threads.&lt;br/&gt;
But JMS specification explicitly states that method close() is the only method of message consumer and session, which can be called concurrently:&lt;br/&gt;
&lt;a href=&quot;https://docs.oracle.com/javaee/7/api/javax/jms/MessageConsumer.html#close--&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javaee/7/api/javax/jms/MessageConsumer.html#close--&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://docs.oracle.com/javaee/7/api/javax/jms/Session.html#close--&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javaee/7/api/javax/jms/Session.html#close--&lt;/a&gt;&lt;br/&gt;
That&apos;s why consumer.close() is frequently used from another thread to make consumer.receive() return. &lt;/p&gt;

&lt;p&gt;In the described use case both receive() and acknowledge() methods are invoked from the same thread. Method close() is invoked from another thread.&lt;br/&gt;
Therefore it is absolutely valid use case.&lt;/p&gt;

&lt;p&gt;Thread1 : Message message = consumer.receive();&lt;br/&gt;
Thread2 : consumer.close();&lt;br/&gt;
Thread1: message.acknowledge();&lt;/p&gt;

&lt;p&gt;I think that till the next major release of ActiveMQ some configuration option that will allow to switch to legacy behavior (or otherwise to the new behavior) would be acceptable solution for all ActiveMQ users.&lt;/p&gt;</comment>
                            <comment id="15551904" author="christopher.l.shannon" created="Thu, 6 Oct 2016 13:18:21 +0000"  >&lt;p&gt;Yep, you are right about the close() call being allowed and I suppose now that I think about it that makes sense to be able to close a message listener or consumer. So based on the spec allowing the close() method to be called from another thread I do agree that this is in fact a valid use case.&lt;/p&gt;

&lt;p&gt;I think the default behavior should just be message.acknowledge() will fail if the consumer was closed.  Then, depending on how much work it is to implement, a flag could also be added to allow the close to be deferred to the session close to change the behavior.  I&apos;ll let Gary comment on this as he has looked into it and knows better about the level of effort required to make these changes.&lt;/p&gt;

&lt;p&gt;Whatever fix is done I can back port it to 5.14.x so that it will go into a 5.14.2 release.&lt;/p&gt;</comment>
                            <comment id="15554576" author="jira-bot" created="Fri, 7 Oct 2016 08:57:56 +0000"  >&lt;p&gt;Commit e91f5c8062f81a76e6983c489bfd092ce4071480 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e91f5c8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e91f5c8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6454&quot; title=&quot;Message is redelivered after succesfull acknowledge()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6454&quot;&gt;&lt;del&gt;AMQ-6454&lt;/del&gt;&lt;/a&gt; - ensure message.acknowledge throws if consumer has closed and message has been released broker side&lt;/p&gt;</comment>
                            <comment id="15554594" author="gtully" created="Fri, 7 Oct 2016 09:05:05 +0000"  >&lt;p&gt;What would be a good name for the connection factory config option that ignores consumer.close for client or invdvidual ack mode such that session close is required to release the consumer and unacked messages? &lt;/p&gt;

&lt;p&gt;Here is one candidate:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ignoreConsumerCloseOnClientAck=true&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think it would default to false to preserve typical usage.&lt;/p&gt;</comment>
                            <comment id="15555322" author="yuriyc" created="Fri, 7 Oct 2016 15:04:26 +0000"  >&lt;p&gt;Gary, will it be possible to specify this configuration option in &quot;java.naming.provider.url&quot; like &quot;tcp://localhost:61616?option=value&quot; when instantiation of JNDI initial context and connection factory is done in JMS provider independent way?&lt;/p&gt;

&lt;p&gt;Will enabling of this option (deferred close) make consumer.receive() to return after consumer.close()?&lt;/p&gt;</comment>
                            <comment id="15555409" author="gtully" created="Fri, 7 Oct 2016 15:37:23 +0000"  >&lt;p&gt;yes, that would be in the intent. When the broker url is: host:port?jms ignoreConsumerCloseOnClientAck=true &lt;br/&gt;
the close would be ignored, session close will call close on all consumers. Then the close check in the message.acknowledge would pass and the ack would work.&lt;/p&gt;</comment>
                            <comment id="17505829" author="christopher.l.shannon" created="Sun, 13 Mar 2022 14:16:11 +0000"  >&lt;p&gt;closing issues not updated in more than 5 years as abandoned&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12831714" name="activemq-bug.zip" size="4672" author="yuriyc" created="Wed, 5 Oct 2016 09:22:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 35 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34gnb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>