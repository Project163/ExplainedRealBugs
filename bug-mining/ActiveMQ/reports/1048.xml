<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:48:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2736] KahaDB doesn&apos;t clean up old files</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2736</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Over time, we&apos;re seeing that kahadb doesn&apos;t clean up old journal files. As a result, we eventually run out of disk space, or rather, we hit our usage limits and our producers are slowed down by the producer flow control mechanism. Others have experienced this problem too (for example, see &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/activemq-users/201002.mbox/%3C27502591.post@talk.nabble.com%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.apache.org/mod_mbox/activemq-users/201002.mbox/%3C27502591.post@talk.nabble.com%3E&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;For now, we&apos;re moving back to the old amqPersistenceStore. &lt;/p&gt;
</description>
                <environment></environment>
        <key id="12483957">AMQ-2736</key>
            <summary>KahaDB doesn&apos;t clean up old files</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="adrian.trenaman">Adrian Trenaman</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 May 2010 09:38:38 +0000</created>
                <updated>Mon, 2 Feb 2015 13:07:37 +0000</updated>
                            <resolved>Thu, 17 Feb 2011 18:11:33 +0000</resolved>
                                    <version>5.3.2</version>
                                    <fixVersion>5.5.0</fixVersion>
                                        <due></due>
                            <votes>12</votes>
                                    <watches>21</watches>
                                                                                                                                                            <comments>
                            <comment id="12942663" author="gtully" created="Tue, 18 May 2010 11:10:52 +0000"  >&lt;p&gt;Could you provide a test case or scenario description that can reproduce?&lt;/p&gt;</comment>
                            <comment id="12943314" author="adrian.trenaman" created="Tue, 18 May 2010 12:16:50 +0000"  >&lt;p&gt;Hi Gary,&lt;/p&gt;

&lt;p&gt;I&apos;m afraid I don&apos;t have a test case for this right now; just observed&lt;br/&gt;
behaviour on our systems here &lt;del&gt;and&lt;/del&gt; verified by other users via a Google&lt;br/&gt;
Search.&lt;/p&gt;

&lt;p&gt;/Ade&lt;/p&gt;

</comment>
                            <comment id="12943313" author="adrian.trenaman" created="Tue, 18 May 2010 13:17:31 +0000"  >&lt;p&gt;Hi Gary,&lt;/p&gt;

&lt;p&gt;Just retested against the very latest FUSE distribution (5.3.1-fuse-01-00) and the log files are being deleted. Looks like this may have been fixed. Will mark this as resolved for now, and revisit if we begin to see the errors again. &lt;/p&gt;

&lt;p&gt;/Ade&lt;/p&gt;</comment>
                            <comment id="12942928" author="straun" created="Fri, 17 Sep 2010 06:09:22 +0000"  >&lt;p&gt;I am seeing this with a broker holding transactional persistent messages (100k messages a day 10k per msg), the queue sizes are all around 0 normally so I would expect the files to be cleared. I am using 5.4.0. The consumer of the messages is a .Net client with &apos;auto acknowledge&apos; set. The KahaDB also appears to slow down as it runs, writes to the queues slows down so that the each commit cycle is taking 10% longer than the last.&lt;/p&gt;</comment>
                            <comment id="12942912" author="gtully" created="Fri, 17 Sep 2010 08:40:54 +0000"  >&lt;p&gt;Straun, can you provide some sort of test case that can reproduce what you are seeing? Maybe a simple java producer/consumer that mimics what your .Net add does.&lt;/p&gt;</comment>
                            <comment id="12942967" author="m4c0" created="Fri, 24 Sep 2010 13:42:18 +0000"  >&lt;p&gt;I&apos;m attaching a test case that reproduces what I got here.&lt;/p&gt;

&lt;p&gt;I tested with a Producer sending 1mi messages (in 100-message blocks) and a Consumer. After some time, I receive a &quot;Usage Manager Store is Full, 100% of 1073741824. Stopping producer (...)&quot; with only a hundred messages on the queue!&lt;/p&gt;</comment>
                            <comment id="12942779" author="jgenender" created="Thu, 7 Oct 2010 13:42:33 +0000"  >&lt;p&gt;Looks like there &lt;b&gt;maybe&lt;/b&gt; a wait/lock condition on multiple &quot;KahaDB Scheduler&quot; threads...&lt;/p&gt;

&lt;p&gt;I took the attached example and was able to reproduce the problem.  A thread dump showed waits on the &quot;KahaDB Scheduler&quot;.  I knocked out one of the schedulers and it appears to clean up.&lt;/p&gt;

&lt;p&gt;Hence... can you please try setting schedulerSupport=&quot;false&quot; on the broker configuration and see if the files no longer grow?   This may be a work around for the time being.  Hopefully this is in the right direction...&lt;/p&gt;</comment>
                            <comment id="12942992" author="jgenender" created="Thu, 7 Oct 2010 13:49:37 +0000"  >&lt;p&gt;I ran the attached example and was able to reproduce it and indeed appears to endlessly grow.  I did a thread dump during the condition and there appears to be a possible locking problem with multiple &quot;KahaDB Scheduler&quot; threads.&lt;/p&gt;

&lt;p&gt;As an experiment I killed one of the KahaDB Schedulers and it seemed to clean up.  I ran the example several times and it seems to clean up.  So this &lt;b&gt;may&lt;/b&gt; be the culprit.&lt;/p&gt;

&lt;p&gt;So please try this as a work around...&lt;/p&gt;

&lt;p&gt;In the broker configuration set schedulerSupport=&quot;false&quot; and see if the files clean up.  This may help until we identify the waits on multiple schedulers.&lt;/p&gt;</comment>
                            <comment id="12942780" author="jgenender" created="Thu, 7 Oct 2010 13:49:46 +0000"  >&lt;p&gt;I ran the attached example and was able to reproduce it and indeed appears to endlessly grow.  I did a thread dump during the condition and there appears to be a possible locking problem with multiple &quot;KahaDB Scheduler&quot; threads.&lt;/p&gt;

&lt;p&gt;As an experiment I killed one of the KahaDB Schedulers and it seemed to clean up.  I ran the example several times and it seems to clean up.  So this &lt;b&gt;may&lt;/b&gt; be the culprit.&lt;/p&gt;

&lt;p&gt;So please try this as a work around...&lt;/p&gt;

&lt;p&gt;In the broker configuration set schedulerSupport=&quot;false&quot; and see if the files clean up.  This may help until we identify the waits on multiple schedulers.&lt;/p&gt;</comment>
                            <comment id="12942782" author="jgenender" created="Thu, 7 Oct 2010 13:50:12 +0000"  >&lt;p&gt;Oops... sorry for the multiple posts :/&lt;/p&gt;</comment>
                            <comment id="12942783" author="jgenender" created="Thu, 7 Oct 2010 18:13:30 +0000"  >&lt;p&gt;My last comment was a red herring.  I found the bug... it s a logic bug.  Patch has been attached.  I will try to create a unit test but wanted to get the patch up since this was a critical bug.&lt;/p&gt;</comment>
                            <comment id="12942986" author="gtully" created="Fri, 8 Oct 2010 12:29:48 +0000"  >&lt;p&gt;jeff, committed the fix, thanks. r1005806&lt;br/&gt;
await the test case to protect it. nice work.&lt;/p&gt;</comment>
                            <comment id="12943021" author="jgenender" created="Fri, 8 Oct 2010 15:41:55 +0000"  >&lt;p&gt;Test case attached&lt;/p&gt;</comment>
                            <comment id="12943018" author="gtully" created="Fri, 8 Oct 2010 16:27:09 +0000"  >&lt;p&gt;attaching the diff with the test case and the fix reverted, in which case the test should fail. but it does not atm.&lt;br/&gt;
Just so we are on the same page, I may be missing something but I would expect it to fail.&lt;/p&gt;</comment>
                            <comment id="12943035" author="gtully" created="Tue, 12 Oct 2010 11:26:00 +0000"  >&lt;p&gt;The scenario that needs to be tested, for future reference:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ackMessageFileMap = {2=[1], 3=[1, 2], 4=[2, 3, 4], 5=[4, 5], 6=[5, 6], 7=[6, 7], 8=[7, 8]}

gCandidateSet = [2, 3, 4, 5, 6, 7]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12943064" author="m4c0" created="Wed, 13 Oct 2010 17:21:06 +0000"  >&lt;p&gt;After some evil debugging tricks, I found that there are some pending inflight transactions (even after restarting the server) in my database files. In this scenario, the gcCandidadeSet is empty, since &quot;metadata.firstInProgressTransactionLocation&quot; points to the first log file (MessageDatabase.java, lines 1140-1154):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// Don&apos;t GC files after the first in progress tx
&lt;/span&gt;Location firstTxLocation = metadata.lastUpdate;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( metadata.firstInProgressTransactionLocation!=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ) {
  firstTxLocation = metadata.firstInProgressTransactionLocation;
}

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( firstTxLocation!=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ) {
  &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;( !gcCandidateSet.isEmpty() ) {
    &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; last = gcCandidateSet.last();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( last &amp;gt;= firstTxLocation.getDataFileId() ) {
      gcCandidateSet.remove(last);
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
    }
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This leads to the question: why it must discard every log file starting from the one containing the first pending transaction? Any malfunctioning operation (even an one-time little mistake) will trash all log files from that point! &lt;/p&gt;

&lt;p&gt;I believe this should happens also on &quot;kill -9&quot; or unexpected power down.&lt;/p&gt;</comment>
                            <comment id="12943054" author="m4c0" created="Wed, 13 Oct 2010 17:28:45 +0000"  >&lt;p&gt;I&apos;m attaching a nasty workaround that commits the pending transactions and automatically archives (or deletes) the old log files when closing the store. I&apos;m not proud of this thing, but it seems to prove the problem is on the pending transaction, since all useless files are correctly disposed after running it.&lt;/p&gt;</comment>
                            <comment id="12943127" author="cwikman" created="Mon, 25 Oct 2010 06:52:25 +0000"  >&lt;p&gt;I&apos;m using ActiveMQ 5.4.1 in production and I have added Gary&apos;s patch, but the log files are stilling growing (even if all queues are empty) and finally Activemq crashes. If I restart ActiveMQ then the log files are deleted. &lt;/p&gt;

&lt;p&gt;Any suggestions on how to fix the problem? &lt;/p&gt;</comment>
                            <comment id="12943115" author="moczarski" created="Mon, 25 Oct 2010 19:00:47 +0000"  >&lt;p&gt;We also had some trouble with growing log files (version 5.4.1). I have two issues identified with similar symptoms (but it seems to be another cause as to this issue):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2982&quot; title=&quot;Sticky KahaDB log files due to local transaction rollback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2982&quot;&gt;&lt;del&gt;AMQ-2982&lt;/del&gt;&lt;/a&gt;: sticky log files on a rollback of a local transaction (test case and patch available)&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2983&quot; title=&quot;Sticky KahaDB log files due to concurrent consumer with local transaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2983&quot;&gt;&lt;del&gt;AMQ-2983&lt;/del&gt;&lt;/a&gt;: sticky log files on multiple concurrent consumers with local transacted sessions (test case available)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If we only use non transacted sessions with auto-acknowledge, we have no problems.&lt;/p&gt;</comment>
                            <comment id="12943129" author="bezudar" created="Tue, 26 Oct 2010 08:03:40 +0000"  >&lt;p&gt;@Swen Does using non transacted sessions with auto acknowledge clear the log files?&lt;br/&gt;
We have been facing a similar problem, however we are using Kaha Persistence Adapter on upgrading from 5.3.2 to 5.4.1. We had to upgrade to 5.4.1 because earlier using Durable Subs Topics our data files weren&apos;t getting cleaned up. Now our index-subs file are creating an issue. &lt;/p&gt;

&lt;p&gt;Any Final fix for this problem?&lt;/p&gt;</comment>
                            <comment id="12943113" author="jgenender" created="Tue, 26 Oct 2010 17:16:00 +0000"  >&lt;p&gt;Folks..&lt;/p&gt;

&lt;p&gt;Please try the patch supplied above: &lt;a href=&quot;https://issues.apache.org/activemq/secure/attachment/19715/amq-2987.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/secure/attachment/19715/amq-2987.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;That appears to fix the problem with the &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2736&quot; title=&quot;KahaDB doesn&amp;#39;t clean up old files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2736&quot;&gt;&lt;del&gt;AMQ-2736&lt;/del&gt;&lt;/a&gt;.zip test.&lt;/p&gt;</comment>
                            <comment id="12943118" author="jgenender" created="Tue, 26 Oct 2010 17:26:57 +0000"  >&lt;p&gt;@Christer WIkman - Gary&apos;s attachment wasn&apos;t a patch... it was a revert to the test case to validate the test case fails.  Please try my patch.&lt;/p&gt;</comment>
                            <comment id="12943112" author="jgenender" created="Tue, 26 Oct 2010 23:08:38 +0000"  >&lt;p&gt;Here is the 5.4.1 distribution with the patch in it.  This is &lt;b&gt;not&lt;/b&gt; an official release... could people please test it out?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://people.apache.org/~jgenender/apache-activemq-5.4.1-AMQ2736-bin.tar.gz&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://people.apache.org/~jgenender/apache-activemq-5.4.1-AMQ2736-bin.tar.gz&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="12943137" author="tranchida" created="Wed, 27 Oct 2010 01:58:52 +0000"  >&lt;p&gt;Do not work for me, same issue.&lt;/p&gt;</comment>
                            <comment id="12943120" author="tranchida" created="Wed, 27 Oct 2010 03:22:54 +0000"  >&lt;p&gt;I think that the fix &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2982&quot; title=&quot;Sticky KahaDB log files due to local transaction rollback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2982&quot;&gt;&lt;del&gt;AMQ-2982&lt;/del&gt;&lt;/a&gt; must fix also this issue.&lt;/p&gt;</comment>
                            <comment id="12943133" author="dejanb" created="Wed, 27 Oct 2010 09:18:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2982&quot; title=&quot;Sticky KahaDB log files due to local transaction rollback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2982&quot;&gt;&lt;del&gt;AMQ-2982&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2983&quot; title=&quot;Sticky KahaDB log files due to concurrent consumer with local transaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2983&quot;&gt;&lt;del&gt;AMQ-2983&lt;/del&gt;&lt;/a&gt; are fixed now on the trunk, so you can test out if that helps. I spotted one more potential issue in the area and I&apos;m working on it now, so stay tuned.&lt;/p&gt;</comment>
                            <comment id="12943140" author="dejanb" created="Wed, 27 Oct 2010 13:28:07 +0000"  >&lt;p&gt;That potential issue from the last comment was the false alarm. I believe that this issue should be fixed now. Please test the latest snapshot&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.5-SNAPSHOT/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.5-SNAPSHOT/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and reopen if you find any problems.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="12943131" author="dejanb" created="Wed, 27 Oct 2010 14:11:38 +0000"  >&lt;p&gt;Just to wrap it all up, there were three issues spotted;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;one spotted by Jeff and fixed by supplied patch and&lt;/li&gt;
	&lt;li&gt;and two covered by &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2982&quot; title=&quot;Sticky KahaDB log files due to local transaction rollback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2982&quot;&gt;&lt;del&gt;AMQ-2982&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2983&quot; title=&quot;Sticky KahaDB log files due to concurrent consumer with local transaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2983&quot;&gt;&lt;del&gt;AMQ-2983&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks to all who contributed, especially Jeff and Swen&lt;/p&gt;</comment>
                            <comment id="12943167" author="cwikman" created="Wed, 3 Nov 2010 09:33:55 +0000"  >&lt;p&gt;We running: &lt;a href=&quot;http://people.apache.org/~jgenender/apache-activemq-5.4.1-AMQ2736-bin.tar.gz&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://people.apache.org/~jgenender/apache-activemq-5.4.1-AMQ2736-bin.tar.gz&lt;/a&gt; and we are still experience problems with log files that are not deleted. &lt;/p&gt;

&lt;p&gt;I deployed the fix yesterday with a new kahadb and this morning I had 155 log files with only 43 messages on two DLQ queues. I deleted the DLQ queues and only 12 log files where deleted. Currently,. I have 144 log files and nothing in the queues. &lt;/p&gt;

</comment>
                            <comment id="12943164" author="gtully" created="Wed, 3 Nov 2010 09:40:29 +0000"  >&lt;p&gt;Christer, please validate with the 5.5-SNAPSHOT, that has the required combined fixes.&lt;br/&gt;
&lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.5-SNAPSHOT/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.5-SNAPSHOT/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12943195" author="cwikman" created="Tue, 9 Nov 2010 07:50:28 +0000"  >&lt;p&gt;I deployed yesterday in stage latest 5.5-SNAPSHOT and it seems that the problem is solved. This morning I had 17 log files, but after I deleted DLQ queues with messages I ended up with only 1 log file! When I used 5.4.1 the files grow with approx 50-100 files per day. &lt;/p&gt;

&lt;p&gt;We are not comfortable deploying 5.5-SNAPSHOT in production. Can anyone provide me with a patch for 5.4.1? Currently, I cannot recommend using version 5.4.1 in production without the combined fixes from 5.5-SNAPSHOT.&lt;/p&gt;
</comment>
                            <comment id="12943198" author="jgenender" created="Tue, 9 Nov 2010 17:28:26 +0000"  >&lt;p&gt;@Christer Wlkman - I built one with the following JIRA patches:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://people.apache.org/~jgenender/apache-activemq-5.4.1-AMQ2736-AMQ2982-AMQ2983-AMQ2935-bin.tar.gz&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://people.apache.org/~jgenender/apache-activemq-5.4.1-AMQ2736-AMQ2982-AMQ2983-AMQ2935-bin.tar.gz&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;YMMV and this is not an official release.  Post back if this works for you.&lt;/p&gt;</comment>
                            <comment id="12943200" author="cwikman" created="Thu, 11 Nov 2010 09:02:56 +0000"  >&lt;p&gt;@Jeff - Thanks! I have deployed your fix in our stage environment. It works much better but not 100%. All queues are empty but I still have 4 log files and one contains 0 bytes, last updated yesterday, and other log file was last updated 6 hours ago. When I used 5.5-SNAPSHOT it went down to 1 log file!&lt;/p&gt;

&lt;p&gt;I will evaluate it for some more days before I can tell for sure if the log files grows. &lt;/p&gt;</comment>
                            <comment id="12943221" author="cwikman" created="Tue, 16 Nov 2010 09:53:09 +0000"  >&lt;p&gt;I have been running Jeff&apos;s fix in stage for 5 days and the log files have not grown. I&apos;m now comfortable to use it in production.&lt;/p&gt;

&lt;p&gt;Many thanks for all help!&lt;/p&gt;</comment>
                            <comment id="12943235" author="dejanb" created="Tue, 16 Nov 2010 10:07:03 +0000"  >&lt;p&gt;BTW. We released a version of Fuse Message Broker that contains a fix for this issue. If anyone is interested, it can be found here &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://repo.fusesource.com/nexus/content/repositories/releases/org/apache/activemq/apache-activemq/5.4.1-fuse-01-00/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://repo.fusesource.com/nexus/content/repositories/releases/org/apache/activemq/apache-activemq/5.4.1-fuse-01-00/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Release notes available at: &lt;a href=&quot;http://fusesource.com/wiki/display/ProdInfo/FUSE+Message+Broker+v5.4.1-fuse+Release+Notes&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://fusesource.com/wiki/display/ProdInfo/FUSE+Message+Broker+v5.4.1-fuse+Release+Notes&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12943229" author="alisenberg" created="Tue, 16 Nov 2010 13:57:42 +0000"  >&lt;p&gt;Hi, I really need this fix!!!!. So finally you tested the fix on 5.4.1 or you are going to put 5.5 in production? &lt;/p&gt;

&lt;p&gt;excuse me, but which is the file with the correct patch?&lt;/p&gt;

&lt;p&gt;One more question: After applying this fix, would be any way for deleting old log files in order to reduce unused space? I am at 100G and I need to maintain the current state of the broker...&lt;/p&gt;

&lt;p&gt;thanks.&lt;/p&gt;</comment>
                            <comment id="12943225" author="cwikman" created="Tue, 16 Nov 2010 14:16:00 +0000"  >&lt;p&gt;Use Jeff&apos;s patch for 5.4.1, &lt;a href=&quot;http://people.apache.org/~jgenender/apache-activemq-5.4.1-AMQ2736-AMQ2982-AMQ2983-AMQ2935-bin.tar.gz&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://people.apache.org/~jgenender/apache-activemq-5.4.1-AMQ2736-AMQ2982-AMQ2983-AMQ2935-bin.tar.gz&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I deployed it in production today and it totally removed the problem with growing log files. It went down from 78 log files to just 1 log file. &lt;/p&gt;</comment>
                            <comment id="12943247" author="srpietrowicz" created="Tue, 16 Nov 2010 20:52:59 +0000"  >&lt;p&gt;I&apos;ve been trying to track down a solution to a problem similar to this, and the latest snapshot of 5.5 doesn&apos;t resolve this for me.&lt;/p&gt;

&lt;p&gt;This is the scenario I&apos;ve created:&lt;/p&gt;

&lt;p&gt;1) a producer starts sending messages&lt;br/&gt;
2) a consumer starts consuming messages, but pauses after 100.&lt;br/&gt;
3) db-##.log files start showing up in the tmp_storage directory as expected.   I let the producer go for a while so a number of db-##.log files are created.&lt;br/&gt;
4) the consumer starts consuming messages again. The db-##.log files start disappearing as they&apos;re used up.&lt;br/&gt;
5) everything finishes.&lt;/p&gt;

&lt;p&gt;Now, if I do:&lt;/p&gt;

&lt;p&gt;1) a producer starts sending messages&lt;br/&gt;
2) a consumer starts consuming messages, but pauses after 100.&lt;br/&gt;
3) db-##.log files start showing up in the tmp_storage directory as expected.   I let the producer go for a while so that a number of db-##.log files are created.&lt;/p&gt;

&lt;p&gt;and kill the consumer and the producer.  The db-##.log files remain, and will not get cleaned up, even on subsequent invocations of new consumers and producers.  If a new consumer/producer (as in the first scenario) are created, it all works;  it&apos;s just that those old .log files never get cleaned up.&lt;/p&gt;</comment>
                            <comment id="12978350" author="jgenender" created="Thu, 6 Jan 2011 14:49:42 +0000"  >&lt;p&gt;Steve, I am having difficulty reproducing this... can you please attach a test case?&lt;/p&gt;</comment>
                            <comment id="12980750" author="alisenberg" created="Wed, 12 Jan 2011 15:28:01 +0000"  >&lt;p&gt;Hi, is this bug fixed on version 5.4.2? or I need to apply the patch too?&lt;/p&gt;

&lt;p&gt;thanks!&lt;/p&gt;</comment>
                            <comment id="12980752" author="straun" created="Wed, 12 Jan 2011 15:34:54 +0000"  >&lt;p&gt;5.4.2 does include &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2982&quot; title=&quot;Sticky KahaDB log files due to local transaction rollback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2982&quot;&gt;&lt;del&gt;AMQ-2982&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2983&quot; title=&quot;Sticky KahaDB log files due to concurrent consumer with local transaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2983&quot;&gt;&lt;del&gt;AMQ-2983&lt;/del&gt;&lt;/a&gt;, whether this solves all of the issue I am unsure but using 5.4.2 worked for me.&lt;/p&gt;</comment>
                            <comment id="12981888" author="matthewvon" created="Fri, 14 Jan 2011 19:29:16 +0000"  >&lt;p&gt;No.  Not fixed in 5.4.2 ... just found that out today.  The hard way.&lt;/p&gt;</comment>
                            <comment id="12981894" author="alisenberg" created="Fri, 14 Jan 2011 19:38:40 +0000"  >&lt;p&gt;I think the same. I installed 5.4.2 but still growing. I will rollback to 5.4.1 with patches &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="12985827" author="jgreen" created="Mon, 24 Jan 2011 17:24:02 +0000"  >&lt;p&gt;Hmm something&apos;s not right on our 5.4.2 instance either. A 5GB store reporting itself (after purging some queues) ~89% full. On disk 4.4G. Restarted AMQ it went down to 1.6G and 29% full.&lt;/p&gt;</comment>
                            <comment id="12988713" author="dejanb" created="Mon, 31 Jan 2011 09:55:52 +0000"  >&lt;p&gt;Can anyone create a test case, or provide a steps to reproduce the problem with 5.4.2 release? Thanks!&lt;/p&gt;</comment>
                            <comment id="12994338" author="mcekal" created="Mon, 14 Feb 2011 15:28:21 +0000"  >&lt;p&gt;Hello Dejan,&lt;br/&gt;
We noticed StorageFull on KahaDb several times so I played a little and found two reasons for this (second seems to be a AMQ bug):&lt;br/&gt;
1) unconsumed message(s) in any datafile blocks the datafile forever there. So if you keep default setup 33mb per file and 1gb limit roughly 30 small messages spread one to each datafile can block whole system&lt;br/&gt;
(I assume this is not a bug, just not nice feature - Why not to reply(=rewrite) messages at least during AMQ restart to latest datafile?)&lt;/p&gt;

&lt;p&gt;2) second issue seems to me as a bug. If you open transacted session and send a message, but do not commit it a datafile is blocked. Again if you spread such uncommited messages over all datafiles you gets &quot;storage is full&quot;. That is ok - someone forget to commit - but problem comes if you kill AMQ using -9 signal (or via TaskManager on Windows). If you do this non-standard kill (=like a hw failure) the uncommited transaction seems to be blocking datafiles forever. New start of AMQ somehow reads again the transaction and still waiting for commit although the producer is not live any more. If you do regular shutdown so ShutdownHook on the Broker is fully executed, next AMQ start correctly recognize whether producer of uncommited transaction (with failover transport) is still up (then transaction is kept, messages are replayed to new/last datafile) or down (then transaction is rollbacked).&lt;br/&gt;
I think AMQ should be able to behave this way even if previously someone killed it brutally(kill -9).&lt;/p&gt;

&lt;p&gt;I have tested these two scenarios on both 5.3.2 and 5.4.2 with same result. We would like to get a patch for 5.3.2 version. Is it possible?&lt;/p&gt;

&lt;p&gt;Thanks a lot&lt;br/&gt;
Martin&lt;/p&gt;</comment>
                            <comment id="12994381" author="gtully" created="Mon, 14 Feb 2011 17:50:02 +0000"  >&lt;p&gt;@Martin, thanks for the feedback. The second issue is indeed a problem, on normal shutdown, inflight (non xa) transactions are rolledback. The same (rollback) should happen after recovery, to deal with the abortive shutdown case.&lt;/p&gt;</comment>
                            <comment id="12995958" author="gtully" created="Thu, 17 Feb 2011 18:11:33 +0000"  >&lt;p&gt;Fixed up abortive shutdown case such that recovered local transactions are auto rolledback.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/viewvc?rev=1071732&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1071732&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think the compact journal data files feature needs another issue.&lt;/p&gt;</comment>
                            <comment id="13044921" author="mcarpella" created="Mon, 6 Jun 2011 15:51:01 +0000"  >&lt;p&gt;I am seeing this or a similar issue on a 5.5.0 broker as well, log files are not being deleted. I now deleted all queues, but I am still seeing the checkpoint task &quot;DEBUG | queue://a.deleted.queue expiring messages ..&quot; in the logs.&lt;/p&gt;

&lt;p&gt;I stopped ActiveMQ afterwards and restartet it, after I deleted all queues and still the space being occupied.&lt;/p&gt;

&lt;p&gt;During the restart, even after I deleted all queues, I had:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DEBUG | XA Transaction &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;/begin : XID:1096044365:3137322e31372e312e352e746d31353531373030333432:3137322e31372e312e352e746d37313330363334
DEBUG | Ack &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; non existent subscription in recovery, ack:MessageAck {commandId = 66898301, responseRequired = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, ackType = 2, consumerId = ID:CLIENT-001-40008-1306310098527-2:5:10553821:1, firstMessageId = e041a486-8c88-3855-304e-4c9eac0f85b1:0:61129:61129, lastMessageId = e041a486-8c88-3855-304e-4c9eac0f85b1:0:61129:61129, destination = queue:&lt;span class=&quot;code-comment&quot;&gt;//a.deleted.queue, transactionId = XID:1096044365:3137322e31372e312e352e746d31353531373030333432:3137322e31372e312e352e746d37313330363334, messageCount = 1, poisonCause = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After the restart, all the space was still occupied and log-files were never deleted. But at least no more expiry entries for the now deleted queues any more.&lt;/p&gt;

&lt;p&gt;KahaDB is 3 according to startup logs. Unfortunately I cannot provide steps to reproduce for 5.5.0 at the moment and the store in question is several GB in size and contains sensitive information I cannot share. &lt;/p&gt;

&lt;p&gt;Should I re-open this issue or a file this as a new issue?&lt;/p&gt;</comment>
                            <comment id="13049295" author="kokushibyou" created="Tue, 14 Jun 2011 17:27:57 +0000"  >&lt;p&gt;This does not appear to be fixed in 5.5. &lt;/p&gt;

&lt;p&gt;I have a queue that holds onto a message every once in a while due to bad formatting or what-have-you (not something I can immediately correct). Since KahaDB requires the need to retain the full contents of the DB file while one message persists, it will cause the file system to grow dramatically if you alter the default kahaDB file size at all. With a DB file of 96 megs each I&apos;ve eaten up almost 5 gigs of disk space in 34 pending messages all less than 2000 bytes each. I&apos;m going to begin auto purging the offending queue (since we don&apos;t require those messages), however it would be preferred to have some automatic process possibly automatically consolidate the DB once its reached a pre-configured limit? &lt;/p&gt;</comment>
                            <comment id="13053867" author="gtully" created="Thu, 23 Jun 2011 14:02:00 +0000"  >&lt;p&gt;Auto consolidation would be a nice enhancement. Can you open a new issue to track that.&lt;/p&gt;

&lt;p&gt;As you know, you can also reduce the journal data file size to reduce the overall disk usage in this case.&lt;/p&gt;

&lt;p&gt;One other thought, using a camel route, you can easily consume and re-submit messages so that they are moved to the current journal data file. Have a look at the route from the dlq back the the original destination for inspiration. &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2710&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-2710&lt;/a&gt;. The idea would be to periodically fire a consumer, using quarts, that removes and adds messages. See the test that pulls the original destination from the message.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/viewvc/activemq/trunk/activemq-camel/src/test/resources/org/apache/activemq/camel/CamelRedeliveryTest-context.xml?view=markup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/activemq/trunk/activemq-camel/src/test/resources/org/apache/activemq/camel/CamelRedeliveryTest-context.xml?view=markup&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc/activemq/trunk/activemq-camel/src/test/java/org/apache/activemq/camel/CamelRedeliveryTest.java?view=markup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/activemq/trunk/activemq-camel/src/test/java/org/apache/activemq/camel/CamelRedeliveryTest.java?view=markup&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13469411" author="vmirea" created="Thu, 4 Oct 2012 14:37:04 +0000"  >&lt;p&gt;Hi guys,&lt;/p&gt;

&lt;p&gt;I am using the version 5.5.1 of ActiveMQ and I can still reproduce this problem.&lt;br/&gt;
I saw you have fixed some problems but I think my case is different.&lt;br/&gt;
The most connected bug with my issue is :&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2983&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-2983&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In my case I am no using local transactions, I am using global transaction (XATransactions) and then I always comit the transactions and still the log files are not deleted.&lt;br/&gt;
The JMS Connections Pool in my case it is defined in glassfish using the ActiveMQ Resource Adapter.&lt;br/&gt;
Have you tested with global transactions too ?&lt;/p&gt;</comment>
                            <comment id="13469431" author="gtully" created="Thu, 4 Oct 2012 14:58:58 +0000"  >&lt;p&gt;@Vasile&lt;br/&gt;
If you can reproduce at will, and can provide a tests case, please open a new jira issue to track your use case. Also, validate that your use case fails on trunk using the latest snapshot.&lt;/p&gt;</comment>
                            <comment id="13469447" author="vmirea" created="Thu, 4 Oct 2012 15:10:43 +0000"  >&lt;p&gt;I want to add to my previous comment that we are using the CPP library CMS for ActiveMQ with stomp too.&lt;br/&gt;
This is the second use-case.&lt;br/&gt;
We have one producer and one subscriber and this is already causing problems.&lt;br/&gt;
The logs are growing.&lt;br/&gt;
In C++ we use Session::AUTO_ACKNOWLEDGE and even in this case the log files are not deleted.&lt;br/&gt;
We write(using a producer) in the queue and and another process is reading(using a listener) we never have many messages in the queue.&lt;br/&gt;
QueueName       Number of pending messages   Number of listener       Messages Enqueued     Messages Dequeued &lt;br/&gt;
queuename 	0 	                           1 	               21522 	            21522&lt;br/&gt;
This is maybe a new use-case too ?&lt;/p&gt;</comment>
                            <comment id="13470277" author="vmirea" created="Fri, 5 Oct 2012 12:52:15 +0000"  >&lt;p&gt;I just downloaded the version 5.6.0 of ActiveMQ.&lt;br/&gt;
I took the old configuration I was using for 5.5.1 and repeat the tests with my application.&lt;br/&gt;
It seems the problems are fixed!&lt;br/&gt;
It means the fixed is not made in version 5.5.0 (like the bug is describing).&lt;br/&gt;
So please modify the description(Fix Versions field) so the people should know that the version 5.6.0 it contains the fix.&lt;br/&gt;
I won&apos;t open a new bug because it makes no sense.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12770461">AMQ-5542</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12461844" name="AMQ-2736.zip" size="3387" author="m4c0" created="Fri, 24 Sep 2010 13:42:17 +0000"/>
                            <attachment id="12461836" name="AMQ2736Test_should_with_this_diff.txt" size="9467" author="gtully" created="Fri, 8 Oct 2010 16:27:09 +0000"/>
                            <attachment id="12461862" name="MyKahaDBStore.java" size="1463" author="m4c0" created="Wed, 13 Oct 2010 17:28:45 +0000"/>
                            <attachment id="12461839" name="amq-2987-testcase.patch" size="7968" author="jgenender" created="Fri, 8 Oct 2010 15:41:55 +0000"/>
                            <attachment id="12461834" name="amq-2987.patch" size="1968" author="jgenender" created="Thu, 7 Oct 2010 18:13:30 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12483802">AMQ-2983</subtask>
                            <subtask id="12483803">AMQ-2982</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14686</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 7 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i00we7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3180</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>