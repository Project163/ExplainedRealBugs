<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:48:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2908] Slow consumer stops receiving messages because PrefetchSubscription.dispatched is filled with expired messages.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2908</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Slow consumer gets stuck when consuming from queue that has expiring messages in it. &lt;/p&gt;

&lt;p&gt;Looked into broker while it got stuck and saw that PrefetchSubscription.dispatched is full of expired messages.&lt;/p&gt;

&lt;p&gt;WORKAROUND&lt;br/&gt;
Into doActualDispatch added check that if subscription is full, it will remove all expired message from dispatch.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: trunk/activemq-core/src/main/java/org/apache/activemq/broker/region/PrefetchSubscription.java
===================================================================
--- trunk/activemq-core/src/main/java/org/apache/activemq/broker/region/PrefetchSubscription.java               (revision 42304)
+++ trunk/activemq-core/src/main/java/org/apache/activemq/broker/region/PrefetchSubscription.java            (working copy)
@@ -400,6 +400,21 @@
         }
     }
 
+   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void removeExpiredMessagesFromDispatch() {
+     &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(dispatchLock) {
+                  &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Iterator&amp;lt;MessageReference&amp;gt; iter = dispatched.iterator(); iter.hasNext(); ) {
+                    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; MessageReference node = iter.next();
+                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (node.isExpired()) {
+                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (broker.isExpired(node)) {
+                            node.getRegionDestination().messageExpired(context, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, node);
+                        }
+                        dispatched.remove(node);
+                        node.getRegionDestination().getDestinationStatistics().getInflight().decrement();
+                    }
+                  }
+     }
+   }
+    
     /**
      * Checks an ack versus the contents of the dispatched list.
      * 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: trunk/activemq-core/src/main/java/org/apache/activemq/broker/region/Queue.java
===================================================================
--- trunk/activemq-core/src/main/java/org/apache/activemq/broker/region/Queue.java           (revision 42304)
+++ trunk/activemq-core/src/main/java/org/apache/activemq/broker/region/Queue.java        (working copy)
@@ -1543,6 +1543,9 @@
                 }
                 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (dispatchSelector.canSelect(s, node)) {
                     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!fullConsumers.contains(s)) {
+                               &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (s.isFull() &amp;amp;&amp;amp; s &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; PrefetchSubscription) {
+                                             ((PrefetchSubscription)s).removeExpiredMessagesFromDispatch();
+                               }
                         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!s.isFull()) {
                             &lt;span class=&quot;code-comment&quot;&gt;// Dispatch it.
&lt;/span&gt;                             s.add(node);

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12483856">AMQ-2908</key>
            <summary>Slow consumer stops receiving messages because PrefetchSubscription.dispatched is filled with expired messages.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="siim_kaalep">Siim Kaalep</reporter>
                        <labels>
                    </labels>
                <created>Fri, 10 Sep 2010 06:27:26 +0000</created>
                <updated>Tue, 20 Sep 2011 10:42:22 +0000</updated>
                            <resolved>Fri, 29 Jul 2011 13:30:20 +0000</resolved>
                                    <version>5.3.2</version>
                                    <fixVersion>5.6.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12942890" author="gtully" created="Fri, 10 Sep 2010 09:09:55 +0000"  >&lt;p&gt;do you have a test case for this?&lt;/p&gt;</comment>
                            <comment id="12942883" author="siim_kaalep" created="Fri, 10 Sep 2010 12:07:57 +0000"  >&lt;blockquote&gt;
&lt;p&gt;do you have a test case for this?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Regrettably, no.&lt;/p&gt;</comment>
                            <comment id="12942892" author="gtully" created="Fri, 10 Sep 2010 12:49:32 +0000"  >&lt;p&gt;a code change like that without a test to validate is just a good start. To have it committed to trunk it needs a test to validate: &lt;br/&gt;
1) the issue still exists&lt;br/&gt;
2) to protect the fix into the future&lt;/p&gt;

&lt;p&gt;I guess a slow client ack consumer can fill the prefetch and an appropriate ttl can have them expire, but I wonder what type of client would cause this behavior is real life, until it acks there will be no further dispatch.&lt;br/&gt;
There is an existing check for message expiry on dispatch and on receiving an ack.&lt;/p&gt;</comment>
                            <comment id="12943070" author="pmorris" created="Fri, 15 Oct 2010 13:36:43 +0000"  >&lt;p&gt;hmmm i am wondering if i am seeing the same issue here, unfortunately the original stack trace or indication of why the user thinks this is a bug was not included but i am seeing the same sort of thing and the broker produced the following stack trace:&lt;/p&gt;

&lt;p&gt;2010-09-05 09:07:51,844 | ERROR | Failed to page in more queue messages  | org.apache.activemq.broker.region.Queue | Queue:CORE-IN-QUEUE&lt;br/&gt;
java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;
                at java.util.Arrays.copyOf(Unknown Source)&lt;br/&gt;
                at java.util.concurrent.CopyOnWriteArrayList.add(Unknown Source)&lt;br/&gt;
                at org.apache.activemq.broker.region.PrefetchSubscription.dispatch(PrefetchSubscription.java:630)&lt;br/&gt;
                at org.apache.activemq.broker.region.PrefetchSubscription.dispatchPending(PrefetchSubscription.java:592)&lt;br/&gt;
                at org.apache.activemq.broker.region.PrefetchSubscription.add(PrefetchSubscription.java:158)&lt;br/&gt;
                at org.apache.activemq.broker.region.Queue.doActualDispatch(Queue.java:1548)&lt;br/&gt;
                at org.apache.activemq.broker.region.Queue.doDispatch(Queue.java:1500)&lt;br/&gt;
                at org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1585)&lt;br/&gt;
                at org.apache.activemq.broker.region.Queue.iterate(Queue.java:1219)&lt;br/&gt;
                at org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:98)&lt;br/&gt;
                at org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:36)&lt;/p&gt;

&lt;p&gt;we are using 5.3.1 by the way, and i will hopefully upgrade to 5.4.1 next week and retry&lt;/p&gt;

&lt;p&gt;in our case we have very slow consumers in certain conditions, because they recieve the message and post it out to a web endpoint, and at various points during the year the web endpoint is taken offline, causing us the above problem.... &lt;/p&gt;

&lt;p&gt;we do have a test case here, but it is kind of explicitly linked into stopping and starting our services, and pulling the IP stack down, so it is kind of difficult to repost that one, and it takes about 2 days for it to actually kill the system after 300 messages per second&lt;/p&gt;</comment>
                            <comment id="12943173" author="gtully" created="Thu, 4 Nov 2010 18:45:55 +0000"  >&lt;p&gt;I tried to reproduce this issue with a test case. The test case is committed at apache as it works ok: &lt;a href=&quot;http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/test/java/org/apache/activemq/usecases/ExpiredMessagesWithNoConsumerTest.java?view=diff&amp;amp;r1=1031135&amp;amp;r2=1031136&amp;amp;pathrev=1031136&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/test/java/org/apache/activemq/usecases/ExpiredMessagesWithNoConsumerTest.java?view=diff&amp;amp;r1=1031135&amp;amp;r2=1031136&amp;amp;pathrev=1031136&lt;/a&gt;&lt;br/&gt;
It is a variant of a slow consumer test, in the original the consumer blocks and only acks when all the messages in the queue have expired. So it will have received 600 (prefetch) messages and they will be in the prefetchsubscription.dispatched list on the broker. The test verifies that all of these messages expire.&lt;br/&gt;
The variation of that test to validate this issue adds another batch of messages with no expiry and validates that the consumer can receive them, so it proves that expiring messages in the dispatched list does not block the consumer.&lt;/p&gt;

&lt;p&gt;Could you look at the test case to see if any of the options used in the test do not match your use case?&lt;/p&gt;</comment>
                            <comment id="12943184" author="siim_kaalep" created="Fri, 5 Nov 2010 09:18:25 +0000"  >&lt;p&gt;After performing more tests I also observed the appearance of OutOfMemoryError. I would like to raise the theoretical case that OutOfMemoryError caused some thread to die that was supposed to perform maintenance for the dispatched list. Leading to a situation wherein the expired messages clogged the processing of the dispatched list.&lt;/p&gt;

&lt;p&gt;If that would be the case, then the current fix is redundant and the real problem is what caused that OutOfMemoryError.&lt;/p&gt;</comment>
                            <comment id="12943183" author="gtully" created="Fri, 5 Nov 2010 10:51:20 +0000"  >&lt;p&gt;yes, with an OOM all bets are off as any thread can die and it is not possible to restart them when there is no heap. &lt;br/&gt;
There is a bunch of information related to memory usage and trouble shooting at: &lt;a href=&quot;http://activemq.apache.org/javalangoutofmemory.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/javalangoutofmemory.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13072810" author="tabish121" created="Fri, 29 Jul 2011 13:30:20 +0000"  >&lt;p&gt;The addition of the inactive destination cleanup and the auto sweep for expired messages should resolve this issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14751</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 17 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0agz3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59023</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>