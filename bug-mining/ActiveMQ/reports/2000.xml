<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:01:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4674] ActiveMQ 5.x does not support the notion of a grace-period for heart beats as supported by the STOMP protocol</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4674</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Regarding the configuration of heart beating the STOMP protocol spec states:&lt;/p&gt;

&lt;p&gt;    &quot;- because of timing inaccuracies, the receiver SHOULD be tolerant and take into account an error margin&quot;&lt;/p&gt;

&lt;p&gt;However, it appears that ActiveMQ 5.x is not tolerant of any error margin. &lt;/p&gt;

&lt;p&gt;Despite the fact that the spec says SHOULD rather than MUST it would make the implementation of STOMP clients easier if the error margin was published.&lt;/p&gt;

&lt;p&gt;As the broker aggressively enforces the heart beat timeouts false failover attempts can result.&lt;/p&gt;

&lt;p&gt;Apparently Apollo supports an error margin of 1.5x the configured heart beat. If it could be made configurable that would be even better! &lt;/p&gt;</description>
                <environment></environment>
        <key id="12662489">AMQ-4674</key>
            <summary>ActiveMQ 5.x does not support the notion of a grace-period for heart beats as supported by the STOMP protocol</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="paulgale">Paul Gale</reporter>
                        <labels>
                            <label>easyfix</label>
                    </labels>
                <created>Wed, 7 Aug 2013 20:45:10 +0000</created>
                <updated>Fri, 2 May 2014 15:10:01 +0000</updated>
                            <resolved>Wed, 14 Aug 2013 20:20:33 +0000</resolved>
                                    <version>5.8.0</version>
                                    <fixVersion>5.9.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13740130" author="tabish121" created="Wed, 14 Aug 2013 20:20:33 +0000"  >&lt;p&gt;Added transport options &quot;?transport.hbGracePeriodMultiplier&quot; which is used to add a user defined grace period to the read check interval indicated by the connecting STOMP client.   By default this value is set at 1.0 in order to keep backwards compat with clients that don&apos;t expect a grace period.  Can be set to values greater than 1.0f and the read check interval will be multiplied by this value.  &lt;/p&gt;</comment>
                            <comment id="13745128" author="paulgale" created="Tue, 20 Aug 2013 16:58:25 +0000"  >&lt;p&gt;I think something has gone awry here. This implementation of a &apos;grace period&apos; doesn&apos;t really help. &lt;/p&gt;

&lt;p&gt;What I am observing, after configuring the grace period with a value of 1.5, is that when a client connects (simplified):&lt;/p&gt;

&lt;p&gt;CONNECT&lt;br/&gt;
heart-beat:5000,0&lt;/p&gt;

&lt;p&gt;the broker responds with:&lt;/p&gt;

&lt;p&gt;CONNECTED&lt;br/&gt;
heart-beat:0,7500&lt;/p&gt;

&lt;p&gt;which is incorrect. The grace period multiplier should NOT affect the broker&apos;s response. The broker should have responded with 5000. &lt;/p&gt;

&lt;p&gt;The client therefore honors the broker&apos;s inflated interval (per the STOMP spec) and sends a read check every 7500ms. &lt;/p&gt;

&lt;p&gt;The broker, meanwhile, applies the grace period multiplier, a second time, to its inflated read check interval. In this case, it now performs a read check every 11250ms (as shown in the DEBUG logging of the AbstractInactivityMonitor).&lt;/p&gt;

&lt;p&gt;With the client idle the broker&apos;s activemq.log contains TRACE log entries that read &quot;A receive is in progress&quot; every 11250ms. I presume this is the ReadCheckTimer handling the read check sent from the client? If so, the log output could be a little more descriptive.&lt;/p&gt;


</comment>
                            <comment id="13745200" author="tabish121" created="Tue, 20 Aug 2013 17:58:50 +0000"  >&lt;p&gt;submit some unit tests. &lt;/p&gt;</comment>
                            <comment id="13745438" author="paulgale" created="Tue, 20 Aug 2013 21:17:24 +0000"  >&lt;p&gt;I have no idea how to write unit tests for ActiveMQ and this section of code in particular. &lt;/p&gt;

&lt;p&gt;Unfortunately I could not find any unit tests for this feature which is surprising given that it was added just the other day. How was it tested? It&apos;s a tad galling to be asked for some tests now.&lt;/p&gt;

&lt;p&gt;I don&apos;t mind modifying existing tests though. However, my personal experience with the unit test codebase is that they&apos;re rather flaky; they almost never pass whenever I&apos;ve tried to run them which doesn&apos;t exactly entice me into wanting to try now.&lt;/p&gt;

&lt;p&gt;Nonetheless, from a quick analysis of the code it would appear that the offending code is in activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/ProtocolConverter.java at line 929:
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    hbReadInterval = (&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;) (&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.parseLong(keepAliveOpts[0]) * hbGracePeriodMultiplier); &lt;span class=&quot;code-comment&quot;&gt;// Wrong!&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;should be:
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    hbReadInterval = (&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;) &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.parseLong(keepAliveOpts[0]); &lt;span class=&quot;code-comment&quot;&gt;//  Honor the client&apos;s read interval&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;where keepAliveOpts&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; is the client specified heartbeat read-interval.&lt;/p&gt;

&lt;p&gt;When the inactivity monitor&apos;s read check time is calculated it&apos;s done correctly:
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;StompInactivityMonitor monitor = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.stompTransport.getInactivityMonitor();
monitor.setReadCheckTime((&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;) (hbReadInterval * hbGracePeriodMultiplier));  &lt;span class=&quot;code-comment&quot;&gt;// Correct
&lt;/span&gt;monitor.setInitialDelayTime(&lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(hbReadInterval, hbWriteInterval));
monitor.setWriteCheckTime(hbWriteInterval);
monitor.startMonitoring();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Setup:    keepAliveOpts[0] = 5000, hbGracePeriodMultiplier = 1.5

Expected: hbReadInterval == 5000, monitor.getReadCheckTime() == 7500
Actual:   hbReadInterval == 7500, monitor.getReadCheckTime() == 11250
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13745460" author="tabish121" created="Tue, 20 Aug 2013 21:28:02 +0000"  >&lt;p&gt;Already fixed earlier, should be in the latest nightly. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="12711959">AMQ-5168</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>342492</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 14 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1n2dr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>342797</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>