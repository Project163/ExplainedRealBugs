<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:05:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5086] vm transport create=false&amp;waitForStart race condition</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5086</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Experience this bug on 5.7.0, I think this is the same on the trunk&lt;/p&gt;

&lt;p&gt;using vm transport for a client to connect to an embedded broker, in a multithreaded application, I&apos;m experiencing a an error (sometimes) which appears to be a race condition at startup.&lt;/p&gt;

&lt;p&gt;Im using create=false and waitForStart to create a connectionFactory for a client connection&lt;br/&gt;
vm://ApplicationName?create=false&amp;amp;waitForStart=120000&lt;/p&gt;

&lt;p&gt;The broker service is started in a seperate thread&lt;/p&gt;

&lt;p&gt;the client connection is started first. but surprisingly it tries start the brokers transport connector. An apparent glitch follows when the broker service stops and re-start the transport.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2014-03-05 11:07:57,626 [ClientConnection_thread] INFO  org.apache.activemq.broker.TransportConnector - Connector vm://ApplicationName Started
[...]
2014-03-05 11:08:07,009 [Main_thread] INFO  org.apache.activemq.broker.TransportConnector - Connector vm://ApplicationName Stopped
2014-03-05 11:08:07,011 [Main_thread] INFO  org.apache.activemq.broker.TransportConnector - Connector vm://ApplicationName Started
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I look into the activemq source and saw this:&lt;/p&gt;

&lt;p&gt;BrokerService.class&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void start() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
[...]
    &lt;span class=&quot;code-comment&quot;&gt;// in jvm master slave, lets not publish over existing broker till we get the lock
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; BrokerRegistry brokerRegistry = BrokerRegistry.getInstance();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (brokerRegistry.lookup(getBrokerName()) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            brokerRegistry.bind(getBrokerName(), BrokerService.&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
    }
    startPersistenceAdapter(startAsync);
    startBroker(startAsync);
    brokerRegistry.bind(getBrokerName(), BrokerService.&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;VMTransportFactory.class&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; BrokerService lookupBroker(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; BrokerRegistry registry, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; brokerName, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; waitForStart) {
        BrokerService broker = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(registry.getRegistryMutext()) {
            broker = registry.lookup(brokerName);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (broker == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; waitForStart &amp;gt; 0) {
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; expiry = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis() + waitForStart;
                &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (broker == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;  &amp;amp;&amp;amp; expiry &amp;gt; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis()) {
                    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; timeout = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(0, expiry - &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis());
                    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; broker named: &quot;&lt;/span&gt; + brokerName + &lt;span class=&quot;code-quote&quot;&gt;&quot; to start&quot;&lt;/span&gt;);
                        registry.getRegistryMutext().wait(timeout);
                    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException ignored) {
                    }
                    broker = registry.lookup(brokerName);
                }
            }
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; broker;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It appears that create=false and waitForStart only waits for the broker to be added to the BrokerRegistry. However when the brokerService is starts, it seems that the broker is added to the registry before it is started.&lt;/p&gt;

&lt;p&gt;I believe some synchronization is missing make the VMTransportFactory wait for the broker not only to be added to the registry, but also fully started.&lt;/p&gt;









</description>
                <environment></environment>
        <key id="12699227">AMQ-5086</key>
            <summary>vm transport create=false&amp;waitForStart race condition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="cmamen">Christian Mamen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Mar 2014 18:30:18 +0000</created>
                <updated>Tue, 16 Dec 2014 00:00:16 +0000</updated>
                            <resolved>Mon, 9 Jun 2014 19:46:53 +0000</resolved>
                                    <version>5.7.0</version>
                    <version>5.8.0</version>
                    <version>5.9.0</version>
                                    <fixVersion>5.10.1</fixVersion>
                    <fixVersion>5.11.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13989694" author="tabish121" created="Mon, 5 May 2014 16:54:56 +0000"  >&lt;p&gt;Would be great if you could come up with a test case to reproduce this issue.  I&apos;ll attach a patch file here that I think should address your issue but a test would be needed to ensure it stays fixed into the future.  &lt;/p&gt;</comment>
                            <comment id="14025635" author="tabish121" created="Mon, 9 Jun 2014 19:46:54 +0000"  >&lt;p&gt;Added a proper wait for start and some tests. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12643389" name="AMQ5086.patch" size="3059" author="tabish" created="Mon, 5 May 2014 16:55:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>377574</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 24 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1t27z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>377868</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>