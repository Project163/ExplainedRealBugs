<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:49:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-7485] RAR managed producer is unaware of timed out transaction; sends non transacted message in error</title>
                <link>https://issues.apache.org/jira/browse/AMQ-7485</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;There is a problem with a RAR managed connection enlisted in a xa transaction that aborts, if that connection is used to produce messages.&lt;/p&gt;

&lt;p&gt;getConnection succeeds and enlists the resource, the session is in an xa transaction, all is good. &lt;br/&gt;
If however, the transaction times out and aborts, &lt;b&gt;before&lt;/b&gt; a producer gets to send(), the send will &lt;b&gt;not&lt;/b&gt; see a transaction context and will produce a message with no transaction identity in error.&lt;br/&gt;
The abort forces an end(fail) and rollback, however this results in the transaction context being unset and the producer session not being aware of the aborted transaction.&lt;br/&gt;
The transaction management is external in the case of a managed connection and the default is non transactional in the absence of an external or RAR local transaction. &lt;/p&gt;

&lt;p&gt;Getting a reference to the TransactionManager and doing a transaction status check before send is a workaround, but that should not be necessary.&lt;/p&gt;</description>
                <environment>&lt;p&gt;JEE RAR&lt;/p&gt;</environment>
        <key id="13305198">AMQ-7485</key>
            <summary>RAR managed producer is unaware of timed out transaction; sends non transacted message in error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="gtully">Gary Tully</reporter>
                        <labels>
                            <label>RAR</label>
                            <label>XA</label>
                            <label>xaresource</label>
                    </labels>
                <created>Fri, 15 May 2020 12:59:37 +0000</created>
                <updated>Thu, 6 Oct 2022 11:18:37 +0000</updated>
                            <resolved>Fri, 15 May 2020 14:45:14 +0000</resolved>
                                    <version>5.15.0</version>
                                    <fixVersion>5.16.0</fixVersion>
                                    <component>RAR</component>
                    <component>XA</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17108260" author="gtully" created="Fri, 15 May 2020 13:06:29 +0000"  >&lt;p&gt;There is an existing rollbackOnly flag that we can check in a producer and flip in the RAR managed connection context. This flag is reset on the next transaction boundary which is what we want.&lt;br/&gt;
In this way, any use of a producer on a session with an aborted transaction will fail early and report an illegal state, preventing any spurious non transacted message production in error. &lt;/p&gt;</comment>
                            <comment id="17108352" author="jira-bot" created="Fri, 15 May 2020 14:40:31 +0000"  >&lt;p&gt;Commit 0ebb0f88ef2afc590bf19ba1ec08ed995669a9dc in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=0ebb0f8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=0ebb0f8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7485&quot; title=&quot;RAR managed producer is unaware of timed out transaction; sends non transacted message in error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7485&quot;&gt;&lt;del&gt;AMQ-7485&lt;/del&gt;&lt;/a&gt; add check for rollbackonly flag in session send such that failed ended transactions prevent further work till next transaction boundary&lt;/p&gt;</comment>
                            <comment id="17108366" author="gtully" created="Fri, 15 May 2020 14:45:14 +0000"  >&lt;p&gt;Added rollback only check in send and flip the rollback only flag from the managed transaction context when end is called with a failure flag.&lt;/p&gt;</comment>
                            <comment id="17109022" author="fvaleri" created="Sat, 16 May 2020 12:00:21 +0000"  >&lt;p&gt;Just for the record, this is an example of the workaround:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Resource(mappedName = &lt;span class=&quot;code-quote&quot;&gt;&quot;java:/TransactionManager&quot;&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; TransactionManager tm;
...
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tm.getStatus() != Status.STATUS_ACTIVE) {
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;TX not active&quot;&lt;/span&gt;);
}
producer.send(message);
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17613450" author="joachim.glink@dematic.com" created="Thu, 6 Oct 2022 11:18:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&#160; I came across this change because I experienced a different behavior in our application after upgrading to AMQ 5.16.x&lt;/p&gt;

&lt;p&gt;In the org.apache.activemq.ra.ManagedTransactionContext class you&#180;ve added&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isRollbackOnly() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; sharedContext.isRollbackOnly() || &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.isRollbackOnly();
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;All the other methods in this class do the call on the sharedContext only in case that the useSharedContext flag is set to true, e.g.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void commit() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; JMSException {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (useSharedTxContext) {
        sharedContext.commit();
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.commit();
    }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In our environment (Wildfly with AMQ RAR), I have a strange behavior that a Producer#send fails because of a &quot;transaction marked as rollback only&quot; even if we do the send without a transaction. (I don&#180;t have a simple reproducer for it and until know I&#180;m only able to reproduce the situation in our full-running system.)&lt;/p&gt;

&lt;p&gt;If I reset the AMQ version to 5.14.x or change the ManagedTransactionContext#isRollbackOnly() and do the check on the &lt;em&gt;sharedContext&lt;/em&gt; only in case of useSharedContext=true, the message sending works.&lt;/p&gt;

&lt;p&gt;So I wonder why the check isn&#180;t done on this method.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 5 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0es7c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>