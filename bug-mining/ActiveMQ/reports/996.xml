<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:47:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2584] Massege store is not cleaned when durable topic subscribers are refusing messages </title>
                <link>https://issues.apache.org/jira/browse/AMQ-2584</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;i am using activemq 5.3 (resp. 5.4 snapshot , 5.3.1 snapshot) with kahadb in following use-case:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;3 durable topic subscriber, each refuses message using session.recover(), 1 delivery attempts&lt;/li&gt;
	&lt;li&gt;ActiveMQ.DLQ consumer&lt;/li&gt;
	&lt;li&gt;persistent message topic producer&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In such case deadletter consumer should consume every message sent, as soon as number of delivery attempts is reached and mmessage is sent to ActiveMQ.DLQ. Result is ok but kahadb data directory at the end contains all log files with names db-&amp;lt;number&amp;gt;.log ever created. They aren&apos;t deleted even after some time.&lt;/p&gt;

&lt;p&gt;I can also see following massege in console:&lt;/p&gt;

&lt;p&gt;WARN | Duplicate message add attempt rejected. Message id: ID:sk1d069c-3826-1264006781626&lt;br/&gt;
-0:0:1:1:13425&lt;/p&gt;

&lt;p&gt;If use-case is altered to use queue instead of topic log files are periodically deleted without WARN messages in console.&lt;/p&gt;

&lt;p&gt;Same behaviour (data files not cleaned) if amqPersistenceAdapter is used except of WARN messages.&lt;/p&gt;

</description>
                <environment>&lt;p&gt;WinXP,&lt;br/&gt;
java version &quot;1.6.0_05&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.6.0_05-b13)&lt;br/&gt;
Java HotSpot(TM) Client VM (build 10.0-b19, mixed mode, sharing)&lt;/p&gt;</environment>
        <key id="12483832">AMQ-2584</key>
            <summary>Massege store is not cleaned when durable topic subscribers are refusing messages </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="durokuruc">Juraj Kuruc</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Jan 2010 11:33:43 +0000</created>
                <updated>Tue, 23 Aug 2011 19:11:38 +0000</updated>
                            <resolved>Wed, 27 Oct 2010 12:04:05 +0000</resolved>
                                    <version>5.3.0</version>
                    <version>5.3.1</version>
                    <version>5.4.0</version>
                                    <fixVersion>5.4.2</fixVersion>
                                    <component>Message Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="12942079" author="gtully" created="Wed, 27 Jan 2010 12:25:34 +0000"  >
&lt;p&gt;Could you attach a test case to this?&lt;/p&gt;

&lt;p&gt;I have just tracked down the cause of the:&lt;br/&gt;
 WARN | Duplicate message add attempt rejected. Message id: ID:sk1d069c-3826-1264006781626-0:0:1:1:13425&lt;br/&gt;
but I don&apos;t think this could result in dangling references to files in the store. &lt;br/&gt;
So i suspect the there is another reason for the data files not being cleaned up. At simple test case would help a lot.&lt;/p&gt;</comment>
                            <comment id="12942080" author="durokuruc" created="Wed, 27 Jan 2010 14:31:02 +0000"  >&lt;p&gt;Find attached java files, sample message and configuration file activemq.xml  for  reproducing this issue.&lt;/p&gt;</comment>
                            <comment id="12938684" author="gtully" created="Mon, 16 Aug 2010 16:54:51 +0000"  >&lt;p&gt;junit test case based on submitted test but borrowing from the junit test case attached to &lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-2870&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-2870&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This test case works fine on trunk&lt;/p&gt;</comment>
                            <comment id="12938717" author="gtully" created="Mon, 16 Aug 2010 16:56:26 +0000"  >&lt;p&gt;The difference may be the use of a small journal data file length such that the files are quickly reclaimed when the contain unreferenced data. With a large file all the messages can exist in one or two data files.&lt;/p&gt;</comment>
                            <comment id="12938313" author="gtully" created="Tue, 17 Aug 2010 12:18:51 +0000"  >&lt;p&gt;Try the new test case, if you can make that fail, please reopen&lt;/p&gt;</comment>
                            <comment id="12938125" author="slewis" created="Tue, 17 Aug 2010 14:28:39 +0000"  >&lt;p&gt;Hey Gary, I modified the test case to use multiple consumers, I think that&apos;s when this seems to break, what do you think?&lt;/p&gt;</comment>
                            <comment id="12938424" author="gtully" created="Tue, 17 Aug 2010 14:52:20 +0000"  >&lt;p&gt;need to look at it in some detail.. guess you should reopen this pending that.&lt;/p&gt;</comment>
                            <comment id="12938225" author="slewis" created="Tue, 17 Aug 2010 14:58:24 +0000"  >&lt;p&gt;Yup, sure thing Gary.  Haven&apos;t had time to look at it other than updating the test case, but I think it&apos;s still an issue.&lt;/p&gt;</comment>
                            <comment id="12938498" author="gtully" created="Wed, 18 Aug 2010 15:24:57 +0000"  >&lt;p&gt;got to the bottom of this. Both stores left dangling references to data files when a journal add was suppressed as a duplicate by the index or reference store.&lt;br/&gt;
In the AMQ case, the bug was a little subtler as it only occurred if a batched write to the journal was pending when the duplicate occurs.&lt;/p&gt;</comment>
                            <comment id="12943082" author="slewis" created="Wed, 20 Oct 2010 20:25:00 +0000"  >&lt;p&gt;Looks like there&apos;s still a case this issue can occur, namely if the consumers and DLQ consumer consumes messages concurrently.  Here&apos;s a patch that updates the existing test which will then show this other case.&lt;/p&gt;</comment>
                            <comment id="12943139" author="gtully" created="Wed, 27 Oct 2010 12:04:05 +0000"  >&lt;p&gt;A workaround for this issue, where the DLQ can receive duplicates, is to disable the cursor message audit for the DLQ.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;policyEntry queue=ActiveMQ.DLQ&lt;span class=&quot;code-quote&quot;&gt;&quot; enableAudit=&quot;&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot; /&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;An enhancement, to allow a DLQ per durable subscription would make it possible to track which durable subscription rejected a message on an individual basis:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-3003&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-3003&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12943154" author="gtully" created="Thu, 28 Oct 2010 12:40:22 +0000"  >&lt;p&gt;additionally, &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;concurrentStoreAndDispatchQueues=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; must be added to the kahaDB persistence adapter to allow it to correctly ack the duplicates that ensue. Otherwise there can be the occasional missed ack. This needs more investigation to see if it can be made work reliably with the default value.&lt;/p&gt;</comment>
                            <comment id="12943165" author="gtully" created="Tue, 2 Nov 2010 13:07:01 +0000"  >&lt;p&gt;Final resolution is to suppress duplicate dispatch to the DLQ at source, in the DeadLetterStrategy implementation by having it keep an audit. In this way, only one copy of a message is dispatched to the DLQ, irrespective of how many durable consumers reject the message. &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3003&quot; title=&quot;Allow the option of a DLQ per durable subscription DeadLetterStrategy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3003&quot;&gt;&lt;del&gt;AMQ-3003&lt;/del&gt;&lt;/a&gt; will help with that.&lt;br/&gt;
Most duplicates are trapped by the store, but when the store has already acked the original, it can get through, the potential problem is the pending cursor of messages to dispatch. When concurrent with store, this can result in a missed dispatch and a subsequent missing ack leaving a dangling message.&lt;br/&gt;
Suppressing the duplicate send in the deadletter strategy removes this possibility.&lt;br/&gt;
Fix in r1030013&lt;/p&gt;</comment>
                            <comment id="13062371" author="larhvi" created="Sat, 9 Jul 2011 13:09:06 +0000"  >&lt;p&gt;I&apos;m having a problem where messages fails to enter the DLQ. My scenario is:&lt;/p&gt;

&lt;p&gt;1. some message fails during processing and ends up on the DLQ&lt;br/&gt;
2. it&apos;s moved back to its original queue, but fails again&lt;br/&gt;
3. message not sent back to the DLQ&lt;/p&gt;

&lt;p&gt;After some googling I found this issue, and I suspect you may have introduced a bug in AbstractDeadLetterStrategy by adding the duplication-checks. (&lt;a href=&quot;http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/main/java/org/apache/activemq/broker/region/policy/AbstractDeadLetterStrategy.java?r1=1030013&amp;amp;r2=1030012&amp;amp;pathrev=1030013&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/main/java/org/apache/activemq/broker/region/policy/AbstractDeadLetterStrategy.java?r1=1030013&amp;amp;r2=1030012&amp;amp;pathrev=1030013&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;I&apos;m seeing the debug log-entry when messages are lost..&lt;br/&gt;
2011-07-09 14:59:07,177 | DEBUG | rollback: TX:ID:ubuntu-48335-1310214645889-0:1:18 syncCount: 2 | org.apache.activemq.transaction.LocalTransaction | ActiveMQ Transport: tcp:///127.0.0.1:59188&lt;br/&gt;
2011-07-09 14:59:07,178 | DEBUG | Not adding duplicate to DLQ: ID:ubuntu-58129-1310214649907-0:1:9:1:5, dest: queue://xxxx | org.apache.activemq.broker.region.policy.AbstractDeadLetterStrategy | ActiveMQ Transport: tcp:///127.0.0.1:59188&lt;/p&gt;</comment>
                            <comment id="13063234" author="gtully" created="Mon, 11 Jul 2011 09:13:10 +0000"  >&lt;p&gt;Lars, yes, the audit should be configurable, such that is it possible to disable. I will expose the option on the default DLQ strategy.&lt;/p&gt;

&lt;p&gt;btw: How do you achieve 2), is it a manual process or do you use a camel route or something else? Any chance you have a test case?&lt;/p&gt;

&lt;p&gt;The addition of &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3003&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-3003&lt;/a&gt; provides an alternative way of avoiding duplicate submission to the DLQ in the scenario described in this issue.&lt;/p&gt;</comment>
                            <comment id="13063248" author="gtully" created="Mon, 11 Jul 2011 09:50:47 +0000"  >&lt;p&gt;new DeadLetterStrategy enableAudit attribute introduced in &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1145092&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1145092&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13063310" author="larhvi" created="Mon, 11 Jul 2011 12:36:15 +0000"  >&lt;p&gt;I moved the messages using the admin interface (conf/jetty.xml).&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt; Any chance you have a test case?&lt;br/&gt;
This happens almost every time a message is moved back to the DLQ the 2nd time. Seems a little bit random though..&lt;/p&gt;

&lt;p&gt;Using the new setting in #1145092 we can avoid message loss now, but shouldn&apos;t that be the default? I mean, if people are bothered by dups in the DLQ wouldn&apos;t it be better for them to enable the audit?&lt;/p&gt;

&lt;p&gt;Btw, when will this fix be released?&lt;/p&gt;</comment>
                            <comment id="13089642" author="carfey" created="Tue, 23 Aug 2011 18:23:41 +0000"  >&lt;p&gt;&amp;gt;&amp;gt; new DeadLetterStrategy enableAudit attribute introduced in &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1145092&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1145092&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Gary, will this be configurable on the individualDeadLetterStrategy/sharedDeadLetterStrategy element or will it be derived from a policyEntry setting? &lt;/p&gt;</comment>
                            <comment id="13089671" author="gtully" created="Tue, 23 Aug 2011 19:11:38 +0000"  >&lt;p&gt;on a dead letter strategy, eg: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;policyEntry ..&quot;&amp;gt;
            &amp;lt;deadLetterStrategy&amp;gt;
              &amp;lt;individualDeadLetterStrategy queuePrefix=&lt;span class=&quot;code-quote&quot;&gt;&quot;Test.DLQ.&quot;&lt;/span&gt; processNonPersistent=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt; enableAudit=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt; /&amp;gt;
            &amp;lt;/deadLetterStrategy&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461601" name="2584_test.zip" size="10195" author="durokuruc" created="Wed, 27 Jan 2010 14:31:02 +0000"/>
                            <attachment id="12461799" name="AMQ2584Test.java" size="8278" author="slewis" created="Tue, 17 Aug 2010 14:28:39 +0000"/>
                            <attachment id="12461797" name="AMQ2584Test.java" size="8089" author="gtully" created="Mon, 16 Aug 2010 16:54:51 +0000"/>
                            <attachment id="12461814" name="UpdatedTestCase.patch" size="9162" author="slewis" created="Wed, 20 Oct 2010 20:25:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14533</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 14 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0b9m7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63670</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>