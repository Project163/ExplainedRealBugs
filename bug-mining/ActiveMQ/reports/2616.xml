<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:13:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5857] Message content stored twice while sending</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5857</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;The storeContent method in ActiveMQTextMessage does not clean text field after storing content. Therefor the message temporary exists twice which can lead to OOM problems for large or many text messages concurrently processing. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12839815">AMQ-5857</key>
            <summary>Message content stored twice while sending</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="graben">Benjamin Graf</reporter>
                        <labels>
                    </labels>
                <created>Tue, 23 Jun 2015 11:14:49 +0000</created>
                <updated>Thu, 7 Apr 2016 14:27:51 +0000</updated>
                            <resolved>Fri, 31 Jul 2015 18:50:45 +0000</resolved>
                                    <version>5.7.0</version>
                    <version>5.8.0</version>
                    <version>5.9.0</version>
                    <version>5.10.0</version>
                    <version>5.11.0</version>
                                    <fixVersion>5.12.0</fixVersion>
                                    <component>JMS client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14605813" author="christopher.l.shannon" created="Mon, 29 Jun 2015 16:08:25 +0000"  >&lt;p&gt;I don&apos;t think it is necessary to change this as there&apos;s already another method called &lt;tt&gt;storeContentAndClear()&lt;/tt&gt; which does this and you can call the method after setting the text on the message if memory could be an issue.  I would be hesitent to change the default behavior to always clear out the text because then a call to &lt;tt&gt;getText&lt;/tt&gt; on a TextMessage would require an additional decoding of the content.&lt;/p&gt;</comment>
                            <comment id="14606015" author="graben" created="Mon, 29 Jun 2015 18:02:06 +0000"  >&lt;p&gt;Well, do you think anyone would call getText() anymore after calling setText()? I think calling storeContentAndClear() is not a good solution esspecially if your using JMS API (eg. camel-jms) and do not want to depend on ActiveMQ proprietary API. Why not use storeContentAndClear in beforeMarshall()?&lt;/p&gt;</comment>
                            <comment id="14606143" author="christopher.l.shannon" created="Mon, 29 Jun 2015 18:55:16 +0000"  >&lt;p&gt;You do make a good point about storeContentAndClear not being a great solution if you want to stick with a pure JMS client.  I wouldn&apos;t expect getText() to be called too often but I could see it being useful in some cases like if a client was logging full messages before or after a send.  &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;, What do you think? I could go either way on this. &lt;/p&gt;</comment>
                            <comment id="14606501" author="tabish121" created="Mon, 29 Jun 2015 22:02:40 +0000"  >&lt;p&gt;I don&apos;t think it&apos;d be a bad thing if the message cleared the content on marshal, however, it is possible that this could have some unintended consequences.  The broker and the client both share this code and on the client side it probably works fine, on the broker side there could be cases where we might see something go wrong when things like concurrent store and dispatch is enabled so changing this bit should be thoroughly tested.  &lt;/p&gt;</comment>
                            <comment id="14606604" author="christopher.l.shannon" created="Mon, 29 Jun 2015 22:57:49 +0000"  >&lt;p&gt;Coming from the broker side, this change actually makes more sense to me as messages will be in memory longer term than a typical client where they go out of scope after being sent and are eligible for GC.&lt;/p&gt;

&lt;p&gt;I can start testing this out tomorrow and see if anything obvious breaks (ie run through the full test suite, etc)&lt;/p&gt;</comment>
                            <comment id="14623966" author="graben" created="Sun, 12 Jul 2015 19:29:59 +0000"  >&lt;p&gt;Any test results yet?&lt;/p&gt;</comment>
                            <comment id="14624568" author="christopher.l.shannon" created="Mon, 13 Jul 2015 12:09:15 +0000"  >&lt;p&gt;Sorry, got side tracked a bit the past couple of weeks.  So, I ran through some tests locally and everything looked ok.  A full run on the CI server would still be needed though as some of the tests are unreliable when run locally for me so I&apos;d want to run it on the CI server to make sure.&lt;/p&gt;

&lt;p&gt;I guess I would defer to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt; on this.  Tim, do you think running through the existing test suite and seeing if anything fails is good enough for testing?&lt;/p&gt;</comment>
                            <comment id="14624792" author="tabish121" created="Mon, 13 Jul 2015 15:24:21 +0000"  >&lt;p&gt;I think that should show if there is an impact.  I think the change is safe other than the risk that the broker logs a message an causes the content to become unmarshaled which could cause compressed content to no longer be compressed but that seems unlikely.  &lt;/p&gt;</comment>
                            <comment id="14624853" author="githubbot" created="Mon, 13 Jul 2015 16:00:15 +0000"  >&lt;p&gt;GitHub user cshannon opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/134&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/134&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5857&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5857&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Changing ActiveMQTextMessage to clear out the text field on marshal to&lt;br/&gt;
    a ByteSequence to prevent the data from being stored in memory twice.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/cshannon/activemq&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cshannon/activemq&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5857&quot; title=&quot;Message content stored twice while sending&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5857&quot;&gt;&lt;del&gt;AMQ-5857&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/134.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/134.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #134&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4e10e046d42a2b794ef830517bfaf651562c970a&lt;br/&gt;
Author: Christopher L. Shannon (cshannon) &amp;lt;christopher.l.shannon@gmail.com&amp;gt;&lt;br/&gt;
Date:   2015-07-13T15:31:14Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5857&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5857&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Changing ActiveMQTextMessage to clear out the text field on marshal to&lt;br/&gt;
    a ByteSequence to prevent the data from being stored in memory twice.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14625086" author="christopher.l.shannon" created="Mon, 13 Jul 2015 18:16:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I pushed up this small change so you can either test it or apply it and see what happens with the full CI build.  Something seems to be up with the PR Jenkins build though.  It failed again for this PR (while working locally) and someone else pushed a minor PR up today and the same thing happened.  It took 3 tries to get it to pass the tests.  I&apos;ll probably ping Gary to give him a heads up.&lt;/p&gt;</comment>
                            <comment id="14648020" author="jira-bot" created="Thu, 30 Jul 2015 17:44:21 +0000"  >&lt;p&gt;Commit 84ec047d2ffdee9630f74bf939746cd5ff2d0e12 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=christopher.l.shannon&quot; class=&quot;user-hover&quot; rel=&quot;christopher.l.shannon&quot;&gt;christopher.l.shannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=84ec047&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=84ec047&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5857&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5857&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Changing ActiveMQTextMessage to clear out the text field on marshal to&lt;br/&gt;
a ByteSequence to prevent the data from being stored in memory twice.&lt;/p&gt;</comment>
                            <comment id="14648024" author="githubbot" created="Thu, 30 Jul 2015 17:47:03 +0000"  >&lt;p&gt;Github user cshannon closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/134&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/134&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14648026" author="christopher.l.shannon" created="Thu, 30 Jul 2015 17:49:16 +0000"  >&lt;p&gt;Fix applied on master and will be included in 5.12.0&lt;/p&gt;</comment>
                            <comment id="14649500" author="christopher.l.shannon" created="Fri, 31 Jul 2015 17:20:28 +0000"  >&lt;p&gt;This fix has caused a test to fail: &lt;/p&gt;

&lt;p&gt;org.apache.activemq.camel.CamelVMTransportRoutingTest.testSendReceiveWithCamelRouteIntercepting&lt;/p&gt;

&lt;p&gt;There appears to be a race condition.&lt;/p&gt;</comment>
                            <comment id="14649642" author="jira-bot" created="Fri, 31 Jul 2015 18:46:46 +0000"  >&lt;p&gt;Commit 310c2bb05916811a25b84d76f11fb84b40087914 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=310c2bb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=310c2bb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5857&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5857&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fixing a potential race condition in the storeContent&lt;br/&gt;
method of ActiveMQTextMessage&lt;/p&gt;</comment>
                            <comment id="14649649" author="christopher.l.shannon" created="Fri, 31 Jul 2015 18:50:45 +0000"  >&lt;p&gt;There was a race condition in the storeContext() method of ActiveMQTextMessage where in between checking the text field for null and writing the content of text to the stream, the text field was set to null.  A fix has been applied that caches the reference to the text string locally in the method to prevent having to synchronize.  I also tweaked a couple other methods with a similar change to prevent the same issue.&lt;/p&gt;

&lt;p&gt;CamelVmTransportRoutingTest is now passing again.  I will double check with Jenkins tomorrow to make sure the test failure has been cleared up.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12483485">AMQ-2103</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 16 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2gdqf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>