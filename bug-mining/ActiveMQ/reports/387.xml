<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:37:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1797] persistent messages for durable subscribers are not purged from disc storage</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1797</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I have some problems with multiple durable subscribers while persistent delivery is used.&lt;br/&gt;
Message should be deleted from disc storage (periodically) after all interested subscribers have received it. In case there was one durable subscriber everything woks just fine. However when I tested this scenerio with two durable subscribers on topic,  the messages were never deleted (disc usage is continously consumed and never purged). &lt;/p&gt;


&lt;p&gt;Test case description:&lt;br/&gt;
-using default activemq.xml configuration file from binary distribution &lt;br/&gt;
-TopicConsumers.java creates two separetes durable consumers&lt;br/&gt;
-textMessageFile.txt is file which text is sent by producer (place it on classpath)&lt;/p&gt;

&lt;p&gt;Result:&lt;br/&gt;
-all messages there were send were also received by both subscribers&lt;br/&gt;
-after more then 100k messages data directory is about 1GB. &lt;br/&gt;
-restarting activemq with so big persistent storage takes very long time&lt;/p&gt;</description>
                <environment>&lt;p&gt;WinXP,&lt;br/&gt;
java version &quot;1.6.0_05&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.6.0_05-b13)&lt;br/&gt;
Java HotSpot(TM) Client VM (build 10.0-b19, mixed mode, sharing)&lt;/p&gt;</environment>
        <key id="12482917">AMQ-1797</key>
            <summary>persistent messages for durable subscribers are not purged from disc storage</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="durokuruc">Juraj Kuruc</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Jun 2008 17:52:12 +0000</created>
                <updated>Wed, 1 Jul 2009 11:06:53 +0000</updated>
                            <resolved>Wed, 1 Jul 2009 11:06:08 +0000</resolved>
                                    <version>5.1.0</version>
                                    <fixVersion>5.3.0</fixVersion>
                                    <component>Message Store</component>
                        <due></due>
                            <votes>5</votes>
                                    <watches>4</watches>
                                                                                                                                                            <comments>
                            <comment id="12939806" author="durokuruc" created="Fri, 13 Jun 2008 15:01:52 +0000"  >&lt;p&gt;It looks that there is a problem in activemq journal wich is used by default amqPersistenceAdapter.  I have tested this also on amq 4.1.1 journaledJDBC adapter with same bug.&lt;br/&gt;
When jdbcPersistenceAdapter with 4.1.1(non-journal) or kahaPersistenceAdapter with 5.1 are used with 2 durable topic subscribers, disc storage is periodically emptied.&lt;/p&gt;</comment>
                            <comment id="12939820" author="rajdavies" created="Sat, 14 Jun 2008 07:00:05 +0000"  >&lt;p&gt;Fixed by SVN revision 667752 and revision 667756&lt;/p&gt;</comment>
                            <comment id="12940525" author="durokuruc" created="Wed, 5 Nov 2008 16:54:12 +0000"  >&lt;p&gt;I&apos;ve tested AMQ 5.2 SNAPSHOT for this fix with partial success. There isn&apos;t any problem every message from Topic is acknoledged but solution doesn&apos;t work when some of messages are regulary received by durable subscribers and some of them are redeliverd till they get to ActiveMQ.DLQ due to exceeding max redelivery count.&lt;br/&gt;
To duplicate error see attached zip .&lt;/p&gt;

&lt;p&gt;-TopicRedeliver creates two separetes durable consumers, which consumes every odd message and recover session if message number is even. Parameter &quot;jms.redeliveryPolicy.maximumRedeliveries=1&quot; causes that after first redelivery message goes to dead letter queue.&lt;br/&gt;
-DlqConsumer consumes messages from ActiveMQ.DLQ&lt;br/&gt;
-TopicProducer sends messages to testTopic&lt;/p&gt;

&lt;p&gt;Reproducing steps:&lt;br/&gt;
1. run DlqConsumer&lt;br/&gt;
2. run TopicRedeliver&lt;br/&gt;
3. run TopicProducer&lt;/p&gt;

&lt;p&gt;Results:&lt;br/&gt;
1.&lt;br/&gt;
%ACTIVEMQ_HOME%/data/journal dir contains several data-x files. More messages you send more data-x files stays in mentioned dir and consumes disc space.(however some of them are deleted this behaviour isn&apos;t predictible)&lt;br/&gt;
Something is going obviously wrong because all messages are consumed from destinations (testTopic and ActiveMQ.DLQ).&lt;br/&gt;
2.&lt;br/&gt;
Size of ActiveMQ.DLQ shown in jConsole is possitive number, despite that DlqConsumer doesn&apos;t consume messages anymore.&lt;br/&gt;
3.&lt;br/&gt;
If TopicRedeliver and DlqConsumer are restarted, any further sending of messages may causes folowing exception:&lt;br/&gt;
ERROR RecoveryListenerAdapter        - Message id ID:sk1d069c-4253-1225900870814-0:0:1:1:42 could not be recovered from the data store - already dispatched&lt;/p&gt;

&lt;p&gt;Using AMQ 5.2. stable release is even not possible run this test - after couple hundred messages one of durable subscriber get stuck (see &lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-2021&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-2021&lt;/a&gt; ) .&lt;/p&gt;</comment>
                            <comment id="12940846" author="durokuruc" created="Wed, 25 Feb 2009 12:51:59 +0000"  >&lt;p&gt;Tests on amq revision number 729038 with amqPersistenceAdapter as well as with kahaPersistenceAdapter but none of them was sucessful&lt;br/&gt;
from different reasons.&lt;/p&gt;

&lt;p&gt;With amqPersistenceAdapter, 100k msgs have been sent and data directory size is 1.1 GB. &lt;br/&gt;
Further message sending make any difference - message store still grows. For addition following error occures several times:&lt;br/&gt;
ERROR RecoveryListenerAdapter        - Message id ... could not be recovered from the data store - already dispatched&lt;/p&gt;

&lt;p&gt;Using kahaPersistenceAdapter, after 100k msgs one of the consumer receives 100k second 99999 msgs.After another 300k msgs data directory size is 410MB. Also some errors are logged by AMQ:&lt;/p&gt;

&lt;p&gt;ERROR DataManagerImpl                - Looking for key 15 but not found in fileMap: &lt;/p&gt;
{17=data-queue-data-17 number = 17 , length = 177868 refCount = 6, 16=data-queue-data-16 number = 16 , length = 33546816 refCount = 86}
&lt;p&gt;ERROR MapContainerImpl               - Failed to get value for offset=4845, key=(15, 29641420, 47), value=(15, 29641472, 8839), previousItem=-1, nextItem=-1&lt;br/&gt;
java.io.IOException: Could not locate data file data-queue-data-15&lt;br/&gt;
        at org.apache.activemq.kaha.impl.data.DataManagerImpl.getDataFile(DataManagerImpl.java:129)&lt;br/&gt;
        at org.apache.activemq.kaha.impl.data.SyncDataFileReader.readItem(SyncDataFileReader.java:65)&lt;br/&gt;
        at org.apache.activemq.kaha.impl.data.DataManagerImpl.readItem(DataManagerImpl.java:141)&lt;br/&gt;
        at org.apache.activemq.kaha.impl.container.MapContainerImpl.getValue(MapContainerImpl.java:481)&lt;br/&gt;
        at org.apache.activemq.store.kahadaptor.KahaMessageStore.recoverNextMessages(KahaMessageStore.java:166)&lt;br/&gt;
        at org.apache.activemq.store.ProxyMessageStore.recoverNextMessages(ProxyMessageStore.java:83)&lt;br/&gt;
        at org.apache.activemq.broker.region.cursors.QueueStorePrefetch.doFillBatch(QueueStorePrefetch.java:92)&lt;br/&gt;
        at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:236)&lt;br/&gt;
        at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.hasNext(AbstractStoreCursor.java:136)&lt;br/&gt;
        at org.apache.activemq.broker.region.cursors.StoreQueueCursor.hasNext(StoreQueueCursor.java:131)&lt;br/&gt;
        at org.apache.activemq.broker.region.Queue.doPageIn(Queue.java:1180)&lt;br/&gt;
        at org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1308)&lt;br/&gt;
        at org.apache.activemq.broker.region.Queue.iterate(Queue.java:1008)&lt;br/&gt;
        at org.apache.activemq.thread.DeterministicTaskRunner.runTask(DeterministicTaskRunner.java:84)&lt;br/&gt;
        at org.apache.activemq.thread.DeterministicTaskRunner$1.run(DeterministicTaskRunner.java:41)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:885)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
ERROR AbstractStoreCursor            - Failed to fill batch for more see atached log - kaha_amq.log&lt;/p&gt;

&lt;p&gt;For this tests it was necessary to adjust memory usage and limit settings - view attached activemq.xml.&lt;br/&gt;
Tested on SUSE Linux Enterprise Server 10.&lt;/p&gt;</comment>
                            <comment id="12940844" author="durokuruc" created="Wed, 25 Feb 2009 12:55:42 +0000"  >&lt;p&gt;config file used to test rev. number 729038&lt;/p&gt;</comment>
                            <comment id="12940821" author="gtully" created="Wed, 25 Feb 2009 23:24:13 +0000"  >&lt;p&gt;the fix for &lt;a href=&quot;http://issues.apache.org/activemq/browse/AMQ-2123&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://issues.apache.org/activemq/browse/AMQ-2123&lt;/a&gt; will help with the &quot;could not be recovered from the data store - already dispatched&quot; issue. This should also help with store management as it ensures that references are correctly cleaned up.&lt;/p&gt;</comment>
                            <comment id="12940869" author="durokuruc" created="Fri, 27 Feb 2009 13:25:25 +0000"  >&lt;p&gt;I&apos;ve tested amq revision number 747951. Cleaning storage using amqPersistenceAdapter is better now, but there are still files that, in my opinion, need to be deleted  - in data/journal/ directory after receiving sotps there are still files data-47 and data-87 and no other number between (I guess that in optimal state should be file numbering continous).&lt;br/&gt;
There is also problem that from 100k msgs sent message  have been only 97208 acknowledged (it should be 100k on both receivers, while every odd message is ack) and  &quot;already dispatched&quot; error is still there.&lt;/p&gt;

&lt;p&gt;with kahaPersistenceAdapter is behaviour very similar as before.&lt;/p&gt;</comment>
                            <comment id="12941029" author="yinghe0101" created="Fri, 20 Mar 2009 21:07:06 +0000"  >&lt;p&gt;test latest trunk 756591&lt;/p&gt;

&lt;p&gt;in network of broker setup( 4 pair master/slave), if I kill TopicConsumers during processing messages and restart it, i will see &quot;Message id ... could not be recovered from the data store - already dispatched&quot;&lt;/p&gt;

&lt;p&gt;i also see &quot;ERROR MasterBroker                   - Slave Failed&lt;br/&gt;
javax.jms.JMSException: Unmatched acknowledege: MessageAck &lt;/p&gt;
{commandId = 62608, responseRequired = true, ackType = 2, consumerId = ID:host-2343-1237580790173-0:1:1:1, firstMessageId = ID:host-2341-1237580773986-0:0:1:1:1341, lastMessageId = ID:host-2341-1237580773986-0:0:1:1:1341, destination = topic://testTopic, transactionId = null, messageCount = 1}
&lt;p&gt;; Could not find Message-ID ID:host-2341-1237580773986-0:0:1:1:1341 in dispatched-list (start of ack)&quot;&lt;/p&gt;

&lt;p&gt;one pair of master/slave, the results are much better. topic consumer seems to recover and continue processing &lt;/p&gt;</comment>
                            <comment id="12941664" author="dejanb" created="Wed, 1 Jul 2009 11:06:08 +0000"  >&lt;p&gt;Some of the commits for the &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2303&quot; title=&quot;Durable consumers recovery &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2303&quot;&gt;&lt;del&gt;AMQ-2303&lt;/del&gt;&lt;/a&gt; seems to fixed this one as well (at least as far as I can test it). Please reopen if doesn&apos;t work with svn revision 790113&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461054" name="ASF.LICENSE.NOT.GRANTED--TopicConsumers.java" size="3172" author="durokuruc" created="Thu, 12 Jun 2008 17:52:12 +0000"/>
                            <attachment id="12460986" name="ASF.LICENSE.NOT.GRANTED--TopicProducer.java" size="4030" author="durokuruc" created="Thu, 12 Jun 2008 17:52:12 +0000"/>
                            <attachment id="12461119" name="ASF.LICENSE.NOT.GRANTED--textMessageFile.txt" size="8846" author="durokuruc" created="Thu, 12 Jun 2008 17:52:12 +0000"/>
                            <attachment id="12461192" name="Storage_cleanup_Redelivery_test.zip" size="9150" author="durokuruc" created="Wed, 5 Nov 2008 16:54:12 +0000"/>
                            <attachment id="12461319" name="activemq.xml" size="4628" author="durokuruc" created="Wed, 25 Feb 2009 12:55:42 +0000"/>
                            <attachment id="12461355" name="kaha_amq.zip" size="9459" author="durokuruc" created="Wed, 25 Feb 2009 12:53:01 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12481900">AMQ-2123</subtask>
                            <subtask id="12482921">AMQ-2303</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84766</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 21 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s2av:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161849</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>