<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:02:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4889] ProxyConnector memory usage skyrockets when several ssl handshakes fails</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4889</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;See &lt;a href=&quot;http://activemq.2283324.n4.nabble.com/Proxy-Connector-memory-consumption-td4674255.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;nabble&lt;/a&gt; for further details.&lt;/p&gt;

&lt;p&gt;To reproduce the issue:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Start embedded proxy broker and the AMQ broker that are embedded in &lt;b&gt;AMQTestBroker&lt;/b&gt; project (see attachments);&lt;/li&gt;
	&lt;li&gt;Start the &lt;b&gt;AMQTestConsumer&lt;/b&gt; project; This program repeatedly tries opening a connection to the ProxyConnector with wrong certificates.&lt;/li&gt;
	&lt;li&gt;Open jconsole to monitor AMQTestBroker memory usage: you should experience an OOM error within one hour with the suggested settings (Xmx = 2048m).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Launch configurations and test keystores are attached to this issue along with the java projects.&lt;/p&gt;

&lt;p&gt;This behavior seems to affect &lt;em&gt;ProxyConnector&lt;/em&gt; only, running the test against a standard nio-based &lt;em&gt;TransportConnector&lt;/em&gt; does not seem to produce anomalous memory consumptions.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Seen in Windows 7 64bit, Windows Server 2008 R2 and Linux RHEL 6.3 64 bit&lt;/p&gt;</environment>
        <key id="12679366">AMQ-4889</key>
            <summary>ProxyConnector memory usage skyrockets when several ssl handshakes fails</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="matteor">matteo rulli</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Nov 2013 09:41:29 +0000</created>
                <updated>Wed, 2 Apr 2014 22:16:09 +0000</updated>
                            <resolved>Mon, 16 Dec 2013 17:14:48 +0000</resolved>
                                    <version>5.8.0</version>
                    <version>5.9.0</version>
                                    <fixVersion>5.9.1</fixVersion>
                    <fixVersion>5.10.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13835229" author="matteor" created="Fri, 29 Nov 2013 07:35:25 +0000"  >&lt;p&gt;I attached a possible patch. As long as I can see, the problem was adding ProxyConnection objs into a collection inside ProxyConnector before starting them.&lt;/p&gt;

&lt;p&gt;Maybe an amq guru can check this and gives some feedbacks?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13835322" author="matteor" created="Fri, 29 Nov 2013 11:31:32 +0000"  >&lt;p&gt;Actually the problem in ProxyConnector hid something more than a simple problem ProxyConnector.java file. &lt;/p&gt;

&lt;p&gt;Apparently some clean-up invocations were missing in SSLNIOTransport as well. This resulted in many leaked file descriptors in linux (RHEL 6.3 64 bit). &lt;/p&gt;

&lt;p&gt;Before the attached patches the lsof command gave tons of&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java    6530 platone    8u  sock                0,6      0t0 2489682586 can&apos;t identify protocol
java    6530 platone    9u  sock                0,6      0t0 2489745273 can&apos;t identify protocol
java    6530 platone   15u  sock                0,6      0t0 2489727545 can&apos;t identify protocol
java    6530 platone   66u  sock                0,6      0t0 2489683982 can&apos;t identify protocol
java    6530 platone   69u  sock                0,6      0t0 2489684335 can&apos;t identify protocol
java    6530 platone   72u  sock                0,6      0t0 2489684339 can&apos;t identify protocol
java    6530 platone   74u  sock                0,6      0t0 2489684688 can&apos;t identify protocol
java    6530 platone   76u  sock                0,6      0t0 2489685055 can&apos;t identify protocol
java    6530 platone   77u  sock                0,6      0t0 2489716539 can&apos;t identify protocol
java    6530 platone   97u  sock                0,6      0t0 2489683431 can&apos;t identify protocol
java    6530 platone   98u  sock                0,6      0t0 2489683450 can&apos;t identify protocol
java    6530 platone   99u  sock                0,6      0t0 2489684695 can&apos;t identify protocol
java    6530 platone  100u  sock                0,6      0t0 2489683990 can&apos;t identify protocol
java    6530 platone  101u  sock                0,6      0t0 2489702245 can&apos;t identify protocol
java    6530 platone  102u  sock                0,6      0t0 2489685058 can&apos;t identify protocol
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;(see attached lsof.txt) with the following socket stats:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;sockets: used 3067
TCP: inuse 21 orphan 0 tw 0 alloc 2808 mem 2648
UDP: inuse 6 mem 5
UDPLITE: inuse 0
RAW: inuse 1
FRAG: inuse 0 memory 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and the following netstat outcome:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;...
tcp        0      0 ::ffff:192.168.24.82:44201  ::ffff:192.168.16.166:61616 ESTABLISHED 6530/java           off (0.00/0/0)
tcp        0      0 ::ffff:192.168.24.82:61619  ::ffff:192.168.24.66:64601  CLOSE_WAIT  6530/java           off (0.00/0/0)
tcp        0      0 ::ffff:192.168.24.82:61619  ::ffff:192.168.24.67:9033   CLOSE_WAIT  6530/java           off (0.00/0/0)
tcp        0      0 ::ffff:192.168.24.82:61619  ::ffff:192.168.24.66:56924  CLOSE_WAIT  6530/java           off (0.00/0/0)
tcp        0      0 ::ffff:192.168.24.82:61619  ::ffff:192.168.24.66:33021  CLOSE_WAIT  6530/java           off (0.00/0/0)
tcp        0      0 ::ffff:192.168.24.82:61619  ::ffff:192.168.24.67:56879  CLOSE_WAIT  6530/java           off (0.00/0/0)
tcp        0      0 ::ffff:192.168.24.82:61619  ::ffff:192.168.24.67:51487  CLOSE_WAIT  6530/java           off (0.00/0/0)
tcp        0      0 ::ffff:192.168.24.82:61619  ::ffff:192.168.24.66:35295  CLOSE_WAIT  6530/java           off (0.00/0/0)
tcp        0      0 ::ffff:192.168.24.82:61619  ::ffff:192.168.24.67:49529  CLOSE_WAIT  6530/java           off (0.00/0/0)
tcp        0      0 ::ffff:192.168.24.82:61619  ::ffff:192.168.24.67:51309  CLOSE_WAIT  6530/java           off (0.00/0/0)
... many other CLOSE_WAIT
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We applied the attached patches and everything run better: the lsof stopped reporting the &lt;em&gt;can&apos;t identify protocol&lt;/em&gt; records and the number of connections in CLOSE_WAIT dropped to zero.&lt;/p&gt;

&lt;p&gt;So what? Does it make sense to you?&lt;/p&gt;</comment>
                            <comment id="13836369" author="matteor" created="Mon, 2 Dec 2013 08:39:29 +0000"  >&lt;p&gt;Still an issue in long-term memory consumption due to another bug in ProxyConnector: missing equals and hashCode methods in ProxyConnections induced a memory leakeage in connections collection inside ProxyConnector.&lt;/p&gt;

&lt;p&gt;I added another patch to solve also this issue.&lt;/p&gt;</comment>
                            <comment id="13839036" author="tabish121" created="Wed, 4 Dec 2013 16:12:50 +0000"  >&lt;p&gt;I&apos;ve reviewed the attached patches, looks pretty good.  I applied the fix to the NIOSSLTransport.  The equals method in the ProxyConnection looks a bit odd, think maybe the equals comparison might be backwards.  I updated the fix a bit with some additional changes.  You should take a look and test in your setup.  Would be great if you can boil down the tests into a JUnit test of sorts so we can see if things are working as expected.  &lt;/p&gt;</comment>
                            <comment id="13839037" author="tabish121" created="Wed, 4 Dec 2013 16:13:43 +0000"  >&lt;p&gt;Proposed patch for this issue that addresses the cleanup code in the Proxy classes.&lt;/p&gt;</comment>
                            <comment id="13839065" author="matteor" created="Wed, 4 Dec 2013 16:49:43 +0000"  >&lt;p&gt;Actually, swapping the start method and the connections.add() in setAcceptListener method in ProxyConnector turned out not to be a good idea. The &lt;em&gt;connections.remove()&lt;/em&gt; in TransportFilter.stop may be called before the connections.add() is invoked.&lt;br/&gt;
I appreciate this in the form of a tiny yet continous memory leakeage due to objects accumulating in connections collection.&lt;/p&gt;

&lt;p&gt;Therefore I modified again the ProxyConnector code to fix also this sort of race condition: now I invoke the connections.add() &lt;em&gt;before&lt;/em&gt; invoking the start but I manage the removal inside a try-catch block (see the updated ProxyConnector_patch_AMQ_4889.txt patch)&lt;/p&gt;

&lt;p&gt;Besides, I had to modify the equals method in ProxyConnection to avoid NPE in case local or remote transorts are null. I updated the ProxyConnection_patch_AMQ_4889.txt file with this fix.&lt;br/&gt;
I&apos;m not completely satisfied with this ProxyConnection.equals() method, since it seems a little bit awkward to me. I don&apos;t know, maybe you can suggest a better strategy to purge the connections list.&lt;/p&gt;

&lt;p&gt;The patch is running for hours now and the issue seems to be fixed. I&apos;ll double check ram consumption tomorrow to have a stronger feedback.&lt;/p&gt;</comment>
                            <comment id="13843367" author="matteor" created="Mon, 9 Dec 2013 18:08:11 +0000"  >&lt;p&gt;With the last checks and updates the ProxyConnector has been working great for days now: heap memory consumption is stable. I&apos;ll try to improve/simplify the test case in ProxyConnIssue.rar in the next days.&lt;/p&gt;

&lt;p&gt;It would be great if I could have some feedbacks on the last patches I created.&lt;/p&gt;</comment>
                            <comment id="13849349" author="kearls" created="Mon, 16 Dec 2013 17:14:48 +0000"  >&lt;p&gt;Fixed with checkin 257710ba1a40e0ac78f5f8035d9663775e122d41.  Thanks for the patches.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12617002" name="AMQ4889.patch" size="8088" author="tabish" created="Wed, 4 Dec 2013 16:13:43 +0000"/>
                            <attachment id="12616363" name="NIOSSLTransport_patch_AMQ_4889.txt" size="1098" author="matteor" created="Fri, 29 Nov 2013 11:33:21 +0000"/>
                            <attachment id="12614047" name="ProxyConnIssue.rar" size="19156" author="matteor" created="Fri, 15 Nov 2013 09:42:16 +0000"/>
                            <attachment id="12617007" name="ProxyConnection_patch_AMQ_4889.txt" size="1949" author="matteor" created="Wed, 4 Dec 2013 16:37:10 +0000"/>
                            <attachment id="12617008" name="ProxyConnector_patch_AMQ_4889.txt" size="3482" author="matteor" created="Wed, 4 Dec 2013 16:37:10 +0000"/>
                            <attachment id="12616367" name="after_lsof.txt" size="24818" author="matteor" created="Fri, 29 Nov 2013 11:33:21 +0000"/>
                            <attachment id="12616368" name="after_netstat.txt" size="2296" author="matteor" created="Fri, 29 Nov 2013 11:33:21 +0000"/>
                            <attachment id="12616364" name="lsof.txt" size="276050" author="matteor" created="Fri, 29 Nov 2013 11:33:21 +0000"/>
                            <attachment id="12616365" name="netstat.txt" size="17056" author="matteor" created="Fri, 29 Nov 2013 11:33:21 +0000"/>
                            <attachment id="12616366" name="sockstat.txt" size="139" author="matteor" created="Fri, 29 Nov 2013 11:33:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>358728</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 49 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1pu8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>359018</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>