<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:42:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2322] ClassCastException having relation to recovery of expired messages and vmQueueCursor pendingQueuePolicy</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2322</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;from: &lt;a href=&quot;http://www.nabble.com/ClassCastException-having-relation-to-expired-messages-tp24287023p24287023.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.nabble.com/ClassCastException-having-relation-to-expired-messages-tp24287023p24287023.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;While testing ActiveMQ5.2.0, I have a question about expired message.&lt;/p&gt;

&lt;p&gt;Note that testing messages are Persistent and using a queue, set message&lt;br/&gt;
expiration time to 10 seconds. configurations are same except destination&lt;br/&gt;
policy(using a vm queue cursor) as below&lt;br/&gt;
&amp;lt;destinationPolicy&amp;gt;&lt;br/&gt;
       &amp;lt;policyMap&amp;gt;&lt;br/&gt;
               &amp;lt;policyEntries&amp;gt;&lt;br/&gt;
                       &amp;lt;policyEntry queue=&quot;&amp;gt;&quot; memoryLimit=&quot;5mb&quot;&amp;gt;&lt;br/&gt;
                               &amp;lt;dispatchPolicy&amp;gt;&lt;br/&gt;
                                       &amp;lt;strictOrderDispatchPolicy /&amp;gt;&lt;br/&gt;
                               &amp;lt;/dispatchPolicy&amp;gt;&lt;br/&gt;
                               &amp;lt;deadLetterStrategy&amp;gt;&lt;br/&gt;
                                       &amp;lt;individualDeadLetterStrategy queuePrefix=&quot;DLQ.&quot;/&amp;gt;&lt;br/&gt;
                               &amp;lt;/deadLetterStrategy&amp;gt;&lt;br/&gt;
                               &amp;lt;pendingQueuePolicy&amp;gt;&lt;br/&gt;
                                       &amp;lt;vmQueueCursor /&amp;gt;&lt;br/&gt;
                               &amp;lt;/pendingQueuePolicy&amp;gt;&lt;br/&gt;
                       &amp;lt;/policyEntry&amp;gt;&lt;br/&gt;
               &amp;lt;/policyEntries&amp;gt;&lt;br/&gt;
       &amp;lt;/policyMap&amp;gt;&lt;br/&gt;
&amp;lt;/destinationPolicy&amp;gt;&lt;br/&gt;
Additionally, it turns out that the activemq broker actually does not&lt;br/&gt;
proactively purge expired messages from queues. so we set&lt;br/&gt;
a thread that periodically cleared my queues of expired messages by help of&lt;br/&gt;
this forum&apos;s advisor.&lt;br/&gt;
We suppose that a server is stopped unexpectedly when expired message leaves&lt;br/&gt;
on queue without disposed by the thread&lt;br/&gt;
After recovering a server, we will expect that remained messages including&lt;br/&gt;
both normal and expired message are loaded normally&lt;br/&gt;
However server stopped abnormally and some error occured while starting&lt;br/&gt;
ActiveMQ. Errors are like that&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2009-07-01 17:13:45,125 [main           ] INFO  BrokerService
- For help or more information please see: http:&lt;span class=&quot;code-comment&quot;&gt;//activemq.apache.org/
&lt;/span&gt;2009-07-01 17:13:45,421 [main           ] INFO  KahaStore
- Kaha Store using data directory
D:\apache\apache-activemq-5.2.0\binary\bin\..\data\kr-store\data
2009-07-01 17:13:45,796 [main           ] ERROR BrokerService
- Failed to start ActiveMQ JMS Message Broker. Reason:
java.lang.ClassCastException:
org.apache.activemq.command.ActiveMQObjectMessage
java.lang.ClassCastException:
org.apache.activemq.command.ActiveMQObjectMessage
       at org.apache.activemq.broker.region.Queue.messageExpired(Queue.java:1114)
       at org.apache.activemq.broker.region.Queue.messageExpired(Queue.java:1106)
       at org.apache.activemq.broker.region.Queue$5.recoverMessage(Queue.java:173)
       at
org.apache.activemq.store.amq.RecoveryListenerAdapter.recoverMessage(RecoveryListenerAdapter.java:45)
       at
org.apache.activemq.store.amq.RecoveryListenerAdapter.recoverMessageReference(RecoveryListenerAdapter.java:56)
       at
org.apache.activemq.store.kahadaptor.KahaReferenceStore.recoverReference(KahaReferenceStore.java:82)
       at
org.apache.activemq.store.kahadaptor.KahaReferenceStore.recover(KahaReferenceStore.java:93)
       at
org.apache.activemq.store.amq.AMQMessageStore.recover(AMQMessageStore.java:481)
       at org.apache.activemq.broker.region.Queue.initialize(Queue.java:167)
       at
org.apache.activemq.broker.region.DestinationFactoryImpl.createDestination(DestinationFactoryImpl.java:83)
       at
org.apache.activemq.broker.region.AbstractRegion.createDestination(AbstractRegion.java:434)
       at
org.apache.activemq.broker.jmx.ManagedQueueRegion.createDestination(ManagedQueueRegion.java:56)
       at
org.apache.activemq.broker.region.AbstractRegion.addDestination(AbstractRegion.java:120)
       at
org.apache.activemq.broker.region.RegionBroker.addDestination(RegionBroker.java:261)
       at
org.apache.activemq.broker.BrokerFilter.addDestination(BrokerFilter.java:142)
       at
org.apache.activemq.broker.BrokerFilter.addDestination(BrokerFilter.java:142)
       at
org.apache.activemq.advisory.AdvisoryBroker.addDestination(AdvisoryBroker.java:147)
       at
org.apache.activemq.broker.BrokerFilter.addDestination(BrokerFilter.java:142)
       at
org.apache.activemq.broker.MutableBrokerFilter.addDestination(MutableBrokerFilter.java:149)
       at
org.apache.activemq.broker.region.AbstractRegion.start(AbstractRegion.java:94)
       at
org.apache.activemq.broker.region.RegionBroker.start(RegionBroker.java:176)
       at
org.apache.activemq.broker.jmx.ManagedRegionBroker.start(ManagedRegionBroker.java:103)
       at
org.apache.activemq.broker.TransactionBroker.start(TransactionBroker.java:112)
       at org.apache.activemq.broker.BrokerFilter.start(BrokerFilter.java:154)
       at org.apache.activemq.broker.BrokerFilter.start(BrokerFilter.java:154)
       at
org.apache.activemq.broker.MutableBrokerFilter.start(MutableBrokerFilter.java:161)
       at org.apache.activemq.broker.BrokerService.start(BrokerService.java:468)
       at
org.apache.activemq.xbean.XBeanBrokerService.afterPropertiesSet(XBeanBrokerService.java:52)
       at
org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1368)
       at
org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1334)
       at
org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:473)
       at
org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory$1.run(AbstractAutowireCapableBeanFactory.java:409)
       at java.security.AccessController.doPrivileged(Native Method)
       at
org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:380)
       at
org.springframework.beans.factory.support.AbstractBeanFactory$1.getObject(AbstractBeanFactory.java:264)
       at
org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:221)
       at
org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:261)
       at
org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:185)
       at
org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:164)
       at
org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:429)
       at
org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:729)
       at
org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:381)
       at
org.apache.xbean.spring.context.ResourceXmlApplicationContext.&amp;lt;init&amp;gt;(ResourceXmlApplicationContext.java:64)
       at
org.apache.xbean.spring.context.ResourceXmlApplicationContext.&amp;lt;init&amp;gt;(ResourceXmlApplicationContext.java:52)
       at
org.apache.activemq.xbean.XBeanBrokerFactory.createApplicationContext(XBeanBrokerFactory.java:96)
       at
org.apache.activemq.xbean.XBeanBrokerFactory.createBroker(XBeanBrokerFactory.java:52)
       at
org.apache.activemq.broker.BrokerFactory.createBroker(BrokerFactory.java:71)
       at
org.apache.activemq.broker.BrokerFactory.createBroker(BrokerFactory.java:54)
       at
org.apache.activemq.console.command.StartCommand.startBroker(StartCommand.java:115)
       at
org.apache.activemq.console.command.StartCommand.runTask(StartCommand.java:74)
       at
org.apache.activemq.console.command.AbstractCommand.execute(AbstractCommand.java:57)
       at
org.apache.activemq.console.command.ShellCommand.runTask(ShellCommand.java:129)
       at
org.apache.activemq.console.command.AbstractCommand.execute(AbstractCommand.java:57)
       at
org.apache.activemq.console.command.ShellCommand.main(ShellCommand.java:79)
       at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
       at
sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
       at
sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
       at java.lang.reflect.Method.invoke(Method.java:585)
       at org.apache.activemq.console.Main.runTaskClass(Main.java:225)
       at org.apache.activemq.console.Main.main(Main.java:106)
2009-07-01 17:13:45,812 [main           ] INFO  BrokerService
- ActiveMQ Message Broker (localhost, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) is shutting down
2009-07-01 17:13:45,828 [main           ] INFO  NetworkConnector
- Network Connector &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-nc Stopped
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment>&lt;p&gt;all&lt;/p&gt;</environment>
        <key id="12483032">AMQ-2322</key>
            <summary>ClassCastException having relation to recovery of expired messages and vmQueueCursor pendingQueuePolicy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="gtully">Gary Tully</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Jul 2009 16:23:34 +0000</created>
                <updated>Thu, 9 Jul 2009 16:27:51 +0000</updated>
                            <resolved>Thu, 9 Jul 2009 16:27:51 +0000</resolved>
                                    <version>5.2.0</version>
                                    <fixVersion>5.3.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12941736" author="gtully" created="Thu, 9 Jul 2009 16:27:51 +0000"  >&lt;p&gt;resolved in r792598&lt;/p&gt;

&lt;p&gt;expired messages are now recovered and expired correctly&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>74983</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 20 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14ckv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>233501</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>