<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:53:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3819] high cpu with stomp+nio+ssl and many subscriptions</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3819</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Switching an existing workload from a transport:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&amp;lt;transportConnector name=&quot;verified_stompssl&quot;  uri=&quot;stomp+ssl://0.0.0.0:6165?needClientAuth=true&quot;/&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;to&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&amp;lt;transportConnector name=&quot;verified_stompssl&quot;  uri=&quot;stomp+nio+ssl://0.0.0.0:6165?needClientAuth=true&quot;/&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;showed the CPU profile to go from 1-5% to 300% constantly on a 8 core server&lt;/p&gt;

&lt;p&gt;I was able to recreate this using a ruby client @ &lt;a href=&quot;http://devco.net/rip/amq_560_stomp_nio_ssl_tester.rb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://devco.net/rip/amq_560_stomp_nio_ssl_tester.rb&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The important combinations are:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I am connecting to a stomp+nio+ssl port&lt;/li&gt;
	&lt;li&gt;I am creating the subscriptions to the 10 queus and topics&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If I change either of these variables - like just commenting out the loop that does those subscriptions - then the CPU load is acceptable.&lt;/p&gt;

&lt;p&gt;I analysed the running VM with VisualVM and found that transport.nio.NIOSSLTransport.serviceRead() is the busy thread.  &lt;/p&gt;


&lt;p&gt;My activemq.xml is:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;beans
  xmlns=&quot;http://www.springframework.org/schema/beans&quot;
  xmlns:amq=&quot;http://activemq.apache.org/schema/core&quot;
  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
  xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
  http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd
  http://activemq.apache.org/camel/schema/spring http://activemq.apache.org/camel/schema/spring/camel-spring.xsd&quot;&amp;gt;
    &amp;lt;broker xmlns=&quot;http://activemq.apache.org/schema/core&quot; brokerName=&quot;amq1&quot; useJmx=&quot;true&quot; persistent=&quot;true&quot; schedulePeriodForDestinationPurge=&quot;60000&quot;&amp;gt;
        &amp;lt;destinationPolicy&amp;gt;
          &amp;lt;policyMap&amp;gt;
            &amp;lt;policyEntries&amp;gt;
              &amp;lt;policyEntry topic=&quot;&amp;gt;&quot; producerFlowControl=&quot;false&quot;/&amp;gt;
              &amp;lt;policyEntry queue=&quot;*.reply.&amp;gt;&quot; gcInactiveDestinations=&quot;true&quot; inactiveTimoutBeforeGC=&quot;120000&quot; /&amp;gt;
            &amp;lt;/policyEntries&amp;gt;
          &amp;lt;/policyMap&amp;gt;
        &amp;lt;/destinationPolicy&amp;gt;

        &amp;lt;managementContext&amp;gt;
          &amp;lt;managementContext connectorPort=&quot;1099&quot; jmxDomainName=&quot;org.apache.activemq&quot;/&amp;gt;
        &amp;lt;/managementContext&amp;gt;

        &amp;lt;plugins&amp;gt;
          &amp;lt;statisticsBrokerPlugin/&amp;gt;
          &amp;lt;simpleAuthenticationPlugin&amp;gt;
            &amp;lt;users&amp;gt;
              &amp;lt;authenticationUser username=&quot;test&quot; password=&quot;test&quot; groups=&quot;admins,everyone&quot;/&amp;gt;
            &amp;lt;/users&amp;gt;
          &amp;lt;/simpleAuthenticationPlugin&amp;gt;
          &amp;lt;authorizationPlugin&amp;gt;
            &amp;lt;map&amp;gt;
              &amp;lt;authorizationMap&amp;gt;
                &amp;lt;authorizationEntries&amp;gt;
                  &amp;lt;authorizationEntry queue=&quot;&amp;gt;&quot; write=&quot;admins&quot; read=&quot;admins&quot; admin=&quot;admins&quot; /&amp;gt;
                  &amp;lt;authorizationEntry topic=&quot;&amp;gt;&quot; write=&quot;admins&quot; read=&quot;admins&quot; admin=&quot;admins&quot; /&amp;gt;
                &amp;lt;/authorizationEntries&amp;gt;
              &amp;lt;/authorizationMap&amp;gt;
            &amp;lt;/map&amp;gt;
          &amp;lt;/authorizationPlugin&amp;gt;
        &amp;lt;/plugins&amp;gt;

        &amp;lt;sslContext&amp;gt;
           &amp;lt;sslContext
                keyStore=&quot;keystore.jks&quot; keyStorePassword=&quot;ohshahCu&quot;
                trustStore=&quot;truststore.jks&quot; trustStorePassword=&quot;ohshahCu&quot;
           /&amp;gt;
        &amp;lt;/sslContext&amp;gt;

        &amp;lt;systemUsage&amp;gt;
          &amp;lt;systemUsage&amp;gt;
            &amp;lt;memoryUsage&amp;gt;
              &amp;lt;memoryUsage limit=&quot;200 mb&quot; /&amp;gt;
            &amp;lt;/memoryUsage&amp;gt;
            &amp;lt;storeUsage&amp;gt;
              &amp;lt;storeUsage limit=&quot;1 gb&quot; /&amp;gt;
            &amp;lt;/storeUsage&amp;gt;
            &amp;lt;tempUsage&amp;gt;
              &amp;lt;tempUsage limit=&quot;1 gb&quot; /&amp;gt;
            &amp;lt;/tempUsage&amp;gt;
          &amp;lt;/systemUsage&amp;gt;
        &amp;lt;/systemUsage&amp;gt;

        &amp;lt;transportConnectors&amp;gt;
          &amp;lt;transportConnector name=&quot;openwire&quot;  uri=&quot;tcp://0.0.0.0:6166&quot;/&amp;gt;
          &amp;lt;transportConnector name=&quot;stomp+nio&quot; uri=&quot;stomp+nio://0.0.0.0:6163&quot;/&amp;gt;
          &amp;lt;transportConnector name=&quot;stompssl&quot;  uri=&quot;stomp+ssl://0.0.0.0:6164&quot;/&amp;gt;
          &amp;lt;transportConnector name=&quot;verified_stompssl&quot;  uri=&quot;stomp+nio+ssl://0.0.0.0:6165?needClientAuth=true&quot;/&amp;gt;
        &amp;lt;/transportConnectors&amp;gt;
    &amp;lt;/broker&amp;gt;

    &amp;lt;import resource=&quot;jetty.xml&quot;/&amp;gt;
&amp;lt;/beans&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;CentOS 6, RC of 5.6.0&lt;/p&gt;

&lt;p&gt;java version &quot;1.6.0_22&quot;&lt;br/&gt;
OpenJDK Runtime Environment (IcedTea6 1.10.6) (rhel-1.43.1.10.6.el6_2-x86_64)&lt;br/&gt;
OpenJDK 64-Bit Server VM (build 20.0-b11, mixed mode)&lt;/p&gt;</environment>
        <key id="12552652">AMQ-3819</key>
            <summary>high cpu with stomp+nio+ssl and many subscriptions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="ripienaar">R.I.Pienaar</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Apr 2012 13:53:45 +0000</created>
                <updated>Tue, 1 May 2012 13:29:37 +0000</updated>
                            <resolved>Tue, 1 May 2012 13:29:37 +0000</resolved>
                                    <version>5.6.0</version>
                                    <fixVersion>5.6.0</fixVersion>
                                    <component>STOMP</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13263226" author="tabish121" created="Thu, 26 Apr 2012 23:02:35 +0000"  >&lt;p&gt;Created a Java version of the test to get the ball rolling.  Didn&apos;t completely match the configuration but did notice that if you crank up the number of messages the test sends the test will fail for NIO+SSL and the CPU will be running wild.  Didn&apos;t have time to look deeper today.&lt;/p&gt;</comment>
                            <comment id="13263757" author="tabish121" created="Fri, 27 Apr 2012 16:02:28 +0000"  >&lt;p&gt;Commit test cases on trunk for this scenario, one for each (TCP, SSL, NIO, NIO+SSL).  Only the NIO+SSL version has an issue. &lt;/p&gt;</comment>
                            <comment id="13264038" author="tabish121" created="Fri, 27 Apr 2012 22:22:03 +0000"  >&lt;p&gt;The test case seems to indicate that its an issue with the send rate on the connection.  If you slow down the outbound send loop at the end of the test the NIO+SSL test will start passing.  It may be an issue of not properly handling underflow situations in the secureRead method.  When things go wrong it seems like we get into a state of underflow but never try reading from the ssl channel again. &lt;/p&gt;</comment>
                            <comment id="13264985" author="dejanb" created="Mon, 30 Apr 2012 15:38:18 +0000"  >&lt;p&gt;I created a fix in svn revision 1332230 and created a new snapshot&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.7-SNAPSHOT/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.7-SNAPSHOT/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It fixes the problem that transport get stuck in serviceRead() method and from my local test it looks pretty much the same as plain stomp+ssl implementation. Can you take it for a spin and let us know if it improves your use case.&lt;/p&gt;</comment>
                            <comment id="13264993" author="tabish121" created="Mon, 30 Apr 2012 15:55:05 +0000"  >&lt;p&gt;Tested here with the fix Dejan posted and the NIO+SSL test works as expected now on my machine.  Would be good confirmation to see if that ruby client test is working now. &lt;/p&gt;</comment>
                            <comment id="13264996" author="ripienaar" created="Mon, 30 Apr 2012 15:56:59 +0000"  >&lt;p&gt;Thanks guys, I&apos;ll test &apos;morrow UK time.&lt;/p&gt;</comment>
                            <comment id="13265744" author="ripienaar" created="Tue, 1 May 2012 11:11:38 +0000"  >&lt;p&gt;Well done, this has resolved the problem for me.  Tested both with my simple test script and real world workload that first brought up the problem.&lt;/p&gt;</comment>
                            <comment id="13265796" author="tabish121" created="Tue, 1 May 2012 13:29:37 +0000"  >&lt;p&gt;Testing shows Dejan&apos;s fix resolves the issue.  &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12524779" name="StompLoadTest.java" size="7881" author="tabish" created="Thu, 26 Apr 2012 23:02:34 +0000"/>
                            <attachment id="12524780" name="StompNIOSSLLoadTest.java" size="2149" author="tabish" created="Thu, 26 Apr 2012 23:02:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>237002</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 30 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ahw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59172</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>