<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:34:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6240] Producer cannot be terminated when slow consumer is detected</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6240</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;There is a discussion relating to the bug here - &lt;a href=&quot;http://activemq.2283324.n4.nabble.com/Force-Producer-to-fail-when-blocked-by-slow-consumer-td4710264.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.2283324.n4.nabble.com/Force-Producer-to-fail-when-blocked-by-slow-consumer-td4710264.html&lt;/a&gt;. Test code to reproduce the problem  has also been uploaded to this discussion.&lt;/p&gt;

&lt;p&gt;We have  a situation where we have a producer which is feeding a slow consumer.&lt;br/&gt;
The consumer belongs to a third party so we do not have control over the broker configuration.&lt;br/&gt;
We would like to terminate our producer but we find that we cannot do so. We can set the timeout on the connection and we then trap the timeout exception. The problem is that when we try to close the session it attempts to rollback but cannot do so as the rollback blocks.&lt;/p&gt;

&lt;p&gt;We have created a small test that is included in the zip (mentioned above) of an Eclipse project.The zip includes three classes. Call the main method of RunTest to run the test. The activemq.xml used is in the root directory of the project. &lt;/p&gt;

&lt;p&gt;The program will timeout after 51 messages and attempt to close the session. &lt;/p&gt;

&lt;p&gt;It eventually locks in this line: &lt;/p&gt;

&lt;p&gt;            this.connection.syncSendPacket(info); &lt;/p&gt;

&lt;p&gt;in the rollback method of the TransactionContext class.&lt;/p&gt;

&lt;p&gt;We believe that the most sensible solution to this is that the rollback should respond to the same timeout as the connection.&lt;/p&gt;</description>
                <environment>&lt;p&gt;The test was run using an out of the box install of ActiveMQ 5.13.2 on Windows 7 Professional (64 bit). &lt;/p&gt;

&lt;p&gt;The java version used was jdk1.8.0_60&lt;/p&gt;</environment>
        <key id="12957659">AMQ-6240</key>
            <summary>Producer cannot be terminated when slow consumer is detected</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="kenhalldnb">Ken Hall</reporter>
                        <labels>
                    </labels>
                <created>Mon, 11 Apr 2016 10:00:19 +0000</created>
                <updated>Thu, 14 Apr 2016 12:46:06 +0000</updated>
                            <resolved>Thu, 14 Apr 2016 11:27:21 +0000</resolved>
                                    <version>5.13.2</version>
                                    <fixVersion>5.14.0</fixVersion>
                                    <component>Connector</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15234850" author="gtully" created="Mon, 11 Apr 2016 10:34:03 +0000"  >&lt;p&gt;it would be interesting to know what happens to the rollback command broker side, such that there is no response. Why does it block?&lt;br/&gt;
A thread dump for the broker when the client is stuck in the close/rollback would help identify&lt;/p&gt;</comment>
                            <comment id="15234898" author="kenhalldnb" created="Mon, 11 Apr 2016 11:25:41 +0000"  >&lt;p&gt;Hi Gary - thanks for the quick response. &lt;br/&gt;
Attached is a zip of the thread dump of the broker process&lt;br/&gt;
If you need any more info let me know&lt;/p&gt;</comment>
                            <comment id="15234939" author="gtully" created="Mon, 11 Apr 2016 11:56:18 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;ActiveMQ Transport: tcp:&lt;span class=&quot;code-comment&quot;&gt;///127.0.0.1:65190@61616&quot;&lt;/span&gt; #52 daemon prio=5 os_prio=0 tid=0x000000005ac6b800 nid=0x20fc waiting on condition [0x000000006035e000]
&lt;/span&gt;   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000000c050b598&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
	at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2163)
	at org.apache.activemq.usage.Usage.waitForSpace(Usage.java:103)
	at org.apache.activemq.usage.StoreUsage.waitForSpace(StoreUsage.java:92)
	at org.apache.activemq.usage.StoreUsage.waitForSpace(StoreUsage.java:87)
	at org.apache.activemq.broker.region.BaseDestination.waitForSpace(BaseDestination.java:686)
	at org.apache.activemq.broker.region.Queue.checkUsage(Queue.java:899)
	at org.apache.activemq.broker.region.Queue.doMessageSend(Queue.java:831)
	at org.apache.activemq.broker.region.Queue.send(Queue.java:731)
	at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:503)
	at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:468)
	at org.apache.activemq.broker.jmx.ManagedRegionBroker.send(ManagedRegionBroker.java:293)
	at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:153)
	at org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:96)
	at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:293)
	at org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:158)
	at org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:546)
	at org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:768)
	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:338)
	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:188)
	at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)
	at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:125)
	at org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:300)
	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)
	at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:233)
	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:215)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;the transport thread is busy waiting for space, blocked, so the next command, the rollback/close cannot be read from the socket.&lt;br/&gt;
Without broker side async blocking, via producerFlowControl or the error on no space, the default behaviour is to block the transport thread.&lt;/p&gt;

&lt;p&gt;Because the broker config cannot be changed I think there are two client options:&lt;br/&gt;
1) use async send and a small producerWindow, this will cause your client to block pending space on the broker for pending messages. However having peeked at the org.apache.activemq.ActiveMQMessageProducer#send(javax.jms.Destination, javax.jms.Message, int, int, long, org.apache.activemq.AsyncCallback) - there is no timeout limit, so an interrupted exception is all that will stop that wait. not so good.&lt;/p&gt;

&lt;p&gt;2) force a close of the connection via the underlying transport, so that the  jms connection sees a socket closure and will report an error. This should avoid the normal closure processing after you see a send timeout.&lt;br/&gt;
That is a bit of a hack, using an activemq narrow api. There are some examples of how to do it in the unit tests:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/activemq/blob/e2b4ca2c59a316be91cf391c758a10e518dd3a1f/activemq-unit-tests/src/test/java/org/apache/activemq/transport/failover/FailoverTimeoutTest.java#L210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/e2b4ca2c59a316be91cf391c758a10e518dd3a1f/activemq-unit-tests/src/test/java/org/apache/activemq/transport/failover/FailoverTimeoutTest.java#L210&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15235038" author="kenhalldnb" created="Mon, 11 Apr 2016 12:48:01 +0000"  >&lt;p&gt;Thanks Gary, I&apos;ll test that and see how I get on - I looked at using the socket but didn&apos;t know how to access it - I was also unsure of what the consequences of doing this would be.&lt;br/&gt;
Our current solution is to interrupt the thread - something like what you suggest in option 1.&lt;/p&gt;

&lt;p&gt;Do you think that the fact that there is no mechanism to time out the rollback is a bug? And if so - do you think it is likely to be fixed?&lt;/p&gt;

&lt;p&gt;I think it would be nice to be able to set a timeout on the rollback (either by inheriting the timeout from the connection or by setting it explicitly) to cover situations like this. If it was felt that inheritance was a bad idea then an explicit rollback(long timeout) call could be added.&lt;/p&gt;</comment>
                            <comment id="15235080" author="kenhalldnb" created="Mon, 11 Apr 2016 13:24:32 +0000"  >&lt;p&gt;Thanks Gary - that worked perfectly. It&apos;s an acceptable solution in our situation so I&apos;m happy to close this issue unless you want to keep it open for any reason. &lt;br/&gt;
If it makes sense to you I can raise the option to timeout a rollback as a feature request.&lt;/p&gt;</comment>
                            <comment id="15235093" author="gtully" created="Mon, 11 Apr 2016 13:32:36 +0000"  >&lt;p&gt;I am not sure. It is a bit of an anti pattern, the whole send timeout. &lt;br/&gt;
Really the connection should close, because the sync send state is unknown. In this case the transaction blocks the close so it may make sense to use rollback(timeout) in the close case, because the socket will close and the broker side transaction will rollback.&lt;/p&gt;

&lt;p&gt;Note the transaction rollback used to be async before: &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2364&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-2364&lt;/a&gt;&lt;br/&gt;
having a timeout would be similar, but I guess so long as we always close it would be ok.&lt;/p&gt;

&lt;p&gt;I see an interesting angle in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1517&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-1517&lt;/a&gt; where the broker side blocking is limited by the message time to live. That would make a deterministic failure scenario. Message expired while pending space for send.&lt;br/&gt;
That would leave the broker side active to respond to a close.&lt;br/&gt;
Do you use messageExpiry or would it be a valid alternative?&lt;/p&gt;</comment>
                            <comment id="15235420" author="kenhalldnb" created="Mon, 11 Apr 2016 16:30:53 +0000"  >&lt;p&gt;We don&apos;t use message expiry as we take a very minimal approach to our configuration. Looking at that solution I was reminded that the issue here might be time zone differences. We will have to communicate with queues on a multiplicity of customers brokers so we cannot make any assumptions or influence their configurations.&lt;/p&gt;
</comment>
                            <comment id="15235421" author="kenhalldnb" created="Mon, 11 Apr 2016 16:30:53 +0000"  >&lt;p&gt;We don&apos;t use message expiry as we take a very minimal approach to our configuration. Looking at that solution I was reminded that the issue here might be time zone differences. We will have to communicate with queues on a multiplicity of customers brokers so we cannot make any assumptions or influence their configurations.&lt;/p&gt;
</comment>
                            <comment id="15239072" author="jira-bot" created="Wed, 13 Apr 2016 11:02:35 +0000"  >&lt;p&gt;Commit 77d46dc139284141336591af649c0cc1da790cd0 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=77d46dc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=77d46dc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6240&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6240&lt;/a&gt; use sendTimout on sync rollback on close such that a blocked connection won&apos;t block a close&lt;/p&gt;</comment>
                            <comment id="15240049" author="tabish121" created="Wed, 13 Apr 2016 21:20:50 +0000"  >&lt;p&gt;The test for this fails in CI, probably just due to being timing sensitive &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/view/A-D/view/ActiveMQ/job/ActiveMQ-Java8/org.apache.activemq$activemq-unit-tests/649/testReport/junit/org.apache.activemq.bugs/AMQ6240Test/testBlockedTxProducerConnectionTimeoutConnectionCanClose/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/view/A-D/view/ActiveMQ/job/ActiveMQ-Java8/org.apache.activemq$activemq-unit-tests/649/testReport/junit/org.apache.activemq.bugs/AMQ6240Test/testBlockedTxProducerConnectionTimeoutConnectionCanClose/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15240074" author="gtully" created="Wed, 13 Apr 2016 21:40:40 +0000"  >&lt;p&gt;it sends too many big messages for slow disks. guess it could be configured down to just one message with a small enough kahadb&lt;/p&gt;</comment>
                            <comment id="15240993" author="jira-bot" created="Thu, 14 Apr 2016 11:25:32 +0000"  >&lt;p&gt;Commit 530c1a81934d0a1ca51a8778e59ee19509378d87 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=530c1a8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=530c1a8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6240&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6240&lt;/a&gt; - tidy up test and reduce duration. reuse closeTimeout on rollback during close which is the case here&lt;/p&gt;</comment>
                            <comment id="15240995" author="gtully" created="Thu, 14 Apr 2016 11:27:21 +0000"  >&lt;p&gt;thanks tim, the test was taking too long which pointed me to the closeTimeout at 15s which was in the mix.&lt;br/&gt;
Reusing that var for the rollback command timeout makes more sense also.&lt;br/&gt;
Reconfigured the test to do less work and removed the inherited variants that work better with no persistence.&lt;/p&gt;</comment>
                            <comment id="15241067" author="tabish121" created="Thu, 14 Apr 2016 12:46:06 +0000"  >&lt;p&gt;Ah nice, the close timeout does seem to make more sense looking at the patch.  &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12798011" name="brokertd.zip" size="4476" author="kenhalldnb" created="Mon, 11 Apr 2016 11:25:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 31 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vx53:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>