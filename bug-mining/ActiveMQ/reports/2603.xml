<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:12:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5368] SSL handshake stalls broker with NIO</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5368</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;using NIOSSL transport, SSL handshakes for ~5000 connections easily stall a broker taking 100% CPU&lt;/p&gt;

&lt;p&gt;I&apos;m using version ActiveMQ 5.8, but it occurs on 5.9, 5.10 versions as well&lt;/p&gt;

&lt;p&gt;doing some profiling, it showed up that the SSL handshake on broker side eats up ~90% of overall CPU time&lt;br/&gt;
by checking just the handshake status in very high frequency&lt;/p&gt;

&lt;p&gt;top 3 methods sorted by own processor time:&lt;br/&gt;
com.sun.net.ssl.internal.ssl.SSLEngineImpl.getHandshakeStatus()&lt;br/&gt;
org.apache.activemq.transport.nio.NIOSSLTransport.doHandshake()&lt;br/&gt;
com.sun.net.ssl.internal.ssl.SSLEngineImpl.getHSStatus(javax.net.ssl.SSLEngineResult$HandshakeStatus)&lt;/p&gt;

&lt;p&gt;the reason is the asynchronous nature of the SSL handshake with NIO, especially the execution of delegated tasks:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;NIOSSLTransport.doHandshake() executes delegated tasks using a TaskRunnerFactory asynchronously&lt;/li&gt;
	&lt;li&gt;in the meantime it loops calling SSLEngine.getHandshakeStatus()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;to improve the situation I did the following changes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;run delegated tasks synchronously in method doHandshake (handshake status NEED_TASK) instead of asynchronously&lt;/li&gt;
	&lt;li&gt;added some small wait cycles in method secureRead as there is not always data available with NIO (to further reduce the number of calls to SSLEngine.getHandshakeStatus)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;after these changes the SSL handshake for several thousand connections in parallel was not a problem anymore&lt;/p&gt;</description>
                <environment>&lt;p&gt;java version &quot;1.7.0_65&quot;&lt;/p&gt;</environment>
        <key id="12743962">AMQ-5368</key>
            <summary>SSL handshake stalls broker with NIO</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="oliverd">Oliver Deckert</reporter>
                        <labels>
                            <label>nio</label>
                            <label>ssl</label>
                    </labels>
                <created>Thu, 25 Sep 2014 07:45:46 +0000</created>
                <updated>Mon, 13 Jul 2015 11:38:21 +0000</updated>
                            <resolved>Thu, 9 Jul 2015 10:58:48 +0000</resolved>
                                    <version>5.8.0</version>
                    <version>5.9.0</version>
                    <version>5.10.0</version>
                                    <fixVersion>5.12.0</fixVersion>
                                    <component>Transport</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14147521" author="oliverd" created="Thu, 25 Sep 2014 07:53:48 +0000"  >&lt;p&gt;NIOSSLTransport.java with 2 modifications:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;run (first) delegated task synchronously&lt;/li&gt;
	&lt;li&gt;add some wait cycles for channel reads (to prevent too frequent reads)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;debug log statements could be removed, of course&lt;/p&gt;</comment>
                            <comment id="14614840" author="dejanb" created="Mon, 6 Jul 2015 10:28:33 +0000"  >&lt;p&gt;Hi Oliver, can you by any chance provide a test case that reproduces this problem? It would help verify the fix and protect it in the future.&lt;/p&gt;</comment>
                            <comment id="14620327" author="dejanb" created="Thu, 9 Jul 2015 10:58:48 +0000"  >&lt;p&gt;I implemented a different fix (with using a selector to wait for the socket data in case of buffer underflow). It have the same effect on the handshake performance and resource usage.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://git1-us-west.apache.org/repos/asf?p=activemq.git;a=commit;h=52e45271&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git1-us-west.apache.org/repos/asf?p=activemq.git;a=commit;h=52e45271&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There&apos;s a new &quot;test&quot; NIOSSLLoadTest.testConnectionHandshakeLoad() which could be used to monitor and profile broker behaviour in this scenario. It&apos;s ignored by default, as it will be problematic to run in CI.&lt;/p&gt;</comment>
                            <comment id="14623357" author="tabish121" created="Sat, 11 Jul 2015 11:07:26 +0000"  >&lt;p&gt;I&apos;ve noticed that since this fix went in there are intermittent test failures in the STOMP module in Jenkins around NIO tests and handshake timeouts, might be worth a look. &lt;/p&gt;</comment>
                            <comment id="14624548" author="dejanb" created="Mon, 13 Jul 2015 11:38:21 +0000"  >&lt;p&gt;Thanks Tim, I had an unrealistic selector read timeout during handshake. This fix&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://git1-us-west.apache.org/repos/asf?p=activemq.git;a=commit;h=ad8879d2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git1-us-west.apache.org/repos/asf?p=activemq.git;a=commit;h=ad8879d2&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;uses soTimeout value or blocks forever if that value is not set. This should help with the test in slow environments.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12671170" name="NIOSSLTransport.patch" size="2872" author="oliverd" created="Thu, 25 Sep 2014 07:53:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 19 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20gv3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>