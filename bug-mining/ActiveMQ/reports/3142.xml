<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:44:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6947] Queue pending message count can go negative on duplicates</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6947</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I have a found an edge case where the destination statistics counter on a Queue can go negative if there are duplicate messages (which should be rare).&#160;&#160;The issue is the statistic is decremented but should not be because the message was already dropped since there was a duplicate.&#160; Also, another statistic is improperly incremented which is the dequeue counter.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13152986">AMQ-6947</key>
            <summary>Queue pending message count can go negative on duplicates</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="4" iconUrl="https://issues.apache.org/jira/images/icons/statuses/reopened.png" description="This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.">Reopened</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="cshannon">Christopher L. Shannon</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Apr 2018 12:23:11 +0000</created>
                <updated>Wed, 18 Apr 2018 16:36:53 +0000</updated>
                                            <version>5.15.3</version>
                                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16440804" author="jira-bot" created="Tue, 17 Apr 2018 12:25:37 +0000"  >&lt;p&gt;Commit 021c82859cf4361eb31b21fdbac17655ae9e368d in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=021c828&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=021c828&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6947&quot; title=&quot;Queue pending message count can go negative on duplicates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6947&quot;&gt;AMQ-6947&lt;/a&gt; - Make sure counters are updated correct on message drop&lt;/p&gt;

&lt;p&gt;Only update metrics counters when message is removed from the&lt;br/&gt;
pagedInMessages list which is important to check in case of duplicates&lt;/p&gt;</comment>
                            <comment id="16440805" author="jira-bot" created="Tue, 17 Apr 2018 12:26:38 +0000"  >&lt;p&gt;Commit 1fe096cb2a3ec03dbf5a7aab05c0960f8c739339 in activemq&apos;s branch refs/heads/activemq-5.15.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1fe096c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1fe096c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6947&quot; title=&quot;Queue pending message count can go negative on duplicates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6947&quot;&gt;AMQ-6947&lt;/a&gt; - Make sure counters are updated correct on message drop&lt;/p&gt;

&lt;p&gt;Only update metrics counters when message is removed from the&lt;br/&gt;
pagedInMessages list which is important to check in case of duplicates&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 021c82859cf4361eb31b21fdbac17655ae9e368d)&lt;/p&gt;</comment>
                            <comment id="16440807" author="christopher.l.shannon" created="Tue, 17 Apr 2018 12:28:55 +0000"  >&lt;p&gt;This is fixed, I did not add a specific test for this as it&apos;s difficult to reliable get duplicates to happen (This&#160;issue only came up rarely, sometimes during queue purges and sometimes not just on normal duplicate detection) but the existing tests should confirm no regressions.&lt;/p&gt;</comment>
                            <comment id="16442462" author="jira-bot" created="Wed, 18 Apr 2018 13:06:08 +0000"  >&lt;p&gt;Commit 6e468b4540754cad5cd30de373cadc026c998669 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=6e468b4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=6e468b4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6947&quot; title=&quot;Queue pending message count can go negative on duplicates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6947&quot;&gt;AMQ-6947&lt;/a&gt; - Update Queue metrics on expiration&lt;/p&gt;

&lt;p&gt;The updated dropMessage method only decrements the destination metrics&lt;br/&gt;
if a message is removed from the pagedInMessages list to prevent&lt;br/&gt;
duplicate updates.  There is also a case where we still need to update&lt;br/&gt;
metrics if the message never makes it into the pagedInMessages list in&lt;br/&gt;
the first place and that is on expiration so this patch fixes that. A&lt;br/&gt;
couple existing tests found this issue.&lt;/p&gt;</comment>
                            <comment id="16442463" author="jira-bot" created="Wed, 18 Apr 2018 13:06:38 +0000"  >&lt;p&gt;Commit bca0af4133a6e226783f8e953f1abe7d4e165743 in activemq&apos;s branch refs/heads/activemq-5.15.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=bca0af4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=bca0af4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6947&quot; title=&quot;Queue pending message count can go negative on duplicates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6947&quot;&gt;AMQ-6947&lt;/a&gt; - Update Queue metrics on expiration&lt;/p&gt;

&lt;p&gt;The updated dropMessage method only decrements the destination metrics&lt;br/&gt;
if a message is removed from the pagedInMessages list to prevent&lt;br/&gt;
duplicate updates.  There is also a case where we still need to update&lt;br/&gt;
metrics if the message never makes it into the pagedInMessages list in&lt;br/&gt;
the first place and that is on expiration so this patch fixes that. A&lt;br/&gt;
couple existing tests found this issue.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 6e468b4540754cad5cd30de373cadc026c998669)&lt;/p&gt;</comment>
                            <comment id="16442805" author="jira-bot" created="Wed, 18 Apr 2018 16:34:50 +0000"  >&lt;p&gt;Commit 7123534e1b1c82f5358f5a12f7498c0562696c92 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=7123534&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=7123534&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6947&quot; title=&quot;Queue pending message count can go negative on duplicates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6947&quot;&gt;AMQ-6947&lt;/a&gt; - Update Queue metrics on expiration&quot;&lt;/p&gt;

&lt;p&gt;This reverts commit 6e468b4540754cad5cd30de373cadc026c998669.&lt;/p&gt;</comment>
                            <comment id="16442806" author="jira-bot" created="Wed, 18 Apr 2018 16:34:51 +0000"  >&lt;p&gt;Commit 1d2226e6cfc110c0b8456f9c5775ce1a6cdf0ac5 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1d2226e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1d2226e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6947&quot; title=&quot;Queue pending message count can go negative on duplicates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6947&quot;&gt;AMQ-6947&lt;/a&gt; - Make sure counters are updated correct on message drop&quot;&lt;/p&gt;

&lt;p&gt;This reverts commit 021c82859cf4361eb31b21fdbac17655ae9e368d.&lt;/p&gt;</comment>
                            <comment id="16442809" author="jira-bot" created="Wed, 18 Apr 2018 16:35:25 +0000"  >&lt;p&gt;Commit 86fbf957e9ee4a005da838cd7306292ab975e745 in activemq&apos;s branch refs/heads/activemq-5.15.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=86fbf95&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=86fbf95&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6947&quot; title=&quot;Queue pending message count can go negative on duplicates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6947&quot;&gt;AMQ-6947&lt;/a&gt; - Update Queue metrics on expiration&quot;&lt;/p&gt;

&lt;p&gt;This reverts commit bca0af4133a6e226783f8e953f1abe7d4e165743.&lt;/p&gt;</comment>
                            <comment id="16442810" author="jira-bot" created="Wed, 18 Apr 2018 16:35:26 +0000"  >&lt;p&gt;Commit 79fae8c00ba60c46b913c6b39370b20c6d15e6ac in activemq&apos;s branch refs/heads/activemq-5.15.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=79fae8c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=79fae8c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6947&quot; title=&quot;Queue pending message count can go negative on duplicates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6947&quot;&gt;AMQ-6947&lt;/a&gt; - Make sure counters are updated correct on message drop&quot;&lt;/p&gt;

&lt;p&gt;This reverts commit 1fe096cb2a3ec03dbf5a7aab05c0960f8c739339.&lt;/p&gt;</comment>
                            <comment id="16442816" author="christopher.l.shannon" created="Wed, 18 Apr 2018 16:36:34 +0000"  >&lt;p&gt;I reverted my commits because the issue still seems to exist especially when purging a queue during heavy contention.&#160; I think when I tested before and saw it was fixed I just got lucky as further tests have it still broken sometimes (obviously points to some sort of race condition)&lt;/p&gt;

&lt;p&gt;This will need to be looked at in more detail to find the underlying cause for the negative counts&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 30 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3sn7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>