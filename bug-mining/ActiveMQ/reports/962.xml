<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:46:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1730] Bad use of Jms field JMSXDeliveryCount. Related to RedeliveryCount and message prefetch </title>
                <link>https://issues.apache.org/jira/browse/AMQ-1730</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;JMSXDeliveryCount  has to be incremented only on transactional delivery failure ( RuntimeException on processing message, ... ).&lt;/p&gt;

&lt;p&gt;JMSXDeliveryCount  is actualy used in correlation with Message.java field: &apos;redeliveryCounter&apos;.&lt;/p&gt;

&lt;p&gt;But RedeliveryCounter  field is used to be incremented each time the message is preteched or sent to a consumer =&amp;gt; It does not mean that message has been processed by business in transaction with a failure. It just has been prefetched by consumer ou subscriber. &lt;br/&gt;
A &apos;not consumed message&apos; can be give back to the broker when the consumer is closed by user, because it has been prefetched but not really consumed!&lt;/p&gt;

&lt;p&gt;It does not match the meaning of the JMS field JMSXDeliveryCount  :&lt;br/&gt;
&quot;If a failure occurs within transactional processing then the JMSXDeliveryCount is incremented&quot;.&lt;/p&gt;


&lt;p&gt;JMSXDeliveryCount  field only has to be incremented on rollback (isn&apos;t it? ). This is why Message.redeliveryCount can not be used. Or the behavour of field Message.redeliveryCount has to be changed.&lt;/p&gt;

&lt;p&gt;You can either :&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;create a new counter on message incremented only on rollback, or&lt;/li&gt;
	&lt;li&gt;modify classes : PrefetchSubscription.java and Queue.java to remove redeliveryCount increment and increment it only on rollback.&lt;/li&gt;
&lt;/ul&gt;



&lt;ul&gt;
	&lt;li&gt;PrefetchSubscription.java:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;                    if (inAckRange) {&lt;br/&gt;
//                        node.incrementRedeliveryCounter();&lt;br/&gt;
                        if (ack.getLastMessageId().equals(messageId)) &lt;/p&gt;
{
                            destination = node.getRegionDestination();
                            callDispatchMatched = true;
                            break;
                        }
&lt;p&gt;                    }&lt;/p&gt;



&lt;ul&gt;
	&lt;li&gt;Queue.java:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;                for (MessageReference ref : sub.remove(context, this)) {&lt;br/&gt;
                    QueueMessageReference qmr = (QueueMessageReference)ref;&lt;br/&gt;
//                    qmr.incrementRedeliveryCounter();&lt;br/&gt;
                    if( qmr.getLockOwner()==sub ) {&lt;br/&gt;
                        qmr.unlock();&lt;br/&gt;
//                        if (!qmr.isDropped() &amp;amp;&amp;amp; !qmr.isAcked()) &lt;/p&gt;
{
//                        	qmr.incrementRedeliveryCounter();
//                        }
&lt;p&gt;                    }&lt;br/&gt;
                    list.add(qmr);&lt;br/&gt;
                }&lt;/p&gt;


&lt;p&gt;BTW, In this code it seems there is a second bug, in case of  test &quot;qmr.getLockOwner()==sub&quot; is true qmr is incremented a second time ?! Is it right ?&lt;/p&gt;



&lt;p&gt;The result of this problem is the following: &lt;/p&gt;

&lt;p&gt;With Spring and DefaultMessageListenerContainer, a message is consumed one by one. This is why a message prefteched many times, on first real consuming has a JMSXDeliveryCount  with high value not reflecting the reality.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12482772">AMQ-1730</key>
            <summary>Bad use of Jms field JMSXDeliveryCount. Related to RedeliveryCount and message prefetch </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="alexiskinsella">Alexis Kinsella</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 May 2008 13:39:37 +0000</created>
                <updated>Fri, 9 Jan 2015 13:35:21 +0000</updated>
                            <resolved>Fri, 30 Jan 2009 12:02:51 +0000</resolved>
                                    <version>5.0.0</version>
                    <version>5.1.0</version>
                                    <fixVersion>5.3.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>5</watches>
                                                                                                                                                            <comments>
                            <comment id="12939706" author="alexiskinsella" created="Thu, 22 May 2008 06:43:29 +0000"  >&lt;p&gt;It is hard to guess how to correct the fact that undelivered messages prefetched should not have their JMSXDeliveryCount  incremented.&lt;/p&gt;

&lt;p&gt;I finally corrected it as a workaround (I also have to let prefetch on queues at 0):&lt;/p&gt;


&lt;ul&gt;
	&lt;li&gt;PrefetchSubscription.java: (Finally not corrected)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;if (inAckRange) {&lt;br/&gt;
 node.incrementRedeliveryCounter();&lt;br/&gt;
if (ack.getLastMessageId().equals(messageId)) &lt;/p&gt;
{ destination = node.getRegionDestination(); callDispatchMatched = true; break; }
&lt;p&gt;}&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Queue.java: (Finally only first increment commented)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;for (MessageReference ref : sub.remove(context, this)) {&lt;br/&gt;
QueueMessageReference qmr = (QueueMessageReference)ref;&lt;br/&gt;
qmr.incrementRedeliveryCounter();&lt;br/&gt;
if( qmr.getLockOwner()==sub ) {&lt;br/&gt;
qmr.unlock();&lt;br/&gt;
// if (!qmr.isDropped() &amp;amp;&amp;amp; !qmr.isAcked()) &lt;/p&gt;
{
// qmr.incrementRedeliveryCounter();
// }
&lt;p&gt;}&lt;br/&gt;
list.add(qmr);&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;Definitely it seems their is a need for 2 counters:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;one to count delivery to consumers (messages consumed or not by the consumer)&lt;/li&gt;
	&lt;li&gt;one for the JMXDeliveryCount incremented only on rollback&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;JMXDeliveryCount  should not be affected by the value of the prefetch.&lt;/p&gt;</comment>
                            <comment id="12939821" author="tsigelnik" created="Tue, 17 Jun 2008 12:39:35 +0000"  >&lt;p&gt;I have the same problem &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1800&quot; title=&quot;Redilivery counter increase incredible&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1800&quot;&gt;&lt;del&gt;AMQ-1800&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
But I think redeliveryCounter has to be incremented on rollback only also&lt;/p&gt;</comment>
                            <comment id="12939896" author="tsigelnik" created="Thu, 3 Jul 2008 07:09:10 +0000"  >&lt;p&gt;I&apos;ve investigated the problem and I thnink the problem is absence of command like RollabckCommand which could increment redelivery counter on server. &lt;/p&gt;

&lt;p&gt;It think it should be added something like RollbackCommand and session.sendRollback(rollbackCommand) as like as sesssion.sendAck(ack)&lt;/p&gt;</comment>
                            <comment id="12939910" author="tsigelnik" created="Thu, 3 Jul 2008 13:48:37 +0000"  >&lt;p&gt;I was wrong. REDELIVERED_ACK_TYPE is what i ment&lt;br/&gt;
I commented qmr.incrementRedeliveryCounter(); both in Queue and now it&apos;s Ok for me&lt;/p&gt;</comment>
                            <comment id="12940458" author="gtully" created="Fri, 7 Nov 2008 16:30:44 +0000"  >&lt;p&gt;On the meaning of JMSXDeliveryCount, note that the semantics of redelivery indicators in JMS are not absolute. They are in indication only that redelivery may have occurred or that a transaction rolledback. &lt;br/&gt;
The fact that redispatch of prefetched messages on subscription close, increments the redelivery count, is reasonable w.r.t the spec. The extent of this can be managed by the prefetch value for the subscription.&lt;/p&gt;</comment>
                            <comment id="12940728" author="gtully" created="Fri, 30 Jan 2009 10:56:19 +0000"  >&lt;p&gt;The fix for &lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-2087&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-2087&lt;/a&gt; is relevant here. prefetched messages no longer get their redelivery incremented once the consumer or session is successfully closed.&lt;/p&gt;</comment>
                            <comment id="12940710" author="gtully" created="Fri, 30 Jan 2009 12:02:51 +0000"  >&lt;p&gt;resolved with r739249&lt;br/&gt;
The fix targets redeliveryCount and ensures that it is not incremented on prefetched messages that have not been delivered to the consumer. The JMSXDeliveredCount is always 1+ the redeliveryCount. &lt;br/&gt;
Please validate your use case against the tests that were modified with r739249, They are visible in the subversion commits tab.&lt;/p&gt;</comment>
                            <comment id="14249853" author="syberyan" created="Wed, 17 Dec 2014 13:50:11 +0000"  >&lt;p&gt;Is this supposed to be fixed for topics as well as queues? (ActiveMQ 5.10.0)&lt;br/&gt;
The reason I ask is that we&apos;re running into this problem with a durable topic subscription. The application uses a transacted camel route without CACHE_CONSUMER, so from what I understand, the session gets closed after each receive and all prefetched messages (100 by default) get redispatched by the broker. The broker however is increasing redelivery count and we see lots of messages ending up in the DLQ.&lt;br/&gt;
edit: by looking at the implementations of Destination.removeSubscription(ConnectionContext context, Subscription sub, long lastDeliveredSequenceId), it seems that the lastDeliveredSequenceId parameter is only used for queues...&lt;/p&gt;</comment>
                            <comment id="14271009" author="gtully" created="Fri, 9 Jan 2015 13:35:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=syberyan&quot; class=&quot;user-hover&quot; rel=&quot;syberyan&quot;&gt;syberyan&lt;/a&gt; - that was ignored for durable subs - a workaround would be setting keepDurableSubsActive to false. (I think)&lt;br/&gt;
I just fixed that up via &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5513&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5513&lt;/a&gt; which will make 5.11&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12482796">AMQ-1800</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12766016">AMQ-5513</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                            <subtask id="12482763">AMQ-2087</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84606</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 45 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s273:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161832</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>