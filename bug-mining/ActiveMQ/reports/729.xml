<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:43:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1886] Transactions used in a JDBC store WITHOUT a journal will not commit the UOW in an atomic operation</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1886</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;The JDBC store&apos;s primary use case has always been to be used in conjunction with the journal.  When the journal is in place it recovers any partially committed transaction and makes the JDBC store consistent.  When the journal is not used, for example when you are setting up an HA solution with an HA JDBC database, then it has been noticed that on a DB failure you may get partial commits of JMS transactions.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12483064">AMQ-1886</key>
            <summary>Transactions used in a JDBC store WITHOUT a journal will not commit the UOW in an atomic operation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="chirino">Hiram R. Chirino</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 Aug 2008 16:17:59 +0000</created>
                <updated>Thu, 6 Aug 2009 11:49:40 +0000</updated>
                            <resolved>Thu, 6 Aug 2009 11:49:40 +0000</resolved>
                                    <version>5.1.0</version>
                                    <fixVersion>5.3.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12940040" author="chirino" created="Thu, 14 Aug 2008 17:22:38 +0000"  >&lt;p&gt;Fixed in rev 685966&lt;/p&gt;</comment>
                            <comment id="12940078" author="tmielke" created="Mon, 18 Aug 2008 21:35:11 +0000"  >&lt;p&gt;I don&apos;t think &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1886&quot; title=&quot;Transactions used in a JDBC store WITHOUT a journal will not commit the UOW in an atomic operation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1886&quot;&gt;&lt;del&gt;AMQ-1886&lt;/del&gt;&lt;/a&gt; is entirely fixed yet. The error handling still needs improvements. &lt;/p&gt;

&lt;p&gt;Assuming the MySQLJDBCAdapter class uses batchStatements (which seems the default for MySQL and Oracle and surely others), the call to MySQLJDBCAdapter.doAddMessage() only adds the SQL statements to the batch, it does not execute the statements:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;DefaultJDBCAdapter.doAddMessage()&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (batchStatments) {
   s.addBatch();
} 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At the end of MemoryTransactionStore.commit() we call persistenceAdapter.commitTransaction(ctx), which calls into TransactionContext.commit() and this is where we execute the SQL statements in executeBatch(). &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;TransactionContext.commit()&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void commit() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!inTx) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Not started.&quot;&lt;/span&gt;);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            executeBatch();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!connection.getAutoCommit()) {
                connection.commit();
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (SQLException e) {
            JDBCPersistenceAdapter.log(&lt;span class=&quot;code-quote&quot;&gt;&quot;Commit failed: &quot;&lt;/span&gt;, e);
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; IOExceptionSupport.create(e);
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            inTx = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            close();
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So far all is fine.&lt;/p&gt;

&lt;p&gt;Now, lets assume an sql exception is caught during the call to executeBatch(). Before re-raising the ex, we run the finally clause in TransactionContext.commit(), which currently sets inTx=false prior to calling close().&lt;/p&gt;

&lt;p&gt;Inside close() we again check for inTx and since it was set to false already (in finally clause), we run executeBatch() again, this time without a transaction. This will result in some message being written directly to the db until we hit another sql exception.&lt;/p&gt;

&lt;p&gt;IMHO, the finally clause in TransactionContext.commit() should swap the order and call close() first before setting inTx=false.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;TransactionContext.commit()&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;...
&lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
  close();
  inTx = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What do you think?&lt;/p&gt;

&lt;p&gt;Then there is a second problem. When I swapped the order of close() and inTx=false there were no messages written to the db in case of hitting an exception during the call to executeBatch(). However, if the sql exception was raised after message 49 out of 50 msgs to be written, we should somehow call a rollback on the jdbc connection. With the change above, these msgs won&apos;t get written to the db as we do not commit the sql insert but we also don&apos;t rollback explicitly in our error handling. I presume the db itself will run a rollback at some stage (timeout or whatsoever) but to have a clean implementation, we will need to rollback in our exception handling.&lt;/p&gt;

&lt;p&gt;Here is a proposed implementation of TransactionStore.commit():&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;TransactionContext.commit()&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void commit() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!inTx) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Not started.&quot;&lt;/span&gt;);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            executeBatch();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!connection.getAutoCommit()) {
                connection.commit();
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (SQLException e) {
            JDBCPersistenceAdapter.log(&lt;span class=&quot;code-quote&quot;&gt;&quot;Commit failed: &quot;&lt;/span&gt;, e);

  	  &lt;span class=&quot;code-comment&quot;&gt;//we need to rollback before the &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; clause, 
&lt;/span&gt;	  &lt;span class=&quot;code-comment&quot;&gt;//either by calling 
&lt;/span&gt;          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.rollback(); 
          &lt;span class=&quot;code-comment&quot;&gt;//or connection.rollback();
&lt;/span&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; IOExceptionSupport.create(e);
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            close();
            inTx = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;What do you think about this change? I have not tested the explicit call to rollback() and don&apos;t claim to understand the source well enough to understand possible side effects of this change. &lt;/p&gt;</comment>
                            <comment id="12940096" author="tmielke" created="Tue, 19 Aug 2008 05:29:33 +0000"  >&lt;p&gt;Reopening this issue based on previous comment.&lt;/p&gt;</comment>
                            <comment id="12940053" author="chirino" created="Tue, 19 Aug 2008 15:42:05 +0000"  >&lt;p&gt;good catch.. I think the root cause is that the close() call in the finally method is not really closing out the jdbc connection.  On a transacted connection if the connection is actually closed before a commit(), it should automatically cause a transaction rollback.&lt;/p&gt;

&lt;p&gt;Will work on a patch for this.&lt;/p&gt;</comment>
                            <comment id="12940924" author="dejanb" created="Thu, 6 Aug 2009 11:49:40 +0000"  >&lt;p&gt;Applied proposed change and added a JDBCStoreBrokerTest test case to verify everything works fine (revision 801612). All other jdbc-related test cases pass as well.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84739</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 16 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s1dj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161699</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>