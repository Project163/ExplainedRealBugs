<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:04:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4636] JDBCPersistence DB stopped during message send; JMSException is sent back to client rather than shutting down connection</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4636</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Broker is configured to use JDBCIOExceptionHandler.&lt;/p&gt;

&lt;p&gt;When the JDBCPersistence DB is stopped during a message send the broker returns the following javax.jms.JMSException back to the client rather than closing the connection.&lt;/p&gt;

&lt;p&gt;This results in the client having to deal with the exception instead of the failover transport having to deal with a connection loss and redeliver the message. Failover transport and transport connection loss seems to be the approach used when other SQL exceptions are thrown.&lt;/p&gt;





&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Exception received on client side:

javax.jms.JMSException: ORA-01089: immediate shutdown in progress - no operation
s are permitted

        at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSuppo
rt.java:54)
        at org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnect
ion.java:1391)
        at org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnect
ion.java:1319)
        at org.apache.activemq.ActiveMQSession.send(ActiveMQSession.java:1798)
        at org.apache.activemq.ActiveMQMessageProducer.send(ActiveMQMessageProdu
cer.java:289)
        at org.apache.activemq.ActiveMQMessageProducer.send(ActiveMQMessageProdu
cer.java:224)
        at org.apache.activemq.ActiveMQMessageProducerSupport.send(ActiveMQMessa
geProducerSupport.java:241)
        at com.acme.MyPublisher.doIt(MyPublisher.java:50)
        at com.acme.MyPublisher.main(MyPublisher.java:26)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.
java:39)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAcces
sorImpl.java:25)
        at java.lang.reflect.Method.invoke(Method.java:597)
        at org.codehaus.mojo.exec.ExecJavaMojo$1.run(ExecJavaMojo.java:297)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:662)
Caused by: java.io.IOException: ORA-01089: immediate shutdown in progress - no o
perations are permitted

        at org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport
.java:45)
        at org.apache.activemq.store.jdbc.TransactionContext.close(TransactionCo
ntext.java:141)
        at org.apache.activemq.store.jdbc.JDBCMessageStore.addMessage(JDBCMessag
eStore.java:129)
        at org.apache.activemq.store.memory.MemoryTransactionStore.addMessage(Me
moryTransactionStore.java:327)
        at org.apache.activemq.store.memory.MemoryTransactionStore$2.asyncAddTop
icMessage(MemoryTransactionStore.java:190)
        at org.apache.activemq.broker.region.Topic.doMessageSend(Topic.java:471)

        at org.apache.activemq.broker.region.Topic.send(Topic.java:435)
        at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.
java:406)
        at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java
:392)
        at org.apache.activemq.broker.jmx.ManagedRegionBroker.send(ManagedRegion
Broker.java:282)
        at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:129)
        at org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeD
estinationBroker.java:96)
        at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.j
ava:317)
        at org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilt
er.java:135)
        at org.apache.activemq.broker.TransportConnection.processMessage(Transpo
rtConnection.java:499)
        at org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.jav
a:749)
        at org.apache.activemq.broker.TransportConnection.service(TransportConne
ction.java:329)
        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportC
onnection.java:184)
        at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport
.java:50)
        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireForm
atNegotiator.java:113)
        at org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(Abs
tractInactivityMonitor.java:288)
        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSup
port.java:83)
        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.jav
a:214)
        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:
196)
        ... 1 more
Caused by: java.lang.Throwable: java.sql.BatchUpdateException: ORA-01089: immedi
ate shutdown in progress - no operations are permitted

        at oracle.jdbc.driver.OraclePreparedStatement.executeBatch(OraclePrepare
dStatement.java:10296)
        at oracle.jdbc.driver.OracleStatementWrapper.executeBatch(OracleStatemen
tWrapper.java:216)
        at com.mchange.v2.c3p0.impl.NewProxyPreparedStatement.executeBatch(NewPr
oxyPreparedStatement.java:1723)
        at org.apache.activemq.store.jdbc.TransactionContext.executeBatch(Transa
ctionContext.java:106)
        at org.apache.activemq.store.jdbc.TransactionContext.executeBatch(Transa
ctionContext.java:84)
        at org.apache.activemq.store.jdbc.TransactionContext.close(TransactionCo
ntext.java:132)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Will attach a test case soon.&lt;/p&gt;</description>
                <environment>&lt;p&gt;tested on trunk.&lt;/p&gt;</environment>
        <key id="12658468">AMQ-4636</key>
            <summary>JDBCPersistence DB stopped during message send; JMSException is sent back to client rather than shutting down connection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="pgfox">Pat Fox</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Jul 2013 08:19:14 +0000</created>
                <updated>Tue, 30 Jul 2013 20:36:01 +0000</updated>
                            <resolved>Tue, 30 Jul 2013 20:35:27 +0000</resolved>
                                    <version>5.8.0</version>
                                    <fixVersion>5.9.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13712196" author="gtully" created="Thu, 18 Jul 2013 10:23:52 +0000"  >&lt;p&gt;there are two problems here.&lt;br/&gt;
1) there is no callback to the IOExceptionHandler in org.apache.activemq.store.jdbc.TransactionContext.close so the exception is not intercepted.&lt;/p&gt;

&lt;p&gt;2) When an IOExceptionHandler wants to &apos;handle&apos; an exception by stopping broker or transports, there is a race between the async stop and the exception response.&lt;/p&gt;

&lt;p&gt;For 1, we need to invoke the handler&lt;br/&gt;
for 2, we need to let the IOExceptionHandler wrap the exception to indicate that it is handled such that can be trapped by org.apache.activemq.broker.TransportConnection#service and ignored. Something like SuppressReplyOnHandled(IOException).&lt;/p&gt;</comment>
                            <comment id="13712291" author="gtully" created="Thu, 18 Jul 2013 13:03:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/activemq/blob/trunk/activemq-unit-tests/src/test/java/org/apache/activemq/broker/ft/DbRestartJDBCQueueMasterSlaveTest.java#L112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/trunk/activemq-unit-tests/src/test/java/org/apache/activemq/broker/ft/DbRestartJDBCQueueMasterSlaveTest.java#L112&lt;/a&gt;&lt;br/&gt;
is also relevant for the consumer case. If we &lt;b&gt;want&lt;/b&gt; to propagate store exceptions back to the client then they should not be IOExceptions. The Handler can do that also.&lt;/p&gt;</comment>
                            <comment id="13713678" author="pgfox" created="Fri, 19 Jul 2013 13:58:10 +0000"  >&lt;p&gt;Thanks Gary, I have spilt your point 2 above into a separate JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4643&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-4643&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13724372" author="gtully" created="Tue, 30 Jul 2013 20:35:27 +0000"  >&lt;p&gt;This is fixed as a byproduct of &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4643&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-4643&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;The TransactionContext.close now correctly delegates to the IOExceptionHandler which handles the transaction commit/rollback failure cases&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12658747">AMQ-4643</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12592940" name="AMQ4636Test.java" size="6760" author="pgfox" created="Thu, 18 Jul 2013 08:56:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>338662</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 17 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1mev3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>338982</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>