<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:36:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1438] When in XA Transaction Active-MQ integrated with OpenEJB hangs in the isSameRM method of LocalAndXATransaction. </title>
                <link>https://issues.apache.org/jira/browse/AMQ-1438</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt; I was facing a problem with the AMQ 4.1 with the LocalAndXATransaction class&apos;s isSameRM waiting indefinitely. The wait is because waitForBrokerInfo calls brokerInfoReceived.await()&lt;br/&gt;
where brokerInfoReceived is a countdown latch. Once this is waiting it&lt;br/&gt;
never gets resumed.&lt;/p&gt;

&lt;p&gt;To trigger it the method onCommand(final Object o) has to be called on&lt;br/&gt;
org.apache.activemq.ActiveMQConnection. &lt;/p&gt;</description>
                <environment>&lt;p&gt;All&lt;/p&gt;</environment>
        <key id="12482377">AMQ-1438</key>
            <summary>When in XA Transaction Active-MQ integrated with OpenEJB hangs in the isSameRM method of LocalAndXATransaction. </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="djencks">David Jencks</assignee>
                                    <reporter username="manucet">Manu T George</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Oct 2007 07:29:02 +0000</created>
                <updated>Mon, 7 Apr 2008 22:16:03 +0000</updated>
                            <resolved>Mon, 7 Apr 2008 22:16:03 +0000</resolved>
                                    <version>4.1.1</version>
                                    <fixVersion>4.1.2</fixVersion>
                                    <component>Connector</component>
                    <component>Transport</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12939033" author="manucet" created="Wed, 3 Oct 2007 07:45:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OPENEJB-702&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/OPENEJB-702&lt;/a&gt; is blocked because of this&lt;/p&gt;</comment>
                            <comment id="12939028" author="manucet" created="Wed, 3 Oct 2007 07:47:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/GERONIMO-3354&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/GERONIMO-3354&lt;/a&gt; is depending on this &lt;/p&gt;</comment>
                            <comment id="12939081" author="manucet" created="Wed, 10 Oct 2007 06:45:15 +0000"  >&lt;p&gt;This fixes the issue. Running the tests shows the same no of failures as before applying the patch so assuming it doesn&apos;t break anything.&lt;/p&gt;</comment>
                            <comment id="12939113" author="manucet" created="Thu, 11 Oct 2007 10:43:10 +0000"  >&lt;p&gt;I believe I owe an explanation for the JIRA.&lt;/p&gt;

&lt;p&gt;The problem faced is a hang in the method below when the Geronimo TM calls it.&lt;/p&gt;

&lt;p&gt;   public boolean isSameRM(XAResource other) throws XAException {&lt;br/&gt;
       if (other instanceof WrapperNamedXAResource) &lt;/p&gt;
{
           return
xaResource.isSameRM(((WrapperNamedXAResource)other).xaResource);
       }
&lt;p&gt;       return false;&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;The hang is because this method invokes org,apache.activemq.ActiveMQConnection.getResourceManagerId()&lt;/p&gt;

&lt;p&gt;This method is shown below&lt;/p&gt;

&lt;p&gt;    public String getResourceManagerId() throws JMSException &lt;/p&gt;
{
        waitForBrokerInfo();
        if( brokerInfo==null )
            throw new JMSException(&quot;Connection failed before Broker info was received.&quot;);            
        return brokerInfo.getBrokerId().getValue();
    }

&lt;p&gt;The waitForBrokerInfo() method is shown below&lt;/p&gt;

&lt;p&gt; private void waitForBrokerInfo() throws JMSException {&lt;br/&gt;
        try &lt;/p&gt;
{
            brokerInfoReceived.await();
        }
&lt;p&gt; catch (InterruptedException e) &lt;/p&gt;
{
            Thread.currentThread().interrupt();
            throw JMSExceptionSupport.create(e);
        }
&lt;p&gt;    }&lt;/p&gt;

&lt;p&gt;Once await is called on brokerInfoReceived which is a countdown latch currently brokerInfoReceived.countDown() never gets called. Actually this should get called on the &lt;br/&gt;
else if ( command.isBrokerInfo() ) &lt;/p&gt;
{
                this.brokerInfo = (BrokerInfo)command;
                brokerInfoReceived.countDown();
                this.optimizeAcknowledge &amp;amp;= !this.brokerInfo.isFaultTolerantConfiguration();
            }

&lt;p&gt;block of the onCommand method of org.apache.activemq.ActiveMQConnection.&lt;/p&gt;

&lt;p&gt;This is not getting called. &lt;/p&gt;

&lt;p&gt;On investigating and with some help from AMQ IRC , I found that there are two methods in org.apache.activemq.transport.vm.VMTransport. They are given below&lt;/p&gt;

&lt;p&gt;    protected void syncOneWay(Object command){&lt;br/&gt;
        final TransportListener tl=peer.transportListener;&lt;br/&gt;
        prePeerSetQueue=peer.prePeerSetQueue;&lt;br/&gt;
        if(tl==null)&lt;/p&gt;
{
            prePeerSetQueue.add(command);
        }
&lt;p&gt;else&lt;/p&gt;
{
            tl.onCommand(command);
        }
&lt;p&gt;    }&lt;/p&gt;

&lt;p&gt;    protected void asyncOneWay(Object command) throws IOException{&lt;br/&gt;
        messageQueue=getMessageQueue();&lt;br/&gt;
        try&lt;/p&gt;
{
            messageQueue.put(command);
            wakeup();
        }
&lt;p&gt;catch(final InterruptedException e)&lt;/p&gt;
{
            log.error(&quot;messageQueue interupted&quot;,e);
            throw new IOException(e.getMessage());
        }
&lt;p&gt;    }&lt;/p&gt;

&lt;p&gt;The problem here is even when i set async=true for the VMTransport when the command BrokerInfo is sent syncOneWay is called. At that time TransportListener tl=null. So it gets added to prePeerSetQueue. The reason for this happening is that in org.apache.activemq.transport.vm.VMTransportFactory when the below lines are called a brokerInfo is sent as server.connect() is called. The async=true is not yet set resulting in the syncOneWay getting called. Only after that IntrospectionSupport.setProperties(vmtransport,options); is called and async is set to true. Due to this inconsistency the BrokerInfo command gets lost.&lt;/p&gt;

&lt;p&gt;VMTransport vmtransport=server.connect();&lt;br/&gt;
IntrospectionSupport.setProperties(vmtransport,options);&lt;/p&gt;

&lt;p&gt;I hope I made the issue clear. Can someone verify the patch or make a fix for this.&lt;/p&gt;

</comment>
                            <comment id="12939386" author="djencks" created="Mon, 24 Mar 2008 07:59:52 +0000"  >&lt;p&gt;Applied modified version of the patch in rev 640340.  Passed options into server.connect method so that correct TransportAcceptListener is sure to be used.&lt;/p&gt;</comment>
                            <comment id="12939454" author="djencks" created="Mon, 7 Apr 2008 22:16:03 +0000"  >&lt;p&gt;Would be a good idea to check if it works in 5.1&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12460800" name="AMQ-1438.patch" size="1677" author="manucet" created="Wed, 10 Oct 2007 06:45:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84538</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 34 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rrpr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160134</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>