<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:49:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-7425] Messages in journal persistence don&apos;t get deleted upon ack</title>
                <link>https://issues.apache.org/jira/browse/AMQ-7425</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;When using a journal JDBC persistence, we noticed that some messages in the DB table (activemq_msgs) don&apos;t always get deleted upon the messages being consumed. The adverse effect is that if the broker restarts (hosted in a K8S pod, so local journal files also lost) the broker will consider all non-deleted message as still unconsumed and will offer them up for consumption (this was an issue for us in production)&lt;/p&gt;

&lt;p&gt;This seems to be cause by the fact that the persistence adapter does not use the right ID in the SQL statement to delete the line.&lt;/p&gt;

&lt;p&gt;This comes from the fact that sometimes, the messageId has a &quot;futureOrSequenceLong&quot; of 0 as opposed to the correct ID (from the DB). This is because the &quot;futureOrSequenceLong&quot; gets set on that message only at the time the message is being persisted. But in a journal persistence, this happens on a frequency (5 minutes by default).&lt;/p&gt;

&lt;p&gt;If a browse action occurs before the message is persisted, then a copy of the message is taken, which also copies of the wrong &quot;futureOrSequenceLong&quot;. Upon consumption (assuming no restarts of the broker in the meantime), it is this copy of the messageId that is used when comes the time to remove the message from the DB.&lt;/p&gt;

&lt;p&gt;The removal code actually caters for the missing &quot;futureOrSequenceLong&quot; in JDBCMessageStore &lt;span class=&quot;error&quot;&gt;&amp;#91;257&amp;#93;&lt;/span&gt;&#160;with this line:&lt;/p&gt;

&lt;p&gt;&#160; &lt;font color=&quot;#FF0000&quot;&gt;&#160;&#160; long seq = ack.getLastMessageId().getFutureOrSequenceLong() != null ?&#160; &#160;&#160; long seq = ack.getLastMessageId().getFutureOrSequenceLong() != null ?&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; (Long) ack.getLastMessageId().getFutureOrSequenceLong() :&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; persistenceAdapter.getStoreSequenceIdForMessageId(context, ack.getLastMessageId(), destination)&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;;&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;In which case it will get it from the DB directly.&lt;/p&gt;

&lt;p&gt;But the issue is that in the described case, the &quot;futureOrSequenceLong&quot; is not null, but has a value of 0L.&lt;/p&gt;

&lt;p&gt;This is due to this line in JournalMessageStore.addMessage &lt;span class=&quot;error&quot;&gt;&amp;#91;142&amp;#93;&lt;/span&gt;&#160;(called when the message is originally produced)&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#FF0000&quot;&gt;message.getMessageId().setFutureOrSequenceLong(0l);&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;I actually think that creating a message on a JournalMessageStore should leave the &quot;futureOrSequenceLong&quot; null so that later condition checks can pick it up as such and properly get the sequence from the database.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13288165">AMQ-7425</key>
            <summary>Messages in journal persistence don&apos;t get deleted upon ack</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbonofre">Jean-Baptiste Onofr&#233;</assignee>
                                    <reporter username="ngrondin78@gmail.com">Nicolas Grondin</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Feb 2020 23:44:15 +0000</created>
                <updated>Tue, 3 Mar 2020 16:16:58 +0000</updated>
                            <resolved>Tue, 3 Mar 2020 16:16:58 +0000</resolved>
                                    <version>5.15.11</version>
                                    <fixVersion>5.16.0</fixVersion>
                    <fixVersion>5.15.12</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17049943" author="jbonofre" created="Tue, 3 Mar 2020 06:38:26 +0000"  >&lt;p&gt;As we are very close to ActiveMQ 5.15.12 and 5.16.0 releases, I did a very simple fix to be sure messages are removed from the store.&lt;/p&gt;

&lt;p&gt;Please, let me know what you think about this.&lt;/p&gt;</comment>
                            <comment id="17050354" author="jira-bot" created="Tue, 3 Mar 2020 16:14:33 +0000"  >&lt;p&gt;Commit 4528b773c6863b7f3994bcdc9772b1fb2a98cfd0 in activemq&apos;s branch refs/heads/master from jbonofre&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=4528b77&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=4528b77&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7425&quot; title=&quot;Messages in journal persistence don&amp;#39;t get deleted upon ack&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7425&quot;&gt;&lt;del&gt;AMQ-7425&lt;/del&gt;&lt;/a&gt; Simple fix to be sure to delete message from JDBC message store&lt;/p&gt;</comment>
                            <comment id="17050355" author="jira-bot" created="Tue, 3 Mar 2020 16:14:35 +0000"  >&lt;p&gt;Commit e20ef34ae0df57527beb84ddd595ca8848d72f71 in activemq&apos;s branch refs/heads/master from Jean-Baptiste Onofr&#233;&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=e20ef34&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=e20ef34&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #495 from jbonofre/&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7425&quot; title=&quot;Messages in journal persistence don&amp;#39;t get deleted upon ack&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7425&quot;&gt;&lt;del&gt;AMQ-7425&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7425&quot; title=&quot;Messages in journal persistence don&amp;#39;t get deleted upon ack&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7425&quot;&gt;&lt;del&gt;AMQ-7425&lt;/del&gt;&lt;/a&gt; Simple fix to be sure to delete message from JDBC message store&lt;/p&gt;</comment>
                            <comment id="17050356" author="jira-bot" created="Tue, 3 Mar 2020 16:14:37 +0000"  >&lt;p&gt;Commit e20ef34ae0df57527beb84ddd595ca8848d72f71 in activemq&apos;s branch refs/heads/master from Jean-Baptiste Onofr&#233;&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=e20ef34&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=e20ef34&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #495 from jbonofre/&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7425&quot; title=&quot;Messages in journal persistence don&amp;#39;t get deleted upon ack&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7425&quot;&gt;&lt;del&gt;AMQ-7425&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7425&quot; title=&quot;Messages in journal persistence don&amp;#39;t get deleted upon ack&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7425&quot;&gt;&lt;del&gt;AMQ-7425&lt;/del&gt;&lt;/a&gt; Simple fix to be sure to delete message from JDBC message store&lt;/p&gt;</comment>
                            <comment id="17050357" author="jira-bot" created="Tue, 3 Mar 2020 16:15:36 +0000"  >&lt;p&gt;Commit cfdfbc57db3c4162c5fcb5e06c0c30b71e44fa93 in activemq&apos;s branch refs/heads/activemq-5.15.x from jbonofre&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=cfdfbc5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=cfdfbc5&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7425&quot; title=&quot;Messages in journal persistence don&amp;#39;t get deleted upon ack&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7425&quot;&gt;&lt;del&gt;AMQ-7425&lt;/del&gt;&lt;/a&gt; Simple fix to be sure to delete message from JDBC message store&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 4528b773c6863b7f3994bcdc9772b1fb2a98cfd0)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0bzb4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>