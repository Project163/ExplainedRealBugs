<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:41:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6680] MQTT over WebSocket doesn&apos;t work when WebSocket data frame contains partial or multiple MQTT control packets</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6680</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I tried to use the MQTT.js library in a browser but it didn&apos;t connect to ActiveMQ using MQTT-WebSocket transport.&lt;br/&gt;
Debugging MQTT.js and ActiveMQ I found that the org.apache.activemq.transport.ws.jetty9.MQTTSocket class (in activemq-http module) assumes that a single WebSocket data frame &lt;ins&gt;always&lt;/ins&gt; contains a single MQTT Control Packet.&lt;br/&gt;
This is the cause of MQTT.js failure because MQTT.js makes several send over WebSocket for a single MQTT Control Packet (header, length etc).&lt;/p&gt;

&lt;p&gt;Accordingly to MQTT OASIS specification ( &lt;a href=&quot;http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718127&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718127&lt;/a&gt; ):&lt;/p&gt;

&lt;p&gt;&lt;cite&gt;A single WebSocket data frame can contain multiple or partial MQTT Control Packets. The receiver MUST NOT assume that MQTT Control Packets are aligned on WebSocket frame boundaries.&lt;/cite&gt;&lt;/p&gt;

&lt;p&gt;And RFC 6455 ( &lt;a href=&quot;https://www.ietf.org/rfc/rfc6455.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.ietf.org/rfc/rfc6455.txt&lt;/a&gt; ): &lt;/p&gt;

&lt;p&gt;&lt;cite&gt;The WebSocket message does not necessarily correspond to a particular network layer framing, as a fragmented message may be coalesced or split by an intermediary.&lt;/cite&gt;&lt;/p&gt;

&lt;p&gt;So I think that ActiveMQ should be fixed to be compliant to the WebSocket and MQTT specifications.&lt;/p&gt;

&lt;p&gt;I attached the diff patch file for MQTTSocket which fixes the problem and a new activemq-http module MQTT-WebSocket unit test for this issue (the same of MQTTWSTransportTest but which splits MQTT Frame Packet in multiple WebSocket frames):&lt;/p&gt;

&lt;p&gt;MQTTWSPartialFrameConnection.java&lt;br/&gt;
MQTTWSPartialFrameTest.java&lt;/p&gt;

&lt;p&gt;When writing the unit test I found also a bug in the class org.apache.activemq.transport.ws.MQTTWSConnection.java. &lt;br/&gt;
All the occurrences of: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ByteSequence payload = wireFormat.marshal(command.encode());
connection.getRemote().sendBytes(ByteBuffer.wrap(payload.data));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;should be replaced with:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ByteSequence payload = wireFormat.marshal(command.encode());
connection.getRemote().sendBytes(ByteBuffer.wrap(payload.data, payload.offset, payload.length));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That is because of the payload.data bytes array buffer in ByteSequenze is bigger than the real MQTT frame packed bytes size, so sending all the payload.data bytes array, ActiveMQ receives much more extra zero-extra bytes. With the current implementation, those extra zero-bytes are ignored and this makes wrongly passes the test (while it should fail because there are &quot;extra bytes&quot; which doesn&apos;t respect the MQTT protocol).&lt;/p&gt;

&lt;p&gt;I attached also the diff patch file for the MQTTWSConnection file.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13073792">AMQ-6680</key>
            <summary>MQTT over WebSocket doesn&apos;t work when WebSocket data frame contains partial or multiple MQTT control packets</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="grayra">Marco Geri</reporter>
                        <labels>
                            <label>mqtt</label>
                            <label>patch</label>
                            <label>websocket</label>
                    </labels>
                <created>Mon, 22 May 2017 09:01:41 +0000</created>
                <updated>Mon, 22 May 2017 16:29:00 +0000</updated>
                            <resolved>Mon, 22 May 2017 16:29:00 +0000</resolved>
                                    <version>5.14.5</version>
                                    <fixVersion>5.15.0</fixVersion>
                    <fixVersion>5.14.6</fixVersion>
                                    <component>MQTT</component>
                    <component>Transport</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16019320" author="grayra" created="Mon, 22 May 2017 09:03:22 +0000"  >&lt;p&gt;Diff patch files and unit test&lt;/p&gt;</comment>
                            <comment id="16019777" author="jira-bot" created="Mon, 22 May 2017 16:27:45 +0000"  >&lt;p&gt;Commit e69367fbc329aa66a90e33a917b0d4ccd86c015e in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e69367f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e69367f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6680&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6680&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fix handling of incoming MQTT binary data over WS.  The handler should&lt;br/&gt;
use the MQTTCodec to ensure that partial or packed frames are fully&lt;br/&gt;
processed&lt;/p&gt;</comment>
                            <comment id="16019778" author="jira-bot" created="Mon, 22 May 2017 16:28:08 +0000"  >&lt;p&gt;Commit bf395fcdb3d63a3af48494cbec86734ed8867a90 in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=bf395fc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=bf395fc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6680&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6680&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fix handling of incoming MQTT binary data over WS.  The handler should&lt;br/&gt;
use the MQTTCodec to ensure that partial or packed frames are fully&lt;br/&gt;
processed&lt;br/&gt;
(cherry picked from commit e69367fbc329aa66a90e33a917b0d4ccd86c015e)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12869219" name="MQTTSocket-patch.txt" size="6224" author="grayra" created="Mon, 22 May 2017 09:03:22 +0000"/>
                            <attachment id="12869222" name="MQTTWSConnection-patch.txt" size="1689" author="grayra" created="Mon, 22 May 2017 09:03:22 +0000"/>
                            <attachment id="12869220" name="MQTTWSPartialFrameConnection.java" size="10466" author="grayra" created="Mon, 22 May 2017 09:03:22 +0000"/>
                            <attachment id="12869221" name="MQTTWSPartialFrameTest.java" size="7540" author="grayra" created="Mon, 22 May 2017 09:03:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 26 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3fa93:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>