<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:36:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1656] Messages are sometimes skipped when  using JDBC master/slave</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1656</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Sometime, a (or some) message(s) hang in the queue while no consumer eat it. It happen more often a failover.&lt;/p&gt;

&lt;p&gt;Scenario:&lt;br/&gt;
2 brokers (jdbc master/slave), 2 consumers (with prefetch set to 1), 2 producers&lt;/p&gt;

&lt;p&gt;Producers :&lt;br/&gt;
  ant producer -Durl=&quot;failover:(tcp://localhost:61618,tcp://localhost:61619)&quot; -Ddurable=true -Dmax=500&lt;br/&gt;
Consumer 1:&lt;br/&gt;
  ant consumer -Durl=&quot;failover:(tcp://localhost:61618,tcp://localhost:61619)&quot; -Dmax=10000 -DclientId=c1&lt;br/&gt;
Consumer 2:&lt;br/&gt;
  ant consumer -Durl=&quot;failover:(tcp://localhost:61618,tcp://localhost:61619)&quot; -Dmax=10000 -DclientId=c2&lt;/p&gt;

&lt;p&gt;1 - Start the two brokers (one will be master, the other will be slave)&lt;br/&gt;
2 - Start the producers, consumers&lt;br/&gt;
3 - Wait a little,&lt;br/&gt;
4 - Kill the master -&amp;gt; slave become master&lt;br/&gt;
5 - Producers continue producing, consumers continue consuming&lt;br/&gt;
6 - After all producers finish their task, the consumer will finish consuming, and sometimes there still messages left in the queue (in the database, and using JMX to see the state of the queue).&lt;br/&gt;
7 - Restart a new broker, kill the master&lt;br/&gt;
8 - The messages will be consumed &lt;/p&gt;


&lt;p&gt;There is a race condition between the time the message is set with the broker sequence number (RegionBroker.java in send method), and the time it is actually put in the database (DefaultJDBCAdapter.java in doAddMessage method).&lt;/p&gt;

&lt;p&gt;I have seen that sometimes message with higher sequence number are put in database before a lower sequence number.  For example: 386 is put in the database before 385. If it is happening when JDBCMessageStore is recovering the next message (lastMessageId is 384), then 386 will be fetched and the lastMessageId will change to be 386. 385 is then put in the db but never retrieved (stopping and restarting the broker will allow to retrieve the message because at start the lastMessageId is -1).&lt;/p&gt;

&lt;p&gt;I have synchronized the code inside the RegionBroker.send, and I don&apos;t have gaps anymore. This is a workaround for us since we don&apos;t process a lot of message. But maybe a more elegant solution is to set the brokerSequenceId in doAddMessage of JDBCAdapter (I may be wrong, I didn&apos;t check if the brokerSequenceId is used elsewhere).&lt;/p&gt;
</description>
                <environment>&lt;p&gt;Windows XP sp2, java 6, Mysql 5.0.51a&lt;/p&gt;</environment>
        <key id="12482464">AMQ-1656</key>
            <summary>Messages are sometimes skipped when  using JDBC master/slave</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="leguil2007">Fran&#231;ois Guillemette</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Apr 2008 17:35:32 +0000</created>
                <updated>Thu, 10 Apr 2008 17:17:14 +0000</updated>
                            <resolved>Thu, 10 Apr 2008 17:17:14 +0000</resolved>
                                    <version>5.0.0</version>
                                    <fixVersion>5.1.0</fixVersion>
                                    <component>Message Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12939556" author="rajdavies" created="Thu, 10 Apr 2008 17:17:14 +0000"  >&lt;p&gt;Fixed by SVN revision 646880&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84619</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 33 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14b6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>233275</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>