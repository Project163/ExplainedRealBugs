<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:52:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-9107] Closing many consumers causes CPU to spike to 100%</title>
                <link>https://issues.apache.org/jira/browse/AMQ-9107</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;When there are many consumers (~188k) on a queue, closing them is incredibly expensive and causes the CPU to spike to 100% while the consumers are closed. Tested on an Amazon MQ mq.m5.large instance (2 vcpu, 8gb memory).&lt;/p&gt;

&lt;p&gt;I have attached a minimal recreation of the issue where the following happens:&#160;&lt;/p&gt;

&lt;p&gt;1/ Open 100 connections.&lt;/p&gt;

&lt;p&gt;2/ Create consumers as fast as we can on all of those connections until we hit at least 188k consumers.&lt;/p&gt;

&lt;p&gt;3/ Sleep for 5 minutes so we can observe the CPU come back down after opening all those connections.&lt;/p&gt;

&lt;p&gt;4/ Start closing consumers as fast as we can.&lt;/p&gt;

&lt;p&gt;5/ After all consumers are closed, sleep for 5 minutes to observe the CPU come back down after closing all the connections.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In this example it seems 5 minutes wasn&apos;t actually sufficient time for the CPU to come back down and the consumer and connection counts seem to hit 0 at the same time:&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13050132/13050132_image-2022-10-07-00-12-39-657.png&quot; height=&quot;353&quot; width=&quot;757&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In a previous test with more time sleeping after closing all the consumers we can see the CPU come back down before we close the connections.&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13050130/13050130_image-2022-10-07-00-17-30-657.png&quot; height=&quot;348&quot; width=&quot;764&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13484946">AMQ-9107</key>
            <summary>Closing many consumers causes CPU to spike to 100%</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbonofre">Jean-Baptiste Onofr&#233;</assignee>
                                    <reporter username="tetlucas">Lucas T&#233;treault</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 Oct 2022 07:18:55 +0000</created>
                <updated>Sun, 6 Nov 2022 20:06:27 +0000</updated>
                            <resolved>Thu, 3 Nov 2022 10:51:15 +0000</resolved>
                                    <version>5.17.1</version>
                    <version>5.16.5</version>
                                    <fixVersion>5.18.0</fixVersion>
                    <fixVersion>5.16.6</fixVersion>
                    <fixVersion>5.17.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="13800">3h 50m</timespent>
                                <comments>
                            <comment id="17613915" author="jbonofre" created="Fri, 7 Oct 2022 07:31:56 +0000"  >&lt;p&gt;What transport is used by the client / broker ? TCP, HTTP, ... ?&lt;/p&gt;</comment>
                            <comment id="17613920" author="tetlucas" created="Fri, 7 Oct 2022 07:35:09 +0000"  >&lt;p&gt;We&apos;re using openwire+ssl. I haven&apos;t tested with any other transports.&#160;&lt;/p&gt;</comment>
                            <comment id="17616765" author="jira-bot" created="Thu, 13 Oct 2022 03:58:10 +0000"  >&lt;p&gt;Commit 96a011d4b1527590b07d6e74f4c6f9a06dbab409 in activemq&apos;s branch refs/heads/main from Jean-Baptiste Onofr&#233;&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=96a011d4b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=96a011d4b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #908 from lucastetreault/&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9107&quot; title=&quot;Closing many consumers causes CPU to spike to 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9107&quot;&gt;&lt;del&gt;AMQ-9107&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9107&quot; title=&quot;Closing many consumers causes CPU to spike to 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9107&quot;&gt;&lt;del&gt;AMQ-9107&lt;/del&gt;&lt;/a&gt; Remove consumers more efficiently in ManagedRegionBroker&lt;/p&gt;</comment>
                            <comment id="17626969" author="jira-bot" created="Tue, 1 Nov 2022 06:06:24 +0000"  >&lt;p&gt;Commit 98b7d3443cca2be964637962f86d265b8375c632 in activemq&apos;s branch refs/heads/main from Lucas T&#233;treault&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=98b7d3443&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=98b7d3443&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Add a test for offline durable subscriptions for &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9107&quot; title=&quot;Closing many consumers causes CPU to spike to 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9107&quot;&gt;&lt;del&gt;AMQ-9107&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17626970" author="jira-bot" created="Tue, 1 Nov 2022 06:06:54 +0000"  >&lt;p&gt;Commit fb89765fdf19602ba9be4034fa88123b7b127c4a in activemq&apos;s branch refs/heads/activemq-5.17.x from Lucas T&#233;treault&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=fb89765fd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=fb89765fd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Add a test for offline durable subscriptions for &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9107&quot; title=&quot;Closing many consumers causes CPU to spike to 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9107&quot;&gt;&lt;del&gt;AMQ-9107&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 98b7d3443cca2be964637962f86d265b8375c632)&lt;/p&gt;</comment>
                            <comment id="17627194" author="christopher.l.shannon" created="Tue, 1 Nov 2022 14:41:26 +0000"  >&lt;p&gt;This doesn&apos;t have nearly enough testing around durable subscriptions and this causes a memory leak. ConsumerInfo is not great to use as the key because that object will change every time a consumer goes offline/online for a durable subscription. I just ran a test where I went online/offline several times in a row for a durable and the new map kept growing because the consumer id changed each time.&lt;/p&gt;

&lt;p&gt;The performance improvement would be nice but I&apos;m skeptical about using ConsumerInfo as a key here unless a lot more testing is done to prove no memory leaks and things actually work for all edge cases including broker restarts, etc.&lt;/p&gt;

&lt;p&gt;Also, by introducing a second map you now have created race conditions because the maps may get out of sync with some weird bug.&lt;/p&gt;</comment>
                            <comment id="17627224" author="christopher.l.shannon" created="Tue, 1 Nov 2022 15:57:19 +0000"  >&lt;p&gt;I&apos;m working on an alternate approach to this and will have a PR ready soon.&lt;/p&gt;</comment>
                            <comment id="17627225" author="jbonofre" created="Tue, 1 Nov 2022 16:00:09 +0000"  >&lt;p&gt;I think the current approach is fine, using ConsumerInfo is interesting because it&apos;s there. If you have a better approach, that&apos;s fine.&lt;/p&gt;

&lt;p&gt;By the way, I would like to submit 5.17.3 to vote asap. If you want me to include your change, please let me know. Thanks !&lt;/p&gt;</comment>
                            <comment id="17627228" author="christopher.l.shannon" created="Tue, 1 Nov 2022 16:11:20 +0000"  >&lt;p&gt;The current approach is not fine considering it causes a memory leak.&lt;/p&gt;</comment>
                            <comment id="17627229" author="jbonofre" created="Tue, 1 Nov 2022 16:17:00 +0000"  >&lt;p&gt;I don&apos;t see where as ConsumerInfo is not store in the subscription. The change only use the ConsumerInfo &quot;one shot&quot; afair.&lt;/p&gt;

&lt;p&gt;Maybe I&apos;m missing something here. I did some simple tests without issue.&lt;/p&gt;

&lt;p&gt;Feel free to propose another way. Do you want me to rollback this change ?&lt;/p&gt;</comment>
                            <comment id="17627233" author="christopher.l.shannon" created="Tue, 1 Nov 2022 16:21:13 +0000"  >&lt;p&gt;I will be pushing up another change in 5 minutes, it causes a memory leak because ConsumerInfo can change when durables go offline and online again. &lt;/p&gt;</comment>
                            <comment id="17627235" author="tetlucas" created="Tue, 1 Nov 2022 16:23:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; I can have another look this evening. In the meantime, if you want me to revert this to unblock the 5.17.3 vote JB is working on I can do that.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17627242" author="christopher.l.shannon" created="Tue, 1 Nov 2022 16:36:53 +0000"  >&lt;p&gt;Also the other issue is composite destinations (which is why it was looking through all the subscriptions). There might be multiple subscriptions mapped to the same ConsumerInfo. I&apos;m reworking my commit to handle that too.&lt;/p&gt;</comment>
                            <comment id="17627243" author="christopher.l.shannon" created="Tue, 1 Nov 2022 16:37:20 +0000"  >&lt;p&gt;This needs more time, I would say revert it and then we can revisit for 5.17.4 with my new approach&lt;/p&gt;</comment>
                            <comment id="17627262" author="christopher.l.shannon" created="Tue, 1 Nov 2022 17:21:19 +0000"  >&lt;p&gt;I created a draft PR here: &lt;a href=&quot;https://github.com/apache/activemq/pull/928&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/928&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m still not sure if it will work entirely yet because of the fact that I think multiple subscriptions can be attached to one ConsumerInfo object (different destinations). I covered the composite case but not sure if there&apos;s other cases without looking at it more. But the fact that the previous commit was iterating through all subscriptions to find matching ConsumerInfo objects tells me that it&apos;s probably not always a 1 to 1 mapping but my assumption is that is only for Composite destinations so this will probably work.&lt;/p&gt;

&lt;p&gt;I have to step away for a bit but can look more later today. If you guys get a chance to look let me know what you think and how performance looks to you, etc.&lt;/p&gt;</comment>
                            <comment id="17627317" author="christopher.l.shannon" created="Tue, 1 Nov 2022 20:22:09 +0000"  >&lt;p&gt;PR updated and ready for review&lt;/p&gt;</comment>
                            <comment id="17628251" author="jira-bot" created="Thu, 3 Nov 2022 10:44:04 +0000"  >&lt;p&gt;Commit d46b74d674c2a67193bb95384290da266adf9a25 in activemq&apos;s branch refs/heads/main from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=d46b74d67&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=d46b74d67&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9107&quot; title=&quot;Closing many consumers causes CPU to spike to 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9107&quot;&gt;&lt;del&gt;AMQ-9107&lt;/del&gt;&lt;/a&gt; - rework performance improvement for consumer closing in&lt;br/&gt;
managed region broker&lt;/p&gt;

&lt;p&gt;This new approach just looks matching Subscriptions from the region for the&lt;br/&gt;
destination which prevents having to store another map and falls back to&lt;br/&gt;
the old approach if something went wrong.&lt;/p&gt;</comment>
                            <comment id="17628254" author="jira-bot" created="Thu, 3 Nov 2022 10:50:30 +0000"  >&lt;p&gt;Commit 2399c637b50eb867a1c7402eb4f9d4951122fd92 in activemq&apos;s branch refs/heads/activemq-5.16.x from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=2399c637b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=2399c637b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9107&quot; title=&quot;Closing many consumers causes CPU to spike to 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9107&quot;&gt;&lt;del&gt;AMQ-9107&lt;/del&gt;&lt;/a&gt; - rework performance improvement for consumer closing in&lt;br/&gt;
managed region broker&lt;/p&gt;

&lt;p&gt;This new approach just looks matching Subscriptions from the region for the&lt;br/&gt;
destination which prevents having to store another map and falls back to&lt;br/&gt;
the old approach if something went wrong.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit d46b74d674c2a67193bb95384290da266adf9a25)&lt;/p&gt;</comment>
                            <comment id="17628256" author="jira-bot" created="Thu, 3 Nov 2022 10:51:02 +0000"  >&lt;p&gt;Commit 8cc7a4545510197fe3074ed598a811bdef6bd5d8 in activemq&apos;s branch refs/heads/activemq-5.17.x from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=8cc7a4545&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=8cc7a4545&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9107&quot; title=&quot;Closing many consumers causes CPU to spike to 100%&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9107&quot;&gt;&lt;del&gt;AMQ-9107&lt;/del&gt;&lt;/a&gt; - rework performance improvement for consumer closing in&lt;br/&gt;
managed region broker&lt;/p&gt;

&lt;p&gt;This new approach just looks matching Subscriptions from the region for the&lt;br/&gt;
destination which prevents having to store another map and falls back to&lt;br/&gt;
the old approach if something went wrong.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit d46b74d674c2a67193bb95384290da266adf9a25)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13050131" name="example.zip" size="7602" author="tetlucas" created="Fri, 7 Oct 2022 07:12:45 +0000"/>
                            <attachment id="13050132" name="image-2022-10-07-00-12-39-657.png" size="91548" author="tetlucas" created="Fri, 7 Oct 2022 07:12:41 +0000"/>
                            <attachment id="13050130" name="image-2022-10-07-00-17-30-657.png" size="92317" author="tetlucas" created="Fri, 7 Oct 2022 07:17:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z19500:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>