<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:53:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-796] Client may shtudown when failover connection is reconnecting.  We need to maintain at least 1 non-daemon thread alive.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-796</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Dejan Reported on the User lists:&lt;/p&gt;

&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;after some experiments I found that this problem only exists if there are no&lt;br/&gt;
other threads in the application. It seems like connection thread dies&lt;br/&gt;
before it manages to reconnect. By starting another thread in the&lt;br/&gt;
application, it succeeds to recover from master failure and reconnect to the&lt;br/&gt;
slave broker. So I have a workaround for now, but it would be nice to make&lt;br/&gt;
this work even for simple (single-threaded) clients.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Dejan&lt;/p&gt;</description>
                <environment></environment>
        <key id="12483294">AMQ-796</key>
            <summary>Client may shtudown when failover connection is reconnecting.  We need to maintain at least 1 non-daemon thread alive.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="chirino">Hiram R. Chirino</reporter>
                        <labels>
                    </labels>
                <created>Wed, 5 Jul 2006 20:28:16 +0000</created>
                <updated>Fri, 26 Apr 2024 00:45:36 +0000</updated>
                            <resolved>Wed, 18 Apr 2012 10:53:06 +0000</resolved>
                                    <version>4.0</version>
                    <version>5.3.0</version>
                                    <fixVersion>5.6.0</fixVersion>
                    <fixVersion>4.0.3</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="12939189" author="chirino" created="Tue, 23 Oct 2007 13:37:04 +0000"  >&lt;p&gt;Fix in rev 587504&lt;/p&gt;

&lt;p&gt;   The threads associated with the session are now setup to be non-daemon so that if you &lt;br/&gt;
   setup a MessageListener and let the main thread exit, your program will not terminate&lt;br/&gt;
   if there are no active transport threads which is the case when the failover transport&lt;br/&gt;
   is in the middle of reconnecting to a broker.&lt;/p&gt;</comment>
                            <comment id="12942311" author="dejanb" created="Tue, 9 Mar 2010 09:58:13 +0000"  >&lt;p&gt;This issue occurs again on the trunk&lt;/p&gt;</comment>
                            <comment id="12942552" author="garyw" created="Thu, 29 Apr 2010 00:01:25 +0000"  >&lt;p&gt;This is a Windows cmd script that uses 2 instances of the ProducerTool sample app to create 2 embedded brokers, and the single-threaded ConsumerTool with a failover URI to demonstrate the problem.&lt;/p&gt;</comment>
                            <comment id="12943317" author="jim_mccabe" created="Thu, 6 May 2010 15:23:31 +0000"  >&lt;p&gt;The solution to this should be simple - just make sure the thread that performs the failover logic does NOT call setDaemon(true).&lt;/p&gt;

&lt;p&gt;Since this bug was fixed three years ago and came back to life, it would be nice if the code took more steps to prevent this from happening in the future, for example:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Override setDaemon(boolean) on that thread so that it never allows itself to be flagged as a daemon.  If it is called in that way, output a stack trace with a message specifically refering to this bug (&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-796&quot; title=&quot;Client may shtudown when failover connection is reconnecting.  We need to maintain at least 1 non-daemon thread alive.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-796&quot;&gt;&lt;del&gt;AMQ-796&lt;/del&gt;&lt;/a&gt;).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Add unit tests that would fail if another part of the code set the failover thread as a daemon.  This seems like it would be a lot harder than the override approach above, but would be nice if it were possible.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13256433" author="rajdavies" created="Wed, 18 Apr 2012 10:53:06 +0000"  >&lt;p&gt;Fixed by Subversion: Committed revision 1327443&lt;/p&gt;</comment>
                            <comment id="13416134" author="xbhanu" created="Tue, 17 Jul 2012 12:24:37 +0000"  >&lt;p&gt;This issue still persists. attaching the jstack on broker. It still doesn&apos;t show any non-daemon thread which would have fixed the issue i guess.&lt;/p&gt;</comment>
                            <comment id="13540358" author="kimmking" created="Fri, 28 Dec 2012 06:29:26 +0000"  >&lt;p&gt;This issue occurs again on the trunk and Version 5.7.0.&lt;br/&gt;
Using:&lt;br/&gt;
1. start a broker in command line&lt;br/&gt;
2. create and run a connection with a consumer and TransportListener(for track reconnecting) in eclipse&lt;br/&gt;
3. stop the broker and restart the broker&lt;br/&gt;
4. then we can see client transportInterupted and transportResumed&lt;br/&gt;
5. stop the broker again &lt;br/&gt;
6. the client process will quit!!!&lt;/p&gt;

&lt;p&gt;The early fix for this bug is to remove daemon=true on ActiveMQ Connection Executor,&lt;br/&gt;
but sometimes this executor does not create new thread.&lt;/p&gt;

&lt;p&gt;The solution is to make the reconnectTask thread is non-daemon:&lt;br/&gt;
// FailoverTransport.java row: 132 &lt;br/&gt;
reconnectTaskFactory = new TaskRunnerFactory();&lt;br/&gt;
reconnectTaskFactory.setDaemon(false); // to set daemon=false by kimmking&lt;br/&gt;
reconnectTaskFactory.init();&lt;/p&gt;

&lt;p&gt;After the fix, the reconnecting of this client works well during broker&apos;s stop for many times.&lt;/p&gt;</comment>
                            <comment id="13540366" author="wangyin" created="Fri, 28 Dec 2012 06:36:44 +0000"  >&lt;p&gt;We just found that non-daemon thread for the executor in the connection may not fix this issue.&lt;br/&gt;
The executor in the connection is used to async take action when internal exceptions occur.&lt;br/&gt;
If no internal exceptions the executor will not be initiated by filling up with non-daemon threads.&lt;br/&gt;
In this case client still can shutdown when failover connection is reconnecting &lt;br/&gt;
because non-daemon threads do not exist in JVM .&lt;br/&gt;
One simple solution is to keep the thread attached with the reconnectTask non-daemon.&lt;/p&gt;</comment>
                            <comment id="13540371" author="kimmking" created="Fri, 28 Dec 2012 06:52:47 +0000"  >&lt;p&gt;Another suggestion, named the reconnectTask thread&#65306;&lt;br/&gt;
reconnectTaskFactory = new TaskRunnerFactory();&lt;br/&gt;
in FailoverTransport.java line 132 is modified to &lt;br/&gt;
reconnectTaskFactory = new TaskRunnerFactory(&quot;FailoverTransport-ReconnectTask&quot;);&lt;/p&gt;</comment>
                            <comment id="13543778" author="fdegir" created="Fri, 4 Jan 2013 10:44:40 +0000"  >&lt;p&gt;We see same behaviour with our simple producer/consumer with 5.7.0. If we attach TransportListener to consumer then things work fine.&lt;br/&gt;
Poducer doesn&apos;t have issues as noted by others.&lt;/p&gt;</comment>
                            <comment id="13789122" author="xbhanu" created="Tue, 8 Oct 2013 11:27:56 +0000"  >&lt;p&gt;Still an issue with ActiveMQ v5.8 !!  Can somebody resolve this please...&lt;/p&gt;</comment>
                            <comment id="13789133" author="xbhanu" created="Tue, 8 Oct 2013 11:35:33 +0000"  >&lt;p&gt;Attaching the jstack output for v5.8. The only non-daemon thread is the main thread which I stopped from exiting only for the purpose of taking a jstack snapshot.&lt;/p&gt;</comment>
                            <comment id="13789264" author="johnbing" created="Tue, 8 Oct 2013 15:01:26 +0000"  >&lt;p&gt;This is really very strange since the creation time for this issue is 2006. Is it really this tough to make the relevant thread non-daemon?&lt;/p&gt;</comment>
                            <comment id="13790377" author="xbhanu" created="Wed, 9 Oct 2013 14:16:00 +0000"  >&lt;p&gt;Ping! Any updates here ?&lt;/p&gt;</comment>
                            <comment id="13790387" author="tabish121" created="Wed, 9 Oct 2013 14:25:38 +0000"  >&lt;p&gt;Use a 5.9-SNAPSHOT, should get you sorted. &lt;/p&gt;</comment>
                            <comment id="15445717" author="babramson" created="Mon, 29 Aug 2016 12:25:29 +0000"  >&lt;p&gt;This issue still seem to exists with client version 5.14.0 using a MessageListener and single threaded application. The reconnect tasks are still daemon threads.&lt;/p&gt;

&lt;p&gt;Thread output:&lt;/p&gt;

&lt;p&gt;&quot;ActiveMQ Task-2&quot; #14 daemon prio=5 os_prio=0 tid=0x000000001e616000 nid=0x11b4 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x000000001f5cf000&amp;#93;&lt;/span&gt;&lt;br/&gt;
&quot;ActiveMQ Task-1&quot; #11 daemon prio=5 os_prio=0 tid=0x000000001e3df000 nid=0x7cc waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x000000001ef8e000&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Cause:&lt;/p&gt;

&lt;p&gt;When the FailoverTransport is created the associated task runner will have daemon = true set. Code path:&lt;/p&gt;

&lt;p&gt;FailoverTransport.java: &lt;/p&gt;

&lt;p&gt; 136         reconnectTaskFactory = new TaskRunnerFactory();&lt;br/&gt;
 137         reconnectTaskFactory.init();&lt;/p&gt;


&lt;p&gt;TaskRunnerFactory.java:&lt;/p&gt;

&lt;p&gt;  58     public TaskRunnerFactory() &lt;/p&gt;
{
  59         this(&quot;ActiveMQ Task&quot;);
  60     }
&lt;p&gt;  61 &lt;br/&gt;
  62     public TaskRunnerFactory(String name) &lt;/p&gt;
{
  63         this(name, Thread.NORM_PRIORITY, true, 1000);
  64     }

&lt;p&gt;The third parameter (daemon = true) is the culpit. &lt;/p&gt;

&lt;p&gt;It seems that the simplest solution is what has been suggested previously, explicitly setting daemon = false on the reconnect factory:&lt;/p&gt;

&lt;p&gt;reconnectTaskFactory.setDaemon(false);&lt;/p&gt;

</comment>
                            <comment id="15814130" author="tuodi" created="Tue, 10 Jan 2017 07:01:46 +0000"  >&lt;p&gt;Yes,we have the some problem in activemq 5.10.0 and 5.13.4. we use failover tcp protocol like:&lt;br/&gt;
failover://(tcp://127.0.0.1:61624,tcp://127.0.0.1:61626)?nested.wireFormat.maxInactivityDuration=3000&amp;amp;nested.connectionTimeout=2000&amp;amp;maxReconnectAttempts=2&amp;amp;timeout=2000&amp;amp;randomize=false&amp;amp;initialReconnectDelay=50&amp;amp;startupMaxReconnectAttempts=2&amp;amp;maxReconnectDelay=100&lt;/p&gt;

&lt;p&gt;first keep all Mq server up&lt;br/&gt;
then shutdown one of the server&lt;br/&gt;
see the log keep create a new connection on the up server and then closed the new connection and the recreate a new connection on the up server ...... dead loop....&lt;/p&gt;

&lt;p&gt;threaddump the thread and see the threadDump.txt and the test code Sender.java in the attach file.&lt;/p&gt;

&lt;p&gt;&quot;ActiveMQ Task-1&quot; daemon prio=6 tid=0x000000000d5c3800 nid=0x2bc8 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x000000000dc2e000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: TIMED_WAITING (parking)&lt;br/&gt;
	at sun.misc.Unsafe.park(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;parking to wait for  &amp;lt;0x00000000db305ec8&amp;gt; (a java.util.concurrent.CountDownLatch$Sync)&lt;br/&gt;
	at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:226)&lt;br/&gt;
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedNanos(AbstractQueuedSynchronizer.java:1033)&lt;br/&gt;
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.tryAcquireSharedNanos(AbstractQueuedSynchronizer.java:1326)&lt;br/&gt;
	at java.util.concurrent.CountDownLatch.await(CountDownLatch.java:282)&lt;br/&gt;
	at org.apache.activemq.transport.WireFormatNegotiator.oneway(WireFormatNegotiator.java:97)&lt;br/&gt;
	at org.apache.activemq.transport.failover.FailoverTransport.restoreTransport(FailoverTransport.java:841)&lt;br/&gt;
	at org.apache.activemq.transport.failover.FailoverTransport.doReconnect(FailoverTransport.java:1020)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x0000000090c6a228&amp;gt; (a java.lang.Object)&lt;br/&gt;
	at org.apache.activemq.transport.failover.FailoverTransport$2.iterate(FailoverTransport.java:148)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x0000000090c6a238&amp;gt; (a java.lang.Object)&lt;br/&gt;
	at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:133)&lt;br/&gt;
	at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:48)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16659079" author="siick" created="Mon, 22 Oct 2018 15:20:21 +0000"  >&lt;p&gt;Just a small reminder to tells that this issue is still in 5.12.1.&lt;/p&gt;

&lt;p&gt;Adding these in FailoverTransport.class fix the issue like &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kimmking&quot; class=&quot;user-hover&quot; rel=&quot;kimmking&quot;&gt;kimmking&lt;/a&gt; said before..&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
reconnectTaskFactory = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TaskRunnerFactory();
reconnectTaskFactory.setDaemon(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// to set daemon=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; by kimmking
&lt;/span&gt;reconnectTaskFactory.init();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If i look that Jira this issue is solved from 5.6.0 but we are a lot here to explain that it is not corrected because we have to edit FailoverTRansport.class by ourselves. So he&apos;s it the only workaround for now or maybe is resolved in the last version?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17841007" author="JIRAUSER305156" created="Fri, 26 Apr 2024 00:44:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9483&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-9483&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I put a patch on this ticket to fix this issue. I concur that it is not fixed in master.&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                                                <inwardlinks description="is fixed by">
                                        <issuelink>
            <issuekey id="13576529">AMQ-9483</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12461686" name="AMQ-796.cmd" size="1336" author="garyw" created="Thu, 29 Apr 2010 00:01:25 +0000"/>
                            <attachment id="12846507" name="Sender.java" size="2188" author="TuoDi" created="Tue, 10 Jan 2017 07:05:20 +0000"/>
                            <attachment id="12536809" name="jstack_amq_5.6.0" size="20325" author="xbhanu" created="Tue, 17 Jul 2012 12:23:33 +0000"/>
                            <attachment id="12607348" name="jstack_v5.8.0" size="7121" author="xbhanu" created="Tue, 8 Oct 2013 11:35:33 +0000"/>
                            <attachment id="12846506" name="threadDump.txt" size="30589" author="TuoDi" created="Tue, 10 Jan 2017 07:05:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84328</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 28 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0akxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59663</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>