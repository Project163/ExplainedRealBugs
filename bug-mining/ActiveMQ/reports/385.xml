<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:37:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1795] in use data files removed from data store under load</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1795</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Under load, I see the error below.&lt;/p&gt;

&lt;p&gt;the problem is that org.apache.activemq.store.amq.AMQPersistenceAdapter.cleanup() does not capture all of the in use files.&lt;br/&gt;
I have made some changes that improves the situation but there is still a window, that seems to be related to spooling messages when a memory limit is reached.&lt;/p&gt;


&lt;p&gt;2008-06-12 14:55:16,689 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  BrokerService                  - Using Persistence Adapter: AMQPersistenceAdapter(activemq-data\localhost)&lt;br/&gt;
2008-06-12 14:55:16,704 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  AMQPersistenceAdapter          - AMQStore starting using directory: activemq-data\localhost&lt;br/&gt;
2008-06-12 14:55:17,361 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  AMQPersistenceAdapter          - Journal deleted: &lt;br/&gt;
2008-06-12 14:55:17,361 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  KahaStore                      - Kaha Store successfully deleted data directory activemq-data\localhost\kr-store\data&lt;br/&gt;
2008-06-12 14:55:17,392 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  KahaStore                      - Kaha Store successfully deleted data directory activemq-data\localhost\kr-store\state&lt;br/&gt;
2008-06-12 14:55:17,392 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  KahaStore                      - Kaha Store using data directory activemq-data\localhost\kr-store\state&lt;br/&gt;
2008-06-12 14:55:17,470 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  AMQPersistenceAdapter          - Active data files: []&lt;br/&gt;
2008-06-12 14:55:17,705 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  BrokerService                  - ActiveMQ null JMS Message Broker (localhost) is starting&lt;br/&gt;
2008-06-12 14:55:17,705 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  BrokerService                  - For help or more information please see: &lt;a href=&quot;http://activemq.apache.org/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/&lt;/a&gt;&lt;br/&gt;
2008-06-12 14:55:17,814 &lt;span class=&quot;error&quot;&gt;&amp;#91;JMX connector  &amp;#93;&lt;/span&gt; INFO  ManagementContext              - JMX consoles can connect to service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi&lt;br/&gt;
2008-06-12 14:55:17,924 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  KahaStore                      - Kaha Store using data directory activemq-data\localhost\kr-store\data&lt;br/&gt;
2008-06-12 14:55:17,939 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  TransportServerThreadSupport   - Listening for connections at: tcp://salthill:61616&lt;br/&gt;
2008-06-12 14:55:17,939 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  TransportConnector             - Connector Default Started&lt;br/&gt;
2008-06-12 14:55:17,939 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  BrokerService                  - ActiveMQ JMS Message Broker (localhost, ID:salthill-2790-1213278917752-0:0) started&lt;br/&gt;
2008-06-12 14:55:17,939 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  MissingDataFileTest            - Starting broker..&lt;br/&gt;
2008-06-12 14:55:58,516 &lt;span class=&quot;error&quot;&gt;&amp;#91;age Thread Pool&amp;#93;&lt;/span&gt; ERROR AsyncDataManager               - Looking for key 551 but not found in fileMap: &lt;/p&gt;
{1014=data-1014 number = 1014 , length = 1960 refCount = 6, 607=data-607 number = 607 , length = 1266 refCount = 1, 928=data-928 number = 928 , .. .. 622 , length = 1352 refCount = 2, 328=data-328 number = 328 , length = 1266 refCount = 1, 256=data-256 number = 256 , length = 1264 refCount = 1, 92=data-92 number = 92 , length = 1264 refCount = 1, 404=data-404 number = 404 , length = 1266 refCount = 1}
&lt;p&gt;2008-06-12 14:55:58,563 &lt;span class=&quot;error&quot;&gt;&amp;#91;age Thread Pool&amp;#93;&lt;/span&gt; ERROR AbstractStoreCursor            - Failed to fill batch&lt;br/&gt;
java.io.IOException: Failed to read to journal for: offset = 0, file = 551, size = &lt;del&gt;1, type = 0. Reason: java.io.IOException: Could not locate data file data&lt;/del&gt;-551&lt;br/&gt;
	at org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:33)&lt;br/&gt;
	at org.apache.activemq.store.amq.AMQPersistenceAdapter.createReadException(AMQPersistenceAdapter.java:635)&lt;br/&gt;
	at org.apache.activemq.store.amq.AMQPersistenceAdapter.readCommand(AMQPersistenceAdapter.java:521)&lt;br/&gt;
	at org.apache.activemq.store.amq.AMQMessageStore.getMessage(AMQMessageStore.java:432)&lt;br/&gt;
	at org.apache.activemq.store.amq.RecoveryListenerAdapter.recoverMessageReference(RecoveryListenerAdapter.java:54)&lt;br/&gt;
	at org.apache.activemq.store.kahadaptor.KahaReferenceStore.recoverReference(KahaReferenceStore.java:82)&lt;br/&gt;
	at org.apache.activemq.store.kahadaptor.KahaReferenceStore.recoverNextMessages(KahaReferenceStore.java:120)&lt;br/&gt;
	at org.apache.activemq.store.amq.AMQMessageStore.recoverNextMessages(AMQMessageStore.java:530)&lt;br/&gt;
	at org.apache.activemq.broker.region.cursors.QueueStorePrefetch.doFillBatch(QueueStorePrefetch.java:75)&lt;br/&gt;
	at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:188)&lt;br/&gt;
	at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.onUsageChanged(AbstractStoreCursor.java:157)&lt;br/&gt;
	at org.apache.activemq.usage.Usage$1.run(Usage.java:266)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:595)&lt;br/&gt;
Caused by: java.io.IOException: Could not locate data file data--551&lt;br/&gt;
	at org.apache.activemq.kaha.impl.async.AsyncDataManager.getDataFile(AsyncDataManager.java:303)&lt;br/&gt;
	at org.apache.activemq.kaha.impl.async.AsyncDataManager.read(AsyncDataManager.java:613)&lt;br/&gt;
	at org.apache.activemq.store.amq.AMQPersistenceAdapter.readCommand(AMQPersistenceAdapter.java:518)&lt;br/&gt;
	... 12 more&lt;br/&gt;
2008-06-12 14:55:58,563 &lt;span class=&quot;error&quot;&gt;&amp;#91;age Thread Pool&amp;#93;&lt;/span&gt; ERROR AbstractStoreCursor            - Failed to fill batch &lt;br/&gt;
java.lang.RuntimeException: java.io.IOException: Failed to read to journal for: offset = 0, file = 551, size = &lt;del&gt;1, type = 0. Reason: java.io.IOException: Could not locate data file data&lt;/del&gt;-551&lt;br/&gt;
	at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:191)&lt;br/&gt;
	at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.onUsageChanged(AbstractStoreCursor.java:157)&lt;br/&gt;
	at org.apache.activemq.usage.Usage$1.run(Usage.java:266)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:595)&lt;br/&gt;
Caused by: java.io.IOException: Failed to read to journal for: offset = 0, file = 551, size = &lt;del&gt;1, type = 0. Reason: java.io.IOException: Could not locate data file data&lt;/del&gt;-551&lt;br/&gt;
	at org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:33)&lt;br/&gt;
	at org.apache.activemq.store.amq.AMQPersistenceAdapter.createReadException(AMQPersistenceAdapter.java:635)&lt;br/&gt;
	at org.apache.activemq.store.amq.AMQPersistenceAdapter.readCommand(AMQPersistenceAdapter.java:521)&lt;br/&gt;
	at org.apache.activemq.store.amq.AMQMessageStore.getMessage(AMQMessageStore.java:432)&lt;br/&gt;
	at org.apache.activemq.store.amq.RecoveryListenerAdapter.recoverMessageReference(RecoveryListenerAdapter.java:54)&lt;br/&gt;
	at org.apache.activemq.store.kahadaptor.KahaReferenceStore.recoverReference(KahaReferenceStore.java:82)&lt;br/&gt;
	at org.apache.activemq.store.kahadaptor.KahaReferenceStore.recoverNextMessages(KahaReferenceStore.java:120)&lt;br/&gt;
	at org.apache.activemq.store.amq.AMQMessageStore.recoverNextMessages(AMQMessageStore.java:530)&lt;br/&gt;
	at org.apache.activemq.broker.region.cursors.QueueStorePrefetch.doFillBatch(QueueStorePrefetch.java:75)&lt;br/&gt;
	at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:188)&lt;br/&gt;
	... 5 more&lt;br/&gt;
Caused by: java.io.IOException: Could not locate data file data--551&lt;br/&gt;
	at org.apache.activemq.kaha.impl.async.AsyncDataManager.getDataFile(AsyncDataManager.java:303)&lt;br/&gt;
	at org.apache.activemq.kaha.impl.async.AsyncDataManager.read(AsyncDataManager.java:613)&lt;br/&gt;
	at org.apache.activemq.store.amq.AMQPersistenceAdapter.readCommand(AMQPersistenceAdapter.java:518)&lt;br/&gt;
	... 12 more&lt;br/&gt;
2008-06-12 15:00:18,531 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  BrokerService                  - ActiveMQ Message Broker (localhost, ID:salthill-2790-1213278917752-0:0) is shutting down&lt;br/&gt;
2008-06-12 15:00:20,438 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  TransportConnector             - Connector Default Stopped&lt;br/&gt;
2008-06-12 15:00:20,641 &lt;span class=&quot;error&quot;&gt;&amp;#91;main           &amp;#93;&lt;/span&gt; INFO  BrokerService                  - ActiveMQ JMS Message Broker (localhost, ID:salthill-2790-1213278917752-0:0) stopped&lt;/p&gt;</description>
                <environment>&lt;p&gt;all&lt;/p&gt;</environment>
        <key id="12482433">AMQ-1795</key>
            <summary>in use data files removed from data store under load</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                            <parent id="12482554">AMQ-1786</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="gtully">Gary Tully</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Jun 2008 14:12:11 +0000</created>
                <updated>Fri, 11 Jul 2008 16:22:54 +0000</updated>
                            <resolved>Thu, 10 Jul 2008 15:29:54 +0000</resolved>
                                    <version>5.1.0</version>
                                    <fixVersion>5.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12939793" author="gtully" created="Thu, 12 Jun 2008 14:18:13 +0000"  >&lt;p&gt;MissingDataFileTest shows the problem.&lt;/p&gt;

&lt;p&gt;There is a fix to cleanup to reference the inuse transaction files using checkpoint.&lt;br/&gt;
also checkpoint is fixed up to return the minimum file in use.&lt;/p&gt;

&lt;p&gt;of note also is AsyncDataManager removal of files that are not inUse. This capability seems to be bsolete but yet I see it remove a file on occasion.&lt;/p&gt;</comment>
                            <comment id="12939830" author="gtully" created="Thu, 12 Jun 2008 14:23:37 +0000"  >&lt;p&gt;note, I had to reduce the store maxFileSize and the cleanup interval to make the test reproduceable. This meant exposing the cleanupInterfal to the persistenceAdapterFactory.&lt;/p&gt;

&lt;p&gt;        AMQPersistenceAdapterFactory factory = (AMQPersistenceAdapterFactory) broker.getPersistenceFactory();&lt;br/&gt;
        factory.setMaxFileLength(2*1024); // ~4 messages&lt;br/&gt;
        factory.setCleanupInterval(5000); // every few second&lt;/p&gt;</comment>
                            <comment id="12939798" author="rajdavies" created="Thu, 12 Jun 2008 14:36:22 +0000"  >&lt;p&gt;Resolved by revision 667105&lt;/p&gt;</comment>
                            <comment id="12939778" author="gtully" created="Thu, 12 Jun 2008 14:51:44 +0000"  >&lt;p&gt;remove some unnecessary info from the description&lt;/p&gt;</comment>
                            <comment id="12939799" author="gtully" created="Thu, 12 Jun 2008 16:01:57 +0000"  >&lt;p&gt;still needs work&lt;/p&gt;</comment>
                            <comment id="12939836" author="gtully" created="Tue, 17 Jun 2008 10:42:10 +0000"  >&lt;p&gt;Still having problems with this:&lt;/p&gt;

&lt;p&gt;I find that the following change helps but is not bulit proof. I think it makes sense to use the mark as the boundary point for deletion but on a slower machine the MissingDataFileTest still shows the error stack trace. A multi core machine does not show the problem.&lt;br/&gt;
Also, the test case only complets when the memory usage limit is omitted or increased to 1024*1024 which may indicate a limitation of the test case. Decreasing the memory usage caused the problem to show up earlier, which does not now seem to be the case. So there is some progress.&lt;/p&gt;

&lt;p&gt;The short of it is that collection of inUse file Ids is not sufficiently stable for the cleanup method. I still do not know where the problem lies though. I need another set of eyes.&lt;/p&gt;

&lt;p&gt;Index: src/main/java/org/apache/activemq/store/amq/AMQPersistenceAdapter.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; src/main/java/org/apache/activemq/store/amq/AMQPersistenceAdapter.java      (revision 668601)&lt;br/&gt;
+++ src/main/java/org/apache/activemq/store/amq/AMQPersistenceAdapter.java      (working copy)&lt;br/&gt;
@@ -425,6 +425,7 @@&lt;br/&gt;
             }&lt;br/&gt;
             Integer lastDataFile = asyncDataManager.getCurrentDataFileId();&lt;br/&gt;
             inProgress.add(lastDataFile);&lt;br/&gt;
+            lastDataFile = asyncDataManager.getMark().getDataFileId();&lt;br/&gt;
             inProgress.addAll(referenceStoreAdapter.getReferenceFileIdsInUse());&lt;br/&gt;
             Location lastActiveTx = transactionStore.checkpoint();&lt;br/&gt;
             if (lastActiveTx != null) {&lt;/p&gt;</comment>
                            <comment id="12939824" author="gtully" created="Tue, 17 Jun 2008 10:59:42 +0000"  >&lt;p&gt;changes that work well on a fast machine to alleviate the stack trace. I still see the error on a slower machine however. test works to completion with the changed memory limit.&lt;/p&gt;</comment>
                            <comment id="12939841" author="rajdavies" created="Wed, 18 Jun 2008 19:35:08 +0000"  >&lt;p&gt;Further patch applied by SVN revision 669265&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461145" name="AMQ-1795.further_improvement" size="1760" author="gtully" created="Tue, 17 Jun 2008 10:59:42 +0000"/>
                            <attachment id="12461163" name="AMQ-1795.test_and_partial_fix" size="24428" author="gtully" created="Thu, 12 Jun 2008 14:18:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84767</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 23 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0tt13:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>172012</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>