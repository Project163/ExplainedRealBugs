<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:39:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1918] AbstractStoreCursor.size gets out of synch with Store size and blocks consumers</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1918</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;In version 5.1.0, we are seeing our queue consumers stop consuming for no reason.&lt;br/&gt;
We have a staged queue environment and we occasionally see one queue display negative pending message counts that hang around -x, rise to -x+n gradually and then fall back to -x abruptly. The messages are building up and being processed in bunches but its not easy to see because the counts are negative. We see this behavior in the messages coming out of the system. Outbound messages come out in bunches and are synchronized with the queue pending count dropping to -x.&lt;/p&gt;

&lt;p&gt;This issue does not happen ALL of the time. It happens about once a week and the only way to fix it is to bounce the broker. It doesn&apos;t happen to the same queue everytime, so it is not our consuming code.&lt;/p&gt;

&lt;p&gt;Although we don&apos;t have a reproducible scenario, we have been able to debug the issue in our test environment.&lt;br/&gt;
We traced the problem to the cached store size in the AbstractStoreCursor.&lt;br/&gt;
This value becomes 0 or negative and prevents the AbstractStoreCursor from retrieving more messages from the store. (see AbstractStoreCursor.fillBatch() )&lt;br/&gt;
We have seen size value go lower than -1000.&lt;br/&gt;
We have also forced it to fix itself by sending in n+1 messages. Once the size goes above zero, the cached value is refreshed and things work ok again.&lt;br/&gt;
Unfortunately, during low volume times, it could be hours before n+1 messages are received, so our message latency can rise during low volume times.... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I have attached our broker config.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12482815">AMQ-1918</key>
            <summary>AbstractStoreCursor.size gets out of synch with Store size and blocks consumers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="ryarger">Richard Yarger</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Aug 2008 14:28:55 +0000</created>
                <updated>Tue, 26 May 2009 08:50:28 +0000</updated>
                            <resolved>Tue, 26 May 2009 08:50:28 +0000</resolved>
                                    <version>5.1.0</version>
                                    <fixVersion>5.3.0</fixVersion>
                                    <component>Message Store</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="12940110" author="ryarger" created="Thu, 28 Aug 2008 22:13:06 +0000"  >&lt;p&gt;I have a reproducible scenario for this issue.&lt;br/&gt;
I cannot guarantee that this is how it always happens, but AbstractStoreCursor.size does go negative everytime I follow this procedure.&lt;br/&gt;
I am sorry I could not make it into a nice little test case. I tried to break it down as best I could.&lt;/p&gt;

&lt;p&gt;I wrapped up my eclipse project. It has 2 consumers, and 2 producers.&lt;br/&gt;
producer_flood sends a larger number of messages to test.queue.1 every 3 seconds&lt;br/&gt;
producer_steady sends a small number of messages to test.queue.1 every 3 seconds&lt;br/&gt;
consumer1 consumes messages off test.queue.1 and forwards them to test.queue.2&lt;br/&gt;
consumer2 consumes messages off test.queue.2 and prints text to system.out&lt;br/&gt;
My broker config file is included in the amq_broker_config dir. It sets the memory limits low so that they can be reached faster.&lt;br/&gt;
The queues are setup for 1MB each and the broker is setup for 3MB.&lt;/p&gt;

&lt;p&gt;Here is the script:&lt;br/&gt;
1) Start a clean broker&lt;br/&gt;
2) Start consumer1 and consumer2&lt;br/&gt;
3) Start producer_flood - this will push messages in faster than consumer1 can handle. &lt;br/&gt;
Let the queue size build up to 1000 messages. This should be 100% of the 1MB allowed for that queue.&lt;br/&gt;
4) Stop consumer2 - this will allow messages to build up in queue2. &lt;br/&gt;
If you watch this queue in a jconsole, you will notice that the percent memory used does not rise, even after you pass the memory limit.&lt;br/&gt;
Let the queue2 size grow to around 2000.&lt;br/&gt;
This will put you near the memory limit for the broker.&lt;br/&gt;
5) Start consumer2 - if you look at jconsole now, the percent memory used is updated and &amp;gt; 100%.&lt;br/&gt;
6) Wait for queue2 to fall below 1000 messages and stop the producer. Let the messages drain and one or both of the queues should now have negative counts. &lt;br/&gt;
7) If you start the producer_steady now you&apos;ll notice that messages do not reach consumer2 at the rate that they go in.&lt;br/&gt;
	If you debug the broker now and look at AbstractStoreCursor.size, it will be negative. &lt;/p&gt;

&lt;p&gt;Please let me know if you need more info.&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="12940114" author="ryarger" created="Thu, 28 Aug 2008 22:16:46 +0000"  >&lt;p&gt;eclipse project with test files&lt;/p&gt;</comment>
                            <comment id="12940133" author="rajdavies" created="Thu, 4 Sep 2008 14:34:24 +0000"  >&lt;p&gt;Thanks Richard - I can&apos;t reproduce on Trunk - so I&apos;m going to mark it fixed in 5.2 - if its still a problem - reopen and I&apos;ll investigate further&lt;/p&gt;</comment>
                            <comment id="12940121" author="ryarger" created="Thu, 4 Sep 2008 15:11:03 +0000"  >&lt;p&gt;I tested with apache-activemq-5.2-20080903.231704-53 and was able to reproduce problem.&lt;br/&gt;
Is there much code difference between yesterday&apos;s snapshot on trunk?&lt;br/&gt;
I&apos;ll try the snapshot tomorrow to be sure.&lt;/p&gt;

&lt;p&gt;Did you happen to try the scenario against 5.1? If so, were you able to reproduce?&lt;/p&gt;</comment>
                            <comment id="12940177" author="ryarger" created="Fri, 5 Sep 2008 15:55:37 +0000"  >&lt;p&gt;I tested the same scenario against activemq-5.2-SNAPSHOT-20080904.231544-55.&lt;br/&gt;
I was able to reproduce the error.&lt;br/&gt;
Is it possible the code you test on trunk was different than what is in the snapshots?&lt;/p&gt;
</comment>
                            <comment id="12940231" author="rajdavies" created="Tue, 23 Sep 2008 05:34:40 +0000"  >&lt;p&gt;This is a timing issue - so its been difficult for me to reproduce on any version. I&apos;ll try get a slower box&lt;/p&gt;</comment>
                            <comment id="12940248" author="nic.tanase" created="Wed, 24 Sep 2008 10:59:24 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;You can use the test cases from the attached archive to reproduce the problem.&lt;br/&gt;
jmeterjms_nic-1.0.jar - modified version of the existing JMS sampler from JMeter project&lt;br/&gt;
JMS Request Only.jmx - test plan for sender&lt;br/&gt;
JMS Receive Only.jmx - test plan for receiver.&lt;br/&gt;
You need to use version 2.3.3 of Jmeter and replace ApacheJMeter_jms.jar with the modified one.&lt;/p&gt;

&lt;p&gt;Sampler code is not closing the connections, so you need to restart Jmeter clients between tests.&lt;br/&gt;
I hope the JMS sampler will make testing easier.&lt;/p&gt;

&lt;p&gt;I consistently get the following problem, using the attached test cases (actual figures may vary).&lt;br/&gt;
The broker is configured to use Oracle10 for persistence. I have created a trigger that copies the records deleted from ACTIVEMQ_MSGS into ACTIVEMQ_HISTORY table so I can see what has been produced and consumed at the persistence layer.&lt;/p&gt;


&lt;p&gt;1. Start Jmeter with 3 producer threads each sending 3333 messages&lt;br/&gt;
2. Start Jmeter with a consumer thread.&lt;br/&gt;
3. Let the producers finish (9999 messages sent to the broker)&lt;br/&gt;
4. Wait for consumer to fetch all 9999 messages.&lt;br/&gt;
5. Consumer stops receiving after 9860 messages (as reported by Jmeter Summary Report).&lt;br/&gt;
6. Table ACTIVEMQ_MSGS contains 304 messages.&lt;br/&gt;
7. Table ACTIVEMQ_HISTORY contains 9695 messages.&lt;br/&gt;
8. JMX statistics show that the queue contains 139 messages.&lt;br/&gt;
9. Trying to browse the queue via JConsole does not return any messages.&lt;/p&gt;

&lt;p&gt;Nic&lt;/p&gt;
</comment>
                            <comment id="12940278" author="nic.tanase" created="Fri, 26 Sep 2008 11:05:56 +0000"  >&lt;p&gt;I found a way to work around this issue, by changing the way messages are loaded from the database.&lt;br/&gt;
I ran tests with several queues, producers and consumers and did not get any undelivered messages anymore.&lt;/p&gt;

&lt;p&gt;DefaultJDBCAdapter.doRecoverNextMessages() recovers the messages with ID higher then the last recovered messages.&lt;br/&gt;
The SQL statement is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;org.apache.activemq.store.jdbc.Statements.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;findNextMessagesStatement = &lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT ID, MSG FROM &quot;&lt;/span&gt; + getFullMessageTableName()
                                        + &lt;span class=&quot;code-quote&quot;&gt;&quot; WHERE CONTAINER=? AND ID &amp;gt; ? ORDER BY ID&quot;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;However, it can happen that messages with lower id are inserted into the DB after messages with higher IDs. &lt;br/&gt;
Such messages do not get recovered from DB.&lt;/p&gt;

&lt;p&gt;I have changed on my local copy the DefaultJDBCAdapter to act retroactive, looking back &lt;tt&gt;maxReturned&lt;/tt&gt; rows for any missed messages.&lt;br/&gt;
Anyway, I am not familiar with ActiveMQ code, so you might want to have a look at the modified DefaultJDBCAdapter.doRecoverNextMessages() bellow:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;org.apache.activemq.store.jdbc.adapter.DefaultJDBCAdapter.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DefaultJDBCAdapter &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; JDBCAdapter {

   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; lastRecoveredMessagesIds = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TreeSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;();
   -------------------------------------------------------

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void doRecoverNextMessages(TransactionContext c, ActiveMQDestination destination, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; nextSeq,
                                      &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxReturned, JDBCMessageRecoveryListener listener) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        PreparedStatement s = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        ResultSet rs = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; id = 0;
        List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; cleanupIds = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;();
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; index = 0;
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            s = c.getConnection().prepareStatement(statements.getFindNextMessagesStatement());
            s.setMaxRows(maxReturned*2);
            s.setString(1, destination.getQualifiedName());
            s.setLong(2, nextSeq - maxReturned);
            rs = s.executeQuery();
            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; count = 0;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (statements.isUseExternalMessageReferences()) {
                &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (rs.next() &amp;amp;&amp;amp; count &amp;lt; maxReturned) {
                	id = rs.getLong(1);
                	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( lastRecoveredMessagesIds.contains(id) ) {
                		&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; message was already recovered
&lt;/span&gt;                		cleanupIds.add(id);
                		&lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
                	}                	
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (listener.recoverMessageReference(rs.getString(1))) {
                        count++;
                        lastRecoveredMessagesIds.add(id);
                    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Stopped recover next messages&quot;&lt;/span&gt;);
                    }
                }
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (rs.next() &amp;amp;&amp;amp; count &amp;lt; maxReturned) {
                	id = rs.getLong(1);
                	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( lastRecoveredMessagesIds.contains(id) ) {
                		&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; message was already recovered
&lt;/span&gt;                		cleanupIds.add(id);
                		&lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
                	}
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (listener.recoverMessage(rs.getLong(1), getBinaryData(rs, 2))) {
                        count++;
                        lastRecoveredMessagesIds.add(id);
                    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Stopped recover next messages&quot;&lt;/span&gt;);
                    }
                }
            }
            
            &lt;span class=&quot;code-comment&quot;&gt;//not cleanup the list of recovered messages
&lt;/span&gt;            index = 0;
            Iterator&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; it = cleanupIds.iterator();
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (it.hasNext() &amp;amp;&amp;amp; index &amp;lt; count) {
            	lastRecoveredMessagesIds.remove(it.next());
            }
            
            
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            e.printStackTrace();
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            close(rs);
            close(s);
        }
    }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</comment>
                            <comment id="12940414" author="gtully" created="Mon, 3 Nov 2008 17:44:06 +0000"  >&lt;p&gt;The following fix may be relevant, the root cause was the cursor and store being out of sync like you describe in the description.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-1984&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-1984&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12940619" author="rajdavies" created="Sun, 28 Dec 2008 23:13:57 +0000"  >&lt;p&gt;Fixed by SVN revision 729803&lt;/p&gt;</comment>
                            <comment id="12940657" author="ryarger" created="Tue, 13 Jan 2009 21:40:34 +0000"  >&lt;p&gt;I applied my test scenario to apache-activemq-5.3-20090113.084327-5.&lt;br/&gt;
It was actually worse.&lt;br/&gt;
I still got a negative queue.&lt;br/&gt;
And I was unable to consume from or produce to queue1. &lt;br/&gt;
The queue was left with 131 messages that consumer1 will not consume, even after I stop and restart the consumer.&lt;br/&gt;
I ran my producers and no messages are added to queue1.&lt;/p&gt;

&lt;p&gt;I restarted the broker and the 131 messages were consumed.&lt;br/&gt;
The following error was in the log:&lt;br/&gt;
ERROR Service                        - Async error occurred: javax.jms.JMSException: Unmatched acknowledege: MessageAck &lt;/p&gt;
{comm
andId = 839, responseRequired = false, ackType = 2, consumerId = ID:vibes-richyarger-1501-1231882347001-0:0:2:1, firstMessage
Id = null, lastMessageId = ID:vibes-richyarger-3948-1231881217090-0:5200:1:1:1, destination = queue://test.queue.1, transacti
onId = TX:ID:vibes-richyarger-1501-1231882347001-0:0:138, messageCount = 1}
&lt;p&gt;; Could not find Message-ID ID:vibes-richyarger-39&lt;br/&gt;
48-1231881217090-0:5200:1:1:1 in dispatched-list (end of ack)&lt;br/&gt;
javax.jms.JMSException: Unmatched acknowledege: MessageAck &lt;/p&gt;
{commandId = 839, responseRequired = false, ackType = 2, consumerI
d = ID:vibes-richyarger-1501-1231882347001-0:0:2:1, firstMessageId = null, lastMessageId = ID:vibes-richyarger-3948-123188121
7090-0:5200:1:1:1, destination = queue://test.queue.1, transactionId = TX:ID:vibes-richyarger-1501-1231882347001-0:0:138, mes
sageCount = 1}
&lt;p&gt;; Could not find Message-ID ID:vibes-richyarger-3948-1231881217090-0:5200:1:1:1 in dispatched-list (end of ack)&lt;/p&gt;

&lt;p&gt;        at org.apache.activemq.broker.region.PrefetchSubscription.assertAckMatchesDispatched(PrefetchSubscription.java:439)&lt;br/&gt;
        at org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:192)&lt;br/&gt;
        at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:377)&lt;br/&gt;
        at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:462)&lt;br/&gt;
        at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194)&lt;br/&gt;
        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)&lt;br/&gt;
        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)&lt;br/&gt;
        at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:85)&lt;br/&gt;
        at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:458)&lt;br/&gt;
        at org.apache.activemq.command.MessageAck.visit(MessageAck.java:205)&lt;br/&gt;
        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:305)&lt;br/&gt;
        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)&lt;br/&gt;
        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)&lt;br/&gt;
        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:143)&lt;br/&gt;
        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:206)&lt;br/&gt;
        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)&lt;br/&gt;
        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:203)&lt;br/&gt;
        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:185)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:595)&lt;/p&gt;



</comment>
                            <comment id="12940668" author="ryarger" created="Tue, 13 Jan 2009 21:42:52 +0000"  >&lt;p&gt;I also have the following errors during startup:&lt;br/&gt;
ERROR Service                        - Async error occurred: javax.jms.JMSException: Transaction &apos;TX:ID:vibes-richyarger-1501&lt;br/&gt;
-1231882347001-0:0:1&apos; has not been started.&lt;br/&gt;
javax.jms.JMSException: Transaction &apos;TX:ID:vibes-richyarger-1501-1231882347001-0:0:1&apos; has not been started.&lt;br/&gt;
        at org.apache.activemq.broker.TransactionBroker.getTransaction(TransactionBroker.java:270)&lt;br/&gt;
        at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:190)&lt;br/&gt;
        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)&lt;br/&gt;
        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)&lt;br/&gt;
        at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:85)&lt;br/&gt;
        at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:458)&lt;br/&gt;
        at org.apache.activemq.command.MessageAck.visit(MessageAck.java:205)&lt;br/&gt;
        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:305)&lt;br/&gt;
        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)&lt;br/&gt;
        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)&lt;br/&gt;
        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:143)&lt;br/&gt;
        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:206)&lt;br/&gt;
        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)&lt;br/&gt;
        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:203)&lt;br/&gt;
        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:185)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:595)&lt;br/&gt;
ERROR Service                        - Async error occurred: javax.jms.JMSException: Could not correlate acknowledgment with&lt;br/&gt;
dispatched message: MessageAck &lt;/p&gt;
{commandId = 25, responseRequired = false, ackType = 3, consumerId = ID:vibes-richyarger-1501-
1231882347001-0:0:1:1, firstMessageId = null, lastMessageId = ID:vibes-richyarger-3948-1231881217090-0:5298:1:1:1, destinatio
n = queue://test.queue.1, transactionId = null, messageCount = 1}
&lt;p&gt;javax.jms.JMSException: Could not correlate acknowledgment with dispatched message: MessageAck &lt;/p&gt;
{commandId = 25, responseRequi
red = false, ackType = 3, consumerId = ID:vibes-richyarger-1501-1231882347001-0:0:1:1, firstMessageId = null, lastMessageId =
 ID:vibes-richyarger-3948-1231881217090-0:5298:1:1:1, destination = queue://test.queue.1, transactionId = null, messageCount
= 1}
&lt;p&gt;        at org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:330)&lt;br/&gt;
        at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:377)&lt;br/&gt;
        at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:462)&lt;br/&gt;
        at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194)&lt;br/&gt;
        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)&lt;br/&gt;
        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)&lt;br/&gt;
        at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:85)&lt;br/&gt;
        at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:458)&lt;br/&gt;
        at org.apache.activemq.command.MessageAck.visit(MessageAck.java:205)&lt;br/&gt;
        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:305)&lt;br/&gt;
        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)&lt;br/&gt;
        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)&lt;br/&gt;
        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:143)&lt;br/&gt;
        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:206)&lt;br/&gt;
        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)&lt;br/&gt;
        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:203)&lt;br/&gt;
        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:185)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:595)&lt;br/&gt;
INFO  WebConsoleStarter              - ActiveMQ WebConsole initialized.&lt;br/&gt;
ERROR Service                        - Async error occurred: javax.jms.JMSException: Unmatched acknowledege: MessageAck &lt;/p&gt;
{comm
andId = 49, responseRequired = false, ackType = 2, consumerId = ID:vibes-richyarger-1501-1231882347001-0:0:2:1, firstMessageI
d = null, lastMessageId = ID:vibes-richyarger-3948-1231881217090-0:4731:1:1:1, destination = queue://test.queue.1, transactio
nId = TX:ID:vibes-richyarger-1501-1231882347001-0:0:7, messageCount = 1}
&lt;p&gt;; Could not find Message-ID ID:vibes-richyarger-3948-&lt;br/&gt;
1231881217090-0:4731:1:1:1 in dispatched-list (end of ack)&lt;br/&gt;
javax.jms.JMSException: Unmatched acknowledege: MessageAck &lt;/p&gt;
{commandId = 49, responseRequired = false, ackType = 2, consumerId
 = ID:vibes-richyarger-1501-1231882347001-0:0:2:1, firstMessageId = null, lastMessageId = ID:vibes-richyarger-3948-1231881217
090-0:4731:1:1:1, destination = queue://test.queue.1, transactionId = TX:ID:vibes-richyarger-1501-1231882347001-0:0:7, messag
eCount = 1}
&lt;p&gt;; Could not find Message-ID ID:vibes-richyarger-3948-1231881217090-0:4731:1:1:1 in dispatched-list (end of ack)&lt;br/&gt;
        at org.apache.activemq.broker.region.PrefetchSubscription.assertAckMatchesDispatched(PrefetchSubscription.java:439)&lt;br/&gt;
        at org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:192)&lt;br/&gt;
        at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:377)&lt;br/&gt;
        at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:462)&lt;br/&gt;
        at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194)&lt;br/&gt;
        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)&lt;br/&gt;
        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)&lt;br/&gt;
        at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:85)&lt;br/&gt;
        at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:458)&lt;br/&gt;
        at org.apache.activemq.command.MessageAck.visit(MessageAck.java:205)&lt;br/&gt;
        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:305)&lt;br/&gt;
        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)&lt;br/&gt;
        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)&lt;br/&gt;
        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:143)&lt;br/&gt;
        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:206)&lt;br/&gt;
        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)&lt;br/&gt;
        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:203)&lt;br/&gt;
        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:185)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:595)&lt;/p&gt;</comment>
                            <comment id="12941084" author="ryarger" created="Mon, 30 Mar 2009 16:58:03 +0000"  >&lt;p&gt;I have created a unit test that can reproduce the issue.&lt;br/&gt;
It takes around 5 min to complete.&lt;/p&gt;

&lt;p&gt;I modeled the test off of the CursorSupport test case.&lt;br/&gt;
I just added a second queue and more specific memory settings.&lt;br/&gt;
I also included tests with different prefetch values.&lt;br/&gt;
Lowering prefetch seems to have a direct impact on the issue.&lt;/p&gt;

&lt;p&gt;testWithDefaultPrefetch() and testWithDefaultPrefetchFiveConsumers()&lt;br/&gt;
are usually the ones to fail.&lt;/p&gt;

&lt;p&gt;I am reproducing the issue quite easily with this test case.&lt;br/&gt;
So let me know if you cannot.&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="12941081" author="ryarger" created="Mon, 30 Mar 2009 17:00:44 +0000"  >&lt;p&gt;I also noticed another ticket that is most likely related to this issue: &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1940&quot; title=&quot;Negative queue size (reproducible)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1940&quot;&gt;&lt;del&gt;AMQ-1940&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12941088" author="npfistner" created="Tue, 31 Mar 2009 07:08:04 +0000"  >&lt;p&gt;Maybe also our problem concerning hanging persistent JDBC Messages is related to this. Please see &lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-2184&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-2184&lt;/a&gt; for details.&lt;br/&gt;
We have to restart our Broker in our productive environment at least once every 24 h.&lt;/p&gt;</comment>
                            <comment id="12941117" author="ryarger" created="Thu, 2 Apr 2009 14:53:00 +0000"  >&lt;p&gt;I should have mentioned that this test case has been written against tag 5.1.0.&lt;br/&gt;
I have been debugging the code and I have some concerns about whether the unit test is producing the same issue that we are seeing in our production environment.&lt;/p&gt;

&lt;p&gt;While the unit test decrements the pending message count extra times and it goes negative,  it does not cause a cursor size to go negative.&lt;/p&gt;

&lt;p&gt;The unit test is producing a negative queue because duplicate messages are being dispatched to the consumer from the RecoveryDispatch.&lt;br/&gt;
PagedInMessages are cached in a RecoveryDispatch when a new subscriber is added.&lt;br/&gt;
I was able to resolve the issue by adding a lock check to the Queue.iterate() method.&lt;br/&gt;
Which I thought was great until I saw that the RecoveryDispatch had been removed in later versions.&lt;/p&gt;

&lt;p&gt;I am going to run the unit test in trunk.&lt;/p&gt;</comment>
                            <comment id="12941374" author="rajdavies" created="Tue, 26 May 2009 08:50:28 +0000"  >&lt;p&gt;Added test case in SVN revision 778622.&lt;br/&gt;
Looks fixed with trunk on 26th May 2009&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461185" name="ASF.LICENSE.NOT.GRANTED--activemq.xml" size="5819" author="ryarger" created="Thu, 28 Aug 2008 14:28:55 +0000"/>
                            <attachment id="12461461" name="NegativeQueueCursorSupport.java" size="14966" author="ryarger" created="Mon, 30 Mar 2009 16:58:03 +0000"/>
                            <attachment id="12461199" name="testAMQMessageStore.zip" size="4735369" author="ryarger" created="Thu, 28 Aug 2008 22:16:46 +0000"/>
                            <attachment id="12461112" name="testdata.zip" size="160185" author="nic.tanase" created="Wed, 24 Sep 2008 10:59:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>75173</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 27 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rzyn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161470</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>