<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:38:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1983] Async error occurred - Slave broker out of sync with master</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1983</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I have tried to reduce the real-life problem to something smaller. See activemqjee-0.0.8.tar.gz&lt;/p&gt;

&lt;p&gt;It&apos;s a MDB that forwards a message to another queue. &lt;/p&gt;

&lt;p&gt;What I did:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;send some messages to queue.A (I did 10 at a time, using the webconsole setting Persistent Delivery)&lt;/li&gt;
	&lt;li&gt;the MDB sends each message to queue.B&lt;/li&gt;
	&lt;li&gt;if a reply queue was set in the message, the MDB sends a reply&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;On queue.B is an MDB that just received and logs the message.&lt;/p&gt;


&lt;p&gt;Logged on the master:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2008-10-19 18:39:54,114 [127.0.0.1:43972] DEBUG AMQMessageStore                - Journalled transacted message add &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;:
   ID:selten.cluster-40744-1224434310420-0:2:4:1:1, at: offset = 90045, file = 1, size = 429, type = 1
......
2008-10-19 18:39:54,278 [127.0.0.1:43972] DEBUG AMQMessageStore                - Transacted message add commit &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;:
   ID:selten.cluster-40744-1224434310420-0:2:4:1:1, at: offset = 90045, file = 1, size = 429, type = 1
......
2008-10-19 18:39:54,305 [127.0.0.1:43962] ERROR MasterBroker                   - Slave Failed
javax.jms.JMSException: Unmatched acknowledege: MessageAck {commandId = 1031, responseRequired = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, ackType = 2, 
  consumerId = ID:selten.cluster-40744-1224434310420-0:0:-1:2, firstMessageId = 
ID:selten.cluster-40744-1224434310420-0:2:4:1:1, lastMessageId = ID:selten.cluster-40744-1224434310420-0:2:4:1:1, 
  destination = queue:&lt;span class=&quot;code-comment&quot;&gt;//queue.B, 
&lt;/span&gt;transactionId = XID:131075:312d2d32613062356562303a613535653a34386662363236643a313135:2d32613062356562303a613535653a34386662363236643a313136,
 messageCount = 1}; Could not find Message-ID ID:selten.cluster-40744-1224434310420-0:2:4:1:1 in dispatched-list (start of ack)
        at org.apache.activemq.broker.region.PrefetchSubscription.assertAckMatchesDispatched(PrefetchSubscription.java:438)
        at org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:188)
        at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:373)
        at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:462)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Logged on the slave:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2008-10-19 18:39:54,112 [.cluster#1] DEBUG AMQMessageStore                - Journalled transacted message add &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;: ID:selten.cluster-40744-1224434310420-0:2:4:1:1, at: offset = 90045, file = 1, size = 429, type = 1
......
2008-10-19 18:39:54,241 [.cluster#1] DEBUG AMQMessageStore                - Transacted message add commit &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;: ID:selten.cluster-40744-1224434310420-0:2:4:1:1, at: offset = 90045, file = 1, size = 429, type = 1
......
2008-10-19 18:39:54,288 [.cluster#1] ERROR Service                        - Async error occurred: javax.jms.JMSException: Slave broker out of sync with master: 
  Dispatched message (ID:selten.cluster-40744-1224434310420-0:2:4:1:1) was not in the pending list &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; queue.B
  javax.jms.JMSException: Slave broker out of sync with master: Dispatched message 
(ID:selten.cluster-40744-1224434310420-0:2:4:1:1) was not in the pending list &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; queue.B
        at org.apache.activemq.broker.region.PrefetchSubscription.processMessageDispatchNotification(PrefetchSubscription.java:175)
        at org.apache.activemq.broker.region.AbstractRegion.processDispatchNotification(AbstractRegion.java:414)
        at org.apache.activemq.broker.region.RegionBroker.processDispatchNotification(RegionBroker.java:585)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I could not consistently reproduce it with a single JBoss server running. I&apos;ve sent a few 100 messages without any problem.&lt;/p&gt;

&lt;p&gt;I&apos;ve tested both 5.2.0-RC2 and 5.3.0-SNAPSHOT (rev 706043).&lt;/p&gt;
</description>
                <environment>&lt;p&gt;java version &quot;1.6.0_07&quot;&lt;br/&gt;
Client is a JBoss 4.2.3.GA cluster using the ActiveMQ resource adapter (from RC2)&lt;br/&gt;
ActiveMQ 5.3.0  rev 706043 in pure master/slave setup&lt;/p&gt;</environment>
        <key id="12482650">AMQ-1983</key>
            <summary>Async error occurred - Slave broker out of sync with master</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                            <parent id="12483556">AMQ-1999</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="hansb">Hans Bausewein</reporter>
                        <labels>
                    </labels>
                <created>Sun, 19 Oct 2008 18:05:10 +0000</created>
                <updated>Mon, 10 Nov 2008 17:53:56 +0000</updated>
                            <resolved>Tue, 28 Oct 2008 12:09:08 +0000</resolved>
                                    <version>5.2.0</version>
                                    <fixVersion>5.2.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12940385" author="hansb" created="Tue, 21 Oct 2008 16:58:36 +0000"  >&lt;p&gt;I&apos;ve run another test with our real application with a single JBoss 4.0.5 host and a pure master/slave ActiveMQ setup (5.2.0 RC2).&lt;/p&gt;

&lt;p&gt;See the ERRORs in &quot;activemq-master.log.gz&quot; and &quot;activemq-slave.log.gz&quot;&lt;/p&gt;

&lt;p&gt;Logged at DEBUG level, so I hope it&apos;s clear enough.&lt;/p&gt;

&lt;p&gt;I think the case matches quite closely to the test code in this issue, though the real application does a lot more.&lt;/p&gt;
</comment>
                            <comment id="12940383" author="hansb" created="Tue, 21 Oct 2008 21:45:00 +0000"  >&lt;p&gt;This was the message from the JBoss server log that produced the issue:&lt;/p&gt;

&lt;p&gt;2008-10-21 18:27:06,677 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.activemq.ActiveMQSession&amp;#93;&lt;/span&gt; ID:master.cluster-49988-1224605035095-0:42:339 sending message: ActiveMQTextMessage &lt;/p&gt;
{commandId = 0, responseRequired = false, messageId = ID:master.cluster-49988-1224605035095-0:42:339:1:1, originalDestination = null, originalTransactionId = null, producerId = ID:master.cluster-49988-1224605035095-0:42:339:1, destination = queue://queue.CLIENT_OUT_TOKEN, transactionId = XID:257:6d6366616464656e2e6d61726b657478732e636f6d2f313530323500000000000000000000000000000000000000000000000000000000000000000000000000:
31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000, expiration = 0, timestamp = 1224606426677, arrival = 0, brokerInTime = 0, brokerOutTime = 0, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 0, properties = null, readOnlyProperties = true, readOnlyBody = true, droppable = false, text = ..........(removed the message)............}


&lt;p&gt;It was one of 686 messages sent by the same EJB to the same queue within about 15 minutes during my tests.&lt;/p&gt;

&lt;p&gt;The transaction commit happened at the time of the ERROR Service                        - Async error occurred: &lt;br/&gt;
  JMSException: Slave broker out of sync with master: Dispatched message (ID:master.cluster-49988-1224605035095-0:42:339:1:1) was not in the pending list&lt;/p&gt;

&lt;p&gt;in the slave log.&lt;/p&gt;


</comment>
                            <comment id="12940397" author="hansb" created="Wed, 22 Oct 2008 07:07:49 +0000"  >&lt;p&gt;This is the start and end of the XA transactions with that XID in the JBoss server log:&lt;/p&gt;

&lt;p&gt;2008-10-21 18:27:09,412 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.activemq.TransactionContext&amp;#93;&lt;/span&gt; Started XA transaction: XID:257:6d6366616464656e2e6d61726b657478732e636f6d2f313530383400000000000000000000000000000000000000000000000000000000000000000000000000:&lt;br/&gt;
31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&lt;br/&gt;
...........&lt;br/&gt;
2008-10-21 18:27:09,457 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.activemq.TransactionContext&amp;#93;&lt;/span&gt; Started XA transaction: XID:257:6d6366616464656e2e6d61726b657478732e636f6d2f313530383400000000000000000000000000000000000000000000000000000000000000000000000000:&lt;br/&gt;
31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&lt;/p&gt;

&lt;p&gt;.................&lt;br/&gt;
2008-10-21 18:27:09,459 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.activemq.ActiveMQSession&amp;#93;&lt;/span&gt; ID:master.cluster-49988-1224605035095-0:42:346 sending message: ActiveMQTextMessage {commandId = 0, responseRequired = false, messageId = ID:master.cluster-49988-1224605035095-0:42:346:1:1, originalDestination = null, originalTransactionId = null, producerId = ID:master.cluster-49988-1224605035095-0:42:346:1, destination = topic://topic.PRE_CLIENT_OUT, transactionId = XID:257:6d6366616464656e2e6d61726b657478732e636f6d2f313530383400000000000000000000000000000000000000000000000000000000000000000000000000:&lt;br/&gt;
31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000, expiration = 0, timestamp = 1224606429459, arrival = 0, brokerInTime = 0, brokerOutTime = 0, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 0, properties = null, readOnlyProperties = true, readOnlyBody = true, droppable = false, text =&lt;/p&gt;

&lt;p&gt;2008-10-21 18:27:09,478 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.activemq.ActiveMQSession&amp;#93;&lt;/span&gt; ID:master.cluster-49988-1224605035095-0:42:346 sending message: ActiveMQTextMessage {commandId = 0, responseRequired = false, messageId = ID:master.cluster-49988-1224605035095-0:42:346:2:1, originalDestination = null, originalTransactionId = null, producerId = ID:master.cluster-49988-1224605035095-0:42:346:2, destination = queue://queue.CLIENT_OUT, transactionId = XID:257:6d6366616464656e2e6d61726b657478732e636f6d2f313530383400000000000000000000000000000000000000000000000000000000000000000000000000:&lt;br/&gt;
31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000, expiration = 0, timestamp = 1224606429478, arrival = 0, brokerInTime = 0, brokerOutTime = 0, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 0, properties = &lt;/p&gt;
{tnx435=true}
&lt;p&gt;, readOnlyProperties = true, readOnlyBody = true, droppable = false, text =&lt;br/&gt;
.............&lt;/p&gt;

&lt;p&gt;2008-10-21 18:27:09,730 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.activemq.TransactionContext&amp;#93;&lt;/span&gt; Ended XA transaction: XID:257:6d6366616464656e2e6d61726b657478732e636f6d2f313530383400000000000000000000000000000000000000000000000000000000000000000000000000:&lt;br/&gt;
31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&lt;br/&gt;
2008-10-21 18:27:09,730 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.activemq.TransactionContext&amp;#93;&lt;/span&gt; End: XidImpl&lt;span class=&quot;error&quot;&gt;&amp;#91;FormatId=257, GlobalId=mcfadden.marketxs.com/15084, BranchQual=1, localId=15084&amp;#93;&lt;/span&gt;&lt;br/&gt;
2008-10-21 18:27:09,730 DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.activemq.TransactionContext&amp;#93;&lt;/span&gt; Ended XA transaction: XID:257:6d6366616464656e2e6d61726b657478732e636f6d2f313530383400000000000000000000000000000000000000000000000000000000000000000000000000:&lt;br/&gt;
31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&lt;/p&gt;

&lt;p&gt;Apparently there are 2 transactions with the same transaction id!&lt;/p&gt;

&lt;p&gt;For different queues, though.&lt;/p&gt;</comment>
                            <comment id="12940349" author="hansb" created="Wed, 22 Oct 2008 10:49:56 +0000"  >&lt;p&gt;Nothing special: it&apos;s just a single MDB running in the same XA transaction and sending messages to different queues or topics.&lt;/p&gt;

&lt;p&gt;I think I must create a better test application.&lt;/p&gt;</comment>
                            <comment id="12940390" author="gtully" created="Fri, 24 Oct 2008 15:52:25 +0000"  >&lt;p&gt;I think the following patch will fix your issue. There is not much in the line of XA tests in core that can help me verify at the moment. If you get a chance, can you build trunk with this patch and validate.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: activemq-core/src/main/java/org/apache/activemq/broker/ft/MasterBroker.java
===================================================================
--- activemq-core/src/main/java/org/apache/activemq/broker/ft/MasterBroker.java	(revision 707659)
+++ activemq-core/src/main/java/org/apache/activemq/broker/ft/MasterBroker.java	(working copy)
@@ -253,7 +253,7 @@
      */
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; prepareTransaction(ConnectionContext context, TransactionId xid) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
         TransactionInfo info = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TransactionInfo(context.getConnectionId(), xid, TransactionInfo.PREPARE);
-        sendAsyncToSlave(info);
+        sendSyncToSlave(info);
         &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; result = &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.prepareTransaction(context, xid);
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; result;
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12940402" author="hansb" created="Sun, 26 Oct 2008 22:36:22 +0000"  >&lt;p&gt;It seems this fixes it. I&apos;ve sent more than 1600 messages without this happening again.&lt;br/&gt;
It&apos;s a bit modified MDB that forwards the message to 2 queues and a topic and sends a reply to the replyTo queue. (closer to what our real application does)&lt;br/&gt;
See activemqjee-0.0.9-src.tar.gz&lt;/p&gt;

&lt;p&gt;I&apos;ve not tested the stand-alone version and that one is not transacted anyway.&lt;br/&gt;
Only tested the EJB version on JBoss 4.2.3.&lt;/p&gt;

</comment>
                            <comment id="12940404" author="gtully" created="Tue, 28 Oct 2008 12:09:08 +0000"  >&lt;p&gt;resolved in r708548&lt;/p&gt;

&lt;p&gt;thanks for validating the patch.&lt;/p&gt;</comment>
                            <comment id="12939596" author="gtully" created="Thu, 6 Nov 2008 10:47:07 +0000"  >&lt;p&gt;These fixes will now make 5.2.0 rc3&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461134" name="ASF.LICENSE.NOT.GRANTED--activemqjee-0.0.8-src.tar.gz" size="7769" author="hansb" created="Sun, 19 Oct 2008 18:05:10 +0000"/>
                            <attachment id="12461204" name="activemq-master.log.gz" size="48979" author="hansb" created="Tue, 21 Oct 2008 16:52:30 +0000"/>
                            <attachment id="12461155" name="activemq-slave.log.gz" size="44778" author="hansb" created="Tue, 21 Oct 2008 21:32:21 +0000"/>
                            <attachment id="12461203" name="activemqjee-0.0.9-src.tar.gz" size="7956" author="hansb" created="Sun, 26 Oct 2008 22:37:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>43780</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 3 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14bs7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>233372</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>