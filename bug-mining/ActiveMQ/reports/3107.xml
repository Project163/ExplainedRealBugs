<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:41:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6831] Broker fails to start complaining about missing/corrupt journal files</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6831</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2017-10-09 12:29:36.802 ERROR 4197 --- [pool-3-thread-1] org.deku.leoz.node.Application           : java.io.IOException: Detected missing/corrupt journal files referenced by:[0:ActiveMQ.DLQ] 3 messages affected.

java.lang.Error: java.io.IOException: Detected missing/corrupt journal files referenced by:[0:ActiveMQ.DLQ] 3 messages affected.
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1148) ~[na:1.8.0_131]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[na:1.8.0_131]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748) ~[na:1.8.0_131]
Caused by: java.io.IOException: Detected missing/corrupt journal files referenced by:[0:ActiveMQ.DLQ] 3 messages affected.
	at org.apache.activemq.store.kahadb.MessageDatabase.recoverIndex(MessageDatabase.java:965) ~[activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase$5.execute(MessageDatabase.java:717) ~[activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.disk.page.Transaction.execute(Transaction.java:779) ~[activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase.recover(MessageDatabase.java:714) ~[activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase.open(MessageDatabase.java:473) ~[activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase.load(MessageDatabase.java:493) ~[activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase.doStart(MessageDatabase.java:297) ~[activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.KahaDBStore.doStart(KahaDBStore.java:219) ~[activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.util.ServiceSupport.start(ServiceSupport.java:55) ~[activemq-client-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.KahaDBPersistenceAdapter.doStart(KahaDBPersistenceAdapter.java:232) ~[activemq-kahadb-store-5.15.1.jar:5.15.1]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Downgrading to 5.15.0 resolves the problem.&lt;br/&gt;
This is an embedded broker setup, using&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
        val pa = brokerService.persistenceAdapter as KahaDBPersistenceAdapter
        pa.isCheckForCorruptJournalFiles = true
        pa.isIgnoreMissingJournalfiles = false
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13107941">AMQ-6831</key>
            <summary>Broker fails to start complaining about missing/corrupt journal files</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="masc3d">masc</reporter>
                        <labels>
                    </labels>
                <created>Mon, 9 Oct 2017 10:35:53 +0000</created>
                <updated>Thu, 28 Nov 2019 17:39:23 +0000</updated>
                            <resolved>Thu, 28 Nov 2019 15:22:23 +0000</resolved>
                                    <version>5.15.1</version>
                                    <fixVersion>5.15.2</fixVersion>
                    <fixVersion>5.16.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16196843" author="christopher.l.shannon" created="Mon, 9 Oct 2017 11:45:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; - Do you think this issue is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6771&quot; title=&quot;Improve performance of KahaDB recovery check checkForCorruptJournalFiles=true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6771&quot;&gt;&lt;del&gt;AMQ-6771&lt;/del&gt;&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="16196869" author="gtully" created="Mon, 9 Oct 2017 12:14:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; I hope not. I would need to check the journal files to verify the corrupt locations. A sanity check to see if a current snapshot has the same determination may help narrow this down.&lt;/p&gt;

&lt;p&gt;The logs should indicate the journal locations in question? How do we know there is no corruption present at the moment?&lt;/p&gt;</comment>
                            <comment id="16196911" author="christopher.l.shannon" created="Mon, 9 Oct 2017 12:54:43 +0000"  >&lt;p&gt;Yeah I just find it interesting that the description says downgrading to 5.15.0 fixes the issue.  &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=masc3d&quot; class=&quot;user-hover&quot; rel=&quot;masc3d&quot;&gt;masc3d&lt;/a&gt;, are you able to upload a small KahaDB store that reproduces the issue?&lt;/p&gt;</comment>
                            <comment id="16197268" author="masc3d" created="Mon, 9 Oct 2017 16:41:57 +0000"  >&lt;p&gt;yes, that would be possible, as it&apos;s my local dev db, it shouldn&apos;t contain anything sensitive.&lt;/p&gt;

&lt;p&gt;I also found that this issue is related to the preallocation kahadb settings:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        pa.preallocationScope = Journal.PreallocationScope.ENTIRE_JOURNAL_ASYNC.name
        pa.preallocationStrategy = Journal.PreallocationStrategy.ZEROS.name
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which I enabled for performance reasons.&lt;/p&gt;

&lt;p&gt;Disabling preallocation will yield both&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2017-10-09 18:34:57.512  WARN 10617 --- [pool-3-thread-1] o.a.a.store.kahadb.MessageDatabase       : Cannot recover message audit

java.io.IOException: Invalid location size: 1:28, size: 0
	at org.apache.activemq.store.kahadb.disk.journal.DataFileAccessor.readRecord(DataFileAccessor.java:88) ~[activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.disk.journal.Journal.read(Journal.java:936) ~[activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase.load(MessageDatabase.java:1151) [activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase.recoverProducerAudit(MessageDatabase.java:784) [activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase.recover(MessageDatabase.java:674) [activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase.open(MessageDatabase.java:473) [activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase.load(MessageDatabase.java:493) [activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase.doStart(MessageDatabase.java:297) [activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.KahaDBStore.doStart(KahaDBStore.java:219) [activemq-kahadb-store-5.15.1.jar:5.15.1]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and subsequently&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2017-10-09 18:34:57.513  WARN 10617 --- [pool-3-thread-1] o.a.a.store.kahadb.MessageDatabase       : Cannot recover ackMessageFileMap

java.io.IOException: Invalid location size: 1:431, size: 0
	at org.apache.activemq.store.kahadb.disk.journal.DataFileAccessor.readRecord(DataFileAccessor.java:88) ~[activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.disk.journal.Journal.read(Journal.java:936) ~[activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase.load(MessageDatabase.java:1151) [activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase.recoverAckMessageFileMap(MessageDatabase.java:805) [activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase.recover(MessageDatabase.java:675) [activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase.open(MessageDatabase.java:473) [activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase.load(MessageDatabase.java:493) [activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.MessageDatabase.doStart(MessageDatabase.java:297) [activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.KahaDBStore.doStart(KahaDBStore.java:219) [activemq-kahadb-store-5.15.1.jar:5.15.1]
	at org.apache.activemq.util.ServiceSupport.start(ServiceSupport.java:55) [activemq-client-5.15.1.jar:5.15.1]
	at org.apache.activemq.store.kahadb.KahaDBPersistenceAdapter.doStart(KahaDBPersistenceAdapter.java:232) [activemq-kahadb-store-5.15.1.jar:5.15.1]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but the broker will at least start.&lt;/p&gt;</comment>
                            <comment id="16197531" author="gtully" created="Mon, 9 Oct 2017 19:09:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=masc3d&quot; class=&quot;user-hover&quot; rel=&quot;masc3d&quot;&gt;masc3d&lt;/a&gt; I had a quick peek at the kahadb.zip but there are no journal files in there. Can you check. Also, if possible describe simple steps to reproduce. I flipped the bits to enable PreallocationStrategy.ZEROS on a few of the recovery unit tests and did not reproduce.&lt;/p&gt;</comment>
                            <comment id="16197690" author="masc3d" created="Mon, 9 Oct 2017 21:01:42 +0000"  >&lt;p&gt;yes sorry, checked again and replaced the archive with the full kahadb folder&lt;/p&gt;</comment>
                            <comment id="16198906" author="jira-bot" created="Tue, 10 Oct 2017 16:24:27 +0000"  >&lt;p&gt;Commit f9899922783e0e94de030f4c867e5d48a3d869a9 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=f989992&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=f989992&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;AMQ-6831, AMQ-6771&amp;#93;&lt;/span&gt; fix up recovery check to ensure full batch is available in memory, regression from &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6771&quot; title=&quot;Improve performance of KahaDB recovery check checkForCorruptJournalFiles=true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6771&quot;&gt;&lt;del&gt;AMQ-6771&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16198913" author="gtully" created="Tue, 10 Oct 2017 16:26:34 +0000"  >&lt;p&gt;This is a regression - &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6771&quot; title=&quot;Improve performance of KahaDB recovery check checkForCorruptJournalFiles=true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6771&quot;&gt;&lt;del&gt;AMQ-6771&lt;/del&gt;&lt;/a&gt; batched the recovery reads but in this case the alignment on a batch record meant a the batch buffer was not refilled. Disabling the recoveryCheck will avoid this problem but it is a serious bug.&lt;/p&gt;</comment>
                            <comment id="16198922" author="jira-bot" created="Tue, 10 Oct 2017 16:33:36 +0000"  >&lt;p&gt;Commit 0f544fd54bde5d39f5e6e19d189580884740768b in activemq&apos;s branch refs/heads/activemq-5.15.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=0f544fd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=0f544fd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;AMQ-6831, AMQ-6771&amp;#93;&lt;/span&gt; fix up recovery check to ensure full batch is available in memory, regression from &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6771&quot; title=&quot;Improve performance of KahaDB recovery check checkForCorruptJournalFiles=true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6771&quot;&gt;&lt;del&gt;AMQ-6771&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(cherry picked from commit f9899922783e0e94de030f4c867e5d48a3d869a9)&lt;/p&gt;</comment>
                            <comment id="16198949" author="christopher.l.shannon" created="Tue, 10 Oct 2017 16:50:26 +0000"  >&lt;p&gt;Thanks for taking a look Gary, when this is good to go I can do a 5.15.2 release since this is a serious issue.&lt;/p&gt;</comment>
                            <comment id="16199184" author="gtully" created="Tue, 10 Oct 2017 18:57:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=masc3d&quot; class=&quot;user-hover&quot; rel=&quot;masc3d&quot;&gt;masc3d&lt;/a&gt; thanks for the kahadb.zip it made it easy to track down.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; it should be sorted however another set of eyes on the change set for &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6831&quot; title=&quot;Broker fails to start complaining about missing/corrupt journal files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6831&quot;&gt;&lt;del&gt;AMQ-6831&lt;/del&gt;&lt;/a&gt; would be valuable. Thanks.&lt;/p&gt;</comment>
                            <comment id="16199548" author="jira-bot" created="Tue, 10 Oct 2017 23:21:12 +0000"  >&lt;p&gt;Commit e793260573f30365572a1e7507cd98e9ed17b1b5 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e793260&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e793260&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;AMQ-6831, AMQ-6771&amp;#93;&lt;/span&gt; trigger eofexception on read -1 - AMQ6522Test&lt;/p&gt;</comment>
                            <comment id="16200130" author="gtully" created="Wed, 11 Oct 2017 11:44:44 +0000"  >&lt;p&gt;There is a workaround but it is temporary. Here is the background, there is a problem with &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6771&quot; title=&quot;Improve performance of KahaDB recovery check checkForCorruptJournalFiles=true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6771&quot;&gt;&lt;del&gt;AMQ-6771&lt;/del&gt;&lt;/a&gt; that speeds up the checkForCorruptJournalFiles. On a restart, it is possible that the check will report corruption when there is none. It is independent of the preallocation strategy or preallocation scope. &lt;br/&gt;
If ignoreMissingJournalFiles=true is configured, this can lead to unnecessary loss of data, otherwise the broker will fail to start and report the corruption and there will be no loss.&lt;br/&gt;
If there is no reason to suspect corruption it may be this defect. The defect relates to the parsing of a batch of journal data. If the journal record header crosses a batch boundary at a particular point, the defect can happen. &lt;br/&gt;
Disabling the checkForCorruptJournalFiles will avoid the problem but also changing or varying the read batch size may avoid the problem.&lt;br/&gt;
The read batch size is controlled by journalMaxWriteBatchSize which default to 4mb. Setting that to 10mb or some larger number may help. It is a little random but the window for this to occur is quite small. If the journalMaxWriteBatchSize is half of of the journalSize (and there is enough memory) then two reads will parse a journal file and the chance of a batch being on a boundary and hitting this defect is very small.&lt;/p&gt;</comment>
                            <comment id="16200135" author="jira-bot" created="Wed, 11 Oct 2017 11:49:34 +0000"  >&lt;p&gt;Commit d66e96e8bc7be51a93835149e132204407d79b5f in activemq&apos;s branch refs/heads/activemq-5.15.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=d66e96e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=d66e96e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;AMQ-6831, AMQ-6771&amp;#93;&lt;/span&gt; trigger eofexception on read -1 - AMQ6522Test&lt;/p&gt;

&lt;p&gt;(cherry picked from commit e793260573f30365572a1e7507cd98e9ed17b1b5)&lt;/p&gt;</comment>
                            <comment id="16200138" author="christopher.l.shannon" created="Wed, 11 Oct 2017 11:50:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; - The fix looks good to me, I ran through some of my tests and everything seemed fine so far&lt;/p&gt;</comment>
                            <comment id="16984370" author="masc3d" created="Thu, 28 Nov 2019 12:06:51 +0000"  >&lt;p&gt;This issue is apparently regressing in 5.15.11.&#160;&lt;/p&gt;

&lt;p&gt;After upgrading from 5.15.10 to 5.15.11 broker complains about missing / corrupt journal files on every restart.&lt;/p&gt;

&lt;p&gt;Downgrading to 5.15.10 resolves the issue.&lt;/p&gt;</comment>
                            <comment id="16984371" author="masc3d" created="Thu, 28 Nov 2019 12:07:37 +0000"  >&lt;p&gt;regression 5.15.10 -&amp;gt; 5.15.11&lt;/p&gt;</comment>
                            <comment id="16984390" author="christopher.l.shannon" created="Thu, 28 Nov 2019 12:51:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=masc3d&quot; class=&quot;user-hover&quot; rel=&quot;masc3d&quot;&gt;masc3d&lt;/a&gt;&#160;- if you think there is a regression here it would be better to open a new Jira and leave this one closed to prevent confusion and then link the two&lt;/p&gt;</comment>
                            <comment id="16984401" author="christopher.l.shannon" created="Thu, 28 Nov 2019 13:12:12 +0000"  >&lt;p&gt;Also looking at the release notes nothing stands out that would cause a regression as nothing touches KahaDB so some investigation would be needed to see if there really is an issue&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ReleaseNote.jspa?projectId=12311210&amp;amp;version=12345958&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/ReleaseNote.jspa?projectId=12311210&amp;amp;version=12345958&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16984409" author="masc3d" created="Thu, 28 Nov 2019 13:24:58 +0000"  >&lt;p&gt;`CallerBufferingDataFileAppender` of kahadb was actually touched in 5.15.11.&lt;/p&gt;

&lt;p&gt;Im quite positive yes, I could replicate this in productive environment 100% on half a dozen restarts while this issue was never seen before (since 5.15.1) and downgrading resolves it instantly.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16984421" author="christopher.l.shannon" created="Thu, 28 Nov 2019 13:47:12 +0000"  >&lt;p&gt;Hmm, it looks like this commit was added&#160;&lt;a href=&quot;https://github.com/apache/activemq/commit/0262338687d7bf811ad9ee0620f77806bd7e08ad&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/commit/0262338687d7bf811ad9ee0620f77806bd7e08ad&lt;/a&gt;&#160;with no Jira which is a big problem as we then it&apos;s hard to track this stuff as seen here.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&#160;- What do you think about this?&lt;/p&gt;

&lt;p&gt;I&apos;m out of the office until Monday but I can take a look next week at it and see if I can reproduce if you don&apos;t have time to peek at it.&#160; If there is a regression here I&apos;d certainly like to get it fixed ASAP to prevent breaking people&apos;s data stores.&lt;/p&gt;</comment>
                            <comment id="16984488" author="gemmellr" created="Thu, 28 Nov 2019 15:19:35 +0000"  >&lt;p&gt;The commit was from &lt;a href=&quot;https://github.com/apache/activemq/pull/348&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/348&lt;/a&gt;, but it still didn&apos;t have a JIRA, tests, or any description of / reason for the change to made.&lt;/p&gt;

&lt;p&gt;As Christopher already noted, a new JIRA should be raised for discussion of the new issue noted, and linked back to this JIRA if desired...though it seems so far like it might be a totally different issue, and if so isnt really related at all. I&apos;ll close this one again now.&lt;/p&gt;</comment>
                            <comment id="16984496" author="masc3d" created="Thu, 28 Nov 2019 15:34:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=robbie&quot; class=&quot;user-hover&quot; rel=&quot;robbie&quot;&gt;robbie&lt;/a&gt; depends how you look at it. functionally and referring to description and stack trace this is totally a regression.&lt;/p&gt;

&lt;p&gt;if you require separate jira issues in order to group your commits, that&apos;s up to you.&lt;br/&gt;
you&apos;re now aware of the issue, feel free to spawn as many issues as you prefer.&lt;/p&gt;</comment>
                            <comment id="16984504" author="christopher.l.shannon" created="Thu, 28 Nov 2019 15:45:21 +0000"  >&lt;p&gt;I added a message to the PR asking if the original person could provide some context as to what the purpose of the commit was for.&#160; Otherwise I&apos;m just inclined to open a new Jira and then revert the change as there&apos;s no clear indication why it was made or what it was trying to solve and no tests.&lt;/p&gt;</comment>
                            <comment id="16984514" author="gtully" created="Thu, 28 Nov 2019 15:58:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; I don&apos;t think that PR is related to the problem b/c that class (that the pr modifies) is only used if a system property is in play that defaults to false, it was an experiment that failed to bare fruit. &lt;br/&gt;
see: &lt;a href=&quot;https://github.com/apache/activemq/blob/bf8eb08acaeec653d04daa0b8b6dd889ef990bed/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/disk/journal/Journal.java#L251&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/bf8eb08acaeec653d04daa0b8b6dd889ef990bed/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/disk/journal/Journal.java#L251&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Unless the -Dorg.apache.kahadb.journal.CALLER_BUFFER_APPENDER=true is set, that code is not in play. And if it is, unsetting org.apache.kahadb.journal.CALLER_BUFFER_APPENDER is the way to go.&lt;/p&gt;</comment>
                            <comment id="16984519" author="christopher.l.shannon" created="Thu, 28 Nov 2019 16:12:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&#160;- Thanks for the context...that is the only KahaDB commit I see between 5.15.10 and 5.15.11 so if that is not causing a problem then I don&apos;t see what else would cause a possible regression.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=masc3d&quot; class=&quot;user-hover&quot; rel=&quot;masc3d&quot;&gt;masc3d&lt;/a&gt;&#160;- Have you set the&#160;-Dorg.apache.kahadb.journal.CALLER_BUFFER_APPENDER=true property in your setup to true?&lt;/p&gt;</comment>
                            <comment id="16984566" author="masc3d" created="Thu, 28 Nov 2019 17:39:23 +0000"  >&lt;p&gt;good call, no we don&apos;t set this and I double checked that&#160;`CallerDataFileAppender` is actually not used / instantiated in our build.&lt;/p&gt;

&lt;p&gt;still can&apos;t believe seeing this several times in a row on orderly restart with 5.15.11 and then not at all with 5.15.10 could be coincidence.&lt;/p&gt;

&lt;p&gt;I marked this TODO for more in-depth tests / isolation but it could take a while until I come up with sth.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="13087235">AMQ-6771</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12891125" name="kahadb.zip" size="24916314" author="masc3d" created="Mon, 9 Oct 2017 20:58:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 50 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3l0un:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310080" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Regression</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10091"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>