<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:34:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6133] Message updates can cause message loss on recovery</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6133</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;After doing some testing with &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6131&quot; title=&quot;Durable subscription rewrote in journal can be to agressive and cause message loss on recovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6131&quot;&gt;&lt;del&gt;AMQ-6131&lt;/del&gt;&lt;/a&gt;, I noticed a similar issue where messages can be lost if a message update is called.&lt;/p&gt;

&lt;p&gt;Normally when KahaDB gets a KahaUpdateMessageCommand it will update the index with the new location.  This works except that if the index is deleted or corrupted and needs to be rebuilt, the replay process may not be able to recover the message.&lt;/p&gt;

&lt;p&gt;This happens because after the message is updated, KahaDB is free to garbage collect the file with the original add command.  So, whatt happens is that during replay when the update command is seen KahaDB rejects it because it can&apos;t find the original message if that file has been GC&apos;d.  This happens in the updateIndex method of MessageDatabase on line 1395 where it prints out a warning saying &quot;Non existent message update attempt rejected&quot;.&lt;/p&gt;

&lt;p&gt;I am attaching a unit test that demonstrates the issue where the count after restart is missing messages.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12932452">AMQ-6133</key>
            <summary>Message updates can cause message loss on recovery</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="cshannon">Christopher L. Shannon</reporter>
                        <labels>
                    </labels>
                <created>Tue, 19 Jan 2016 15:47:00 +0000</created>
                <updated>Fri, 1 Apr 2016 16:52:32 +0000</updated>
                            <resolved>Fri, 1 Apr 2016 16:52:32 +0000</resolved>
                                    <version>5.13.0</version>
                                    <fixVersion>5.13.1</fixVersion>
                    <fixVersion>5.13.3</fixVersion>
                    <fixVersion>5.14.0</fixVersion>
                                    <component>Broker</component>
                    <component>KahaDB</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15106897" author="christopher.l.shannon" created="Tue, 19 Jan 2016 15:53:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I have attached a test that shows the Queue case breaking.  I think it will also break for durables in certain conditions.  One easy solution is to change line 1416 in MessageDatabase (the warning log message) to &lt;tt&gt;this.updateIndex(tx, command, location);&lt;/tt&gt; and simply add the message if it can&apos;t find it.  However, this is probably not desirable in all cases as I&apos;m guessing there are times when the update should be rejected (such as after an ack).  Another solution is to not garbage collect the original journal file that contains the add command, however then that would lead to having more journal files laying around that couldn&apos;t be garbage collected.&lt;/p&gt;</comment>
                            <comment id="15107665" author="tabish121" created="Tue, 19 Jan 2016 23:24:49 +0000"  >&lt;p&gt;Added a test that shows this in effect using the persistJMSRedelivered policy since that is the place you&apos;d most likely see this happening.  &lt;/p&gt;</comment>
                            <comment id="15108652" author="gtully" created="Wed, 20 Jan 2016 14:57:00 +0000"  >&lt;p&gt;It should add the message if it cannot be found. It is expected that the original gets gced because it is no longer indexed. The update should aim to add or replace.&lt;/p&gt;</comment>
                            <comment id="15108684" author="christopher.l.shannon" created="Wed, 20 Jan 2016 15:12:14 +0000"  >&lt;p&gt;Thanks for the input Gary, I will create a patch and include Tim&apos;s test.&lt;/p&gt;</comment>
                            <comment id="15108915" author="jira-bot" created="Wed, 20 Jan 2016 17:00:48 +0000"  >&lt;p&gt;Commit b4aa53d806570a4f054dc0af9cb095f13b914153 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=b4aa53d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=b4aa53d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6133&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6133&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fixing the processing of KahaUpdateMessageCommand to add the message to&lt;br/&gt;
the store if it doesn&apos;t exist, instead of ignoring it.  This will&lt;br/&gt;
prevent message loss in certain cases when the KahaDB index has to be&lt;br/&gt;
rebuilt.&lt;/p&gt;</comment>
                            <comment id="15108918" author="jira-bot" created="Wed, 20 Jan 2016 17:01:29 +0000"  >&lt;p&gt;Commit adc3ba49c2cfb739ad7619a3aa7c5b518de5c996 in activemq&apos;s branch refs/heads/activemq-5.13.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=adc3ba4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=adc3ba4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6133&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6133&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fixing the processing of KahaUpdateMessageCommand to add the message to&lt;br/&gt;
the store if it doesn&apos;t exist, instead of ignoring it.  This will&lt;br/&gt;
prevent message loss in certain cases when the KahaDB index has to be&lt;br/&gt;
rebuilt.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit b4aa53d806570a4f054dc0af9cb095f13b914153)&lt;/p&gt;</comment>
                            <comment id="15108921" author="christopher.l.shannon" created="Wed, 20 Jan 2016 17:02:40 +0000"  >&lt;p&gt;Patch and test submitted by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt; applied to master and 5.13.x.&lt;/p&gt;</comment>
                            <comment id="15221647" author="christopher.l.shannon" created="Fri, 1 Apr 2016 12:43:24 +0000"  >&lt;p&gt;I&apos;m seeing a race condition issue here where some duplicate messages end up in the store. The issue occurs when persistJmsRedelivered is turned on for a Queue and concurrentStoreAndDispatchQueues is used.&lt;/p&gt;

&lt;p&gt;What I&apos;m seeing is that when rapidly producing/consuming, after a consumer gets all of the messages, sometimes the message reappears.  The cause seems to be that sometimes the message has been acked by the consumer and removed after it has been added to the store but before the update command runs (to set the redelivered flag).  So what happens with this fix is that at the end it will try to update a non-existent message so it will end up re-adding it.&lt;/p&gt;

&lt;p&gt;In a test on my machine with 1 producer/consumer rapidly producing and consuming 50k messages, at the end of the test I consistently see 10-20 messages left over in the store even though the consumer has already received them all.  &lt;/p&gt;

&lt;p&gt;I&apos;m investigating more now to see if there is a good way to fix this without having to completely back out this patch.&lt;/p&gt;</comment>
                            <comment id="15221665" author="christopher.l.shannon" created="Fri, 1 Apr 2016 13:08:12 +0000"  >&lt;p&gt;Actually, I think what is happening is that the update command is running first because it&apos;s not done async like the add message command.  So I think the fix might be to do the update command async as well, or maybe modify the original add message command if it hasn&apos;t been performed yet.&lt;/p&gt;</comment>
                            <comment id="15221713" author="gtully" created="Fri, 1 Apr 2016 14:02:56 +0000"  >&lt;p&gt;hmm. I think concurrentStoreAndDispatchQueues is not compatible with persistJmsRedelivered. The point of persistJmsRedelivered is that the delivery count is persisted &lt;b&gt;before&lt;/b&gt; dispatch which is not the case with concurrentStoreAndDispatchQueues.&lt;br/&gt;
One attribute is a policyEntry, the other on the PA, so it is not easy to enforce but the combination do not make sense.&lt;br/&gt;
Maybe the update is done async but we wait on the future, or we update the inflight write and wait on its future.&lt;br/&gt;
Either way, it may not be trivial and it may be more straightforward to document the incompatibility. The two features are working against each other.&lt;br/&gt;
To force them to coexist will impact both.&lt;/p&gt;</comment>
                            <comment id="15221728" author="christopher.l.shannon" created="Fri, 1 Apr 2016 14:13:45 +0000"  >&lt;p&gt;Good points, and it may not make sense to change anything other than to document the behavior better as pointed out.  I&apos;m testing out a couple things today to see what a fix would look like.  I was thinking one thing that might work would be to update the message that is part of the async task if the task hasn&apos;t started executing yet, else if it has executed then go through the normal update.  Not sure of any side effects of that approach yet though.&lt;/p&gt;</comment>
                            <comment id="15221784" author="christopher.l.shannon" created="Fri, 1 Apr 2016 14:41:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;, After some testing, I agree with your assessment to do nothing.  Indeed it doesn&apos;t really make any sense to try and make the two features coexist.  One issue of trying to update a message async is then you can&apos;t guarantee that it was persisted before dispatch so you negate any benefits. And you already alluded to this when you mentioned the point is to persist before dispatch.  In fact, if anything, I&apos;m seeing slower message rates with added synchronization from trying to do the update.&lt;/p&gt;

&lt;p&gt;In the doMessageSend() method inside Queue where asyncAddQueueMessage() is called, do you think it makes sense to check there if the destination has persistJmsRedelivered enabled and if it does call addMessage() instead?  Or just leave it alone and document it?&lt;/p&gt;</comment>
                            <comment id="15221792" author="gtully" created="Fri, 1 Apr 2016 14:52:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
I like that, isPersistJMSRedelivered is likely selectively used. &lt;/p&gt;

&lt;p&gt;In doMessageSend, &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isPersistJMSRedelivered())  &amp;amp;&amp;amp; messages.isCacheEnabled()  {&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; &lt;br/&gt;
guess the order of the checks could go either way &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;that is safest as it enforces the persistJmsRedelivered semantic. &lt;/p&gt;</comment>
                            <comment id="15221888" author="christopher.l.shannon" created="Fri, 1 Apr 2016 16:04:10 +0000"  >&lt;p&gt;Sounds good, I&apos;ll update that and add a note to the documentation about it.&lt;/p&gt;</comment>
                            <comment id="15221945" author="jira-bot" created="Fri, 1 Apr 2016 16:44:24 +0000"  >&lt;p&gt;Commit b2327db3b79dffd42fd5c6ba85720a5d9c302052 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=b2327db&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=b2327db&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6133&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6133&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Disabling async queue message store when persistJMSRedelivered is turned&lt;br/&gt;
on for a destination.  That flag will cause a sync update later on&lt;br/&gt;
dispatch which can cause a race condition if the original message add is&lt;br/&gt;
processed after the update.  This can cause a duplicate message to be&lt;br/&gt;
stored.&lt;/p&gt;</comment>
                            <comment id="15221961" author="jira-bot" created="Fri, 1 Apr 2016 16:52:12 +0000"  >&lt;p&gt;Commit 8393e6b8ea6cb9953f54cec80df46b8c181c7e7f in activemq&apos;s branch refs/heads/activemq-5.13.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=8393e6b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=8393e6b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6133&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6133&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Disabling async queue message store when persistJMSRedelivered is turned&lt;br/&gt;
on for a destination.  That flag will cause a sync update later on&lt;br/&gt;
dispatch which can cause a race condition if the original message add is&lt;br/&gt;
processed after the update.  This can cause a duplicate message to be&lt;br/&gt;
stored.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit b2327db3b79dffd42fd5c6ba85720a5d9c302052)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12932249">AMQ-6131</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12783215" name="AMQ6133PersistJMSRedeliveryTest.java" size="7865" author="tabish" created="Tue, 19 Jan 2016 23:24:49 +0000"/>
                            <attachment id="12783125" name="AMQ6133Test.java" size="9248" author="cshannon" created="Tue, 19 Jan 2016 15:56:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 33 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2roxj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>