<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:57:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3016] Race condition in DemandForwardingBridgeSupport can cause remote connection to be leaked.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3016</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Symptom&lt;br/&gt;
========&lt;br/&gt;
I set up two Brokers and a network bridge from Broker A to Broker B over HTTP.  When the bridge is established, each Broker has a single transport connection (VM on broker A and HTTP on broker B) as recorded in RegionBroker.connections&lt;/p&gt;

&lt;p&gt;I noticed that when Broker A was stopped (normally), periodically the HTTP connection would remain in Broker B&apos;s RegionBroker.connections until the InactivityMonitor on the connection timed out.  If the InactivityMonitor was disbled, then the connection would remain indefinitely.  &lt;/p&gt;

&lt;p&gt;If Broker A was restarted, the bridge would be restarted and a second connection would be recorded in Broker B&apos;s RegionBroker.connections.  Repeating restarts of Broker A would cause an accumulation of &quot;dead&quot; connections, which would eventually lead to an OOM.&lt;/p&gt;

&lt;p&gt;Cause&lt;br/&gt;
=====&lt;br/&gt;
When Broker A is stopped, DemandForwardingBridgeSupport.stop() is called and sends a ShutdownInfo command to the local and remote transports.  When the transports receive the ShutdownInfo, they remove the connection from their associated RegionBroker.connections as part of  TransportConnection.processRemoveConnection(ConnectionId, long):&lt;/p&gt;

&lt;p&gt;    public synchronized Response processRemoveConnection(ConnectionId id, long lastDeliveredSequenceId)&lt;br/&gt;
            throws InterruptedException {&lt;br/&gt;
...&lt;br/&gt;
            try &lt;/p&gt;
{
                broker.removeConnection(cs.getContext(), cs.getInfo(), null);
            }
&lt;p&gt; catch (Throwable e) &lt;/p&gt;
{
                SERVICELOG.warn(&quot;Failed to remove connection &quot; + cs.getInfo(), e);
            }

&lt;p&gt;In the cases were Broker B would not clean up its connection, I traced the code and discovered that the ShutdownInfo message was not being sent because the remote transport (HttpClientTransport) had already had its &quot;stopped&quot; flag set to true as part of HttpClientTransport.oneway(Object command):&lt;/p&gt;

&lt;p&gt;    public void oneway(Object command) throws IOException {&lt;/p&gt;

&lt;p&gt;        if (isStopped()) &lt;/p&gt;
{
            throw new IOException(&quot;stopped.&quot;);
        }
&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;DemandForwardingBridgeSupport&apos;s stop() method has the following code:&lt;/p&gt;

&lt;p&gt;    public void stop() throws Exception {&lt;br/&gt;
...&lt;br/&gt;
                    ASYNC_TASKS.execute(new Runnable() {&lt;br/&gt;
                        public void run() {&lt;br/&gt;
                            try &lt;/p&gt;
{
                                localBroker.oneway(new ShutdownInfo());
                                sendShutdown.countDown();
                                remoteBroker.oneway(new ShutdownInfo());
                            }
&lt;p&gt; catch (Throwable e) &lt;/p&gt;
{
                                LOG.debug(&quot;Caught exception sending shutdown&quot;, e);
                            }
&lt;p&gt; finally &lt;/p&gt;
{
                                sendShutdown.countDown();
                            }
&lt;p&gt;                        }&lt;br/&gt;
                    });&lt;br/&gt;
                    if (!sendShutdown.await(10, TimeUnit.SECONDS)) &lt;/p&gt;
{
                        LOG.info(&quot;Network Could not shutdown in a timely manner&quot;);
                    }&lt;br/&gt;
                } finally {
                    ServiceStopper ss = new ServiceStopper();
                    ss.stop(remoteBroker);
                    ss.stop(localBroker);
                    // Release the started Latch since another thread could be
                    // stuck waiting for it to start up.
                    startedLatch.countDown();
                    startedLatch.countDown();
                    localStartedLatch.countDown();
                    ss.throwFirstException();
                }&lt;br/&gt;
            }&lt;br/&gt;
&lt;br/&gt;
ShutdownInfo is sent asynchronously to the local and remote transports by a slave thread:&lt;br/&gt;
&lt;br/&gt;
                                localBroker.oneway(new ShutdownInfo());&lt;br/&gt;
                                sendShutdown.countDown();&lt;br/&gt;
                                remoteBroker.oneway(new ShutdownInfo());&lt;br/&gt;
&lt;br/&gt;
The sendShutdown  latch is used by the master thread to prevent running the finally clause until the ShutdownInfo has been sent:&lt;br/&gt;
&lt;br/&gt;
                    if (!sendShutdown.await(10, TimeUnit.SECONDS)) {                        LOG.info(&quot;Network Could not shutdown in a timely manner&quot;);                    }
&lt;p&gt;                } finally &lt;/p&gt;
{
                    ServiceStopper ss = new ServiceStopper();
                    ss.stop(remoteBroker);
                    ss.stop(localBroker);
...
                }
&lt;p&gt;            }&lt;/p&gt;

&lt;p&gt;However, because the latch is countdown &lt;b&gt;before&lt;/b&gt; remoteTransport.oneway(new ShutdownInfo()) there is a race condition and in most cases the main thread calls ss.stop(remoteBroker) before the slave thread has completed its call to remoteTransport.oneway(new ShutdownInfo()).  As a result, the remoteTransport appears already stopped and the ShutdownInfo is discarded.  This leaves the connection dangling on the remote broker until the InactivityMonitor closes it.&lt;/p&gt;

&lt;p&gt;Solution&lt;br/&gt;
======&lt;br/&gt;
The sendShutdown latch should be countdown &lt;b&gt;after&lt;/b&gt; remoteTransport.oneway(new ShutdownInfo()).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12483820">AMQ-3016</key>
            <summary>Race condition in DemandForwardingBridgeSupport can cause remote connection to be leaked.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="stirlingc">Stirling Chow</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Nov 2010 20:01:12 +0000</created>
                <updated>Tue, 6 Nov 2012 21:50:27 +0000</updated>
                            <resolved>Tue, 6 Nov 2012 21:50:27 +0000</resolved>
                                    <version>5.4.1</version>
                                    <fixVersion>5.8.0</fixVersion>
                                    <component>Connector</component>
                    <component>Transport</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12943175" author="stirlingc" created="Thu, 4 Nov 2010 20:03:03 +0000"  >&lt;p&gt;This unit test exhibits the problem being reported.  In this test, a &quot;validation&quot; run is made using TCP as the bridge transport &amp;#8212; the race condition does not cause a leak because the remote end of the TCP connection detects the closing of the socket and cleans up the connection.  The &quot;failed&quot; run is made using HTTP as the bridge transport.  On my system, the race condition always occurs and causes the unit test to fail.  With the patch applied, both tests always succeed.&lt;/p&gt;</comment>
                            <comment id="12943172" author="stirlingc" created="Thu, 4 Nov 2010 20:08:42 +0000"  >&lt;p&gt;Patch to DemandForwardingBridgeSupport which removes the premature call to sendShutdown.countDown.  countDown is already called by the finally clause.&lt;/p&gt;</comment>
                            <comment id="12943174" author="stirlingc" created="Thu, 4 Nov 2010 20:13:44 +0000"  >&lt;p&gt;Checkin for r808890 added the extra call to sendShutdown.countDown()&lt;/p&gt;</comment>
                            <comment id="12943171" author="eric-awl" created="Fri, 5 Nov 2010 08:25:53 +0000"  >&lt;p&gt;Hi&lt;/p&gt;

&lt;p&gt;Since duplex connections are very different from non-duplex one, this patch must be carefully test in all conditions. &lt;br/&gt;
Did you launch all ActiveMQ Maven tests and verify that no border effects are discovered ?&lt;/p&gt;

&lt;p&gt;Regards&lt;br/&gt;
Eric-AWL&lt;/p&gt;</comment>
                            <comment id="13491857" author="tabish121" created="Tue, 6 Nov 2012 21:50:27 +0000"  >&lt;p&gt;Noticed this also while doing some work in the bridging code.  &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12483857">AMQ-1855</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12461830" name="ConnectionLeakTest.java" size="5012" author="stirlingc" created="Thu, 4 Nov 2010 20:03:02 +0000"/>
                            <attachment id="12461840" name="patch.txt" size="796" author="stirlingc" created="Thu, 4 Nov 2010 20:08:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>74748</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 3 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0earb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>81505</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>