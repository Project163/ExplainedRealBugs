<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:24:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5854] Duplicate messages when failover is done during prepare phase of two phase commit.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5854</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Use case :&lt;br/&gt;
                With Spring DMLC, Read a jms message in a queue, produce a jms message in an output queue and write data in database.&lt;/p&gt;

&lt;p&gt;Problem description :&lt;/p&gt;

&lt;p&gt;                Due to hight CPU usage, the inactity monitor closes connections between clients and broker while 16 messages were processed.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2015-06-01 04:39:01,130 | WARN  | Transport Connection to: tcp://*** failed: org.apache.activemq.transport.InactivityIOException: Channel was inactive for too (&amp;gt;30000) long: tcp://*** | org.apache.activemq.broker.TransportConnection.Transport | ActiveMQ InactivityMonitor Worker
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;                15 messages are rolled back and redilevered to another consummer.&lt;/p&gt;

&lt;p&gt;                In the log we got 15 warnings :&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ActiveMQMessageConsumer   |WARN |jmsContainer-173|rolling back transaction (XID:***) post failover recovery. 1 previously delivered message(s) not replayed to consumer: ***
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;                But one message is not rolled back (the transaction commit) and is also redileverd to another consummer. So it&apos;s processed twice by two different consummers (two inserts in database and two output JMS messages generated) and is not deduplicated.&lt;/p&gt;

&lt;p&gt;                In the activeMq log we got the message :&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN  | Async error occurred:  | org.apache.activemq.broker.TransportConnection.Service | ActiveMQ Transport: tcp:///***
                       javax.jms.JMSException: Unmatched acknowledge: MessageAck {commandId = 6665, responseRequired = false, ackType = 2, consumerId = ID:***, firstMessageId = ID:***-50800-1433109620591-1:2:31356:1:1, lastMessageId = ID:***-50800-1433109620591-1:2:31356:1:1, destination = queue://***, transactionId = XID:[1096044365,globalId=47524f55505f3030303038736572766963657472616974656d656e7431363536373030343133,branchId=47524f55505f3030303038736572766963657472616974656d656e743137343737], messageCount = 1, poisonCause = null}; Could not find Message-ID ID:***-50800-1433109620591-1:2:31356:1:1 in dispatched-list (start of ack)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;                For this duplicated message, the failover occur during prepare phase of commit :&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[{2015/06/01 04:39:50,322 |FailoverTransport         |WARN |jmsContainer-152|Transport (tcp://***) failed, reason:  , attempting to automatically reconnect}]
org.apache.activemq.transport.InactivityIOException: Cannot send, channel has already failed: ***
                at org.apache.activemq.transport.AbstractInactivityMonitor.doOnewaySend(AbstractInactivityMonitor.java:297)
                at org.apache.activemq.transport.AbstractInactivityMonitor.oneway(AbstractInactivityMonitor.java:286)
                at org.apache.activemq.transport.TransportFilter.oneway(TransportFilter.java:85)
                at org.apache.activemq.transport.WireFormatNegotiator.oneway(WireFormatNegotiator.java:104)
                at org.apache.activemq.transport.failover.FailoverTransport.oneway(FailoverTransport.java:658)
                at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:68)
                at org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60)
                at org.apache.activemq.ActiveMQConnection.doAsyncSendPacket(ActiveMQConnection.java:1321)
                at org.apache.activemq.ActiveMQConnection.asyncSendPacket(ActiveMQConnection.java:1315)
                at org.apache.activemq.ActiveMQSession.asyncSendPacket(ActiveMQSession.java:1933)
                at org.apache.activemq.ActiveMQSession.sendAck(ActiveMQSession.java:2099)
                at org.apache.activemq.ActiveMQSession.sendAck(ActiveMQSession.java:2094)
                at org.apache.activemq.ActiveMQMessageConsumer.acknowledge(ActiveMQMessageConsumer.java:1083)
                at org.apache.activemq.ActiveMQMessageConsumer$5.beforeEnd(ActiveMQMessageConsumer.java:1041)
                at org.apache.activemq.TransactionContext.beforeEnd(TransactionContext.java:202)
                at org.apache.activemq.TransactionContext.end(TransactionContext.java:409)
                at com.atomikos.datasource.xa.XAResourceTransaction.suspend(XAResourceTransaction.java:457)
                at com.atomikos.datasource.xa.XAResourceTransaction.prepare(XAResourceTransaction.java:608)
                at com.atomikos.icatch.imp.PrepareMessage.send(PrepareMessage.java:61)
                at com.atomikos.icatch.imp.PropagationMessage.submit(PropagationMessage.java:111)
                at com.atomikos.icatch.imp.Propagator$PropagatorThread.run(Propagator.java:87)
                at com.atomikos.icatch.imp.Propagator.submitPropagationMessage(Propagator.java:66)
                at com.atomikos.icatch.imp.ActiveStateHandler.prepare(ActiveStateHandler.java:173)
                at com.atomikos.icatch.imp.CoordinatorImp.prepare(CoordinatorImp.java:832)
                at com.atomikos.icatch.imp.CoordinatorImp.terminate(CoordinatorImp.java:1159)
                at com.atomikos.icatch.imp.CompositeTerminatorImp.commit(CompositeTerminatorImp.java:92)
                at com.atomikos.icatch.jta.TransactionImp.commit(TransactionImp.java:236)
                at com.atomikos.icatch.jta.TransactionManagerImp.commit(TransactionManagerImp.java:498)
                at com.atomikos.icatch.jta.UserTransactionImp.commit(UserTransactionImp.java:129)
                at org.springframework.transaction.jta.JtaTransactionManager.doCommit(JtaTransactionManager.java:1011)
                at org.springframework.transaction.support.AbstractPlatformTransactionManager.processCommit(AbstractPlatformTransactionManager.java:755)
                at org.springframework.transaction.support.AbstractPlatformTransactionManager.commit(AbstractPlatformTransactionManager.java:724)
                at org.springframework.jms.listener.AbstractPollingMessageListenerContainer.receiveAndExecute(AbstractPollingMessageListenerContainer.java:257)
                at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.invokeListener(DefaultMessageListenerContainer.java:1101)
                at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.run(DefaultMessageListenerContainer.java:995)
                at java.lang.Thread.run(Thread.java:761)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Our analysis :&lt;/p&gt;

&lt;p&gt;                We think that the duplicate message is caused by the failover during the prepare phase of the commit so we modify the source code to reproduce the case.&lt;/p&gt;

&lt;p&gt;                Our modifications in config to produce failovers:&lt;br/&gt;
                               broker : transport.useKeepAlive=false&lt;br/&gt;
                               client : wireFormat.maxInactivityDuration=5000&lt;/p&gt;


&lt;p&gt;                We add Thread.sleep in the source code of org.apache.activemq.ActiveMQMessageConsumer to force failover to be done exactly where we think it causes problems :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;org.apache.activemq.ActiveMQMessageConsumer#acknowledge()&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                

                    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void acknowledge() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; JMSException {
                               clearDeliveredList();
                               waitForRedeliveries();
                               &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(deliveredMessages) {

                                   &lt;span class=&quot;code-comment&quot;&gt;// BEGIN MODIFIED CODE
&lt;/span&gt;                                   LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;start sleeping 20 seconds to test failover&quot;&lt;/span&gt;);
                                   &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;{
                                       &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000 * 20 );
                                   }&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e){
                                       LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exception :&quot;&lt;/span&gt;,e);
                                   }
                                   LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;end sleeping 20 seconds to test failover&quot;&lt;/span&gt;);
                                   &lt;span class=&quot;code-comment&quot;&gt;// END MODIFIED CODE
&lt;/span&gt;
                                   &lt;span class=&quot;code-comment&quot;&gt;// Acknowledge all messages so far.
&lt;/span&gt;                                   MessageAck ack = makeAckForAllDeliveredMessages(MessageAck.STANDARD_ACK_TYPE);
                                   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ack == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
                                       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// no msgs
&lt;/span&gt;
                                   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (session.getTransacted()) {
                                       rollbackOnFailedRecoveryRedelivery();
                                       session.doStartTransaction();
                                       ack.setTransactionId(session.getTransactionContext().getTransactionId());
                                   }

                                   pendingAck = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                                    session.sendAck(ack);

                                   &lt;span class=&quot;code-comment&quot;&gt;// Adjust the counters
&lt;/span&gt;                                   deliveredCounter = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(0, deliveredCounter - deliveredMessages.size());
                                   additionalWindowSize = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(0, additionalWindowSize - deliveredMessages.size());

                                   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!session.getTransacted()) {
                                       deliveredMessages.clear();
                                   }
                               }
                    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;                               

&lt;p&gt;                With these changes on the configuration and the code, the problem is easily reproduced.&lt;/p&gt;

&lt;p&gt;                We also try with transactedIndividualAck=true, and we add a Thread.sleep in the code :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;org.apache.activemq.ActiveMQMessageConsumer#registerSync()&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                
                    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void registerSync() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; JMSException {
                               session.doStartTransaction();
                               &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!synchronizationRegistered) {
                                   synchronizationRegistered = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
                                   session.getTransactionContext().addSynchronization(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Synchronization() {
                                       @Override
                                       &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void beforeEnd() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                                           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (transactedIndividualAck) {
                                               clearDeliveredList();
                                               waitForRedeliveries();
                                               &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(deliveredMessages) {
                                                   
                                                   &lt;span class=&quot;code-comment&quot;&gt;// BEGIN MODIFIED CODE
&lt;/span&gt;                                                   LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;start sleeping 20 seconds to test failover&quot;&lt;/span&gt;);
                                                   &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;{
                                                       &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000 * 20 );
                                                   }&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e){
                                                       LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exception :&quot;&lt;/span&gt;,e);
                                                   }
                                                   LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;end sleeping 20 seconds to test failover&quot;&lt;/span&gt;);
                                                   &lt;span class=&quot;code-comment&quot;&gt;// END MODIFIED CODE                            
&lt;/span&gt;
                                                   rollbackOnFailedRecoveryRedelivery();
                                               }
                                           } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                                               acknowledge();
                                           }
                                           synchronizationRegistered = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
                                       }

                                       @Override
                                       &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void afterCommit() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                                           commit();
                                           synchronizationRegistered = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
                                       }

                                       @Override
                                       &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void afterRollback() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                                           rollback();
                                           synchronizationRegistered = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
                                       }
                                   });
                               }
                    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;                                               
&lt;p&gt;                With these modifications, we still get duplicates messages.&lt;/p&gt;

&lt;p&gt;                We think that the problem is that the statement synchronized(deliveredMessages) prevents the call of clearDeliveredList() by another ActiveMQConnection thread that clears messages in progress.&lt;br/&gt;
                By adding logs we observe that a thread is waiting deliveredMessages &#8216;s lock in clearDeliveredList() method.&lt;/p&gt;


&lt;p&gt;Question :&lt;/p&gt;

&lt;p&gt;                We tried fixes described in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5068&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5068&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3519&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-3519&lt;/a&gt; but it doesn&#8217;t help to solve our problem.&lt;br/&gt;
                Is there a workaround or a config parameter that can help to prevent this problem ?&lt;/p&gt;

&lt;p&gt;                We are working on our side to find a correction. An option may be to force rolling back transaction if there is a failover during the prepare phase of commit in ConnectionStateTracker.restoreTransactions().&lt;/p&gt;

</description>
                <environment>&lt;p&gt;Ubuntu or AIX&lt;br/&gt;
ActiveMQ 5.9.1 (problem is reproduced in 5.10.2 and 5.11.1)&lt;br/&gt;
Spring DMLC&lt;br/&gt;
XA transactions with atomikos 3.7.0 (problem is also reproduced with 3.9.15)&lt;br/&gt;
Persistent messages&lt;br/&gt;
Multithreading (this problem occur when there is at least 2 consummers on a queue)&lt;/p&gt;</environment>
        <key id="12839158">AMQ-5854</key>
            <summary>Duplicate messages when failover is done during prepare phase of two phase commit.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="michael.s">Michael</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Jun 2015 15:36:33 +0000</created>
                <updated>Sun, 22 Nov 2015 18:37:16 +0000</updated>
                            <resolved>Mon, 28 Sep 2015 14:13:10 +0000</resolved>
                                    <version>5.9.1</version>
                    <version>5.10.2</version>
                    <version>5.11.1</version>
                                    <fixVersion>5.13.0</fixVersion>
                                    <component>Broker</component>
                    <component>JMS client</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="14605833" author="michael.s" created="Mon, 29 Jun 2015 16:19:32 +0000"  >&lt;p&gt;We think that our issue is related to issue &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2590&quot; title=&quot;Transaction commit/rollback through failover should throw TransactionRolledBackException if recovery redelivery dispatches to another consumer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2590&quot;&gt;&lt;del&gt;AMQ-2590&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In the &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2590&quot; title=&quot;Transaction commit/rollback through failover should throw TransactionRolledBackException if recovery redelivery dispatches to another consumer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2590&quot;&gt;&lt;del&gt;AMQ-2590&lt;/del&gt;&lt;/a&gt; issue, only one phase commit transactions are rolled back in case of failover.&lt;/p&gt;

&lt;p&gt;We change the ConnectionStateTracker code (in 5.10.2) to rollback others type of transaction (BEGIN and PREPARE).&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;org.apache.activemq.state.ConnectionStateTracker.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void restoreTransactions(Transport transport, ConnectionState connectionState) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        Vector&amp;lt;TransactionInfo&amp;gt; toRollback = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Vector&amp;lt;TransactionInfo&amp;gt;();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (TransactionState transactionState : connectionState.getTransactionStates()) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isDebugEnabled()) {
                LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;tx: &quot;&lt;/span&gt; + transactionState.getId());
            }

            &lt;span class=&quot;code-comment&quot;&gt;// rollback any completed transactions - no way to know &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; commit got there
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// or &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; reply went missing
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!transactionState.getCommands().isEmpty()) {
                Command lastCommand = transactionState.getCommands().get(transactionState.getCommands().size() - 1);
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastCommand &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; TransactionInfo) {
                    TransactionInfo transactionInfo = (TransactionInfo) lastCommand;
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (transactionInfo.getType() == TransactionInfo.COMMIT_ONE_PHASE
                            &lt;span class=&quot;code-comment&quot;&gt;// BEGIN MODIFIED CODE					
&lt;/span&gt;                            || transactionInfo.getType() == TransactionInfo.BEGIN
                            || transactionInfo.getType() == TransactionInfo.PREPARE
                            &lt;span class=&quot;code-comment&quot;&gt;// END MODIFIED CODE							
&lt;/span&gt;                            ) {
                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isDebugEnabled()) {
                            LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;rolling back potentially completed tx: &quot;&lt;/span&gt; + transactionState.getId());
                        }
                        toRollback.add(transactionInfo);
                        &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
                    }
                }
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With this change we can not reproduce our duplicated messages issue.&lt;/p&gt;

&lt;p&gt;Is there a specific reason why only one phase transactions are rolled back in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2590&quot; title=&quot;Transaction commit/rollback through failover should throw TransactionRolledBackException if recovery redelivery dispatches to another consumer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2590&quot;&gt;&lt;del&gt;AMQ-2590&lt;/del&gt;&lt;/a&gt; ?&lt;/p&gt;

&lt;p&gt;We are working on our side to provide a test case to reproduce the duplicated message issue.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="14680372" author="nannou9" created="Mon, 10 Aug 2015 17:07:31 +0000"  >&lt;p&gt;Hi Michael!&lt;/p&gt;

&lt;p&gt;1st of all thank you for your work you&apos;ve done so far, it is very helpful.&lt;/p&gt;

&lt;p&gt;So basing on your work, I was able to reproduce the problem with Atomikos 3.9.26 (which include important fix for rollback to fail) but also confirmed this problem to occur with Apache Geronimo transaction manger.&lt;br/&gt;
This proves that problem is purely ActiveMQ related.&lt;br/&gt;
I&apos;ve also tested JBoss A-MQ 6.1 (5.9 based) and 6.2 (5.11 based)- all affected with same problem!&lt;/p&gt;

&lt;p&gt;What is important to say here is that this problem will occur significantly more often on slow envs which prone to freeze/restart (virtual machines especially).&lt;/p&gt;

&lt;p&gt;Let&apos;s see now what will happen and whether someone will grab that task.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="14729084" author="hakim.acharifi" created="Thu, 3 Sep 2015 13:58:05 +0000"  >&lt;p&gt;In order to reproduce the AMQ5854 issue, we have created a maven project amq5854 (see the attached amq5854.tar.gz).&lt;/p&gt;

&lt;p&gt;The abnormal behavior has been reproduced in 2 versions of AMQ : 5.10.2 and 5.11.1&lt;/p&gt;

&lt;p&gt;The goal is to feign an overloaded CPU by modifying the activemq-client-xxx.jar with a sleep of 20 seconds during the consumption of the message.&lt;/p&gt;

&lt;p&gt;Prerequisites to be able to reproduce the abnormal behavior :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Consumer : failover, wireFormat.maxInactivityDuration=5000 and RedeliveryPolicy with a maximumRedeliveries of 3 times&lt;/li&gt;
	&lt;li&gt;Broker : transport.useKeepAlive=false&lt;/li&gt;
	&lt;li&gt;activemq-client-xxx.jar : add Thread.sleep(20*1000) on the org.apache.activemq.ActiveMQMessageConsumer (see the attached sources)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Use case :&lt;/p&gt;

&lt;p&gt;A producer send a message to the INPUT_QUEUE queue on an embedded broker.&lt;br/&gt;
Then a consumer implemented by a Spring Listener consume this message from the INPUT_QUEUE, transform it and send it to another queue (OUTPUT_QUEUE).&lt;br/&gt;
The read from INPUT_QUEUE and the write to OUTPUT_QUEUE are included in a same transaction XA.&lt;/p&gt;

&lt;p&gt;With the activemq-client modification, the consumption of the message is superior of 20 seconds and the maxInactivatyDuration for the consumer is 5 seconds.&lt;br/&gt;
Hence, we will be always in the case where an InactivityIOException prevent the arrival of the message on the OUTPUT_QUEUE because of the rollback transaction request.&lt;br/&gt;
So the expected result is to have 1 message in DLQ (Dead Letter Queue) and no message in the OUTPUT_QUEUE.&lt;br/&gt;
But due to the abnormal behavior, Activemq do not rollback the write on the OUTPUT_QUEUE. &lt;br/&gt;
So After 3 retries,  we have 1 message on DLQ and  3 duplicate messages on the OUTPUT_QUEUE.&lt;/p&gt;
</comment>
                            <comment id="14729092" author="hakim.acharifi" created="Thu, 3 Sep 2015 14:03:48 +0000"  >&lt;p&gt;maven project amq5854 and the modified activemq-client-xxx.jar &lt;/p&gt;</comment>
                            <comment id="14904713" author="gtully" created="Wed, 23 Sep 2015 15:58:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michael.s&quot; class=&quot;user-hover&quot; rel=&quot;michael.s&quot;&gt;michael.s&lt;/a&gt; the intent of the tracker to to maintain the transaction state, and recover it, if it can. If the commit request gets a failure then it is impossible to know if the message got there or if the reply was lost so notifying the client is the only option. Otherwise failover can try and recreate the transaction state and allow it to complete.&lt;br/&gt;
In hindsight, trying to maintain transaction semantics across failover (especially in the context of multiple consumers) seems too complex.&lt;br/&gt;
I want to investigate the fix for this issue and see if it is better to implement the fix or remove this feature altogether and just rollback any indoubt transaction on failover.&lt;/p&gt;</comment>
                            <comment id="14933301" author="jira-bot" created="Mon, 28 Sep 2015 13:41:35 +0000"  >&lt;p&gt;Commit 8d982479e9a5579fc3f6da04109a1b3ef69431eb in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=8d98247&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=8d98247&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5854&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5854&lt;/a&gt; - fix and test. Ensure transaction rollback if there are pending acks during a failover reconnect. Reliably tracking pending acks to eusure possible redelivery is too complex in the context of acks getting dropped by failover or ignored by the subscription, in addition to being sent async. Couple that with multiple consumers on the same connection and the locking of message delivery; only safe course is to ensure rollback outcome.&lt;/p&gt;</comment>
                            <comment id="14933341" author="gtully" created="Mon, 28 Sep 2015 14:13:10 +0000"  >&lt;p&gt;I have implemented a rollback only option on the transaction context that is triggered by a failover, the initial disconnect that will trigger a reconnect.&lt;br/&gt;
If there are pending acks, so messages that need an ack in the transaction, a rollback is forced. This seems the only sensible option.&lt;br/&gt;
There is a new unit test that simulates a delayed or slow ack, consumer side, with an additional transaction synchronization and can reliably reproduce the missed ack.&lt;/p&gt;</comment>
                            <comment id="14933384" author="nannou9" created="Mon, 28 Sep 2015 14:43:50 +0000"  >&lt;p&gt;Excellent news!&lt;br/&gt;
Thanks Gary!&lt;/p&gt;</comment>
                            <comment id="14935075" author="jira-bot" created="Tue, 29 Sep 2015 12:15:29 +0000"  >&lt;p&gt;Commit 92e1f60d984d0e29eade47dbb6d2d30d838254c2 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=92e1f60&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=92e1f60&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5854&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5854&lt;/a&gt; - tidy up test&lt;/p&gt;</comment>
                            <comment id="14936603" author="hakim.acharifi" created="Wed, 30 Sep 2015 09:05:51 +0000"  >&lt;p&gt;Thanks Gary for fixing this issue !&lt;/p&gt;

&lt;p&gt;Looks okay to us.&lt;/p&gt;</comment>
                            <comment id="14936683" author="gtully" created="Wed, 30 Sep 2015 10:25:27 +0000"  >&lt;p&gt;good to know. thank for the verification&lt;/p&gt;</comment>
                            <comment id="14936693" author="jira-bot" created="Wed, 30 Sep 2015 10:41:49 +0000"  >&lt;p&gt;Commit fc25535748fb8dbaea588203086c4802d1ccf091 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=fc25535&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=fc25535&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5854&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5854&lt;/a&gt; - fix intermittent test failure&lt;/p&gt;</comment>
                            <comment id="15021120" author="jira-bot" created="Sun, 22 Nov 2015 18:37:16 +0000"  >&lt;p&gt;Commit de5d0d9430838948196f573c5278c75fbee9f25e in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=de5d0d9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=de5d0d9&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5854&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5854&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fix intermittent test failure caused by the test reconnecting before&lt;br/&gt;
the failure assertion had a chance to assert the expected failure&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12753991" name="ActiveMQMessageConsumer-5.10.2-ModifyWithThreadSleep.java" size="68147" author="hakim.acharifi" created="Thu, 3 Sep 2015 14:03:48 +0000"/>
                            <attachment id="12753992" name="ActiveMQMessageConsumer-5.11.1-ModifyWithThreadSleep.java" size="68730" author="hakim.acharifi" created="Thu, 3 Sep 2015 14:03:48 +0000"/>
                            <attachment id="12753990" name="amq5854.tar.gz" size="3205982" author="hakim.acharifi" created="Thu, 3 Sep 2015 14:03:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2g9qf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>