<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:42:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1855] bridge reconnection stops because of race in SimpleDiscoveryAgent</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1855</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I believe there is a race condition in SimpleDiscoveryAgent which can cause subsequent bridge restart to fail, without starting new thread that should restart a bridge. As a consequence, network bridge is never restarted.&lt;/p&gt;

&lt;p&gt;Following scenario leads to this:&lt;br/&gt;
1. bridge is disconnected (e.g. local error: org.apache.activemq.transport.InactivityIOException: Channel was inactive for too long)&lt;br/&gt;
2. bridge is disposed in separate thread in DemandForwardingBridge.serviceLocalException&lt;br/&gt;
3. SimpleDiscoveryAgent.serviceFailed is called which starts up another thread which calls DiscoveryNetworkConnector.onServiceAdd which tries to restart bridge&lt;br/&gt;
4. bridge startup can cause javax.jms.InvalidClientIDException: Broker: some_broker2 - Client: NC_some_broker1_inboundlocalhost already connected (this one is caused by race condition with thread disposing the bridge, since given client subscription should be removed by thread disposing the bridge (step 2)&lt;br/&gt;
5. this causes invocation of DemandForwardingBridge.serviceLocalException (this call can be made asynchronously, while previous bridge startup is still in progress)&lt;/p&gt;

&lt;p&gt;As a consequence, multiple threads can end up calling SimpleDiscoveryAgent.serviceFailed simultaneously.&lt;/p&gt;

&lt;p&gt;serviceFailed will call DiscoveryNetworkConnector.onServiceAdd which will try to reconnect bridge. Reconnect logic is guarded by &lt;br/&gt;
if( event.failed.compareAndSet(false, true) ) &lt;/p&gt;

&lt;p&gt;which tries to ensure that only a single thread is reconnecting bridge at some point.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void serviceFailed(DiscoveryEvent devent) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    	
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SimpleDiscoveryEvent event = (SimpleDiscoveryEvent) devent;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( event.failed.compareAndSet(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) ) {
        	
			listener.onServiceRemove(event);
	    	&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; thread = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;() {
	    		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
	
	
	    			&lt;span class=&quot;code-comment&quot;&gt;// We detect a failed connection attempt because the service fails right
&lt;/span&gt;	    			&lt;span class=&quot;code-comment&quot;&gt;// away.
&lt;/span&gt;	    			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( event.connectTime + minConnectTime &amp;gt; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis()  ) {
	    				
	    				event.connectFailures++;
	    				
	    				&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( maxReconnectAttempts&amp;gt;0 &amp;amp;&amp;amp;  event.connectFailures &amp;gt;= maxReconnectAttempts ) {
	    					&lt;span class=&quot;code-comment&quot;&gt;// Don&apos; &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to re-connect
&lt;/span&gt;	    					&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
	    				}
	    				
		                &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(sleepMutex){
		                    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;{
		                    	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( !running.get() )
		                    		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
		                    	
		                        sleepMutex.wait(event.reconnectDelay);
		                    }&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(InterruptedException ie){
                                &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
		                       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
		                    }
		                }
	
		                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!useExponentialBackOff) {
		                    event.reconnectDelay = initialReconnectDelay;
		                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
		                    &lt;span class=&quot;code-comment&quot;&gt;// Exponential increment of reconnect delay.
&lt;/span&gt;		                    event.reconnectDelay*=backOffMultiplier;
		                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(event.reconnectDelay&amp;gt;maxReconnectDelay)
		                        event.reconnectDelay=maxReconnectDelay;
		                }
		                
	    			} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
	    				event.connectFailures = 0;
	                    event.reconnectDelay = initialReconnectDelay;
	    			}
	    			                    			
	            	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( !running.get() )
	            		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
	            	
	    			event.connectTime = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis();
	    			event.failed.set(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
	    			
	    			listener.onServiceAdd(event);
	    		}
	    	};
	    	thread.setDaemon(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
	    	thread.start();
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Prior to calling DiscoveryNetworkConnector.onServiceAdd, event.failed is set to false (T1), and it&apos;s possible for some other thread (T2) to enter block guarded by if( event.failed.compareAndSet(false, true) ) , while reconnect process has already begun by first thread. T2 can satisfy condition: if( event.connectTime + minConnectTime &amp;gt; System.currentTimeMillis()  )  and will enter &lt;br/&gt;
sleepMutex.wait(event.reconnectDelay), but still holding event.failed == true (causing all other calls to serviceFailed not to start thread that will reconnect bridge).&lt;/p&gt;

&lt;p&gt;If first thread (T1) fails to reconnect bridge (e.g because of InvalidClientIDException described in step 4), it will not schedule new thread to restart broker (and call DiscoveryNetworkConnector.onServiceRemove, and cleanup DiscoveryNetworkConnector.bridges) because of event.failed == true, and T2 still waiting (default 5 sec). When T2 wakes up from wait, it will try to restart broker and fail because of following condition in DiscoveryNetworkConnector:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (    bridges.containsKey(uri) 
                    || localURI.equals(uri) 
                    || (connectionFilter!=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !connectionFilter.connectTo(uri))
                    )
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;bridges.containsKey(uri) will be true (thread T1 added it while unsuccessfully trying to reconnect bridge), and T2 will return from DiscoveryNetworkConnector.onServiceAdd and will not start bridge. &lt;br/&gt;
No additional attempt to reconnect bridge will be made, since T2 held event.failed == true, effectively ignoring SimpleDiscoveryAgent.serviceFailed calls from other threads processing local or remote bridge exceptions.&lt;/p&gt;

&lt;p&gt;End result:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;DiscoveryNetworkConnector.bridges contains bridge that is disposed and prevents all other attempts to restart bridge (onServiceAdd always returns because bridges.containsKey(uri) == true)&lt;/li&gt;
	&lt;li&gt;SimpleDiscoveryAgent doesn&apos;t try to reconnect the bridge (T2 was a last attempt which returned without restarting the bridge - SimpleDiscoveryAgent.serviceFailed is not called again, since bridge is not started&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think that synchronization of threads processing bridge exceptions and entering SimpleDiscoveryAgent.serviceFailed should be verified and/or improved.&lt;br/&gt;
Also, InvalidClientIDException is relatively common (at least on multicore machines, e.g. Solaris T2000), maybe ConduitBridge.serviceLocalException (which starts another thread doing ServiceSupport.dispose(DemandForwardingBridgeSupport.this)), should be changed to wait a bit for bridge disposal to finish (e.g. sleep for some time) and then try to restart a bridge - waiting for a second more to restart a bridge is better then not to start it at all&lt;/p&gt;

&lt;p&gt;I&apos;ve seen this problem in 4.1.0 and 4.1.2, but I think it can occur in 5.1 and 5.2 trunk (SimpleDiscoveryAgent.serviceFailed and DiscoveryNetworkConnector.onServiceAdd are more or less the same, just using ASYNC_TASKS to execute asynchronous calls, instead of starting new threads directly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12483857">AMQ-1855</key>
            <summary>bridge reconnection stops because of race in SimpleDiscoveryAgent</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="mlukica">Mario Lukica</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Jul 2008 13:30:13 +0000</created>
                <updated>Thu, 4 Nov 2010 20:13:44 +0000</updated>
                            <resolved>Mon, 31 Aug 2009 09:05:46 +0000</resolved>
                                    <version>4.1.2</version>
                                    <fixVersion>5.3.0</fixVersion>
                                    <component>Connector</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12941538" author="gtully" created="Thu, 27 Aug 2009 14:27:54 +0000"  >&lt;p&gt;the enhancements in &lt;a href=&quot;http://svn.apache.org/viewvc?rev=805361&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=805361&amp;amp;view=rev&lt;/a&gt; can help configure a faster timeout on a discovered network connector. &lt;/p&gt;</comment>
                            <comment id="12940899" author="gtully" created="Mon, 31 Aug 2009 09:05:45 +0000"  >&lt;p&gt;though I could not reproduce, the changes in revision &lt;a href=&quot;http://svn.apache.org/viewcvs?view=rev&amp;amp;rev=808890&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs?view=rev&amp;amp;rev=808890&lt;/a&gt; will fix this issue for both the simple discovery and multicast discovery providers.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12483820">AMQ-3016</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84586</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 13 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ku1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>119685</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>