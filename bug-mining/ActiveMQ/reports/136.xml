<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:32:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-876] Kaha DB cannot locate queue data files</title>
                <link>https://issues.apache.org/jira/browse/AMQ-876</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Keep getting exception below.  Note that you are looking for queue-data-1, but actual file name is data-queue-data-1&lt;/p&gt;

&lt;p&gt;$ pwd&lt;br/&gt;
  /cygdrive/d/amq/activemq-kaha/kaha.db&lt;br/&gt;
$ ls&lt;br/&gt;
data-kaha-1  data-queue-data-1  index-kaha  index-queue-data  index-transactions&lt;/p&gt;

&lt;p&gt;javax.jms.JMSException: java.io.IOException: Could not locate data file queue-data-1&lt;br/&gt;
        at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:46)&lt;br/&gt;
        at org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1154)&lt;br/&gt;
        at org.apache.activemq.TransactionContext.commit(TransactionContext.java:260)&lt;br/&gt;
        at org.apache.activemq.ActiveMQSession.commit(ActiveMQSession.java:464)&lt;br/&gt;
        at com.barra.cp.common.io.MultiQueueReceiver.onMessage(MultiQueueReceiver.java:163)&lt;br/&gt;
        at com.barra.cp.common.io.SingleMessageMultiQueueReceiver$OneMessageAtATime.runMultiQueue(SingleMessageMultiQueueReceiver.java:176)&lt;br/&gt;
        at com.barra.cp.common.io.SingleMessageMultiQueueReceiver$OneMessageAtATime.doRun(SingleMessageMultiQueueReceiver.java:143)&lt;br/&gt;
        at com.barra.cp.common.io.SingleMessageMultiQueueReceiver$OneMessageAtATime.run(SingleMessageMultiQueueReceiver.java:124)&lt;br/&gt;
        at java.lang.Thread.run(Unknown Source)&lt;br/&gt;
Caused by: org.apache.activemq.kaha.RuntimeStoreException: java.io.IOException: Could not locate data file queue-data-1&lt;br/&gt;
        at org.apache.activemq.kaha.impl.MapContainerImpl.getValue(MapContainerImpl.java:340)&lt;br/&gt;
        at org.apache.activemq.kaha.impl.MapContainerImpl.remove(MapContainerImpl.java:265)&lt;br/&gt;
        at org.apache.activemq.store.kahadaptor.KahaMessageStore.removeMessage(KahaMessageStore.java:68)&lt;br/&gt;
        at org.apache.activemq.store.kahadaptor.KahaTransaction.commit(KahaTransaction.java:92)&lt;br/&gt;
        at org.apache.activemq.store.kahadaptor.KahaTransactionStore.commit(KahaTransactionStore.java:95)&lt;br/&gt;
        at org.apache.activemq.transaction.LocalTransaction.commit(LocalTransaction.java:68)&lt;br/&gt;
        at org.apache.activemq.broker.TransactionBroker.commitTransaction(TransactionBroker.java:154)&lt;br/&gt;
        at org.apache.activemq.broker.BrokerFilter.commitTransaction(BrokerFilter.java:92)&lt;br/&gt;
        at org.apache.activemq.broker.BrokerFilter.commitTransaction(BrokerFilter.java:92)&lt;br/&gt;
        at org.apache.activemq.broker.MutableBrokerFilter.commitTransaction(MutableBrokerFilter.java:102)&lt;br/&gt;
        at org.apache.activemq.broker.AbstractConnection.processCommitTransactionOnePhase(AbstractConnection.java:330)&lt;br/&gt;
        at org.apache.activemq.command.TransactionInfo.visit(TransactionInfo.java:99)&lt;br/&gt;
        at org.apache.activemq.broker.AbstractConnection.service(AbstractConnection.java:228)&lt;br/&gt;
        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:63)&lt;br/&gt;
        at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:92)&lt;br/&gt;
        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:67)&lt;br/&gt;
        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:123)&lt;br/&gt;
        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:123)&lt;br/&gt;
        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:88)&lt;br/&gt;
        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:127)&lt;br/&gt;
        ... 1 more&lt;br/&gt;
Caused by: java.io.IOException: Could not locate data file queue-data-1&lt;br/&gt;
        at org.apache.activemq.kaha.impl.DataManager.getDataFile(DataManager.java:117)&lt;br/&gt;
        at org.apache.activemq.kaha.impl.StoreDataReader.readItem(StoreDataReader.java:62)&lt;br/&gt;
        at org.apache.activemq.kaha.impl.DataManager.readItem(DataManager.java:121)&lt;br/&gt;
        at org.apache.activemq.kaha.impl.MapContainerImpl.getValue(MapContainerImpl.java:337)&lt;br/&gt;
        ... 20 more&lt;/p&gt;</description>
                <environment>&lt;p&gt;WinXP&lt;/p&gt;</environment>
        <key id="12481732">AMQ-876</key>
            <summary>Kaha DB cannot locate queue data files</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="vpesochi">Vadim Pesochinskiy</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Aug 2006 19:00:50 +0000</created>
                <updated>Wed, 15 Nov 2006 17:54:16 +0000</updated>
                            <resolved>Wed, 15 Nov 2006 17:54:16 +0000</resolved>
                                    <version>4.1.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>Message Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12938409" author="vpesochi" created="Wed, 6 Sep 2006 20:41:26 +0000"  >&lt;p&gt;Sorry, but I still get this problem&lt;/p&gt;

&lt;p&gt;ERROR MapContainerImpl               - Failed to get value for offset=357, key=(-1, -1, 0), value=(-1, -1, 0), previousItem=-1, nextItem=765&lt;/p&gt;

&lt;p&gt;java.io.IOException: Could not locate data file queue-data-1&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.kaha.impl.data.DataManager.getDataFile(DataManager.java:118)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.kaha.impl.data.StoreDataReader.readItem(StoreDataReader.java:62)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.kaha.impl.data.DataManager.readItem(DataManager.java:122)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.kaha.impl.container.MapContainerImpl.getValue(MapContainerImpl.java:344)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.kaha.impl.container.MapContainerImpl.remove(MapContainerImpl.java:272)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.store.kahadaptor.KahaMessageStore.removeMessage(KahaMessageStore.java:68)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.store.kahadaptor.KahaTransaction.commit(KahaTransaction.java:92)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.store.kahadaptor.KahaTransactionStore.commit(KahaTransactionStore.java:95)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.transaction.LocalTransaction.commit(LocalTransaction.java:68)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.broker.TransactionBroker.commitTransaction(TransactionBroker.java:154)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.broker.BrokerFilter.commitTransaction(BrokerFilter.java:93)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.broker.BrokerFilter.commitTransaction(BrokerFilter.java:93)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.broker.MutableBrokerFilter.commitTransaction(MutableBrokerFilter.java:103)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.broker.MutableBrokerFilter.commitTransaction(MutableBrokerFilter.java:103)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.broker.AbstractConnection.processCommitTransactionOnePhase(AbstractConnection.java:330)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.command.TransactionInfo.visit(TransactionInfo.java:99)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.broker.AbstractConnection.service(AbstractConnection.java:228)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:63)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:92)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:67)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:124)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:123)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:88)&lt;/p&gt;

&lt;p&gt;	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:129)&lt;/p&gt;
</comment>
                            <comment id="12938469" author="vpesochi" created="Tue, 12 Sep 2006 00:46:35 +0000"  >
&lt;p&gt;Hi Rob,&lt;/p&gt;

&lt;p&gt;I have been trying to understand what is going on there. Here is what I found out so far. The exception happens in DataManager.getDataFile(DataItem) method. In this method the 2nd line is fileMap.get(key); and the key is -1 when the exception occurs. &lt;/p&gt;

&lt;p&gt;The key is from getFile() method of the DataItem. If you scroll down the stack trace to MapContainerImpl.getValue(), the DataItem&apos;s file field is set from IndexItem&apos;s valueFile member. This value is set &quot;incorrectly&quot; to -1 in MapContainerImpl.remove. &lt;/p&gt;

&lt;p&gt;In this method you find the following lines:&lt;/p&gt;

&lt;p&gt;// ensure we have the upto date item&lt;br/&gt;
item=indexList.getEntry(item);&lt;/p&gt;

&lt;p&gt;The IndexItem item is set from a HashMap in this method and the valueFile field on this object is &quot;correct&quot; (i.e. != -1). However after this line, the value that is read from the file system has the -1 in it, which results in error.&lt;/p&gt;

&lt;p&gt;Quite frankly, I do not yet understand the Kaha code well enough. Can you please guide me to through this, so I can help you with resolving and testing this issue? By the way can you reproduce this JIRA?  &lt;/p&gt;

&lt;p&gt;Regards,&lt;/p&gt;

&lt;p&gt;Vadim&lt;/p&gt;</comment>
                            <comment id="12938410" author="rajdavies" created="Tue, 12 Sep 2006 10:02:55 +0000"  >&lt;p&gt;Hi Vadim,&lt;/p&gt;

&lt;p&gt;I couldn&apos;t reproduce this - and as I&apos;d fixed something like this a few weeks ago - I&apos;d assumed it was fixed.&lt;br/&gt;
Could you try and produce a test case for this ?&lt;/p&gt;

&lt;p&gt;cheers,&lt;/p&gt;

&lt;p&gt;Rob&lt;/p&gt;</comment>
                            <comment id="12938405" author="vpesochi" created="Tue, 12 Sep 2006 16:38:57 +0000"  >&lt;p&gt;Rob,&lt;/p&gt;

&lt;p&gt;Unfortunately it is not easy to reproduce this bug. It happens all the time when I run my test, but not on the same iteration of the test. Sometimes it happens right away, other times I have to wait longer. My test sends 1500 messages but the error happens only once, but every time.&lt;/p&gt;</comment>
                            <comment id="12938197" author="vpesochi" created="Thu, 14 Sep 2006 18:03:58 +0000"  >&lt;p&gt;Hi Rob,&lt;/p&gt;

&lt;p&gt;I just send the test code to help reproduce this problem to you Gmail account. Please let me know if you got it and was able to reproduce the problem. Thanks.&lt;/p&gt;</comment>
                            <comment id="12938340" author="vpesochi" created="Fri, 15 Sep 2006 17:50:39 +0000"  >&lt;p&gt;I am not sure if you got my message or not. Since I am going to be away starting on Monday I am attaching the test and my e-mail.&lt;/p&gt;

&lt;p&gt;&quot;I was unable to write a simple unit test to recreate the problem, so I am attaching simulation test along with some utility classes. I am using IntelliJ Idea and JDK 1.5.2 installed. I am not sure if there is any 1.5 syntax. To run the test just start the broker (with kaha persistence) and execute DailyUpdateSimulationJmsTest JUnit class from Idea (Idea project file included). Sometimes it takes awhile before the error occurs (up to 5 minutes), but most of the time it happens very quickly. To check if error happened &quot;grep&quot; the AMQ log for &quot;Could not locate data file&quot; string. Thanks.&quot;&lt;/p&gt;</comment>
                            <comment id="12936464" author="vpesochi" created="Tue, 3 Oct 2006 22:26:19 +0000"  >&lt;p&gt;Hi Rob,&lt;/p&gt;

&lt;p&gt;Is there any chance you can give me heads up on when you may have time to take a look at this? Thanks.&lt;/p&gt;</comment>
                            <comment id="12938506" author="rajdavies" created="Thu, 5 Oct 2006 10:23:49 +0000"  >&lt;p&gt;Hi Vadim,&lt;/p&gt;

&lt;p&gt;would you mind trying the latest code ? I&apos;ve done some bug fixes in the kaha area today - unfortunately one of the bug fixes means it&apos;s no longer backwards compatible&lt;/p&gt;

&lt;p&gt;cheers,&lt;/p&gt;

&lt;p&gt;Rob&lt;/p&gt;</comment>
                            <comment id="12938459" author="vpesochi" created="Fri, 20 Oct 2006 22:00:46 +0000"  >&lt;p&gt;Hi Rob,&lt;/p&gt;

&lt;p&gt;Yes looks like you got it. Thanks a lot.&lt;/p&gt;</comment>
                            <comment id="12938613" author="vpesochi" created="Wed, 15 Nov 2006 17:54:16 +0000"  >&lt;p&gt;this seems to be fixed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12460610" name="test.zip" size="7151132" author="vpesochi" created="Fri, 15 Sep 2006 17:50:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84510</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            19 years, 2 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0tsr3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>171967</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>