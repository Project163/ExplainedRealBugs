<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:05:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5265] JMX destination entires fail due to race condition in MBeanBridgeDestination</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5265</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;JMX statistics on destinations creates a race condition in the MBeanBridgeDestination&apos;s onInboundMessage, onOutboundMessage, and the purgeInactiveDestinationView task.  If the task fires and removes the objectName while the onInboundMessage or onOutboundMessage fires, it will spit out warnings of it already being created if multiple threads are running.  The fix is to properly synchronize in the purgeInactiveDestinationView and also be sure it cleans up itself in the destinationObjectNameMap.&lt;/p&gt;

&lt;p&gt;Patch is attached as is a git pull request (for whatever is easier)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12726188">AMQ-5265</key>
            <summary>JMX destination entires fail due to race condition in MBeanBridgeDestination</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="jgenender">Jeff Genender</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Jul 2014 21:03:21 +0000</created>
                <updated>Mon, 16 Oct 2023 09:37:32 +0000</updated>
                            <resolved>Wed, 9 Jul 2014 14:58:20 +0000</resolved>
                                    <version>5.9.1</version>
                    <version>5.10.0</version>
                                    <fixVersion>5.10.1</fixVersion>
                    <fixVersion>5.11.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="14055542" author="githubbot" created="Tue, 8 Jul 2014 21:07:39 +0000"  >&lt;p&gt;GitHub user jgenender opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/31&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/31&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5265&quot; title=&quot;JMX destination entires fail due to race condition in MBeanBridgeDestination&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5265&quot;&gt;&lt;del&gt;AMQ-5265&lt;/del&gt;&lt;/a&gt; - fix race condition for task&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5265&quot; title=&quot;JMX destination entires fail due to race condition in MBeanBridgeDestination&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5265&quot;&gt;&lt;del&gt;AMQ-5265&lt;/del&gt;&lt;/a&gt; - fix race condition for task in MBeanBridgeDestination for running the purgeInactiveDestinationViewTask and the execution of onOutboundMessage and onInboundMessage&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jgenender/activemq&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jgenender/activemq&lt;/a&gt; trunk&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/31.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/31.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #31&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit a519384355d0e4acc74e9871ea33e2ee1d113ed5&lt;br/&gt;
Author: Jeff Genender &amp;lt;jgenender@savoirtech.com&amp;gt;&lt;br/&gt;
Date:   2014-07-08T21:05:41Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5265&quot; title=&quot;JMX destination entires fail due to race condition in MBeanBridgeDestination&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5265&quot;&gt;&lt;del&gt;AMQ-5265&lt;/del&gt;&lt;/a&gt; - fix race condition for task&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14056311" author="dejanb" created="Wed, 9 Jul 2014 14:58:20 +0000"  >&lt;p&gt;Patch applied. Thanks!&lt;/p&gt;</comment>
                            <comment id="14315995" author="githubbot" created="Wed, 11 Feb 2015 10:43:38 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/31&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/31&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14527137" author="thammoud" created="Mon, 4 May 2015 19:43:42 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;I do still see the problem in 5.11.1. The culprit is destinationObjectNameMap which is being used for both inbound and outbound messages.  A destination that is put from the onInBoundMessage gets trashed by the one put from the onOutBoundMessage. The cleanup code in the stop() method will clean only one MBean instance leaving the other one dangling. &lt;/p&gt;

&lt;p&gt;My setup is as follows:&lt;/p&gt;

&lt;p&gt;Two Networked Brokers (Full Duplex) (A and B). Two clients each publishing on the same exact topic. Each client is connected to exactly one of the brokers. Kill Broker B. Restart Broker B. On reconnect, you will see the error in Broker A. &lt;/p&gt;
</comment>
                            <comment id="14528487" author="thammoud" created="Tue, 5 May 2015 14:11:34 +0000"  >&lt;p&gt;Attached is a patch that believe will address the issue.&lt;/p&gt;</comment>
                            <comment id="14585211" author="githubbot" created="Sun, 14 Jun 2015 19:16:53 +0000"  >&lt;p&gt;GitHub user Hauenstein opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/114&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/114&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5265&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5265&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This is a revision of &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5265&quot; title=&quot;JMX destination entires fail due to race condition in MBeanBridgeDestination&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5265&quot;&gt;&lt;del&gt;AMQ-5265&lt;/del&gt;&lt;/a&gt; &amp;#8211; the original fix didn&apos;t quite clean up all of the mbeans that MBeanBridgeDestination created, as &lt;span class=&quot;error&quot;&gt;&amp;#91;noted in the original issue by Tarek Hammoud&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5265?focusedCommentId=14527137&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14527137&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5265?focusedCommentId=14527137&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14527137&lt;/a&gt;).  The key for the map used to track the ObjectNames was an ActiveMQDestination (which uses the destination&apos;s physical name for its equals() implementation) caused the inbound and outbound entries in the map to randomly replace each other.&lt;/p&gt;

&lt;p&gt;    Like Tarek, I could reproduce this issue using 5.11.1 with two networked brokers (full duplex) with a client publishing to a topic.  After I restart a broker, the logs on the non-restarted broker show the MBeanBridgeDestination reporting many InstanceAlreadyExistsExceptions when trying to register the unintentionally-duplicated mbeans.&lt;/p&gt;

&lt;p&gt;    Please let me know if this makes sense or if there are any changes you would suggest (ex: is there a reasonable way or an example I could follow to add a unit test for something like this?).  Thanks!&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/Hauenstein/activemq&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Hauenstein/activemq&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/114.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/114.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #114&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 139916e3eee1b60992e13657069358186e57247f&lt;br/&gt;
Author: L. Hauenstein &amp;lt;logan.hauenstein@gmail.com&amp;gt;&lt;br/&gt;
Date:   2015-06-11T18:34:28Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5265&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5265&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Revision of &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5265&quot; title=&quot;JMX destination entires fail due to race condition in MBeanBridgeDestination&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5265&quot;&gt;&lt;del&gt;AMQ-5265&lt;/del&gt;&lt;/a&gt; - fixed the map that tracks&lt;br/&gt;
    MBeanBridgeDestination&apos;s registered mbeans so that it cleans itself up&lt;br/&gt;
    correctly when stopped.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14585772" author="gtully" created="Mon, 15 Jun 2015 10:52:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Hauenstein&quot; class=&quot;user-hover&quot; rel=&quot;Hauenstein&quot;&gt;Hauenstein&lt;/a&gt; peek at &lt;a href=&quot;https://github.com/apache/activemq/blob/138e52b08c2f49b730817932a6e63f2a135854f1/activemq-unit-tests/src/test/java/org/apache/activemq/network/DuplexNetworkMBeanTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/138e52b08c2f49b730817932a6e63f2a135854f1/activemq-unit-tests/src/test/java/org/apache/activemq/network/DuplexNetworkMBeanTest.java&lt;/a&gt; for some unit test inspiration, or other tests in that package&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12654681" name="AMQ-5265.patch" size="2855" author="jgenender" created="Tue, 8 Jul 2014 21:04:39 +0000"/>
                            <attachment id="12730506" name="activemq.patch" size="7302" author="thammoud" created="Tue, 5 May 2015 14:11:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>404295</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 23 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xkwv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>404335</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>