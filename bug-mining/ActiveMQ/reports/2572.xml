<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:10:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5668] NPE in kahadb with concurrentStoreAndDispatchTopics when sending MQTT msgs with different QoS</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5668</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Running KahaDB with concurrentStoreAndDispatchTopics=&quot;true&quot; and sending 3 MQTT messages using different QoS values raises &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2015-03-17 13:27:48,866 WARN ActiveMQ NIO Worker 2 - Failed to send MQTT Publish:
java.lang.NullPointerException
	at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.setLastCachedId(AbstractStoreCursor.java:319)
	at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.trackLastCached(AbstractStoreCursor.java:280)
	at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.addMessageLast(AbstractStoreCursor.java:213)
	at org.apache.activemq.broker.region.cursors.TopicStorePrefetch.addMessageLast(TopicStorePrefetch.java:74)
	at org.apache.activemq.broker.region.cursors.StoreDurableSubscriberCursor.addMessageLast(StoreDurableSubscriberCursor.java:198)
	at org.apache.activemq.broker.region.PrefetchSubscription.add(PrefetchSubscription.java:159)
	at org.apache.activemq.broker.region.DurableTopicSubscription.add(DurableTopicSubscription.java:274)
	at org.apache.activemq.broker.region.policy.SimpleDispatchPolicy.dispatch(SimpleDispatchPolicy.java:48)
	at org.apache.activemq.broker.region.Topic.dispatch(Topic.java:717)
	at org.apache.activemq.broker.region.Topic.doMessageSend(Topic.java:510)
	at org.apache.activemq.broker.region.Topic.send(Topic.java:441)
	at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:419)
	at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:468)
	at org.apache.activemq.broker.jmx.ManagedRegionBroker.send(ManagedRegionBroker.java:297)
	at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:152)
	at org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:96)
	at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:307)
	at org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:157)
	at org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:541)
	at org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:768)
	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:334)
	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:188)
	at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:45)
	at org.apache.activemq.transport.mqtt.MQTTInactivityMonitor.onCommand(MQTTInactivityMonitor.java:147)
	at org.apache.activemq.transport.mqtt.MQTTTransportFilter.sendToActiveMQ(MQTTTransportFilter.java:106)
	at org.apache.activemq.transport.mqtt.MQTTProtocolConverter.sendToActiveMQ(MQTTProtocolConverter.java:173)
	at org.apache.activemq.transport.mqtt.MQTTProtocolConverter.onMQTTPublish(MQTTProtocolConverter.java:445)
	at org.apache.activemq.transport.mqtt.MQTTProtocolConverter.onMQTTCommand(MQTTProtocolConverter.java:210)
	at org.apache.activemq.transport.mqtt.MQTTTransportFilter.onCommand(MQTTTransportFilter.java:94)
	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)
	at org.apache.activemq.transport.mqtt.MQTTCodec$1.onFrame(MQTTCodec.java:54)
	at org.apache.activemq.transport.mqtt.MQTTCodec.processCommand(MQTTCodec.java:79)
	at org.apache.activemq.transport.mqtt.MQTTCodec.access$400(MQTTCodec.java:26)
	at org.apache.activemq.transport.mqtt.MQTTCodec$4.parse(MQTTCodec.java:194)
	at org.apache.activemq.transport.mqtt.MQTTCodec$3.parse(MQTTCodec.java:160)
	at org.apache.activemq.transport.mqtt.MQTTCodec$2.parse(MQTTCodec.java:123)
	at org.apache.activemq.transport.mqtt.MQTTCodec.parse(MQTTCodec.java:65)
	at org.apache.activemq.transport.mqtt.MQTTNIOTransport.serviceRead(MQTTNIOTransport.java:105)
	at org.apache.activemq.transport.mqtt.MQTTNIOTransport.access$000(MQTTNIOTransport.java:43)
	at org.apache.activemq.transport.mqtt.MQTTNIOTransport$1.onSelect(MQTTNIOTransport.java:66)
	at org.apache.activemq.transport.nio.SelectorSelection.onSelect(SelectorSelection.java:97)
	at org.apache.activemq.transport.nio.SelectorWorker$1.run(SelectorWorker.java:119)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;MQTT, KahaDB&lt;/p&gt;</environment>
        <key id="12782550">AMQ-5668</key>
            <summary>NPE in kahadb with concurrentStoreAndDispatchTopics when sending MQTT msgs with different QoS</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="tmielke">Torsten Mielke</reporter>
                        <labels>
                            <label>broker</label>
                            <label>kahadb</label>
                            <label>mqtt</label>
                    </labels>
                <created>Tue, 17 Mar 2015 12:29:34 +0000</created>
                <updated>Wed, 17 Jun 2015 23:11:52 +0000</updated>
                            <resolved>Wed, 17 Jun 2015 23:11:52 +0000</resolved>
                                    <version>5.11.1</version>
                                    <fixVersion>5.12.0</fixVersion>
                                    <component>Broker</component>
                    <component>KahaDB</component>
                    <component>MQTT</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14365057" author="tmielke" created="Tue, 17 Mar 2015 12:31:56 +0000"  >&lt;p&gt;Possible workarounds:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;concurrentStoreAndDispatchTopics=&quot;false&quot; as recommended in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2864&quot; title=&quot;AMQ2149KahaDBTest - intermittent missing/out of order message with restart/failover and durable subs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2864&quot;&gt;&lt;del&gt;AMQ-2864&lt;/del&gt;&lt;/a&gt;,&lt;/li&gt;
	&lt;li&gt;use a different persistence store, e.g. LevelDB&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14365058" author="tmielke" created="Tue, 17 Mar 2015 12:34:07 +0000"  >&lt;p&gt;Attaching unit test in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5668&quot; title=&quot;NPE in kahadb with concurrentStoreAndDispatchTopics when sending MQTT msgs with different QoS&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5668&quot;&gt;&lt;del&gt;AMQ-5668&lt;/del&gt;&lt;/a&gt;Test.tgz. It uses Eclipse Paho MQTT library.&lt;/p&gt;</comment>
                            <comment id="14581313" author="christopher.l.shannon" created="Thu, 11 Jun 2015 01:08:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tmielke&quot; class=&quot;user-hover&quot; rel=&quot;tmielke&quot;&gt;tmielke&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for the bug report and for your test case.  I took a look at this and there is a race condition.  As you pointed out, the best work around is probably to use concurrentStoreAndDispatchTopics=&quot;false&quot; for now.&lt;/p&gt;

&lt;p&gt;In detail, the issue lies in the setLastCacheId method in AbstractStoreCursor which you can see in the stack trace.  In the else clause in that method lastCachedIds[ index].getFutureOrSequenceLong() is returning null because it hasn&apos;t been set yet.  KahaDB assigns that value when the message is added to the store in a transaction.   However the TopicStorePefetch cursor is calling trackLastCached before KahaDB actually gets around to finishing the transaction and assigning the value, which happens asynchronously.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;, What do you guys thisnk about this?  It&apos;s certainly easy enough to add a null check but then the value is never cached in setLastCachedId as it just skips it.  This may not actually be a problem depending on what the lastCacheId is used for.  If I add a null check in, the test case passes but it seems like there could be a larger concurrency issue here that might need to be resolved besides just adding in a check for a null.&lt;/p&gt;</comment>
                            <comment id="14581865" author="gtully" created="Thu, 11 Jun 2015 12:06:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=christopher.l.shannon&quot; class=&quot;user-hover&quot; rel=&quot;christopher.l.shannon&quot;&gt;christopher.l.shannon&lt;/a&gt; - great that you are looking into this, it always helps to have another set of eyes.&lt;br/&gt;
I think there are two things to consider: 1) the value of concurrentStoreAndDispatchTopics=true - I don&apos;t really see the benefit b/c it is very unlikely that all subs will get to ack a message before it is persisted. In the queue case, it does have a beneficial effect b/c it is just a single client that needs to ack fast.&lt;br/&gt;
2) what lastCacheId is used for? When the cache is full it stops tracking messages and when the cache is empty, to avoid replaying all messages from the store the cursor wants to start a store replay from the last message that it cached. There is a setBatch that sets the start point. Implicit in this is that the sequenceId in the store is in sync with the order messages are placed in the cursor. That is the crux of it. If the start point is off, there is a potential for a missed dispatch or a duplicate dispatch. Note - I think the durable topic case is a little simpler because of the per sub index, but that would need to be validated.&lt;/p&gt;

&lt;p&gt;In the queue case, there are a bunch of hoops that ensure ordering because it is complicated with concurrentStoreAndDispatch. The same attention has not been given to the topic case to date.&lt;br/&gt;
If there is a proven usecase for  concurrentStoreAndDispatchTopics=true (point 1) - then the is a case for migrating the work done on queue cursors around lastCacheId to topics.&lt;/p&gt;</comment>
                            <comment id="14582049" author="christopher.l.shannon" created="Thu, 11 Jun 2015 15:13:27 +0000"  >&lt;p&gt;Seeing as how there isn&apos;t really a benefit based on your first point and that there is at least one issue documented (as shown by this NPE), should we go ahead and update the documentation here &lt;a href=&quot;http://activemq.apache.org/kahadb.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/kahadb.html&lt;/a&gt; to specify that &lt;tt&gt;concurrentStoreAndDispatchTopics&lt;/tt&gt; is not recommended to be enabled?  &lt;/p&gt;</comment>
                            <comment id="14582059" author="tabish121" created="Thu, 11 Jun 2015 15:21:27 +0000"  >&lt;p&gt;Agree with that, there doesn&#8217;t seem to be a compelling reason to enable that for Topics. &lt;/p&gt;</comment>
                            <comment id="14582141" author="christopher.l.shannon" created="Thu, 11 Jun 2015 15:57:13 +0000"  >&lt;p&gt;I went ahead and updated the documentation with a warning to specify concurrentStoreAndDispatchTopics is not recommended.  I would say we should probably close this ticket as there is a larger issue here than just the NPE and there isn&apos;t a reason to enable this property right now.  As Gary said, if there is a proven use case then it can be revisited later and a new ticket can be created to migrate the work from the queue case to ensure proper ordering is done.&lt;/p&gt;</comment>
                            <comment id="14588575" author="christopher.l.shannon" created="Tue, 16 Jun 2015 19:02:15 +0000"  >&lt;p&gt;Today I got the exact same null pointer exception in the same spot of the code (setLastCachedId method).  I was just using JMS and not MQTT.  I was doing some testing and I had a producer publishing messages as fast as possible to a topic.  At the time there was an existing offline durable subscription on that topic.  While the producer was running, I removed the durable subscription (using broker.removeSubscription) and the producer received that null pointer exception and closed.  I repeated the test and it didn&apos;t happen every time but I can get it to happen every few times.&lt;/p&gt;

&lt;p&gt;So it seems like it might be a good idea to at least add in a null pointer check to prevent an exception since there is a race condition issue.&lt;/p&gt;</comment>
                            <comment id="14588754" author="gtully" created="Tue, 16 Jun 2015 20:54:44 +0000"  >&lt;p&gt;i wonder if you could try and manufacture a unit test that can reproduce? it does look like some work is needed.&lt;/p&gt;</comment>
                            <comment id="14588808" author="christopher.l.shannon" created="Tue, 16 Jun 2015 21:29:03 +0000"  >&lt;p&gt;I&apos;ll try and come up with a test tomorrow that can reproduce it.  It might be hard to get something that happens reliably but I&apos;ll see what I can do. &lt;/p&gt;</comment>
                            <comment id="14589676" author="christopher.l.shannon" created="Wed, 17 Jun 2015 12:03:18 +0000"  >&lt;p&gt;I was actually able to reproduce this reliably in a unit test.  What I discovered with my use case is that the same line is throwing the exception as the test case that was uploaded to this ticket, but it&apos;s a slightly different issue.  For the the original issue, astCachedIds[ index].getFutureOrSequenceLong() is returning null which causes the Long.compare method to fail.  In my case, with the durable unsubscribe, candidate.getFutureOrSequenceLong() is returning null and causing the problem.&lt;/p&gt;

&lt;p&gt;I&apos;m working on a pull request now to fix both issues and I will push it up shortly.&lt;/p&gt;</comment>
                            <comment id="14589753" author="githubbot" created="Wed, 17 Jun 2015 13:25:50 +0000"  >&lt;p&gt;GitHub user cshannon opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/116&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/116&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5668&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5668&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This commit fixes a race condition in AbstractStoreCursor setLastCacheId that could&lt;br/&gt;
    cause a null pointer exception in certain cases.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/cshannon/activemq&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cshannon/activemq&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5668&quot; title=&quot;NPE in kahadb with concurrentStoreAndDispatchTopics when sending MQTT msgs with different QoS&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5668&quot;&gt;&lt;del&gt;AMQ-5668&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/116.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/116.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #116&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 72f30e9c82d157f2810a9bff315da99d8b7098fb&lt;br/&gt;
Author: Christopher L. Shannon (cshannon) &amp;lt;christopher.l.shannon@gmail.com&amp;gt;&lt;br/&gt;
Date:   2015-06-17T13:23:08Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5668&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5668&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This commit fixes a race condition in AbstractStoreCursor setLastCacheId that could&lt;br/&gt;
    cause a null pointer exception in certain cases.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14589756" author="christopher.l.shannon" created="Wed, 17 Jun 2015 13:29:04 +0000"  >&lt;p&gt;I submitted a PR that fixes the race condition causing the NPE for both the test case uploaded to this ticket and the case that I found.  It solves the race condition problem by saving references off locally to prevent the issue of the state changing (ie becoming null) after the null check was performed. I included a unit test to show that it is fixed.&lt;/p&gt;

&lt;p&gt;Edit: I forgot to mention that there is probably more work to be done here, but this patch at least will prevent the producer from blowing up on sends because of a NPE.&lt;/p&gt;</comment>
                            <comment id="14590818" author="githubbot" created="Wed, 17 Jun 2015 23:10:50 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/116&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/116&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14590819" author="tabish121" created="Wed, 17 Jun 2015 23:11:52 +0000"  >&lt;p&gt;Seems sensible enough to protect from the NPE case, patch applied, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12705075" name="AMQ-5668Test.tgz" size="160489" author="tmielke" created="Tue, 17 Mar 2015 12:34:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 22 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i26v4v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>