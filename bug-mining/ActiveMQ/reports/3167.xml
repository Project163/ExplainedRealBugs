<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:44:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-7002] Activemq SchedulerBroker doSchedule can schedule duplicate jobIds leading to runtime exception </title>
                <link>https://issues.apache.org/jira/browse/AMQ-7002</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Under load we&apos;ve observed that SchedulerBroker will attempt to schedule jobs using the same JobId.&lt;/p&gt;

&lt;p&gt;When JobScheduleView attempts to process these jobs we&apos;ll encounter an exception during the below put call:&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#bbb529&quot;&gt;@Override&lt;/font&gt;&lt;font color=&quot;#cc7832&quot;&gt;public &lt;/font&gt;TabularData &lt;font color=&quot;#ffc66d&quot;&gt;getAllJobs&lt;/font&gt;() &lt;font color=&quot;#cc7832&quot;&gt;throws &lt;/font&gt;Exception {&lt;br/&gt;
 OpenTypeFactory factory = OpenTypeSupport.getFactory(Job.&lt;font color=&quot;#cc7832&quot;&gt;class&lt;/font&gt;)&lt;font color=&quot;#cc7832&quot;&gt;;&lt;/font&gt; CompositeType ct = factory.getCompositeType()&lt;font color=&quot;#cc7832&quot;&gt;;&lt;/font&gt; TabularType tt = &lt;font color=&quot;#cc7832&quot;&gt;new &lt;/font&gt;TabularType(&lt;font color=&quot;#6a8759&quot;&gt;&quot;Scheduled Jobs&quot;&lt;/font&gt;&lt;font color=&quot;#cc7832&quot;&gt;, &lt;/font&gt;&lt;font color=&quot;#6a8759&quot;&gt;&quot;Scheduled Jobs&quot;&lt;/font&gt;&lt;font color=&quot;#cc7832&quot;&gt;, &lt;/font&gt;ct&lt;font color=&quot;#cc7832&quot;&gt;, new &lt;/font&gt;String[] { &lt;font color=&quot;#6a8759&quot;&gt;&quot;jobId&quot; {color}});&lt;/font&gt; TabularDataSupport rc = &lt;font color=&quot;#cc7832&quot;&gt;new &lt;/font&gt;TabularDataSupport(tt)&lt;font color=&quot;#cc7832&quot;&gt;;&lt;/font&gt; List&amp;lt;Job&amp;gt; jobs = &lt;font color=&quot;#cc7832&quot;&gt;this&lt;/font&gt;.&lt;font color=&quot;#9876aa&quot;&gt;jobScheduler&lt;/font&gt;.getAllJobs()&lt;font color=&quot;#cc7832&quot;&gt;;&lt;/font&gt;&lt;font color=&quot;#cc7832&quot;&gt; for &lt;/font&gt;(Job job : jobs) {&lt;br/&gt;
 rc.put(&lt;font color=&quot;#cc7832&quot;&gt;new &lt;/font&gt;CompositeDataSupport(ct&lt;font color=&quot;#cc7832&quot;&gt;, &lt;/font&gt;factory.getFields(job)))&lt;font color=&quot;#cc7832&quot;&gt;;&lt;/font&gt; }&lt;br/&gt;
 &lt;font color=&quot;#cc7832&quot;&gt;return &lt;/font&gt;rc;&lt;br/&gt;
 {color}}&lt;/p&gt;

&lt;p&gt;This can be triggered by clicking on the Schduled tab in the webconsole.&lt;/p&gt;

&lt;p&gt;The error only occurs due to duplicate JobIds.&lt;/p&gt;

&lt;p&gt;Debugging this error, we can see that two jobs with different payloads have the same JobId - this should not be allowed to occur.&lt;/p&gt;

&lt;p&gt;We need to ensure that JobIds are unique.&lt;/p&gt;


&lt;p&gt;Note:&lt;/p&gt;

&lt;p&gt;In test scenario virtual topics are in use, with two consumers.&lt;br/&gt;
Redelivery plugin is also in use on the Broker.&lt;/p&gt;

&lt;p&gt;&amp;lt;plugins&amp;gt;&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &amp;lt;redeliveryPlugin fallbackToDeadLetter=&quot;false&quot; sendToDlqIfMaxRetriesExceeded=&quot;false&quot;&amp;gt;&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &amp;lt;redeliveryPolicyMap&amp;gt;&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &amp;lt;redeliveryPolicyMap&amp;gt;&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &amp;lt;defaultEntry&amp;gt;&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &amp;lt;redeliveryPolicy backOffMultiplier=&quot;2&quot; initialRedeliveryDelay=&quot;60000&quot; maximumRedeliveries=&quot;20&quot; maximumRedeliveryDelay=&quot;300000&quot; useExponentialBackOff=&quot;true&quot;/&amp;gt;&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &amp;lt;/defaultEntry&amp;gt;&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &amp;lt;/redeliveryPolicyMap&amp;gt;&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &amp;lt;/redeliveryPolicyMap&amp;gt;&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &amp;lt;/redeliveryPlugin&amp;gt;&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &amp;lt;/plugins&amp;gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Java 8&lt;br/&gt;
AMQ 5.15.4&lt;/p&gt;</environment>
        <key id="13168372">AMQ-7002</key>
            <summary>Activemq SchedulerBroker doSchedule can schedule duplicate jobIds leading to runtime exception </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="jgoodyear">Jamie Mark Goodyear</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Jun 2018 14:24:39 +0000</created>
                <updated>Wed, 27 Jun 2018 16:42:46 +0000</updated>
                            <resolved>Wed, 27 Jun 2018 16:42:46 +0000</resolved>
                                    <version>5.15.4</version>
                                    <fixVersion>5.15.5</fixVersion>
                    <fixVersion>5.16.0</fixVersion>
                                    <component>Broker</component>
                    <component>Job Scheduler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16523801" author="gtully" created="Tue, 26 Jun 2018 14:28:39 +0000"  >&lt;p&gt;running the scheduled package:&#160;org.apache.activemq.broker.scheduler - from activemq-unit-tests would mostly verify if there is any code that depends on the messageId being the jobId&lt;/p&gt;</comment>
                            <comment id="16525025" author="jgoodyear" created="Wed, 27 Jun 2018 13:02:49 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12929402/12929402_amq7002-master.patch&quot; title=&quot;amq7002-master.patch attached to AMQ-7002&quot;&gt;amq7002-master.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Please find attached a patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7002&quot; title=&quot;Activemq SchedulerBroker doSchedule can schedule duplicate jobIds leading to runtime exception &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7002&quot;&gt;&lt;del&gt;AMQ-7002&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The code change is to start using ID_GENERATOR to set JobId when scheduling a job instead of using messageId.&lt;/p&gt;

&lt;p&gt;The test suits in Broker, unit tests &amp;amp; use cases all pass with this change in place.&lt;/p&gt;

&lt;p&gt;A unit test, AMQ7002Test, has been created to exercise this code.&lt;/p&gt;

&lt;p&gt;In short the unit test configures a broker with redelivery plugin installed, and send a message to a virtual topic with two consumers.&lt;br/&gt;
The consumers will perform a rollback operation, this causes the scheduler to come into play.&lt;br/&gt;
When then check that the jobs in the scheduler have unique IDs.&lt;/p&gt;

&lt;p&gt;If we do not have the ID_GENERATOR in play than this test case fails, with the ID_GENERATOR we get the unique IDs we require.&lt;/p&gt;

&lt;p&gt;JobIDs need to be unique in the scheduler. Under the existing code its possible for a race condition in which two or more jobs get the same JobID while having different payloads, the ID_GENERATOR resolves this issue by ensuring each job ID is unique.&lt;/p&gt;

&lt;p&gt;Please review this patch for both the AMQ 5.15.x and 5.16.x (master) branches. &lt;/p&gt;

&lt;p&gt;I&apos;d like to thank jgenender, joed, hkesler, and gtully for helping in identifying the issue and how to test/exercise the fix.&lt;/p&gt;</comment>
                            <comment id="16525035" author="jira-bot" created="Wed, 27 Jun 2018 13:14:56 +0000"  >&lt;p&gt;Commit e0aa091d9ef16fb3f2a570a95bbd4326abc58941 in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e0aa091&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e0aa091&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7002&quot; title=&quot;Activemq SchedulerBroker doSchedule can schedule duplicate jobIds leading to runtime exception &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7002&quot;&gt;&lt;del&gt;AMQ-7002&lt;/del&gt;&lt;/a&gt; - ensure uniqueue jobids, fix and test via patch from Jamie goodyear applied with thanks&lt;/p&gt;</comment>
                            <comment id="16525038" author="jira-bot" created="Wed, 27 Jun 2018 13:17:31 +0000"  >&lt;p&gt;Commit 4cbb913271c6c41196c425dd9c32050d6a3d7030 in activemq&apos;s branch refs/heads/activemq-5.15.x from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=4cbb913&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=4cbb913&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7002&quot; title=&quot;Activemq SchedulerBroker doSchedule can schedule duplicate jobIds leading to runtime exception &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7002&quot;&gt;&lt;del&gt;AMQ-7002&lt;/del&gt;&lt;/a&gt; - ensure uniqueue jobids, fix and test via patch from Jamie goodyear applied with thanks&lt;/p&gt;

&lt;p&gt;(cherry picked from commit e0aa091d9ef16fb3f2a570a95bbd4326abc58941)&lt;/p&gt;</comment>
                            <comment id="16525080" author="gtully" created="Wed, 27 Jun 2018 13:20:36 +0000"  >&lt;p&gt;patch applied, thanks!&lt;/p&gt;</comment>
                            <comment id="16525089" author="tabish121" created="Wed, 27 Jun 2018 13:23:47 +0000"  >&lt;p&gt;-1&lt;/p&gt;

&lt;p&gt;No regression testing added for existing store, please revert and provide tests.&lt;/p&gt;</comment>
                            <comment id="16525203" author="gtully" created="Wed, 27 Jun 2018 15:33:29 +0000"  >&lt;p&gt;I don&apos;t see any issue with the change in the format of the job id string.&lt;/p&gt;

&lt;p&gt;the generator is already used in the code base:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/activemq/blob/57795bafcea290c6879bb288822435c480a9212d/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/scheduler/JobSchedulerImpl.java#L753&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/57795bafcea290c6879bb288822435c480a9212d/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/scheduler/JobSchedulerImpl.java#L753&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16525217" author="jgoodyear" created="Wed, 27 Jun 2018 15:54:56 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12929430/12929430_AMQ7002-messageId.patch&quot; title=&quot;AMQ7002-messageId.patch attached to AMQ-7002&quot;&gt;AMQ7002-messageId.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;, please see the above update patch.&lt;/p&gt;

&lt;p&gt;This patch ensures that MessageID format is honored.&lt;/p&gt;</comment>
                            <comment id="16525260" author="jira-bot" created="Wed, 27 Jun 2018 16:30:25 +0000"  >&lt;p&gt;Commit 76490a2c7f3a95c3861bb2dec76c4cc16f5dae3c in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jgenender&quot; class=&quot;user-hover&quot; rel=&quot;jgenender&quot;&gt;jgenender&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=76490a2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=76490a2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7002&quot; title=&quot;Activemq SchedulerBroker doSchedule can schedule duplicate jobIds leading to runtime exception &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7002&quot;&gt;&lt;del&gt;AMQ-7002&lt;/del&gt;&lt;/a&gt; - Change jobid identifier to messageid format&lt;/p&gt;</comment>
                            <comment id="16525274" author="jira-bot" created="Wed, 27 Jun 2018 16:41:39 +0000"  >&lt;p&gt;Commit 3397a972139214720faa93d8e900ac4b9ac851b7 in activemq&apos;s branch refs/heads/activemq-5.15.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jgenender&quot; class=&quot;user-hover&quot; rel=&quot;jgenender&quot;&gt;jgenender&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=3397a97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=3397a97&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7002&quot; title=&quot;Activemq SchedulerBroker doSchedule can schedule duplicate jobIds leading to runtime exception &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7002&quot;&gt;&lt;del&gt;AMQ-7002&lt;/del&gt;&lt;/a&gt; - Change jobid identifier to messageid format&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12929430" name="AMQ7002-messageId.patch" size="1690" author="jgoodyear" created="Wed, 27 Jun 2018 15:52:11 +0000"/>
                            <attachment id="12929402" name="amq7002-master.patch" size="8583" author="jgoodyear" created="Wed, 27 Jun 2018 12:52:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 20 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3v92n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>