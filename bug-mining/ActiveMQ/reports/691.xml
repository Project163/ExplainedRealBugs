<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:42:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2346] in managed environment, 2 connections/session, UserTransaction, transaction management gets confused</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2346</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;In geronimo we&apos;re seeing an intermittent tck problem that seems to relate to a situation where there are:&lt;br/&gt;
&amp;#8211; a BMT stateless session ejb&lt;br/&gt;
&amp;#8211; two connections (I think these get shared to the same ManagedConnection)&lt;br/&gt;
&amp;#8211; two sessions&lt;br/&gt;
&amp;#8211; tx control through UT&lt;br/&gt;
&amp;#8211; send a message in one tx&lt;br/&gt;
&amp;#8211; receive message in a tx that is rolled back&lt;br/&gt;
&amp;#8211; receive message in a tx that is committed&lt;/p&gt;

&lt;p&gt;In a public test case I&apos;m seeing that the session proxies get confused about whether there is an active transaction.  This doesn&apos;t happen all the time but with a few repititions it happens consistently.&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;https://issues.apache.org/jira/browse/GERONIMO-4784&quot; title=&quot;Problem with ActiveMQ, two connections/sessions, and UserTransaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GERONIMO-4784&quot;&gt;&lt;del&gt;GERONIMO-4784&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12482864">AMQ-2346</key>
            <summary>in managed environment, 2 connections/session, UserTransaction, transaction management gets confused</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="djencks">David Jencks</reporter>
                        <labels>
                    </labels>
                <created>Wed, 5 Aug 2009 16:13:44 +0000</created>
                <updated>Thu, 3 Sep 2009 15:56:04 +0000</updated>
                            <resolved>Thu, 3 Sep 2009 15:56:04 +0000</resolved>
                                    <version>5.3.0</version>
                                    <fixVersion>5.3.0</fixVersion>
                                    <component>JCA Container</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12941308" author="djencks" created="Wed, 19 Aug 2009 17:10:25 +0000"  >&lt;p&gt;I&apos;ve found a way to reproduce the problem in activemq.  See activemq-ra/src/test/java/org/apache/activemq/ra/JmsXARollback2CxTransactionTest.java&lt;/p&gt;

&lt;p&gt;The test testRepeatReceiveTwoThenRollback is currently renamed so it doesnt run.&lt;/p&gt;

&lt;p&gt;rev 805881&lt;/p&gt;</comment>
                            <comment id="12940999" author="gtully" created="Mon, 31 Aug 2009 14:42:06 +0000"  >&lt;p&gt;David, not sure what the best plan of action is here.&lt;/p&gt;

&lt;p&gt;I worked through the test case and the problem is that there are two sessions and two XAResources and only one of those sessions is associated with the active connection so only one of those sessions will behave as expected when a transaction is rolled back.&lt;br/&gt;
The test holds two connections and two XAResources and alternates the commit/rollback between them. I find that the second iteration of the test always fails.&lt;/p&gt;

&lt;p&gt;There is an additional problem in that  the second session/connection has an outstanding transaction when it is closed, as a result of the outstanding transaction, the close is deferred till the transaction commits, which never happens, thus we see the problems with &quot;javax.jms.InvalidClientIDException: Broker: localhost - Client: org.apache.activemq.test.JmsResourceProvider already connected from vm://localhost#4 on subsequent tests. &lt;/p&gt;

&lt;p&gt;My first though was that these connections should be presenting the same XAResource (somethng with isSameRM == true), Essentially an XAResoruce for the Broker. But it looks like the intention is that an XAResource maps to a session. Maybe this is the crux of the problem.&lt;/p&gt;

&lt;p&gt;When dealing with the two sessions and XAResources, my thinking was that the test should be driving 2PC, but this does not work because the broker only sees one transaction branch and fails on a second prepare.&lt;/p&gt;

&lt;p&gt;So I am thinking that the correct solution is to have a shared XAResource for the ResourceAdapter and have sessions just track the association. Not sure yet what all the ramifications are. What do you think?&lt;/p&gt;</comment>
                            <comment id="12941009" author="gtully" created="Mon, 31 Aug 2009 16:35:05 +0000"  >&lt;p&gt;looks like &lt;a href=&quot;http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/main/java/org/apache/activemq/TransactionContext.java?view=log#rev581242&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/main/java/org/apache/activemq/TransactionContext.java?view=log#rev581242&lt;/a&gt; is relevant. That static could be the shared state we need.&lt;/p&gt;</comment>
                            <comment id="12941010" author="djencks" created="Mon, 31 Aug 2009 17:02:04 +0000"  >&lt;p&gt;Making ENDED_XA_TRANSACTION_CONTEXTS static in TransactionContext makes the test pass for me.  This variable doesn&apos;t make any sense unless it&apos;s static, as otherwise the only possible TransactionContext in the list is &quot;this&quot;.&lt;/p&gt;

&lt;p&gt;I&apos;m not thrilled with introducing a static, in an osgi environment it would be better to have a service, but it seems like the best solution in a non-osgi environment.&lt;/p&gt;

&lt;p&gt;Unfortunately I&apos;m seeing a new problem, apparently a race condition between closing a connection and starting a new connection and setting clientId.  Adding a Thread.sleep(10) to JmsTransactionTestSupport reconnect sidesteps this problem...&lt;/p&gt;

&lt;p&gt;Tests run: 17, Failures: 0, Errors: 15, Skipped: 0, Time elapsed: 2.022 sec &amp;lt;&amp;lt;&amp;lt; FAILURE!&lt;br/&gt;
testReceiveTwoThenCloseConnection(org.apache.activemq.ra.JmsXARollback2CxTransactionTest)  Time elapsed: 1.124 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!&lt;br/&gt;
javax.jms.InvalidClientIDException: Broker: localhost - Client: org.apache.activemq.test.JmsResourceProvider already connected from vm://localhost#8&lt;br/&gt;
	at org.apache.activemq.broker.region.RegionBroker.addConnection(RegionBroker.java:216)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.addConnection(BrokerFilter.java:82)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.addConnection(BrokerFilter.java:82)&lt;br/&gt;
	at org.apache.activemq.advisory.AdvisoryBroker.addConnection(AdvisoryBroker.java:77)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.addConnection(BrokerFilter.java:82)&lt;br/&gt;
	at org.apache.activemq.broker.MutableBrokerFilter.addConnection(MutableBrokerFilter.java:89)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.processAddConnection(TransportConnection.java:686)&lt;br/&gt;
	at org.apache.activemq.command.ConnectionInfo.visit(ConnectionInfo.java:134)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:308)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:182)&lt;br/&gt;
	at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:109)&lt;br/&gt;
	at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)&lt;br/&gt;
	at org.apache.activemq.transport.vm.VMTransport.iterate(VMTransport.java:205)&lt;br/&gt;
	at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:122)&lt;br/&gt;
	at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:43)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:651)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:676)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:613)&lt;/p&gt;</comment>
                            <comment id="12941669" author="gtully" created="Thu, 3 Sep 2009 15:56:04 +0000"  >&lt;p&gt;static back in place and made the removeCommand sync in transport connection to kill race condition with starting a new connection with the same clientId.&lt;/p&gt;

&lt;p&gt;revision: r811003&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>74974</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 12 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s29b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161842</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>