<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:52:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3665] Velocity&apos;s IntroSpectionCache causes OutOfMemoryError on large AMQ stores when running activem-admin journal-audit</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3665</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;activemq-admin journal-audit can be used to dump the content of the AMQ store to system out. The format of the output is rendered using Velocity.&lt;br/&gt;
For large AMQ stores (e.g. 3GB) activemq-admin will run out of memory. &lt;br/&gt;
This is because Velocity internally uses an introSpectionCache that fills up over time until heap memory is exhausted. &lt;/p&gt;

&lt;p&gt;There is some documentation on that cache in the Velocity &lt;a href=&quot;http://velocity.apache.org/engine/devel/developer-guide.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Developers Guide&lt;/a&gt; in section &quot;Other Context Issues&quot;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;One of the features provided by the VelocityContext (or any Context derived from AbstractContext) is node specific introspection caching. Generally, you as a the developer don&apos;t need to worry about this when using the VelocityContext as your context. However, there is currently one known usage pattern where you must be aware of this feature.&lt;/p&gt;

&lt;p&gt;The VelocityContext will accumulate intropection information about the syntax nodes in a template as it visits those nodes. So, in the following situation:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;You are iterating over the same template using the same VelocityContext object.&lt;/li&gt;
	&lt;li&gt;Template caching is off.&lt;/li&gt;
	&lt;li&gt;You request the Template from getTemplate() on each iteration.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It is possible that your VelocityContext will appear to &apos;leak&apos; memory (it is really just gathering more introspection information.) What happens is that it accumulates template node introspection information for each template it visits, and as template caching is off, it appears to the VelocityContext that it is visiting a new template each time. Hence it gathers more introspection information and grows. It is highly recommended that you do one or more of the following:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Create a new VelocityContext for each excursion down through the template render process. This will prevent the accumulation of introspection cache data. For the case where you want to reuse the VelocityContext because it&apos;s populated with data or objects, you can simply wrap the populated VelocityContext in another, and the &apos;outer&apos; one will accumulate the introspection information, which you will just discard. Ex. VelocityContext useThis = new VelocityContext( populatedVC ); This works because the outer context will store the introspection cache data, and get any requested data from the inner context (as it is empty.) Be careful though - if your template places data into the context and it&apos;s expected that it will be used in the subsequent iterations, you will need to do one of the other fixes, as any template #set() statements will be stored in the outermost context. See the discussion in Context chaining for more information.&lt;/li&gt;
	&lt;li&gt;Turn on template caching. This will prevent the template from being re-parsed on each iteration, resulting the the VelocityContext being able to not only avoid adding to the introspection cache information, but be able to use it resulting in a performance improvement.&lt;/li&gt;
	&lt;li&gt;Reuse the Template object for the duration of the loop iterations. Then you won&apos;t be forcing Velocity, if the cache is turned off, to reread and reparse the same template over and over, so the VelocityContext won&apos;t gather new introspection information each time.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;


&lt;p&gt;Right now the Velocity introSpectionCache grows with every entry read from the journal until an OOM error is raised. &lt;/p&gt;</description>
                <environment>&lt;p&gt;AMQ persistence store, activemq-admin journal-audit&lt;/p&gt;</environment>
        <key id="12538633">AMQ-3665</key>
            <summary>Velocity&apos;s IntroSpectionCache causes OutOfMemoryError on large AMQ stores when running activem-admin journal-audit</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tmielke">Torsten Mielke</assignee>
                                    <reporter username="tmielke">Torsten Mielke</reporter>
                        <labels>
                            <label>OOM</label>
                            <label>OutOfMemoryError</label>
                            <label>activmq-admin</label>
                            <label>journal-audit</label>
                            <label>velocity</label>
                    </labels>
                <created>Tue, 17 Jan 2012 14:28:59 +0000</created>
                <updated>Mon, 23 Jan 2012 13:37:09 +0000</updated>
                            <resolved>Mon, 23 Jan 2012 13:37:08 +0000</resolved>
                                    <version>5.5.1</version>
                                    <fixVersion>5.6.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13188432" author="tmielke" created="Wed, 18 Jan 2012 13:00:39 +0000"  >&lt;p&gt;Attaching a patch for this bug. &lt;br/&gt;
Will work out a JUnit test next and commit the fix thereafter. &lt;/p&gt;

&lt;p&gt;The patch simply turns on template caching in Velocity via org.apache.activemq.console.command.store.amq.CustomResourceLoader. &lt;/p&gt;</comment>
                            <comment id="13191151" author="tmielke" created="Mon, 23 Jan 2012 13:36:33 +0000"  >&lt;p&gt;Bug resolved in revisions &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1234779&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#1234779&lt;/a&gt; - &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1234783&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#1234783&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12511493" name="AMQ-3665.patch" size="20144" author="tmielke" created="Mon, 23 Jan 2012 13:31:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>224136</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 44 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0aicf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59245</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>