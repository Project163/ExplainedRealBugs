<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:53:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3473] Messages (possibly) stuck and pending messages count showing high number of pending message which do not get sent to a consumer.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3473</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Two brokers, each with a network connection to the other. We have two producers producing persistent messages to a single queue at a rate of 20-50/second. There is a single consumer. All clients prefer the primary broker.&lt;/p&gt;

&lt;p&gt;The consumer is &apos;bursty&apos; - i.e. it grabs 5000 messages and then processes them. During processing, new messages build up on the broker.&lt;/p&gt;

&lt;p&gt;If the primary broker is restarted we will see it come back with, as you would expect, with a number of pending messages. This message count never fully returns to 0 even if the producers are stopped and browsing the queue through the GUI shows either no messages or only messages that were produced since the restart.&lt;/p&gt;


&lt;p&gt;I have turned on Kaha debugging and, after the initial restart, we see the following during every checkpoint:&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; TRACE MessageDatabase                - Last update: 3974:2450180, full gc candidates set: &lt;span class=&quot;error&quot;&gt;&amp;#91;3950, 3951, 3973, 3974&amp;#93;&lt;/span&gt;&lt;br/&gt;
...&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; TRACE MessageDatabase                - gc candidates after dest:1:MyQueue, &lt;span class=&quot;error&quot;&gt;&amp;#91;3951, 3973&amp;#93;&lt;/span&gt;&lt;br/&gt;
...&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; TRACE MessageDatabase                - gc candidates: &lt;span class=&quot;error&quot;&gt;&amp;#91;3951, 3973&amp;#93;&lt;/span&gt;&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; TRACE MessageDatabase                - not removing data file: 3951 as contained ack(s) refer to referenced file: &lt;span class=&quot;error&quot;&gt;&amp;#91;3950, 3951&amp;#93;&lt;/span&gt;&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; DEBUG MessageDatabase                - Cleanup removing the data files: &lt;span class=&quot;error&quot;&gt;&amp;#91;3973&amp;#93;&lt;/span&gt;&lt;br/&gt;
(I assume that is supposed to say &apos;&lt;span class=&quot;error&quot;&gt;&amp;#91;Checkpoint Worker&amp;#93;&lt;/span&gt;&apos;, incidentally)&lt;/p&gt;

&lt;p&gt;After the second restart we will see many:&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;0.8.0.200:47300&amp;#93;&lt;/span&gt; WARN  MessageDatabase                - Duplicate message add attempt rejected. Destination: MyQueue, Message id: ID:node001-58675-1314038640553-0:17:1:1:470776&lt;/p&gt;

&lt;p&gt;Followed by:&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; TRACE MessageDatabase                - Last update: 3974:13515407, full gc candidates set: &lt;span class=&quot;error&quot;&gt;&amp;#91;3950, 3951, 3974&amp;#93;&lt;/span&gt;&lt;br/&gt;
...&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; TRACE MessageDatabase                - gc candidates after dest:1:MyQueue, &lt;span class=&quot;error&quot;&gt;&amp;#91;3951&amp;#93;&lt;/span&gt;&lt;br/&gt;
...&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; TRACE MessageDatabase                - gc candidates: &lt;span class=&quot;error&quot;&gt;&amp;#91;3951&amp;#93;&lt;/span&gt;&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;eckpoint Worker&amp;#93;&lt;/span&gt; DEBUG MessageDatabase                - Cleanup removing the data files: &lt;span class=&quot;error&quot;&gt;&amp;#91;3951&amp;#93;&lt;/span&gt;&lt;/p&gt;



&lt;p&gt;This is very similar, if not the same, to &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2955&quot; title=&quot;Message getting stuck on queue, leading to KahaDB log files not being deleted and disk running out of space&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2955&quot;&gt;&lt;del&gt;AMQ-2955&lt;/del&gt;&lt;/a&gt;. I have tried setting &apos;useCache=false&apos; but this does not rectify the issue. This could also be a similar issue to &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3281&quot; title=&quot;Messages stuck&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3281&quot;&gt;&lt;del&gt;AMQ-3281&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I will attach a config. Please advise if you would like me to enable further debugging.&lt;/p&gt;

&lt;p&gt;I don&apos;t currently have a test harness that replicates this issue and due to the fact this is only happening in our production environment, I&apos;m unable to verify reliably whether messages are being lost, delayed or if this is purely a stats issue.&lt;/p&gt;

</description>
                <environment>&lt;p&gt;Ubuntu 11.04 (64-bit)&lt;/p&gt;

&lt;p&gt;Java(TM) SE Runtime Environment (build 1.6.0_24-b07)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 19.1-b02, mixed mode)&lt;/p&gt;</environment>
        <key id="12520013">AMQ-3473</key>
            <summary>Messages (possibly) stuck and pending messages count showing high number of pending message which do not get sent to a consumer.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="matsharpe">Mat Sharpe</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Aug 2011 19:45:51 +0000</created>
                <updated>Wed, 28 Mar 2012 09:45:17 +0000</updated>
                            <resolved>Wed, 28 Mar 2012 09:45:16 +0000</resolved>
                                    <version>5.5.0</version>
                                    <fixVersion>5.6.0</fixVersion>
                                    <component>Message Store</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13239404" author="gtully" created="Tue, 27 Mar 2012 12:20:21 +0000"  >&lt;p&gt;There is a problem here with the enqueue counter. If a duplicate message send occurs across a network connector and the message has not been dispatched. The store will add the message to the journal but the index update will recognize the duplicate. It updates the index to reference the last journal insert, but the enqueue counter is not decremented to reflect the duplicate.&lt;/p&gt;

&lt;p&gt;The duplicate send can occur if the connection or broker dies after a send but before a reply is received. The message remains unacked and gets redispatched. The redelivery counter will be incremented to reflect the resend in this case.&lt;/p&gt;

&lt;p&gt;In 5.6, (&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3576&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-3576&lt;/a&gt;) there is an optional boolean transportConnector.auditNetworkProducers attribute that can be used to add a producer audit for a network connector. This will suppress the duplicate send in this case. It is disabled by default because it can prevent legit duplicate messages from non conduit topics and virtual destinations from propagating across the network.&lt;/p&gt;

&lt;p&gt;The producer audit is a good solution but in the event that the audit cache is exceeded, the duplicate detection by the store should be reflected in the destination enqueue statistic.&lt;/p&gt;</comment>
                            <comment id="13239406" author="gtully" created="Tue, 27 Mar 2012 12:29:56 +0000"  >&lt;p&gt;The auditNetworkProducers attribute from &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3576&quot; title=&quot;ProducerBrokerExchange last producer sequenceId initialization needs runtime updates to deal with possible duplicate resends&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3576&quot;&gt;&lt;del&gt;AMQ-3576&lt;/del&gt;&lt;/a&gt; will help avoid this issue.&lt;/p&gt;</comment>
                            <comment id="13240326" author="gtully" created="Wed, 28 Mar 2012 09:45:17 +0000"  >&lt;p&gt;fix for the enqueue and message count statistic in the event of &quot;Duplicate message add attempt rejected&quot; @ &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1306228&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1306228&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                            <outwardlinks description="requires">
                                        <issuelink>
            <issuekey id="12529900">AMQ-3576</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12491539" name="activemq.xml" size="5863" author="matsharpe" created="Wed, 24 Aug 2011 19:48:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63852</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 34 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0aizj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59349</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>