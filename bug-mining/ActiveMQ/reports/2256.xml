<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:04:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4182] Memory Leak for ActiveMQBytesMessage with Compression as true</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4182</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;InflaterInputStream is supposed to close explicitly to release resource allocated by its JNI methods. In ActiveMQBytesMessage, dataIn property is disposed simply without closing it, which results in some weird memory leak that can&apos;t be detected from heap size. It can&apos;t be controlled by -Xmx or -XX:MaxDirectMemorySize.&lt;/p&gt;

&lt;p&gt;Please run the following test program to verify the issue:&lt;/p&gt;

&lt;p&gt;import java.util.concurrent.TimeUnit;&lt;/p&gt;

&lt;p&gt;import javax.jms.BytesMessage;&lt;br/&gt;
import javax.jms.Connection;&lt;br/&gt;
import javax.jms.Session;&lt;/p&gt;

&lt;p&gt;import org.apache.activemq.ActiveMQConnectionFactory;&lt;br/&gt;
import org.apache.activemq.command.ActiveMQBytesMessage;&lt;/p&gt;

&lt;p&gt;/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A simple test to verify memory leak in ActiveMQBytesMessage.&lt;br/&gt;
 */&lt;br/&gt;
public class Main&lt;br/&gt;
{&lt;br/&gt;
    public static void main(String[] args) throws Exception &lt;br/&gt;
    {&lt;br/&gt;
        ActiveMQConnectionFactory connFactory = new ActiveMQConnectionFactory(&quot;vm://localhost&quot;);&lt;br/&gt;
        connFactory.setUseCompression(true);&lt;br/&gt;
        Connection conn = connFactory.createConnection();&lt;br/&gt;
        Session session = conn.createSession(false, Session.AUTO_ACKNOWLEDGE);&lt;br/&gt;
        BytesMessage message = session.createBytesMessage();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;        message.writeBytes(new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;1024&amp;#93;&lt;/span&gt;);&lt;/p&gt;

&lt;p&gt;        ActiveMQBytesMessage m = (ActiveMQBytesMessage)message;&lt;br/&gt;
        if(!m.isCompressed())&lt;/p&gt;
        {
            throw new RuntimeException();
        }


&lt;p&gt;        while (true)&lt;br/&gt;
        {&lt;br/&gt;
            for (int k = 0; k &amp;lt; 1024; ++k)&lt;/p&gt;
            {
                message.reset();
                byte[] data = new byte[1024];
                message.readBytes(data);
            }
&lt;p&gt;            TimeUnit.MILLISECONDS.sleep(10);&lt;br/&gt;
        }&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;}&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux(Redhat 5.5), Windows 7&lt;/p&gt;</environment>
        <key id="12616950">AMQ-4182</key>
            <summary>Memory Leak for ActiveMQBytesMessage with Compression as true</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="jeff.huang">Jeff Huang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Nov 2012 15:42:51 +0000</created>
                <updated>Wed, 23 Apr 2014 10:59:31 +0000</updated>
                            <resolved>Wed, 23 Apr 2014 10:59:31 +0000</resolved>
                                    <version>5.5.1</version>
                                    <fixVersion>5.10.0</fixVersion>
                                    <component>JMS client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13503864" author="tabish121" created="Mon, 26 Nov 2012 16:17:18 +0000"  >&lt;p&gt;Added some additional logic to attempt to close the dataIn stream when possible.&lt;/p&gt;</comment>
                            <comment id="13506175" author="jeff.huang" created="Thu, 29 Nov 2012 02:57:51 +0000"  >&lt;p&gt;I read the changes. Fix in reset() is good I believe. But I am worried about the finalize() method because I don&apos;t think it would work as good as we would expect. Please take a look at how Sun&apos;s JDK 1.6 implemented java.util.zip.Inflater&lt;/p&gt;

&lt;p&gt;336     /**&lt;br/&gt;
337      * Closes the decompressor and discards any unprocessed input.&lt;br/&gt;
338      * This method should be called when the decompressor is no longer&lt;br/&gt;
339      * being used, but will also be called automatically by the finalize()&lt;br/&gt;
340      * method. Once this method is called, the behavior of the Inflater&lt;br/&gt;
341      * object is undefined.&lt;br/&gt;
342      */&lt;br/&gt;
343     public void end() {&lt;br/&gt;
344         synchronized (zsRef) {&lt;br/&gt;
345             long addr = zsRef.address();&lt;br/&gt;
346             zsRef.clear();&lt;br/&gt;
347             if (addr != 0) &lt;/p&gt;
{
348                 end(addr);
349                 buf = null;
350             }
&lt;p&gt;351         }&lt;br/&gt;
352     }&lt;br/&gt;
353&lt;br/&gt;
354     /**&lt;br/&gt;
355      * Closes the decompressor when garbage is collected.&lt;br/&gt;
356      */&lt;br/&gt;
357     protected void finalize() &lt;/p&gt;
{
358         end();
359     }

&lt;p&gt;They have already done finalize() with end(). So if finalize() works well, the problem wouldn&apos;t exist in the first place. And since those memory is allocated out of JVM heap, the GC could have problem to sense the necessity to clean something even the system blows out.&lt;/p&gt;</comment>
                            <comment id="13506194" author="jeff.huang" created="Thu, 29 Nov 2012 03:58:52 +0000"  >&lt;p&gt;Please try to run the test program with -Xmx10M, -X128M, and -X2G, and monitor the JVM memory usage. Here are the results in my own test system with 8G memory when it was stable:&lt;/p&gt;

&lt;p&gt;-Xmx10M&lt;br/&gt;
  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND&lt;br/&gt;
15070 root      17   0  429m 123m 9856 S 80.2  1.5   0:48.49 java   &lt;/p&gt;

&lt;p&gt;-Xmx128M&lt;br/&gt;
  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND&lt;br/&gt;
15115 root      17   0 2808m 2.0g 9856 S 78.6 26.0   0:22.70 java&lt;/p&gt;

&lt;p&gt;-X2G&lt;br/&gt;
Never stable and the whole system just ran out of memory.&lt;/p&gt;

&lt;p&gt;That means when -Xmx is big enough for holding NORMAL objects the GC just won&apos;t see the memory problem at all, which results in the finalize() method won&apos;t be executed ever.&lt;/p&gt;</comment>
                            <comment id="13506197" author="jeff.huang" created="Thu, 29 Nov 2012 04:02:39 +0000"  >&lt;p&gt;The change on finalize() won&apos;t fix the problem because java.util.zip.Inflater tries that already. The memory problem happens out of the normal heap and GC won&apos;t detect the memory shortage, in turn objects won&apos;t be wiped out at all.&lt;/p&gt;</comment>
                            <comment id="13506793" author="tabish121" created="Thu, 29 Nov 2012 21:11:32 +0000"  >&lt;p&gt;You&apos;re welcome to submit a patch if you can see a reasonable solution to the issue you are seeing. &lt;/p&gt;</comment>
                            <comment id="13506880" author="jeff.huang" created="Thu, 29 Nov 2012 22:19:36 +0000"  >&lt;p&gt;Unfortunately, I don&apos;t have a solution for that. I would tend to say that there is not a valid solution for that. &lt;/p&gt;

&lt;p&gt;We could try to add a close() or release() method to ActiveMQBytesMessage, but I don&apos;t think the users are going to call it because it is not part of the JMS API. &lt;/p&gt;

&lt;p&gt;Or we can try to find another pure Java compression library to avoid the need to release the resource explicitly. But that may probably mean we need to sacrifice some performance when doing compression.&lt;/p&gt;

&lt;p&gt;Or we may want to decompress the whole buffer, instead of remaining a stream for it. The memory footprint would be bigger, but comparing to blowing out the whole system, this is acceptable.&lt;/p&gt;

&lt;p&gt;Or we can call off this feature. Tell the users not to use BytesMessage in ActiveMQ when they try to use compression.&lt;/p&gt;</comment>
                            <comment id="13978065" author="dejanb" created="Wed, 23 Apr 2014 10:59:31 +0000"  >&lt;p&gt;I implemented explicit compression/decompression of the payload when we initialise writing and reading operations.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/activemq/commit/44bb9fbe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/activemq/commit/44bb9fbe&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;With this we can avoid using finalize() to close the streams, which can cause memory leaks. The trade-off is that we keep uncompressed messages in memory, but IMHO that&apos;s not an issue as compression is meant to be used on the wire and the similar approach is used for other kind of messages.&lt;/p&gt;

&lt;p&gt;There&apos;s still couple of more places where we should remove finalize()&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>258841</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 30 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0l4sn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>121427</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>