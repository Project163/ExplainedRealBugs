<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:05:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5274] Stuck messages and CPU churn when aborted transacted message expires</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5274</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;The test case is a simple producer/consumer:&lt;/p&gt;

&lt;p&gt;Producer: 20 messages are injected, with a timeout of 10s.&lt;/p&gt;

&lt;p&gt;Consumer: The redelivery policy is set to 0 retries (the issue exists with other values). The consumer uses transactions and throws a runtime exception on each message received.&lt;/p&gt;

&lt;p&gt;queue stats show 20 enqueue, 19 dequeue, 1 pending&lt;/p&gt;

&lt;p&gt;DLQ stat show 20 enqueue: all 20 messages go to DLQ, IDs ending in 1-10 for failing, 11-20 for expiry (approx)&lt;/p&gt;

&lt;p&gt;the pending item (ID ending in 10) is a &quot;ghost message&quot; , and remains stuck indefinitely in queue.test&lt;/p&gt;

&lt;p&gt;if you browse, the message is not shown&lt;/p&gt;

&lt;p&gt;A) if you restart the broker, after a short while the message is cleaned:&lt;/p&gt;

&lt;p&gt;jvm 1    |  WARN | Duplicate message add attempt rejected. Destination: QUEUE://ActiveMQ.DLQ, Message id: ID:REDACTED-52872-1405079629779-1:1:1:1:10&lt;br/&gt;
jvm 1    |  WARN | org.apache.activemq.broker.region.cursors.QueueStorePrefetch@5b427f3c:ActiveMQ.DLQ,batchResetNeeded=false,storeHasMessages=true,size=0,cacheEnabled=true,maxBatchSize:20,hasSpace:tru&lt;br/&gt;
e - cursor got duplicate: ID:REDACTED--52872-1405079629779-1:1:1:1:10, 4&lt;br/&gt;
jvm 1    |  WARN | duplicate message from store ID:REDACTED--52872-1405079629779-1:1:1:1:10, redirecting for dlq processing&lt;/p&gt;


&lt;p&gt;B) if you purge, ActiveMQ logs a warning: &quot;WARN | queue://queue.test after purge complete, message count stats report: 1&quot;&lt;br/&gt;
	the queue is marked as being empty.&lt;br/&gt;
	however if you restart the broker, the message re-appears shorty, before being cleaned as above&lt;/p&gt;


&lt;p&gt;SUPPLEMENTARY: with activeMQ 5.9.0 and above , if you run the injection several times, the CPU usage of ActiveMQ climbs drastically until the queue is purged.&lt;/p&gt;

</description>
                <environment>&lt;p&gt;win64, RHEL11&lt;/p&gt;</environment>
        <key id="12726798">AMQ-5274</key>
            <summary>Stuck messages and CPU churn when aborted transacted message expires</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="yannick.malins">Yannick Malins</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Jul 2014 12:48:38 +0000</created>
                <updated>Mon, 12 Dec 2016 11:21:47 +0000</updated>
                            <resolved>Thu, 11 Sep 2014 20:25:54 +0000</resolved>
                                    <version>5.8.0</version>
                    <version>5.9.0</version>
                    <version>5.9.1</version>
                    <version>5.10.0</version>
                                    <fixVersion>5.11.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14058729" author="yannick.malins" created="Fri, 11 Jul 2014 12:50:29 +0000"  >&lt;p&gt;test case and readme&lt;/p&gt;</comment>
                            <comment id="14058794" author="yannick.malins" created="Fri, 11 Jul 2014 13:53:18 +0000"  >&lt;p&gt;debug log file&lt;/p&gt;</comment>
                            <comment id="14058838" author="yannick.malins" created="Fri, 11 Jul 2014 14:32:55 +0000"  >&lt;p&gt;see attached log - this seems to be due to the &quot;sync with message expiry processing&quot; if clause in queuesubscription.acknowledge()&lt;/p&gt;

&lt;p&gt;it seems that if the message is expired it is not removed - but that the expiry doesn&apos;t remove it either&lt;/p&gt;</comment>
                            <comment id="14058864" author="tabish121" created="Fri, 11 Jul 2014 15:03:47 +0000"  >&lt;p&gt;See if you can work out a JUnit test case that shows the issue, then when it&apos;s fixed the test will ensure that it remains fixed into the future. &lt;/p&gt;</comment>
                            <comment id="14062419" author="tabish121" created="Tue, 15 Jul 2014 18:07:29 +0000"  >&lt;p&gt;Attempted to create test to reproduce could not find any problems with this or the provided test against 5.11-SNAPSHOT.&lt;/p&gt;</comment>
                            <comment id="14063257" author="yannick.malins" created="Wed, 16 Jul 2014 07:50:43 +0000"  >&lt;p&gt;Hi Tim,&lt;/p&gt;

&lt;p&gt;I just ran my test against apache-activemq-5.11-20140715.223633-34 on win64 , and I got exactly the same issue.&lt;/p&gt;

&lt;p&gt;The test script prints that it rejects messages 1-&amp;gt;10 (the others have already expired), and after it closes, when you go to:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://localhost:8161/admin/queues.jsp&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8161/admin/queues.jsp&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;you see:&lt;/p&gt;

&lt;p&gt;ActiveMQ.DLQ	20	0	20	0	Browse Active Consumers&lt;br/&gt;
Active Producers&lt;br/&gt;
  	Send To Purge Delete&lt;br/&gt;
queue.test	1	0	20	19	Browse Active Consumers&lt;br/&gt;
Active Producers&lt;br/&gt;
  	Send To Purge Delete&lt;/p&gt;

&lt;p&gt;There is one &quot;ghost&quot; message stuck in queue.test&lt;/p&gt;

&lt;p&gt;I will try integrating your junit and running that to see if I can reproduce with that, it will make things easier indeed&lt;/p&gt;</comment>
                            <comment id="14076349" author="yannick.malins" created="Mon, 28 Jul 2014 16:25:26 +0000"  >&lt;p&gt;OK, I found some time to integrate the junit test. It seems something in the config is wrong, because if I change the dlq statisfaction method to the following:&lt;/p&gt;

&lt;p&gt;      @Override&lt;br/&gt;
      public boolean isSatisified() throws Exception {&lt;br/&gt;
        long size = dlqView.getQueueSize();&lt;br/&gt;
        LOG.info(&quot;DLQ Size: {}&quot;, size);&lt;br/&gt;
        if (size == 20) {&lt;br/&gt;
          for (Object O : dlqView.browseMessages()) &lt;/p&gt;
{
            LOG.info(((ActiveMQTextMessage) O).toString());
          }
&lt;p&gt;          return true;&lt;br/&gt;
        }&lt;br/&gt;
        return false;&lt;br/&gt;
      }&lt;/p&gt;

&lt;p&gt;I notice that all the messages have dlqDeliveryFailureCause=expired , which should only be the case for the untreated messages. The others should have session rollback/abort as the fail reason.&lt;/p&gt;

&lt;p&gt;I will try to see what we are missing&lt;/p&gt;</comment>
                            <comment id="14109150" author="yannick.malins" created="Mon, 25 Aug 2014 14:36:37 +0000"  >&lt;p&gt;Also reproduced with jboss-a-mq-6.1.0.redhat-379 , the only difference to the maven test case is adding the configured user/pass in the connection factory defined in context-jms.xml&lt;/p&gt;</comment>
                            <comment id="14112193" author="tmielke" created="Wed, 27 Aug 2014 12:23:15 +0000"  >&lt;p&gt;Uploading a modified version &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5274&quot; title=&quot;Stuck messages and CPU churn when aborted transacted message expires&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5274&quot;&gt;&lt;del&gt;AMQ-5274&lt;/del&gt;&lt;/a&gt;v2.zip that runs a JUnit test. Simply run mvn test to reproduce the issue.&lt;/p&gt;</comment>
                            <comment id="14130650" author="gtully" created="Thu, 11 Sep 2014 20:25:54 +0000"  >&lt;p&gt;fix in &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=26807cd4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=26807cd4&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;inflight messages are not expired by the broker side background periodic check. In this way, acks do not compete with expiry.&lt;/p&gt;</comment>
                            <comment id="14131318" author="yannick.malins" created="Fri, 12 Sep 2014 09:20:00 +0000"  >&lt;p&gt;Validated the fix on last night&apos;s snapshot! Thanks Gary&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13027334">AMQ-6534</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12655206" name="AMQ-5274.zip" size="7031" author="yannick.malins" created="Fri, 11 Jul 2014 12:50:29 +0000"/>
                            <attachment id="12664632" name="AMQ-5274v2.zip" size="11265" author="tmielke" created="Wed, 27 Aug 2014 12:33:56 +0000"/>
                            <attachment id="12655826" name="AMQ5274Test.java" size="5741" author="tabish" created="Tue, 15 Jul 2014 18:07:29 +0000"/>
                            <attachment id="12655210" name="logs_extract.txt" size="3282" author="yannick.malins" created="Fri, 11 Jul 2014 13:53:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>404905</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 10 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xonb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>404943</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>