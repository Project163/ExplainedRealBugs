<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:42:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6891] Duplicated message in JMS transaction, when jdbc persistence fails (Memory leak on Queue)</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6891</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I have following scenario (see attached test case):&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Send 1 message in JMS transaction&lt;/li&gt;
	&lt;li&gt;Enable database problem simulation (throw &lt;tt&gt;SQLException&lt;/tt&gt; in &lt;tt&gt;TransactionContext.executeBatch()&lt;/tt&gt; method - the similar situation should happen, when commit fails)&lt;/li&gt;
	&lt;li&gt;Attempt to send 2 messages in one JMS transaction, send operation fails as is expected (only 1 message is in database from first send operation)&lt;/li&gt;
	&lt;li&gt;Disable database problem simulation (&lt;tt&gt;SQLException&lt;/tt&gt; is not thrown from now)&lt;/li&gt;
	&lt;li&gt;Repeat the attempt to send &quot;the same&quot; 2 messages in one JMS transaction, send operation is successful now, how is expected (3 messages are in database)&lt;/li&gt;
	&lt;li&gt;Attempt to receive 3 messages 1, 2, 3, but 5 messages are received 1, 2, 3, 2, 3.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I have suspicion, that problem is in &lt;tt&gt;org.apache.activemq.broker.region.Queue&lt;/tt&gt;. It seems that reason is &lt;tt&gt;indexOrderedCursorUpdates&lt;/tt&gt; list. The &lt;tt&gt;Queue.onAdd(MessageContext)&lt;/tt&gt; method is invoked for each message by &lt;tt&gt;JDBCMessageStore.addMessage(ConnectionContext, Message) method&lt;/tt&gt;, which adds &lt;tt&gt;MessageContext&lt;/tt&gt; into this list. The added &lt;tt&gt;MessageContext&lt;/tt&gt; is processed (and removed) in &lt;tt&gt;Queue.doPendingCursorAdditions()&lt;/tt&gt; method, which is invoked only from &quot;afterCommit synchronization&quot; (&lt;tt&gt;Queue.CursorAddSync.afterCommit()&lt;/tt&gt; method). But when commit operation fails, then &quot;afterCommit&quot; method is not invoked (but &lt;tt&gt;afterRollback&lt;/tt&gt; method is invoked) and &lt;tt&gt;MessageContext&lt;/tt&gt; entries stays in &lt;tt&gt;indexOrderedCursorUpdates&lt;/tt&gt; list.&lt;/p&gt;

&lt;p&gt;Personaly I would expect, that some &quot;remove&quot; operation should be done in &lt;tt&gt;Queue.CursorAddSync.afterRolback()&lt;/tt&gt; method. Probably the similar operation should be done in &lt;tt&gt;Queue.doMessageSend()&lt;/tt&gt; method on place, where &lt;tt&gt;Exception&lt;/tt&gt; from &quot;addMessage&quot; is handled in case when JMS transaction is not used. Or some different &quot;completion&quot; operation should be introduced, because &lt;tt&gt;MessageContext&lt;/tt&gt; is only add into the list,&#160; but don&apos;t removed in case of failure.&lt;/p&gt;

&lt;p&gt;When I tried to register (and use) &lt;tt&gt;LeaseLockerIOExceptionHandler&lt;/tt&gt; IOExceptionHandler, the transports was successfully restarted, but my &quot;client&quot; code was blocked in &lt;tt&gt;ActiveMQSession.commit()&lt;/tt&gt; method. Is it expected behavior?&lt;/p&gt;

&lt;p&gt;When I tried to add following code into &lt;tt&gt;Queue.CursorAddSync.afterRollback()&lt;/tt&gt;, I received only 3 expected messages (when JMS transaction is used), but it was only blind shot, sorry, because I don&apos;t understand the whole logic here.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void afterRollback() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
  &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(indexOrderedCursorUpdates) {
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = indexOrderedCursorUpdates.size() - 1; i &amp;gt;= 0; i--) {
      MessageContext mc = indexOrderedCursorUpdates.get(i);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(mc.message.getMessageId().equals(messageContext.message.getMessageId())) {
        indexOrderedCursorUpdates.remove(mc);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(mc.onCompletion != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
          mc.onCompletion.run();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
      }
    }
  }
  messageContext.message.decrementReferenceCount();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13133738">AMQ-6891</key>
            <summary>Duplicated message in JMS transaction, when jdbc persistence fails (Memory leak on Queue)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="rkraus">Radek Kraus</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Jan 2018 16:21:05 +0000</created>
                <updated>Tue, 30 Jan 2018 10:53:10 +0000</updated>
                            <resolved>Tue, 30 Jan 2018 10:53:10 +0000</resolved>
                                    <version>5.15.2</version>
                                    <fixVersion>5.16.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16340885" author="rkraus" created="Fri, 26 Jan 2018 10:28:57 +0000"  >&lt;p&gt;The test case, which should demonstrate the &lt;tt&gt;Queue&lt;/tt&gt; memory leak on &lt;tt&gt;indexOrderedCursorUpdates&lt;/tt&gt; list, is added into attached &lt;tt&gt;JmsTransactionCommitFailureTest&lt;/tt&gt; class (only java reflection is used for acquiring list size after unsuccessful send operations). Usage of&#160;&lt;tt&gt;LeaseLockerIOExceptionHandler&lt;/tt&gt; has still same effect -&#160;&lt;tt&gt;ActiveMQsession.commit()&lt;/tt&gt; is blocked.&lt;/p&gt;</comment>
                            <comment id="16340992" author="gtully" created="Fri, 26 Jan 2018 12:44:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rkraus&quot; class=&quot;user-hover&quot; rel=&quot;rkraus&quot;&gt;rkraus&lt;/a&gt; thanks for the great test and analysis. I think you have identified the problem being the lack of work on the sync rollback. Am just wondering if the hash/equals of messageContext should be implemented such that indexOrderedCursorUpdates.remove() would be sufficient and am wondering about calling the completion in the rollback case, but it may be necessary for cleanup.&lt;br/&gt;
I will investigate some more. thanks again for the great bug report &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16341034" author="jira-bot" created="Fri, 26 Jan 2018 13:18:33 +0000"  >&lt;p&gt;Commit f96a20e831755505b31df2e14fd3266f74d5a149 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=f96a20e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=f96a20e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6891&quot; title=&quot;Duplicated message in JMS transaction, when jdbc persistence fails (Memory leak on Queue)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6891&quot;&gt;&lt;del&gt;AMQ-6891&lt;/del&gt;&lt;/a&gt; apply fix and test from Radek Kraus with thanks. Pending cursor adds are now dropped on rollback&lt;/p&gt;</comment>
                            <comment id="16341047" author="gtully" created="Fri, 26 Jan 2018 13:24:00 +0000"  >&lt;p&gt;It think your fix is on the money and the completion should be run. Thanks.&lt;/p&gt;</comment>
                            <comment id="16341252" author="rkraus" created="Fri, 26 Jan 2018 16:39:09 +0000"  >&lt;p&gt;Thank you for your time and confirmation my issue. Thanks for your great reaction time. &lt;br/&gt;
But unfortunately, I think, that problem is more complex. IMHO the invocation of &lt;tt&gt;rollbackPendingCursorAdditions(MessageContext)&lt;/tt&gt; method only from &lt;tt&gt;afterRollback()&lt;/tt&gt; solves problem when JMS transaction is used - it is great. But the similar problem (entry is not removed from list) occurs even when JMS transaction is not used (I noted it in issue description too). The problem is, that in this situation the &quot;rollback&quot; method is not invoked at all. In this case exception handling in &lt;tt&gt;doMessageSend(ProducerBrokerExchange, Message)&lt;/tt&gt; doesn&apos;t contains remove action too. In normal flow (no exception), the method &lt;tt&gt;tryOrderedCursorAdd()&lt;/tt&gt; is invoked and remove operation is finally done by &quot;standard&quot; &lt;tt&gt;doPendingCursorAdditions()&lt;/tt&gt; method. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
void doMessageSend(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ProducerBrokerExchange producerExchange, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Message message) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException,
&#160; ...
&#160; &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;//AMQ-6133 - don&apos;t store async &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; using persistJMSRedelivered
&lt;/span&gt;&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;//This flag causes a sync update later on dispatch which can cause a race
&lt;/span&gt;&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;//condition &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the original add is processed after the update, which can cause
&lt;/span&gt;&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;//a duplicate message to be stored
&lt;/span&gt;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (messages.isCacheEnabled() &amp;amp;&amp;amp; !isPersistJMSRedelivered()) {
&#160;&#160;&#160;&#160;&#160; result = store.asyncAddQueueMessage(context, message, isOptimizeStorage());
&#160;&#160;&#160;&#160;&#160; result.addListener(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PendingMarshalUsageTracker(message));
&#160;&#160;&#160; } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&#160;&#160;&#160;&#160;&#160; store.addMessage(context, message);
&#160;&#160;&#160; }
&#160; } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;// we may have a store in inconsistent state, so reset the cursor
&lt;/span&gt;&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;// before restarting normal broker operations
&lt;/span&gt;&#160;&#160;&#160; resetNeeded = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&#160;&#160;&#160; pendingSends.decrementAndGet();
&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;// !!! 
&lt;/span&gt;&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;// Here should be remove operation too, probably?
&lt;/span&gt;&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;//rollbackPendingCursorAdditions(messageContext);
&lt;/span&gt;&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;// !!!
&lt;/span&gt;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
&#160; }

&#160; ...

&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(tryOrderedCursorAdd(message, context)) {
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
&#160; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Yes it is my fault, because I didn&apos;t provide test case for this situation (send message without JMS transaction), sorry. I can extend my test class for this test case too. Sorry again.&lt;/p&gt;</comment>
                            <comment id="16341300" author="gtully" created="Fri, 26 Jan 2018 17:11:35 +0000"  >&lt;p&gt;the non transacted case has this issue also. Most often store IOErrors would result in the broker stop. However there are cases where we want to let these error bubble back to the producers and in that case we still have leak in the non transacted case.&lt;/p&gt;</comment>
                            <comment id="16344868" author="jira-bot" created="Tue, 30 Jan 2018 10:52:00 +0000"  >&lt;p&gt;Commit dd2572bcb1c3793a8a2fa19cc4fc88cc8481f96e in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=dd2572b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=dd2572b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6891&quot; title=&quot;Duplicated message in JMS transaction, when jdbc persistence fails (Memory leak on Queue)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6891&quot;&gt;&lt;del&gt;AMQ-6891&lt;/del&gt;&lt;/a&gt; test and fix non tx variant of this leak&lt;/p&gt;</comment>
                            <comment id="16344873" author="gtully" created="Tue, 30 Jan 2018 10:53:10 +0000"  >&lt;p&gt;fixed up the non transacted path and reused the leak test, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12907847" name="JmsTransactionCommitFailureTest.java" size="11078" author="rkraus" created="Fri, 26 Jan 2018 10:29:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 42 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3pd6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>