<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:00:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3447] When MessageListenerServlet is running under servlet3, the continuation is not timing out.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3447</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;In MessageListenerServlet.java&lt;/p&gt;

&lt;p&gt;          if (message == null &amp;amp;&amp;amp; client.getListener().getUndeliveredMessages().size() == 0) {&lt;br/&gt;
                Continuation continuation = ContinuationSupport.getContinuation(request);&lt;/p&gt;

&lt;p&gt;                if (continuation.isExpired()) &lt;/p&gt;
{
                    response.setStatus(HttpServletResponse.SC_OK);
                    StringWriter swriter = new StringWriter();
                    PrintWriter writer = new PrintWriter(swriter);
                    writer.println(&quot;&amp;lt;ajax-response&amp;gt;&quot;);
                    writer.print(&quot;&amp;lt;/ajax-response&amp;gt;&quot;);

                    writer.flush();
                    String m = swriter.toString();
                    response.getWriter().println(m); 
                    
                    return;
                }

&lt;p&gt;                continuation.setTimeout(timeout);&lt;br/&gt;
                continuation.suspend();&lt;br/&gt;
                LOG.debug( &quot;Suspending continuation &quot; + continuation );&lt;/p&gt;

&lt;p&gt;                // Fetch the listeners&lt;br/&gt;
                AjaxListener listener = client.getListener();&lt;br/&gt;
                listener.access();&lt;/p&gt;

&lt;p&gt;                // register this continuation with our listener.&lt;br/&gt;
                listener.setContinuation(continuation);&lt;/p&gt;

&lt;p&gt;                return;&lt;br/&gt;
            }&lt;/p&gt;

&lt;p&gt;Based on above code, the continuation is expected to be expired after given timeout when there is no message available for the ajax client and the ajax client will then receive an &quot;empty&quot; message. However based on the servlet 3 Continuation implementation in jetty (Servlet3Continuation.java) the only place where the continuation is set to expire is within the below method (there is a bug in this method as well). &lt;/p&gt;

&lt;p&gt;public void addContinuationListener(final ContinuationListener listener)&lt;br/&gt;
    {&lt;br/&gt;
        AsyncListener wrapped = new AsyncListener()&lt;br/&gt;
        {&lt;br/&gt;
            public void onComplete(final AsyncEvent event) throws IOException&lt;/p&gt;
            {
                listener.onComplete(Servlet3Continuation.this);
            }&lt;br/&gt;
&lt;br/&gt;
            public void onError(AsyncEvent event) throws IOException&lt;br/&gt;
            {                listener.onComplete(Servlet3Continuation.this);            }

&lt;p&gt;            public void onStartAsync(AsyncEvent event) throws IOException&lt;/p&gt;
            {
                event.getAsyncContext().addListener(this);
            }

&lt;p&gt;            public void onTimeout(AsyncEvent event) throws IOException&lt;/p&gt;
            {
                _expired=true;
                listener.onTimeout(Servlet3Continuation.this);
            }
&lt;p&gt;        };&lt;/p&gt;

&lt;p&gt;        if (_context==null)&lt;br/&gt;
            _context.addListener(wrapped);&lt;br/&gt;
        else&lt;br/&gt;
            _listeners.add(wrapped);&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;Without adding a listener the continuation will never be set to expire, therefore the &quot;empty&quot; response is never sent back to the client, the connection from the client is resumed and suspended over and over again until the connection is aborted by client or there is a message available.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu 11.04 using glassfish as web container running servlet 3.0 webapp.&lt;/p&gt;</environment>
        <key id="12518599">AMQ-3447</key>
            <summary>When MessageListenerServlet is running under servlet3, the continuation is not timing out.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jackygurui">Rui Gu</reporter>
                        <labels>
                            <label>Ajax</label>
                    </labels>
                <created>Thu, 11 Aug 2011 15:22:16 +0000</created>
                <updated>Wed, 19 Jun 2013 16:28:50 +0000</updated>
                            <resolved>Wed, 19 Jun 2013 16:28:50 +0000</resolved>
                                    <version>5.5.0</version>
                                    <fixVersion>5.9.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13682371" author="themel" created="Thu, 13 Jun 2013 16:04:28 +0000"  >&lt;p&gt;This looks like it&apos;s actually a bug in Jetty&apos;s continuation support, but in the mean time, here&apos;s a workaround:&lt;/p&gt;

&lt;p&gt;&amp;#8212; MessageListenerServlet.java.orig    2013-02-06 15:13:06.000000000 +0100&lt;br/&gt;
+++ MessageListenerServlet.java 2013-06-13 17:17:43.562011800 +0200&lt;br/&gt;
@@ -41,6 +41,7 @@&lt;/p&gt;

&lt;p&gt; import org.apache.activemq.MessageAvailableConsumer;&lt;br/&gt;
 import org.eclipse.jetty.continuation.Continuation;&lt;br/&gt;
+import org.eclipse.jetty.continuation.ContinuationListener;&lt;br/&gt;
 import org.eclipse.jetty.continuation.ContinuationSupport;&lt;br/&gt;
 import org.slf4j.Logger;&lt;br/&gt;
 import org.slf4j.LoggerFactory;&lt;br/&gt;
@@ -307,13 +308,29 @@&lt;/p&gt;

&lt;p&gt;             if (message == null &amp;amp;&amp;amp; client.getListener().getUndeliveredMessages().size() == 0) {&lt;br/&gt;
                 Continuation continuation = ContinuationSupport.getContinuation(request);&lt;br/&gt;
+&lt;br/&gt;
+               // Add a listener to the continuation to make sure it actually&lt;br/&gt;
+               // will expire (seems like a bug in Jetty Servlet 3 continuations, see &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3447&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-3447&lt;/a&gt;&lt;br/&gt;
+               continuation.addContinuationListener(new ContinuationListener() {&lt;br/&gt;
+                       @Override public void onTimeout(Continuation cont) {&lt;br/&gt;
+                               if (LOG.isDebugEnabled()) &lt;/p&gt;
{
+                                       LOG.debug(&quot;Continuation &quot; + cont.toString() + &quot; expired.&quot;);
+                               }
&lt;p&gt;+                       }&lt;br/&gt;
+                       @Override public void onComplete(Continuation cont) {&lt;br/&gt;
+                               if (LOG.isDebugEnabled()) &lt;/p&gt;
{
+                                       LOG.debug(&quot;Continuation &quot; + cont.toString() + &quot; completed.&quot;);
+                               }
&lt;p&gt;+                       }&lt;br/&gt;
+               });&lt;br/&gt;
+&lt;/p&gt;

&lt;p&gt;                 if (continuation.isExpired()) {&lt;br/&gt;
                     response.setStatus(HttpServletResponse.SC_OK);&lt;br/&gt;
                     StringWriter swriter = new StringWriter();&lt;br/&gt;
                     PrintWriter writer = new PrintWriter(swriter);&lt;/p&gt;</comment>
                            <comment id="13687748" author="themel" created="Wed, 19 Jun 2013 08:04:53 +0000"  >&lt;p&gt;Acknowledged as a Jetty bug, fixed in HEAD: &lt;a href=&quot;https://bugs.eclipse.org/bugs/show_bug.cgi?id=410911&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugs.eclipse.org/bugs/show_bug.cgi?id=410911&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13688130" author="tabish121" created="Wed, 19 Jun 2013 16:28:50 +0000"  >&lt;p&gt;Patch applied on trunk, for v5.9.0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>65457</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 22 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0eajz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>81472</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>