<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:34:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6142] ActiveMQBytesMessage decompress throws DataFormatException incorrect header check</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6142</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;In our environment we use an embedded broker. On one topic where compression is enabled, the server is also listening in on the messages. From ActiveMQ 5.10.0 up to 5.13.0, we encounter DataFormatException: incorrect header check exceptions on the tcp clients due to corruption of the payload. Attached are a test server and client. At some point, the client will exit due to mentioned exception. Increase chances by running multiple clients. This scenario works with 5.8.0 and 5.9.1.&lt;/p&gt;

&lt;p&gt;If the server has multiple consumers on the same topic, they will encounter corruption as well, but this has other side-effects.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12933814">AMQ-6142</key>
            <summary>ActiveMQBytesMessage decompress throws DataFormatException incorrect header check</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="tagliola">Claudio Tagliola</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Jan 2016 14:01:17 +0000</created>
                <updated>Mon, 11 Apr 2016 13:35:29 +0000</updated>
                            <resolved>Mon, 1 Feb 2016 17:44:31 +0000</resolved>
                                    <version>5.10.2</version>
                    <version>5.12.1</version>
                    <version>5.11.3</version>
                    <version>5.13.0</version>
                                    <fixVersion>5.13.1</fixVersion>
                    <fixVersion>5.14.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15115226" author="tagliola" created="Mon, 25 Jan 2016 14:01:49 +0000"  >&lt;p&gt;Stack trace:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;javax.jms.JMSException: java.util.zip.DataFormatException: incorrect header check
	at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:72)
	at org.apache.activemq.command.ActiveMQBytesMessage.initializeReading(ActiveMQBytesMessage.java:884)
	at org.apache.activemq.command.ActiveMQBytesMessage.getBodyLength(ActiveMQBytesMessage.java:198)
	at com.foo.bar.activemqtest.MessageListener.onMessage(MessageListener.java:11)
	at org.apache.activemq.ActiveMQMessageConsumer.dispatch(ActiveMQMessageConsumer.java:1393)
	at org.apache.activemq.ActiveMQSessionExecutor.dispatch(ActiveMQSessionExecutor.java:131)
	at org.apache.activemq.ActiveMQSessionExecutor.iterate(ActiveMQSessionExecutor.java:202)
	at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:133)
	at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:48)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
Caused by: java.io.IOException: java.util.zip.DataFormatException: incorrect header check
	at org.apache.activemq.command.ActiveMQBytesMessage.decompress(ActiveMQBytesMessage.java:902)
	at org.apache.activemq.command.ActiveMQBytesMessage.initializeReading(ActiveMQBytesMessage.java:876)
	... 10 more
Caused by: java.util.zip.DataFormatException: incorrect header check
	at java.util.zip.Inflater.inflateBytes(Native Method)
	at java.util.zip.Inflater.inflate(Inflater.java:259)
	at java.util.zip.Inflater.inflate(Inflater.java:280)
	at org.apache.activemq.command.ActiveMQBytesMessage.decompress(ActiveMQBytesMessage.java:898)
	... 11 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15115228" author="tagliola" created="Mon, 25 Jan 2016 14:03:38 +0000"  >&lt;p&gt;Prior thread on activemq-users: &lt;a href=&quot;http://activemq.2283324.n4.nabble.com/ActiveMQBytesMessage-decompress-throws-DataFormatException-incorrect-header-check-tp4706292.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.2283324.n4.nabble.com/ActiveMQBytesMessage-decompress-throws-DataFormatException-incorrect-header-check-tp4706292.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15121768" author="tagliola" created="Thu, 28 Jan 2016 15:56:07 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;package com.foo.bar.activemqtest;

import javax.jms.*;
import javax.jms.Connection;
import javax.jms.Message;

import org.apache.activemq.*;
import org.apache.activemq.broker.*;
import org.junit.*;

public class ActiveMQBytesMessageCorruptionTest
{
    private volatile AssertionError assertionError;

    @Test
    public void bytesMessageCorruption() throws Exception
    {
        BrokerService brokerService = new BrokerService();
        brokerService.setBrokerName(&quot;embedded&quot;);
        brokerService.setPersistent(false);
        brokerService.start();

        ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(&quot;vm://embedded&quot;);
        connectionFactory.setUseCompression(true);

        Connection connection = connectionFactory.createConnection();
        connection.start();

        for (int i = 0; i &amp;lt; 10; i++)
        {
            Session mySession = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);
            mySession.createConsumer(mySession.createTopic(&quot;foo.bar&quot;)).setMessageListener(this::onMessage);
        }

        Session producerSession = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);
        MessageProducer messageProducer = producerSession.createProducer(producerSession.createTopic(&quot;foo.bar&quot;));

        for (int i = 0; i &amp;lt; 1000; i++)
        {
            BytesMessage bytesMessage = producerSession.createBytesMessage();
            bytesMessage.writeBytes(new byte[0]);
            messageProducer.send(bytesMessage);

            if (assertionError != null)
            {
                throw assertionError;
            }
        }

    }

    private void onMessage(Message message)
    {
        try
        {
            ((BytesMessage) message).getBodyLength();
        }
        catch (JMSException | Error e)
        {
            assertionError = new AssertionError(&quot;Exception in thread&quot;, e);
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Unit test will fail most of the time with:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.AssertionError: Exception in thread
	at com.foo.bar.activemqtest.ActiveMQBytesMessageCorruptionTest.onMessage(ActiveMQBytesMessageCorruptionTest.java:60)
	at org.apache.activemq.ActiveMQMessageConsumer.dispatch(ActiveMQMessageConsumer.java:1393)
	at org.apache.activemq.ActiveMQSessionExecutor.dispatch(ActiveMQSessionExecutor.java:131)
	at org.apache.activemq.ActiveMQSessionExecutor.iterate(ActiveMQSessionExecutor.java:202)
	at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:133)
	at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:48)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
Caused by: java.lang.OutOfMemoryError: Java heap space
	at org.apache.activemq.command.ActiveMQBytesMessage.decompress(ActiveMQBytesMessage.java:897)
	at org.apache.activemq.command.ActiveMQBytesMessage.initializeReading(ActiveMQBytesMessage.java:876)
	at org.apache.activemq.command.ActiveMQBytesMessage.getBodyLength(ActiveMQBytesMessage.java:198)
	at com.foo.bar.activemqtest.ActiveMQBytesMessageCorruptionTest.onMessage(ActiveMQBytesMessageCorruptionTest.java:56)
	at com.foo.bar.activemqtest.ActiveMQBytesMessageCorruptionTest$$Lambda$3/665188480.onMessage(Unknown Source)
	... 8 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15126614" author="jira-bot" created="Mon, 1 Feb 2016 17:37:41 +0000"  >&lt;p&gt;Commit aaa2fdd5418098b98595f9f85be8248da32aff7b in activemq&apos;s branch refs/heads/activemq-5.13.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=aaa2fdd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=aaa2fdd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6142&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6142&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fixing a race condition that exists in the decompress method of&lt;br/&gt;
ActiveMQBytesMessage that can cause an invalid length to be read.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 5f7a81f9280fb65b8a3c1f85c4570a18d87fafd9)&lt;/p&gt;</comment>
                            <comment id="15126621" author="christopher.l.shannon" created="Mon, 1 Feb 2016 17:44:31 +0000"  >&lt;p&gt;Thanks for the test cases.  There was a race condition in the decompress method of ActiveMQBytesMessage.  I applied a fix and include a variation of one of your tests to make sure to catch this problem if it comes back in the future.&lt;/p&gt;</comment>
                            <comment id="15228135" author="gtully" created="Wed, 6 Apr 2016 11:34:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; sorry for the late input. I was peeking at this change and some of the sync from &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6218&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6218&lt;/a&gt; etc.&lt;/p&gt;

&lt;p&gt;Message intentionally has no sync, the intent is that copy is called if mods will be made. There is one before dispatch to a consumer that should sort this issue.&lt;br/&gt;
However, the copy seems broken.&lt;br/&gt;
For this bytesMessage case, it looks like the root cause is in message.copy where the content ByteSequence is referenced rather than copied in error.&lt;/p&gt;

&lt;p&gt;For &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6218&quot; title=&quot;Message content returns null occasionally from Virtual Topic to the consumer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6218&quot;&gt;&lt;del&gt;AMQ-6218&lt;/del&gt;&lt;/a&gt; - if all of those issues relate to concurrentStoreAndDispatch, it may be that we need to take a message.copy for the async store case.&lt;/p&gt;

&lt;p&gt;Let me attach a diff to see if this makes sense to you.&lt;/p&gt;</comment>
                            <comment id="15228136" author="gtully" created="Wed, 6 Apr 2016 11:35:53 +0000"  >&lt;p&gt;amq-6142.diff - file attach. Show the problem with message.copy that seems to be the root cause cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15228163" author="christopher.l.shannon" created="Wed, 6 Apr 2016 12:10:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;, This diff makes sense to fix the copy which is the root of the issue.  My commit had a test so if this diff is applied as a new commit CI can check that everything is still good.&lt;/p&gt;

&lt;p&gt;For &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6218&quot; title=&quot;Message content returns null occasionally from Virtual Topic to the consumer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6218&quot;&gt;&lt;del&gt;AMQ-6218&lt;/del&gt;&lt;/a&gt;, yes the entire problem comes down to concurrentStoreAndDispatch.  I talked to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt; about it a little and the problem shows up when using the VM transport because of the same message reference but two different threads accessing it.  There are other messages that could be fixed but the text message is the main issue because of the fix from &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5857&quot; title=&quot;Message content stored twice while sending&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5857&quot;&gt;&lt;del&gt;AMQ-5857&lt;/del&gt;&lt;/a&gt; where we clear out the text after converting to bytes so that the data isn&apos;t stored twice but only counted once.  So you can get into this weird state where both bytes and text end up being null.   &lt;/p&gt;

&lt;p&gt;Copying the message before doing the async store would fix this issue for sure and would allow the sync that I added to be backed out.  We could also back out the fix from &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5857&quot; title=&quot;Message content stored twice while sending&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5857&quot;&gt;&lt;del&gt;AMQ-5857&lt;/del&gt;&lt;/a&gt; as it was only applied to text messages (but other messages have the same issue i think) which would fix the issue as well.  I think that backing out the sync and copying the message before the async store makes the most sense but I didn&apos;t do that originally because I was concerned about the extra memory usage for large messages and for the memory usage counter to not take that into account.  But the copy is probably the right thing to do to prevent future problems with the async store case.&lt;/p&gt;</comment>
                            <comment id="15228254" author="christopher.l.shannon" created="Wed, 6 Apr 2016 13:39:33 +0000"  >&lt;p&gt;Also if we go the copy route we would need to take a look at the async listener that runs after completion.  I recently committed a fix to move the clearMarshalledState() call into the listener (if reduce memory footprint is on) and I think that might still need to run on the original message, not the copy since the copy should be GC&apos;s anyways after it&apos;s written.&lt;/p&gt;</comment>
                            <comment id="15228298" author="gtully" created="Wed, 6 Apr 2016 14:06:31 +0000"  >&lt;p&gt;good point, but thinking some more, the copy may be problematic because the concurrentStore stuff is coordinated through state in the messageId which is also copied. Will need to do some more root cause analysis on the concurrentStoreAndDisptch cases.&lt;/p&gt;</comment>
                            <comment id="15228649" author="christopher.l.shannon" created="Wed, 6 Apr 2016 17:02:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;, Seems like this same issue reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6218&quot; title=&quot;Message content returns null occasionally from Virtual Topic to the consumer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6218&quot;&gt;&lt;del&gt;AMQ-6218&lt;/del&gt;&lt;/a&gt; that caused me to add synchronization has also come up before in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2966&quot; title=&quot;Null messages occurring when using VM transport, topics and multiple consumers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2966&quot;&gt;&lt;del&gt;AMQ-2966&lt;/del&gt;&lt;/a&gt;.  What do you think about rolling back the fix I added from &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5857&quot; title=&quot;Message content stored twice while sending&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5857&quot;&gt;&lt;del&gt;AMQ-5857&lt;/del&gt;&lt;/a&gt; that clears out the text field after marshalling?  That was the start of all of these issues since state is now mutated and before it wasn&apos;t.  The downside is that the data would once again be stored twice leading to possible OOM issues, including for clients which is why originally &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5857&quot; title=&quot;Message content stored twice while sending&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5857&quot;&gt;&lt;del&gt;AMQ-5857&lt;/del&gt;&lt;/a&gt; was submitted.  So it would be nice to be able to clear it out but not if other concurrent issues keep popping up.&lt;/p&gt;

&lt;p&gt;Also, on a related note having to do with changing message state during dispatch, as I was digging back through some of this stuff I was looking at the reduceMemoryFootPrint flag and wondering if it could be applied to topics.  I&apos;m guessing it caused issues before so it wasn&apos;t applied (maybe with concurrent store and dispatch for topics) but it would be useful to be able to turn it on, especially if concurrent store and dispatch is off, which is the default.  &lt;/p&gt;</comment>
                            <comment id="15230280" author="gtully" created="Thu, 7 Apr 2016 14:04:58 +0000"  >&lt;p&gt;there is some more context in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2103&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-2103&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15230472" author="gtully" created="Thu, 7 Apr 2016 16:04:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; I think rolling back the sync is best, then thinking of mutation being ok on your own copy which implies maybe doing more copies and those not sharing mutable state. Client side there is typically a copy per consumer. &lt;br/&gt;
Broker side there is a single copy of the message at the moment and the reduceMemoryFootPrint policy can control whacking the duplicate state on send/store for a queue. concurrentStoreAndDispatch muddies that a bit.&lt;/p&gt;</comment>
                            <comment id="15232035" author="christopher.l.shannon" created="Fri, 8 Apr 2016 11:14:11 +0000"  >&lt;p&gt;Yep agreed, lets roll back the sync I added.  I think the Jira reported for &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5857&quot; title=&quot;Message content stored twice while sending&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5857&quot;&gt;&lt;del&gt;AMQ-5857&lt;/del&gt;&lt;/a&gt; was about client side and not the broker side (since reduceMemoryFootprint exists to clear the duplicate state, at least for queues).  I would say we either need to roll that commit back as well or maybe figure out a way so that the client can clear out the state but the broker won&apos;t clear it out until it is safe to do so.&lt;/p&gt;</comment>
                            <comment id="15234993" author="jira-bot" created="Mon, 11 Apr 2016 12:32:54 +0000"  >&lt;p&gt;Commit e69c2cbad6611fa355bd9eb592f03bd3b8f90abb in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e69c2cb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e69c2cb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6142&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6142&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Moving the bytes copy to the parent Message class to solve this this&lt;br/&gt;
issue for all message types as that is the root cause&lt;/p&gt;</comment>
                            <comment id="15234994" author="jira-bot" created="Mon, 11 Apr 2016 12:33:14 +0000"  >&lt;p&gt;Commit 20e84d63e045d3d26627e204c808677a8fe77dc4 in activemq&apos;s branch refs/heads/activemq-5.13.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=20e84d6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=20e84d6&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6142&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6142&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Moving the bytes copy to the parent Message class to solve this this&lt;br/&gt;
issue for all message types as that is the root cause&lt;/p&gt;

&lt;p&gt;(cherry picked from commit e69c2cbad6611fa355bd9eb592f03bd3b8f90abb)&lt;/p&gt;</comment>
                            <comment id="15235015" author="christopher.l.shannon" created="Mon, 11 Apr 2016 12:39:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;, I applied your new patch as it makes sense to move the bytes copy to that root Message class.  I also rolled back the sync as we discussed. &lt;/p&gt;</comment>
                            <comment id="15235034" author="gtully" created="Mon, 11 Apr 2016 12:43:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; great. I recall many times thinking message needed some sync and then finding a missing copy or a copy in the wrong place &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15235090" author="christopher.l.shannon" created="Mon, 11 Apr 2016 13:31:59 +0000"  >&lt;p&gt;Yep, makes sense now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I think what&apos;s left to do would be to call beforeMarshall on the message before async store to prevent the concurrent modifications on dispatch with the vm transport and also hopefully apply reduceMemoryFootprint flag for the topic case.  These can be done in new Jiras for a 5.14.0 release.&lt;/p&gt;</comment>
                            <comment id="15235098" author="gtully" created="Mon, 11 Apr 2016 13:35:29 +0000"  >&lt;p&gt;agree&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12679335">AMQ-4887</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12784155" name="Client.java" size="796" author="tagliola" created="Mon, 25 Jan 2016 14:03:04 +0000"/>
                            <attachment id="12784156" name="MessageListener.java" size="352" author="tagliola" created="Mon, 25 Jan 2016 14:03:04 +0000"/>
                            <attachment id="12784157" name="Server.java" size="1833" author="tagliola" created="Mon, 25 Jan 2016 14:03:04 +0000"/>
                            <attachment id="12797284" name="amq-6142.diff" size="2503" author="gtully" created="Wed, 6 Apr 2016 11:35:53 +0000"/>
                            <attachment id="12784158" name="pom.xml" size="923" author="tagliola" created="Mon, 25 Jan 2016 14:03:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 32 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2rxbb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>