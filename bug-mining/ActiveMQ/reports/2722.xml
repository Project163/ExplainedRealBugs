<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:33:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6094] Memory Leak with abnormal disconnecting consumers</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6094</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;On our production ActiveMQ broker (processes around 10 000 messages / sec in average) we have encountered situations where queues started blocking completely after running without problems for a couple of days.&lt;/p&gt;

&lt;p&gt;When taking a look at the activemq logs, we can see messages like this (I&apos;ve changed queue names and client IPs):&lt;/p&gt;

&lt;p&gt;2015-12-17 20:52:37,375 | INFO  | Usage(default:memory:queue://Consumer.AAA.VirtualTopic.OFFER:memory) percentUsage=100%, usage=104858538, limit=104857600, percentUsageMinDelta=1%;Parent:Usage(default:memory) percentUsage=42%, usage=305669289, limit=720424141, percentUsageMinDelta=1%: Usage Manager Memory Limit reached. Producer (ID:ip-172-30-0-97-38230-1450370654525-1:8:1:1) stopped to prevent flooding queue://Consumer.AAA.VirtualTopic.OFFER. See &lt;a href=&quot;http://activemq.apache.org/producer-flow-control.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/producer-flow-control.html&lt;/a&gt; for more info (blocking for: 151s) | org.apache.activemq.broker.region.Queue | ActiveMQ Transport: tcp:///1.1.1.1:36128@61616&lt;/p&gt;

&lt;p&gt;The strange thing is, when taking a look at the admin interface, there are no messages queued in the above mentioned queue and also purging the queue does not help.&lt;/p&gt;

&lt;p&gt;The only thing that works (that we found out so far) (to get the broker process messages again) in the above situation is:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;delete the queue (it then is recreated automatically and works again)&lt;/li&gt;
	&lt;li&gt;restart the broker&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I have now tried to reproduce the situation locally and come up with a test case that, while I am not sure if that is the exact problem that we face in production, at least produces the same problem as mentioned above. I have noticed that we sometimes have network issues between the clients and the broker and therefore have done something similar in the test code.&lt;/p&gt;

&lt;p&gt;The test code launches 4 producing threads and 4 consuming threads. The producers &amp;gt; 1000 messages / sec to the queues and the consumers just read them. Once after a while (every 10 seconds), one of the consuming threads is interrupted and then, with a delay of another 10 seconds, the connection is cleaned up (to free up the allocated messages that are already in the dead connections prefetchBuffer). &lt;/p&gt;

&lt;p&gt;When running the test case on a fresh download of activeMQ 5.13.0, it takes a long time until the broker completey blocks, as it takes time for the memory to fill up. However, when checking JMX stats, it is clearly visible, that the following metrics behave strangely:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;CursorMemoryUsage&lt;/li&gt;
	&lt;li&gt;MemoryUsageByteCount&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Both above metrics are quite constant for some time, and then, once a thread gets interrupted and the connection cleaned up, it suddenly increases by couple of mbytes ... then, again, while the consumers and producers work normally, the size is quite constant, until again, a consumer is interrupted, which again increases memory for couple of mbytes ... and this continues until memory is completely full and no messages can pass anymore through the broker.&lt;/p&gt;

&lt;p&gt;To speed things up, a lower memory limit can be placed on the queue in the activemq.xml configuration file, which will lead to shorter waiting time before the broker blocks messages on the queue.&lt;/p&gt;

&lt;p&gt;Even terminating the client jvm does not free up resources on the broker.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Unmodified release version of ActiveMQ 5.13.0 (&lt;a href=&quot;http://www.eu.apache.org/dist/activemq/5.13.0/apache-activemq-5.13.0-bin.tar.gz&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.eu.apache.org/dist/activemq/5.13.0/apache-activemq-5.13.0-bin.tar.gz&lt;/a&gt;)&lt;/p&gt;</environment>
        <key id="12922954">AMQ-6094</key>
            <summary>Memory Leak with abnormal disconnecting consumers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="d.bieringer">Dominik Bieringer</reporter>
                        <labels>
                    </labels>
                <created>Fri, 18 Dec 2015 07:20:23 +0000</created>
                <updated>Tue, 5 Jan 2016 15:09:50 +0000</updated>
                            <resolved>Tue, 5 Jan 2016 14:17:22 +0000</resolved>
                                    <version>5.13.0</version>
                                    <fixVersion>5.12.2</fixVersion>
                    <fixVersion>5.13.1</fixVersion>
                    <fixVersion>5.14.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15063632" author="d.bieringer" created="Fri, 18 Dec 2015 07:21:10 +0000"  >&lt;p&gt;Test Case&lt;/p&gt;</comment>
                            <comment id="15063636" author="d.bieringer" created="Fri, 18 Dec 2015 07:26:45 +0000"  >&lt;p&gt;Running the same test code with 5.12.1 works correctly and the described issue does not appear.&lt;/p&gt;</comment>
                            <comment id="15063688" author="d.bieringer" created="Fri, 18 Dec 2015 08:30:35 +0000"  >&lt;p&gt;Also tried it now with 5.12.2 (built with code from GitHub) and this version seems to be affected by the above described problem as well (I&apos;ve added it to the affected versions)&lt;/p&gt;</comment>
                            <comment id="15064239" author="christopher.l.shannon" created="Fri, 18 Dec 2015 17:15:10 +0000"  >&lt;p&gt;Thanks for reporting this.  I was able to use your test and verify that there is in fact an issue. I modified your test case slightly so that it runs with an embedded broker and JUnit.  I am able to see it print out an increasing memory usage.&lt;/p&gt;

&lt;p&gt;I did some debugging with git-bisect and the problem is coming from this commit: &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=1ad0117932ae73603b963860c92c0980a3572b9e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=1ad0117932ae73603b963860c92c0980a3572b9e&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The commit was all cherry-picked to 5.12.x &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=e54c9ccfa0a2bbc419fc10c39825610bf078c3db&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=e54c9ccfa0a2bbc419fc10c39825610bf078c3db&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So, for now I am going to go ahead and cancel the 5.12.2 vote because I think this issue should be resolved before releasing 5.12.2&lt;/p&gt;</comment>
                            <comment id="15064247" author="christopher.l.shannon" created="Fri, 18 Dec 2015 17:17:13 +0000"  >&lt;p&gt;Modified test case that runs with JUnit and is standalone that demonstrates the problem.&lt;/p&gt;</comment>
                            <comment id="15064336" author="christopher.l.shannon" created="Fri, 18 Dec 2015 17:57:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;, When you get a chance can you take a look at this and see what you think?  I&apos;ve narrowed down the issue to the changes that were made to PrefetchSubscription in commit &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=1ad0117932ae73603b963860c92c0980a3572b9e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=1ad0117932ae73603b963860c92c0980a3572b9e&lt;/a&gt; .  If you undo the changes then the test case runs without memory usage continuing to increase.&lt;/p&gt;</comment>
                            <comment id="15081020" author="felixehm" created="Mon, 4 Jan 2016 11:14:17 +0000"  >&lt;p&gt;Hi,&lt;br/&gt;
do I understand that this problem only occurs for durable subscribers ?&lt;br/&gt;
Thanks,&lt;br/&gt;
Felix&lt;/p&gt;</comment>
                            <comment id="15083090" author="jira-bot" created="Tue, 5 Jan 2016 14:09:42 +0000"  >&lt;p&gt;Commit e3df09b9db09d6cf2834b0beb901c253be9b6120 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e3df09b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e3df09b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6094&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6094&lt;/a&gt; - regression via &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6014&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6014&lt;/a&gt; - incorrect ref count on message expiry event during cursor move for dispatch. Fix and test - thanks for the test&lt;/p&gt;</comment>
                            <comment id="15083097" author="gtully" created="Tue, 5 Jan 2016 14:11:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=felixehm&quot; class=&quot;user-hover&quot; rel=&quot;felixehm&quot;&gt;felixehm&lt;/a&gt; - fraid not. It related to the expiry check, so any message with a setTimeToLive could trigger it.&lt;/p&gt;</comment>
                            <comment id="15083105" author="gtully" created="Tue, 5 Jan 2016 14:17:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; thanks for the unit test and commit identification. The expiry case was missing a decrement which lead to the leak. The test now verifies the usage after draining the queue, it finishes in a minute of so. &lt;/p&gt;</comment>
                            <comment id="15083136" author="christopher.l.shannon" created="Tue, 5 Jan 2016 14:33:01 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;, I will get the fix back-ported and re-run the 5.12.2 vote.&lt;/p&gt;</comment>
                            <comment id="15083197" author="jira-bot" created="Tue, 5 Jan 2016 15:08:08 +0000"  >&lt;p&gt;Commit 26665fa1b98a9004fc90a6eeea26ca06eb53d118 in activemq&apos;s branch refs/heads/activemq-5.13.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=26665fa&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=26665fa&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6094&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6094&lt;/a&gt; - regression via &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6014&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6014&lt;/a&gt; - incorrect ref count on message expiry event during cursor move for dispatch. Fix and test - thanks for the test&lt;/p&gt;

&lt;p&gt;(cherry picked from commit e3df09b9db09d6cf2834b0beb901c253be9b6120)&lt;/p&gt;</comment>
                            <comment id="15083200" author="jira-bot" created="Tue, 5 Jan 2016 15:08:48 +0000"  >&lt;p&gt;Commit 6f8942387e98f3dd41612dc331fa72f3fa718613 in activemq&apos;s branch refs/heads/activemq-5.12.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=6f89423&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=6f89423&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6094&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6094&lt;/a&gt; - regression via &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6014&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6014&lt;/a&gt; - incorrect ref count on message expiry event during cursor move for dispatch. Fix and test - thanks for the test&lt;/p&gt;

&lt;p&gt;(cherry picked from commit e3df09b9db09d6cf2834b0beb901c253be9b6120)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12905926">AMQ-6014</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12778441" name="Test.java" size="3007" author="d.bieringer" created="Fri, 18 Dec 2015 07:21:10 +0000"/>
                            <attachment id="12778522" name="Test6094JUnit.java" size="4602" author="cshannon" created="Fri, 18 Dec 2015 17:17:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 46 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2q2tz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310080" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Regression</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10091"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>