<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:59:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-9504] activemq multikahadb persistence adapter with topic wildcard filtered adapter and per destination filtered adapter causes broker failure on restart</title>
                <link>https://issues.apache.org/jira/browse/AMQ-9504</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;When using Multi KahaDB persistence adapter according to &lt;a href=&quot;https://activemq.apache.org/components/classic/documentation/kahadb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the documentation&lt;/a&gt; it shows that you can use multiple &lt;tt&gt;filteredPersistenceAdapters&lt;/tt&gt; but this does not work if you have two filtered adapter where one is using wildcard match for topics (or even a specific topic) and second filtered adapter using per destination filtered adapter.&lt;/p&gt;

&lt;p&gt;The idea being you want to use one KahaDB instance for all the topics and per destination KahaDB instance for all other destinations like queues. Something like this for illustration of the issue see test for more details. (note JMX needs to be enabled) : &#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;broker &#160;useJmx=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt; brokerName=&lt;span class=&quot;code-quote&quot;&gt;&quot;broker&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;persistenceAdapter&amp;gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;mKahaDB directory=&lt;span class=&quot;code-quote&quot;&gt;&quot;${activemq.base}/data/kahadb&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;filteredPersistenceAdapters&amp;gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;&amp;lt;!-- match all topics--&amp;gt;&lt;/span&gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;filteredKahaDB topic=&lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;gt;&lt;/span&gt;&quot;&lt;/span&gt;&amp;gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;usage&amp;gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;storeUsage limit=&lt;span class=&quot;code-quote&quot;&gt;&quot;1g&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/usage&amp;gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;persistenceAdapter&amp;gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;kahaDB journalMaxFileLength=&lt;span class=&quot;code-quote&quot;&gt;&quot;32mb&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/persistenceAdapter&amp;gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/filteredKahaDB&amp;gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;&amp;lt;!-- match all destinations &#160;kahaDB per destinations --&amp;gt;&lt;/span&gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;filteredKahaDB perDestination=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;persistenceAdapter&amp;gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;kahaDB journalMaxFileLength=&lt;span class=&quot;code-quote&quot;&gt;&quot;32mb&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/persistenceAdapter&amp;gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/filteredKahaDB&amp;gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/filteredPersistenceAdapters&amp;gt;&lt;/span&gt;
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/mKahaDB&amp;gt;&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/persistenceAdapter&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/broker&amp;gt;&lt;/span&gt;&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;With this setting it works for the first time when broker is started. But as soon as you have atleast one topic created which uses wild card filtered adapter and you restart the broker, then what happens is there are two KahaDBPersistenceAdapter created one by the wildcard (&quot;&amp;gt;&quot;) topic filtered adapter and another one by the second per destination filtered adapter, and so second KahaDBPersistenceAdapter fails with below exception:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[INFO] Running org.apache.activemq.bugs.MultiKahaDBMultipleFilteredAdapterTest
[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 16.20 s &amp;lt;&amp;lt;&amp;lt; FAILURE! &#8211; in org.apache.activemq.bugs.MultiKahaDBMultipleFilteredAdapterTest
[ERROR] org.apache.activemq.bugs.MultiKahaDBMultipleFilteredAdapterTest.testTopicWildcardAndPerDestinationFilteredAdapter &#8211; Time elapsed: 11.08 s &amp;lt;&amp;lt;&amp;lt; ERROR!
javax.management.InstanceAlreadyExistsException: org.apache.activemq:type=Broker,brokerName=localhost,service=PersistenceAdapter,instanceName=KahaDBPersistenceAdapter[/mnt/c/Users/ritesh.adval/work/external-repos/activemq/activemq-unit-tests/target/activemq-data/mKahaDB/topic#3a#2f#2f#3e_Index_/mnt/c/Users/ritesh.adval/work/external-repos/activemq/activemq-unit-tests/target/activemq-data/mKahaDB/topic#3a#2f#2f#3e|#3a#2f#2f#3e_Index_/mnt/c/Users/ritesh.adval/work/external-repos/activemq/activemq-unit-tests/target/activemq-data/mKahaDB/topic#3a#2f#2f#3e]
&#160; &#160; &#160; &#160; at java.management/com.sun.jmx.mbeanserver.Repository.addMBean(Repository.java:436)
&#160; &#160; &#160; &#160; at java.management/com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerWithRepository(DefaultMBeanServerInterceptor.java:1855)
&#160; &#160; &#160; &#160; at java.management/com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerDynamicMBean(DefaultMBeanServerInterceptor.java:955)
&#160; &#160; &#160; &#160; at java.management/com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerObject(DefaultMBeanServerInterceptor.java:890)
&#160; &#160; &#160; &#160; at java.management/com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerMBean(DefaultMBeanServerInterceptor.java:320)
&#160; &#160; &#160; &#160; at java.management/com.sun.jmx.mbeanserver.JmxMBeanServer.registerMBean(JmxMBeanServer.java:522)
&#160; &#160; &#160; &#160; at org.apache.activemq.broker.jmx.ManagementContext.registerMBean(ManagementContext.java:415)
&#160; &#160; &#160; &#160; at org.apache.activemq.broker.jmx.AnnotatedMBean.registerMBean(AnnotatedMBean.java:93)
&#160; &#160; &#160; &#160; at org.apache.activemq.store.kahadb.KahaDBPersistenceAdapter.doStart(KahaDBPersistenceAdapter.java:251)
&#160; &#160; &#160; &#160; at org.apache.activemq.util.ServiceSupport.start(ServiceSupport.java:55)
&#160; &#160; &#160; &#160; at org.apache.activemq.store.kahadb.MultiKahaDBPersistenceAdapter.doStart(MultiKahaDBPersistenceAdapter.java:381)
&#160; &#160; &#160; &#160; at org.apache.activemq.util.ServiceSupport.start(ServiceSupport.java:55)
&#160; &#160; &#160; &#160; at org.apache.activemq.broker.BrokerService.doStartPersistenceAdapter(BrokerService.java:681)
&#160; &#160; &#160; &#160; at org.apache.activemq.broker.BrokerService.startPersistenceAdapter(BrokerService.java:663)
&#160; &#160; &#160; &#160; at org.apache.activemq.broker.BrokerService.start(BrokerService.java:627)
&#160; &#160; &#160; &#160; at org.apache.activemq.bugs.MultiKahaDBMultipleFilteredAdapterTest.testTopicWildcardAndPerDestinationFilteredAdapter(MultiKahaDBMultipleFilteredAdapterTest.java:76)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I have unit test for this and have a fix as well, attaching them with the issue (its for 5.18.4 release and I believe issue exists in latest 6.x release as well).&lt;br/&gt;
&#160;&lt;br/&gt;
The bug is that on restart/start of the broker, wildcard filtered adapter adds one &lt;tt&gt;KahaDBPersistenceAdapter&lt;/tt&gt; when calling &lt;tt&gt;MultiKahaDBPersistenceAdapter.setFilteredPersistenceAdapters&lt;/tt&gt;, and on the call to &lt;tt&gt;doStart&lt;/tt&gt; of &lt;tt&gt;MultiKahaDBPersistenceAdapter&lt;/tt&gt;, it uses per destination filtered adapter to add another &lt;tt&gt;KahaDBPersistenceAdapter&lt;/tt&gt; for the same topic, and fails on JMX MBean registration. The fix is to make sure to check if a &lt;tt&gt;KahaDBPersistenceAdapter&lt;/tt&gt; already exists for given destination dir, when we do per destination filtered adapter processing and only add it if one does not exists already.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13580030">AMQ-9504</key>
            <summary>activemq multikahadb persistence adapter with topic wildcard filtered adapter and per destination filtered adapter causes broker failure on restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="ritesh.adval">ritesh adval</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 May 2024 21:31:41 +0000</created>
                <updated>Tue, 28 May 2024 18:00:49 +0000</updated>
                            <resolved>Wed, 22 May 2024 13:43:51 +0000</resolved>
                                    <version>5.18.4</version>
                    <version>6.1.2</version>
                                    <fixVersion>6.2.0</fixVersion>
                    <fixVersion>5.18.5</fixVersion>
                    <fixVersion>6.1.3</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17848405" author="christopher.l.shannon" created="Tue, 21 May 2024 23:58:22 +0000"  >&lt;p&gt;This probably needs to be looked at more and i&apos;m not sure if &quot;perDestination&quot; was meant to work for this use case&lt;/p&gt;</comment>
                            <comment id="17848442" author="JIRAUSER305516" created="Wed, 22 May 2024 04:54:20 +0000"  >&lt;p&gt;It is&#160; if you look at the documentation at &lt;a href=&quot;https://activemq.apache.org/components/classic/documentation/kahadb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://activemq.apache.org/components/classic/documentation/kahadb&lt;/a&gt; , first of all multiple filteredKahaDB are allowed as also shown in the example in above link.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Each instance of&#160;&lt;tt&gt;kahaDB&lt;/tt&gt;&#160;can be configured independently. If no destination is supplied to a&#160;&lt;tt&gt;filteredKahaDB&lt;/tt&gt;, the implicit default value will match any destination, queue or topic.&quot; This is a handy catch all. If no matching persistence adapter can be found, destination creation will fail with an exception. The &lt;tt&gt;filteredKahaDB&lt;/tt&gt;&#160;shares its wildcard matching rules with&#160;&lt;a href=&quot;https://activemq.apache.org/components/classic/documentation/per-destination-policies&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Per Destination Policies&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;and also:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Set &lt;tt&gt;perDestination=&quot;true&quot;&lt;/tt&gt;&#160;on the catch all, i.e., when no explicit destination is set,&#160;&lt;tt&gt;filteredKahaDB&lt;/tt&gt;&#160;entry. Each matching destination will be assigned its own&#160;&lt;tt&gt;kahaDB&lt;/tt&gt; instance.&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Nowhere in the document, it says that if you use a filteredKahaDB with perDestination=&quot;true&quot; then you can not use any other filteredKahaDB and more over the use case I mentioned is a valid one where I have non durable topics and I do not want to run multiple kahadbs for each topics, where as for queues I want to have one kahadb per queue.&lt;/p&gt;

&lt;p&gt;And I tested it and it works just not on restart of the broker due the bug and fix seems to have fixed the issue.&lt;/p&gt;</comment>
                            <comment id="17848614" author="jira-bot" created="Wed, 22 May 2024 13:27:50 +0000"  >&lt;p&gt;Commit ddfb36515c0e9588d2e322365f56a3f53fb094ad in activemq&apos;s branch refs/heads/main from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=ddfb36515&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=ddfb36515&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9504&quot; title=&quot;activemq multikahadb persistence adapter with topic wildcard filtered adapter and per destination filtered adapter causes broker failure on restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9504&quot;&gt;&lt;del&gt;AMQ-9504&lt;/del&gt;&lt;/a&gt; - Prevent registering duplicate mKahadb adapters&lt;/p&gt;

&lt;p&gt;This fixes an issue on start up of a broker that is configured with&lt;br/&gt;
multiple mKahaDB filtered adapters and one is configured with&lt;br/&gt;
perDestination=true. Before this fix a duplicate persistence adapter&lt;br/&gt;
could be created because the filter did not check for existing matches.&lt;/p&gt;

&lt;p&gt;Patch applied with thanks to Ritesh Adval&lt;/p&gt;</comment>
                            <comment id="17848615" author="jira-bot" created="Wed, 22 May 2024 13:30:01 +0000"  >&lt;p&gt;Commit d719df23007393660547b58c9ff17c3d0bd72f8a in activemq&apos;s branch refs/heads/activemq-6.1.x from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=d719df230&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=d719df230&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9504&quot; title=&quot;activemq multikahadb persistence adapter with topic wildcard filtered adapter and per destination filtered adapter causes broker failure on restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9504&quot;&gt;&lt;del&gt;AMQ-9504&lt;/del&gt;&lt;/a&gt; - Prevent registering duplicate mKahadb adapters&lt;/p&gt;

&lt;p&gt;This fixes an issue on start up of a broker that is configured with&lt;br/&gt;
multiple mKahaDB filtered adapters and one is configured with&lt;br/&gt;
perDestination=true. Before this fix a duplicate persistence adapter&lt;br/&gt;
could be created because the filter did not check for existing matches.&lt;/p&gt;

&lt;p&gt;Patch applied with thanks to Ritesh Adval&lt;/p&gt;

&lt;p&gt;(cherry picked from commit ddfb36515c0e9588d2e322365f56a3f53fb094ad)&lt;/p&gt;</comment>
                            <comment id="17848617" author="jira-bot" created="Wed, 22 May 2024 13:33:45 +0000"  >&lt;p&gt;Commit c71965176ac4acec78779fbc626c98fc310603e1 in activemq&apos;s branch refs/heads/activemq-5.18.x from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=c71965176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=c71965176&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9504&quot; title=&quot;activemq multikahadb persistence adapter with topic wildcard filtered adapter and per destination filtered adapter causes broker failure on restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9504&quot;&gt;&lt;del&gt;AMQ-9504&lt;/del&gt;&lt;/a&gt; - Prevent registering duplicate mKahadb adapters&lt;/p&gt;

&lt;p&gt;This fixes an issue on start up of a broker that is configured with&lt;br/&gt;
multiple mKahaDB filtered adapters and one is configured with&lt;br/&gt;
perDestination=true. Before this fix a duplicate persistence adapter&lt;br/&gt;
could be created because the filter did not check for existing matches.&lt;/p&gt;

&lt;p&gt;Patch applied with thanks to Ritesh Adval&lt;/p&gt;

&lt;p&gt;(cherry picked from commit ddfb36515c0e9588d2e322365f56a3f53fb094ad)&lt;/p&gt;</comment>
                            <comment id="17848619" author="christopher.l.shannon" created="Wed, 22 May 2024 13:43:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ritesh.adval&quot; class=&quot;user-hover&quot; rel=&quot;ritesh.adval&quot;&gt;ritesh.adval&lt;/a&gt; - Thanks for the detailed information, I took a look closely at this and it is indeed just an issue on restart. Things work correctly initially (only 2 stores were created in your unit test) but then on restart the code for &lt;tt&gt;perDestination=true&lt;/tt&gt; isn&apos;t smart enough to check if there are existing adapters that exist that already map to the existing directories.&lt;/p&gt;

&lt;p&gt;Your fix looks good so I made some small modifications to it and the test and applied a variation of it.&lt;/p&gt;</comment>
                            <comment id="17848629" author="jira-bot" created="Wed, 22 May 2024 14:11:35 +0000"  >&lt;p&gt;Commit 527d245831fb95fa3a25180ecf404d5a316f2425 in activemq&apos;s branch refs/heads/main from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=527d24583&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=527d24583&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9504&quot; title=&quot;activemq multikahadb persistence adapter with topic wildcard filtered adapter and per destination filtered adapter causes broker failure on restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9504&quot;&gt;&lt;del&gt;AMQ-9504&lt;/del&gt;&lt;/a&gt; - Add missing license header&lt;/p&gt;</comment>
                            <comment id="17848630" author="jira-bot" created="Wed, 22 May 2024 14:11:57 +0000"  >&lt;p&gt;Commit ba3d395fc3f077f41381ad801f2a898caebb1eaa in activemq&apos;s branch refs/heads/activemq-6.1.x from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=ba3d395fc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=ba3d395fc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9504&quot; title=&quot;activemq multikahadb persistence adapter with topic wildcard filtered adapter and per destination filtered adapter causes broker failure on restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9504&quot;&gt;&lt;del&gt;AMQ-9504&lt;/del&gt;&lt;/a&gt; - Add missing license header&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 527d245831fb95fa3a25180ecf404d5a316f2425)&lt;/p&gt;</comment>
                            <comment id="17848632" author="jira-bot" created="Wed, 22 May 2024 14:12:34 +0000"  >&lt;p&gt;Commit a12f030090bdf593b4c7bbaf10cd2d553f14bf89 in activemq&apos;s branch refs/heads/activemq-5.18.x from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=a12f03009&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=a12f03009&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9504&quot; title=&quot;activemq multikahadb persistence adapter with topic wildcard filtered adapter and per destination filtered adapter causes broker failure on restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9504&quot;&gt;&lt;del&gt;AMQ-9504&lt;/del&gt;&lt;/a&gt; - Add missing license header&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 527d245831fb95fa3a25180ecf404d5a316f2425)&lt;/p&gt;</comment>
                            <comment id="17848667" author="JIRAUSER305516" created="Wed, 22 May 2024 15:32:53 +0000"  >&lt;p&gt;This is great, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; for applying the patch, can you please let me know if there will be a new patch release from activemq-5.18.x release branch ? I would look to use official release version with this fix.&lt;/p&gt;</comment>
                            <comment id="17848684" author="christopher.l.shannon" created="Wed, 22 May 2024 16:40:39 +0000"  >&lt;p&gt;6.2.0 should be getting prepared for release before too long but I&apos;m not sure about 5.18.5, there&apos;s not much else pressing at the moment for a release.&#160;&lt;/p&gt;</comment>
                            <comment id="17848695" author="JIRAUSER305516" created="Wed, 22 May 2024 17:37:41 +0000"  >&lt;p&gt;We are still on jdk 11 and would like to use next release 5.18.5. it seems the page here shows ETA of june 24th for next 5.18.5 release &lt;a href=&quot;https://activemq.apache.org/components/classic/download/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://activemq.apache.org/components/classic/download/&lt;/a&gt;&#160; let me know if this will happen or&#160; should I address the release question to someone else who does it ?&#160;&lt;/p&gt;

&lt;p&gt;Would like this patch release available sooner if possible so we can use it.&lt;/p&gt;

&lt;p&gt;Thx&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17848699" author="christopher.l.shannon" created="Wed, 22 May 2024 17:53:21 +0000"  >&lt;p&gt;Any dates are just an estimate and there is no guarantee. This is definitely not a high priority thing that is going to cause us to rush a release so I can&apos;t tell you when it will be released as the focus is on the newer 6.x releases now. Asking other people isn&apos;t going to change the answer.&lt;/p&gt;</comment>
                            <comment id="17849076" author="JIRAUSER305516" created="Thu, 23 May 2024 18:40:53 +0000"  >&lt;p&gt;ok thx for the update. For us its a high priority issue, because the functionality of multi kahadb is broken as soon as the broker is restarted (with configuration we have in this issue).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Moreover it seems it would in fact causes DATA CORRUPTION because there are two KahaDBPersistenceAdapter running on same directory when you turn off jmx. The jmx=true exhibits the issue where we get an exception to register the same mbean twice, but if we set jmx to false. then it silently would start two KahaDBPersistenceAdapter and test will not fail.&lt;/p&gt;

&lt;p&gt;if you set the jmx to false you will see below (this the log from test after we restart the broker), note it goes into PageFile recovery after restart, there will not be any exception thrown in the test but two KahaDBPersistenceAdapter&#160; are allowed to run on same directory which is not good.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also I think it would good to log a line in&#160; KahaDBPersistenceAdapter when it starts on a directory... currently its very hard to know from the logs, how many of these are configured and running on what directory.&lt;br/&gt;
&#160;&lt;br/&gt;
2024-05-23 11:31:04,297 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;BrokerService &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;- Using Persistence Adapter: MultiKahaDBPersistenceAdapter&lt;span class=&quot;error&quot;&gt;&amp;#91;/mnt/c/Users/ritesh.adval/work/external-repos/activemq/activemq-unit-tests/target/activemq-data/mKahaDB&amp;#93;&lt;/span&gt;&lt;a href=&quot;#3a#2f#2f#3e&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;KahaDBPersistenceAdapter[/mnt/c/Users/ritesh.adval/work/external-repos/activemq/activemq-unit-tests/target/activemq-data/mKahaDB/topic#3a#2f#2f#3e]&lt;/a&gt;]&lt;br/&gt;
2024-05-23 11:31:04,298 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;BrokerService &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;- Starting Persistence Adapter: MultiKahaDBPersistenceAdapter&lt;span class=&quot;error&quot;&gt;&amp;#91;/mnt/c/Users/ritesh.adval/work/external-repos/activemq/activemq-unit-tests/target/activemq-data/mKahaDB&amp;#93;&lt;/span&gt;&lt;a href=&quot;#3a#2f#2f#3e&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;KahaDBPersistenceAdapter[/mnt/c/Users/ritesh.adval/work/external-repos/activemq/activemq-unit-tests/target/activemq-data/mKahaDB/topic#3a#2f#2f#3e]&lt;/a&gt;]&lt;br/&gt;
2024-05-23 11:31:04,331 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;KahaDBStore &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;- Starting KahaDBStore&lt;br/&gt;
2024-05-23 11:31:04,335 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;MessageDatabase &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;- Opening MessageDatabase&lt;br/&gt;
2024-05-23 11:31:04,413 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;MessageDatabase &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;- KahaDB is version 7&lt;br/&gt;
2024-05-23 11:31:04,551 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;KahaDBStore &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;- Starting KahaDBStore&lt;br/&gt;
2024-05-23 11:31:04,561 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;MessageDatabase &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;- Opening MessageDatabase&lt;br/&gt;
2024-05-23 11:31:04,619 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;MessageDatabase &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;- KahaDB is version 7&lt;br/&gt;
2024-05-23 11:31:04,631 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;KahaDBStore &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;- Starting KahaDBStore&lt;br/&gt;
2024-05-23 11:31:04,633 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;MessageDatabase &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;- Opening MessageDatabase&lt;br/&gt;
&lt;b&gt;2024-05-23 11:31:04,699 &lt;span class=&quot;error&quot;&gt;&amp;#91;e Page Recovery&amp;#93;&lt;/span&gt; - INFO &#160;PageFile &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; - Page File: target/activemq-data/mKahaDB/topic#3a#2f#2f#3e/db.data. Recovering pageFile free list due to prior unclean shutdown..&lt;/b&gt;&lt;br/&gt;
&lt;b&gt;2024-05-23 11:31:04,703 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;MessageDatabase &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;- KahaDB is version 7&lt;/b&gt;&lt;br/&gt;
&lt;b&gt;2024-05-23 11:31:04,726 &lt;span class=&quot;error&quot;&gt;&amp;#91;e Page Recovery&amp;#93;&lt;/span&gt; - INFO &#160;PageFile &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; - Page File: target/activemq-data/mKahaDB/topic#3a#2f#2f#3e/db.data. Recovered pageFile free list of size: 0&lt;/b&gt;&lt;br/&gt;
&lt;b&gt;2024-05-23 11:31:04,730 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;MessageDatabase &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;- Recovering from the journal @1:622&lt;/b&gt;&lt;br/&gt;
&lt;b&gt;2024-05-23 11:31:04,738 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;MessageDatabase &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;- Recovery replayed 1 operations from the journal in 0.018 seconds.&lt;/b&gt;&lt;br/&gt;
2024-05-23 11:31:04,740 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;BrokerService &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;- Starting Temp Data Store&lt;br/&gt;
2024-05-23 11:31:04,742 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;PListStoreImpl &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; - PListStore:&lt;span class=&quot;error&quot;&gt;&amp;#91;/mnt/c/Users/ritesh.adval/work/external-repos/activemq/activemq-unit-tests/target/activemq-data/localhost/tmp_storage&amp;#93;&lt;/span&gt; started&lt;br/&gt;
2024-05-23 11:31:04,743 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;BrokerService &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;- Starting Job Scheduler Store&lt;br/&gt;
2024-05-23 11:31:04,744 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &#160; &#160; &#160; &#160; &#160; &amp;#93;&lt;/span&gt; - INFO &#160;BrokerService &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;- Persistence Adapter successfully started&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17849115" author="christopher.l.shannon" created="Thu, 23 May 2024 20:43:41 +0000"  >&lt;p&gt;Yeah, it would be a problem because it&apos;s trying to create duplicate adapters touching the same directory, so it&apos;s definitely not going to work right. Turning off JMX as you have shown just pushes the problem downstream if you configure things that way and will cause things to break. The vast majority of people do not use multiKahaDB and if they do obviously don&apos;t configure it this way (most people that use the option to create a store per destination set up their config with that as the only filter) otherwise it would have been reported way before now.&lt;/p&gt;

&lt;p&gt;Is there a reason why you can&apos;t build a custom version with the patch temporarily? One of the benefits of using open source like this is you can do whatever you want, you can build your own version at any point. I know you want to use an official release but building your own version with the fix is the fastest way for now.&lt;/p&gt;

&lt;p&gt;Our plan is to do a 6.2.0 release in the next couple of weeks, after that we could look at doing a 5.18.5 release which would include this fix, but again, I&apos;m not really sure on an exact timeline so if it&apos;s that high of a priority you will need to build your own version temporarily until the new version is out.&lt;/p&gt;</comment>
                            <comment id="17850126" author="JIRAUSER305516" created="Tue, 28 May 2024 18:00:49 +0000"  >&lt;p&gt;ok thx &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; for the update.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13069018" name="bugfix.patch" size="1494" author="ritesh.adval" created="Tue, 21 May 2024 21:32:06 +0000"/>
                            <attachment id="13069019" name="test.patch" size="6499" author="ritesh.adval" created="Tue, 21 May 2024 21:32:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 24 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1pcns:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>