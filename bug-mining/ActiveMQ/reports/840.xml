<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:44:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2611] Stopping camel context with ActiveMQComponent does not close connections to ActiveMQ</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2611</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Stopping a camel context that uses an ActiveMQComponent does not appear to close connections to the ActiveMQBroker.  See the attached test case as an example.  It creates a camel context containing an ActiveMQ consumer and producer, sends a message, then destroys the context.  The test case does this in a loop so every 4 seconds the old camel context is destroyed and a new one is created.  Every second the test outputs the number of connections to the ActiveMQ broker.  This number continually grows over time.  After running for a few minutes I see output like this:&lt;/p&gt;


&lt;p&gt;10:17:28,885 INFO  ActiveMQTest - num connections = 159&lt;br/&gt;
10:17:29,885 INFO  ActiveMQTest - num connections = 159&lt;br/&gt;
10:17:30,574 INFO  ActiveMQTest - creating context and sending message&lt;br/&gt;
10:17:30,574 INFO  DefaultCamelContext - Apache Camel 2.1.0-psc-01-00RC1 (CamelContext:camel-160) is starting&lt;br/&gt;
10:17:30,574 INFO  DefaultCamelContext - JMX enabled. Using DefaultManagedLifecycleStrategy.&lt;br/&gt;
10:17:30,744 INFO  DefaultCamelContext - Apache Camel 2.1.0-psc-01-00RC1 (CamelContext:camel-160) started&lt;br/&gt;
10:17:30,753 INFO  ActiveMQTest - consume message = message&lt;br/&gt;
10:17:30,885 INFO  ActiveMQTest - num connections = 160&lt;br/&gt;
10:17:31,885 INFO  ActiveMQTest - num connections = 160&lt;br/&gt;
10:17:32,747 INFO  ActiveMQTest - destroying context&lt;br/&gt;
10:17:32,747 INFO  DefaultCamelContext - Apache Camel 2.1.0-psc-01-00RC1 (CamelContext:camel-160) is stopping&lt;br/&gt;
10:17:32,755 INFO  DefaultInflightRepository - Shutting down with no inflight exchanges.&lt;br/&gt;
10:17:32,755 INFO  DefaultCamelContext - Apache Camel 2.1.0-psc-01-00RC1 (CamelContext:camel-160) stopped&lt;br/&gt;
10:17:32,886 INFO  ActiveMQTest - num connections = 160&lt;br/&gt;
10:17:33,885 INFO  ActiveMQTest - num connections = 160&lt;/p&gt;


&lt;p&gt;Also if I do &quot;netstat -an | grep 61616&quot; I see the number of connections to the broker on TCP port 61616 is continually growing.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu Linux 9.10, Sun JDK 1.6.0_15, Camel 2.1.0-psc-01-00RC1, ActiveMQ 5.3.0-psc-01-00RC1&lt;/p&gt;</environment>
        <key id="12483228">AMQ-2611</key>
            <summary>Stopping camel context with ActiveMQComponent does not close connections to ActiveMQ</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="ariekenb">Aaron Riekenberg</reporter>
                        <labels>
                    </labels>
                <created>Sun, 14 Feb 2010 16:18:47 +0000</created>
                <updated>Wed, 17 Feb 2010 14:21:48 +0000</updated>
                            <resolved>Wed, 17 Feb 2010 14:21:48 +0000</resolved>
                                    <version>5.3.0</version>
                                    <fixVersion>5.3.1</fixVersion>
                    <fixVersion>5.4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12942202" author="ariekenb" created="Sun, 14 Feb 2010 16:19:27 +0000"  >&lt;p&gt;Example test case&lt;/p&gt;</comment>
                            <comment id="12942208" author="ariekenb" created="Sun, 14 Feb 2010 18:07:23 +0000"  >&lt;p&gt;Looking into the code, it looks like by default org.apache.activemq.camel.component.ActiveMQConfiguration.usePooledConnection = true, so ActiveMQConfiguration.createConnectionFactory creates an org.apache.activemq.pool.PooledConnectionFactory.  PooledConnectionFactory needs to have stop() called on it to close underlying connections.  Nothing in camel is doing this when the context is closed.&lt;/p&gt;

&lt;p&gt;One possible workaround is to manually create a PooledConnectionFactory and pass it to ActiveMQComponent.setConnectionFactory.  Then you have to call stop() yourself on the PooledConnectionFactory to close connections when the camel context is stopped.&lt;/p&gt;

&lt;p&gt;This seems to be a bad default.  If by default camel is going to create a PooledConnectionFactory for the user, shouldn&apos;t it clean it up when the context is closed?&lt;/p&gt;</comment>
                            <comment id="12942188" author="davsclaus" created="Mon, 15 Feb 2010 09:37:15 +0000"  >&lt;p&gt;Aaron good findings.&lt;/p&gt;

&lt;p&gt;You could probably try to see if you can patch the AMQ component to be able to stop the connection factory when its stopped.&lt;/p&gt;</comment>
                            <comment id="12942203" author="ariekenb" created="Wed, 17 Feb 2010 03:33:43 +0000"  >&lt;p&gt;Here is a patch against activemq trunk.&lt;/p&gt;

&lt;p&gt;This fixes my test case and passes all unit tests for activemq-camel.&lt;/p&gt;</comment>
                            <comment id="12942225" author="davsclaus" created="Wed, 17 Feb 2010 06:15:12 +0000"  >&lt;p&gt;Aaron thanks for the patch. I have moved the ticket to AMQ as its a bug/issue with AMQ.&lt;/p&gt;</comment>
                            <comment id="12942231" author="dejanb" created="Wed, 17 Feb 2010 14:21:48 +0000"  >&lt;p&gt;Fixed with svn revision 910984. I modified your test and converted it to test case. Thanks for the patch&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461610" name="ActiveMQTest.java" size="2791" author="ariekenb" created="Sun, 14 Feb 2010 16:19:26 +0000"/>
                            <attachment id="12461620" name="camel2469.patch" size="5032" author="ariekenb" created="Wed, 17 Feb 2010 03:33:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>74874</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rqe7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>159920</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>