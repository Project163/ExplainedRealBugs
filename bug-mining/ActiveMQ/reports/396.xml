<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:37:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1805] Persistent message leak when broker run out of disk space</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1805</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;In our environment, we have several ActvieMQ CPP clients sending persistent messages continuously to a ActiveMQ 5.1 broker. In normal condition the broker works fine until it ran out of disk space. At that point the client would receive out of disk space advisory message AFTER sending the message, therefore the message should be removed from broker, however, the message are kept in the memory due to a problem in the DataFileAppender &amp;amp; AsyncDatamanager, when the disk is full, the message is saved in the inflightWrites map but never taken out since the enqueue will fail due to IOException.&lt;/p&gt;

&lt;p&gt;        synchronized (this) {&lt;br/&gt;
            // Find the position where this item will land at.&lt;br/&gt;
            DataFile dataFile = dataManager.allocateLocation(location);&lt;br/&gt;
            if( !sync ) &lt;/p&gt;
{
                inflightWrites.put(new WriteKey(location), write);
            }
&lt;p&gt;            batch = enqueue(dataFile, write);&lt;br/&gt;
        }&lt;/p&gt;

&lt;p&gt;and&lt;/p&gt;

&lt;p&gt;        synchronized (this) &lt;/p&gt;
{
            // Find the position where this item will land at.
            DataFile dataFile = dataManager.allocateLocation(location);
            inflightWrites.put(new WriteKey(location), write);
            batch = enqueue(dataFile, write);
        }</description>
                <environment>&lt;p&gt;ActiveMQ 5.1 (AMQStore w/o SystemUsage configuration)&lt;br/&gt;
Windows XP SP2&lt;br/&gt;
ActiveMQ CPP 2.1.3&lt;/p&gt;</environment>
        <key id="12482239">AMQ-1805</key>
            <summary>Persistent message leak when broker run out of disk space</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="bluefox">Bruce Lee</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Jun 2008 15:50:44 +0000</created>
                <updated>Thu, 19 Jun 2008 16:11:33 +0000</updated>
                            <resolved>Thu, 19 Jun 2008 16:00:34 +0000</resolved>
                                    <version>5.1.0</version>
                                    <fixVersion>5.2.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12939839" author="bluefox" created="Tue, 17 Jun 2008 16:21:31 +0000"  >&lt;p&gt;From the above 5.1 source code, it seems like allocateLocation should actually make sure that there is enough disk space for the particular message. However, it actually only create the File handle without actually allocating any disk space So to fix this problem, we added&lt;/p&gt;

&lt;p&gt;nextWriteFile.closeRandomAccessFile(nextWriteFile.openRandomAccessFile(true));&lt;/p&gt;

&lt;p&gt;in the AsyncDataManager.allocateLocation method to try and pre allocate the disk space. We believe that this will not have much impact on the performance as data file is 32MB default, but please feel free to advice otherwise as this is our first time looking at ActiveMQ source code. &lt;/p&gt;</comment>
                            <comment id="12939825" author="bluefox" created="Tue, 17 Jun 2008 16:28:36 +0000"  >&lt;p&gt;The patch for InactivityMonitor.java  provided by Tom Vijlbrief seems to be missing in ActiveMQ 5.1, which causes a thread leak when the client does not close the connection properly.&lt;/p&gt;</comment>
                            <comment id="12939851" author="rajdavies" created="Thu, 19 Jun 2008 16:00:34 +0000"  >&lt;p&gt;Fixed by SVN revision 669519&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12482206">AMQ-724</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12461177" name="amq-1805.diff" size="877" author="bluefox" created="Tue, 17 Jun 2008 16:21:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84763</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 23 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14bc7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>233300</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>