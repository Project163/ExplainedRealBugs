<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:38:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6482] Possible thread leak ?</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6482</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;We have an activemq broker running for ~ 24 hours, handling ~ 100k topics and up to 8k connections (for ~ 24k consumers).&lt;/p&gt;

&lt;p&gt;Looking at my graph, I see that I get a big increase of threads count happended (in 4 steps, ~ 500 more threads each time) as shown here : &lt;a href=&quot;https://snapshot.raintank.io/dashboard/snapshot/ExUb4pgNYnmBo92JgbZrvJ6fiBm3PNrI&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://snapshot.raintank.io/dashboard/snapshot/ExUb4pgNYnmBo92JgbZrvJ6fiBm3PNrI&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;However, even if the traffic dropped in the night, the thread count never decreased and is still ~ 2500.&lt;/p&gt;

&lt;p&gt;I checked a thread dump and it looks like (full dump attached) :&lt;/p&gt;

&lt;p&gt;```&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;grep  Thread.State thread_dump   |awk &apos;
{ print $2 }
&lt;p&gt;&apos; |sort|uniq -c&lt;br/&gt;
     26 RUNNABLE&lt;br/&gt;
     70 TIMED_WAITING&lt;br/&gt;
   2446 WAITING&lt;br/&gt;
```&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Mhh, so many WAITING threads, let&apos;s check why :&lt;/p&gt;

&lt;p&gt;```&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;grep   &apos;parking to&apos; thread_dump    |cut -d &apos;&amp;gt;&apos; -f 2 |sort |uniq -c&lt;br/&gt;
      1  (a java.util.concurrent.CountDownLatch$Sync)&lt;br/&gt;
   1308  (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)&lt;br/&gt;
   1159  (a java.util.concurrent.locks.ReentrantLock$NonfairSync)&lt;br/&gt;
     41  (a java.util.concurrent.SynchronousQueue$TransferStack)&lt;br/&gt;
```&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;m not a big java expert but seems a bit unexpected behavior to me.&lt;/p&gt;

&lt;p&gt;For various reason (big number of topics etc ) we use custom GC config, here it is :&lt;/p&gt;

&lt;p&gt;```&lt;br/&gt;
ACTIVEMQ_OPTS_MEMORY=&quot;-Xms128M -Xmx10G -Xloggc:/home/log/activemq/gc.log -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseG1GC -XX:InitiatingHeapOccupancyPercent=75 -XX:NewRatio=4&quot;&lt;br/&gt;
```&lt;/p&gt;

&lt;p&gt;Maxence&lt;/p&gt;</description>
                <environment></environment>
        <key id="13015315">AMQ-6482</key>
            <summary>Possible thread leak ?</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="Sp4rKy">Maxence Dunnewind</reporter>
                        <labels>
                            <label>threading</label>
                    </labels>
                <created>Wed, 26 Oct 2016 06:01:17 +0000</created>
                <updated>Fri, 4 Nov 2016 18:10:30 +0000</updated>
                            <resolved>Fri, 4 Nov 2016 17:00:34 +0000</resolved>
                                    <version>5.14.1</version>
                                    <fixVersion>5.15.0</fixVersion>
                    <fixVersion>5.14.2</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15607553" author="sp4rky" created="Wed, 26 Oct 2016 06:05:20 +0000"  >&lt;p&gt;Full thread dump&lt;/p&gt;</comment>
                            <comment id="15609200" author="sp4rky" created="Wed, 26 Oct 2016 18:05:19 +0000"  >&lt;p&gt;This keeps increasing , ~ 400 thread every 4/5 hours. Right now, on the same instance :&lt;/p&gt;

&lt;p&gt;   1873  (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)&lt;br/&gt;
   1613  (a java.util.concurrent.locks.ReentrantLock$NonfairSync)&lt;/p&gt;</comment>
                            <comment id="15630112" author="christopher.l.shannon" created="Wed, 2 Nov 2016 19:13:46 +0000"  >&lt;p&gt;Are new websocket connections being created/destroyed often or do the connections come online and pretty much stay there?  I&apos;m trying to get a better idea if this is something related to a websocket connection not being shutdown cleanly or maybe a deadlock with long running connections, etc.&lt;/p&gt;</comment>
                            <comment id="15630685" author="sp4rky" created="Wed, 2 Nov 2016 22:04:30 +0000"  >&lt;p&gt;New websocket connections are definitively created quiet often. They are created every time a user log in to the website (or throug mobile app) or switch to a new page while being logged in. &lt;/p&gt;

&lt;p&gt;Something (maybe) interesting is that we had a bug in our code which was creating too many topics (~ 100k in a few seconds) by sending messages to lot of these new topics. 95% of them were never read. We fixed it and reduced to ~ 8000 topics (no GC of old destination right now), but the thread leak is still present and seems to grow at same speed than before (from ~ 300 right after start to ~ 1000 in 3 hours), so looks like this is not related to topics/messages. So the only remaining possibility is client side.  Moreover, looking at the graph, it seems that the number of thread increases by &quot;step&quot;. For ex between 7.50 and 8.10 pm (utc+2) it only increase of 100threads,  then in 15 minutes I have a 500 thread bump, then almost stable for 10 minutes, then +400 threads in 5 minutes etc ... It seems that the number of threads increases faster when I have a lot of &quot;outgoing messages&quot;, and slowly when I don&apos;t have much, maybe a hint.&lt;/p&gt;

&lt;p&gt;Though this is a production service, we can accept small downtime (like for a restart, if config update is needed) and I&apos;m available as Sp4rKy on freenode if you want some live debug (baiscally between 9 and 19 utc+2).&lt;/p&gt;</comment>
                            <comment id="15632620" author="christopher.l.shannon" created="Thu, 3 Nov 2016 12:42:47 +0000"  >&lt;p&gt;From what I can tell, the issue seems to be that the Websocket connections are hanging waiting for a response from the client when doing the inactivity check. There are tons of the below blocked threads:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;ActiveMQ InactivityMonitor Worker&quot; #40006 daemon prio=5 os_prio=0 tid=0x00007fc60cfd4800 nid=0x4c92 waiting on condition [0x00007fc4148c7000]
   java.lang.Thread.State: WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait for  &amp;lt;0x000000055a702d70&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
	at org.eclipse.jetty.util.SharedBlockingCallback$Blocker.block(SharedBlockingCallback.java:219)
	at org.eclipse.jetty.websocket.common.BlockingWriteCallback$WriteBlocker.block(BlockingWriteCallback.java:83)
	at org.eclipse.jetty.websocket.common.WebSocketRemoteEndpoint.blockingWrite(WebSocketRemoteEndpoint.java:107)
	at org.eclipse.jetty.websocket.common.WebSocketRemoteEndpoint.sendString(WebSocketRemoteEndpoint.java:387)
	at org.apache.activemq.transport.ws.jetty9.StompSocket.sendToStomp(StompSocket.java:47)
	at org.apache.activemq.transport.stomp.ProtocolConverter.onActiveMQCommand(ProtocolConverter.java:888)
	at org.apache.activemq.transport.ws.AbstractStompSocket.oneway(AbstractStompSocket.java:63)
	at org.apache.activemq.transport.AbstractInactivityMonitor.doOnewaySend(AbstractInactivityMonitor.java:334)
	at org.apache.activemq.transport.AbstractInactivityMonitor.access$800(AbstractInactivityMonitor.java:41)
	at org.apache.activemq.transport.AbstractInactivityMonitor$4.run(AbstractInactivityMonitor.java:200)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There seems to me to be 2 issues here:&lt;/p&gt;

&lt;p&gt;1) Jetty seems to have an issue where it gets stuck and never returns or times out the blocking send.  I found this issue here: &lt;a href=&quot;https://github.com/eclipse/jetty.project/issues/272&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/eclipse/jetty.project/issues/272&lt;/a&gt;&lt;br/&gt;
2) The inactivity monitor is supposed to be doing a one way send anyways but the send is actually a blocking send so it can get stuck waiting for a response. &lt;/p&gt;

&lt;p&gt;I think under the old Jetty 8 websocket stuff we were doing async sends but under Jetty 9 that got switched to sync and it waits for the bytes to transfer.  I think, at least for the inactivity monitor and maybe all calls, we should be doing async sends and not blocking so that the lock can be released.  Or at least have some way to timeout.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;, what do you think about something like this? &lt;a href=&quot;https://github.com/cshannon/activemq/commit/915cc828b928268e18bb50b99247e78e77aa0d51&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cshannon/activemq/commit/915cc828b928268e18bb50b99247e78e77aa0d51&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15634132" author="tabish121" created="Thu, 3 Nov 2016 20:26:03 +0000"  >&lt;p&gt;Seems reasonable that these calls shouldn&apos;t block but we need to at least try and throw an error if the send can&apos;t complete to break the connection, so maybe something like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void sendToStomp(StompFrame command) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            session.getRemote().sendStringByFuture(command.format()).get(30, TimeUnit.SECONDS);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; IOExceptionSupport.create(e);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15636979" author="jira-bot" created="Fri, 4 Nov 2016 16:56:29 +0000"  >&lt;p&gt;Commit 450cabe4ead1fb78eec2e94013d2868a5bf864da in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=450cabe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=450cabe&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6482&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6482&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Adding a timeout for websocket sends to prevent the transport thread&lt;br/&gt;
from getting stuck and blocking.  The default is 30 seconds.&lt;/p&gt;</comment>
                            <comment id="15636994" author="jira-bot" created="Fri, 4 Nov 2016 16:59:55 +0000"  >&lt;p&gt;Commit fdf1537eb8c3bf08668d452f2c816cb28acd8f00 in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=fdf1537&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=fdf1537&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6482&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6482&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Adding a timeout for websocket sends to prevent the transport thread&lt;br/&gt;
from getting stuck and blocking.  The default is 30 seconds.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 450cabe4ead1fb78eec2e94013d2868a5bf864da)&lt;/p&gt;</comment>
                            <comment id="15637208" author="jira-bot" created="Fri, 4 Nov 2016 18:10:10 +0000"  >&lt;p&gt;Commit 937b2acd4628fdbfe8165db5f97225dddab515e7 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=937b2ac&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=937b2ac&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6482&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6482&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Adding websocket send timeout to AMQP over websockets&lt;/p&gt;</comment>
                            <comment id="15637210" author="jira-bot" created="Fri, 4 Nov 2016 18:10:30 +0000"  >&lt;p&gt;Commit e9489a45b382b292ed975331a0dd5233d250ac3f in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e9489a4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e9489a4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6482&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6482&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Adding websocket send timeout to AMQP over websockets&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 937b2acd4628fdbfe8165db5f97225dddab515e7)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13014262">AMQ-6474</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12835269" name="thread_dump" size="4390619" author="Sp4rKy" created="Wed, 26 Oct 2016 06:05:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35egv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>