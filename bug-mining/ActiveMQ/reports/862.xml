<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:45:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2440] stomp+nio leaking file descriptor on client drop</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2440</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;The bug is observed on code checkout from &lt;a href=&quot;https://svn.apache.org/repos/asf/activemq/tags/activemq-5.3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/activemq/tags/activemq-5.3.0&lt;/a&gt;&lt;br/&gt;
A server is initiated with stomp+nio transport on port 61612.&lt;/p&gt;

&lt;p&gt;A client connects. A SelectorWorker is created on SelectorManager:68.&lt;br/&gt;
If the client drops the connection an exception is received at StompNIOTransport:91.&lt;br/&gt;
&quot;java.io.IOException: An existing connection was forcibly closed by the remote host&quot;.&lt;br/&gt;
But selector are not cleaned up. It works with stomp transport. But not with stomp+nio.&lt;/p&gt;

&lt;p&gt;What I see in the end is an increasing number of &quot;connections&quot; if the JVM.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows XP&lt;/p&gt;</environment>
        <key id="12482130">AMQ-2440</key>
            <summary>stomp+nio leaking file descriptor on client drop</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="tuler">Danilo Tuler</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 Oct 2009 13:51:26 +0000</created>
                <updated>Wed, 10 Mar 2010 12:50:50 +0000</updated>
                            <resolved>Wed, 10 Mar 2010 12:50:50 +0000</resolved>
                                    <version>5.3.0</version>
                                    <fixVersion>5.3.1</fixVersion>
                    <fixVersion>5.4.0</fixVersion>
                                    <component>Transport</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12940885" author="tuler" created="Mon, 5 Oct 2009 21:18:42 +0000"  >&lt;p&gt;This is my first shot at fixing it.&lt;/p&gt;

&lt;p&gt;Some of the issues I found:&lt;/p&gt;

&lt;p&gt;1) SelectorWorker calls Selector.open(), but the selector is never ever closed. I&apos;m closing at SelectorManager.onWorkerEmptyEvent. Not sure if that&apos;s the correct spot.&lt;/p&gt;

&lt;p&gt;2) StompNIOTransport.serviceRead was not calling selection.close on IOException. NIOTransport does call selection.close on channel.read == -1 but not on IOException.&lt;/p&gt;

&lt;p&gt;3) DataInputStream not being closed at StompNIOTransport.serviceRead&lt;/p&gt;

&lt;p&gt;I&apos;m still getting some side effects. The exception below happened once on a client disconnect. Seems like a race condition at SelectorWorker.&lt;/p&gt;

&lt;p&gt;Exception in thread &quot;NIO Transport Thread&quot; java.nio.channels.ClosedSelectorException&lt;br/&gt;
	at sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:66)&lt;br/&gt;
	at sun.nio.ch.SelectorImpl.select(SelectorImpl.java:80)&lt;br/&gt;
	at org.apache.activemq.transport.nio.SelectorWorker.run(SelectorWorker.java:76)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;</comment>
                            <comment id="12940894" author="dejanb" created="Tue, 6 Oct 2009 10:15:24 +0000"  >&lt;p&gt;I&apos;m failing to reproduce this problem. Can you provide your testing code (in any language that you have it)? Thanks&lt;/p&gt;</comment>
                            <comment id="12940921" author="tuler" created="Tue, 6 Oct 2009 12:41:51 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Start a server with a single stomp+nio transport. StompDropTestServer.java attached.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Now you need a way to see the TCP ports opened by the server process. netstat will do, but I&apos;m using &quot;Process Explorer&quot; &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; on Windows XP. Choose the process on the list, go to properties page, TCP/IP tab.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;For the client I&apos;m using the gozirra library, which is a java stomp client &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;. I think StompConnection from ActiveMQ would lead to the same issue. But my application already uses gozirra. Create a client, StompDropTestConsumer.java attached.&lt;br/&gt;
No matter if the client calls disconnect or not, the server TCP ports will still be opened when the client terminates (and won&apos;t be reused).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://technet.microsoft.com/en-us/sysinternals/bb896653.aspx&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://technet.microsoft.com/en-us/sysinternals/bb896653.aspx&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://www.germane-software.com/software/Java/Gozirra/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.germane-software.com/software/Java/Gozirra/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12940951" author="tuler" created="Tue, 6 Oct 2009 12:42:48 +0000"  >&lt;p&gt;The client requires gozirra client from &lt;a href=&quot;http://www.germane-software.com/software/Java/Gozirra/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.germane-software.com/software/Java/Gozirra/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12941066" author="tuler" created="Tue, 6 Oct 2009 19:30:14 +0000"  >&lt;p&gt;Another thing that disturbs me is that TcpTransport.closeStreams is never called.&lt;br/&gt;
The only call is commented out at TcpTransport.doStop.&lt;/p&gt;</comment>
                            <comment id="12942330" author="dejanb" created="Wed, 10 Mar 2010 12:50:49 +0000"  >&lt;p&gt;This is now fixed on trunk and 5.3 branch. It&apos;s tested manually using StompLoadTest in activemq-systest subproject, which opens/closes a connection for every send/receive and simulates a real load on the broker. This test should be converted to the real system test, but that&apos;s the case for another issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461362" name="AMQ-2440-1.txt" size="2349" author="tuler" created="Mon, 5 Oct 2009 21:18:42 +0000"/>
                            <attachment id="12461374" name="StompDropTestConsumer.java" size="1184" author="tuler" created="Tue, 6 Oct 2009 12:42:48 +0000"/>
                            <attachment id="12461368" name="StompDropTestServer.java" size="360" author="tuler" created="Tue, 6 Oct 2009 12:42:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>74946</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 37 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rq1r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>159864</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>