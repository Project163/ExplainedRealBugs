<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:44:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-7001] Contention on message properties with amqp jms transfromer and kahadb concurrentStoreAndDispatch</title>
                <link>https://issues.apache.org/jira/browse/AMQ-7001</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Openwire to AMQP&lt;/p&gt;

&lt;p&gt;Send can fail with&#160;ConcurrentModificationException. Stack trace:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
javax.jms.JMSException: java.util.concurrent.ExecutionException: java.util.ConcurrentModificationException
at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:54)
at org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1403)
at org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1436)
at org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1323)
at org.apache.activemq.ActiveMQSession.send(ActiveMQSession.java:1976)
at org.apache.activemq.ActiveMQMessageProducer.send(ActiveMQMessageProducer.java:288)
at org.apache.activemq.ActiveMQMessageProducer.send(ActiveMQMessageProducer.java:223)
at org.apache.activemq.ActiveMQMessageProducerSupport.send(ActiveMQMessageProducerSupport.java:241)
at org.apache.activemq.transport.amqp.interop.OpenWireToAmqpConcurrentStoreAndDispatchTest$2.run(OpenWireToAmqpConcurrentStoreAndDispatchTest.java:158)
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.lang.Throwable: java.util.concurrent.ExecutionException: java.util.ConcurrentModificationException
at java.util.concurrent.FutureTask.report(FutureTask.java:122)
at java.util.concurrent.FutureTask.get(FutureTask.java:192)
at org.apache.activemq.broker.region.Queue.doMessageSend(Queue.java:924)
at org.apache.activemq.broker.region.Queue.send(Queue.java:767)
at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:505)
at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:477)
at org.apache.activemq.broker.jmx.ManagedRegionBroker.send(ManagedRegionBroker.java:293)
at org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:96)
at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:295)
at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:154)
at org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:572)
at org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:768)
at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:330)
at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:194)
at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)
at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:125)
at org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:301)
at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)
at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:233)
at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:215)
... 1 more
Caused by: java.util.ConcurrentModificationException
at java.util.HashMap$HashIterator.nextNode(HashMap.java:1437)
at java.util.HashMap$KeyIterator.next(HashMap.java:1461)
at org.apache.activemq.util.MarshallingSupport.marshalPrimitiveMap(MarshallingSupport.java:61)
at org.apache.activemq.command.Message.beforeMarshall(Message.java:261)
at org.apache.activemq.openwire.v11.MessageMarshaller.looseMarshal(MessageMarshaller.java:281)
at org.apache.activemq.openwire.v11.ActiveMQMessageMarshaller.looseMarshal(ActiveMQMessageMarshaller.java:111)
at org.apache.activemq.openwire.v11.ActiveMQBytesMessageMarshaller.looseMarshal(ActiveMQBytesMessageMarshaller.java:111)
at org.apache.activemq.openwire.OpenWireFormat.marshal(OpenWireFormat.java:162)
at org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore.addMessage(KahaDBStore.java:537)
at org.apache.activemq.store.kahadb.KahaDBStore$StoreQueueTask.run(KahaDBStore.java:1513)
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
... 1 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13168345">AMQ-7001</key>
            <summary>Contention on message properties with amqp jms transfromer and kahadb concurrentStoreAndDispatch</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="gtully">Gary Tully</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Jun 2018 13:12:08 +0000</created>
                <updated>Wed, 1 Aug 2018 22:34:51 +0000</updated>
                            <resolved>Wed, 1 Aug 2018 22:15:21 +0000</resolved>
                                    <version>5.15.0</version>
                                    <fixVersion>5.15.5</fixVersion>
                                    <component>AMQP</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16523800" author="jira-bot" created="Tue, 26 Jun 2018 14:26:12 +0000"  >&lt;p&gt;Commit ed8860000f6d9c0dcd71206309ba27a34db2c606 in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=ed88600&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=ed88600&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7001&quot; title=&quot;Contention on message properties with amqp jms transfromer and kahadb concurrentStoreAndDispatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7001&quot;&gt;&lt;del&gt;AMQ-7001&lt;/del&gt;&lt;/a&gt; - amqp jms transformer - always copy message if properties need to be modified, fix and long running test that is disabled&lt;/p&gt;</comment>
                            <comment id="16523809" author="jira-bot" created="Tue, 26 Jun 2018 14:33:46 +0000"  >&lt;p&gt;Commit 19cb5d7c8b11123b884eb23b0f0624d90fcb205c in activemq&apos;s branch refs/heads/activemq-5.15.x from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=19cb5d7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=19cb5d7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7001&quot; title=&quot;Contention on message properties with amqp jms transfromer and kahadb concurrentStoreAndDispatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7001&quot;&gt;&lt;del&gt;AMQ-7001&lt;/del&gt;&lt;/a&gt; - amqp jms transformer - always copy message if properties need to be modified, fix and long running test that is disabled&lt;/p&gt;

&lt;p&gt;(cherry picked from commit ed8860000f6d9c0dcd71206309ba27a34db2c606)&lt;/p&gt;</comment>
                            <comment id="16531878" author="jira-bot" created="Tue, 3 Jul 2018 20:18:49 +0000"  >&lt;p&gt;Commit 83514ef799cb71c3ed1ee1f81553d87383f2cd42 in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=83514ef&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=83514ef&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7001&quot; title=&quot;Contention on message properties with amqp jms transfromer and kahadb concurrentStoreAndDispatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7001&quot;&gt;&lt;del&gt;AMQ-7001&lt;/del&gt;&lt;/a&gt; - ensure cursor pending cached id list is pruned of futures that end in an exception, fix and test&lt;/p&gt;</comment>
                            <comment id="16565637" author="tabish121" created="Wed, 1 Aug 2018 17:05:57 +0000"  >&lt;p&gt;The change here needs to be reverted and an alternate solution found.&#160; The current change causes message bodies to be garbled for certain types and the conversion back to AMQP fails leads to dropped messages for some AMQP receivers&lt;/p&gt;</comment>
                            <comment id="16566066" author="jira-bot" created="Wed, 1 Aug 2018 22:14:14 +0000"  >&lt;p&gt;Commit 9ec6ee43b146736fdf635090b2829a0c621a00f3 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=9ec6ee4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=9ec6ee4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7001&quot; title=&quot;Contention on message properties with amqp jms transfromer and kahadb concurrentStoreAndDispatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7001&quot;&gt;&lt;del&gt;AMQ-7001&lt;/del&gt;&lt;/a&gt; Resolve issues with encode failures on copied messages&lt;/p&gt;

&lt;p&gt;Ensure that messages are copied to avoid contention on message content&lt;br/&gt;
when concurrent store and dispatch is enabled and better handle the AMQP&lt;br/&gt;
message type value.  Adds an AMQP Encoder for UTF8Buffer to encode down&lt;br/&gt;
to AMQP String encodings to allow for encoded OpenWire messages such as&lt;br/&gt;
MapMessage which can contain UTF8Buffer instances for String keys and&lt;br/&gt;
values.&lt;/p&gt;</comment>
                            <comment id="16566068" author="jira-bot" created="Wed, 1 Aug 2018 22:14:56 +0000"  >&lt;p&gt;Commit ad0ae74f3b432f96aba17957bbb6dca0e0bdf8f5 in activemq&apos;s branch refs/heads/activemq-5.15.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=ad0ae74&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=ad0ae74&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7001&quot; title=&quot;Contention on message properties with amqp jms transfromer and kahadb concurrentStoreAndDispatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7001&quot;&gt;&lt;del&gt;AMQ-7001&lt;/del&gt;&lt;/a&gt; Resolve issues with encode failures on copied messages&lt;/p&gt;

&lt;p&gt;Ensure that messages are copied to avoid contention on message content&lt;br/&gt;
when concurrent store and dispatch is enabled and better handle the AMQP&lt;br/&gt;
message type value.  Adds an AMQP Encoder for UTF8Buffer to encode down&lt;br/&gt;
to AMQP String encodings to allow for encoded OpenWire messages such as&lt;br/&gt;
MapMessage which can contain UTF8Buffer instances for String keys and&lt;br/&gt;
values.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 9ec6ee43b146736fdf635090b2829a0c621a00f3)&lt;/p&gt;</comment>
                            <comment id="16566102" author="jira-bot" created="Wed, 1 Aug 2018 22:34:30 +0000"  >&lt;p&gt;Commit ba7934e91adf1c068db7107a6353b867e276affb in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=ba7934e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=ba7934e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7001&quot; title=&quot;Contention on message properties with amqp jms transfromer and kahadb concurrentStoreAndDispatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7001&quot;&gt;&lt;del&gt;AMQ-7001&lt;/del&gt;&lt;/a&gt; Remove now unnecessary check for UTF8Buffer type&lt;/p&gt;

&lt;p&gt;Remove the now unneeded checks for UTF8Buffer on the outbound converter&lt;br/&gt;
as the Codec now can encode those to the correct string AMQP types&lt;br/&gt;
without need for any help.&lt;/p&gt;</comment>
                            <comment id="16566103" author="jira-bot" created="Wed, 1 Aug 2018 22:34:51 +0000"  >&lt;p&gt;Commit 77e584f05700dd6b2f7cf1eb3f63423b6eaa6393 in activemq&apos;s branch refs/heads/activemq-5.15.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=77e584f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=77e584f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7001&quot; title=&quot;Contention on message properties with amqp jms transfromer and kahadb concurrentStoreAndDispatch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7001&quot;&gt;&lt;del&gt;AMQ-7001&lt;/del&gt;&lt;/a&gt; Remove now unnecessary check for UTF8Buffer type&lt;/p&gt;

&lt;p&gt;Remove the now unneeded checks for UTF8Buffer on the outbound converter&lt;br/&gt;
as the Codec now can encode those to the correct string AMQP types&lt;br/&gt;
without need for any help.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit ba7934e91adf1c068db7107a6353b867e276affb)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 15 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3v8wn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>