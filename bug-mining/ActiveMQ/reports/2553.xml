<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:10:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5599] Broker start thread hangs forever in async mode when startup of PersistenceAdapter is very fast</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5599</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;We encountered a situation where the startup of our broker fails sometimes. We investigated this and have seen that this is caused by a race condition.&lt;br/&gt;
When the BrokerService is configured to be async, the starting of the broker will hang when the starting of the PersistenceAdapter is faster than expected.&lt;/p&gt;

&lt;p&gt;The ActiveMQ code will first start the persistence adapter, and then start the broker. When startup is configured to be &apos;async&apos;, these actions will happen async (in separate threads). Since these calls are async, we can not garuantee the order in which they will be finished. Although the ActiveMQ code now relies on the fact that the starting of the persistence adapter takes longer, and it waits in the starting of the broker for the starting of the persistence adapter to finish. When the starting of the persistence adapter already finished before the starting of the broker starts waiting for it, it will wait forever (and thus the broker cannot get started).&lt;/p&gt;

&lt;p&gt;In the following snippet from org.apache.activemq.broker.BrokerService this becomes clear:&lt;/p&gt;

&lt;p&gt;&apos;startPersistenceAdapter&apos; is fast and already notifies: persistenceAdapterLock.notifyAll();. &lt;br/&gt;
&apos;startBroker&apos; will wait for notification but no one will ever notify it again: persistenceAdapterLock.wait();&lt;/p&gt;

&lt;p&gt;&amp;#8212;&lt;/p&gt;

&lt;p&gt;startPersistenceAdapter(startAsync);&lt;br/&gt;
startBroker(startAsync);&lt;/p&gt;

&lt;p&gt;private void startPersistenceAdapter(boolean async) throws Exception {&lt;br/&gt;
    if (async) {&lt;br/&gt;
        new Thread(&quot;Persistence Adapter Starting Thread&quot;) {&lt;br/&gt;
            @Override&lt;br/&gt;
            public void run() {&lt;br/&gt;
                try &lt;/p&gt;
{
                    doStartPersistenceAdapter();
                }
&lt;p&gt; catch (Throwable e) &lt;/p&gt;
{
                    startException = e;
                }
&lt;p&gt; finally {&lt;br/&gt;
                    synchronized (persistenceAdapterLock) &lt;/p&gt;
{
                        persistenceAdapterLock.notifyAll();
                    }
&lt;p&gt;                }&lt;br/&gt;
            }&lt;br/&gt;
        }.start();&lt;br/&gt;
    } else &lt;/p&gt;
{
        doStartPersistenceAdapter();
    }
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;private void startBroker(boolean async) throws Exception {&lt;br/&gt;
    if (async) {&lt;br/&gt;
        new Thread(&quot;Broker Starting Thread&quot;) {&lt;br/&gt;
            @Override&lt;br/&gt;
            public void run() {&lt;br/&gt;
                try {&lt;br/&gt;
                    synchronized (persistenceAdapterLock) &lt;/p&gt;
{
                        persistenceAdapterLock.wait();
                    }
&lt;p&gt;                    doStartBroker();&lt;br/&gt;
                } catch (Throwable t) &lt;/p&gt;
{
                    startException = t;
                }
&lt;p&gt;            }&lt;br/&gt;
        }.start();&lt;br/&gt;
    } else &lt;/p&gt;
{
        doStartBroker();
    }
&lt;p&gt;}&lt;/p&gt;</description>
                <environment></environment>
        <key id="12776170">AMQ-5599</key>
            <summary>Broker start thread hangs forever in async mode when startup of PersistenceAdapter is very fast</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="wardvijf">Ward V</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Feb 2015 14:24:56 +0000</created>
                <updated>Tue, 2 Jun 2015 15:38:12 +0000</updated>
                            <resolved>Tue, 2 Jun 2015 15:38:12 +0000</resolved>
                                    <version>5.10.0</version>
                                    <fixVersion>5.12.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                        <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 39 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i25t7j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>