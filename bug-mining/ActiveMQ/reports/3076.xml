<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:41:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6697] Aborting a STOMP 1.1 transaction after ACK/NACK leads to invalid state</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6697</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Reproducing the problem:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Receive a message via STOMP (&lt;ins&gt;EDIT: on a subscription with ack:client-individual&lt;/ins&gt;)&lt;/li&gt;
	&lt;li&gt;Start a transaction&lt;/li&gt;
	&lt;li&gt;ACK &lt;del&gt;(or NACK)&lt;/del&gt; the message within the transaction&lt;/li&gt;
	&lt;li&gt;Abort the transaction&lt;/li&gt;
	&lt;li&gt;ACK (or NACK) the message&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Expected behaviour:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The message is according to step #5 either ACKed or NACKed.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Observed behaviour:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The message is neither ACKed nor NACKed, but stays in unacknowledged state&lt;/li&gt;
	&lt;li&gt;An exception is raised:&lt;br/&gt;
 org.apache.activemq.transport.stomp.ProtocolException: Unexpected ACK received for message-id &lt;span class=&quot;error&quot;&gt;&amp;#91;ID:(...)&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.activemq.transport.stomp.ProtocolConverter.onStompAck(ProtocolConverter.java:475)&lt;br/&gt;
        at org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommand(ProtocolConverter.java:250)&lt;br/&gt;
        at org.apache.activemq.transport.stomp.StompTransportFilter.onCommand(StompTransportFilter.java:85)&lt;br/&gt;
        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)&lt;br/&gt;
        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:233)&lt;br/&gt;
        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:215)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:745)&lt;/li&gt;
	&lt;li&gt;an ERROR message is sent to the client&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;As far as I can tell this is caused by code in both onStompAck() and onStompNack():&lt;br/&gt;
&lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=blob;f=activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/ProtocolConverter.java;h=b25860bf6895240c33a8643b6fcc731af126d32e;hb=refs/heads/master#l440&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=blob;f=activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/ProtocolConverter.java;h=b25860bf6895240c33a8643b6fcc731af126d32e;hb=refs/heads/master#l440&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;With a STOMP 1.1 ACK/NACK, ackId == null, so the message entry is taken out of this.pedingAcks (sic!).&lt;br/&gt;
When the transaction is aborted the message entry is then not put back into this.pedingAcks, so any subsequent ACK/NACK will find pendingAck==null, therefore acked==false, raising an exception.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13076830">AMQ-6697</key>
            <summary>Aborting a STOMP 1.1 transaction after ACK/NACK leads to invalid state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="mgerstel">Markus Gerstel</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Jun 2017 12:22:49 +0000</created>
                <updated>Mon, 5 Jun 2017 07:05:48 +0000</updated>
                            <resolved>Fri, 2 Jun 2017 18:23:30 +0000</resolved>
                                    <version>5.14.5</version>
                                    <fixVersion>5.15.0</fixVersion>
                    <fixVersion>5.14.6</fixVersion>
                                    <component>STOMP</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16034908" author="tabish121" created="Fri, 2 Jun 2017 15:47:48 +0000"  >&lt;p&gt;This test seems to indicate that all is working as designed.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test(timeout = 60000)
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testTransactionRollback() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        MessageProducer producer = session.createProducer(queue);
        producer.send(session.createTextMessage(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello&quot;&lt;/span&gt;));
        producer.close();

        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; frame = &lt;span class=&quot;code-quote&quot;&gt;&quot;STOMP\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;login:system\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;passcode:manager\n&quot;&lt;/span&gt; +
            &lt;span class=&quot;code-quote&quot;&gt;&quot;accept-version:1.1\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;host:localhost\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;client-id:test\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;\n&quot;&lt;/span&gt; + Stomp.NULL;
        stompConnection.sendFrame(frame);

        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; f = stompConnection.receiveFrame();
        assertTrue(f.startsWith(&lt;span class=&quot;code-quote&quot;&gt;&quot;CONNECTED&quot;&lt;/span&gt;));

        QueueViewMBean queueView = getProxyToQueue(getQueueName());
        assertEquals(1, queueView.getQueueSize());

        frame = &lt;span class=&quot;code-quote&quot;&gt;&quot;BEGIN\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;transaction: tx1\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;\n\n&quot;&lt;/span&gt; + Stomp.NULL;
        stompConnection.sendFrame(frame);

        frame = &lt;span class=&quot;code-quote&quot;&gt;&quot;SUBSCRIBE\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;destination:/queue/&quot;&lt;/span&gt; + getQueueName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;\n&quot;&lt;/span&gt; +
            &lt;span class=&quot;code-quote&quot;&gt;&quot;id:12345\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;ack:client\n\n&quot;&lt;/span&gt; + Stomp.NULL;
        stompConnection.sendFrame(frame);

        StompFrame received = stompConnection.receive();
        assertTrue(received.getAction().equals(&lt;span class=&quot;code-quote&quot;&gt;&quot;MESSAGE&quot;&lt;/span&gt;));

        &lt;span class=&quot;code-comment&quot;&gt;// ack it
&lt;/span&gt;        frame = &lt;span class=&quot;code-quote&quot;&gt;&quot;ACK\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;transaction: tx1\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;subscription:12345\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;message-id:&quot;&lt;/span&gt; +
                received.getHeaders().get(&lt;span class=&quot;code-quote&quot;&gt;&quot;message-id&quot;&lt;/span&gt;) + &lt;span class=&quot;code-quote&quot;&gt;&quot;\n\n&quot;&lt;/span&gt; + Stomp.NULL;
        stompConnection.sendFrame(frame);

        &lt;span class=&quot;code-comment&quot;&gt;// rollback first message
&lt;/span&gt;        frame = &lt;span class=&quot;code-quote&quot;&gt;&quot;ABORT\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;transaction: tx1\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;\n\n&quot;&lt;/span&gt; + Stomp.NULL;
        stompConnection.sendFrame(frame);

        assertEquals(1, queueView.getQueueSize());

        &lt;span class=&quot;code-comment&quot;&gt;// ack it
&lt;/span&gt;        frame = &lt;span class=&quot;code-quote&quot;&gt;&quot;ACK\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;subscription:12345\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;message-id:&quot;&lt;/span&gt; +
                received.getHeaders().get(&lt;span class=&quot;code-quote&quot;&gt;&quot;message-id&quot;&lt;/span&gt;) + &lt;span class=&quot;code-quote&quot;&gt;&quot;\n\n&quot;&lt;/span&gt; + Stomp.NULL;
        stompConnection.sendFrame(frame);

        assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;Message not ack&apos;d&quot;&lt;/span&gt;, Wait.waitFor(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Wait.Condition() {

            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isSatisified() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; queueView.getQueueSize() == 0;
            }
        }));

        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; unsub = &lt;span class=&quot;code-quote&quot;&gt;&quot;UNSUBSCRIBE\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;destination:/queue/&quot;&lt;/span&gt; + getQueueName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;\n&quot;&lt;/span&gt; +
            &lt;span class=&quot;code-quote&quot;&gt;&quot;receipt:1\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;id:12345\n\n&quot;&lt;/span&gt; + Stomp.NULL;
        stompConnection.sendFrame(unsub);

        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; receipt = stompConnection.receiveFrame();
        assertTrue(receipt.contains(&lt;span class=&quot;code-quote&quot;&gt;&quot;RECEIPT&quot;&lt;/span&gt;));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The first thing I see wrong here is that you cannot NACK a message in a TX so that will definitely fail if you try and do it a second time as you&apos;ve already NACK&apos;d the message.  My guess is that your first ACK is not including the TXID in the ACK an thereby just ACK&apos;ing the message outside the TX.&lt;/p&gt;</comment>
                            <comment id="16034910" author="jira-bot" created="Fri, 2 Jun 2017 15:50:32 +0000"  >&lt;p&gt;Commit bd8661796b190ef605458cdd7a0d90d9af4f51a0 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=bd86617&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=bd86617&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6697&quot; title=&quot;Aborting a STOMP 1.1 transaction after ACK/NACK leads to invalid state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6697&quot;&gt;&lt;del&gt;AMQ-6697&lt;/del&gt;&lt;/a&gt; Adds a test to show that the described case works&lt;/p&gt;

&lt;p&gt;Correctly ACK inside a TX and then Abort and then ACK again outside a TX&lt;br/&gt;
to show that the broker will then mark the message as consumed.&lt;/p&gt;</comment>
                            <comment id="16034952" author="mgerstel" created="Fri, 2 Jun 2017 16:04:00 +0000"  >&lt;p&gt;snipped the TCP traffic:&lt;/p&gt;

&lt;p&gt; =&amp;gt; STOMP&lt;br/&gt;
 =&amp;gt; accept-version:1.1&lt;br/&gt;
 =&amp;gt; login:admin&lt;br/&gt;
 =&amp;gt; passcode:password&lt;br/&gt;
 =&amp;gt; &lt;br/&gt;
&amp;lt;=  CONNECTED&lt;br/&gt;
&amp;lt;=  server:ActiveMQ/5.14.5&lt;br/&gt;
&amp;lt;=  heart-beat:0,0&lt;br/&gt;
&amp;lt;=  session:ID:internal.ac.uk-46456-1496419320010-3:1&lt;br/&gt;
&amp;lt;=  version:1.1&lt;br/&gt;
&amp;lt;=  &lt;br/&gt;
&amp;lt;=  &lt;br/&gt;
 =&amp;gt; SEND&lt;br/&gt;
 =&amp;gt; content-length:26&lt;br/&gt;
 =&amp;gt; destination:/queue/some.queue&lt;br/&gt;
 =&amp;gt; &lt;br/&gt;
 =&amp;gt; 2017-06-02 17:02:15.192632SUBSCRIBE&lt;br/&gt;
 =&amp;gt; ack:client-individual&lt;br/&gt;
 =&amp;gt; destination:/queue/some.queue&lt;br/&gt;
 =&amp;gt; id:1&lt;br/&gt;
 =&amp;gt; &lt;br/&gt;
&amp;lt;=  MESSAGE&lt;br/&gt;
&amp;lt;=  content-length:26&lt;br/&gt;
&amp;lt;=  expires:0&lt;br/&gt;
&amp;lt;=  destination:/queue/some.queue&lt;br/&gt;
&amp;lt;=  subscription:1&lt;br/&gt;
&amp;lt;=  priority:4&lt;br/&gt;
&amp;lt;=  message-id:ID\cinternal.ac.uk-46456-1496419320010-3\c1\c-1\c1\c1&lt;br/&gt;
&amp;lt;=  timestamp:1496419335195&lt;br/&gt;
&amp;lt;=  &lt;br/&gt;
&amp;lt;=  2017-06-02 17:02:15.192632&lt;br/&gt;
 =&amp;gt; BEGIN&lt;br/&gt;
 =&amp;gt; transaction:1&lt;br/&gt;
 =&amp;gt; &lt;br/&gt;
 =&amp;gt; ACK&lt;br/&gt;
 =&amp;gt; message-id:ID\cinternal.ac.uk-46456-1496419320010-3\c1\c-1\c1\c1&lt;br/&gt;
 =&amp;gt; subscription:1&lt;br/&gt;
 =&amp;gt; transaction:1&lt;br/&gt;
 =&amp;gt; &lt;br/&gt;
 =&amp;gt; ABORT&lt;br/&gt;
 =&amp;gt; transaction:1&lt;br/&gt;
 =&amp;gt; &lt;br/&gt;
 =&amp;gt; ACK&lt;br/&gt;
 =&amp;gt; message-id:ID\cinternal.ac.uk-46456-1496419320010-3\c1\c-1\c1\c1&lt;br/&gt;
 =&amp;gt; subscription:1&lt;br/&gt;
 =&amp;gt; &lt;br/&gt;
&amp;lt;=  ERROR&lt;br/&gt;
&amp;lt;=  content-type:text/plain&lt;br/&gt;
&amp;lt;=  message:Unexpected ACK received for message-id &lt;span class=&quot;error&quot;&gt;&amp;#91;ID\cinternal.ac.uk-46456-1496419320010-3\c1\c-1\c1\c1&amp;#93;&lt;/span&gt;&lt;br/&gt;
&amp;lt;=  &lt;br/&gt;
&amp;lt;=  org.apache.activemq.transport.stomp.ProtocolException: Unexpected ACK received for message-id &lt;span class=&quot;error&quot;&gt;&amp;#91;ID:internal.ac.uk-46456-1496419320010-3:1:-1:1:1&amp;#93;&lt;/span&gt;&lt;br/&gt;
&amp;lt;=  	at org.apache.activemq.transport.stomp.ProtocolConverter.onStompAck(ProtocolConverter.java:475)&lt;br/&gt;
&amp;lt;=  	at org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommand(ProtocolConverter.java:250)&lt;br/&gt;
&amp;lt;=  	at org.apache.activemq.transport.stomp.StompTransportFilter.onCommand(StompTransportFilter.java:85)&lt;br/&gt;
&amp;lt;=  	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)&lt;br/&gt;
&amp;lt;=  	at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:233)&lt;br/&gt;
&amp;lt;=  	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:215)&lt;br/&gt;
&amp;lt;=  	at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
&amp;lt;=  &lt;br/&gt;
 =&amp;gt; &lt;/p&gt;</comment>
                            <comment id="16034955" author="mgerstel" created="Fri, 2 Jun 2017 16:06:44 +0000"  >&lt;p&gt;According to the spec both ACK and NACK can be used in transactions, so I wonder why you think otherwise. &lt;a href=&quot;http://stomp.github.io/stomp-specification-1.1.html#NACK&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stomp.github.io/stomp-specification-1.1.html#NACK&lt;/a&gt;&lt;br/&gt;
Not relevant to the problem at hand though.&lt;/p&gt;</comment>
                            <comment id="16034972" author="tabish121" created="Fri, 2 Jun 2017 16:16:07 +0000"  >&lt;p&gt;Yes, it can be optionally, I should have been more clear, it can&apos;t be used in a TX in ActiveMQ&lt;/p&gt;</comment>
                            <comment id="16034976" author="tabish121" created="Fri, 2 Jun 2017 16:18:37 +0000"  >&lt;p&gt;You will need to create a unit test that shows an issue, testing on the broker shows it works as expected.  I can think of a couple client&apos;s that would have issues if it didn&apos;t as they rely on this.  &lt;/p&gt;</comment>
                            <comment id="16034989" author="mgerstel" created="Fri, 2 Jun 2017 16:23:32 +0000"  >&lt;p&gt;Working on this now.&lt;/p&gt;</comment>
                            <comment id="16035010" author="mgerstel" created="Fri, 2 Jun 2017 16:36:05 +0000"  >&lt;p&gt;Got it.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/Stomp11Test.java b/activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/Stomp11Test.java
index f61c899..f4ce712 100644
--- a/activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/Stomp11Test.java
+++ b/activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/Stomp11Test.java
@@ -1150,7 +1150,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Stomp11Test &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; StompTestSupport {
         stompConnection.sendFrame(frame);
 
         frame = &lt;span class=&quot;code-quote&quot;&gt;&quot;SUBSCRIBE\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;destination:/queue/&quot;&lt;/span&gt; + getQueueName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;\n&quot;&lt;/span&gt; +
-            &lt;span class=&quot;code-quote&quot;&gt;&quot;id:12345\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;ack:client\n\n&quot;&lt;/span&gt; + Stomp.NULL;
+            &lt;span class=&quot;code-quote&quot;&gt;&quot;id:12345\n&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;ack:client-individual\n\n&quot;&lt;/span&gt; + Stomp.NULL;
         stompConnection.sendFrame(frame);
 
         StompFrame received = stompConnection.receive();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;leads to&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Tests run: 28, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 90.347 sec &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.activemq.transport.stomp.Stomp11NIOSSLTest&lt;br/&gt;
testTransactionRollbackAllowsSecondAckOutsideTX(org.apache.activemq.transport.stomp.Stomp11NIOSSLTest)  Time elapsed: 30.193 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!&lt;br/&gt;
java.lang.AssertionError: Message not ack&apos;d&lt;br/&gt;
	at org.junit.Assert.fail(Assert.java:88)&lt;br/&gt;
	at org.junit.Assert.assertTrue(Assert.java:41)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.Stomp11Test.testTransactionRollbackAllowsSecondAckOutsideTX(Stomp11Test.java:1175)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:498)&lt;br/&gt;
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)&lt;br/&gt;
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)&lt;br/&gt;
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)&lt;br/&gt;
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)&lt;br/&gt;
	at org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:298)&lt;br/&gt;
	at org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:292)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="16035011" author="mgerstel" created="Fri, 2 Jun 2017 16:37:46 +0000"  >&lt;p&gt;thanks for your clarification regarding NACK+TX&lt;/p&gt;</comment>
                            <comment id="16035179" author="jira-bot" created="Fri, 2 Jun 2017 18:19:57 +0000"  >&lt;p&gt;Commit e83bb6dc38ed793ead919e5d7d6d9146816c66a5 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e83bb6d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e83bb6d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6697&quot; title=&quot;Aborting a STOMP 1.1 transaction after ACK/NACK leads to invalid state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6697&quot;&gt;&lt;del&gt;AMQ-6697&lt;/del&gt;&lt;/a&gt; Preserve dispatched state on client-individual tx ack&lt;/p&gt;

&lt;p&gt;Need to preserve the messages in the dispatched list when a&lt;br/&gt;
client-individual ack comes in so that on abort the state remains&lt;br/&gt;
dispatched and the message can still be ack&apos;d&lt;/p&gt;</comment>
                            <comment id="16035181" author="jira-bot" created="Fri, 2 Jun 2017 18:21:02 +0000"  >&lt;p&gt;Commit 8417ce537b2cb96965827ebfb793f31814ba1ddd in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=8417ce5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=8417ce5&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6697&quot; title=&quot;Aborting a STOMP 1.1 transaction after ACK/NACK leads to invalid state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6697&quot;&gt;&lt;del&gt;AMQ-6697&lt;/del&gt;&lt;/a&gt; Make the MBean explicitly final for java 7 support&lt;/p&gt;
</comment>
                            <comment id="16035183" author="jira-bot" created="Fri, 2 Jun 2017 18:22:16 +0000"  >&lt;p&gt;Commit 1c141eae409f87f5a2d8ffe1a5d8821882a614a0 in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1c141ea&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1c141ea&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6697&quot; title=&quot;Aborting a STOMP 1.1 transaction after ACK/NACK leads to invalid state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6697&quot;&gt;&lt;del&gt;AMQ-6697&lt;/del&gt;&lt;/a&gt; Adds a test to show that the described case works&lt;/p&gt;

&lt;p&gt;Correctly ACK inside a TX and then Abort and then ACK again outside a TX&lt;br/&gt;
to show that the broker will then mark the message as consumed.&lt;br/&gt;
(cherry picked from commit bd8661796b190ef605458cdd7a0d90d9af4f51a0)&lt;/p&gt;</comment>
                            <comment id="16035184" author="jira-bot" created="Fri, 2 Jun 2017 18:22:22 +0000"  >&lt;p&gt;Commit 0be8b63fde120aff68248cf0b10869c83ae7d21c in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=0be8b63&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=0be8b63&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6697&quot; title=&quot;Aborting a STOMP 1.1 transaction after ACK/NACK leads to invalid state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6697&quot;&gt;&lt;del&gt;AMQ-6697&lt;/del&gt;&lt;/a&gt; Preserve dispatched state on client-individual tx ack&lt;/p&gt;

&lt;p&gt;Need to preserve the messages in the dispatched list when a&lt;br/&gt;
client-individual ack comes in so that on abort the state remains&lt;br/&gt;
dispatched and the message can still be ack&apos;d&lt;br/&gt;
(cherry picked from commit e83bb6dc38ed793ead919e5d7d6d9146816c66a5)&lt;/p&gt;</comment>
                            <comment id="16035185" author="jira-bot" created="Fri, 2 Jun 2017 18:22:28 +0000"  >&lt;p&gt;Commit e38ac94a27347c89dddcd30c7a3e6063a69308dd in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e38ac94&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e38ac94&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6697&quot; title=&quot;Aborting a STOMP 1.1 transaction after ACK/NACK leads to invalid state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6697&quot;&gt;&lt;del&gt;AMQ-6697&lt;/del&gt;&lt;/a&gt; Make the MBean explicitly final for java 7 support&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 8417ce537b2cb96965827ebfb793f31814ba1ddd)&lt;/p&gt;</comment>
                            <comment id="16035188" author="tabish121" created="Fri, 2 Jun 2017 18:23:30 +0000"  >&lt;p&gt;Fixed the individual ack case to not remove the dispatched message if it was in a TX when it was ack&apos;d to preserve state on TX abort &lt;/p&gt;</comment>
                            <comment id="16036616" author="mgerstel" created="Mon, 5 Jun 2017 07:05:48 +0000"  >&lt;p&gt;Confirmed that this fixes my problems. Thank you very much &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 24 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ft07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>