<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:41:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6847] Immediate poison ACK after move from DLQ leads to message loss</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6847</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;&lt;b&gt;Setup&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;setMaximumRedeliveries(0)&lt;/li&gt;
	&lt;li&gt;Throw RuntimeException (Poison ACK) in consumer directly after receiving message&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Scenario&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Move message from DLQ to original input queue (either web console or JMX retryMessages)&lt;/li&gt;
	&lt;li&gt;Processing of message fails again directly&lt;/li&gt;
	&lt;li&gt;The message is considered to be still on the DLQ on the rejection and ActiveMQ logs &quot;Not adding duplicate to DLQ&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Introducing a delay before throwing the exception in the client will get around the issue.&lt;/p&gt;

&lt;p&gt;I initially noticed the issue when using an AMQP reject (Apache Qpid Proton) after which I reproduced similar conditions (instant poison ACK) it with the JMS client. The attached Java app will reproduce the issue on 5.14.5 and 5.15.2.&lt;/p&gt;

&lt;p&gt;Might be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5752&quot; title=&quot;Move and copy message does not work in web console&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5752&quot;&gt;&lt;del&gt;AMQ-5752&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;2017-10-24 13:38:11,275 | DEBUG | Not adding duplicate to DLQ: ID:xxx-32848-1508845049112-6:1:1:1:1, dest: queue://TEST | org.apache.activemq.broker.region.policy.AbstractDeadLetterStrategy | ActiveMQ Transport: tcp:///127.0.0.1:36360@61616&lt;/p&gt;</description>
                <environment></environment>
        <key id="13111681">AMQ-6847</key>
            <summary>Immediate poison ACK after move from DLQ leads to message loss</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="alvinkwekel@gmail.com">Alvin Kwekel</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 Oct 2017 12:59:13 +0000</created>
                <updated>Tue, 19 Dec 2017 15:21:20 +0000</updated>
                            <resolved>Fri, 27 Oct 2017 10:42:09 +0000</resolved>
                                    <version>5.14.5</version>
                    <version>5.15.2</version>
                                    <fixVersion>5.14.6</fixVersion>
                    <fixVersion>5.15.3</fixVersion>
                    <fixVersion>5.16.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16220724" author="gtully" created="Thu, 26 Oct 2017 16:27:13 +0000"  >&lt;p&gt;it seems the retry operation will need to lock down dispatch to the DLQ till it completes. This case shows that it can accept a message while an ack (and rollback of the audit) is pending.&lt;/p&gt;</comment>
                            <comment id="16222141" author="jira-bot" created="Fri, 27 Oct 2017 10:40:24 +0000"  >&lt;p&gt;Commit 2ea5d1420bbbf90bd151e19a75e6ca33c773f1f4 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=2ea5d14&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=2ea5d14&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6847&quot; title=&quot;Immediate poison ACK after move from DLQ leads to message loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6847&quot;&gt;&lt;del&gt;AMQ-6847&lt;/del&gt;&lt;/a&gt; pause dispatch for message move to avoid redelivery with pending ack/remove/audit rollback&lt;/p&gt;</comment>
                            <comment id="16222144" author="gtully" created="Fri, 27 Oct 2017 10:42:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alvinkwekel%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;alvinkwekel@gmail.com&quot;&gt;alvinkwekel@gmail.com&lt;/a&gt; Thanks for the test - I was able to easily integrate into a unit test to validate. Having the receiving queue pause while the move is in progress sorts this issue.&lt;/p&gt;</comment>
                            <comment id="16223741" author="alvinkwekel@gmail.com" created="Sat, 28 Oct 2017 21:24:23 +0000"  >&lt;p&gt;Great work &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;. Thanks for the fix!&lt;/p&gt;</comment>
                            <comment id="16226494" author="guido.schreuder@gmail.com" created="Tue, 31 Oct 2017 09:18:27 +0000"  >&lt;p&gt;Will this be backported to a 5.14.x maintenance release?&lt;br/&gt;
I&apos;m asking since this is a blocking issue for us and upgrading would require some serious impact analysis.&lt;/p&gt;

&lt;p&gt;BTW I&apos;m following this bug up for the client &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alvinkwekel%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;alvinkwekel@gmail.com&quot;&gt;alvinkwekel@gmail.com&lt;/a&gt; reported this for&lt;/p&gt;</comment>
                            <comment id="16226610" author="christopher.l.shannon" created="Tue, 31 Oct 2017 10:58:06 +0000"  >&lt;p&gt;This can be backported to 5.15.x for sure but there&apos;s not really any plans right now to do another 5.14.x release.  (this could change if enough people want a new release) Is it possible to upgrade to 5.15.x? (this requires Java 8).  &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; - Looks like this test broke on the latest run in CI: &lt;a href=&quot;https://builds.apache.org/view/A/view/ActiveMQ/job/ActiveMQ-Java8/lastBuild/org.apache.activemq$activemq-unit-tests/testReport/org.apache.activemq.broker.virtual/VirtualTopicsAndDurableSubsTest/testMoveFromDLQImmediateDLQ/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/view/A/view/ActiveMQ/job/ActiveMQ-Java8/lastBuild/org.apache.activemq$activemq-unit-tests/testReport/org.apache.activemq.broker.virtual/VirtualTopicsAndDurableSubsTest/testMoveFromDLQImmediateDLQ/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It works for me locally though so maybe just need to tweak something &lt;/p&gt;</comment>
                            <comment id="16233944" author="jira-bot" created="Wed, 1 Nov 2017 11:26:49 +0000"  >&lt;p&gt;Commit 03b19b9da4d50c3bb8985f930e93596c7d994d26 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=03b19b9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=03b19b9&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6847&quot; title=&quot;Immediate poison ACK after move from DLQ leads to message loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6847&quot;&gt;&lt;del&gt;AMQ-6847&lt;/del&gt;&lt;/a&gt; limit the retry loop to one iteration overa all pending messages such that new additions are not replayed to avoid duplicates&lt;/p&gt;</comment>
                            <comment id="16233946" author="gtully" created="Wed, 1 Nov 2017 11:30:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; sorted that failure, it reproduced locally in a loop. It exposed another problem with retry where new additions would be retried twice leading do duplicate send suppression.&lt;/p&gt;</comment>
                            <comment id="16296481" author="guido.schreuder@gmail.com" created="Tue, 19 Dec 2017 08:58:47 +0000"  >&lt;p&gt;Since there is now a &lt;a href=&quot;https://issues.apache.org/jira/projects/AMQ/versions/12340366&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;5.14.6&lt;/a&gt; maintenance release planned; can I vote for this bug to be included in it?&lt;/p&gt;</comment>
                            <comment id="16296696" author="jira-bot" created="Tue, 19 Dec 2017 12:18:50 +0000"  >&lt;p&gt;Commit eb9e50f3c9ea9de4777a6c6295ff8065aa3b4252 in activemq&apos;s branch refs/heads/activemq-5.15.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=eb9e50f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=eb9e50f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6847&quot; title=&quot;Immediate poison ACK after move from DLQ leads to message loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6847&quot;&gt;&lt;del&gt;AMQ-6847&lt;/del&gt;&lt;/a&gt; pause dispatch for message move to avoid redelivery with pending ack/remove/audit rollback&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 2ea5d1420bbbf90bd151e19a75e6ca33c773f1f4)&lt;/p&gt;</comment>
                            <comment id="16296697" author="jira-bot" created="Tue, 19 Dec 2017 12:18:51 +0000"  >&lt;p&gt;Commit 0464d53233f95535dfaf8da6adcef9470cb52bdf in activemq&apos;s branch refs/heads/activemq-5.15.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=0464d53&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=0464d53&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6847&quot; title=&quot;Immediate poison ACK after move from DLQ leads to message loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6847&quot;&gt;&lt;del&gt;AMQ-6847&lt;/del&gt;&lt;/a&gt; limit the retry loop to one iteration overa all pending messages such that new additions are not replayed to avoid duplicates&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 03b19b9da4d50c3bb8985f930e93596c7d994d26)&lt;/p&gt;</comment>
                            <comment id="16296699" author="jira-bot" created="Tue, 19 Dec 2017 12:19:30 +0000"  >&lt;p&gt;Commit e62705aa9d7646108e42c321d390189aa26587ba in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e62705a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e62705a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6847&quot; title=&quot;Immediate poison ACK after move from DLQ leads to message loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6847&quot;&gt;&lt;del&gt;AMQ-6847&lt;/del&gt;&lt;/a&gt; pause dispatch for message move to avoid redelivery with pending ack/remove/audit rollback&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 2ea5d1420bbbf90bd151e19a75e6ca33c773f1f4)&lt;/p&gt;</comment>
                            <comment id="16296700" author="jira-bot" created="Tue, 19 Dec 2017 12:19:32 +0000"  >&lt;p&gt;Commit 185160c0daf955bf7ef43a9440cf5bc9672bd461 in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=185160c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=185160c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6847&quot; title=&quot;Immediate poison ACK after move from DLQ leads to message loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6847&quot;&gt;&lt;del&gt;AMQ-6847&lt;/del&gt;&lt;/a&gt; limit the retry loop to one iteration overa all pending messages such that new additions are not replayed to avoid duplicates&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 03b19b9da4d50c3bb8985f930e93596c7d994d26)&lt;/p&gt;</comment>
                            <comment id="16296704" author="christopher.l.shannon" created="Tue, 19 Dec 2017 12:20:25 +0000"  >&lt;p&gt;I cherry picked into both 5.15.x and 5.14.x branches.&lt;/p&gt;</comment>
                            <comment id="16296713" author="jira-bot" created="Tue, 19 Dec 2017 12:28:01 +0000"  >&lt;p&gt;Commit a5d32da8a143ad541cc484f10fac759c81449482 in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=a5d32da&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=a5d32da&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6847&quot; title=&quot;Immediate poison ACK after move from DLQ leads to message loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6847&quot;&gt;&lt;del&gt;AMQ-6847&lt;/del&gt;&lt;/a&gt; - fix compilation for java 7&lt;/p&gt;</comment>
                            <comment id="16296950" author="guido.schreuder@gmail.com" created="Tue, 19 Dec 2017 15:21:20 +0000"  >&lt;p&gt;Thank you Christopher! Eagerly awaiting the release &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12893740" name="FailingReceiver.java" size="1919" author="alvinkwekel@gmail.com" created="Tue, 24 Oct 2017 12:59:48 +0000"/>
                            <attachment id="12893743" name="dlq-redelivery-issue.tar.gz" size="2476" author="alvinkwekel@gmail.com" created="Tue, 24 Oct 2017 13:13:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 48 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3lmyf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>