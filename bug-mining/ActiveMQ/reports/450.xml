<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:38:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1925] JDBC-Master/Slave Failover - Consumer stop after 1000 Messages</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1925</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;In a JDBC-Master/Slave Environment with ActiveMQ 5.1.0 (+patches for 1710 und 1838) the failover for consumers works, the consumers resume to get messages after the failover but then the suddenly stop after approx. 1000 messages (mostly 1000, one got to 1080). The consumers are using transacted sessions.&lt;/p&gt;

&lt;p&gt;The thread dump look unsuspicious, everybody is waiting on the Socket&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;br/&gt;
	at java.net.SocketInputStream.socketRead0(Native Method)&lt;br/&gt;
	at java.net.SocketInputStream.read(SocketInputStream.java:129)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpBufferedInputStream.fill(TcpBufferedInputStream.java:50)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpBufferedInputStream.read(TcpBufferedInputStream.java:58)&lt;br/&gt;
	at java.io.DataInputStream.readInt(DataInputStream.java:370)&lt;br/&gt;
	at org.apache.activemq.openwire.OpenWireFormat.unmarshal(OpenWireFormat.java:269)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.readCommand(TcpTransport.java:203)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:195)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:183)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;

&lt;p&gt;A memory dump from the consumers shows that they&apos;ve really run out of messages and are waiting for the broker to deliver new ones. I&apos;ve attached both the thread dump and the heap dump to this issue (or better: I&apos;ll do so &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The broker doesn&apos;t do anything (also waits on the transport-socket), the queue has a full page-in buffer (100 messages) but obviously fails to do anything with it. If I manually trigger a doDispatch of all pagedIn messages (via the debugger, just a try to revive the thing) it returns doing nothing at all, since all subscriptions are full (s.isFull). I further investigated the issue and was confused to see the prefetchExtension field of the PrefetchSubscription having a value of -1000 (negative!). This explains why it was considered full:&lt;br/&gt;
  dispatched.size() - prefetchExtension &amp;gt;= info.getPrefetchSize()&lt;br/&gt;
  0 - (-1000) &amp;gt;= 1000&lt;br/&gt;
quite nasty.. so even though the dispatched size was zero the client didn&apos;t receive any new messages.&lt;br/&gt;
The only place this value can become negative is inside acknowledge, where it&apos;s decremented (prefetchExtension--), all other places do a Math.max(0, X).&lt;/p&gt;

&lt;p&gt;So here&apos;s my guess what happened: The client had a full (1000 messages) prefetch buffer when I killed my master. As soon as the slave was done starting they reconnected and started processing the messages in the prefetch and acknowleding them. This gradually decremented the counter into a negative value because the slave never got a chance to increment the prefetchExtension since it didn&apos;t action delivery those messages.&lt;/p&gt;

&lt;p&gt;Possible solutions:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;clear the prefetch buffer on a failover&lt;/li&gt;
	&lt;li&gt;just don&apos;t allow this value to become smaller than zero (not sure if that covers all bases)&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12482229">AMQ-1925</key>
            <summary>JDBC-Master/Slave Failover - Consumer stop after 1000 Messages</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="msiegenthaler">Mario Siegenthaler</reporter>
                        <labels>
                    </labels>
                <created>Tue, 2 Sep 2008 17:38:21 +0000</created>
                <updated>Wed, 8 Oct 2008 08:49:56 +0000</updated>
                            <resolved>Fri, 12 Sep 2008 11:06:00 +0000</resolved>
                                    <version>5.1.0</version>
                                    <fixVersion>5.2.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12940126" author="msiegenthaler" created="Tue, 2 Sep 2008 17:38:51 +0000"  >&lt;p&gt;Consumer memory dump&lt;/p&gt;</comment>
                            <comment id="12940130" author="msiegenthaler" created="Tue, 2 Sep 2008 17:39:42 +0000"  >&lt;p&gt;Consumer thread-dump&lt;/p&gt;</comment>
                            <comment id="12940149" author="msiegenthaler" created="Tue, 2 Sep 2008 18:40:15 +0000"  >&lt;p&gt;Well the &quot;just don&apos;t allow this value to become smaller than zero&quot;-approach does not work. Now I&apos;ve got consumers whose PrefetchSubscription isn&apos;t full but who don&apos;t get more than X messages anyway. However the change seems to increase X a notch...&lt;/p&gt;</comment>
                            <comment id="12940216" author="msiegenthaler" created="Wed, 10 Sep 2008 09:32:07 +0000"  >&lt;p&gt;I&apos;ve looked into it again. My first guess wasn&apos;t completly off spot, although the client clear it&apos;s buffers (Session#clearMessagesInProgress) it still has a message in progress namely the one of the current transaction. So when this message gets ack&apos;d during the recover (the transaction is commited there) the PrefetchSubscription#acknowlegde gets confused.&lt;br/&gt;
It&apos;s inAckRange algorithm runs wild because ack.getFirstMessageId==null and the lastMessageId isn&apos;t in the dispatch-list (with the &quot;old&quot;-master it&apos;d have been the first entry). So what it does is run to the complete dispatch list and ack&apos;s everything. This is a very bad move because it in fact deletes every message in the dispatch list permanently (around 100 messages; also from the DB)!!&lt;br/&gt;
It even shows the message &quot;Could not correlate acknowledgment with dispatched message&quot;, but only at debug level.&lt;/p&gt;

&lt;p&gt;Of course the dispatching gets completey out of sync afterwards, since all the messages in the broker&apos;s dispatched-list are now gone... so every single ack afterward clears (aka deletes from the database) the whole dispatched-list (mostly around 100 messages). After some ack&apos;s&lt;/p&gt;

&lt;p&gt;Note that I only see this happening with transactional consumers, only then I get a transaction-ack-replay that then goes wrong. Also note that it does not happen in the current trunk or the 5.1 release because they fail on &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1710&quot; title=&quot;Failing over in JDBC Master/Slave topology does not preserve transaction state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1710&quot;&gt;&lt;del&gt;AMQ-1710&lt;/del&gt;&lt;/a&gt; (&quot;transaction X has not been started&quot;)&lt;/p&gt;</comment>
                            <comment id="12940214" author="msiegenthaler" created="Wed, 10 Sep 2008 14:27:21 +0000"  >&lt;p&gt;TestCase showing the problem with lost messages.&lt;br/&gt;
The test testAMQ1925_TXInProgress should fail, the other two run fine.&lt;/p&gt;

&lt;p&gt;Note: The test does not always fail, only when it gets interrupted during session.commit. This is the slowest call, so it mostly happens, but there&apos;s no guarantee.&lt;/p&gt;</comment>
                            <comment id="12940179" author="msiegenthaler" created="Wed, 10 Sep 2008 17:14:32 +0000"  >&lt;p&gt;part-patch for the issue.&lt;br/&gt;
Acks are now checked to match the dispatch list, if not an exception is thrown (but unfortunatly only logged, cannot get the clients commit to fail).&lt;/p&gt;

&lt;p&gt;Consequences:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;messages get no longer delete arbitary (very good)&lt;/li&gt;
	&lt;li&gt;can cause some dup-delivery (since it cannot let commit fail)&lt;/li&gt;
	&lt;li&gt;some messages may become &quot;hidden&quot; for the consumers that did failover. New consumers can see the messages.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The patch also contains an updated version of the test-case&lt;/p&gt;</comment>
                            <comment id="12940184" author="rajdavies" created="Wed, 10 Sep 2008 18:05:00 +0000"  >&lt;p&gt;Patch applied in SVN revision 693915.&lt;/p&gt;</comment>
                            <comment id="12940151" author="gtully" created="Thu, 11 Sep 2008 11:41:14 +0000"  >&lt;p&gt;I think the change to isFull() to add in isSlave() in PrefetchSubscription&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; is problematic.&lt;/p&gt;

&lt;p&gt;In pure master slave, it means that the dispatch list does not get populated in the slave and hence the acks result in errors. &lt;br/&gt;
To see the problem, check out the log4j logging in activemq-core/target/test.log that results from:&lt;br/&gt;
   mvn test -Dtest=MasterSlaveTempQueueMemoryTest&lt;/p&gt;

&lt;p&gt;For the slave is is fine to let dispatch happen to fill the dispatchList, the actual doDispatch call is gated on isSlave() so the does not actually go to a consumer but is available to the ack. &lt;/p&gt;

&lt;p&gt;What as the reason for the change, is it that the stats or counters are off?&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/main/java/org/apache/activemq/broker/region/PrefetchSubscription.java?rev=693915&amp;amp;r1=693914&amp;amp;r2=693915&amp;amp;view=diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/main/java/org/apache/activemq/broker/region/PrefetchSubscription.java?rev=693915&amp;amp;r1=693914&amp;amp;r2=693915&amp;amp;view=diff&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12940217" author="msiegenthaler" created="Thu, 11 Sep 2008 15:30:54 +0000"  >&lt;p&gt;My patch didn&apos;t contain the line in question and does not depend on it (in fact I did all the tests with it the line as commited in 692539).&lt;br/&gt;
So I suspect it&apos;s just a merge problem.&lt;/p&gt;</comment>
                            <comment id="12940152" author="gtully" created="Thu, 11 Sep 2008 15:53:54 +0000"  >&lt;p&gt;ok, did not notice that it was not in your patch, will follow up with rob and revert the change. thanks for the heads up.&lt;/p&gt;</comment>
                            <comment id="12940200" author="gtully" created="Fri, 12 Sep 2008 11:06:00 +0000"  >&lt;p&gt;reverted change to PrefetchSubscription.isFull and updated a test case to catch this in the future. this is full was not part of the original patch, &lt;/p&gt;

&lt;p&gt;r694679.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461149" name="AMQ1925Test.java" size="6040" author="msiegenthaler" created="Wed, 10 Sep 2008 14:27:21 +0000"/>
                            <attachment id="12461130" name="heapdump-1220373534484.hprof" size="3322083" author="msiegenthaler" created="Tue, 2 Sep 2008 17:39:42 +0000"/>
                            <attachment id="12461246" name="patch-1925-1.diff" size="21853" author="msiegenthaler" created="Wed, 10 Sep 2008 17:14:32 +0000"/>
                            <attachment id="12461245" name="threaddump-1220371256910.tdump" size="10792" author="msiegenthaler" created="Tue, 2 Sep 2008 17:38:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>75169</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 11 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s1mf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161739</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310080" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Regression</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10092"><![CDATA[Unit Test Broken]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>