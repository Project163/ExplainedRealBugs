<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:47:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2935] java.io.EOFException: Chunk stream does not exist at page on broker start</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2935</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I am seeing this regularly upon restarts in all versions from 5.4.x - I cannot downgrade due to breaking issues in previous versions.&lt;br/&gt;
The broker was shutdown cleanly with no logged issues.&lt;br/&gt;
Deleting the activemq-data directory seems to be the only recovery solution (which is not an option in production)&lt;/p&gt;

&lt;p&gt;2010-09-23 13:54:30,997 &lt;span class=&quot;error&quot;&gt;&amp;#91;Starting ActiveMQ Broker&amp;#93;&lt;/span&gt; ERROR org.apache.activemq.broker.BrokerService - Failed to start ActiveMQ JMS Message Broker. Reason: java.io.EOFException: Chunk stream does not exist at page: 0&lt;br/&gt;
java.io.EOFException: Chunk stream does not exist at page: 0&lt;br/&gt;
	at org.apache.kahadb.page.Transaction$2.readPage(Transaction.java:454)&lt;br/&gt;
	at org.apache.kahadb.page.Transaction$2.&amp;lt;init&amp;gt;(Transaction.java:431)&lt;br/&gt;
	at org.apache.kahadb.page.Transaction.openInputStream(Transaction.java:428)&lt;br/&gt;
	at org.apache.kahadb.page.Transaction.load(Transaction.java:404)&lt;br/&gt;
	at org.apache.kahadb.page.Transaction.load(Transaction.java:361)&lt;br/&gt;
	at org.apache.activemq.broker.scheduler.JobSchedulerStore$3.execute(JobSchedulerStore.java:250)&lt;br/&gt;
	at org.apache.kahadb.page.Transaction.execute(Transaction.java:728)&lt;br/&gt;
	at org.apache.activemq.broker.scheduler.JobSchedulerStore.doStart(JobSchedulerStore.java:239)&lt;br/&gt;
	at org.apache.activemq.util.ServiceSupport.start(ServiceSupport.java:53)&lt;br/&gt;
	at org.apache.activemq.broker.scheduler.SchedulerBroker.getStore(SchedulerBroker.java:198)&lt;br/&gt;
	at org.apache.activemq.broker.scheduler.SchedulerBroker.getInternalScheduler(SchedulerBroker.java:185)&lt;br/&gt;
	at org.apache.activemq.broker.scheduler.SchedulerBroker.start(SchedulerBroker.java:85)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.start(BrokerFilter.java:157)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.start(BrokerFilter.java:157)&lt;br/&gt;
	at org.apache.activemq.broker.TransactionBroker.start(TransactionBroker.java:112)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerService$3.start(BrokerService.java:1786)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerService.start(BrokerService.java:496)&lt;br/&gt;
	at org.apache.activemq.ra.ActiveMQResourceAdapter$1.run(ActiveMQResourceAdapter.java:85)&lt;/p&gt;</description>
                <environment>&lt;p&gt;Win7 32bit, JDK 1.6_20&lt;/p&gt;</environment>
        <key id="12483866">AMQ-2935</key>
            <summary>java.io.EOFException: Chunk stream does not exist at page on broker start</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="andyg">Andy Gumbrecht</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Sep 2010 12:43:49 +0000</created>
                <updated>Fri, 9 Oct 2015 02:49:19 +0000</updated>
                            <resolved>Wed, 6 Oct 2010 13:43:17 +0000</resolved>
                                    <version>5.4.0</version>
                    <version>5.4.1</version>
                    <version>5.4.2</version>
                                    <fixVersion>5.4.2</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>17</votes>
                                    <watches>31</watches>
                                                                                                                <comments>
                            <comment id="12942958" author="andyg" created="Thu, 23 Sep 2010 12:46:13 +0000"  >&lt;p&gt;Here is my config and zipped activemq-data directory&lt;/p&gt;</comment>
                            <comment id="12942945" author="eric-awl" created="Thu, 23 Sep 2010 15:49:24 +0000"  >
&lt;p&gt;I upgraded from 5.3.2 to 5.4.1. Some jars (spring) were updated.&lt;/p&gt;

&lt;p&gt;If  I delete all files in activemq-data/xxxx/scheduler and then restart the process. It&apos;s OK&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;sibModule@td0sib01s SIBBusModule-TestDeCharge-td0sib01s&amp;#93;&lt;/span&gt;$ ll scheduler&lt;br/&gt;
total 36&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 sibModule sibdev     0 Sep 23 17:39 db-1.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 sibModule sibdev     0 Sep 23 17:39 lock&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 sibModule sibdev 16384 Sep 23 17:39 scheduleDB.data&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 sibModule sibdev 16408 Sep 23 17:39 scheduleDB.redo&lt;/p&gt;

&lt;p&gt;If I stop the process with a CTRL-C shutdown action and try to restart it without deleting the files, I have this error.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;sibModule@td0sib01s scheduler&amp;#93;&lt;/span&gt;$ ll&lt;br/&gt;
total 36&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 sibModule sibdev     0 Sep 23 17:39 db-1.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 sibModule sibdev 16384 Sep 23 17:44 scheduleDB.data&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 sibModule sibdev 16408 Sep 23 17:39 scheduleDB.redo&lt;/p&gt;

&lt;p&gt;I have a MemoryPersistance configuration.&lt;/p&gt;

</comment>
                            <comment id="12942948" author="eric-awl" created="Thu, 23 Sep 2010 16:05:19 +0000"  >&lt;p&gt;When I add&lt;br/&gt;
schedulerSupport=&quot;false&quot;&lt;/p&gt;

&lt;p&gt;in the &quot;broker&quot; configuration, It seems OK. No activemq-data directory nor files below are created.&lt;/p&gt;

&lt;p&gt;Example :&lt;/p&gt;

&lt;p&gt;&amp;lt;broker xmlns=&quot;http://activemq.apache.org/schema/core&quot; brokerName=&quot;SIBBusModule-TestDeCharge-td0sib01s&quot; useJmx=&quot;true&quot; persistent=&quot;false&quot; useShutdownHook=&quot;false&quot; schedulerSupport=&quot;false&quot;&amp;gt;&lt;/p&gt;

</comment>
                            <comment id="12942925" author="andyg" created="Fri, 24 Sep 2010 09:23:26 +0000"  >&lt;p&gt;Thanks Eric,&lt;/p&gt;

&lt;p&gt;Applying the property schedulerSupport=&quot;false&quot;  to the broker seems to have nipped this in the bud, at least for the few tests I have run.&lt;/p&gt;

&lt;p&gt;Where did you find the docs on this parameter? - All I can find is this: &lt;a href=&quot;http://activemq.apache.org/delay-and-schedule-message-delivery.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/delay-and-schedule-message-delivery.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;As this was introduced recently (5.4.x) as new option I think &apos;false&apos; should really be the default option - Especially as it seems to be broken.&lt;/p&gt;</comment>
                            <comment id="12942972" author="bryanck" created="Fri, 24 Sep 2010 17:27:23 +0000"  >&lt;p&gt;Setting the schedulerSupport=false for me did reduce the likelihood of this error occurring for me. With it set to true, it happens nearly every single time I shut down and restart. However, I am still getting the problem intermittently after shutdown and restart, even with this set to false, albeit less frequently. I will attached stack traces of it occurring with both schedulerSupport=true and false (the error occurs in different places during initialization).&lt;/p&gt;

&lt;p&gt;Also, to note, this is a much more frequent occurrence with 5.4.1 vs 5.4.0. I do not have this issue with 5.3.2 so have downgraded to that for now.&lt;/p&gt;

&lt;p&gt;This occurs for me on both Windows 7 64-bit JDK 1.6.21 and Mac OS 10.6.4.&lt;/p&gt;</comment>
                            <comment id="12942965" author="bryanck" created="Fri, 24 Sep 2010 17:42:44 +0000"  >&lt;p&gt;Stack traces of the issue, with schedulerSupport=true and with schedulerSupport=false&lt;/p&gt;</comment>
                            <comment id="12942976" author="shiweiyuan" created="Sun, 26 Sep 2010 07:14:45 +0000"  >&lt;p&gt;I get the same issue when try activemq 5.4.1 on linux with jdk1.5. and I get around this issue by deleting all files/folders under data.&lt;br/&gt;
But it will not be practical if it&apos;s a production environment.&lt;/p&gt;</comment>
                            <comment id="12942975" author="andyg" created="Sun, 26 Sep 2010 09:49:09 +0000"  >&lt;p&gt;Yes Bryan, you are right, setting schedulerSupport=false has only &apos;reduced&apos; the likelihood of this occurring - This is still happening, but less frequently.&lt;/p&gt;

&lt;p&gt;There must be a race condition on shutdown which is corrupting the KahaDB files - I have looked at the startup code, but nothing seems to have changed much recently.&lt;/p&gt;

&lt;p&gt;The corruption is obviously more aggressive in the the sheduler code.&lt;/p&gt;

&lt;p&gt;This is a real show stopper for me right now, so I will dig more into this to see if I can find the problem.&lt;/p&gt;</comment>
                            <comment id="12942974" author="andyg" created="Sun, 26 Sep 2010 09:58:14 +0000"  >&lt;p&gt;I have elevated this to &apos;Blocker&apos; due to the fact that others are also experiencing this, and that the general solution for everyone is to physically delete files in order to continue - not an option in production.&lt;br/&gt;
The bug is consistently repeatable and is destructive in that files are left in an unrecoverable state - The ability of ActiveMQ to recover from a crash is a feature, so the the ability to recover from a simple restart is ultimately critical. &lt;/p&gt;</comment>
                            <comment id="12942984" author="shiweiyuan" created="Mon, 27 Sep 2010 04:42:12 +0000"  >&lt;p&gt;This issue maybe caused by lack of disk capacity.&lt;/p&gt;

&lt;p&gt;when using the default configuration, i.e. the pending queue policy will be store based message cursor.&lt;br/&gt;
I found that the data folder size will increase very rapidly:&lt;br/&gt;
300,000 messages, 30 bytes per message, non_persistent,  the file named tmpDB.data  under data\localhost\tmp_storage\ will up to 1.15G in my environment.&lt;br/&gt;
so, pls check if your disk load/capacity is full.&lt;/p&gt;

&lt;p&gt;But I&apos;m still experiencing this issue after make sure the disk capacity is not full.&lt;br/&gt;
Will update on this issue if I get new evidence later...&lt;/p&gt;</comment>
                            <comment id="12942983" author="andyg" created="Mon, 27 Sep 2010 07:09:40 +0000"  >&lt;p&gt;Tested in several environments, of which at least one is a very high spec system, all with plenty of free space. Same results, so nothing to do with capacity.&lt;/p&gt;

&lt;p&gt;This seems to be pretty consistent, but even more so with schedulerSupport=true (occurs on practically every restart).&lt;br/&gt;
The point of failure is easy to track down at org.apache.kahadb.page.Transaction$2.readPage(Transaction.java:454) - The question is more about why is the KahaDB file left in an unreadable state on a clean shutdown?&lt;/p&gt;</comment>
                            <comment id="12942993" author="fgynnild" created="Mon, 4 Oct 2010 08:33:38 +0000"  >&lt;p&gt;This is a blocker issue for me, and it seems to be unrelated to the amount of available disk space.&lt;/p&gt;</comment>
                            <comment id="12943031" author="adamaitch" created="Mon, 4 Oct 2010 09:44:03 +0000"  >&lt;p&gt;This renders 5.4.1 unusable for me. Had to roll back to 5.3.2.&lt;/p&gt;</comment>
                            <comment id="12942847" author="swapnonil" created="Mon, 4 Oct 2010 15:36:24 +0000"  >&lt;p&gt;The reason I chose Active MQ 5.4 is because is of it&apos;s &quot;Message Scheduling&quot; feature, which is not there in 5.3. We are using the message scheduling feature released with 5.4. Our application needs messages to sit on a queue for at least 30 seconds.  &lt;br/&gt;
I am using the Spring JMS Template to send messages. This is how I am sending messages.&lt;/p&gt;
&lt;hr /&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: none;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Message createMessage(Session session) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; JMSException
{
    Date date = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date();
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; delayInSeconds = properties.getProperty(MESSAGE_DELAY);
    Message message = session.createObjectMessage(mqRequest);
    message.setLongProperty(TIMESTAMP_AS_EPOCH_ATTRIBUTE, date.getTime());
    message.setStringProperty(TIMESTAMP_AS_STRING_ATTRIBUTE, getDateAsString(date));
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (delayInSeconds != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
    {
        LOGGER.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Delay set at &quot;&lt;/span&gt; + delayInSeconds + &lt;span class=&quot;code-quote&quot;&gt;&quot; seconds&quot;&lt;/span&gt;);
        message.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_DELAY, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.parseInt(delayInSeconds) * 1000);
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; message;
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I can downgrade to 5.3 but then how do I get message scheduling. Please advice.&lt;/p&gt;

&lt;p&gt;I have checked disk capacity. There&apos;s no problem with that. &lt;br/&gt;
By the way the stack trace I get is exactly what Andy posted.&lt;/p&gt;

&lt;p&gt;I just deleted all the contents of localhost/scheduler directory, and started the broker again. This time it starts ok and is working fine.&lt;/p&gt;</comment>
                            <comment id="12942880" author="gtully" created="Tue, 5 Oct 2010 08:40:32 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;useShutdownHook=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; is relevant. With a simple embedded broker Ctrl+C and restart without the shutdown hook, the stores are not stopped, in fact the broker is not stopped. A restart results in this problem every time. The store needs to be flushed on start which will should help but requires some code changes. In addition, this exception should be trapped such that it leads to recovery.&lt;/p&gt;

&lt;p&gt;To work around, either &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;useShutdownHook=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; needs to be used such that the broker is stopped when the jvm is shutdown or there needs to be an explicit call to broker.stop()&lt;/p&gt;</comment>
                            <comment id="12942936" author="eric-awl" created="Tue, 5 Oct 2010 09:02:02 +0000"  >&lt;p&gt;Hi Gary&lt;/p&gt;

&lt;p&gt;Do you confirm us that &quot;schedulerSupport=false&quot; is enough when we don&apos;t plan to use sheduled messages and don&apos;t want to have any files written on disk ?&lt;/p&gt;

&lt;p&gt;Eric&lt;/p&gt;</comment>
                            <comment id="12942879" author="s1ngle" created="Tue, 5 Oct 2010 09:03:05 +0000"  >&lt;p&gt;In our configuration we have &lt;span class=&quot;error&quot;&gt;&amp;#91;and had&amp;#93;&lt;/span&gt; useShutdownHook=&quot;true&quot;, also we do not use db (only memory).&lt;/p&gt;

&lt;p&gt;broker.setPersistenceAdapter(new MemoryPersistenceAdapter());&lt;br/&gt;
broker.setPersistent(false);&lt;br/&gt;
broker.setUseShutdownHook(true);&lt;br/&gt;
broker.setUseLoggingForShutdownErrors(false);&lt;/p&gt;

&lt;p&gt;If we do not use: &quot;broker.setSchedulerSupport(false);&quot; the problem is 100% reproducible.&lt;/p&gt;

&lt;p&gt;Although we were not able to reproduce it with a scheduler being off, we would not take a risk, as someone mentioned above, this setting only reduce the probability of the problem.&lt;/p&gt;</comment>
                            <comment id="12942935" author="andyg" created="Tue, 5 Oct 2010 09:39:22 +0000"  >&lt;p&gt;Eric,&lt;/p&gt;

&lt;p&gt;Only using &quot;schedulerSupport=false&quot; does NOT resolve this issue. The problem is specifically a KahaDB problem (the default persistence store is KahaDB).&lt;/p&gt;

&lt;p&gt;Swapping out the persistence store is currently the only option. If you need &apos;any&apos; persistence then I would suggest the jdbcPersistenceAdapter (the default uses a Derby Database, but many can be used).&lt;br/&gt;
This is substantially slower than KahaDB, but not enough to worry about if you are only pushing say several thousand messages a minute (you&apos;d have to run your own tests). I am in fact happy enough with the performance that I am likely to stick with it for stabilities sake even if this issue is resolved.&lt;/p&gt;

&lt;p&gt;&amp;lt;broker xmlns=&quot;http://activemq.apache.org/schema/core&quot;&lt;br/&gt;
          useJmx=&quot;false&quot;&lt;br/&gt;
          brokerName=&quot;YourName&quot;&lt;br/&gt;
          useShutdownHook=&quot;false&quot;&lt;br/&gt;
          persistent=&quot;true&quot;&lt;br/&gt;
          start=&quot;false&quot;&lt;br/&gt;
          schedulerSupport=&quot;false&quot;&lt;br/&gt;
          enableStatistics=&quot;false&quot;&amp;gt;&lt;/p&gt;

&lt;p&gt;    &amp;lt;persistenceAdapter&amp;gt;&lt;br/&gt;
      &amp;lt;jdbcPersistenceAdapter dataDirectory=&quot;activemq-data/jdbc&quot;/&amp;gt;&lt;br/&gt;
    &amp;lt;/persistenceAdapter&amp;gt;&lt;/p&gt;

&lt;p&gt;.....&lt;/p&gt;

&lt;p&gt;Note: If schedulerSupport is enabled then the error will still persist (excuse the pun) due to the fact that the scheduler uses KahaDB irrelevant of the persistenceAdapter - So if you want scheduler support then there is currently no option (unless someone knows how to configure the scheduler to use another store?).&lt;/p&gt;

&lt;p&gt;Gary,&lt;/p&gt;

&lt;p&gt;I should have mentioned that my configuration is for an OpenEJB RA, whereby the RA is responsible for starting and stopping ActiveMQ (which is does, and still produces a corrupt KahaDB) - The default OpenEJB RA config uses a memory store, but I require persistence for my project. A standalone application (basically as Krzysztof writes) which loops through start/stop will still produce the same stacktrace virtually every time.&lt;/p&gt;</comment>
                            <comment id="12942952" author="eric-awl" created="Tue, 5 Oct 2010 09:59:50 +0000"  >&lt;p&gt;Hi Andy&lt;/p&gt;

&lt;p&gt;I don&apos;t need nor scheduled Messages, nor Persistance. So I don&apos;t need KahaDB usage at all.&lt;/p&gt;

&lt;p&gt;I wonder if, in this case, &quot;schedulerSupport=false&quot; is enough.&lt;/p&gt;

&lt;p&gt;Eric&lt;/p&gt;</comment>
                            <comment id="12942960" author="gtully" created="Tue, 5 Oct 2010 11:24:20 +0000"  >&lt;p&gt;I have found a problem with the recovery processing in the kahaDB pageFile/index but the issue only occurs when there has been an abortive close, as in the stop method of the broker was not called or did not complete or a file write did not complete with the clean shutdown flag set.&lt;br/&gt;
With a successful call to broker.stop() the problem is avoided as there is no recovery of the pageFile from the redo buffer at restart so it may not be the only issue here.&lt;/p&gt;

&lt;p&gt;The latest 5.5-SNAPSHOT from maven or the repo has the fix. It would be great if you could validate.&lt;br/&gt;
&lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.5-SNAPSHOT/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.5-SNAPSHOT/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Andy, Krzysztof, Can you verify that the broker is actually stopped in your start/stop tests.There should be messages in the log of the form: 10:55:37,927 &lt;span class=&quot;error&quot;&gt;&amp;#91;main &amp;#93;&lt;/span&gt; INFO  JobSchedulerStore - JobSchedulerStore:activemq-data/localhost/scheduler stopped&lt;/p&gt;

&lt;p&gt;Eric, for your use case, schedulerSupport=false is sufficient.&lt;/p&gt;</comment>
                            <comment id="12942968" author="ngehring" created="Tue, 5 Oct 2010 11:47:05 +0000"  >&lt;p&gt;Gary - thanks for looking in to this.  We are going to test that it solves the issue we&apos;re seeing.&lt;/p&gt;

&lt;p&gt;In the meantime a quick question please....  as we are running this in the background in Unix, how do we stop the broker gracefully?  The FAQ simply says to kill the process and I presume that this will not call broker.stop() correctly.&lt;/p&gt;</comment>
                            <comment id="12942862" author="s1ngle" created="Tue, 5 Oct 2010 11:57:19 +0000"  >&lt;p&gt;Gary, you are right.&lt;br/&gt;
After deleting activemq-data I verified following situation:&lt;br/&gt;
until I abnormally quit the application &lt;span class=&quot;error&quot;&gt;&amp;#91;and thus the broker.stop() is not invoked&amp;#93;&lt;/span&gt; everything starts OK&lt;br/&gt;
only after a crash/abnormal ending of an application the problem appears &lt;span class=&quot;error&quot;&gt;&amp;#91;in 100% cases&amp;#93;&lt;/span&gt; (deleting the data or setting schedulerSupport to false resolve the issue).&lt;/p&gt;</comment>
                            <comment id="12942951" author="gtully" created="Tue, 5 Oct 2010 12:32:16 +0000"  >&lt;p&gt;Nik, so long as you don&apos;t use kill -9, and use one of the interrupt signals SIGHUP (Unix Only), SIGINT, or SIGTERM  instead, the jvm interruption handler will have a chance to kick in and call stop via the shutdownHooks registered by the broker.&lt;/p&gt;

&lt;p&gt;But you can also use ./bin/activemq stop on unix, see : &lt;a href=&quot;http://activemq.apache.org/unix-shell-script.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/unix-shell-script.html&lt;/a&gt;&lt;br/&gt;
I guess activemq stop is the preferred approach, it will try via jmx first and then revert to kill after some timeout.&lt;/p&gt;</comment>
                            <comment id="12942973" author="swapnonil" created="Tue, 5 Oct 2010 18:33:42 +0000"  >&lt;p&gt;Hi Gary,&lt;/p&gt;

&lt;p&gt;I can indeed confirm that in our case the problem started only after someone killed the activemq process using kill -9. As I reported earlier, when I deleted everything under localhost/scheduler folder and restarted activemq it started cleanly.&lt;/p&gt;

&lt;p&gt;With regards to your suggestion of testing 5.5 Snapshot; Are you saying that with 5.5 activemq can recover correctly from these kill -9 type shutdowns and we won&apos;t see this &quot;Chunk Stream&quot; errors? &lt;/p&gt;</comment>
                            <comment id="12942933" author="gtully" created="Tue, 5 Oct 2010 18:37:46 +0000"  >&lt;p&gt;yes. it would be great if you could validate the fix.&lt;/p&gt;</comment>
                            <comment id="12942988" author="andyg" created="Wed, 6 Oct 2010 13:16:19 +0000"  >&lt;p&gt;Gary,&lt;/p&gt;

&lt;p&gt;Many thanks, the fix works so far. I am still in the process of further testing , but a corrupted KahaDB is now properly recovered on restart.&lt;/p&gt;

&lt;p&gt;I think in my specific RA case that &apos;not&apos; calling &apos;waitUntilStopped()&apos;  in the RA may have caused the corruption - If the system exits too early then this would be the culprit.&lt;/p&gt;

&lt;p&gt;I&apos;ll let you know if and when I find something.&lt;/p&gt;</comment>
                            <comment id="12942946" author="gtully" created="Wed, 6 Oct 2010 13:43:16 +0000"  >&lt;p&gt;thanks for the validation andy, marking resolved.&lt;/p&gt;</comment>
                            <comment id="12942995" author="fgynnild" created="Wed, 6 Oct 2010 14:13:40 +0000"  >&lt;p&gt;Great that you found and fixed this issue! What is the strategy of back porting critical and blocker issues like this? The severity of this bug leaves 5.4.* useless in a production environment, but it is still announced as the stable one.&lt;/p&gt;</comment>
                            <comment id="12942784" author="eduzanni" created="Thu, 7 Oct 2010 18:32:47 +0000"  >&lt;p&gt;I agree with Frank. This issue has been affecting us too (we&apos;re using Fuse broker v. 5.4, which in turn relies on activeMQ 5.4). Is there any prevision regarding a &quot;patched&quot; release for version 5.4 with Gary&apos;s fix that can be used safely in a production environment?&lt;/p&gt;</comment>
                            <comment id="12943010" author="tomdz" created="Fri, 8 Oct 2010 01:48:12 +0000"  >&lt;p&gt;FWIW, I get this issue on first write into a new KahaDB store, as well, though not consistently. In this particular case, ActiveMQ is used in a unit test and KahaDB is configured to write to a new temporary directory. The startup code looks like this:&lt;/p&gt;

&lt;p&gt;File tmpDir = File.createTempFile(&quot;activmq&quot;, &quot;&quot;);&lt;/p&gt;

&lt;p&gt;tmpDir.delete();&lt;br/&gt;
tmpDir.mkdir();&lt;/p&gt;

&lt;p&gt;KahaDBStore kaha = new KahaDBStore();&lt;/p&gt;

&lt;p&gt;kaha.setDirectory(localDbDir);&lt;/p&gt;

&lt;p&gt;BrokerService broker = new BrokerService();&lt;/p&gt;

&lt;p&gt;broker.setUseShutdownHook(true);&lt;br/&gt;
broker.setPersistenceAdapter(kaha);&lt;br/&gt;
broker.addConnector(&quot;vm://localhost:12345&quot; );&lt;br/&gt;
broker.start();&lt;/p&gt;

&lt;p&gt;Then the very first message (jms producer using via a vm connection) fails with this error:&lt;/p&gt;

&lt;p&gt;VMTransport org.apache.activemq.broker.TransportConnection.Transport Transport failed: java.io.EOFException: Chunk stream does not exist at page: 0&lt;br/&gt;
java.io.EOFException: Chunk stream does not exist at page: 0&lt;br/&gt;
	at org.apache.kahadb.page.Transaction$2.readPage(Transaction.java:454)&lt;br/&gt;
	at org.apache.kahadb.page.Transaction$2.&amp;lt;init&amp;gt;(Transaction.java:431)&lt;br/&gt;
	at org.apache.kahadb.page.Transaction.openInputStream(Transaction.java:428)&lt;br/&gt;
	at org.apache.kahadb.page.Transaction.load(Transaction.java:404)&lt;br/&gt;
	at org.apache.kahadb.page.Transaction.load(Transaction.java:361)&lt;br/&gt;
	at org.apache.activemq.broker.scheduler.JobSchedulerStore$3.execute(JobSchedulerStore.java:250)&lt;br/&gt;
	at org.apache.kahadb.page.Transaction.execute(Transaction.java:728)&lt;br/&gt;
	at org.apache.activemq.broker.scheduler.JobSchedulerStore.doStart(JobSchedulerStore.java:239)&lt;br/&gt;
	at org.apache.activemq.util.ServiceSupport.start(ServiceSupport.java:53)&lt;br/&gt;
	at org.apache.activemq.broker.scheduler.SchedulerBroker.getStore(SchedulerBroker.java:197)&lt;br/&gt;
	at org.apache.activemq.broker.scheduler.SchedulerBroker.getInternalScheduler(SchedulerBroker.java:184)&lt;br/&gt;
	at org.apache.activemq.broker.scheduler.SchedulerBroker.send(SchedulerBroker.java:131)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:129)&lt;br/&gt;
	at org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:96)&lt;br/&gt;
	at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:230)&lt;br/&gt;
	at org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:135)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:460)&lt;br/&gt;
	at org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:663)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:309)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:185)&lt;br/&gt;
	at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:116)&lt;br/&gt;
	at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:69)&lt;br/&gt;
	at org.apache.activemq.transport.vm.VMTransport.iterate(VMTransport.java:218)&lt;br/&gt;
	at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:122)&lt;br/&gt;
	at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:43)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;</comment>
                            <comment id="12943014" author="swapnonil" created="Fri, 8 Oct 2010 07:35:32 +0000"  >&lt;p&gt;Hi Gary,&lt;/p&gt;

&lt;p&gt;We verified the fix. It works as expected. &lt;/p&gt;

&lt;p&gt;However since there is no talk of merging this fix back to 5.4 we are going into production from Monday onwards with 5.5 Snapshot.&lt;/p&gt;

&lt;p&gt;We thank you for applying this fix.&lt;/p&gt;</comment>
                            <comment id="12942985" author="fgynnild" created="Fri, 8 Oct 2010 14:01:29 +0000"  >&lt;p&gt;I also tried the fix, and I no longer got the error message. But not all queues are working afterwards. Some queues work as expected, but for some of the other queues nothing gets into them. And there is no error messages either, neither on the server or the client side. Does anyone else experience this behavior?&lt;/p&gt;</comment>
                            <comment id="12943024" author="gtully" created="Fri, 8 Oct 2010 14:08:03 +0000"  >&lt;p&gt;Frank, can you try an reproduce with trace level logging?&lt;/p&gt;</comment>
                            <comment id="12943038" author="norman" created="Sun, 10 Oct 2010 18:08:31 +0000"  >&lt;p&gt;We saw the same exception in JAMES. IMHO a backport of the fix is a must because its really unacceptable to only be able to start again when purge all data. Thats just a no-go for a production service.. &lt;/p&gt;</comment>
                            <comment id="12943101" author="eduzanni" created="Thu, 21 Oct 2010 21:21:23 +0000"  >&lt;p&gt;Any news on the backport possibility for this issue? We&apos;d like having the scheduled/delayed message delivery available, so reverting to version 5.3 wouldn&apos;t be so much of a nice option for us here.&lt;/p&gt;</comment>
                            <comment id="12943116" author="gtully" created="Fri, 22 Oct 2010 07:56:00 +0000"  >&lt;p&gt;we will drop a new release 5.4.2 once we get completion on a few more outstanding issues.&lt;/p&gt;</comment>
                            <comment id="12943102" author="jns" created="Fri, 22 Oct 2010 23:11:59 +0000"  >&lt;p&gt;Gary,&lt;br/&gt;
 Activemq 5.5 snapshot fix worked. Thanks for the fix. &lt;br/&gt;
Can you provide us with an approximate 5.4.2 release date....Just a rough estimate would be fine.&lt;/p&gt;</comment>
                            <comment id="12943157" author="rbonneau" created="Mon, 1 Nov 2010 22:28:44 +0000"  >&lt;p&gt;As requested by Eduardo Zanni above, can anyone supply a workaround if using 5.4.0?&lt;/p&gt;</comment>
                            <comment id="12943188" author="redvortex" created="Mon, 8 Nov 2010 16:53:01 +0000"  >&lt;p&gt;We are also looking for either:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;A workaround for 5.4.1&lt;/li&gt;
	&lt;li&gt;A 5.4.2 version that includes this fix&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We need to move to 5.4.x from 5.3.2 but cannot do so because of this critical issue.&lt;/p&gt;</comment>
                            <comment id="12943204" author="okozlov" created="Thu, 11 Nov 2010 02:20:17 +0000"  >&lt;p&gt;Could one of the Activemq developers provide a date for the next release that will include a fix for this issue? Whatever it will be.. 5.4.2 or 5.5.0.&lt;/p&gt;

&lt;p&gt;We are in the final stage of developing an large system that will go to production in beginning of December and we are experiencing this issue in staging (using 5.4.1). It would be really nice to get a fix before Dec.1  If it&apos;s not possible - is there a patch for 5.4.1 or a workaround?&lt;/p&gt;

&lt;p&gt;Really appreciate!&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Oleg.&lt;/p&gt;</comment>
                            <comment id="12943203" author="srodrigu85@gmail.com" created="Thu, 11 Nov 2010 05:53:33 +0000"  >&lt;p&gt;@Oleg: The issue is resolved in the trunk, you can always pickup the latest sourcecode there and compile, or grab the nightly builds.&lt;br/&gt;
But there is a discussion in the mailing list, there should be a 5.4.2 soon.&lt;/p&gt;</comment>
                            <comment id="12973878" author="randy_palmer" created="Tue, 21 Dec 2010 20:48:24 +0000"  >&lt;p&gt;It seems like schedulerSupport defaulted to true in 5.4.1.  It appears to default to false in 5.4.2 so you may need to explicitly set schedulerSupport=true on your broker when you update from 5.4.1. to 5.4.2 if it&apos;s not already in your config file.&lt;/p&gt;</comment>
                            <comment id="14933672" author="volkerk" created="Mon, 28 Sep 2015 17:58:20 +0000"  >&lt;p&gt;This error still happens in 5.10 with the PList store (tmp_storage), which always uses kahaDB. A lot!&lt;/p&gt;</comment>
                            <comment id="14949795" author="fenghao0038" created="Fri, 9 Oct 2015 02:49:19 +0000"  >&lt;p&gt;I met the same problem in 5.8 . I wonder  how did you resolve your problem in 5.10 , Using the workaround by set the schedulerSupport=false  ?&lt;br/&gt;
I will always use KahaDB and even sometimes need the scheduler function . &lt;br/&gt;
Would you please share some of your good experience ?  Thanks&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12537142">AMQ-3648</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12461872" name="activemq-data.zip" size="41621" author="andyg" created="Thu, 23 Sep 2010 13:35:16 +0000"/>
                            <attachment id="12461859" name="activemq.xml" size="1412" author="andyg" created="Thu, 23 Sep 2010 12:58:29 +0000"/>
                            <attachment id="12461845" name="stacktraces.txt" size="3938" author="bryanck" created="Fri, 24 Sep 2010 17:42:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14825</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 6 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ba07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63733</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>