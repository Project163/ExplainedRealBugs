<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:11:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5340] QueueBrowser with expired messages hangs until woken by expired messages background job</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5340</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I would expect browsing a queue with only a few messages to not take a long time. Indeed it normally takes only a few ms. in my application. But sometimes the ActiveMQQueueBrowser hangs for up to 30 seconds at method before returning!&lt;/p&gt;

&lt;p&gt;When the issue occurs, the loop in hasMoreElements() calls waitForMessage() multiple times which times out after 2s at semaphore.wait(2000) without receiving any message from the broker. I found that when the broker&apos;s background job that checks for expired messages runs, the browser happens to be woken even if there are no expired messages. So setting the expireMessagesPeriod to a low value (e.g. 200ms) is a good workaround for this issue, but this is quite brittle because it uses internal broker implementation that may not even be related to the issue!&lt;/p&gt;

&lt;p&gt;To reproduce:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;(this is what I do in my application) create a queue, send a few message with an expiration time of 10 seconds and repeatedly browse it until it is empty. If I browse the queue after these 10 seconds have passed, the issue occurs!&lt;/li&gt;
	&lt;li&gt;I can always reproduce the issue by running AMQ580BrowsingBug from the related bug report &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4595&quot; title=&quot;QueueBrowser hangs when browsing large queues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4595&quot;&gt;&lt;del&gt;AMQ-4595&lt;/del&gt;&lt;/a&gt;: this browsing test seems to always hang. I slightly adjusted the test so you can easily change the expired messages period and see the runtime differ when changing this.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12738296">AMQ-5340</key>
            <summary>QueueBrowser with expired messages hangs until woken by expired messages background job</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="slowstrider">Vermeulen</reporter>
                        <labels>
                            <label>QueueBrowser</label>
                    </labels>
                <created>Mon, 1 Sep 2014 16:08:15 +0000</created>
                <updated>Tue, 15 Sep 2015 12:58:19 +0000</updated>
                            <resolved>Mon, 6 Jul 2015 20:49:21 +0000</resolved>
                                    <version>5.9.0</version>
                    <version>5.10.0</version>
                                    <fixVersion>5.12.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14117526" author="slowstrider" created="Mon, 1 Sep 2014 16:12:22 +0000"  >&lt;p&gt;Attached JUnit test that shows the issue. On my machine it runs in 0.7ms when sending 50 messages using EXPIRE_MESSAGES_PERIOD = 200. With EXPIRE_MESSAGES_PERIOD = 10000 and otherwise the same settings it runs in 10.5s, with EXPIRE_MESSAGES_PERIOD = 30000 in 30.5s.&lt;/p&gt;</comment>
                            <comment id="14170401" author="gercodries" created="Tue, 14 Oct 2014 02:39:06 +0000"  >&lt;p&gt;I&apos;m experiencing this issue as well, but my messages are not expiring. Steps to reproduce on AMQ 5.10.0, default configuration - just unzip and run:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Send a few messages to a queue&lt;/li&gt;
	&lt;li&gt;Browse it repeatedly&lt;/li&gt;
	&lt;li&gt;Observe that on some browse attempts hasMoreMessages() takes a very long time (tens of seconds)&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14592505" author="christopher.l.shannon" created="Thu, 18 Jun 2015 21:07:06 +0000"  >&lt;p&gt;This is not a problem and is working as intended.  Your issue is that you are using a transaction and you never call commit so your messages are never acknowledged by the broker.  Since your messages are never acknowledged, hasMoreElements() will always return true because the QueueBrowser is never notified that it is done browsing until the expire messages task runs and removes the messages.&lt;/p&gt;

&lt;p&gt;In your test on line 115 when you create your session, if you change &lt;tt&gt;connection.createSession(true, Session.AUTO_ACKNOWLEDGE)&lt;/tt&gt; to &lt;tt&gt;connection.createSession(false, Session.AUTO_ACKNOWLEDGE&lt;/tt&gt; then your test will immediately finish and not hang.&lt;/p&gt;

&lt;p&gt; If you still want to use a transaction then you need to call commit on the session after you get each element or hasMoreElements() is never going to finish.  So you would change your loop to:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (enumeration.hasMoreElements()) {
	TextMessage m = (TextMessage) enumeration.nextElement();
	browsed++;
        session.commit();
	LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;B[{}]: {}&quot;&lt;/span&gt;, browsed, m.getText().substring(0, 100));
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14593593" author="christopher.l.shannon" created="Fri, 19 Jun 2015 16:28:48 +0000"  >&lt;p&gt;After talking with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt; about this issue, I&apos;m going to take a look and see what it would take to change the QueueBrowser behavior so it doesn&apos;t participate in a transaction since it doesn&apos;t really make sense to be transacted. &lt;/p&gt;</comment>
                            <comment id="14596157" author="slowstrider" created="Mon, 22 Jun 2015 16:19:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=christopher.l.shannon&quot; class=&quot;user-hover&quot; rel=&quot;christopher.l.shannon&quot;&gt;christopher.l.shannon&lt;/a&gt;, following your suggestion for either properly handling transactions or not using transactions solves the issue in the example I created.&lt;/p&gt;

&lt;p&gt;What is very weird is that the issue still remains in my actual application. I am using standalone Spring (3.2.5.RELEASE, no J2EE container). I use the browseSelected method of a org.springframework.jms.core.JmsTemplate that is configured with an ActiveMQConnectionFactory. As is the default, it does not use a transaction and it uses auto acknowledge.&lt;/p&gt;

&lt;p&gt;Problem also remains when I set sessionTransacted to true on the JmsTemplate and call commit after fetching each message.&lt;/p&gt;</comment>
                            <comment id="14596221" author="christopher.l.shannon" created="Mon, 22 Jun 2015 16:58:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slowstrider&quot; class=&quot;user-hover&quot; rel=&quot;slowstrider&quot;&gt;slowstrider&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;That is odd because it should work fine.  I just modified your example to use a JmsTemplate and browseSelected to browse the queue and everything works as expected and finishes in less than 1 second.  I went ahead and uploaded my change so you can see what I did.   I&apos;m using Spring version 3.2.11.RELEASE (current version in ActiveMQ&apos;s master) &lt;/p&gt;</comment>
                            <comment id="14596626" author="slowstrider" created="Mon, 22 Jun 2015 20:56:14 +0000"  >&lt;p&gt;Thank you for taking the time to solve this issue. Perhaps it&apos;s some specific configuration in my setup e.g. in activemq.xml or my Spring configuration which creates the queue. I will see if I can isolate the issue.&lt;/p&gt;</comment>
                            <comment id="14597390" author="slowstrider" created="Tue, 23 Jun 2015 09:17:55 +0000"  >&lt;p&gt;I found out what I did wrong. The AMQ5340BrowsingPerformanceBug.java does not reproduce the issue and indeed contains the bug you have mentioned. It does not actually do what I am claiming in the bug description! With a small change I can reproduce the original bug I mentioned:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;set a time to live of 1 second for the messages that are sent&lt;/li&gt;
	&lt;li&gt;set expireMessagesPeriod to 10 seconds&lt;/li&gt;
	&lt;li&gt;repeatedly browse the queue until it is empty, sleeping for 100ms in between&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;One would expect this to end after at most 1200 ms or so, but it actually runs for 10 seconds! After all messages have expired enumeration.hasMoreElements() blocks instead of immediately returning false.&lt;/p&gt;</comment>
                            <comment id="14597396" author="slowstrider" created="Tue, 23 Jun 2015 09:21:08 +0000"  >&lt;p&gt;AMQ5340BrowsingPerformanceBugCorrected actually shows the issue I&apos;m experiencing.&lt;/p&gt;</comment>
                            <comment id="14597402" author="slowstrider" created="Tue, 23 Jun 2015 09:29:36 +0000"  >&lt;p&gt;In summary: after there are expired messages, the queue browser&apos;s enumeration.hasMoreElements() blocks until the expired messages are removed by the background job.&lt;/p&gt;

&lt;p&gt;The blocking is unexpected. I would expect the enumeration to immediately return no messages at all, or perhaps alternatively immediately return the expired messages which the background job hasn&apos;t removed yet.&lt;/p&gt;</comment>
                            <comment id="14598109" author="christopher.l.shannon" created="Tue, 23 Jun 2015 18:14:42 +0000"  >&lt;p&gt;Thanks for submitting your updated test case, I can see where this an issue now.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;This is another interesting issue relating to expired messages.  The problem with this test case is the messages are added to the subscription to be dispatched but when the subscription goes to dispatch them the logic detects the messages are expired so the QueueBrowser client never gets any messages.  Unfortunately, since the QueueBrowser never receives any messages it never sends back any acks and acks are what trigger the logic to send a NULL_MESSAGE signaling the browser is done.  This happens in the iterate method in Queue.&lt;/p&gt;

&lt;p&gt;So basically the QueueBrowser needs some way to know that it will never receive any messages.  The QueueBrowser already calls off to waitForMessage() in the hasMoreElements() so using the pullCommand might work here as that would trigger the NULL_MESSAGE to get sent back.  However, right now a pull command is never sent if prefetch is greater than 0.&lt;/p&gt;</comment>
                            <comment id="14598991" author="slowstrider" created="Wed, 24 Jun 2015 07:16:18 +0000"  >&lt;p&gt;When the queue has no messages at all the browser returns immediately. This is true before sending any message as well as after the expired messages have been removed by the background job.&lt;/p&gt;</comment>
                            <comment id="14600956" author="gtully" created="Thu, 25 Jun 2015 10:06:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=christopher.l.shannon&quot; class=&quot;user-hover&quot; rel=&quot;christopher.l.shannon&quot;&gt;christopher.l.shannon&lt;/a&gt;  - it does not make sense to me that a queue browser would check expiry, it should get a snapshot of messages from its creation time.&lt;br/&gt;
maybe the simplest thing is to make the expiry check from org.apache.activemq.broker.region.PrefetchSubscription#dispatchPending conditional on not being a browser:                                &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isBrowser()  &amp;amp;&amp;amp; node!=QueueMessageReference.NULL_MESSAGE &amp;amp;&amp;amp; node.isExpired()) {&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14601121" author="christopher.l.shannon" created="Thu, 25 Jun 2015 13:03:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I agree, not checking expiry for browsers makes sense.  This almost works but it appears there is something else that would need to be changed too...The problem is when running the test case against this change, the last run breaks.  The &lt;tt&gt;enumeration.hasMoreElements()&lt;/tt&gt; returns true but the only thing pending is the NULL control message so then &lt;tt&gt;enumeration.nextElement()&lt;/tt&gt; returns null.  It&apos;s detecting that no new messages were added in the iterate() method in Queue and calling brwoser.decrementQueueRef() which sends the NULL control message.  I haven&apos;t looked at it yet to figure out why it&apos;s doing that.&lt;/p&gt;</comment>
                            <comment id="14614928" author="githubbot" created="Mon, 6 Jul 2015 11:50:31 +0000"  >&lt;p&gt;GitHub user cshannon opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/127&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/127&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5340&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5340&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    A QueueBrowser no longer checks expiry on messages to prevent a&lt;br/&gt;
    browser from hanging in between the hasMoreElements check and actually&lt;br/&gt;
    getting a message.  This means that if messages were in the queue when&lt;br/&gt;
    the browser started it will receive messages even if they are now&lt;br/&gt;
    expired. Even though the browser will get the expired message, the&lt;br/&gt;
    broker will still expire it to prevent future access to it.&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/cshannon/activemq&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cshannon/activemq&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5340&quot; title=&quot;QueueBrowser with expired messages hangs until woken by expired messages background job&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5340&quot;&gt;&lt;del&gt;AMQ-5340&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/127.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/127.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #127&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ebac24a95870fda9de760709ffb5533adaa5c7f7&lt;br/&gt;
Author: Christopher L. Shannon &amp;lt;christopher.l.shannon@gmail.com&amp;gt;&lt;br/&gt;
Date:   2015-07-06T02:11:23Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5340&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5340&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    A QueueBrowser no longer checks expiry on messages to prevent a&lt;br/&gt;
    browser from hanging in between the hasMoreElements check and actually&lt;br/&gt;
    getting a message.  This means that if messages were in the queue when&lt;br/&gt;
    the browser started it will receive messages even if they are now&lt;br/&gt;
    expired. Even though the browser will get the expired message, the&lt;br/&gt;
    broker will still expire it to prevent future access to it.&lt;/p&gt;

&lt;p&gt;    Thanks to Henno Vermeulen for providing a test case.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14614930" author="christopher.l.shannon" created="Mon, 6 Jul 2015 11:53:14 +0000"  >&lt;p&gt;I finally got some time to come back to this.  I created a PR so that a queue browser now ignores expiration but the broker will still expire the message on dispatch.  This way the browser will get a snapshot when started and prevent it from hanging but any future calls (a new browser, etc) won&apos;t get the messages as they have expired on the broker end.  &lt;/p&gt;</comment>
                            <comment id="14615582" author="githubbot" created="Mon, 6 Jul 2015 20:23:18 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/127&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/127&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14615633" author="tabish121" created="Mon, 6 Jul 2015 20:49:21 +0000"  >&lt;p&gt;Fix applied, thanks!&lt;/p&gt;</comment>
                            <comment id="14745411" author="slowstrider" created="Tue, 15 Sep 2015 12:58:19 +0000"  >&lt;p&gt;Thank you for solving this, I upgraded to ActiveMQ 5.12.0 and my tests now succeed while they fail in 5.10.0.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12654150">AMQ-4595</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12855644">AMQNET-505</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12845735">AMQCPP-576</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12665787" name="AMQ5340BrowsingPerformanceBug.java" size="4967" author="slowstrider" created="Mon, 1 Sep 2014 16:12:22 +0000"/>
                            <attachment id="12741255" name="AMQ5340BrowsingPerformanceBugCorrected.java" size="5742" author="slowstrider" created="Tue, 23 Jun 2015 09:21:08 +0000"/>
                            <attachment id="12741070" name="AMQ5340BrowsingWithSpring.java" size="5097" author="cshannon" created="Mon, 22 Jun 2015 16:57:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 10 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1zk2f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>