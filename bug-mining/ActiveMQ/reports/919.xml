<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:46:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2749] Broker hangs in TopicSubscription.add</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2749</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Our broker suddenly hang in production environment. We created a bunch of jstacks to see what the reason is.&lt;/p&gt;

&lt;p&gt;The jstacks show that the broker waits with many threads in doMessageSend:&lt;/p&gt;

&lt;p&gt;e.g.&lt;br/&gt;
&quot;ActiveMQ Transport: tcp:///10.231.233.117:51088&quot; daemon prio=10 tid=0x00002aab84016800 nid=0x1f19 waiting for monitor entry &lt;span class=&quot;error&quot;&gt;&amp;#91;0x000000006a8f2000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: BLOCKED (on object monitor)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic.doMessageSend(Topic.java:402)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00002aaab46f8938&amp;gt; (a org.apache.activemq.broker.region.Topic)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic.send(Topic.java:384)&lt;br/&gt;
	at org.apache.activemq.broker.region.DestinationFilter.send(DestinationFilter.java:93)&lt;br/&gt;
	at org.apache.activemq.broker.region.virtual.VirtualTopicInterceptor.send(VirtualTopicInterceptor.java:46)&lt;br/&gt;
	at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:354)&lt;br/&gt;
	at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:445)&lt;br/&gt;
	at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:224)&lt;br/&gt;
	at org.apache.activemq.advisory.AdvisoryBroker.fireAdvisory(AdvisoryBroker.java:443)&lt;br/&gt;
	at org.apache.activemq.advisory.AdvisoryBroker.fireAdvisory(AdvisoryBroker.java:373)&lt;br/&gt;
	at org.apache.activemq.advisory.AdvisoryBroker.fireAdvisory(AdvisoryBroker.java:368)&lt;br/&gt;
	at org.apache.activemq.advisory.AdvisoryBroker.addDestinationInfo(AdvisoryBroker.java:173)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.addDestinationInfo(BrokerFilter.java:214)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.addDestinationInfo(BrokerFilter.java:214)&lt;br/&gt;
	at org.apache.activemq.broker.MutableBrokerFilter.addDestinationInfo(MutableBrokerFilter.java:221)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.processAddDestination(TransportConnection.java:467)&lt;br/&gt;
	at org.apache.activemq.command.DestinationInfo.visit(DestinationInfo.java:122)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:300)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:178)&lt;br/&gt;
	at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.StompTransportFilter.sendToActiveMQ(StompTransportFilter.java:82)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.ProtocolConverter.sendToActiveMQ(ProtocolConverter.java:135)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.ProtocolConverter.createTempQueue(ProtocolConverter.java:611)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.LegacyFrameTranslator.convertDestination(LegacyFrameTranslator.java:130)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.FrameTranslator$Helper.copyStandardHeadersFromFrameToMessage(FrameTranslator.java:93)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.LegacyFrameTranslator.convertFrame(LegacyFrameTranslator.java:54)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.ProtocolConverter.convertMessage(ProtocolConverter.java:591)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.ProtocolConverter.onStompSend(ProtocolConverter.java:231)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommand(ProtocolConverter.java:173)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.StompTransportFilter.onCommand(StompTransportFilter.java:71)&lt;br/&gt;
	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:204)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:186)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;It is waiting to lock 0x00002aaab46f8938. This is the thread that holds the lock:&lt;/p&gt;

&lt;p&gt;&quot;ActiveMQ Transport: tcp:///10.231.233.117:43020&quot; daemon prio=10 tid=0x00000000608d8800 nid=0xc6e in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0x000000007d41c000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: TIMED_WAITING (on object monitor)&lt;br/&gt;
	at java.lang.Object.wait(Native Method)&lt;br/&gt;
	at org.apache.activemq.broker.region.TopicSubscription.add(TopicSubscription.java:106)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked &amp;lt;0x00002aaab57d34e8&amp;gt; (a java.lang.Object)&lt;br/&gt;
	at org.apache.activemq.broker.region.policy.SimpleDispatchPolicy.dispatch(SimpleDispatchPolicy.java:49)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00002aaab46f98e0&amp;gt; (a java.util.concurrent.CopyOnWriteArrayList)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic.dispatch(Topic.java:585)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic.doMessageSend(Topic.java:443)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00002aaab46f8938&amp;gt; (a org.apache.activemq.broker.region.Topic)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic.send(Topic.java:384)&lt;br/&gt;
	at org.apache.activemq.broker.region.DestinationFilter.send(DestinationFilter.java:93)&lt;br/&gt;
	at org.apache.activemq.broker.region.virtual.VirtualTopicInterceptor.send(VirtualTopicInterceptor.java:46)&lt;br/&gt;
	at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:354)&lt;br/&gt;
	at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:445)&lt;br/&gt;
	at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:224)&lt;br/&gt;
	at org.apache.activemq.advisory.AdvisoryBroker.fireAdvisory(AdvisoryBroker.java:443)&lt;br/&gt;
	at org.apache.activemq.advisory.AdvisoryBroker.fireAdvisory(AdvisoryBroker.java:373)&lt;br/&gt;
	at org.apache.activemq.advisory.AdvisoryBroker.fireAdvisory(AdvisoryBroker.java:368)&lt;br/&gt;
	at org.apache.activemq.advisory.AdvisoryBroker.removeDestination(AdvisoryBroker.java:185)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.removeDestination(BrokerFilter.java:146)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.removeDestination(BrokerFilter.java:146)&lt;br/&gt;
	at org.apache.activemq.broker.MutableBrokerFilter.removeDestination(MutableBrokerFilter.java:153)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.processRemoveConnection(TransportConnection.java:713)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00002aaac32b10c0&amp;gt; (a org.apache.activemq.broker.jmx.ManagedTransportConnection)&lt;br/&gt;
	at org.apache.activemq.command.RemoveInfo.visit(RemoveInfo.java:72)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:300)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:178)&lt;br/&gt;
	at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.StompTransportFilter.sendToActiveMQ(StompTransportFilter.java:82)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.ProtocolConverter.sendToActiveMQ(ProtocolConverter.java:135)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.ProtocolConverter.onStompDisconnect(ProtocolConverter.java:545)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommand(ProtocolConverter.java:189)&lt;br/&gt;
	at org.apache.activemq.transport.stomp.StompTransportFilter.onCommand(StompTransportFilter.java:71)&lt;br/&gt;
	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:204)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:186)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;So it is the client 10.231.233.117 that has a stomp-connection to the broker, causes a TopicSubscription.add and causes the broker freeze. &lt;/p&gt;

&lt;p&gt;This is how we configure our openwire transport-connector in the activemq.xml:&lt;br/&gt;
        &amp;lt;transportConnectors&amp;gt;&lt;br/&gt;
            &amp;lt;transportConnector name=&quot;openwire&quot; uri=&quot;tcp://0.0.0.0:61616&quot;/&amp;gt;&lt;br/&gt;
            &amp;lt;transportConnector name=&quot;stomp&quot; uri=&quot;stomp://0.0.0.0:61613&quot;/&amp;gt;&lt;br/&gt;
        &amp;lt;/transportConnectors&amp;gt;&lt;/p&gt;

&lt;p&gt;We took jstack-dumps with a distance of 9 minutes. Both are attached. In both dumps it is the same TopicSubscription.add that causes the hang.&lt;/p&gt;

&lt;p&gt;How can we solve this issue? Looks like the connection should run into an timeout but doesn&apos;t. Is this an activemq bug? Can we somehow set the broker openwire timeout parameters?&lt;/p&gt;

&lt;p&gt;Thanks for any hints.&lt;/p&gt;</description>
                <environment>&lt;p&gt;red had enterprise&lt;/p&gt;</environment>
        <key id="12483574">AMQ-2749</key>
            <summary>Broker hangs in TopicSubscription.add</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jteetel">Dennis Klinkott</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 May 2010 17:49:47 +0000</created>
                <updated>Mon, 11 Jul 2011 21:22:39 +0000</updated>
                            <resolved>Mon, 11 Jul 2011 21:22:39 +0000</resolved>
                                    <version>5.3.1</version>
                                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12942729" author="jteetel" created="Wed, 26 May 2010 10:34:37 +0000"  >&lt;p&gt;Now we got the same problem on a preprod machine.&lt;/p&gt;

&lt;p&gt;This time it is not a stomp connection that causes the freeze.&lt;/p&gt;

&lt;p&gt;This is the thread that holds the lock that blocks all other threads:&lt;/p&gt;

&lt;p&gt;&quot;ActiveMQ Transport: tcp:///10.231.243.16:57992&quot; daemon prio=10 tid=0x00002ab309c44800 nid=0xd40 in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00002ab364174000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: TIMED_WAITING (on object monitor)&lt;br/&gt;
	at java.lang.Object.wait(Native Method)&lt;br/&gt;
	at org.apache.activemq.broker.region.TopicSubscription.add(TopicSubscription.java:106)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked &amp;lt;0x00002aab30c0e238&amp;gt; (a java.lang.Object)&lt;br/&gt;
	at org.apache.activemq.broker.region.policy.SimpleDispatchPolicy.dispatch(SimpleDispatchPolicy.java:49)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00002aaab3f5eaa8&amp;gt; (a java.util.concurrent.CopyOnWriteArrayList)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic.dispatch(Topic.java:585)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic.doMessageSend(Topic.java:443)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00002aaab3f5de00&amp;gt; (a org.apache.activemq.broker.region.Topic)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic.send(Topic.java:384)&lt;br/&gt;
	at org.apache.activemq.broker.region.DestinationFilter.send(DestinationFilter.java:93)&lt;br/&gt;
	at org.apache.activemq.broker.region.virtual.VirtualTopicInterceptor.send(VirtualTopicInterceptor.java:46)&lt;br/&gt;
	at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:354)&lt;br/&gt;
	at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:445)&lt;br/&gt;
	at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:224)&lt;br/&gt;
	at org.apache.activemq.advisory.AdvisoryBroker.fireAdvisory(AdvisoryBroker.java:443)&lt;br/&gt;
	at org.apache.activemq.advisory.AdvisoryBroker.fireAdvisory(AdvisoryBroker.java:373)&lt;br/&gt;
	at org.apache.activemq.advisory.AdvisoryBroker.addConsumer(AdvisoryBroker.java:116)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.addConsumer(BrokerFilter.java:86)&lt;br/&gt;
	at org.apache.activemq.broker.MutableBrokerFilter.addConsumer(MutableBrokerFilter.java:93)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.processAddConsumer(TransportConnection.java:533)&lt;br/&gt;
	at org.apache.activemq.command.ConsumerInfo.visit(ConsumerInfo.java:349)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:300)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:178)&lt;br/&gt;
	at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)&lt;br/&gt;
	at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113)&lt;br/&gt;
	at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:216)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00002aab2fd02060&amp;gt; (a org.apache.activemq.transport.InactivityMonitor$1)&lt;br/&gt;
	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:204)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:186)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I wonder how TopicSubscription.add can freeze?&lt;/p&gt;</comment>
                            <comment id="12942730" author="gtully" created="Wed, 26 May 2010 10:47:08 +0000"  >&lt;p&gt;from the code: &lt;a href=&quot;http://svn.apache.org/viewvc/activemq/tags/activemq-5.3.1/activemq-core/src/main/java/org/apache/activemq/broker/region/TopicSubscription.java?view=markup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/activemq/tags/activemq-5.3.1/activemq-core/src/main/java/org/apache/activemq/broker/region/TopicSubscription.java?view=markup&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;it looks like u have reached the temp store or memory limit on the pending message cursor. which it is depends on the pending message cursor u are using. &lt;/p&gt;</comment>
                            <comment id="12942735" author="jteetel" created="Wed, 26 May 2010 12:02:19 +0000"  >&lt;p&gt;I&apos;ve attached our activemq.xml and a screenshot of a jmx console to a similar broker that is running since 5 days.&lt;/p&gt;

&lt;p&gt;we do not have any warnings or errors in the log.&lt;/p&gt;

&lt;p&gt;if we reached the temp store or memory limit on the pending message cursor, would we get a warning log entry?&lt;/p&gt;</comment>
                            <comment id="12942732" author="gtully" created="Wed, 26 May 2010 16:33:49 +0000"  >&lt;p&gt;I just added a log message if the subscription is blocked as in your stack trace to trunk. r948489. will be in tonights 5.4-SNAPSHOT&lt;br/&gt;
While u don&apos;t have any usage limits specified, there are some default values, 64M memory, 10G temp and 100G store. Would you be using that much temp space?&lt;/p&gt;</comment>
                            <comment id="12942736" author="jteetel" created="Thu, 27 May 2010 09:32:56 +0000"  >&lt;p&gt;We might have reached the 64M memory limit. &lt;/p&gt;

&lt;p&gt;We changed our configuration and specified a high memory limit. Hopefully this will solve our issue.&lt;/p&gt;</comment>
                            <comment id="13063551" author="tabish121" created="Mon, 11 Jul 2011 21:22:39 +0000"  >&lt;p&gt;Configuration issue, broker was reaching its memory limits.  &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461710" name="activemq.xml" size="3689" author="jteetel" created="Wed, 26 May 2010 11:54:58 +0000"/>
                            <attachment id="12461711" name="jmx console screenshot.jpg" size="225194" author="jteetel" created="Wed, 26 May 2010 11:58:48 +0000"/>
                            <attachment id="12461708" name="jstack.2010-05-25-14-01-30" size="1375230" author="jteetel" created="Tue, 25 May 2010 17:52:29 +0000"/>
                            <attachment id="12461709" name="jstack.2010-05-25-14-10-54" size="1429914" author="jteetel" created="Tue, 25 May 2010 17:52:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>68353</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 20 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0tvh3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>172408</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>