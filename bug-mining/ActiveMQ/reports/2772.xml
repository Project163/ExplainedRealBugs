<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:33:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5785] Deadlock between FilePendingMessageCursor usage change and incoming send operations.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5785</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;During the peak loads we are encountering a recurring deadlock issue in ActiveMQ broker. The threads that are deadlocked are &lt;br/&gt;
ActiveMQ  NIO Worker - trying to add message to FilePendingCursor&lt;br/&gt;
Broker.Service Worker - that is trying to expire message from FilePendingCursor.&lt;/p&gt;

&lt;p&gt;=============================&lt;br/&gt;
Found one Java-level deadlock:&lt;br/&gt;
=============================&lt;br/&gt;
&quot;ActiveMQ NIO Worker 1003&quot;:&lt;br/&gt;
  waiting to lock monitor 0x00002aeeb515a4f8 (object 0x00000007807da3e8, a org.apache.activemq.broker.region.cursors.FilePendingMessageCursor),&lt;br/&gt;
  which is held by &quot;ActiveMQ BrokerService.worker.1&quot;&lt;br/&gt;
&quot;ActiveMQ BrokerService.worker.1&quot;:&lt;br/&gt;
  waiting for ownable synchronizer 0x000000077ac84b40, (a java.util.concurrent.locks.ReentrantReadWriteLock$NonfairSync),&lt;br/&gt;
  which is held by &quot;ActiveMQ NIO Worker 1003&quot;&lt;/p&gt;

&lt;p&gt;Java stack information for the threads listed above:&lt;br/&gt;
===================================================&lt;br/&gt;
&quot;ActiveMQ NIO Worker 1003&quot;:&lt;br/&gt;
	at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.addMessageLast(FilePendingMessageCursor.java:207)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00000007807da3e8&amp;gt; (a org.apache.activemq.broker.region.cursors.FilePendingMessageCursor)&lt;br/&gt;
	at org.apache.activemq.broker.region.cursors.StoreQueueCursor.addMessageLast(StoreQueueCursor.java:96)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000007784e8c88&amp;gt; (a org.apache.activemq.broker.region.cursors.StoreQueueCursor)&lt;br/&gt;
	at org.apache.activemq.broker.region.Queue.sendMessage(Queue.java:1855)&lt;br/&gt;
	at org.apache.activemq.broker.region.Queue.doMessageSend(Queue.java:939)&lt;br/&gt;
	at org.apache.activemq.broker.region.Queue.send(Queue.java:733)&lt;br/&gt;
	at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:424)&lt;br/&gt;
	at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:445)&lt;br/&gt;
	at org.apache.activemq.broker.jmx.ManagedRegionBroker.send(ManagedRegionBroker.java:297)&lt;br/&gt;
	at org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:96)&lt;br/&gt;
	at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:307)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:147)&lt;br/&gt;
	at org.apache.activemq.broker.UserIDBroker.send(UserIDBroker.java:56)&lt;br/&gt;
	at org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:152)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:496)&lt;br/&gt;
	at org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:756)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:294)&lt;br/&gt;
	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:148)&lt;br/&gt;
	at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)&lt;br/&gt;
	at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113)&lt;br/&gt;
	at org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:270)&lt;br/&gt;
	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)&lt;br/&gt;
	at org.apache.activemq.transport.nio.NIOTransport.serviceRead(NIOTransport.java:138)&lt;br/&gt;
	at org.apache.activemq.transport.nio.NIOTransport$1.onSelect(NIOTransport.java:69)&lt;br/&gt;
	at org.apache.activemq.transport.nio.SelectorSelection.onSelect(SelectorSelection.java:94)&lt;br/&gt;
	at org.apache.activemq.transport.nio.SelectorWorker$1.run(SelectorWorker.java:119)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:744)&lt;br/&gt;
&quot;ActiveMQ BrokerService.worker.1&quot;:&lt;br/&gt;
	at sun.misc.Unsafe.park(Native Method)&lt;/li&gt;
	&lt;li&gt;parking to wait for  &amp;lt;0x000000077ac84b40&amp;gt; (a java.util.concurrent.locks.ReentrantReadWriteLock$NonfairSync)&lt;br/&gt;
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)&lt;br/&gt;
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:834)&lt;br/&gt;
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:867)&lt;br/&gt;
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1197)&lt;br/&gt;
	at java.util.concurrent.locks.ReentrantReadWriteLock$WriteLock.lock(ReentrantReadWriteLock.java:945)&lt;br/&gt;
	at org.apache.activemq.broker.region.Queue.messageExpired(Queue.java:1841)&lt;br/&gt;
	at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.discardExpiredMessage(FilePendingMessageCursor.java:474)&lt;br/&gt;
	at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.expireOldMessages(FilePendingMessageCursor.java:420)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000007807da3e8&amp;gt; (a org.apache.activemq.broker.region.cursors.FilePendingMessageCursor)&lt;br/&gt;
	at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.onUsageChanged(FilePendingMessageCursor.java:398)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000007807da3e8&amp;gt; (a org.apache.activemq.broker.region.cursors.FilePendingMessageCursor)&lt;br/&gt;
	at org.apache.activemq.usage.Usage$1.run(Usage.java:304)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:744)&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>&lt;p&gt;Physical Machine (192 GB RAM, 24 VCPU), RHEL 5.9, Java 1.7&lt;br/&gt;
ActiveMQ runs on 4 GB heap&lt;/p&gt;</environment>
        <key id="12831373">AMQ-5785</key>
            <summary>Deadlock between FilePendingMessageCursor usage change and incoming send operations.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="sreepanchajanyam">Sree Panchajanyam D</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 May 2015 13:21:20 +0000</created>
                <updated>Wed, 26 Oct 2016 08:38:10 +0000</updated>
                            <resolved>Tue, 8 Mar 2016 21:53:18 +0000</resolved>
                                    <version>5.10.0</version>
                                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14552309" author="sreepanchajanyam" created="Wed, 20 May 2015 13:24:41 +0000"  >&lt;p&gt;Attaching the thread dump. This issue is occurring everyday at peak hours. We have upgraded to 5.10.0 from 5.6.0 about 4 months ago. This issue has started occurring since a week.  &lt;/p&gt;</comment>
                            <comment id="14553030" author="christopher.l.shannon" created="Wed, 20 May 2015 20:18:55 +0000"  >&lt;p&gt;This appears to probably be the same race condition issue I reported here: &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5712&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5712&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt; uploaded a patch to that Jira that I&apos;ve been running for a while and it has solved the deadlock problem for me.  It hasn&apos;t been committed to master yet but if you don&apos;t mind applying the patch yourself it should at least help you stop the deadlock until it gets fixed permanently.&lt;/p&gt;</comment>
                            <comment id="14555231" author="tabish121" created="Thu, 21 May 2015 23:09:30 +0000"  >&lt;p&gt;Given this is logged against 5.10 it may be a different issue so it&apos;d be a good idea to try out a later release 5.11.1+&lt;/p&gt;</comment>
                            <comment id="14558776" author="sreepanchajanyam" created="Tue, 26 May 2015 07:22:37 +0000"  >&lt;p&gt;Agree with Timothy. This seems to be a different issue. This issue occurs in one of our several AMQ environments and cannot be replicated anywhere else.&lt;/p&gt;

&lt;p&gt;I can go with the upgrade if I can find a root cause of the issue and for sure know that 5.11.1 will fix it as an AMQ upgrade in our environment is non trivial.&lt;br/&gt;
The issue again occurred yesterday and the thread dumps from yesterday tell the same story. If you need any activemq logs either in trace/debug mode I will be able to attach them here.&lt;/p&gt;

&lt;p&gt;I am going through the ActiveMQ source code to corner this issue. Any pointers/help in this regard is greatly appreciated.&lt;/p&gt;</comment>
                            <comment id="14559016" author="christopher.l.shannon" created="Tue, 26 May 2015 11:59:09 +0000"  >&lt;p&gt;Yes, I think you are right that it is different.  At first glance it looked like the same issue based on the addMessageLast thread being the same.  The patch I suggested helps with timing out while waiting to add a message on a store, but this is different. &lt;/p&gt;

&lt;p&gt;Based on your thread dump, the NIO worker has acquired the &lt;tt&gt;messagesLock&lt;/tt&gt; in the &lt;tt&gt;sendMessage&lt;/tt&gt; method of the Queue class (line 1853 in the Queue.java) and is waiting on the intrinsic lock of FilePendingMessageCursor on the &lt;tt&gt;addMessageLast&lt;/tt&gt; method (line 207 in FilePendingMessageCursor.java).  The BrokerService thread has acquired the intrinsic lock of FilePendingMessageCursor in &lt;tt&gt;onUsageChanged&lt;/tt&gt; (line 394 of FilePendingMessageCursor.java)  and is waiting on &lt;tt&gt;messagesLock&lt;/tt&gt; in the &lt;tt&gt;messageExpired&lt;/tt&gt; method (line 1841 of Queue.java)....a pretty classic deadlock.  In version 5.11.1 some of this has been refactored a bit, &lt;tt&gt;sendMessage&lt;/tt&gt; method has been replaced with &lt;tt&gt;cursorAdd&lt;/tt&gt;, etc.  However, at a glance I think the deadlock issue would still exist in 5.11.1.&lt;/p&gt;

&lt;p&gt;Tim, do you think it would be worth replacing the &lt;tt&gt;messagesLock.writeLock().lock()&lt;/tt&gt; calls with &lt;tt&gt;messagesLock.writeLock().tryLock()&lt;/tt&gt; and handle the lock timeout to prevent a potential deadlock?&lt;/p&gt;

</comment>
                            <comment id="15185105" author="gtully" created="Tue, 8 Mar 2016 15:41:18 +0000"  >&lt;p&gt;it looks like the onUsageChanged of the filecursor needs to remove expired messages from the cursor and then process them as expired &lt;b&gt;without&lt;/b&gt; holding the cursor lock. So break out discardExpiredMessages from expireOldMessages and call discardExpiredMessages with some list, without the lock&lt;/p&gt;</comment>
                            <comment id="15185454" author="jira-bot" created="Tue, 8 Mar 2016 18:38:54 +0000"  >&lt;p&gt;Commit 8b23e072eeab2beebf62fd267bf8d9f88d05b5c2 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=8b23e07&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=8b23e07&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5785&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5785&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Avoid holding the intrinsic lock on the cursor when expiring the&lt;br/&gt;
messages.  &lt;/p&gt;</comment>
                            <comment id="15185493" author="christopher.l.shannon" created="Tue, 8 Mar 2016 18:54:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; , Good idea, I meant to come back to this issue and take a closer look at solving it but it got lost in the backlog. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15607861" author="mkubricht" created="Wed, 26 Oct 2016 08:38:10 +0000"  >&lt;p&gt;Reviewing the commit I found that it introduces new mistake.&lt;br/&gt;
I believe that commit solves the deadlock problem, but...&lt;/p&gt;

&lt;p&gt;It breaks original implementation of method &lt;tt&gt;expireOldMessages()&lt;/tt&gt; which is:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;still used by other methods - &lt;tt&gt;tryAddMessageLast(MessageReference, long)&lt;/tt&gt;, &lt;tt&gt;addMessageFirst(MessageReference)&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;protected, so potentially used by extending classes&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Problem caused by changing &lt;tt&gt;expireOldMessages()&lt;/tt&gt; is that it breaks the functionality of freeing space when adding new messages to the cursor. Currently after this fix it only creates a an unnecessary load of expired messages to the list which is never used.&lt;/p&gt;

&lt;p&gt;Commenting on these lines in code (which are shared by both addMessageX methods):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!hasSpace()) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isDiskListEmpty()) {
      expireOldMessages(); &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will not clear anything!
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (hasSpace()) { &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; probably won&apos;t happen
&lt;/span&gt;        memoryList.addMessageFirst(node);
        node.incrementReferenceCount();
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; { &lt;span class=&quot;code-comment&quot;&gt;// will always fallback to flushing data to disk
&lt;/span&gt;        flushToDisk();
      }
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12734128" name="threaddump16214.txt" size="4294043" author="sreepanchajanyam" created="Wed, 20 May 2015 13:24:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 3 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ezkn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>