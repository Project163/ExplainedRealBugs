<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:34:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1467] Deadlock between FilePendingMessageCursor and MemoryUsage</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1467</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Deadlock detected by jconsole. Fairly easy to reproduce with a maven-perf-test-plugin using journaled jdbc persistence. Using the latest 5.0-SNAPSHOT build&lt;/p&gt;


&lt;p&gt;ActiveMQ Task&lt;br/&gt;
Name: ActiveMQ Task&lt;br/&gt;
State: BLOCKED on java.lang.Object@1ba1894 owned by: ActiveMQ Transport: tcp:///167.235.7.27:4215&lt;br/&gt;
Total blocked: 1,001  Total waited: 1,002&lt;/p&gt;

&lt;p&gt;Stack trace: &lt;br/&gt;
org.apache.activemq.usage.MemoryUsage.increaseUsage(MemoryUsage.java:126)&lt;br/&gt;
org.apache.activemq.usage.MemoryUsage.increaseUsage(MemoryUsage.java:122)&lt;br/&gt;
org.apache.activemq.command.Message.incrementReferenceCount(Message.java:585)&lt;br/&gt;
org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.next(FilePendingMessageCursor.java:198)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked org.apache.activemq.broker.region.cursors.FilePendingMessageCursor@1347d75&lt;br/&gt;
org.apache.activemq.broker.region.cursors.StoreQueueCursor.next(StoreQueueCursor.java:129)&lt;/li&gt;
	&lt;li&gt;locked org.apache.activemq.broker.region.cursors.StoreQueueCursor@14f3d22&lt;br/&gt;
org.apache.activemq.broker.region.Queue.buildList(Queue.java:1020)&lt;/li&gt;
	&lt;li&gt;locked org.apache.activemq.broker.region.cursors.StoreQueueCursor@14f3d22&lt;/li&gt;
	&lt;li&gt;locked org.apache.activemq.broker.region.Queue@1b2591c&lt;br/&gt;
org.apache.activemq.broker.region.Queue.doPageIn(Queue.java:1002)&lt;br/&gt;
org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1065)&lt;br/&gt;
org.apache.activemq.broker.region.Queue.iterate(Queue.java:938)&lt;br/&gt;
org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:118)&lt;br/&gt;
org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:42)&lt;br/&gt;
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:885)&lt;br/&gt;
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
java.lang.Thread.run(Thread.java:619)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;ActiveMQ Transport: tcp://....:xxxx&lt;br/&gt;
Name: ActiveMQ Transport: tcp:///167.235.7.27:4215&lt;br/&gt;
State: BLOCKED on org.apache.activemq.broker.region.cursors.FilePendingMessageCursor@1347d75 owned by: ActiveMQ Task&lt;br/&gt;
Total blocked: 46  Total waited: 2&lt;/p&gt;

&lt;p&gt;Stack trace: &lt;br/&gt;
org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.onUsageChanged(FilePendingMessageCursor.java:260)&lt;br/&gt;
org.apache.activemq.usage.Usage.fireEvent(Usage.java:254)&lt;br/&gt;
org.apache.activemq.usage.Usage.setPercentUsage(Usage.java:224)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked java.lang.Object@1ba1894&lt;br/&gt;
org.apache.activemq.usage.MemoryUsage.decreaseUsage(MemoryUsage.java:149)&lt;br/&gt;
org.apache.activemq.usage.MemoryUsage.decreaseUsage(MemoryUsage.java:142)&lt;br/&gt;
org.apache.activemq.command.Message.decrementReferenceCount(Message.java:601)&lt;/li&gt;
	&lt;li&gt;locked org.apache.activemq.command.ActiveMQTextMessage@960b08&lt;br/&gt;
org.apache.activemq.broker.region.IndirectMessageReference.drop(IndirectMessageReference.java:137)&lt;/li&gt;
	&lt;li&gt;locked org.apache.activemq.broker.region.IndirectMessageReference@ae7918&lt;br/&gt;
org.apache.activemq.broker.region.QueueSubscription.acknowledge(QueueSubscription.java:56)&lt;br/&gt;
org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:193)&lt;/li&gt;
	&lt;li&gt;locked org.apache.activemq.broker.region.QueueSubscription@1e13a2c&lt;br/&gt;
org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:340)&lt;br/&gt;
org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:427)&lt;br/&gt;
org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194)&lt;br/&gt;
org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:73)&lt;br/&gt;
org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:73)&lt;br/&gt;
org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:87)&lt;br/&gt;
org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:478)&lt;br/&gt;
org.apache.activemq.command.MessageAck.visit(MessageAck.java:196)&lt;br/&gt;
org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:319)&lt;br/&gt;
org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:216)&lt;br/&gt;
org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:67)&lt;br/&gt;
org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:134)&lt;br/&gt;
org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:124)&lt;/li&gt;
	&lt;li&gt;locked org.apache.activemq.transport.InactivityMonitor$1@10e2558&lt;br/&gt;
org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)&lt;br/&gt;
org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:183)&lt;br/&gt;
org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:170)&lt;br/&gt;
java.lang.Thread.run(Thread.java:619)&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12482116">AMQ-1467</key>
            <summary>Deadlock between FilePendingMessageCursor and MemoryUsage</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="nickysandhu">Nicky Sandhu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Oct 2007 16:16:54 +0000</created>
                <updated>Fri, 19 Oct 2007 19:07:42 +0000</updated>
                            <resolved>Fri, 19 Oct 2007 19:07:42 +0000</resolved>
                                                    <fixVersion>5.0.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12939102" author="nickysandhu" created="Tue, 16 Oct 2007 16:52:56 +0000"  >&lt;p&gt;The above stack trace could not be correlated to revision number. here&apos;s the stack trace with activemq-core revision # 585186&lt;br/&gt;
----------------- Thread : ActiveMQ Task ----------------------------------&lt;br/&gt;
Name: ActiveMQ Task&lt;br/&gt;
State: BLOCKED on java.lang.Object@fcc6e8 owned by: ActiveMQ Transport: tcp:///167.235.7.27:4773&lt;br/&gt;
Total blocked: 4,249  Total waited: 4,257&lt;/p&gt;

&lt;p&gt;Stack trace: &lt;br/&gt;
org.apache.activemq.usage.MemoryUsage.decreaseUsage(MemoryUsage.java:146)&lt;br/&gt;
org.apache.activemq.usage.MemoryUsage.decreaseUsage(MemoryUsage.java:142)&lt;br/&gt;
org.apache.activemq.command.Message.decrementReferenceCount(Message.java:602)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked org.apache.activemq.command.ActiveMQTextMessage@450ae7&lt;br/&gt;
org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.remove(FilePendingMessageCursor.java:209)&lt;/li&gt;
	&lt;li&gt;locked org.apache.activemq.broker.region.cursors.FilePendingMessageCursor@166c37e&lt;br/&gt;
org.apache.activemq.broker.region.cursors.StoreQueueCursor.remove(StoreQueueCursor.java:135)&lt;/li&gt;
	&lt;li&gt;locked org.apache.activemq.broker.region.cursors.StoreQueueCursor@cece16&lt;br/&gt;
org.apache.activemq.broker.region.Queue.buildList(Queue.java:1021)&lt;/li&gt;
	&lt;li&gt;locked org.apache.activemq.broker.region.cursors.StoreQueueCursor@cece16&lt;/li&gt;
	&lt;li&gt;locked org.apache.activemq.broker.region.Queue@156f770&lt;br/&gt;
org.apache.activemq.broker.region.Queue.doPageIn(Queue.java:1002)&lt;br/&gt;
org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1065)&lt;br/&gt;
org.apache.activemq.broker.region.Queue.iterate(Queue.java:938)&lt;br/&gt;
org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:118)&lt;br/&gt;
org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:42)&lt;br/&gt;
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:885)&lt;br/&gt;
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
java.lang.Thread.run(Thread.java:619)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;------------------ Thread ActiveMQ Transport ---------------------------------------&lt;br/&gt;
Name: ActiveMQ Transport: tcp:///167.235.7.27:4773&lt;br/&gt;
State: BLOCKED on org.apache.activemq.broker.region.cursors.FilePendingMessageCursor@166c37e owned by: ActiveMQ Task&lt;br/&gt;
Total blocked: 69  Total waited: 0&lt;/p&gt;

&lt;p&gt;Stack trace: &lt;br/&gt;
org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.onUsageChanged(FilePendingMessageCursor.java:260)&lt;br/&gt;
org.apache.activemq.usage.Usage.fireEvent(Usage.java:254)&lt;br/&gt;
org.apache.activemq.usage.Usage.setPercentUsage(Usage.java:224)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked java.lang.Object@fcc6e8&lt;br/&gt;
org.apache.activemq.usage.MemoryUsage.decreaseUsage(MemoryUsage.java:149)&lt;br/&gt;
org.apache.activemq.usage.MemoryUsage.decreaseUsage(MemoryUsage.java:142)&lt;br/&gt;
org.apache.activemq.command.Message.decrementReferenceCount(Message.java:602)&lt;/li&gt;
	&lt;li&gt;locked org.apache.activemq.command.ActiveMQTextMessage@13c2797&lt;br/&gt;
org.apache.activemq.broker.region.IndirectMessageReference.drop(IndirectMessageReference.java:137)&lt;/li&gt;
	&lt;li&gt;locked org.apache.activemq.broker.region.IndirectMessageReference@4b5011&lt;br/&gt;
org.apache.activemq.broker.region.QueueSubscription.acknowledge(QueueSubscription.java:56)&lt;br/&gt;
org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:193)&lt;/li&gt;
	&lt;li&gt;locked org.apache.activemq.broker.region.QueueSubscription@5cb0bb&lt;br/&gt;
org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:340)&lt;br/&gt;
org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:427)&lt;br/&gt;
org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194)&lt;br/&gt;
org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:73)&lt;br/&gt;
org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:73)&lt;br/&gt;
org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:87)&lt;br/&gt;
org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:440)&lt;br/&gt;
org.apache.activemq.command.MessageAck.visit(MessageAck.java:196)&lt;br/&gt;
org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:281)&lt;br/&gt;
org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:178)&lt;br/&gt;
org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:67)&lt;br/&gt;
org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:134)&lt;br/&gt;
org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:124)&lt;/li&gt;
	&lt;li&gt;locked org.apache.activemq.transport.InactivityMonitor$1@1b8b810&lt;br/&gt;
org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)&lt;br/&gt;
org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:183)&lt;br/&gt;
org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:170)&lt;br/&gt;
java.lang.Thread.run(Thread.java:619)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12939091" author="nickysandhu" created="Tue, 16 Oct 2007 17:26:11 +0000"  >&lt;p&gt;Taking a page from the Swing/AWT event dispatch book I started a new thread for actually notifiying the listeners. This avoids this and other potential callback deadlocks for Usage.&lt;/p&gt;

&lt;p&gt;Reran the load tests using maven-perftest-plugin and things seem to be stable so far&lt;/p&gt;</comment>
                            <comment id="12939139" author="rajdavies" created="Thu, 18 Oct 2007 14:09:15 +0000"  >&lt;p&gt;Fixed by svn revision 585967&lt;/p&gt;</comment>
                            <comment id="12939072" author="nickysandhu" created="Thu, 18 Oct 2007 20:14:38 +0000"  >&lt;p&gt;Deadlocked again.... I uncommented these lines @ line # 272 in Usage.java&lt;br/&gt;
            getExecutor().execute(listenerNotifier);&lt;/p&gt;

&lt;p&gt;And now it seems to work great. Please fix. &lt;/p&gt;</comment>
                            <comment id="12939142" author="rajdavies" created="Fri, 19 Oct 2007 19:05:48 +0000"  >&lt;p&gt;DOH! can&apos;t believe I did that! - I was chasing down another bug&lt;/p&gt;</comment>
                            <comment id="12939121" author="rajdavies" created="Fri, 19 Oct 2007 19:07:42 +0000"  >&lt;p&gt;svn revision 586581&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12460871" name="patch-usage-fireevent.txt" size="1739" author="nickysandhu" created="Tue, 16 Oct 2007 17:26:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95794</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 years, 6 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s053:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161499</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>