<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:24:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5712] Broker can deadlock when using queues while producers wait on disk space</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5712</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I am experiencing a deadlock when using a Queue with non-persistent messages.  The queue has a cursor high memory water mark set (right now at 70%).  When a producer is producing messages quickly to the queue and that limit gets hit, the broker can deadlock.   I have tried setting producerWindowSize and alwaysSyncSend which did not seem to help. When the broker hits that limit, I am unable to do things like purge the queue.  Consumers can also deadlock as well. &lt;/p&gt;

&lt;p&gt;Note that this appears to be the same issue as described in this ticket here: &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2475&quot; title=&quot;If tmp message store fills up, broker can deadlock due to while producers wait on disk space and consumers wait on acks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2475&quot;&gt;&lt;del&gt;AMQ-2475&lt;/del&gt;&lt;/a&gt; .  The difference is that I am using a Queue and not a Topic and the fix for this appears to only have been for Topics.&lt;/p&gt;

&lt;p&gt;The problem appears to be in the Queue class on line 1852 inside the &lt;tt&gt;cursorAdd&lt;/tt&gt; method.  The method being called is &lt;tt&gt;return messages.addMessageLast(msg);&lt;/tt&gt; which will block indefinitely if there is no space available, which in turn ties up the &lt;tt&gt;messagesLock&lt;/tt&gt; from being used by any other threads.  We have seen a deadlock where consumers can&apos;t consume because they are waiting on this lock.   It looks like in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2475&quot; title=&quot;If tmp message store fills up, broker can deadlock due to while producers wait on disk space and consumers wait on acks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2475&quot;&gt;&lt;del&gt;AMQ-2475&lt;/del&gt;&lt;/a&gt; part of the fix was to replace &lt;tt&gt;messages.addMessageLast(msg)&lt;/tt&gt; with &lt;tt&gt;messages.tryAddMessageLast(msg, 10)&lt;/tt&gt;.  I also noticed that not all of the message cursors support &lt;tt&gt;tryAddMessageLast&lt;/tt&gt;, which could be a problem.  &lt;tt&gt;FilePendingMessageCursor&lt;/tt&gt; implements it but the rest of the cursors (notably &lt;tt&gt;StoreQueueCursor&lt;/tt&gt;) simply delegate back to &lt;tt&gt;addMessageLast&lt;/tt&gt; in the parent class.  So part of this fix may require implementing &lt;tt&gt;tryAddMessageLast&lt;/tt&gt; across more cursors.&lt;/p&gt;


&lt;p&gt;Here is part of the thread dump showing the stuck producer:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;ActiveMQ Transport: ssl:&lt;span class=&quot;code-comment&quot;&gt;///192.168.3.142:38589&quot;&lt;/span&gt; daemon prio=10 tid=0x00007fb46c006000 nid=0x3b1a runnable [0x00007fb4b8a0d000]
&lt;/span&gt;   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (parking)
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000000cfb13cd0&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
        at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:226)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2176)
        at org.apache.activemq.usage.Usage.waitForSpace(Usage.java:103)
        at org.apache.activemq.usage.Usage.waitForSpace(Usage.java:90)
        at org.apache.activemq.usage.Usage.waitForSpace(Usage.java:80)
        at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.tryAddMessageLast(FilePendingMessageCursor.java:235)
        - locked &amp;lt;0x00000000d2015ee0&amp;gt; (a org.apache.activemq.broker.region.cursors.FilePendingMessageCursor)
        at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.addMessageLast(FilePendingMessageCursor.java:207)
        - locked &amp;lt;0x00000000d2015ee0&amp;gt; (a org.apache.activemq.broker.region.cursors.FilePendingMessageCursor)
        at org.apache.activemq.broker.region.cursors.StoreQueueCursor.addMessageLast(StoreQueueCursor.java:97)
        - locked &amp;lt;0x00000000d1f20908&amp;gt; (a org.apache.activemq.broker.region.cursors.StoreQueueCursor)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12819015">AMQ-5712</key>
            <summary>Broker can deadlock when using queues while producers wait on disk space</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="cshannon">Christopher L. Shannon</reporter>
                        <labels>
                    </labels>
                <created>Tue, 7 Apr 2015 18:31:44 +0000</created>
                <updated>Fri, 20 Nov 2015 21:01:57 +0000</updated>
                            <resolved>Fri, 20 Nov 2015 21:01:57 +0000</resolved>
                                    <version>5.11.1</version>
                                    <fixVersion>5.13.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14485804" author="githubbot" created="Wed, 8 Apr 2015 18:57:27 +0000"  >&lt;p&gt;GitHub user cshannon opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/84&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/84&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Modified StoreQueueCursor to prevent a broker deadlock&lt;/p&gt;

&lt;p&gt;    Modified StoreQueueCursor to properly implement tryAddMessageLast so that the message lock can be released during a timeout when the temporary store is full.  Updated Queue to call tryAddMessageLast instead of addMessageLast in the cursorAdd method.&lt;/p&gt;

&lt;p&gt;        This resolves &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5712&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5712&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/cshannon/activemq&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cshannon/activemq&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5712&quot; title=&quot;Broker can deadlock when using queues while producers wait on disk space&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5712&quot;&gt;&lt;del&gt;AMQ-5712&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/84.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/84.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #84&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 631518cda7ce81d5ff677b06db9c833d0b8538ee&lt;br/&gt;
Author: Christopher L. Shannon (cshannon) &amp;lt;christopher.l.shannon@gmail.com&amp;gt;&lt;br/&gt;
Date:   2015-04-08T18:49:57Z&lt;/p&gt;

&lt;p&gt;    Modified StoreQueueCursor to properly implement tryAddMessageLast so that the message lock can be released during a timeout when the temporary store is full.  Updated Queue to call tryAddMessageLast instead of addMessageLast in the cursorAdd method.&lt;/p&gt;

&lt;p&gt;    This resolves &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5712&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5712&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14485821" author="christopher.l.shannon" created="Wed, 8 Apr 2015 19:04:05 +0000"  >&lt;p&gt;I just submitted a pull request: &lt;a href=&quot;https://github.com/apache/activemq/pull/84&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/84&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This seems to fix the issues that I am having.  Without the patch, the broker would deadlock (I could not purge, etc) when the temp store limit was hit for non-persistent messages for both sync and async sends and also both when sendFailIfNoSpace is true or false.  &lt;/p&gt;

&lt;p&gt;With this patch, I am able to purge and no longer have deadlock issues.  For async sends, if &lt;tt&gt;sendFailIIfNoSpace&lt;/tt&gt; is false the producer will block but I can purge and then the producer resumes.  I &lt;tt&gt;sendFailIfNoSpace&lt;/tt&gt; is true, exceptions are logged to the broker and I can still purge.  For non-persistent sync sends, if &lt;tt&gt;sendFailIIfNoSpace&lt;/tt&gt; is false the producer will block but I can purge and then the producer resumes.  I &lt;tt&gt;sendFailIfNoSpace&lt;/tt&gt; is true, the producer gets an exception which is what should happen.&lt;/p&gt;

&lt;p&gt;Let me know if this looks ok. I looked at what was done for Topics in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2475&quot; title=&quot;If tmp message store fills up, broker can deadlock due to while producers wait on disk space and consumers wait on acks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2475&quot;&gt;&lt;del&gt;AMQ-2475&lt;/del&gt;&lt;/a&gt; and I tried to follow the same strategy. I can also try and add a test or 2 if needed.&lt;/p&gt;</comment>
                            <comment id="14485840" author="tabish121" created="Wed, 8 Apr 2015 19:14:33 +0000"  >&lt;p&gt;I general it&apos;s a good idea to add some unit tests that cover the problem you are trying to address, this provides context to the person reviewing the patch, and protects the fix into the future.  &lt;/p&gt;</comment>
                            <comment id="14485861" author="christopher.l.shannon" created="Wed, 8 Apr 2015 19:28:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;, sounds good.  I don&apos;t have time today but tomorrow morning I will try and get some tests together to cover this fix.  I&apos;ll push up my change to my branch when I am done.&lt;/p&gt;</comment>
                            <comment id="14488355" author="tabish121" created="Thu, 9 Apr 2015 21:54:20 +0000"  >&lt;p&gt;I believe I&apos;ve run into this while doing some testing for AMQP flow control issues.  Once I did some debugging I remembered this issue while looking into the stack traces.  &lt;/p&gt;</comment>
                            <comment id="14488392" author="christopher.l.shannon" created="Thu, 9 Apr 2015 22:14:24 +0000"  >&lt;p&gt;I started working on a unit test today to replicate this issue but I haven&apos;t quite been able to reproduce the bug in a unit test yet.  In my simple unit test (just one producer), when the temp storage fills the broker detects this at line 821 of &lt;tt&gt;Queue.java&lt;/tt&gt; when &lt;tt&gt;checkUsage(context, producerExchange, message);&lt;/tt&gt; is called.&lt;/p&gt;

&lt;p&gt;When I run our real broker, it gets past that line until it hits the &lt;tt&gt;cursorAdd&lt;/tt&gt; method and ultimately gets stuck spinning in &lt;tt&gt;FilePendingMessageCursor.java&lt;/tt&gt; on line 235 at &lt;tt&gt;if (systemUsage.getTempUsage().waitForSpace(maxWaitTime))&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Our broker is configured for persistent messaging, but the producer is sending non-persistent messages which is why the temp store is used.  I&apos;ll continue to try and put a test together next week or figure out what&apos;s different about my set up.  We have some custom code that we are using so it could be that or it could just be our configuration. (Maybe something in the Queue Policy that we have configured)  What I do know is that when I apply my pull request it fixes the dead lock and the broker no longer gets stuck on line 235 of &lt;tt&gt;FilePendingMessageCursor.java&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="14492612" author="christopher.l.shannon" created="Mon, 13 Apr 2015 16:40:40 +0000"  >&lt;p&gt;Timothy,&lt;/p&gt;

&lt;p&gt;I just pushed up my updated &lt;a href=&quot;https://github.com/apache/activemq/pull/84/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pull request&lt;/a&gt; with a unit test.  If you run the test before my patch, it will timeout because of a deadlock.  With my patch applied it completes successfully.  The key in this test to making it deadlock is the issue only occurs when the temporary storage size is configured to be less than the memory storage size.  (such as 4 gig of memory storage and 1 gig of temp storage).  While this configuration probably isn&apos;t too likely, it&apos;s still a possibility.  When memory fills up and it is dumped to disk, the deadlock occurs and the queue can not be purged.  My unit test demonstrates this.&lt;/p&gt;

&lt;p&gt;Also, I still think there other conditions that cause the broker to deadlock in the same spot (in one of our servers this has happened and the temporary storage was greater than memory size) but this unit test was the easiest way I could reproduce the problem reliably.&lt;/p&gt;

&lt;p&gt;Let me know what you think,&lt;br/&gt;
Chris&lt;/p&gt;
</comment>
                            <comment id="14492733" author="tabish121" created="Mon, 13 Apr 2015 17:50:18 +0000"  >&lt;p&gt;Thanks for the patch, I had uncovered much the same, in my testing and have a smaller but similar test case using the AMQP test client.  The issue occurs due to a race when the temp store is initialize by a change in memory usage that trips the limit causing the in memory message to need to be sent to disk.  The problem is that in the Queue send we don&apos;t see that temp storage is full yet and try to do the add.  While your fix does work around this is would result in the lose of the message(s) that arrive while this is happening which is not something we would want to do in the case of a Queue which has specific QOS guarantees.  &lt;/p&gt;

&lt;p&gt;I am taking a look at how things work today and rethinking some of the layering of add vs tryAdd as it seems a bit wrong to me and can lead to this sort of error in more than one case as you have pointed out.  &lt;/p&gt;</comment>
                            <comment id="14492768" author="paulgale" created="Mon, 13 Apr 2015 18:12:33 +0000"  >&lt;p&gt;Perhaps I&apos;ve missed something but if you&apos;re working with non-persistent messages then why not configure a policyEntry for the queue to use a vmCursor rather than the default storeCursor? &lt;/p&gt;

&lt;p&gt;Regardless, I agree that the temp store&apos;s implementation needs some work. Ideally it should honor the sendFailIfNoSpaceAfterTimeout when configured on the systemUsage element.&lt;/p&gt;</comment>
                            <comment id="14492775" author="christopher.l.shannon" created="Mon, 13 Apr 2015 18:16:15 +0000"  >&lt;p&gt;Great, thanks for your help and for taking a look this issue in detail as it is very important to us and it is causing us a lot of problems.  I suspected my patch may not be the best solution and would need some rework because when the tryAdd method times out with my patch nothing is actually done with that message.  After returning false it just continues on and the message gets lost as you pointed out.  However, I figured submitting something that at least demonstrated the issue as well as a unit test where it is consistently reproducible would help get things started towards finding the best solution to fix the issue permanently.&lt;/p&gt;

&lt;p&gt;Chris&lt;/p&gt;</comment>
                            <comment id="14492786" author="christopher.l.shannon" created="Mon, 13 Apr 2015 18:23:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulgale&quot; class=&quot;user-hover&quot; rel=&quot;paulgale&quot;&gt;paulgale&lt;/a&gt;, Our issue is that we occasionally have slow consumers which fill up our entire memory store (and temporary store) which is causing the deadlock.  This is the reason we can&apos;t use the vmCursor as we need to be able to spill over onto to disk when the memory store fills up.  Also, in our case the jms producer is setting the delivery mode as non-persistent (so the temp store gets used), but it could just as easily switch to persistent.  We want the queue to be set up so the producer can decide if it wants to publish persistent or non persistent messages.&lt;/p&gt;</comment>
                            <comment id="14492866" author="paulgale" created="Mon, 13 Apr 2015 19:01:54 +0000"  >&lt;p&gt;I too have hit the same limitations of the temp store. In the interim you can always force the broker to treat all messages as persistent using the &lt;tt&gt;forcePersistencyModeBrokerPlugin&lt;/tt&gt;. Alternatively use the broker component. &lt;/p&gt;

&lt;p&gt;Perhaps you might need to supplement it with (it&apos;s been a while) this to force the cursor to not use the temp store:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;pendingQueuePolicy&amp;gt;
  &amp;lt;storeCursor/&amp;gt;
&amp;lt;/pendingQueuePolicy&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Is PFC disabled for your queue? If so, why?&lt;/p&gt;

&lt;p&gt;Regardless, even if the temp store worked correctly both memory and disk are limited resources so you&apos;re only delaying the inevitable as one of them will eventually fill up - that is, not unless the producer is flow controlled.&lt;/p&gt;</comment>
                            <comment id="14492884" author="tabish121" created="Mon, 13 Apr 2015 19:11:41 +0000"  >&lt;p&gt;PFC in this case doesn&apos;t matter as the problem occurs outside the normal checks and the add of the message into the cursor stalls while holding the message lock preventing any consumer from ever pulling a message off the Queue so basically the Queue becomes unusable until a broker restart. &lt;/p&gt;</comment>
                            <comment id="14492920" author="christopher.l.shannon" created="Mon, 13 Apr 2015 19:22:51 +0000"  >&lt;p&gt;As Timothy said, PFC doesn&apos;t make a difference and we have tried it both on and off.  For now we have the producer switched to being persistent to fix the issue temporarily. &lt;tt&gt;forcePersistencyModeBrokerPlugin&lt;/tt&gt; doesn&apos;t really help because we want to be able to support both persistent and non-persistent messages on the same destination and don&apos;t want to enforce what the producer sets the delivery mode as. &lt;/p&gt;</comment>
                            <comment id="14493044" author="paulgale" created="Mon, 13 Apr 2015 20:46:45 +0000"  >&lt;p&gt;I don&apos;t see how this plugin puts a requirement on the producer. For example, setting &lt;tt&gt;&amp;lt;forcePersistencyModeBrokerPlugin persistenceFlag=&quot;true&quot;/&amp;gt;&lt;/tt&gt; allows the producer to send either form. It simply makes all messages persistent (or non-persistent if &lt;tt&gt;false&lt;/tt&gt;).&lt;/p&gt;</comment>
                            <comment id="14505294" author="tabish121" created="Tue, 21 Apr 2015 17:12:28 +0000"  >&lt;p&gt;Patch with test and a hacked workaround that allows the Queue to stall but still recover via purge or consumption that you can apply to your local broker build for now.  The problem starts to run deep if you track it far enough so we should probably do more work here to clean things up and work more sensibly, and predictably.  &lt;/p&gt;</comment>
                            <comment id="14507000" author="christopher.l.shannon" created="Wed, 22 Apr 2015 12:45:25 +0000"  >&lt;p&gt;Thanks Timothy.  I have tested out this patch and it looks good.  I will go ahead and apply this to our broker so we can use it for now.&lt;/p&gt;</comment>
                            <comment id="14620728" author="githubbot" created="Thu, 9 Jul 2015 15:53:26 +0000"  >&lt;p&gt;Github user cshannon closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/84&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/84&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15018770" author="jira-bot" created="Fri, 20 Nov 2015 20:58:49 +0000"  >&lt;p&gt;Commit cc6213ebf25a129b278a2ff0d7c32c25edd71eaa in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=cc6213e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=cc6213e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5712&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5712&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Switching addMessageLast to tryAddMessageLast when messages are added&lt;br/&gt;
to a Queue pending cursor to allow a potential deadlock to be&lt;br/&gt;
avoided. There is more work to be done here but this will at least&lt;br/&gt;
prevent a deadlock from occurring.&lt;/p&gt;

&lt;p&gt;Fix and test based off of a patch created by Timothy Bish.&lt;/p&gt;</comment>
                            <comment id="15018777" author="christopher.l.shannon" created="Fri, 20 Nov 2015 21:01:57 +0000"  >&lt;p&gt;This has been fixed by applying the patch submitted here.  I have created a new ticket to track progress for a better solution in the future &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6056&quot; title=&quot;Refactor non-persistent limits in terms of the temporary store usage&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6056&quot;&gt;AMQ-6056&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12914987">AMQ-6056</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12726920" name="queue-cursor.patch" size="55955" author="tabish" created="Tue, 21 Apr 2015 17:12:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311020" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>External issue URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[https://issues.apache.org/jira/browse/AMQ-2475]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2cx8v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>