<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:33:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6194] Deleting a temporary queue creates a warning message in the broker</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6194</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;When deleting a temporary queue, the ActiveMQ 5.13.1 (and 5.12.2) broker logs the following warning message:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  [ActiveMQ NIO Worker 111] [TempQueue] temp-queue://ID:brokerHostname-57582-1455804170203-8569:1:1 on dispose, purge of 1 pending messages: org.apache.activemq.broker.region.cursors.VMPendingMessageCursor@e0f6196
WARN  [ActiveMQ NIO Worker 111] [Queue] temp-queue://ID:brokerHostname-57582-1455804170203-8569:1:1 after purge of 1 messages, message count stats report: 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The cause of this warning seems to be the publication of a &quot;ghost&quot; message when sending a single message on the temporary queue from a transacted session, as demonstrated by this test class:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.text.SimpleDateFormat;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.Date;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.Connection;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.JMSException;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.MessageProducer;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.Session;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.TemporaryQueue;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.jms.TextMessage;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.activemq.ActiveMQConnectionFactory;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GhostMessageOnTempQueueWithTransactedSessionDemo {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; JMSException {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ActiveMQConnectionFactory factory = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ActiveMQConnectionFactory(&lt;span class=&quot;code-quote&quot;&gt;&quot;tcp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:61616&quot;&lt;/span&gt;);
&lt;/span&gt;        Connection connection = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        Session session = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        MessageProducer producer = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        TemporaryQueue temporaryQueue = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            connection = factory.createConnection();
            connection.start();
            &lt;span class=&quot;code-comment&quot;&gt;// The session has to be transacted &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the second &lt;span class=&quot;code-quote&quot;&gt;&quot;ghost&quot;&lt;/span&gt; message to appear (see below).
&lt;/span&gt;            session = connection.createSession(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, Session.SESSION_TRANSACTED);
            &lt;span class=&quot;code-comment&quot;&gt;// And the publication has to be on a temporary queue (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the temporary queue is created by another process, the second &lt;span class=&quot;code-quote&quot;&gt;&quot;ghost&quot;&lt;/span&gt; message still appears).
&lt;/span&gt;            temporaryQueue = session.createTemporaryQueue();
            producer = session.createProducer(temporaryQueue);
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TextMessage textMessage = session.createTextMessage();
            textMessage.setText(&lt;span class=&quot;code-quote&quot;&gt;&quot;GhostMessageDemo@&quot;&lt;/span&gt; + &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleDateFormat(&lt;span class=&quot;code-quote&quot;&gt;&quot;yyyy-MM-dd&lt;span class=&quot;code-quote&quot;&gt;&apos;T&apos;&lt;/span&gt;HH:mm:ss,SSSZ&quot;&lt;/span&gt;).format(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date()));

            producer.send(textMessage);
            &lt;span class=&quot;code-comment&quot;&gt;// Here, in ActiveMQ 5.13.1 and 5.12.2, the message was sent but cannot be browsed or consumed. It can however be seen in the JMX console with:
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// - EnqueueCount, that was increased by one;
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// - MemoryUsageByteCount (by sending huge messages of different size to ensure that it is indeed the real message).
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// In ActiveMQ 5.10.2 (and 5.4.1), it is not sent (even though SocketOutputStream.socketWrite is still called through TcpFormat.oneway?).
&lt;/span&gt;
            session.commit();
            &lt;span class=&quot;code-comment&quot;&gt;// Here, in ActiveMQ 5.13.1, a &lt;span class=&quot;code-quote&quot;&gt;&quot;ghost&quot;&lt;/span&gt; message was sent (EnqueueCount has increased by one again) and the real message is visible and can be consumed.
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// If rollback is called instead, the real message stays (and cannot be consumed since the &lt;span class=&quot;code-quote&quot;&gt;&quot;ghost&quot;&lt;/span&gt; message is not sent).
&lt;/span&gt;        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (producer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
                producer.close();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (temporaryQueue != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
                &lt;span class=&quot;code-comment&quot;&gt;// Here, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; there was a consumer on the queue, it would have consumed the real message, leaving the &lt;span class=&quot;code-quote&quot;&gt;&quot;ghost&quot;&lt;/span&gt; message that lead to the broker warning.
&lt;/span&gt;                temporaryQueue.delete();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (session != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
                session.close();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (connection != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                connection.stop();
                connection.close();
            }
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12946537">AMQ-6194</key>
            <summary>Deleting a temporary queue creates a warning message in the broker</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="DavidD">David Dou</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Mar 2016 13:02:25 +0000</created>
                <updated>Fri, 1 Jul 2016 12:28:53 +0000</updated>
                            <resolved>Mon, 7 Mar 2016 14:20:55 +0000</resolved>
                                    <version>5.12.1</version>
                    <version>5.13.1</version>
                                    <fixVersion>5.13.4</fixVersion>
                    <fixVersion>5.14.0</fixVersion>
                                    <component>Broker</component>
                    <component>JMS client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15179807" author="christopher.l.shannon" created="Fri, 4 Mar 2016 12:16:07 +0000"  >&lt;p&gt;Thanks for the test case.  I took your example and re-wrote it slightly with JUnit to demonstrate the issue and uploaded it as an attachment.   &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;, If you run the test case you will see that the statistics report back a message count of 2 instead of 1.  The issue here is pretty simple, it&apos;s on line 857 of the Queue class: &lt;a href=&quot;https://github.com/apache/activemq/blob/master/activemq-broker/src/main/java/org/apache/activemq/broker/region/Queue.java#L857&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/master/activemq-broker/src/main/java/org/apache/activemq/broker/region/Queue.java#L857&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The problem is the temp queue is part of a transaction, but since its store is null that if statement is always true so it executes the messageSent() method there and also again when the transaction completes which leads to the statistics updating twice.&lt;/p&gt;

&lt;p&gt;Seems like we could just delete the &lt;tt&gt;store == null&lt;/tt&gt; part because I think any non temporary destination should always have a store.  Could also just change it to &lt;tt&gt;if ((store == null &amp;amp;&amp;amp; !destination.isTemporary()) || (!context.isInTransaction() &amp;amp;&amp;amp; !message.isPersistent()))&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;But I wanted to run it by you first to see what you think since you were the last person to have touched that line in this commit &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=54e2e3bef290d7455d9d1ba3420d12dc4805b339&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=54e2e3bef290d7455d9d1ba3420d12dc4805b339&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15182900" author="gtully" created="Mon, 7 Mar 2016 11:29:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; thanks for the heads up!&lt;br/&gt;
The intent is to match tryOrderedCursorAdd, 2nd else clause.&lt;br/&gt;
Where there is no ordering issue with non persistent messages and when the store == null all messages are non persistent.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/activemq/blob/master/activemq-broker/src/main/java/org/apache/activemq/broker/region/Queue.java#L879&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/master/activemq-broker/src/main/java/org/apache/activemq/broker/region/Queue.java#L879&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To match that clearly I think it should be: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( !context.isInTransaction() &amp;amp;&amp;amp; !( store == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; message.isPersistent())) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;An alternative approach would be to delete that line altogether and add a call to messageSend in tryOrderedCursorAdd.&lt;br/&gt;
ie: When there is no order issue, add to the cursor and add to the stats.&lt;br/&gt;
That keeps the logic and the action nicely together so the intent is a little more clear.&lt;/p&gt;

&lt;p&gt;There used to be a sendLock, and it idea was to do the stats update outside of that lock, hence the separation. With the send lock gone, there is no good reason not to inline the call to sendMessage in the tryOrderedCursorAdd&lt;/p&gt;
</comment>
                            <comment id="15182996" author="christopher.l.shannon" created="Mon, 7 Mar 2016 13:32:13 +0000"  >&lt;p&gt;Thanks for the explanation &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;. I like the idea of getting rid of that line and moving the stats to tryOrderedCursorAdd as it is cleaner.  I will apply the fix and a test shortly.&lt;/p&gt;</comment>
                            <comment id="15183049" author="jira-bot" created="Mon, 7 Mar 2016 14:20:13 +0000"  >&lt;p&gt;Commit 903dec615c7932475bd3e6cd869af25f01de64b2 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=903dec6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=903dec6&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6194&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6194&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fixing an issue that caused statistics for a transactional temporary&lt;br/&gt;
queue to be updated twice by mistake.  Moved the statistics update into&lt;br/&gt;
tryOrderedCursorAdd so that the update is called immediately only if&lt;br/&gt;
not inside a transaction.&lt;/p&gt;</comment>
                            <comment id="15358593" author="hakanj" created="Fri, 1 Jul 2016 07:52:54 +0000"  >&lt;p&gt;In our production test environment this bug causes the ActiveMQ kahadb store limit to be reached, even though there is not a single message currently in the broker. The &quot;data/kahadb&quot; directory fills up with database log files, stopping the broker from working.&lt;/p&gt;

&lt;p&gt;We have several clients using request-response where the response queue is a temporary queue. Each client has its own temporary queue which is reused for all requests during the lifetime of the client process, as recommended &lt;a href=&quot;http://activemq.apache.org/how-should-i-implement-request-response-with-jms.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;by the ActiveMQ documentation&lt;/a&gt;.&lt;br/&gt;
When we look at the temp queues using hawtio we see that the &lt;em&gt;EnqueueCount&lt;/em&gt; is always two times the &lt;em&gt;DequeueCount&lt;/em&gt;, even though no messages can be fetched from the queue, aka &quot;ghost&quot; messages.&lt;/p&gt;

&lt;p&gt;Because of the seriousness of this issue I would consider this issue to be at least &lt;em&gt;Major&lt;/em&gt;, not &lt;em&gt;Minor&lt;/em&gt; as it is today.&lt;/p&gt;

&lt;p&gt;If we manually build ActiveMQ with this patch, then this issue goes away, but we would prefer to have an official release instead.&lt;br/&gt;
We would be very happy if a new release containing this fix could be prioritized.&lt;/p&gt;</comment>
                            <comment id="15358767" author="jira-bot" created="Fri, 1 Jul 2016 10:38:41 +0000"  >&lt;p&gt;Commit 7ddfa97d0173b07346ea8fdfcb8e6545766e0d39 in activemq&apos;s branch refs/heads/activemq-5.13.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=7ddfa97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=7ddfa97&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6194&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6194&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fixing an issue that caused statistics for a transactional temporary&lt;br/&gt;
queue to be updated twice by mistake.  Moved the statistics update into&lt;br/&gt;
tryOrderedCursorAdd so that the update is called immediately only if&lt;br/&gt;
not inside a transaction.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 903dec615c7932475bd3e6cd869af25f01de64b2)&lt;/p&gt;</comment>
                            <comment id="15358772" author="christopher.l.shannon" created="Fri, 1 Jul 2016 10:43:59 +0000"  >&lt;p&gt;I actually meant to merge this earlier into a 5.13.x minor release but it was overlooked.  I went ahead and merged it now so it will be in 5.13.4 if released as well as 5.14.0.  I would like to start pushing for 5.14.0 soon but there are still a couple of issues to be worked out first so a 5.13.4 may end up being going out the door in the meantime as it probably has enough bug fixes by now that it can be released.&lt;/p&gt;</comment>
                            <comment id="15358888" author="hakanj" created="Fri, 1 Jul 2016 12:28:53 +0000"  >&lt;p&gt;Thank you for your quick response.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12791455" name="AMQ6194Test.java" size="3260" author="cshannon" created="Fri, 4 Mar 2016 12:07:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 20 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2u3hz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>