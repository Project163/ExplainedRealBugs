<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:45:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-7196] During startup ActiveMq load all the scheduleDB.data on memory causing OOM </title>
                <link>https://issues.apache.org/jira/browse/AMQ-7196</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I had a broker with lots of scheduled messages and I noticed that during startup (clean or unclean) the broker was reading the whole index file and storing it os memory:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/activemq/blob/master/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/scheduler/JobSchedulerImpl.java#L665&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/master/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/scheduler/JobSchedulerImpl.java#L665&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In order to prevent the OOM, I changed this method to return a&#160;Iterator&amp;lt;JobLocation&amp;gt; instead of a List&amp;lt;JobLocation&amp;gt; avoiding load all this data into the heap.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I also noticed that during the startup we read the index at least 3 times:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/activemq/blob/master/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/scheduler/JobSchedulerStoreImpl.java#L829&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/master/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/scheduler/JobSchedulerStoreImpl.java#L829&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/activemq/blob/master/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/scheduler/JobSchedulerStoreImpl.java#L857&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/master/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/scheduler/JobSchedulerStoreImpl.java#L857&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/activemq/blob/master/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/scheduler/JobSchedulerStoreImpl.java#L940&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/master/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/scheduler/JobSchedulerStoreImpl.java#L940&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Probably we can optimize this but this should be another Jira (also maybe we dont need to call recover(tx) when its a clean shutdown)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/activemq/blob/master/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/scheduler/JobSchedulerStoreImpl.java#L787&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/master/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/scheduler/JobSchedulerStoreImpl.java#L787&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13232308">AMQ-7196</key>
            <summary>During startup ActiveMq load all the scheduleDB.data on memory causing OOM </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="alanprot">Alan Protasio</reporter>
                        <labels>
                    </labels>
                <created>Wed, 8 May 2019 18:59:53 +0000</created>
                <updated>Fri, 6 Sep 2019 15:53:24 +0000</updated>
                            <resolved>Mon, 13 May 2019 11:37:48 +0000</resolved>
                                    <version>5.15.9</version>
                    <version>5.16.0</version>
                                    <fixVersion>5.15.10</fixVersion>
                    <fixVersion>5.16.0</fixVersion>
                                    <component>KahaDB</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="16835831" author="jbonofre" created="Wed, 8 May 2019 19:15:42 +0000"  >&lt;p&gt;It&apos;s impacting any broker with `scheduler` enable.&lt;/p&gt;</comment>
                            <comment id="16835861" author="alanprot" created="Wed, 8 May 2019 19:52:50 +0000"  >&lt;p&gt;yeah, and the broker cannot startup when it gets in this situation.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;With this change the broker can&#160;at least startup, but it still read the index file at least 3 times (even with a clean shutdown).&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16837508" author="tabish121" created="Fri, 10 May 2019 18:23:48 +0000"  >&lt;p&gt;I took a quick look and this seems like a reasonable change given what the code is doing in this scenario.&#160;&lt;/p&gt;</comment>
                            <comment id="16837551" author="alanprot" created="Fri, 10 May 2019 19:33:57 +0000"  >&lt;p&gt;Thanks for your input &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16837899" author="christopher.l.shannon" created="Sat, 11 May 2019 17:47:04 +0000"  >&lt;p&gt;I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt; - makes sense to iterate over the index using the iterator and not load into a list for no reason.&lt;/p&gt;

&lt;p&gt;I can take a closer look Monday and merge it&lt;/p&gt;</comment>
                            <comment id="16838476" author="jira-bot" created="Mon, 13 May 2019 11:36:15 +0000"  >&lt;p&gt;Commit b56819123b21af1df001cb2a10e77ba88a3b3c95 in activemq&apos;s branch refs/heads/master from Alan Protasio&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=b568191&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=b568191&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7196&quot; title=&quot;During startup ActiveMq load all the scheduleDB.data on memory causing OOM &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7196&quot;&gt;&lt;del&gt;AMQ-7196&lt;/del&gt;&lt;/a&gt; - During startup ActiveMq load all the scheduleDB.data on memory causing OOM&lt;/p&gt;</comment>
                            <comment id="16838477" author="jira-bot" created="Mon, 13 May 2019 11:36:17 +0000"  >&lt;p&gt;Commit 23f0b1476cf66457e495c370e7869deafc5ed547 in activemq&apos;s branch refs/heads/master from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=23f0b14&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=23f0b14&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge branch &apos;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7196&quot; title=&quot;During startup ActiveMq load all the scheduleDB.data on memory causing OOM &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7196&quot;&gt;&lt;del&gt;AMQ-7196&lt;/del&gt;&lt;/a&gt;&apos;&lt;/p&gt;

&lt;p&gt;This closes #356&lt;/p&gt;

&lt;p&gt;Thanks to Alan Protasio for the patch&lt;/p&gt;</comment>
                            <comment id="16838478" author="jira-bot" created="Mon, 13 May 2019 11:37:35 +0000"  >&lt;p&gt;Commit 66e6e1355313c8931bff8ef4d040dbf2a6726dc6 in activemq&apos;s branch refs/heads/activemq-5.15.x from Alan Protasio&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=66e6e13&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=66e6e13&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7196&quot; title=&quot;During startup ActiveMq load all the scheduleDB.data on memory causing OOM &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7196&quot;&gt;&lt;del&gt;AMQ-7196&lt;/del&gt;&lt;/a&gt; - During startup ActiveMq load all the scheduleDB.data on memory causing OOM&lt;/p&gt;

&lt;p&gt;(cherry picked from commit b56819123b21af1df001cb2a10e77ba88a3b3c95)&lt;/p&gt;</comment>
                            <comment id="16838883" author="alanprot" created="Mon, 13 May 2019 21:35:25 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;!! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16924355" author="jira-bot" created="Fri, 6 Sep 2019 15:53:24 +0000"  >&lt;p&gt;Commit dc35218a2d766a86a78376bfd4b51e7ae5bda935 in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=dc35218&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=dc35218&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7196&quot; title=&quot;During startup ActiveMq load all the scheduleDB.data on memory causing OOM &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7196&quot;&gt;&lt;del&gt;AMQ-7196&lt;/del&gt;&lt;/a&gt; - fix broken test; recovery not applicable to inmemory store&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 10 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z02ijs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>