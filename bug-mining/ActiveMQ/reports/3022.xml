<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:40:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6602] Memory leak when undeploying webapp with ActiveMQ client</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6602</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I have a web app with an ActiveMQ client. When undeploying the app, Tomcat logs the following messages.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;15-Feb-2017 17:53:31.760 WARNING [localhost-startStop-2] org.apache.catalina.loader.WebappClassLoaderBase.clearReferencesThreads The web application [Engine] appears to have started a thread named [ActiveMQ
 Session: ID:comp-41144-1487186920452-1:1:3] but has failed to stop it. This is very likely to create a memory leak. Stack trace of thread:
 java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
 java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:502)
 org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:119)
 org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:42)
15-Feb-2017 17:53:31.761 WARNING [localhost-startStop-2] org.apache.catalina.loader.WebappClassLoaderBase.clearReferencesThreads The web application [Engine] appears to have started a thread named [ActiveMQ
 Session: ID:comp-41144-1487186920452-1:1:2] but has failed to stop it. This is very likely to create a memory leak. Stack trace of thread:
 java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
 java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:502)
 org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:119)
 org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:42)
15-Feb-2017 17:53:31.762 WARNING [localhost-startStop-2] org.apache.catalina.loader.WebappClassLoaderBase.clearReferencesThreads The web application [Engine] appears to have started a thread named [ActiveMQ
 Session: ID:comp-41144-1487186920452-1:1:4] but has failed to stop it. This is very likely to create a memory leak. Stack trace of thread:
 java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
 java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:502)
 org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:119)
 org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:42)
15-Feb-2017 17:53:31.762 WARNING [localhost-startStop-2] org.apache.catalina.loader.WebappClassLoaderBase.clearReferencesThreads The web application [Engine] appears to have started a thread named [ActiveMQ
 Session: ID:comp-41144-1487186920452-1:1:10] but has failed to stop it. This is very likely to create a memory leak. Stack trace of thread:
 java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
 java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:502)
 org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:119)
 org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:42)
15-Feb-2017 17:53:31.763 WARNING [localhost-startStop-2] org.apache.catalina.loader.WebappClassLoaderBase.clearReferencesThreads The web application [Engine] appears to have started a thread named [ActiveMQ
 Session: ID:comp-41144-1487186920452-1:1:6] but has failed to stop it. This is very likely to create a memory leak. Stack trace of thread:
 java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
 java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:502)
 org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:119)
 org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:42)
Feb 15, 2017 5:53:31 PM org.apache.catalina.core.ApplicationContext log
INFO: Closing Spring root WebApplicationContext
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13043532">AMQ-6602</key>
            <summary>Memory leak when undeploying webapp with ActiveMQ client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="mykolamarkov">Mykola Markov</reporter>
                        <labels>
                            <label>leak</label>
                    </labels>
                <created>Thu, 16 Feb 2017 07:58:58 +0000</created>
                <updated>Fri, 24 Feb 2017 11:38:03 +0000</updated>
                            <resolved>Thu, 23 Feb 2017 15:26:55 +0000</resolved>
                                    <version>5.14.3</version>
                                    <fixVersion>5.15.0</fixVersion>
                    <fixVersion>5.14.4</fixVersion>
                                    <component>JMS client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15869460" author="mykolamarkov" created="Thu, 16 Feb 2017 08:01:58 +0000"  >&lt;p&gt;Can be fixed with &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6602&quot; title=&quot;Memory leak when undeploying webapp with ActiveMQ client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6602&quot;&gt;&lt;del&gt;AMQ-6602&lt;/del&gt;&lt;/a&gt;.patch&lt;/p&gt;</comment>
                            <comment id="15878207" author="christopher.l.shannon" created="Wed, 22 Feb 2017 13:32:54 +0000"  >&lt;p&gt; From the stack trace it looks like a deadlock occurred on shutdown and after taking a quick glance at this I&apos;m a little confused as to how adding that lock solves this issue.   There is an AtomicBoolean that gets checked to prevent the initialization from happening more than once.   Can you elaborate more?  One issue I do see is that the executor should probably be volatile or an AtomicReference when it is set so that it is visible to all threads on init.&lt;/p&gt;</comment>
                            <comment id="15880128" author="mykolamarkov" created="Thu, 23 Feb 2017 08:50:38 +0000"  >&lt;p&gt;To show how it can impact, I had updated TaskRunnerFactory init function in this manner:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void init() {
    	&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; threadId = &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().hashCode();
    	&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    		LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;before init TaskRunnerFactory[{}-0x{}], executor:{}&quot;&lt;/span&gt;, name, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.toHexString(threadId), executor);
&lt;span class=&quot;code-comment&quot;&gt;//    		initLock.lock();
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//    		LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;after lock TaskRunnerFactory[{}-0x{}], executor:{}&quot;&lt;/span&gt;, name, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.toHexString(threadId), executor);
&lt;/span&gt;    		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (initDone.compareAndSet(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)) {
    			&lt;span class=&quot;code-comment&quot;&gt;// If your OS/JVM combination has a good thread model, you may want to
&lt;/span&gt;    			&lt;span class=&quot;code-comment&quot;&gt;// avoid using a thread pool to run tasks and use a DedicatedTaskRunner instead.
&lt;/span&gt;    			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (dedicatedTaskRunner || &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;.equalsIgnoreCase(&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.activemq.UseDedicatedTaskRunner&quot;&lt;/span&gt;))) {
    				executor = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    			} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (executor == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    				executor = createDefaultExecutor();
    			}
    			LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Initialized TaskRunnerFactory[{}-0x{}] using ExecutorService: {}&quot;&lt;/span&gt;, name, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.toHexString(threadId), executor);
    		}
    	} &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;//    		initLock.unlock();
&lt;/span&gt;    		LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;after unlock TaskRunnerFactory[{}-0x{}], executor:{}&quot;&lt;/span&gt;, name, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.toHexString(threadId), executor);
    	}
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Initialization log&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2017-02-15 17:02:57.614 [DEBUG] [colContainer-1] o.a.a.t.TaskRunnerFactory - before init TaskRunnerFactory[ActiveMQ Session Task-0x2bef0d82], executor:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2017-02-15 17:02:57.615 [DEBUG] [clContainer-1] o.a.a.t.TaskRunnerFactory - before init TaskRunnerFactory[ActiveMQ Session Task-0x4b0e0ec5], executor:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2017-02-15 17:02:57.615 [DEBUG] [clContainer-1] o.a.a.t.TaskRunnerFactory - after unlock TaskRunnerFactory[ActiveMQ Session Task-0x4b0e0ec5], executor:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2017-02-15 17:02:57.615 [DEBUG] [rlContainer-1] o.a.a.t.TaskRunnerFactory - before init TaskRunnerFactory[ActiveMQ Session Task-0x28aeb65f], executor:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2017-02-15 17:02:57.615 [DEBUG] [rlContainer-1] o.a.a.t.TaskRunnerFactory - after unlock TaskRunnerFactory[ActiveMQ Session Task-0x28aeb65f], executor:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2017-02-15 17:02:57.615 [DEBUG] [polContainer-1] o.a.a.t.TaskRunnerFactory - before init TaskRunnerFactory[ActiveMQ Session Task-0x6e32598d], executor:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2017-02-15 17:02:57.615 [DEBUG] [polContainer-1] o.a.a.t.TaskRunnerFactory - after unlock TaskRunnerFactory[ActiveMQ Session Task-0x6e32598d], executor:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2017-02-15 17:02:57.621 [DEBUG] [rolContainer-1] o.a.a.t.TaskRunnerFactory - before init TaskRunnerFactory[ActiveMQ Session Task-0x75aef312], executor:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2017-02-15 17:02:57.621 [DEBUG] [rolContainer-1] o.a.a.t.TaskRunnerFactory - after unlock TaskRunnerFactory[ActiveMQ Session Task-0x75aef312], executor:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2017-02-15 17:02:57.621 [DEBUG] [org.springframework.jms.listener.DefaultMessageListenerContainer#0-1] o.a.a.t.TaskRunnerFactory - before init TaskRunnerFactory[ActiveMQ Session Task-0x20a020d9], executor:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2017-02-15 17:02:57.621 [DEBUG] [org.springframework.jms.listener.DefaultMessageListenerContainer#0-1] o.a.a.t.TaskRunnerFactory - after unlock TaskRunnerFactory[ActiveMQ Session Task-0x20a020d9], executor:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2017-02-15 17:02:57.636 [TRACE] [ActiveMQ Session: ID:comp-49411-1487206976940-1:1:1] o.a.a.t.DedicatedTaskRunner - Running task org.apache.activemq.ActiveMQSessionExecutor@7d4182f8
2017-02-15 17:02:57.637 [TRACE] [ActiveMQ Session: ID:comp-49411-1487206976940-1:1:6] o.a.a.t.DedicatedTaskRunner - Running task org.apache.activemq.ActiveMQSessionExecutor@1d3f4670
2017-02-15 17:02:57.639 [TRACE] [ActiveMQ Session: ID:comp-49411-1487206976940-1:1:2] o.a.a.t.DedicatedTaskRunner - Running task org.apache.activemq.ActiveMQSessionExecutor@51aef7dd
2017-02-15 17:02:57.641 [TRACE] [ActiveMQ Session: ID:comp-49411-1487206976940-1:1:5] o.a.a.t.DedicatedTaskRunner - Running task org.apache.activemq.ActiveMQSessionExecutor@2cd032c6
2017-02-15 17:02:57.642 [TRACE] [ActiveMQ Session: ID:comp-49411-1487206976940-1:1:12] o.a.a.t.DedicatedTaskRunner - Running task org.apache.activemq.ActiveMQSessionExecutor@6ab678f8
2017-02-15 17:02:57.649 [DEBUG] [colContainer-1] o.a.a.t.TaskRunnerFactory - Initialized TaskRunnerFactory[ActiveMQ Session Task-0x2bef0d82] using ExecutorService: java.util.concurrent.ThreadPoolExecutor@5b724860[Running, pool size = 0, active threads = 0, queued tasks = 0, completed tasks = 0]
2017-02-15 17:02:57.650 [DEBUG] [colContainer-1] o.a.a.t.TaskRunnerFactory - after unlock TaskRunnerFactory[ActiveMQ Session Task-0x2bef0d82], executor:java.util.concurrent.ThreadPoolExecutor@5b724860[Running, pool size = 0, active threads = 0, queued tasks = 0, completed tasks = 0]
2017-02-15 17:02:57.660 [TRACE] [colContainer-1] o.a.a.t.TaskRunnerFactory - Created thread[ActiveMQ Session Task-1]: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[ActiveMQ Session Task-1,7,main]
2017-02-15 17:02:57.813 [DEBUG] [DefaultMessageListenerContainer-2] o.a.a.t.TaskRunnerFactory - before init TaskRunnerFactory[ActiveMQ Session Task-0x789e8e89], executor:java.util.concurrent.ThreadPoolExecutor@5b724860[Running, pool size = 1, active threads = 0, queued tasks = 0, completed tasks = 1]
2017-02-15 17:02:57.814 [DEBUG] [DefaultMessageListenerContainer-2] o.a.a.t.TaskRunnerFactory - after unlock TaskRunnerFactory[ActiveMQ Session Task-0x789e8e89], executor:java.util.concurrent.ThreadPoolExecutor@5b724860[Running, pool size = 1, active threads = 0, queued tasks = 0, completed tasks = 1]
2017-02-15 17:02:57.815 [DEBUG] [DefaultMessageListenerContainer-3] o.a.a.t.TaskRunnerFactory - before init TaskRunnerFactory[ActiveMQ Session Task-0x5c3aee6b], executor:java.util.concurrent.ThreadPoolExecutor@5b724860[Running, pool size = 1, active threads = 0, queued tasks = 0, completed tasks = 2]
2017-02-15 17:02:57.816 [DEBUG] [DefaultMessageListenerContainer-3] o.a.a.t.TaskRunnerFactory - after unlock TaskRunnerFactory[ActiveMQ Session Task-0x5c3aee6b], executor:java.util.concurrent.ThreadPoolExecutor@5b724860[Running, pool size = 1, active threads = 0, queued tasks = 0, completed tasks = 2]
2017-02-15 17:02:57.815 [DEBUG] [DefaultMessageListenerContainer-4] o.a.a.t.TaskRunnerFactory - before init TaskRunnerFactory[ActiveMQ Session Task-0x11da4ceb], executor:java.util.concurrent.ThreadPoolExecutor@5b724860[Running, pool size = 1, active threads = 0, queued tasks = 0, completed tasks = 2]
2017-02-15 17:02:57.817 [DEBUG] [DefaultMessageListenerContainer-4] o.a.a.t.TaskRunnerFactory - after unlock TaskRunnerFactory[ActiveMQ Session Task-0x11da4ceb], executor:java.util.concurrent.ThreadPoolExecutor@5b724860[Running, pool size = 1, active threads = 0, queued tasks = 0, completed tasks = 3]
2017-02-15 17:02:57.813 [DEBUG] [DefaultMessageListenerContainer-5] o.a.a.t.TaskRunnerFactory - before init TaskRunnerFactory[ActiveMQ Session Task-0x5da5b756], executor:java.util.concurrent.ThreadPoolExecutor@5b724860[Running, pool size = 1, active threads = 1, queued tasks = 0, completed tasks = 2]
2017-02-15 17:02:57.815 [DEBUG] [klContainer-1] o.a.a.t.TaskRunnerFactory - before init TaskRunnerFactory[ActiveMQ Session Task-0x36ebc2a0], executor:java.util.concurrent.ThreadPoolExecutor@5b724860[Running, pool size = 1, active threads = 0, queued tasks = 0, completed tasks = 3]
2017-02-15 17:02:57.817 [DEBUG] [klContainer-1] o.a.a.t.TaskRunnerFactory - after unlock TaskRunnerFactory[ActiveMQ Session Task-0x36ebc2a0], executor:java.util.concurrent.ThreadPoolExecutor@5b724860[Running, pool size = 1, active threads = 1, queued tasks = 0, completed tasks = 3]
2017-02-15 17:02:57.817 [TRACE] [klContainer-1] o.a.a.t.TaskRunnerFactory - Created thread[ActiveMQ Session Task-2]: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[ActiveMQ Session Task-2,7,main]
2017-02-15 17:02:57.817 [DEBUG] [DefaultMessageListenerContainer-1] o.a.a.t.TaskRunnerFactory - before init TaskRunnerFactory[ActiveMQ Session Task-0x62922916], executor:java.util.concurrent.ThreadPoolExecutor@5b724860[Running, pool size = 1, active threads = 0, queued tasks = 0, completed tasks = 3]
2017-02-15 17:02:57.818 [DEBUG] [DefaultMessageListenerContainer-1] o.a.a.t.TaskRunnerFactory - after unlock TaskRunnerFactory[ActiveMQ Session Task-0x62922916], executor:java.util.concurrent.ThreadPoolExecutor@5b724860[Running, pool size = 2, active threads = 1, queued tasks = 0, completed tasks = 4]
2017-02-15 17:02:57.818 [DEBUG] [DefaultMessageListenerContainer-5] o.a.a.t.TaskRunnerFactory - after unlock TaskRunnerFactory[ActiveMQ Session Task-0x5da5b756], executor:java.util.concurrent.ThreadPoolExecutor@5b724860[Running, pool size = 2, active threads = 0, queued tasks = 0, completed tasks = 6]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Sample configuration:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	&amp;lt;bean id=&lt;span class=&quot;code-quote&quot;&gt;&quot;jmsFactory&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.activemq.pool.PooledConnectionFactory&quot;&lt;/span&gt;
		destroy-method=&lt;span class=&quot;code-quote&quot;&gt;&quot;stop&quot;&lt;/span&gt;&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;connectionFactory&quot;&lt;/span&gt;&amp;gt;
			&amp;lt;bean class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;&lt;/span&gt; p:trustAllPackages=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;&amp;gt;
				&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerURL&quot;&lt;/span&gt;&amp;gt;
					&amp;lt;value&amp;gt;${jms.host}&amp;lt;/value&amp;gt;
				&amp;lt;/property&amp;gt;
			&amp;lt;/bean&amp;gt;
		&amp;lt;/property&amp;gt;
	&amp;lt;/bean&amp;gt;

.............
I have containers defined like &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; one
	&amp;lt;bean id=&lt;span class=&quot;code-quote&quot;&gt;&quot;polContainer&quot;&lt;/span&gt;
		class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.springframework.jms.listener.DefaultMessageListenerContainer&quot;&lt;/span&gt;&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;connectionFactory&quot;&lt;/span&gt; ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;jmsFactory&quot;&lt;/span&gt; /&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;destination&quot;&lt;/span&gt; ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;poQueue&quot;&lt;/span&gt; /&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;messageListener&quot;&lt;/span&gt; ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;psReceiver&quot;&lt;/span&gt; /&amp;gt;
		&amp;lt;property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;concurrentConsumers&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt; /&amp;gt;
	&amp;lt;/bean&amp;gt;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is initDone.compareAndSet(false, true) set TRUE (Thread [ colContainer-1 ]), but executor still null when next Thread ( [ clContainer-1 ]) try to use this shared connection.&lt;br/&gt;
In my box it takes 30ms to create Executor after this all works fine. &lt;/p&gt;</comment>
                            <comment id="15880464" author="christopher.l.shannon" created="Thu, 23 Feb 2017 14:02:09 +0000"  >&lt;p&gt;Ah, I see the issue now, good catch.  I forgot that the init() method is invoked each time createTaskRunner() and execute() is called leading to this race condition where multiple TaskRunners get started when they shouldn&apos;t.  I will take a closer look at this for a fix, some variation of your patch will probably be the fix.&lt;/p&gt;</comment>
                            <comment id="15880626" author="jira-bot" created="Thu, 23 Feb 2017 15:20:33 +0000"  >&lt;p&gt;Commit fe5164a404ebcb0879c1b769e16c00f475320419 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=fe5164a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=fe5164a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6602&quot; title=&quot;Memory leak when undeploying webapp with ActiveMQ client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6602&quot;&gt;&lt;del&gt;AMQ-6602&lt;/del&gt;&lt;/a&gt;: Fix race condition in TaskRunnerFactory&lt;/p&gt;

&lt;p&gt;Fixing a race condition in TaskRunnerFactory where if multiple threads&lt;br/&gt;
call createTaskRunner() at the same time some threads might see the&lt;br/&gt;
executor as null (if it hasn&apos;t finished initializing) leading to the&lt;br/&gt;
creation of extra DedicatedTaskRunner objects instead of sharing a&lt;br/&gt;
PooledTaskRunner.&lt;/p&gt;</comment>
                            <comment id="15880627" author="jira-bot" created="Thu, 23 Feb 2017 15:21:11 +0000"  >&lt;p&gt;Commit b6a8c188ff07a795399067ef6f6598a2f623a002 in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=b6a8c18&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=b6a8c18&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6602&quot; title=&quot;Memory leak when undeploying webapp with ActiveMQ client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6602&quot;&gt;&lt;del&gt;AMQ-6602&lt;/del&gt;&lt;/a&gt;: Fix race condition in TaskRunnerFactory&lt;/p&gt;

&lt;p&gt;Fixing a race condition in TaskRunnerFactory where if multiple threads&lt;br/&gt;
call createTaskRunner() at the same time some threads might see the&lt;br/&gt;
executor as null (if it hasn&apos;t finished initializing) leading to the&lt;br/&gt;
creation of extra DedicatedTaskRunner objects instead of sharing a&lt;br/&gt;
PooledTaskRunner.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit fe5164a404ebcb0879c1b769e16c00f475320419)&lt;/p&gt;</comment>
                            <comment id="15880645" author="christopher.l.shannon" created="Thu, 23 Feb 2017 15:26:55 +0000"  >&lt;p&gt;Resolved the issue by using a variation of double checked locking so that the synchronized penalty only occurs when initialization is first needed.  After initialization is complete threads will no longer need to synchronize every init() call.&lt;/p&gt;</comment>
                            <comment id="15880692" author="jira-bot" created="Thu, 23 Feb 2017 15:57:21 +0000"  >&lt;p&gt;Commit 1f53b124bcdc41e6241c811f6854c42855deaf6a in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1f53b12&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1f53b12&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6602&quot; title=&quot;Memory leak when undeploying webapp with ActiveMQ client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6602&quot;&gt;&lt;del&gt;AMQ-6602&lt;/del&gt;&lt;/a&gt; - Removing lambdas for java 7 compatibility&lt;/p&gt;</comment>
                            <comment id="15880693" author="jira-bot" created="Thu, 23 Feb 2017 15:57:41 +0000"  >&lt;p&gt;Commit 789f82b34bd4103448e25ae16f53d95946619809 in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=789f82b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=789f82b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6602&quot; title=&quot;Memory leak when undeploying webapp with ActiveMQ client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6602&quot;&gt;&lt;del&gt;AMQ-6602&lt;/del&gt;&lt;/a&gt; - Removing lambdas for java 7 compatibility&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 1f53b124bcdc41e6241c811f6854c42855deaf6a)&lt;/p&gt;</comment>
                            <comment id="15880800" author="mykolamarkov" created="Thu, 23 Feb 2017 16:42:12 +0000"  >&lt;p&gt;Thanks Christopher for quick patch!&lt;/p&gt;</comment>
                            <comment id="15882495" author="jira-bot" created="Fri, 24 Feb 2017 11:37:45 +0000"  >&lt;p&gt;Commit 0cf64783d2cbae684f6d2d3e6c46801070f7fd77 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=0cf6478&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=0cf6478&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6602&quot; title=&quot;Memory leak when undeploying webapp with ActiveMQ client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6602&quot;&gt;&lt;del&gt;AMQ-6602&lt;/del&gt;&lt;/a&gt; - fix java 7 incompatibility&lt;/p&gt;</comment>
                            <comment id="15882498" author="jira-bot" created="Fri, 24 Feb 2017 11:38:03 +0000"  >&lt;p&gt;Commit e5751570936e335a59dfa7f124623f4b257be03d in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e575157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e575157&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6602&quot; title=&quot;Memory leak when undeploying webapp with ActiveMQ client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6602&quot;&gt;&lt;del&gt;AMQ-6602&lt;/del&gt;&lt;/a&gt; - fix java 7 incompatibility&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 0cf64783d2cbae684f6d2d3e6c46801070f7fd77)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12518840">AMQ-3451</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12853002" name="AMQ-6602.patch" size="2492" author="mykolamarkov" created="Thu, 16 Feb 2017 08:01:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 38 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3a5s7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>