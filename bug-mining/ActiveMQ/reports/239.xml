<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:34:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1156] option &quot;wireFormat.tcpNoDelayEnabled=true&quot; is ignored</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1156</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;&lt;b&gt;A. Description&lt;/b&gt;&lt;br/&gt;
Setting the wireFormat.tcpNoDelayEnabled flag to true in connection uri&apos;s (for example &lt;em&gt;&quot;tcp://localhost:61616?wireFormat.tcpNoDelayEnabled&quot;&lt;/em&gt;) has no effect:&lt;br/&gt;
The sockets created in ActiveMQ do not have the TcpNoDelay flag set to true.&lt;br/&gt;
You can verify this for example in the following way: insert the line &lt;em&gt;System.err.println(sock.getTcpNoDelay());&lt;/em&gt; at the end of the method&lt;br/&gt;
&lt;em&gt;org.apache.activemq.transport.tcp.TcpTransport.initialiseSocket&lt;/em&gt;.&lt;br/&gt;
Also you can try my test at &lt;a href=&quot;http://www.nabble.com/High-latency-for-small-messages-problem-t3159901.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.nabble.com/High-latency-for-small-messages-problem-t3159901.html&lt;/a&gt; which makes latency appear if Nagle&apos;s algorithm is not disabled.&lt;br/&gt;
This affects versions 4.0, 4.1.0, and 4.2.0 latest snapshot. I guess 4.0.2 is affected too.&lt;/p&gt;



&lt;p&gt;&lt;b&gt;B. Reason&lt;/b&gt;&lt;br/&gt;
After looking at the source code to understand how the options are set, i saw that in the method org.apache.activemq.transport.tcp.TcpTransportFactory.compositeConfigure the following line appears:&lt;br/&gt;
&lt;em&gt;Map socketOptions = IntrospectionSupport.extractProperties(options, &quot;socket.&quot;)&lt;/em&gt;; &lt;/p&gt;

&lt;p&gt;and also that the method to set the TcpNoDelay option in class &lt;em&gt;org.apache.activemq.transport.tcp.TcpTransport&lt;/em&gt; is called &lt;em&gt;setTcpNoDelay&lt;/em&gt; and not &lt;em&gt;setTcpNoDelayEnabled&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Therefore, I tried to write &lt;em&gt;&quot;socket.tcpNoDelay=true&quot;&lt;/em&gt; instead of &lt;em&gt;&quot;wireFormat.tcpNoDelayEnabled=true&quot;&lt;/em&gt; and it &lt;b&gt;worked!&lt;/b&gt; This is a &lt;b&gt;workaround&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;But, &lt;em&gt;&quot;wireFormat.tcpNoDelayEnabled&quot;&lt;/em&gt; option is not refused (as &lt;em&gt;&quot;wireFormat.tcpNoDelayTypoEnabled&quot;&lt;/em&gt; would be). The option &lt;em&gt;&quot;tcpNoDelay=true&quot;&lt;/em&gt; is not refused either, but DOES NOT work either.&lt;/p&gt;



&lt;p&gt;&lt;b&gt;C. Fix&lt;/b&gt;&lt;br/&gt;
So, please, for the sake of the poor soul who&apos;s next going to try to disable Nagle&apos;s algorithm without noticing any effect, and will start looking for the problem elsewhere (and for the sake of consistency also):&lt;br/&gt;
-Either change the documentation (&lt;a href=&quot;http://www.activemq.org/site/tcp-transport-reference.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.activemq.org/site/tcp-transport-reference.html&lt;/a&gt; and &lt;a href=&quot;http://www.activemq.org/site/configuring-wire-formats.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.activemq.org/site/configuring-wire-formats.html&lt;/a&gt;) to say that one should use the &lt;em&gt;socket.tcpNoDelay&lt;/em&gt; option, or&lt;br/&gt;
-Change the code to obey the documentation (and make it refuse old options like just &lt;em&gt;&quot;tcpNoDelay&quot;&lt;/em&gt; who have no effect).&lt;/p&gt;

&lt;p&gt;Personally I would change the documentation ASAP so that people know about the &lt;em&gt;&quot;socket.tcpNoDelay=true&quot;&lt;/em&gt; workaround until next version, and then change the code to recognize the &lt;em&gt;&quot;wireFormat.tcpNoDelayTypoEnabled&quot;&lt;/em&gt; option. I&apos;d like to point out that the own ActiveMQ test cases use &lt;em&gt;&quot;wireFormat.tcpNoDelayTypoEnabled&quot;&lt;/em&gt; .&lt;/p&gt;



&lt;p&gt;&lt;b&gt;D. Related issues&lt;/b&gt;&lt;br/&gt;
This is related to a previous post of mine: &lt;a href=&quot;http://www.nabble.com/High-latency-for-small-messages-problem-t3159901.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.nabble.com/High-latency-for-small-messages-problem-t3159901.html&lt;/a&gt;&lt;br/&gt;
Doing quick synchronized sends showed a 39ms latency if the broker is running in Linux, and a 200ms latency if the broker is in Windows (by the way, if someone knows the bottom reason for this exact latency times, please tell me). Putting the &lt;em&gt;&quot;wireFormat.tcpNoDelayTypoEnabled&quot;&lt;/em&gt; to true in order to disable Nagle&apos;s algorithm had no effect (because ActiveMQ does not recognize it).&lt;/p&gt;

&lt;p&gt;Very probably this is also related to issues &lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-1143&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-1143&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-1137&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-1137&lt;/a&gt; (in this one probably Helmutt tried to set the wireFormat.tcpNoDelayTypoEnabled without success because of this).&lt;/p&gt;</description>
                <environment>&lt;p&gt;Any.&lt;/p&gt;</environment>
        <key id="12482114">AMQ-1156</key>
            <summary>option &quot;wireFormat.tcpNoDelayEnabled=true&quot; is ignored</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                            <parent id="12482187">AMQ-1233</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chirino">Hiram R. Chirino</assignee>
                                    <reporter username="davidmc">David Mart&#237;n Clavo</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Feb 2007 08:17:33 +0000</created>
                <updated>Mon, 22 Oct 2007 20:00:53 +0000</updated>
                            <resolved>Mon, 22 Oct 2007 20:00:53 +0000</resolved>
                                    <version>4.0</version>
                    <version>4.1.0</version>
                    <version>5.0.0</version>
                                    <fixVersion>5.0.0</fixVersion>
                                    <component>Documentation</component>
                    <component>Test Cases</component>
                    <component>Transport</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12938907" author="davidmc" created="Thu, 22 Feb 2007 02:48:24 +0000"  >&lt;p&gt;Some more findings...&lt;br/&gt;
It seems that even the socket.tcpNoDelay option does nothing to set TCP_NODELAY on broker sockets, when written in the activemq.xml file, like for example:&lt;/p&gt;

&lt;p&gt;  &amp;lt;broker name=&quot;broker&quot; useJmx=&quot;true&quot; persistent=&quot;false&quot; xmlns=&quot;http://activemq.org/config/1.0&quot; deleteAllMessagesOnStartup=&quot;true&quot;&amp;gt;&lt;/p&gt;

&lt;p&gt;    &amp;lt;transportConnectors&amp;gt;&lt;br/&gt;
      &amp;lt;transportConnector uri=&quot;tcp://localhost:61616?socket.tcpNoDelay=true;wireFormat.tcpNoDelayEnabled=true;tcpNoDelay=true&quot;/&amp;gt;&lt;br/&gt;
    &amp;lt;/transportConnectors&amp;gt;&lt;/p&gt;

&lt;p&gt;  &amp;lt;/broker&amp;gt;&lt;/p&gt;

&lt;p&gt;None of the options I put has any effect on the broker&apos;s sockets, but they all are accepted by the options parser without throwing an exception.&lt;br/&gt;
In some scenarios some delayed ACK timeouts were still appearing because of the broker&apos;s sockets having TCP_NODELAY = false even if the client sockets have TCP_NODELAY = true.&lt;/p&gt;

&lt;p&gt;So, if you really want to disable Nagle&apos;s Algorithm in ActiveMQ without exception (broker and clients), one should go to the org.apache.activemq.transport.tcp.TcpTransport.initialiseSocket method and add the following line at the end of the method:&lt;/p&gt;

&lt;p&gt;sock.setTcpNoDelay(true);&lt;/p&gt;</comment>
                            <comment id="12938840" author="janknecht" created="Tue, 13 Mar 2007 11:51:56 +0000"  >&lt;p&gt;This TCP_NODELAY caused also my problem described in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1137&quot; title=&quot;Transactional, non persistent queing very slow under Linux&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1137&quot;&gt;&lt;del&gt;AMQ-1137&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
Regardless of which of these options (&quot;socket.tcpNoDelay=true;wireFormat.tcpNoDelayEnabled=true;tcpNoDelay=true&quot;) I set transactional messaging is slow under Linux.&lt;/p&gt;

&lt;p&gt;I patched  the &lt;tt&gt;org.apache.activemq.transport.tcp.TcpTransport&lt;/tt&gt; class and disbled TCP_NODELAY hard-coded like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;TcpTransport.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void initialiseSocket(Socket sock) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; SocketException {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (socketOptions != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      IntrospectionSupport.setProperties(socket, socketOptions);
    }

    socket.setTcpNoDelay(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);  &lt;span class=&quot;code-comment&quot;&gt;// disable TCP_NODELAY anyway
&lt;/span&gt;    socket.setReceiveBufferSize(socketBufferSize);
    socket.setSendBufferSize(socketBufferSize);

    sock.setTcpNoDelay(socket.getTcpNoDelay()); &lt;span class=&quot;code-comment&quot;&gt;// disable TCP_NODELAY also &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sock
&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      sock.setReceiveBufferSize(socketBufferSize);
      sock.setSendBufferSize(socketBufferSize);

    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (SocketException se) {
      log.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot set socket buffer size = &quot;&lt;/span&gt; + socketBufferSize);
      log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot set socket buffer size. Reason: &quot;&lt;/span&gt; + se, se);
    }
    sock.setSoTimeout(soTimeout);

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (keepAlive != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      sock.setKeepAlive(keepAlive.booleanValue());
    }

    &lt;span class=&quot;code-comment&quot;&gt;//    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tcpNoDelay != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;//      sock.setTcpNoDelay(tcpNoDelay.booleanValue());
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;//    }
&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!socketInitialized) {
      &lt;span class=&quot;code-comment&quot;&gt;//      log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Initialized ACX version $Date: 2007/02/13 16:21 $ of TcpTransport with: sock.getTcpNoDelay=&quot;&lt;/span&gt; + sock.getTcpNoDelay() + &lt;span class=&quot;code-quote&quot;&gt;&quot;, sock.getReceiveBufferSize=&quot;&lt;/span&gt; + sock.getReceiveBufferSize() + &lt;span class=&quot;code-quote&quot;&gt;&quot;, sock.getSendBufferSize=&quot;&lt;/span&gt; + sock.getSendBufferSize() + &lt;span class=&quot;code-quote&quot;&gt;&quot;, socket.getTcpNoDelay=&quot;&lt;/span&gt; + socket.getTcpNoDelay()
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;//          + &lt;span class=&quot;code-quote&quot;&gt;&quot;, socket.getReceiveBufferSize=&quot;&lt;/span&gt; + socket.getReceiveBufferSize() + &lt;span class=&quot;code-quote&quot;&gt;&quot;, socket.getSendBufferSize=&quot;&lt;/span&gt; + socket.getSendBufferSize());
&lt;/span&gt;      log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Initialized ACX patch revision A of TcpTransport with: tcpNoDelay=&quot;&lt;/span&gt; + socket.getTcpNoDelay() + &lt;span class=&quot;code-quote&quot;&gt;&quot; and buffer sizes=&quot;&lt;/span&gt; + socket.getReceiveBufferSize());
      socketInitialized = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12938919" author="janknecht" created="Tue, 13 Mar 2007 12:43:05 +0000"  >&lt;p&gt;On Linux 2.6.16 or 2.6.17 perhaps setting this &lt;tt&gt;sysctl net.ipv4.tcp_abc=0&lt;/tt&gt; may help as described in &lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-1137#action_38799&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-1137#action_38799&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="12938934" author="davidmc" created="Wed, 14 Mar 2007 05:09:24 +0000"  >&lt;p&gt;Indeed Helmut. When you set socket.tcpNoDelay=true on a client (producer or consumer) URI, the client&apos;s sockets have TCP_NODELAY properly set to true.&lt;br/&gt;
But when you try to do the same in activemq.xml for the broker&apos;s sockets, it doesn&apos;t work. You have to hard code it.&lt;br/&gt;
I found that setting TCP_NODELAY on the producer&apos;s sockets is the most important, but setting it on the broker&apos;s and consumer&apos;s sockets also eliminates many timeouts.&lt;/p&gt;

&lt;p&gt;Thank you very much for the warning on tcp_abc. I am not using any of those kernels but it is good to know &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12939055" author="chirino" created="Wed, 5 Sep 2007 21:53:22 +0000"  >&lt;p&gt;Great comments guys.  I just committed a fix to the activemq trunk.&lt;/p&gt;

&lt;p&gt;We now actually update the tcpNoDelay setting on the socket once the wireformat options are negociated.  This allows&lt;br/&gt;
the client to control if his socket and the server&apos;s socket use the option.  By default tcpNoDelay is enabled.&lt;br/&gt;
the client should use a URL like tcp://localhost:61616?wireFormat.tcpNoDelayEnabled=false to disable tcpNoDelay on&lt;br/&gt;
 both the client and the server socket.&lt;/p&gt;

&lt;p&gt;If you guys get a chance could you confirm that this fixes the issue?? thanks.  Hiram&lt;/p&gt;</comment>
                            <comment id="12939040" author="chirino" created="Wed, 5 Sep 2007 21:55:21 +0000"  >&lt;p&gt;Fix was in revision 573080&lt;/p&gt;</comment>
                            <comment id="12939157" author="chirino" created="Mon, 22 Oct 2007 20:00:53 +0000"  >&lt;p&gt;Fixed in 5.0&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12481933">AMQ-1137</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12482187">AMQ-1233</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84305</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 years, 6 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s2wn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161947</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>