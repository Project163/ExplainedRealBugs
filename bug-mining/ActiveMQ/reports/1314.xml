<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:51:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3014] DemandForwardingBridgeSupport can send BrokerInfo to remote transport before local broker ID is known.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3014</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Symptom&lt;br/&gt;
========&lt;br/&gt;
We have a production system that involves a set of Brokers connected in a demand-forwarding Network-of-Brokers using HTTP-based bridges.  Each Broker periodically scans its list of peer brokers by iterating over RegionBroker.getPeerBrokerInfos:&lt;/p&gt;

&lt;p&gt;    public synchronized BrokerInfo[] getPeerBrokerInfos() &lt;/p&gt;
{
        BrokerInfo[] result = new BrokerInfo[brokerInfos.size()];
        result = brokerInfos.toArray(result);
        return result;
    }

&lt;p&gt;This scanning code assumes that BrokerInfo.getBrokerId() is always non-null (since every broker should have an ID).  However, we periodically noticed that BrokerInfo.getBrokerId() returned a NULL value, which was very unexpected.&lt;/p&gt;

&lt;p&gt;Cause&lt;br/&gt;
======&lt;br/&gt;
We analyzed the DemandForwardingBridgeSupport and noticed that when the remote bridge/transport is started, it sends the local Broker&apos;s ID:&lt;/p&gt;

&lt;p&gt;    protected void startRemoteBridge() throws Exception &lt;/p&gt;
{
...
                    brokerInfo.setBrokerId(this.localBrokerId);
                    remoteBroker.oneway(brokerInfo);
                }

&lt;p&gt;The local Broker&apos;s ID is not initially known until it is received from the local transport and processed by DemandForwardingBridge.serviceLocalBrokerInfo(...):&lt;/p&gt;

&lt;p&gt;    protected void serviceLocalBrokerInfo(Command command) throws InterruptedException {&lt;br/&gt;
        synchronized (brokerInfoMutex) {&lt;br/&gt;
            localBrokerId = ((BrokerInfo)command).getBrokerId();&lt;br/&gt;
            localBrokerPath&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; = localBrokerId;&lt;br/&gt;
            localBrokerIdKnownLatch.countDown();&lt;/p&gt;

&lt;p&gt;The local Broker&apos;s ID is dispatched asynchronously when the local transport is started, as seen in TransportConnection.start():&lt;/p&gt;

&lt;p&gt;    public void start() throws Exception {&lt;br/&gt;
        starting = true;&lt;br/&gt;
        try {&lt;br/&gt;
            synchronized (this) {&lt;br/&gt;
                if (taskRunnerFactory != null) &lt;/p&gt;
{
                    taskRunner = taskRunnerFactory.createTaskRunner(this, &quot;ActiveMQ Connection Dispatcher: &quot;
                            + getRemoteAddress());
                }
&lt;p&gt; else &lt;/p&gt;
{
                    taskRunner = null;
                }
&lt;p&gt;                transport.start();&lt;br/&gt;
                active = true;&lt;br/&gt;
                dispatchAsync(connector.getBrokerInfo());&lt;/p&gt;

&lt;p&gt;Because of the asynchronous dispatch, the remote bridge may be started before the local Broker&apos;s ID is known.  This would be particularly evident when the local broker is under load processing a lot of tasks.&lt;/p&gt;

&lt;p&gt;We&apos;ve attached a unit test that demonstrates how a slow asynchronous dispatch on the local transport can cause the remote transport to transmit a null BrokerId.&lt;/p&gt;

&lt;p&gt;Solution&lt;br/&gt;
======&lt;br/&gt;
DemandForwardingBridgeSupport already contains a  localBrokerIdKnownLatch, so starting the remote transport should wait for this latch before accessing the local Broker&apos;s ID (see patch).&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12483853">AMQ-3014</key>
            <summary>DemandForwardingBridgeSupport can send BrokerInfo to remote transport before local broker ID is known.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="stirlingc">Stirling Chow</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Nov 2010 22:56:29 +0000</created>
                <updated>Fri, 30 Sep 2011 19:36:05 +0000</updated>
                            <resolved>Fri, 30 Sep 2011 19:36:05 +0000</resolved>
                                    <version>5.4.1</version>
                                    <fixVersion>5.6.0</fixVersion>
                                    <component>Broker</component>
                    <component>Transport</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12943163" author="stirlingc" created="Wed, 3 Nov 2010 22:57:22 +0000"  >&lt;p&gt;Patch of DemandForwardingBridgeSupport, which waits until the local Broker&apos;s ID is known before transmitting the BrokerInfo to the remote transport.&lt;/p&gt;</comment>
                            <comment id="12943162" author="stirlingc" created="Wed, 3 Nov 2010 22:59:14 +0000"  >&lt;p&gt;Unit test that demonstrates the ability of DemandForwardingBridgeSupport to transmit a null local Broker ID.  The test contains a &quot;normal&quot; case that typically succeeds because there are few delays in VMTransport.  The test also contains a &quot;delayed&quot; case that fails with the unpatched DemandForwardingBridgeSupport.  When the attached patch.txt is applied, both tests pass.&lt;/p&gt;</comment>
                            <comment id="13062640" author="tabish121" created="Sat, 9 Jul 2011 21:40:19 +0000"  >&lt;p&gt;Both tests seem to fail regardless of the patch being applied.&lt;/p&gt;</comment>
                            <comment id="13063493" author="stirlingc" created="Mon, 11 Jul 2011 19:49:20 +0000"  >&lt;p&gt;The unit test is failing because Broker.addBroker(...) is no longer being called when the bridge processes a remote BrokerInfo command.  The test was relying on addBroker(...) to verify that the broker ID had been set.&lt;/p&gt;

&lt;p&gt;The removal occurred in TransportConnection#processBrokerInfo(...) as part of this changeset:&lt;/p&gt;

&lt;p&gt;Revision: 1058577&lt;br/&gt;
Author: gtully&lt;br/&gt;
Date: 6:18:14 AM, January 13, 2011&lt;br/&gt;
Message:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3077&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-3077&lt;/a&gt; - ArraysIndexOutOfBoundsException : -32768 in &quot;BrokerService&lt;span class=&quot;error&quot;&gt;&amp;#91;xxx&amp;#93;&lt;/span&gt; Task&quot; thread - brokerInfo and peerBroker infro explosion problems. A peer is a oneway relationship with networks, broker infos were being accumulated in duplicate for each connector and for multiple connectors. The peer broker info was maintained for each which caused the problem marshalling. re: &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2632&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-2632&lt;/a&gt; - the configuration is now respected so it can be selectively enabled and rebalance only occurs if we randomly choose an alternative. The nested peer broker info is not propagated in a connection control&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;Modified : /activemq/trunk/activemq-core/src/main/java/org/apache/activemq/network/DemandForwardingBridgeSupport.java&lt;br/&gt;
Modified : /activemq/trunk/activemq-core/src/main/java/org/apache/activemq/broker/TransportConnection.java&lt;br/&gt;
Modified : /activemq/trunk/activemq-core/src/main/java/org/apache/activemq/broker/region/RegionBroker.java&lt;br/&gt;
Modified : /activemq/trunk/activemq-core/src/main/java/org/apache/activemq/command/BrokerInfo.java&lt;br/&gt;
Modified : /activemq/trunk/activemq-core/src/main/java/org/apache/activemq/transport/failover/FailoverTransport.java&lt;br/&gt;
Modified : /activemq/trunk/activemq-core/src/test/java/org/apache/activemq/transport/failover/FailoverClusterTest.java&lt;br/&gt;
Modified : /activemq/trunk/activemq-core/src/test/java/org/apache/activemq/JmsMultipleBrokersTestSupport.java&lt;br/&gt;
Added : /activemq/trunk/activemq-core/src/test/java/org/apache/activemq/usecases/NetworkOfTwentyBrokersTest.java&lt;/p&gt;
</comment>
                            <comment id="13063631" author="stirlingc" created="Tue, 12 Jul 2011 00:59:09 +0000"  >&lt;p&gt;Updated unit test that works on trunk to demonstrate the issue (pre-patch) and resolution (post patch).&lt;/p&gt;</comment>
                            <comment id="13063632" author="stirlingc" created="Tue, 12 Jul 2011 01:00:03 +0000"  >&lt;p&gt;I&apos;ve added a revised unit test that does not rely on Broker.addBroker(...) to demonstrate that the issue (transmitting BrokerInfo with null ID) is still present on trunk.&lt;/p&gt;</comment>
                            <comment id="13118318" author="tabish121" created="Fri, 30 Sep 2011 19:36:05 +0000"  >&lt;p&gt;Reviewed the code, Patch applied, thanks for the hard work on this.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12486126" name="NullBrokerIdTest.java" size="6386" author="stirlingc" created="Tue, 12 Jul 2011 00:59:09 +0000"/>
                            <attachment id="12461881" name="NullBrokerIdTest.java" size="5294" author="stirlingc" created="Wed, 3 Nov 2010 22:59:14 +0000"/>
                            <attachment id="12461880" name="patch.txt" size="789" author="stirlingc" created="Wed, 3 Nov 2010 22:57:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>41606</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0agyf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59020</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>