<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:39:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2051] Removing a Destination with active subscribers causes the destination to be unable to be removed.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2051</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;While attempting to implement destination removal in the ActiveMQ-CPP client I noticed that when attempting to remove destination that had active subscribers the destination would be placed in a state that they could not be removed once the subscribers had all been removed.  &lt;/p&gt;

&lt;p&gt;Sending a DestinationInfo command to the Broker while keeping my consumer open results in an exception which is expected since there are still subscribers.  &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;javax.jms.JMSException: Destination still has an active subscription: topic:&lt;span class=&quot;code-comment&quot;&gt;//TEST.FOO
&lt;/span&gt;	at org.apache.activemq.broker.region.AbstractRegion.removeDestination(AbstractRegion.java:158)
	at org.apache.activemq.broker.jmx.ManagedTopicRegion.removeDestination(ManagedTopicRegion.java:62)
	at org.apache.activemq.broker.region.RegionBroker.removeDestination(RegionBroker.java:289)
	at org.apache.activemq.broker.region.RegionBroker.removeDestinationInfo(RegionBroker.java:312)
	at org.apache.activemq.broker.BrokerFilter.removeDestinationInfo(BrokerFilter.java:218)
	at org.apache.activemq.broker.BrokerFilter.removeDestinationInfo(BrokerFilter.java:218)
	at org.apache.activemq.advisory.AdvisoryBroker.removeDestinationInfo(AdvisoryBroker.java:193)
	at org.apache.activemq.broker.BrokerFilter.removeDestinationInfo(BrokerFilter.java:218)
	at org.apache.activemq.broker.MutableBrokerFilter.removeDestinationInfo(MutableBrokerFilter.java:226)
	at org.apache.activemq.broker.TransportConnection.processRemoveDestination(TransportConnection.java:481)
	at org.apache.activemq.command.DestinationInfo.visit(DestinationInfo.java:124)
	at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:305)
	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)
	at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:104)
	at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)
	at org.apache.activemq.transport.vm.VMTransport.iterate(VMTransport.java:205)
	at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:122)
	at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:43)
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:885)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:619)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once I removed my consumer and sent the command again I got no errors indicating that it couldn&apos;t be removed, however I could still see the Destination in the Web Console.&lt;/p&gt;

&lt;p&gt;Looking into the Broker code I see that the RegionBroker class processes a removeDestination call by first removing the Destination from its map of Destinations and then attempting to remove it from the Region that it belongs to.  If this call fails the code will never again attempt to remove a Destination since its removed from the RegionBroker&apos;s map but it may not be removed from the specific region it resides in.  The code looks like it should first attempt to remove the Destination from the region before removing from its map, the addDestination method works in that way, adding it to region before adding it to its map so that if an exception occurs nothing is added.&lt;/p&gt;

&lt;p&gt;RegionBroker.java : around line 283&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;|
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void removeDestination(ConnectionContext context, ActiveMQDestination destination, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; timeout) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (destinations.remove(destination) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; (destination.getDestinationType()) {
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; ActiveMQDestination.QUEUE_TYPE:
                queueRegion.removeDestination(context, destination, timeout);
                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; ActiveMQDestination.TOPIC_TYPE:
                topicRegion.removeDestination(context, destination, timeout);
                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; ActiveMQDestination.TEMP_QUEUE_TYPE:
                tempQueueRegion.removeDestination(context, destination, timeout);
                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; ActiveMQDestination.TEMP_TOPIC_TYPE:
                tempTopicRegion.removeDestination(context, destination, timeout);
                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;:
                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; createUnknownDestinationTypeException(destination);
            }
        }

    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12482183">AMQ-2051</key>
            <summary>Removing a Destination with active subscribers causes the destination to be unable to be removed.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="tabish">Timothy A. Bish</reporter>
                        <labels>
                    </labels>
                <created>Wed, 31 Dec 2008 22:41:14 +0000</created>
                <updated>Thu, 15 Jan 2009 13:59:54 +0000</updated>
                            <resolved>Thu, 15 Jan 2009 13:58:40 +0000</resolved>
                                    <version>5.1.0</version>
                    <version>5.2.0</version>
                                    <fixVersion>5.3.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12940609" author="tabish121" created="Wed, 31 Dec 2008 22:43:04 +0000"  >&lt;p&gt;I&apos;ve attached a unit test, I&apos;ve not been able to find an easy way though to actually test that the Destination is completely removed.&lt;/p&gt;
</comment>
                            <comment id="12940636" author="tabish121" created="Wed, 31 Dec 2008 22:50:26 +0000"  >&lt;p&gt;Potential Patch for this issue.  Probably need someone with more knowledge of the broker internals to ensure this won&apos;t break anything.&lt;/p&gt;</comment>
                            <comment id="12940638" author="tabish121" created="Mon, 12 Jan 2009 16:09:18 +0000"  >&lt;p&gt;Gary, can you take a look at this one for me, we talked about this issue in December, would like to get your input on what I&apos;ve found.&lt;/p&gt;</comment>
                            <comment id="12940670" author="djencks" created="Tue, 13 Jan 2009 19:53:14 +0000"  >&lt;p&gt;This doesn&apos;t seem to be a complete fix.  AFAICT the subscriptions still have the references to any messages that were in the queue when it was destroyed.  Trying to recreate the queue results in recovery failures as these references don&apos;t find the messages they refer to.&lt;/p&gt;

&lt;p&gt;I have to say I&apos;m confused about what should happen when you destroyDestination for a destination that has active consumers and messages in it.  In the case I am working with the consumer was discarded without being closed so it doesn&apos;t much matter what state the client end of the consumer is in but I wonder what should happen if the consumer is actually being used.&lt;/p&gt;</comment>
                            <comment id="12940664" author="gtully" created="Thu, 15 Jan 2009 13:58:40 +0000"  >&lt;p&gt;patch applied and modified test included, thanks. r734524&lt;/p&gt;

&lt;p&gt;The remove implementation takes a timeout option, if the timeout is 0, it errors if there are consumers.&lt;br/&gt;
if the timeout &amp;gt; 0 it removes the subscribers and disposes the queue, which should purge the queue.&lt;/p&gt;

&lt;p&gt;So to Davids question, I guess a removeDestination where the destination has messages should delete the messages, that is purge the store.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461313" name="RemoveDestinationTest.java" size="5233" author="tabish" created="Wed, 31 Dec 2008 22:43:04 +0000"/>
                            <attachment id="12461271" name="removeDestinationPatch.txt" size="1055" author="tabish" created="Wed, 31 Dec 2008 22:50:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>75102</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 45 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14cjz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>233497</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>