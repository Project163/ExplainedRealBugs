<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:42:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1095] Invalid messages selected from durable topic</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1095</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;We think we&apos;ve found an issue with durable topic subscriptions and message selectors.&lt;/p&gt;

&lt;p&gt;The attached application sends messages with an int property i with values 0..19 to a topic. We also have a durable subscription to the topic, selecting messages for which i%2=0. After sending the messages, the connection is started, allowing the consumer to receive the messages we&apos;ve published that match the selection criterion. The second and every subsequent time we run the application, we see the following:&lt;/p&gt;

&lt;p&gt;message.i = 19&lt;br/&gt;
message.i = 0&lt;br/&gt;
message.i = 2&lt;br/&gt;
message.i = 4&lt;br/&gt;
message.i = 6&lt;br/&gt;
message.i = 8&lt;br/&gt;
message.i = 10&lt;br/&gt;
message.i = 12&lt;br/&gt;
message.i = 14&lt;br/&gt;
message.i = 16&lt;br/&gt;
message.i = 18&lt;/p&gt;

&lt;p&gt;message.i = 19 does not match the message selector criterion but it reaches our message handler anyway.&lt;/p&gt;

&lt;p&gt;Tested with ActiveMQ from trunk, revision 486090.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12482257">AMQ-1095</key>
            <summary>Invalid messages selected from durable topic</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chirino">Hiram R. Chirino</assignee>
                                    <reporter username="fullung">Albert Strasheim</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Dec 2006 14:45:10 +0000</created>
                <updated>Tue, 29 Jan 2008 22:30:27 +0000</updated>
                            <resolved>Mon, 1 Oct 2007 20:03:25 +0000</resolved>
                                    <version>5.0.0</version>
                                    <fixVersion>5.0.0</fixVersion>
                                    <component>Selector</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12938990" author="rainer klute" created="Fri, 10 Aug 2007 14:23:32 +0000"  >&lt;p&gt;I have developed a JUnit test case to verify this issue. The test cases show the following:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The bug occurs only with durable subscribers. Non-durable subscribers work fine.&lt;/li&gt;
	&lt;li&gt;The bug occurs if the ActiveMQ broker uses an already existing kaha directory. Everything works fine if the broker creates and uses a fresh kaha directory.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12939001" author="rainer klute" created="Fri, 10 Aug 2007 14:24:51 +0000"  >&lt;p&gt;The JUnit test cases mentioned in my other comment. Download, unpack, and open the index.html file.&lt;/p&gt;</comment>
                            <comment id="12939009" author="rainer klute" created="Mon, 13 Aug 2007 15:35:03 +0000"  >&lt;p&gt;It seems to me that the bug is in the Kaha persistence manager namely in the method org.apache.activemq.store.kahadaptor.KahaTopicMessageStore.addMessage(ConnectionContext context, Message message). Here the message is added to the message containers of &lt;b&gt;all&lt;/b&gt; topic subcribers without checking their respective selectors. Am I on the right track here or not?&lt;/p&gt;</comment>
                            <comment id="12937311" author="rainer klute" created="Tue, 14 Aug 2007 10:06:07 +0000"  >&lt;p&gt;I am one step further now: It might be disputed whether it is sensible or not to add messages to all topic subscribers. However, that does obviously no harm when a fresh kaha store is used.&lt;/p&gt;

&lt;p&gt;However, when a kaha store is recovered that had been created in a former run, the messages that went to the wrong subscribers are still in the store. But now they show up at all subscribers independed of their selectors.&lt;/p&gt;</comment>
                            <comment id="12937476" author="rainer klute" created="Tue, 14 Aug 2007 11:12:58 +0000"  >&lt;p&gt;I updated the test case to verify that unexpected messages are present after recovering the kaha store.&lt;/p&gt;</comment>
                            <comment id="12936649" author="rainer klute" created="Wed, 15 Aug 2007 10:18:05 +0000"  >&lt;p&gt;Okay, folks, here&apos;s a hack to solve this issue. With this patch the KahaTopicMessageStore.addMessage(ConnectionContext, Message) method refuses to add a message to those subscription containers where the message does not match the respective subscription selector.&lt;/p&gt;

&lt;p&gt;Unfortunately the method does not have much it can build on except for the message itself and the subcription info. Therefore I had to re-implement the selector matching stuff from AbstractSubscription. Another option would have been to pass on some necessary information to the store, but I didn&apos;t want to fiddle around with any ActiveMQ architecture issues.&lt;/p&gt;

&lt;p&gt;Probably the ActiveMQ architects can find a better and more elegant solution to this problem. Well, at least my JUnit test run now, and my project will hopefully do so, too.&lt;/p&gt;

&lt;p&gt;(As an aside, I observed that the hash-index-topic-data_topic___TheNameOfMyTopic file in the Kaha directory grows without paying attention to the maximum file limit. What will happen here in the end?)&lt;/p&gt;</comment>
                            <comment id="12936543" author="rainer klute" created="Wed, 15 Aug 2007 10:20:43 +0000"  >&lt;p&gt;Oops, wrong file uploaded. Here&apos;s a better one.&lt;/p&gt;</comment>
                            <comment id="12939076" author="chirino" created="Fri, 28 Sep 2007 14:13:20 +0000"  >&lt;p&gt;Hi Klute,&lt;/p&gt;

&lt;p&gt;is it just the attached DurableTopicSelector.java that I need to verify the bug??  Could you reattach with an Apache License header on it and make sure you click the check box that says your contributing to the ASF.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="12939032" author="rainer klute" created="Fri, 28 Sep 2007 15:07:24 +0000"  >&lt;p&gt;Hi Hiram,&lt;/p&gt;

&lt;p&gt;DurableTopicSelector.java is the original bug poster&apos;s test case. I cannot comment on it.&lt;/p&gt;

&lt;p&gt;My files are:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;ActiveMQ_Testcases.jar containing JUnit test cases and some documentation on how to run them.&lt;/li&gt;
	&lt;li&gt;patch_for_&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1095&quot; title=&quot;Invalid messages selected from durable topic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1095&quot;&gt;&lt;del&gt;AMQ-1095&lt;/del&gt;&lt;/a&gt;.diff with a patch that fixes the problem for me.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I shall resubmit the stuff with the Apache 2 License later, but surely not today. However, you can treat this comment as an LOI.&lt;/p&gt;</comment>
                            <comment id="12939074" author="rainer klute" created="Mon, 1 Oct 2007 09:27:35 +0000"  >&lt;p&gt;Source files in ActiveMQ_Testcases.jar now have the Apache License header.&lt;/p&gt;</comment>
                            <comment id="12938462" author="chirino" created="Mon, 1 Oct 2007 20:03:25 +0000"  >&lt;p&gt;Thanks for the updated test case.&lt;/p&gt;

&lt;p&gt;I have added it and fixed the problem in revision:581053&lt;/p&gt;</comment>
                            <comment id="12939295" author="rajdavies" created="Tue, 29 Jan 2008 22:30:26 +0000"  >&lt;p&gt;This works better with AMQStore and deleteAllMessagesOnStartup&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12460609" name="ASF.LICENSE.NOT.GRANTED--DurableTopicSelector.java" size="2054" author="fullung" created="Tue, 12 Dec 2006 14:45:10 +0000"/>
                            <attachment id="12460673" name="ActiveMQ_Testcases.jar" size="15680" author="rainer klute" created="Mon, 1 Oct 2007 09:27:35 +0000"/>
                            <attachment id="12460803" name="patch_for_AMQ-1095.diff" size="5322" author="rainer klute" created="Wed, 15 Aug 2007 10:20:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84722</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 44 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s1o7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161747</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>