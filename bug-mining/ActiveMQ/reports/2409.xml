<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:07:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5347] persistJMSRedelivered flag doesn&apos;t work correctly when exceptions occur</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5347</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;The new flag in 5.10 that ensures the JMSRedelivered flag persists across broker restarts does not work correctly when an exception occurs when attempting to write the &quot;message update&quot; to disk before the restart.  In that case, messages can be assigned to receivers, the broker can be restarted, and then the messages are re-assigned to receivers and do not include the JMSRedelivered flag as expected.  I will attach a unit test and proposed fix to illustrate the problem.&lt;/p&gt;

&lt;p&gt;Also, here is additional information I had sent to the mailing list:&lt;br/&gt;
When using the new option persisteJMSRedelivered (to ensure the redelivered flag is set correctly on potentially duplicate messages that are re-dispatched by the broker even after a restart): &amp;lt;policyEntry queue=&quot;&amp;gt;&quot; persistJMSRedelivered=&quot;true&quot;&amp;gt;&amp;lt;/policyEntry&amp;gt;&lt;/p&gt;

&lt;p&gt;there is still a case where a message can be re-sent and will not be marked as redelivered.  I can open a JIRA and probably create a unit test but it is pretty clear from the pasted code below where the exception is getting swallowed.  Would the preferred fix be to update the broker interface and make preProcessDispatch throw an IOException or would it be better to add a new field to the MessageDispatch class to indicate an exception occurred and leave the interface alone?&lt;/p&gt;

&lt;p&gt;The specific case when this can happen is when a MessageStore returns an exception during the updateMessage call, which then gets swallowed (and an ERROR logged) and still allows the message to be dispatched to the consumer.  The exception seems like it should actually propagate out of the preProcessDispatch function in RegionBroker as shown below, but this would require changing the Broker interface and making the void preProcessDispatch function throw an IOException.&lt;/p&gt;

&lt;p&gt;//RegionBroker.java&lt;br/&gt;
    @Override&lt;br/&gt;
    public void preProcessDispatch(MessageDispatch messageDispatch) {&lt;br/&gt;
        Message message = messageDispatch.getMessage();&lt;br/&gt;
        if (message != null) {&lt;br/&gt;
            long endTime = System.currentTimeMillis();&lt;br/&gt;
            message.setBrokerOutTime(endTime);&lt;br/&gt;
            if (getBrokerService().isEnableStatistics()) &lt;/p&gt;
{
                long totalTime = endTime - message.getBrokerInTime();
                ((Destination) message.getRegionDestination()).getDestinationStatistics().getProcessTime().addTime(totalTime);
            }
&lt;p&gt;            if (((BaseDestination) message.getRegionDestination()).isPersistJMSRedelivered() &amp;amp;&amp;amp; !message.isRedelivered() &amp;amp;&amp;amp; message.isPersistent()) {&lt;br/&gt;
                final int originalValue = message.getRedeliveryCounter();&lt;br/&gt;
                message.incrementRedeliveryCounter();&lt;br/&gt;
                try &lt;/p&gt;
{
                    ((BaseDestination) message.getRegionDestination()).getMessageStore().updateMessage(message);
                }
&lt;p&gt; catch (IOException error) {&lt;br/&gt;
                    LOG.error(&quot;Failed to persist JMSRedeliveryFlag on {} in {}&quot;, message.getMessageId(), message.getDestination(), error);&lt;br/&gt;
                } finally &lt;/p&gt;
{
                    message.setRedeliveryCounter(originalValue);
                }
&lt;p&gt;            }&lt;br/&gt;
        }&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;//TransportConnection.java&lt;br/&gt;
    protected void processDispatch(Command command) throws IOException {&lt;br/&gt;
        MessageDispatch messageDispatch = (MessageDispatch) (command.isMessageDispatch() ? command : null);&lt;br/&gt;
        try {&lt;br/&gt;
            if (!stopping.get()) {&lt;br/&gt;
                if (messageDispatch != null) &lt;/p&gt;
{
                    broker.preProcessDispatch(messageDispatch);
                }
&lt;p&gt;                dispatch(command);  //This code will dispatch the message whether or not the updateMessage function actually worked&lt;br/&gt;
            }&lt;br/&gt;
        ...&lt;/p&gt;</description>
                <environment></environment>
        <key id="12739972">AMQ-5347</key>
            <summary>persistJMSRedelivered flag doesn&apos;t work correctly when exceptions occur</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="jfugitt">Jesse Fugitt</reporter>
                        <labels>
                    </labels>
                <created>Mon, 8 Sep 2014 21:02:52 +0000</created>
                <updated>Fri, 31 Oct 2014 19:32:55 +0000</updated>
                            <resolved>Fri, 31 Oct 2014 16:46:26 +0000</resolved>
                                    <version>5.10.0</version>
                                    <fixVersion>5.11.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14126095" author="jfugitt" created="Mon, 8 Sep 2014 21:07:01 +0000"  >&lt;p&gt;Attached a proposed patch against the latest code on github for the persistJMSRedelivered issue.&lt;/p&gt;

&lt;p&gt;Also, attached a new unit test that passes when run from activemq-unit-tests after the fix is applied.&lt;/p&gt;</comment>
                            <comment id="14192035" author="gtully" created="Fri, 31 Oct 2014 16:46:27 +0000"  >&lt;p&gt;thanks for the test case and patch. I decided to keep the broker interface as is b/c lots of folks have their own plugins so the exception is propagated via a runtime exception. The exception kills the connection and hence the consumer and the delivery failure is properly accounted for.&lt;br/&gt;
A variant of your test where the broker remains alive exposed another issue with the redelivery flag and dispatch ordering. That is also sorted with&lt;br/&gt;
&lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/activemq/commit/52e1a05a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/activemq/commit/52e1a05a&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="14192307" author="jfugitt" created="Fri, 31 Oct 2014 19:32:55 +0000"  >&lt;p&gt;Great thanks.  Killing the connection was the important thing and the runtime exception looks like it accomplishes that.  Originally, I looked at a way to sneak the exception through the interface since changing would impact so many files/plugins but ended up just submitting the patch so that the intent was clear.  Glad you were able to get this in.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12667243" name="AMQ5347.patch" size="8133" author="jfugitt" created="Mon, 8 Sep 2014 21:07:01 +0000"/>
                            <attachment id="12667244" name="RedeliveryRestartWithExceptionTest.java" size="13616" author="jfugitt" created="Mon, 8 Sep 2014 21:07:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1zt33:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>