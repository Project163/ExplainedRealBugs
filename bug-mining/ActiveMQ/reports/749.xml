<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:43:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1873] Stomp connections doesn&apos;t seem to be released cleanly (Too many open files error)</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1873</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I&apos;m actually testing ActiveMQ with a python stomp Client (stomp.py &lt;a href=&quot;http://www.briggs.net.nz/log/projects/stomppy/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.briggs.net.nz/log/projects/stomppy/&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;I&apos;m trying to load the broker with ~200 producers (on ~200 hosts) feeding one TOPIC for only one consumer.&lt;/p&gt;

&lt;p&gt;Everything is working almost fine until the client connection fails.&lt;/p&gt;

&lt;p&gt;The ActiveMQ log displays :&lt;br/&gt;
...&lt;br/&gt;
2008-07-30 09:28:43,665 &lt;span class=&quot;error&quot;&gt;&amp;#91;localhost:61613&amp;#93;&lt;/span&gt; ERROR TransportConnector             - Could not accept connection : Too many open files&lt;br/&gt;
2008-07-30 09:28:43,665 &lt;span class=&quot;error&quot;&gt;&amp;#91;localhost:61613&amp;#93;&lt;/span&gt; DEBUG TransportConnector             - Reason: Too many open files&lt;br/&gt;
java.net.SocketException: Too many open files&lt;br/&gt;
	at java.net.PlainSocketImpl.socketAccept(Native Method)&lt;br/&gt;
	at java.net.PlainSocketImpl.accept(PlainSocketImpl.java:384)&lt;br/&gt;
	at java.net.ServerSocket.implAccept(ServerSocket.java:450)&lt;br/&gt;
	at java.net.ServerSocket.accept(ServerSocket.java:421)&lt;br/&gt;
	at org.apache.activemq.transport.tcp.TcpTransportServer.run(TcpTransportServer.java:221)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:595)&lt;/p&gt;

&lt;p&gt;When I look at the open files (or connections) (with lsof) I see 65446 lines like :&lt;/p&gt;

&lt;p&gt;java    26765 root *066u  sock        0,4          7534034 can&apos;t identify protocol&lt;/p&gt;

&lt;p&gt;This seems to indicate that ActiveMQ doesn&apos;t totally released the UNIX socket&lt;/p&gt;

&lt;p&gt;I&apos;m attaching the activemq.xml conf file.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux RHEL 4&lt;br/&gt;
java version &quot;1.5.0_15&quot;&lt;br/&gt;
Java(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_15-b04)&lt;br/&gt;
Java HotSpot(TM) Server VM (build 1.5.0_15-b04, mixed mode)&lt;/p&gt;</environment>
        <key id="12483788">AMQ-1873</key>
            <summary>Stomp connections doesn&apos;t seem to be released cleanly (Too many open files error)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="devemy">Julien Devemy</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 Jul 2008 08:01:10 +0000</created>
                <updated>Tue, 5 Jul 2011 20:31:25 +0000</updated>
                            <resolved>Tue, 5 Jul 2011 20:31:25 +0000</resolved>
                                    <version>5.1.0</version>
                                    <fixVersion>NEEDS_REVIEW</fixVersion>
                                        <due></due>
                            <votes>8</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="12941399" author="alex.hollerith" created="Fri, 30 Oct 2009 12:44:40 +0000"  >&lt;p&gt;config:&lt;br/&gt;
&amp;lt;policyEntry queue=&quot;&amp;gt;&quot; producerFlowControl=&quot;true&quot; memoryLimit=&quot;5mb&quot;&amp;gt;&lt;/p&gt;

&lt;p&gt;setup:&lt;br/&gt;
1 perl stomp producer producing into a queue,&lt;br/&gt;
  connecting and disconnecting on every post,&lt;br/&gt;
  rather low frequency of posts (0.5/minute)&lt;br/&gt;
0 consumers&lt;/p&gt;

&lt;p&gt;behaviour:&lt;br/&gt;
works OK until around 68 messages are in the queue (surely depends on the size of the messages)&lt;/p&gt;

&lt;p&gt;after that you get this in the log:&lt;br/&gt;
2009-10-29 20:32:05,189 | INFO  | Usage Manager memory limit reached on queue://test.soccerfeeds.queue. Producers will be throttled to the rate at which messages are removed &amp;lt;...&amp;gt;&lt;/p&gt;

&lt;p&gt;And while the activemq service is in that &quot;throttling producers&quot; state you will see CLOSE_WAIT sockets building up:&lt;br/&gt;
tcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:41519    CLOSE_WAIT&lt;br/&gt;
tcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:36141    CLOSE_WAIT&lt;br/&gt;
tcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:45840    CLOSE_WAIT&lt;br/&gt;
tcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:43793    CLOSE_WAIT&lt;br/&gt;
tcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:40212    CLOSE_WAIT&lt;br/&gt;
tcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:44060    CLOSE_WAIT&lt;br/&gt;
tcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:43776    CLOSE_WAIT&lt;br/&gt;
tcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:44032    CLOSE_WAIT&lt;br/&gt;
tcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:43781    CLOSE_WAIT&lt;br/&gt;
tcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:40200    CLOSE_WAIT&lt;br/&gt;
tcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:44045    CLOSE_WAIT&lt;/p&gt;

&lt;p&gt;You can watch the numbers grow with:&lt;br/&gt;
watch --interval=5 &apos;netstat -an |grep tcp |grep 61613 | grep CLOSE_WAIT |wc -l&apos;&lt;/p&gt;

&lt;p&gt;Every post increases the number of CLOSE_WAIT sockets by 1. And the sockets will not go away, the number seems to be steadily growing.&lt;/p&gt;

&lt;p&gt;Just consume one single message (we did it via the admin webinterface) and the number of sockets in CLOSE_WAIT drops to 0 instantly.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;root@bladedist01 activemq&amp;#93;&lt;/span&gt;# netstat -an |grep tcp |grep 61613&lt;br/&gt;
tcp        0      0 :::61613                    :::*                        LISTEN&lt;/p&gt;

&lt;p&gt;Our theory is that activemq does somehow manage to build up sockets in CLOSE_WAIT state while it is &quot;throttling producers&quot; mode on a given queue until, eventually, the system runs out of resources (file descriptors in this case).&lt;/p&gt;</comment>
                            <comment id="12941956" author="ruben.wagner@gmx.net" created="Wed, 21 Jul 2010 09:21:25 +0000"  >&lt;p&gt;We can reproduce this issue on a Linux platform which runs under a high load. One client is sufficient to produce the stale sockets.&lt;br/&gt;
The client has to do something like (perl):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(1)
{
    my $c = Stomp::Connection-&amp;gt;&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;(host=&amp;gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;localhost&quot;&lt;/span&gt;, port=&amp;gt;61613 );
    $c-&amp;gt;Send( &lt;span class=&quot;code-quote&quot;&gt;&quot;/topic/foo&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;hi5&quot;&lt;/span&gt; );
    $c-&amp;gt;Disconnect();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We have reproduced the problem with the following transport connectors:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;stomp (Perl, PHP)&lt;/li&gt;
	&lt;li&gt;stomp+nio (Perl, PHP)&lt;/li&gt;
	&lt;li&gt;openwire (Java)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We have reproduced the problem with the following builds: 5.3.2, 5.3.1, 5.4-SNAPSHOT (we did not try the others)&lt;/p&gt;

&lt;p&gt;It looks like a race condition to me, as the problem occures more often, the weaker the running machine is. It does not occure when I add a short sleep to my test script.&lt;/p&gt;

&lt;p&gt;Testing environments:&lt;br/&gt;
#1:&lt;br/&gt;
Linux version 2.6.26.8+pata&lt;br/&gt;
java version &quot;1.6.0_12&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.6.0_12-b04)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 11.2-b01, mixed mode)&lt;/p&gt;

&lt;p&gt;#2:&lt;br/&gt;
Linux version 2.6.32-23-generic-pae&lt;br/&gt;
java version &quot;1.6.0_20&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.6.0_20-b02)&lt;br/&gt;
Java HotSpot(TM) Server VM (build 16.3-b01, mixed mode)&lt;/p&gt;

&lt;p&gt;P.S.&lt;br/&gt;
excuse my english, I&apos;m not a native speaker&lt;/p&gt;</comment>
                            <comment id="13019837" author="rws_urbancode" created="Thu, 14 Apr 2011 14:08:00 +0000"  >&lt;p&gt;Is this the same issue as &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1739&quot; title=&quot;ActiveMQ 5.1.0 runs out of file descriptors with lots of &amp;#39;CLOSE_WAIT&amp;#39; sockets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1739&quot;&gt;&lt;del&gt;AMQ-1739&lt;/del&gt;&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="13060116" author="tabish121" created="Tue, 5 Jul 2011 20:31:25 +0000"  >&lt;p&gt;This is in some ways related to &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3393&quot; title=&quot;Number of established STOMP connections constantly increasing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3393&quot;&gt;&lt;del&gt;AMQ-3393&lt;/del&gt;&lt;/a&gt;. There is also the fact that Stomp 1.0 doesn&apos;t allow for a keep alive so sometimes connection drops aren&apos;t detected. &lt;/p&gt;

&lt;p&gt;Reopen if the problem persists.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461126" name="ASF.LICENSE.NOT.GRANTED--activemq.xml" size="5126" author="devemy" created="Wed, 30 Jul 2008 08:01:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>69108</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0tu6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>172198</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>