<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:02:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4924] Duplicate messages are left in the persistence store</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4924</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;We have a local and remote broker connected with a duplex bridge, which is initiated by the remote broker.&lt;br/&gt;
Producers are attached to the remote broker, one consumer to the local broker.&lt;br/&gt;
The following scenario causes messages to be left in the local store, which are replayed when the local broker is restarted:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;messages are forwarded from the remote broker to the local broker&lt;/li&gt;
	&lt;li&gt;messages are dispatched to the local consumer&lt;/li&gt;
	&lt;li&gt;the connection between the local and remote broker fails&lt;/li&gt;
	&lt;li&gt;the local broker tries to acknowledge the message reception to the remote broker, which fails&lt;/li&gt;
	&lt;li&gt;the remote broker reconnects&lt;/li&gt;
	&lt;li&gt;the messages are resent&lt;/li&gt;
	&lt;li&gt;the local broker correctly identifies them as duplicates, but puts them into the store nevertheless where they remain until the local broker is restarted&lt;/li&gt;
	&lt;li&gt;other messages are produced and consumed without a problem&lt;/li&gt;
	&lt;li&gt;the local broker is restarted&lt;/li&gt;
	&lt;li&gt;the duplicates are now delivered to the local consumer again and of course out of order&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This behaviour can be identified by a queue size which does not seem to shrink below a certain number, even if a consumer is connected and consuming other messages.&lt;/p&gt;

&lt;p&gt;When the log level is set to TRACE these messages indicate the problem:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2013-12-06 20:35:17,405 TRACE .a.a.b.r.c.AbstractStoreCursor - org.apache.activemq.broker.region.cursors.QueueStorePrefetch@c0bc4f:testqueue,batchResetNeeded=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,storeHasMessages=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;,size=0,cacheEnabled=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;,maxBatchSize:1 - cursor got duplicate: ID:smcexp5-58011-1386358514283-7:1:1:1:1, 4 [ActiveMQ VMTransport: vm:&lt;span class=&quot;code-comment&quot;&gt;//LOCAL#19-1]
&lt;/span&gt;2013-12-06 20:35:17,412 TRACE .a.a.b.r.c.AbstractStoreCursor - org.apache.activemq.broker.region.cursors.QueueStorePrefetch@c0bc4f:testqueue,batchResetNeeded=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,storeHasMessages=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,size=1,cacheEnabled=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,maxBatchSize:1 - fillBatch [ActiveMQ BrokerService[LOCAL] Task-2]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12683192">AMQ-4924</key>
            <summary>Duplicate messages are left in the persistence store</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="ron.koerner">Ron Koerner</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 Dec 2013 19:56:28 +0000</created>
                <updated>Wed, 2 Apr 2014 22:19:16 +0000</updated>
                            <resolved>Wed, 11 Dec 2013 11:17:01 +0000</resolved>
                                    <version>5.8.0</version>
                    <version>5.9.0</version>
                                    <fixVersion>5.9.1</fixVersion>
                    <fixVersion>5.10.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13841630" author="ron.koerner" created="Fri, 6 Dec 2013 20:00:34 +0000"  >&lt;p&gt;Attached test case to reproduce the problem. It can be reproduced with KahaDB or LevelDB.&lt;/p&gt;</comment>
                            <comment id="13841650" author="ron.koerner" created="Fri, 6 Dec 2013 20:16:18 +0000"  >&lt;p&gt;Attached new version, where the local consumer is disconnected and reconnected to exclude prefetch issues.&lt;/p&gt;</comment>
                            <comment id="13845315" author="rajdavies" created="Wed, 11 Dec 2013 11:17:01 +0000"  >&lt;p&gt;Duplicates where not being checked in duplex connections.&lt;br/&gt;
There is an additional property on NetworkConnector that needs to be enabled - checkDuplicateMessagesOnDuplex (default is false).&lt;/p&gt;

&lt;p&gt;Thank you Ron for investigating this!&lt;/p&gt;</comment>
                            <comment id="13845321" author="ron.koerner" created="Wed, 11 Dec 2013 11:31:01 +0000"  >&lt;p&gt;It also seems to help to enable &quot;supportFailOver&quot; in the broker.&lt;/p&gt;

&lt;p&gt;I don&apos;t know about the individual advantages or disadvantages for each solution. Can you elaborate? Is there a reason not to activate supportFailOver or checkDuplicateMessagesOnDuplex permanently/by default?&lt;/p&gt;</comment>
                            <comment id="13845322" author="ron.koerner" created="Wed, 11 Dec 2013 11:33:48 +0000"  >&lt;p&gt;This also seemst to be a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3473&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-3473&lt;/a&gt;.&lt;br/&gt;
Unfortunately setting auditNetworkProducers = true does not suppress the extra message in the store.&lt;/p&gt;</comment>
                            <comment id="13845343" author="ron.koerner" created="Wed, 11 Dec 2013 12:17:42 +0000"  >&lt;p&gt;After looking at your change, I wondered if the problem also occurs without a duplex bridge and reran my test. It does happen without duplex. I also may have misunderstood your code, but I was wondering how the remote side could know which messages need to be resent, as sometimes messages could get lost and other times just the response/ack gets lost (like in my case).&lt;/p&gt;</comment>
                            <comment id="13845353" author="gtully" created="Wed, 11 Dec 2013 12:42:33 +0000"  >&lt;p&gt;@Ron supportFailOver is really old code that has no tests and I am not aware of any user of it. It duplicates work done elsewhere. So don&apos;t go down that road. see: &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4929&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-4929&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13845360" author="rajdavies" created="Wed, 11 Dec 2013 12:47:20 +0000"  >&lt;p&gt;There&apos;s another variable to set on the TransportConnector - auditNetworkProducers (disabled by default) - for regular networks. Messages are always available to be resent unless they&apos;ve been acknowledged as being consumed, so its really only duplicate messages that we need to worry about.&lt;/p&gt;</comment>
                            <comment id="13845437" author="ron.koerner" created="Wed, 11 Dec 2013 14:35:37 +0000"  >&lt;p&gt;So if I have no duplex connection I need to activate auditNetworkProducer on the receiving TransportConnector (in my case &quot;LOCAL&quot;) and if I have a duplex connection I need to activate checkDuplicateMessagesOnDuplex on the sending NetworkConnector (in my case &quot;REMOTE&quot;).&lt;br/&gt;
But when messages are sent from REMOTE to LOCAL the DemandForwardingBridge on the LOCAL side will actually check for the duplicate, even if it is configured only on the REMOTE side.&lt;br/&gt;
As soon as 5.10 is released I will change my setup accordingly. For now I can use supportFailOver as a workaround.&lt;/p&gt;

&lt;p&gt;Thank you very much!&lt;/p&gt;

&lt;p&gt;Other people with this problem may appreciate a hint to use auditNetworkProducers or checkDuplicateMessagesOnDuplex whenever they encounter the situation that there is a duplicate detected by the cursor.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12685909">AMQ-4952</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12617465" name="AMQ4924.java" size="12084" author="ron.koerner" created="Fri, 6 Dec 2013 20:16:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>362444</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 49 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qh5r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>362738</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>