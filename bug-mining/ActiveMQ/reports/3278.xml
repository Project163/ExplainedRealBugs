<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:48:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-7353] Rare NPE during marshal, killing async dispatch task and potentially leaving un-marshal cache invalid</title>
                <link>https://issues.apache.org/jira/browse/AMQ-7353</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;On occasion the following NPE occurs:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Error in thread &lt;span class=&quot;code-quote&quot;&gt;&apos;ActiveMQ BrokerService[..] Task-243&apos;&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; org.apache.activemq.thread.TaskRunnerFactory$1$1
Method uncaughtException
Throwable java.lang.NullPointerException
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.arraycopy(Native Method)
	at org.apache.activemq.transport.nio.NIOOutputStream.write(NIOOutputStream.java:113)
	at java.io.DataOutputStream.write(DataOutputStream.java:107)
	at org.apache.activemq.openwire.v10.BaseDataStreamMarshaller.tightMarshalByteSequence2(BaseDataStreamMarshaller.java:431)
	at org.apache.activemq.openwire.v10.MessageMarshaller.tightMarshal2(MessageMarshaller.java:183)
	at org.apache.activemq.openwire.v10.ActiveMQMessageMarshaller.tightMarshal2(ActiveMQMessageMarshaller.java:89)
	at org.apache.activemq.openwire.v10.ActiveMQBytesMessageMarshaller.tightMarshal2(ActiveMQBytesMessageMarshaller.java:89)
	at org.apache.activemq.openwire.OpenWireFormat.tightMarshalNestedObject2(OpenWireFormat.java:417)
	at org.apache.activemq.openwire.v10.BaseDataStreamMarshaller.tightMarshalNestedObject2(BaseDataStreamMarshaller.java:135)
	at org.apache.activemq.openwire.v10.MessageDispatchMarshaller.tightMarshal2(MessageDispatchMarshaller.java:105)
	at org.apache.activemq.openwire.OpenWireFormat.marshal(OpenWireFormat.java:227)
	at org.apache.activemq.transport.tcp.TcpTransport.oneway(TcpTransport.java:175)
	at org.apache.activemq.transport.AbstractInactivityMonitor.doOnewaySend(AbstractInactivityMonitor.java:335)
	at org.apache.activemq.transport.AbstractInactivityMonitor.oneway(AbstractInactivityMonitor.java:317)
	at org.apache.activemq.transport.TransportFilter.oneway(TransportFilter.java:85)
	at org.apache.activemq.transport.WireFormatNegotiator.oneway(WireFormatNegotiator.java:116)
	at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:68)
	at org.apache.activemq.broker.TransportConnection.dispatch(TransportConnection.java:1456)
	at org.apache.activemq.broker.TransportConnection.processDispatch(TransportConnection.java:966)
	at org.apache.activemq.broker.TransportConnection.iterate(TransportConnection.java:1016)
	at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:133)
	at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:48)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
	&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13270759">AMQ-7353</key>
            <summary>Rare NPE during marshal, killing async dispatch task and potentially leaving un-marshal cache invalid</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="gtully">Gary Tully</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Nov 2019 16:41:51 +0000</created>
                <updated>Fri, 23 Oct 2020 09:45:52 +0000</updated>
                            <resolved>Tue, 26 Nov 2019 17:04:02 +0000</resolved>
                                    <version>5.15.0</version>
                                    <fixVersion>5.16.0</fixVersion>
                                    <component>Broker</component>
                    <component>Transport</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16982664" author="gtully" created="Tue, 26 Nov 2019 16:46:54 +0000"  >&lt;p&gt;I added the causes relation here to&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7245&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-7245&lt;/a&gt;&#160;but it could be relates to, however depending on what happens next the client may see a read error or an invalid marshal cache on the next command, leading to ClassCastException etc. The connection may not always terminate due to the NPE in a timely manner and during the working part of the marshal the broker side cache can be populated, but the command never completed, leaving the other end (un marshal cache) out of sync.&lt;/p&gt;

&lt;p&gt;If the symptoms of &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7245&quot; title=&quot;ActiveMQ is throwing ClassCastExceptions inside the client library&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7245&quot;&gt;AMQ-7245&lt;/a&gt; have a corresponding error on NPE on the broker side, which is my suspicion, I think this is the root cause.&lt;/p&gt;</comment>
                            <comment id="16982676" author="jira-bot" created="Tue, 26 Nov 2019 16:59:10 +0000"  >&lt;p&gt;Commit 5a0c853ba0e2ade0b29fa4319857bd8a557995e4 in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=5a0c853&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=5a0c853&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7353&quot; title=&quot;Rare NPE during marshal, killing async dispatch task and potentially leaving un-marshal cache invalid&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7353&quot;&gt;&lt;del&gt;AMQ-7353&lt;/del&gt;&lt;/a&gt; - fix visibility of marshalledProperties to ensure competing threads don&apos;t see partial objects in error. Little test case that demonstrates the problem in isolation&lt;/p&gt;</comment>
                            <comment id="17219126" author="mstratto" created="Thu, 22 Oct 2020 16:00:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&#160;any idea if this fix was backported into a Red Hat GA build of activemq? I am seeing a very similar stack trace&#160;in versions 5.11.0.redhat-630371 and 5.11.0.redhat-630475:&lt;/p&gt;

&lt;p&gt;```&lt;br/&gt;
2020-10-22 11:39:02,815 ERROR [ActiveMQ BrokerService&lt;span class=&quot;error&quot;&gt;&amp;#91;umb-node0-EaTtvz-001&amp;#93;&lt;/span&gt; Task-3] o.a.a.t.TaskRunnerFactory$1$1.uncaughtException:182 - Error in thread &apos;ActiveMQ BrokerService&lt;span class=&quot;error&quot;&gt;&amp;#91;umb-node0-EaTtvz-001&amp;#93;&lt;/span&gt; Task-3&apos; java.lang.NullPointerException: null at org.apache.activemq.openwire.v10.BaseDataStreamMarshaller.tightMarshalByteSequence2(BaseDataStreamMarshaller.java:430) at org.apache.activemq.openwire.v10.MessageMarshaller.tightMarshal2(MessageMarshaller.java:182) at org.apache.activemq.openwire.v10.ActiveMQMessageMarshaller.tightMarshal2(ActiveMQMessageMarshaller.java:89) at org.apache.activemq.openwire.v10.ActiveMQTextMessageMarshaller.tightMarshal2(ActiveMQTextMessageMarshaller.java:89) at org.apache.activemq.openwire.OpenWireFormat.tightMarshalNestedObject2(OpenWireFormat.java:417) at org.apache.activemq.openwire.v10.BaseDataStreamMarshaller.tightMarshalNestedObject2(BaseDataStreamMarshaller.java:135) at org.apache.activemq.openwire.v10.MessageDispatchMarshaller.tightMarshal2(MessageDispatchMarshaller.java:105) at org.apache.activemq.openwire.OpenWireFormat.marshal(OpenWireFormat.java:227) at org.apache.activemq.transport.tcp.TcpTransport.oneway(TcpTransport.java:175) at org.apache.activemq.transport.AbstractInactivityMonitor.doOnewaySend(AbstractInactivityMonitor.java:335) at org.apache.activemq.transport.AbstractInactivityMonitor.oneway(AbstractInactivityMonitor.java:317) at org.apache.activemq.transport.TransportFilter.oneway(TransportFilter.java:85) at org.apache.activemq.transport.WireFormatNegotiator.oneway(WireFormatNegotiator.java:116) at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:68) at org.apache.activemq.broker.TransportConnection.dispatch(TransportConnection.java:1456) at org.apache.activemq.broker.TransportConnection.processDispatch(TransportConnection.java:966) at org.apache.activemq.broker.TransportConnection.iterate(TransportConnection.java:1016) at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:133) at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:48) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
```&lt;/p&gt;

&lt;p&gt;In particular we are getting this in a unit test for a broker network (broker A &amp;lt;-&amp;gt; broker B) with a topic producer on broker A and a topic consumer on broker B. Both these brokers are running in memory on the same JVM for the purposes of the test. We also tested with both producer and consumer on the same cluster and can reproduce. It also prompted me to check our staging environment where we have our current network of broker configuration sitting for QA (running amq version 5.11.0.redhat-630371), for some reason my logs dont have a stack trace but I am pretty sure this is the same problem since their appearance is correlated to when we switched from a single broker to a network of brokers:&lt;/p&gt;

&lt;p&gt;```&lt;/p&gt;

&lt;p&gt;2020-10-22T11:21:13.844-0400 ERROR 28028 &amp;#8212; [ActiveMQ BrokerService&lt;span class=&quot;error&quot;&gt;&amp;#91;HOSTNAME-REDACTED&amp;#93;&lt;/span&gt; Task-3498] o.a.activemq.thread.TaskRunnerFactory : Error in thread &apos;ActiveMQ BrokerService&lt;span class=&quot;error&quot;&gt;&amp;#91;HOSTNAME-REDACTED&amp;#93;&lt;/span&gt; Task-3498&apos; java.lang.NullPointerException: null&lt;/p&gt;

&lt;p&gt;```&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Is this the same issue and its just not fixed in the Red Hat build, or a similar issue maybe that needs to be investigated?&lt;/p&gt;</comment>
                            <comment id="17219578" author="gtully" created="Fri, 23 Oct 2020 09:45:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mstratto&quot; class=&quot;user-hover&quot; rel=&quot;mstratto&quot;&gt;mstratto&lt;/a&gt;&#160;that fix would have been back ported for sure. There must be some additional problem at play.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Can you share your unit test? Comments on&#160;&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7245&quot; title=&quot;ActiveMQ is throwing ClassCastExceptions inside the client library&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7245&quot;&gt;AMQ-7245&lt;/a&gt;&#160;point to topics being necessary which seems to correlate.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If there is something that can reproduce the issue it would be a great help.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13245787">AMQ-7245</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z09154:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>