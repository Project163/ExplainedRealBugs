<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:07:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5300] Inifinite loop when attempting to replay levelDB logs to rebuild index</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5300</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;While searching for a workaround for issue &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5284&quot; title=&quot;InvalidClassException when migrating LevelDB store from 5.9.1 to 5.10.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5284&quot;&gt;&lt;del&gt;AMQ-5284&lt;/del&gt;&lt;/a&gt;, I came across this issue.&lt;/p&gt;

&lt;p&gt;To work around the serialization issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5284&quot; title=&quot;InvalidClassException when migrating LevelDB store from 5.9.1 to 5.10.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5284&quot;&gt;&lt;del&gt;AMQ-5284&lt;/del&gt;&lt;/a&gt;), I deleted the index snapshots from the LevelDB datastore. This will replay the logs to regenerate the index. However, if a log rotation has already occurred, you will get an infinite loop upon restart.&lt;/p&gt;

&lt;p&gt;Here are the steps to reproduce what I am seeing:&lt;/p&gt;

&lt;p&gt;Configure ActiveMQ 5.10.0 to use a LevelDB data store with the log size of about 1MB.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;persistenceAdapter&amp;gt;
    &amp;lt;levelDB directory=&lt;span class=&quot;code-quote&quot;&gt;&quot;${activemq.data}/leveldb&quot;&lt;/span&gt; logSize=&lt;span class=&quot;code-quote&quot;&gt;&quot;1000000&quot;&lt;/span&gt; /&amp;gt;
&amp;lt;/persistenceAdapter&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then I started up the broker and published 10,000 persistent messages to a queue, causing the log files to rotate (twice in my case). I see the following files in the data store folder:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-rw-rw-r--. 1 user users 1000071 Jul 30 11:15 0000000000000000.log
-rw-rw-r--. 1 user users 1000009 Jul 30 11:16 00000000000f4287.log
drwxrwxr-x. 2 user users    4096 Jul 30 11:16 00000000001e84d0.index
-rw-rw-r--. 1 user users 1000000 Jul 30 11:17 00000000001e84d0.log
drwxrwxr-x. 2 user users    4096 Jul 30 11:11 dirty.index
-rw-rw-r--. 1 user users       0 Jul 30 11:11 lock
drwxrwxr-x. 2 user users    4096 Jul 30 11:11 plist.index
-rw-rw-r--. 1 user users      24 Jul 30 11:11 store-version.txt
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I then consume 5,000 messages, which causes the first log to be deleted since it is no longer being referenced. I see the following log statements:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2014-07-30 11:29:14,960 | DEBUG | Log no longer referenced: 0 | org.apache.activemq.leveldb.LevelDBClient | &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-2
2014-07-30 11:29:14,967 | DEBUG | Deleting log at 0 | org.apache.activemq.leveldb.LevelDBClient | &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And I see the remaining files in the data store folder (notice the 0000000000000000.log is gone):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-rw-rw-r--. 1 user users 1000009 Jul 30 11:16 00000000000f4287.log
-rw-rw-r--. 1 user users 1000011 Jul 30 11:29 00000000001e84d0.log
drwxrwxr-x. 2 user users    4096 Jul 30 11:29 00000000002dc71b.index
-rw-rw-r--. 1 user users 1000000 Jul 30 11:29 00000000002dc71b.log
drwxrwxr-x. 2 user users    4096 Jul 30 11:11 dirty.index
-rw-rw-r--. 1 user users       0 Jul 30 11:11 lock
drwxrwxr-x. 2 user users    4096 Jul 30 11:11 plist.index
-rw-rw-r--. 1 user users      24 Jul 30 11:11 store-version.txt
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At this point, I shut down the broker and here is the listing of what&apos;s left in the data store:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-rw-rw-r--. 1 user users 1000009 Jul 30 11:16 00000000000f4287.log
-rw-rw-r--. 1 user users 1000011 Jul 30 11:29 00000000001e84d0.log
-rw-rw-r--. 1 user users 1000000 Jul 30 11:29 00000000002dc71b.log
drwxrwxr-x. 2 user users    4096 Jul 30 11:36 0000000000301737.index
drwxrwxr-x. 2 user users    4096 Jul 30 11:11 dirty.index
drwxrwxr-x. 2 user users    4096 Jul 30 11:11 plist.index
-rw-rw-r--. 1 user users      24 Jul 30 11:11 store-version.txt
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I then delete the index folder within the data store (in my case &quot;0000000000301737.index&quot;). I am doing this to force a replay of the logs to regenerate the index (due to the serialization issue I ran into).&lt;/p&gt;

&lt;p&gt;And finally, this is the message I am getting once I start the broker back up (infinite loop of this same message, and I have to shut down the broker):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2014-07-30 11:40:27,415 | WARN  | No reader available &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; position: 0, log_infos: {1000071=LogInfo(/home/user/apache-activemq-5.10.0/data/leveldb/00000000000f4287.log,1000071,1000009), 2000080=LogInfo(/home/user/apache-activemq-5.10.0/data/leveldb/00000000001e84d0.log,2000080,1000011), 3000091=LogInfo(/home/user/apache-activemq-5.10.0/data/leveldb/00000000002dc71b.log,3000091,0)} | org.apache.activemq.leveldb.RecordLog | main
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Linux&lt;/p&gt;</environment>
        <key id="12730988">AMQ-5300</key>
            <summary>Inifinite loop when attempting to replay levelDB logs to rebuild index</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="vhle01">Vu Le</reporter>
                        <labels>
                    </labels>
                <created>Thu, 31 Jul 2014 03:47:40 +0000</created>
                <updated>Mon, 2 Mar 2015 13:45:42 +0000</updated>
                            <resolved>Wed, 7 Jan 2015 17:12:30 +0000</resolved>
                                    <version>5.9.1</version>
                    <version>5.10.0</version>
                                    <fixVersion>5.11.0</fixVersion>
                                    <component>LevelDB</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="14191683" author="anujkhandelwal" created="Fri, 31 Oct 2014 10:53:32 +0000"  >&lt;p&gt;I have seen exact same issue with my ActiveMQ broker (5.10). It looks like a bug, Can someone please take a look here ?&lt;/p&gt;</comment>
                            <comment id="14252456" author="burtonator" created="Thu, 18 Dec 2014 22:47:13 +0000"  >&lt;p&gt;I&apos;m having similar issues with corruption in AMQ.  could you upload your code for testing?  I can then test it to see if I have similar behavior.  &lt;/p&gt;

&lt;p&gt;I may be wrong I think your problem is that it CAN NOT recover in your situation because the log has been deleted and it has no index to start from.&lt;/p&gt;

&lt;p&gt;It should print a better message though.&lt;/p&gt;</comment>
                            <comment id="14267882" author="gtully" created="Wed, 7 Jan 2015 17:12:30 +0000"  >&lt;p&gt;fix and test in &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/activemq/commit/b54606b1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/activemq/commit/b54606b1&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14298185" author="altaflux" created="Fri, 30 Jan 2015 04:26:22 +0000"  >&lt;p&gt;Hi Good day,&lt;/p&gt;

&lt;p&gt;It seems this issue is not fixed as I have been able to replicated on Replicated Level DB and the lastest 5.11 snapshot. The levelDB corrupts even at the point that every time I kill current master the next slave to take the position starts doing the infinite loop. The only way to fix this is to delete the leveldb data from all ActiveMQ instances which obviously lets me without messages. I find this issue to be quite critical as it occurs even on graceful shut downs of ActiveMQ.&lt;/p&gt;

&lt;p&gt;I have a attached a copy of the logs and my levelDB directory. (If all messages on the Queue look the same is because they are, for testing purposes i send the same message over and over)&lt;br/&gt;
&lt;a href=&quot;https://drive.google.com/file/d/0B6ANh1aTzRg3S2Q2SVRUY0ZhT0k/view?usp=sharing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://drive.google.com/file/d/0B6ANh1aTzRg3S2Q2SVRUY0ZhT0k/view?usp=sharing&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;My settings are:&lt;br/&gt;
Ubuntu 14.04 64bit&lt;br/&gt;
leveldb jin linux-x64&lt;/p&gt;

&lt;p&gt;            &amp;lt;replicatedLevelDB&lt;br/&gt;
                    directory=&quot;${mailSystem.activeMQ.rebDB}&quot;&lt;br/&gt;
                    replicas=&quot;3&quot;&lt;br/&gt;
                    sync=&quot;local_mem&quot;&lt;br/&gt;
                    logSize=&quot;25413000&quot;&lt;br/&gt;
                    indexCompression=&quot;none&quot;&lt;br/&gt;
                    zkAddress=&quot;lstkmy90430:2181,lstkmy36606:2181,lstkmy52108:2181&quot;&lt;br/&gt;
                    zkPath=&quot;/activemq/leveldb-stores&quot;&lt;br/&gt;
                    /&amp;gt;&lt;/p&gt;
</comment>
                            <comment id="14343163" author="artem.karpenko" created="Mon, 2 Mar 2015 13:45:42 +0000"  >&lt;p&gt;Since this is resolved and specifically mentiones LevelDB, I&apos;ve opened another issue for Replicated LevelDB: &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5618&quot; title=&quot;Infinite loop in log replay with Replicated LevelDB&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5618&quot;&gt;&lt;del&gt;AMQ-5618&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>409060</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 38 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ydsn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>409056</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>