<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:45:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2622] ObjectMessage is [still] being serialized and de-serialized when using setObjectMessageSerializationDefered and setCopyMessageOnSend in local vm:// scenario</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2622</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I have outlined the problem in the following forum link: &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://old.nabble.com/URGENT-QUESTION:-AMQ-5.3.0-bug-or-configuration-error------ObjectMessage-is--still--being-serialized-when-using-setObjectMessageSerializationDefered-and-setCopyMessageOnSend-td27654579.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://old.nabble.com/URGENT-QUESTION:-AMQ-5.3.0-bug-or-configuration-error------ObjectMessage-is--still--being-serialized-when-using-setObjectMessageSerializationDefered-and-setCopyMessageOnSend-td27654579.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I have not created a JUnit test that demonstrates this, but here are the basic steps to reproduce this:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;create an embedded broker with no persistence, dedicatedTaskRunner = false, and optimizedDispatch = true&lt;/li&gt;
	&lt;li&gt;create the ActiveMQConnectionFactory and set the setObjectMessageSerializationDefered = TRUE and setCopyMessageOnSend = FALSE&lt;/li&gt;
	&lt;li&gt;create your connection from the factory&lt;/li&gt;
	&lt;li&gt;create a producer and &lt;span class=&quot;error&quot;&gt;&amp;#91;MessageListener&amp;#93;&lt;/span&gt; consumer against a Queue&lt;/li&gt;
	&lt;li&gt;create your own custom java object that implements Externalizable - this is important, because you will be able to set a breakpoint in the readExternal and writeExternal methods to see the 2 locations on the AMQ code where the message is copied - causing a serialization/de-serialization&lt;/li&gt;
	&lt;li&gt;create a new ObjectMessage and send it from the producer to the consumer&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The message will get serialized in ActiveMQConnection.java on this line &lt;span class=&quot;error&quot;&gt;&amp;#91;msg = msg.copy();&amp;#93;&lt;/span&gt; - see the linked forum issue for the code snippet and line numbers. &lt;/p&gt;

&lt;p&gt;NOTE: you will need to continue stepping the code through the complete dispatch process because it will go through a de-serialization phase as well when the call to getObject is called in the onMessage of the MessageListener.&lt;/p&gt;

&lt;p&gt;Please let me know if I can provide any more details - OR, if I&apos;m not setting something properly to keep the ObjectMessage from being serialized.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Bob&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows Server 2008 R2, 64-bit, binary download of ActiveMQ 5.3.0, Java 1.6.0_17 (64-bit), Eclipse 3.5 (64-bit), tomcat 6.0 (64-bit)&lt;/p&gt;</environment>
        <key id="12483504">AMQ-2622</key>
            <summary>ObjectMessage is [still] being serialized and de-serialized when using setObjectMessageSerializationDefered and setCopyMessageOnSend in local vm:// scenario</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="bob.deremer">Bob DeRemer</reporter>
                        <labels>
                    </labels>
                <created>Mon, 22 Feb 2010 16:21:54 +0000</created>
                <updated>Wed, 8 Sep 2010 11:25:52 +0000</updated>
                            <resolved>Wed, 8 Sep 2010 11:25:52 +0000</resolved>
                                    <version>5.3.0</version>
                                    <fixVersion>5.4.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12942269" author="slewis" created="Mon, 22 Feb 2010 21:16:21 +0000"  >&lt;p&gt;Here&apos;s a unit test patch that shows the problem, am currently looking into a fix for this also.&lt;/p&gt;</comment>
                            <comment id="12942177" author="gtully" created="Wed, 24 Mar 2010 13:52:10 +0000"  >&lt;p&gt;resolved in r927054&lt;/p&gt;

&lt;p&gt;ObjectMessage.copy is now respects setObjectMessageSerializationDefered&lt;/p&gt;</comment>
                            <comment id="12942758" author="thammoud" created="Wed, 2 Jun 2010 23:03:02 +0000"  >&lt;p&gt;Hi, I tested this fix and encountered a case where this mechanism does not seem to work properly. Here is the scenario we have:&lt;/p&gt;

&lt;p&gt;A server that has a producer. The producer communicates with the local broker using the vm://. There are local consumers that listen on the topic being published to in the same VM. All consumers that are local in the same VM work as advertised without any serialization thanks to this fix. &lt;/p&gt;

&lt;p&gt;Here is the problem:&lt;/p&gt;

&lt;p&gt;Remote consumers communicate to the broker using TCP for the same topic. When the producer sends the message to the destination, it is being sent over the vm:// and ObjectMessage has content set to null and a valid object. The broker then tries to send the message to the remote client with null contents causing errors.&lt;/p&gt;

&lt;p&gt;It seems that perhaps, ObjectMessage should override getContent() to detect this situation. i.e if object != null and content is null, then serialize first and then return the content. I am sure you have a better solution to this issue. Thanks.&lt;/p&gt;</comment>
                            <comment id="12942859" author="gtully" created="Wed, 8 Sep 2010 11:04:17 +0000"  >&lt;p&gt;when a deferred serializable message is marshaled it needs to serialize, as described in the case of a vm non serialized message to a topic with multiple consumers, some of which don&apos;t use vm: transport and as a result need marshaling.&lt;br/&gt;
Query ordering? if the non vm: consumer is dispatched to before the vm: consumer, will it negate the non serialization for the vm consumer?&lt;/p&gt;</comment>
                            <comment id="12942860" author="gtully" created="Wed, 8 Sep 2010 11:25:52 +0000"  >&lt;p&gt;resolved in r994990&lt;/p&gt;

&lt;p&gt;the issue of ordering disappears as each consumer gets its own copy, so an objects write operation will be called but reads will happen in unserialised copies. The serialisation is now called before marshalling which will only be invoked for non vm transports. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461627" name="unit-test.txt" size="8860" author="slewis" created="Mon, 22 Feb 2010 21:16:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14809</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 11 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ba8f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63770</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>