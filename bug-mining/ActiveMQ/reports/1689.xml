<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:57:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3746] Non Durable Topic subscription with prefetch=0, MessageConsumer.receivenowait() (or MessageConsumer.receive(timeout) hangs indefinitely</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3746</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Non Durable Topic subscription with prefetch=0, MessageConsumer.receivenowait() (or MessageConsumer.receive(timeout) hangs indefinitely.&lt;/p&gt;

&lt;p&gt;I get the following thread dump&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; prio=5 tid=7f996d000000 nid=0x105bc3000 in &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [105bc1000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (on object monitor)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
	- waiting on &amp;lt;7f39f1b30&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:485)
	at org.apache.activemq.SimplePriorityMessageDispatchChannel.dequeue(SimplePriorityMessageDispatchChannel.java:87)
	- locked &amp;lt;7f39f1b30&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)
	at org.apache.activemq.ActiveMQMessageConsumer.dequeue(ActiveMQMessageConsumer.java:468)
	at org.apache.activemq.ActiveMQMessageConsumer.receiveNoWait(ActiveMQMessageConsumer.java:621)
	at org.apache.activemq.usecases.TopicSubscriptionZeroPrefetchTest.testTopicConsumerPrefetchZero(TopicSubscriptionZeroPrefetchTest.java:71)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It seems the TopicSubscription does not support &quot;pullMessage&quot;.&lt;/p&gt;

&lt;p&gt;This only appears to impact Non Durable Topic Subscriptions. Durable Topic Subscriptions with prefetch=0 do &lt;b&gt;NOT&lt;/b&gt; exhibit this behavior.&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12544606">AMQ-3746</key>
            <summary>Non Durable Topic subscription with prefetch=0, MessageConsumer.receivenowait() (or MessageConsumer.receive(timeout) hangs indefinitely</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="pgfox">Pat Fox</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Feb 2012 13:07:16 +0000</created>
                <updated>Sun, 28 Oct 2012 18:58:43 +0000</updated>
                            <resolved>Sun, 28 Oct 2012 18:58:43 +0000</resolved>
                                    <version>5.5.1</version>
                                    <fixVersion>5.8.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13219178" author="pgfox" created="Wed, 29 Feb 2012 13:12:34 +0000"  >&lt;p&gt;attached a new junit testcase to illustrate issue.&lt;/p&gt;</comment>
                            <comment id="13219281" author="pgfox" created="Wed, 29 Feb 2012 15:29:24 +0000"  >&lt;p&gt;Perhaps rather than reaching a hanging state, the MessageConsumer could &quot;fail fast&quot; at creation time if prefetch=0 for non durable topic subscribers. &lt;/p&gt;

&lt;p&gt;To that effect, I have attached &quot;APotentialFixForAMQ-3746.patch&quot; where the ActiveMQMessageConsumer constructor does the following check.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	&lt;span class=&quot;code-comment&quot;&gt;// AMQ-3746
&lt;/span&gt;	&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; prefetch set to zero &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Non Durable topic Consumer, &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; a JMS Exception.
&lt;/span&gt;	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getPrefetchNumber() == 0 &amp;amp;&amp;amp; info.getDestination().isTopic() &amp;amp;&amp;amp; !isDurableSubscriber()){
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JMSException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot have a prefetch size of zero &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a Non Durable Topic Subscriber&quot;&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I hope the above check should isolate just Non Durable Topic consumers with prefetch=0, perhaps someone could review it? Maybe there is a cleverer way to resolve this issue?&lt;/p&gt;

&lt;p&gt;patch created off lastest revision (1295087)&lt;/p&gt;</comment>
                            <comment id="13219507" author="pgfox" created="Wed, 29 Feb 2012 20:25:46 +0000"  >&lt;p&gt;After applying &quot;APotentialFixForAMQ-3746.patch&quot; I noticed a change in exception behavior around the &quot;MessageListener&quot; case. Before applying the patch ActiveMQMessageConsumer.setMessageListener()&lt;br/&gt;
throws the JMSException below when prefetch=0.&lt;/p&gt;

&lt;p&gt;before patch:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;javax.jms.JMSException: Illegal prefetch size of zero. This setting is not supported &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; asynchronous consumers please set a value of at least 1
	at org.apache.activemq.ActiveMQMessageConsumer.setMessageListener(ActiveMQMessageConsumer.java:417)
	...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;after applying the patch the following exception is thrown when creating the ActiveMQMessageConsumer before ActiveMQMessageConsumer.setMessageListener() can be called. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;javax.jms.JMSException: Cannot have a prefetch size of zero &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a Non Durable Topic Subscriber
	at org.apache.activemq.ActiveMQMessageConsumer.&amp;lt;init&amp;gt;(ActiveMQMessageConsumer.java:245)
	at org.apache.activemq.ActiveMQSession.createConsumer(ActiveMQSession.java:1134)
	at org.apache.activemq.ActiveMQSession.createConsumer(ActiveMQSession.java:1078)
	at org.apache.activemq.ActiveMQSession.createConsumer(ActiveMQSession.java:991)
	at org.apache.activemq.ActiveMQSession.createConsumer(ActiveMQSession.java:964)
	...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;	

&lt;p&gt;Although it results in the same overall outcome, it does change the existing (correct) exception behavior.&lt;/p&gt;

&lt;p&gt;Hence not sure if &quot;Fail Fast&quot; in &quot;APotentialFixForAMQ-3746.patch&quot; is the best approach.&lt;/p&gt;</comment>
                            <comment id="13220435" author="tabish121" created="Thu, 1 Mar 2012 22:32:20 +0000"  >&lt;p&gt;Another potential fix is to actually allow TopicSubscription to work with a zero prefetch.  A pullMessage request could open a window to allow one topic message to get dispatched to the topic inside the pull time window given.  This basically allows the consumer to always be a slow consumer, and messages are stored based on the maxPendingMessageLimit.  Not sure what the use case for that would be but its possible.  Here&apos;s a rough patch that adds this, not tested very heavily. &lt;/p&gt;</comment>
                            <comment id="13458641" author="davsclaus" created="Wed, 19 Sep 2012 12:35:45 +0000"  >&lt;p&gt;Tim, sounds like a good idea.&lt;/p&gt;

&lt;p&gt;Maybe try to revisit your patch for the 5.8 release.&lt;/p&gt;</comment>
                            <comment id="13458648" author="gtully" created="Wed, 19 Sep 2012 12:41:55 +0000"  >&lt;p&gt;that reads very like the use case for a retroactive consumer. I would expect a poll to only work if there is something pending in the retroactive buffer. But a poll should not block for ever. That is really a bug.&lt;/p&gt;</comment>
                            <comment id="13485690" author="tabish121" created="Sun, 28 Oct 2012 18:58:43 +0000"  >&lt;p&gt;Fixed on trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12516743" name="AMQ-3746.txt" size="13010" author="tabish" created="Thu, 1 Mar 2012 22:32:20 +0000"/>
                            <attachment id="12516573" name="APotentialFixForAMQ-3746.patch" size="5121" author="pgfox" created="Wed, 29 Feb 2012 15:29:24 +0000"/>
                            <attachment id="12516559" name="TopicSubscriptionZeroPrefetchTest.patch" size="3771" author="pgfox" created="Wed, 29 Feb 2012 13:12:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>229792</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 4 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0amc7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59892</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>