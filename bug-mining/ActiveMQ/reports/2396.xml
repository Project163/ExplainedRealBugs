<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:07:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5396] Linkstealing causes deadlock when old client disconnects before link stealing adds the connection</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5396</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;During link stealing in progress if the old client(or connection) issues a disconnect can cause a deadlock due the order in which the locks are obtained on RegionBroker.addConnection and TransportConnection.processRemoveConneciton.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12748453">AMQ-5396</key>
            <summary>Linkstealing causes deadlock when old client disconnects before link stealing adds the connection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="sai.boorlagadda@gmail.com">Sai</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Oct 2014 23:31:42 +0000</created>
                <updated>Mon, 20 Oct 2014 23:08:02 +0000</updated>
                            <resolved>Mon, 20 Oct 2014 23:08:02 +0000</resolved>
                                    <version>5.11.0</version>
                                    <fixVersion>5.11.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14174543" author="sai.boorlagadda@gmail.com" created="Fri, 17 Oct 2014 00:43:55 +0000"  >&lt;p&gt;attached the jstack which shows the deadlock&lt;/p&gt;</comment>
                            <comment id="14175667" author="workanandr" created="Fri, 17 Oct 2014 22:50:32 +0000"  >&lt;p&gt;Test case to reproduce this (with Mqtt Paho client lib):&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;In the broker source, in activemq-broker/src/main/java/org/apache/activemq/broker/region/RegionBroker.java add sleep between the 2 lines in function addConnection() as shown below:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                            TransportConnection transportConnection = (TransportConnection) connection;
                             Thread.sleep(30000);
                             transportConnection.stopAsync();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Run the broker&lt;/li&gt;
	&lt;li&gt;Run the following test case:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    @Test
    public void testLinkStealingDeadlock2() throws MqttException, InterruptedException
    {
        MqttClient client1 = new MqttClient(&quot;tcp://localhost:1883&quot;, &quot;client1&quot;);

        client1.connect();

        Thread thread = new Thread(new Runnable() {
            @Override
            public void run() {
                try {
                    System.out.println(&quot;Connecting client 2....&quot;);
                    MqttClient client2 = new MqttClient(&quot;tcp://localhost:1883&quot;, &quot;client1&quot;); // should be same client id
                    client2.connect();
                    System.out.println(&quot;Done connecting client2&quot;);
                } catch (MqttException e) {
                    // TODO Auto-generated catch block
                    e.printStackTrace();
                }
            }
        });
        thread.start(); 
        Thread.sleep(2000);
        System.out.println(&quot;Disconnecting client1...&quot;);
        client1.disconnect();

        System.out.println(&quot;Connecting client3...&quot;);
        MqttClient client3 = new MqttClient(&quot;tcp://localhost:1883&quot;, &quot;client3&quot;);
        client3.connect();

        System.out.println(&quot;Client3 connected&quot;);

        client3.disconnect();


        Thread.sleep(120*1000);
        Assert.assertTrue(true);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Run jstack on the JVM&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14177622" author="tabish121" created="Mon, 20 Oct 2014 23:08:02 +0000"  >&lt;p&gt;Reviewed the patch a bit and it looks good.  The old context can be safely used outside the sync block as the stopAsync is thread safe and will only run once so if the owning connection closes first it will be fine.  I tweaked the patch a bit to avoid the log output when old context is null, as that would spam the logs.  &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12675416" name="jstack.txt" size="5316" author="sai.boorlagadda@gmail.com" created="Fri, 17 Oct 2014 02:26:06 +0000"/>
                            <attachment id="12675396" name="linkstealing-deadlock.patch" size="2715" author="sai.boorlagadda@gmail.com" created="Fri, 17 Oct 2014 00:41:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 5 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2182v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>