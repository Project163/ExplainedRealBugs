<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:02:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4837] LevelDB corrupted when in a replication cluster</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4837</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I have clustered 3 ActiveMQ instances using replicated leveldb and zookeeper. When performing some tests using Web UI, I can across issues that appears to corrupt the leveldb data files.&lt;/p&gt;

&lt;p&gt;The issue can be replicated by performing the following steps:&lt;br/&gt;
1.	Start 3 activemq nodes.&lt;br/&gt;
2.	Push a message to the master (Node1) and browse the queue using the web UI&lt;br/&gt;
3.	Stop master node (Node1)&lt;br/&gt;
4.	Push a message to the new master (Node2) and browse the queue using the web UI. Message summary and queue content ok.&lt;br/&gt;
5.	Start Node1&lt;br/&gt;
6.	Stop master node (Node2)&lt;br/&gt;
7.	Browse the queue using the web UI on new master (Node3). Message summary ok however when clicking on the queue, no message details. An error (see below) is logged by the master, which attempts a restart.&lt;/p&gt;

&lt;p&gt;From this point, the database appears to be corrupted and the same error occurs to each node infinitely (shutdown/restart). The only way around is to stop the nodes and clear the data files.&lt;/p&gt;

&lt;p&gt;However when a message is pushed between step 5 and 6, the error doesn&#8217;t occur.&lt;/p&gt;

&lt;p&gt;=================================&lt;br/&gt;
Leveldb configuration on the 3 instances:&lt;br/&gt;
		&amp;lt;persistenceAdapter&amp;gt;&lt;br/&gt;
			&amp;lt;replicatedLevelDB&lt;br/&gt;
					directory=&quot;${activemq.data}/leveldb&quot;&lt;br/&gt;
					replicas=&quot;3&quot;&lt;br/&gt;
					bind=&quot;tcp://0.0.0.0:0&quot;&lt;br/&gt;
					zkAddress=&quot;zkserver:2181&quot;&lt;br/&gt;
					zkPath=&quot;/activemq/leveldb-stores&quot;&lt;br/&gt;
					/&amp;gt;&lt;br/&gt;
		&amp;lt;/persistenceAdapter&amp;gt;&lt;/p&gt;

&lt;p&gt;=================================&lt;br/&gt;
The error is:&lt;br/&gt;
INFO | Stopping BrokerService&lt;span class=&quot;error&quot;&gt;&amp;#91;localhost&amp;#93;&lt;/span&gt; due to exception, java.io.IOException&lt;br/&gt;
java.io.IOException&lt;br/&gt;
        at org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:39)&lt;br/&gt;
        at org.apache.activemq.leveldb.LevelDBClient.might_fail(LevelDBClient.scala:543)&lt;br/&gt;
        at org.apache.activemq.leveldb.LevelDBClient.might_fail_using_index(LevelDBClient.scala:974)&lt;br/&gt;
        at org.apache.activemq.leveldb.LevelDBClient.collectionCursor(LevelDBClient.scala:1270)&lt;br/&gt;
        at org.apache.activemq.leveldb.LevelDBClient.queueCursor(LevelDBClient.scala:1194)&lt;br/&gt;
        at org.apache.activemq.leveldb.DBManager.cursorMessages(DBManager.scala:708)&lt;br/&gt;
       at org.apache.activemq.leveldb.LevelDBStore$LevelDBMessageStore.recoverNextMessages(LevelDBStore.scala:741)&lt;br/&gt;
        at org.apache.activemq.broker.region.cursors.QueueStorePrefetch.doFillBatch(QueueStorePrefetch.java:106)&lt;br/&gt;
        at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:258)&lt;br/&gt;
        at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.reset(AbstractStoreCursor.java:108)&lt;br/&gt;
        at org.apache.activemq.broker.region.cursors.StoreQueueCursor.reset(StoreQueueCursor.java:157)&lt;br/&gt;
        at org.apache.activemq.broker.region.Queue.doPageInForDispatch(Queue.java:1875)&lt;br/&gt;
        at org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:2086)&lt;br/&gt;
        at org.apache.activemq.broker.region.Queue.iterate(Queue.java:1581)&lt;br/&gt;
        at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:129)&lt;br/&gt;
        at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:47)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:722)&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
        at org.apache.activemq.leveldb.LevelDBClient$$anonfun$queueCursor$1.apply(LevelDBClient.scala:1198)&lt;br/&gt;
        at org.apache.activemq.leveldb.LevelDBClient$$anonfun$queueCursor$1.apply(LevelDBClient.scala:1194)&lt;br/&gt;
        at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1$$anonfun$apply$mcV$sp$12.apply(LevelDBClient.scala:1272)&lt;br/&gt;
        at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1$$anonfun$apply$mcV$sp$12.apply(LevelDBClient.scala:1271)&lt;br/&gt;
        at org.apache.activemq.leveldb.LevelDBClient$RichDB.check$4(LevelDBClient.scala:315)&lt;br/&gt;
        at org.apache.activemq.leveldb.LevelDBClient$RichDB.cursorRange(LevelDBClient.scala:317)&lt;br/&gt;
        at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1.apply$mcV$sp(LevelDBClient.scala:1271)&lt;br/&gt;
        at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1.apply(LevelDBClient.scala:1271)&lt;br/&gt;
        at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1.apply(LevelDBClient.scala:1271)&lt;br/&gt;
        at org.apache.activemq.leveldb.LevelDBClient.usingIndex(LevelDBClient.scala:968)&lt;br/&gt;
        at org.apache.activemq.leveldb.LevelDBClient$$anonfun$might_fail_using_index$1.apply(LevelDBClient.scala:974)&lt;br/&gt;
        at org.apache.activemq.leveldb.LevelDBClient.might_fail(LevelDBClient.scala:540)&lt;br/&gt;
        ... 17 more&lt;/p&gt;
</description>
                <environment>&lt;p&gt;CentOS, Linux version 2.6.32-71.29.1.el6.x86_64&lt;br/&gt;
java-1.7.0-openjdk.x86_64/java-1.6.0-openjdk.x86_64&lt;br/&gt;
zookeeper-3.4.5.2&lt;/p&gt;</environment>
        <key id="12676619">AMQ-4837</key>
            <summary>LevelDB corrupted when in a replication cluster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chirino">Hiram R. Chirino</assignee>
                                    <reporter username="Gnome">Guillaume</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 Oct 2013 12:38:29 +0000</created>
                <updated>Wed, 12 Mar 2014 03:03:07 +0000</updated>
                            <resolved>Thu, 16 Jan 2014 17:45:44 +0000</resolved>
                                    <version>5.9.0</version>
                                    <fixVersion>5.9.1</fixVersion>
                    <fixVersion>5.10.0</fixVersion>
                                    <component>LevelDB</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13809037" author="gnome" created="Wed, 30 Oct 2013 12:47:21 +0000"  >&lt;p&gt;Attached the ActiveMQ configuration and the logs of the 3 nodes. &lt;br/&gt;
WRK01 is first elected as Master, then WRK02, then WRK03 (fails).&lt;/p&gt;</comment>
                            <comment id="13809251" author="gnome" created="Wed, 30 Oct 2013 15:44:18 +0000"  >&lt;p&gt;Note that the problem also occurs when the replication sync parameter is set to quorum_disk and quorum_mem.&lt;/p&gt;</comment>
                            <comment id="13809299" author="chirino" created="Wed, 30 Oct 2013 16:32:30 +0000"  >&lt;p&gt;Looking into it...&lt;/p&gt;</comment>
                            <comment id="13809313" author="chirino" created="Wed, 30 Oct 2013 16:44:10 +0000"  >&lt;p&gt;I failed to reproduce using the procedure outlined.  I was testing on 3 Fedora Core 18 VMs.&lt;/p&gt;

&lt;p&gt;I was pushing messages using the example in: examples/openwire/swissarmy&lt;br/&gt;
and running: ant producer -Durl=&apos;failover:(tcp://demo01:61616,tcp://demo02:61616,tcp://demo03:61616)&apos; -Ddurable=true -Dtopic=false -Dmax=10&lt;/p&gt;

&lt;p&gt;I was just browsing the queue using the new hawtio web console.  Not really drilling into each of the messages.&lt;/p&gt;

&lt;p&gt;Guillaume, could you add more details on how you you&apos;ve been reproducing.  How you adding the messages?  Perhaps the number and size of the messages makes a difference.&lt;/p&gt;</comment>
                            <comment id="13809398" author="gnome" created="Wed, 30 Oct 2013 17:44:37 +0000"  >&lt;p&gt;Hi Hiram,&lt;br/&gt;
I was using the activemq web console to send messages (destination: default foo.bar, default content and Persistent option ticked), to view the queue summary and to display the list of messages.&lt;br/&gt;
I have performed a couple of tests using the swissarmy example. I cannot reproduce the issue with 10 messages. However I managed to reproduce the problem when sending 1 message at the time (other parameter similar to yours). I am using the default activemq UI to view the queue summary and looking the queue content - which triggers the error at step 7.&lt;/p&gt;</comment>
                            <comment id="13809446" author="chirino" created="Wed, 30 Oct 2013 18:25:11 +0000"  >&lt;p&gt;Ok. thx. I was able to reproduce.. looking into the root cause now.&lt;/p&gt;</comment>
                            <comment id="13810429" author="chirino" created="Thu, 31 Oct 2013 16:58:45 +0000"  >&lt;p&gt;unit test for this issue can be found at: &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/activemq/blob/trunk/activemq-leveldb-store/src/test/java/org/apache/activemq/leveldb/test/ReplicatedLevelDBBrokerTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/trunk/activemq-leveldb-store/src/test/java/org/apache/activemq/leveldb/test/ReplicatedLevelDBBrokerTest.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It was intermittently failing for me.&lt;/p&gt;</comment>
                            <comment id="13810453" author="chirino" created="Thu, 31 Oct 2013 17:23:19 +0000"  >&lt;p&gt;Hi Guillaume,&lt;/p&gt;

&lt;p&gt;I think I&apos;ve fixed this issue now.  If you get a chance could you verify against the following build:&lt;br/&gt;
&lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.10-SNAPSHOT/apache-activemq-5.10-20131031.171656-11-bin.tar.gz&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.10-SNAPSHOT/apache-activemq-5.10-20131031.171656-11-bin.tar.gz&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13810473" author="chirino" created="Thu, 31 Oct 2013 17:41:17 +0000"  >&lt;p&gt;Ah.. hold off.. I&apos;m still seeing the issue.  Need better unit test.&lt;/p&gt;</comment>
                            <comment id="13811515" author="chirino" created="Fri, 1 Nov 2013 18:06:30 +0000"  >&lt;p&gt;Hi Guillaume,&lt;/p&gt;

&lt;p&gt;Ok. I think I got it this time.  Could you check this build for me?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.10-SNAPSHOT/apache-activemq-5.10-20131101.162431-14-bin.tar.gz&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.10-SNAPSHOT/apache-activemq-5.10-20131101.162431-14-bin.tar.gz&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13813026" author="gnome" created="Mon, 4 Nov 2013 17:17:47 +0000"  >&lt;p&gt;Hi Hiram, unfortunately I reproduced the issue with this build - using the army swiss example and sending 1 message at the time.&lt;/p&gt;</comment>
                            <comment id="13814892" author="chirino" created="Wed, 6 Nov 2013 13:48:57 +0000"  >&lt;p&gt;Weird.  I can&apos;t reproduce anymore with the latest build.  Perhaps the build I linked to in the issue did not have the fix.  Here&apos;s a link to a fresh build:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.10-SNAPSHOT/apache-activemq-5.10-20131106.134045-17-bin.tar.gz&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.10-SNAPSHOT/apache-activemq-5.10-20131106.134045-17-bin.tar.gz&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Could you double check again?&lt;/p&gt;</comment>
                            <comment id="13825308" author="meurwinn" created="Mon, 18 Nov 2013 13:26:16 +0000"  >&lt;p&gt;I, we have exectly the same error but in a non clustered environment.&lt;/p&gt;

&lt;p&gt;We&apos;re using AMQ 5.9 with level db basic configuration.&lt;/p&gt;

&lt;p&gt;We can reproduce it whis about 280 messages per second in a durable topic with one consumer.&lt;br/&gt;
The dispatched queue is around 0 to 150 messages.&lt;/p&gt;

&lt;p&gt;The error occurs after 1h 50 min processing.&lt;/p&gt;

&lt;p&gt;Erros :&lt;br/&gt;
2013-11-18 11:52:07,279 | INFO  | Stopping BrokerService&lt;span class=&quot;error&quot;&gt;&amp;#91;localhost&amp;#93;&lt;/span&gt; due to exception, java.io.IOException | org.apache.activemq.util.DefaultIOExceptionHandler | LevelDB IOException handler.&lt;br/&gt;
java.io.IOException&lt;br/&gt;
	at org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:39)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient.might_fail(LevelDBClient.scala:543)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient.might_fail_using_index(LevelDBClient.scala:974)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient.collectionCursor(LevelDBClient.scala:1270)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient.queueCursor(LevelDBClient.scala:1194)&lt;br/&gt;
	at org.apache.activemq.leveldb.DBManager.cursorMessages(DBManager.scala:708)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBStore$LevelDBMessageStore.recover(LevelDBStore.scala:733)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic.doBrowse(Topic.java:588)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic.access$100(Topic.java:65)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic$6.run(Topic.java:721)&lt;br/&gt;
	at org.apache.activemq.thread.SchedulerTimerTask.run(SchedulerTimerTask.java:33)&lt;br/&gt;
	at java.util.TimerThread.mainLoop(Unknown Source)&lt;br/&gt;
	at java.util.TimerThread.run(Unknown Source)&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$queueCursor$1.apply(LevelDBClient.scala:1198)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$queueCursor$1.apply(LevelDBClient.scala:1194)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1$$anonfun$apply$mcV$sp$12.apply(LevelDBClient.scala:1272)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1$$anonfun$apply$mcV$sp$12.apply(LevelDBClient.scala:1271)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$RichDB.check$4(LevelDBClient.scala:315)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$RichDB.cursorRange(LevelDBClient.scala:317)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1.apply$mcV$sp(LevelDBClient.scala:1271)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1.apply(LevelDBClient.scala:1271)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1.apply(LevelDBClient.scala:1271)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient.usingIndex(LevelDBClient.scala:968)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$might_fail_using_index$1.apply(LevelDBClient.scala:974)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient.might_fail(LevelDBClient.scala:540)&lt;br/&gt;
	... 11 more&lt;br/&gt;
2013-11-18 11:52:07,308 | INFO  | Apache ActiveMQ 5.9.0 (localhost, ID:SERVER-50960-1384765393652-0:1) is shutting down | org.apache.activemq.broker.BrokerService | IOExceptionHandler: stopping BrokerService&lt;span class=&quot;error&quot;&gt;&amp;#91;localhost&amp;#93;&lt;/span&gt;&lt;br/&gt;
2013-11-18 11:52:07,370 | WARN  | Failed to browse Topic: CHANGE_TOPIC | org.apache.activemq.broker.region.Topic | ActiveMQ Broker&lt;span class=&quot;error&quot;&gt;&amp;#91;localhost&amp;#93;&lt;/span&gt; Scheduler&lt;br/&gt;
org.apache.activemq.broker.SuppressReplyException: ShutdownBrokerInitiated&lt;br/&gt;
	at org.apache.activemq.util.DefaultIOExceptionHandler.handle(DefaultIOExceptionHandler.java:134)&lt;br/&gt;
	at org.apache.activemq.broker.BrokerService.handleIOException(BrokerService.java:2526)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anon$2.run(LevelDBClient.scala:521)&lt;br/&gt;
Caused by: java.io.IOException&lt;br/&gt;
	at org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:39)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient.might_fail(LevelDBClient.scala:543)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient.might_fail_using_index(LevelDBClient.scala:974)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient.collectionCursor(LevelDBClient.scala:1270)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient.queueCursor(LevelDBClient.scala:1194)&lt;br/&gt;
	at org.apache.activemq.leveldb.DBManager.cursorMessages(DBManager.scala:708)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBStore$LevelDBMessageStore.recover(LevelDBStore.scala:733)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic.doBrowse(Topic.java:588)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic.access$100(Topic.java:65)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic$6.run(Topic.java:721)&lt;br/&gt;
	at org.apache.activemq.thread.SchedulerTimerTask.run(SchedulerTimerTask.java:33)&lt;br/&gt;
	at java.util.TimerThread.mainLoop(Unknown Source)&lt;br/&gt;
	at java.util.TimerThread.run(Unknown Source)&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$queueCursor$1.apply(LevelDBClient.scala:1198)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$queueCursor$1.apply(LevelDBClient.scala:1194)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1$$anonfun$apply$mcV$sp$12.apply(LevelDBClient.scala:1272)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1$$anonfun$apply$mcV$sp$12.apply(LevelDBClient.scala:1271)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$RichDB.check$4(LevelDBClient.scala:315)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$RichDB.cursorRange(LevelDBClient.scala:317)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1.apply$mcV$sp(LevelDBClient.scala:1271)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1.apply(LevelDBClient.scala:1271)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1.apply(LevelDBClient.scala:1271)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient.usingIndex(LevelDBClient.scala:968)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$might_fail_using_index$1.apply(LevelDBClient.scala:974)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient.might_fail(LevelDBClient.scala:540)&lt;br/&gt;
	... 11 more&lt;br/&gt;
2013-11-18 11:52:07,470 | INFO  | Stopped LevelDB&lt;span class=&quot;error&quot;&gt;&amp;#91;C:\TEST\apache-activemq-5.9.0\bin\..\data\LevelDB&amp;#93;&lt;/span&gt; | org.apache.activemq.leveldb.LevelDBStore | LevelDB IOException handler.&lt;br/&gt;
2013-11-18 11:52:13,821 | INFO  | The connection to &apos;tcp://127.0.0.1:59574&apos; is taking a long time to shutdown. | org.apache.activemq.broker.TransportConnection | IOExceptionHandler: stopping BrokerService&lt;span class=&quot;error&quot;&gt;&amp;#91;localhost&amp;#93;&lt;/span&gt;&lt;br/&gt;
2013-11-18 11:52:18,823 | INFO  | The connection to &apos;tcp://127.0.0.1:59574&apos; is taking a long time to shutdown. | org.apache.activemq.broker.TransportConnection | IOExceptionHandler: stopping BrokerService&lt;span class=&quot;error&quot;&gt;&amp;#91;localhost&amp;#93;&lt;/span&gt;&lt;br/&gt;
2013-11-18 11:52:23,854 | INFO  | The connection to &apos;tcp://127.0.0.1:59574&apos; is taking a long time to shutdown. | org.apache.activemq.broker.TransportConnection | IOExceptionHandler: stopping BrokerService&lt;span class=&quot;error&quot;&gt;&amp;#91;localhost&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="13825318" author="chirino" created="Mon, 18 Nov 2013 13:44:44 +0000"  >&lt;p&gt;Tenzin,&lt;/p&gt;

&lt;p&gt;Does it also happen with a fresh SNAPSHOT build?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://repository.apache.org/service/local/artifact/maven/redirect?r=snapshots&amp;amp;g=org.apache.activemq&amp;amp;a=apache-activemq&amp;amp;v=5.10-SNAPSHOT&amp;amp;e=tar.gz&amp;amp;c=bin&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://repository.apache.org/service/local/artifact/maven/redirect?r=snapshots&amp;amp;g=org.apache.activemq&amp;amp;a=apache-activemq&amp;amp;v=5.10-SNAPSHOT&amp;amp;e=tar.gz&amp;amp;c=bin&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13825334" author="meurwinn" created="Mon, 18 Nov 2013 14:06:46 +0000"  >&lt;p&gt;I&apos;ve reproduce one more time the error so i&apos;m trying with the snapshot but i&apos;m on Windows server so the snapshot that i&apos;m testing is this one :&lt;br/&gt;
&lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.10-SNAPSHOT/apache-activemq-5.10-20131115.231503-20-bin.zip&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.10-SNAPSHOT/apache-activemq-5.10-20131115.231503-20-bin.zip&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="13826331" author="meurwinn" created="Tue, 19 Nov 2013 09:06:38 +0000"  >&lt;p&gt;Hi,&lt;br/&gt;
the broker stopped 3 times this night after about 6h50min, then 6h50 min then 50min.&lt;br/&gt;
The error sounds to be the sa&#249;me (except the line number in class) but the broker restart automaticly with the snapshot. &lt;/p&gt;

&lt;p&gt;2013-11-19 05:27:43,671 | INFO  | Stopping BrokerService&lt;span class=&quot;error&quot;&gt;&amp;#91;localhost&amp;#93;&lt;/span&gt; due to exception, java.io.IOException | org.apache.activemq.util.DefaultIOExceptionHandler | LevelDB IOException handler.&lt;br/&gt;
java.io.IOException&lt;br/&gt;
	at org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:39)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient.might_fail(LevelDBClient.scala:554)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient.might_fail_using_index(LevelDBClient.scala:1021)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient.collectionCursor(LevelDBClient.scala:1320)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient.queueCursor(LevelDBClient.scala:1244)&lt;br/&gt;
	at org.apache.activemq.leveldb.DBManager.cursorMessages(DBManager.scala:708)&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBStore$LevelDBMessageStore.recover(LevelDBStore.scala:747)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic.doBrowse(Topic.java:588)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic.access$100(Topic.java:65)&lt;br/&gt;
	at org.apache.activemq.broker.region.Topic$6.run(Topic.java:721)&lt;br/&gt;
	at org.apache.activemq.thread.SchedulerTimerTask.run(SchedulerTimerTask.java:33)&lt;br/&gt;
	at java.util.TimerThread.mainLoop(Unknown Source)&lt;br/&gt;
	at java.util.TimerThread.run(Unknown Source)&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$queueCursor$1.apply(LevelDBClient.scala:1248)&lt;/p&gt;

&lt;p&gt;It&apos;s not easy to reproduce. It&apos;s better with the snapshot but i can&apos;t say that no messages are lost with leveldb.&lt;/p&gt;</comment>
                            <comment id="13826530" author="chirino" created="Tue, 19 Nov 2013 13:59:19 +0000"  >&lt;p&gt;Ok.. so right now it just seems like the master is rebooting due to an error that a new slave seems to recover from right?&lt;/p&gt;</comment>
                            <comment id="13826571" author="meurwinn" created="Tue, 19 Nov 2013 15:09:19 +0000"  >&lt;p&gt;I&apos;m not in a clustered environment, so there is on one node (that&apos;s the difference with Guillaume).&lt;/p&gt;</comment>
                            <comment id="13827654" author="meurwinn" created="Wed, 20 Nov 2013 13:40:24 +0000"  >&lt;p&gt;I&apos;ve try this night with AMQ 5.9 levelDb (no cluster) in case of 30 messages / s and there is no error or reboot (about 17h processing).&lt;/p&gt;

&lt;p&gt;So the error appends only with a minimum of messages per second (200 or more).&lt;/p&gt;</comment>
                            <comment id="13829814" author="gnome" created="Fri, 22 Nov 2013 09:19:45 +0000"  >&lt;p&gt;Hiram, Sorry for the delay in testing the fix. I will try to come back to you at the beginning of next week.&lt;/p&gt;</comment>
                            <comment id="13831529" author="meurwinn" created="Mon, 25 Nov 2013 15:12:56 +0000"  >&lt;p&gt;Hi,&lt;br/&gt;
some news ! my AMQ is processing 50 messages / s (1 producer/1 consumer, 1 persistent topic) since 3 days and it has failed 9 times, then reboot each time. &lt;br/&gt;
The messages are not lost, but each time it failed, the producer is waiting and it&apos;s not the best for us.&lt;br/&gt;
The best should be to solve the problem.&lt;/p&gt;

&lt;p&gt;The environment is NT and no cluster.&lt;br/&gt;
Maybe we could change the item title to &quot;LevelDB corrupted in AMQ (Cluster or Not)&quot; and the environment.&lt;/p&gt;</comment>
                            <comment id="13831593" author="chirino" created="Mon, 25 Nov 2013 16:04:49 +0000"  >&lt;p&gt;Hi Tenzin,&lt;/p&gt;

&lt;p&gt;Yeah if your setup is non-replicated, I&apos;d open a new issue to track the problem since this issue was originally opened on a problem that only affected replicated setups.&lt;/p&gt;

&lt;p&gt;Also it does not seem like the store gets &apos;corrupted&apos; since you don&apos;t loose messages after a restart.&lt;/p&gt;</comment>
                            <comment id="13831599" author="meurwinn" created="Mon, 25 Nov 2013 16:17:11 +0000"  >&lt;p&gt;Ok, sounds great, just give us the new issue number when it&apos;ll be done.&lt;br/&gt;
I&apos;m agree to test new snapshot if you need.&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="13832426" author="meurwinn" created="Tue, 26 Nov 2013 09:11:21 +0000"  >&lt;p&gt;Hi, bad news...&lt;br/&gt;
After 12 errors and automatic reboot, AMQ seems to be very very slow and accept only one messages/second from the producer.&lt;br/&gt;
Performances are OK after a manual restart.&lt;/p&gt;

&lt;p&gt;So, i stopped the AMQ and i had a lot of warning about &quot;Timer already cancelled&quot;.&lt;/p&gt;</comment>
                            <comment id="13834918" author="remogloor" created="Thu, 28 Nov 2013 15:20:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4882&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-4882&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;is the unclustered version of this problem. I can reproduce this by 100% just by starting some client that processes and enqueues messages while starting/stopping AMQ. After some restarts AMQ won&apos;t start anymore and the log contains the exception posted by others in this issue.&lt;/p&gt;</comment>
                            <comment id="13837814" author="chirino" created="Tue, 3 Dec 2013 15:48:21 +0000"  >&lt;p&gt;Hi Remo,&lt;/p&gt;

&lt;p&gt;Thanks.  Tenzin, does &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4882&quot; title=&quot;LevelDB can get to a corrupt state when using XA transactions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4882&quot;&gt;&lt;del&gt;AMQ-4882&lt;/del&gt;&lt;/a&gt; seem like your issue?&lt;/p&gt;</comment>
                            <comment id="13837842" author="meurwinn" created="Tue, 3 Dec 2013 16:16:58 +0000"  >&lt;p&gt;Hi Hiram,&lt;br/&gt;
the stack is the same, but the environment and the test procedure are not the same.&lt;/p&gt;

&lt;p&gt;I can reproduce it in a NON clustered/replicated environment.&lt;br/&gt;
The test procedure is easy : i send about 200 messages / second in a persiatant durable TOPIC. Messages are consume by only one consumer on real time.&lt;br/&gt;
A few time per day, AMQ FAILED with the same error as i ever posted (the same as Remo) and REBOOT automaticly (AMQ 5.9.0 FAILED and only try to stop).&lt;/p&gt;

&lt;p&gt;My second problem is that after maybe 10 automatic reboot (after failure), AMQ is very slow and accept only a few messages per second from the producer.&lt;/p&gt;</comment>
                            <comment id="13837905" author="chirino" created="Tue, 3 Dec 2013 17:07:29 +0000"  >&lt;p&gt;Tenzin, how big are the messages and are you using transactions?&lt;/p&gt;</comment>
                            <comment id="13837908" author="meurwinn" created="Tue, 3 Dec 2013 17:12:43 +0000"  >&lt;p&gt;Not shure, but i can remember that the average was probably about 4 000 bytes in my use case.&lt;/p&gt;</comment>
                            <comment id="13839034" author="chirino" created="Wed, 4 Dec 2013 16:05:16 +0000"  >&lt;p&gt;Tenzin, since your issue seems different I opened a new issue under &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4917&quot; title=&quot;LevelDB store can fail when using durable subs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4917&quot;&gt;&lt;del&gt;AMQ-4917&lt;/del&gt;&lt;/a&gt;.  It seems specifically related to durable subs.&lt;/p&gt;</comment>
                            <comment id="13850324" author="gnome" created="Tue, 17 Dec 2013 10:27:38 +0000"  >&lt;p&gt;Hiram, I can confirm that the problem raised in this ticket is resolved in the most recent build I could pick - apache-activemq-5.10-20131214.063224-32-bin.zip . &lt;br/&gt;
Thanks for this. Guillaume&lt;/p&gt;</comment>
                            <comment id="13873508" author="rajdavies" created="Thu, 16 Jan 2014 15:43:07 +0000"  >&lt;p&gt;is this resolved?&lt;/p&gt;</comment>
                            <comment id="13873655" author="chirino" created="Thu, 16 Jan 2014 17:45:45 +0000"  >&lt;p&gt;Marking issue as resolved since the fix was confirmed by Guillaume. Thx!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12679030">AMQ-4882</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12682713">AMQ-4917</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12611049" name="LevelDBCorrupted.zip" size="18044" author="Gnome" created="Wed, 30 Oct 2013 12:47:21 +0000"/>
                            <attachment id="12614384" name="activemq.xml" size="6070" author="meurwinn" created="Mon, 18 Nov 2013 13:22:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356051</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 44 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1pdqv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356339</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>