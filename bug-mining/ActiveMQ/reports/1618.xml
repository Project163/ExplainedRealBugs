<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:56:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3451] Tomcat 6.0.32 complains that ActiveMQ 5.5 doesn&apos;t shutdown a thread</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3451</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Every time when restarting web application in Tomcat Manager I get messages:&lt;/p&gt;

&lt;p&gt;SEVERE: The web application &lt;span class=&quot;error&quot;&gt;&amp;#91;/sms&amp;#93;&lt;/span&gt; appears to have started a thread named &lt;span class=&quot;error&quot;&gt;&amp;#91;ActiveMQ Task-3&amp;#93;&lt;/span&gt; but has failed to stop it. This is very likely to create a memory leak.&lt;/p&gt;

&lt;p&gt;With every restart PermGen space is increased and finally i got OutOfMemory error for PermGen space.&lt;/p&gt;

&lt;p&gt;I use Spring DefaultMessageListenerContainer, and it&apos;s shutdown method closes properly receivers threads. What is &quot;ActiveMQ Task-3&quot; thread and how to close it properly ?&lt;/p&gt;</description>
                <environment>&lt;p&gt;jdk 1.6.0_23 for Linux 64 bit, Ubuntu 11.04&lt;br/&gt;
Tomcat 6.0.32&lt;br/&gt;
Spring 3.0.5&lt;/p&gt;</environment>
        <key id="12518840">AMQ-3451</key>
            <summary>Tomcat 6.0.32 complains that ActiveMQ 5.5 doesn&apos;t shutdown a thread</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="beowulf">John Miller</reporter>
                        <labels>
                            <label>leak</label>
                            <label>resource</label>
                    </labels>
                <created>Sun, 14 Aug 2011 20:18:24 +0000</created>
                <updated>Thu, 16 Feb 2017 08:02:41 +0000</updated>
                            <resolved>Sun, 9 Sep 2012 08:39:38 +0000</resolved>
                                    <version>5.5.0</version>
                                    <fixVersion>5.7.0</fixVersion>
                                    <component>JMS client</component>
                        <due></due>
                            <votes>11</votes>
                                    <watches>15</watches>
                                                                                                                <comments>
                            <comment id="13084896" author="beowulf" created="Sun, 14 Aug 2011 20:22:11 +0000"  >&lt;p&gt;My connection factory is declared in web.xml&lt;/p&gt;

&lt;p&gt;&amp;lt;!-- Standalone ActiveMQ --&amp;gt;       &lt;br/&gt;
     &amp;lt;Resource name=&quot;jms/connectionFactory&quot; auth=&quot;Container&quot; type=&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;&lt;br/&gt;
            description=&quot;Repository JMS Connection Factory&quot; factory=&quot;org.apache.activemq.jndi.JNDIReferenceFactory&quot;&lt;br/&gt;
            brokerURL=&quot;failover:(tcp://localhost:61616)?timeout=3000&amp;amp;jms.redeliveryPolicy.maximumRedeliveries=2&amp;amp;jms.redeliveryPolicy.initialRedeliveryDelay=3000L&amp;amp;jms.redeliveryPolicy.useExponentialBackOff=false&quot;&lt;br/&gt;
            brokerName=&quot;LocalActiveMQBroker&quot;/&amp;gt;&lt;/p&gt;</comment>
                            <comment id="13085016" author="beowulf" created="Mon, 15 Aug 2011 10:41:08 +0000"  >&lt;p&gt;Duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2852&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-2852&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13085017" author="beowulf" created="Mon, 15 Aug 2011 10:41:31 +0000"  >&lt;p&gt;Duplicate&lt;/p&gt;</comment>
                            <comment id="13085019" author="beowulf" created="Mon, 15 Aug 2011 10:47:43 +0000"  >&lt;p&gt;Linked a similar issue, not sure if this is a duplicate.&lt;/p&gt;</comment>
                            <comment id="13095327" author="gtully" created="Thu, 1 Sep 2011 14:48:53 +0000"  >&lt;p&gt;does calling: org.apache.activemq.thread.DefaultThreadPools#shutdown work for you? I guess it would need to be part of a javax.servlet.ServletContextListener or called as part of the shutdown of your message listener container.&lt;br/&gt;
I guess we would need to include a little helper class to make it easier to configure.&lt;/p&gt;</comment>
                            <comment id="13104531" author="ravimbhatt" created="Wed, 14 Sep 2011 14:38:16 +0000"  >&lt;p&gt;I am having similar issue where tomcat does not shut down properly because of activemq threads. &lt;/p&gt;

&lt;p&gt;I tried above solution org.apache.activemq.thread.DefaultThreadPools#shutdown, it does not help. I called this inside my contextDestroyed in tomcat, and it makes no difference to the situation.&lt;/p&gt;</comment>
                            <comment id="13104532" author="ravimbhatt" created="Wed, 14 Sep 2011 14:39:10 +0000"  >&lt;p&gt;and BTW i have tested this on tomcat 5, 6 and 7 with activemq 5.5.0&lt;/p&gt;

&lt;p&gt;The situation happens only when there were messages on the queue and messages where being processed inside onMessage of a listener. If there are no messages on the queue, it shuts down properly if we call connection close etc in cotextDestroyed.&lt;/p&gt;</comment>
                            <comment id="13128557" author="javich" created="Mon, 17 Oct 2011 01:23:43 +0000"  >&lt;p&gt;In my case the message appears regardless of the queue(s) being empty.&lt;/p&gt;

&lt;p&gt;Using activemq 5.5 with camel 2.8 and spring 3.0.5 deployed to tomcat 6.0.32&lt;/p&gt;

&lt;p&gt;Broker is set up locally using activemq camel component.&lt;/p&gt;
</comment>
                            <comment id="13138391" author="mbakhti" created="Fri, 28 Oct 2011 14:17:22 +0000"  >&lt;p&gt;I have the same issue in Activemq 5.5. &lt;br/&gt;
I tried :&lt;/p&gt;

&lt;p&gt;broker.getTaskRunnerFactory().shutdown();&lt;br/&gt;
broker.getPersistenceTaskRunnerFactory().shutdown();&lt;br/&gt;
broker.stop();&lt;br/&gt;
broker.waitUntilStopped();&lt;br/&gt;
Scheduler.shutdown();&lt;/p&gt;

&lt;p&gt;but it doesn&apos;t change anything &lt;/p&gt;</comment>
                            <comment id="13170863" author="andreas@apache.org" created="Fri, 16 Dec 2011 09:39:03 +0000"  >&lt;p&gt;For me the following seems to work:&lt;/p&gt;

&lt;p&gt;Interrupt the TCP transport socket handler daemon thread:&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Index: activemq-core/src/main/java/org/apache/activemq/transport/tcp/TcpTransportServer.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; activemq-core/src/main/java/org/apache/activemq/transport/tcp/TcpTransportServer.java	(revision 1214868)&lt;br/&gt;
+++ activemq-core/src/main/java/org/apache/activemq/transport/tcp/TcpTransportServer.java	(working copy)&lt;br/&gt;
@@ -380,6 +380,8 @@&lt;br/&gt;
         if (serverSocket != null) &lt;/p&gt;
{
             serverSocket.close();
         }
&lt;p&gt;+        this.socketHandlerThread.interrupt();&lt;br/&gt;
+        this.socketHandlerThread = null;&lt;br/&gt;
     }&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;Shutdown the task runner factory in a servlet context listener:&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;public class CleanupAmqThreads implements ServletContextListener {&lt;/p&gt;

&lt;p&gt;     @Override&lt;br/&gt;
         public void contextInitialized(ServletContextEvent sce) {&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     @Override&lt;br/&gt;
     public void contextDestroyed(ServletContextEvent sce) &lt;/p&gt;
{
         DefaultThreadPools.getDefaultTaskRunnerFactory().shutdown();
     }
&lt;p&gt;}&lt;/p&gt;</comment>
                            <comment id="13172356" author="dejanb" created="Mon, 19 Dec 2011 15:55:04 +0000"  >&lt;p&gt;Looked at some similar issue, and it seems to me it&apos;s just Tomcat doesn&apos;t like threads created for async closing of activemq connections. Try using URLs like&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;failover:(tcp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:61616?closeAsync=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and see if it helps.&lt;/p&gt;</comment>
                            <comment id="13184829" author="nilsga" created="Thu, 12 Jan 2012 08:48:22 +0000"  >&lt;p&gt;Same problem, using Active MQ 5.5.1. Tried with &quot;closeAsync=false&quot; which didn&apos;t seem to make any difference.&lt;/p&gt;</comment>
                            <comment id="13268345" author="grambal" created="Fri, 4 May 2012 13:18:22 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;Have you got a workaround to solve this issue ?&lt;/p&gt;

&lt;p&gt;Sincerely&lt;/p&gt;</comment>
                            <comment id="13413543" author="liny" created="Fri, 13 Jul 2012 07:30:05 +0000"  >&lt;p&gt;I have same issue after stop my application by Tomcat.&lt;br/&gt;
I don&apos;t know why ActiveMQ team doesn&apos;t fix it for a long time.&lt;/p&gt;</comment>
                            <comment id="13415845" author="liny" created="Tue, 17 Jul 2012 02:09:52 +0000"  >&lt;p&gt;I crated a war to reproduce this issue. Please refer to &lt;a href=&quot;http://activemq.2283324.n4.nabble.com/Old-issue-Memory-leak-after-stop-web-application-in-Tomcat-tp4653959p4654028.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.2283324.n4.nabble.com/Old-issue-Memory-leak-after-stop-web-application-in-Tomcat-tp4653959p4654028.html&lt;/a&gt;. Hope this is helpful.&lt;/p&gt;</comment>
                            <comment id="13416044" author="gtully" created="Tue, 17 Jul 2012 09:44:48 +0000"  >&lt;p&gt;@liny, thanks for that test case war. Peeking at the code, I think the problem is related to the code in com.foo.MainApplication#stop&lt;/p&gt;

&lt;p&gt;That closes the connection, (returns them to the pool), but does not stop the connection pool. It does however stop the executors, and this prevents the real close of the connections when the spring context calls the custom stop destroy method. This is evident from the &lt;tt&gt;ERROR o.a.a.transport.tcp.TcpTransport - Could not stop service: tcp://foo.com/15.87.14.93:61616. Reason: java.util.concurrent.RejectedExecutionException&lt;/tt&gt; exception.&lt;/p&gt;

&lt;p&gt;So you can explicitly call close on the connection pool, like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;conn.close();
((PooledConnectionFactory) springHelper.getBean(&lt;span class=&quot;code-quote&quot;&gt;&quot;pooledJmsFactory&quot;&lt;/span&gt;)).stop();
DefaultThreadPools.getDefaultTaskRunnerFactory().shutdown();
DefaultThreadPools.shutdown();&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;or somehow arrange it such that the calls to &lt;tt&gt;shutdown()&lt;/tt&gt; are done when the spring context is destroyed. So after the connection pool is successfully destroyed.&lt;/p&gt;</comment>
                            <comment id="13416089" author="liny" created="Tue, 17 Jul 2012 11:10:36 +0000"  >&lt;p&gt;@Gary &lt;br/&gt;
Thanks for reply. Directly call below method in my stop() still can&apos;t work.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;((PooledConnectionFactory) springHelper.getBean(&quot;pooledJmsFactory&quot;)).stop();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Please refer to &lt;a href=&quot;http://activemq.2283324.n4.nabble.com/Old-issue-Memory-leak-after-stop-web-application-in-Tomcat-tp4653959p4654084.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.2283324.n4.nabble.com/Old-issue-Memory-leak-after-stop-web-application-in-Tomcat-tp4653959p4654084.html&lt;/a&gt; for details.&lt;/p&gt;</comment>
                            <comment id="13427617" author="sgri" created="Thu, 2 Aug 2012 21:16:44 +0000"  >&lt;p&gt;The problem is that when you put ActiveMQ libraries into Tomcat shared &quot;lib&quot; folder, then ActiveMQ  thread pool becomes shared between all web applications. When a web application sends a message, then a transport thread is created by a web application, then the thread is returned to the pool. Then the web application is undeployed,  the thread remains alive in the pool and can be re-used by another applicaiton. In results into a memory leak, because the thread is still alive after undeployment of web application and references the web application context classloader.&lt;/p&gt;</comment>
                            <comment id="13427619" author="sgri" created="Thu, 2 Aug 2012 21:18:17 +0000"  >&lt;p&gt;Attached a screenshot with profiler which clearly shows a memory leak.&lt;/p&gt;</comment>
                            <comment id="13427629" author="sgri" created="Thu, 2 Aug 2012 21:23:12 +0000"  >&lt;p&gt;However, when I removed ActiveMQ libraries from tomcat shared libraries and packaged them into WAR, the problem has gone because each web application now has its own ActiveMQ thread pool.&lt;/p&gt;</comment>
                            <comment id="13427633" author="sgri" created="Thu, 2 Aug 2012 21:27:28 +0000"  >&lt;p&gt;You can&apos;t call org.apache.activemq.thread.DefaultThreadPools#shutdown when ActiveMQ libraries are in Tomcat shared libs, because calling that method will shutdown the shared thread pool, and  all other web application deployed to the same Tomcat will be unable to send any JMS messages. You can do that when ActiveMQ libraries are packaged into web application only.&lt;/p&gt;</comment>
                            <comment id="13427643" author="sgri" created="Thu, 2 Aug 2012 21:38:25 +0000"  >&lt;p&gt;Whether you have a memory leak or not depends on how fast you re-load or re-deploy applications and how intense ActiveMQ is used by other web applications on the same tomcat. Sometimes &quot;ActiveMQ Transport&quot; or &quot;ActiveMQ Task&quot; thread is terminated by inactivity, and in that case you don&apos;t have a memory leak. Most of the time you have a memory leak when deploying ActiveMQ to Tomcat shared libs.&lt;/p&gt;</comment>
                            <comment id="13427872" author="sgri" created="Fri, 3 Aug 2012 07:10:55 +0000"  >&lt;p&gt;The problem is in org.apache.activemq.thread.TaskRunnerFactory#executor. The thread pool&apos;s keepAliveTime is 30 seconds. If you have a single web application in Tomcat which uses JMS, and&lt;br/&gt;
 you re-start (or re-deploy) your web application in an interval less that 30 seconds, then the thread is not terminated and re-used, the thread references the undeployed web applicaiton classloader and JVM cannot collect undeployed application and free PermGen memory area.&lt;/p&gt;</comment>
                            <comment id="13427938" author="gtully" created="Fri, 3 Aug 2012 09:42:55 +0000"  >&lt;p&gt;@Sergey this is great information&lt;/p&gt;

&lt;p&gt;So the crux seems to be the classloader reference, if the pool is to be shared then it must not refer to an app specific loader. Do you understand the nature of that reference?&lt;/p&gt;

&lt;p&gt;The alternative approach is to remove the use of the statically defined default task runner factory from client side code and use one per connection factory.&lt;/p&gt;</comment>
                            <comment id="13427981" author="sgri" created="Fri, 3 Aug 2012 10:42:52 +0000"  >&lt;p&gt;@Gary&lt;/p&gt;

&lt;p&gt;Yes, I understand the nature of the reference. When ActiveMQ thread pool creates a new thread, then the thread inherits the current thread context classloder. When the client web application is creating a JMS connection, then the context classloder is Tomcat WebAppClassLoader. As long as the thread is alive, it references web application classloader. The thread can be re-used by another web application while still holding a reference to the undeployed web application which created the thread.&lt;/p&gt;</comment>
                            <comment id="13427996" author="gtully" created="Fri, 3 Aug 2012 11:15:35 +0000"  >&lt;p&gt;hmm, ok. so it sounds like a sensible fix is to clear and reset the tccl in the thread factory such that it is not inherited by the activemq task runner threads.&lt;br/&gt;
I just wonder if that behavior will break any clients, am thinking cxf and jaxb or in servicemix etc. It may need to be configurable via a system property just incase.&lt;br/&gt;
fancy taking a stab at a patch?&lt;/p&gt;</comment>
                            <comment id="13428000" author="sgri" created="Fri, 3 Aug 2012 11:33:50 +0000"  >&lt;p&gt;Found another memory leak, see &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3959&quot; title=&quot;Memory leak caused by org.apache.activemq.util.StringArrayEditor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3959&quot;&gt;&lt;del&gt;AMQ-3959&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13428012" author="sgri" created="Fri, 3 Aug 2012 12:01:28 +0000"  >&lt;p&gt;@Gary&lt;/p&gt;

&lt;p&gt;Ok, I will try to set tccl to null and then will run the memory profiler again.&lt;/p&gt;</comment>
                            <comment id="13428020" author="sgri" created="Fri, 3 Aug 2012 12:15:31 +0000"  >&lt;p&gt;I have tried the patch below&lt;br/&gt;
-------------------------&lt;br/&gt;
Index: activemq-core/src/main/java/org/apache/activemq/thread/TaskRunnerFactory.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; activemq-core/src/main/java/org/apache/activemq/thread/TaskRunnerFactory.java       (revision 1366667)&lt;br/&gt;
+++ activemq-core/src/main/java/org/apache/activemq/thread/TaskRunnerFactory.java       (working copy)&lt;br/&gt;
@@ -108,6 +108,8 @@&lt;br/&gt;
                 Thread thread = new Thread(runnable, name + &quot;-&quot; + id.incrementAndGet());&lt;br/&gt;
                 thread.setDaemon(daemon);&lt;br/&gt;
                 thread.setPriority(priority);&lt;br/&gt;
+                thread.setContextClassLoader(null);&lt;br/&gt;
                 return thread;&lt;br/&gt;
             }&lt;br/&gt;
         });&lt;br/&gt;
-------------------------&lt;/p&gt;

&lt;p&gt;Still have memory leak, now because of inherited access control context, see the screenshot.&lt;/p&gt;
</comment>
                            <comment id="13428065" author="sgri" created="Fri, 3 Aug 2012 13:15:38 +0000"  >&lt;p&gt;Attached a patch which cleans the thread&apos;s context classloader and inherited security context.&lt;/p&gt;</comment>
                            <comment id="13428097" author="liny" created="Fri, 3 Aug 2012 14:03:09 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Is the solution is one of bellows?&lt;br/&gt;
1. Killed all sessions, wait more than 30 secs, then thread pool will kill himself.&lt;br/&gt;
2. Use patch.txt&lt;/p&gt;</comment>
                            <comment id="13428118" author="liny" created="Fri, 3 Aug 2012 14:26:16 +0000"  >&lt;p&gt;@Sergey&lt;/p&gt;

&lt;p&gt;No, I didn&apos;t put ActiveMQ Lib in tomcat share lib directory. So your solutions work, right? If yes, really appreciated. I&apos;ll try soon!&lt;/p&gt;</comment>
                            <comment id="13428126" author="sgri" created="Fri, 3 Aug 2012 14:34:52 +0000"  >&lt;p&gt;@liny&lt;/p&gt;

&lt;p&gt;I you didn&apos;t put ActiveMQ lib in tomcat shared lib, then I don&apos;t understand why you have a memory leak, because when I package ActiveMQ libs to WEB-INF/lib, then I don&apos;t have any memory leaks except &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3959&quot; title=&quot;Memory leak caused by org.apache.activemq.util.StringArrayEditor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3959&quot;&gt;&lt;del&gt;AMQ-3959&lt;/del&gt;&lt;/a&gt;. &lt;br/&gt;
You need to deploy your web application, then stop it in Tomcat Manager, then use Eclipse Memory Analysis tool, take a heap dump, open histogram, group by clasloader, then find paths to GC root for WebAppClassLoader. When done, you will know for sure the cause of  the memory leak.&lt;/p&gt;</comment>
                            <comment id="13428135" author="liny" created="Fri, 3 Aug 2012 14:49:48 +0000"  >&lt;p&gt;@Sergey&lt;/p&gt;

&lt;p&gt;My situation is described at &lt;a href=&quot;http://activemq.2283324.n4.nabble.com/Old-issue-Memory-leak-after-stop-web-application-in-Tomcat-tp4653959p4654028.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.2283324.n4.nabble.com/Old-issue-Memory-leak-after-stop-web-application-in-Tomcat-tp4653959p4654028.html&lt;/a&gt; with a simple web app. Would you like to try to see if you can see the same problem like me? Eclipse Memory Analysis looks a good tool, will try it.&lt;/p&gt;</comment>
                            <comment id="13428167" author="sgri" created="Fri, 3 Aug 2012 15:09:23 +0000"  >&lt;p&gt;@liny&lt;/p&gt;

&lt;p&gt;I have downloaded the application from &lt;a href=&quot;https://docs.google.com/open?id=0B-ZFcczN9qxYZmh5dDdoMFVCUkE&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.google.com/open?id=0B-ZFcczN9qxYZmh5dDdoMFVCUkE&lt;/a&gt;, and analyzed the heap dump.&lt;/p&gt;

&lt;p&gt;I don&apos;t see any memory leaks related to threads, the only memory leak with your web application is  &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3959&quot; title=&quot;Memory leak caused by org.apache.activemq.util.StringArrayEditor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3959&quot;&gt;&lt;del&gt;AMQ-3959&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13430390" author="ccorsi" created="Tue, 7 Aug 2012 16:08:48 +0000"  >&lt;p&gt;@Sergey&lt;/p&gt;

&lt;p&gt;The issue is more fundamental than your patch.  Those threads are created by the default task runner factory and this factory is created once and then never shutdown throwout the life time of the process. &lt;/p&gt;

&lt;p&gt;Adding a shutdown of the default task runner will remove this issue but will raise another issue when using the shared classloader of the application server with multiple containers.&lt;/p&gt;

&lt;p&gt;The default task runner should be associated with the broker server and not a self contained static class.  This should resolve the case of its use within the broker side code but will not resolve this issue within the client side issue.  That needs a little more work on getting this to work properly.&lt;/p&gt;

&lt;p&gt;I have tried to shutdown the default task runner factory fix but when I hot deploy the container again.  It raises a rejected exception when trying to add a task to the runner since this executor has been shutdown already.&lt;/p&gt;

&lt;p&gt;I tried a fix to associates a default task runner factory to the broker and that resolved the issue I was initially seeing.&lt;/p&gt;

&lt;p&gt;I still have an issue with the client code that uses the default task runner factory.  This still needs work on my end and will probably require a different fix that would provide a similar solution.  I was thinking about using WeakReferences associated with a ReferenceQueue.  Whenever the remove method is called the task runner factory can be shutdown.  This might work.  I just need to implement this.&lt;/p&gt;

&lt;p&gt;--Claudio&lt;/p&gt;</comment>
                            <comment id="13446121" author="nimmi" created="Fri, 31 Aug 2012 16:48:03 +0000"  >&lt;p&gt;When can we expect a solution to this issue ? We are facing the same issue on Tomcat7 as well.&lt;/p&gt;</comment>
                            <comment id="13447162" author="davsclaus" created="Mon, 3 Sep 2012 08:41:49 +0000"  >&lt;p&gt;If people only run 1 broker in the JVM, we could as a temporary fix, add some flag/option/whatever to tell the broker, to shutdown these thread pools when the BrokerService is shutdown.&lt;/p&gt;

&lt;p&gt;Its of course a bit tricker when its a JMS client, as that would be some stop logic in a ConnectionFactory or the likes, to get a callback when to shutdown.&lt;/p&gt;</comment>
                            <comment id="13447171" author="davsclaus" created="Mon, 3 Sep 2012 08:57:03 +0000"  >&lt;p&gt;The org.apache.activemq.thread.DefaultThreadPools seems to be used in 2 areas&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;by the broker a bit&lt;/li&gt;
	&lt;li&gt;transports&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The code for the broker, can be refactored to use a broker specific executor, so when the broker shutdown, those threads will be shutdown as well. That should be doable&lt;/p&gt;

&lt;p&gt;The transports can be used by JMS clients as well, so I wonder as Gary says, can we use a dedicated thread pool (executor service) &lt;b&gt;per&lt;/b&gt; transport?&lt;br/&gt;
If that would be doable, then we have start|stop callbacks on the transports, where we can ensure the thread pool is setup / shutdown properly.&lt;/p&gt;</comment>
                            <comment id="13447238" author="davsclaus" created="Mon, 3 Sep 2012 12:05:14 +0000"  >&lt;p&gt;I have attached a patch to fix the part that is used by the broker, to use the executor the broker itself provides.&lt;/p&gt;

&lt;p&gt;Anyone see a problem with that? The unit tests passes, and a brief spin of running a standalone broker seems fine.&lt;/p&gt;
</comment>
                            <comment id="13447251" author="nimmi" created="Mon, 3 Sep 2012 12:50:51 +0000"  >&lt;p&gt;Hello Claus,&lt;/p&gt;

&lt;p&gt;Would it be possible to attach the updated ActiveMQ jar please.Also let me know which version of ActiveMQ are you using.&lt;br/&gt;
I am trying the 5.7.snapshot since it has the new DefaultThreadPools.getDefaultTaskRunnerFactory().shutdown(); method but still Tomcat7 fails to shutdown cleanly.&lt;/p&gt;</comment>
                            <comment id="13447262" author="davsclaus" created="Mon, 3 Sep 2012 13:17:33 +0000"  >&lt;p&gt;The ASF CI server will once in a while deploy a new SNAPSHOT you can download. Keep an eye on&lt;br/&gt;
&lt;a href=&quot;https://builds.apache.org/job/ActiveMQ-Trunk-Deploy/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ActiveMQ-Trunk-Deploy/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The attached patch only fixes on the broker side, there is still all the transports. I am continuing on the patch, taking one step at a time. Currently testing with 2 more fixes for discover agent and another place. Then next is the remainder 7 transports using it.&lt;/p&gt;</comment>
                            <comment id="13447274" author="davsclaus" created="Mon, 3 Sep 2012 13:40:36 +0000"  >&lt;p&gt;Patch with more fixes. Only the transports to go now.&lt;/p&gt;</comment>
                            <comment id="13447299" author="nimmi" created="Mon, 3 Sep 2012 14:50:37 +0000"  >&lt;p&gt;Thank you very much for working on this issue.I&apos;ll check the builds page.&lt;/p&gt;</comment>
                            <comment id="13447575" author="davsclaus" created="Tue, 4 Sep 2012 09:18:45 +0000"  >&lt;p&gt;Okay got as far with a JMS client in Tomcat now not reporting any leaks from its console, when I stop the app or redeploy it.&lt;br/&gt;
&amp;gt; &lt;br/&gt;
Message: 	&lt;br/&gt;
No web applications appear to have triggered a memory leak on stop, reload or undeploy.&lt;/p&gt;</comment>
                            <comment id="13447576" author="davsclaus" created="Tue, 4 Sep 2012 09:21:41 +0000"  >&lt;p&gt;With an embedded AMQ broker I still get this&lt;/p&gt;

&lt;p&gt;&amp;gt; The following web applications were stopped (reloaded, undeployed), but their&lt;br/&gt;
classes from previous runs are still loaded in memory, thus causing a memory&lt;br/&gt;
leak (use a profiler to confirm):&lt;br/&gt;
/camel-example-activemq-tomcat&lt;/p&gt;</comment>
                            <comment id="13447609" author="davsclaus" created="Tue, 4 Sep 2012 10:50:13 +0000"  >&lt;p&gt;Patch with transport connections fixes. I also attached the core JAR for people to give a try. The other SNAPSHOT jars are in maven snapshot repo, where you can download them. As no fixes has yet been committed to the codebase.&lt;/p&gt;</comment>
                            <comment id="13447726" author="davsclaus" created="Tue, 4 Sep 2012 14:38:10 +0000"  >&lt;p&gt;I discovered a leak in Camel, when JMX is enabled. &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-5564&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-5564&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13448865" author="davsclaus" created="Wed, 5 Sep 2012 16:30:20 +0000"  >&lt;p&gt;First part of patch is committed to the code base. The connector/transport code need a bit more love, as they tend to either create the pools in ctr / start or stop lifecycle methods. The code could possible be more consistent among them.&lt;/p&gt;</comment>
                            <comment id="13449862" author="davsclaus" created="Thu, 6 Sep 2012 17:57:08 +0000"  >&lt;p&gt;Okay &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4026&quot; title=&quot;Refactor logic to shutdown thread pools using a single API to ensure better shutdown and offer logging et all&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4026&quot;&gt;&lt;del&gt;AMQ-4026&lt;/del&gt;&lt;/a&gt; is now committed, so we have a better API for shutting down thread pools. Will work on getting the patches in the codebase, so the JMS Client work well in Tomcat when re-deploying apps. &lt;/p&gt;

&lt;p&gt;A fully embedded ActiveMQ broker in Tomcat has a number of more pools and other parts in the works, eg such as JMX and whatnot that can cause a bit pain, eg to ensure all JMX stuff is properly unregistered and whatnot. &lt;/p&gt;

&lt;p&gt;First priority is the JMS client though.&lt;/p&gt;</comment>
                            <comment id="13450546" author="davsclaus" created="Fri, 7 Sep 2012 12:00:02 +0000"  >&lt;p&gt;Okay got the JMS client leak fixed and committed to trunk. No leaks reported by Tomcat, and the WebappClassLoader did not have any strong references to any classes anymore. So seems we can fully undeploy/redeploy without leaks now.&lt;/p&gt;</comment>
                            <comment id="13450678" author="davsclaus" created="Fri, 7 Sep 2012 14:50:22 +0000"  >&lt;p&gt;Okay got further on the embedded broker side. Got a classloader leak fixed due a spring introspection cache, needed to be explicit cleared.&lt;br/&gt;
The tomcat manager console now says there is no leaks. And all activemq and camel classes is fully unloaded when stopping the app.&lt;/p&gt;

&lt;p&gt;One last thing would be a JMX thread not being shutdown on the broker side.&lt;/p&gt;</comment>
                            <comment id="13450843" author="nimmi" created="Fri, 7 Sep 2012 18:14:39 +0000"  >&lt;p&gt;We tried the 6th September build and our issues with ActiveMQ task runner threads have been fixed.Thank you.&lt;br/&gt;
When can we expect the official version of ActiveMQ-5.7 to be released ?&lt;br/&gt;
Also could anybody please comment on &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4030&quot; title=&quot;Tomcat7 with ActiveMQ-5.6 or ActiveMQ-5.7 starts with error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4030&quot;&gt;&lt;del&gt;AMQ-4030&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13451543" author="davsclaus" created="Sun, 9 Sep 2012 08:39:38 +0000"  >&lt;p&gt;I created &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4033&quot; title=&quot;AMQ Broker - Uses custom RMIServerSocketFactory class which cannot be unloaded due socket reuse&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4033&quot;&gt;&lt;del&gt;AMQ-4033&lt;/del&gt;&lt;/a&gt; for the issue with the embedded AMQ broker. The JMS client now shutdown all the threads, and can be unloaded by the classloader etc.&lt;/p&gt;

&lt;p&gt;About the AMQ 5.7 release, then this should be discussed at the AMQ mailing list such as either the dev or user.&lt;/p&gt;</comment>
                            <comment id="13453845" author="nimmi" created="Wed, 12 Sep 2012 09:02:28 +0000"  >&lt;p&gt;ok,thank you.Will mail the user mailing list.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12483952">AMQ-2852</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12601450">AMQ-3962</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12601350">AMQ-3959</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13043532">AMQ-6602</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12606761">AMQ-4033</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12605552">AMQ-4008</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12543537" name="AMQ-3451-broker.patch" size="6921" author="davsclaus" created="Mon, 3 Sep 2012 12:05:14 +0000"/>
                            <attachment id="12543548" name="AMQ-3451-broker2.patch" size="11167" author="davsclaus" created="Mon, 3 Sep 2012 13:40:36 +0000"/>
                            <attachment id="12543650" name="AMQ-3541-3.patch" size="29139" author="davsclaus" created="Tue, 4 Sep 2012 10:50:13 +0000"/>
                            <attachment id="12543651" name="activemq-core-5.7-SNAPSHOT.jar" size="4029586" author="davsclaus" created="Tue, 4 Sep 2012 10:50:13 +0000"/>
                            <attachment id="12539034" name="inherited_access_cotrol_context_leak.png" size="298989" author="sgri" created="Fri, 3 Aug 2012 12:15:31 +0000"/>
                            <attachment id="12539044" name="patch.txt" size="2162" author="sgri" created="Fri, 3 Aug 2012 13:15:37 +0000"/>
                            <attachment id="12538954" name="transport_thread_leak.png" size="509348" author="sgri" created="Thu, 2 Aug 2012 21:18:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>60650</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 10 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0aj1z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59360</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>