<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:39:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6590] KahaDB index loses track of free pages on unclean shutdown</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6590</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I have discovered an issue with the KahaDB index recovery after an unclean shutdown (OOM error, kill -9, etc) that leads to excessive disk space usage. &lt;/p&gt;

&lt;p&gt;Normally on clean shutdown the index stores the known set of free pages to db.free and reads that in on start up to know which pages can be re-used.  On an unclean shutdown this is not written to disk so on start up the index is supposed to scan the page file to figure out all of the free pages.&lt;/p&gt;

&lt;p&gt;Unfortunately it turns out that this scan of the page file is being done before the total page count value has been set so when the iterator is created it always thinks there are 0 pages to scan.&lt;/p&gt;

&lt;p&gt;The end result is that every time an unclean shutdown occurs all known free pages are lost and no longer tracked.  This of course means new free pages have to be allocated and all of the existing space is now lost which will lead to excessive index file growth over time.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13039809">AMQ-6590</key>
            <summary>KahaDB index loses track of free pages on unclean shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="cshannon">Christopher L. Shannon</reporter>
                        <labels>
                    </labels>
                <created>Thu, 2 Feb 2017 12:01:17 +0000</created>
                <updated>Sun, 21 Oct 2018 17:29:22 +0000</updated>
                            <resolved>Thu, 2 Feb 2017 12:09:00 +0000</resolved>
                                    <version>5.14.3</version>
                                    <fixVersion>5.15.0</fixVersion>
                    <fixVersion>5.14.4</fixVersion>
                    <fixVersion>5.15.7</fixVersion>
                    <fixVersion>5.16.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="15849839" author="jira-bot" created="Thu, 2 Feb 2017 12:06:39 +0000"  >&lt;p&gt;Commit 38d85be476a06fe9a1f60b4f38232d64a6d0398a in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=38d85be&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=38d85be&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6590&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6590&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fix KahaDB index free page recovery on unclean shutdown so that existing&lt;br/&gt;
free pages will be tracked and not lost.&lt;/p&gt;</comment>
                            <comment id="15849841" author="jira-bot" created="Thu, 2 Feb 2017 12:07:56 +0000"  >&lt;p&gt;Commit 6a87e13eb3d6f819b0d05ee8d16f6d955442425e in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=6a87e13&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=6a87e13&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6590&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6590&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fix KahaDB index free page recovery on unclean shutdown so that existing&lt;br/&gt;
free pages will be tracked and not lost.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 38d85be476a06fe9a1f60b4f38232d64a6d0398a)&lt;/p&gt;</comment>
                            <comment id="15849844" author="jira-bot" created="Thu, 2 Feb 2017 12:10:32 +0000"  >&lt;p&gt;Commit 83511c96e5cf91f348a81ecc3c4439aa345548dd in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=83511c9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=83511c9&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6590&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6590&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Removing un-needed imports&lt;/p&gt;</comment>
                            <comment id="15849845" author="jira-bot" created="Thu, 2 Feb 2017 12:10:53 +0000"  >&lt;p&gt;Commit cc28f5dc3905e411b3e5ce39240baf21ccedb0af in activemq&apos;s branch refs/heads/activemq-5.14.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=cc28f5d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=cc28f5d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6590&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6590&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Removing un-needed imports&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 83511c96e5cf91f348a81ecc3c4439aa345548dd)&lt;/p&gt;</comment>
                            <comment id="15849847" author="christopher.l.shannon" created="Thu, 2 Feb 2017 12:13:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;, Can you do a quick sanity check on this?  I believe this is the correct fix.&lt;/p&gt;</comment>
                            <comment id="15850004" author="gtully" created="Thu, 2 Feb 2017 14:50:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; sure. that fix does look correct and is a great catch. &lt;/p&gt;</comment>
                            <comment id="15850043" author="christopher.l.shannon" created="Thu, 2 Feb 2017 15:25:07 +0000"  >&lt;p&gt;Thanks for taking a look.&lt;/p&gt;</comment>
                            <comment id="16653349" author="gtully" created="Wed, 17 Oct 2018 10:43:32 +0000"  >&lt;p&gt;It turns out that this change, while good, means that we take a hit on start in the normal failover case where the primary dies uncleanly.&lt;/p&gt;

&lt;p&gt;There have been reports of more than 2mins to start and the threads are stuck in sequence.set add.&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7055&quot; title=&quot;Small optimization on SequenceSet to prevent iterating through the whole set when a value bigger than the last value is added&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7055&quot;&gt;&lt;del&gt;AMQ-7055&lt;/del&gt;&lt;/a&gt; helps a good bit, but the problem is we are trading off availability for disk usage and taking the hit during restart.&lt;/p&gt;

&lt;p&gt;I am thinking it may be better to do a checkpoint of the feeList when we do gc, the cleanup phase, and accept that information on restart.&#160;&lt;/p&gt;

&lt;p&gt;If the restart is unclean, we remember that and do a freeList recovery when we next do an orderly shutdown. In that way, we can still restart fast, lose some disk space to some missed free pages and gracefully recover when we are stopping.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; I&#160;wonder if that will hold together? The other&#160;approach is do have the option to do this offline, offline work has always been on the todo.&lt;/p&gt;</comment>
                            <comment id="16653357" author="gtully" created="Wed, 17 Oct 2018 10:53:58 +0000"  >&lt;p&gt;The checkpoint won&apos;t help, it will not be possible to work with a stale free list b/c one of those may now be occupied, hense the index file will have to grow, however we can still do the full and necessary free recovery on shutdown rather than on start.&#160;&lt;/p&gt;</comment>
                            <comment id="16653395" author="jira-bot" created="Wed, 17 Oct 2018 11:32:32 +0000"  >&lt;p&gt;Commit 5d3a3fcca7fbc04e60a146e42fb1f65b94e4ea7b in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=5d3a3fc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=5d3a3fc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6590&quot; title=&quot;KahaDB index loses track of free pages on unclean shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6590&quot;&gt;&lt;del&gt;AMQ-6590&lt;/del&gt;&lt;/a&gt; - rework fix to take the recovery hit on clean shutdown rather than on restart, trade off availability for short term disk usage&lt;/p&gt;</comment>
                            <comment id="16653398" author="gtully" created="Wed, 17 Oct 2018 11:35:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; I have moved this fix to the shutdown phase b/c the recovery work can be significant on very large stores. The down side is temporary disk space usage by the index which is a better trade off IMHO.&#160;&lt;/p&gt;

&lt;p&gt;I also added an info log message to indicate that the some recovery is going on.&lt;/p&gt;</comment>
                            <comment id="16653549" author="jgoodyear" created="Wed, 17 Oct 2018 13:29:25 +0000"  >&lt;p&gt;Can we back port this change to the 5.15.x line as well?&lt;/p&gt;</comment>
                            <comment id="16653622" author="jira-bot" created="Wed, 17 Oct 2018 14:22:04 +0000"  >&lt;p&gt;Commit cee7f014fa4afca04681066946e5a2b6811141af in activemq&apos;s branch refs/heads/activemq-5.15.x from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=cee7f01&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=cee7f01&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6590&quot; title=&quot;KahaDB index loses track of free pages on unclean shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6590&quot;&gt;&lt;del&gt;AMQ-6590&lt;/del&gt;&lt;/a&gt; - rework fix to take the recovery hit on clean shutdown rather than on restart, trade off availability for short term disk usage&lt;/p&gt;</comment>
                            <comment id="16653629" author="jgenender" created="Wed, 17 Oct 2018 14:24:50 +0000"  >&lt;p&gt;Nice &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;.&#160; I pushed this to 5.15.x (5.15.7) as this was supposed to be in the 5.15 line as well.&#160; Probably should have been a new improvement JIRA.&#160; Updated the versions above as well.&#160; Thank you!&lt;/p&gt;</comment>
                            <comment id="16653818" author="christopher.l.shannon" created="Wed, 17 Oct 2018 16:42:02 +0000"  >&lt;p&gt;Nice catch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; , I agree that it is fine to temporarily take the space hit as it will get cleaned up on the next clean shutdown.&lt;/p&gt;

&lt;p&gt;My only question is will there now be a large delay on shutdown instead? So are we just moving the 2 minute lag time to having to wait on shutdown instead of startup? In that case it doesn&#8217;t seem to be much different on a restart case as you have to wait the 2 minutes either way&lt;/p&gt;</comment>
                            <comment id="16653831" author="jgenender" created="Wed, 17 Oct 2018 16:48:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;, I think the criticality of this is restart on a failed broker.&#160; It could cause slowness in failover that delays startup of the broker.&#160; In a clean shut down, yes the delay moved to the back, but its a known delay when you are shutting it down in a clean fashion.&#160; Thus you can plan it.&#160; This makes sense as during a failover, you likely need availability immediately since that generally is not planned.&lt;/p&gt;</comment>
                            <comment id="16653872" author="christopher.l.shannon" created="Wed, 17 Oct 2018 17:06:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jgenender&quot; class=&quot;user-hover&quot; rel=&quot;jgenender&quot;&gt;jgenender&lt;/a&gt; , ah yeah that makes sense, on the failover case on a shared store you want to resume as fast as possible &lt;/p&gt;

&lt;p&gt;So yeah for sure this is a good change as it helps that failover case and then you can plan later when to take that hit on a clean restart or shutdown.&lt;/p&gt;</comment>
                            <comment id="16653873" author="gtully" created="Wed, 17 Oct 2018 17:07:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; sure, the recovery penalty needs to be taken at some stage.&lt;/p&gt;

&lt;p&gt;The ~2mins is not ideal,&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7055&quot; title=&quot;Small optimization on SequenceSet to prevent iterating through the whole set when a value bigger than the last value is added&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7055&quot;&gt;&lt;del&gt;AMQ-7055&lt;/del&gt;&lt;/a&gt;&#160; helps, but also for the really large index cases, being able to set the index page size may help. That is currently not exposed in kahadb and defaults to 4k, which means loads of small seek/reads of the index file. Exposing that may help.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16654661" author="alanprot" created="Thu, 18 Oct 2018 05:30:37 +0000"  >&lt;p&gt;Hum....&lt;/p&gt;

&lt;p&gt;I dont really think that this is solving the all problem.... Of course in the case of a crash (unclean shutdown) the fail over will be faster....&lt;/p&gt;

&lt;p&gt;But after that, let&apos;s imagine that we wanna do a normal restart. Well the broker will have a long shutdown and while doing that it will still hold the lock making the failover slow the same way.&lt;/p&gt;

&lt;p&gt;And maybe now is worst... Imagine that the shutdown is taking 2 minutes and the&#160;ACTIVEMQ_KILL_MAXSECONDS is&#160;set to 30 secs...&lt;/p&gt;

&lt;p&gt;In this case all the shutdown will be unclean (so lots of&#160;dangling free pages - larger index file on each restart)&#160;until we delete the index file and perform a full recovery.&lt;/p&gt;

&lt;p&gt;Why don&apos;t we save the free page in every checkpoint + keep track of it&apos;s hash or fingerPrint (SequenceSetHash) in the metadata (the page size is already saved there).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/activemq/blob/5d3a3fcca7fbc04e60a146e42fb1f65b94e4ea7b/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/disk/page/PageFile.java#L468&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/5d3a3fcca7fbc04e60a146e42fb1f65b94e4ea7b/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/disk/page/PageFile.java#L468&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Now, in the load method, we can check if the fingerprint of the metadata is equal to the saved free list... if it&apos;s equal we can load this list, if it&apos;s not, we can recover it (read the whole index file as before).&lt;/p&gt;

&lt;p&gt;So in each checkpoint we should:&lt;/p&gt;

&lt;p&gt;Calculate freeList hash (or this can be pre calculated changing it every time that this list is modified)&#160;&lt;br/&gt;
 Save the free list&#160;&lt;br/&gt;
 Save this information in the metadata&lt;/p&gt;

&lt;p&gt;Now, on the load we can check if the hash of the loaded free list is the equal to the metadata... if it is we are good.&lt;/p&gt;

&lt;p&gt;This is a rough draft of what I meant and seems to be working.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/alanprot/activemq/commit/18036ef7214ef0eaa25c8650f40644dd8b4632a5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/alanprot/activemq/commit/18036ef7214ef0eaa25c8650f40644dd8b4632a5&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Is important to note that in the Pagefile#load method we need to rebuild the index in the same way it was in the checkpoint (the recovery will be performed after to replay the time btw the checkpoint and the crash)&lt;/p&gt;

&lt;p&gt;So...&lt;/p&gt;

&lt;p&gt;Imagine the timeline:&lt;/p&gt;

&lt;p&gt;T0 -&amp;gt;&#160;P1, P2 and P3 are free.&lt;/p&gt;

&lt;p&gt;T1 -&amp;gt; Checkpoint&lt;/p&gt;

&lt;p&gt;T2 -&amp;gt; P1 got occupied.&lt;/p&gt;

&lt;p&gt;T3 -&amp;gt; Crash&lt;/p&gt;

&lt;p&gt;In the current scenario after the &#160;Pagefile#load the P1 will be free and then the replay will mark P1 as occupied...&lt;/p&gt;

&lt;p&gt;My change only make sure that db.data and db.free are in sync and showing the reality in T1 (checkpoint), If they are in sync i can use the db.free.&lt;/p&gt;

&lt;p&gt;&#160;In this case we will only perform a full read if the crash is btw saving the db.free and db.data... This is very unlikely&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jgenender&quot; class=&quot;user-hover&quot; rel=&quot;jgenender&quot;&gt;jgenender&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; Does this make sense?&lt;/p&gt;

&lt;p&gt;If you think that this makes sense i can create a Jira to try to implement this..&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16654671" author="alanprot" created="Thu, 18 Oct 2018 05:38:37 +0000"  >&lt;p&gt;Actually this fixed the failover speed, but my proposal I just makes it more streamlined&lt;/p&gt;</comment>
                            <comment id="16654678" author="jgenender" created="Thu, 18 Oct 2018 05:48:54 +0000"  >&lt;p&gt;Hi Alan... that&apos;s awesome! &#160;That would totally work in cutting down the potential for the recovery. May I suggest that you open a new Jira to track this since this one is resolved. &#160;Right now parts of this are in multiple releases, so its own Jira may help ensure we know what release it would be a part of.&#160;&#160; Your code looks pretty clear and I think it deserves its own JIRA &#160;Please reference this one in the new JIRA.&lt;/p&gt;</comment>
                            <comment id="16655236" author="jgenender" created="Thu, 18 Oct 2018 13:37:33 +0000"  >&lt;p&gt;One more small comment, I would change from&#160;using Random as the fingerprint and perhaps use a time stamp or something. &#160;The Random could potentially have a clash and possibly could have a collision which would cause corruption. &#160;Perhaps use a Time function or time based UUID as your finger print. &#160;Since this will not be doing 2 checkpoints&#160;in under a millisecond, I think that would be the safest.&lt;/p&gt;</comment>
                            <comment id="16655260" author="alanprot" created="Thu, 18 Oct 2018 14:05:30 +0000"  >&lt;p&gt;Yep...&lt;/p&gt;

&lt;p&gt;Or we can change the fingerprint for freePageTxId or something like that and be a single increment (freePageTxId++) on every&#160;time i save db.free&lt;/p&gt;</comment>
                            <comment id="16655414" author="jgenender" created="Thu, 18 Oct 2018 15:20:55 +0000"  >&lt;p&gt;Also, add a unit test. &#160;The unit test can show a normal checkpoint, and you can also exercise the failure by force calling brokerService.getPersistenceAdapter().checkpoint() and then changing the db.data or db.free fingerprint with some file I/O using the File object, then restarting and testing that it did a full recovery. &#160;Should be straight forward. Open a new Jira on this &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16655503" author="christopher.l.shannon" created="Thu, 18 Oct 2018 16:12:23 +0000"  >&lt;p&gt;The ACTIVEMQ_KILL_MAXSECONDS actually occurred to me as well a bit after I responded to this. I use a custom start up script but still have something similar where if the broker hangs it will be killed which obviously breaks in this case.  So that case needs to be handled.&lt;/p&gt;</comment>
                            <comment id="16655537" author="alanprot" created="Thu, 18 Oct 2018 16:29:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; What about saving the free pages in the check point? Do you think that make sense?&lt;/p&gt;

&lt;p&gt;I was talking other guys and the only concern&#160;seems to be that we will increase the Checkpoint timings (as we are writing one more file)&lt;/p&gt;</comment>
                            <comment id="16655547" author="christopher.l.shannon" created="Thu, 18 Oct 2018 16:38:11 +0000"  >&lt;p&gt;I&apos;m good with the checkpoint but want to see what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; thinks as he brought up some concerns about checkpointing the free list.  As Jeff said we can continue the conversation against the PR in a new jira.&lt;/p&gt;</comment>
                            <comment id="16655742" author="alanprot" created="Thu, 18 Oct 2018 18:51:13 +0000"  >&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Just created a new Jira for that:&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7080&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-7080&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16656900" author="jira-bot" created="Fri, 19 Oct 2018 15:00:39 +0000"  >&lt;p&gt;Commit 79c74998dc1efb72b05d32f920052a1df4b6dd8e in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=79c7499&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=79c7499&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7082&quot; title=&quot;KahaDB index, recover free pages in parallel with start&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7082&quot;&gt;&lt;del&gt;AMQ-7082&lt;/del&gt;&lt;/a&gt; - recover index free pages in parallel with start, merge in flush, clean shutdown if complete. follow up on &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6590&quot; title=&quot;KahaDB index loses track of free pages on unclean shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6590&quot;&gt;&lt;del&gt;AMQ-6590&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16658305" author="jira-bot" created="Sun, 21 Oct 2018 17:29:22 +0000"  >&lt;p&gt;Commit c6103415b9a185776ebc16343c6574f7ff884806 in activemq&apos;s branch refs/heads/activemq-5.15.x from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=c610341&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=c610341&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7082&quot; title=&quot;KahaDB index, recover free pages in parallel with start&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7082&quot;&gt;&lt;del&gt;AMQ-7082&lt;/del&gt;&lt;/a&gt; - recover index free pages in parallel with start, merge in flush, clean shutdown if complete. follow up on &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6590&quot; title=&quot;KahaDB index loses track of free pages on unclean shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6590&quot;&gt;&lt;del&gt;AMQ-6590&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13192835">AMQ-7082</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 4 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39ivz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>