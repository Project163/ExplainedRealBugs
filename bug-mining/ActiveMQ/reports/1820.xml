<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:58:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4319] ActiveMQ destination are tracked by securitycontext and never cleaned up, causes ActiveMQ to crash.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4319</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;We are using ActiveMQ + mcollective.  With mcollective, we are using the &quot;activemq connector (&lt;a href=&quot;http://docs.puppetlabs.com/mcollective/reference/plugins/connector_activemq.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.puppetlabs.com/mcollective/reference/plugins/connector_activemq.html&lt;/a&gt;)&quot;&lt;/p&gt;

&lt;p&gt;We are running ActiveMQ in the EC2 Cloud, so we have enabled security for the connections being made.&lt;/p&gt;

&lt;p&gt;We have 2 ActiveMQ servers that are configures as network of brokers, about around 200 nodes that we communicate with.&lt;/p&gt;

&lt;p&gt;The problem we are seeing is that after about 1 week in operation, ActiveMQ will crash because it runs out of memory.  We have been monitoring the heap, and you will see it rise during the week, and then the wrapper will eventually restart activemq&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;wrapper.log&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR  | wrapper  | 2013/02/01 09:38:33 | JVM appears hung: Timed out waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; signal from JVM.
ERROR  | wrapper  | 2013/02/01 09:38:33 | JVM did not exit on request, terminated
INFO   | wrapper  | 2013/02/01 09:38:33 | JVM exited on its own &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; waiting to kill the application.
STATUS | wrapper  | 2013/02/01 09:38:33 | JVM exited in response to signal SIGKILL (9).
STATUS | wrapper  | 2013/02/01 09:38:38 | Launching a JVM...}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the activemq connector page, it says that there needs to be cleanup of queues.  This is put into place.&lt;/p&gt;

&lt;p&gt;I did a heap dump, and with external help I was told that &quot;the authentication plugin is retaining destinations in a cached connection&quot;&lt;/p&gt;

&lt;p&gt;These connections need to be deleted and cleaned up as well.&lt;/p&gt;</description>
                <environment>&lt;p&gt;RHEL 6&lt;/p&gt;</environment>
        <key id="12632413">AMQ-4319</key>
            <summary>ActiveMQ destination are tracked by securitycontext and never cleaned up, causes ActiveMQ to crash.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="mwoodson">Matt Woodson</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 Feb 2013 17:13:23 +0000</created>
                <updated>Mon, 25 Feb 2013 18:24:43 +0000</updated>
                            <resolved>Mon, 25 Feb 2013 18:24:42 +0000</resolved>
                                    <version>5.6.0</version>
                                    <fixVersion>5.9.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13578556" author="gtully" created="Thu, 14 Feb 2013 18:32:58 +0000"  >&lt;p&gt;the problem is the org.apache.activemq.security.AuthorizationBroker, it adds destination to the security context on addProducer/addConsumer but when these destinations are gc&apos;ed they are not removed from the connection context.&lt;br/&gt;
With a long lived connection, these can accumulate.&lt;/p&gt;

&lt;p&gt;securityContext.getAuthorizedReadDests().put(info.getDestination(), info.getDestination());&lt;/p&gt;

&lt;p&gt;the fix is probably in org.apache.activemq.security.AuthorizationBroker#removeDestination, where we need to remove the destination from the auth map of all connections.&lt;/p&gt;

&lt;p&gt;org.apache.activemq.security.SimpleAuthenticationPluginTest would be a simple place to add a test case, once the gcInactive is added to org/apache/activemq/security/simple-auth-broker.xml&lt;/p&gt;

&lt;p&gt;creating producers/consumers to USERS.1-1000 and having them gced and checking jvm stack usage should expose the problem in a unit test.&lt;/p&gt;</comment>
                            <comment id="13579321" author="gtully" created="Fri, 15 Feb 2013 17:02:08 +0000"  >&lt;p&gt;unit test - fix is not trivial. will take a bit of work.&lt;/p&gt;</comment>
                            <comment id="13586090" author="tabish121" created="Mon, 25 Feb 2013 18:24:43 +0000"  >&lt;p&gt;Fix and test added on trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12569563" name="AMQ-4319-unittest.patch" size="5437" author="gtully" created="Fri, 15 Feb 2013 17:02:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>312909</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 39 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1hzz3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>313255</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>