<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:34:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1490] Deadlocks (with JUnit tests)</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1490</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;For some time now there have been various bug reports about ActiveMQ &quot;blocking&quot;, &quot;not receiving messages&quot;, &quot;running into a deadlock&quot; etc. Since I encoutered such deadlocks now and then, too, I eventually wrote up a JUnit testing scenario for this stuff. I found out that deadlocks can be quite easily reproduced. The symptoms are that the producer thread is sending or committing while the consumer thread is receiving or committing - and none of them can advance. One of the threads is always stuck in a blocking queue.&lt;/p&gt;

&lt;p&gt;Here&apos;s a sample output of my testing class:&lt;br/&gt;
 An ActiveMQ deadlock has been discovered. The following threads seem to be involved:&lt;/p&gt;

&lt;p&gt; Thread &quot;producer&quot; is inactive since 16 seconds after 358719 status changes. The current status is COMMITTING&lt;br/&gt;
 sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
 java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)&lt;br/&gt;
  java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1889)&lt;br/&gt;
 java.util.concurrent.ArrayBlockingQueue.take(ArrayBlockingQueue.java:317)&lt;br/&gt;
 org.apache.activemq.transport.FutureResponse.getResult(FutureResponse.java:40)&lt;br/&gt;
 org.apache.activemq.transport.ResponseCorrelator.request(ResponseCorrelator.java:76)&lt;br/&gt;
 org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1172)&lt;br/&gt;
 org.apache.activemq.TransactionContext.commit(TransactionContext.java:259)&lt;br/&gt;
 org.apache.activemq.ActiveMQSession.commit(ActiveMQSession.java:494)&lt;br/&gt;
 de.rainer_klute.activemq.ProducerThread.run(ProducerThread.java:162)&lt;/p&gt;

&lt;p&gt; Thread &quot;consumer&quot; is inactive since 16 seconds after 1807 status changes. The current status is RECEIVING&lt;br/&gt;
 java.lang.Object.wait(Native Method)&lt;br/&gt;
 java.lang.Object.wait(Object.java:485)&lt;br/&gt;
 org.apache.activemq.MessageDispatchChannel.dequeue(MessageDispatchChannel.java:75)&lt;br/&gt;
 org.apache.activemq.ActiveMQMessageConsumer.dequeue(ActiveMQMessageConsumer.java:404)&lt;br/&gt;
 org.apache.activemq.ActiveMQMessageConsumer.receive(ActiveMQMessageConsumer.java:452)&lt;br/&gt;
 org.apache.activemq.ActiveMQMessageConsumer.receive(ActiveMQMessageConsumer.java:504)&lt;br/&gt;
 de.rainer_klute.activemq.ConsumerThread.run(ConsumerThread.java:183)&lt;/p&gt;

&lt;p&gt;The following factors seem to increase the probability of a deadlock:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;small values for memoryUsage&lt;/li&gt;
	&lt;li&gt;working transacted in the consumer (not always necessary but &quot;helps&quot;)&lt;/li&gt;
	&lt;li&gt;many messages in the persistence store (to be achieved via a long delay before the consumer starts to read messages)&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>&lt;p&gt;Linux&lt;/p&gt;</environment>
        <key id="12482329">AMQ-1490</key>
            <summary>Deadlocks (with JUnit tests)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="rainer klute">Rainer Klute</reporter>
                        <labels>
                    </labels>
                <created>Mon, 12 Nov 2007 09:48:24 +0000</created>
                <updated>Tue, 4 Mar 2008 15:52:15 +0000</updated>
                            <resolved>Wed, 13 Feb 2008 10:24:39 +0000</resolved>
                                    <version>5.0.0</version>
                                    <fixVersion>5.1.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="12939173" author="rainer klute" created="Mon, 12 Nov 2007 10:22:50 +0000"  >&lt;p&gt;JUnit test cases for this issue. See file index.html or &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1490&quot; title=&quot;Deadlocks (with JUnit tests)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1490&quot;&gt;&lt;del&gt;AMQ-1490&lt;/del&gt;&lt;/a&gt;.html for details.&lt;/p&gt;</comment>
                            <comment id="12939144" author="rainer klute" created="Tue, 13 Nov 2007 06:21:47 +0000"  >&lt;p&gt;I just checked this issue against ActiveMQ 5.0.0 RC3 and found it still valid. And I got additional warnings like these:&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; INFO: ActiveMQ Message Broker (localhost, ID:xxxxxxxx-17170-1194934336239-0:0) is shutting down&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; 13.11.2007 07:13:03 org.apache.activemq.ActiveMQConnection onAsyncException&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; WARNUNG: Async exception with no exception listener: org.apache.activemq.transport.TransportDisposedIOException: Peer (vm://localhost#1) disposed.&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; org.apache.activemq.transport.TransportDisposedIOException: Peer (vm://localhost#1) disposed.&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.transport.vm.VMTransport.iterate(VMTransport.java:200)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:118)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:42)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:885)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; 13.11.2007 07:13:03 org.apache.activemq.AdvisoryConsumer dispose&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; INFO: Failed to send remove command: javax.jms.JMSException: Peer (vm://localhost#1) disposed.&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; javax.jms.JMSException: Peer (vm://localhost#1) disposed.&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:62)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.ActiveMQConnection.asyncSendPacket(ActiveMQConnection.java:1154)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.AdvisoryConsumer.dispose(AdvisoryConsumer.java:56)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.ActiveMQConnection.cleanup(ActiveMQConnection.java:1326)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.ActiveMQConnection.transportFailed(ActiveMQConnection.java:2027)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.ActiveMQConnection$4.run(ActiveMQConnection.java:1663)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:885)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Caused by: org.apache.activemq.transport.TransportDisposedIOException: Peer (vm://localhost#1) disposed.&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.transport.vm.VMTransport.oneway(VMTransport.java:87)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:40)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:59)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.ActiveMQConnection.asyncSendPacket(ActiveMQConnection.java:1152)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     ... 7 more&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; 13.11.2007 07:13:03 org.apache.activemq.ActiveMQConnection transportFailed&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; WARNUNG: Cleanup failed&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; javax.jms.JMSException: Peer (vm://localhost#1) disposed.&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:62)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.ActiveMQConnection.asyncSendPacket(ActiveMQConnection.java:1154)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.TransactionContext.begin(TransactionContext.java:200)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.ActiveMQSession.doStartTransaction(ActiveMQSession.java:1653)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.ActiveMQMessageConsumer.acknowledge(ActiveMQMessageConsumer.java:823)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.ActiveMQMessageConsumer.dispose(ActiveMQMessageConsumer.java:651)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.ActiveMQSession.dispose(ActiveMQSession.java:575)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.ActiveMQConnection.cleanup(ActiveMQConnection.java:1332)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.ActiveMQConnection.transportFailed(ActiveMQConnection.java:2027)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.ActiveMQConnection$4.run(ActiveMQConnection.java:1663)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:885)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Caused by: org.apache.activemq.transport.TransportDisposedIOException: Peer (vm://localhost#1) disposed.&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.transport.vm.VMTransport.oneway(VMTransport.java:87)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:40)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:59)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     at org.apache.activemq.ActiveMQConnection.asyncSendPacket(ActiveMQConnection.java:1152)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt;     ... 11 more&lt;/p&gt;</comment>
                            <comment id="12939165" author="chirino" created="Tue, 13 Nov 2007 22:10:43 +0000"  >&lt;p&gt;I reviewed you test case and noticed that your consumer uses the same connection as the producer.  It is possible to get into a deadlock situation when this occurs.  If your producer blocks due to it waiting space on the broker, it will lock up the connection.  At that point the consumer will not be able to consume anymore messages either.&lt;/p&gt;

&lt;p&gt;I believe your deadlocks will go away if you use separate connections for the consumer and producer threads.&lt;/p&gt;</comment>
                            <comment id="12939230" author="rainer klute" created="Wed, 14 Nov 2007 05:12:06 +0000"  >&lt;p&gt;Using the same connection for the producer as well as for the consumer is neither uncommon nor is it contrary to the JMS specification. I&apos;d say since the JMS specification allows it, ActiveMQ should support it on principle.&lt;/p&gt;

&lt;p&gt;Some more rationale: With separate connections you would have to diffentiate between &quot;producing&quot; and &quot;consuming&quot; connections. This would be unnecessarily complex - not to mention the many connections&apos; resource consumption. An application&apos;s JMS setup would be too static. It should be possible to build up complex communication scenarios all over the same connection, and it should even be possible to change the communicators&apos; roles (producer or consumer) over time.&lt;/p&gt;

&lt;p&gt;I&apos;d be grateful if you could address this issue.&lt;/p&gt;

&lt;p&gt;What can I do until then? In my project&apos;s scenario I have a few producers (at present only one) writing messages to a topic and about 200 consumers reading them based on message properties. Should I really use different connections for all of them or are two connections sufficient?&lt;/p&gt;</comment>
                            <comment id="12939232" author="fullung" created="Wed, 14 Nov 2007 12:49:17 +0000"  >&lt;p&gt;This is starting to sound like an issue I reported some time back, namely &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1148&quot; title=&quot;Fast producer, slow consumer hangs after a few messages when using VMPendingSubscriberMessageStoragePolicy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1148&quot;&gt;&lt;del&gt;AMQ-1148&lt;/del&gt;&lt;/a&gt;, which hasn&apos;t received much attention in recent months.&lt;/p&gt;

&lt;p&gt;There is nothing in the JMS specification to indicate that one should use separate connections for producers and consumers and doing so can have various implications for the design of an application, so I would agree with Rainer Klute that this is something that should probably be looked at carefully.&lt;/p&gt;</comment>
                            <comment id="12939156" author="rainer klute" created="Mon, 19 Nov 2007 19:08:24 +0000"  >&lt;p&gt;Meanwhile I am pretty sure that the &quot;use two connections&quot; approach does not work. My application has two producers and a few dozens of consumers, and now - desperate as I am - each session has its own connection or, to put it the other way round, each connection has only a single session. Nevertheless I still end up with a lot of threads hanging around like shown in the original bug description (see above).&lt;/p&gt;</comment>
                            <comment id="12939204" author="rainer klute" created="Wed, 21 Nov 2007 10:08:35 +0000"  >&lt;p&gt;I did some further investigation and changed by JUnit test to use a configurable number of producers and consumers. The good news is that it demonstrates a bug with a very small amount of messages already. I one of the test scenarios I have 2 producers. Each one sends 2 messages to a topic. The single consumer should receive 4 messages. However, this fails depending on the combination of whether the producers or the consumers or both operate transacted or not. Increase the number of messages and other combinations fail. (I&apos;ll check in the JUnit test soon.)&lt;/p&gt;</comment>
                            <comment id="12938965" author="rainer klute" created="Wed, 21 Nov 2007 10:30:28 +0000"  >&lt;p&gt;Modified JUnit tests as mentioned in the comment above. See index.html for details!&lt;/p&gt;</comment>
                            <comment id="12939186" author="rainer klute" created="Wed, 21 Nov 2007 13:44:27 +0000"  >&lt;p&gt;Small fix in the JUnit test.&lt;/p&gt;

&lt;p&gt;If running the test with 2 messages (i.e. 1 per producer) the test fails differently from when running with many messages (e.g. 20,000 per producer).&lt;/p&gt;</comment>
                            <comment id="12939008" author="rainer klute" created="Wed, 21 Nov 2007 14:05:10 +0000"  >&lt;p&gt;Just tried the stuff with a TCP transport instead of a VM transport: No substantial change except for the places where the deadlocks occur.&lt;/p&gt;</comment>
                            <comment id="12939217" author="rajdavies" created="Fri, 23 Nov 2007 07:21:03 +0000"  >&lt;p&gt;The consumer(s) need to be initialized before you send messages to them -&lt;br/&gt;
e.g. when creating the ConsumerThreads in the ReliabilityTest - call consumer.init() - which actually creates the JMS consumer.&lt;/p&gt;

&lt;p&gt;ActiveMQ only sends topic messages to consumers that exist - or have existed (if they are durable). &lt;br/&gt;
Also - please don&apos;t call inactivity a deadlock &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12939152" author="rainer klute" created="Fri, 23 Nov 2007 07:56:10 +0000"  >&lt;p&gt;Please look once more: I &lt;b&gt;do&lt;/b&gt; initialize the consumer threads and create the consumers - see line 282 in ReliabilityTest.java.&lt;/p&gt;

&lt;p&gt;If there were no consumers, they wouldn&apos;t receive any messages at all. However, the usually do receive some messages, but not all.&lt;/p&gt;</comment>
                            <comment id="12939246" author="rajdavies" created="Fri, 23 Nov 2007 08:24:10 +0000"  >&lt;p&gt;your calling init in the wrong place -  move it to line 252&lt;/p&gt;</comment>
                            <comment id="12939221" author="rainer klute" created="Fri, 23 Nov 2007 08:37:32 +0000"  >&lt;p&gt;Yup, you are right! I now moved initializing and starting the consumers before the producers. However, the behaviour is still buggy, i.e. the two producers hanging in a commit() while the consumer is in a receive(). The corrected JUnit test will follow in a minute.&lt;/p&gt;</comment>
                            <comment id="12939200" author="rainer klute" created="Fri, 23 Nov 2007 08:39:41 +0000"  >&lt;p&gt;Fixed JUnit tests&lt;/p&gt;</comment>
                            <comment id="12939203" author="rajdavies" created="Wed, 28 Nov 2007 20:21:01 +0000"  >&lt;p&gt;Potential fix by SVN revision revision 599129&lt;br/&gt;
Rainer would you mind verifying please ?&lt;/p&gt;</comment>
                            <comment id="12939231" author="rainer klute" created="Thu, 29 Nov 2007 11:13:53 +0000"  >&lt;p&gt;The good news is: Yes, it works! Great! Thanks, Rob!&lt;/p&gt;

&lt;p&gt;The bad news is: Some test cases take a tremendous amount of heap space now. My former max memory setting of -Xmx256K was insufficient; with -Xmx1024K the test application runs. This gave me cause to investigate that behaviour more closely and I had jconsole watch the memory usage. The result you&apos;ll find in attachment &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1490&quot; title=&quot;Deadlocks (with JUnit tests)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1490&quot;&gt;&lt;del&gt;AMQ-1490&lt;/del&gt;&lt;/a&gt;_memory-001.png. I did some drawing on that screenshot to demarcate the test cases. The wall clock times on the X axis you can correlate to the detailed test case protocol in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1490&quot; title=&quot;Deadlocks (with JUnit tests)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1490&quot;&gt;&lt;del&gt;AMQ-1490&lt;/del&gt;&lt;/a&gt;_result-001.txt.&lt;/p&gt;

&lt;p&gt;The scenario is that two producers send each 100,000 messages to a topic and one consumer reads them all. The differences between them are whether producing and consuming sessions are transactional or not.&lt;/p&gt;

&lt;p&gt;Interesting results:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The enormous memory consumption only occurs if the producers operate transactionally and the consumer does not.&lt;/li&gt;
	&lt;li&gt;Test case 0001 (transactional producers) starts to consume much memory. However, after a mark-and-sweep garbage collection things stay moderate.&lt;/li&gt;
	&lt;li&gt;The execution times vary very much: There&apos;s a factor of 7.7 between the fastest and the slowest run.&lt;/li&gt;
	&lt;li&gt;The fastests test cases are those without transactional producers.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12939210" author="rainer klute" created="Thu, 29 Nov 2007 11:14:58 +0000"  >&lt;p&gt;Memory consumption screenshot (see last comment)&lt;/p&gt;</comment>
                            <comment id="12939227" author="rainer klute" created="Thu, 29 Nov 2007 11:15:56 +0000"  >&lt;p&gt;Detailed test results (see last comment)&lt;/p&gt;</comment>
                            <comment id="12939228" author="rajdavies" created="Tue, 4 Dec 2007 11:31:57 +0000"  >&lt;p&gt;There&apos;s additional fixes here by SVN revision 600891&lt;br/&gt;
If there isn&apos;t enough memory for the broker to finish a transaction the broker will block - so if you see producers pause this is the likely reason&lt;/p&gt;</comment>
                            <comment id="12939251" author="rainer klute" created="Wed, 5 Dec 2007 07:13:25 +0000"  >&lt;p&gt;I&apos;d be happy if that would be so. However, instead of pausing the test case still fails with an OutOfMemoryError when I specify -Xmx256M or -Xmx512M.&lt;/p&gt;

&lt;p&gt;With 768 MB it works. The funny thing is that it runs faster with 768 MB than with 1024 MB. Maybe its swapping that disturbs in the latter case.&lt;/p&gt;</comment>
                            <comment id="12939247" author="rajdavies" created="Sat, 8 Dec 2007 10:06:29 +0000"  >&lt;p&gt;Hi Rainer,&lt;br/&gt;
This has taken a while to track down - but the ack list in amq could grow excessively large. For my tests - the memory profile is good with 100,000 msgs per producer - if you get a chance - please confirm&lt;/p&gt;

&lt;p&gt;using  svn revision 602440&lt;/p&gt;

&lt;p&gt;thanks,&lt;/p&gt;

&lt;p&gt;Rob&lt;/p&gt;</comment>
                            <comment id="12939286" author="rainer klute" created="Sat, 8 Dec 2007 18:25:16 +0000"  >&lt;p&gt;Hi Rob,&lt;br/&gt;
now there&apos;s another problem: When the consumer is not yet receiving messages, the producers now block after sending a bunch of messages. They should spool the messages to disk instead. (My real-world application generates dozens or hundreds of messages per second while there might be now consumer available for days.)&lt;/p&gt;</comment>
                            <comment id="12939250" author="rajdavies" created="Sun, 16 Dec 2007 22:55:03 +0000"  >&lt;p&gt;Hi Rainer,&lt;br/&gt;
the problem is the size of the transaction  - currently you need to either have smaller transactions - or enough memory to accommodate them,&lt;br/&gt;
As this problem has moved on since the original issue - can we close this and add a new feature that would allow spooling to disk for in-memory transactions?&lt;/p&gt;

&lt;p&gt;thanks,&lt;/p&gt;

&lt;p&gt;Rob&lt;/p&gt;</comment>
                            <comment id="12939280" author="rainer klute" created="Mon, 17 Dec 2007 15:17:21 +0000"  >&lt;p&gt;Rob,&lt;br/&gt;
I am presently running my test cases&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;without the one with the large transaction size but&lt;/li&gt;
	&lt;li&gt;with more messages than before (500,000 per producer, with 2 producers and 1 consumer).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The flow control issues seems indeed to be solved, so yes, we can close this issue.&lt;/p&gt;

&lt;p&gt;However, with the increase of  the number of messages, I get all sorts of errors from the AMQ store, i.e.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;notes about messages that could not have been entered into the store because of an IndexOutOfBoundException, and&lt;/li&gt;
	&lt;li&gt;notes about messages that could not have been recoved from the store.&lt;br/&gt;
Before creating another issue, I&apos;ll update to the very latest ActiveMQ snapshot and retry.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12939290" author="rainer klute" created="Mon, 17 Dec 2007 16:21:17 +0000"  >&lt;p&gt;Oh no! With the latest snapshot (subversion revision 605158) I get blocks/deadlocks again! Producers and consumers each hanging in a commit()!&lt;/p&gt;</comment>
                            <comment id="12939283" author="rajdavies" created="Thu, 20 Dec 2007 00:13:13 +0000"  >&lt;p&gt;Could you attach a stack dump of where they hang in a commit ? - I can&apos;t reproduce&lt;/p&gt;</comment>
                            <comment id="12939241" author="rainer klute" created="Thu, 20 Dec 2007 10:39:59 +0000"  >&lt;p&gt;Hm, when I tried once again to reproduce it, I couldn&apos;t. Perhaps my grace period of 15 seconds for deadlock/blocking was too short and the algorithm detected a block that wasn&apos;t one. Now it requires 2 minutes without any send/receive activity before claiming that something blocks.&lt;/p&gt;

&lt;p&gt;I&apos;d say let&apos;s close this issue. I&apos;ll continue to stress test ActiveMQ anyway and will submit a new issue soon!&lt;/p&gt;

&lt;p&gt;Rob, thanks a lot for fixing this issue!&lt;/p&gt;</comment>
                            <comment id="12939285" author="rajdavies" created="Thu, 20 Dec 2007 20:45:35 +0000"  >&lt;p&gt;Phew! Thanks Rainer for you&apos;re help!!&lt;/p&gt;</comment>
                            <comment id="12938497" author="rainer klute" created="Fri, 25 Jan 2008 14:48:00 +0000"  >&lt;p&gt;Sorry, but I have to reopen this issue again!&lt;/p&gt;

&lt;p&gt;While the test scenario &quot;multiple producers, single consumer&quot; seems to work fine in most cases, the scenario &quot;one producer, multiple consumers&quot; fails soon and reproducibly with just 2 consumers and as few as 6,000 messages. (In my production environment I&apos;ll have about 600 consumers and about 250 messages per second.)&lt;/p&gt;

&lt;p&gt;I shall re-submit a further development of my JUnit test case shortly.&lt;/p&gt;</comment>
                            <comment id="12938636" author="rainer klute" created="Fri, 25 Jan 2008 14:58:12 +0000"  >&lt;p&gt;Sample output of the &quot;1 producer, 2 consumers&quot; scenario&lt;/p&gt;</comment>
                            <comment id="12938926" author="rainer klute" created="Sat, 26 Jan 2008 16:36:41 +0000"  >&lt;p&gt;The latest version of my test cases.&lt;/p&gt;</comment>
                            <comment id="12939345" author="rainer klute" created="Wed, 13 Feb 2008 10:24:39 +0000"  >&lt;p&gt;Seems to work with revision 627336 if transaction size is not too big. However, if neither producer nor consumers are transacted, performance is best.&lt;/p&gt;</comment>
                            <comment id="12939366" author="lhotari" created="Tue, 4 Mar 2008 15:52:15 +0000"  >&lt;p&gt;I&apos;m using Jencks Inbound/Outbound JMS configuration for consuming &amp;amp; producing messages and quite often there&apos;s a 2 minute delay in message delivery after the producer has replied. This happens only in ActiveMQ 5.0. I&apos;ll try nightly builds to see if they fix the problem. Maybe JCA/RA has the same issue?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12460934" name="AMQ-1490_memory-001.png" size="54971" author="rainer klute" created="Thu, 29 Nov 2007 11:14:58 +0000"/>
                            <attachment id="12460974" name="AMQ-1490_result-001.txt" size="87043" author="rainer klute" created="Thu, 29 Nov 2007 11:15:56 +0000"/>
                            <attachment id="12460989" name="AMQ-1490_result-002.txt" size="10978" author="rainer klute" created="Fri, 25 Jan 2008 14:58:12 +0000"/>
                            <attachment id="12461012" name="ActiveMQ_Testcases.jar" size="49703" author="rainer klute" created="Sat, 26 Jan 2008 16:36:41 +0000"/>
                            <attachment id="12461018" name="ActiveMQ_Testcases.jar" size="38400" author="rainer klute" created="Fri, 23 Nov 2007 08:39:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84682</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 39 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0tsmn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>171947</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>