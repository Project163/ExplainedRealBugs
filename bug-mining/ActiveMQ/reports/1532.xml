<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:54:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3654] JDBC Master/Slave : Slave cannot acquire lock when the master loose database connection.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3654</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Our configuration is JDBC Master/Slave with one master and one slave. When the master is started, he acquire the database lock.&lt;br/&gt;
Then when the slave is started, he wait to acquire the database lock. When the master loose the network connection to the database, the lock in the database is not removed and the slave connot acquire the database lock. In this situation, the master is unable to respond to client (due to network failure)&lt;br/&gt;
and the slave is not started because he can&apos;t acquire the database lock.&lt;/p&gt;

&lt;p&gt;When the master is killed, the slave can&apos;t acquire the database lock too. After the network connection is restored, when the master starts, it cannot&lt;br/&gt;
acquire lock to the database (because the lod lock is always present) so now, we have two slaves and no master.&lt;/p&gt;

&lt;p&gt;Please, refer to this issue which is the same problem : &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1958&quot; title=&quot;JDBC master/slave deadlock when connection is lost&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1958&quot;&gt;&lt;del&gt;AMQ-1958&lt;/del&gt;&lt;/a&gt; &lt;/p&gt;</description>
                <environment>&lt;p&gt;Unix/Redhat 5.6&lt;br/&gt;
ActiveMQ 5.5.0&lt;br/&gt;
Oracle 10G&lt;/p&gt;</environment>
        <key id="12537523">AMQ-3654</key>
            <summary>JDBC Master/Slave : Slave cannot acquire lock when the master loose database connection.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="rmartin">Richard Martin</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 Jan 2012 15:11:41 +0000</created>
                <updated>Mon, 20 Aug 2012 11:31:56 +0000</updated>
                            <resolved>Wed, 13 Jun 2012 21:55:49 +0000</resolved>
                                    <version>5.5.0</version>
                                    <fixVersion>5.7.0</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="13181422" author="wangyin" created="Fri, 6 Jan 2012 16:33:37 +0000"  >
&lt;p&gt;I guess When the master loose the network connection to the database,the underlying jdbc connection can not detect the network connection is broken in time.&lt;br/&gt;
You can try to set the value of property lockKeepAlivePeriod of jdbcPersistenceAdapter to be smaller than default value(default 30s).&lt;br/&gt;
If it works please let me know,thanks.&lt;/p&gt;</comment>
                            <comment id="13182642" author="rmartin" created="Mon, 9 Jan 2012 17:21:17 +0000"  >&lt;p&gt;Thanks for the suggestion, i tried to set the property lockKeepAlivePeriod to 3s with this configuration :&lt;/p&gt;

&lt;p&gt;&amp;lt;jdbcPersistenceAdapter lockKeepAlivePeriod=&quot;3000&quot;  dataDirectory=&quot;${activemq.base}/data&quot; dataSource=&quot;#oracle-ds&quot; /&amp;gt;&lt;/p&gt;

&lt;p&gt;But it didn&apos;t work. When the network connection on the master is lost, the lock is still present in the database. Any other idea which can solve the network failure test ?&lt;/p&gt;

&lt;p&gt;Do you think, i can use the jdbc mode configured with useDatabaseLock=&quot;false&quot; ? It seem to be a master/master solution. We need to have a HA Solution with no message lost. With the shared database, the message are stored in the same place. So if the master1 fail, the message is stored in the database and our client switch to the master2 and he can consume the message. Is it correct or i must use a Jdbc master/slave with useDatabaseLock=&quot;true&quot; to have a HA solution ?&lt;/p&gt;</comment>
                            <comment id="13182979" author="wangyin" created="Tue, 10 Jan 2012 01:16:22 +0000"  >&lt;p&gt;Seem it&apos;s the business for oracle to handle this situation because it doest not detect the broken connection and release the row lock in time.&lt;br/&gt;
You can consult your DBA for more advice.&lt;/p&gt;</comment>
                            <comment id="13193863" author="metatech" created="Thu, 26 Jan 2012 14:35:52 +0000"  >&lt;p&gt;If the database connection is abruptly lost (no TCP FIN nor RST), for instance when the network cable is unplugged, the DB client application cannot release the lock anymore.&lt;br/&gt;
The DB server itself needs to detect the dead connection.&lt;br/&gt;
On Oracle the parameter &quot;SQLNET.EXPIRE_TIME&quot; can be used.&lt;/p&gt;</comment>
                            <comment id="13205353" author="kimmking" created="Fri, 10 Feb 2012 10:47:18 +0000"  >&lt;p&gt;metatech&apos;s suggestion is nice.&lt;/p&gt;

&lt;p&gt;Exclusive Lock in this point is magic and dangerous way.&lt;br/&gt;
 Under certain conditions, this error will occur.&lt;br/&gt;
   And if a storage do not support the lock like this, sadness happens.&lt;/p&gt;</comment>
                            <comment id="13274504" author="ranpeng" created="Mon, 14 May 2012 08:26:26 +0000"  >&lt;p&gt;i use the mysql database to store messages ,and i met the same problem. When the master loose the network connection to the database, the lock in the database is not removed and the slave connot acquire the database lock.after the network recovery connection ,the master still can&apos;t acquire lock to the database  so now, we have two slaves and no master.period of time , the master process automatically exit,remaining a slave.Any other idea which can solve the network failure test ?&lt;/p&gt;</comment>
                            <comment id="13294679" author="gtully" created="Wed, 13 Jun 2012 21:55:49 +0000"  >&lt;p&gt;Added a lease based data base locker. Use as follows from xml config with the 5.7-SNAPSHOT&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;       &amp;lt;ioExceptionHandler&amp;gt;
            &amp;lt;jDBCIOExceptionHandler/&amp;gt;
        &amp;lt;/ioExceptionHandler&amp;gt;

        &amp;lt;persistenceAdapter&amp;gt;
            &amp;lt;jdbcPersistenceAdapter lockKeepAlivePeriod=&lt;span class=&quot;code-quote&quot;&gt;&quot;1000&quot;&lt;/span&gt; lockAcquireSleepInterval=&lt;span class=&quot;code-quote&quot;&gt;&quot;2000&quot;&lt;/span&gt;&amp;gt;
                &amp;lt;databaseLocker&amp;gt;
                    &amp;lt;lease-database-locker/&amp;gt;
                &amp;lt;/databaseLocker&amp;gt;
            &amp;lt;/jdbcPersistenceAdapter&amp;gt;
        &amp;lt;/persistenceAdapter&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The optional IOExceptionHandler will pause/resume the transport connectors on any IO exception related to access to the DB.&lt;br/&gt;
The lease based lock is acquired by blocking at start and retained by the keepAlivePeriod. To retain, the lease is extended by the lockAcquireSleepInterval, so in theory the master is always &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;lockAcquireSleepInterval-lockKeepAlivePeriod&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; ahead of the slave w.r.t the lease.&lt;br/&gt;
The lease is dropped on normal shutdown.&lt;br/&gt;
The broker system clock is not in sync with the db, a maxAllowableDiffFromDBTime &amp;gt; 0 will adjust the lease duration if the skew exceeds the absolute maxAllowableDiffFromDBTime value, allowing the db to dictate the utc basis for the lease.&lt;/p&gt;</comment>
                            <comment id="13294681" author="gtully" created="Wed, 13 Jun 2012 21:58:24 +0000"  >&lt;p&gt;would appreciate if you could validate the efficacy of this lease based approach in your environment using the latest 5.7-SNAPSHOT &lt;/p&gt;</comment>
                            <comment id="13430984" author="gshx" created="Wed, 8 Aug 2012 09:43:59 +0000"  >&lt;p&gt;Thanks Gary. What is the suggested patch back-porting process in case I want to apply this patch to my v5.6 broker running the jdbc master-slave configuration against oracle? Should I just build the core jar from source after applying the changes to v5.6 code in my local svn repo?&lt;/p&gt;</comment>
                            <comment id="13430990" author="gtully" created="Wed, 8 Aug 2012 09:53:13 +0000"  >&lt;p&gt;maybe first try a 5.7-SNAPSHOT to validate it works in your use case, but sure, an updated activemq-core is all that you will need.&lt;/p&gt;</comment>
                            <comment id="13430996" author="gshx" created="Wed, 8 Aug 2012 10:13:59 +0000"  >&lt;p&gt;Thanks Gary, will first test with the 5.7-SNAPSHOT.&lt;/p&gt;</comment>
                            <comment id="13431196" author="zeeiyer" created="Wed, 8 Aug 2012 16:14:46 +0000"  >&lt;p&gt;+1 for the lock lease approach with the deck loaded in favor of the current leasee. That&apos;s how i have seen it work with Terracotta and many other implementations...Seems like just the implementation needs to be tested out.&lt;/p&gt;</comment>
                            <comment id="13432484" author="gshx" created="Fri, 10 Aug 2012 02:10:22 +0000"  >&lt;p&gt;Tested 5.7-SNAPSHOT with MySQL and the patch works just fine. The BROKER_NAME also seems to be getting populated in the lock table.&lt;/p&gt;</comment>
                            <comment id="13433008" author="wangyin" created="Mon, 13 Aug 2012 08:59:28 +0000"  >&lt;p&gt;For row lock based database locker, I use the same configuration file for all brokers.&lt;br/&gt;
This makes deployment job simple really.&lt;br/&gt;
LeaseDatabaseLocker need specify the unique lease id, by default it&apos;s broker name, &lt;br/&gt;
so does this mean I have to specify different broker name for each one in the cluster?&lt;br/&gt;
The last confusion is should lockAcquireSleepInterval be greater than lockKeepAlivePeriod anyway?&lt;/p&gt;</comment>
                            <comment id="13437795" author="gtully" created="Mon, 20 Aug 2012 11:31:56 +0000"  >&lt;p&gt;@SuoNayi &lt;br/&gt;
yes, either the brokerName or the lease-database-locker.leaseHolderId needs to be unique for a master/slave pair.&lt;br/&gt;
And yes, lockAcquireSleepInterval &amp;gt; lockKeepAlivePeriod is necessary.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12539772">AMQ-3681</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12483313">AMQ-1958</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>223029</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 14 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0agr3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>58987</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>