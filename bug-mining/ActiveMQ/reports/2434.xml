<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:07:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5493] KahaDB MessageDatabase race condition while stopping the broker and cleaning up</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5493</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;This issue was seen on the surface via the following broker INFO log message:&lt;/p&gt;

&lt;p&gt;2014-12-10 16:21:58,842 | INFO  | KahaDB: Recovering checkpoint thread after death | org.apache.activemq.store.kahadb.MessageDatabase | Thread-26&lt;/p&gt;

&lt;p&gt;This means that the checkpoint thread is being revived unnecessarily while&lt;br/&gt;
stopping the broker. It could even happen that it is revived multiple times before the closing process is completed.&lt;/p&gt;

&lt;p&gt;To show the flow of the race condition, consider the following blocks of code from activemq/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/MessageDatabase.java:&lt;/p&gt;

&lt;p&gt;Lines 425 - 442 &lt;span class=&quot;error&quot;&gt;&amp;#91;in close()&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;if( opened.compareAndSet(true, false)) {&lt;br/&gt;
     ... some code ...&lt;br/&gt;
          if (metadata.page != null) &lt;/p&gt;
{
               checkpointUpdate(true);
          }
&lt;p&gt;     ... some code ...&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;Lines 1499 - 1501 &lt;span class=&quot;error&quot;&gt;&amp;#91;in checkpointUpdate(boolean)&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;public void execute(Transaction tx) throws IOException {&lt;br/&gt;
     checkpointUpdate(tx, cleanup);&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;Line 1524 &lt;span class=&quot;error&quot;&gt;&amp;#91;in checkpointUpdate(Transaction, boolean)&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;metadata.ackMessageFileMapLocation = checkpointAckMessageFileMap();&lt;/p&gt;

&lt;p&gt;Line 1735 &lt;span class=&quot;error&quot;&gt;&amp;#91;in checkpointAckMessageFileMap()&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Location location = store(new KahaAckMessageFileMapCommand().setAckMessageFileMap(new Buffer(baos.toByteArray())), nullCompletionCallback);&lt;/p&gt;

&lt;p&gt;Lines 993 - 995 &lt;span class=&quot;error&quot;&gt;&amp;#91;in store(...)&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;if (checkpointThread != null &amp;amp;&amp;amp; !checkpointThread.isAlive()) {&lt;br/&gt;
     startCheckpoint();&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;Lines 332  - 372  &lt;span class=&quot;error&quot;&gt;&amp;#91;In startCheckpoint()&amp;#93;&lt;/span&gt;&lt;br/&gt;
if (checkpointThread == null) {&lt;br/&gt;
     start = true;&lt;br/&gt;
} else if (!checkpointThread.isAlive()) {&lt;br/&gt;
     start = true;&lt;br/&gt;
      LOG.info(&quot;KahaDB: Recovering checkpoint thread after death&quot;);&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;if (start) {&lt;br/&gt;
     checkpointThread = new Thread(&quot;ActiveMQ Journal Checkpoint Worker&quot;) {&lt;br/&gt;
          @Override&lt;br/&gt;
          public void run() {&lt;br/&gt;
               try {&lt;br/&gt;
                     ... some code ...&lt;br/&gt;
                     while (opened.get()) &lt;/p&gt;
{
                          ... some code ...
                     }
&lt;p&gt;                } catch (InterruptedException e) &lt;/p&gt;
{
                            // Looks like someone really wants us to exit this thread...
                }
&lt;p&gt; catch (IOException ioe) &lt;/p&gt;
{
                            LOG.error(&quot;Checkpoint failed&quot;, ioe);
                            brokerService.handleIOException(ioe);
               }
&lt;p&gt;          }&lt;br/&gt;
     };&lt;/p&gt;

&lt;p&gt;     checkpointThread.setDaemon(true);&lt;br/&gt;
     checkpointThread.start();&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;Here is the sequence of events, involving code above that shows the race:&lt;/p&gt;

&lt;p&gt;1. in close() set &quot;opened&quot; to false&lt;br/&gt;
2. in startCheckpoint() &quot;opened.get()&quot; is false so checkpoint thread exits run method and makes checkpointThread.isAlive() false&lt;br/&gt;
3. in store(...) calling startCheckpoint() which will revive the checkpoint thread again&lt;/p&gt;

&lt;p&gt;Added some INFO logs to confirm the order above:&lt;/p&gt;

&lt;p&gt;2014-12-17 13:27:43,678 | INFO  | patanasov: from unload() calling close() | org.apache.activemq.store.kahadb.MessageDatabase | Thread-18&lt;br/&gt;
2014-12-17 13:27:43,678 | INFO  | patanasov: close(): set opened to false; calling checkpointUpdate(true) | org.apache.activemq.store.kahadb.MessageDatabase | Thread-18&lt;br/&gt;
2014-12-17 13:27:43,678 | INFO  | patanasov: startCheckpoint(): checkpointThread exiting its run method | org.apache.activemq.store.kahadb.MessageDatabase | ActiveMQ Journal Checkpoint Worker&lt;br/&gt;
2014-12-17 13:27:43,681 | INFO  | patanasov: from store() calling startCheckpoint() | org.apache.activemq.store.kahadb.MessageDatabase | Thread-18&lt;br/&gt;
2014-12-17 13:27:43,682 | INFO  | KahaDB: Recovering checkpoint thread after death | org.apache.activemq.store.kahadb.MessageDatabase | Thread-18&lt;/p&gt;

&lt;p&gt;Based on my limited understanding of this code, this does not seem to have any serious negative impacts, but it would be nice to be looked at by the community.   &lt;/p&gt;

&lt;p&gt;It does not seem to make sense to revive the thread after opened.get() became false because the checkpointThread will not do anything anyway due to opened.get() being false at that point. Consider the body of the checkpointThread:&lt;/p&gt;

&lt;p&gt;MessageDatabase.java, Lines 348 - 359&lt;/p&gt;

&lt;p&gt;while (opened.get()){&lt;br/&gt;
     ... code that will attempt updates ...&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;However, since opened.get() is false, this will not enter the while loop and hence the checkpointThread will exit its run quickly again.&lt;/p&gt;

&lt;p&gt;A possible fix for this is the following&lt;/p&gt;

&lt;p&gt;Lines 993 - 995 &lt;span class=&quot;error&quot;&gt;&amp;#91;in store(...)&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;change&lt;/p&gt;

&lt;p&gt;if (checkpointThread != null &amp;amp;&amp;amp; !checkpointThread.isAlive()) {&lt;br/&gt;
     startCheckpoint();&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;to&lt;/p&gt;

&lt;p&gt;if (checkpointThread != null &amp;amp;&amp;amp; !checkpointThread.isAlive() &amp;amp;&amp;amp; opened.get()) {&lt;br/&gt;
     startCheckpoint();&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;If opened.get() is false, then we must be closing and we will not revive the thread. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12762634">AMQ-5493</key>
            <summary>KahaDB MessageDatabase race condition while stopping the broker and cleaning up</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="patanasov">Pero Atanasov</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Dec 2014 17:38:52 +0000</created>
                <updated>Mon, 22 Dec 2014 12:46:05 +0000</updated>
                            <resolved>Mon, 22 Dec 2014 12:46:05 +0000</resolved>
                                    <version>5.10.0</version>
                                    <fixVersion>5.11.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14251931" author="patanasov" created="Thu, 18 Dec 2014 17:43:27 +0000"  >&lt;p&gt;Patch to fix raised issue.&lt;/p&gt;</comment>
                            <comment id="14255704" author="gtully" created="Mon, 22 Dec 2014 12:46:05 +0000"  >&lt;p&gt;patch applied with thanks in &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/activemq/commit/02d974c4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/activemq/commit/02d974c4&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12688069" name="AMQ5493.patch" size="814" author="patanasov" created="Thu, 18 Dec 2014 17:43:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 48 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23l33:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>