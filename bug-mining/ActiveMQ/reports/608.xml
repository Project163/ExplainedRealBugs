<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:41:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2233] After rollback received messages not re-presented</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2233</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;After rollback received messages not re-presented.  If I receive in a transaction and then roll back the messages should be re-presented in the next transaction.  This used to work in 5.1.0, but is broken in 5.2.0.&lt;/p&gt;

&lt;p&gt;You can browse the Queue in JMX after the rollback and see that the messages are still there, but they are not received by a consumer in the same process.&lt;/p&gt;

&lt;p&gt;Here&apos;s a test case (fails on the checkPostConditions()):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;RawRollbackTests {
	
	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; ConnectionFactory connectionFactory;
	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Destination queue;
	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; BrokerService broker;

	@BeforeClass
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void clean() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		FileUtils.deleteDirectory(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-quote&quot;&gt;&quot;activemq-data&quot;&lt;/span&gt;));
		broker = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BrokerService();
		broker.setUseJmx(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
		broker.start();
		ActiveMQConnectionFactory connectionFactory = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ActiveMQConnectionFactory();
		connectionFactory.setBrokerURL(&lt;span class=&quot;code-quote&quot;&gt;&quot;vm:&lt;span class=&quot;code-comment&quot;&gt;//localhost?async=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;);
&lt;/span&gt;		RawRollbackTests.connectionFactory = connectionFactory;
		queue = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ActiveMQQueue(&lt;span class=&quot;code-quote&quot;&gt;&quot;queue&quot;&lt;/span&gt;);
	}

	@AfterClass
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void close() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		broker.stop();
	}

	@Before
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void clearData() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		getMessages(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// drain queue
&lt;/span&gt;		convertAndSend(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;);
		convertAndSend(&lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;);
	}


	@After
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void checkPostConditions() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {

		&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000L);
		List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; list = getMessages(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
		assertEquals(2, list.size());

	}

	@Test
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testReceiveMessages() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {

		List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; list = getMessages(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
		assertEquals(2, list.size());
		assertTrue(list.contains(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;));

	}
	
	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void convertAndSend(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; msg) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		Connection connection = connectionFactory.createConnection();
		connection.start();
		Session session = connection.createSession(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, Session.AUTO_ACKNOWLEDGE);
		MessageProducer producer = session.createProducer(queue);
		producer.send(session.createTextMessage(msg));
		producer.close();
		session.commit();
		session.close();
		connection.close();
	}

	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; getMessages(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; rollback) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		Connection connection = connectionFactory.createConnection();
		connection.start();
		Session session = connection.createSession(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, Session.AUTO_ACKNOWLEDGE);
		&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; next = &quot;&quot;;
		List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; msgs = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;();
		&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (next != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
			next = (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) receiveAndConvert(session);
			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (next != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
				msgs.add(next);
		}
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rollback) {
			session.rollback();
		} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
			session.commit();
		}
		session.close();
		connection.close();
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; msgs;
	}

	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; receiveAndConvert(Session session) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		MessageConsumer consumer = session.createConsumer(queue);
		Message message = consumer.receive(100L);
		consumer.close();
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (message==&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
		}
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ((TextMessage)message).getText();
	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12483038">AMQ-2233</key>
            <summary>After rollback received messages not re-presented</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="david_syer">Dave Syer</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Apr 2009 12:08:40 +0000</created>
                <updated>Wed, 8 Jul 2009 09:03:05 +0000</updated>
                            <resolved>Wed, 8 Jul 2009 09:03:05 +0000</resolved>
                                    <version>5.2.0</version>
                                    <fixVersion>5.3.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                    <workratio workratioPercent="0"/>
                                                                    <timeoriginalestimate seconds="0">0h</timeoriginalestimate>
                            <timeestimate seconds="0">0h</timeestimate>
                                        <comments>
                            <comment id="12941230" author="gtully" created="Tue, 28 Apr 2009 16:31:32 +0000"  >&lt;p&gt;can you attach your test case (see the attach file link) and make a license grant so that your test can be added to the activemq suite?&lt;/p&gt;

&lt;p&gt;This is an interesting test case. The change of behavior is around consumer.close() and transactions. When in a transaction, the close is deferred till the transaction completes, so with a prefetch &amp;gt; 0, messages dispatched to that consumer will not be available till the transaction commits.&lt;/p&gt;

&lt;p&gt;I think your test case will work with a prefetch of 0, connectionFactory.setBrokerURL(&quot;vm://localhost?async=false&amp;amp;waitForStart=5000&amp;amp;jms.prefetchPolicy.all=0&quot;);&lt;/p&gt;</comment>
                            <comment id="12941236" author="gtully" created="Tue, 28 Apr 2009 16:46:45 +0000"  >&lt;p&gt;for a managed case, the XA case was made the general case. a close is deferred if in any transaction.&lt;/p&gt;</comment>
                            <comment id="12941234" author="david_syer" created="Wed, 29 Apr 2009 05:20:08 +0000"  >&lt;p&gt;Attached test case as file.&lt;/p&gt;</comment>
                            <comment id="12941244" author="david_syer" created="Sat, 2 May 2009 07:44:47 +0000"  >&lt;p&gt;Thanks for the response.  The prefetch hint didn&apos;t have any effect on the test case.  I didn&apos;t follow the comment about the deferred close.&lt;/p&gt;</comment>
                            <comment id="12941298" author="gtully" created="Tue, 12 May 2009 11:36:29 +0000"  >&lt;p&gt;Added your test case with the prefetch workaround: &lt;a href=&quot;http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/test/java/org/apache/activemq/bugs/RawRollbackTests.java?view=markup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/test/java/org/apache/activemq/bugs/RawRollbackTests.java?view=markup&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The issue is the consumer.close call in the receiveAndConvert. The close occurs in a transaction and the close is deferred till the transaction completes. The default prefetch value of 100 ensures that the consumer will have both messages queued up for dispatch. The undispatched are only redispatched afer the close. But we don&apos;t know if the messages are to be acked till the transaction completes. Thus the additional prefetched &quot;bar&quot; message is not available to a second consumer.&lt;br/&gt;
Changing the prefetch value to 0 (note the changed connectionURL) ensures that each consumer gets a single message from a call to receive so only that message is outstanding until the transaction completes.&lt;/p&gt;</comment>
                            <comment id="12941297" author="david_syer" created="Tue, 12 May 2009 12:37:30 +0000"  >&lt;p&gt;Thanks for the update.  I tried (as previously indicated) the prefetch hint and it didn&apos;t change anything.  If I understand the comment correctly maybe you misunderstood the test case: it doesn&apos;t fail because &quot;bar&quot; is unavailable to a second consumer - in fact it is, as the assertion &lt;tt&gt;assertEquals(2, list.size())&lt;/tt&gt; in the test method shows. &lt;/p&gt;

&lt;p&gt;It fails because neither &quot;foo&quot; nor &quot;bar&quot; is available to any consumer whatsoever, after the rollback has occurred.  The transaction has certainly completed by the time the test fails (thecomment seems to imply the opposite, but maybe I misunderstood).&lt;/p&gt;

&lt;p&gt;It still fails for you, right?  (I only ran it against 5.2.0.)&lt;/p&gt;</comment>
                            <comment id="12941277" author="gtully" created="Tue, 12 May 2009 15:42:10 +0000"  >&lt;p&gt;so the test (your test) I committed to trunk works. It uses &amp;amp;jms.prefetchPolicy.all=0&lt;/p&gt;

&lt;p&gt;With out the prefetch=0 config, the assertion fails for me with list.size() == 1&lt;br/&gt;
In the rollback case, receiveAndConvert is called twice so two consumers are created. The first consumer gets both messages dispatched to it and consumes one before closing. The second consumer gets nothing. So list.size == 1.&lt;br/&gt;
The problem is the consumer.close is deferred till the transaction completes (commits or rollsback)&lt;/p&gt;

&lt;p&gt;The workaround is to only deliver messages on demand, when receive is called, prefetch=0 gives this.&lt;/p&gt;</comment>
                            <comment id="12941296" author="david_syer" created="Wed, 13 May 2009 00:42:09 +0000"  >&lt;p&gt;Your failure is not the same as mine (in 5.2.0).  I am failing in the @After, and it sounds like you are failing (before the fetch size hint) in @Test.&lt;/p&gt;

&lt;p&gt;I will try it when a new snapshot appears.  The Apache snapshots repo has a latest version in mid April; any news on that, or am I looking in the wrong place?&lt;/p&gt;

&lt;p&gt;The original test (with or without the fech size) still fails with 5.2.0 and passes with 5.1.0.  It also fails if I use a single consumer to consume all messages in a Session.  So I&apos;d be interested to know what broke in the meantime there.  5.1.0 seems correct as far as the JMS spec goes.&lt;/p&gt;</comment>
                            <comment id="12941291" author="gtully" created="Wed, 13 May 2009 08:22:02 +0000"  >&lt;p&gt;The nightly snapshot is available at &lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.3-SNAPSHOT/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.3-SNAPSHOT/&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;I think the key change (on trunk) relates to consumer.close when there is a transaction. The close is deferred to a synchronisation afterCompletion so the effect of the close is not visible till the transaction completes. From what i can see, the test depends on the visibility of predispatched messages before the transaction completes.&lt;/p&gt;

&lt;p&gt;Can you provide your test variant that uses a single consumer so I can include it?&lt;br/&gt;
W.r.t the spec, the whole prefetch issue is outside the spec, prefetch=0 gets it back in line.&lt;/p&gt;</comment>
                            <comment id="12941295" author="david_syer" created="Wed, 13 May 2009 11:27:14 +0000"  >&lt;p&gt;Added shared consumer test case.  This passes in 5.3-SNAPSHOT even without the fetch size hint as predicted.  But it also fails in 5.2.0, which still seems like a bug to me, considering what you said above.  What do you think?&lt;/p&gt;</comment>
                            <comment id="12941303" author="gtully" created="Fri, 15 May 2009 09:30:43 +0000"  >&lt;p&gt;yea, I think that is a bug with 5.2.0. All is good on trunk now though. I committed that shared test to protect against regression, thanks. Are you happy to see this issue closed?&lt;/p&gt;</comment>
                            <comment id="12941329" author="david_syer" created="Tue, 19 May 2009 10:01:49 +0000"  >&lt;p&gt;Not abundantly happy, really, no.  I think it&apos;s a regression from 5.1.0, and hiding behind the strict letter of the law regarding the specification is a weak position to take.  Even if prefetch is a proprietary feature, having to set it to a non-default value to get a system to behave as expected makes it very hard for users to guess or understand what is happening.  Also, prefetch is a good feature that I probably want to use, so switching it off just to get messages redelivered to another consumer in the same process seems like it must be a workaround for a bug.&lt;/p&gt;</comment>
                            <comment id="12941496" author="david_syer" created="Mon, 15 Jun 2009 17:12:17 +0000"  >&lt;p&gt;I am seeing this issue in production environments now - unacked messages sit on the broker forever until it is restarted.  Is there some way I can help to fix it so the behaviour goes back to the way it was in 5.1?&lt;/p&gt;</comment>
                            <comment id="12941708" author="david_syer" created="Wed, 8 Jul 2009 07:36:02 +0000"  >&lt;p&gt;This issue is now apparently fixed in 5.3-SNAPSHOT (my original test case passes), presumably as a result of fixes for other issues?&lt;/p&gt;</comment>
                            <comment id="12941707" author="gtully" created="Wed, 8 Jul 2009 09:03:05 +0000"  >&lt;p&gt;resolving as per dave&apos;s comment, current snapshot has a fix.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12482777">AMQ-2034</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12461512" name="RawRollbackSharedConsumerTests.java" size="3313" author="david_syer" created="Wed, 13 May 2009 11:27:14 +0000"/>
                            <attachment id="12461503" name="RawRollbackTests.java" size="3315" author="david_syer" created="Wed, 29 Apr 2009 05:20:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>75017</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 20 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s1cn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161695</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310080" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Regression</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10091"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>