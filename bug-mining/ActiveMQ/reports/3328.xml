<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:49:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-7488] Corruption to mKahaDB transaction journal can lead to partial transaction completion in error</title>
                <link>https://issues.apache.org/jira/browse/AMQ-7488</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;mKahaDB has a transaction journal to track the outcome of local JMS transactions that span kahaDB instances. Ie: send to A and B where each has its own persistence adapter.&lt;br/&gt;
To ensure N instances are in sync,  a local 2PC is required&lt;br/&gt;
On recovery, if there is an outcome recorded in the txStore journal a commit must be replayed. If the outcome has not been recorded, rollback is assumed.&lt;br/&gt;
If the txJournal is corrupt and detected as corrupt the broker fails to start. &lt;br/&gt;
However it is not possible to manually recover via JMX without a live broker.&lt;br/&gt;
Each kahaDB instance would need to be restarted in isolation to force heuristic completion.&lt;/p&gt;

&lt;p&gt;Deleting the corrupt journal to allow restart is potentially problematic &lt;b&gt;if&lt;/b&gt; there are pending outcomes. &lt;br/&gt;
It can lead to partial outcomes, as recovery assumes good information, with no information from an empty tx journal, assumes rollback of any relevant pending transaction.&lt;/p&gt;

&lt;p&gt;Note: the failure window is very small, but it is present and can lead to message loss once the txStore data is lost, deleted. &lt;/p&gt;

&lt;p&gt;workarond:&lt;br/&gt;
Only delete a corrupt txStore journal once there are no recovered XA transactions in play in any of the nested kahaDB instances. This is visible from the recovery logging.&lt;br/&gt;
If there are recovered XA transactions with formatId=61616 (the internal id used to identify these local 2pc transactions), then careful recovery of the relevant kahaDB instance directory in standalone mode (without mKahaDB) will be required if the transactions should commit.&lt;/p&gt;

&lt;p&gt;solution:&lt;br/&gt;
The journal needs to better detect  corruption &lt;b&gt;and&lt;/b&gt; not do any recovery processing in the absence of correct (non corrupt) information. Leaving pending transactions to be heuristically completed via JMX. &lt;/p&gt;</description>
                <environment></environment>
        <key id="13306171">AMQ-7488</key>
            <summary>Corruption to mKahaDB transaction journal can lead to partial transaction completion in error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="gtully">Gary Tully</reporter>
                        <labels>
                            <label>XA</label>
                            <label>mKahaDB</label>
                            <label>mkahadb</label>
                            <label>recovery</label>
                    </labels>
                <created>Wed, 20 May 2020 11:39:00 +0000</created>
                <updated>Wed, 20 May 2020 11:49:22 +0000</updated>
                            <resolved>Wed, 20 May 2020 11:48:36 +0000</resolved>
                                    <version>5.15.0</version>
                                    <fixVersion>5.16.0</fixVersion>
                                    <component>KahaDB</component>
                    <component>mKahaDB</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17112094" author="jira-bot" created="Wed, 20 May 2020 11:43:56 +0000"  >&lt;p&gt;Commit cedac472a1f143955c41d9a05baa2d4bf38399a3 in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=cedac47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=cedac47&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7488&quot; title=&quot;Corruption to mKahaDB transaction journal can lead to partial transaction completion in error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7488&quot;&gt;&lt;del&gt;AMQ-7488&lt;/del&gt;&lt;/a&gt; mkahadb - detect txStore corruption and suspend recovery, auto recover if no outcomes pending&lt;/p&gt;</comment>
                            <comment id="17112100" author="gtully" created="Wed, 20 May 2020 11:48:36 +0000"  >&lt;p&gt;Enabled checksum for txStore and tidied up journal corruption detection.&lt;br/&gt;
In the presence of corruption and pending transactions, heuristic completion will be required via JMX.&lt;br/&gt;
If there are no pending transactions, the corruption is resolved automatically.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 25 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ey7s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>