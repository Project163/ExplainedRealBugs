<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:10:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5413] AMQP test client delivery/redelivery anomoly</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5413</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Using Apache Qpid test clients qpid-send and qpid-receive ActiveMQ broker behaves differently from qpidd and I&apos;m wondering if the difference is important.&lt;/p&gt;

&lt;p&gt;The test code command lines are:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;qpid-send -a &quot;chuck; {create:always}&quot; --connection-options {protocol:amqp1.0} --sequence yes --content-string 0
qpid-receive -a chuck -m 1 --connection-options &quot;{protocol:amqp1.0}&quot; --print-headers yes
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When I run the tests against qpidd they send one message and receive one message every time. However against ActiveMQ 5.11 the qpid-receive does not receive the message until one of several conditions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the qpid-receive command also includes &quot;--timeout 1&quot;&lt;/li&gt;
	&lt;li&gt;the qpid-receive command is repeated several, possibly dozens, of times.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;When qpidd broker is running or when activemq is running and --timeout is specified then the qpid-receive output is:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;chug@FJELD ~&amp;gt; qpid-receive -a chuck -m 1 --connection-options &quot;{protocol:amqp1.0}&quot; --print-headers yes
Properties: {sn:1, ts:1414177685195174548, x-amqp-first-acquirer:True}

0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, activemq running the client twice without the timeout and once with the timeout looks like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;chug@FJELD ~&amp;gt; qpid-receive -a chuck -m 1 --connection-options &quot;{protocol:amqp1.0}&quot; --print-headers yes
chug@FJELD ~&amp;gt; qpid-receive -a chuck -m 1 --connection-options &quot;{protocol:amqp1.0}&quot; --print-headers yes
chug@FJELD ~&amp;gt; qpid-receive -a chuck -m 1 --connection-options &quot;{protocol:amqp1.0}&quot; --print-headers yes --timeout 1
Redelivered: true
Properties: {sn:1, ts:1414178091185765136, x-amqp-delivery-count:1}

0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The false receive attempts make the message look like it was already delivered, hence the Redelivered: true, first-acquirer absent and the x-amqp-delivery-count setting.&lt;/p&gt;

&lt;p&gt;Views of the protocol interactions between the brokers and clients are here:&lt;br/&gt;
&lt;a href=&quot;http://people.apache.org/~chug/adverb_qpid_send_receive_1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://people.apache.org/~chug/adverb_qpid_send_receive_1/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I ran the tests twice on ActiveMQ with the tcpnodelay option turned on and off but that didn&apos;t seem to make any difference.&lt;/p&gt;</description>
                <environment>&lt;p&gt;broker: snapshot apache-activemq-5.11-20141022.222801-124-bin.tar.gz 	&lt;br/&gt;
  Wed Oct 22 22:28:02 UTC 2014&lt;br/&gt;
host: Linux Fedora 19 x64&lt;br/&gt;
clients: Apache Qpid C++ messaging qpid-send qpid-receive (current trunk)&lt;br/&gt;
protocol: AMQP 1.0&lt;/p&gt;</environment>
        <key id="12750445">AMQ-5413</key>
            <summary>AMQP test client delivery/redelivery anomoly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="chug">Charles E. Rolke</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 Oct 2014 20:15:12 +0000</created>
                <updated>Wed, 27 May 2015 15:32:06 +0000</updated>
                            <resolved>Wed, 27 May 2015 15:32:05 +0000</resolved>
                                    <version>5.11.0</version>
                                    <fixVersion>5.12.0</fixVersion>
                                    <component>AMQP</component>
                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14185786" author="chug" created="Mon, 27 Oct 2014 20:49:43 +0000"  >&lt;p&gt;I believe that the broker is mishandling the Flow performative &apos;drain&apos; flag. Referring to trace &lt;a href=&quot;http://people.apache.org/~chug/adverb_qpid_send_receive_1/qpid-send-receive_activemq-5.11_nodelay_1.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://people.apache.org/~chug/adverb_qpid_send_receive_1/qpid-send-receive_activemq-5.11_nodelay_1.html&lt;/a&gt; the following flow exchange happens:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&#9674;  &#9674;&#9674;  Frame 97  127.0.0.1:38598  -&amp;gt; 127.0.0.1:5672  10.422229 flow [0,0] (0,1000)   (drain=false)
&#9674;  &#9674;&#9674;  Frame 98  127.0.0.1:38598  -&amp;gt; 127.0.0.1:5672  10.422252 flow [0,0] (0,1000)   (drain=true)
&#9674;  &#9674;&#9674;  Frame 100  127.0.0.1:38598 &amp;lt;-  127.0.0.1:5672  10.423470 flow [0,0] (1000,0)
&#9674;  &#9674;&#9674;  Frame 101  127.0.0.1:38598  -&amp;gt; 127.0.0.1:5672  10.423595 flow [0,0] (1000,1000)
&#9674;  &#9674;&#9674;  Frame 102  127.0.0.1:38598 &amp;lt;-  127.0.0.1:5672  10.423810 flow [0,0] (2000,0)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The client sends two closely spaced flow messages to the broker. They are identical except that the drain flag is false in Frame 97 but true in Frame 98. The broker responds in Frame 100 by advancing the delivery count to 1000 to drain the available credit.  Frames 101 and 102 are a repeat of the flow-with-drain from the client followed by the broker effecting the drain with an advanced delivery count.&lt;/p&gt;

&lt;p&gt;The protocol error is that by AMQP 1.0 the sender receiving a flow with drain=true SHOULD send all available messages before advancing the delivery count to effect the drain.&lt;/p&gt;

&lt;p&gt;Just a guess here but the broker looks like it starts to form a delivery for the message it has in the queue but can&apos;t deliver it because the drain behavior kicked in. That&apos;s why when the client finally gets the message it is &apos;redelivered&apos;.&lt;/p&gt;

&lt;p&gt;Since the behavior is marked with SHOULD and not with MUST then the drain behavior is probably acceptable. However, if the drain bypasses available messages then a user might expect that the messages would finally be delivered with Redelivered=false. &lt;/p&gt;</comment>
                            <comment id="14393672" author="tabish121" created="Thu, 2 Apr 2015 23:00:24 +0000"  >&lt;p&gt;This is resolved with the addition of proper drain support.  &lt;/p&gt;</comment>
                            <comment id="14561143" author="tabish121" created="Wed, 27 May 2015 15:28:58 +0000"  >&lt;p&gt;Found an issue with the credit handling after drain completes.&lt;/p&gt;</comment>
                            <comment id="14561150" author="tabish121" created="Wed, 27 May 2015 15:32:05 +0000"  >&lt;p&gt;Additional fix and tests added&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12757501">AMQ-5453</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 25 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i21k6v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>