<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:17:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5605] High CPU load when using failover transport in network connector</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5605</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I&apos;ve got a configuration with two master/slave setups consisting of 3 ActiveMQ instances each. They are deployed on three servers, with one ActiveMQ instance from each master/slave setup on every server. They are using the leveldb and zookeeper. Everything works fine.&lt;/p&gt;

&lt;p&gt;Now I&apos;ve got the strange behaviour that when I add a network connector to each ActiveMQ instance like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;networkConnector name=&lt;span class=&quot;code-quote&quot;&gt;&quot;toMasterSlave02&quot;&lt;/span&gt; dynamicOnly=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt; uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;masterslave:(tcp:&lt;span class=&quot;code-comment&quot;&gt;//host1:61617,tcp://host2:61617,tcp://host3:61617)&quot;&lt;/span&gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When you now restart the master of the master/slave setup that is targeted by the above network connector the cpu load on the current master goes and stays up at 100%, i.e. it uses one CPU per configured transportConnector.&lt;/p&gt;

&lt;p&gt;Now the explanation, mostly copied from &lt;a href=&quot;http://activemq.2283324.n4.nabble.com/High-CPU-load-with-network-connector-failover-transport-tp4691798.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.2283324.n4.nabble.com/High-CPU-load-with-network-connector-failover-transport-tp4691798.html&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;When one of the brokers is restarted, the other broker uses ~400% CPU. The cause is the FailoverTransport reconnectTask spinning, and nothing is stopping the task.&lt;/p&gt;

&lt;p&gt;Reverting this fix made for &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5315&quot; title=&quot;NullPointerException in DemandForwardingBridgeSupport.collectBrokerInfos&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5315&quot;&gt;&lt;del&gt;AMQ-5315&lt;/del&gt;&lt;/a&gt;, while it does reintroduce the NullPointerException, does handle failover properly without spinning:&lt;br/&gt;
&lt;a href=&quot;https://git1-us-west.apache.org/repos/asf/activemq/repo?p=activemq.git;a=commitdiff;h=c391321d1b5b59542d847717654b0d4dba54cf2f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git1-us-west.apache.org/repos/asf/activemq/repo?p=activemq.git;a=commitdiff;h=c391321d1b5b59542d847717654b0d4dba54cf2f&lt;/a&gt; &amp;lt;&lt;a href=&quot;https://git1-us-west.apache.org/repos/asf/activemq/repo?p=activemq.git;a=commitdiff;h=c391321d1b5b59542d847717654b0d4dba54cf2f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git1-us-west.apache.org/repos/asf/activemq/repo?p=activemq.git;a=commitdiff;h=c391321d1b5b59542d847717654b0d4dba54cf2f&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;The reason it works after reverting that change is the NullPointerException is caught, -&amp;gt; serviceLocalException() -&amp;gt; ServiceSupport.dispose(getControllingService()); with the fix made in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5315&quot; title=&quot;NullPointerException in DemandForwardingBridgeSupport.collectBrokerInfos&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5315&quot;&gt;&lt;del&gt;AMQ-5315&lt;/del&gt;&lt;/a&gt;, the dispose() call is never made. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry, but I&apos;ve got no clue how to provide a unit test for this. Maybe someone else can help.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu 14.04, SuSE Enterprise 11.3&lt;/p&gt;</environment>
        <key id="12776495">AMQ-5605</key>
            <summary>High CPU load when using failover transport in network connector</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="larsn">Lars Neumann</reporter>
                        <labels>
                            <label>failover</label>
                    </labels>
                <created>Fri, 20 Feb 2015 17:33:05 +0000</created>
                <updated>Fri, 29 Apr 2016 11:12:35 +0000</updated>
                            <resolved>Wed, 12 Aug 2015 10:00:48 +0000</resolved>
                                    <version>5.11.0</version>
                    <version>5.11.1</version>
                                    <fixVersion>5.12.0</fixVersion>
                    <fixVersion>5.11.3</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14662020" author="gtully" created="Fri, 7 Aug 2015 16:01:08 +0000"  >&lt;p&gt;it looks like that fix needs to be reverted, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;  - what do u think?&lt;/p&gt;</comment>
                            <comment id="14662030" author="tabish121" created="Fri, 7 Aug 2015 16:07:39 +0000"  >&lt;p&gt;Seems like it probably should be.  &lt;/p&gt;</comment>
                            <comment id="14662273" author="tabish121" created="Fri, 7 Aug 2015 18:59:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; Looking at that code again I think it might make more sense to change the collectBrokerInfos calls for those null checks such that they call serviceLocationException instead which should result in both the fire of the error and the dispose call on the controlling resource which is the bit that is currently being missed.  Otherwise you end up with the NPE error getting fired out which causes confusion in the logs.  Thoughts?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/activemq-broker/src/main/java/org/apache/activemq/network/DemandForwardingBridgeSupport.java b/activemq-broker/src/main/java/org/apache/activemq/network/DemandForwardingBridgeSupport.java
index 8e08f95..ad6fd61 100644
--- a/activemq-broker/src/main/java/org/apache/activemq/network/DemandForwardingBridgeSupport.java
+++ b/activemq-broker/src/main/java/org/apache/activemq/network/DemandForwardingBridgeSupport.java
@@ -348,7 +348,7 @@
         &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
             remoteBrokerInfo = futureRemoteBrokerInfo.get();
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (remoteBrokerInfo == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
-                fireBridgeFailed(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Throwable(&lt;span class=&quot;code-quote&quot;&gt;&quot;remoteBrokerInfo is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;));
+                serviceLocalException(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Throwable(&lt;span class=&quot;code-quote&quot;&gt;&quot;remoteBrokerInfo is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;));
                 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
             }
         } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
@@ -359,7 +359,7 @@
         &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
             localBrokerInfo = futureLocalBrokerInfo.get();
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (localBrokerInfo == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
-                fireBridgeFailed(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Throwable(&lt;span class=&quot;code-quote&quot;&gt;&quot;localBrokerInfo is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;));
+                serviceLocalException(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Throwable(&lt;span class=&quot;code-quote&quot;&gt;&quot;localBrokerInfo is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;));
                 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
             }
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="14662373" author="jira-bot" created="Fri, 7 Aug 2015 20:22:21 +0000"  >&lt;p&gt;Commit a3c8bee1f0696b1d0d9a315b12241eecbf1f2d85 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=a3c8bee&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=a3c8bee&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5605&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Attempt to resolve high CPU usage after error by ensuring that the&lt;br/&gt;
transport is disposed along with the fire of the local error. &lt;/p&gt;</comment>
                            <comment id="14679689" author="larsn" created="Mon, 10 Aug 2015 07:17:20 +0000"  >&lt;p&gt;Thanks. I tested the commit with the current 5.11.x branch and it fixes the issue. &lt;/p&gt;

&lt;p&gt;Is there any possibility to get this issue and &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5082&quot; title=&quot;ActiveMQ replicatedLevelDB cluster breaks, all nodes stop listening&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5082&quot;&gt;&lt;del&gt;AMQ-5082&lt;/del&gt;&lt;/a&gt; in a 5.11.x release?&lt;/p&gt;</comment>
                            <comment id="14679937" author="gtully" created="Mon, 10 Aug 2015 10:53:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt; think that nails it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14680065" author="larsn" created="Mon, 10 Aug 2015 13:02:02 +0000"  >&lt;p&gt;Sweet. I will test the current 5.11.x branch without the patch from &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5082&quot; title=&quot;ActiveMQ replicatedLevelDB cluster breaks, all nodes stop listening&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5082&quot;&gt;&lt;del&gt;AMQ-5082&lt;/del&gt;&lt;/a&gt; and let you know. Might take a day or so.&lt;/p&gt;</comment>
                            <comment id="14693053" author="larsn" created="Wed, 12 Aug 2015 07:27:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;, thanks for your help. Applying the patch to the latest 5.11.x branch fixes the issue for me. &lt;/p&gt;

&lt;p&gt;Any chance of getting this in a release, either 5.11.x or 5.12.x?&lt;/p&gt;</comment>
                            <comment id="14693247" author="tabish121" created="Wed, 12 Aug 2015 10:00:48 +0000"  >&lt;p&gt;Fix included in 5.12.0 code.  &lt;/p&gt;</comment>
                            <comment id="14978441" author="jira-bot" created="Wed, 28 Oct 2015 13:43:43 +0000"  >&lt;p&gt;Commit 756fa656b37df24bfe41679f8db238c021fe5f8b in activemq&apos;s branch refs/heads/activemq-5.11.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=756fa65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=756fa65&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5605&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Attempt to resolve high CPU usage after error by ensuring that the&lt;br/&gt;
transport is disposed along with the fire of the local error. &lt;/p&gt;</comment>
                            <comment id="15263740" author="ruffp" created="Fri, 29 Apr 2016 08:34:31 +0000"  >&lt;p&gt;Does this bug affect the version 5.10.2 of ActiveMQ? Because we have a similar problem with 100% CPU usage and nothing special in logs.&lt;br/&gt;
Our ActiveMQ was working fine until we introduce the Network Connector with &lt;tt&gt;masterslave:(tcp://host1, tcp://host2)&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15263909" author="christopher.l.shannon" created="Fri, 29 Apr 2016 11:12:35 +0000"  >&lt;p&gt;I believe it was introduced in 5.10.1 so the same issue probably exists in 5.10.2 as well since it wasn&apos;t fixed until 5.11.3 and 5.12.0.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 29 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i25v67:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>