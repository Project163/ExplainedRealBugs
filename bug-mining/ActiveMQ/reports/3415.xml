<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:51:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-8617] RedeliveryPolicy:Exponential Backoff + NonBlockingRedelivery = too long delays</title>
                <link>https://issues.apache.org/jira/browse/AMQ-8617</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Scenario on client:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Employing RedeliveryPolicy with exponential backoff (keeping maximum redeliveries at default 6)&lt;/li&gt;
	&lt;li&gt;Enabled non-blocking redelivery&lt;/li&gt;
	&lt;li&gt;Receiving e.g. 100 consecutive poison messages which are rolled back repeatedly (which eventually should DLQ after max redeliveries)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This will result in massive redelivery delays due to a logic bug.&lt;/p&gt;

&lt;p&gt;The reason is that redeliveryDelay is a field variable kept on the ActiveMQMessageConsumer, instead of being a property on the message - or that the redelivery delay was calculated per message based on the redelivery count.&lt;/p&gt;

&lt;p&gt;When consecutive messages rollbacks multiple times, the redeliveryDelay field is continuously multiplied by the backoff multiplier, resulting in enormous delays.&lt;/p&gt;

&lt;p&gt;Pull Request for fix, including test: &lt;a href=&quot;https://github.com/apache/activemq/pull/843&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/843&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13447584">AMQ-8617</key>
            <summary>RedeliveryPolicy:Exponential Backoff + NonBlockingRedelivery = too long delays</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbonofre">Jean-Baptiste Onofr&#233;</assignee>
                                    <reporter username="stolsvik">Endre St&#248;lsvik</reporter>
                        <labels>
                    </labels>
                <created>Mon, 30 May 2022 23:46:58 +0000</created>
                <updated>Tue, 22 Nov 2022 07:56:30 +0000</updated>
                            <resolved>Tue, 22 Nov 2022 07:56:30 +0000</resolved>
                                                    <fixVersion>5.18.0</fixVersion>
                    <fixVersion>5.17.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17637059" author="jira-bot" created="Tue, 22 Nov 2022 07:55:52 +0000"  >&lt;p&gt;Commit 393a696955cbf97b90576e4a85b3ce1a02268ad7 in activemq&apos;s branch refs/heads/main from Endre St&#248;lsvik&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=393a69695&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=393a69695&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-8617&quot; title=&quot;RedeliveryPolicy:Exponential Backoff + NonBlockingRedelivery = too long delays&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-8617&quot;&gt;&lt;del&gt;AMQ-8617&lt;/del&gt;&lt;/a&gt;: RedeliveryPolicy:Exponential Backoff + NonBlockingRedelivery = too long delays&lt;/p&gt;

&lt;p&gt;Scenario on client:&lt;/p&gt;

&lt;p&gt;1. Employing RedeliveryPolicy with exponential backoff (keeping maximum&lt;br/&gt;
redeliveries at default 6)&lt;br/&gt;
2. Enabled non-blocking redelivery&lt;br/&gt;
3. Receiving e.g. 100 consecutive poison messages (which eventually&lt;br/&gt;
should DLQ after max redeliveries)&lt;/p&gt;

&lt;p&gt;This will result in massive redelivery delays due to a logic bug.&lt;/p&gt;

&lt;p&gt;The reason is that redeliveryDelay is a field variable kept on the&lt;br/&gt;
ActiveMQMessageConsumer, instead of being a property on the message - or&lt;br/&gt;
that the redelivery delay was calculated per message based on the&lt;br/&gt;
redelivery count.&lt;/p&gt;

&lt;p&gt;When consecutive messages rollbacks multiple times, the redeliveryDelay&lt;br/&gt;
field is continuously multiplied by the backoff multiplier, resulting in&lt;br/&gt;
enormous delays.&lt;/p&gt;

&lt;p&gt;Fix: Ditch the field variable, instead calculating the redeliveryDelay&lt;br/&gt;
per delivery from the redelivery count. (This happens to be identical to&lt;br/&gt;
how it is done in afterRollback() in ActiveMQSession:1004.)&lt;/p&gt;

&lt;p&gt;Test is added - which fails with the previous code, and passes with&lt;br/&gt;
this. Added a debug log line for the calculated delay.&lt;/p&gt;</comment>
                            <comment id="17637060" author="jira-bot" created="Tue, 22 Nov 2022 07:55:53 +0000"  >&lt;p&gt;Commit 9852cf1f4954d0c417b618f2c1a007dbfd0363bb in activemq&apos;s branch refs/heads/main from Jean-Baptiste Onofr&#233;&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=9852cf1f4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=9852cf1f4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #843 from stolsvik/main&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-8617&quot; title=&quot;RedeliveryPolicy:Exponential Backoff + NonBlockingRedelivery = too long delays&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-8617&quot;&gt;&lt;del&gt;AMQ-8617&lt;/del&gt;&lt;/a&gt;: RedeliveryPolicy:Exponential Backoff + NonBlockingRedelivery = too long delays&lt;/p&gt;</comment>
                            <comment id="17637061" author="jira-bot" created="Tue, 22 Nov 2022 07:56:21 +0000"  >&lt;p&gt;Commit 2de859f758ac0e9968211248200953a3cbed6f5e in activemq&apos;s branch refs/heads/activemq-5.17.x from Endre St&#248;lsvik&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=2de859f75&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=2de859f75&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-8617&quot; title=&quot;RedeliveryPolicy:Exponential Backoff + NonBlockingRedelivery = too long delays&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-8617&quot;&gt;&lt;del&gt;AMQ-8617&lt;/del&gt;&lt;/a&gt;: RedeliveryPolicy:Exponential Backoff + NonBlockingRedelivery = too long delays&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 393a696955cbf97b90576e4a85b3ce1a02268ad7)&lt;/p&gt;

&lt;p&gt;Scenario on client:&lt;/p&gt;

&lt;p&gt;1. Employing RedeliveryPolicy with exponential backoff (keeping maximum&lt;br/&gt;
redeliveries at default 6)&lt;br/&gt;
2. Enabled non-blocking redelivery&lt;br/&gt;
3. Receiving e.g. 100 consecutive poison messages (which eventually&lt;br/&gt;
should DLQ after max redeliveries)&lt;/p&gt;

&lt;p&gt;This will result in massive redelivery delays due to a logic bug.&lt;/p&gt;

&lt;p&gt;The reason is that redeliveryDelay is a field variable kept on the&lt;br/&gt;
ActiveMQMessageConsumer, instead of being a property on the message - or&lt;br/&gt;
that the redelivery delay was calculated per message based on the&lt;br/&gt;
redelivery count.&lt;/p&gt;

&lt;p&gt;When consecutive messages rollbacks multiple times, the redeliveryDelay&lt;br/&gt;
field is continuously multiplied by the backoff multiplier, resulting in&lt;br/&gt;
enormous delays.&lt;/p&gt;

&lt;p&gt;Fix: Ditch the field variable, instead calculating the redeliveryDelay&lt;br/&gt;
per delivery from the redelivery count. (This happens to be identical to&lt;br/&gt;
how it is done in afterRollback() in ActiveMQSession:1004.)&lt;/p&gt;

&lt;p&gt;Test is added - which fails with the previous code, and passes with&lt;br/&gt;
this. Added a debug log line for the calculated delay.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 51 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z12t7k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>