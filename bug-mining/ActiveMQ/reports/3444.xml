<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:54:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-9254] KahaDB minor fix when db files may be larger than max length</title>
                <link>https://issues.apache.org/jira/browse/AMQ-9254</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Log message:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.io.IOException: Invalid location size: 54:33554460, size: 2412
        at org.apache.activemq.store.kahadb.disk.journal.DataFileAccessor.readRecord(DataFileAccessor.java:88) ~[?:?]
        at org.apache.activemq.store.kahadb.disk.journal.Journal.read(Journal.java:953) ~[?:?]
        at org.apache.activemq.store.kahadb.MessageDatabase.load(MessageDatabase.java:1197) ~[?:?]
        at org.apache.activemq.store.kahadb.KahaDBStore.loadMessage(KahaDBStore.java:1401) ~[?:?]
        ... 74 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;db-54.log size: 33556877&lt;/p&gt;

&lt;p&gt;Note: This read would have succeeded otherwise.&lt;/p&gt;

&lt;p&gt;Reproducible test case:&lt;br/&gt;
ref: &lt;a href=&quot;https://github.com/mattrpav/activemq-jira-9254&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mattrpav/activemq-jira-9254&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13534602">AMQ-9254</key>
            <summary>KahaDB minor fix when db files may be larger than max length</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mattrpav">Matt Pavlovich</assignee>
                                    <reporter username="mattrpav">Matt Pavlovich</reporter>
                        <labels>
                    </labels>
                <created>Mon, 1 May 2023 15:33:01 +0000</created>
                <updated>Thu, 29 Jun 2023 22:54:10 +0000</updated>
                            <resolved>Wed, 3 May 2023 10:08:51 +0000</resolved>
                                                    <fixVersion>6.0.0</fixVersion>
                    <fixVersion>5.17.5</fixVersion>
                    <fixVersion>5.18.2</fixVersion>
                                    <component>KahaDB</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17718294" author="mattrpav" created="Mon, 1 May 2023 17:22:48 +0000"  >&lt;p&gt;Considaration to convert this to a log.WARN and attempt to continue&lt;/p&gt;

&lt;p&gt;ref: &lt;a href=&quot;https://github.com/apache/activemq/blob/activemq-5.17.4/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/disk/journal/DataFileAccessor.java#L88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/activemq-5.17.4/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/disk/journal/DataFileAccessor.java#L88&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;            if ((long)location.getOffset() + location.getSize() &amp;gt; dataFile.length) {
                throw new IOException(&quot;Invalid location size: &quot; + location + &quot;, size: &quot; + location.getSize());
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</comment>
                            <comment id="17718370" author="christopher.l.shannon" created="Mon, 1 May 2023 23:13:48 +0000"  >&lt;p&gt;I haven&apos;t had a chance to look at the test case yet but I assume that the file is larger than the max size due to a message being published that is larger than the max file size? It&apos;s been a little while since I have been in the KahaDB journal code but I think the only time the journal file should be larger would be a big message. If that isn&apos;t the case here then we&apos;d need to figure out why the file is too big.&lt;/p&gt;</comment>
                            <comment id="17718372" author="christopher.l.shannon" created="Mon, 1 May 2023 23:23:42 +0000"  >&lt;p&gt;So to be clear, the issue is the actual file is larger than dataFile.length?&lt;/p&gt;

&lt;p&gt;That seems to be a bit of a problem if the file is larger than what is reported so I wonder if we should be smarter here. I need to look how that value is set but I am guessing the length is coming from max length setting or some sort of offset by the read messages etc Trying to read past the real max length is an actual problem and I don&apos;t think we should be swallowing that error just because in this one case it would succeed. In other cases it could be corruption.&lt;/p&gt;

&lt;p&gt;I&apos;m wondering if we should do something where we check the real file length as an extra check before failing. If we are truly exceeding the real file length we need to throw an exception and shut down.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17718374" author="christopher.l.shannon" created="Mon, 1 May 2023 23:34:51 +0000"  >&lt;p&gt;Ok so the size is actually incremented for each message so it can be longer then max journal size and that is normal. It seems there&apos;s probably a bit of a math issue here (that&apos;s the real bug) when writing to the file and it&apos;s a bit off. Maybe rounding or something else. Ultimately finding that bug is the real solution but as a sanity check in the mean time we could handle it better.&lt;/p&gt;

&lt;p&gt;I think we should do something like the following:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Keep things as they currently are for computing the dataFile.length as it seems to be computing it by offsets and incrementing for each message/write so it&apos;s fast and avoids an expensive lookup to the file system&lt;/li&gt;
	&lt;li&gt;If we encounter this edge case error we look up the real length of the file on the file system and re-check. If the real size is longer and the read is fine then we just log an info statement or something otherwise continue with the IO exception.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;We shouldn&apos;t need to cache the value if it&apos;s only on error which would be rare and also the file size can change until it rolls over to the next file.&lt;/p&gt;

&lt;p&gt;Ultimately there&apos;s probably an issue here with the counter.&lt;/p&gt;</comment>
                            <comment id="17718378" author="mattrpav" created="Mon, 1 May 2023 23:50:10 +0000"  >&lt;p&gt;I&apos;ll work up a PR. In the one-off case of a db-foo.log file being too large, inside the if.. check size.. .. we can do the OS file size check (fstat() penalty).. but this would &lt;em&gt;only&lt;/em&gt; be for reads outside the expected max journal length, so the read penalty would be very limited, and we wouldn&apos;t need to cache the size (which could be wrong if the file changes size).&lt;/p&gt;</comment>
                            <comment id="17718872" author="jira-bot" created="Wed, 3 May 2023 10:04:47 +0000"  >&lt;p&gt;Commit bcc74f93fe6dbbd5c795c35484db8efa29b254b6 in activemq&apos;s branch refs/heads/main from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=bcc74f93fe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=bcc74f93fe&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9254&quot; title=&quot;KahaDB minor fix when db files may be larger than max length&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9254&quot;&gt;&lt;del&gt;AMQ-9254&lt;/del&gt;&lt;/a&gt; - Rework data file size validation and add unit test&lt;/p&gt;

&lt;p&gt;This isolates the validation on data file length on read and adds unit&lt;br/&gt;
tests to verify we properly fallback to the real file length on initial&lt;br/&gt;
size check failure&lt;/p&gt;</comment>
                            <comment id="17718873" author="jira-bot" created="Wed, 3 May 2023 10:04:47 +0000"  >&lt;p&gt;Commit b8b5dedb781677970c227d1cc972397cb994b901 in activemq&apos;s branch refs/heads/main from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=b8b5dedb78&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=b8b5dedb78&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #1004 from mattrpav/&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9254&quot; title=&quot;KahaDB minor fix when db files may be larger than max length&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9254&quot;&gt;&lt;del&gt;AMQ-9254&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9254&quot; title=&quot;KahaDB minor fix when db files may be larger than max length&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9254&quot;&gt;&lt;del&gt;AMQ-9254&lt;/del&gt;&lt;/a&gt; DataFile readRecord fallback to OS file.length in rare edge case&lt;/p&gt;

&lt;p&gt;Rework validation that the record read won&apos;t exceed the length of the file&lt;/p&gt;</comment>
                            <comment id="17718875" author="jira-bot" created="Wed, 3 May 2023 10:07:47 +0000"  >&lt;p&gt;Commit 78a399cb8714c6b7cd0bbcaa6be21fa217399033 in activemq&apos;s branch refs/heads/activemq-5.18.x from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=78a399cb87&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=78a399cb87&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9254&quot; title=&quot;KahaDB minor fix when db files may be larger than max length&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9254&quot;&gt;&lt;del&gt;AMQ-9254&lt;/del&gt;&lt;/a&gt; - Rework data file size validation and add unit test&lt;/p&gt;

&lt;p&gt;This isolates the validation on data file length on read and adds unit&lt;br/&gt;
tests to verify we properly fallback to the real file length on initial&lt;br/&gt;
size check failure&lt;/p&gt;

&lt;p&gt;(cherry picked from commit bcc74f93fe6dbbd5c795c35484db8efa29b254b6)&lt;/p&gt;</comment>
                            <comment id="17718876" author="jira-bot" created="Wed, 3 May 2023 10:08:29 +0000"  >&lt;p&gt;Commit 6a64a0817e93991515eb89ee09ddc468452bd1c3 in activemq&apos;s branch refs/heads/activemq-5.17.x from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=6a64a0817e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=6a64a0817e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9254&quot; title=&quot;KahaDB minor fix when db files may be larger than max length&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9254&quot;&gt;&lt;del&gt;AMQ-9254&lt;/del&gt;&lt;/a&gt; - Rework data file size validation and add unit test&lt;/p&gt;

&lt;p&gt;This isolates the validation on data file length on read and adds unit&lt;br/&gt;
tests to verify we properly fallback to the real file length on initial&lt;br/&gt;
size check failure&lt;/p&gt;

&lt;p&gt;(cherry picked from commit bcc74f93fe6dbbd5c795c35484db8efa29b254b6)&lt;/p&gt;</comment>
                            <comment id="17723961" author="jira-bot" created="Thu, 18 May 2023 16:29:09 +0000"  >&lt;p&gt;Commit cfbea60d6d4f934e7fbe85915183a2f211414b82 in activemq&apos;s branch refs/heads/main from Matt Pavlovich&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=cfbea60d6d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=cfbea60d6d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9258&quot; title=&quot;Fix flaky kahadb test that can fail on busy CI server&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9258&quot;&gt;AMQ-9258&lt;/a&gt; Update kahadb corruption test to account for new fix from &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9254&quot; title=&quot;KahaDB minor fix when db files may be larger than max length&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9254&quot;&gt;&lt;del&gt;AMQ-9254&lt;/del&gt;&lt;/a&gt; (#1007)&lt;/p&gt;
</comment>
                            <comment id="17738815" author="jira-bot" created="Thu, 29 Jun 2023 22:50:11 +0000"  >&lt;p&gt;Commit fa72c13612e816603b42245de54b4d4dc8fc3dcd in activemq&apos;s branch refs/heads/activemq-5.18.x from Matt Pavlovich&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=fa72c13612&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=fa72c13612&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9258&quot; title=&quot;Fix flaky kahadb test that can fail on busy CI server&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9258&quot;&gt;AMQ-9258&lt;/a&gt; Update kahadb corruption test to account for new fix from &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9254&quot; title=&quot;KahaDB minor fix when db files may be larger than max length&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9254&quot;&gt;&lt;del&gt;AMQ-9254&lt;/del&gt;&lt;/a&gt; (#1007)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit cfbea60d6d4f934e7fbe85915183a2f211414b82)&lt;/p&gt;</comment>
                            <comment id="17738818" author="jira-bot" created="Thu, 29 Jun 2023 22:54:10 +0000"  >&lt;p&gt;Commit 697feeccb0a14caa464e09adcde43fd58b30bc55 in activemq&apos;s branch refs/heads/activemq-5.17.x from Matt Pavlovich&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=697feeccb0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=697feeccb0&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9258&quot; title=&quot;Fix flaky kahadb test that can fail on busy CI server&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9258&quot;&gt;AMQ-9258&lt;/a&gt; Update kahadb corruption test to account for new fix from &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9254&quot; title=&quot;KahaDB minor fix when db files may be larger than max length&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9254&quot;&gt;&lt;del&gt;AMQ-9254&lt;/del&gt;&lt;/a&gt; (#1007)&lt;/p&gt;

&lt;p&gt;(cherry picked from commit cfbea60d6d4f934e7fbe85915183a2f211414b82)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13103273">AMQ-6815</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1hmgo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>