<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:23:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6010] AMQP SSL Transport &quot;leaking&quot; currentTransportCounts</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6010</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;When using the AMQP SSL transport the currentTransportCount (variable that tracks connection count in TcpTransportServer.java) can &quot;leak&quot; when the SSL connection is aborted during handshake. In this case the TcpTransportServer class the currentTransportCount is incremented in handleSocket but never decremented in stopped. This eventually leads to ExceededMaximumConnectionsException being thrown from handleSocket. The SSL connection is aborted during handshake if needClientAuth is configured on the transport and a client with an invalid certificate tries to connect.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Reproduction&lt;/b&gt;&lt;br/&gt;
1. Enable the AMQP SSL transport: &lt;tt&gt;&amp;lt;transportConnector name=&quot;amqp+ssl&quot; uri=&quot;amqp+ssl://0.0.0.0:5671?needClientAuth=true&amp;amp;maximumConnections=10&quot;/&amp;gt;&lt;/tt&gt;&lt;br/&gt;
2. Try to connect with no/invalid client certificate: &lt;tt&gt;openssl s_client -connect localhost:5671&lt;/tt&gt;&lt;br/&gt;
3. After 10 attempts ActiveMQ logs will start showing ExceededMaximumConnectionsException exceptions.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Bug&lt;/b&gt;&lt;br/&gt;
During the SSL handshake phase the protocol converter in the AMQP transport is set to the AMQPProtocolDiscriminator which silently swallows exceptions:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onAMQPException(IOException error) {
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Which in turn cause the normal stop sequence (via asyncStop) to be skipped.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Fix&lt;/b&gt;&lt;br/&gt;
Change the AMQPProtocolDiscriminator to handle the error instead of swallow it:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onAMQPException(IOException error) {
    transport.sendToActiveMQ(error);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12904662">AMQ-6010</key>
            <summary>AMQP SSL Transport &quot;leaking&quot; currentTransportCounts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="mmeulemans">Marcel Meulemans</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Oct 2015 20:43:42 +0000</created>
                <updated>Wed, 14 Oct 2015 15:43:30 +0000</updated>
                            <resolved>Wed, 14 Oct 2015 15:43:30 +0000</resolved>
                                    <version>5.11.1</version>
                    <version>5.12.0</version>
                                    <fixVersion>5.13.0</fixVersion>
                    <fixVersion>5.12.2</fixVersion>
                                    <component>AMQP</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14955660" author="tabish121" created="Tue, 13 Oct 2015 20:56:01 +0000"  >&lt;p&gt;You should take a shot at creating a unit test to reproduce and supply a patch to fix if you feel so inclined.  &lt;/p&gt;</comment>
                            <comment id="14957103" author="jira-bot" created="Wed, 14 Oct 2015 15:40:55 +0000"  >&lt;p&gt;Commit 95a9a8035145bea04126e924a38ba133a2d6f7e4 in activemq&apos;s branch refs/heads/activemq-5.12.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=95a9a80&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=95a9a80&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6010&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6010&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fix for failed SSL connections not releasing the connection count in the&lt;br/&gt;
transport which leads to connections being rejected as having eceeded&lt;br/&gt;
the maximum configured connections.&lt;br/&gt;
(cherry picked from commit 80b526be7df3471876eceaa2c610747ca7fb89da)&lt;/p&gt;</comment>
                            <comment id="14957104" author="jira-bot" created="Wed, 14 Oct 2015 15:40:56 +0000"  >&lt;p&gt;Commit 80b526be7df3471876eceaa2c610747ca7fb89da in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=80b526b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=80b526b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6010&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6010&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fix for failed SSL connections not releasing the connection count in the&lt;br/&gt;
transport which leads to connections being rejected as having eceeded&lt;br/&gt;
the maximum configured connections.&lt;/p&gt;</comment>
                            <comment id="14957111" author="tabish121" created="Wed, 14 Oct 2015 15:43:30 +0000"  >&lt;p&gt;Created a test case to reproduce and applied the suggested fix.  All working now.  &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 5 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2myxj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>