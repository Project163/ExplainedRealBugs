<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:09:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5711] [AMQP] Consumer on named temporary queue results in NullPointerException</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5711</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Attempting to create a consumer on a named temporary queue (&quot;temp-queue://&amp;lt;name&amp;gt;&quot;) via AMQP results in a NullPointerException. Following minimal test client using the Qpid AMQP client (qpid-amqp-1-0-client-jms) demonstrates the problem (imports elided for brevity):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MinimalAmqpTest {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (InputStream propertiesStream =
                MinimalAmqpTest.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getResourceAsStream(&lt;span class=&quot;code-quote&quot;&gt;&quot;amqp.properties&quot;&lt;/span&gt;)) {
            Properties properties = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Properties();
            properties.load(propertiesStream);
            Context context = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InitialContext(properties);
            ConnectionFactory connectionFactory =
                (ConnectionFactory) context.lookup(&lt;span class=&quot;code-quote&quot;&gt;&quot;localhost&quot;&lt;/span&gt;);
            Connection connection = connectionFactory.createConnection();            
            connection.start();
 
            Queue queue = (Queue) context.lookup(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;);
            Session consumerSession =
                connection.createSession(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, Session.AUTO_ACKNOWLEDGE);
            consumerSession.createConsumer(queue);
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Where amqp.properties looks something like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.naming.factory.initial = org.apache.qpid.amqp_1_0.jms.jndi.PropertiesFileInitialContextFactory
connectionfactory.localhost = amqp://172.16.133.147:5672?clientid=test-client
queue.test = temp-queue://test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Running this test against an AMQP-enabled ActiveMQ 5.11.1, 5.10.2 or 5.10.1 broker results in an NPE:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.NullPointerException
        at org.apache.activemq.broker.region.TempQueue.addSubscription(TempQueue.java:72)
        at org.apache.activemq.broker.region.AbstractRegion.addConsumer(AbstractRegion.java:319)
        at org.apache.activemq.broker.region.RegionBroker.addConsumer(RegionBroker.java:427)
        at org.apache.activemq.broker.BrokerFilter.addConsumer(BrokerFilter.java:102)
        at org.apache.activemq.broker.BrokerFilter.addConsumer(BrokerFilter.java:102)
        at org.apache.activemq.broker.BrokerFilter.addConsumer(BrokerFilter.java:102)
        at org.apache.activemq.broker.BrokerFilter.addConsumer(BrokerFilter.java:102)
        at org.apache.activemq.broker.MutableBrokerFilter.addConsumer(MutableBrokerFilter.java:107)
        at org.apache.activemq.broker.TransportConnection.processAddConsumer(TransportConnection.java:663)
        at org.apache.activemq.command.ConsumerInfo.visit(ConsumerInfo.java:348)
        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:334)
        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:188)
        at org.apache.activemq.transport.amqp.AmqpTransportFilter.sendToActiveMQ(AmqpTransportFilter.java:114)
        at org.apache.activemq.transport.amqp.AmqpProtocolConverter.sendToActiveMQ(AmqpProtocolConverter.java:1497)
        at org.apache.activemq.transport.amqp.AmqpProtocolConverter.onSenderOpen(AmqpProtocolConverter.java:1421)
        at org.apache.activemq.transport.amqp.AmqpProtocolConverter.onLinkOpen(AmqpProtocolConverter.java:577)
        at org.apache.activemq.transport.amqp.AmqpProtocolConverter.processLinkEvent(AmqpProtocolConverter.java:389)
        at org.apache.activemq.transport.amqp.AmqpProtocolConverter.onFrame(AmqpProtocolConverter.java:334)
        at org.apache.activemq.transport.amqp.AmqpProtocolConverter.onAMQPData(AmqpProtocolConverter.java:275)
        at org.apache.activemq.transport.amqp.AmqpTransportFilter.onCommand(AmqpTransportFilter.java:98)
        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)
        at org.apache.activemq.transport.amqp.AmqpFrameParser$1.onFrame(AmqpFrameParser.java:57)
        at org.apache.activemq.transport.amqp.AmqpFrameParser$5.parse(AmqpFrameParser.java:205)
        at org.apache.activemq.transport.amqp.AmqpFrameParser$4.parse(AmqpFrameParser.java:178)
        at org.apache.activemq.transport.amqp.AmqpFrameParser.parse(AmqpFrameParser.java:73)
        at org.apache.activemq.transport.amqp.AmqpNioTransport.serviceRead(AmqpNioTransport.java:118)
        at org.apache.activemq.transport.amqp.AmqpNioTransport.access$000(AmqpNioTransport.java:44)
        at org.apache.activemq.transport.amqp.AmqpNioTransport$1.onSelect(AmqpNioTransport.java:75)
        at org.apache.activemq.transport.nio.SelectorSelection.onSelect(SelectorSelection.java:97)
        at org.apache.activemq.transport.nio.SelectorWorker$1.run(SelectorWorker.java:119)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The reason for the NPE is that in the following excerpt from TempQueue.java, tempDest.getConnectionId() returns null:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!context.isFaultTolerant()
                &amp;amp;&amp;amp; (!context.isNetworkConnection() &amp;amp;&amp;amp; !tempDest
                        .getConnectionId().equals(
                                sub.getConsumerInfo().getConsumerId()
                                        .getConnectionId()))) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The ActiveMQTempDestination tempDest is created by ActiveMQDestination.createDestination(String, byte):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ActiveMQTempQueue(ActiveMQTempDestination).&amp;lt;init&amp;gt;(String) line: 39	
ActiveMQTempQueue.&amp;lt;init&amp;gt;(String) line: 36	
ActiveMQDestination.createDestination(String, byte) line: 95	
AmqpProtocolConverter.createDestination(Object) line: 951	
AmqpProtocolConverter.onSenderOpen(Sender, AmqpProtocolConverter$AmqpSessionContext) line: 1375	
AmqpProtocolConverter.onLinkOpen(Link) line: 577	
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The created object is returned through the call stack as-is until it reaches the onSenderOpen frame, where it is assigned to the ConsumerInfo. The connection ID is never set.&lt;/p&gt;

&lt;p&gt;Proposed fix: in DestinationFactoryImpl.createDestination(ConnectionContext, ActiveMQDestination, DestinationStatistics), after casting destination to ActiveMQTempDestination and before instantiating TempQueue, the connection ID (and any other required information) could be set from the ConnectionContext.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12818966">AMQ-5711</key>
            <summary>[AMQP] Consumer on named temporary queue results in NullPointerException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="dake">Daniel Keyhani</reporter>
                        <labels>
                            <label>easyfix</label>
                    </labels>
                <created>Tue, 7 Apr 2015 15:22:24 +0000</created>
                <updated>Tue, 21 Apr 2015 21:47:17 +0000</updated>
                            <resolved>Tue, 21 Apr 2015 21:47:17 +0000</resolved>
                                    <version>5.10.1</version>
                    <version>5.10.2</version>
                    <version>5.11.1</version>
                                    <fixVersion>5.12.0</fixVersion>
                                    <component>AMQP</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14483412" author="tabish121" created="Tue, 7 Apr 2015 16:02:51 +0000"  >&lt;p&gt;So the NPE is not great here but what you are trying to do is also not really expected to work.  Temporary destinations are created from an open connection using createTempQueue or createTempTopic and then used by that connection (and only that connection) to consume from, other connections can produce to it if the destination is set as a reply to on a message.  Defining the temporary destination in your JNDI config make the assumption that the broker will just happily create one for you if it does not exist which is not really true over AMQP as there are properties of the incoming link creation that control if a temporary topic is created.  The fix that would really make sense here is better detect this sort of thing and close the link with an error.  &lt;/p&gt;</comment>
                            <comment id="14505840" author="tabish121" created="Tue, 21 Apr 2015 21:47:17 +0000"  >&lt;p&gt;Updated the AMQP handling code to reject links that are created using named temp destinations that didn&apos;t originate from a dynamic link.  &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 31 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2cwy7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>