<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:44:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2659] JMSException incorrectly thrown when using XAConnection/XASession outside a transaction</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2659</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Currently, if one attempts to use an XAConnection (implemented by ActiveMQXAConnection) and consequently an XASession (implemented by ActiveMQXASession) outside a transaction, a JMSException is thrown.  However, nowhere in the JMS Spec does it say that if an XAConnection/XASession is used, it &lt;em&gt;&lt;b&gt;must&lt;/b&gt;&lt;/em&gt; be enlisted in a transaction.  It is perfectly legal to &lt;em&gt;&lt;b&gt;not&lt;/b&gt;&lt;/em&gt; start a transaction but still use the XA objects.&lt;/p&gt;

&lt;p&gt;I propose that the following 2 methods in ActiveMQXASession be changed as follows to resolve this bug:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    public boolean getTransacted() throws JMSException {
        return getTransactionContext().isInXATransaction();
    }

    /**
     * This is called before transacted work is done by the session.
     * XA transactions are controlled outside of the session so
     * nothing has to be done here.  The only reason for this method
     * to be here is to override the parent.
     */
    protected void doStartTransaction() {
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
The current version of these methods is as follows (for reference):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    public boolean getTransacted() throws JMSException {
        return true;
    }

    /**
     * This is called before transacted work is done by
     * the session.  XA Work can only be done when this
     * XA resource is associated with an Xid.
     *
     * @throws JMSException not associated with an Xid
     */
    protected void doStartTransaction() throws JMSException {

        if (!getTransactionContext().isInXATransaction()) {
            throw new JMSException(&quot;Session&apos;s XAResource has not been enlisted in a distributed transaction.&quot;);
        }

    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12482499">AMQ-2659</key>
            <summary>JMSException incorrectly thrown when using XAConnection/XASession outside a transaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="rodos77">Eugene Rodos</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Mar 2010 16:31:21 +0000</created>
                <updated>Tue, 3 Aug 2021 07:23:19 +0000</updated>
                            <resolved>Wed, 13 Jun 2018 10:53:17 +0000</resolved>
                                    <version>5.3.0</version>
                                    <fixVersion>5.4.0</fixVersion>
                    <fixVersion>5.16.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="12942474" author="gtully" created="Tue, 20 Apr 2010 16:24:15 +0000"  >&lt;p&gt;what is your use case here? it is normal for an xa connection to be used with an xa transaction, that is what xa_rdonly is about. Not sure why the check was added in the first place but it has been around for quite a while and is a good indication of intent, as in, it helps determine whether an XA connection factory is being used as desired when it is configured with a transaction manager. I am slow to drop it without out good reason.&lt;/p&gt;</comment>
                            <comment id="12942462" author="rodos77" created="Tue, 20 Apr 2010 16:56:24 +0000"  >&lt;p&gt;The use case is that when the JMS client calls createConnection on the connection factory handle, an XA tx may have been started or may not have been.  The RA has no way of knowing this.  Therefore, we configure the RA to always use XAConnectionFactory.  This way, if a tx was started, the XA capabilities of the connection will be used, and if not, they won&apos;t, but it should work in either case.&lt;/p&gt;

&lt;p&gt;Without this change, I get an Exception when trying to use the AMQXAConnFactory/AMQXAConn when a tx has not been started.  I&apos;ve had to make this change to make our RA work with AMQ.  Other JMS engines (such as JBoss) don&apos;t have this restriction.  Nor do the JMS and JCA specify anywhere that if XA objects are used, a tx MUST be started.&lt;/p&gt;</comment>
                            <comment id="12942526" author="rodos77" created="Mon, 26 Apr 2010 14:12:27 +0000"  >&lt;p&gt;So what&apos;s the verdict?  Can we get this change into 5.4.0 so I can use AMQ with our RA and not have to patch the source on my end?&lt;/p&gt;</comment>
                            <comment id="12942522" author="gtully" created="Mon, 26 Apr 2010 15:18:10 +0000"  >&lt;p&gt;to speed up the process, it would help if there were a few unit tests that demonstrated the required behavior and don&apos;t break anything else. I think message receipt will be problematic as an XASession is always transacted w.r.t acks and without a transaction there will be no ack.&lt;/p&gt;

&lt;p&gt;btw: I think the change to getTransacted() will help with &lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-2712&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-2712&lt;/a&gt; which is good.&lt;/p&gt;</comment>
                            <comment id="12942541" author="rodos77" created="Tue, 27 Apr 2010 17:36:53 +0000"  >&lt;p&gt;Isn&apos;t an ack sent at the end of ActiveMQSession.run() irrespective of whether there is a tx in progress or not?  line 885 in 5.3.1: asyncSendPacket(ack).  In fact, ActiveMQXASession doesn&apos;t override this so it will always execute the code in ActiveMQSession which surely can run without a tx.&lt;/p&gt;

&lt;p&gt;I will work on a junit test shortly...&lt;/p&gt;</comment>
                            <comment id="12942523" author="gtully" created="Tue, 27 Apr 2010 17:52:21 +0000"  >&lt;p&gt;yea, in the run() case it is. The issue is for other regular users of jms who swap in an XA connection factory for a regular connection factory and use an XASession as a regular session without a transaction, currently they will get an exception but with the proposed changes they will not and they are into undefined behavior.&lt;br/&gt;
The point being that this change has implications beyond the RA use case. A variant of the org.apache.activemq.JMSConsumerTest with an XA connection factory will demonstrate the problems that the current exception is trying to avoid. From a normal JMS user perspective, Session and XASession are not the same.&lt;/p&gt;

&lt;p&gt;Maybe the way out of this is again through configuration, making the check for an active XA transaction optional, so it can be disabled for power users.&lt;/p&gt;</comment>
                            <comment id="12942521" author="rodos77" created="Tue, 27 Apr 2010 18:15:21 +0000"  >&lt;p&gt;I still don&apos;t understand why using XASession without a tx is &quot;undefined behavior&quot;.  No, they are not the same.  XASession has additional functionality but should still work as a regular session in the absence of tx. After all, XASession extends Session so even by the API an XASession can be treated as a regular Session.  In fact, the JMS client will always get a regular Session to work with.  However, the RA may instantiate an XASession behind the scenes.&lt;/p&gt;

&lt;p&gt;If we make this change and modify JMSConsumerTest to use XASession, what problem are you expecting to occur?&lt;/p&gt;
</comment>
                            <comment id="12942549" author="rodos77" created="Wed, 28 Apr 2010 15:42:15 +0000"  >&lt;p&gt;Ok, so I modified JMSConsumerTest to use XASession (attached).  I did initially see some problems and now understand what you were talking about.  However, I was able to get rid of the problem and make the tests pass by including the following method in ActiveMQXASession: &lt;br class=&quot;atl-forced-newline&quot; /&gt; &lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    public boolean isAutoAcknowledge() {
       return true;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think this makes sense since for an XASession transactions are controlled outside of the session and so as far as the session is concerned it is always AUTO_ACKNOWLEDGE.&lt;/p&gt;

&lt;p&gt;This would take care of your concerns, no?&lt;/p&gt;

&lt;p&gt;P.S.  There are 4 failures in the test but I think those are because the tests don&apos;t make sense any more with the transactions not controlled by the session.  Sorry, I don&apos;t have more time right now to look into it further.&lt;/p&gt;</comment>
                            <comment id="12942678" author="rodos77" created="Tue, 18 May 2010 16:31:27 +0000"  >&lt;p&gt;Hi Gary,&lt;/p&gt;

&lt;p&gt;Did you have a chance to run the attached test and check the additional proposed change?  Does it satisfy your concerns?  Can these changes be adopted?  I think in this case it is better to make it work for all use cases as opposed to going the config route.&lt;/p&gt;</comment>
                            <comment id="12942676" author="gtully" created="Tue, 18 May 2010 16:54:50 +0000"  >&lt;p&gt;will try and find some time for this before the 5.4 release&lt;/p&gt;</comment>
                            <comment id="12939315" author="gtully" created="Fri, 6 Aug 2010 17:07:34 +0000"  >&lt;p&gt;changes implemented in r983057&lt;br/&gt;
thanks for the test case etc.&lt;/p&gt;</comment>
                            <comment id="16510938" author="gtully" created="Wed, 13 Jun 2018 10:41:35 +0000"  >&lt;p&gt;Revisiting this, I now think the change needs to be configurable.&lt;/p&gt;

&lt;p&gt;I came across a use case with an XASession and consumer.receive(timeout) where the XA transaction rolls back before the timeout and where the subsequent received message gets auto acked in error, effectively loosing a message. Before this change, the doStartTransaction would throw and the receive would fail.&lt;/p&gt;

&lt;p&gt;Because the lifecycle of the transaction is independent of the consumer and session, having the session&#160;work without a transaction will leave the potential for holes in transacted work. It should not be enabled by default.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In addition, XASession.getTransacted() should always return true&#160; as per the &lt;a href=&quot;https://docs.oracle.com/javaee/5/api/javax/jms/XASession.html#getTransacted()&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;javadoc&lt;/a&gt;, not sure why that was missed 6years ago.&lt;/p&gt;

&lt;p&gt;I will rework the changes to allow the use of an xasession outside of a transaction once there is an explicit request to use a non transacted ack mode via setXaAckMode.&lt;/p&gt;

&lt;p&gt;By default, work outside an xa transaction will throw an error as it should.&lt;/p&gt;</comment>
                            <comment id="16510942" author="jira-bot" created="Wed, 13 Jun 2018 10:48:57 +0000"  >&lt;p&gt;Commit 004be56127e7e949c8ffff8c36435ea0f27d32d4 in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=004be56&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=004be56&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2659&quot; title=&quot;JMSException incorrectly thrown when using XAConnection/XASession outside a transaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2659&quot;&gt;&lt;del&gt;AMQ-2659&lt;/del&gt;&lt;/a&gt; - make configurable based on xaAckMode, otherwise pure xa case can default to autoack in error. Additional tests&lt;/p&gt;</comment>
                            <comment id="16510943" author="gtully" created="Wed, 13 Jun 2018 10:53:17 +0000"  >&lt;p&gt;To use a non transacted ack mode in XASessions, it now needs to be explicitly enabled via the xaAckMode accessor. Either through the brokerURI or via the setter.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ActiveMQXAConnectionFactory activeMQXAConnectionFactory = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ActiveMQXAConnectionFactory(&lt;span class=&quot;code-quote&quot;&gt;&quot;vm:&lt;span class=&quot;code-comment&quot;&gt;//localhost?jms.xaAckMode=1&quot;&lt;/span&gt;);
&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;// or
&lt;/span&gt;activeMQXAConnectionFactory.setXaAckMode(Session.AUTO_ACKNOWLEDGE);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16561803" author="christopher.l.shannon" created="Mon, 30 Jul 2018 11:37:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; - it looks like your latest commit broke this test: &lt;a href=&quot;https://builds.apache.org/view/A/view/ActiveMQ/job/ActiveMQ-Java8/lastBuild/org.apache.activemq$activemq-karaf-itest/testReport/org.apache.activemq.karaf.itest/ActiveMQBrokerNdCamelFeatureTest/test/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/view/A/view/ActiveMQ/job/ActiveMQ-Java8/lastBuild/org.apache.activemq$activemq-karaf-itest/testReport/org.apache.activemq.karaf.itest/ActiveMQBrokerNdCamelFeatureTest/test/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Do we need to configure something different now with camel for XA or is this a regression?&lt;/p&gt;</comment>
                            <comment id="16561902" author="jira-bot" created="Mon, 30 Jul 2018 13:07:21 +0000"  >&lt;p&gt;Commit 18543080a04b3612708464eb32e9975a8eb974f6 in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1854308&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1854308&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2659&quot; title=&quot;JMSException incorrectly thrown when using XAConnection/XASession outside a transaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2659&quot;&gt;&lt;del&gt;AMQ-2659&lt;/del&gt;&lt;/a&gt; - fix camel route config to reflect revised behaviour&lt;/p&gt;</comment>
                            <comment id="16561903" author="gtully" created="Mon, 30 Jul 2018 13:08:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; thanks for the heads up, apologies. yes - the config for that non transacted route with an xa connection factory needed to be updated after this change. sorted now.&lt;/p&gt;</comment>
                            <comment id="16562071" author="christopher.l.shannon" created="Mon, 30 Jul 2018 16:13:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; - no problem thanks for fixing that, I was just verifying this morning all the tests work as I am about to do a 5.15.5 release and noticed that the Camel test had broke in Jenkins&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13369071">AMQ-8213</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12461685" name="JMSConsumerTestXA.java" size="39065" author="rodos77" created="Wed, 28 Apr 2010 15:44:11 +0000"/>
                            <attachment id="12461684" name="JmsTestSupportXA.java" size="6151" author="rodos77" created="Wed, 28 Apr 2010 15:44:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14717</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 16 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0b9t3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63701</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>