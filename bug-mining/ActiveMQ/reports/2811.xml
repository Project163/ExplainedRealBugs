<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:34:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6248] Failover - transport connected to one broker fails due to error in connection to another broker</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6248</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;There is a bug in the  &lt;tt&gt;FailoverTransport&lt;/tt&gt; which is triggered by a race condition. The client log contains message:&lt;br/&gt;
&lt;tt&gt;WARN | ActiveMQ Transport: &lt;b&gt;URI1&lt;/b&gt; [FailoverTransport] Transport (&lt;b&gt;URI2&lt;/b&gt;) failed, attempting to automatically reconnect&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;The exact impact on client failover differs with each setup and environment. In our case this forced client to infinitely switch between two available brokers.&lt;/p&gt;

&lt;p&gt;Assume client is configured to use broker URL in form&lt;br/&gt;
&lt;tt&gt;failover:(URI1,URI2)?randomize=false&lt;/tt&gt;.&lt;br/&gt;
Assume that broker with URI1 is down and the other broker URI2 is running fine. This is normal master/slave setup. &lt;/p&gt;

&lt;p&gt;Client tries to establish connection and the following happens:&lt;br/&gt;
1. URI1 is tried, it fails because this broker is not reachable (down or waiting slave)&lt;br/&gt;
2. URI2 is tried, it succeeds because this broker is currently the &apos;master&apos;&lt;br/&gt;
3. Exception from thread of transport to URI1 causes failure in transport to URI2&lt;br/&gt;
4. Try another transport in the list. Oh wait, its URI1 -&amp;gt; go to 1.&lt;/p&gt;

&lt;p&gt;Impact for different configurations might not be that severe. But unfortunately in our case we were not able to avoid this bug no matter the configuration. For example &lt;tt&gt;randomize=true&lt;/tt&gt; helped a little, but still the inifinite loop happens 1/2 of the time.&lt;/p&gt;

&lt;p&gt;The bug is caused by a single shared instance &lt;tt&gt;myTransportListener&lt;/tt&gt; of &lt;tt&gt;TransportListener&lt;/tt&gt; in &lt;tt&gt;FailoverTransport&lt;/tt&gt; class. &lt;tt&gt;doReconnect()&lt;/tt&gt; tries to start transport to URI1 and registers the listener on it. Transport fails to start and the next transport to URI2 is tried. But the listener is not unregistered from the failed transport URI1. Failures that happen on transport URI1 may call in its own thread the listener method &lt;tt&gt;onException()&lt;/tt&gt;. This call will get to &lt;tt&gt;handleTransportFailure()&lt;/tt&gt; where it waits for the &lt;tt&gt;reconnectMutex&lt;/tt&gt;. The reconnect task thread continues, establishes Transport URI2, sets it to &lt;tt&gt;connectedTransport&lt;/tt&gt;=URI2, releases the reconnectMutex. The thread of transport URI1 unblocks in handleTransportFailure() and destroys the connectedTransport=URI2.&lt;/p&gt;

&lt;p&gt;I have created a patch against version 5.11 that deals specifically with this problem.&lt;br/&gt;
The change is that instead of the single shared myTrasnportListener instance there is a new listener created for each new transport.&lt;br/&gt;
Each new listener keeps reference to the transport it was assigned to. The listener will cause failover only if the exception is coming from the transport which is currently connected.&lt;br/&gt;
I didn&apos;t care about the other methods of the listener, but these probably need the same restriction.&lt;/p&gt;

&lt;p&gt;This bug is present in all versions from version 4.0 (I didn&apos;t go deeper). The idea in the patch should be applicable for all versions.&lt;/p&gt;

&lt;p&gt;Btw. log message mentioned in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4986&quot; title=&quot;tightEncoding=false + failover triggers Broker memory exhaust&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4986&quot;&gt;&lt;del&gt;AMQ-4986&lt;/del&gt;&lt;/a&gt; contains the same URI1 vs URI2 problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12958845">AMQ-6248</key>
            <summary>Failover - transport connected to one broker fails due to error in connection to another broker</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="pjanata">Petr Janata</reporter>
                        <labels>
                            <label>failover</label>
                            <label>race-condition</label>
                    </labels>
                <created>Thu, 14 Apr 2016 13:39:42 +0000</created>
                <updated>Mon, 18 Apr 2016 13:55:43 +0000</updated>
                            <resolved>Mon, 18 Apr 2016 13:55:43 +0000</resolved>
                                                    <fixVersion>5.13.3</fixVersion>
                    <fixVersion>5.14.0</fixVersion>
                                    <component>Transport</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15241223" author="pjanata" created="Thu, 14 Apr 2016 14:14:39 +0000"  >&lt;p&gt;Here is the patch. It is an output from svn diff command.&lt;/p&gt;</comment>
                            <comment id="15245674" author="jira-bot" created="Mon, 18 Apr 2016 13:46:04 +0000"  >&lt;p&gt;Commit 23a5beb86c3dac151ae3ed242ce506aa0048bd03 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=23a5beb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=23a5beb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6248&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6248&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Prevent conccurent calls to handleTransportFailure from closing an&lt;br/&gt;
already reconnected transport instance.  &lt;/p&gt;</comment>
                            <comment id="15245691" author="jira-bot" created="Mon, 18 Apr 2016 13:53:14 +0000"  >&lt;p&gt;Commit 46dadf986666170638f8c8c6e1cb29346f4a86b5 in activemq&apos;s branch refs/heads/activemq-5.13.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=46dadf9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=46dadf9&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6248&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6248&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Prevent conccurent calls to handleTransportFailure from closing an&lt;br/&gt;
already reconnected transport instance.  &lt;br/&gt;
(cherry picked from commit 23a5beb86c3dac151ae3ed242ce506aa0048bd03)&lt;/p&gt;

&lt;p&gt;Conflicts:&lt;br/&gt;
	activemq-client/src/main/java/org/apache/activemq/transport/failover/FailoverTransport.java&lt;/p&gt;</comment>
                            <comment id="15245693" author="jira-bot" created="Mon, 18 Apr 2016 13:54:10 +0000"  >&lt;p&gt;Commit 3560d9123dbeecc97f075a6812f15b2484836275 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=3560d91&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=3560d91&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6248&quot; title=&quot;Failover - transport connected to one broker fails due to error in connection to another broker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6248&quot;&gt;&lt;del&gt;AMQ-6248&lt;/del&gt;&lt;/a&gt; fix logging statement to use the connected URI.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12798740" name="AMQ-6248.patch.svndiff" size="9212" author="pjanata" created="Thu, 14 Apr 2016 14:14:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 31 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2w4gf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>