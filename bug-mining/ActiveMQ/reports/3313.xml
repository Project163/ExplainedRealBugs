<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:49:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-7314] Redelivery counter is not getting incremented when LastDeliveredSeqID &gt; BrokerSequenceId</title>
                <link>https://issues.apache.org/jira/browse/AMQ-7314</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Issue: Redelivery counter is not getting incremented when LastDeliveredSeqID &amp;gt; BrokerSequenceId&lt;/p&gt;

&lt;p&gt;Version tested : ActiveMQ 5.14.4 and 5.15.10 versions&lt;/p&gt;

&lt;p&gt;Description:&lt;br/&gt;
I have created the two queues, one for sending requests and other for receiving its response.&lt;br/&gt;
The steps for these queues are given below.&lt;/p&gt;

&lt;p&gt;Steps:&lt;/p&gt;

&lt;p&gt;1. SenderA (Machine A) sends Msg on RequestQueue TO ReceiverB (Machine B) (Redelivery count is 0, Ack Mode:INDIVIDUAL_ACKNOWLEDGE).&lt;/p&gt;

&lt;p&gt;2. SenderB sends ResponseMsg on Response queue (Machine B) TO ReceiverA (Machine A) (Async Msg Listener, Ack Mode:CLIENT_ACKNOWLEDGE)&lt;/p&gt;

&lt;p&gt;3. SenderB is waiting for the consumed advisory for ResponseMsg. Request Msg is not yet acknowledged.&lt;/p&gt;

&lt;p&gt; 4. ReceiverA acknowledges the ResponseMsg. ResponseMsg consumed advisory is received by SenderB&lt;/p&gt;

&lt;p&gt;5. Machine B disconnects from the embedded broker hosted on Machine A&lt;/p&gt;

&lt;p&gt; 6. On Machine B reconnection, Broker sends Msg on RequestQueue again -&amp;gt; ReceiverB (Issue: Redelivery count is 0 instead of 1)&lt;/p&gt;

&lt;p&gt;Analysis:&lt;br/&gt;
1. The Queue.java has removeSubscription() function which increments the redelivery counter by comparing lastDeliveredSequenceId and BrokerSequenceId.&lt;br/&gt;
2. The step4 incremented the LastDeliveredSeqID for message consumed advisory. &lt;br/&gt;
3. The transport connection updates the lastDeliveredSequenceId for each consumer by calling&lt;br/&gt;
 processRemoveConsumer(consumerId, lastDeliveredSequenceId);&lt;br/&gt;
 4. The condition &#8220;ref.getMessageId().getBrokerSequenceId() == lastDeliveredSequenceId&#8221; in removeSubscription() doesn&#8217;t set markAsRedelivered to true.&lt;/p&gt;

&lt;p&gt;org.apache.activemq.broker.region.Queue removeSubscription&lt;br/&gt;
FINE: queue://RequestQueue_334 remove sub: QueueSubscription: consumer=ID:5107-1569853470047-1:1:1:1, destinations=1, dispatched=2, delivered=2, pending=0, prefetch=1, prefetchExtension=2, lastDeliveredSeqId: 17, dequeues: 0, dispatched: 2, inflight: 2, groups: 0&lt;br/&gt;
org.apache.activemq.broker.region.Queue removeSubscription&lt;br/&gt;
FINE: LastDeliveredSeqID: 17, message reference: ID:WIN2K8R2-7986-1569853472713-4:1:1:1:1, BrokerSequenceId 7&lt;br/&gt;
org.apache.activemq.broker.region.Queue removeSubscription&lt;br/&gt;
FINE: LastDeliveredSeqID: 17, message reference: ID:WIN2K8R2-7986-1569853472713-4:1:1:1:2, BrokerSequenceId 8&lt;/p&gt;


&lt;p&gt;Queue.java , removeSubscription()&lt;/p&gt;

&lt;p&gt;Existing Code in 5.14.4:&lt;/p&gt;

&lt;p&gt;// locate last redelivered in unconsumed list (list in delivery rather than seq order)&lt;br/&gt;
 if (lastDeliveredSequenceId &amp;gt; RemoveInfo.LAST_DELIVERED_UNSET) {&lt;br/&gt;
 for (MessageReference ref : unAckedMessages) {&lt;br/&gt;
 if (ref.getMessageId().getBrokerSequenceId() == lastDeliveredSequenceId) {&lt;br/&gt;
 lastDeliveredRef = ref;&lt;br/&gt;
 markAsRedelivered = true;&lt;br/&gt;
 LOG.debug(&quot;found lastDeliveredSeqID: {}, message reference: {}&quot;, lastDeliveredSequenceId, ref.getMessageId());&lt;br/&gt;
 break;&lt;br/&gt;
 }&lt;br/&gt;
 }&lt;br/&gt;
 }&lt;/p&gt;

&lt;p&gt;Suggested fix:&lt;/p&gt;

&lt;p&gt;// locate last redelivered in unconsumed list (list in delivery rather than seq order)&lt;br/&gt;
 if (lastDeliveredSequenceId &amp;gt; RemoveInfo.LAST_DELIVERED_UNSET) {&lt;br/&gt;
 for (MessageReference ref : unAckedMessages) {&lt;br/&gt;
 LOG.debug(&quot;UnAcked message reference: {}, BrokerSequenceId {}&quot;, ref.getMessageId(), ref.getMessageId().getBrokerSequenceId());&lt;br/&gt;
 if (lastDeliveredSequenceId == 0 || (lastDeliveredSequenceId &amp;gt; 0 &amp;amp;&amp;amp; ref.getMessageId().getBrokerSequenceId() &amp;lt;= lastDeliveredSequenceId)) &lt;br/&gt;
 {&lt;br/&gt;
 lastDeliveredRef = ref;&lt;br/&gt;
 markAsRedelivered = true;&lt;br/&gt;
 LOG.debug(&quot;found lastDeliveredSeqID: {}, message reference: {}&quot;, lastDeliveredSequenceId, ref.getMessageId());&lt;br/&gt;
 }&lt;br/&gt;
 }&lt;br/&gt;
 }&lt;/p&gt;

&lt;p&gt;Could you please review the analysis and fix?&lt;/p&gt;

&lt;p&gt;Thanks, &lt;br/&gt;
Dhananjay&lt;/p&gt;</description>
                <environment></environment>
        <key id="13260050">AMQ-7314</key>
            <summary>Redelivery counter is not getting incremented when LastDeliveredSeqID &gt; BrokerSequenceId</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="4" iconUrl="https://issues.apache.org/jira/images/icons/statuses/reopened.png" description="This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.">Reopened</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="jbonofre">Jean-Baptiste Onofr&#233;</assignee>
                                    <reporter username="djdkedev">Dhananjay</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Oct 2019 06:10:55 +0000</created>
                <updated>Wed, 22 Nov 2023 12:44:35 +0000</updated>
                                            <version>5.14.4</version>
                    <version>5.15.10</version>
                                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17049410" author="jira-bot" created="Mon, 2 Mar 2020 16:56:43 +0000"  >&lt;p&gt;Commit df1750fe01a6e31573e3bc66ee342402963fd014 in activemq&apos;s branch refs/heads/master from jbonofre&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=df1750f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=df1750f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7314&quot; title=&quot;Redelivery counter is not getting incremented when LastDeliveredSeqID &amp;gt; BrokerSequenceId&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7314&quot;&gt;AMQ-7314&lt;/a&gt; Fix counter increment when lastDelivereSeqId &amp;gt; BrokerSequenceId&lt;/p&gt;</comment>
                            <comment id="17049411" author="jira-bot" created="Mon, 2 Mar 2020 16:56:45 +0000"  >&lt;p&gt;Commit c4e72e3383f6a30808fbee12b722704deaeaa1dd in activemq&apos;s branch refs/heads/master from Jean-Baptiste Onofr&#233;&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=c4e72e3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=c4e72e3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #489 from jbonofre/&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7314&quot; title=&quot;Redelivery counter is not getting incremented when LastDeliveredSeqID &amp;gt; BrokerSequenceId&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7314&quot;&gt;AMQ-7314&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7314&quot; title=&quot;Redelivery counter is not getting incremented when LastDeliveredSeqID &amp;gt; BrokerSequenceId&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7314&quot;&gt;AMQ-7314&lt;/a&gt; Fix counter increment when lastDelivereSeqId &amp;gt; BrokerSequenceId&lt;/p&gt;</comment>
                            <comment id="17049412" author="jira-bot" created="Mon, 2 Mar 2020 16:56:47 +0000"  >&lt;p&gt;Commit c4e72e3383f6a30808fbee12b722704deaeaa1dd in activemq&apos;s branch refs/heads/master from Jean-Baptiste Onofr&#233;&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=c4e72e3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=c4e72e3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #489 from jbonofre/&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7314&quot; title=&quot;Redelivery counter is not getting incremented when LastDeliveredSeqID &amp;gt; BrokerSequenceId&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7314&quot;&gt;AMQ-7314&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7314&quot; title=&quot;Redelivery counter is not getting incremented when LastDeliveredSeqID &amp;gt; BrokerSequenceId&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7314&quot;&gt;AMQ-7314&lt;/a&gt; Fix counter increment when lastDelivereSeqId &amp;gt; BrokerSequenceId&lt;/p&gt;</comment>
                            <comment id="17049414" author="jira-bot" created="Mon, 2 Mar 2020 16:57:16 +0000"  >&lt;p&gt;Commit 6d2560f7e35b12e73bf9f82cb235dc32855271f5 in activemq&apos;s branch refs/heads/activemq-5.15.x from jbonofre&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=6d2560f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=6d2560f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7314&quot; title=&quot;Redelivery counter is not getting incremented when LastDeliveredSeqID &amp;gt; BrokerSequenceId&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7314&quot;&gt;AMQ-7314&lt;/a&gt; Fix counter increment when lastDelivereSeqId &amp;gt; BrokerSequenceId&lt;/p&gt;

&lt;p&gt;(cherry picked from commit df1750fe01a6e31573e3bc66ee342402963fd014)&lt;/p&gt;</comment>
                            <comment id="17054934" author="christopher.l.shannon" created="Mon, 9 Mar 2020 13:02:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&#160;- Does this look correct to you? It seems wrong to mark the lastDeliveredRef as found when it&apos;s less than the lastDeliveredSequenceId and not equal to it&lt;/p&gt;</comment>
                            <comment id="17054958" author="gtully" created="Mon, 9 Mar 2020 13:34:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; on a quick peek that does look wrong, that value is set by the client consumer on close to track what was consumed.&lt;br/&gt;
I did a quick sanity of related tests and I see that org.apache.bugs.AMQ1730Test#testRedelivery breaks with that change. &lt;br/&gt;
Maybe that fix needs a test case in a similar vein to show what is broken and also to protect it.&lt;/p&gt;</comment>
                            <comment id="17054968" author="christopher.l.shannon" created="Mon, 9 Mar 2020 13:41:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&#160;- Thanks Gary for taking a look.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbonofre&quot; class=&quot;user-hover&quot; rel=&quot;jbonofre&quot;&gt;jbonofre&lt;/a&gt;&#160;- We may want to just revert this fix for now for a future release to create a test case and figure out a proper fix as to not cause a regression&lt;/p&gt;</comment>
                            <comment id="17054975" author="jbonofre" created="Mon, 9 Mar 2020 13:48:17 +0000"  >&lt;p&gt;The fix looked good to me. Anyway as it&#8217;s minor I will rollback and do a better fix for next release cycle.&#160;&lt;/p&gt;</comment>
                            <comment id="17055586" author="jira-bot" created="Tue, 10 Mar 2020 05:29:51 +0000"  >&lt;p&gt;Commit 1550ae42f7ad86d8b341503dd3ab39b94f1c5bec in activemq&apos;s branch refs/heads/master from jbonofre&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=1550ae4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=1550ae4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7314&quot; title=&quot;Redelivery counter is not getting incremented when LastDeliveredSeqID &amp;gt; BrokerSequenceId&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7314&quot;&gt;AMQ-7314&lt;/a&gt; Fix counter increment when lastDelivereSeqId &amp;gt; BrokerSequenceId&quot;&lt;/p&gt;

&lt;p&gt;This reverts commit df1750fe01a6e31573e3bc66ee342402963fd014.&lt;/p&gt;</comment>
                            <comment id="17055587" author="jira-bot" created="Tue, 10 Mar 2020 05:30:22 +0000"  >&lt;p&gt;Commit e783b7f93ae19be6c1e1defa3fef452ff44fe4d6 in activemq&apos;s branch refs/heads/activemq-5.15.x from jbonofre&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=e783b7f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=e783b7f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7314&quot; title=&quot;Redelivery counter is not getting incremented when LastDeliveredSeqID &amp;gt; BrokerSequenceId&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7314&quot;&gt;AMQ-7314&lt;/a&gt; Fix counter increment when lastDelivereSeqId &amp;gt; BrokerSequenceId&quot;&lt;/p&gt;

&lt;p&gt;This reverts commit 6d2560f7e35b12e73bf9f82cb235dc32855271f5.&lt;/p&gt;</comment>
                            <comment id="17788461" author="djdkedev" created="Tue, 21 Nov 2023 15:43:08 +0000"  >&lt;p&gt;We are upgrading ActiveMQ 5.14.4 in our product to &lt;a href=&quot;https://activemq.apache.org/news/cve-2023-46604&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CVE-2023-46604&lt;/a&gt;&#160;fixed version&#160;&lt;a href=&quot;https://activemq.apache.org/activemq-5015016-release&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.15.16&lt;/a&gt;. Are you considering this &quot;Redelivery counter increment&quot; fix for &lt;a href=&quot;https://activemq.apache.org/activemq-5015016-release&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.15.16&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17788758" author="jbonofre" created="Wed, 22 Nov 2023 12:44:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djdkedev&quot; class=&quot;user-hover&quot; rel=&quot;djdkedev&quot;&gt;djdkedev&lt;/a&gt; ActiveMQ 5.15.x and 5.16.x are not maintained anymore. We are working on 6.0.x, 5.18.x, and 5.17.x.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12981955" name="ActiveMQ_RedeliveryCounter_Fix_Diff.htm" size="3014860" author="djdkedev" created="Wed, 2 Oct 2019 07:04:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z077xk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>