<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:56:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3664] Not all messages will be acknowledged when optimizeAcknowledge is true</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3664</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I make performance test with activemq. When I set optimizeAcknowledge = true I get a dramatic performance improvement, but when I shut down the producer the consumer does not acknowledge all messages! If I stop the consumer and then I start the consumer a second time the consumer recieves messages again and again not all messages will be acknoledged in the queue.&lt;/p&gt;

&lt;p&gt;I am using camel 2.9.0 to produce and consume the messages.&lt;br/&gt;
I am using the consumer Template with asyncSendBody.&lt;br/&gt;
The following route is configured in the camelContext:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
    &amp;lt;camel:camelContext id=&quot;camelContext&quot;&amp;gt;
    	&amp;lt;camel:template id=&quot;producerTemplate&quot;/&amp;gt;
    	&amp;lt;camel:consumerTemplate id=&quot;consumerTemplate&quot;/&amp;gt;
    	&amp;lt;camel:route&amp;gt;
    		&amp;lt;camel:from uri=&quot;jms:queue0?concurrentConsumers=3&amp;amp;amp;maxConcurrentConsumers=10&amp;amp;amp;asyncConsumer=true&quot;/&amp;gt;
    		&amp;lt;camel:to uri=&quot;beanConsumer&quot;/&amp;gt;
    	&amp;lt;/camel:route&amp;gt;
    &amp;lt;/camel:camelContext&amp;gt;

The config for the ActiveMQComponent:
    &amp;lt;bean id=&quot;jms&quot; class=&quot;org.apache.activemq.camel.component.ActiveMQComponent&quot;&amp;gt;
		&amp;lt;property name=&quot;connectionFactory&quot;&amp;gt;		
			&amp;lt;bean class=&quot;org.apache.activemq.pool.PooledConnectionFactory&quot;&amp;gt;
   				&amp;lt;property name=&quot;connectionFactory&quot;&amp;gt;
  					&amp;lt;bean class=&quot;org.apache.activemq.spring.ActiveMQConnectionFactory&quot;&amp;gt;
   						&amp;lt;property name=&quot;optimizeAcknowledge&quot; value=&quot;true&quot;/&amp;gt;
   						&amp;lt;property name=&quot;dispatchAsync&quot; value=&quot;true&quot;/&amp;gt;
  						&amp;lt;property name=&quot;sendAcksAsync&quot; value=&quot;true&quot;/&amp;gt;
  						&amp;lt;property name=&quot;useAsyncSend&quot; value=&quot;true&quot;/&amp;gt;
				 		&amp;lt;property name=&quot;brokerURL&quot; value=&quot;nio://138-ham-de:61616&quot;/&amp;gt;				 		
				 		&amp;lt;property name=&quot;useDedicatedTaskRunner&quot; value=&quot;false&quot;/&amp;gt; 
    				&amp;lt;/bean&amp;gt;	
      			&amp;lt;/property&amp;gt;
      		&amp;lt;/bean&amp;gt;
      	&amp;lt;/property&amp;gt;
    &amp;lt;/bean&amp;gt;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think, the problem is here:&lt;br/&gt;
Class ActiveMQMessageConsumer:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
    private void afterMessageIsConsumed(MessageDispatch md, boolean messageExpired) throws JMSException {
        if (unconsumedMessages.isClosed()) {
            return;
        }
        if (messageExpired) {
            synchronized (deliveredMessages) {
                deliveredMessages.remove(md);
            }
            stats.getExpiredMessageCount().increment();
            ackLater(md, MessageAck.DELIVERED_ACK_TYPE);
        } else {
            stats.onMessage();
            if (session.getTransacted()) {
                // Do nothing.
            } else if (isAutoAcknowledgeEach()) {
                if (deliveryingAcknowledgements.compareAndSet(false, true)) {
                    synchronized (deliveredMessages) {
                        if (!deliveredMessages.isEmpty()) {
                            if (optimizeAcknowledge) {
                                ackCounter++;
                                if (ackCounter &amp;gt;= (info.getPrefetchSize() * .65) || System.currentTimeMillis() &amp;gt;= (optimizeAckTimestamp + optimizeAckTimeout)) {
                                	MessageAck ack = makeAckForAllDeliveredMessages(MessageAck.STANDARD_ACK_TYPE);
                                	if (ack != null) {
                            		    deliveredMessages.clear();
                            		    ackCounter = 0;
                            		    session.sendAck(ack);
                            		    optimizeAckTimestamp = System.currentTimeMillis();
                                	}
                                }
                            } else {
                                MessageAck ack = makeAckForAllDeliveredMessages(MessageAck.STANDARD_ACK_TYPE);
                                if (ack!=null) {
                                    deliveredMessages.clear();
                                    session.sendAck(ack);
                                }
                            }
                        }
                    }
                    deliveryingAcknowledgements.set(false);
                }
            } else if (isAutoAcknowledgeBatch()) {
                ackLater(md, MessageAck.STANDARD_ACK_TYPE);
            } else if (session.isClientAcknowledge()||session.isIndividualAcknowledge()) {
                boolean messageUnackedByConsumer = false;
                synchronized (deliveredMessages) {
                    messageUnackedByConsumer = deliveredMessages.contains(md);
                }
                if (messageUnackedByConsumer) {
                    ackLater(md, MessageAck.DELIVERED_ACK_TYPE);
                }
            } 
            else {
                throw new IllegalStateException(&quot;Invalid session state.&quot;);
            }
        }
    }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What will happen when no producer will send a message to this queue so that no message will pass this method? When will the deliveredMessages been acked?&lt;/p&gt;

</description>
                <environment>&lt;p&gt;Windows 7 and Linux Debian with JRE 1.6.24 or JRE 1.6.27&lt;/p&gt;</environment>
        <key id="12538611">AMQ-3664</key>
            <summary>Not all messages will be acknowledged when optimizeAcknowledge is true</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="matw">Matthias Wessel</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Jan 2012 09:38:21 +0000</created>
                <updated>Tue, 18 Sep 2012 10:16:42 +0000</updated>
                            <resolved>Tue, 18 Sep 2012 10:16:42 +0000</resolved>
                                    <version>5.5.1</version>
                                    <fixVersion>5.7.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13187771" author="gtully" created="Tue, 17 Jan 2012 16:00:24 +0000"  >&lt;p&gt;I suspect you need to explicitly set a cache level (use cacheLevel or cacheLevelName attributes) for the component. It defaults to cache_auto which means cache_consumer when there is no transaction. So the consumer is not actually closed.&lt;br/&gt;
If the consumer is closed, any outstanding auto ack will be dispatched.&lt;/p&gt;</comment>
                            <comment id="13188421" author="matw" created="Wed, 18 Jan 2012 12:09:15 +0000"  >&lt;p&gt;When I switch to another cache than CACHE_AUTO or CACHE CONSUMER, I get a dramatic deterioration of performance. Then I am faster when I do not use ptimizeAcknowledge = true. This cannot be the goal of this setting!&lt;br/&gt;
The other problem is I do not want to close the consumer. Yes, I want to close the producer, but the consumer should consume and acknowledge all existing messages in the queue. The consumer should not care about how many producers produce messages to the queue. &lt;/p&gt;</comment>
                            <comment id="13188430" author="gtully" created="Wed, 18 Jan 2012 12:50:54 +0000"  >&lt;p&gt;How do you stop the consumer? When the consumer is stopped it needs to be shutdown, so if it is cached, it needs to be really closed, because optimizeAcknowledge delays acks (to batch them) for a period or till half of the prefetch is reached or till it is closed. The expectation is that there will be duplicate delivery if the consumer is not closed.&lt;br/&gt;
The default auto ack mode, does an immediate ack.&lt;/p&gt;

&lt;p&gt;The other alternative is to use transactions to batch your client acks, I think this may be the simplest approach. &lt;br/&gt;
Another option is to use client ack mode and periodically call acknowledge, but with camel, this would require your own processor to get access to the underlying activemq message to call acknowledge.&lt;/p&gt;

&lt;p&gt;I think first, validate that the consumer is closed when it is shutdown.&lt;/p&gt;

&lt;p&gt;For this case, we may need to introduce a consumer task that does a periodic ack, to catch the case where the consumer is cached, there is a pause in production, and there are pending acks. But in the abortive case, there may still be duplicates.&lt;/p&gt;</comment>
                            <comment id="13451306" author="davsclaus" created="Sat, 8 Sep 2012 10:20:04 +0000"  >&lt;p&gt;Gary&lt;/p&gt;

&lt;p&gt;Yeah maybe a multiplexed background thread could run and acknowledge the messages if the consumer has been inactive for a period.&lt;br/&gt;
I wonder if we can use a single thread for all optimized ack consumers, I would assume a thread per consumer would bee too much?&lt;/p&gt;</comment>
                            <comment id="13453819" author="tabish121" created="Wed, 12 Sep 2012 08:02:00 +0000"  >&lt;p&gt;The simplest thing would probably be to add a task to the Schedular instance that&apos;s owned by ActiveMQConnection that can check for time since last ack on the consumer and fire an ack if the configured time has elapsed.&lt;/p&gt;</comment>
                            <comment id="13457723" author="tabish121" created="Tue, 18 Sep 2012 10:16:21 +0000"  >&lt;p&gt;added option optimizedAckScheduledAckInterval to Connection and MessageConsumer to allow for a configurable async ack of outstanding messages.  By default this option is set to zero, meaning no async acks are sent.  If the user wants to ensure all messages are acked at some point then they can enable this by setting to a value greater than zero.  &lt;/p&gt;</comment>
                            <comment id="13457724" author="tabish121" created="Tue, 18 Sep 2012 10:16:42 +0000"  >&lt;p&gt;fixed in trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>224115</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 10 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0aicn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59246</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>