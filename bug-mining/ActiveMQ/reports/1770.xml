<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:57:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4148] Static subscriptions from network bridges do not respect TTL (off by one in calculation), resulting in duplicate consumers.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4148</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Symptom&lt;br/&gt;
=======&lt;br/&gt;
The remote broker path is not set on network consumers that result from static subscriptions; as a result, they are forwarded to other bridges even when the network TTL on the bridges is 1.  In an n+1 hub-and-spoke network, the next broker to join receives n subscriptions instead of 1.&lt;/p&gt;

&lt;p&gt;Cause&lt;br/&gt;
=====&lt;br/&gt;
A consumer for a static subscriptions is created by the following code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;DemandForwardingBridgeSupport.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void startLocalBridge() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable {
...
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!disposed.get()) {
            setupStaticDestinations();
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Network connection between &quot;&lt;/span&gt; + localBroker + &lt;span class=&quot;code-quote&quot;&gt;&quot; and &quot;&lt;/span&gt; + remoteBroker + &lt;span class=&quot;code-quote&quot;&gt;&quot;(&quot;&lt;/span&gt; + remoteBrokerName + &lt;span class=&quot;code-quote&quot;&gt;&quot;) was interrupted during establishment.&quot;&lt;/span&gt;);
        }
    }
}

/**
 * Subscriptions &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; these destinations are always created
 */
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void setupStaticDestinations() {
...
            DemandSubscription sub = createDemandSubscription(dest);
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                addSubscription(sub);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
                LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to add &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; destination &quot;&lt;/span&gt; + dest, e);
            }
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isTraceEnabled()) {
                LOG.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;bridging messages &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; destination: &quot;&lt;/span&gt; + dest);
            }
        }
    }
}

&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; DemandSubscription createDemandSubscription(ActiveMQDestination destination) {
    ConsumerInfo info = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConsumerInfo();
    info.setDestination(destination);

    &lt;span class=&quot;code-comment&quot;&gt;// the remote info held by the DemandSubscription holds the original consumerId,
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// the local info get&apos;s overwritten
&lt;/span&gt;    info.setConsumerId(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConsumerId(localSessionInfo.getSessionId(), consumerIdGenerator.getNextSequenceId()));
    DemandSubscription result = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        result = createDemandSubscription(info);
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
        LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to create DemandSubscription &quot;&lt;/span&gt;, e);
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; result;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note how the broker path is &lt;b&gt;not&lt;/b&gt; set on the &lt;tt&gt;ConsumerInfo&lt;/tt&gt; that is used for the subscription.  &lt;/p&gt;

&lt;p&gt;In contrast, a consumer for a dynamic subscription does have its broker path updated to indicate that it is from a remote broker:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;DemandForwardingBridgeSupport.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void serviceRemoteCommand(Command command) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!disposed.get()) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (command.isMessageDispatch()) {
                safeWaitUntilStarted();
                MessageDispatch md = (MessageDispatch) command;
                serviceRemoteConsumerAdvisory(md.getMessage().getDataStructure());
                ackAdvisory(md.getMessage());
...

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void serviceRemoteConsumerAdvisory(DataStructure data) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
...
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (addConsumerInfo(info)) {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isDebugEnabled()) {
                    LOG.debug(configuration.getBrokerName() + &lt;span class=&quot;code-quote&quot;&gt;&quot; bridged sub on &quot;&lt;/span&gt; + localBroker + &lt;span class=&quot;code-quote&quot;&gt;&quot; from &quot;&lt;/span&gt; + remoteBrokerName + &lt;span class=&quot;code-quote&quot;&gt;&quot; : &quot;&lt;/span&gt; + info);
                }
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isDebugEnabled()) {
                    LOG.debug(configuration.getBrokerName() + &lt;span class=&quot;code-quote&quot;&gt;&quot; Ignoring sub from &quot;&lt;/span&gt; + remoteBrokerName + &lt;span class=&quot;code-quote&quot;&gt;&quot; as already subscribed to matching destination : &quot;&lt;/span&gt; + info);
                }
            }
        }
...

&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; addConsumerInfo(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ConsumerInfo consumerInfo) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; consumerAdded = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    ConsumerInfo info = consumerInfo.copy();
    addRemoteBrokerToBrokerPath(info);
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Because of this difference, a static subscription will be forwarded to new bridges with a &lt;tt&gt;null&lt;/tt&gt; brokerPath while a dynamic subscription to the same queue will be forwarded with a singleton brokerPath.  As a result, static subscriptions will be propagated one further hop than their dynamic counterparts.  In the case of a network TTL of 1, the static subscription consumers from existing bridges are unexpectedly propagated to new bridges, while the dynamic subscription consumers are correctly suppressed.&lt;/p&gt;

&lt;p&gt;Solution&lt;br/&gt;
========&lt;br/&gt;
There should be no logical difference between a network consumer created for a static subscription vs. a dynamic subscription.  In either case, the bridge creates a consumer on behalf of the remote broker.  As such, the consumer for a static subscription should have the remote broker in its broker path because it represents a subscription from that remote broker (even if there is no consumer).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12614131">AMQ-4148</key>
            <summary>Static subscriptions from network bridges do not respect TTL (off by one in calculation), resulting in duplicate consumers.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="stirlingc">Stirling Chow</reporter>
                        <labels>
                    </labels>
                <created>Wed, 31 Oct 2012 06:22:26 +0000</created>
                <updated>Thu, 24 Jan 2013 18:41:02 +0000</updated>
                            <resolved>Thu, 24 Jan 2013 18:41:02 +0000</resolved>
                                    <version>5.8.0</version>
                                    <fixVersion>5.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13487577" author="stirlingc" created="Wed, 31 Oct 2012 06:26:43 +0000"  >&lt;p&gt;Unit test that demonstrates bug by failing an assertion resulting from the duplicate/unexpected subscription propagation.&lt;/p&gt;</comment>
                            <comment id="13487580" author="stirlingc" created="Wed, 31 Oct 2012 06:29:01 +0000"  >&lt;p&gt;Patch that, once applied, allows AMQ4148Test to pass.&lt;/p&gt;</comment>
                            <comment id="13561839" author="tabish121" created="Thu, 24 Jan 2013 18:40:00 +0000"  >&lt;p&gt;Does indeed appear to be an issue.  I tweaked the test a bit to ensure it doesn&apos;t fail because it didn&apos;t sleep long enough, and also ensure it doesn&apos;t hang on shutdown.  &lt;/p&gt;</comment>
                            <comment id="13561842" author="tabish121" created="Thu, 24 Jan 2013 18:41:02 +0000"  >&lt;p&gt;Nice investigation, applied the patch and an updated version of the test. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12551495" name="AMQ4148.patch" size="916" author="stirlingc" created="Wed, 31 Oct 2012 06:29:01 +0000"/>
                            <attachment id="12551494" name="AMQ4148Test.java" size="3216" author="stirlingc" created="Wed, 31 Oct 2012 06:26:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>253260</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 43 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0dcv3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>76013</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>