<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:32:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6005] Slave broker startup corrupts shared PList storage</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6005</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;h4&gt;&lt;a name=&quot;Background&quot;&gt;&lt;/a&gt;Background&lt;/h4&gt;

&lt;p&gt;When multiple JVMs run AMQ in a master/slave configuration with the broker directory in a shared filesystem location (as is required e.g. for kahaPersistence), and when due to high message volume or slow producers the broker&apos;s memory needs exceed the configured memory usage limit, AMQ will overflow asynchronous messages to a PList store inside the &quot;tmp_storage&quot; subdirectory of said shared broker directory.&lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;Issue&quot;&gt;&lt;/a&gt;Issue&lt;/h4&gt;

&lt;p&gt;We frequently observed this tmpDB store getting corrupted with &quot;stale NFS filehandle&quot; errors for tmpDB.data, tmpDB.redo, and some journal files, all of which suddenly went missing from the tmp_storage folder. This puts the entire broker into a bad state from which it cannot recover. Only restarting the service (which causes a broker slave to take over and loses the yet-undelivered messages) gets a working state back.&lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;Symptoms&quot;&gt;&lt;/a&gt;Symptoms&lt;/h4&gt;

&lt;p&gt;Stack trace:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;...
Caused by: java.io.IOException: Stale file handle
	at java.io.RandomAccessFile.readBytes0(Native Method)
	at java.io.RandomAccessFile.readBytes(RandomAccessFile.java:350)
	at java.io.RandomAccessFile.read(RandomAccessFile.java:385)
	at java.io.RandomAccessFile.readFully(RandomAccessFile.java:444)
	at java.io.RandomAccessFile.readFully(RandomAccessFile.java:424)
	at org.apache.kahadb.page.PageFile.readPage(PageFile.java:876)
	at org.apache.kahadb.page.Transaction$2.readPage(Transaction.java:446)
	at org.apache.kahadb.page.Transaction$2.&amp;lt;init&amp;gt;(Transaction.java:437)
	at org.apache.kahadb.page.Transaction.openInputStream(Transaction.java:434)
	at org.apache.kahadb.page.Transaction.load(Transaction.java:410)
	at org.apache.kahadb.page.Transaction.load(Transaction.java:367)
	at org.apache.kahadb.index.ListIndex.loadNode(ListIndex.java:306)
	at org.apache.kahadb.index.ListIndex.getHead(ListIndex.java:99)
	at org.apache.kahadb.index.ListIndex.iterator(ListIndex.java:284)
	at org.apache.activemq.store.kahadb.plist.PList$PListIterator.&amp;lt;init&amp;gt;(PList.java:199)
	at org.apache.activemq.store.kahadb.plist.PList.iterator(PList.java:189)
	at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor$DiskIterator.&amp;lt;init&amp;gt;(FilePendingMessageCursor.java:496)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h4&gt;&lt;a name=&quot;Cause&quot;&gt;&lt;/a&gt;Cause&lt;/h4&gt;

&lt;p&gt;During BrokerThread startup, the BrokerService.startPersistenceAdapter() method is called, which  via doStartPersistenceAdapter() and getProducerSystemUsage() invokes getSystemUsage(), that calls getTempDataStore(), and that method summarily cleans out the existing contents of the tmp_storage directory.&lt;br/&gt;
All of this happens &lt;b&gt;before&lt;/b&gt; the broker lock is obtained in the PersistenceAdapter.start() method at the end of doStartPersistenceAdapter().&lt;/p&gt;

&lt;p&gt;So a JVM that doesn&apos;t get to be the broker (because there already is one) and runs in slave mode (waiting to obtain the broker lock) interferes with and corrupts the running broker&apos;s tmp_storage and thus breaks the broker. That&apos;s a critical bug. The slave has no business starting up the persistence adapter and cleaning out data as it hasn&apos;t gotten the lock yet, so isn&apos;t allowed to do any work, period. &lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;Workaround&quot;&gt;&lt;/a&gt;Workaround&lt;/h4&gt;

&lt;p&gt;As workaround, an unshared local directory needs to be specified as tempDirectory for the broker, even if the main broker directory is shared. Also, since broker startup will clear the tmp_storage out anyway, there really is no advantage to having this in a shared location - since the next broker that starts up after a broker failure will never re-use that data anyway.&lt;/p&gt;</description>
                <environment>&lt;p&gt;RHLinux6&lt;/p&gt;</environment>
        <key id="12903653">AMQ-6005</key>
            <summary>Slave broker startup corrupts shared PList storage</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="volkerk">Volker Kleinschmidt</reporter>
                        <labels>
                    </labels>
                <created>Fri, 9 Oct 2015 08:02:46 +0000</created>
                <updated>Thu, 10 Dec 2015 15:52:52 +0000</updated>
                            <resolved>Thu, 10 Dec 2015 14:26:43 +0000</resolved>
                                    <version>5.7.0</version>
                    <version>5.10.0</version>
                                    <fixVersion>5.13.1</fixVersion>
                    <fixVersion>5.14.0</fixVersion>
                                    <component>KahaDB</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14953113" author="tabish121" created="Mon, 12 Oct 2015 13:27:18 +0000"  >&lt;p&gt;Have you tested against the latest release, 5.10 is relatively old at this point.  &lt;/p&gt;</comment>
                            <comment id="14954334" author="volkerk" created="Tue, 13 Oct 2015 04:01:09 +0000"  >&lt;p&gt;Not yet - we have an AMQ 5.12 upgrade in the pipeline, but not in production use yet, and this problem is only reproduced in production use, since you need to create quite a few asynchronous topic messages to even get to use tmp_storage - while there&apos;s few messages they all stay in memory and this issue doesn&apos;t arise. Plus you need a multi-server environment. So this isn&apos;t easily reproduced in the lab.&lt;/p&gt;

&lt;p&gt;However the relevant code has not changed in 5.12, I&apos;ve verified that. It&apos;s all in one class and should be easy enough to follow the outline in the ticket description. I&apos;ve added some additional detail to make it easier to follow.&lt;/p&gt;</comment>
                            <comment id="14967709" author="volkerk" created="Wed, 21 Oct 2015 19:20:54 +0000"  >&lt;p&gt;Also, to replicate the source of the problem, you can simply hand-create empty tmpDB.data, tmpDB.redo, and db-1.log files in the shared tmp_storage folder, then restart one of the slave nodes while the master broker is still running - you will see that those files get deleted by the slave startup, which would corrupt the master broker&apos;s tmpDB if it were currently using it. So for issue replication it&apos;s not necessary to actually create enough asynchronous message load to be using tmp_storage - it&apos;s the tmpDB deletion by a &lt;b&gt;slave&lt;/b&gt; that is the problem.&lt;/p&gt;

&lt;p&gt;I should also note that we&apos;d originally been seeing this in action only when using JDBC persistence (where there&apos;s technically no need for a shared dataDirectory at all anymore). With kahaPersistence things used to go south before ever reaching this point, due to unreliable file locking over NFS, so we&apos;ve moved away from that.&lt;br/&gt;
(Update: it does happen with kahaPersistence too, seen it just recently, with 160 GB of error logging as a result)&lt;/p&gt;</comment>
                            <comment id="15051027" author="jira-bot" created="Thu, 10 Dec 2015 14:25:51 +0000"  >&lt;p&gt;Commit 768fa17085ac938441915a82987c99b37ac52515 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=768fa17&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=768fa17&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6005&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6005&lt;/a&gt; - have plist whack it existing state on start. Start the temp store after the primary persistence adapter which does the locking&lt;/p&gt;</comment>
                            <comment id="15051030" author="gtully" created="Thu, 10 Dec 2015 14:26:43 +0000"  >&lt;p&gt;clearing out temp store is deferred till temp store start which is now done after locking by primary store&lt;/p&gt;</comment>
                            <comment id="15051052" author="jira-bot" created="Thu, 10 Dec 2015 14:49:00 +0000"  >&lt;p&gt;Commit 9e8f0203015dd842ecc0804231da9a62ed3b02ec in activemq&apos;s branch refs/heads/activemq-5.13.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=9e8f020&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=9e8f020&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6005&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6005&lt;/a&gt; - have plist whack it existing state on start. Start the temp store after the primary persistence adapter which does the locking&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 768fa17085ac938441915a82987c99b37ac52515)&lt;/p&gt;</comment>
                            <comment id="15051137" author="volkerk" created="Thu, 10 Dec 2015 15:52:52 +0000"  >&lt;p&gt;Thanks for the fix, much appreciated!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 49 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mswf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>