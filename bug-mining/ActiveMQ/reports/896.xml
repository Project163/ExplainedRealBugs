<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:45:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2651] prefetchExtension off-by-1 for transacted consumers with prefetchSize &gt; 0</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2651</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Linked to forum discussion: &lt;a href=&quot;http://old.nabble.com/prefetchExtension-off-by-1-for-transacted-consumers-with-prefetchSize-%3E-0-ts27866123.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://old.nabble.com/prefetchExtension-off-by-1-for-transacted-consumers-with-prefetchSize-%3E-0-ts27866123.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I&apos;ve searched the forum and JIRA and have noticed that the prefetchExtension in PrefetchSubscription has caused grief before.  However, I think there&apos;s still a problem.&lt;/p&gt;

&lt;p&gt;First, I understand the purpose of the prefetchExtension for the case when prefetchSize = 0.  It allows messages to be dispatched to the consumer when the consumer requests them (i.e. polls them).  However, I don&apos;t really understand the purpose of the prefetchExtension for the cases when prefetchSize &amp;gt; 0.  If the consumer has set the prefetchSize to x, shouldn&apos;t it always receive only x messages at a time?  Why is the prefetchSize being extended?  I see that it is only extended in the case when the message delivery is transacted but I still don&apos;t understand why this is necessary.&lt;/p&gt;

&lt;p&gt;In any case, assuming the prefetchExtension is necessary in the case of prefetchSize &amp;gt; 0 and transacted message delivery, I think the calculation of the prefetchExtension in this case has an off-by-1 error.  I am attaching a junit test that illustrates this problem.&lt;/p&gt;

&lt;p&gt;The test is basically acting like a JCA Resource Adapter and sets up an asynchronous message listener by creating a ConnectionConsumer with a maxMessages value of 1.  This translates into a PrefetchSubscription with a prefetchSize of 1.  The test then sends 3 messages.  The purpose of the 1st message is to trigger the prefetch extension logic in PrefetchSubscription upon the message&apos;s ack.  When this happens, the prefetchExtension is set to 1 and the prefetchSize essentially becomes 2.  I believe this is incorrect and is the off-by-1 error (assuming the prefetchExtension is required at all in this case).  The 2nd message is simulated to be a long running message so that when the 3rd message is dispatched, the 2nd message is still being processed.  When the 3rd message is dispatched, because the prefetchSize has been extended, it will try to deliver it even though the processing of the 2nd message has not been completed and even though maxMessages on the ConnectionConsumer was specified as 1.&lt;/p&gt;

&lt;p&gt;Now, if I only have 1 ServerSession in the ServerSessionPool, this behavior seems to violate the JMS Spec since the maxMessages parameter used during ConnectionConsumer creation is defined as &quot;the maximum number of messages that can be assigned to a server session at one time&quot; and ActiveMQ is trying to assign 2 messages to the same ServerSession at the same time. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12483428">AMQ-2651</key>
            <summary>prefetchExtension off-by-1 for transacted consumers with prefetchSize &gt; 0</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="rodos77">Eugene Rodos</reporter>
                        <labels>
                    </labels>
                <created>Mon, 15 Mar 2010 21:22:57 +0000</created>
                <updated>Thu, 2 May 2013 02:29:43 +0000</updated>
                            <resolved>Tue, 20 Apr 2010 15:17:16 +0000</resolved>
                                    <version>5.3.0</version>
                                    <fixVersion>5.4.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12942355" author="rodos77" created="Mon, 15 Mar 2010 21:24:56 +0000"  >&lt;p&gt;Attaching junit test.&lt;/p&gt;</comment>
                            <comment id="12942406" author="rodos77" created="Thu, 15 Apr 2010 15:45:24 +0000"  >&lt;p&gt;Patch attached.&lt;/p&gt;</comment>
                            <comment id="12942475" author="gtully" created="Tue, 20 Apr 2010 15:17:16 +0000"  >&lt;p&gt;resolved in r935954&lt;/p&gt;

&lt;p&gt;policyEntry.usePrefetchExtension allows the prefetch extension behaviur to be disabled. When false, and with prefetch of 1 or X, a new message will only be dispatched when the message is acked, rather than when it is delivered. When false, a client ack consumer  or transacted consumer will only ever get prefetch (X) number messages. &lt;/p&gt;

&lt;p&gt;code example of it disabled from the test:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        PolicyMap policyMap = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PolicyMap();
        PolicyEntry defaultEntry = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PolicyEntry();
        &lt;span class=&quot;code-comment&quot;&gt;// ensure prefetch is exact. only delivery next when current is acked
&lt;/span&gt;        defaultEntry.setUsePrefetchExtension(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        policyMap.setDefaultEntry(defaultEntry);
        broker.setDestinationPolicy(policyMap);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12483708">AMQ-2652</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12461666" name="ASF.LICENSE.NOT.GRANTED--UsePrefetchExtension_Option.patch" size="4616" author="rodos77" created="Thu, 15 Apr 2010 15:45:24 +0000"/>
                            <attachment id="12461656" name="OnePrefetchAsyncConsumerTest.java" size="7479" author="rodos77" created="Mon, 15 Mar 2010 21:24:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>65689</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 32 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rq6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>159885</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>