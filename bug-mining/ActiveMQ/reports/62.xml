<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:30:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-718] Incorrect length specification in loose encoding?</title>
                <link>https://issues.apache.org/jira/browse/AMQ-718</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Unless loose-encoded length is mean to mean something different from tight-encoded length, I believe that the length written to the wire for loosely-encoded OpenWire messages is off by 4.  I imagine this hasn&apos;t been caught before because most clients synchronously read packets off the wire and so can ignore the length specification.&lt;/p&gt;

&lt;p&gt;&amp;#8212; activemq-core/src/main/java/org/apache/activemq/openwire/OpenWireFormat.java        (revision 399408)&lt;br/&gt;
+++ activemq-core/src/main/java/org/apache/activemq/openwire/OpenWireFormat.java        (working copy)&lt;br/&gt;
@@ -172,7 +172,7 @@&lt;br/&gt;
                     sequence = baos.toByteSequence();&lt;/p&gt;

&lt;p&gt;                     if( !sizePrefixDisabled ) &lt;/p&gt;
{
-                        size = sequence.getLength()-4;
+                        size = sequence.getLength();
                         ByteArrayPacket packet = new ByteArrayPacket(sequence);
                         PacketData.writeIntBig(packet, size);
                     }
&lt;p&gt;@@ -253,7 +253,7 @@&lt;br/&gt;
                 if( !sizePrefixDisabled ) &lt;/p&gt;
{
                     looseOut.close();
                     ByteSequence sequence = baos.toByteSequence();
-                    dataOut.writeInt(sequence.getLength()-4);
+                    dataOut.writeInt(sequence.getLength());
                     dataOut.write(sequence.getData(), sequence.getOffset(), sequence.getLength());
                 }
</description>
                <environment></environment>
        <key id="12481691">AMQ-718</key>
            <summary>Incorrect length specification in loose encoding?</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chirino">Hiram R. Chirino</assignee>
                                    <reporter username="andrewlu">Andrew Lusk</reporter>
                        <labels>
                    </labels>
                <created>Mon, 22 May 2006 13:06:41 +0000</created>
                <updated>Wed, 31 May 2006 01:37:31 +0000</updated>
                            <resolved>Wed, 31 May 2006 01:37:31 +0000</resolved>
                                    <version>4.0 RC2</version>
                    <version>4.0 RC3</version>
                    <version>4.0</version>
                                    <fixVersion>4.0</fixVersion>
                                    <component>Transport</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12937649" author="jstrachan" created="Mon, 22 May 2006 18:29:54 +0000"  >&lt;p&gt;added versions&lt;/p&gt;</comment>
                            <comment id="12937671" author="chirino" created="Mon, 22 May 2006 22:02:17 +0000"  >&lt;p&gt;Good find..  I think it&apos;s worth delaying the 4.0 release to fix this.&lt;/p&gt;</comment>
                            <comment id="12937941" author="chirino" created="Mon, 22 May 2006 22:40:37 +0000"  >&lt;p&gt;oh.  I think I may read this too quickly.&lt;/p&gt;

&lt;p&gt;I just reviewed the code, and the size field is consistent in usage in both the loose and tight encoding.  They size written is the number of bytes that will follow.&lt;/p&gt;</comment>
                            <comment id="12937955" author="chirino" created="Mon, 22 May 2006 22:52:26 +0000"  >&lt;p&gt;As I see it both loose and tight encoding prefix the size of the playload.&lt;/p&gt;

&lt;p&gt;So the total size of a command when it is encoding to bytes would be 4+1+size-of-payload which corresponds to the size-of-payload, type, and payload.&lt;/p&gt;

&lt;p&gt;This is true for both loose and tight encoding.  If I&apos;m wrong please let me know.&lt;/p&gt;</comment>
                            <comment id="12938128" author="andrewlu" created="Tue, 23 May 2006 00:31:18 +0000"  >&lt;p&gt;FWIW, my understanding is that size-of-payload includes the type byte, but not the size bytes.  Correct?  (see int size=1 on OpenWireFormat.java:223).&lt;/p&gt;

&lt;p&gt;I think it may be right in one instance and wrong in another.&lt;/p&gt;

&lt;p&gt;Using this code as an example, from OpenWireFormat.java:242:&lt;/p&gt;

&lt;p&gt;               DataOutputStream looseOut = dataOut;&lt;br/&gt;
                ByteArrayOutputStream baos=null;&lt;/p&gt;

&lt;p&gt;                if( !sizePrefixDisabled ) &lt;/p&gt;
{
                        baos = new ByteArrayOutputStream();
                        looseOut = new DataOutputStream(baos);
                }

&lt;p&gt;                looseOut.writeByte(type);&lt;br/&gt;
                dsm.looseMarshal(this, c, looseOut);&lt;/p&gt;

&lt;p&gt;                if( !sizePrefixDisabled ) &lt;/p&gt;
{
                    looseOut.close();
                    ByteSequence sequence = baos.toByteSequence();
                    dataOut.writeInt(sequence.getLength()-4);
                    dataOut.write(sequence.getData(), sequence.getOffset(), sequence.getLength());
                }

&lt;p&gt;Nowhere was the size written into &quot;baos&quot; yet 4 is being subtracted from its size to put the size on the wire.  In another location in the file (the other overload of marshal() :&lt;/p&gt;

&lt;p&gt;                    ByteArrayOutputStream baos = new ByteArrayOutputStream();&lt;br/&gt;
                    DataOutputStream ds = new DataOutputStream(baos);&lt;br/&gt;
                    if( !sizePrefixDisabled ) &lt;/p&gt;
{
                        ds.writeInt(0); // we don&apos;t know the final size yet but write this here for now.
                    }
&lt;p&gt;                    ds.writeByte(type);&lt;br/&gt;
                    dsm.looseMarshal(this, c, ds);&lt;br/&gt;
                    ds.close();&lt;br/&gt;
                    sequence = baos.toByteSequence();&lt;/p&gt;

&lt;p&gt;                    if( !sizePrefixDisabled ) &lt;/p&gt;
{
                        size = sequence.getLength()-4;
                        ByteArrayPacket packet = new ByteArrayPacket(sequence);
                        PacketData.writeIntBig(packet, size);
                    }
&lt;p&gt;                }&lt;/p&gt;

&lt;p&gt;In this case I think this code is right, since the size has been written in to that sequence.&lt;/p&gt;

&lt;p&gt;I&apos;ll revert the second case I mentioned and run my tests again.&lt;/p&gt;</comment>
                            <comment id="12937786" author="andrewlu" created="Tue, 23 May 2006 01:25:12 +0000"  >&lt;p&gt;OK, I&apos;ve verified that my code still works with just the first case I mentioned (in the marshal(Object, DataOutputStream) overload) patched.  The other case I believe is fine how it is.&lt;/p&gt;</comment>
                            <comment id="12937970" author="chirino" created="Tue, 23 May 2006 03:48:52 +0000"  >&lt;p&gt;Hi Adrew.. this stuf is not easy grok.. glad your keeping us honest.&lt;/p&gt;

&lt;p&gt;Your right, I stand corrected, the size field holds the size of the type+playload fields.  For a sec there I was thinking it only held the size of the payload.&lt;/p&gt;

&lt;p&gt;I now agree with your anyalisys that the original patch to line 253 is valid.  And also found that the sizePrefixDisabled option was not being honorred in the tight encoding case for that method.  This is the new patch what I will be applying shortly.&lt;/p&gt;

&lt;p&gt;Index: /Users/chirino/sandbox/activemq-4-branch/activemq-core/src/main/java/org/apache/activemq/openwire/OpenWireFormat.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; /Users/chirino/sandbox/activemq-4-branch/activemq-core/src/main/java/org/apache/activemq/openwire/OpenWireFormat.java	(revision 399345)&lt;br/&gt;
+++ /Users/chirino/sandbox/activemq-4-branch/activemq-core/src/main/java/org/apache/activemq/openwire/OpenWireFormat.java	(working copy)&lt;br/&gt;
@@ -233,11 +233,15 @@&lt;br/&gt;
 	            BooleanStream bs = new BooleanStream();&lt;br/&gt;
 	            size += dsm.tightMarshal1(this, c, bs);&lt;br/&gt;
 	            size += bs.marshalledSize(); &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;dataOut.writeInt(size);&lt;br/&gt;
+&lt;br/&gt;
+                if( !sizePrefixDisabled ) 
{
+                    dataOut.writeInt(size);
+                }
&lt;p&gt;+                &lt;br/&gt;
 	            dataOut.writeByte(type);            &lt;br/&gt;
 	            bs.marshal(dataOut);&lt;br/&gt;
 	            dsm.tightMarshal2(this, c, dataOut, bs);&lt;br/&gt;
+                &lt;br/&gt;
             } else {            	&lt;br/&gt;
             	DataOutputStream looseOut = dataOut;&lt;br/&gt;
             	ByteArrayOutputStream baos=null;&lt;br/&gt;
@@ -253,7 +257,7 @@&lt;br/&gt;
                 if( !sizePrefixDisabled ) &lt;/p&gt;
{
                     looseOut.close();
                     ByteSequence sequence = baos.toByteSequence();
-                    dataOut.writeInt(sequence.getLength()-4);
+                    dataOut.writeInt(sequence.getLength());
                     dataOut.write(sequence.getData(), sequence.getOffset(), sequence.getLength());
                 }&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="12937744" author="chirino" created="Tue, 23 May 2006 05:44:02 +0000"  >&lt;p&gt;Patch commited.  Thanks  Andrew!&lt;/p&gt;</comment>
                            <comment id="12938031" author="chirino" created="Wed, 31 May 2006 01:37:08 +0000"  >&lt;p&gt;fixing in 4.0&lt;/p&gt;</comment>
                            <comment id="12937846" author="chirino" created="Wed, 31 May 2006 01:37:31 +0000"  >&lt;p&gt;recut 4.0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84295</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            19 years, 27 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i17zov:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>254752</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>