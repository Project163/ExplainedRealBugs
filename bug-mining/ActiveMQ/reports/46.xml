<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:30:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-677] ActiveMQ broker leaks advisory topics</title>
                <link>https://issues.apache.org/jira/browse/AMQ-677</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;When I run the attached code, which AFAIK is completely legal JMS, the ActiveMQ broker grows to 500+ mb and crashes due to being out of heap space.  &lt;/p&gt;

&lt;p&gt;Some investigation with hprof has lead me to believe that the advisory topics created by the MessageConsumers (and Producers, but I use the same producer each time so that&apos;s not causing a problem) are being put into a DestinationMap and not being removed.&lt;/p&gt;

&lt;p&gt;The rough origin of this is in the addProducer call in AdvisoryBroker, which creates the advisory topic.&lt;/p&gt;

&lt;p&gt;Note that this memory is not freed when the DestinationInfo removing the original temptopic is received, nor when the actual client exits.  The object lifetime of these advisory destinations seems very poorly defined.  If they are implicitly created by the server, they should be implicitly destroyed by the same.&lt;/p&gt;

&lt;p&gt;To reproduce, I&apos;ve been running this code with -Dtopic=true and -Dmax=10000 (though the problem shows up well before this amount).  This is just a modified version of the example ProducerTool (note it doesn&apos;t actually send any messages).&lt;/p&gt;

&lt;p&gt;Please verify the correctness of the attached code.&lt;/p&gt;

&lt;p&gt;Andrew Lusk&lt;/p&gt;</description>
                <environment>&lt;p&gt;linux, near-trunk version of ActiveMQ&lt;/p&gt;</environment>
        <key id="12481642">AMQ-677</key>
            <summary>ActiveMQ broker leaks advisory topics</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="andrewlu">Andrew Lusk</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Apr 2006 06:45:41 +0000</created>
                <updated>Mon, 1 May 2006 22:34:04 +0000</updated>
                            <resolved>Mon, 1 May 2006 22:34:04 +0000</resolved>
                                                    <fixVersion>4.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12937923" author="andrewlu" created="Thu, 6 Apr 2006 14:51:50 +0000"  >&lt;p&gt;I have reproduced this problem in svn trunk (previously I was a few weeks behind).&lt;/p&gt;</comment>
                            <comment id="12937733" author="andrewlu" created="Sat, 8 Apr 2006 06:12:07 +0000"  >&lt;p&gt;Adding this line:&lt;/p&gt;

&lt;p&gt;next.removeDestination(context, AdvisorySupport.getConsumerAdvisoryTopic(info.getDestination()), timeout);&lt;/p&gt;

&lt;p&gt;below the fireAdvisory call in AdvisoryBroker::removeDestination appears to solve this problem, but at the cost of a very severe performance decrease.  &lt;/p&gt;

&lt;p&gt;Would really appreciate traction from someone more familiar with this particular code.&lt;/p&gt;</comment>
                            <comment id="12937854" author="andrewlu" created="Sat, 8 Apr 2006 06:25:26 +0000"  >&lt;p&gt;Another solution that I&apos;ve found to work, with no performance penalty, is to simple not create / send on advisory topics for temporary destinations.  I&apos;m  not sure if this might break something else internally though.&lt;/p&gt;</comment>
                            <comment id="12937614" author="rajdavies" created="Sat, 8 Apr 2006 15:10:57 +0000"  >&lt;p&gt;destinations that don&apos;t exist are added by calling the broker stack from the top to add the destination - which we don&apos;t need to do for advisories &lt;/p&gt;</comment>
                            <comment id="12937677" author="rajdavies" created="Sun, 9 Apr 2006 06:47:39 +0000"  >&lt;p&gt;added fix suggested&lt;/p&gt;</comment>
                            <comment id="12937763" author="andrewlu" created="Sun, 9 Apr 2006 09:29:16 +0000"  >&lt;p&gt;I got a fresh snapshot of trunk after your latest patch, and tested it with the code I attached above.  It still exhibits this memory bloat problem, after several thousand iterations.  Did this code work for you with this fix?&lt;/p&gt;

&lt;p&gt;Also, the fix that was put in only removes consumer advisory topics, when producer advisory topics are just as much of a problem.  The fix will also crash when info == null (when I mentioned putting that line in just after the fireAdvisory call, I meant still within the checked info != null block).&lt;/p&gt;

&lt;p&gt;The code I provided was a stopgap solution that caused other serious problems for me (and maybe only worked because I was a few weeks back from trunk).  In my tree I&apos;m going with the second thing I mentioned (not creating advisory topics for temporary destinations) which is working fine for me while I work on investigating some other issues that have come up with higher numbers of iterations.&lt;/p&gt;</comment>
                            <comment id="12937688" author="rajdavies" created="Mon, 10 Apr 2006 16:16:56 +0000"  >&lt;p&gt;I&apos;ve checked in some updates and ran the program through JProfiler - I can&apos;t see any memory leaks.&lt;br/&gt;
Re - performance - usual practice is to create only a few (1 preferably) temp destination and use selectors - as the creation of any managed resource (consumer/producer/session/connection/destination is heavy compared to sending/selecting messages)&lt;/p&gt;</comment>
                            <comment id="12937804" author="rajdavies" created="Mon, 10 Apr 2006 19:19:27 +0000"  >&lt;p&gt;correction - there&apos;s still a memory leak - gonna track it down &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12937835" author="andrewlu" created="Tue, 11 Apr 2006 04:08:02 +0000"  >&lt;p&gt;The lines you added in r392929 throw an exception in the broker and crash my ProducerTool on the first iteration, since producer advisory topics and consumer advisory topics are unconditionally closed, when in the case of the above attached code it doesn&apos;t create any producers on the temporary topic, only consumers.&lt;/p&gt;

&lt;p&gt;Please verify the fix on the above attached ProducerTool with -Dtopic=true and -Dmax=10000.  It has always very readily reproduced this problem.&lt;/p&gt;

&lt;p&gt;INFO  Service                        - Sync error occurred: javax.jms.JMSException: Destination does not exist: topic://ActiveMQ.Advisory.Producer.Topic.ID:andrewlu-33101-1144699546209-0:0:1&lt;br/&gt;
javax.jms.JMSException: Destination does not exist: topic://ActiveMQ.Advisory.Producer.Topic.ID:andrewlu-33101-1144699546209-0:0:1&lt;br/&gt;
        at org.apache.activemq.broker.region.RegionBroker.removeDestination(RegionBroker.java:216)&lt;br/&gt;
        at org.apache.activemq.broker.BrokerFilter.removeDestination(BrokerFilter.java:129)&lt;br/&gt;
        at org.apache.activemq.advisory.AdvisoryBroker.removeDestinationInfo(AdvisoryBroker.java:180)&lt;br/&gt;
        at org.apache.activemq.broker.BrokerFilter.removeDestinationInfo(BrokerFilter.java:204)&lt;br/&gt;
        at org.apache.activemq.broker.MutableBrokerFilter.removeDestinationInfo(MutableBrokerFilter.java:214)&lt;br/&gt;
        at org.apache.activemq.broker.AbstractConnection.processRemoveDestination(AbstractConnection.java:376)&lt;br/&gt;
        at org.apache.activemq.command.DestinationInfo.visit(DestinationInfo.java:122)&lt;br/&gt;
        at org.apache.activemq.broker.AbstractConnection.service(AbstractConnection.java:196)&lt;br/&gt;
        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:62)&lt;br/&gt;
        at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:93)&lt;br/&gt;
        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:70)&lt;br/&gt;
        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:114)&lt;br/&gt;
        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:122)&lt;br/&gt;
        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:87)&lt;br/&gt;
        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:139)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:595)&lt;/p&gt;</comment>
                            <comment id="12937704" author="chirino" created="Mon, 1 May 2006 22:34:04 +0000"  >&lt;p&gt;Fixed in latest snapshot.  I was also able to run your ProducerTool without issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12460727" name="ASF.LICENSE.NOT.GRANTED--ProducerTool.java" size="5285" author="andrewlu" created="Thu, 6 Apr 2006 06:45:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>49303</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            19 years, 31 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i17zmn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>254742</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>