<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:58:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4366] PooledConnectionFactory closes connections that are in use</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4366</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;&lt;tt&gt;PooledConnectionFactory&lt;/tt&gt; closes connections that are still referenced and should not be closed. Happens only when connection idle or expire time passes. Calling &lt;tt&gt;createConnection&lt;/tt&gt; after that time will invalidate the connection and all previously obtained &lt;tt&gt;Sessions&lt;/tt&gt; will behave as closed.&lt;/p&gt;

&lt;p&gt;Due to default 30 second idle timeout, it is likely not to cause problems when:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;connection is continually in use&lt;/li&gt;
	&lt;li&gt;all &lt;tt&gt;PooledConnection&lt;/tt&gt; s are borrowed at startup&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Client with session whose connection was prematurely closed will see similar stacktrace:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;javax.jms.IllegalStateException: The Session is closed
                at org.apache.activemq.ActiveMQSession.checkClosed(ActiveMQSession.java:731)
                at org.apache.activemq.ActiveMQSession.configureMessage(ActiveMQSession.java:719)
                at org.apache.activemq.ActiveMQSession.createBytesMessage(ActiveMQSession.java:316)
                at org.apache.activemq.pool.PooledSession.createBytesMessage(PooledSession.java:168)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="12636075">AMQ-4366</key>
            <summary>PooledConnectionFactory closes connections that are in use</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="pjanata">Petr Janata</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Mar 2013 16:58:14 +0000</created>
                <updated>Thu, 23 Feb 2017 15:48:17 +0000</updated>
                            <resolved>Fri, 8 Mar 2013 20:07:11 +0000</resolved>
                                    <version>5.7.0</version>
                    <version>5.8.0</version>
                                    <fixVersion>5.9.0</fixVersion>
                                    <component>Pool</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="13597294" author="pjanata" created="Fri, 8 Mar 2013 17:07:52 +0000"  >&lt;p&gt;Patch against 5.7.0 tag with testcase that reproduces the issue and poor fix.&lt;/p&gt;</comment>
                            <comment id="13597298" author="tabish121" created="Fri, 8 Mar 2013 17:10:44 +0000"  >&lt;p&gt;Thanks, I&apos;ll take a look.&lt;/p&gt;</comment>
                            <comment id="13597425" author="tabish121" created="Fri, 8 Mar 2013 19:22:35 +0000"  >&lt;p&gt;Looking at the code a bit I think part of the problem here is that Idle timeout seems to be considered even when there are references to the ConnectionPool which would go against the stated purpose of IdleTimeout which is to close out Connection&apos;s that have sat unused.  If a reference is active then the ConnectionPool shouldn&apos;t be considered inactive since some Session is open and could be in use.  Only expiry timeout should be considered regardless of reference count if I understand that setting correctly, the doco is a bit vague. &lt;/p&gt;</comment>
                            <comment id="13597496" author="tabish121" created="Fri, 8 Mar 2013 20:07:11 +0000"  >&lt;p&gt;Should be fixed now.&lt;/p&gt;</comment>
                            <comment id="13619630" author="tmielke" created="Tue, 2 Apr 2013 08:47:05 +0000"  >&lt;p&gt;A proper workaround for any 5.7 and 5.8 versioned clients seems to be to disable the session idle timeout on the ConnectionFactory using PooledConnectionFactory.setIdleTimeout(0).&lt;/p&gt;</comment>
                            <comment id="13621564" author="boday" created="Thu, 4 Apr 2013 00:14:40 +0000"  >&lt;p&gt;alright, can I assume that when this occurs the message is being rolled back/replayed rather than being lost (assuming AUTO_ACK, non-tx mode)?&lt;/p&gt;

&lt;p&gt;any other side-effects of the proposed workaround of setting the idelTimeout to 0 (inefficient connection/session mgmt, etc)?&lt;/p&gt;

&lt;p&gt;any plans to backport it to a minor release of 5.7 or 5.8?&lt;/p&gt;</comment>
                            <comment id="13626330" author="tmielke" created="Tue, 9 Apr 2013 07:23:40 +0000"  >&lt;p&gt;I am not aware of any side effects when applying the workaround and setting idleTimeout=0. &lt;br/&gt;
As a consequence sessions won&apos;t be invalidated just because they were idle for a specific period of time. But that should generally not be a problem. &lt;br/&gt;
I had a customer testing this idleTimeout=0 in their integration test env and it did not cause any problems. &lt;/p&gt;

&lt;p&gt;Also, its my understanding that you generally should not loose any messages due to the &quot;The Session is closed&quot; error. &lt;br/&gt;
Typically the session is checked for validity right &lt;b&gt;before&lt;/b&gt; sending the message. You app code of course needs to handle the error and should not assume that the msg was sent.&lt;/p&gt;

</comment>
                            <comment id="14343186" author="dvhv_sekhar" created="Mon, 2 Mar 2015 14:27:45 +0000"  >&lt;p&gt;we are using ActiveMQ version 5.10. Is this fix available in 5.10? or should we use the workaround of setting idleTimeout=0. &lt;/p&gt;</comment>
                            <comment id="14343384" author="tmielke" created="Mon, 2 Mar 2015 16:58:44 +0000"  >&lt;p&gt;Yes, 5.10 will include the fix for this bug. &lt;/p&gt;</comment>
                            <comment id="15880678" author="raphiki" created="Thu, 23 Feb 2017 15:48:17 +0000"  >&lt;p&gt;An expired connection is now not closed if used by an other thread but there is nothing preventing the loan of an expiryConnection isn&apos;t it ?&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;http://grepcode.com/file/repo1.maven.org/maven2/org.apache.activemq/activemq-jms-pool/5.11.0/org/apache/activemq/jms/pool/PooledConnectionFactory.java#236&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;connectionPool.borrow()&lt;/a&gt; just call the expiryCheck() throught the &lt;a href=&quot;http://grepcode.com/file/repo1.maven.org/maven2/org.apache.activemq/activemq-jms-pool/5.11.0/org/apache/activemq/jms/pool/PooledConnectionFactory.java#135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;validateObject()&lt;/a&gt; method but it considers the connection valid (and so reusable) if it has expired but has still some remaining reference...&lt;/p&gt;

&lt;p&gt;On my environment my expiryTimeout of 60 seconds is rarely reached (unless I assign a connection for each consumer but I can&apos;t do that in production environment).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12572783" name="poolConClose.diff" size="3126" author="pjanata" created="Fri, 8 Mar 2013 17:07:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>316567</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 38 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1imiv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>316909</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>