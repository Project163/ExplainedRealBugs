<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:52:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3404] Purge command does not accept message selectors</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3404</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;The admin purge command does not work with a message selector.&lt;br/&gt;
A patch is forth coming, there is some cleanup, and compliance to be vetted before I can attach the patch.&lt;/p&gt;

&lt;p&gt;(1) Browse with no arguments:&lt;/p&gt;

&lt;p&gt;user@activemq-master:~/activemq$ activemq-admin browse --amqurl tcp://localhost:61616  --view JMSTimestamp queue.FOO.BAR&lt;/p&gt;

&lt;p&gt;Java Runtime: Sun Microsystems Inc. 1.6.0_22&lt;br/&gt;
/home/y/libexec/jdk1.6.0/jre&lt;br/&gt;
   Heap sizes: current=60800k  free=58531k  max=902976k&lt;br/&gt;
     JVM args: -Dactivemq.classpath=&quot;&quot; &lt;br/&gt;
     -Djavax.net.ssl.trustStoreType=JKS&lt;/p&gt;

&lt;p&gt;ACTIVEMQ_HOME: /home/y/libexec/activemq&lt;br/&gt;
ACTIVEMQ_BASE: /home/y/libexec/activemq&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608108263&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608108740&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608109283&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608109790&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608110324&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608110831&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608111374&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608111872&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608112415&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608113005&lt;/p&gt;



&lt;p&gt;(2) Browse with msgsel&lt;/p&gt;

&lt;p&gt;user@activemq-master:~/activemq$ activemq-admin browse --amqurl tcp://localhost:61616  --view JMSTimestamp --msgsel &apos;JMSTimestamp&amp;lt;1310608110324&apos; queue.FOO.BAR&lt;/p&gt;

&lt;p&gt;Java Runtime: Sun Microsystems Inc. 1.6.0_22&lt;br/&gt;
/home/y/libexec/jdk1.6.0/jre&lt;br/&gt;
   Heap sizes: current=60800k  free=58535k  max=902976k&lt;br/&gt;
     JVM args: -Dactivemq.classpath=&quot;&quot;&lt;br/&gt;
     -Djavax.net.ssl.trustStoreType=JKS&lt;/p&gt;

&lt;p&gt;ACTIVEMQ_HOME: /home/y/libexec/activemq&lt;br/&gt;
ACTIVEMQ_BASE: /home/y/libexec/activemq&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608108263&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608108740&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608109283&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608109790&lt;/p&gt;

&lt;p&gt;(3) Purge with msgsel: - Not Working -  (what I wanted here was to use only those&lt;br/&gt;
matching my criteria)&lt;/p&gt;

&lt;p&gt;user@activemq-master:~/activemq$ activemq-admin purge --msgsel &apos;JMSTimestamp&amp;lt;1310608110324&apos; queue.FOO.BAR&lt;/p&gt;

&lt;p&gt;Java Runtime: Sun Microsystems Inc. 1.6.0_22&lt;br/&gt;
/home/y/libexec/jdk1.6.0/jre&lt;br/&gt;
   Heap sizes: current=60800k  free=58531k  max=902976k&lt;br/&gt;
     JVM args: -Dactivemq.classpath=&quot;&quot; &lt;br/&gt;
     -Djavax.net.ssl.trustStoreType=JKS&lt;/p&gt;

&lt;p&gt;ACTIVEMQ_HOME: /home/y/libexec/activemq&lt;br/&gt;
ACTIVEMQ_BASE: /home/y/libexec/activemq&lt;/p&gt;

&lt;p&gt;Connecting to JMX URL:&lt;br/&gt;
service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi&lt;br/&gt;
INFO: Removing message:&lt;br/&gt;
ID:activemq-master-55970-1309958858075-2:32:1:1:1&lt;br/&gt;
from queue: queue.FOO.BAR&lt;br/&gt;
INFO: Removing message:&lt;br/&gt;
ID:activemq-master-55970-1309958858075-2:32:1:1:2&lt;br/&gt;
from queue: queue.FOO.BAR&lt;br/&gt;
INFO: Removing message:&lt;br/&gt;
ID:activemq-master-55970-1309958858075-2:32:1:1:3&lt;br/&gt;
from queue: queue.FOO.BAR&lt;br/&gt;
INFO: Removing message:&lt;br/&gt;
ID:activemq-master-55970-1309958858075-2:32:1:1:4&lt;br/&gt;
from queue: queue.FOO.BAR&lt;br/&gt;
INFO: Removing message:&lt;br/&gt;
ID:activemq-master-55970-1309958858075-2:32:1:1:5&lt;br/&gt;
from queue: queue.FOO.BAR&lt;br/&gt;
INFO: Removing message:&lt;br/&gt;
ID:activemq-master-55970-1309958858075-2:32:1:1:6&lt;br/&gt;
from queue: queue.FOO.BAR&lt;br/&gt;
INFO: Removing message:&lt;br/&gt;
ID:activemq-master-55970-1309958858075-2:32:1:1:7&lt;br/&gt;
from queue: queue.FOO.BAR&lt;br/&gt;
INFO: Removing message:&lt;br/&gt;
ID:activemq-master-55970-1309958858075-2:32:1:1:8&lt;br/&gt;
from queue: queue.FOO.BAR&lt;br/&gt;
INFO: Removing message:&lt;br/&gt;
ID:activemq-master-55970-1309958858075-2:32:1:1:9&lt;br/&gt;
from queue: queue.FOO.BAR&lt;br/&gt;
INFO: Removing message:&lt;br/&gt;
ID:activemq-master-55970-1309958858075-2:32:1:1:10&lt;br/&gt;
from queue: queue.FOO.BAR&lt;/p&gt;


&lt;p&gt;(4) Purge with msgsel working with a patch:&lt;/p&gt;

&lt;p&gt;user@activemq-master:~/activemq$ activemq-admin browse --amqurl tcp://localhost:61616  --view JMSTimestamp --msgsel &apos;JMSTimestamp&amp;lt;1310608391914&apos; queue.FOO.BAR&lt;/p&gt;

&lt;p&gt;Java Runtime: Sun Microsystems Inc. 1.6.0_22&lt;br/&gt;
/home/y/libexec/jdk1.6.0/jre&lt;br/&gt;
   Heap sizes: current=60800k  free=58535k  max=902976k&lt;br/&gt;
     JVM args: -Dactivemq.classpath=&quot;&quot; &lt;br/&gt;
     -Djavax.net.ssl.trustStoreType=JKS&lt;/p&gt;

&lt;p&gt;ACTIVEMQ_HOME: /home/y/libexec/activemq&lt;br/&gt;
ACTIVEMQ_BASE: /home/y/libexec/activemq&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608389116&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608389607&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608390266&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608390781&lt;/p&gt;

&lt;p&gt;JMS_HEADER_FIELD:JMSTimestamp = 1310608391390&lt;/p&gt;



&lt;p&gt;user@activemq-master:~/activemq$ ./activemq-admin purge  --msgsel &apos;JMSTimestamp&amp;lt;1310608391914&apos;  queue.FOO.BAR &lt;/p&gt;

&lt;p&gt;Java Runtime: Sun Microsystems Inc. 1.6.0_22&lt;br/&gt;
/home/y/libexec/jdk1.6.0/jre&lt;br/&gt;
   Heap sizes: current=60800k  free=58575k  max=902976k&lt;br/&gt;
     JVM args: -Dactivemq.classpath=&quot;&quot; &lt;/p&gt;

&lt;p&gt;     -Djavax.net.ssl.trustStoreType=JKS&lt;/p&gt;

&lt;p&gt;ACTIVEMQ_HOME: /home/y/libexec/activemq&lt;br/&gt;
ACTIVEMQ_BASE: /home/y/libexec/activemq&lt;/p&gt;

&lt;p&gt;Connecting to JMX URL:&lt;br/&gt;
service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi&lt;br/&gt;
INFO: Addobjects is :&lt;span class=&quot;error&quot;&gt;&amp;#91;JMSTimestamp&amp;lt;1310608391914&amp;#93;&lt;/span&gt;&lt;br/&gt;
INFO: Removing message:&lt;br/&gt;
ID:activemq-master-55970-1309958858075-2:33:1:1:1&lt;br/&gt;
from queue: queue.FOO.BAR&lt;br/&gt;
INFO: Removing message:&lt;br/&gt;
ID:activemq-master-55970-1309958858075-2:33:1:1:2&lt;br/&gt;
from queue: queue.FOO.BAR&lt;br/&gt;
INFO: Removing message:&lt;br/&gt;
ID:activemq-master-55970-1309958858075-2:33:1:1:3&lt;br/&gt;
from queue: queue.FOO.BAR&lt;br/&gt;
INFO: Removing message:&lt;br/&gt;
ID:activemq-master-55970-1309958858075-2:33:1:1:4&lt;br/&gt;
from queue: queue.FOO.BAR&lt;br/&gt;
INFO: Removing message:&lt;br/&gt;
ID:activemq-master-55970-1309958858075-2:33:1:1:5&lt;br/&gt;
from queue: queue.FOO.BAR&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12514469">AMQ-3404</key>
            <summary>Purge command does not accept message selectors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="areese">Allen Reese</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Jul 2011 17:11:44 +0000</created>
                <updated>Fri, 16 Dec 2011 11:41:22 +0000</updated>
                            <resolved>Fri, 16 Dec 2011 11:41:22 +0000</resolved>
                                    <version>5.5.0</version>
                                    <fixVersion>5.6.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13068432" author="areese" created="Wed, 20 Jul 2011 15:20:49 +0000"  >&lt;p&gt;The correct fix is to use a QueryViewMbean:&lt;/p&gt;

&lt;p&gt;//                        List messages = JmxMBeansUtil.createMessageQueryFilter(createJmxConnection(), queueName).query(queryAddObjects);&lt;br/&gt;
//                        purgeMessages(queueName, messages);&lt;br/&gt;
						QueueViewMBean proxy = (QueueViewMBean) MBeanServerInvocationHandler&lt;br/&gt;
								.newProxyInstance(createJmxConnection(),&lt;br/&gt;
										queueName, QueueViewMBean.class, true);&lt;br/&gt;
						int removed = 0;&lt;br/&gt;
						for (String remove : queryAddObjects) &lt;/p&gt;
{
							removed = proxy.removeMatchingMessages(remove);
							context.printInfo(&quot;Removed: &quot; + removed
									+ &quot; messages for msgsel&quot; + remove);
						}
&lt;p&gt;                    }&lt;br/&gt;
A patch and test is forthcoming, but -xmsgsel will not work with this patch&lt;/p&gt;</comment>
                            <comment id="13068711" author="areese" created="Wed, 20 Jul 2011 23:27:54 +0000"  >&lt;p&gt;Patch to fix this issue, with a test cases that fails before and passes afterwards.&lt;/p&gt;

&lt;p&gt;License on test code comes from copying other test code, specifically org.apache.activemq.network.jms.QueueBridgeTest&lt;/p&gt;</comment>
                            <comment id="13068885" author="dejanb" created="Thu, 21 Jul 2011 10:08:55 +0000"  >&lt;p&gt;Patch applied with svn revision 1149095. Thanks!&lt;/p&gt;</comment>
                            <comment id="13071272" author="areese" created="Tue, 26 Jul 2011 18:41:17 +0000"  >&lt;p&gt;This works for me, and is complete.&lt;/p&gt;</comment>
                            <comment id="13108512" author="gtully" created="Tue, 20 Sep 2011 10:56:09 +0000"  >&lt;p&gt;reopen to set fix version to 5.6&lt;/p&gt;</comment>
                            <comment id="13108557" author="gtully" created="Tue, 20 Sep 2011 11:01:35 +0000"  >&lt;p&gt;closing again with correct fix version&lt;/p&gt;</comment>
                            <comment id="13169457" author="tmielke" created="Wed, 14 Dec 2011 15:50:07 +0000"  >&lt;p&gt;I need to reopen this bug.&lt;/p&gt;

&lt;p&gt;The proposed fix has a problem. When multiple message selector criteria are specified using a comma separated list, as in &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;--msgsel &lt;span class=&quot;code-quote&quot;&gt;&quot;JMSMessageID=&lt;span class=&quot;code-quote&quot;&gt;&apos;*:10&apos;&lt;/span&gt;,JMSPriority&amp;gt;5&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;then the current fix maps the criteria using an OR logical operator as this code shows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;PurgeCommand.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void runTask(List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; tokens) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
  ...
  &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; remove : queryAddObjects) {
	removed = proxy.removeMatchingMessages(remove);
	context.printInfo(&lt;span class=&quot;code-quote&quot;&gt;&quot;Removed: &quot;&lt;/span&gt; + removed
		+ &lt;span class=&quot;code-quote&quot;&gt;&quot; messages &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; msgsel&quot;&lt;/span&gt; + remove);
  }
  ...
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This code iterates through each message selector criteria and removes the messages that matches each criteria individually.&lt;/p&gt;

&lt;p&gt;Instead comma separated selector criteria should be treated as an AND operator. The usage output for activem-admin purge -help and activemq-admin browse -help suggests this and its also the way how activemq-admin browse behaves. &lt;/p&gt;


&lt;p&gt;Proposing a new fix including an updated TestPurgeCommand.java test.&lt;/p&gt;

&lt;p&gt;This fix works with the ActiveMQ specific message selector syntax, e.g. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   --msgsel &lt;span class=&quot;code-quote&quot;&gt;&quot;JMSMessageID=&lt;span class=&quot;code-quote&quot;&gt;&apos;*:10&apos;&lt;/span&gt;,JMSPriority&amp;gt;5&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;but also with an SQL92 syntax specified on command line, e.g. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
   --msgsel &lt;span class=&quot;code-quote&quot;&gt;&quot;(JMSMessageID=&lt;span class=&quot;code-quote&quot;&gt;&apos;*:10&apos;&lt;/span&gt;) AND (JMSPriority&amp;gt;5)&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13169458" author="tmielke" created="Wed, 14 Dec 2011 15:51:17 +0000"  >&lt;p&gt;Attaching a possible fix in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3404&quot; title=&quot;Purge command does not accept message selectors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3404&quot;&gt;&lt;del&gt;AMQ-3404&lt;/del&gt;&lt;/a&gt;.patch and would like to get some confirmation that this solution is good before I commit this fix.&lt;/p&gt;

&lt;p&gt;Any feedback appreciated.&lt;/p&gt;</comment>
                            <comment id="13170148" author="dejanb" created="Thu, 15 Dec 2011 12:01:39 +0000"  >&lt;p&gt;This patch looks OK to me&lt;/p&gt;</comment>
                            <comment id="13170324" author="areese" created="Thu, 15 Dec 2011 16:17:22 +0000"  >&lt;p&gt;Looks good to me.  I missed the sql92, and the , operator when I first did this.&lt;/p&gt;</comment>
                            <comment id="13170920" author="tmielke" created="Fri, 16 Dec 2011 11:41:22 +0000"  >&lt;p&gt;Fixed in revision 1215056.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12507370" name="AMQ-3404.patch" size="13552" author="tmielke" created="Wed, 14 Dec 2011 15:51:17 +0000"/>
                            <attachment id="12487233" name="PurgeCommand.patch" size="15802" author="areese" created="Wed, 20 Jul 2011 23:27:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>60053</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 49 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0aj6v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59382</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>