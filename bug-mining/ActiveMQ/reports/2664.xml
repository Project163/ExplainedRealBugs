<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:23:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4361] Deadlock during close while publishing to flow-controlled queue</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4361</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;TestCase on github: &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/samhendley/activemq-close-deadlock-bug&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/samhendley/activemq-close-deadlock-bug&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The deadlock occurs when we are using TcpTransport to a flow-controlled queue and we then try to gracefully shutdown the application. The close operation hangs forever because it is trying to send a &quot;close packet&quot; to the server. It never gets the chance to send that request because the socket is blocked by the publishing thread. This stops my publisher from shutting down and causes us to orphan threads during shutdown.&lt;/p&gt;

&lt;p&gt;I have verified this bug occurs on atleast activemq 5.6.0 and 5.8.0 and on linux and windows using JDK 1.6.&lt;/p&gt;

&lt;p&gt;I don&apos;t need a fix for the bug necessarily, just a way to gracefully shutdown my publisher if I get into this state.&lt;/p&gt;

&lt;p&gt;Partial Stack Trace During failure&lt;br/&gt;
&quot;ClosingThread&quot; prio=6 tid=0x045ce000 nid=0xa84 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x04ddf000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: WAITING (parking)&lt;br/&gt;
    at sun.misc.Unsafe.park(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;parking to wait for  &amp;lt;0x23fc52d8&amp;gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)&lt;br/&gt;
    at java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)&lt;br/&gt;
    at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:811)&lt;br/&gt;
    at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:842)&lt;br/&gt;
    at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1178)&lt;br/&gt;
    at java.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:186)&lt;br/&gt;
    at java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:262)&lt;br/&gt;
    at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:66)&lt;br/&gt;
    at org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60)&lt;br/&gt;
    at org.apache.activemq.ActiveMQConnection.doAsyncSendPacket(ActiveMQConnection.java:1304)&lt;br/&gt;
    at org.apache.activemq.ActiveMQConnection.asyncSendPacket(ActiveMQConnection.java:1298)&lt;br/&gt;
    at org.apache.activemq.ActiveMQSession.asyncSendPacket(ActiveMQSession.java:1901)&lt;br/&gt;
    at org.apache.activemq.ActiveMQMessageProducer.close(ActiveMQMessageProducer.java:173)&lt;br/&gt;
    at org.activemq.bug.DeadlockDuringCloseTest$2.run(DeadlockDuringCloseTest.java:83)&lt;br/&gt;
    at java.lang.Thread.run(Thread.java:662)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&quot;PublishingThread&quot; prio=6 tid=0x045cd800 nid=0xb84 runnable &lt;span class=&quot;error&quot;&gt;&amp;#91;0x04d8f000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;br/&gt;
    at java.net.SocketOutputStream.socketWrite0(Native Method)&lt;br/&gt;
    at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:92)&lt;br/&gt;
    at java.net.SocketOutputStream.write(SocketOutputStream.java:136)&lt;br/&gt;
    at org.apache.activemq.transport.tcp.TcpBufferedOutputStream.flush(TcpBufferedOutputStream.java:115)&lt;br/&gt;
    at java.io.DataOutputStream.flush(DataOutputStream.java:106)&lt;br/&gt;
    at org.apache.activemq.transport.tcp.TcpTransport.oneway(TcpTransport.java:176)&lt;br/&gt;
    at org.apache.activemq.transport.AbstractInactivityMonitor.doOnewaySend(AbstractInactivityMonitor.java:322)&lt;br/&gt;
    at org.apache.activemq.transport.AbstractInactivityMonitor.oneway(AbstractInactivityMonitor.java:304)&lt;br/&gt;
    at org.apache.activemq.transport.TransportFilter.oneway(TransportFilter.java:85)&lt;br/&gt;
    at org.apache.activemq.transport.WireFormatNegotiator.oneway(WireFormatNegotiator.java:104)&lt;br/&gt;
    at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:68)&lt;br/&gt;
    at org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60)&lt;br/&gt;
    at org.apache.activemq.ActiveMQConnection.doAsyncSendPacket(ActiveMQConnection.java:1304)&lt;br/&gt;
    at org.apache.activemq.ActiveMQConnection.asyncSendPacket(ActiveMQConnection.java:1298)&lt;br/&gt;
    at org.apache.activemq.ActiveMQSession.send(ActiveMQSession.java:1782)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked &amp;lt;0x23faa7d8&amp;gt; (a java.lang.Object)&lt;br/&gt;
    at org.apache.activemq.ActiveMQMessageProducer.send(ActiveMQMessageProducer.java:289)&lt;br/&gt;
    at org.apache.activemq.ActiveMQMessageProducer.send(ActiveMQMessageProducer.java:224)&lt;br/&gt;
    at org.apache.activemq.ActiveMQMessageProducerSupport.send(ActiveMQMessageProducerSupport.java:300)&lt;br/&gt;
    at org.activemq.bug.DeadlockDuringCloseTest$1.run(DeadlockDuringCloseTest.java:63)&lt;br/&gt;
    at java.lang.Thread.run(Thread.java:662)&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>&lt;p&gt;Windows, Linux, JDK 1.6&lt;/p&gt;</environment>
        <key id="12635662">AMQ-4361</key>
            <summary>Deadlock during close while publishing to flow-controlled queue</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="shendley">Sam hendley</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Mar 2013 21:02:10 +0000</created>
                <updated>Thu, 22 Oct 2015 14:51:16 +0000</updated>
                            <resolved>Wed, 3 Apr 2013 19:23:58 +0000</resolved>
                                    <version>5.6.0</version>
                    <version>5.8.0</version>
                                    <fixVersion>5.9.0</fixVersion>
                                    <component>JMS client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13595224" author="ceposta" created="Wed, 6 Mar 2013 22:43:00 +0000"  >&lt;p&gt;We can definitely check into this bug, but when sending async (or non-persistent) like you are, you may wish to consider using producer windows so you don&apos;t run into this type of producer flow control which blocks the entire connection.&lt;/p&gt;

&lt;p&gt;See here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://activemq.apache.org/producer-flow-control.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/producer-flow-control.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13595234" author="tabish121" created="Wed, 6 Mar 2013 22:53:43 +0000"  >&lt;p&gt;You should be able to interrupt the Thread that&apos;s blocked in the sync send call so that the application can shutdown normally.&lt;/p&gt;</comment>
                            <comment id="13595245" author="shendley" created="Wed, 6 Mar 2013 23:01:53 +0000"  >&lt;p&gt;I had tried both of those tricks before without fixing the issue. The key was to do both at the same time. By turning on producer windowing I am not blocking on a socket write which means the Thread.interrupt will work because we blocking on a regular lock. I&apos;ll update the example project showing the workaround. That solves my immediate issue, is this otherwise considered a &quot;wont fix&quot;?&lt;/p&gt;</comment>
                            <comment id="13595248" author="shendley" created="Wed, 6 Mar 2013 23:03:27 +0000"  >&lt;p&gt;To be clear: Thread.interrupt() while in SocketOutputStream.socketWrite doesn&apos;t work. I needed to be in the &quot;window blocking&quot; for thread.interrupt to work.&lt;/p&gt;</comment>
                            <comment id="13595254" author="tabish121" created="Wed, 6 Mar 2013 23:09:44 +0000"  >&lt;p&gt;You&apos;re welcome to figure out a clever fix and submit a patch, not sure there&apos;s a whole lot that can be done in this case. &lt;/p&gt;</comment>
                            <comment id="13595953" author="shendley" created="Thu, 7 Mar 2013 15:11:43 +0000"  >&lt;p&gt;So it makes sense to me why the non-producer window version blocks; native socket writes don&apos;t react to thread.interrupt(). I can&apos;t think of a way around that problem. The only thing I would imagine helping is to default to the other strategy and then require people to opt-in to this more dangerous (and less performant?) mode.&lt;/p&gt;

&lt;p&gt;However I was annoyed by the fact I need a Thread.interrupt even with the other version. This means I need to add an extra level of synchronized bookkeeping to perform a clean shutdown. I dug into the source code of activemq and the issue is there is a tight wait loop in org.apache.activemq.usage.MemoryUsage where it only checks the &quot;percentUsed&quot; field. I believe it should also look at the &quot;started&quot; field and bail if the usage counter has been stopped. I have to imagine that was what the developers of that class were planning, on the stop method they notify on the same mutex to wake up all the listeners (presumably so they can bail quickly). I looked at all of the implementations of Usage and they all seem to have the same issue. Shouldn&apos;t they all check &quot;started&quot; and bail if the condition they are trying to reach can never be reached?&lt;/p&gt;</comment>
                            <comment id="13595957" author="tabish121" created="Thu, 7 Mar 2013 15:17:59 +0000"  >&lt;p&gt;Create a test case and propose a patch to the issue, we can review it and see if it makes sense / doesn&apos;t break anything.  Sounds like something that would be a benefit.  &lt;/p&gt;</comment>
                            <comment id="13621235" author="tabish121" created="Wed, 3 Apr 2013 19:23:58 +0000"  >&lt;p&gt;Fixed the MemoryUsage waitForSpace code throws an InterruptedException so that the windowed producer send will throw an JMSException when the Producer is closed.  &lt;/p&gt;</comment>
                            <comment id="14969183" author="shendley" created="Thu, 22 Oct 2015 13:53:41 +0000"  >&lt;p&gt;We recently updated to 5.12.0 and a test I had put in place to track the &quot;higher level&quot; shutdown started failing occasionally. I still haven&apos;t worked out the cause of that but I did try enabling ProducerWindowSize to verify the fix to this bug. So technically it closes quickly but it is throwing an IllegalMonitorStateException. There is a bug in the waitForSpace method where we don&apos;t relock the readLock if the waitForSpaceCondition throws.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.IllegalMonitorStateException: attempt to unlock read lock, not locked by current thread
	at java.util.concurrent.locks.ReentrantReadWriteLock$Sync.unmatchedUnlockException(ReentrantReadWriteLock.java:447)
	at java.util.concurrent.locks.ReentrantReadWriteLock$Sync.tryReleaseShared(ReentrantReadWriteLock.java:431)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.releaseShared(AbstractQueuedSynchronizer.java:1340)
	at java.util.concurrent.locks.ReentrantReadWriteLock$ReadLock.unlock(ReentrantReadWriteLock.java:883)
	at org.apache.activemq.usage.MemoryUsage.waitForSpace(MemoryUsage.java:87)
	at org.apache.activemq.ActiveMQMessageProducer.send(ActiveMQMessageProducer.java:282)
	at org.apache.activemq.ActiveMQMessageProducer.send(ActiveMQMessageProducer.java:223)
	at org.apache.activemq.ActiveMQMessageProducerSupport.send(ActiveMQMessageProducerSupport.java:269)
	at org.springframework.jms.connection.CachedMessageProducer.send(CachedMessageProducer.java:181)
	at org.springframework.jms.core.JmsTemplate.doSend(JmsTemplate.java:636)
	at org.springframework.jms.core.JmsTemplate.doSend(JmsTemplate.java:607)
	at org.springframework.jms.core.JmsTemplate$3.doInJms(JmsTemplate.java:572)
	at org.springframework.jms.core.JmsTemplate.execute(JmsTemplate.java:494)
	at org.springframework.jms.core.JmsTemplate.send(JmsTemplate.java:569)
	at org.springframework.jms.core.JmsTemplate.send(JmsTemplate.java:560)
	at com.sms.jms.FastInterruptibleSingleDestinationJmsOutClient.send(FastInterruptibleSingleDestinationJmsOutClient.java:77)
	at com.sms.jms.FastInterruptibleSingleDestinationJmsOutClient.publishAsBytesMessage(FastInterruptibleSingleDestinationJmsOutClient.java:68)
	at com.sms.jms.FastInterruptibleSingleDestinationJmsOutClientTest$2.run(FastInterruptibleSingleDestinationJmsOutClientTest.java:83)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744)}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; waitForSpace(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; timeout) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (parent != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!parent.waitForSpace(timeout)) {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            }
        }
        usageLock.readLock().lock();
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (percentUsage &amp;gt;= 100) {
                usageLock.readLock().unlock();
                usageLock.writeLock().lock();
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (percentUsage &amp;gt;= 100 ) {
                        waitForSpaceCondition.await(timeout, TimeUnit.MILLISECONDS);
                    }
                    &lt;span class=&quot;code-comment&quot;&gt;// I believe &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; relocking needs to be in the &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; block.
&lt;/span&gt;                    usageLock.readLock().lock();
                } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
                    usageLock.writeLock().unlock();
                }
            }

            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; percentUsage &amp;lt; 100;
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            usageLock.readLock().unlock();
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14969252" author="jira-bot" created="Thu, 22 Oct 2015 14:50:24 +0000"  >&lt;p&gt;Commit 9ddd162d2584f39c8e3b303db91dc43143381ecc in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=9ddd162&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=9ddd162&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4361&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-4361&lt;/a&gt; - implement suggestion from Sam hendley with thanks, avoid the IllegalMonitorStateException&lt;/p&gt;</comment>
                            <comment id="14969255" author="gtully" created="Thu, 22 Oct 2015 14:51:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shendley&quot; class=&quot;user-hover&quot; rel=&quot;shendley&quot;&gt;shendley&lt;/a&gt; thanks, sorted that IllegalMonitorStateException&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>316155</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 4 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ijzj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>316498</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>