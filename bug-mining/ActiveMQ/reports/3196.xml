<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:44:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-7067] KahaDB Recovery can experience a dangling transaction when prepare and commit occur on different data files.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-7067</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;KahaDB Recovery can experience a dangling transaction when prepare and commit occur on different data files.&lt;/p&gt;

&lt;p&gt;Scenario:&lt;/p&gt;

&lt;p&gt;A XA Transaction is started, message is prepared and sent into Broker.&lt;/p&gt;

&lt;p&gt;We then send into broker enough messages to file page file (100 message with 512 * 1024 characters in message payload). This forces a new&#160;data file to be created.&lt;/p&gt;

&lt;p&gt;Commit the XA transaction. Commit will land on the new&#160;data file.&lt;/p&gt;

&lt;p&gt;Restart the Broker.&lt;/p&gt;

&lt;p&gt;Upon restart a KahaDB recovery is executed.&lt;/p&gt;

&lt;p&gt;The prepare in PageFile 1 is not matched to Commit on PageFile 2, as such, it will appear in recovered message state.&lt;/p&gt;

&lt;p&gt;Looking deeper into this scenario, it appears that the commit message is GC&apos;d, hence the prepare &amp;amp; commit can not be matched.&lt;/p&gt;

&lt;p&gt;The MessageDatabase only checks the following for GC:&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#808080&quot;&gt;// Don&apos;t GC files referenced by in-progress tx&lt;/font&gt;&lt;font color=&quot;#cc7832&quot;&gt;if &lt;/font&gt;(inProgressTxRange&lt;span class=&quot;error&quot;&gt;&amp;#91;&lt;font color=&quot;#6897bb&quot;&gt;0&lt;/font&gt;&amp;#93;&lt;/span&gt; != &lt;font color=&quot;#cc7832&quot;&gt;null&lt;/font&gt;) {&lt;br/&gt;
 &lt;font color=&quot;#cc7832&quot;&gt;for &lt;/font&gt;(&lt;font color=&quot;#cc7832&quot;&gt;int &lt;/font&gt;pendingTx=inProgressTxRange&lt;span class=&quot;error&quot;&gt;&amp;#91;&lt;font color=&quot;#6897bb&quot;&gt;0&lt;/font&gt;&amp;#93;&lt;/span&gt;.getDataFileId()&lt;font color=&quot;#cc7832&quot;&gt;; &lt;/font&gt;pendingTx &amp;lt;= inProgressTxRange&lt;span class=&quot;error&quot;&gt;&amp;#91;&lt;font color=&quot;#6897bb&quot;&gt;1&lt;/font&gt;&amp;#93;&lt;/span&gt;.getDataFileId()&lt;font color=&quot;#cc7832&quot;&gt;; &lt;/font&gt;pendingTx++) {&lt;br/&gt;
 gcCandidateSet.remove(pendingTx)&lt;font color=&quot;#cc7832&quot;&gt;;&lt;/font&gt; }&lt;br/&gt;
 }&lt;/p&gt;

&lt;p&gt;We need to become aware of where the prepare &amp;amp; commits occur in pagefiles with respect to GCing files.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13189438">AMQ-7067</key>
            <summary>KahaDB Recovery can experience a dangling transaction when prepare and commit occur on different data files.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="jgoodyear">Jamie Mark Goodyear</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Oct 2018 14:28:11 +0000</created>
                <updated>Wed, 24 Mar 2021 14:22:44 +0000</updated>
                            <resolved>Wed, 17 Oct 2018 17:18:45 +0000</resolved>
                                    <version>5.15.6</version>
                                    <fixVersion>5.15.7</fixVersion>
                    <fixVersion>5.16.0</fixVersion>
                                    <component>KahaDB</component>
                    <component>XA</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16638417" author="jgoodyear" created="Thu, 4 Oct 2018 15:52:02 +0000"  >&lt;p&gt;Please see the amq7067 unit test.&lt;/p&gt;

&lt;p&gt;This patch is for AMQ 5.15.x branch.&lt;/p&gt;

&lt;p&gt;You can execute using the following command:&lt;br/&gt;
&#160;mvn -Dtest=AMQ7067Test test&lt;/p&gt;


&lt;p&gt;Keeping original comment for history:&lt;/p&gt;

&lt;p&gt;I&apos;ve attached a stand alone test case to reproduce the issue.&lt;/p&gt;

&lt;p&gt;Here&apos;s how to use the test case:&lt;/p&gt;

&lt;p&gt;0. Setup AMQ 5.15.6 broker on local system. Use default configuration, no special settings required. Start broker.&lt;br/&gt;
 1. Extract AMQ7067 zip file.&lt;br/&gt;
 2. Run XATransactionTest while Broker is live using :&#160; mvn clean compile exec:java -Dexec.mainClass=&quot;XATransactionTest&quot;&lt;/p&gt;

&lt;p&gt;The test case will output:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; &#8212; exec-maven-plugin:1.6.0:java (default-cli) @ transaction &#8212;&lt;br/&gt;
 SLF4J: Class path contains multiple SLF4J bindings.&lt;br/&gt;
 SLF4J: Found binding in &lt;span class=&quot;error&quot;&gt;&amp;#91;jar:file:/Users/icbts/.m2/repository/org/apache/activemq/activemq-all/5.15.6/activemq-all-5.15.6.jar!/org/slf4j/impl/StaticLoggerBinder.class&amp;#93;&lt;/span&gt;&lt;br/&gt;
 SLF4J: Found binding in &lt;span class=&quot;error&quot;&gt;&amp;#91;jar:file:/Users/icbts/.m2/repository/org/slf4j/slf4j-log4j12/1.6.1/slf4j-log4j12-1.6.1.jar!/org/slf4j/impl/StaticLoggerBinder.class&amp;#93;&lt;/span&gt;&lt;br/&gt;
 SLF4J: See &lt;a href=&quot;http://www.slf4j.org/codes.html#multiple_bindings&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.slf4j.org/codes.html#multiple_bindings&lt;/a&gt; for an explanation.&lt;br/&gt;
 SLF4J: Actual binding is of type &lt;span class=&quot;error&quot;&gt;&amp;#91;org.slf4j.impl.Log4jLoggerFactory&amp;#93;&lt;/span&gt;&lt;br/&gt;
 createDanglingTransaction txid: XID:&lt;span class=&quot;error&quot;&gt;&amp;#91;55,globalId=ffffffffffffffffffffffffffffffffffffffe9ffffffb8fffffff7ffffffa1,branchId=ffffffffffffffffffffffffffffffffffffffe9ffffffb8fffffff7ffffffa1&amp;#93;&lt;/span&gt;&lt;br/&gt;
 createXATransaction txid: XID:&lt;span class=&quot;error&quot;&gt;&amp;#91;55,globalId=000015333ec,branchId=000015333ec&amp;#93;&lt;/span&gt;&lt;br/&gt;
 Pending Transactions 1: [XID:&lt;span class=&quot;error&quot;&gt;&amp;#91;55,globalId=ffffffffffffffffffffffffffffffffffffffe9ffffffb8fffffff7ffffffa1,branchId=ffffffffffffffffffffffffffffffffffffffe9ffffffb8fffffff7ffffffa1&amp;#93;&lt;/span&gt;]&lt;br/&gt;
 &#160;INFO | I/O exception (org.apache.http.NoHttpResponseException) caught when processing request to {}-&amp;gt;&lt;a href=&quot;http://localhost:8161:&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8161:&lt;/a&gt; The target server failed to respond&lt;br/&gt;
 &#160;INFO | Retrying request to {}-&amp;gt;&lt;a href=&quot;http://localhost:8161/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8161&lt;/a&gt;&lt;br/&gt;
 Pending Transactions 2: [XID:&lt;span class=&quot;error&quot;&gt;&amp;#91;55,globalId=ffffffffffffffffffffffffffffffffffffffe9ffffffb8fffffff7ffffffa1,branchId=ffffffffffffffffffffffffffffffffffffffe9ffffffb8fffffff7ffffffa1&amp;#93;&lt;/span&gt;, XID:&lt;span class=&quot;error&quot;&gt;&amp;#91;55,globalId=000015333ec,branchId=000015333ec&amp;#93;&lt;/span&gt;]&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;In the Broker log you&apos;ll see:&lt;/p&gt;

&lt;p&gt;&#160;INFO | KahaDB is version 6&lt;br/&gt;
 &#160;INFO | Recovering from the journal @1:741&lt;br/&gt;
 &#160;INFO | Recovery replayed 429 operations from the journal in 0.081 seconds.&lt;br/&gt;
 &#160;WARN | Recovered prepared XA TX: [XID:&lt;span class=&quot;error&quot;&gt;&amp;#91;55,globalId=ffffffffffffffffffffffffffffffffffffffe9ffffffb8fffffff7ffffffa1,branchId=ffffffffffffffffffffffffffffffffffffffe9ffffffb8fffffff7ffffffa1&amp;#93;&lt;/span&gt;]&lt;br/&gt;
 &#160;WARN | Recovered prepared XA TX: [XID:&lt;span class=&quot;error&quot;&gt;&amp;#91;55,globalId=000015333ec,branchId=000015333ec&amp;#93;&lt;/span&gt;]&lt;br/&gt;
 &#160;&lt;br/&gt;
 On JConsole you&apos;ll see two messages in org.apache.activemq &amp;gt; Broker &amp;gt; RecoveredXaTransaction MBean.&lt;/p&gt;

&lt;p&gt;Given we commit the transaction, I&apos;d expect there to not be a message in Recovered state.&lt;/p&gt;

&lt;p&gt;Note:&#160; If we do not send additional messages to force a new page file, than we do not see the message in Recovered state after broker restart.&lt;/p&gt;

&lt;p&gt;It appears to be that the prepared statement in db-1.log,. and commit in db-2.log will result in the commit getting GC&apos;d (hence no pare to match) and having the message being seen as being in prepared state, and hence getting recovered.&lt;/p&gt;</comment>
                            <comment id="16640066" author="githubbot" created="Fri, 5 Oct 2018 16:45:33 +0000"  >&lt;p&gt;GitHub user jgoodyear opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/302&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/302&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7067&quot; title=&quot;KahaDB Recovery can experience a dangling transaction when prepare and commit occur on different data files.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7067&quot;&gt;&lt;del&gt;AMQ-7067&lt;/del&gt;&lt;/a&gt; KahaDB Recovery can experience a dangling transaction when&#8230;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7067&quot; title=&quot;KahaDB Recovery can experience a dangling transaction when prepare and commit occur on different data files.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7067&quot;&gt;&lt;del&gt;AMQ-7067&lt;/del&gt;&lt;/a&gt; KahaDB Recovery can experience a dangling transaction when prepare and commit occur on different pagefiles.&lt;/p&gt;

&lt;p&gt;    Test cases added for Commit and Rollback on XA and Non-XA transactions.&lt;/p&gt;

&lt;p&gt;    Executed kahadb-store tests, activemq-unit-tests, and ran full build.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jgoodyear/activemq&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jgoodyear/activemq&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/302.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/302.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #302&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 2dabd858240dc3dc4341cceb1d28a61e5f440d1a&lt;br/&gt;
Author: jgoodyear &amp;lt;jamie.goodyear@...&amp;gt;&lt;br/&gt;
Date:   2018-10-05T16:34:21Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7067&quot; title=&quot;KahaDB Recovery can experience a dangling transaction when prepare and commit occur on different data files.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7067&quot;&gt;&lt;del&gt;AMQ-7067&lt;/del&gt;&lt;/a&gt; KahaDB Recovery can experience a dangling transaction when prepare and commit occur on different pagefiles.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16641757" author="gtully" created="Mon, 8 Oct 2018 12:29:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jgoodyear&quot; class=&quot;user-hover&quot; rel=&quot;jgoodyear&quot;&gt;jgoodyear&lt;/a&gt; I think the patch is on the right track but I think it needs some small mod.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The ack message file map can do what we need but I think it has to track the association between the prepare record location and the outcome (commit/rollback) location rather than the actual message or ack commands.&lt;/p&gt;

&lt;p&gt;ie: all of the transaction commands could be in one data file, the prepare in another and the outcome in a third. Tracking the link between the third and the first is not sufficient in this case. It should be possible to validate that with another test scenario.&lt;/p&gt;

&lt;p&gt;I think the prepare record location needs to be tracked in the in memory tx&#160;representation in some way to make it available to the outcome processor.&lt;/p&gt;</comment>
                            <comment id="16642067" author="jgoodyear" created="Mon, 8 Oct 2018 16:05:37 +0000"  >&lt;p&gt;Hi Gary,&lt;/p&gt;

&lt;p&gt;The crux of this patch is to prevent the GC of the PageFile such that on recovery&#160; Commit/Rollback can be processed as per existing logic.&#160; No changes to the existing processors is required. &lt;/p&gt;

&lt;p&gt;Please note, the problem was happening with Non-XA transactions as well, hence the addition of non-xa unit tests. The commit/rollback would get lost via GC, by updating the code to mark those index to not be GC&apos;d the behavoir is fixed for both XA and Non-XA transactions. Adding in a new structure and logic to track the TX lifeCycle would not touch the Non-XA transaction case.&lt;/p&gt;</comment>
                            <comment id="16642107" author="gtully" created="Mon, 8 Oct 2018 16:35:29 +0000"  >&lt;p&gt;In the xa case,&#160;I don&apos;t think the&#160;prepare record location is tracked, so it can get lost, leaving&#160;updates and a commit/rollback - which will barf. I am suggesting tracking the&#160;outcome record with the prepare location, and possibly with all of the updates.&lt;/p&gt;

&lt;p&gt;I had not considered the non xa case, in that case, the commit is all that is needed b/c the default will be to rollback. The commit outcome location needs to be linked to each of the&#160;update commands in turn.&lt;/p&gt;</comment>
                            <comment id="16642151" author="gtully" created="Mon, 8 Oct 2018 17:02:36 +0000"  >&lt;p&gt;I see that losing a prepare record after an outcome is still recoverable, once all of the updates are present.&lt;/p&gt;

&lt;p&gt;However I think that a prepare record needs to be tracked in case it falls outside of the current txRange or current write file.&lt;/p&gt;</comment>
                            <comment id="16642593" author="jgoodyear" created="Mon, 8 Oct 2018 23:21:39 +0000"  >&lt;p&gt;I&apos;ve updated the PR after our discussion on IRC.&lt;/p&gt;

&lt;p&gt;All locations are updated on commit/rollback/prepare.&lt;/p&gt;</comment>
                            <comment id="16643123" author="gtully" created="Tue, 9 Oct 2018 11:08:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jgoodyear&quot; class=&quot;user-hover&quot; rel=&quot;jgoodyear&quot;&gt;jgoodyear&lt;/a&gt; I have pushed your changes and some additional test tidy up and a prepare variant. Thank you.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/activemq/commit/57c7939534a927bfc2d1b0454aac7ef8d804532b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/commit/57c7939534a927bfc2d1b0454aac7ef8d804532b&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think ack compaction will need some follow on work b/c it won&apos;t be aware that the ackMessageFileMap now also has transaction locations, it will only move acks and I think will leave the journals candidates for gc again.&#160;&lt;/p&gt;

&lt;p&gt;As it stands ackCompaction should be disabled for this fix to be effective, until that is proven not to be the case or it is fixed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;There are some ackCompaction tests that can be combined with the recovery checks to validate.&#160;&lt;/p&gt;

&lt;p&gt;This issue should remain open till we get a resolution to that.&lt;/p&gt;</comment>
                            <comment id="16643136" author="christopher.l.shannon" created="Tue, 9 Oct 2018 11:17:01 +0000"  >&lt;p&gt;Shouldn&apos;t we just record the reference location update inside of the pageFile.tx() for the KahaCommitCommand case? This would do it under the write lock and also prevent having to iterate again plus then the change gets commited to the index in the transaciton.&#160; Ie, change:&#160;&lt;/p&gt;

&lt;p&gt;&#160;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;Operation&amp;gt; messagingTx = inflightTx;
    indexLock.writeLock().lock();
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        pageFile.tx().execute(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Transaction.Closure&amp;lt;IOException&amp;gt;() {
            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void execute(Transaction tx) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Operation op : messagingTx) {
                    op.execute(tx);
                }
            }
        });
        metadata.lastUpdate = location;
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        indexLock.writeLock().unlock();
    }
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Operation op: inflightTx) {
        recordAckMessageReferenceLocation(location, op.getLocation());
    }    
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;to:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;Operation&amp;gt; messagingTx = inflightTx;
    indexLock.writeLock().lock();
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        pageFile.tx().execute(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Transaction.Closure&amp;lt;IOException&amp;gt;() {
            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void execute(Transaction tx) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Operation op : messagingTx) {
                    op.execute(tx);
                    recordAckMessageReferenceLocation(location, op.getLocation());
                }
            }
        });
        metadata.lastUpdate = location;
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        indexLock.writeLock().unlock();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16643158" author="gtully" created="Tue, 9 Oct 2018 11:31:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; yes, good catch. I should be under that lock. The map does not get updated in the pagefile tx, just during checkpoints, but it does need to be protected from concurrent access.&lt;/p&gt;</comment>
                            <comment id="16643214" author="christopher.l.shannon" created="Tue, 9 Oct 2018 11:55:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; - and I guess that means we should also add a pageFile.tx() to do the updates in for the KahaPrepareCommand and KahaRollbackCommand as well right?&lt;/p&gt;

&lt;p&gt;And I think you are right that the Ack compaction stuff needs updating..the easiest thing is probably to just change the task so that it doesn&apos;t remove the forwarded journal file from the ackMessageFileMap if it contains a transaction command (normal GC should remove it if there are no open transactions remaining on that file)..this probably reduces the usefullness of ack compaction but I don&apos;t see a better way without expanding to rewrite all the other commands as well&lt;/p&gt;</comment>
                            <comment id="16643241" author="christopher.l.shannon" created="Tue, 9 Oct 2018 12:21:08 +0000"  >&lt;p&gt;I think maybe something like this would work for ack compaction but would need to test it out...I don&apos;t see any current tests for ack compaction&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/cshannon/activemq/commit/bb28cd0b647c52e8dc84b1740ab4d5ef1ca6198a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cshannon/activemq/commit/bb28cd0b647c52e8dc84b1740ab4d5ef1ca6198a&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16643245" author="gtully" created="Tue, 9 Oct 2018 12:22:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt; We just need the lock for protection, no tx, b/c the index is not updated.&lt;/p&gt;

&lt;p&gt;On the compaction, I think that is the simplest approach.&lt;/p&gt;

&lt;p&gt;Ideally we would have some sort of reference count on the referenced ids in the ackMessageFileMap - allowing each ack and outcome to be recorded and having some way to know there are just non ack references remaining.&lt;/p&gt;

&lt;p&gt;We don&apos;t need to retain everything. i.e.: the prepare record can go if there is an outcome, and if the outcome is rollback then both the prepare and rollback can go b/c recovery will default to rollback. For commit, both xa and non xa, it needs to be retained as long as the updates (add/ack commands).&lt;/p&gt;

&lt;p&gt;It will get complex fast however.&lt;/p&gt;

&lt;p&gt;Getting it correct first will suffice, which means retaining the transaction related commands. I will see if I can wrangle a test to reproduce to get the full context.&lt;/p&gt;</comment>
                            <comment id="16643252" author="christopher.l.shannon" created="Tue, 9 Oct 2018 12:25:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; - ok sounds good, having a test case to reproduce everything first will make it easier to validate any changes to ack compaction&lt;/p&gt;

&lt;p&gt;And you are right about the index not being updated, I just realized the ackMessageFileMap is marked as transient (i was thinking it was stored to disk during index updates)&lt;/p&gt;

&lt;p&gt;Also, based on your comment I&apos;m not sure my sample I linked above is good enough for the commit case. (we might end up removing those files if acks are moved and the transaction is commited and not in flight but the message add or commit commands exist not sure). So again having some tests will help tremendously to validate&lt;/p&gt;</comment>
                            <comment id="16643377" author="jgoodyear" created="Tue, 9 Oct 2018 12:57:11 +0000"  >&lt;p&gt;The following test case can be inserted into the AMQ7067Test file:&lt;br/&gt;
 &lt;a href=&quot;https://gist.github.com/jgoodyear/f3c716aec99c066894047ed996cdcdc9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/jgoodyear/f3c716aec99c066894047ed996cdcdc9&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Its a non-completing test, it just allows us to setup the scenario, load up a lot of db page files, than let compaction occur.&lt;/p&gt;

&lt;p&gt;In my IDEA environment i can watch the data folder populate:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
icbts-2:activemq-unit-tests icbts$ ls target/data/kahadb/
db-1.log&#160;&#160;&#160;&#160;&#160;&#160;&#160; db-115.log&#160;&#160;&#160;&#160;&#160; db-131.log&#160;&#160;&#160;&#160;&#160; db-148.log&#160;&#160;&#160;&#160;&#160; db-164.log&#160;&#160;&#160;&#160;&#160; db-180.log&#160;&#160;&#160;&#160;&#160; db-197.log&#160;&#160;&#160;&#160;&#160; db-212.log&#160;&#160;&#160;&#160;&#160; db-229.log&#160;&#160;&#160;&#160;&#160; db-245.log&#160;&#160;&#160;&#160;&#160; db-261.log&#160;&#160;&#160;&#160;&#160; db-278.log&#160;&#160;&#160;&#160;&#160; db-4.log&#160;&#160;&#160;&#160;&#160;&#160;&#160; db-56.log&#160;&#160;&#160;&#160;&#160;&#160; db-72.log&#160;&#160;&#160;&#160;&#160;&#160; db-89.log
db-10.log&#160;&#160;&#160;&#160;&#160;&#160; db-116.log&#160;&#160;&#160;&#160;&#160; db-132.log&#160;&#160;&#160;&#160;&#160; db-149.log&#160;&#160;&#160;&#160;&#160; db-165.log&#160;&#160;&#160;&#160;&#160; db-181.log&#160;&#160;&#160;&#160;&#160; db-198.log&#160;&#160;&#160;&#160;&#160; db-213.log&#160;&#160;&#160;&#160;&#160; db-23.log&#160;&#160;&#160;&#160;&#160;&#160; db-246.log&#160;&#160;&#160;&#160;&#160; db-262.log&#160;&#160;&#160;&#160;&#160; db-279.log&#160;&#160;&#160;&#160;&#160; db-40.log&#160;&#160;&#160;&#160;&#160;&#160; db-57.log&#160;&#160;&#160;&#160;&#160;&#160; db-73.log&#160;&#160;&#160;&#160;&#160;&#160; db-9.log
db-100.log&#160;&#160;&#160;&#160;&#160; db-117.log&#160;&#160;&#160;&#160;&#160; db-133.log&#160;&#160;&#160;&#160;&#160; db-15.log&#160;&#160;&#160;&#160;&#160;&#160; db-166.log&#160;&#160;&#160;&#160;&#160; db-182.log&#160;&#160;&#160;&#160;&#160; db-199.log&#160;&#160;&#160;&#160;&#160; db-214.log&#160;&#160;&#160;&#160;&#160; db-230.log&#160;&#160;&#160;&#160;&#160; db-247.log&#160;&#160;&#160;&#160;&#160; db-263.log&#160;&#160;&#160;&#160;&#160; db-28.log&#160;&#160;&#160;&#160;&#160;&#160; db-41.log&#160;&#160;&#160;&#160;&#160;&#160; db-58.log&#160;&#160;&#160;&#160;&#160;&#160; db-74.log&#160;&#160;&#160;&#160;&#160;&#160; db-90.log
db-101.log&#160;&#160;&#160;&#160;&#160; db-118.log&#160;&#160;&#160;&#160;&#160; db-134.log&#160;&#160;&#160;&#160;&#160; db-150.log&#160;&#160;&#160;&#160;&#160; db-167.log&#160;&#160;&#160;&#160;&#160; db-183.log&#160;&#160;&#160;&#160;&#160; db-2.log&#160;&#160;&#160;&#160;&#160;&#160;&#160; db-215.log&#160;&#160;&#160;&#160;&#160; db-231.log&#160;&#160;&#160;&#160;&#160; db-248.log&#160;&#160;&#160;&#160;&#160; db-264.log&#160;&#160;&#160;&#160;&#160; db-280.log&#160;&#160;&#160;&#160;&#160; db-42.log&#160;&#160;&#160;&#160;&#160;&#160; db-59.log&#160;&#160;&#160;&#160;&#160;&#160; db-75.log&#160;&#160;&#160;&#160;&#160;&#160; db-91.log
db-102.log&#160;&#160;&#160;&#160;&#160; db-119.log&#160;&#160;&#160;&#160;&#160; db-135.log&#160;&#160;&#160;&#160;&#160; db-151.log&#160;&#160;&#160;&#160;&#160; db-168.log&#160;&#160;&#160;&#160;&#160; db-184.log&#160;&#160;&#160;&#160;&#160; db-20.log&#160;&#160;&#160;&#160;&#160;&#160; db-216.log&#160;&#160;&#160;&#160;&#160; db-232.log&#160;&#160;&#160;&#160;&#160; db-249.log&#160;&#160;&#160;&#160;&#160; db-265.log&#160;&#160;&#160;&#160;&#160; db-281.log&#160;&#160;&#160;&#160;&#160; db-43.log&#160;&#160;&#160;&#160;&#160;&#160; db-6.log&#160;&#160;&#160;&#160;&#160;&#160;&#160; db-76.log&#160;&#160;&#160;&#160;&#160;&#160; db-92.log
db-103.log&#160;&#160;&#160;&#160;&#160; db-12.log&#160;&#160;&#160;&#160;&#160;&#160; db-136.log&#160;&#160;&#160;&#160;&#160; db-152.log&#160;&#160;&#160;&#160;&#160; db-169.log&#160;&#160;&#160;&#160;&#160; db-185.log&#160;&#160;&#160;&#160;&#160; db-200.log&#160;&#160;&#160;&#160;&#160; db-217.log&#160;&#160;&#160;&#160;&#160; db-233.log&#160;&#160;&#160;&#160;&#160; db-25.log&#160;&#160;&#160;&#160;&#160;&#160; db-266.log&#160;&#160;&#160;&#160;&#160; db-282.log&#160;&#160;&#160;&#160;&#160; db-44.log&#160;&#160;&#160;&#160;&#160;&#160; db-60.log&#160;&#160;&#160;&#160;&#160;&#160; db-77.log&#160;&#160;&#160;&#160;&#160;&#160; db-93.log
db-104.log&#160;&#160;&#160;&#160;&#160; db-120.log&#160;&#160;&#160;&#160;&#160; db-137.log&#160;&#160;&#160;&#160;&#160; db-153.log&#160;&#160;&#160;&#160;&#160; db-17.log&#160;&#160;&#160;&#160;&#160;&#160; db-186.log&#160;&#160;&#160;&#160;&#160; db-201.log&#160;&#160;&#160;&#160;&#160; db-218.log&#160;&#160;&#160;&#160;&#160; db-234.log&#160;&#160;&#160;&#160;&#160; db-250.log&#160;&#160;&#160;&#160;&#160; db-267.log&#160;&#160;&#160;&#160;&#160; db-29.log&#160;&#160;&#160;&#160;&#160;&#160; db-45.log&#160;&#160;&#160;&#160;&#160;&#160; db-61.log&#160;&#160;&#160;&#160;&#160;&#160; db-78.log&#160;&#160;&#160;&#160;&#160;&#160; db-94.log
db-105.log&#160;&#160;&#160;&#160;&#160; db-121.log&#160;&#160;&#160;&#160;&#160; db-138.log&#160;&#160;&#160;&#160;&#160; db-154.log&#160;&#160;&#160;&#160;&#160; db-170.log&#160;&#160;&#160;&#160;&#160; db-187.log&#160;&#160;&#160;&#160;&#160; db-202.log&#160;&#160;&#160;&#160;&#160; db-219.log&#160;&#160;&#160;&#160;&#160; db-235.log&#160;&#160;&#160;&#160;&#160; db-251.log&#160;&#160;&#160;&#160;&#160; db-268.log&#160;&#160;&#160;&#160;&#160; db-3.log&#160;&#160;&#160;&#160;&#160;&#160;&#160; db-46.log&#160;&#160;&#160;&#160;&#160;&#160; db-62.log&#160;&#160;&#160;&#160;&#160;&#160; db-79.log&#160;&#160;&#160;&#160;&#160;&#160; db-95.log
db-106.log&#160;&#160;&#160;&#160;&#160; db-122.log&#160;&#160;&#160;&#160;&#160; db-139.log&#160;&#160;&#160;&#160;&#160; db-155.log&#160;&#160;&#160;&#160;&#160; db-171.log&#160;&#160;&#160;&#160;&#160; db-188.log&#160;&#160;&#160;&#160;&#160; db-203.log&#160;&#160;&#160;&#160;&#160; db-22.log&#160;&#160;&#160;&#160;&#160;&#160; db-236.log&#160;&#160;&#160;&#160;&#160; db-252.log&#160;&#160;&#160;&#160;&#160; db-269.log&#160;&#160;&#160;&#160;&#160; db-30.log&#160;&#160;&#160;&#160;&#160;&#160; db-47.log&#160;&#160;&#160;&#160;&#160;&#160; db-63.log&#160;&#160;&#160;&#160;&#160;&#160; db-8.log&#160;&#160;&#160;&#160;&#160;&#160;&#160; db-96.log
db-107.log&#160;&#160;&#160;&#160;&#160; db-123.log&#160;&#160;&#160;&#160;&#160; db-14.log&#160;&#160;&#160;&#160;&#160;&#160; db-156.log&#160;&#160;&#160;&#160;&#160; db-172.log&#160;&#160;&#160;&#160;&#160; db-189.log&#160;&#160;&#160;&#160;&#160; db-204.log&#160;&#160;&#160;&#160;&#160; db-220.log&#160;&#160;&#160;&#160;&#160; db-237.log&#160;&#160;&#160;&#160;&#160; db-253.log&#160;&#160;&#160;&#160;&#160; db-27.log&#160;&#160;&#160;&#160;&#160;&#160; db-31.log&#160;&#160;&#160;&#160;&#160;&#160; db-48.log&#160;&#160;&#160;&#160;&#160;&#160; db-64.log&#160;&#160;&#160;&#160;&#160;&#160; db-80.log&#160;&#160;&#160;&#160;&#160;&#160; db-97.log
db-108.log&#160;&#160;&#160;&#160;&#160; db-124.log&#160;&#160;&#160;&#160;&#160; db-140.log&#160;&#160;&#160;&#160;&#160; db-157.log&#160;&#160;&#160;&#160;&#160; db-173.log&#160;&#160;&#160;&#160;&#160; db-19.log&#160;&#160;&#160;&#160;&#160;&#160; db-205.log&#160;&#160;&#160;&#160;&#160; db-221.log&#160;&#160;&#160;&#160;&#160; db-238.log&#160;&#160;&#160;&#160;&#160; db-254.log&#160;&#160;&#160;&#160;&#160; db-270.log&#160;&#160;&#160;&#160;&#160; db-32.log&#160;&#160;&#160;&#160;&#160;&#160; db-49.log&#160;&#160;&#160;&#160;&#160;&#160; db-65.log&#160;&#160;&#160;&#160;&#160;&#160; db-81.log&#160;&#160;&#160;&#160;&#160;&#160; db-98.log
db-109.log&#160;&#160;&#160;&#160;&#160; db-125.log&#160;&#160;&#160;&#160;&#160; db-141.log&#160;&#160;&#160;&#160;&#160; db-158.log&#160;&#160;&#160;&#160;&#160; db-174.log&#160;&#160;&#160;&#160;&#160; db-190.log&#160;&#160;&#160;&#160;&#160; db-206.log&#160;&#160;&#160;&#160;&#160; db-222.log&#160;&#160;&#160;&#160;&#160; db-239.log&#160;&#160;&#160;&#160;&#160; db-255.log&#160;&#160;&#160;&#160;&#160; db-271.log&#160;&#160;&#160;&#160;&#160; db-33.log&#160;&#160;&#160;&#160;&#160;&#160; db-5.log&#160;&#160;&#160;&#160;&#160;&#160;&#160; db-66.log&#160;&#160;&#160;&#160;&#160;&#160; db-82.log&#160;&#160;&#160;&#160;&#160;&#160; db-99.log
db-11.log&#160;&#160;&#160;&#160;&#160;&#160; db-126.log&#160;&#160;&#160;&#160;&#160; db-142.log&#160;&#160;&#160;&#160;&#160; db-159.log&#160;&#160;&#160;&#160;&#160; db-175.log&#160;&#160;&#160;&#160;&#160; db-191.log&#160;&#160;&#160;&#160;&#160; db-207.log&#160;&#160;&#160;&#160;&#160; db-223.log&#160;&#160;&#160;&#160;&#160; db-24.log&#160;&#160;&#160;&#160;&#160;&#160; db-256.log&#160;&#160;&#160;&#160;&#160; db-272.log&#160;&#160;&#160;&#160;&#160; db-34.log&#160;&#160;&#160;&#160;&#160;&#160; db-50.log&#160;&#160;&#160;&#160;&#160;&#160; db-67.log&#160;&#160;&#160;&#160;&#160;&#160; db-83.log&#160;&#160;&#160;&#160;&#160;&#160; db.data
db-110.log&#160;&#160;&#160;&#160;&#160; db-127.log&#160;&#160;&#160;&#160;&#160; db-143.log&#160;&#160;&#160;&#160;&#160; db-16.log&#160;&#160;&#160;&#160;&#160;&#160; db-176.log&#160;&#160;&#160;&#160;&#160; db-192.log&#160;&#160;&#160;&#160;&#160; db-208.log&#160;&#160;&#160;&#160;&#160; db-224.log&#160;&#160;&#160;&#160;&#160; db-240.log&#160;&#160;&#160;&#160;&#160; db-257.log&#160;&#160;&#160;&#160;&#160; db-273.log&#160;&#160;&#160;&#160;&#160; db-35.log&#160;&#160;&#160;&#160;&#160;&#160; db-51.log&#160;&#160;&#160;&#160;&#160;&#160; db-68.log&#160;&#160;&#160;&#160;&#160;&#160; db-84.log&#160;&#160;&#160;&#160;&#160;&#160; db.redo
db-111.log&#160;&#160;&#160;&#160;&#160; db-128.log&#160;&#160;&#160;&#160;&#160; db-144.log&#160;&#160;&#160;&#160;&#160; db-160.log&#160;&#160;&#160;&#160;&#160; db-177.log&#160;&#160;&#160;&#160;&#160; db-193.log&#160;&#160;&#160;&#160;&#160; db-209.log&#160;&#160;&#160;&#160;&#160; db-225.log&#160;&#160;&#160;&#160;&#160; db-241.log&#160;&#160;&#160;&#160;&#160; db-258.log&#160;&#160;&#160;&#160;&#160; db-274.log&#160;&#160;&#160;&#160;&#160; db-36.log&#160;&#160;&#160;&#160;&#160;&#160; db-52.log&#160;&#160;&#160;&#160;&#160;&#160; db-69.log&#160;&#160;&#160;&#160;&#160;&#160; db-85.log&#160;&#160;&#160;&#160;&#160;&#160; lock
db-112.log&#160;&#160;&#160;&#160;&#160; db-129.log&#160;&#160;&#160;&#160;&#160; db-145.log&#160;&#160;&#160;&#160;&#160; db-161.log&#160;&#160;&#160;&#160;&#160; db-178.log&#160;&#160;&#160;&#160;&#160; db-194.log&#160;&#160;&#160;&#160;&#160; db-21.log&#160;&#160;&#160;&#160;&#160;&#160; db-226.log&#160;&#160;&#160;&#160;&#160; db-242.log&#160;&#160;&#160;&#160;&#160; db-259.log&#160;&#160;&#160;&#160;&#160; db-275.log&#160;&#160;&#160;&#160;&#160; db-37.log&#160;&#160;&#160;&#160;&#160;&#160; db-53.log&#160;&#160;&#160;&#160;&#160;&#160; db-7.log&#160;&#160;&#160;&#160;&#160;&#160;&#160; db-86.log
db-113.log&#160;&#160;&#160;&#160;&#160; db-13.log&#160;&#160;&#160;&#160;&#160;&#160; db-146.log&#160;&#160;&#160;&#160;&#160; db-162.log&#160;&#160;&#160;&#160;&#160; db-179.log&#160;&#160;&#160;&#160;&#160; db-195.log&#160;&#160;&#160;&#160;&#160; db-210.log&#160;&#160;&#160;&#160;&#160; db-227.log&#160;&#160;&#160;&#160;&#160; db-243.log&#160;&#160;&#160;&#160;&#160; db-26.log&#160;&#160;&#160;&#160;&#160;&#160; db-276.log&#160;&#160;&#160;&#160;&#160; db-38.log&#160;&#160;&#160;&#160;&#160;&#160; db-54.log&#160;&#160;&#160;&#160;&#160;&#160; db-70.log&#160;&#160;&#160;&#160;&#160;&#160; db-87.log
db-114.log&#160;&#160;&#160;&#160;&#160; db-130.log&#160;&#160;&#160;&#160;&#160; db-147.log&#160;&#160;&#160;&#160;&#160; db-163.log&#160;&#160;&#160;&#160;&#160; db-18.log&#160;&#160;&#160;&#160;&#160;&#160; db-196.log&#160;&#160;&#160;&#160;&#160; db-211.log&#160;&#160;&#160;&#160;&#160; db-228.log&#160;&#160;&#160;&#160;&#160; db-244.log&#160;&#160;&#160;&#160;&#160; db-260.log&#160;&#160;&#160;&#160;&#160; db-277.log&#160;&#160;&#160;&#160;&#160; db-39.log&#160;&#160;&#160;&#160;&#160;&#160; db-55.log&#160;&#160;&#160;&#160;&#160;&#160; db-71.log&#160;&#160;&#160;&#160;&#160;&#160; db-88.log
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Than reduce to the below after GC:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
icbts-2:activemq-unit-tests icbts$ ls target/data/kahadb/
db-318.log      db.data         db.redo         lock
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16643380" author="jgoodyear" created="Tue, 9 Oct 2018 12:58:36 +0000"  >&lt;p&gt;I&apos;ll note that I ran the full unit test suite through using the patch with out breaking existing test cases.&lt;/p&gt;</comment>
                            <comment id="16643488" author="jgoodyear" created="Tue, 9 Oct 2018 14:14:56 +0000"  >&lt;p&gt;Are the changes we&apos;re making to MessageDatabase small enough such that we could back port the fix to 5.15.x line?&lt;/p&gt;</comment>
                            <comment id="16643490" author="christopher.l.shannon" created="Tue, 9 Oct 2018 14:17:56 +0000"  >&lt;p&gt;I was going to backport all commits from this patch to 5.15.x as I don&apos;t know when 5.16.0 will go out and this seems like an important fix&lt;/p&gt;</comment>
                            <comment id="16643497" author="jgoodyear" created="Tue, 9 Oct 2018 14:22:56 +0000"  >&lt;p&gt;Thank you &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16645043" author="christopher.l.shannon" created="Wed, 10 Oct 2018 14:27:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jgoodyear&quot; class=&quot;user-hover&quot; rel=&quot;jgoodyear&quot;&gt;jgoodyear&lt;/a&gt; - i cherry-picked the existing 3 commits into the 5.15.x branch...I will also move anymore from master after the ack compaction case is sorted so we can do a 5.15.7 release soon as this is an important fix&lt;/p&gt;</comment>
                            <comment id="16646464" author="jbonofre" created="Thu, 11 Oct 2018 14:04:22 +0000"  >&lt;p&gt;Hi, I would like to start ActiveMQ 5.15.6 release pretty soon. What&apos;s the current status of this one ? Thanks !&lt;/p&gt;</comment>
                            <comment id="16646490" author="christopher.l.shannon" created="Thu, 11 Oct 2018 14:28:18 +0000"  >&lt;p&gt;I assume you mean 5.15.7 as 5.15.6 is already out.&lt;/p&gt;

&lt;p&gt;There is still no test case yet to validate the ack compaction stuff and I&apos;m out of town next week so probably won&apos;t be a release until the following week at least.  I don&apos;t want to release (and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; i&apos;m sure agrees) until we make sure we don&apos;t break other stuff with compaction.  &lt;/p&gt;</comment>
                            <comment id="16647928" author="gtully" created="Fri, 12 Oct 2018 13:58:28 +0000"  >&lt;p&gt;I pushed an update, that goes some of the way, at least there is one test and a fix.&lt;br/&gt;
The&#160;test is just for a prepare record, ack compaction will still move once the there are outcomes and that will break the reference. that will need a commit test in the same vein.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jgoodyear&quot; class=&quot;user-hover&quot; rel=&quot;jgoodyear&quot;&gt;jgoodyear&lt;/a&gt; flip: &lt;a href=&quot;https://github.com/apache/activemq/commit/7c890d477663d91aef518e30d60cf3c13827877a#diff-e3b8fff8c2133dfd70999705bbb558b3R2094&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/commit/7c890d477663d91aef518e30d60cf3c13827877a#diff-e3b8fff8c2133dfd70999705bbb558b3R2094&lt;/a&gt; to false to see the new test fail to get suck in&lt;br/&gt;
I think the solution is to forward commit records, but more tests are needed to verify the problem and the fix&lt;/p&gt;</comment>
                            <comment id="16651026" author="jbonofre" created="Tue, 16 Oct 2018 01:26:38 +0000"  >&lt;p&gt;Thanks for the update guys. I&apos;m fixing &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7076&quot; title=&quot;Features repository should refer the spring-legacy one&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7076&quot;&gt;&lt;del&gt;AMQ-7076&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7073&quot; title=&quot;MQTT tests are failing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7073&quot;&gt;AMQ-7073&lt;/a&gt; on my side.&lt;/p&gt;

&lt;p&gt;Please let me know when I can start 5.15.7 release. Thanks !&lt;/p&gt;</comment>
                            <comment id="16653887" author="jira-bot" created="Wed, 17 Oct 2018 17:13:57 +0000"  >&lt;p&gt;Commit ed727d22e1f22a13813d61dba3908408fcd3cd36 in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=ed727d2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=ed727d2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7067&quot; title=&quot;KahaDB Recovery can experience a dangling transaction when prepare and commit occur on different data files.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7067&quot;&gt;&lt;del&gt;AMQ-7067&lt;/del&gt;&lt;/a&gt; - track xa commit outcomes in ack compaction such that there are no dangling prepared tx on full recovery, fix and test&lt;/p&gt;</comment>
                            <comment id="16653895" author="gtully" created="Wed, 17 Oct 2018 17:18:45 +0000"  >&lt;p&gt;I think this is now sorted, the ack compaction will still work and not get in the way.&lt;/p&gt;</comment>
                            <comment id="16653909" author="jgoodyear" created="Wed, 17 Oct 2018 17:24:11 +0000"  >&lt;p&gt;I see the commit message for master, are we putting this on 5.15 too?&lt;/p&gt;</comment>
                            <comment id="16653926" author="jira-bot" created="Wed, 17 Oct 2018 17:35:02 +0000"  >&lt;p&gt;Commit f7ff4c25e13133132c3103141a5179c93e43b536 in activemq&apos;s branch refs/heads/activemq-5.15.x from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=f7ff4c2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=f7ff4c2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7067&quot; title=&quot;KahaDB Recovery can experience a dangling transaction when prepare and commit occur on different data files.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7067&quot;&gt;&lt;del&gt;AMQ-7067&lt;/del&gt;&lt;/a&gt; - track xa commit outcomes in ack compaction such that there are no dangling prepared tx on full recovery, fix and test&lt;/p&gt;</comment>
                            <comment id="16653927" author="jgenender" created="Wed, 17 Oct 2018 17:35:20 +0000"  >&lt;p&gt;Done.&#160; Thanks.&lt;/p&gt;</comment>
                            <comment id="16653948" author="christopher.l.shannon" created="Wed, 17 Oct 2018 17:55:24 +0000"  >&lt;p&gt;Awesome thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;I&#8217;m actually out of the office the rest of the week but when I get back Monday I can do the work for the 5.15.7 release if no one else gets around to it&lt;/p&gt;</comment>
                            <comment id="16658338" author="githubbot" created="Sun, 21 Oct 2018 19:14:20 +0000"  >&lt;p&gt;Github user jgoodyear closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/302&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/302&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16662257" author="jira-bot" created="Wed, 24 Oct 2018 12:56:03 +0000"  >&lt;p&gt;Commit 8e5d539665519629139633e324a672b0a415d4b2 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=8e5d539&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=8e5d539&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-7067&quot; title=&quot;KahaDB Recovery can experience a dangling transaction when prepare and commit occur on different data files.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-7067&quot;&gt;&lt;del&gt;AMQ-7067&lt;/del&gt;&lt;/a&gt; - add missing license header&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13367192">AMQ-8201</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12942458" name="amq7067test.patch" size="7729" author="jgoodyear" created="Thu, 4 Oct 2018 21:36:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 3 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ytzj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>