<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:49:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3028] ActiveMQ broker processing slows with consumption from large store</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3028</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;In scalability tests, this problem occured.  I have tested a workaround that appears to function.  A fix will gladly be submitted - would like some guidance, though, on the most appropriate solution.&lt;/p&gt;

&lt;p&gt;Here&apos;s the summary.  Many more details are available upon request.&lt;/p&gt;

&lt;p&gt;Root cause:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Believed to be simultaneous access to LRUCache objects which are not thread-safe (PageFile&apos;s pageCache)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Workaround:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Synchronize the LRUCache on all access methods (get, put, remove)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The symptoms are as follows:&lt;/p&gt;

&lt;p&gt;  1. Message rates run fairly-constant until a point in time when they degrade rather quickly&lt;br/&gt;
  2. After a while (about 15 minutes), the message rates drop to the floor - with large numbers of seconds with 0 records passing&lt;br/&gt;
  3. Using VisualVM or JConsole, note that memory use grows continuosuly&lt;br/&gt;
  4. When message rates drop to the floor, the VM is spending the vast majority of its time performing garbage collection&lt;br/&gt;
  5. Heap dumps show that LRUCache objects (the pageCache members of PageFile&apos;s) are far exceeding their configured limits.&lt;br/&gt;
      The default limit was used, 10000.  A size of over 170,000 entries was reached.&lt;br/&gt;
  6. No producer flow control occurred (did not see the flow control log message)&lt;/p&gt;

&lt;p&gt;Test scenario used to reproduce:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Fast producers (limited to &amp;lt;= 1000 msgs/sec)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;using transactions&lt;/li&gt;
		&lt;li&gt;10 msg per transaction&lt;/li&gt;
		&lt;li&gt;message content size 177 bytes&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Slow consumers (limited to &amp;lt;= 10 msg/sec)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;auto-acknowledge mode; not transacted&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;10 Queues
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;1 producer per queue&lt;/li&gt;
		&lt;li&gt;1 consumer per queue&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Producers, Consumers, and Broker all running on different systems, and on the same system (different test runs).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Note that disk space was not an issue - there was always plenty of disk space available.&lt;/p&gt;

&lt;p&gt;One other interesting note - once a large database of records was stored in KahaDB, only running consumers, this problem still occurred.&lt;/p&gt;

&lt;p&gt;This issue sounds like it may be related to 1764, and 2721.  The root cause sounds the same as 2290 - unsynchronized access to LRUCache.&lt;/p&gt;

&lt;p&gt;The most straight-forward solution is to modify all LRUCache objects (org.apache.kahadb.util.LRUCache, org.apache.activemq.util.LRUCache, ...) to be concurrent.  Another is to create concurrent versions (perhaps ConcurrentLRUCache) and make use of those at least in PageFile.pageCache.&lt;/p&gt;</description>
                <environment>&lt;p&gt;CentOS 5.5, Sun JDK 1.6.0_21-b06 64 bit, ActiveMQ 5.4.1, AMD Athlon(tm) II X2 B22, local disk&lt;/p&gt;</environment>
        <key id="12483903">AMQ-3028</key>
            <summary>ActiveMQ broker processing slows with consumption from large store</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="artnaseef">Arthur Naseef</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Nov 2010 20:13:00 +0000</created>
                <updated>Thu, 25 Nov 2010 09:03:54 +0000</updated>
                            <resolved>Wed, 24 Nov 2010 11:56:27 +0000</resolved>
                                    <version>5.4.1</version>
                                    <fixVersion>5.4.2</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="12943206" author="artnaseef" created="Wed, 10 Nov 2010 20:27:18 +0000"  >&lt;p&gt;Patch which synchronizes org.apache.kahadb.util.LRUCache and org.apache.activemq.util.LRUCache on get(), put(), and remove() calls.&lt;/p&gt;</comment>
                            <comment id="12943245" author="artnaseef" created="Mon, 22 Nov 2010 18:47:55 +0000"  >&lt;p&gt;Is there something I can do to further assist with this issue?&lt;/p&gt;

&lt;p&gt;Testing with the attached patch was successful - all of the problems were aleviated.&lt;/p&gt;

&lt;p&gt;I have considered writing a JUnit to test it, but that is not trivial because (a) the time needed to learn JUnit, (b) the impact of configuration on reproducing the problem in a timely manner (increasing JVM memory may delay detection of the issue), and (c) detecting the problem requires internal access to the LRUCache or some other method with which I am unfamiliar.&lt;/p&gt;</comment>
                            <comment id="12943260" author="dejanb" created="Wed, 24 Nov 2010 11:56:27 +0000"  >&lt;p&gt;Fixed with svn revision 1038566&lt;/p&gt;

&lt;p&gt;I didn&apos;t make LRU cache synced in general, just synced the usage of pageCache. Let us know if it helps with your scenario.&lt;/p&gt;</comment>
                            <comment id="12943252" author="artnaseef" created="Wed, 24 Nov 2010 18:00:10 +0000"  >&lt;p&gt;I will test with the update and post the results when complete.  With any luck, it&apos;ll be done today.&lt;/p&gt;</comment>
                            <comment id="12943251" author="asussman" created="Wed, 24 Nov 2010 18:23:19 +0000"  >
&lt;p&gt;Are you saying their solution isn&apos;t good enough?&lt;/p&gt;

</comment>
                            <comment id="12943264" author="artnaseef" created="Wed, 24 Nov 2010 18:35:25 +0000"  >&lt;p&gt;Oh hey Adam - different message thread.&lt;/p&gt;

&lt;p&gt;I was just indicating that I need to run my tests to feel confident it&apos;s resolved.&lt;/p&gt;</comment>
                            <comment id="12943263" author="artnaseef" created="Wed, 24 Nov 2010 19:40:50 +0000"  >&lt;p&gt;My tests just finished and ran without a problem.  In addition to consistent performance throughout the test, a heapdump with VisualVM shows the LRUCache objects all stayed within their limits.&lt;/p&gt;

&lt;p&gt;Thank you!&lt;/p&gt;</comment>
                            <comment id="12943262" author="dejanb" created="Thu, 25 Nov 2010 09:03:54 +0000"  >&lt;p&gt;Thanks for confirming!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461882" name="LRUCache.patch" size="2091" author="artnaseef" created="Wed, 10 Nov 2010 20:27:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14748</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0b9w7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63715</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>