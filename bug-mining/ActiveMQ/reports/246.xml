<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:34:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1202] 4.2 Broker memory leak wrt network connectors</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1202</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;If the NetworkConnector list contains any entries to unavailable / unreachable targets, memory is leaked.&lt;/p&gt;

&lt;p&gt;Tested with a broker having fairly &quot;stock&quot; settings, and with the following NetworkConnector section:&lt;br/&gt;
    &amp;lt;networkConnectors&amp;gt;&lt;br/&gt;
      &amp;lt;networkConnector uri=&quot;static://(tcp://dummy:5111?connectionTimeout=5000)&quot; prefetchSize=&quot;10000&quot;/&amp;gt;&lt;br/&gt;
    &amp;lt;/networkConnectors&amp;gt;&lt;/p&gt;

&lt;p&gt;I am using JDK 1.6, since that version of jmap allows the &quot;-histo:live&quot; switch, producing a list of the live objects.&lt;/p&gt;

&lt;p&gt;Just after starting the Broker, here is the top 10 entries from jmap:&lt;br/&gt;
num   #instances    #bytes  class name&lt;br/&gt;
--------------------------------------&lt;br/&gt;
  1:     36639     4143792  &amp;lt;constMethodKlass&amp;gt;&lt;br/&gt;
  2:     36639     2935200  &amp;lt;methodKlass&amp;gt;&lt;br/&gt;
  3:     54423     2326752  &amp;lt;symbolKlass&amp;gt;&lt;br/&gt;
  4:      8099     2008984  [B&lt;br/&gt;
  5:      3451     1771816  &amp;lt;constantPoolKlass&amp;gt;&lt;br/&gt;
  6:      3451     1433032  &amp;lt;instanceKlassKlass&amp;gt;&lt;br/&gt;
  7:     14220     1212160  [C&lt;br/&gt;
  8:      2894     1089840  &amp;lt;constantPoolCacheKlass&amp;gt;&lt;br/&gt;
  9:         8      524352  [Lorg.apache.activemq.command.DataStructure;&lt;/p&gt;


&lt;p&gt;And then after about 5 minutes or so, here&apos;s the jmap top 10:&lt;br/&gt;
num   #instances    #bytes  class name&lt;br/&gt;
--------------------------------------&lt;br/&gt;
  1:       198    12977712  [Lorg.apache.activemq.command.DataStructure;&lt;br/&gt;
  2:     36647     4144520  &amp;lt;constMethodKlass&amp;gt;&lt;br/&gt;
  3:     36647     2935840  &amp;lt;methodKlass&amp;gt;&lt;br/&gt;
  4:     54427     2326960  &amp;lt;symbolKlass&amp;gt;&lt;br/&gt;
  5:      8293     2207032  [B&lt;br/&gt;
  6:      3455     1773488  &amp;lt;constantPoolKlass&amp;gt;&lt;br/&gt;
  7:      3455     1434376  &amp;lt;instanceKlassKlass&amp;gt;&lt;br/&gt;
  8:     14499     1234040  [C&lt;br/&gt;
  9:      2898     1091120  &amp;lt;constantPoolCacheKlass&amp;gt;&lt;br/&gt;
 10:     17754      426096  java.lang.String&lt;/p&gt;


&lt;p&gt;Not sure what component down the list is holding onto DataStructure, but I&apos;ve included the full jmap output files.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12482220">AMQ-1202</key>
            <summary>4.2 Broker memory leak wrt network connectors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="yaussy">Kevin Yaussy</reporter>
                        <labels>
                    </labels>
                <created>Mon, 12 Mar 2007 17:53:52 +0000</created>
                <updated>Thu, 18 Oct 2007 03:55:52 +0000</updated>
                            <resolved>Thu, 18 Oct 2007 03:55:52 +0000</resolved>
                                    <version>5.0.0</version>
                                    <fixVersion>5.0.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12938863" author="yaussy" created="Mon, 16 Apr 2007 15:41:32 +0000"  >&lt;p&gt;This is kind of an ugly one, but I traced it down to org/apache/activemq/broker/TransportConnector.java and its usage of the connections list.  The code pathway for setting up a Network connection goes as far as calling TransportConnector.onStarted, which adds to this list.  However, this path gets called prior to discovering that the target is not there, but TransportConnector.onStopped is never called.  Thus, TransportConnection objects are leaked into the connections list.&lt;/p&gt;

&lt;p&gt;I did not discover yet what use this list is, other than potentially on Broker shutdown, if TransportConnector.stop is called.  So, as a quick work around, I&apos;ve commented out usage of the connections list in TransportConnector.onStarted and onStopped.&lt;/p&gt;</comment>
                            <comment id="12938988" author="alewando" created="Wed, 9 May 2007 20:23:12 +0000"  >&lt;p&gt;Another data point, we are running in to this issue as well. It seems to be much worse when the number of connections is large. We run embedded brokers in each of our app server processes, with each broker connected to every other broker (fully connected network). When 9 of the 12 app servers were down it ran through 1.5GB of heap on each of the remaining 3 app servers in about an hour.&lt;/p&gt;

&lt;p&gt;Any idea if a fix of this can be put out before 4.2 is released? This is a fairly serious issue for us.&lt;/p&gt;</comment>
                            <comment id="12938930" author="alewando" created="Mon, 21 May 2007 19:31:41 +0000"  >&lt;p&gt;I&apos;ve looked in to this a bit more and agree with Kevin. TransportConnector is holding on to TransportConnection instances in the connections list. TransportConnector.onStopped() would remove them from the list, but it never gets called. The reason it never gets called is a bit of a long story:&lt;/p&gt;

&lt;p&gt;If there are multiple NetworkConnector entries, DiscoveryNetworkConnector creates a bridge for each one. A bridge has a local and remote transport, one for each end of the connection. The &apos;local&apos; transport of each of those bridge connections is an in-VM transport obtained from the VMTransportFactory. &lt;br/&gt;
VMTransportFactory caches it VMTransportServer instances by &apos;host&apos;. Because it caches these by host, and the host portion of the VM-transport is based on the broker name, all of the bridges&apos; local transports share the same VMTransportServer instance.&lt;br/&gt;
When the bridge can&apos;t connect to the remote broker, DiscoveryNetworkConnector does the right thing and tries to dispose of the local and remote transports it created. This disposal includes calling VMTransportServer.stop(), which usually includes stopping the releated TransportConnections, which would in turn cause TransportConnector.onStopped(TransportConnection) to be called, thus cleaning up the connections list. BUT becuase there are other bridges running that share the same VMTransportServer, it&apos;s connectionCount variable is greater than 0 which prevents it from closing the related transport connections. So the TransportConnector lives on and holds on to useless TransportConnections.&lt;/p&gt;

&lt;p&gt;I don&apos;t know what can be done to fix this, but at least the details may be useful to someone who wants to look at it further.&lt;/p&gt;</comment>
                            <comment id="12938942" author="yaussy" created="Wed, 23 May 2007 15:36:51 +0000"  >&lt;p&gt;Sorry, Adam.  I should have posted this a little while ago.  I ended up just commenting out the contents of onStarted and onStopped in TransportConnector.  The collections didn&apos;t appear to be used for anything - it has been a safe change for us so far.&lt;/p&gt;

&lt;p&gt;There&apos;s another, similar, leak.  I&apos;ll open a new issue for that.  It involves rejected connections &lt;b&gt;into&lt;/b&gt; the broker (as opposed to this one which is connections &lt;b&gt;out&lt;/b&gt; being made by this broker).&lt;/p&gt;</comment>
                            <comment id="12939092" author="rajdavies" created="Thu, 18 Oct 2007 03:55:52 +0000"  >&lt;p&gt;Added testcase:  org.apache.activemq.network.NetworkConnectionsCleanedupTest in svn revision 585843&lt;br/&gt;
profiled for an hour - memory usage remained below 3mb for the jvm in this time&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12460929" name="ASF.LICENSE.NOT.GRANTED--jmap.tar" size="92160" author="yaussy" created="Mon, 12 Mar 2007 17:53:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84711</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 years, 6 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s1lz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>161737</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>