<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:58:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4116] Memory usage is not cleared from the source queue when a message is moved to another queue over the VMTransport</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4116</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Reproduction&lt;br/&gt;
============&lt;br/&gt;
Using VMTransport:&lt;/p&gt;

&lt;p&gt;1. Produce a message on queue A and verify that queue A&apos;s memory usage increases&lt;br/&gt;
2. Consume the message from queue A and verify that queue A&apos;s memory usage decreases.&lt;br/&gt;
3. Resend the message to queue B.&lt;/p&gt;

&lt;p&gt;Expected: Queue A&apos;s memory usage is not increased by the enqueue to queue B.&lt;br/&gt;
Actual: Queue A&apos;s memory usage increases and no memory usage increase occurs on queue B.&lt;/p&gt;

&lt;p&gt;Symptom&lt;br/&gt;
=======&lt;br/&gt;
When messages are moved between queues using the VMTransport, they continue to contribute to the memory usage of the source queue rather than the destination queue.&lt;/p&gt;

&lt;p&gt;The correct behaviour (memory usage decreases from queue A and increases in queue B) is exhibited by non-VMTransport (e.g., TCP).&lt;/p&gt;

&lt;p&gt;Cause&lt;br/&gt;
=====&lt;br/&gt;
When the message is first sent to queue A, it&apos;s memoryUsage field is set to match queue A&apos;s:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;org.apache.activemq.broker.region.Queue&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void send(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ProducerBrokerExchange producerExchange, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Message message) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ConnectionContext context = producerExchange.getConnectionContext();
    &lt;span class=&quot;code-comment&quot;&gt;// There is delay between the client sending it and it arriving at the
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// destination.. it may have expired.
&lt;/span&gt;    message.setRegionDestination(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;org.apache.activemq.command.Message&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setRegionDestination(org.apache.activemq.broker.region.Destination destination) {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.regionDestination = destination;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.memoryUsage==&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.memoryUsage=regionDestination.getMemoryUsage();
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As the message moves across the transport, it is copied along with the memoryUsage field:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;org.apache.activemq.command.Message&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void copy(Message copy) {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.copy(copy);
...
    copy.memoryUsage=&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.memoryUsage;
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When the message is sent to the second queue, memoryUsage is non-null, so setRegionDestination(...) does not update memoryUsage to reflect the new destination queue.&lt;/p&gt;

&lt;p&gt;When the destination queue accepts the message, the memoryUsage of the source queue is (incorrectly) increased:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;org.apache.activemq.command.Message&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; incrementReferenceCount() {
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; rc;
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; size;
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
        rc = ++referenceCount;
        size = getSize();
    }

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rc == 1 &amp;amp;&amp;amp; getMemoryUsage() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        getMemoryUsage().increaseUsage(size);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This mal-behaviour is not exhibited by other transports since they serialize Message and memoryUsage is transient.  As a result, the call to setRegionDestination(...) will properly update memoryUsage when the message arrives at the destination queue.&lt;/p&gt;

&lt;p&gt;Solution&lt;br/&gt;
========&lt;br/&gt;
There are a number of possible solutions, any of which would correct the behaviour (although I am unsure what side-effects they may have on other behaviour):&lt;/p&gt;

&lt;p&gt;1. It seems odd that memoryUsage is copied when Message is copied.  If Message.copy(...) is used as a shortcut to avoid serialization/deserialization on VMTransport, then it should have the same semantics and avoid copying transient fields.&lt;/p&gt;

&lt;p&gt;2. It seems odd that setRegionDestination(...) would not always set the memoryUsage to match the destination&apos;s memoryUsage.&lt;/p&gt;

&lt;p&gt;3. ActiveMQConnection has a comment regarding concessions made for messages transmitted by the VM transport:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;org.apache.activemq.ActiveMQConnection&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onCommand(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; o) {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Command command = (Command)o;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!closed.get() &amp;amp;&amp;amp; command != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            command.visit(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CommandVisitorAdapter() {
                @Override
                &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Response processMessageDispatch(MessageDispatch md) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                    waitForTransportInterruptionProcessingToComplete();
                    ActiveMQDispatcher dispatcher = dispatchers.get(md.getConsumerId());
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (dispatcher != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                        &lt;span class=&quot;code-comment&quot;&gt;// Copy in &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; a embedded broker is dispatching via
&lt;/span&gt;                        &lt;span class=&quot;code-comment&quot;&gt;// vm://
&lt;/span&gt;                        &lt;span class=&quot;code-comment&quot;&gt;// md.getMessage() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; to signal end of queue
&lt;/span&gt;                        &lt;span class=&quot;code-comment&quot;&gt;// browse.
&lt;/span&gt;                        Message msg = md.getMessage();
                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (msg != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                            msg = msg.copy();
                            msg.setReadOnlyBody(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
                            msg.setReadOnlyProperties(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
                            msg.setRedeliveryCounter(md.getRedeliveryCounter());
                            msg.setConnection(ActiveMQConnection.&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
                            md.setMessage(msg);
                        }
                        dispatcher.dispatch(md);
                    }
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Adding a call to msg.setMemoryUsage(null) would address this bug.&lt;/p&gt;

&lt;p&gt;The latter appears to be the least intrusive, although it will only address the case of VMTransport messages moving between producers/consumers. Queue contains shortcut methods for moving messages between queues (e.g., copyMessageTo).  I have not verified if these methods exhibit the same behaviour re: memory usage, but if so, they would not be addressed by patching ActiveMQConnection.&lt;/p&gt;

&lt;p&gt;Our main concern is with the reported use case, so I&apos;ve attached a patch for ActiveMQConnection and unit test to demonstrate the behaviour.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12612520">AMQ-4116</key>
            <summary>Memory usage is not cleared from the source queue when a message is moved to another queue over the VMTransport</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="stirlingc">Stirling Chow</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Oct 2012 00:47:06 +0000</created>
                <updated>Thu, 31 Jan 2013 21:50:26 +0000</updated>
                            <resolved>Thu, 31 Jan 2013 21:50:26 +0000</resolved>
                                    <version>5.7.0</version>
                                    <fixVersion>5.8.0</fixVersion>
                                    <component>Transport</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13479550" author="stirlingc" created="Fri, 19 Oct 2012 01:17:03 +0000"  >&lt;p&gt;Unit test demonstrating bug on VMTransport and how TCP transport does not exhibit bug.&lt;/p&gt;</comment>
                            <comment id="13479553" author="stirlingc" created="Fri, 19 Oct 2012 01:18:54 +0000"  >&lt;p&gt;ActiveMQConnection patch to resolve issue.&lt;/p&gt;</comment>
                            <comment id="13568146" author="tabish121" created="Thu, 31 Jan 2013 21:46:14 +0000"  >&lt;p&gt;Agreed that when copied in ActiveMQConnection there&apos;s definitely no need for the copy to retain a reference to the MemoryUsage.  Will look at &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4147&quot; title=&quot;Memory usage incorrectly updated across network of brokers when VMTransport is used.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4147&quot;&gt;&lt;del&gt;AMQ-4147&lt;/del&gt;&lt;/a&gt; also but applying this patch won&apos;t hurt anything even if we take action on 4147.  &lt;/p&gt;</comment>
                            <comment id="13568151" author="tabish121" created="Thu, 31 Jan 2013 21:50:26 +0000"  >&lt;p&gt;Fix applied, thanks for the test and patch.  &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12614093">AMQ-4147</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12549793" name="AMQ4116.patch" size="790" author="stirlingc" created="Fri, 19 Oct 2012 01:18:54 +0000"/>
                            <attachment id="12549792" name="AMQ4116Test.java" size="4091" author="stirlingc" created="Fri, 19 Oct 2012 01:17:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>249704</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0agkn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>58958</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>