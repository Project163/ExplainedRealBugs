<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:44:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2563] Memory Leak in DefaultJDBCAdapter</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2563</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I was performing an endurance test on ActiveMQ 5.3.0.  My test consisted of a single queue with a number of producers and consumers.  The producers send very simple text messages and the consumers simply receive the message and do no other processing.  Using the OOTB configuration (which uses -Xmx512m) with JDBC persistence to an Oracle database, I found the system came to a halt at around 10.3 million messages.  Looking at the VM revealed a very full heap and tiny gains from garbage collection.  Restarting the broker allows the system to run again.&lt;/p&gt;

&lt;p&gt;To determine the cause of the exhausted heap, I took a series of heap dumps over time.  My examination of the heaps showed that the number of live instances of TreeMap$Entry and Long were increasing linearly with the number of messages.  The Longs were owned by the TreeMap$Entry objects.  The TreeMap$Entry objects could be tracked back to the TreeSet&amp;lt;Long&amp;gt; instance from the lastRecoveredMessageIds field in DefaultJDBCAdapter.&lt;/p&gt;

&lt;p&gt;The only method that uses lastRecoveredMessageIds is:&lt;br/&gt;
public void doRecoverNextMessages(TransactionContext c, ActiveMQDestination destination, long nextSeq,&lt;br/&gt;
            int maxReturned, JDBCMessageRecoveryListener listener) throws Exception&lt;/p&gt;

&lt;p&gt;As the listener is called to recover a message, the id is added to this set.  The id is only removed from this set if it is encountered on future run of doRecoverNextMessages when it is added to the cleanupIds list.  The SQL that is executed at the beginning of the method filters messages based on having an id greater than nextSeq.  If nextSeq is always large enough, an id is never added to cleanupIds and consequently never removed from lastRecoveredMessageIds.&lt;/p&gt;

&lt;p&gt;I saw that the use of lastRecoveredMessageIds was introduced with &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-1918&quot; title=&quot;AbstractStoreCursor.size gets out of synch with Store size and blocks consumers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-1918&quot;&gt;&lt;del&gt;AMQ-1918&lt;/del&gt;&lt;/a&gt;.  Also, &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2436&quot; title=&quot;JDBC synchronization problems under high load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2436&quot;&gt;&lt;del&gt;AMQ-2436&lt;/del&gt;&lt;/a&gt; synchronizes the TreeSet, but that should have no effect on this issue.&lt;/p&gt;

&lt;p&gt;Dejan mentioned some work done on JDBC persistence and a memory leak fix in association with &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2519&quot; title=&quot;Prevent JDBC store to persist the same message twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2519&quot;&gt;&lt;del&gt;AMQ-2519&lt;/del&gt;&lt;/a&gt;.  I have performed the same test on the latest snapshots of 5.3.1 and 5.4.  The same results were observed on those as well.  Also, work done for &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2519&quot; title=&quot;Prevent JDBC store to persist the same message twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2519&quot;&gt;&lt;del&gt;AMQ-2519&lt;/del&gt;&lt;/a&gt; modified JDBCMessageStore, JDBCTopicMessageStore, and JDBCPersistenceAdapter.  I believe the issue is in DefaultJDBCAdapter.&lt;/p&gt;

&lt;p&gt;To reproduce:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Start a broker using JDBC persistence (sample configuration file will be attached)&lt;/li&gt;
	&lt;li&gt;Start a number of producers and consumers using the same queue on that broker (sample WAR file will be attached.  Modify WEB-INF/applicationContext.xml to set the queue name and broker URL.  The war file currently uses TestQueue and tcp://localhost:61616, respectively.)&lt;/li&gt;
	&lt;li&gt;Wait for about 20,000 messages to be processed (you can use less; it just gets easier in the heap dumps to see after about 20,000 messages.  29 bytes are retained per message that is processed)&lt;/li&gt;
	&lt;li&gt;Look at the old generation size after a full garbage collection over time.  It grows slowly.&lt;/li&gt;
	&lt;li&gt;Obtain a heap dump.  The heap dump will show a number of retained instances of TreeMap$Entry and Long.  (sample heap dump will be attached)&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>&lt;p&gt;Java 1.6.0_07-b06 on Solaris (5.10) sparcv9&lt;/p&gt;</environment>
        <key id="12483189">AMQ-2563</key>
            <summary>Memory Leak in DefaultJDBCAdapter</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dejanb">Dejan Bosanac</assignee>
                                    <reporter username="jimharter">Jim Harter</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Jan 2010 20:52:56 +0000</created>
                <updated>Wed, 3 Feb 2010 14:46:58 +0000</updated>
                            <resolved>Wed, 3 Feb 2010 14:46:58 +0000</resolved>
                                    <version>5.3.0</version>
                                    <fixVersion>5.3.1</fixVersion>
                    <fixVersion>5.4.0</fixVersion>
                                    <component>Message Store</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12941985" author="jimharter" created="Fri, 8 Jan 2010 20:55:06 +0000"  >&lt;p&gt;Attaching sample broker configuration file, test web application to produce and consume messages, and a zip of a heap dump showing the memory leak&lt;/p&gt;</comment>
                            <comment id="12941984" author="dejanb" created="Sun, 10 Jan 2010 11:25:01 +0000"  >&lt;p&gt;Scheduled it for 5.3.1&lt;/p&gt;</comment>
                            <comment id="12942153" author="dejanb" created="Wed, 3 Feb 2010 14:46:58 +0000"  >&lt;p&gt;Resolved with svn revision 906054.&lt;/p&gt;

&lt;p&gt;The problematic lastRecoveredMessageIds is removed completely. It was just a temp workaround for duplicate messages. Now we have it implemented when messages are added to the store, so there&apos;s no need for this check.&lt;/p&gt;

&lt;p&gt;The commit also includes a fix for a cursor problem spotted during the test.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461588" name="AMQTest.war" size="5849364" author="jimharter" created="Fri, 8 Jan 2010 20:55:06 +0000"/>
                            <attachment id="12461587" name="heap.zip" size="4409685" author="jimharter" created="Fri, 8 Jan 2010 20:55:06 +0000"/>
                            <attachment id="12461586" name="jdbc-test.xml" size="2606" author="jimharter" created="Fri, 8 Jan 2010 20:55:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>74893</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 42 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rpw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>159839</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>