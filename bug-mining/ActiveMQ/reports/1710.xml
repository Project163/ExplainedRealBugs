<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:57:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4166] RedeliveryPlugin causes a deadlock with JobSchedulerImpl</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4166</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Originates from the forum discussion &lt;a href=&quot;http://activemq.2283324.n4.nabble.com/RedeliveryPlugin-causes-a-deadlock-with-JobSchedulerImpl-in-ActiveMQ-5-7-0-tt4659019.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.2283324.n4.nabble.com/RedeliveryPlugin-causes-a-deadlock-with-JobSchedulerImpl-in-ActiveMQ-5-7-0-tt4659019.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;we have RedeliveryPlugin causing thread deadlock together with JobSchedulerImpl. ActiveMQ version is 5.7.0. We activated RedeliveryPlugin in our broker config xml (see below). There two stacktraces below as well. One is from ActiveMQ VMTransport thread, which tries to send a message to a dead letter queue using RedeliveryPlugin. RedeliveryPlugin just tries to reschedule the message for redelivery and for that it calls JobSchedulerImpl and blocks on its synchronized method &quot;schedule&quot;. On the way &quot;consumersLock&quot; is locked. &lt;br/&gt;
Another stack trace is from JobScheduler:JMS thread, which fires a job to redeliver some message and tries to send it using the same queue used by the VMTransport thread. And it blocks on that consumersLock locked by the VMTransport thread. And this occurs in JobSchedulerImpl#mainLoop method inside synchronized {} block causing a deadlock, since the VMTransport thread tries to call another synchronized method of JobSchedulerImpl. The art how RedeliveryPlugin and JobSchedulerImpl are programmed seems to be quite dangerous, since they both access the queues and try to acquire queue locks. And additionally synchronized methods of JobSchedulerImpl are called directly from RedeliveryPlugin making that to a nice source of thread deadlocks. And I see no measures taken in the code to avoid these deadlocks.&lt;br/&gt;
We can reproduce it quite often if we start ActiveMQ with empty stores (kahadb and scheduler stores are deleted manually from the file system before startup). But looking at the code, I would say that the problem may occur in any situation in any deployment scenario (standalone or embedded in a JEE container). It is just enough to have some Transport thread redelivering a message and the JobScheduler thread trying to fire a job at the same moment on the same queue.&lt;br/&gt;
And another strange thing, which is may be has nothing to do with the deadlock but is still strange, is that according to the stack trace RedeliveryPlugin tries to redeliver an expired message.&lt;/p&gt;

&lt;p&gt;broker config and the stack traces are attached to the issue.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Reproduced on Windows 8, Windows Vista, MacOS X&lt;br/&gt;
with Oracle jdk 1.7.0_07. ActiveMQ is started embedded using RAR inside Glassfish 3.1.2.2.&lt;/p&gt;</environment>
        <key id="12615460">AMQ-4166</key>
            <summary>RedeliveryPlugin causes a deadlock with JobSchedulerImpl</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="barlabanov">Sergiy Barlabanov</reporter>
                        <labels>
                    </labels>
                <created>Fri, 9 Nov 2012 10:57:13 +0000</created>
                <updated>Thu, 21 Jan 2016 18:35:25 +0000</updated>
                            <resolved>Thu, 21 Jan 2016 18:35:25 +0000</resolved>
                                    <version>5.7.0</version>
                                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13493915" author="barlabanov" created="Fri, 9 Nov 2012 11:02:18 +0000"  >&lt;p&gt;Broker config and the stack traces of the participating threads.&lt;/p&gt;</comment>
                            <comment id="13493921" author="barlabanov" created="Fri, 9 Nov 2012 11:08:24 +0000"  >&lt;p&gt;With this deadlock problem the new feature announced for 5.7.0 about per-destination redelivery configuration is actually unusable. I see no workaround besides fallback to use ConnectionFactory to configure the redelivery.&lt;/p&gt;</comment>
                            <comment id="13494330" author="gtully" created="Fri, 9 Nov 2012 21:36:54 +0000"  >&lt;p&gt;I think the processing of expired messages in error is the root cause or the deadlock.&lt;br/&gt;
The correct expiry check is in &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1407640&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1407640&amp;amp;view=rev&lt;/a&gt;&lt;br/&gt;
There is only one valid path to scheduled redelivery and this is through the receipt of a poison ack with just a subscription dispatch lock held.&lt;br/&gt;
If optimizedDispatch is used, such that the scheduler send thread does a dispatch, there is a deadlock possibility.&lt;br/&gt;
The fix is either to split schedule and execute in the scheduler or let the redelivery plugin do the schedule async. The simplest solution is to schedule async i think.&lt;br/&gt;
@Sergiy, from your config, you don&apos;t use optimizedDispatch so you should be set.&lt;br/&gt;
Would it be possible to validate using a 5.8-SNAPSHOT.&lt;/p&gt;</comment>
                            <comment id="13494332" author="gtully" created="Fri, 9 Nov 2012 21:40:19 +0000"  >&lt;p&gt;@Sergiy, btw - thanks for the stack traces &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13496233" author="barlabanov" created="Tue, 13 Nov 2012 14:51:28 +0000"  >&lt;p&gt;I will try 5.8-SNAPSHOT the next days and write the feedback.&lt;/p&gt;</comment>
                            <comment id="13497033" author="barlabanov" created="Wed, 14 Nov 2012 11:17:11 +0000"  >&lt;p&gt;Just tried our application with ActiveMQ 5.8-SNAPSHOT. No deadlocks detected. Looks good. optimizedDispatch was set to true.&lt;/p&gt;

&lt;p&gt;One question: would it be enough to take 1407640 revision to get the bug patched in 5.7.0? It looks that message expiry is not the only problem causing the deadlock. You wrote something about &quot;split schedule and execute in the scheduler or let the redelivery plugin do the schedule async&quot;.&lt;/p&gt;</comment>
                            <comment id="13497034" author="barlabanov" created="Wed, 14 Nov 2012 11:18:10 +0000"  >&lt;p&gt;Just a few notes: when I tried the resource adapter of 5.8-SNAPSHOT the following problems occured:&lt;br/&gt;
1. activemq-core.jar was not inside the rar. This resulted in XBeanBrokerFactory ClassNotFoundException.&lt;br/&gt;
2. activemq-spring.jar was missing in the rar as well. This resulted in the missing namespace exception (&lt;a href=&quot;http://activemq.apache.org/schema/core&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/schema/core&lt;/a&gt;) since activemq.xsd in inside activemq-spring.jar&lt;/p&gt;

&lt;p&gt;I had to add the missing jars manually in order to get the RAR deployed.&lt;/p&gt;</comment>
                            <comment id="13497035" author="gtully" created="Wed, 14 Nov 2012 11:23:26 +0000"  >&lt;p&gt;@Sergiy - 1407640 revision is sufficient provide u use the default optimizedDispatch=&quot;false&quot;. With it true, there is a chance of deadlock given specific circumstances.&lt;/p&gt;</comment>
                            <comment id="13497036" author="gtully" created="Wed, 14 Nov 2012 11:28:13 +0000"  >&lt;p&gt;opened &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4172&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-4172&lt;/a&gt; to track RAR issues with snapshot&lt;/p&gt;</comment>
                            <comment id="15111058" author="tabish121" created="Thu, 21 Jan 2016 18:35:25 +0000"  >&lt;p&gt;Multiple fixes and refactorings in this area since this was opened.  Not test case to confirm all paths are correct but reported that it was working in a 5.8-SNAPSHOT&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12552813" name="broker-config.xml" size="4507" author="barlabanov" created="Fri, 9 Nov 2012 11:02:18 +0000"/>
                            <attachment id="12552814" name="stack-trace-1.txt" size="4079" author="barlabanov" created="Fri, 9 Nov 2012 11:02:18 +0000"/>
                            <attachment id="12552815" name="stack-trace-2.txt" size="1715" author="barlabanov" created="Fri, 9 Nov 2012 11:02:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>256743</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 43 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0iqsv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>107436</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>