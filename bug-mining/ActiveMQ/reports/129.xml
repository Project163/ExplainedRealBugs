<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:32:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-932] Quickly broken client connections lead to memory leaks</title>
                <link>https://issues.apache.org/jira/browse/AMQ-932</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Connections to the openwire port that are pathologically broken (for example any http request) or that die in some other way extremely quickly will lead to memory losses of aout 64Kb each time. This happens because many services are stop()ed directly in the middle of start(), and then never stopped for real, or stopped again but on an object tree with an inconsistent state. This is usually also accompanied by the JMX message:&lt;/p&gt;

&lt;p&gt;WARN  ManagedTransportConnection     - Failed to unregister mbean: org.apache.activemq:BrokerName=localhost,Type=Connection,ConnectorName=default,Connection=25&lt;/p&gt;

&lt;p&gt;But that is a cosmetic symptom and not critical (and this has otherwise nothing to do with JMX).&lt;/p&gt;

&lt;p&gt;My patch is a band-aid that is functional but I&apos;m not very happy with it. The patch changes some service logic so that if stop is called in the middle of start, the stop is instead queued and called at the end of start. There will still be multiple stops, and you&apos;ll still see the cosmetic JMX error from the second ineffectual stop, but the first stop cleans up correctly so there are no leaks.&lt;/p&gt;

&lt;p&gt;I think there&apos;s probably a better solution, but it was tough to see what. I&apos;d appreciate better ideas. Possibly something involving moving the dangerous operations (wire format negotiation etc) out of start?&lt;/p&gt;

&lt;p&gt;I am working on a unit test, but I can&apos;t promise I will have something to submit. I&apos;m having to play JVM games to detect the problem in a unit test and that might not fly for general purpose use.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12481823">AMQ-932</key>
            <summary>Quickly broken client connections lead to memory leaks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jheitmann">John Heitmann</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Sep 2006 07:19:39 +0000</created>
                <updated>Mon, 25 Sep 2006 11:23:13 +0000</updated>
                            <resolved>Mon, 25 Sep 2006 11:23:13 +0000</resolved>
                                    <version>4.0.2</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12938381" author="kellyc" created="Sat, 23 Sep 2006 17:52:00 +0000"  >&lt;p&gt;I ran into a similar issue but I don&apos;t think it was due to broken connections. I&apos;ve got a heap dump from the broker (jdk1.6), and it looks like the OpenWireFormat marshalCache is the root cause of the one I&apos;m working on. Each DataStructure[] marshalCache is roughly 64K because of the MARSHAL_CACHE_SIZE. There&apos;s 738 DataStructure[] arrays in my heap, taking up 48 Mbytes. Most of these only have one element used. &lt;/p&gt;

&lt;p&gt;I think issues 914 and 937 might be related or the same. &lt;/p&gt;</comment>
                            <comment id="12938244" author="jheitmann" created="Sun, 24 Sep 2006 07:50:18 +0000"  >&lt;p&gt;Those are the exact symptoms that occur as a result of the problem I saw. For every bad connection there was a bunch of individual object leakage (one each of the major transport filters, a couple different mbeans, a connection object etc), but by far the most serious leakage were the empty pre-allocated marshaler cache arrays. This looks like a common symptom of anything that would leak transports/connections, so it might not be the same root cause.&lt;/p&gt;

&lt;p&gt;If you can reproduce it and want help I&apos;d be happy to take a look.&lt;/p&gt;

&lt;p&gt;If you can&apos;t find the problem one thing that could really help mitigate the severity of these kinds of leaks is to make the initialization of the marshaling caches conditional on the wireFormat.cacheEnabled flag. This would give a lot more leak headroom.&lt;/p&gt;</comment>
                            <comment id="12938398" author="jstrachan" created="Mon, 25 Sep 2006 11:23:13 +0000"  >&lt;p&gt;Patch applied John with thanks - could you double check I&apos;ve applied it correctly please?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12460554" name="ASF.LICENSE.NOT.GRANTED--73.diff" size="3419" author="jheitmann" created="Thu, 21 Sep 2006 07:19:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84442</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            19 years, 10 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14qf3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>235745</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>