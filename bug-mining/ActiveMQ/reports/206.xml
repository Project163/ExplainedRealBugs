<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:33:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1146] InactivityMonitor: Transport connection disconnected &quot;Channel was inactive for too long.&quot;</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1146</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Sometimes (when the transport is idle for long) the transport gets disconnected with the message &quot;Channel was inactive for too long.&quot; &lt;/p&gt;

&lt;p&gt;        Apparently this is same as reported in &lt;a href=&quot;http://www.nabble.com/Channel-was-inactive-for-too-long-t1463069.html#a3971744&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.nabble.com/Channel-was-inactive-for-too-long-t1463069.html#a3971744&lt;/a&gt; and &lt;a href=&quot;http://www.nabble.com/Durable-consumer-reconnect-problem-tf1716817.html#a6147014&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.nabble.com/Durable-consumer-reconnect-problem-tf1716817.html#a6147014&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;Version: 4.1 &lt;/p&gt;

&lt;p&gt;Background: &lt;/p&gt;

&lt;p&gt;        The class org.apache.activemq.transport.InactivityMonitor runs monitoring threads to check the read and write of the transport(TCP for example). If it hasn&apos;t sent the message during the given period, it sends a KeepAliveInfo to ensure the connectivity. If it doesn&apos;t receive the message for a given duration, then it disconnects the transport. &lt;/p&gt;

&lt;p&gt;        By default, the maximumInactivityDuration is 30000 milliseconds. This is the time interval between the check for read. That is if an end of the transport doesn&apos;t receive any message for this period, then it will close the connection. For the read check, the time interval is half of maximumInactivityDuration i.e. 15000 millisecond. That is if a message was not sent during this period, it will send a KeepAliveInfo to ensure the connectivity. &lt;/p&gt;


&lt;p&gt;Problem and the recommended fix: &lt;/p&gt;

&lt;p&gt;        The InactivityMonitor class uses the flags inReceive and commandReceived variables in methods readCheck and onCommand. Typically these two methods are called from different threads. Also, the flags inSend and commandSent are used in methods oneway and writeCheck. Again these two methods are called from different threads. But, the synchronization was missing for these. This seems to be a potential cause for the problem. So, synchronization has been incorporated for these flag usages. &lt;/p&gt;

&lt;p&gt;        The same class InactivityMonitor is used at both client and server side. In general, the write check (which sends KeepAliveInfo) happens twice during the time when the read check happens once. Probably the client and server machines have performance differences and just to be safer, now the write check is made to happen thrice during the time when the read check happens once. &lt;/p&gt;


&lt;p&gt;        The original and the changed source files are attached here. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.nabble.com/file/5958/InactivityMonitor_changed.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.nabble.com/file/5958/InactivityMonitor_changed.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.nabble.com/file/5957/InactivityMonitor_Original.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.nabble.com/file/5957/InactivityMonitor_Original.java&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows Server 2003 running broker and Windows XP running client. Java 1.5.0_08 &lt;/p&gt;</environment>
        <key id="12482091">AMQ-1146</key>
            <summary>InactivityMonitor: Transport connection disconnected &quot;Channel was inactive for too long.&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chirino">Hiram R. Chirino</assignee>
                                    <reporter username="mariappan.r@gmail.com">Mari</reporter>
                        <labels>
                    </labels>
                <created>Thu, 1 Feb 2007 20:26:24 +0000</created>
                <updated>Mon, 22 Aug 2016 18:18:11 +0000</updated>
                            <resolved>Fri, 19 Oct 2007 17:31:47 +0000</resolved>
                                    <version>4.1.0</version>
                                    <fixVersion>5.0.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>7</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="3600">1h</timeoriginalestimate>
                            <timeestimate seconds="3600">1h</timeestimate>
                                                    <aggregatetimeoriginalestimate seconds="3600">1h</aggregatetimeoriginalestimate>
                                        <aggregatetimeremainingestimate seconds="3600">1h</aggregatetimeremainingestimate>
                                                <comments>
                            <comment id="12936478" author="jstrachan" created="Tue, 12 Jun 2007 13:42:55 +0000"  >&lt;p&gt;Patch applied with thanks!&lt;/p&gt;</comment>
                            <comment id="12939127" author="mteira" created="Thu, 18 Oct 2007 08:12:41 +0000"  >&lt;p&gt;I&apos;m having some issues where slow performance in the backend database seems to lead to InactivityIOExceptions. My opinion is that the fix for this issue is causing those problems: &lt;/p&gt;

&lt;p&gt;Having in mind that the design of the readCheck/writeCheck monitors is that we always should have a command among two readCheck (produced by normal activity or by the response of a KeepAlive injected by the writeCheck between two readChecks if needed), synchronizing on the readChecker variable seems a bad idea:&lt;/p&gt;

&lt;p&gt;If the chain of transportListener.onCommand() is lasting more than the negociated MaxInactivityDuration, we will end with two readCheck executing one after the other, without a writeCheck between them. The first readCheck success, sets the commandReceived to false, and the second one is always going to fail, as no new command has been processed, nor a writeCheck has been executed since the last readCheck.&lt;/p&gt;

&lt;p&gt;I don&apos;t see the need of synchronizing on the readChecker/writeChecker variables. These are AtomicBooleans and should be safe to access them from different threads (this seemed to be the motivation of the fix). Also, synchronizing the readCheck/writeCheck is actually delaying the execution of the check, and we cannot guarantee anymore the alternating of writeCheck readCheck execution, that is needed for the solution to work.&lt;/p&gt;

&lt;p&gt;Also, synchronizing that is avoiding this code in readCheck() :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;     
&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (readChecker) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inReceive.get()) {
                LOG.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;A receive is in progress&quot;&lt;/span&gt;);
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;to be reached: because inReceive is only set during onCommand, and that is synchronized on readChecker also. Furthermore, the right way to do this is returning here when a onCommand is performed at the same time, and not waiting, to not break the sequence of readCheck/writeCheck invocations.&lt;/p&gt;


&lt;p&gt;In few words, I think that this change breaks the InactivityMonitor, and my opinion is that it should be rolled back. Also in the 4.1 subtask that I opened some time ago. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Any comments?&lt;/p&gt;
</comment>
                            <comment id="12939111" author="mteira" created="Thu, 18 Oct 2007 10:44:41 +0000"  >&lt;p&gt;After discussing the problem with Rob Davies in the IRC channel, I&apos;m reopening this issue to rollback the synchronization for the readCheck/writeCheck.&lt;/p&gt;
</comment>
                            <comment id="12939178" author="chirino" created="Fri, 19 Oct 2007 17:31:47 +0000"  >&lt;p&gt;tightened up the synchronizations in trunk.   Now we only synchronize to avoid 2 concurrent sends going the next transport or to avoid 2 concurrent commands / exceptions from being delivered to the transport listener.&lt;/p&gt;</comment>
                            <comment id="15430087" author="ahirepankaj" created="Mon, 22 Aug 2016 05:44:53 +0000"  >&lt;p&gt;Hi All,&lt;/p&gt;

&lt;p&gt;I am facing the same issue with Activemq 5.6.0. I tried to disable the Inactivity monitor by setting 0 , in activemq.mxl under conf.&lt;br/&gt;
Still facing same error.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="15431347" author="christopher.l.shannon" created="Mon, 22 Aug 2016 18:18:11 +0000"  >&lt;p&gt;This jira is 9 years old and even version 5.6.0 is several years old by now.  You should try the latest version (up to 5.14.0 now) and then start a new Jira issue if you think there is a bug or try and get help on the users mailing list.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12460775" name="ASF.LICENSE.NOT.GRANTED--InactivityMonitor_Original.java" size="5915" author="mariappan.r@gmail.com" created="Thu, 1 Feb 2007 20:26:24 +0000"/>
                            <attachment id="12460565" name="ASF.LICENSE.NOT.GRANTED--InactivityMonitor_changed.java" size="6353" author="mariappan.r@gmail.com" created="Thu, 1 Feb 2007 20:26:24 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12481972">AMQ-1302</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84481</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 13 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ku3j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>119694</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>