<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:58:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3539] Prefetch state can be incorrect when transacted redelivery of duplicates occurs, causing stalled queue</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3539</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;ul&gt;
	&lt;li&gt;In ActiveMQMessageConsumer, delivery acks are generated by receive() calls and by the dispatch() method when transacted redelivery of duplicates occurs.  These delivery acks are consolidated by calling ackLater which batches them up using first/last message id and sends the acks as appropriate w.r.t. the prefetch size.&lt;/li&gt;
	&lt;li&gt;On the broker, the prefetch window is extended by checking the last message id, finding where it is in the dispatched queue and incrementing the prefetchExtension accordingly.  This algorithm depends on the consumer maintaining the dispatch order in its consolidated delivery acks.&lt;/li&gt;
	&lt;li&gt;When the transacted redelivery occurs, it happens in a separate thread than the receive, operating on the latest delivered message.  The delivery acks from the receive thread are arbitrarily delayed (but in order of dispatch) depending on client action.  The mixing of these can result in an out of order consolidated delivery ack.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Real example (the client and broker logs are mixed to make it easier to follow; the dispatch logs come from my own custom logging plugin):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2011-10-12 11:51:51,712 TRACE ActiveMqBroker [BrokerService[jmsBroker] Task-3] - Dispatching message [ID:XXX-45585-1318434687322-0:68:1:1:1]
2011-10-12 11:51:51,834 TRACE ActiveMqBroker [BrokerService[jmsBroker] Task-43] - Dispatching message [ID:XXX-60241-1318434687532-0:56:1:1:3]
2011-10-12 11:51:51,835 TRACE ActiveMqBroker [BrokerService[jmsBroker] Task-43] - Dispatching message [ID:XXX-45585-1318434687322-0:68:1:1:2]

2011-10-12 11:51:51,836 DA [ActiveMQ Session Task-1] - ID:XXX-60241-1318434687532-0:33:1:1 tracking transacted redelivery of duplicate: ActiveMQTextMessage {commandId = 827, responseRequired = true, messageId = ID:XXX-45585-1318434687322-0:68:1:1:2, originalDestination = null, originalTransactionId = null, producerId = ID:XXX-45585-1318434687322-0:68:1:1, destination = queue://indexer.index-content-dispatcher, transactionId = null, expiration = 0, timestamp = 1318434696398, arrival = 0, brokerInTime = 1318434696461, brokerOutTime = 1318434711835, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = org.apache.activemq.util.ByteSequence@305e3ad0, dataStructure = null, redeliveryCounter = 0, size = 0, properties = XXX }

2011-10-12 11:51:51,876 TRACE ActiveMqBroker [ActiveMQ Transport: tcp:///127.0.0.1:55235] - firstId: ID:XXX-45585-1318434687322-0:68:1:1:2, lastId: ID:XXX-45585-1318434687322-0:68:1:1:1, dest: queue://indexer.index-content-dispatcher, acktype:0, individualAck:false, deliveredAck:true, messageAck:true, standardAck:false

2011-10-12 11:51:51,878 TRACE ActiveMqBroker [BrokerService[jmsBroker] Task-8] - Dispatching message [ID:XXX-60241-1318434687532-0:56:1:1:4]

2011-10-12 11:51:51,879 DA [ActiveMQ Session Task-1] - ID:XXX-60241-1318434687532-0:33:1:1 tracking transacted redelivery of duplicate: ActiveMQTextMessage {commandId = 840, responseRequired = true, messageId = ID:XXX-60241-1318434687532-0:56:1:1:4, originalDestination = null, originalTransactionId = null, producerId = ID:XXX-60241-1318434687532-0:56:1:1, destination = queue://indexer.index-content-dispatcher, transactionId = null, expiration = 0, timestamp = 1318434696518, arrival = 0, brokerInTime = 1318434696600, brokerOutTime = 1318434711878, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = org.apache.activemq.util.ByteSequence@332a4674, dataStructure = null, redeliveryCounter = 0, size = 0, properties = XXX }

2011-10-12 11:51:51,903 TRACE ActiveMqBroker [ActiveMQ Transport: tcp:///127.0.0.1:55235] - firstId: ID:XXX-60241-1318434687532-0:56:1:1:4, lastId: ID:XXX-60241-1318434687532-0:56:1:1:3, dest: queue://indexer.index-content-dispatcher, acktype:0, individualAck:false, deliveredAck:true, messageAck:true, standardAck:false

2011-10-12 11:51:51,905 TRACE ActiveMqBroker [BrokerService[jmsBroker] Task-8] - Dispatching message [ID:XXX-45585-1318434687322-0:68:1:1:3]

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the first ack received by the broker, you can see that message &lt;tt&gt;68:1:1:2&lt;/tt&gt; is the first id and &lt;tt&gt;68:1:1:1&lt;/tt&gt; is the last id.  The broker never looks at the first id and will consider this a delivery ack of everything up to &lt;tt&gt;68:1:1:1&lt;/tt&gt; (which was the first message dispatched).  Thus this mixing results in a incorrect delivery count on the part of the broker.&lt;/p&gt;

&lt;p&gt;An easy fix which would sometimes prematurely extend the prefetch window would be to always send transacted redelivery acks immediately (or consolidate them separately from receive originated delivery acks).  Since transacted redelivery acks always get triggered on messages delivered later than the receive acks this would cause the broker to think that all the earlier messages had been delivered also.  This might be inappropriate with really large prefetch sizes, although this is tempered by the fact that this only occurs in failover situations.  &lt;/p&gt;

&lt;p&gt;Another fix might be to enqueue the transacted redelivered messages and do the filtering of these types of messages in the dequeue method which would result in proper ordering of the delivery acks.&lt;/p&gt;

&lt;p&gt;Anything else would seem to require explicit broker accounting of each delivered message.  I&apos;m willing to try to implement one of these fixes (I&apos;m leaning to the dequeue filtering) but would like some guidance.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12526886">AMQ-3539</key>
            <summary>Prefetch state can be incorrect when transacted redelivery of duplicates occurs, causing stalled queue</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="mserrano">Martin Serrano</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Oct 2011 18:01:58 +0000</created>
                <updated>Wed, 30 Jan 2013 12:14:29 +0000</updated>
                            <resolved>Wed, 30 Jan 2013 12:14:28 +0000</resolved>
                                    <version>5.5.0</version>
                                    <fixVersion>5.8.0</fixVersion>
                                    <component>Broker</component>
                    <component>JMS client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13126250" author="tabish121" created="Wed, 12 Oct 2011 23:44:38 +0000"  >&lt;p&gt;Creating a unit test that demonstrates your issue would be helpful here.&lt;/p&gt;</comment>
                            <comment id="13218447" author="mserrano" created="Tue, 28 Feb 2012 18:39:54 +0000"  >&lt;p&gt;I have confirmed this bug exists in 5.6 trunk.  I will be able to work on a unit test soon hopefully.&lt;/p&gt;</comment>
                            <comment id="13218458" author="mserrano" created="Tue, 28 Feb 2012 18:46:46 +0000"  >&lt;p&gt;Patch I&apos;m using for the moment (this is the &quot;easy&quot; fix I mention above)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: ActiveMQMessageConsumer.java
===================================================================
--- ActiveMQMessageConsumer.java	(revision 50578)
+++ ActiveMQMessageConsumer.java	(working copy)
@@ -1353,7 +1353,9 @@
                                 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (transactedIndividualAck) {
                                     immediateIndividualTransactedAck(md);
                                 } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
-                                    ackLater(md, MessageAck.DELIVERED_ACK_TYPE);
+                                  &lt;span class=&quot;code-comment&quot;&gt;// ATTIVIO, fix &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; AMQ-3539
&lt;/span&gt;+                                  MessageAck ack = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MessageAck(md, MessageAck.DELIVERED_ACK_TYPE, 1);
+                                  session.sendAck(ack);
                                 }
                             }
                         }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13458647" author="davsclaus" created="Wed, 19 Sep 2012 12:41:46 +0000"  >&lt;p&gt;Martin, thanks for reporting and with the details you do.&lt;br/&gt;
Have you been running with your &quot;patch&quot; in production for a while? And did that fix it for you?&lt;/p&gt;
</comment>
                            <comment id="13458649" author="davsclaus" created="Wed, 19 Sep 2012 12:42:15 +0000"  >&lt;p&gt;Lets see if we can revisit and find a good solution for this after the 5.7 release.&lt;/p&gt;</comment>
                            <comment id="13458672" author="mserrano" created="Wed, 19 Sep 2012 13:18:54 +0000"  >&lt;p&gt;We have been using this patch successfully since reporting the issue.  It definitely fixes the issue.  Unfortunately I have not had the time to reproduce this in a simple unit test outside of our environment.  It is easy to reproduce in our environment &amp;#8211; we have several failover stress tests with heavy message traffic that we run in a loop.&lt;/p&gt;</comment>
                            <comment id="13566410" author="gtully" created="Wed, 30 Jan 2013 12:14:29 +0000"  >&lt;p&gt;fix looks good (there is no harm in premature extension of prefetch as it is capped by the broker) and no regression in org.apache.activemq.transport.failover.FailoverRedeliveryTransactionTest&lt;/p&gt;

&lt;p&gt;applied with thanks in &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1440366&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1440366&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>74254</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 42 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0al67:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59703</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>