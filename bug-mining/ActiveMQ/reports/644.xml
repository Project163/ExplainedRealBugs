<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:41:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-1112] remove expired messages from Store and update Message cursors</title>
                <link>https://issues.apache.org/jira/browse/AMQ-1112</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Ensure messages that are expired are removed from message store and message cursrors are also updated consistently&lt;/p&gt;</description>
                <environment></environment>
        <key id="12482850">AMQ-1112</key>
            <summary>remove expired messages from Store and update Message cursors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                            <parent id="12483590">AMQ-2552</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="rajdavies">Robert Davies</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Dec 2006 20:39:59 +0000</created>
                <updated>Wed, 24 Mar 2010 16:04:18 +0000</updated>
                            <resolved>Mon, 16 Nov 2009 10:36:12 +0000</resolved>
                                    <version>5.0.0</version>
                                    <fixVersion>5.3.1</fixVersion>
                    <fixVersion>5.4.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>14</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="12936434" author="jstrachan" created="Tue, 12 Jun 2007 09:48:08 +0000"  >&lt;p&gt;added an affected version&lt;/p&gt;</comment>
                            <comment id="12941132" author="gtully" created="Tue, 7 Apr 2009 09:17:39 +0000"  >&lt;p&gt;Am guessing this jira is still open because the mechanism for expiry is non deterministic, It occurs on ack and on message dispatch but not independently. For example a message enqueue with no more work on the broker will not be removed when it expires. &lt;br/&gt;
There needs to be a task that periodically checks and expriies messages independent of normal message processing.&lt;br/&gt;
Current behavior is that expired messages will not  be delivered to a consumer, but they remain till some destination activity occurs.&lt;/p&gt;

&lt;p&gt;I imagine a destinationPolicy.expiryPeriod=60000 - which indicates that a task will fire every minute and iterate through the in memory messages and expiry any that warrent it.&lt;br/&gt;
Possilby there is another destinationPolicy,expireStoredMessages=true which indicates that the expiry task will iterate through the entire store to locate messages that have expired. there may even be a limit, destinationPolicy.expiryTaskDuration=500 that limits a task duration to some period.&lt;/p&gt;

&lt;p&gt;In all these would make message expiry deterministic for a destination.&lt;/p&gt;</comment>
                            <comment id="12941131" author="gtully" created="Tue, 7 Apr 2009 09:21:45 +0000"  >&lt;p&gt;some further context from the user list:&lt;br/&gt;
&lt;a href=&quot;http://www.nabble.com/Expired-messages-are-not-being-removed-from-queues-tt21967682.html#a22773666&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.nabble.com/Expired-messages-are-not-being-removed-from-queues-tt21967682.html#a22773666&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12941157" author="gtully" created="Thu, 9 Apr 2009 13:59:00 +0000"  >&lt;p&gt;just fyi I am highlighting the workaround from the post linked above.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;In the end I implemented a workaround that was simply a thread that periodically cleared my queues of expired messages. The way it did so was to use a MessageConsumer and use a JMSSelector to consume only those messages that had expired. I don&apos;t believe the consumer itself actually ever receives any messages, but the act of looking for them causes ActiveMQ to expunge the expired messages.&lt;/p&gt;

&lt;p&gt;e.g:&lt;br/&gt;
                MessageConsumer c = sess.createConsumer(dest, &quot;JMSExpiration &amp;lt; &quot; + System.currentTimeMillis());&lt;br/&gt;
                Message m = c.receiveNoWait();&lt;br/&gt;
                if (m != null) log.error(&quot;Returned an expired message&quot;);&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="12941311" author="bdarfler" created="Sat, 16 May 2009 01:31:33 +0000"  >&lt;p&gt;I created a quick python script that hits the web ui, finds all the queues and then browses each which causes any expired messages to actually be removed from the queue.  We put this as a cron job that runs every 5 min.&lt;/p&gt;

&lt;p&gt;If you pass no arguments it looks at localhost otherwise you can pass in as many host names as you want to hit.&lt;/p&gt;

&lt;p&gt;I tried attaching it but no go so here is the source.&lt;/p&gt;

&lt;p&gt;--------------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;#! /usr/bin/env python&lt;/p&gt;

&lt;p&gt;import sys, urllib2, re&lt;/p&gt;

&lt;p&gt;pattern = re.compile(&apos;browse.jsp&amp;#63;JMSDestination=(&lt;span class=&quot;error&quot;&gt;&amp;#91;a-zA-Z.&amp;#93;&lt;/span&gt;*)&apos;)&lt;/p&gt;

&lt;p&gt;def expireMsgs(host=&apos;localhost&apos;):&lt;br/&gt;
    url = &apos;http://&apos; + host + &apos;:8161&apos;&lt;br/&gt;
    html = urllib2.urlopen(url + &apos;/admin/queues.jsp&apos;).read()&lt;br/&gt;
    for queue in set(pattern.findall(html)):&lt;br/&gt;
        urllib2.urlopen(url + &apos;/admin/browse.jsp?JMSDestination=&apos; + queue).read()&lt;/p&gt;

&lt;p&gt;if not sys.argv&lt;span class=&quot;error&quot;&gt;&amp;#91;1:&amp;#93;&lt;/span&gt;:&lt;br/&gt;
    expireMsgs()&lt;br/&gt;
else:&lt;br/&gt;
    for arg in sys.argv&lt;span class=&quot;error&quot;&gt;&amp;#91;1:&amp;#93;&lt;/span&gt;:&lt;br/&gt;
        expireMsgs(arg)&lt;/p&gt;</comment>
                            <comment id="12941398" author="bdarfler" created="Tue, 26 May 2009 19:58:09 +0000"  >&lt;p&gt;warning, my above fix runs into this &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-2169&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-2169&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12941699" author="gtully" created="Tue, 7 Jul 2009 16:01:23 +0000"  >&lt;p&gt;r791881&lt;br/&gt;
Added a new expireMessagesPeriod (default 30 seconds) periodic task on a queue that iterates though maxExpirePageSize(default 400) queued messages (or draws them into memory) to implement deterministic message expiry. Can be disabled by setting expireMessagesPeriod==0 through a PolicyEntry. A producer with no consumer will not longer be blocked on memory limits if a message expiry is configured on a message as they will be actively expired every 30 seconds.&lt;br/&gt;
There is an additional expiredCount attribute in the destination statistics to track the count of expired messages.&lt;/p&gt;</comment>
                            <comment id="12941419" author="jacovt" created="Wed, 26 Aug 2009 11:37:58 +0000"  >&lt;p&gt;Need to update the schema to allow the configuration of  the expireMessagesPeriod attribute using activemq-broker.xml.&lt;/p&gt;

&lt;p&gt;Currently activemq fails with a org.springframework.beans.factory.xml.XmlBeanDefinitionStoreException if you try define the attribute.&lt;/p&gt;

&lt;p&gt;---Jaco&lt;/p&gt;</comment>
                            <comment id="12941420" author="gtully" created="Wed, 26 Aug 2009 11:53:13 +0000"  >&lt;p&gt;schema updated in r807969&lt;/p&gt;</comment>
                            <comment id="12941120" author="dejanb" created="Mon, 7 Sep 2009 08:46:37 +0000"  >&lt;p&gt;optimizedDispatch makes this test hang, so I commented it out for the moment. It should be investigated more.&lt;/p&gt;</comment>
                            <comment id="12941140" author="dejanb" created="Mon, 7 Sep 2009 08:49:23 +0000"  >&lt;p&gt;optimizedDispatch makes this test hang (producer hangs)&lt;/p&gt;</comment>
                            <comment id="12941327" author="gtully" created="Mon, 7 Sep 2009 16:09:09 +0000"  >&lt;p&gt;issue with optimizedDispatch resolved in 812214 &lt;/p&gt;</comment>
                            <comment id="12941495" author="dejanb" created="Fri, 25 Sep 2009 16:41:12 +0000"  >&lt;p&gt;Modified test so that it has larger expiry time, which helps it pass on slower machines. But if you have small enough expiry time, it will fail&lt;/p&gt;</comment>
                            <comment id="12941746" author="gtully" created="Mon, 16 Nov 2009 10:36:12 +0000"  >&lt;p&gt;last piece of this resolved by &lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-2481&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-2481&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12941743" author="gtully" created="Mon, 16 Nov 2009 10:37:02 +0000"  >&lt;p&gt;last piece resolved by &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2481&quot; title=&quot;OOM due to message expiry processing with large numbers of messages in queue because of slow or absent consumers.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-2481&quot;&gt;&lt;del&gt;AMQ-2481&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12942186" author="gtully" created="Wed, 24 Mar 2010 15:51:41 +0000"  >&lt;p&gt;This fix only applies to queues. Topics are a different matter as there is only persistence when there are durable consumers. there are pending message limit strategies that control the build up of messages for slow consumers. See: &lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/test/java/org/apache/activemq/MessageEvictionTest.java?view=markup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/test/java/org/apache/activemq/MessageEvictionTest.java?view=markup&lt;/a&gt; for an example of configured message eviction.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12483118">AMQ-2481</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                            <subtask id="12481673">AMQ-1207</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>84720</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 35 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rq53:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>159879</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>