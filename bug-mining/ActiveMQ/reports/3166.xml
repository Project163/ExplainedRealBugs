<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:44:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6575] Retained messages not persisted? (MQTT)</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6575</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;&lt;b&gt;Issue&lt;/b&gt;&lt;br/&gt;
Retained message is not persisted (after restart?)&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Steps to reproduce&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Client &lt;b&gt;c1&lt;/b&gt; connects and publishes a message &lt;b&gt;m1&lt;/b&gt; to topic &lt;b&gt;t1&lt;/b&gt;  with retain: &lt;b&gt;true&lt;/b&gt; and QoS: &lt;b&gt;2&lt;/b&gt;. Client then disconnects.&lt;/li&gt;
	&lt;li&gt;Client connect (with same clientId or different, both works) and &lt;b&gt;c1&lt;/b&gt; subscribes to &lt;b&gt;t1&lt;/b&gt;. &lt;b&gt;c1&lt;/b&gt; recieves &lt;b&gt;m1&lt;/b&gt;.&lt;br/&gt;
However, if the broker is restarted and &lt;b&gt;step 2&lt;/b&gt; is re-run, the &lt;b&gt;m1&lt;/b&gt; is never recieved.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Shouldn&apos;t a retained message with QoS-2 be persisted and send to clients even after restart?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13036794">AMQ-6575</key>
            <summary>Retained messages not persisted? (MQTT)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="stefannilsson">Stefan Nilsson</reporter>
                        <labels>
                    </labels>
                <created>Sat, 21 Jan 2017 13:26:13 +0000</created>
                <updated>Fri, 22 Jul 2022 22:37:30 +0000</updated>
                                            <version>5.14.3</version>
                                                    <component>Broker</component>
                    <component>MQTT</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15846905" author="stefannilsson" created="Tue, 31 Jan 2017 14:38:30 +0000"  >&lt;p&gt;Mosquitto MQTT-broker provides a configuration option (&apos;retained_persistence&apos;) to handle this.&lt;/p&gt;</comment>
                            <comment id="15847443" author="stefannilsson" created="Tue, 31 Jan 2017 20:21:45 +0000"  >&lt;p&gt;A couple of sections from the MQTT 3.1.1-spec talking about &lt;b&gt;retained&lt;/b&gt; message handling.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Retained messages do not form part of the Session state in the Server, they MUST NOT be deleted when the Session ends &lt;span class=&quot;error&quot;&gt;&amp;#91;MQTT-3.1.2.7&amp;#93;&lt;/span&gt;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;blockquote&gt;&lt;p&gt;If the RETAIN flag is set to 1, in a PUBLISH Packet sent by a Client to a Server, the Server MUST store the Application Message and its QoS, so that it can be delivered to future subscribers whose subscriptions match its topic name &lt;span class=&quot;error&quot;&gt;&amp;#91;MQTT-3.3.1-5&amp;#93;&lt;/span&gt;. When a new subscription is established, the last retained message, if any, on each matching topic name MUST be sent to the subscriber &lt;span class=&quot;error&quot;&gt;&amp;#91;MQTT-3.3.1-6&amp;#93;&lt;/span&gt;.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="16049331" author="meth" created="Wed, 14 Jun 2017 16:06:24 +0000"  >&lt;p&gt;There was a &lt;a href=&quot;http://activemq.2283324.n4.nabble.com/Publish-Retained-MQTT-Message-issue-tt4686326.html#none&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;post&lt;/a&gt; on mailing list that could help:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;We did some performance test based on ActiveMQ 5.10, found publish mqtt message with retain enabled is much faster than disable retain.&lt;/p&gt;

&lt;p&gt;And I also tested the retained message will be lost after restart activemq node.&lt;/p&gt;

&lt;p&gt;Checked the source code,the line#621 in class &quot;org.apache.activemq.transport.mqtt.MQTTProtocolConverter&quot; is confusing,&lt;br/&gt;
 msg.setPersistent(command.qos() != QoS.AT_MOST_ONCE &amp;amp;&amp;amp; !command.retain());&lt;/p&gt;

&lt;p&gt;Should it be following logic?&lt;br/&gt;
msg.setPersistent(command.qos() != QoS.AT_MOST_ONCE || command.retain());&lt;/p&gt;

&lt;p&gt;Based on MQTT Spec : &lt;a href=&quot;http://public.dhe.ibm.com/software/dw/webservices/ws-mqtt/mqtt-v3r1.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://public.dhe.ibm.com/software/dw/webservices/ws-mqtt/mqtt-v3r1.html&lt;/a&gt;&lt;br/&gt;
Retained messages should be kept over restarts of the server. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The issue seems to be critical to me. You can&apos;t rely on the whole retain-feature unless your broker is never down or you need a workaround like peridic republishing of messages by the clients.&lt;/p&gt;</comment>
                            <comment id="16524993" author="gtully" created="Wed, 27 Jun 2018 12:43:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=meth&quot; class=&quot;user-hover&quot; rel=&quot;meth&quot;&gt;meth&lt;/a&gt; I was in that area of the code today and came to the same conclusion but then thinking more I think the durability of the message, whether it is persistent or not, needs to come from the publish QoS.&lt;/p&gt;

&lt;p&gt;I am thinking the code should be:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
msg.setPersistent(command.qos() != QoS.AT_MOST_ONCE);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;ie: the retain flag does not effect the durability of the message, just that it gets retained for that topic.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;with this change, retain messages with qos &amp;gt; 0 will survive a restart for existing durable subscribers or virtual topic queues. retain with qos == 0 will not.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16525005" author="jira-bot" created="Wed, 27 Jun 2018 12:52:47 +0000"  >&lt;p&gt;Commit 919ca96cee67d7ceed06a5cc542628ddc21841e2 in activemq&apos;s branch refs/heads/master from gtully&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=919ca96&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=919ca96&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6575&quot; title=&quot;Retained messages not persisted? (MQTT)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6575&quot;&gt;AMQ-6575&lt;/a&gt; - take message durability from publish qos for retained messages, fix and test&lt;/p&gt;</comment>
                            <comment id="17570193" author="fnordian" created="Fri, 22 Jul 2022 22:07:19 +0000"  >&lt;p&gt;Has this been addressed?. It still seems to be an issue in ActiveMQ Classic 5.17.4&lt;/p&gt;

&lt;p&gt;Retained messages are lost when the broker is restarted. Will this be addressed or is this level of MQTT compatibility out of scope for ActiveMQ?&lt;/p&gt;</comment>
                            <comment id="17570199" author="fnordian" created="Fri, 22 Jul 2022 22:37:30 +0000"  >&lt;p&gt;It works as expected in Artemis.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 16 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3916f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>