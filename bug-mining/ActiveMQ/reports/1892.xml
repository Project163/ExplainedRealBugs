<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:59:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4512] MemoryUsage waitForSpace in inconsistent state</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4512</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;There is a race condition in MemoryUsage which makes it possible for it to be left in an inconsistent state and thereby hang any clients in waitForSpace().&lt;/p&gt;

&lt;p&gt;The core issue is in the following block of code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void decreaseUsage(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; value) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (value == 0) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; percentUsage;
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (usageMutex) {
            usage -= value;
            percentUsage = caclPercentUsage();
        }
        setPercentUsage(percentUsage);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (parent != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            parent.decreaseUsage(value);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The bug occurs when multiple threads are calling increment/decrement at same time. Since the field &quot;usage&quot; is protected with the usageMutex each writer/reader will see the correct and current value for usage and calculate the right value for percentUsage at that instant. &quot;setPercentUsage&quot; is also   protected by the same usageMutex so we resyncronize on usageMutex to set the percentUsage field as well. The issue is that threads may enter the setPercentUsage synchronized block in a different order than they entered the percentUsage &quot;calculating&quot; block. Since percentUsage is carried between the two blocks, a reordering of threads can allow the wrong final percentUsage value to be set. &lt;/p&gt;

&lt;p&gt;Possible threading (imagine usage starts at 0 and limit is 100).&lt;br/&gt;
Thread #1 - usage += 150; percentUsage = 150;&lt;br/&gt;
Thread #1 - suspended before called setPercentUsage&lt;br/&gt;
Thread #2 - usage -= 150; percentUsage = 0;&lt;br/&gt;
Thread #2 - setPercentUsage(0);&lt;br/&gt;
Thread #1 - resumed, can now call setPercentUsage&lt;br/&gt;
Thread #1 - setPercentUsage(150);&lt;/p&gt;

&lt;p&gt;Final value = 150&lt;/p&gt;

&lt;p&gt;This same pattern of synchronizing to calculate the percentUsage and then setting the value later is repeated in all of the Usage objects I looked at. My guess it was written this way to avoid holding locks while making calls out to &quot;untrusted code&quot; but it is a very dangerous way to do the calculations. The most surprising thing is the locks are still being explicitly held while calling fireEvent anyways.&lt;/p&gt;

&lt;p&gt;I have attached two screenshots taken using a debugger of two threads that have both been stalled for multiple minutes on &quot;waitForSpace&quot; trying to publish to the same queue. Notice they both have a &quot;usage&quot; of 0 but a &quot;percentUsage&quot; &amp;gt; 100, this should be impossible. To get the system into this state I was using JmsTemplate and a CachingConnectionFactory to publish on 8 threads and a single DefaultMessageListenerContainer who is pulling the messages off as fast as possible. The test publishes 100000 measurements and around ~75% of the time atleast a few producers end up stalled in waitForSpace() even though the queue is ready for more messages. I can also reproduce these results using JmsTemplate and PooledConnectionFactory so I don&apos;t believe it&apos;s an issue in the pooling implementations.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12646315">AMQ-4512</key>
            <summary>MemoryUsage waitForSpace in inconsistent state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="shendley">Sam hendley</reporter>
                        <labels>
                    </labels>
                <created>Mon, 6 May 2013 22:14:09 +0000</created>
                <updated>Wed, 14 Oct 2015 16:14:42 +0000</updated>
                            <resolved>Fri, 10 May 2013 17:14:18 +0000</resolved>
                                    <version>5.6.0</version>
                    <version>5.7.0</version>
                                    <fixVersion>5.9.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13650808" author="gtully" created="Tue, 7 May 2013 13:35:00 +0000"  >&lt;p&gt;analysis looks good. lining up for 5.9 - any chance you could produce a simple junit test case that just exercises MemoryUsage and multiple threads. would be good to have a simple way to validate and protect any fix.&lt;/p&gt;</comment>
                            <comment id="13650925" author="shendley" created="Tue, 7 May 2013 14:55:07 +0000"  >&lt;p&gt;Wow, I&apos;m not surprised this doesn&apos;t occur alot for other people, it takes 10s of thousands of iterations for me to detect a failure. I am amazed it occurs so often in my main test case using the full broker, I&apos;m sure if I was on another machine with more/less cores I wouldn&apos;t have ever noticed this. &lt;/p&gt;

&lt;p&gt;The test case I&apos;m uploading fails most runs. I found attaching a debugger and/or profiler made it much more likely to hit. Switching the number of cores it can run on should also help. Heres a sample output on a failure.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Attempt: 673 : Usage(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) percentUsage=35%, usage=0, limit=1000, percentUsageMinDelta=1%
Operations: [15, 12, 33, 76, 23, 64, 43, 58, 64, 21, 57, 57, 15, 80, 50, 17, 63, 90, 58, 46, 98, 21, 22, 78, 43, 9, 58, 16, 83, 45, 60, 59, 99, 42, 62, 91, 62, 29, 69, 97, 12, 80, 33, 36, 15, 97, 48, 28, 9, 63, 93, 13, 75, 83, 7, 21, 29, 20, 87, 88, 23, 81, 39, 91, 68, 46, 75, 35, 46, 53, 42, 89, 59, 7, 98, 2, 36, 28, 9, 3, 51, 13, 90, 71, 82, 40]

java.lang.AssertionError: 
Expected :0
Actual   :35
 &amp;lt;Click to see difference&amp;gt;
	at org.junit.Assert.fail(Assert.java:93)
	at org.junit.Assert.failNotEquals(Assert.java:647)
	at org.junit.Assert.assertEquals(Assert.java:128)
	at org.junit.Assert.assertEquals(Assert.java:472)
	at org.junit.Assert.assertEquals(Assert.java:456)
	at com.sms.backspool.jms.MemoryUsageTest.checkPercentage(MemoryUsageTest.java:149)
	at com.sms.backspool.jms.MemoryUsageTest.testCycle(MemoryUsageTest.java:22)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13650927" author="shendley" created="Tue, 7 May 2013 14:55:29 +0000"  >&lt;p&gt;Test case showing failure. Remember that there are many other functions that have the same broken pattern of letting the &quot;percentUsage&quot; escape the synchronized block and they should be fixed across the board, not just for MemoryUsage.&lt;/p&gt;</comment>
                            <comment id="13652254" author="tabish121" created="Wed, 8 May 2013 19:33:05 +0000"  >&lt;p&gt;I took a stab at cleaning this up, you&apos;re welcome to review and comment.  &lt;/p&gt;</comment>
                            <comment id="13652328" author="shendley" created="Wed, 8 May 2013 20:42:31 +0000"  >&lt;p&gt;Changes look pretty solid, did the test case break for you reliably?&lt;/p&gt;

&lt;p&gt;I am still worried about holding the lock during listener callbacks, seems like an easy way to cause deadlocks. Meh, its gotten this far without deadlocking and this is no worse so its probably ok.&lt;/p&gt;</comment>
                            <comment id="13652347" author="tabish121" created="Wed, 8 May 2013 20:52:34 +0000"  >&lt;p&gt;Yes, the test shows the issue reliably.&lt;/p&gt;

&lt;p&gt;At least in the case of fireEvent we queue up the callbacks in an executor so really the locks can be safely held.  The one that&apos;s a bit more scary is the notifyCallbackWhenNotFull but if you look at the Broker code the callbacks are merely waking up a task runner so its ok for these as well. &lt;/p&gt;</comment>
                            <comment id="13654616" author="tabish121" created="Fri, 10 May 2013 17:14:18 +0000"  >&lt;p&gt;Fixes and the test case added on trunk&lt;/p&gt;</comment>
                            <comment id="14236923" author="shendley" created="Sat, 6 Dec 2014 18:50:39 +0000"  >&lt;p&gt;We are still pinned to 5.8.0 because of some other dependencies (camel mostly) so despite me knowing about this issue for nearly 2 years I still can&apos;t ship with producerWindow enabled. This has become a real problem because the &quot;raw socket blocking&quot; is preventing any sort of clean shutdown. &lt;/p&gt;

&lt;p&gt;Do you think I would be about backporting these fixes and the related one for &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4361&quot; title=&quot;Deadlock during close while publishing to flow-controlled queue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4361&quot;&gt;&lt;del&gt;AMQ-4361&lt;/del&gt;&lt;/a&gt; to 5.8.0? I copied over the Usage class and it&apos;s sub classes from 5.9.0. No other code changes were made and all of the unit tests in activemq passed. Any ideas how I would go about verifying the safety of these changes?&lt;/p&gt;</comment>
                            <comment id="14957177" author="dhananjaydp" created="Wed, 14 Oct 2015 16:14:42 +0000"  >&lt;p&gt;Is there any valid work around for applications which are stick to 5.7.0?&lt;/p&gt;

&lt;p&gt;I am using 5.7.0 client libraries, as I am tied to other dependencies like karaf, camel etc. &lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12582353" name="AMQ4512Patch.txt" size="27944" author="tabish" created="Wed, 8 May 2013 20:03:28 +0000"/>
                            <attachment id="12582348" name="AMQ4512Patch.txt" size="27937" author="tabish" created="Wed, 8 May 2013 19:33:05 +0000"/>
                            <attachment id="12581976" name="MemUsage1.PNG" size="46533" author="shendley" created="Mon, 6 May 2013 22:14:42 +0000"/>
                            <attachment id="12581977" name="MemUsage2.PNG" size="51769" author="shendley" created="Mon, 6 May 2013 22:14:42 +0000"/>
                            <attachment id="12582105" name="MemoryUsageTest.java" size="5153" author="shendley" created="Tue, 7 May 2013 14:55:29 +0000"/>
                            <attachment id="12581980" name="QueueStats.PNG" size="26017" author="shendley" created="Mon, 6 May 2013 22:30:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>326673</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 5 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1kcvj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>327018</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>