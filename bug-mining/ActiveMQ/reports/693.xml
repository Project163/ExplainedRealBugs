<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:42:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2356] optimizeDispatch=true and UseDedicatedTaskRunner=false lead to deadlocked queues</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2356</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;We have an environment where we have a very large number of destinations. In an effort to reduce the number of threads I have set the options&lt;/p&gt;

&lt;p&gt;-Dorg.apache.activemq.UseDedicatedTaskRunner=false&lt;/p&gt;

&lt;p&gt;and &lt;/p&gt;

&lt;p&gt;&amp;lt;policyEntry queue=&quot;&amp;gt;&quot; optimizedDispatch=&quot;true&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;Unfortunately this very quickly leads to deadlocked queues.&lt;/p&gt;

&lt;p&gt;My environment is:&lt;/p&gt;

&lt;p&gt;ActiveMQ 5.2&lt;br/&gt;
Ubunty Jaunty kernel 2.6.28-14-generic #47-Ubuntu SMP (although only a single core on my system)&lt;br/&gt;
TCP transportConnector&lt;/p&gt;

&lt;p&gt;To reproduce the bug (which I can do 100% of the time) I connect 5 consumers (AUTO_ACK) to 5 different queues. Then I start 5 producers and pair them up with a consumer on a queue, and they start sending PERSISTENT messages. I&apos;ve set the producer to send 100 messages and disconnect, and the consumer to receive 100 messages and disconnect. The first pair usually gets through their 100 messages and disconnect, at which point all the other pairs have deadlocked at less than 30 messages each.&lt;/p&gt;

&lt;p&gt;At this point I can connect jconsole and hit the Detect Deadlock button and it finds the 4 deadlocks for me. The 4 deadlocks all have the same stacktraces, one of which looks like this:&lt;/p&gt;

&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;Name: ActiveMQ Transport: tcp:///127.0.0.1:49307&lt;br/&gt;
State: BLOCKED on java.lang.Object@f8828 owned by: ActiveMQ Transport: tcp:///127.0.0.1:48031&lt;br/&gt;
Total blocked: 3  Total waited: 1&lt;/p&gt;

&lt;p&gt;Stack trace: &lt;br/&gt;
org.apache.activemq.broker.region.PrefetchSubscription.dispatchPending(PrefetchSubscription.java:576)&lt;br/&gt;
org.apache.activemq.broker.region.PrefetchSubscription.add(PrefetchSubscription.java:150)&lt;br/&gt;
org.apache.activemq.broker.region.Queue.doActualDispatch(Queue.java:1266)&lt;br/&gt;
org.apache.activemq.broker.region.Queue.doDispatch(Queue.java:1230)&lt;br/&gt;
org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1308)&lt;br/&gt;
org.apache.activemq.broker.region.Queue.iterate(Queue.java:1011)&lt;br/&gt;
org.apache.activemq.broker.region.Queue.wakeup(Queue.java:1146)&lt;br/&gt;
org.apache.activemq.broker.region.Queue.sendMessage(Queue.java:1141)&lt;br/&gt;
org.apache.activemq.broker.region.Queue.doMessageSend(Queue.java:474)&lt;br/&gt;
org.apache.activemq.broker.region.Queue.send(Queue.java:417)&lt;br/&gt;
org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:350)&lt;br/&gt;
org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:437)&lt;br/&gt;
org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:224)&lt;br/&gt;
org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:126)&lt;br/&gt;
org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:95)&lt;br/&gt;
org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:126)&lt;br/&gt;
...SpecialAuthorizationBroker.send(DynamicAuthorizationBroker.java:156)&lt;br/&gt;
org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:126)&lt;br/&gt;
org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:133)&lt;br/&gt;
org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:450)&lt;br/&gt;
org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:639)&lt;br/&gt;
org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:305)&lt;br/&gt;
org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)&lt;br/&gt;
org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)&lt;br/&gt;
org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:143)&lt;br/&gt;
org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:206)&lt;br/&gt;
org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)&lt;br/&gt;
org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:203)&lt;br/&gt;
org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:185)&lt;br/&gt;
java.lang.Thread.run(Thread.java:595)&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Name: ActiveMQ Transport: tcp:///127.0.0.1:48031&lt;br/&gt;
State: BLOCKED on org.apache.activemq.broker.region.Queue$2@102d82c owned by: ActiveMQ Transport: tcp:///127.0.0.1:49307&lt;br/&gt;
Total blocked: 3  Total waited: 0&lt;/p&gt;

&lt;p&gt;Stack trace: &lt;br/&gt;
org.apache.activemq.broker.region.Queue.iterate(Queue.java:951)&lt;br/&gt;
org.apache.activemq.broker.region.Queue.wakeup(Queue.java:1146)&lt;br/&gt;
org.apache.activemq.broker.region.Queue.removeMessage(Queue.java:1073)&lt;br/&gt;
org.apache.activemq.broker.region.QueueSubscription.acknowledge(QueueSubscription.java:51)&lt;br/&gt;
org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:238)&lt;br/&gt;
org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:373)&lt;br/&gt;
org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:462)&lt;br/&gt;
org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194)&lt;br/&gt;
org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)&lt;br/&gt;
org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)&lt;br/&gt;
org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)&lt;br/&gt;
org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)&lt;br/&gt;
org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:85)&lt;br/&gt;
org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:456)&lt;br/&gt;
org.apache.activemq.command.MessageAck.visit(MessageAck.java:205)&lt;br/&gt;
org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:305)&lt;br/&gt;
org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)&lt;br/&gt;
org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)&lt;br/&gt;
org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:143)&lt;br/&gt;
org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:206)&lt;br/&gt;
org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)&lt;br/&gt;
org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:203)&lt;br/&gt;
org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:185)&lt;br/&gt;
java.lang.Thread.run(Thread.java:595)&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12483083">AMQ-2356</key>
            <summary>optimizeDispatch=true and UseDedicatedTaskRunner=false lead to deadlocked queues</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="zakalwe">Mats Henrikson</reporter>
                        <labels>
                    </labels>
                <created>Mon, 17 Aug 2009 22:51:46 +0000</created>
                <updated>Fri, 4 Sep 2009 14:26:01 +0000</updated>
                            <resolved>Fri, 4 Sep 2009 14:26:01 +0000</resolved>
                                    <version>5.2.0</version>
                                    <fixVersion>5.3.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12941226" author="gtully" created="Tue, 18 Aug 2009 09:44:47 +0000"  >&lt;p&gt;have you tried to reproduce with a 5.3-SNAPSHOT?&lt;/p&gt;</comment>
                            <comment id="12941289" author="zakalwe" created="Tue, 18 Aug 2009 14:36:15 +0000"  >&lt;p&gt;I just downloaded the latest 5.3-SNAPSHOT dated Mon Aug 17 18:51:55 GMT+00:00 2009 and I can repro the deadlock.&lt;/p&gt;</comment>
                            <comment id="12941417" author="dave_stanley" created="Mon, 24 Aug 2009 14:35:42 +0000"  >&lt;p&gt;Have you tried with the nio transport?&lt;/p&gt;</comment>
                            <comment id="12941418" author="zakalwe" created="Mon, 24 Aug 2009 16:24:02 +0000"  >&lt;p&gt;Yes, but only in 5.2. Unfortunately I can&apos;t get the NIO transport to work at all, doing anything. I haven&apos;t had time yet to track down if I have misconfigured it or something. I have a task to investigate the NIO transport further and log a bug if I can&apos;t get that working either.&lt;/p&gt;</comment>
                            <comment id="12938375" author="rajdavies" created="Fri, 4 Sep 2009 14:26:01 +0000"  >&lt;p&gt;Fixed by SVN revision 811425&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>74971</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14ckn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>233500</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>