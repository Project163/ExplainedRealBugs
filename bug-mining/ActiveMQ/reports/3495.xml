<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:59:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-9625] Messages can become stuck on Queues</title>
                <link>https://issues.apache.org/jira/browse/AMQ-9625</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;For the last several years I have occasionally seen &quot;stuck&quot; messages that appear on queues that will not be dispatched until after a broker restart. The bug looks to be the same as described in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-2955&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-2955&lt;/a&gt; (the root cause was never figured out, it was just closed as they couldn&apos;t reproduce it). The resulting behavior seen is that KahaDB has the batch cursor set to a point after a message that is stored so that message will never dispatch.&#160; There&apos;s been some other work done previously to help this issue, notably &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3149&quot; title=&quot;concurrentStoreAndDispatchQueues when cache disabled can lead to skipped message dispatch, leaving message pending for some time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3149&quot;&gt;&lt;del&gt;AMQ-3149&lt;/del&gt;&lt;/a&gt; (more details in that issue and more below)&#160;&lt;/p&gt;

&lt;p&gt;I recently figured out how to reproduce it in a test environment and finally tracked down what the root cause and a fix. Not surprisingly, there are a few things at play here and the bug is a race condition so it won&apos;t be seen unless a bunch of things hold true (and if the broker is configured a certain way)&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Background%3A&quot;&gt;&lt;/a&gt;Background:&lt;/h3&gt;

&lt;p&gt;There are 2 optimizations that the broker uses that are playing into this and both must be enabled for the issue to happen.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;tt&gt;useCache=true&lt;/tt&gt; , The normal flow for incoming messages is that they get written to the store and then they get paged off disk (same thread or another thread) to be dispatched to consumers. However, there&apos;s also a message cache and if enabled and if there&apos;s free memory, the message will be added to the the cache after sending to disk so we don&apos;t need to re-read it off disk again later when dispatching.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;concurrentStoreAndDispatchQueues=true&lt;/tt&gt; The broker also has an optimization for queues where it it will try and dispatch incoming messages concurrently to consumers while also writing to disk. (Async message writes) if the consumers are fast enough to ack, we can cancel the disk write which saves disk IO and this obviously is a benefit for slow disks. This requires the cache to be enabled as described in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3149&quot; title=&quot;concurrentStoreAndDispatchQueues when cache disabled can lead to skipped message dispatch, leaving message pending for some time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3149&quot;&gt;&lt;del&gt;AMQ-3149&lt;/del&gt;&lt;/a&gt; otherwise we run into problems because messages won&apos;t be dispatched if not finished so this mode is really only useful for the cache being enabled. Furthermore, if the cache is not enabled messages could get stuck if no new messages come in for a while so that&apos;s another reason this mode has no effect if the cache is off.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The two settings work together and in practice this means the flow ends up being that the message is submitted to the store to be added as part of an async task that is queued up in the background by the store. While the task is in the queue, the message is then concurrently added to the in memory cache and the broker will proceed to dispatch to consumers, who may or may not acknowledge dispatched messages before the disk write is finished if the consumers are fast and keeping up. Messages that were already written are removed like normal but if the async task was not finished it gets cancelled and saves a disk write.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Bugdescription%3A&quot;&gt;&lt;/a&gt;Bug description:&lt;/h3&gt;

&lt;p&gt;When the broker runs out of memory to cache messages, the cache has to be &lt;a href=&quot;https://github.com/apache/activemq/blob/3400983a22284a28a8989d4b0aaf762090b0911a/activemq-broker/src/main/java/org/apache/activemq/broker/region/cursors/AbstractStoreCursor.java#L258&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;disabled&lt;/a&gt;. As part of this process the cache has to &lt;a href=&quot;https://github.com/apache/activemq/blob/3400983a22284a28a8989d4b0aaf762090b0911a/activemq-broker/src/main/java/org/apache/activemq/broker/region/cursors/AbstractStoreCursor.java#L336&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tell&lt;/a&gt; the store what the last message is that was cached so that when the cache is exhausted we can resume paging off disk and dispatching in the correct spot.&lt;/p&gt;

&lt;p&gt;The process for disabling the cache starts when a new incoming message is attempted to be added to the cache and it detects that memory is full. When this happens the process for disabling and syncing to the store starts and the cache goes through and makes sure any previously cached messages that may be pending to be written are completed (either acked and cancelled or written to disk and completed) and after that will tell the store where to resume, which would be after the last cached message. When the cache is disabled, new writes should &lt;a href=&quot;https://github.com/apache/activemq/blob/3400983a22284a28a8989d4b0aaf762090b0911a/activemq-broker/src/main/java/org/apache/activemq/broker/region/Queue.java#L895&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;no longer&lt;/a&gt; be async (&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3149&quot; title=&quot;concurrentStoreAndDispatchQueues when cache disabled can lead to skipped message dispatch, leaving message pending for some time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3149&quot;&gt;&lt;del&gt;AMQ-3149&lt;/del&gt;&lt;/a&gt;) because we need to have the messages written to disk to be dispatched and prevent stuck/delayed delivery.&lt;/p&gt;

&lt;p&gt;In theory, because the store was told the last cached message, the new incoming message that triggered the disabling/sync would be eventually paged off disk and dispatched. However, there is a race condition bug and what is actually happening is sometimes the new incoming message has not completed the write to the store when the queue goes to fill the next batch to dispatch (because it was async still), so it gets missed as it&apos;s still pending. Normally as described earlier, if the cache is disabled, all the new store writes should be sync and not async messages but in this case the message that triggered the disabling/sync was still submitted as async but never cached. Furthermore, if there are several producers you can have multiple in flight async messages that were submitted before the cache was disabled, but then by the time they get added to the cache the cache is seen as disabled and they are not added.&lt;/p&gt;

&lt;p&gt;The end result is that if the consumer and producers are very fast, you might have one or more pending async writes that are skipped by the cache because it was disabled so you get into a similar situation as &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-3149&quot; title=&quot;concurrentStoreAndDispatchQueues when cache disabled can lead to skipped message dispatch, leaving message pending for some time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-3149&quot;&gt;&lt;del&gt;AMQ-3149&lt;/del&gt;&lt;/a&gt; described, and when the cursor goes to page off the next messages it may not see the pending write(s) that haven&apos;t finished (and was not added to the cache) so those messages are skipped. By the time the incoming message is finished writing to the store, the disk cursor has moved past it and the message will be skipped and gets stuck until the broker restarts to reset the batch.&lt;/p&gt;

&lt;p&gt;This can happen repeatedly for cache enables/disables which is why you might see 1 stuck message or more if it repeatedly happens.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Solution%3A&quot;&gt;&lt;/a&gt;Solution:&lt;/h3&gt;

&lt;p&gt;The solution is actually rather simple and a couple lines of code. When the cache is disabled we just need to ensure that any messages that are in flight are now treated as sync and not async so they do not get missed as they will no longer be added to the memory in the cache.&lt;/p&gt;

&lt;p&gt;When a message added to the cache triggers the cache to disable, we just need to wait for its async task to finish so that it will be visible when reading in the next batch and paging off disk before we set the batch on the store. Also, lots of fast producers could cause other messages to be submitted as async just before the cache was disabled, and then by the time it reaches the cache they get skipped so we need to wait on those as well.&#160;&lt;/p&gt;

&lt;p&gt;Writing a unit test for this would be very difficult due to the race conditions an async going on, however these small changes are very simple and low risk as the only thing that is happening is we are just converting waiting on the async write to finish (converts them to sync) during the small window when the cache is toggled off which prevents the bug.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13599419">AMQ-9625</key>
            <summary>Messages can become stuck on Queues</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="cshannon">Christopher L. Shannon</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Nov 2024 17:08:16 +0000</created>
                <updated>Thu, 13 Mar 2025 16:56:55 +0000</updated>
                            <resolved>Thu, 21 Nov 2024 14:57:09 +0000</resolved>
                                    <version>5.18.6</version>
                    <version>6.1.4</version>
                                    <fixVersion>6.2.0</fixVersion>
                    <fixVersion>5.19.0</fixVersion>
                    <fixVersion>6.1.5</fixVersion>
                    <fixVersion>5.18.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="17900073" author="jira-bot" created="Thu, 21 Nov 2024 14:51:05 +0000"  >&lt;p&gt;Commit 7f218fe05d67117573329593a712ec420532810d in activemq&apos;s branch refs/heads/main from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=7f218fe05d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=7f218fe05d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9625&quot; title=&quot;Messages can become stuck on Queues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9625&quot;&gt;&lt;del&gt;AMQ-9625&lt;/del&gt;&lt;/a&gt; - Prevent queue messages from becoming stuck&lt;/p&gt;

&lt;p&gt;Fixes a race condition bug that can lead to a message being missed on&lt;br/&gt;
dispatch and stuck on a Queue until restart when caching and&lt;br/&gt;
concurrentStoreAndDispatch are enabled on a Queue and the cache becomes&lt;br/&gt;
disabled.&lt;/p&gt;</comment>
                            <comment id="17900074" author="jira-bot" created="Thu, 21 Nov 2024 14:51:05 +0000"  >&lt;p&gt;Commit bd91d9786156026ed4b1702cb0476aea51f1f4e2 in activemq&apos;s branch refs/heads/main from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=bd91d97861&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=bd91d97861&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #1355 from cshannon/&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9625&quot; title=&quot;Messages can become stuck on Queues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9625&quot;&gt;&lt;del&gt;AMQ-9625&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9625&quot; title=&quot;Messages can become stuck on Queues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9625&quot;&gt;&lt;del&gt;AMQ-9625&lt;/del&gt;&lt;/a&gt; - Prevent queue messages from becoming stuck&lt;/p&gt;</comment>
                            <comment id="17900077" author="jira-bot" created="Thu, 21 Nov 2024 14:55:45 +0000"  >&lt;p&gt;Commit 3d8ce8eec17e40c25441649ca2853fbd1778fb9e in activemq&apos;s branch refs/heads/activemq-6.1.x from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=3d8ce8eec1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=3d8ce8eec1&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9625&quot; title=&quot;Messages can become stuck on Queues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9625&quot;&gt;&lt;del&gt;AMQ-9625&lt;/del&gt;&lt;/a&gt; - Prevent queue messages from becoming stuck&lt;/p&gt;

&lt;p&gt;Fixes a race condition bug that can lead to a message being missed on&lt;br/&gt;
dispatch and stuck on a Queue until restart when caching and&lt;br/&gt;
concurrentStoreAndDispatch are enabled on a Queue and the cache becomes&lt;br/&gt;
disabled.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 7f218fe05d67117573329593a712ec420532810d)&lt;/p&gt;</comment>
                            <comment id="17900078" author="jira-bot" created="Thu, 21 Nov 2024 14:56:28 +0000"  >&lt;p&gt;Commit e33f44a7b967dcf7001988b7b15c7ff567170b5b in activemq&apos;s branch refs/heads/activemq-5.18.x from Christopher L. Shannon&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=e33f44a7b9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=e33f44a7b9&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9625&quot; title=&quot;Messages can become stuck on Queues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9625&quot;&gt;&lt;del&gt;AMQ-9625&lt;/del&gt;&lt;/a&gt; - Prevent queue messages from becoming stuck&lt;/p&gt;

&lt;p&gt;Fixes a race condition bug that can lead to a message being missed on&lt;br/&gt;
dispatch and stuck on a Queue until restart when caching and&lt;br/&gt;
concurrentStoreAndDispatch are enabled on a Queue and the cache becomes&lt;br/&gt;
disabled.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 7f218fe05d67117573329593a712ec420532810d)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="12483849">AMQ-2955</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12496260">AMQ-3149</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            50 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1so20:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>