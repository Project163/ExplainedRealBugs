<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:51:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-8287] Deadlock caused by synchronized on serviceRead() in NIOSSLTransport</title>
                <link>https://issues.apache.org/jira/browse/AMQ-8287</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I ran into a deadlock caused by the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-8169&quot; title=&quot;StompNIOSSLTest test fails with more recent JDK 8 versions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-8169&quot;&gt;&lt;del&gt;AMQ-8169&lt;/del&gt;&lt;/a&gt; when using Stomp NIOSSLTransport (but it could probably happen for other nio ssl transports)&lt;/p&gt;

&lt;p&gt;The newly added synchronized on the serviceRead() caused a deadlock between the transport and the TransportConnection. One thread acquired a lock on the TransportConnection and was waiting on serviceRead() to acquire the NIOSSLTransport lock. Another thread had was inside serviceRead() so it acquired the NIOSSLTransport lock and was then later waiting for the TransportConnection lock.&lt;/p&gt;

&lt;p&gt;The main issue is that processCommand(plain) ends up being protected by the lock and since there&apos;s multiple brokers/filters running we run into a deadlock (my current deadlock happened processing a ConsumerInfo command)&lt;/p&gt;

&lt;p&gt;To fix this we simply need to narrow the lock as it&apos;s too broad. The goal here was to protect the the reading off the channel concurrently (so really the secureRead() method so we can move the lock to secureRead() and not lock the entire serviceRead() call and that should fix the deadlock problem while still solving the initial issue which was demonstrated by the StompNIOSSL failing before this fix. I will open a new Jira shortly and push a fix.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13381704">AMQ-8287</key>
            <summary>Deadlock caused by synchronized on serviceRead() in NIOSSLTransport</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="cshannon">Christopher L. Shannon</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Jun 2021 13:33:29 +0000</created>
                <updated>Wed, 2 Jun 2021 17:55:57 +0000</updated>
                            <resolved>Wed, 2 Jun 2021 17:55:57 +0000</resolved>
                                    <version>5.15.15</version>
                    <version>5.16.2</version>
                                    <fixVersion>5.16.3</fixVersion>
                    <fixVersion>5.17.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3000">50m</timespent>
                                <comments>
                            <comment id="17355893" author="jira-bot" created="Wed, 2 Jun 2021 17:53:48 +0000"  >&lt;p&gt;Commit 2fcf2fd75f7c2a04151a2284595a08bf4c03240b in activemq&apos;s branch refs/heads/main from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=2fcf2fd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=2fcf2fd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-8287&quot; title=&quot;Deadlock caused by synchronized on serviceRead() in NIOSSLTransport&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-8287&quot;&gt;&lt;del&gt;AMQ-8287&lt;/del&gt;&lt;/a&gt; - fix NIOSSLTransport deadlock with serviceRead lock&lt;/p&gt;

&lt;p&gt;This narrows the lock that was added to serviceRead() to secureRead()&lt;br/&gt;
which prevents processing commands while locked which should solve the&lt;br/&gt;
deadlock issues&lt;/p&gt;</comment>
                            <comment id="17355894" author="jira-bot" created="Wed, 2 Jun 2021 17:53:49 +0000"  >&lt;p&gt;Commit ac27cc2cda1ac10d01bc87c1f875dcf278a9594f in activemq&apos;s branch refs/heads/main from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=ac27cc2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=ac27cc2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge branch &apos;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-8287&quot; title=&quot;Deadlock caused by synchronized on serviceRead() in NIOSSLTransport&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-8287&quot;&gt;&lt;del&gt;AMQ-8287&lt;/del&gt;&lt;/a&gt;&apos; into main&lt;/p&gt;

&lt;p&gt;This closes #666&lt;/p&gt;</comment>
                            <comment id="17355895" author="jira-bot" created="Wed, 2 Jun 2021 17:55:09 +0000"  >&lt;p&gt;Commit 0f952f72f798c5626dcd6270c9282e0e8988bd41 in activemq&apos;s branch refs/heads/activemq-5.16.x from Christopher L. Shannon (cshannon)&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=0f952f7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=0f952f7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-8287&quot; title=&quot;Deadlock caused by synchronized on serviceRead() in NIOSSLTransport&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-8287&quot;&gt;&lt;del&gt;AMQ-8287&lt;/del&gt;&lt;/a&gt; - fix NIOSSLTransport deadlock with serviceRead lock&lt;/p&gt;

&lt;p&gt;This narrows the lock that was added to serviceRead() to secureRead()&lt;br/&gt;
which prevents processing commands while locked which should solve the&lt;br/&gt;
deadlock issues&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 2fcf2fd75f7c2a04151a2284595a08bf4c03240b)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13362339">AMQ-8169</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 23 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0rl7c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>