<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:48:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2103] Memory leak when marshaling ActiveMQTextMessage to persistent store</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2103</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;When an org.apache.activemq.command.ActiveMQTextMessage is marshaled into the persistence store some portion of the messages are stored in memory (i.e. pending cursor/consumer dispatch queue).  The messages stored in memory have the potential to cause the broker to run out of memory because org.apache.activemq.command.ActiveMQTextMessage objects can store the data twice, once in the &apos;text&apos; field and once in the &apos;content&apos; field.  Normally this isn&apos;t a problem since the &apos;content&apos; field is cleared when the message is being used in a client application (i.e. by calling getText() clears content).  The problem occurs when a consumer is slow and a large number of messages are sitting around on the broker in pending/dispatch memory space.  The message is marshaled for the store and then persisted to disk and copied to pending memory when space is available.&lt;/p&gt;

&lt;p&gt;This bug affects any ActiveMQ*Message object that does not clear its temporary data (i.e. &apos;text&apos; field) once it has been marshaled.  When a message is marshaled we should null the derived objects memory space once the data has been written to the parent object&apos;s &apos;content&apos; field.&lt;/p&gt;</description>
                <environment>&lt;p&gt;ActiveMQ 5.0.0.20-fuse&lt;/p&gt;</environment>
        <key id="12483485">AMQ-2103</key>
            <summary>Memory leak when marshaling ActiveMQTextMessage to persistent store</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="tpounds">Trevor Pounds</reporter>
                        <labels>
                    </labels>
                <created>Tue, 10 Feb 2009 20:29:01 +0000</created>
                <updated>Tue, 14 Jun 2016 14:37:52 +0000</updated>
                            <resolved>Thu, 14 Oct 2010 11:24:48 +0000</resolved>
                                    <version>5.0.0</version>
                                    <fixVersion>5.4.2</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12940748" author="tpounds" created="Tue, 10 Feb 2009 20:30:23 +0000"  >&lt;p&gt;attaching memory usage diagram showing how the message data can be duplicated.&lt;/p&gt;</comment>
                            <comment id="12940756" author="tpounds" created="Tue, 10 Feb 2009 20:31:23 +0000"  >&lt;p&gt;attaching jhat heap analysis showing ActiveMQTextMessage object with duplicate data.&lt;/p&gt;</comment>
                            <comment id="12940762" author="tpounds" created="Tue, 10 Feb 2009 20:31:55 +0000"  >&lt;p&gt;attaching jhat heap analysis showing ActiveMQTextMessage-&amp;gt;ByteSequence object holding the byte array data.&lt;/p&gt;</comment>
                            <comment id="12940741" author="tpounds" created="Tue, 10 Feb 2009 20:32:20 +0000"  >&lt;p&gt;attaching jhat heap analysis showing ActiveMQTextMessage-&amp;gt;ByteSequence-&amp;gt;byte array object holding the message data.&lt;/p&gt;</comment>
                            <comment id="12940743" author="tpounds" created="Tue, 10 Feb 2009 20:33:35 +0000"  >&lt;p&gt;attaching patch that clears ActiveMQTextMessage &apos;text&apos; field data when marshaling.&lt;/p&gt;</comment>
                            <comment id="12940765" author="tpounds" created="Tue, 10 Feb 2009 21:07:01 +0000"  >&lt;p&gt;I also forgot to mention that this probably only affects use cases with something like vm transport where the message stays internal to the same JVM and is not marshaled across the wire.&lt;/p&gt;</comment>
                            <comment id="12940764" author="tpounds" created="Tue, 10 Feb 2009 22:21:00 +0000"  >&lt;p&gt;attaching heap usage graph comparing memory before and after applying patch &lt;/p&gt;</comment>
                            <comment id="12940738" author="rajdavies" created="Wed, 11 Feb 2009 07:34:54 +0000"  >&lt;p&gt;Patch applied in SVN revision 743258&lt;/p&gt;</comment>
                            <comment id="12940769" author="tpounds" created="Wed, 11 Feb 2009 17:22:45 +0000"  >&lt;p&gt;Rob did you look at all to see if this affects other message types (i.e. ActiveMQObjectMessage, ActiveMQMapMessage)?  I believe some of these these suffer from the same problem.&lt;/p&gt;</comment>
                            <comment id="12943045" author="gtully" created="Mon, 11 Oct 2010 16:23:52 +0000"  >&lt;p&gt;This fix breaks the topic case with multiple consumers and a vm transport producer. There is contention over marshaling so whacking the marshaled state is not possible, results in missing content for some of the consumers. &lt;a href=&quot;https://issues.apache.org/activemq/browse/AMQ-2966&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/AMQ-2966&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Think the fix is to have an reduceMemoryFootprint policy option that when enabled for queues, will clear the marshaled state (can work for map and object messages also) when the message is first persisted. This is a natural sync point that is contention free provided the concurrentStoreAndDispatchQueue KahaDB option that tries to optimize out persistence, is not enabled.&lt;/p&gt;
</comment>
                            <comment id="12943042" author="gtully" created="Mon, 11 Oct 2010 19:18:08 +0000"  >&lt;p&gt;patch reverted and new policy based solution applied in r1021466&lt;/p&gt;

&lt;p&gt;The patch, setting the text attribute to null, was unprotected. Currently there are no destructive operations, on a message, allowing it to be shared across topic consumers without synchronization, which allows concurrent dispatch to be fast. This is important to maintain.&lt;/p&gt;

&lt;p&gt;A new destination policy for queues, boolean attribute reduceMemoryFootprint has been introduced to do meet this use case.&lt;br/&gt;
When true, the marshaled state of a message will be cleared once the message is persisted in the store. This is a natural, contention free sync point.&lt;br/&gt;
Note:  The kahaDB concurrentStoreAndForwardQueues option (which introduces concurrency) and the memory persistence adapter (which will not marshall) are not compatible with this new policy.&lt;/p&gt;

&lt;p&gt;Trevor, can you validate that this change meet your use case?&lt;/p&gt;</comment>
                            <comment id="12943048" author="tpounds" created="Tue, 12 Oct 2010 04:13:37 +0000"  >&lt;p&gt;This fix looks like it will work but I do have some concerns implementing it as a destination policy. Wouldn&apos;t it make more sense to implement this using SoftReferences or a hook into the MarshallAware interface?  In my opinion it makes sense to clear memory at the discretion of the collector when the message has been completely serialized to disk when there is not enough memory. The actual problem I was trying to solve was to prevent &quot;hidden&quot; memory from hanging around that was not tied to the ActiveMQ memory usage policies. I could be missing something here but it seems there are disjoint philosophies for memory management related to overall broker memory usage, fast dispatch cursors and other unaccounted for &quot;live&quot; objects. I&apos;m not sure what to do here but the proposed fix (including my original submission) seems like a kludge at best. Does anyone else have other opinions?&lt;/p&gt;</comment>
                            <comment id="12942818" author="gtully" created="Tue, 12 Oct 2010 09:30:43 +0000"  >&lt;p&gt;I think there is merit in the original use case, but soft references would not cut it as the messages are retained in memory by the cursors and there is duplication. The key issue with any destruction of a message in memory is that it requires a sync point. A general MarshallAware interface hook would require a sync on message that would have a large impact on scaleability of topics.&lt;/p&gt;

&lt;p&gt;I agree, that there needs to be some tie with available vm memory and cursor memory usage, but that sort of scheme would require major surgery atm.&lt;/p&gt;

&lt;p&gt;Memory management is something that is central to the amq 6.0 (apollo) architecture. &lt;/p&gt;</comment>
                            <comment id="12943053" author="gtully" created="Thu, 14 Oct 2010 11:24:48 +0000"  >&lt;p&gt;resolving. &lt;br/&gt;
addressing any further limitations to the memory usage tracking as it pertains to actual jvm usage will be punted to 6.0&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12839815">AMQ-5857</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12978816">AMQ-6323</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12461209" name="AMQ-2103.diff" size="563" author="tpounds" created="Tue, 10 Feb 2009 20:33:35 +0000"/>
                            <attachment id="12461351" name="Duplicate Message Data (Internal Marshalling).png" size="78474" author="tpounds" created="Tue, 10 Feb 2009 20:30:23 +0000"/>
                            <attachment id="12461297" name="heap_100_1MB_messages.png" size="94871" author="tpounds" created="Tue, 10 Feb 2009 22:21:00 +0000"/>
                            <attachment id="12461251" name="jhat_ActiveMQTextMessage_0xe837a478.htm" size="3683" author="tpounds" created="Tue, 10 Feb 2009 20:31:23 +0000"/>
                            <attachment id="12461208" name="jhat_ByteSequence_0xe837a5c0.htm" size="1108" author="tpounds" created="Tue, 10 Feb 2009 20:31:55 +0000"/>
                            <attachment id="12461285" name="jhat_ByteSequence_data_0xe837adb0.htm" size="6048" author="tpounds" created="Tue, 10 Feb 2009 20:32:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14757</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 6 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0b9xz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63723</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>