<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:47:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2764] For &quot;duplex&quot; network connection,  after restart one ActiveMQ,  message is missing.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2764</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I have two AMQ setup.  And they use duplex network connection between.   After I restart one ActiveMQ which initiates the connection,  half of the message are missing.    In order to avoid this problem,  I have restart the other ActiveMQ.   And this  happens when I use &quot;staticallyIncludedDestinations&quot; or &quot;dynamicallyIncludedDestinations&quot; config in broker.&lt;/p&gt;

&lt;p&gt;1 SETUP:&lt;br/&gt;
a) SCA server has a network connector to remote server114.  In order to repeat this problem, you have to use &quot;staticallyIncludedDestinations&quot;.&lt;/p&gt;

&lt;p&gt;&amp;lt;networkConnector name=&quot;SCA&quot; uri=&quot;static://(&lt;a href=&quot;https://192.168.3.114:61617&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://192.168.3.114:61617&lt;/a&gt;)&quot; duplex=&quot;true&quot;&amp;gt;&lt;br/&gt;
               &amp;lt;staticallyIncludedDestinations&amp;gt;&lt;br/&gt;
                              &amp;lt;queue physicalName=&quot;R&quot;/&amp;gt;&lt;br/&gt;
               &amp;lt;/staticallyIncludedDestinations&amp;gt;&lt;br/&gt;
&amp;lt;/networkConnector&amp;gt;&lt;/p&gt;

&lt;p&gt;b) SCA server has a java code consumer listening on queue R:&lt;/p&gt;

&lt;p&gt;c)  Remote server114 is listening on 61617, see config below;&lt;br/&gt;
&amp;lt;transportConnectors&amp;gt; &lt;br/&gt;
           &amp;lt;transportConnector name=&quot;openwire&quot; uri=&quot;tcp://0.0.0.0:61616&quot;/&amp;gt; &lt;br/&gt;
           &amp;lt;transportConnector name=&quot;https&quot; uri=&quot;https://0.0.0.0:61617?needClientAuth=true&quot;/&amp;gt; &lt;br/&gt;
&amp;lt;/transportConnectors&amp;gt; &lt;br/&gt;
(See attached picture &quot;Remote-Console1.jpg&quot;.)&lt;/p&gt;

&lt;p&gt;2. Restart activemq on SCA server and restart consumer application listening on queue R on SCA too.  Remote server114 activemq admin console shows there are two consumers on R. &lt;br/&gt;
(See attached picture &quot;Remote-Console2.jpg&quot;)&lt;/p&gt;

&lt;p&gt;3 Start a producer on remote server114 to send 10 messages to R.  On SCA server, consumer on R  only receives 5 messages.&lt;br/&gt;
(See attached picture &quot;SCA-consumer1.JPG&quot;)&lt;/p&gt;

&lt;p&gt;4. On remote server114 activemq admin console, these 10 messages are divided by these two consumers.&lt;br/&gt;
(See attached picture &quot;Remote-Console3.jpg&quot;)&lt;/p&gt;

</description>
                <environment>&lt;p&gt;Windows2k3,  AMQ 5.3.1, &lt;/p&gt;</environment>
        <key id="12483855">AMQ-2764</key>
            <summary>For &quot;duplex&quot; network connection,  after restart one ActiveMQ,  message is missing.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                            <parent id="12483840">AMQ-3021</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="qingyi">Qingyi Gu</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Jun 2010 18:33:10 +0000</created>
                <updated>Fri, 5 Nov 2010 23:04:43 +0000</updated>
                            <resolved>Fri, 27 Aug 2010 11:58:10 +0000</resolved>
                                    <version>5.3.1</version>
                                    <fixVersion>5.4.1</fixVersion>
                    <fixVersion>5.4.2</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12942478" author="lcurry" created="Mon, 12 Jul 2010 13:47:25 +0000"  >&lt;p&gt;Steps to reproduce the issue&lt;br/&gt;
----------------------------------&lt;br/&gt;
To reproduce this issue I installed apache-activemq-5.3.2 in two separate locations. The scenario simulates a hub and spoke architecture in which the hub (Broker1) will be connected (via a networkConnector) to Broker2. The network connector uses &quot;http&quot; rather than &quot;tcp&quot; for connection between brokers. This is a requirement for customer because customer  broker connection must traverse distinct networks. Note the problem does not seem to occur when &quot;tcp&quot; is used. The networkConnector also defines a &quot;staticallyIncludedDestination&quot;.&lt;/p&gt;

&lt;p&gt;The problem happens when Broker1 is shutdown and restarted. After that, the networkConnector (store and forward)&lt;br/&gt;
mechanism seems to break. Messages that should be available to a consumer in queue on Broker1 are not sent to consumer&lt;br/&gt;
and appear to be lost.  &lt;/p&gt;

&lt;p&gt;The actual config details are given below. Also attached are the activemq.xml files for Broker1 and Broker2.&lt;/p&gt;

&lt;p&gt;1)	Update activemq.xml for Broker1.&lt;br/&gt;
The changes to the default configuration for Broker1 include the following: &lt;br/&gt;
&#8226;	Change the broker name from localhost to Broker1&lt;br/&gt;
&#8226;	Add networkConnector to Broker2.&lt;/p&gt;

&lt;p&gt;    &amp;lt;broker xmlns=&quot;http://activemq.apache.org/schema/core&quot; useJmx=&quot;true&quot; brokerName=&quot;BROKER1&quot; dataDirectory=&quot;${activemq.base}&lt;br/&gt;
/data&quot; destroyApplicationContextOnStop=&quot;true&quot; &amp;gt;&lt;/p&gt;

&lt;p&gt;...&lt;br/&gt;
...&lt;br/&gt;
      &amp;lt;networkConnectors&amp;gt;&lt;br/&gt;
              &amp;lt;networkConnector name=&quot;SCA&quot; uri=&quot;static://(&lt;a href=&quot;http://localhost:61617&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:61617&lt;/a&gt;)&quot; duplex=&quot;true&quot;&amp;gt;&lt;br/&gt;
                      &amp;lt;staticallyIncludedDestinations&amp;gt;&lt;br/&gt;
                      &amp;lt;queue physicalName=&quot;R&quot;/&amp;gt;&lt;br/&gt;
                      &amp;lt;/staticallyIncludedDestinations&amp;gt;&lt;br/&gt;
              &amp;lt;/networkConnector&amp;gt;&lt;br/&gt;
      &amp;lt;/networkConnectors&amp;gt;&lt;/p&gt;


&lt;p&gt;2)	Update the activemq.xml for Broker2&lt;br/&gt;
The changes to the default configuration for Broker2 include the following:&lt;br/&gt;
&#8226;	Change the broker name from localhost to Broker2&lt;br/&gt;
&#8226;	Change the default transport connector (tcp) to listen on 61618 (to avoid conflict with Broker1&apos;s tcp port)&lt;br/&gt;
&#8226;	Add an transport connector (http) for port 61617. This is the port that will be connected to by Broker1.&lt;/p&gt;

&lt;p&gt;    &amp;lt;broker xmlns=&quot;http://activemq.apache.org/schema/core&quot; useJmx=&quot;true&quot; brokerName=&quot;BROKER2&quot; dataDirectory=&quot;${activemq.base}&lt;br/&gt;
/data&quot; destroyApplicationContextOnStop=&quot;true&quot;&amp;gt;&lt;br/&gt;
...&lt;br/&gt;
...&lt;br/&gt;
       &amp;lt;transportConnectors&amp;gt;&lt;br/&gt;
           &amp;lt;transportConnector name=&quot;openwire&quot; uri=&quot;tcp://0.0.0.0:61618&quot;/&amp;gt;&lt;br/&gt;
           &amp;lt;transportConnector name=&quot;http&quot; uri=&quot;http://0.0.0.0:61617&quot;/&amp;gt;&lt;br/&gt;
       &amp;lt;/transportConnectors&amp;gt;&lt;/p&gt;



&lt;p&gt;3)	Start Broker2 using the activemq.bat script in Broker2&apos;s installation /bin directory.&lt;br/&gt;
4)	Start Broker1 using the activemq.bat script in Broker1&apos;s installation /bin directory.&lt;/p&gt;


&lt;p&gt;5)	Run simple producer/consumer scenarios.&lt;br/&gt;
a)	Run consumer against 61616 (Broker1).&lt;br/&gt;
 Go to Broker1&apos;s example directory:&lt;br/&gt;
E.g.&lt;br/&gt;
C:\Progress\apache-activemq-5.3.2\example&lt;br/&gt;
Run the following:&lt;/p&gt;

&lt;p&gt;&#61656;	ant consumer -Durl=tcp://localhost:61616 -Dmax=100 -Dsubject=R&lt;br/&gt;
The above command will connect to Broker1 and listen for 100 messages on queue R on Broker1&lt;/p&gt;

&lt;p&gt;b)	Next in another window - same directory - run the following:&lt;br/&gt;
&#61656;	ant producer -Durl=tcp://localhost:61616 -Dmax=10 -Dsubject=R&lt;br/&gt;
The above command will connect to Broker1 and send 10 messages to queue R on Broker1&lt;/p&gt;

&lt;p&gt;You should see the consumer will receive the 10 messages.&lt;br/&gt;
c)	Next, Run producer to send messages to Broker2:&lt;br/&gt;
&#61656;	ant producer -Durl=tcp://localhost:61618 -Dmax=10 -Dsubject=R&lt;br/&gt;
Because of the networkConnector set up for queue R between Broker1-&amp;gt;Broker2, the consumer (that was already running and connected to Broker1) should also receive these 10 messages that were sent to queue R on Broker2.&lt;/p&gt;

&lt;p&gt;6)	Shutdown Broker1 and restart.&lt;/p&gt;

&lt;p&gt;7)	Run step 5 again. You will see when you run the producer the second time (step 5c) that not all the messages get to the consumer connected to queue R on Broker1. Only every other message arrive at consumer. &lt;/p&gt;

&lt;p&gt;You can shutdown Broker1 and repeat step 5 over and over and each time you will see fewer and fewer messages arrive at consumer connected to queue R on Broker1.  Where do these messages go?&lt;/p&gt;

&lt;p&gt;Information from jconsole&lt;br/&gt;
-------------------------------&lt;br/&gt;
While running this test case, start jconsole and attach to each of the brokers.&lt;br/&gt;
On Broker2 open the MBeans tab and expand activemq-&amp;gt;BROKER2-&amp;gt;Subscription-&amp;gt;Non-Durable-&amp;gt;Queue-&amp;gt;R-&amp;gt;NC_BROKER1_inbound_BROKER2&lt;br/&gt;
This will show the subscription created on Broker2 by the networkConnector.&lt;br/&gt;
Each time you shutdown Broker1 and restart, jconsole will show a new Subscription created in Broker2.&lt;/p&gt;</comment>
                            <comment id="12937720" author="slewis" created="Mon, 23 Aug 2010 20:48:03 +0000"  >&lt;p&gt;I&apos;ve put together a test case (attached test-case.txt) similar to the NetworkReconnectTest that specifically goes through the steps in Lowry&apos;s description but I can&apos;t seem to reproduce this on trunk.  Have you tried this on the 5.4 release or on the latest snapshot?&lt;/p&gt;</comment>
                            <comment id="12936737" author="qingyi" created="Tue, 24 Aug 2010 13:03:53 +0000"  >&lt;p&gt;I just tested with AMQ5.4.0 release,  the problem still exists.  I looked at your activemq config in your test case.  I think you have broker1 and broker2 reversed based on Lowry&apos;s description.   There is one little typo in Lowry&apos;s comment.   In his first step &quot;1) Update activemq.xml for Broker1.&quot;,  it should be &quot;Add networkConnector to Broker1&quot;, not  &quot;Add networkConnector to Broker2.&quot;.&lt;/p&gt;</comment>
                            <comment id="12936422" author="slewis" created="Tue, 24 Aug 2010 20:58:30 +0000"  >&lt;p&gt;Thanks for that, have re-worked the test case and it does reproduce the issue now, have attached an update.&lt;/p&gt;</comment>
                            <comment id="12937216" author="gtully" created="Wed, 25 Aug 2010 11:46:41 +0000"  >&lt;p&gt;it looks like due to http being async the bridge does not get torn down when the remote broker shutsdown as is the case with a tcp connection. With tcp there is always an outstanding read that will fail. It looks like the failed read is is being retried in the http case.&lt;br/&gt;
It may be a case of configuring retry semantics for http client but I think it may need some duplicate detection of network connectors based on name or something. need to research it a bit.&lt;/p&gt;</comment>
                            <comment id="12942762" author="gtully" created="Fri, 27 Aug 2010 11:58:10 +0000"  >&lt;p&gt;fix in r990107&lt;/p&gt;

&lt;p&gt;InactivityMonitor added to http transport by default. May be disabled via query parameters useInactivityMonitor=false for clients and transport.useInactivityMonitor=false on the broker side.&lt;br/&gt;
The default 30second timeout can be configured via url query params:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:61617?transport.readCheckTime=4000&amp;amp;amp;transport.initialDelayTime=4000&quot;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; For a duplex network connector, these are applied to the target broker http listener so that they apply to the return network connector transport connection.&lt;br/&gt;
test case included, was a great help, thanks.&lt;/p&gt;</comment>
                            <comment id="12942996" author="dejanb" created="Wed, 6 Oct 2010 13:44:44 +0000"  >&lt;p&gt;An additional fix that enables transport options to persist connector restart has been committed with svn revision 1005033 and will be available in 5.5.0&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12483467">AMQ-2831</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12483475">AMQ-2894</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12461725" name="Remote-Console1.JPG" size="57083" author="qingyi" created="Fri, 4 Jun 2010 18:34:45 +0000"/>
                            <attachment id="12461726" name="Remote-Console2.JPG" size="58419" author="qingyi" created="Fri, 4 Jun 2010 18:34:46 +0000"/>
                            <attachment id="12461727" name="Remote-Console3.JPG" size="58176" author="qingyi" created="Fri, 4 Jun 2010 18:34:46 +0000"/>
                            <attachment id="12461728" name="SCA-consumer1.JPG" size="43171" author="qingyi" created="Fri, 4 Jun 2010 18:35:09 +0000"/>
                            <attachment id="12461681" name="test-case.txt" size="14850" author="slewis" created="Tue, 24 Aug 2010 20:58:30 +0000"/>
                            <attachment id="12461674" name="test-case.txt" size="9428" author="slewis" created="Mon, 23 Aug 2010 20:48:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14842</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 7 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0b9zb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63729</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>