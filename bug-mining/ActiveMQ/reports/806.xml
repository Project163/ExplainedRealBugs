<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:44:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-2567] Zero Prefetch not working</title>
                <link>https://issues.apache.org/jira/browse/AMQ-2567</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I have problems using the zero prefetch. The consumer starts prefetching messages after some receives. &lt;/p&gt;

&lt;p&gt;Our use case is, that we have a large computation which is split into smaller sub jobs. These jobs are sent via ActiveMQ to some processing nodes on different machines. The duration of jobs differs very much (10s to some minutes). The jobs are sent by decreasing estimated computation time. If one of the consumers which receives a large job prefetches some other jobs, these will be processed later. In the meantime the remaining consumers are idle, and the total computation time is much longer than necessary.&lt;/p&gt;

&lt;p&gt;I have modified the existing ZeroPrefetchConsumerTest to test for the problem (I have removed the other test methods). &lt;/p&gt;

&lt;p&gt;Two consumers (C1  and C2) are instantiated. These messages are sent:&lt;br/&gt;
1,2,3,4,5,6,7,8,9&lt;/p&gt;

&lt;p&gt;C1 reads 4 times, receives 1,2,3,4 -&amp;gt; this is correct&lt;/p&gt;

&lt;p&gt;now C2 reads, it receives 8 not 5, which is the next message in the queue. The reason is, that C1 prefetched 5, 6, 7, that should not have happened.(sometimes C1 only prefetches 5,6)&lt;/p&gt;

&lt;p&gt;The problem can be seen in the JMX Console as well, after a while, the first consumer has more than one dispatched message and the queue has an InflightCount of 3, although there are only two consumers!&lt;/p&gt;

&lt;p&gt;The last version that we used was 4.1.1, that worked.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Unix/Windows, Java 1.6&lt;/p&gt;</environment>
        <key id="12483209">AMQ-2567</key>
            <summary>Zero Prefetch not working</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="rudolf_janz">Rudolf Janz</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 Jan 2010 14:26:28 +0000</created>
                <updated>Thu, 28 Jan 2010 10:49:37 +0000</updated>
                            <resolved>Wed, 20 Jan 2010 16:45:48 +0000</resolved>
                                    <version>5.3.0</version>
                                    <fixVersion>5.3.1</fixVersion>
                    <fixVersion>5.4.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12942007" author="rudolf_janz" created="Thu, 14 Jan 2010 14:29:21 +0000"  >&lt;p&gt;Extended the test case to send more than one messages and listen and receiving on two consumers.&lt;/p&gt;</comment>
                            <comment id="12942006" author="rudolf_janz" created="Thu, 14 Jan 2010 16:28:03 +0000"  >&lt;p&gt;Gary Tully wrote:&lt;br/&gt;
PrefetchSubscription and prefetchExtension on a deliveryAck in a transaction &lt;br/&gt;
are areas that you need to look into to resolve this. Great that you have a &lt;br/&gt;
simple junit test case.&lt;br/&gt;
&amp;#8212;&lt;/p&gt;

&lt;p&gt;You are right, prefetchExtension is the problem. I do not understand the reason for it. If I want prefetch 0, it should stay that way. Right now it is increased on each pull.&lt;/p&gt;

&lt;p&gt;In acknowledge there is the following comment &lt;br/&gt;
      if (context.isInTransaction()) {&lt;br/&gt;
              // extend prefetch window only if not a pulling consumer&lt;br/&gt;
                                if (getPrefetchSize() != 0) {&lt;br/&gt;
                                    prefetchExtension = Math.max(&lt;br/&gt;
                                            prefetchExtension, index );&lt;/p&gt;

&lt;p&gt;In PrefetchSubscription::pullMessage it checks for prefetchSize 0 &lt;br/&gt;
        if (getPrefetchSize() == 0 &amp;amp;&amp;amp; !isSlave()) {&lt;br/&gt;
            final long dispatchCounterBeforePull;&lt;br/&gt;
        	synchronized(this) &lt;/p&gt;
{
        		prefetchExtension++;
        		dispatchCounterBeforePull = dispatchCounter;
        	}</comment>
                            <comment id="12942005" author="gtully" created="Thu, 14 Jan 2010 17:42:54 +0000"  >&lt;p&gt;so the prefetchExtension is the mechanism by which a message is dispatched to a consumer with prefetch=0. Each receive() sends a pull if there are no messages which increments the prefetchExtension so another message is dispatched. With a prefetch of 0, you should only be able to get one message at a time.&lt;/p&gt;

&lt;p&gt;I think a deliveredAck may be the problem, a delivered ack uses the prefetchextension to ensure that within a transaction it is possible to read past the prefetch limit. If prefetch=0, a pulling consumer, it should not do that. Check to see if you are getting an ack with ackType=0.&lt;/p&gt;

&lt;p&gt;if so, either the logic with a standard ack needs to be duplicated with a deliveredAck or the delivery ack needs to be suppressed on the consumer. &lt;/p&gt;</comment>
                            <comment id="12942004" author="rudolf_janz" created="Thu, 14 Jan 2010 18:31:51 +0000"  >&lt;p&gt;Ok, I unterstand now, what it is for.&lt;br/&gt;
Then I guess prefetchExtension should be reset to 0 again after the transaction? But it kept increasing.  &lt;/p&gt;

&lt;p&gt;I will have a look at the Ack logic tomorrow.&lt;/p&gt;</comment>
                            <comment id="12942009" author="rudolf_janz" created="Fri, 15 Jan 2010 11:40:44 +0000"  >&lt;p&gt;So I added a printout in the client (Expecting/Read) and in the PrefetchSubscribtion for all Acks,&lt;br/&gt;
C1/2 are the consumer n is the number of acked messaged. This is how it happens&lt;/p&gt;

&lt;p&gt;Expecting Msg1&lt;br/&gt;
Read Msg1&lt;br/&gt;
C1: n:1 isDeliveredAck(Before): 1&lt;br/&gt;
C1: n:1 isDeliveredAck(After): 1&lt;br/&gt;
C1: n:1 isStandardAckXA(Before): 1&lt;br/&gt;
C1: n:1 isStandardAckXA(After): 1&lt;br/&gt;
Expecting Msg2&lt;br/&gt;
C1: n:1 isDeliveredAck(Before): &lt;b&gt;2&lt;/b&gt;  This is wrong it should be in the same state as before the message 1, should have been &lt;br/&gt;
C1: n:1 isDeliveredAck(After): 2&lt;br/&gt;
Read Msg2&lt;br/&gt;
C1: n:1 isStandardAckXA(Before): 2&lt;br/&gt;
C1: n:1 isStandardAckXA(After): 2&lt;br/&gt;
Expecting Msg3&lt;br/&gt;
C1: n:1 isDeliveredAck(Before): 2&lt;br/&gt;
C1: n:1 isDeliveredAck(After): 2&lt;br/&gt;
Read Msg3&lt;br/&gt;
C1: n:1 isStandardAckXA(Before): 2&lt;br/&gt;
C1: n:1 isStandardAckXA(After): 2&lt;br/&gt;
Expecting Msg4&lt;br/&gt;
Read Msg4&lt;br/&gt;
C1: n:1 isDeliveredAck(Before): 3&lt;br/&gt;
C1: n:1 isDeliveredAck(After): 3&lt;br/&gt;
C1: n:1 isStandardAckXA(Before): 3&lt;br/&gt;
C1: n:1 isStandardAckXA(After): 3&lt;br/&gt;
Expecting Msg5&lt;br/&gt;
Read Msg8&lt;br/&gt;
C2: n:1 isDeliveredAck(Before): 1&lt;br/&gt;
C2: n:1 isDeliveredAck(After): 1&lt;br/&gt;
C2: n:1 isStandardAckXA(Before): 1&lt;br/&gt;
C2: n:1 isStandardAckXA(After): 1&lt;/p&gt;

&lt;p&gt;I think the problem is in the standardAck, this should decrement prefetchIndex. But I guess I am forgetting something (I extended receiving two messages in the transaction in the test case) &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ack.isStandardAck()) {
                   ...
                            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (context.isInTransaction()) {
                                &lt;span class=&quot;code-comment&quot;&gt;// extend prefetch window only &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; not a pulling
&lt;/span&gt;                                &lt;span class=&quot;code-comment&quot;&gt;// consumer
&lt;/span&gt;                                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(prefix+&lt;span class=&quot;code-quote&quot;&gt;&quot;isStandardAckXA(Before): &quot;&lt;/span&gt; +prefetchExtension);
&lt;span class=&quot;code-comment&quot;&gt;//RJ                                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getPrefetchSize() != 0) {
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//RJ                                   prefetchExtension = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(prefetchExtension, index );
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//RJ                               }
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//RJ &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; the same as in the non transacted &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;
&lt;/span&gt;                                prefetchExtension = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(0,    prefetchExtension - index);
                                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(prefix+&lt;span class=&quot;code-quote&quot;&gt;&quot;isStandardAckXA(After): &quot;&lt;/span&gt; +prefetchExtension);
                            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(prefix+&lt;span class=&quot;code-quote&quot;&gt;&quot;isStandardAck(Before): &quot;&lt;/span&gt; +prefetchExtension);
                                prefetchExtension = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(0,
}}
                                        prefetchExtension - index);
                                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(prefix+&lt;span class=&quot;code-quote&quot;&gt;&quot;isStandardAck(After): &quot;&lt;/span&gt; +prefetchExtension);
                            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Expecting Msg1&lt;br/&gt;
Read Msg1&lt;br/&gt;
C1: n:1 isDeliveredAck(Before): 1&lt;br/&gt;
C1: n:1 isDeliveredAck(After): 1&lt;br/&gt;
C1: n:1 isStandardAckXA(Before): 1&lt;br/&gt;
C1: n:1 isStandardAckXA(After): 0&lt;br/&gt;
Expecting Msg2&lt;br/&gt;
Read Msg2&lt;br/&gt;
C1: n:1 isDeliveredAck(Before): 1&lt;br/&gt;
C1: n:1 isDeliveredAck(After): 1&lt;br/&gt;
C1: n:1 isStandardAckXA(Before): 1&lt;br/&gt;
C1: n:1 isStandardAckXA(After): 0&lt;br/&gt;
Expecting Msg3&lt;br/&gt;
Read Msg3&lt;br/&gt;
C1: n:1 isDeliveredAck(Before): 1&lt;br/&gt;
C1: n:1 isDeliveredAck(After): 1&lt;br/&gt;
C1: n:1 isStandardAckXA(Before): 1&lt;br/&gt;
C1: n:1 isStandardAckXA(After): 0&lt;br/&gt;
Expecting Msg4&lt;br/&gt;
C1: n:1 isDeliveredAck(Before): 1&lt;br/&gt;
C1: n:1 isDeliveredAck(After): 1&lt;br/&gt;
Read Msg4&lt;br/&gt;
C1: n:1 isStandardAckXA(Before): 1&lt;br/&gt;
C1: n:1 isStandardAckXA(After): 0&lt;br/&gt;
Expecting Msg5&lt;br/&gt;
C2: n:1 isDeliveredAck(Before): 1&lt;br/&gt;
C2: n:1 isDeliveredAck(After): 1&lt;br/&gt;
Read Msg5&lt;br/&gt;
C2: n:1 isStandardAckXA(Before): 1&lt;br/&gt;
C2: n:1 isStandardAckXA(After): 0&lt;br/&gt;
Expecting Msg6&lt;br/&gt;
Read Msg6&lt;br/&gt;
Expecting Msg7&lt;br/&gt;
C1: n:1 isDeliveredAck(Before): 1&lt;br/&gt;
C1: n:1 isDeliveredAck(After): 1&lt;br/&gt;
Read Msg7&lt;br/&gt;
C1: n:1 isDeliveredAck(Before): 2&lt;br/&gt;
C1: n:1 isDeliveredAck(After): 2&lt;br/&gt;
C1: n:2 isStandardAckXA(Before): 2&lt;br/&gt;
C1: n:2 isStandardAckXA(After): 0&lt;br/&gt;
Expecting Msg8&lt;br/&gt;
Read Msg8&lt;br/&gt;
C2: n:1 isDeliveredAck(Before): 1&lt;br/&gt;
C2: n:1 isDeliveredAck(After): 1&lt;br/&gt;
C2: n:1 isStandardAckXA(Before): 1&lt;br/&gt;
C2: n:1 isStandardAckXA(After): 0&lt;/p&gt;

&lt;p&gt;THis look ok to me now&lt;/p&gt;</comment>
                            <comment id="12942010" author="rudolf_janz" created="Fri, 15 Jan 2010 11:42:36 +0000"  >&lt;p&gt;Here is the extended TestCase and the Subscribtion class including the printouts&lt;/p&gt;</comment>
                            <comment id="12942041" author="gtully" created="Wed, 20 Jan 2010 16:45:48 +0000"  >&lt;p&gt;Thanks for the test case, debugging and fix. &lt;br/&gt;
Fix with small modification applied to trunk in r901269 and 5.3.1 in r901271&lt;/p&gt;</comment>
                            <comment id="12942085" author="kutzi" created="Wed, 27 Jan 2010 17:28:33 +0000"  >&lt;p&gt;Was the fix already released as part of a snapshot release available at &lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/&lt;/a&gt; ?&lt;br/&gt;
Judging by the JAR file dates I would say no.&lt;/p&gt;

&lt;p&gt;If not, when can I expect a snapshot release which includes the fix?&lt;/p&gt;</comment>
                            <comment id="12942084" author="gtully" created="Wed, 27 Jan 2010 18:39:46 +0000"  >&lt;p&gt;most of the artifacts are there but the release full tar or zip files still have not been updated for the 5.4-SNAPSHOT - need to check why hudson has not done it, it may be pending a full clean build. Some test failures were resolved today so it should be real soon.&lt;/p&gt;</comment>
                            <comment id="12942098" author="kutzi" created="Thu, 28 Jan 2010 08:24:00 +0000"  >&lt;p&gt;Seems like the MD5 and SHA signatures are redeployed every day, but the artifacts themselves (JARs, POMs) are still from January 15th&lt;/p&gt;</comment>
                            <comment id="12942100" author="gtully" created="Thu, 28 Jan 2010 10:20:44 +0000"  >&lt;p&gt;I kicked hudson into doing a redeploy of the artifacts and the full install tar files are now uploaded containing the build artifacts from the 27/01 which should have the fix for this issue.&lt;/p&gt;</comment>
                            <comment id="12942106" author="kutzi" created="Thu, 28 Jan 2010 10:32:46 +0000"  >&lt;p&gt;Thanks.&lt;br/&gt;
Seems like new artifacts were only deployed for ActiveMQ 5.4.&lt;br/&gt;
Can you also do it for 5.3.1-SNAPSHOT, please?&lt;/p&gt;</comment>
                            <comment id="12942107" author="gtully" created="Thu, 28 Jan 2010 10:49:07 +0000"  >&lt;p&gt;done for 5.3.1-SNAPSHOT&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461596" name="PrefetchSubscription.java" size="33016" author="rudolf_janz" created="Fri, 15 Jan 2010 11:42:36 +0000"/>
                            <attachment id="12461595" name="ZeroPrefetchConsumerTest.java" size="6455" author="rudolf_janz" created="Fri, 15 Jan 2010 11:42:36 +0000"/>
                            <attachment id="12461594" name="ZeroPrefetchConsumerTest.java" size="4309" author="rudolf_janz" created="Thu, 14 Jan 2010 14:29:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>74890</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 43 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rpx3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>159843</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>