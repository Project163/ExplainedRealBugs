<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:58:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4147] Memory usage incorrectly updated across network of brokers when VMTransport is used.</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4147</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Symptom&lt;br/&gt;
=======&lt;br/&gt;
I was writing some unit tests based on &lt;tt&gt;org.apache.activemq.JmsMultipleBrokersTestSupport&lt;/tt&gt;, and noticed the following issue:&lt;/p&gt;

&lt;p&gt;When brokers are connected in a network using VMTransport (i.e., VMTransport on both the local and remote ends of a bridge), and a message moves from broker1 to broker2, the memory usage of the message continues to be accounted for on broker1 until the message is actually consumed on broker2.  &lt;/p&gt;

&lt;p&gt;If the brokers are bridged using a non-VM transport (e.g., TCP), memory usage on broker1 is reduced as soon as the message is bridged to broker2, and broker2&apos;s memory usage increases until the message is consumed.&lt;/p&gt;

&lt;p&gt;Cause&lt;br/&gt;
=====&lt;br/&gt;
The cause is the same as in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4116&quot; title=&quot;Memory usage is not cleared from the source queue when a message is moved to another queue over the VMTransport&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4116&quot;&gt;&lt;del&gt;AMQ-4116&lt;/del&gt;&lt;/a&gt;: &lt;tt&gt;Message.copy()&lt;/tt&gt; copies the &lt;tt&gt;memoryUsage&lt;/tt&gt; object.  As a result, when the message moves from broker1 to broker2, the original &lt;tt&gt;memoryUsage&lt;/tt&gt; object, which refers to broker1 is copied through to broker2 and never updated to broker2&apos;s &lt;tt&gt;memoryUsage&lt;/tt&gt; object.&lt;/p&gt;

&lt;p&gt;Specifically, the message is copied from the local transport before being sent to the remote transport by this code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;DemandForwardingBridgeSupport.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void serviceLocalCommand(Command command) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!disposed.get()) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (command.isMessageDispatch()) {
                enqueueCounter.incrementAndGet();
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; MessageDispatch md = (MessageDispatch) command;
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; DemandSubscription sub = subscriptionMapByLocalId.get(md.getConsumerId());
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sub != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; md.getMessage() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; sub.incrementOutstandingResponses()) {

                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (suppressMessageDispatch(md, sub)) {
                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isDebugEnabled()) {
                            LOG.debug(configuration.getBrokerName() + &lt;span class=&quot;code-quote&quot;&gt;&quot; message not forwarded to &quot;&lt;/span&gt; + remoteBrokerName + &lt;span class=&quot;code-quote&quot;&gt;&quot; because message came from there or fails networkTTL, brokerPath: &quot;&lt;/span&gt; + Arrays.toString(md.getMessage().getBrokerPath()) + &lt;span class=&quot;code-quote&quot;&gt;&quot;, message: &quot;&lt;/span&gt; + md.getMessage());
                        }
                        &lt;span class=&quot;code-comment&quot;&gt;// still ack as it may be durable
&lt;/span&gt;                        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                            localBroker.oneway(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MessageAck(md, MessageAck.INDIVIDUAL_ACK_TYPE, 1));
                        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
                            sub.decrementOutstandingResponses();
                        }
                        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
                    }

                    Message message = configureMessage(md);
...

&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; Message configureMessage(MessageDispatch md) {
    Message message = md.getMessage().copy();
...

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This bug is not present when a non-VM transport is used for the bridge because &lt;tt&gt;Message.memoryUsage&lt;/tt&gt; is marked transient &lt;b&gt;not&lt;/b&gt; copied during serialization/deserialization over the transport.&lt;/p&gt;

&lt;p&gt;Solution&lt;br/&gt;
========&lt;br/&gt;
Since this is at least the second bug to result from the current &lt;tt&gt;Message.copy()&lt;/tt&gt; behaviour, I think &quot;Solution 1&quot; proposed from &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4116&quot; title=&quot;Memory usage is not cleared from the source queue when a message is moved to another queue over the VMTransport&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4116&quot;&gt;&lt;del&gt;AMQ-4116&lt;/del&gt;&lt;/a&gt; is starting to look attractive as both a solution to &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4116&quot; title=&quot;Memory usage is not cleared from the source queue when a message is moved to another queue over the VMTransport&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4116&quot;&gt;&lt;del&gt;AMQ-4116&lt;/del&gt;&lt;/a&gt; and this bug:&lt;/p&gt;

&lt;p&gt;Modify &lt;tt&gt;Message.copy()&lt;/tt&gt; so that it sets the resulting message&apos;s &lt;tt&gt;memoryUsage&lt;/tt&gt; object to &lt;tt&gt;null&lt;/tt&gt;.  This would make &lt;tt&gt;Message.copy()&lt;/tt&gt; behave more similarly to serialization/deserialization.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12614093">AMQ-4147</key>
            <summary>Memory usage incorrectly updated across network of brokers when VMTransport is used.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="stirlingc">Stirling Chow</reporter>
                        <labels>
                    </labels>
                <created>Tue, 30 Oct 2012 22:16:21 +0000</created>
                <updated>Tue, 31 Mar 2015 21:42:08 +0000</updated>
                            <resolved>Fri, 1 Feb 2013 15:54:34 +0000</resolved>
                                    <version>5.7.0</version>
                                    <fixVersion>5.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13487320" author="stirlingc" created="Tue, 30 Oct 2012 22:35:36 +0000"  >&lt;p&gt;Unit test demonstrating issue on VM transport, but no problem with TCP transport&lt;/p&gt;</comment>
                            <comment id="13487327" author="stirlingc" created="Tue, 30 Oct 2012 22:44:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4116&quot; title=&quot;Memory usage is not cleared from the source queue when a message is moved to another queue over the VMTransport&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4116&quot;&gt;&lt;del&gt;AMQ-4116&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4137&quot; title=&quot;Create a store import/export command line tool to covert between store types&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4137&quot;&gt;&lt;del&gt;AMQ-4137&lt;/del&gt;&lt;/a&gt; both have the same cause, but exhibit different problems.&lt;/p&gt;</comment>
                            <comment id="13568209" author="tabish121" created="Thu, 31 Jan 2013 22:48:50 +0000"  >&lt;p&gt;Added a fix to prevent the Bridge from propagating MemoryUsage values when copying.  Will look further at why we would ever want to copy MemoryUsage in Message.copy().  &lt;/p&gt;</comment>
                            <comment id="13568822" author="tabish121" created="Fri, 1 Feb 2013 15:54:34 +0000"  >&lt;p&gt;Fixed on trunk by having the bridge clear the memory usage.  &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12711964">AMQ-5169</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12612520">AMQ-4116</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12551437" name="AMQ4147Test.java" size="7293" author="stirlingc" created="Tue, 30 Oct 2012 22:35:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>253221</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 42 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0dcj3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>75959</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>