<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:33:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6059] DLQ message lost after broker restarts</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6059</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;&lt;b&gt;How to Reproduce&lt;/b&gt;&lt;br/&gt;
1. Default ActiveMQ 5.12.1 package with the attached activemq.xml.&lt;br/&gt;
2. Send a message to a queue with expiration time one second.&lt;br/&gt;
4. After the expiry time, the message will be moved to DLQ. This can be monitored by the AMQ web console.&lt;br/&gt;
5. Restart AMQ. You will find that the message disappear from the AMQ web console. Try to consume the message from the DLQ, nothing is received.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Cause Analysis&lt;/b&gt;&lt;br/&gt;
1. KahaDB works well. It means the cause should be related to the leveldb mechanism.&lt;br/&gt;
2. In my understanding, the JMS message is persistent to a log file and leveldb will maintain to a reference to the position where the JMS message is stored in the log. After a message expires, AMQ will copy the expired JMS message and the reference to the posistion is also copied, then send to DLQ. When AMQ restarts, DLQ will recover the message from the persistent storage. Since the DLQ message shares the same reference to the JMS message data, the message in DLQ also has the expiration time that is the same as the original message. The expiry scanner will detect the DLQ message expires and remove it. That&apos;s why the message is lost after restart.&lt;br/&gt;
3. Actually, the message to DLQ is not completely the same as the origial message. Because the expiration time will be reset to 0 and some more message properties will be added. The DLQ message should not reuse the same reference to message data. For more details, please refer to org.apache.activemq.broker.region.RegionBroker.sendToDeadLetterQueue(ConnectionContext context, MessageReference node, Subscription subscription, Throwable poisonCause) method.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Fixed Proposal&lt;/b&gt;&lt;br/&gt;
In org.apache.activemq.broker.region.RegionBroker.sendToDeadLetterQueue(ConnectionContext context, MessageReference node, Subscription subscription, Throwable poisonCause) method, after the message is copied, set the dataLocator to null (message.getMessageId().setDataLocator(null) to force leveldb to save the new JMS message data and refer to a new position.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows, Linux Redhat&lt;/p&gt;</environment>
        <key id="12915655">AMQ-6059</key>
            <summary>DLQ message lost after broker restarts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tabish">Timothy A. Bish</assignee>
                                    <reporter username="nevinchen">Nevin Chen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 Nov 2015 01:49:11 +0000</created>
                <updated>Tue, 12 Jan 2016 17:00:51 +0000</updated>
                            <resolved>Tue, 12 Jan 2016 16:58:22 +0000</resolved>
                                    <version>5.12.1</version>
                                    <fixVersion>5.13.1</fixVersion>
                    <fixVersion>5.14.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15023590" author="nevinchen" created="Tue, 24 Nov 2015 02:04:54 +0000"  >&lt;p&gt;Test case to reproduce this issue. It is expected to run in activemq-unit-tests project.&lt;/p&gt;</comment>
                            <comment id="15094251" author="jira-bot" created="Tue, 12 Jan 2016 16:51:57 +0000"  >&lt;p&gt;Commit 505a76a8bb7180debbd36637dce1b9101150d0b4 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=505a76a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=505a76a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6059&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6059&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Ensure that a message sent to the store for the DLQ is rewritten so that&lt;br/&gt;
its updated values are written to prevent exirpation loops and loss of&lt;br/&gt;
reollback cause etc.&lt;/p&gt;</comment>
                            <comment id="15094279" author="tabish121" created="Tue, 12 Jan 2016 16:58:22 +0000"  >&lt;p&gt;Analysis was correct, the message needs to be rewritten in the store when sent into the DLQ to update the message object otherwise the old expiration is retained and newer metadata added is lost.  &lt;/p&gt;</comment>
                            <comment id="15094289" author="jira-bot" created="Tue, 12 Jan 2016 17:00:51 +0000"  >&lt;p&gt;Commit b04cfeb8af2cdf7d9ccbcd65a309478d4e01db9f in activemq&apos;s branch refs/heads/activemq-5.13.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=b04cfeb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=b04cfeb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6059&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6059&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Ensure that a message sent to the store for the DLQ is rewritten so that&lt;br/&gt;
its updated values are written to prevent exirpation loops and loss of&lt;br/&gt;
reollback cause etc.&lt;br/&gt;
(cherry picked from commit 505a76a8bb7180debbd36637dce1b9101150d0b4)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12773965" name="LevelDBStoreRecoveryBrokerTest.java" size="6148" author="nevinchen" created="Tue, 24 Nov 2015 02:04:54 +0000"/>
                            <attachment id="12773959" name="activemq.xml" size="6296" author="nevinchen" created="Tue, 24 Nov 2015 01:54:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 45 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2oucn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>