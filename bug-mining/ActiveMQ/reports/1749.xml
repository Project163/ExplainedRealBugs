<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:57:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4157] KahaDBTransactionStore.removeAyncMessage may cancel addMessage when in transaction leading to unpersisted messages</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4157</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;This was very difficult to track down.  It rarely occurs because a certain set of events must be occurring to trigger the bug.   I have marked it a Blocker because when it does occur, it is silent and leads to a message not being persisted in the MessageStore.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Description&lt;/b&gt;&lt;br/&gt;
The crux of the bug is that when a rollback on a session occurs, the resulting MessageAck can overlap with the async store of the message in the KahaDB.   When this occurs, the message is never persisted.  Additionally, the resultant &lt;tt&gt;CancellationException&lt;/tt&gt; is ignored in o.a.a.broker.region.Queue:796.   The steps:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;a StoreQueueTask is created to add a message X.  this is put on the async task queue&lt;/li&gt;
	&lt;li&gt;meanwhile this message is dispatched via a prefetch subscription to a transacted consumer.&lt;/li&gt;
	&lt;li&gt;the transacted consumer calls session.rollback&lt;/li&gt;
	&lt;li&gt;this leads to acknowledgement of the dispatched message&lt;/li&gt;
	&lt;li&gt;as a result &lt;tt&gt;destination.removeAsyncMessage()&lt;/tt&gt; is called&lt;/li&gt;
	&lt;li&gt;if the original add has not yet executed then it will be cancelled leading to the message never being persisted!  (occurs at KahaDBStore:401)&lt;/li&gt;
	&lt;li&gt;the Queue.send method uses the result future to make sure the persist happens in the store, but it ignores cancellation, so this can lead execution control to return to the sender when no persistence has occurred without an error.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I have not been able to reproduce this in a small activemq-only test.  But I can reproduce it in my environment.  &lt;/p&gt;

&lt;p&gt;&lt;b&gt;Proposed Solutions&lt;/b&gt;&lt;br/&gt;
I&apos;m really unsure of the solution here.  Should &lt;tt&gt;KahaDBStore.removeAsyncMessage&lt;/tt&gt; (line 393) check the context and only cancel tasks if it is not in a transaction context?  But what would that mean in the log?  Would there be a removeMessage prior to the addMessage?&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Workaround&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;turn off caching for the destination (see &lt;a href=&quot;http://activemq.apache.org/per-destination-policies.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dest policies&lt;/a&gt;).  this will cause messages to be added synchronously so they will not be subject to the async cancellation&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>&lt;p&gt;linux 64-bit, kahadb, persisted messages, cached dest, transacted&lt;/p&gt;</environment>
        <key id="12614557">AMQ-4157</key>
            <summary>KahaDBTransactionStore.removeAyncMessage may cancel addMessage when in transaction leading to unpersisted messages</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="mserrano">Martin Serrano</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Nov 2012 19:07:01 +0000</created>
                <updated>Wed, 28 Aug 2013 14:29:40 +0000</updated>
                            <resolved>Wed, 28 Aug 2013 14:29:40 +0000</resolved>
                                    <version>5.7.0</version>
                                    <fixVersion>5.9.0</fixVersion>
                                    <component>Message Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13489683" author="mserrano" created="Fri, 2 Nov 2012 19:24:57 +0000"  >&lt;p&gt;Note in my integration test which does reproduce this, it failed 5 times out of 231 runs.&lt;/p&gt;</comment>
                            <comment id="13489897" author="mserrano" created="Sat, 3 Nov 2012 01:27:12 +0000"  >&lt;p&gt;I confirmed the workaround.  When turning off caching, the test no longer failed (500 iterations succeed)&lt;/p&gt;</comment>
                            <comment id="13492440" author="gtully" created="Wed, 7 Nov 2012 15:52:43 +0000"  >&lt;p&gt;getting this on the radar for 5.8&lt;/p&gt;</comment>
                            <comment id="13549668" author="gtully" created="Thu, 10 Jan 2013 14:35:57 +0000"  >&lt;p&gt;There is another workaround, &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;kahaDB concurrentStoreAndDispatchQueues=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt; ..&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13549751" author="gtully" created="Thu, 10 Jan 2013 16:15:21 +0000"  >&lt;p&gt;fix in &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1431463&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1431463&amp;amp;view=rev&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;@Martin, thanks for the great description and diagnosis, it very much helped the process of building a reproducible junit test case to validate and protect the fix.&lt;/p&gt;</comment>
                            <comment id="13572919" author="kearls" created="Wed, 6 Feb 2013 22:20:17 +0000"  >&lt;p&gt;This test is still failing for me, usually with a message like the one below. This test failed on message 992, but typically it fails on 998 or 999.&lt;/p&gt;

&lt;p&gt;I will attach the log.&lt;/p&gt;

&lt;p&gt;Running org.apache.activemq.bugs.AMQ4157Test&lt;br/&gt;
Tests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 32.811 sec &amp;lt;&amp;lt;&amp;lt; FAILURE!&lt;br/&gt;
testPublishCountsWithRollbackConsumer(org.apache.activemq.bugs.AMQ4157Test)  Time elapsed: 32.538 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!&lt;br/&gt;
java.lang.AssertionError: got message 992&lt;br/&gt;
	at org.junit.Assert.fail(Assert.java:88)&lt;br/&gt;
	at org.junit.Assert.assertTrue(Assert.java:41)&lt;br/&gt;
	at org.junit.Assert.assertNotNull(Assert.java:621)&lt;br/&gt;
	at org.apache.activemq.bugs.AMQ4157Test.consumeMessages(AMQ4157Test.java:123)&lt;br/&gt;
	at org.apache.activemq.bugs.AMQ4157Test.testPublishCountsWithRollbackConsumer(AMQ4157Test.java:101)&lt;/p&gt;


&lt;p&gt;Results :&lt;/p&gt;

&lt;p&gt;Failed tests: &lt;br/&gt;
  AMQ4157Test.testPublishCountsWithRollbackConsumer:101-&amp;gt;consumeMessages:123 got message 992&lt;/p&gt;</comment>
                            <comment id="13572945" author="tabish121" created="Wed, 6 Feb 2013 22:38:34 +0000"  >&lt;p&gt;Reopened since Kevin is seeing failures.  I saw it fail last night also. &lt;/p&gt;</comment>
                            <comment id="13752431" author="gtully" created="Wed, 28 Aug 2013 14:29:40 +0000"  >&lt;p&gt;seems to be resolved on trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12568311" name="org.apache.activemq.bugs.AMQ4157Test-output.txt" size="1656717" author="kearls" created="Wed, 6 Feb 2013 22:20:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>254045</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 12 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ei8v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>82718</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>