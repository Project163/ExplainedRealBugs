<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:59:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-9654] Queue size incorrect even when queue is empty</title>
                <link>https://issues.apache.org/jira/browse/AMQ-9654</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;Environment:&lt;br/&gt;
Linux OS&lt;br/&gt;
ActiveMQ 5.17.6 using network of brokers (2-3 brokers per cluster) &lt;br/&gt;
Cloud deployment with high frequency of network inconsistency&lt;/p&gt;

&lt;p&gt;1. Queue size may reflect a small number of messages are still pending on the queue (1 or 2), but there are no messages present. &lt;/p&gt;

&lt;p&gt;2. Broker restart corrects the messages&lt;/p&gt;

&lt;p&gt;3. No clear indications of exception or error in broker or client-side logs&lt;/p&gt;

&lt;p&gt;4. Application consuming messages using multiple consumers and single-message-per-transaction using local transaction ack mode. (Camel JMS, Spring, etc)&lt;/p&gt;

&lt;p&gt;5. Across dozens of brokers processing 100&apos;s of millions of messages per year, this will occur a handful of times in all.&lt;/p&gt;

&lt;p&gt;Suspect queue size counter consistency issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13606524">AMQ-9654</key>
            <summary>Queue size incorrect even when queue is empty</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="mattrpav">Matt Pavlovich</assignee>
                                    <reporter username="mattrpav">Matt Pavlovich</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Jan 2025 16:27:34 +0000</created>
                <updated>Fri, 13 Jun 2025 15:53:01 +0000</updated>
                                            <version>5.17.6</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17922076" author="christopher.l.shannon" created="Wed, 29 Jan 2025 12:38:27 +0000"  >&lt;p&gt;It&apos;s going to be hard to track down the issue with the info you described unless someone just gets lucky as it&apos;s probably not an actual error or anything (lack of errors in the log etc...) and just a thread safety issue which is always difficult to find.&lt;/p&gt;

&lt;p&gt;When you say there is still pending messages, is it just the one destination metrics counter? &lt;/p&gt;

&lt;p&gt;What about other info going on or other metrics (destination, subscription, etc)? These might give an indication of what happened.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Do any messages show as expired, redelivered, etc?&lt;/li&gt;
	&lt;li&gt;Do enqueue/dequeue counts match up?&lt;/li&gt;
	&lt;li&gt;What about dispatched vs consumed counts for subs?&lt;/li&gt;
	&lt;li&gt;Is cursor caching enabled?&lt;/li&gt;
	&lt;li&gt;Any messages going to the DLQ?&lt;/li&gt;
	&lt;li&gt;Persistent or non persistent? What does the data store show? Anything pending in KahaDB on the destination?&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17957411" author="mattrpav" created="Tue, 10 Jun 2025 02:11:45 +0000"  >&lt;p&gt;1a. Not expired &lt;br/&gt;
1b. Might be redelivered (working to verify)&lt;br/&gt;
1c. Duplicate From Store occurred &lt;/p&gt;

&lt;p&gt;4. No, cursor cache is disabled&lt;/p&gt;

&lt;p&gt;5. Yes, duplicate from store&lt;/p&gt;

&lt;p&gt;6. Persistent&lt;/p&gt;

&lt;p&gt;Log messages&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.activemq.broker.region.cursors.QueueStorePrefetch@5a64ec82:QUEUE.IN,batchResetNeeded=false,size=4,cacheEnabled=false,maxBatchSize:4,hasSpace:true,pendingCachedIds.size:0,lastSyncCachedId:null,lastSyncCachedId-seq:null,lastAsyncCachedId:null,lastAsyncCachedId-seq:null,store=permits:10000,sd=nextSeq:6378647,lastRet:MessageOrderCursor:[def:6378646, low:0, high:0],pending:0 - cursor got duplicate from store ID:app-client-id-795c4dfcbb-kp6qx-33983-7123677174665-287:366099:1:1:18 seq: 6378646
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17957559" author="mattrpav" created="Tue, 10 Jun 2025 03:39:08 +0000"  >&lt;p&gt;I&apos;m narrowing down a candidate to this code block:&lt;/p&gt;

&lt;p&gt;Observations&lt;br/&gt;
1. A log or counter in an else {} could assist in providing verification that this is the area with the issue.&lt;br/&gt;
2. Could a consistency error with dropIfLive also result in the duplicate from store? If the pagedInMessages reference is not getting removed on dropMessages, that would seem to make sense.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    private void dropMessage(ConnectionContext context, QueueMessageReference reference) {
        //use dropIfLive so we only process the statistics at most one time
        if (reference.dropIfLive()) {
            destinationStatistics.getDequeues().increment();
            destinationStatistics.getMessages().decrement();

            final var tmpMessageFlowStats = destinationStatistics.getMessageFlowStats();
            if(tmpMessageFlowStats != null) {
                Message tmpMessage = reference.getMessage();
                tmpMessageFlowStats.dequeueStats(context.getClientId(), tmpMessage.getMessageId().toString(), tmpMessage.getTimestamp(), tmpMessage.getBrokerInTime(), tmpMessage.getBrokerOutTime()); 
            }

            if(isAdvancedNetworkStatisticsEnabled() &amp;amp;&amp;amp; context.getConnection() != null &amp;amp;&amp;amp; context.getConnection().isNetworkConnection()) {
                destinationStatistics.getNetworkDequeues().increment();
            }

            pagedInMessagesLock.writeLock().lock();
            try {
                pagedInMessages.remove(reference);
            } finally {
                pagedInMessagesLock.writeLock().unlock();
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Consider improved locking semantics?&lt;br/&gt;
ref: &lt;a href=&quot;https://github.com/apache/activemq/blob/main/activemq-broker/src/main/java/org/apache/activemq/broker/region/IndirectMessageReference.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/blob/main/activemq-broker/src/main/java/org/apache/activemq/broker/region/IndirectMessageReference.java&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17973516" author="jira-bot" created="Fri, 13 Jun 2025 15:53:00 +0000"  >&lt;p&gt;Commit 28c71aa4ee641bbd7f9caf685982cc65ef52a93e in activemq&apos;s branch refs/heads/main from Matt Pavlovich&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=28c71aa4ee&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=28c71aa4ee&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9654&quot; title=&quot;Queue size incorrect even when queue is empty&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9654&quot;&gt;AMQ-9654&lt;/a&gt; Enhance SendDuplicateFromStoreToDLQTest to cover various policyEntry configurations&lt;/p&gt;</comment>
                            <comment id="17973517" author="jira-bot" created="Fri, 13 Jun 2025 15:53:01 +0000"  >&lt;p&gt;Commit a5962478eae9c8164dc7f23831c830c4ee600b74 in activemq&apos;s branch refs/heads/main from Matt Pavlovich&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=activemq.git;h=a5962478ea&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=activemq.git;h=a5962478ea&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #1454 from mattrpav/&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9654&quot; title=&quot;Queue size incorrect even when queue is empty&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9654&quot;&gt;AMQ-9654&lt;/a&gt;-test&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-9654&quot; title=&quot;Queue size incorrect even when queue is empty&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-9654&quot;&gt;AMQ-9654&lt;/a&gt; Enhance SendDuplicateFromStoreToDLQTest&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12969773">AMQ-6293</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            21 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1tvnc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>