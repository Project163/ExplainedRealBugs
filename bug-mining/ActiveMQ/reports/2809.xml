<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:34:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-6256] ConcurentStoreAndDispatch can lead to inconsistent message states using VM Transport</title>
                <link>https://issues.apache.org/jira/browse/AMQ-6256</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;When messages are added to a store asynchronously (when using concurrent store and dispatch) and then dispatched to a consumer at the same time, there is a race condition that can occur primarily with the VM Transport.  The issue is that it&apos;s possible that when the VM Transport is copying the message for dispatch, the async task can run at the same time to store the message.  It&apos;s possible that the copy on dispatch can occur during the same time the async store task is trying to marshall the data and properties which can lead to an inconsistent state of the message (ie null content).  This is the cause of the issue in &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6218&quot; title=&quot;Message content returns null occasionally from Virtual Topic to the consumer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-6218&quot;&gt;&lt;del&gt;AMQ-6218&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The proper fix for this is to make sure the beforeMarshall method is called prior to the task running and prior to dispatch.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12959158">AMQ-6256</key>
            <summary>ConcurentStoreAndDispatch can lead to inconsistent message states using VM Transport</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cshannon">Christopher L. Shannon</assignee>
                                    <reporter username="cshannon">Christopher L. Shannon</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Apr 2016 12:24:36 +0000</created>
                <updated>Mon, 18 Apr 2016 12:44:16 +0000</updated>
                            <resolved>Fri, 15 Apr 2016 13:09:01 +0000</resolved>
                                    <version>5.13.2</version>
                                    <fixVersion>5.13.3</fixVersion>
                    <fixVersion>5.14.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15242922" author="jira-bot" created="Fri, 15 Apr 2016 13:02:46 +0000"  >&lt;p&gt;Commit b9f9f03829a65efa2956c347d2cafa41905313c6 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=b9f9f03&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=b9f9f03&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6256&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6256&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Calling beforeMarshall on messages when they async stored before the&lt;br/&gt;
store task is run and before consumer dispatch to prevent two threads&lt;br/&gt;
from trying to mutate the message state at the same time.&lt;/p&gt;</comment>
                            <comment id="15242928" author="jira-bot" created="Fri, 15 Apr 2016 13:07:06 +0000"  >&lt;p&gt;Commit dc3c5a719b47fc40b5affce8412390ead67ce8ef in activemq&apos;s branch refs/heads/activemq-5.13.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=dc3c5a7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=dc3c5a7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6256&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6256&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Calling beforeMarshall on messages when they async stored before the&lt;br/&gt;
store task is run and before consumer dispatch to prevent two threads&lt;br/&gt;
from trying to mutate the message state at the same time.&lt;/p&gt;

&lt;p&gt;(cherry picked from commit b9f9f03829a65efa2956c347d2cafa41905313c6)&lt;/p&gt;</comment>
                            <comment id="15242988" author="gtully" created="Fri, 15 Apr 2016 13:57:58 +0000"  >&lt;p&gt;afaik the format is not used by before marshall, I think beforeMarshall can done in Queue with an null format, just  before a call to asyncAdd.&lt;br/&gt;
there is a beforeMarshall in this way before stomp dispatch to the broker to ensure properties are accounted for.&lt;br/&gt;
see: &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=blobdiff;f=activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/ProtocolConverter.java;h=b25860bf6895240c33a8643b6fcc731af126d32e;hp=8539b59ee046e54c5ec82c73edc6f591da0c9148;hb=57264bf;hpb=521c4fd8c31a88575f80659e9b84f016b22087ea&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=blobdiff;f=activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/ProtocolConverter.java;h=b25860bf6895240c33a8643b6fcc731af126d32e;hp=8539b59ee046e54c5ec82c73edc6f591da0c9148;hb=57264bf;hpb=521c4fd8c31a88575f80659e9b84f016b22087ea&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15243001" author="christopher.l.shannon" created="Fri, 15 Apr 2016 14:09:24 +0000"  >&lt;p&gt;Thanks for pointing that out, i can move it to the Queue.&lt;/p&gt;</comment>
                            <comment id="15243012" author="jira-bot" created="Fri, 15 Apr 2016 14:19:09 +0000"  >&lt;p&gt;Commit b9b98a45cee484b112dadeffa2d9a874c4ffe280 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=b9b98a4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=b9b98a4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6256&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6256&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Moving beforeMarshall call out of the store and into the actual&lt;br/&gt;
destination&lt;/p&gt;</comment>
                            <comment id="15243017" author="jira-bot" created="Fri, 15 Apr 2016 14:23:19 +0000"  >&lt;p&gt;Commit 32913408a68ec92e3d202f5dcc3923d5c7d7588a in activemq&apos;s branch refs/heads/activemq-5.13.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=3291340&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=3291340&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6256&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6256&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Moving beforeMarshall call out of the store and into the actual&lt;br/&gt;
destination&lt;/p&gt;

&lt;p&gt;(cherry picked from commit b9b98a45cee484b112dadeffa2d9a874c4ffe280)&lt;/p&gt;</comment>
                            <comment id="15243019" author="jira-bot" created="Fri, 15 Apr 2016 14:24:20 +0000"  >&lt;p&gt;Commit 1ffac14f6ed3b2f2d30b5de1b759f16a29a0c099 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1ffac14&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1ffac14&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6256&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6256&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;cleanup imports&lt;/p&gt;</comment>
                            <comment id="15245553" author="christopher.l.shannon" created="Mon, 18 Apr 2016 12:17:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;,  This patch has the side effect that it ends up calling beforeMarshall for all stores, including the memory store.  I believe this is causing the tests failures in AMQ2103Test here: &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/view/A-D/view/ActiveMQ/job/ActiveMQ-Java8/652/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/view/A-D/view/ActiveMQ/job/ActiveMQ-Java8/652/testReport/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m assuming we don&apos;t really want to marshall data for the memory store, so do you think we should move the beforeMarshall call back to the store implementations?&lt;/p&gt;

&lt;p&gt;Edit: Looks like it caused this failure as well org.apache.activemq.usecases.ObjectMessageNotSerializableTest.testSendNotSerializeableObjectMessage&lt;/p&gt;</comment>
                            <comment id="15245579" author="gtully" created="Mon, 18 Apr 2016 12:30:24 +0000"  >&lt;p&gt;darn, yea, that is the only option. Your original fix is perfect then, just doing the work in the stores that actually do async bits.&lt;br/&gt;
For the memory store and pure invm dispatch, bypassing serialisation altogether is valid. Win for the test suite.&lt;/p&gt;</comment>
                            <comment id="15245588" author="christopher.l.shannon" created="Mon, 18 Apr 2016 12:39:24 +0000"  >&lt;p&gt;Ok, sounds good, easy enough to revert back to the original fix &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="15245589" author="jira-bot" created="Mon, 18 Apr 2016 12:40:45 +0000"  >&lt;p&gt;Commit 11622b3af32fe9518df06f026e6c0fb65de4aa26 in activemq&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=11622b3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=11622b3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6256&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6256&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Moving beforeMarshall back to the store implementations because we don&apos;t&lt;br/&gt;
want all store implementations to marshall (such as memory store)&lt;/p&gt;

&lt;p&gt;This reverts commit b9b98a45cee484b112dadeffa2d9a874c4ffe280.&lt;/p&gt;</comment>
                            <comment id="15245594" author="jira-bot" created="Mon, 18 Apr 2016 12:44:16 +0000"  >&lt;p&gt;Commit 840583df090bdca6ef1a709d1a2e7701aaeda637 in activemq&apos;s branch refs/heads/activemq-5.13.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cshannon&quot; class=&quot;user-hover&quot; rel=&quot;cshannon&quot;&gt;cshannon&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=840583d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=840583d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-6256&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-6256&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Moving beforeMarshall back to the store implementations because we don&apos;t&lt;br/&gt;
want all store implementations to marshall (such as memory store)&lt;/p&gt;

&lt;p&gt;This reverts commit 32913408a68ec92e3d202f5dcc3923d5c7d7588a.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12951170">AMQ-6218</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="12952488">AMQ-6222</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 31 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2w6dr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>