<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 05:53:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-3004] Build-up of unwanted messages</title>
                <link>https://issues.apache.org/jira/browse/AMQ-3004</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;One of our installations have several consumers. These consumers subscribe for messages from a queue linked to a virtual topic. All consumers supply a selector. Some consumers connect, process any persisted messages, then disconnect. These connect/disconnect cycles are repeated a few times a day.&lt;/p&gt;

&lt;p&gt;What we&apos;ve seen is that messages build-up for consumers. These messages does not match the supplied selector. The side effect of this was that we ran into a situation whereby message &quot;got stuck&quot;. Increasing the &lt;em&gt;maxPageSize&lt;/em&gt; property helped. This is unfortunately a short term solution.&lt;/p&gt;

&lt;p&gt;A simple test was constructed whereby &lt;b&gt;selectorAware&lt;/b&gt; was set to &lt;b&gt;true&lt;/b&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;virtualDestinations&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;virtualTopic name=&lt;span class=&quot;code-quote&quot;&gt;&quot;VirtualTopic.&amp;gt;&lt;/span&gt;&quot;&lt;/span&gt; prefix=&lt;span class=&quot;code-quote&quot;&gt;&quot;Consumer.*.&quot;&lt;/span&gt; selectorAware=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;/&amp;gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/virtualDestinations&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What we noticed is that:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Messages are correctly received by a connected consumer&lt;/li&gt;
	&lt;li&gt;A consumer that connects, disconnects and re-connects later will loose any messages that were send in the time period it was disconnected.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This behaviour was unexpected. From the AMQ documention (&lt;a href=&quot;http://activemq.apache.org/virtual-destinations.html):&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/virtual-destinations.html):&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;From version 5.4, dispatch from virtual topics to subscription queues can be selectorAware such that only messages that match one of the existing subscribers are actually dispatched. Using this option prevents the build up of unmatched messages when selectors are used by exclusive consumers&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Note: it does not state that the consumer needs to be connected for this feature to work.&lt;/p&gt;

&lt;p&gt;Given the test it looks like subscriptions itself are not persisted, thus the AMQ broker has no idea that it should enqueue a message for a particular subscription queue.&lt;/p&gt;

&lt;p&gt;Would it be possible to add either of:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Persist subscription detail, specifically for the case where the subscription&apos;s selector should be applied to the subscription queue&lt;/li&gt;
	&lt;li&gt;Propagate selectors and the attached  subscription queue to the top-level virtual topic so that only interested messages can be delivered to the intended recipient?&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Anything else we can try, supply or help with?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12483852">AMQ-3004</key>
            <summary>Build-up of unwanted messages</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajdavies">Robert Davies</assignee>
                                    <reporter username="rnaude">Roelof Naude</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Oct 2010 13:00:18 +0000</created>
                <updated>Sun, 15 Apr 2012 10:38:09 +0000</updated>
                            <resolved>Sun, 15 Apr 2012 10:38:09 +0000</resolved>
                                    <version>5.4.1</version>
                                    <fixVersion>5.6.0</fixVersion>
                                    <component>Broker</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12943147" author="rnaude" created="Thu, 4 Nov 2010 11:58:24 +0000"  >&lt;p&gt;The attached patch solves the issue for the most part. Consumers need to connect at least once for the selector to be cached. The cached selector will be persisted to the configured file every 10min. It is re-loaded during startup.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;broker&amp;gt;&lt;/span&gt;
.
.
.
   &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;plugins&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;spring:ref local=&lt;span class=&quot;code-quote&quot;&gt;&quot;subQueueSelectorCacheBroker&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/plugins&amp;gt;&lt;/span&gt;
.
.
.
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/broker&amp;gt;&lt;/span&gt;

&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;spring:bean id=&lt;span class=&quot;code-quote&quot;&gt;&quot;subQueueSelectorCacheBroker&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.activemq.plugin.SubQueueSelectorCacheBrokerPlugin&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;spring:property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;persistFile&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;file:${jboss.server.data.dir}/activemq/selectorCache.dat&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
 &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/spring:bean&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13106922" author="tkarakai" created="Fri, 16 Sep 2011 23:52:14 +0000"  >&lt;p&gt;We would very much like to get this patch into the trunk!&lt;/p&gt;

&lt;p&gt;Virtual Topics are a perfect match for our use case, we have a single selector per queue (multiple consumers but each using the same selector on a given queue), and need to guarantee that the (filtered) messages are delivered to each queue even when all the consumers disconnect (in our case not intentionally, just dues to some failure or networking issue) and it&apos;s not acceptable to miss messages that were published during a disconnect.&lt;/p&gt;

&lt;p&gt;Any chance that this solution or a comparable one will make it to an an official release?&lt;/p&gt;</comment>
                            <comment id="13108494" author="gtully" created="Tue, 20 Sep 2011 10:23:40 +0000"  >&lt;p&gt;lets try and get to this for 5.6&lt;/p&gt;</comment>
                            <comment id="13109524" author="gtully" created="Wed, 21 Sep 2011 14:24:53 +0000"  >&lt;p&gt;@Takar&lt;br/&gt;
Roelof&apos;s patch looks very good and is mostly unobtrusive. &lt;br/&gt;
For your use case though I think it only kicks in if all subscriptions are disconnected, which may not be what you want.&lt;/p&gt;

&lt;p&gt;It also needs a junit test case to validate and protect it.&lt;br/&gt;
Maybe you can provide the required test case and some update that will make it work for you?&lt;/p&gt;</comment>
                            <comment id="13137260" author="tabish121" created="Thu, 27 Oct 2011 16:32:20 +0000"  >&lt;p&gt;Would be great if we could get a JUnit test case for this to help determine what the best fix is.&lt;/p&gt;</comment>
                            <comment id="13254299" author="rajdavies" created="Sun, 15 Apr 2012 10:38:09 +0000"  >&lt;p&gt;Submitted patch - and other bits a pieces -&lt;br/&gt;
Can use the persistent cache as a broker plugin - &lt;br/&gt;
e.g.&lt;/p&gt;

&lt;p&gt;&amp;lt;plugins&amp;gt;&lt;br/&gt;
 &amp;lt;virtualSelectorCacheBrokerPlugin persistFile =&quot;selectorcache.data&quot;/&amp;gt;&lt;br/&gt;
&amp;lt;/plugins&amp;gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12461816" name="AMQ-3004.patch" size="12864" author="rnaude" created="Thu, 4 Nov 2010 11:58:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59926</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 32 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0akb3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59563</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>