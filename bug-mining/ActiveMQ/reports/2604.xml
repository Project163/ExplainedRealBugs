<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:12:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-5851] Unmatched acknowledge: MessageAck {commandId = 77, responseRequired = false, ackType = 2, ...Could not find Message-ID XXX in dispatched-list (start of ack)</title>
                <link>https://issues.apache.org/jira/browse/AMQ-5851</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;When lot of messages got expired because of JMS client Time to Live (TTL) property then below error will appear and consumer will freeze&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt; Connection to broker failed: Unmatched acknowledge: MessageAck {commandId = 77, responseRequired = false, ackType = 2, consumerId =XXX firstMessageId = ID:XXX
 lastMessageId = ID:XXX
, destination = queue://abc, transactionId = null, messageCount = 1, poisonCause = null}; Could not find Message-ID in dispatched-list (start of ack)
         at org.apache.activemq.broker.region.PrefetchSubscription.assertAckMatchesDispatched(PrefetchSubscription.java:477) [activemq-broker-5.11.1.jar:5.11.1
 at org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:212) [activemq-broker-5.11.1.jar:5.11.1]
 at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:441) [activemq-broker-5.11.1.jar:5.11.1]
 at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:484) [activemq-broker-5.11.1.jar:5.11.1]
 at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:87) [activemq-broker-5.11.1.jar:5.11.1]
 at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:87) [activemq-broker-5.11.1.jar:5.11.1]
 at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:277) [activemq-broker-5.11.1.jar:5.11.1]
 at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:97) [activemq-broker-5.11.1.jar:5.11.1]
 at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:550) [activemq-broker-5.11.1.jar:5.11.1]
 at org.apache.activemq.command.MessageAck.visit(MessageAck.java:245) [activemq-client-5.11.1.jar:5.11.1]
 at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:334) [activemq-broker-5.11.1.jar:5.11.1]
 at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:188) [activemq-broker-5.11.1.jar:5.11.1]
 at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50) [activemq-client-5.11.1.jar:5.11.1]
 at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113) [activemq-client-5.11.1.jar:5.11.1]
 at org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:270) [activemq-client-5.11.1.jar:5.11.1]
 at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83) [activemq-client-5.11.1.jar:5.11.1]
 at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:214) [activemq-client-5.11.1.jar:5.11.1]
 at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:196) [activemq-client-5.11.1.jar:5.11.1]
 at java.lang.Thread.run(Thread.java:745) [rt.jar:1.8.0_25]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Steps to reproduce :&lt;br/&gt;
1. Enable TTL property for JMS client&lt;br/&gt;
2. Keep TTL value very low say 5 sec&lt;br/&gt;
3. Send lot of messages so some message will get expired&lt;br/&gt;
4. Make sure that some message should expired when they are in MDB means running inside MDB&lt;/p&gt;


&lt;p&gt;Then we will see above error in the logs&lt;/p&gt;</description>
                <environment></environment>
        <key id="12838767">AMQ-5851</key>
            <summary>Unmatched acknowledge: MessageAck {commandId = 77, responseRequired = false, ackType = 2, ...Could not find Message-ID XXX in dispatched-list (start of ack)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gtully">Gary Tully</assignee>
                                    <reporter username="grijesh.saini">Grijesh Saini</reporter>
                        <labels>
                            <label>ttl</label>
                    </labels>
                <created>Thu, 18 Jun 2015 11:43:58 +0000</created>
                <updated>Thu, 9 Jul 2015 16:20:47 +0000</updated>
                            <resolved>Thu, 9 Jul 2015 16:04:32 +0000</resolved>
                                    <version>5.10.0</version>
                    <version>5.11.0</version>
                    <version>5.11.1</version>
                                    <fixVersion>5.12.0</fixVersion>
                                    <component>JMS client</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14591730" author="tabish121" created="Thu, 18 Jun 2015 12:48:48 +0000"  >&lt;p&gt;Recommend you create a unit test to reproduce.  &lt;/p&gt;</comment>
                            <comment id="14593145" author="grijesh.saini" created="Fri, 19 Jun 2015 07:36:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Hi Timothy I attached the test case project which will be able to replicate given issue.&lt;/p&gt;

&lt;p&gt;Please find README.txt inside zip file to run the test case .&lt;br/&gt;
As it is only happening when we are using resource adapter so I created a small ear file with a junit test case.&lt;/p&gt;

&lt;p&gt;Please let me know if you will face any issue while running above project.&lt;/p&gt;</comment>
                            <comment id="14593340" author="christopher.l.shannon" created="Fri, 19 Jun 2015 11:26:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=grijesh.saini&quot; class=&quot;user-hover&quot; rel=&quot;grijesh.saini&quot;&gt;grijesh.saini&lt;/a&gt;, Thanks for uploading a test case.  I&apos;ll take a look at this when I get a chance.&lt;/p&gt;</comment>
                            <comment id="14593372" author="grijesh.saini" created="Fri, 19 Jun 2015 12:17:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=christopher.l.shannon&quot; class=&quot;user-hover&quot; rel=&quot;christopher.l.shannon&quot;&gt;christopher.l.shannon&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Yes sure Christopher, Thanks.&lt;/p&gt;</comment>
                            <comment id="14594922" author="christopher.l.shannon" created="Sun, 21 Jun 2015 02:25:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tabish121&quot; class=&quot;user-hover&quot; rel=&quot;tabish121&quot;&gt;tabish121&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Sorry in advance for the long message but this is a kind of complicated issue and was pretty hard to track down.&lt;/p&gt;

&lt;p&gt;There is a race condition of sorts and it is caused by the unique circumstances of this test case and the environment.  The short version is that message acks are being received out of order due to messages being handled concurrently in different threads.  Sometimes this causes an exception because by the time some of the acks are received by the broker, the broker has already expired the messages so the acknowledgement check fails.  This is happening in Wildfly because the container is creating a pool of threads to handle multiple messages at the same time (ie ServerSession pool).  This is unique to application servers because of the use of a ConnectionConsumer and ServerSessions so multiple threads can handle messages from 1 consumer.&lt;/p&gt;

&lt;p&gt;What&apos;s going on is as a message producer is sending messages to the broker with a TTL value set at 10 milliseconds, the Wildfly consumer is quickly dequeing messages in parallel.  The run() method in ActiveMQSession is being executed for each new message in different threads.  The first thing that happens is the message is checked to see if it has expired (around line 885 of ActiveMQSession).  If it&apos;s not expired, then the code continues on and the messageListener (in this case the MDB) eventually runs (around line 1037). The example that was submitted here has the MDB sleeping for 1 second which is  longer than the TTL of the messages being sent.  So a bunch of threads are sleeping for 1 second and then when they are finished the run() method continues on and at the end sends a normal acknowledgement back to the broker in the finally block (around line 1052)&lt;/p&gt;

&lt;p&gt;However, as the ConnectionConsumer is rapidly consuming more messages and dispatching to different Sessions, eventually one of the threads runs into a message that is expired because the time out period is so short.  Since the message is expired, it is acked early and sent to the broker.  The MDB never fires when the message is expired.   This triggers the broker to iterate through all of the dispatched messages and to expire ones that it can.  This happens in the PrefetchSubscription class around line 325 when an expired Ack is received.  So, all of the messages that were dispatched essentially get removed from that dispatch list since all of the messages are expired.  Then, when some of the threads in Wildfly finish sleeping they continue on and get around to sending back an ack.  Except that by the time this acknowledgement is sent to the broker, the messages have already been expired because the thread that detected the expired message already sent an expired ack to the broker so the message attempting to be acked doesn&apos;t exist in the dispatched list.&lt;/p&gt;

&lt;p&gt;Below is a printout from my log file with some extra debug statements that I added.  The &quot;handling message&quot; line is a debug statement that I added to print right after a message is dequeued in the run() method.  You can see multiple threads executing at the same time in Wildfly.  &quot;Expired Message&quot; prints out when a message is detected as being expired. &quot;Sending Ack&quot; prints out when the thread finishes the normal execution and sends a normal ack back to the broker.  As you can see below, we run into trouble when the thread handling the 4th message finishes and sends an acknowledgement to the broker.  During the period of time that the thread handling message 4 was sleeping for 1 second, 13 other messages were handled in parallel.  Just before thread 4 finished, one of the other threads had detected that message 13 expired and sent back an expiration ack which triggered all of the acks to be expired(including message 4) so by the time the ack for the 4th message reached the broker that message was already removed from the dispatch list and we get an exception.&lt;/p&gt;

&lt;p&gt;So, as far as solutions go, I&apos;m not sure what the best approach would be.  This situation could happen anytime messages are processed slowly in parallel and there is a TTL set.  Obviously one work around is to not concurrently process messages off the same subscription but that is pretty common with MDBs and application servers.  One solution could be to check a second time to see if the message has expired after the messageListener has been called and send an expired ack instead of a normal ack in that case.  But we&apos;d need to change the server logic to not fail if it couldn&apos;t find the message to ack because it was already expired.  I think another solution could be to keep track of of which messages have already been expired on a subscription for some window of time so that so that if an acknowledgement comes later it could be detected as being for an expired message and no error would be thrown.  What do you guys thing?  I can work on a PR and introduce a fix but wanted to discuss what you thought would be the best approach.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;20:20:52,347 INFO  [org.apache.activemq.ra.ActiveMQEndpointWorker] (default-threads - 1) Successfully established connection to broker [tcp://localhost:61616]
20:21:00,745 INFO  [stdout] (default-threads - 2) handling message: ID:localhost.localdomain-53475-1434846046033-2:1:1:3:1
20:21:00,747 INFO  [stdout] (default-threads - 2) Expired Ack (ActiveMQSession) for: null,ID:localhost.localdomain-53475-1434846046033-2:1:1:3:1
20:21:00,763 INFO  [stdout] (default-threads - 3) handling message: ID:localhost.localdomain-53475-1434846046033-2:1:1:4:1
20:21:00,868 INFO  [stdout] (default-threads - 4) handling message: ID:localhost.localdomain-53475-1434846046033-2:1:1:5:1
20:21:00,980 INFO  [stdout] (default-threads - 5) handling message: ID:localhost.localdomain-53475-1434846046033-2:1:1:6:1
20:21:01,087 INFO  [stdout] (default-threads - 6) handling message: ID:localhost.localdomain-53475-1434846046033-2:1:1:7:1
20:21:01,199 INFO  [stdout] (default-threads - 7) handling message: ID:localhost.localdomain-53475-1434846046033-2:1:1:8:1
20:21:01,315 INFO  [stdout] (default-threads - 8) handling message: ID:localhost.localdomain-53475-1434846046033-2:1:1:9:1
20:21:01,316 INFO  [stdout] (default-threads - 8) Expired Ack (ActiveMQSession) for: null,ID:localhost.localdomain-53475-1434846046033-2:1:1:9:1
20:21:01,423 INFO  [stdout] (default-threads - 9) handling message: ID:localhost.localdomain-53475-1434846046033-2:1:1:10:1
20:21:01,539 INFO  [stdout] (default-threads - 10) handling message: ID:localhost.localdomain-53475-1434846046033-2:1:1:11:1
20:21:01,655 INFO  [stdout] (default-threads - 11) handling message: ID:localhost.localdomain-53475-1434846046033-2:1:1:12:1
20:21:01,768 INFO  [stdout] (default-threads - 12) handling message: ID:localhost.localdomain-53475-1434846046033-2:1:1:13:1
20:21:01,806 INFO  [stdout] (default-threads - 12) Expired Ack (ActiveMQSession) for: null,ID:localhost.localdomain-53475-1434846046033-2:1:1:13:1
20:21:01,809 INFO  [stdout] (default-threads - 3) Hello world!3
20:21:01,810 INFO  [stdout] (default-threads - 3) Sending Ack (ActiveMQSession line 1010) for: 2; ID:localhost.localdomain-53475-1434846046033-2:1:1:4:1,ID:localhost.localdomain-53475-1434846046033-2:1:1:4:1
20:21:01,872 INFO  [stdout] (default-threads - 4) Hello world!4
20:21:01,872 INFO  [stdout] (default-threads - 4) Sending Ack (ActiveMQSession line 1010) for: 2; ID:localhost.localdomain-53475-1434846046033-2:1:1:5:1,ID:localhost.localdomain-53475-1434846046033-2:1:1:5:1
20:21:01,874 INFO  [stdout] (default-threads - 13) handling message: ID:localhost.localdomain-53475-1434846046033-2:1:1:14:1
20:21:01,888 ERROR [org.apache.activemq.ra.ActiveMQEndpointWorker] (ActiveMQ Connection Executor: tcp://localhost/127.0.0.1:61616@43165) Connection to broker failed: Unmatched acknowledge: MessageAck {commandId = 16, responseRequired = false, ackType = 2, consumerId = ID:localhost.localdomain-46056-1434846051491-1:1:-1:2, firstMessageId = ID:localhost.localdomain-53475-1434846046033-2:1:1:4:1, lastMessageId = ID:localhost.localdomain-53475-1434846046033-2:1:1:4:1, destination = queue://TEST.FOO, transactionId = null, messageCount = 1, poisonCause = null}; Could not find Message-ID ID:localhost.localdomain-53475-1434846046033-2:1:1:4:1 in dispatched-list (start of ack): javax.jms.JMSException: Unmatched acknowledge: MessageAck {commandId = 16, responseRequired = false, ackType = 2, consumerId = ID:localhost.localdomain-46056-1434846051491-1:1:-1:2, firstMessageId = ID:localhost.localdomain-53475-1434846046033-2:1:1:4:1, lastMessageId = ID:localhost.localdomain-53475-1434846046033-2:1:1:4:1, destination = queue://TEST.FOO, transactionId = null, messageCount = 1, poisonCause = null}; Could not find Message-ID ID:localhost.localdomain-53475-1434846046033-2:1:1:4:1 in dispatched-list (start of ack)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14597520" author="gtully" created="Tue, 23 Jun 2015 11:46:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=christopher.l.shannon&quot; class=&quot;user-hover&quot; rel=&quot;christopher.l.shannon&quot;&gt;christopher.l.shannon&lt;/a&gt; great detail &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. Seems that the broker reaction to the expiredAck is excessive. maybe that should be treated as a single/individual ack and just remove the single message that has expired, it can check the count attribute to ensure it should match a single message. Currently in prefetchsub there is a check on all dispatched messages which seems excessive in this scenario. I think that is the crux of the problem.&lt;/p&gt;

&lt;p&gt;For a long time, there was no message expiry processing thread so the only checks were on dispatch, it seems when there is periodic expiry some of the additional checks are candidates from removal.&lt;/p&gt;</comment>
                            <comment id="14597695" author="christopher.l.shannon" created="Tue, 23 Jun 2015 14:13:11 +0000"  >&lt;p&gt;It seems like switching the logic to only remove the message or messages that the ack refers to might be the best way to go. The rest of the acknowledgements seem to work like this already so it seems like a good idea to make them behave the same.&lt;/p&gt;

&lt;p&gt;Besides expiring pending messages waiting to be dispatched, does the expiry task also look at dispatched messages? &lt;/p&gt;</comment>
                            <comment id="14597726" author="gtully" created="Tue, 23 Jun 2015 14:25:06 +0000"  >&lt;p&gt;the expiry task does not deal with dispatched messages. that was sorted via : &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5274?focusedCommentId=14130650&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14130650&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5274?focusedCommentId=14130650&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14130650&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14597764" author="christopher.l.shannon" created="Tue, 23 Jun 2015 14:56:59 +0000"  >&lt;p&gt;I can work on a patch for this for this week.  Some of the users that connect to the brokers that my team manages use message driven beans so it would be nice to try and get this sorted out in time for 5.12.0.&lt;/p&gt;</comment>
                            <comment id="14601700" author="githubbot" created="Thu, 25 Jun 2015 18:41:44 +0000"  >&lt;p&gt;GitHub user cshannon opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/123&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/123&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5851&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5851&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This commit resolves an issue where unmatched acknowledgement&lt;br/&gt;
    messages could be received when running a MDB consumer and&lt;br/&gt;
    sending messages with a short TTL.  The expiration logic when&lt;br/&gt;
    receiveing an expired Message Ack will now only expire messages&lt;br/&gt;
    in dispatch relating to the received ack, not all expired messages&lt;br/&gt;
    in the dispatch list.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/cshannon/activemq&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cshannon/activemq&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5851&quot; title=&quot;Unmatched acknowledge: MessageAck {commandId = 77, responseRequired = false, ackType = 2, ...Could not find Message-ID XXX in dispatched-list (start of ack)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-5851&quot;&gt;&lt;del&gt;AMQ-5851&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/123.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/123.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #123&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 1bce29ac6f55394fa9ebf2ee347dcde415bac7e0&lt;br/&gt;
Author: Christopher L. Shannon (cshannon) &amp;lt;christopher.l.shannon@gmail.com&amp;gt;&lt;br/&gt;
Date:   2015-06-25T18:22:32Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-5851&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AMQ-5851&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This commit resolves an issue where unmatched acknowledgement&lt;br/&gt;
    messages could be received when running a MDB consumer and&lt;br/&gt;
    sending messages with a short TTL.  The expiration logic when&lt;br/&gt;
    receiveing an expired Message Ack will now only expire messages&lt;br/&gt;
    in dispatch relating to the received ack, not all expired messages&lt;br/&gt;
    in the dispatch list.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14601708" author="christopher.l.shannon" created="Thu, 25 Jun 2015 18:43:23 +0000"  >&lt;p&gt;I created a pull request to address this issue and to update the expired ack to only expire the messages in dispatched relating to the ack, and not all expired messages.  I added a unit test that simulates the issue with how it would be run in an application container.  The test passes with my patch but fails without it.  Take a look and let me know what you think.&lt;/p&gt;</comment>
                            <comment id="14602635" author="gtully" created="Fri, 26 Jun 2015 09:55:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=christopher.l.shannon&quot; class=&quot;user-hover&quot; rel=&quot;christopher.l.shannon&quot;&gt;christopher.l.shannon&lt;/a&gt; the changes look good - however I did a sanity check with some tests and the first one I tried - org.apache.activemq.JMSConsumerTest#testMessageListenerWithConsumerCanBeStoppedConcurently had a failure that seems related.&lt;br/&gt;
Can you investigate and possibly validate with a full test run of the unit tests.&lt;/p&gt;</comment>
                            <comment id="14602708" author="christopher.l.shannon" created="Fri, 26 Jun 2015 11:12:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;,  &lt;/p&gt;

&lt;p&gt;Thanks for pointing that out, my logic was slightly off when I tried to move the isAckRange check into a helper method, so I will back that part of the patch out.&lt;/p&gt;

&lt;p&gt;I had run through a bunch of tests already that I could find relating to expired messages and they had passed but of course there are a lot of tests.  The JMSConsumerTest seems like a good one to run for a sanity check though.&lt;/p&gt;

&lt;p&gt;I&apos;ll go ahead and do a full run through all the tests and amend my pull request if everything looks good.&lt;/p&gt;</comment>
                            <comment id="14602722" author="gtully" created="Fri, 26 Jun 2015 11:28:32 +0000"  >&lt;p&gt;great. A good trick is to poke around the git annotations in the code you are changing to find relevant commits and corresponding tests. That is why I chose JMSConsumerTest. &lt;br/&gt;
This does point to the need to have some good sanity tests in the PR build.&lt;/p&gt;</comment>
                            <comment id="14603416" author="christopher.l.shannon" created="Fri, 26 Jun 2015 18:52:34 +0000"  >&lt;p&gt;Thanks Gary, that&apos;s a good point.  I pushed up my modified PR.  The tests have been running for 6+ hours and I think it is good to go.  There were a couple that failed but those tests always fail on my machine so it doesn&apos;t have anything to do with the patch.  For example, TopicClusterTest always fails for me but seems to work fine in the Apache Jenkins setup.&lt;/p&gt;

&lt;p&gt;I agree it would be nice to run some sanity tests that hit core parts of the code base on the PR build, just as long as the build isn&apos;t too long, maybe something that can run in 15 or 20 minutes.&lt;/p&gt;</comment>
                            <comment id="14620723" author="githubbot" created="Thu, 9 Jul 2015 15:48:37 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/activemq/pull/123&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/activemq/pull/123&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14620749" author="gtully" created="Thu, 9 Jul 2015 16:04:32 +0000"  >&lt;p&gt;patch applied with thanks to cshannon in &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/activemq/commit/f10aab64&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/activemq/commit/f10aab64&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14620778" author="grijesh.saini" created="Thu, 9 Jul 2015 16:20:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=christopher.l.shannon&quot; class=&quot;user-hover&quot; rel=&quot;christopher.l.shannon&quot;&gt;christopher.l.shannon&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gtully&quot; class=&quot;user-hover&quot; rel=&quot;gtully&quot;&gt;gtully&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thank you for the fix &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12759684">AMQ-5476</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12740594" name="AcknowledgeIssue.zip" size="8444341" author="grijesh.saini" created="Fri, 19 Jun 2015 07:35:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2g7dj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>