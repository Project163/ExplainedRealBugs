<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 06:02:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[AMQ-4920] AmqpErrorException occurs with multiple concurrent amqp topic consumers</title>
                <link>https://issues.apache.org/jira/browse/AMQ-4920</link>
                <project id="12311210" key="AMQ">ActiveMQ Classic</project>
                    <description>&lt;p&gt;I&apos;ll add a test to reproduce this.  There are currently 2 problems.  The more frequent one looks like:  org.apache.qpid.amqp_1_0.type.AmqpErrorException&lt;br/&gt;
        at org.apache.qpid.amqp_1_0.codec.ValueHandler.readConstructor(ValueHandler.java:99)&lt;br/&gt;
        at org.apache.qpid.amqp_1_0.codec.ValueHandler.parse(ValueHandler.java:90)&lt;br/&gt;
        at org.apache.qpid.amqp_1_0.codec.ValueHandler.readConstructor(ValueHandler.java:105)&lt;br/&gt;
        at org.apache.qpid.amqp_1_0.codec.ValueHandler.parse(ValueHandler.java:90)&lt;/p&gt;

&lt;p&gt;&#8230; repeated many times&lt;br/&gt;
at org.apache.qpid.amqp_1_0.codec.ValueHandler.readConstructor(ValueHandler.java:105)&lt;br/&gt;
        at org.apache.qpid.amqp_1_0.codec.ValueHandler.parse(ValueHandler.java:90)&lt;br/&gt;
        at org.apache.qpid.amqp_1_0.messaging.SectionDecoderImpl.parseAll(SectionDecoderImpl.java:49)&lt;br/&gt;
        at org.apache.qpid.amqp_1_0.client.Receiver.receive(Receiver.java:280)&lt;br/&gt;
        at org.apache.qpid.amqp_1_0.jms.impl.MessageConsumerImpl.receive0(MessageConsumerImpl.java:286)&lt;br/&gt;
        at org.apache.qpid.amqp_1_0.jms.impl.MessageConsumerImpl.receiveImpl(MessageConsumerImpl.java:255)&lt;br/&gt;
        at org.apache.qpid.amqp_1_0.jms.impl.MessageConsumerImpl.receive(MessageConsumerImpl.java:238)&lt;br/&gt;
        at org.apache.qpid.amqp_1_0.jms.impl.MessageConsumerImpl.receive(MessageConsumerImpl.java:56)&lt;br/&gt;
        at org.apache.activemq.transport.amqp.ENTMQ466ConsumerThread.run(ENTMQ466Test.java:123)&lt;/p&gt;

&lt;p&gt;This occurs at the line &quot;final EncodedMessage amqp = outboundTransformer.transform(jms);&quot; in the ConsumerContext.pumpOutbound() method of AmqpProtocolConverter(). This call sometimes returns with its content (amqp.getArray()) set to all zeros. &lt;/p&gt;

&lt;p&gt;On those messages this line&lt;br/&gt;
LOG.info(&quot;In pumpOutbound, setting currentBuffer to offset {} length {} content &lt;span class=&quot;error&quot;&gt;&amp;#91;{}&amp;#93;&lt;/span&gt;&quot;, amqp.getArrayOffset(), amqp.getLength(), amqp.getArray());&lt;br/&gt;
returns:&lt;/p&gt;

&lt;p&gt;2013-11-26 17:19:16,680 &lt;span class=&quot;error&quot;&gt;&amp;#91;calhost&amp;#93;&lt;/span&gt; Task-3] - INFO AmqpProtocolConverter - In pumpOutbound, setting currentBuffer to offset 0 length 162 content [[0, 0, 0, 0, 0, \&lt;br/&gt;
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\&lt;br/&gt;
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0\&lt;br/&gt;
, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]]&lt;/p&gt;

&lt;p&gt;At the root of this, outboundTransformer is a (proton) AutoOutboundTransformer.  It calls AMQPNativeOutboundTransformer.transform(), which calls msg.readBytes(data), which sometimes writes all 0s to data.  Here msg is an ActiveMQBytesMessage.  &lt;/p&gt;
</description>
                <environment></environment>
        <key id="12682879">AMQ-4920</key>
            <summary>AmqpErrorException occurs with multiple concurrent amqp topic consumers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kearls">Kevin Anthony Earls</assignee>
                                    <reporter username="kearls">Kevin Anthony Earls</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 Dec 2013 11:11:35 +0000</created>
                <updated>Wed, 2 Apr 2014 22:15:47 +0000</updated>
                            <resolved>Thu, 9 Jan 2014 09:42:28 +0000</resolved>
                                                    <fixVersion>5.9.1</fixVersion>
                    <fixVersion>5.10.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13844634" author="tabish121" created="Tue, 10 Dec 2013 20:33:56 +0000"  >&lt;p&gt;My guess would be that the message is getting dispatched to two different transports at the same time and the amqp transport code that modifies headers and read the message body causes one to read the message while its in an invalid state.  &lt;/p&gt;

&lt;p&gt;I made this change and now I can&apos;t reproduce the problem, still requires further investigation though to confirm that this is what&apos;s really happening.  &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                    org.apache.activemq.command.Message message = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (md.getMessage() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                        message = md.getMessage().copy();
                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!message.getProperties().containsKey(MESSAGE_FORMAT_KEY)) {
                            message.setProperty(MESSAGE_FORMAT_KEY, 0);
                        }
                    }
                    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ActiveMQMessage jms = (ActiveMQMessage) message;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13845198" author="kearls" created="Wed, 11 Dec 2013 09:02:37 +0000"  >&lt;p&gt;Hi Tim.  I applied your change, but AMQ4920Test still fails.  Did you change anything else?&lt;/p&gt;</comment>
                            <comment id="13845313" author="tabish121" created="Wed, 11 Dec 2013 11:12:53 +0000"  >&lt;p&gt;It could still fail here since this really isn&apos;t synchronized.  I did also have the BytesMessage losing contents patch applied at the time as well.  &lt;/p&gt;</comment>
                            <comment id="13847648" author="tabish121" created="Fri, 13 Dec 2013 16:53:17 +0000"  >&lt;p&gt;Kevin, can you test using the following patch and see if your test still fails.  &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;diff --git a/activemq-amqp/src/main/java/org/apache/activemq/transport/amqp/AmqpProtocolConverter.java b/activemq-amqp/src/main/java/org/apache/activemq/transport/amqp/AmqpProtocolConverter.java
index 893fa1b..06a4aa9 100644
--- a/activemq-amqp/src/main/java/org/apache/activemq/transport/amqp/AmqpProtocolConverter.java
+++ b/activemq-amqp/src/main/java/org/apache/activemq/transport/amqp/AmqpProtocolConverter.java
@@ -1134,7 +1137,7 @@
             consumerInfo.setNoRangeAcks(true);
             consumerInfo.setDestination(dest);
             consumerInfo.setPrefetchSize(100);
-            consumerInfo.setDispatchAsync(true);
+            consumerInfo.setDispatchAsync(false);
             if (source.getDistributionMode() == COPY &amp;amp;&amp;amp; dest.isQueue()) {
                 consumerInfo.setBrowser(true);
             }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13847709" author="kearls" created="Fri, 13 Dec 2013 17:50:29 +0000"  >&lt;p&gt;Sorry, still failing.  It looks like it&apos;s better, as now AMQ4920Test sometimes finishes, but most of the time it still fails.&lt;/p&gt;</comment>
                            <comment id="13847821" author="tabish121" created="Fri, 13 Dec 2013 19:32:44 +0000"  >&lt;p&gt;Do you have the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/AMQ-4887&quot; title=&quot;ActiveMQBytesMessage will lost content if message&amp;#39;s property was set before copy &quot; class=&quot;issue-link&quot; data-issue-key=&quot;AMQ-4887&quot;&gt;&lt;del&gt;AMQ-4887&lt;/del&gt;&lt;/a&gt; applied to your codebase right now, I&apos;ve been unable to reproduce this issue after that fix plus changing the async dispatch flag to false.  &lt;/p&gt;</comment>
                            <comment id="13848650" author="kearls" created="Sun, 15 Dec 2013 18:23:05 +0000"  >&lt;p&gt;I have that installed, and AMQ4920Test is still failing for me.  I&apos;ll double check tomorrow and make sure I&apos;m running all of the right code.&lt;/p&gt;</comment>
                            <comment id="13849640" author="tabish121" created="Mon, 16 Dec 2013 19:38:55 +0000"  >&lt;p&gt;Updated the test to fix a timing issue that could cause it to fail erroneously.  Maybe retry the async dispatch fix again to see if this was the failure you were seeing.  &lt;/p&gt;</comment>
                            <comment id="13850268" author="kearls" created="Tue, 17 Dec 2013 09:09:50 +0000"  >&lt;p&gt;Sorry, it&apos;s still failing for me.  I&apos;ll attach a log where I ran the test 50 times and got 16 failures.  After each failure I grepped for error messages, most of which look like:&lt;/p&gt;

&lt;p&gt;2013-12-17 09:50:36,657 &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-1-thread-4&amp;#93;&lt;/span&gt; - ERROR AMQ4930ConsumerTask            - consumer Consumer-3 expected 291 got message &lt;span class=&quot;error&quot;&gt;&amp;#91;topic&amp;#93;&lt;/span&gt;&lt;br/&gt;
or &lt;br/&gt;
2013-12-17 09:49:32,429 &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-1-thread-3&amp;#93;&lt;/span&gt; - ERROR AMQ4930ConsumerTask            - consumer Consumer-2 expected 646 got message &lt;span class=&quot;error&quot;&gt;&amp;#91;topic://AMQ4920Test1387270164946&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="13850269" author="kearls" created="Tue, 17 Dec 2013 09:10:52 +0000"  >&lt;p&gt;Log from 50 iterations of AMQ4920Test&lt;/p&gt;</comment>
                            <comment id="13850853" author="tabish121" created="Tue, 17 Dec 2013 20:22:45 +0000"  >&lt;p&gt;I&apos;ve added one fix that ensures that when dispatched to Topic consumers we don&apos;t do concurrent writes to the same Message object.  &lt;/p&gt;</comment>
                            <comment id="13865670" author="tabish121" created="Wed, 8 Jan 2014 17:38:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kearls&quot; class=&quot;user-hover&quot; rel=&quot;kearls&quot;&gt;kearls&lt;/a&gt; I believe this is resolved now, can you confirm that and close this if you are satisfied that its fixed. &lt;/p&gt;</comment>
                            <comment id="13951265" author="gurilubana" created="Fri, 28 Mar 2014 19:18:41 +0000"  >&lt;p&gt;Is there a workaround for this bug. I am using qpid-java-amqp-1-0-client-jms-0.26 and still hit this error.&lt;/p&gt;</comment>
                            <comment id="13955299" author="kearls" created="Mon, 31 Mar 2014 15:32:58 +0000"  >&lt;p&gt;Unfortunately there&apos;s no workaround in 5.9, you&apos;d need to use a 5.10-SNAPSHOT.&lt;/p&gt;</comment>
                            <comment id="13956818" author="gurilubana" created="Tue, 1 Apr 2014 17:51:27 +0000"  >&lt;p&gt;So essentially multiple topic consumers even running from different instances do not work. This pretty much makes publish-subscribe system unworkable since in any production environment you would have more than 1 subscriber to the same topic. Or is there any other way.?&lt;br/&gt;
Btw any idea when 5.10 is coming out.&lt;br/&gt;
Also is it the broker or client problem?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12619062" name="rp.out" size="143579" author="kearls" created="Tue, 17 Dec 2013 09:10:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>362136</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 34 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qf9j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>362431</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>