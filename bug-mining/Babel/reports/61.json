{"url":"https://api.github.com/repos/babel/babel/issues/13245","repository_url":"https://api.github.com/repos/babel/babel","labels_url":"https://api.github.com/repos/babel/babel/issues/13245/labels{/name}","comments_url":"https://api.github.com/repos/babel/babel/issues/13245/comments","events_url":"https://api.github.com/repos/babel/babel/issues/13245/events","html_url":"https://github.com/babel/babel/issues/13245","id":873690389,"node_id":"MDU6SXNzdWU4NzM2OTAzODk=","number":13245,"title":"[Bug]: plugin-transform-block-scoping constant checks produce different behaviour","user":{"login":"overlookmotel","id":557937,"node_id":"MDQ6VXNlcjU1NzkzNw==","avatar_url":"https://avatars.githubusercontent.com/u/557937?v=4","gravatar_id":"","url":"https://api.github.com/users/overlookmotel","html_url":"https://github.com/overlookmotel","followers_url":"https://api.github.com/users/overlookmotel/followers","following_url":"https://api.github.com/users/overlookmotel/following{/other_user}","gists_url":"https://api.github.com/users/overlookmotel/gists{/gist_id}","starred_url":"https://api.github.com/users/overlookmotel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/overlookmotel/subscriptions","organizations_url":"https://api.github.com/users/overlookmotel/orgs","repos_url":"https://api.github.com/users/overlookmotel/repos","events_url":"https://api.github.com/users/overlookmotel/events{/privacy}","received_events_url":"https://api.github.com/users/overlookmotel/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":919437103,"node_id":"MDU6TGFiZWw5MTk0MzcxMDM=","url":"https://api.github.com/repos/babel/babel/labels/outdated","name":"outdated","color":"ededed","default":false,"description":"A closed issue/PR that is archived due to age. Recommended to make a new issue"}],"state":"closed","locked":true,"assignee":{"login":"overlookmotel","id":557937,"node_id":"MDQ6VXNlcjU1NzkzNw==","avatar_url":"https://avatars.githubusercontent.com/u/557937?v=4","gravatar_id":"","url":"https://api.github.com/users/overlookmotel","html_url":"https://github.com/overlookmotel","followers_url":"https://api.github.com/users/overlookmotel/followers","following_url":"https://api.github.com/users/overlookmotel/following{/other_user}","gists_url":"https://api.github.com/users/overlookmotel/gists{/gist_id}","starred_url":"https://api.github.com/users/overlookmotel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/overlookmotel/subscriptions","organizations_url":"https://api.github.com/users/overlookmotel/orgs","repos_url":"https://api.github.com/users/overlookmotel/repos","events_url":"https://api.github.com/users/overlookmotel/events{/privacy}","received_events_url":"https://api.github.com/users/overlookmotel/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"overlookmotel","id":557937,"node_id":"MDQ6VXNlcjU1NzkzNw==","avatar_url":"https://avatars.githubusercontent.com/u/557937?v=4","gravatar_id":"","url":"https://api.github.com/users/overlookmotel","html_url":"https://github.com/overlookmotel","followers_url":"https://api.github.com/users/overlookmotel/followers","following_url":"https://api.github.com/users/overlookmotel/following{/other_user}","gists_url":"https://api.github.com/users/overlookmotel/gists{/gist_id}","starred_url":"https://api.github.com/users/overlookmotel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/overlookmotel/subscriptions","organizations_url":"https://api.github.com/users/overlookmotel/orgs","repos_url":"https://api.github.com/users/overlookmotel/repos","events_url":"https://api.github.com/users/overlookmotel/events{/privacy}","received_events_url":"https://api.github.com/users/overlookmotel/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":2,"created_at":"2021-05-01T14:39:40Z","updated_at":"2021-08-03T04:03:19Z","closed_at":"2021-05-03T15:47:25Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### ðŸ’»\r\n\r\n- [X] Would you like to work on a fix?\r\n\r\n### How are you using Babel?\r\n\r\n@babel/cli\r\n\r\n### Input code\r\n\r\n```js\r\nlet isCalled = false;\r\nconst fn = () => isCalled = true;\r\n\r\nconst i = 0;\r\ntry {\r\n  i = fn();\r\n} catch (e) {\r\n  console.log(isCalled);\r\n}\r\n```\r\n\r\n[Babel REPL](https://babeljs.io/repl#?browsers=&build=&builtIns=false&corejs=3.6&spec=false&loose=true&code_lz=DYUwLgBAlgzgwgQ2KAJhAvBAZkmIDcAUAMYD2AdjJFuRhABQCUGAfNPEqnWAE4CuBQiQpVodAIxFeATwgBvQhDGYaTIgF8IxBGGIALBiGYKlZSqVAA6YKQDm9WImQgUjDYSA&debug=false&forceAllTransforms=false&shippedProposals=false&circleciRepo=&evaluate=false&fileSize=false&timeTravel=false&sourceType=module&lineWrap=true&presets=&prettier=false&targets=Node-10&version=7.14.0&externalPlugins=%40babel%2Fplugin-transform-block-scoping%407.13.16)\r\n\r\n### Configuration file name\r\n\r\n_No response_\r\n\r\n### Configuration\r\n\r\n_No response_\r\n\r\n### Current and expected behavior\r\n\r\nOriginal code logs \"true\".\r\n\r\nBut [plugin-transform-block-scoping](https://babeljs.io/docs/en/babel-plugin-transform-block-scoping)'s constant checks produces code with a slightly different behaviour:\r\n\r\n```js\r\nfunction _readOnlyError(name) { throw new TypeError(\"\\\"\" + name + \"\\\" is read-only\"); }\r\nvar isCalled = false;\r\nvar fn = () => isCalled = true;\r\n\r\nvar i = 0;\r\ntry {\r\n  i = (_readOnlyError(\"i\"), fn());\r\n} catch (e) {\r\n  console.log(isCalled);\r\n}\r\n```\r\n\r\nThis logs \"false\" because `_readOnlyError()` throws before `fn()` is evaluated.\r\n\r\n### Environment\r\n\r\nBabel REPL\r\n\r\n### Possible solution\r\n\r\nOrder of `fn()` and `_readOnlyError(\"i\")` should be reversed:\r\n\r\n```js\r\ni = (fn(), _readOnlyError(\"i\"))\r\n```\r\n\r\nThis order would produce wrong result if `_readOnlyError()` returned a value, but since we know for sure it'll throw, that's not relevant.\r\n\r\n### Additional context\r\n\r\nThere are two other more obscure cases where the above solution is not sufficient to solve the problem:\r\n\r\n(I may have time to make a PR for the simple case above, but unlikely I will for these two)\r\n\r\n#### Destructuring\r\n\r\n```js\r\nconst c = 0;\r\nlet x = 1, y = 2;\r\ntry {\r\n  [x, c, y] = [11, 0, 22];\r\n} catch (e) {\r\n  console.log( {x, y} );\r\n}\r\n```\r\n\r\n[REPL](https://babeljs.io/repl#?browsers=&build=&builtIns=false&corejs=3.6&spec=false&loose=true&code_lz=MYewdgzgLgBMMF4YAYDcAoANgU1gD0RgEYAaGAT0ICYMoAnSgb3RhgG08zgzyBdQtkVIoyVKrwwBfOAEMowABYwAFNgCUMZq1CQQOAHSYQAc2WNOFSWqnogA&debug=false&forceAllTransforms=false&shippedProposals=false&circleciRepo=&evaluate=false&fileSize=false&timeTravel=false&sourceType=module&lineWrap=true&presets=&prettier=false&targets=Node-10&version=7.14.0&externalPlugins=%40babel%2Fplugin-transform-block-scoping%407.13.16)\r\n\r\n`[x, c, y] = []` is transformed to `[x, c, y] = (_readOnlyError(\"c\"), [11, 0, 22])`.\r\n\r\nOriginal logs `{x: 11, y: 2}` whereas transpiled code logs `{x: 1, y: 2}`. It should throw only after `x` has been assigned, but before `y` is.\r\n\r\nThis is tricky to get right. Best solution I can see is:\r\n\r\n```js\r\n// NB Assignment to `y` has been omitted\r\n[x] = [11, 0, 22], _readOnlyError(\"c\");\r\n```\r\n\r\n#### Assignment operators\r\n\r\n```js\r\nconst calls = [];\r\nconst fn = () => calls.push('fn');\r\n\r\nconst i = {\r\n  valueOf() {\r\n    calls.push('valueOf');\r\n    return 1;\r\n   }\r\n};\r\n\r\ntry {\r\n  i += fn();\r\n} catch (e) {\r\n  console.log(calls);\r\n}\r\n```\r\n\r\n[Babel REPL](https://babeljs.io/repl#?browsers=&build=&builtIns=false&corejs=3.6&spec=false&loose=true&code_lz=MYewdgzgLgBMCGAbREYF4YG0C6BuAUKJLAGZjowAUAlOgHxxIoB0ADgK4QAWlA5Gb2oFC4aDACWFAN74YMAG5J2AUwDyJGjBly5CZBDacevRYhXrBBHTABOyqOxvkAjFbkBffO-FQbATy1ZCRgAagwyGgJ3RihgLiplWm04URBEZWZEEABzSj0UIS8gA&debug=false&forceAllTransforms=false&shippedProposals=false&circleciRepo=&evaluate=false&fileSize=false&timeTravel=false&sourceType=module&lineWrap=true&presets=&prettier=false&targets=Node-10&version=7.14.0&externalPlugins=%40babel%2Fplugin-transform-block-scoping%407.13.16)\r\n\r\nOriginal logs `[ 'fn', 'valueOf' ]`.\r\n\r\nBabel transforms `i += fn()` to `i += (_readOnlyError(\"i\"), fn())`. So transpiled code logs `[]`.\r\n\r\nAfter reversing `fn()` and `_readOnlyError(\"i\")`, it logs `[ 'fn' ]` (still incorrect).\r\n\r\nThe correct transpiled output would be:\r\n\r\n```js\r\ni + fn(), _readOnlyError(\"i\")\r\n```\r\n\r\nNB `&&=`, `||=` and `??=` aren't affected by this additional complication, but I think all other assignment operators are.\r\n\r\n`i++` / `++i` should be treated as same as `i += 1`:\r\n\r\n```js\r\ni + 1, _readOnlyError(\"i\")\r\n```","closed_by":{"login":"JLHwung","id":3607926,"node_id":"MDQ6VXNlcjM2MDc5MjY=","avatar_url":"https://avatars.githubusercontent.com/u/3607926?v=4","gravatar_id":"","url":"https://api.github.com/users/JLHwung","html_url":"https://github.com/JLHwung","followers_url":"https://api.github.com/users/JLHwung/followers","following_url":"https://api.github.com/users/JLHwung/following{/other_user}","gists_url":"https://api.github.com/users/JLHwung/gists{/gist_id}","starred_url":"https://api.github.com/users/JLHwung/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JLHwung/subscriptions","organizations_url":"https://api.github.com/users/JLHwung/orgs","repos_url":"https://api.github.com/users/JLHwung/repos","events_url":"https://api.github.com/users/JLHwung/events{/privacy}","received_events_url":"https://api.github.com/users/JLHwung/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/babel/babel/issues/13245/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/babel/babel/issues/13245/timeline","performed_via_github_app":null,"state_reason":"completed"}