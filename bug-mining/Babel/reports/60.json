{"url":"https://api.github.com/repos/babel/babel/issues/11964","repository_url":"https://api.github.com/repos/babel/babel","labels_url":"https://api.github.com/repos/babel/babel/issues/11964/labels{/name}","comments_url":"https://api.github.com/repos/babel/babel/issues/11964/comments","events_url":"https://api.github.com/repos/babel/babel/issues/11964/events","html_url":"https://github.com/babel/babel/issues/11964","id":679431325,"node_id":"MDU6SXNzdWU2Nzk0MzEzMjU=","number":11964,"title":"@babel/register cannot process `convert-source-map` module","user":{"login":"overlookmotel","id":557937,"node_id":"MDQ6VXNlcjU1NzkzNw==","avatar_url":"https://avatars.githubusercontent.com/u/557937?v=4","gravatar_id":"","url":"https://api.github.com/users/overlookmotel","html_url":"https://github.com/overlookmotel","followers_url":"https://api.github.com/users/overlookmotel/followers","following_url":"https://api.github.com/users/overlookmotel/following{/other_user}","gists_url":"https://api.github.com/users/overlookmotel/gists{/gist_id}","starred_url":"https://api.github.com/users/overlookmotel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/overlookmotel/subscriptions","organizations_url":"https://api.github.com/users/overlookmotel/orgs","repos_url":"https://api.github.com/users/overlookmotel/repos","events_url":"https://api.github.com/users/overlookmotel/events{/privacy}","received_events_url":"https://api.github.com/users/overlookmotel/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":560986419,"node_id":"MDU6TGFiZWw1NjA5ODY0MTk=","url":"https://api.github.com/repos/babel/babel/labels/i:%20needs%20triage","name":"i: needs triage","color":"ededed","default":false,"description":null},{"id":919437103,"node_id":"MDU6TGFiZWw5MTk0MzcxMDM=","url":"https://api.github.com/repos/babel/babel/labels/outdated","name":"outdated","color":"ededed","default":false,"description":"A closed issue/PR that is archived due to age. Recommended to make a new issue"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-08-14T22:23:20Z","updated_at":"2021-04-24T04:05:03Z","closed_at":"2021-01-22T10:08:21Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bug Report\r\n\r\n<!-- If you would like to implement a PR, we are more than happy to help you go through the process!-->\r\n- [X] I would like to work on a fix!\r\n\r\n<!--\r\n@babel/eslint-parser:\r\n  If you are having issues with JSX you might want to check out eslint-plugin-react. If there's an issue with new experimental syntax you might need check if it's supported by @babel/eslint-plugin.\r\n-->\r\n\r\n**Current behavior**\r\n\r\n`@babel/register` errors when code it is transpiling requires the `convert-source-map` package.\r\n\r\n**Input Code**\r\n\r\n```js\r\nrequire('@babel/register')( { ignore: [] } );\r\nconsole.log( require('convert-source-map') );\r\n```\r\n\r\nProduces error:\r\n\r\n```\r\nTypeError: /path/to/app/node_modules/convert-source-map/index.js:\r\n  _convertSourceMap(...).default.fromObject is not a function\r\n    at generateCode (/path/to/app/node_modules/@babel/core/lib/transformation/file/generate.js:78:54)\r\n```\r\n\r\nNB Does not error if `cache: false` option is used.\r\n\r\n**Expected behavior**\r\n\r\nExpected application to run without error.\r\n\r\n**Babel Configuration (babel.config.js, .babelrc, package.json#babel, cli command, .eslintrc)**\r\n\r\nNone.\r\n\r\n**Environment**\r\n<!--- Tip: Instead of filling out the questions below, you can run `npx envinfo --preset babel` and paste the result below ``` -->\r\n```\r\nSystem:\r\n  OS: macOS Mojave 10.14.6\r\nBinaries:\r\n  Node: 14.7.0 - ~/.nvm/versions/node/v14.7.0/bin/node\r\n  npm: 6.14.7 - ~/.nvm/versions/node/v14.7.0/bin/npm\r\nnpmPackages:\r\n  @babel/core: ^7.11.1 => 7.11.1 \r\n  @babel/generator: ^7.11.0 => 7.11.0 \r\n  @babel/parser: ^7.11.3 => 7.11.3 \r\n  @babel/plugin-transform-modules-commonjs: ^7.10.4 => 7.10.4 \r\n  @babel/register: ^7.10.5 => 7.10.5 \r\n  @babel/traverse: ^7.11.0 => 7.11.0 \r\n  @babel/types: ^7.11.0 => 7.11.0 \r\n  babel-jest: ^26.3.0 => 26.3.0 \r\n  eslint: ^7.6.0 => 7.6.0 \r\n  jest: ^26.3.0 => 26.3.0\r\n```\r\n\r\n**Possible Solution**\r\n<!--- If you have suggestions on a fix for the bug -->\r\n\r\nCause appears to be that `@babel/core` also requires `convert-source-map` internally [here](https://github.com/babel/babel/blob/main/packages/babel-core/src/transformation/file/generate.js#L4). However, the build on NPM lazy-loads the package:\r\n\r\n```js\r\nfunction _convertSourceMap() {\r\n  const data = _interopRequireDefault(require(\"convert-source-map\"));\r\n\r\n  _convertSourceMap = function () {\r\n    return data;\r\n  };\r\n\r\n  return data;\r\n}\r\n```\r\n\r\nSo, while generating the transpiled version of `convert-source-map`, `require('convert-source-map')` is called again. It's a circular require and so returns `{}`, causing the error.\r\n\r\nIf caching is disabled, other modules are passed through `generateCode()` first, and so `require('convert-source-map')` is not circular -> no error.\r\n\r\nA hacky solution would be:\r\n\r\n1. Run dummy data through `generateCode()` before registering the `pirates` hook. This would get `convert-source-map` pre-loaded inside `@babel/core`.\r\n2. Clear `convert-source-map` from the require cache so it would be transpiled anew when later `require()`-ed.\r\n\r\n```js\r\nrequire('@babel.core').transformSync('1', {sourceMaps: 'inline', configFile: false, babelrc: false});\r\ndelete require.cache[require.resolve('convert-source-map')];\r\n```\r\n\r\nObviously this is a very hacky solution and would impose a small slowdown on all users, most of whom won't be using `convert-source-map`, so not great. But maybe there's a better way. Or maybe it's not worth solving.\r\n\r\n**Additional context**\r\n\r\nI am using Babel to instrument code, hence why I want it to transpile all code, including `node_modules`.","closed_by":{"login":"nicolo-ribaudo","id":7000710,"node_id":"MDQ6VXNlcjcwMDA3MTA=","avatar_url":"https://avatars.githubusercontent.com/u/7000710?v=4","gravatar_id":"","url":"https://api.github.com/users/nicolo-ribaudo","html_url":"https://github.com/nicolo-ribaudo","followers_url":"https://api.github.com/users/nicolo-ribaudo/followers","following_url":"https://api.github.com/users/nicolo-ribaudo/following{/other_user}","gists_url":"https://api.github.com/users/nicolo-ribaudo/gists{/gist_id}","starred_url":"https://api.github.com/users/nicolo-ribaudo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicolo-ribaudo/subscriptions","organizations_url":"https://api.github.com/users/nicolo-ribaudo/orgs","repos_url":"https://api.github.com/users/nicolo-ribaudo/repos","events_url":"https://api.github.com/users/nicolo-ribaudo/events{/privacy}","received_events_url":"https://api.github.com/users/nicolo-ribaudo/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/babel/babel/issues/11964/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/babel/babel/issues/11964/timeline","performed_via_github_app":null,"state_reason":"completed"}