{"url":"https://api.github.com/repos/babel/babel/issues/12737","repository_url":"https://api.github.com/repos/babel/babel","labels_url":"https://api.github.com/repos/babel/babel/issues/12737/labels{/name}","comments_url":"https://api.github.com/repos/babel/babel/issues/12737/comments","events_url":"https://api.github.com/repos/babel/babel/issues/12737/events","html_url":"https://github.com/babel/babel/issues/12737","id":799394235,"node_id":"MDU6SXNzdWU3OTkzOTQyMzU=","number":12737,"title":"class-property transform leaks new.target in initializer to upper level","user":{"login":"JLHwung","id":3607926,"node_id":"MDQ6VXNlcjM2MDc5MjY=","avatar_url":"https://avatars.githubusercontent.com/u/3607926?v=4","gravatar_id":"","url":"https://api.github.com/users/JLHwung","html_url":"https://github.com/JLHwung","followers_url":"https://api.github.com/users/JLHwung/followers","following_url":"https://api.github.com/users/JLHwung/following{/other_user}","gists_url":"https://api.github.com/users/JLHwung/gists{/gist_id}","starred_url":"https://api.github.com/users/JLHwung/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JLHwung/subscriptions","organizations_url":"https://api.github.com/users/JLHwung/orgs","repos_url":"https://api.github.com/users/JLHwung/repos","events_url":"https://api.github.com/users/JLHwung/events{/privacy}","received_events_url":"https://api.github.com/users/JLHwung/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":438612746,"node_id":"MDU6TGFiZWw0Mzg2MTI3NDY=","url":"https://api.github.com/repos/babel/babel/labels/good%20first%20issue","name":"good first issue","color":"bfdadc","default":true,"description":null},{"id":711596574,"node_id":"MDU6TGFiZWw3MTE1OTY1NzQ=","url":"https://api.github.com/repos/babel/babel/labels/Spec:%20Class%20Fields","name":"Spec: Class Fields","color":"1d76db","default":false,"description":""},{"id":919437103,"node_id":"MDU6TGFiZWw5MTk0MzcxMDM=","url":"https://api.github.com/repos/babel/babel/labels/outdated","name":"outdated","color":"ededed","default":false,"description":"A closed issue/PR that is archived due to age. Recommended to make a new issue"}],"state":"closed","locked":true,"assignee":{"login":"iamfotx","id":20137243,"node_id":"MDQ6VXNlcjIwMTM3MjQz","avatar_url":"https://avatars.githubusercontent.com/u/20137243?v=4","gravatar_id":"","url":"https://api.github.com/users/iamfotx","html_url":"https://github.com/iamfotx","followers_url":"https://api.github.com/users/iamfotx/followers","following_url":"https://api.github.com/users/iamfotx/following{/other_user}","gists_url":"https://api.github.com/users/iamfotx/gists{/gist_id}","starred_url":"https://api.github.com/users/iamfotx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iamfotx/subscriptions","organizations_url":"https://api.github.com/users/iamfotx/orgs","repos_url":"https://api.github.com/users/iamfotx/repos","events_url":"https://api.github.com/users/iamfotx/events{/privacy}","received_events_url":"https://api.github.com/users/iamfotx/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"iamfotx","id":20137243,"node_id":"MDQ6VXNlcjIwMTM3MjQz","avatar_url":"https://avatars.githubusercontent.com/u/20137243?v=4","gravatar_id":"","url":"https://api.github.com/users/iamfotx","html_url":"https://github.com/iamfotx","followers_url":"https://api.github.com/users/iamfotx/followers","following_url":"https://api.github.com/users/iamfotx/following{/other_user}","gists_url":"https://api.github.com/users/iamfotx/gists{/gist_id}","starred_url":"https://api.github.com/users/iamfotx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iamfotx/subscriptions","organizations_url":"https://api.github.com/users/iamfotx/orgs","repos_url":"https://api.github.com/users/iamfotx/repos","events_url":"https://api.github.com/users/iamfotx/events{/privacy}","received_events_url":"https://api.github.com/users/iamfotx/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":5,"created_at":"2021-02-02T15:39:54Z","updated_at":"2021-10-16T04:03:22Z","closed_at":"2021-07-16T19:58:55Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bug Report\r\n\r\n<!-- If you would like to implement a PR, we are more than happy to help you go through the process!-->\r\n- [ ] I would like to work on a fix!\r\n\r\n<!--\r\n@babel/eslint-parser:\r\n  If you are having issues with JSX you might want to check out eslint-plugin-react. If there's an issue with new experimental syntax you might need to check if it's supported by @babel/eslint-plugin.\r\n-->\r\n\r\n**Current behavior**\r\n<!-- A clear and concise description of the behavior. -->\r\n\r\n- [REPL](https://babel.dev/repl#?browsers=IE%206&build=&builtIns=usage&spec=false&loose=false&code_lz=MYGwhgzhAEDC0G8BQ1rAPYDsIBcBOArsDungBQCUiKq0OAFgJYQB0AYuutALxrhTVatXGByNg0AA49omAKYB3FjjB4A5nJw1UAXxp69YEHLw4yZeQrgV2nFpIpA&debug=false&forceAllTransforms=false&shippedProposals=false&circleciRepo=&evaluate=true&fileSize=false&timeTravel=false&sourceType=module&lineWrap=true&presets=stage-3&prettier=false&targets=&version=7.12.12&externalPlugins=)\r\n\r\n`(new C).Foo.p` evaluates to `C`.\r\n\r\n**Input Code**\r\n\r\n```js\r\nclass C {\r\n  constructor() {\r\n    this.Foo = class {\r\n      static p = new.target\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**Expected behavior**\r\n`(new C).Foo.p` should evaluate to `undefined`.\r\n\r\n**Babel Configuration (babel.config.js, .babelrc, package.json#babel, cli command, .eslintrc)**\r\nSee REPL configs\r\n\r\n**Environment**\r\nREPL\r\n\r\n**Possible Solution**\r\nWhen we are converting class properties into `defineProperty` calls that are appended to the `class`, we should replace `new.target` in class field initializers to `undefined` if it is [associated](https://github.com/babel/babel/blob/bab5c62f907b6f90d094531ab22aa0a86d7c35a5/packages/babel-plugin-transform-new-target/src/index.js#L20-L30) to the class scope, otherwise `new.target` is leaked to the upper `new.target` values.\r\n\r\nThe replacing step can be inserted after `super()` is replaced in initializers:\r\n\r\nhttps://github.com/babel/babel/blob/bab5c62f907b6f90d094531ab22aa0a86d7c35a5/packages/babel-helper-create-class-features-plugin/src/fields.js#L684\r\n\r\nMore test examples:\r\n\r\n```js\r\nclass C {\r\n  constructor() {\r\n    this.Foo = class {\r\n      static p1 = class { constructor() { new.target } } // should not replace\r\n      static p2 = new function () { new.target } // should not replace\r\n      static p3 = () => { new.target } // should replace\r\n    }\r\n  }\r\n}\r\n```","closed_by":{"login":"JLHwung","id":3607926,"node_id":"MDQ6VXNlcjM2MDc5MjY=","avatar_url":"https://avatars.githubusercontent.com/u/3607926?v=4","gravatar_id":"","url":"https://api.github.com/users/JLHwung","html_url":"https://github.com/JLHwung","followers_url":"https://api.github.com/users/JLHwung/followers","following_url":"https://api.github.com/users/JLHwung/following{/other_user}","gists_url":"https://api.github.com/users/JLHwung/gists{/gist_id}","starred_url":"https://api.github.com/users/JLHwung/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JLHwung/subscriptions","organizations_url":"https://api.github.com/users/JLHwung/orgs","repos_url":"https://api.github.com/users/JLHwung/repos","events_url":"https://api.github.com/users/JLHwung/events{/privacy}","received_events_url":"https://api.github.com/users/JLHwung/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/babel/babel/issues/12737/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/babel/babel/issues/12737/timeline","performed_via_github_app":null,"state_reason":"completed"}