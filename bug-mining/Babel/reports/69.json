{"url":"https://api.github.com/repos/babel/babel/issues/13953","repository_url":"https://api.github.com/repos/babel/babel","labels_url":"https://api.github.com/repos/babel/babel/issues/13953/labels{/name}","comments_url":"https://api.github.com/repos/babel/babel/issues/13953/comments","events_url":"https://api.github.com/repos/babel/babel/issues/13953/events","html_url":"https://github.com/babel/babel/issues/13953","id":1051253941,"node_id":"I_kwDOAXbCs84-qNy1","number":13953,"title":"[Bug]: DirectiveLiterals seem to \"over-escape\" when generated from a parse","user":{"login":"tolmasky","id":23753,"node_id":"MDQ6VXNlcjIzNzUz","avatar_url":"https://avatars.githubusercontent.com/u/23753?v=4","gravatar_id":"","url":"https://api.github.com/users/tolmasky","html_url":"https://github.com/tolmasky","followers_url":"https://api.github.com/users/tolmasky/followers","following_url":"https://api.github.com/users/tolmasky/following{/other_user}","gists_url":"https://api.github.com/users/tolmasky/gists{/gist_id}","starred_url":"https://api.github.com/users/tolmasky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tolmasky/subscriptions","organizations_url":"https://api.github.com/users/tolmasky/orgs","repos_url":"https://api.github.com/users/tolmasky/repos","events_url":"https://api.github.com/users/tolmasky/events{/privacy}","received_events_url":"https://api.github.com/users/tolmasky/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":560986419,"node_id":"MDU6TGFiZWw1NjA5ODY0MTk=","url":"https://api.github.com/repos/babel/babel/labels/i:%20needs%20triage","name":"i: needs triage","color":"ededed","default":false,"description":null},{"id":919437103,"node_id":"MDU6TGFiZWw5MTk0MzcxMDM=","url":"https://api.github.com/repos/babel/babel/labels/outdated","name":"outdated","color":"ededed","default":false,"description":"A closed issue/PR that is archived due to age. Recommended to make a new issue"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2021-11-11T18:33:10Z","updated_at":"2022-02-13T04:05:41Z","closed_at":"2021-11-14T01:46:16Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### ðŸ’»\r\n\r\n- [ ] Would you like to work on a fix?\r\n\r\n### How are you using Babel?\r\n\r\nProgrammatic API (`babel.transform`, `babel.parse`)\r\n\r\n### Input code\r\n\r\n```javascript\r\nconst { parse } require(\"@babel/parser\");\r\n\r\n[\r\n    parse(`\"\\\\t hi\"`).program.directive[0].value,\r\n    parse(`;\"\\\\t hi\"`).program.body[1].expression.value]\r\n]\r\n```\r\n\r\nOutputs: \r\n```javascript\r\n[\"\\\\t hi\", \"\\t hi\"]\r\n```\r\n\r\n### Configuration file name\r\n\r\n_No response_\r\n\r\n### Configuration\r\n\r\n_No response_\r\n\r\n### Current and expected behavior\r\n\r\nCurrent behavior: this above code outputs `[\"\\\\t hi\", \"\\t hi\"]`\r\nExpected behavior: I would expect it to output `[\"\\t hi\", \"\\t hi\"]`\r\n\r\nPerhaps the spec defines directives to parse differently, but this seems off to me. Especially considering that when doing `DirectiveLiteral(\"\\t hi\")`, then value is \"\\t hi\" (matching the behavior from StringLiterals). As such, this seems to be happening during the parse, and not the AST node creation.\r\n\r\n### Environment\r\n\r\nRunKit Notebook: https://runkit.com/tolmasky/directive-literals-too-many-slashes\r\n\r\n- Node 14.7.6\r\n- @babel/parser v7.16.3\r\n\r\n### Possible solution\r\n\r\nI haven't looked at the code yet, but I imagine doing whatever strings do when they parse. Again, if this is spec defined then happy to retract this bug.\r\n\r\n### Additional context\r\n\r\nWe convert the last directive in the directive prologue into a string literal (by appending a statement manually), since REPLs have the expectation that *something* should be \"returned\" after every line. So, if you type:\r\n\r\n```javascript\r\n\"use strict\";\r\n\"pizza\";\r\n```\r\n\r\nTechnically this code has not expressions, since all the strings count as directives. However, the user would expect to see \"pizza\" returned. This matches eval behavior:\r\n\r\n```javascript\r\neval(`\"use strict\";\r\n\"pizza\";`)\r\n```\r\n\r\nThe above returns \"pizza\".\r\n\r\nAnyways, we do something like the following to accomplish this:\r\n\r\n```javascript\r\nif (program.directives.length > 0)\r\n     program.body = program\r\n        .directives\r\n        .slice(-1)\r\n        .map(({ value }) =>\r\n            t.ExpressionStatement(\r\n                t.StringLiteral(value.value)))\r\n        .concat(body);\r\n```\r\n\r\nUnfortunately, this generated the wrong result if there are any escape sequences. I've looked at trying to use the contents of `extra.raw` and `extra.rawValue`, but those aren't super helpful either, unless you just *re-parse* `extra.raw`, which seems like overkill. `JSON.parse(extra.rawValue)` almost works, but fails on cases like this:\r\n\r\n```javascript\r\n\"abc \\\r\nhi\"\r\n```\r\n\r\n","closed_by":{"login":"JLHwung","id":3607926,"node_id":"MDQ6VXNlcjM2MDc5MjY=","avatar_url":"https://avatars.githubusercontent.com/u/3607926?v=4","gravatar_id":"","url":"https://api.github.com/users/JLHwung","html_url":"https://github.com/JLHwung","followers_url":"https://api.github.com/users/JLHwung/followers","following_url":"https://api.github.com/users/JLHwung/following{/other_user}","gists_url":"https://api.github.com/users/JLHwung/gists{/gist_id}","starred_url":"https://api.github.com/users/JLHwung/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JLHwung/subscriptions","organizations_url":"https://api.github.com/users/JLHwung/orgs","repos_url":"https://api.github.com/users/JLHwung/repos","events_url":"https://api.github.com/users/JLHwung/events{/privacy}","received_events_url":"https://api.github.com/users/JLHwung/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/babel/babel/issues/13953/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/babel/babel/issues/13953/timeline","performed_via_github_app":null,"state_reason":"completed"}