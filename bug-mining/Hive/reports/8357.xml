<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:23:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-26576] Alter table calls on Iceberg tables can inadvertently change metadata_location</title>
                <link>https://issues.apache.org/jira/browse/HIVE-26576</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Concurrent alter_table calls can interfere and can cause the metadata_location property of an Iceberg table to be messed up.&lt;/p&gt;

&lt;p&gt;Basically there&apos;s no table level locking for Iceberg tables in Hive during the usual operations, and thus some extra performance related features are available, like concurrent inserts, as opposed to native Hive tables. This was done under the assumption that the optimistic locking pattern that is used in HiveTableOperations protects changing the metadata_location by the use of an HMS table lock there only.&lt;/p&gt;

&lt;p&gt;This is fine until some other alter_table calls get into the system such as one from StatTask or DDLTask. Such tasks perform their work as:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;get the current table&lt;/li&gt;
	&lt;li&gt;do the alteration&lt;/li&gt;
	&lt;li&gt;send the changes via alter_table call to HMS&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In between the retrieval of the table and the alter_table call a legit commit from HiveTableOperations might bump the metadata_location, but this will get reverted as these tasks consider an outdated metadata_location (and the alter table call will overwrite all table props including this one too..)&lt;/p&gt;

&lt;p&gt;This is a design issue, and to solve this while preserving the concurrency features I propose to make use of HiveIcebergMetaHook where all such alter_table calls are intercepted, and the same locking mechanism could be used there as the one found in HiveTableOperations. The proposed flow on HMS client side would be:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hook: preAlterTable
	&lt;ul&gt;
		&lt;li&gt;request table level lock&lt;/li&gt;
		&lt;li&gt;refresh the Iceberg table from catalog (HMS) to see if new updates have arrived&lt;/li&gt;
		&lt;li&gt;compare the current metadata with the one thought to be the base of this request, if metadata_location is outdated overwrite it with the fresh, current one in this request&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;do the alter_table call to HMS with the relevant changes (updated stats or other properties)&lt;/li&gt;
	&lt;li&gt;hook: post/rollbackAlterTable
	&lt;ul&gt;
		&lt;li&gt;release table level lock&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This can work as the metadata_location should never be changed by anything other than HiveTableOperations, which is the only thing not using this hook (if it did we&apos;d be in an endless loop). There&apos;s actually one exception which is if a user wants to change the metadata_location by hand. I can make an exception to that signalling this fact from an environmentContext instance when the corresponding AlterTableSetPropertiesDesc is constructed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13483815">HIVE-26576</key>
            <summary>Alter table calls on Iceberg tables can inadvertently change metadata_location</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="szita">&#193;d&#225;m Szita</assignee>
                                    <reporter username="szita">&#193;d&#225;m Szita</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 29 Sep 2022 11:20:24 +0000</created>
                <updated>Wed, 16 Nov 2022 13:50:36 +0000</updated>
                            <resolved>Sun, 2 Oct 2022 16:51:45 +0000</resolved>
                                                    <fixVersion>4.0.0-alpha-2</fixVersion>
                                    <component>Iceberg integration</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4200">1h 10m</timespent>
                                <comments>
                            <comment id="17612138" author="szita" created="Sun, 2 Oct 2022 16:51:45 +0000"  >&lt;p&gt;Merged to master. Thanks for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ayushtkn&quot; class=&quot;user-hover&quot; rel=&quot;ayushtkn&quot;&gt;ayushtkn&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17621928" author="zabetak" created="Fri, 21 Oct 2022 07:45:28 +0000"  >&lt;p&gt;The ticket is marked as resolved for 4.0.0 but we are currently underway of releasing 4.0.0-alpha-2 so I changed the fixVersion accordingly; If that is not accurate please update the fixVersion accordingly.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 3 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z18y20:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>