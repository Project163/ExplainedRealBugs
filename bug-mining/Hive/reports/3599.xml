<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:34:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-11023] Disable directSQL if datanucleus.identifierFactory = datanucleus2</title>
                <link>https://issues.apache.org/jira/browse/HIVE-11023</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;We hit an interesting bug in a case where datanucleus.identifierFactory = datanucleus2 .&lt;/p&gt;

&lt;p&gt;The problem is that directSql handgenerates SQL strings assuming &quot;datanucleus1&quot; naming scheme. If a user has their metastore JDO managed by datanucleus.identifierFactory = datanucleus2 , the SQL strings we generate are incorrect.&lt;/p&gt;

&lt;p&gt;One simple example of what this results in is the following: whenever DN persists a field which is held as a List&amp;lt;T&amp;gt;, it winds up storing each T as a separate line in the appropriate mapping table, and has a column called INTEGER_IDX, which holds the position in the list. Then, upon reading, it automatically reads all relevant lines with an ORDER BY INTEGER_IDX, which results in the list retaining its order. In DN2 naming scheme, the column is called IDX, instead of INTEGER_IDX. If the user has run appropriate metatool upgrade scripts, it is highly likely that they have both columns, INTEGER_IDX and IDX.&lt;/p&gt;

&lt;p&gt;Whenever they use JDO, such as with all writes, it will then use the IDX field, and when they do any sort of optimized reads, such as through directSQL, it will ORDER BY INTEGER_IDX.&lt;/p&gt;

&lt;p&gt;An immediate danger is seen when we consider that the schema of a table is stored as a List&amp;lt;FieldSchema&amp;gt; , and while IDX has 0,1,2,3,... , INTEGER_IDX will contain 0,0,0,0,... and thus, any attempt to describe the table or fetch schema for the table can come up mixed up in the table&apos;s native hashing order, rather than sorted by the index.&lt;/p&gt;

&lt;p&gt;This can then result in schema ordering being different from the actual table. For eg:, if a user has a (a:int,b:string,c:string), a describe on this may return (c:string, a:int, b: string), and thus, queries which are inserting after selecting from another table can have ClassCastExceptions when trying to insert data in the wong order - this is how we discovered this bug. This problem, however, can be far worse, if there are no type problems - it is possible, for eg., that if a,b&amp;amp;c were all strings, that that insert query would succeed but mix up the order, which then results in user table data being mixed up. This has the potential to be very bad.&lt;/p&gt;

&lt;p&gt;We should write a tool to help convert metastores that use &quot;datanucleus2&quot; to &quot;datanucleus1&quot;(more difficult, needs more one-time testing) or change directSql to support both(easier to code, but increases test-coverage matrix significantly and we should really then be testing against both schemes). But in the short term, we should disable directSql if we see that the identifierfactory is &quot;datanucleus2&quot;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12838213">HIVE-11023</key>
            <summary>Disable directSQL if datanucleus.identifierFactory = datanucleus2</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sushanth">Sushanth Sowmyan</assignee>
                                    <reporter username="sushanth">Sushanth Sowmyan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Jun 2015 16:26:59 +0000</created>
                <updated>Fri, 19 Jun 2015 03:24:15 +0000</updated>
                            <resolved>Wed, 17 Jun 2015 23:44:10 +0000</resolved>
                                    <version>1.2.1</version>
                    <version>1.3.0</version>
                    <version>2.0.0</version>
                                    <fixVersion>1.2.1</fixVersion>
                                    <component>Metastore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14588641" author="hiveqa" created="Tue, 16 Jun 2015 19:44:42 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12739893/HIVE-11023.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12739893/HIVE-11023.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 1 failed/errored test(s), 9008 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hive.hcatalog.streaming.TestStreaming.testTransactionBatchEmptyCommit
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4274/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4274/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4274/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4274/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-4274/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-4274/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 1 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12739893 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14589182" author="sushanth" created="Wed, 17 Jun 2015 02:06:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt;, could you please review? Thanks!&lt;/p&gt;</comment>
                            <comment id="14590806" author="ashutoshc" created="Wed, 17 Jun 2015 23:05:01 +0000"  >&lt;p&gt;+1 Longer term I liked your first suggestion of converting data in RDBMS from DN2 to DN1.&lt;/p&gt;</comment>
                            <comment id="14590830" author="sushanth" created="Wed, 17 Jun 2015 23:19:30 +0000"  >&lt;p&gt;Thanks, Ashutosh. Yup, I intend to file a new jira to enable that.&lt;/p&gt;</comment>
                            <comment id="14590860" author="sushanth" created="Wed, 17 Jun 2015 23:38:56 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-11039&quot; title=&quot;Write a tool to allow people with datanucelus.identifierFactory=datanucleus2 to migrate their metastore to datanucleus1 naming&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-11039&quot;&gt;HIVE-11039&lt;/a&gt; to help convert DN2 to DN1 naming scheme.&lt;/p&gt;</comment>
                            <comment id="14590866" author="sushanth" created="Wed, 17 Jun 2015 23:44:10 +0000"  >&lt;p&gt;Committed to branch-1.2, branch-1 and master.&lt;/p&gt;

&lt;p&gt;Thanks, Ashutosh!&lt;/p&gt;</comment>
                            <comment id="14592184" author="xuefuz" created="Thu, 18 Jun 2015 17:44:17 +0000"  >&lt;p&gt;qq, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sushanth&quot; class=&quot;user-hover&quot; rel=&quot;sushanth&quot;&gt;sushanth&lt;/a&gt;, does this happen to previous releases as well?&lt;/p&gt;</comment>
                            <comment id="14592540" author="sushanth" created="Thu, 18 Jun 2015 21:28:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt; : Yes, this will happen to all releases with directSql - which means anything past 0.12, I think. That said, the number of installations that override this parameter should hopefully be minimal.&lt;/p&gt;

&lt;p&gt;If people are using datanucleus2 as their identifierFactory version, then:&lt;br/&gt;
a) They should disable directSql (can be done by conf parameter, does not need this code fix - the code fix simply automates that for current and future releases)&lt;br/&gt;
b) They should retain that identifierFactory - a mixed metastore with both is bad.&lt;br/&gt;
c) Once we have a way of migrating them, as with &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-11039&quot; title=&quot;Write a tool to allow people with datanucelus.identifierFactory=datanucleus2 to migrate their metastore to datanucleus1 naming&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-11039&quot;&gt;HIVE-11039&lt;/a&gt; filed, we should migrate them out of it.&lt;/p&gt;

&lt;p&gt;This parameter should never have been a part of hive-site.xml, I think, since it&apos;s dangerous if a user changes it. A &quot;datanucleus1&quot; installation changing the parameter to &quot;datanucleus2&quot; or vice-versa can result in metadata corruption for us.&lt;/p&gt;</comment>
                            <comment id="14592608" author="xuefuz" created="Thu, 18 Jun 2015 21:57:37 +0000"  >&lt;p&gt;Makes sense. Thanks for the explanation.&lt;/p&gt;</comment>
                            <comment id="14592953" author="lefty@hortonworks.com" created="Fri, 19 Jun 2015 03:24:15 +0000"  >&lt;p&gt;Should this be documented in the wiki?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="12838616">HIVE-11039</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12739893" name="HIVE-11023.patch" size="1544" author="sushanth" created="Tue, 16 Jun 2015 16:32:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2g40n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>