<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:56:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-17344] LocalCache element memory usage is not calculated properly.</title>
                <link>https://issues.apache.org/jira/browse/HIVE-17344</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Orc footer cache has a calculation of memory usage:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; getMemoryUsage() {
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; bb.remaining() + 100; &lt;span class=&quot;code-comment&quot;&gt;// 100 is &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 2 longs, BB and java overheads (semi-arbitrary).
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ByteBuffer.remaining returns the remaining space in the bytebuffer, thus allowing this cache have elements MAXWEIGHT/100 of arbitrary size. I think the correct solution would be bb.capacity.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13095306">HIVE-17344</key>
            <summary>LocalCache element memory usage is not calculated properly.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gubjanos">Janos Gub</assignee>
                                    <reporter username="gubjanos">Janos Gub</reporter>
                        <labels>
                    </labels>
                <created>Thu, 17 Aug 2017 11:00:38 +0000</created>
                <updated>Tue, 22 May 2018 23:58:27 +0000</updated>
                            <resolved>Mon, 11 Sep 2017 07:38:35 +0000</resolved>
                                                    <fixVersion>3.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16130285" author="kgyrtkirk" created="Thu, 17 Aug 2017 11:34:15 +0000"  >&lt;p&gt;+1 pending tests&lt;/p&gt;</comment>
                            <comment id="16130380" author="hiveqa" created="Thu, 17 Aug 2017 13:23:37 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12882323/HIVE-17344.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12882323/HIVE-17344.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 10 failed/errored test(s), 10977 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[smb_mapjoin_1] (batchId=240)
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[smb_mapjoin_7] (batchId=240)
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[spark_dynamic_partition_pruning] (batchId=169)
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[spark_dynamic_partition_pruning_mapjoin_only] (batchId=170)
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[spark_vectorized_dynamic_partition_pruning] (batchId=169)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=235)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query23] (batchId=235)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionRegistrationWithCustomSchema (batchId=180)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionSpecRegistrationWithCustomSchema (batchId=180)
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation (batchId=180)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/6436/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/6436/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/6436/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/6436/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-6436/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-6436/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 10 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12882323 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="16131171" author="sershe" created="Thu, 17 Aug 2017 19:34:52 +0000"  >&lt;p&gt;How are those bbs allocated? &lt;/p&gt;</comment>
                            <comment id="16133458" author="sershe" created="Fri, 18 Aug 2017 18:52:29 +0000"  >&lt;p&gt;I don&apos;t think there&apos;s actually a bug since everywhere this buffer is passed in it&apos;s either allocated exactly to size, or read from disk the same way. Reads duplicate it so remaining will not change.&lt;br/&gt;
Looking at capacity is not correct in all cases either, e.g. if someone were to cache multiple slices of the same large buffer, like LLAP allocator does in other places, it would be accounted for multiple times. So, I dunno if this change is needed. Perhaps instead at caching time it should check capacity and remaining are the same.&lt;/p&gt;</comment>
                            <comment id="16134858" author="gubjanos" created="Mon, 21 Aug 2017 08:19:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;it&apos;s either allocated exactly to size&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If it is allocated to size, then the bb.remaining will be 0 right?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;read from disk the same way&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Then here it is 0 also?&lt;/p&gt;

&lt;p&gt;The weigher in LocalCache sums up the getMemoryUsage of the TailAndFileData.&lt;br/&gt;
If the remaining size is ALWAYS 0, how &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-16133&quot; title=&quot;Footer cache in Tez AM can take too much memory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-16133&quot;&gt;&lt;del&gt;HIVE-16133&lt;/del&gt;&lt;/a&gt; is limiting the maximum size of the cache? (Or how is it different from setting the maxsize of the cache to limit the number of elements in it)&lt;br/&gt;
Isn&apos;t &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-16133&quot; title=&quot;Footer cache in Tez AM can take too much memory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-16133&quot;&gt;&lt;del&gt;HIVE-16133&lt;/del&gt;&lt;/a&gt; about restricting the total memory usage of cache?&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hagleitn&quot; class=&quot;user-hover&quot; rel=&quot;hagleitn&quot;&gt;hagleitn&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16135008" author="kgyrtkirk" created="Mon, 21 Aug 2017 10:36:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt; I think it is currently true that remaining == capacity...but the underlying OrcTail resets the position to 0 when it reads explicitly...so if the bb position is not at the beginning remainig() would could underestimate the memory usage...so I think using capacity would be better...because in that case it may only overestimate memory usage...and not under (but there is the case when someone uses windows...)&lt;/p&gt;

&lt;p&gt;I haven&apos;t seen any references where a bigger bb was sliced and passed to this function...if that happens...the capacity of the sliced bb is the old limit...which is ok...&lt;/p&gt;

&lt;p&gt;I agree that currently capacity/remaining will do the same...but capacity would be more explicit&lt;/p&gt;</comment>
                            <comment id="16135009" author="gubjanos" created="Mon, 21 Aug 2017 10:36:45 +0000"  >&lt;p&gt;Sorry my bad. So when bytebuffers sliced position and limit will be set in a way that remaining returns the size of the slice. If there are overlapped slices it will be counted twice, but capacity would not help in this case neither.&lt;/p&gt;</comment>
                            <comment id="16138924" author="sershe" created="Wed, 23 Aug 2017 19:27:34 +0000"  >&lt;p&gt;Yeah sorry it&apos;s allocated and reset to 0 or read the same way, so remaining == capacity. Then, it&apos;s duplicated (not copied) on read, so the original buffer never changes.&lt;br/&gt;
Can you add a check with an error that this is the case, we don&apos;t want to cache buffers with spurious extra space. Other than that +1&lt;/p&gt;</comment>
                            <comment id="16158381" author="gubjanos" created="Fri, 8 Sep 2017 09:28:42 +0000"  >&lt;p&gt;Attaching patch reflecting to Sergey&apos;s comments.&lt;/p&gt;</comment>
                            <comment id="16159020" author="sershe" created="Fri, 8 Sep 2017 18:00:52 +0000"  >&lt;p&gt;+1 pending tests&lt;/p&gt;</comment>
                            <comment id="16159097" author="hiveqa" created="Fri, 8 Sep 2017 18:48:26 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12886027/HIVE-17344.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12886027/HIVE-17344.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 6 failed/errored test(s), 11032 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestAccumuloCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=230)
TestDummy - did not produce a TEST-*.xml file (likely timed out) (batchId=230)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[auto_sortmerge_join_2] (batchId=47)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_values_orig_table_use_metadata] (batchId=61)
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[bucketizedhiveinputformat] (batchId=170)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=234)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/6733/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/6733/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/6733/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/6733/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-6733/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-6733/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 6 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12886027 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="16160844" author="kgyrtkirk" created="Mon, 11 Sep 2017 07:38:35 +0000"  >&lt;p&gt;pushed to master, Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gubjanos&quot; class=&quot;user-hover&quot; rel=&quot;gubjanos&quot;&gt;gubjanos&lt;/a&gt; for taking care of this and Sergey for reviewing it!&lt;/p&gt;</comment>
                            <comment id="16169524" author="lefty@hortonworks.com" created="Mon, 18 Sep 2017 02:40:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kgyrtkirk&quot; class=&quot;user-hover&quot; rel=&quot;kgyrtkirk&quot;&gt;kgyrtkirk&lt;/a&gt;, please add fix version 3.0.0 to this issue.  Thanks.&lt;/p&gt;</comment>
                            <comment id="16170212" author="kgyrtkirk" created="Mon, 18 Sep 2017 16:02:23 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=leftylev&quot; class=&quot;user-hover&quot; rel=&quot;leftylev&quot;&gt;leftylev&lt;/a&gt;, I&apos;ve just corrected it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16485959" author="vgarg" created="Tue, 22 May 2018 23:58:27 +0000"  >&lt;p&gt;Hive 3.0.0 has been released so closing this jira.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12886027" name="HIVE-17344.2.patch" size="1261" author="gubjanos" created="Fri, 8 Sep 2017 09:26:33 +0000"/>
                            <attachment id="12882323" name="HIVE-17344.patch" size="682" author="gubjanos" created="Thu, 17 Aug 2017 11:05:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3iwen:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>