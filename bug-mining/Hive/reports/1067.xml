<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:03:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-3826] Rollbacks and retries of drops cause org.datanucleus.exceptions.NucleusObjectNotFoundException: No such database row)</title>
                <link>https://issues.apache.org/jira/browse/HIVE-3826</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;I&apos;m not sure if this is the only cause of the exception &quot;org.datanucleus.exceptions.NucleusObjectNotFoundException: No such database row)&quot; from the metastore, but one cause seems to be related to a drop command failing, and being retried by the client.&lt;/p&gt;

&lt;p&gt;Based on focusing on a single thread in the metastore with DEBUG level logging, I was seeing the objects that were intended to be dropped remaining in the PersistenceManager cache even after a rollback.  The steps seemed to be as follows:&lt;/p&gt;

&lt;p&gt;1) First attempt to drop the table, the table is pulled into the PersistenceManager cache for the purposes of dropping&lt;br/&gt;
2) The drop fails, e.g. due to a lock wait timeout on the SQL backend, this causes a rollback of the transaction&lt;br/&gt;
3) The drop is retried using a different thread on the metastore Thrift server or a different server and succeeds&lt;br/&gt;
4) Back on the original thread of the original Thrift server someone tries to perform some write operation which produces a commit.  This causes those detached objects related to the dropped table to attempt to reattach, causing JDO to query the SQL backend for those objects which it can&apos;t find.  This causes the exception.&lt;/p&gt;

&lt;p&gt;I was able to reproduce this regularly using the following sequence of commands:&lt;br/&gt;
Hive client 1 (Hive1): connected to a metastore Thrift server running a single thread, I hard coded a RuntimeException into the code to drop a table in the ObjectStore, specifically right before the commit in preDropStorageDescriptor, to induce a rollback.  I also turned off all retries at all layers of the metastore.&lt;br/&gt;
Hive client 2 (Hive2): connected to a separate metastore Thrift server running with standard configs and code&lt;/p&gt;

&lt;p&gt;1: On Hive1, CREATE TABLE t1 (c STRING);&lt;br/&gt;
2: On Hive1, DROP TABLE t1; // This failed due to the hard coded exception&lt;br/&gt;
3: On Hive2, DROP TABLE t1; // Succeeds&lt;br/&gt;
4: On Hive1, CREATE DATABASE d1; // This database already existed, I&apos;m not sure why this was necessary, but it didn&apos;t work without it, it seemed to have an affect on the order objects were committed in the next step&lt;br/&gt;
5: On Hive1, CREATE DATABASE d2; // This database didn&apos;t exist, it would fail with the NucleusObjectNotFoundException&lt;/p&gt;

&lt;p&gt;The object that would cause the exception varied, I saw the MTable, the MSerDeInfo, and MTablePrivilege from the table that attempted to be dropped.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12624899">HIVE-3826</key>
            <summary>Rollbacks and retries of drops cause org.datanucleus.exceptions.NucleusObjectNotFoundException: No such database row)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kevinwilfong">Kevin Wilfong</assignee>
                                    <reporter username="kevinwilfong">Kevin Wilfong</reporter>
                        <labels>
                    </labels>
                <created>Thu, 20 Dec 2012 21:39:33 +0000</created>
                <updated>Thu, 16 May 2013 21:10:33 +0000</updated>
                            <resolved>Sat, 22 Dec 2012 06:30:50 +0000</resolved>
                                    <version>0.11.0</version>
                                    <fixVersion>0.11.0</fixVersion>
                                    <component>Metastore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13537407" author="kevinwilfong" created="Thu, 20 Dec 2012 21:45:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://reviews.facebook.net/D7539&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.facebook.net/D7539&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13537534" author="kevinwilfong" created="Fri, 21 Dec 2012 00:10:51 +0000"  >&lt;p&gt;The tests pass.&lt;/p&gt;</comment>
                            <comment id="13538660" author="namit" created="Sat, 22 Dec 2012 04:08:13 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;Great catch - running tests.&lt;/p&gt;</comment>
                            <comment id="13538686" author="namit" created="Sat, 22 Dec 2012 06:30:50 +0000"  >&lt;p&gt;Committed. Thanks Kevin&lt;/p&gt;</comment>
                            <comment id="13538819" author="hudson" created="Sat, 22 Dec 2012 14:16:31 +0000"  >&lt;p&gt;Integrated in Hive-trunk-h0.21 #1871 (See &lt;a href=&quot;https://builds.apache.org/job/Hive-trunk-h0.21/1871/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hive-trunk-h0.21/1871/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-3826&quot; title=&quot;Rollbacks and retries of drops cause org.datanucleus.exceptions.NucleusObjectNotFoundException: No such database row)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-3826&quot;&gt;&lt;del&gt;HIVE-3826&lt;/del&gt;&lt;/a&gt; Rollbacks and retries of drops cause &lt;br/&gt;
org.datanucleus.exceptions.NucleusObjectNotFoundException: No such database row)&lt;br/&gt;
(Kevin Wilfong via namit) (Revision 1425247)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
namit : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1425247&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1425247&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hive/trunk/metastore/src/java/org/apache/hadoop/hive/metastore/ObjectStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13547920" author="hudson" created="Wed, 9 Jan 2013 10:23:35 +0000"  >&lt;p&gt;Integrated in Hive-trunk-hadoop2 #54 (See &lt;a href=&quot;https://builds.apache.org/job/Hive-trunk-hadoop2/54/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hive-trunk-hadoop2/54/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-3826&quot; title=&quot;Rollbacks and retries of drops cause org.datanucleus.exceptions.NucleusObjectNotFoundException: No such database row)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-3826&quot;&gt;&lt;del&gt;HIVE-3826&lt;/del&gt;&lt;/a&gt; Rollbacks and retries of drops cause &lt;br/&gt;
org.datanucleus.exceptions.NucleusObjectNotFoundException: No such database row)&lt;br/&gt;
(Kevin Wilfong via namit) (Revision 1425247)&lt;/p&gt;

&lt;p&gt;     Result = ABORTED&lt;br/&gt;
namit : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1425247&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1425247&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hive/trunk/metastore/src/java/org/apache/hadoop/hive/metastore/ObjectStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12561989" name="HIVE-3826.1.patch.txt" size="715" author="kevinwilfong" created="Thu, 20 Dec 2012 21:45:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>301413</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 46 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16sg7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>247741</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>