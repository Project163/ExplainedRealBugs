<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:24:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-27695] Intermittent OOM when running TestMiniTezCliDriver</title>
                <link>https://issues.apache.org/jira/browse/HIVE-27695</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Running all the tests under TestMiniTezCliDriver very frequently (but still intermittently) leads to OutOfMemory errors.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cd itests/qtest &amp;amp;&amp;amp; mvn test -Dtest=TestMiniTezCliDriver
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I set &lt;tt&gt;-XX:+HeapDumpOnOutOfMemoryError&lt;/tt&gt; and the respective heapdumps are attached to this ticket.&lt;/p&gt;

&lt;p&gt;The OOM is thrown from the application master and a quick inspection of the dumps shows that it comes mainly from the accumulation of Configuration objects (~1MB each) by various classes.&lt;/p&gt;

&lt;p&gt;The max heap size for application master is pretty low (~100MB) so it is quite easy to reach. The heap size is explicitly very low for testing purposes but maybe we should re-evaluate the current configurations for the tests.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13550867">HIVE-27695</key>
            <summary>Intermittent OOM when running TestMiniTezCliDriver</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zabetak">Stamatis Zampetakis</assignee>
                                    <reporter username="zabetak">Stamatis Zampetakis</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 15 Sep 2023 15:43:53 +0000</created>
                <updated>Fri, 29 Mar 2024 17:49:54 +0000</updated>
                            <resolved>Mon, 16 Oct 2023 08:17:55 +0000</resolved>
                                    <version>4.0.0-beta-1</version>
                                    <fixVersion>4.0.0</fixVersion>
                                    <component>Test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17767538" author="abstractdog" created="Thu, 21 Sep 2023 12:32:57 +0000"  >&lt;p&gt;can you please clarify how did you get the heapdump? it could be used in the scope of &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-27719&quot; title=&quot;Save heapdump in case of OOM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-27719&quot;&gt;HIVE-27719&lt;/a&gt; with minimal or no modification&lt;/p&gt;</comment>
                            <comment id="17767548" author="zabetak" created="Thu, 21 Sep 2023 12:51:16 +0000"  >&lt;p&gt;To obtain the heapdump from the TestMiniTezCliDriver I modified the following properties in &quot;data/conf/tez/hive-site.xml&quot; file as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;property&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;name&amp;gt;&lt;/span&gt;hive.tez.java.opts&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/name&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;value&amp;gt;&lt;/span&gt; -Dlog4j.configurationFile=tez-container-log4j2.properties -Dtez.container.log.level=INFO -Dtez.container.root.logger=CLA -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/home/stamatis/Issues/tez_union_oom/child&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/value&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/property&amp;gt;&lt;/span&gt;

&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;property&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;name&amp;gt;&lt;/span&gt;tez.am.launch.cmd-opts&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/name&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;value&amp;gt;&lt;/span&gt; -Dlog4j.configurationFile=tez-container-log4j2.properties -Dtez.container.log.level=INFO -Dtez.container.root.logger=CLA -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/home/stamatis/Issues/tez_union_oom/am&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/value&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/property&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17769958" author="zabetak" created="Thu, 28 Sep 2023 09:17:10 +0000"  >&lt;p&gt;More failed runs due to OOM in TezCliDriver:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;http://ci.hive.apache.org/job/hive-precommit/job/PR-4750/3/testReport/junit/org.apache.hadoop.hive.cli/TestMiniTezCliDriver/Testing___split_19___PostProcess___testCliDriver_flatten_union_subdir_/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ci.hive.apache.org/job/hive-precommit/job/PR-4750/3/testReport/junit/org.apache.hadoop.hive.cli/TestMiniTezCliDriver/Testing___split_19___PostProcess___testCliDriver_flatten_union_subdir_/&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://ci.hive.apache.org/job/hive-precommit/job/PR-4754/1/testReport/junit/org.apache.hadoop.hive.cli/TestMiniTezCliDriver/Testing___split_19___PostProcess___testCliDriver_tez_union_with_udf_/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ci.hive.apache.org/job/hive-precommit/job/PR-4754/1/testReport/junit/org.apache.hadoop.hive.cli/TestMiniTezCliDriver/Testing___split_19___PostProcess___testCliDriver_tez_union_with_udf_/&lt;/a&gt;&#160;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17773984" author="zabetak" created="Wed, 11 Oct 2023 10:04:16 +0000"  >&lt;p&gt;The OOM raised from the AM shows that GC is consuming almost the entire CPU time trying to free up some memory unsuccessfully. The problem also shows up in CPU flamegraphs obtained via async-profiler and it is also present when enabling gc verbose logs. In the GC logs, we can clearly see that there are many &quot;Full GC&quot; cycles that are not really freeing up any memory.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.lang.OutOfMemoryError: GC overhead limit exceeded
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The heap dump shows that a big amount of memory is occupied by configurations objects:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;org.apache.hadoop.conf.Configuration occupy (32% of the heap)&lt;/li&gt;
	&lt;li&gt;org.apache.hadoop.mapred.JobConf (17% of the heap)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The biggest configuration objects retain roughly ~1MB of memory and these are used extensively in the application. By analyzing the heapdump we can observe that each HeldContainer holds around 10 configuration objects (among other things) so we can roughly estimate that each container requires 10MB of heap memory in the application master.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Class Name                                                                | Objects | Referenced Objects | Ref. Shallow Heap
-----------------------------------------------------------------------------------------------------------------------------
org.apache.tez.dag.app.rm.YarnTaskSchedulerService$DelayedContainerManager|       1 |                 40 |             1,920
&apos;- java.util.concurrent.PriorityBlockingQueue                             |       1 |                 30 |             1,440
   &apos;- java.lang.Object[]                                                  |       1 |                 30 |             1,440
      &apos;- org.apache.tez.dag.app.rm.YarnTaskSchedulerService$HeldContainer |       3 |                 30 |             1,440
         &apos;- org.apache.tez.dag.app.ContainerContext                       |       3 |                 30 |             1,440
            &apos;- org.apache.tez.dag.app.dag.impl.VertexImpl                 |       3 |                 30 |             1,440
               |- org.apache.tez.dag.app.dag.impl.DAGImpl                 |       2 |                 16 |               768
               |- java.util.HashMap                                       |       2 |                  6 |               288
               |- org.apache.hadoop.conf.Configuration                    |       5 |                  5 |               240
               &apos;- org.apache.tez.dag.app.dag.impl.VertexManager           |       3 |                  3 |               144
-----------------------------------------------------------------------------------------------------------------------------
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the heap dump we can see four containers held by the AM so this can easily mean ~40MB of constant memory consumption. Depending on the environment we can have more Tez containers up and running  which further increases the memory demands of the AM.&lt;/p&gt;

&lt;p&gt;All the elements that were used in the analysis above are attached inside the  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13063480/13063480_dag_am_debug_bundles.tar.xz&quot; title=&quot;dag_am_debug_bundles.tar.xz attached to HIVE-27695&quot;&gt;dag_am_debug_bundles.tar.xz&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; file. Notably, the heap dump from the OOM, the gclogs and allocation profiling for the misbehaving AM can be found under dag_am_128xmx_oom directory.&lt;/p&gt;

&lt;p&gt;In order to avoid the OOM we can do one of the following:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;limit container reuse and thus reduce the number of active containers tracked by the AM (tez.am.container.reuse.enabled=false)&lt;/li&gt;
	&lt;li&gt;increase the maximun heap space (xmx) for the AM to alleviate the GC pressure due to the number of active containers (tez.am.resource.memory.mb=256/512)&lt;/li&gt;
	&lt;li&gt;limit the maximum number of containers by tuning the appropriate Yarn properties&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;ve tested two out of three from the above options monitoring GC activity, CPU usage, and total test execution time and the best option is to bump the maximun heap for the AM to 512MB; using this heap size GC activity remains pretty low, tests run in 8:13 minutes, and obviously there is no OOM. &lt;/p&gt;

&lt;p&gt;Bumping up the heap to 256 works also pretty well although tests are slightly slower (vs. 512MB) taking ~8:27 minutes. &lt;/p&gt;

&lt;p&gt;Disabling the container reuse while keeping the max heap constant at 128MB also solves the OOM but the duration of the tests is very long (~42 minutes) due to the overhead introduced by creating new containers all the time.&lt;/p&gt;

&lt;p&gt;The gclogs as well as the CPU profiling from the three solutions outlined above are also present inside the dag_am_debug_bundles.tar.gz file.  &lt;/p&gt;</comment>
                            <comment id="17775589" author="zabetak" created="Mon, 16 Oct 2023 08:17:55 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/hive/commit/c126422a91be695c75ec4a750638a0aa4d1ba6cd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/commit/c126422a91be695c75ec4a750638a0aa4d1ba6cd&lt;/a&gt;. Thanks for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ayushsaxena&quot; class=&quot;user-hover&quot; rel=&quot;ayushsaxena&quot;&gt;ayushsaxena&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="13559887">HIVE-27916</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13530255">HIVE-27182</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13551514">HIVE-27719</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13551513">HIVE-27718</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13511076">HIVE-26828</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13510780">HIVE-26820</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13062951" name="am_heap_dumps.tar.xz" size="38202928" author="zabetak" created="Fri, 15 Sep 2023 15:48:51 +0000"/>
                            <attachment id="13063480" name="dag_am_debug_bundles.tar.xz" size="18204236" author="zabetak" created="Wed, 11 Oct 2023 10:03:46 +0000"/>
                            <attachment id="13062952" name="leak_suspect_1.png" size="190937" author="zabetak" created="Fri, 15 Sep 2023 15:50:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 4 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ke3s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>