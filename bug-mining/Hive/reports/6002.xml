<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:58:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-17853] RetryingMetaStoreClient loses UGI impersonation-context when reconnecting after timeout</title>
                <link>https://issues.apache.org/jira/browse/HIVE-17853</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;The &lt;tt&gt;RetryingMetaStoreClient&lt;/tt&gt; is used to automatically reconnect to the Hive metastore, after client timeout, transparently to the user.&lt;/p&gt;

&lt;p&gt;In case of user impersonation (e.g. Oozie super-user &lt;tt&gt;oozie&lt;/tt&gt; impersonating a Hadoop user &lt;tt&gt;mithun&lt;/tt&gt;, to run a workflow), in case of timeout, we find that the reconnect causes the &lt;tt&gt;UGI.doAs()&lt;/tt&gt; context to be lost. Any further metastore operations will be attempted as the login-user (&lt;tt&gt;oozie&lt;/tt&gt;), as opposed to the effective user (&lt;tt&gt;mithun&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;We should have a fix for this shortly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13110820">HIVE-17853</key>
            <summary>RetryingMetaStoreClient loses UGI impersonation-context when reconnecting after timeout</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cdrome">Chris Drome</assignee>
                                    <reporter username="mithun">Mithun Radhakrishnan</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Oct 2017 22:15:04 +0000</created>
                <updated>Tue, 22 May 2018 23:16:38 +0000</updated>
                            <resolved>Fri, 1 Dec 2017 21:58:54 +0000</resolved>
                                    <version>2.2.1</version>
                    <version>2.4.0</version>
                    <version>3.0.0</version>
                                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Metastore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16226624" author="hiveqa" created="Tue, 31 Oct 2017 11:09:57 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12894882/HIVE-17853.01.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12894882/HIVE-17853.01.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 8 failed/errored test(s), 11342 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_values_orig_table_use_metadata] (batchId=62)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[unionDistinct_1] (batchId=145)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[llap_acid_fast] (batchId=156)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[sysdb] (batchId=155)
org.apache.hadoop.hive.cli.TestNegativeMinimrCliDriver.testCliDriver[ct_noperm_loc] (batchId=93)
org.apache.hadoop.hive.cli.control.TestDanglingQOuts.checkDanglingQOut (batchId=205)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testConstraints (batchId=222)
org.apache.hive.jdbc.TestTriggersTezSessionPoolManager.testTriggerHighShuffleBytes (batchId=229)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/7572/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/7572/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/7572/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/7572/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-7572/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-7572/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 8 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12894882 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="16227126" author="vihangk1" created="Tue, 31 Oct 2017 17:13:16 +0000"  >&lt;p&gt;Thanks for the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cdrome&quot; class=&quot;user-hover&quot; rel=&quot;cdrome&quot;&gt;cdrome&lt;/a&gt;. I am curious to understand why this happens. When impersonation is turned on the HMSClient is instantiated from the HiveSessionImplWithUGI and it does a doAs() when instantiating the client. All subsequent actions coming via HS2 should also do a doAs() using the sessionProxy. Is this happening in case of HCatalog (I am not very familiar with HCatalog)? It would be great if you provide some call-stack or example of when this happens. Thanks!&lt;/p&gt;

&lt;p&gt;Took a quick look at the patch. Couple questions.&lt;br/&gt;
if (this.ugi == null) &lt;/p&gt;
{
78	      LOG.warn(&quot;RetryingMetaStoreClient unable to determine current user UGI.&quot;);
79	    }

&lt;p&gt;Will ugi ever be null? If not, may be this check is redundant.&lt;br/&gt;
Can you also add a test case if possible?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="16227311" author="cdrome" created="Tue, 31 Oct 2017 18:45:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vihangk1&quot; class=&quot;user-hover&quot; rel=&quot;vihangk1&quot;&gt;vihangk1&lt;/a&gt;, as per the description, consider the case of Oozie &lt;tt&gt;oozie&lt;/tt&gt; impersonating a different user &lt;tt&gt;mithun&lt;/tt&gt;. The &lt;tt&gt;oozie&lt;/tt&gt; user will create a client and open the connection to the metastore within the doAs clause, which means that all operations during this session are performed as &lt;tt&gt;mithun&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;A retry/reconnect can occur if the read timeout for an operation is exceeded or the lifetime of the connection is exceeded. At this point, &lt;tt&gt;close&lt;/tt&gt; is called explicitly, followed by a call to &lt;tt&gt;open&lt;/tt&gt; to establish a new connection. However, the reconnect call is not being performed in a doAs context, so it will create a new connection to the metastore as &lt;tt&gt;oozie&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;There is no specific stack trace to attach here as it depends on the operations executed after the reconnect, and typically manifests as a failure caused by insufficient privileges. Worst case, if &lt;tt&gt;oozie&lt;/tt&gt; has more privileges than &lt;tt&gt;mithun&lt;/tt&gt;, it will successfully perform operations that &lt;tt&gt;mithun&lt;/tt&gt; is not allowed to perform.&lt;/p&gt;

&lt;p&gt;According to the API, fetching the UserGroupInformation object can throw an IOException. I&apos;m not familiar with the cases under which this would occur. However, I didn&apos;t want to fail immediately, because if the connection was initially established within a doAs, the calling code should have been able to establish a proper identity. So I let as much work get accomplished until the reconnect fails, which shouldn&apos;t be a problem, because most metastore sessions are not long-lived.&lt;/p&gt;</comment>
                            <comment id="16227401" author="mithun" created="Tue, 31 Oct 2017 19:51:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vihangk1&quot; class=&quot;user-hover&quot; rel=&quot;vihangk1&quot;&gt;vihangk1&lt;/a&gt;,&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;All subsequent actions coming via HS2 should also do a doAs() using the sessionProxy. Is this happening in case of HCatalog...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Right. HS2 doesn&apos;t come into it, since this has more to do with &lt;tt&gt;HCatClient&lt;/tt&gt;. The HCatalog APIs use &lt;tt&gt;HiveClientCache&lt;/tt&gt; to amortize the cost of &lt;tt&gt;HiveMetaStoreClient&lt;/tt&gt; construction and metastore connections.&lt;br/&gt;
Systems like Oozie/Falcon that use &lt;tt&gt;HCatClient&lt;/tt&gt; to make metastore-calls within a &lt;tt&gt;doAs()&lt;/tt&gt; context might land up losing their &lt;tt&gt;UGI.doAs()&lt;/tt&gt; contexts after timeout, causing any retried actions to run as a privileged, rather than the impersonated user.&lt;/p&gt;</comment>
                            <comment id="16233534" author="mithun" created="Wed, 1 Nov 2017 01:06:12 +0000"  >&lt;p&gt;For the record, we&apos;ve tested this out manually, using an Oozie setup, with user-impersonation. I suppose it might be possible to set up a unit-test using something based on &lt;tt&gt;MiniHiveKdc&lt;/tt&gt;, but it looks non-trivial. Hmm...&lt;/p&gt;</comment>
                            <comment id="16234314" author="mithun" created="Wed, 1 Nov 2017 16:18:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vihangk1&quot; class=&quot;user-hover&quot; rel=&quot;vihangk1&quot;&gt;vihangk1&lt;/a&gt;, would you be averse to our adding a unit-test in a followup JIRA?&lt;/p&gt;</comment>
                            <comment id="16234338" author="vihangk1" created="Wed, 1 Nov 2017 16:33:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;Right. HS2 doesn&apos;t come into it, since this has more to do with HCatClient. The HCatalog APIs use HiveClientCache to amortize the cost of HiveMetaStoreClient construction and metastore connections. Systems like Oozie/Falcon that use HCatClient to make metastore-calls within a doAs() context might land up losing their UGI.doAs() contexts after timeout, causing any retried actions to run as a privileged, rather than the impersonated user.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mithun&quot; class=&quot;user-hover&quot; rel=&quot;mithun&quot;&gt;mithun&lt;/a&gt; for the clarification. I am fine with adding unit-tests in a followup JIRA. May be we should also refactor the reconnect using UGI logic in a separate method? the &lt;tt&gt;invoke&lt;/tt&gt; method is already pretty unwieldy will the different try catch clauses. Rest looks fine to me. +1&lt;/p&gt;</comment>
                            <comment id="16234426" author="cdrome" created="Wed, 1 Nov 2017 17:27:44 +0000"  >&lt;p&gt;I&apos;m part way through a possible unittest now. Let&apos;s see how that goes.&lt;/p&gt;

&lt;p&gt;Unittests have not run for any of the other candidate branches yet.&lt;br/&gt;
Will try to coerce builds to run.&lt;/p&gt;</comment>
                            <comment id="16275017" author="mithun" created="Fri, 1 Dec 2017 21:27:21 +0000"  >&lt;p&gt;I&apos;ll check this version of the fix in. I have raised &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-18199&quot; title=&quot;Add unit-test for lost UGI doAs() context in RetryingMetaStoreClient&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-18199&quot;&gt;HIVE-18199&lt;/a&gt; to track the addition of the unit-test.&lt;/p&gt;</comment>
                            <comment id="16275046" author="mithun" created="Fri, 1 Dec 2017 21:58:24 +0000"  >&lt;p&gt;Checked into &lt;tt&gt;master&lt;/tt&gt;, &lt;tt&gt;branch-2&lt;/tt&gt;, and &lt;tt&gt;branch-2.2&lt;/tt&gt;. Thank you for the fix, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cdrome&quot; class=&quot;user-hover&quot; rel=&quot;cdrome&quot;&gt;cdrome&lt;/a&gt;! And thank you, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vihangk1&quot; class=&quot;user-hover&quot; rel=&quot;vihangk1&quot;&gt;vihangk1&lt;/a&gt;, for taking the time to review.&lt;/p&gt;</comment>
                            <comment id="16299065" author="thejas" created="Wed, 20 Dec 2017 20:47:54 +0000"  >&lt;p&gt;We should also check to see if current user is same as the original UGI user, and not do the ugi.doAs() if it is the same. Otherwise, this can potentially cause problems where the users are not privileged users (ie, there is no intent to do a &quot;doAs&quot;).&lt;br/&gt;
Without such a check, you would get errors like &quot; userX is not allowed to impersonate userX&quot;.&lt;/p&gt;</comment>
                            <comment id="16299079" author="thejas" created="Wed, 20 Dec 2017 20:57:51 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-18322&quot; title=&quot;RetryingMetaStoreClient reconnect should not use ugi.doAs if not necessary&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-18322&quot;&gt;HIVE-18322&lt;/a&gt;. &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cdrome&quot; class=&quot;user-hover&quot; rel=&quot;cdrome&quot;&gt;cdrome&lt;/a&gt;&lt;br/&gt;
Do you think you will be able to take a stab at it ?&lt;/p&gt;</comment>
                            <comment id="16485556" author="ashutoshc" created="Tue, 22 May 2018 23:16:38 +0000"  >&lt;p&gt;This jira is resolved and released with Hive 3.0 If you find an issue with it, please create a new jira.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13122283">HIVE-18199</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13126386">HIVE-18322</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12895046" name="HIVE-17853.01-branch-2.patch" size="4634" author="cdrome" created="Tue, 31 Oct 2017 18:59:15 +0000"/>
                            <attachment id="12894882" name="HIVE-17853.01.patch" size="4634" author="cdrome" created="Tue, 31 Oct 2017 00:32:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3lhnj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12341417">2.2.1</customfieldvalue>
    <customfieldvalue id="12340338">2.4.0</customfieldvalue>
    <customfieldvalue id="12340268">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>