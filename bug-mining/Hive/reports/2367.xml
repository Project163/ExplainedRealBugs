<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:21:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-7431] When run on spark cluster, some spark tasks may fail</title>
                <link>https://issues.apache.org/jira/browse/HIVE-7431</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;When running queries on spark, some spark tasks fail (usually the first couple of tasks) with the following stack trace:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;org.apache.hadoop.hive.ql.exec.mr.ExecMapper.configure(ExecMapper.java:154)&lt;br/&gt;
org.apache.hadoop.hive.ql.exec.spark.HiveMapFunction.call(HiveMapFunction.java:60)&lt;br/&gt;
org.apache.hadoop.hive.ql.exec.spark.HiveMapFunction.call(HiveMapFunction.java:35)&lt;br/&gt;
org.apache.spark.api.java.JavaRDDLike$$anonfun$fn$7$1.apply(JavaRDDLike.scala:161)&lt;br/&gt;
org.apache.spark.api.java.JavaRDDLike$$anonfun$fn$7$1.apply(JavaRDDLike.scala:161)&lt;br/&gt;
org.apache.spark.rdd.RDD$$anonfun$12.apply(RDD.scala:559)&lt;br/&gt;
org.apache.spark.rdd.RDD$$anonfun$12.apply(RDD.scala:559)&lt;br/&gt;
org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:35)&lt;br/&gt;
org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:262)&lt;br/&gt;
org.apache.spark.rdd.RDD.iterator(RDD.scala:229)&lt;br/&gt;
org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:158)&lt;br/&gt;
...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Observed for spark standalone cluster. Not verified for spark on yarn or mesos.&lt;br/&gt;
NO PRECOMMIT TESTS. This is for spark branch only.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12727825">HIVE-7431</key>
            <summary>When run on spark cluster, some spark tasks may fail</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lirui">Rui Li</assignee>
                                    <reporter username="lirui">Rui Li</reporter>
                        <labels>
                    </labels>
                <created>Thu, 17 Jul 2014 02:25:22 +0000</created>
                <updated>Fri, 29 May 2015 02:31:37 +0000</updated>
                            <resolved>Mon, 21 Jul 2014 05:22:29 +0000</resolved>
                                                    <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14065872" author="lirui" created="Fri, 18 Jul 2014 01:34:32 +0000"  >&lt;p&gt;The original exception is:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;org.apache.hadoop.hive.ql.metadata.HiveException: Hive internal error: cannot find parent in the child operator!&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.Operator.initialize(Operator.java:365)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.mr.ExecMapper.configure(ExecMapper.java:133)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.spark.HiveMapFunction.call(HiveMapFunction.java:60)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.spark.HiveMapFunction.call(HiveMapFunction.java:35)&lt;br/&gt;
        at org.apache.spark.api.java.JavaRDDLike$$anonfun$fn$7$1.apply(JavaRDDLike.scala:161)&lt;br/&gt;
        at org.apache.spark.api.java.JavaRDDLike$$anonfun$fn$7$1.apply(JavaRDDLike.scala:161)&lt;br/&gt;
        at org.apache.spark.rdd.RDD$$anonfun$12.apply(RDD.scala:559)&lt;br/&gt;
        at org.apache.spark.rdd.RDD$$anonfun$12.apply(RDD.scala:559)&lt;br/&gt;
        at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:35)&lt;br/&gt;
        at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:262)&lt;br/&gt;
        at org.apache.spark.rdd.RDD.iterator(RDD.scala:229)&lt;br/&gt;
        at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:158)&lt;br/&gt;
        at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:99)&lt;br/&gt;
        at org.apache.spark.scheduler.Task.run(Task.scala:51)&lt;br/&gt;
        at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:183)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:744)&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="14065958" author="lirui" created="Fri, 18 Jul 2014 03:10:17 +0000"  >&lt;p&gt;It seems that some malformed op tree caused this issue:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;MAP&amp;gt;Id =69
  &amp;lt;Children&amp;gt;
    &amp;lt;TS&amp;gt;Id =65
      &amp;lt;Children&amp;gt;
        &amp;lt;SEL&amp;gt;Id =66
          &amp;lt;Children&amp;gt;
            &amp;lt;GBY&amp;gt;Id =67
              &amp;lt;Children&amp;gt;
                &amp;lt;RS&amp;gt;Id =68
                  &amp;lt;Children&amp;gt;
                  &amp;lt;\Children&amp;gt;
                  &amp;lt;Parent&amp;gt;Id = 67 null&amp;lt;\Parent&amp;gt;
                &amp;lt;\RS&amp;gt;
              &amp;lt;\Children&amp;gt;
              &amp;lt;Parent&amp;gt;Id = 66 null&amp;lt;\Parent&amp;gt;
            &amp;lt;\GBY&amp;gt;
          &amp;lt;\Children&amp;gt;
          &amp;lt;Parent&amp;gt;Id = 65 null&amp;lt;\Parent&amp;gt;
        &amp;lt;\SEL&amp;gt;
      &amp;lt;\Children&amp;gt;
      &amp;lt;Parent&amp;gt;Id = 71
    &amp;lt;MAP&amp;gt;Id =71
      &amp;lt;Children&amp;gt;null
      &amp;lt;\Children&amp;gt;
      &amp;lt;Parent&amp;gt;&amp;lt;\Parent&amp;gt;
    &amp;lt;\MAP&amp;gt;&amp;lt;\Parent&amp;gt;
    &amp;lt;\TS&amp;gt;
  &amp;lt;\Children&amp;gt;
  &amp;lt;Parent&amp;gt;&amp;lt;\Parent&amp;gt;
&amp;lt;\MAP&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14066004" author="xuefuz" created="Fri, 18 Jul 2014 04:23:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirui&quot; class=&quot;user-hover&quot; rel=&quot;lirui&quot;&gt;lirui&lt;/a&gt; Thanks for working on this. How to reproduce the problem? What query can produce this error?&lt;/p&gt;</comment>
                            <comment id="14066114" author="lirui" created="Fri, 18 Jul 2014 06:48:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt; This failure happens when I run select count ( * ) or max/min queries on a table.&lt;br/&gt;
Spark cluster is deployed in standalone mode.&lt;/p&gt;

&lt;p&gt;I added some log to debug the issue. I found that the issue is due to setting parent for a TS more than once. Take the malformed op tree I mentioned earlier for example, when MAP (69) is created, we set TS (65) as its child and set TS (65)&apos;s parent to MAP (69). But later when creating MAP (71), TS (65) is set as its child again. Now TS (65)&apos;s parent doesn&apos;t contain MAP (69), which triggers the exception.&lt;/p&gt;

&lt;p&gt;I&apos;m not familiar with how the map operator is structured but I suppose a TS shouldn&apos;t be assigned to multiple MAPs right? Please note the successful tasks don&apos;t have such a malformed tree.&lt;/p&gt;

&lt;p&gt;I&apos;m still working to find the root cause. Any thoughts on this issue?&lt;/p&gt;</comment>
                            <comment id="14066120" author="lirui" created="Fri, 18 Jul 2014 06:52:28 +0000"  >&lt;p&gt;I also noted that when running on Tez, MapWork is cached in an ObjectCache. Now spark mode retrieves the MapWork from the plan file for each task. Not sure if this could be related to the issue here?&lt;/p&gt;</comment>
                            <comment id="14066188" author="lirui" created="Fri, 18 Jul 2014 09:26:43 +0000"  >&lt;p&gt;Since each spark task is a thread running in the same JVM, we should always deserialize the MapWork from the plan file for each task, rather than loading it from the cache.&lt;/p&gt;

&lt;p&gt;I run several queries with this patch and all tasks finish successfully.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt;] please help to see if this is the right way to solve this issue.&lt;/p&gt;</comment>
                            <comment id="14067195" author="xuefuz" created="Fri, 18 Jul 2014 23:29:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirui&quot; class=&quot;user-hover&quot; rel=&quot;lirui&quot;&gt;lirui&lt;/a&gt; I wasn&apos;t able to reproduce the problem as my dataset is small and thus my test case doesn&apos;t involves multiple tasks.&lt;/p&gt;

&lt;p&gt;I think you&apos;re right that multiple tasks shouldn&apos;t share MapWork in case of Spark as each thread running a task needs its own copy of operators. While it&apos;s okay to deserialize a MapWork for each task running in a JVM, for a longer term, maybe we should deserialize once and clone it as needed. Cloning should be more performing.&lt;/p&gt;

&lt;p&gt;I guess this uncovers a concurrency issue. I expect there will be more issues like this. Thanks for identifying this one.&lt;/p&gt;

&lt;p&gt;Could you clean up the patch a little by removing debugging code?&lt;/p&gt;</comment>
                            <comment id="14068100" author="lirui" created="Mon, 21 Jul 2014 01:37:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt;, thanks for the review. I&apos;ll clean up the code and use clone instead.&lt;/p&gt;</comment>
                            <comment id="14068115" author="xuefuz" created="Mon, 21 Jul 2014 02:15:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirui&quot; class=&quot;user-hover&quot; rel=&quot;lirui&quot;&gt;lirui&lt;/a&gt; Let&apos;s not worry about cloning for now. It can be done later as optimization. Just clean up the code to remove unnecessary changes.&lt;/p&gt;</comment>
                            <comment id="14068118" author="lirui" created="Mon, 21 Jul 2014 02:30:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt; I see. In HiveMapFunction.call, MapWork is retrieved and put to a global work map in Utilities. I think this is redundant since ExecMapper will later get MapWork itself. I commented these out in the current patch. Should I just remove them?&lt;/p&gt;</comment>
                            <comment id="14068175" author="xuefuz" created="Mon, 21 Jul 2014 04:01:28 +0000"  >&lt;p&gt;Sure. Please feel free to do so. That&apos;s just POC code.&lt;/p&gt;</comment>
                            <comment id="14068216" author="lirui" created="Mon, 21 Jul 2014 05:11:52 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt;, I&apos;ve updated the patch.&lt;/p&gt;</comment>
                            <comment id="14068221" author="xuefuz" created="Mon, 21 Jul 2014 05:21:59 +0000"  >&lt;p&gt;Patch looks good to me. Will commit shortly.&lt;/p&gt;</comment>
                            <comment id="14068222" author="xuefuz" created="Mon, 21 Jul 2014 05:22:29 +0000"  >&lt;p&gt;Patch committed to spark branch. Thanks to Rui for the contribution.&lt;/p&gt;</comment>
                            <comment id="14248691" author="brocknoland" created="Tue, 16 Dec 2014 19:00:31 +0000"  >&lt;p&gt;FYI that I created a jira to re-introduce some caching of these objects in RSC in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-9127&quot; title=&quot;Improve CombineHiveInputFormat.getSplit performance&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-9127&quot;&gt;&lt;del&gt;HIVE-9127&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12723734">HIVE-7292</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12762070">HIVE-9127</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12656484" name="HIVE-7431.1.patch" size="3382" author="lirui" created="Fri, 18 Jul 2014 09:21:06 +0000"/>
                            <attachment id="12656821" name="HIVE-7431.2.patch" size="1707" author="lirui" created="Mon, 21 Jul 2014 05:11:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>405930</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 49 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xusn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>405950</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>