<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:27:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-28880] Wrong result when output column in a vectorized expression is used as a scratch column by a child</title>
                <link>https://issues.apache.org/jira/browse/HIVE-28880</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Steps to reproduce:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;#Issue is not reproducible without below configs
set hive.vectorized.execution.enabled=true;
set hive.cbo.enable=true;
set hive.auto.convert.join=true;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Create tables &amp;amp; insert few rows&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE EXTERNAL TABLE main_tbl(col1 string, col2 string) stored as orc;
CREATE EXTERNAL TABLE sub_tbl(pdate date) stored as orc;
insert into main_tbl values(&apos;20250331&apos;,&apos;BBB&apos;),(&apos;20250331&apos;,&apos;AAAAAA&apos;);
insert into sub_tbl values(&apos;2025-03-31&apos;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The below query returns incorrect results&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;select case
&#160; &#160; when upper(trim(col2)) = &apos;AAAAAA&apos; then &apos;AAAA_BBBB_CCCC_DDDD&apos;
&#160; &#160; when upper(trim(col2)) = &apos;BBB&apos; then &apos;WWWW_XXXX_YYYY_ZZZZ&apos;
&#160; &#160; else &apos;N/A&apos;
end as result
from main_tbl
where cast(concat(substr(trim(col1),1,4),&apos;-&apos;,substr(trim(col1),5,2),&apos;-&apos;,substr(trim(col1),7,2)) as date) in (select pdate from sub_tbl);

Output:
--------------------
WWWW_XXXX_YYYY_ZZZZ
BBBWWWW_XXXX_YYYY_Z&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;While the expected result is&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-------------------------
WWWW_XXXX_YYYY_ZZZZ
AAAA_BBBB_CCCC_DDDD
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;One workaround for this is rephrasing the query to&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;select case
&#160; &#160; when upper(trim(col2)) = &apos;AAAAAA&apos; then &apos;AAAA_BBBB_CCCC_DDDD&apos;
&#160; &#160; when upper(trim(col2)) = &apos;BBB&apos; then &apos;WWWW_XXXX_YYYY_ZZZZ&apos;
&#160; &#160; else &apos;N/A&apos;
end as result
from main_tbl
where col1 in (select date_format(pdate, &apos;yyyyMMdd&apos;) from sub_tbl);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Attaching the qtest file here&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13614077">HIVE-28880</key>
            <summary>Wrong result when output column in a vectorized expression is used as a scratch column by a child</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="soumyakanti.das">Soumyakanti Das</assignee>
                                    <reporter username="tarak271">Taraka Rama Rao Lethavadla</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 3 Apr 2025 11:38:58 +0000</created>
                <updated>Thu, 31 Jul 2025 08:51:17 +0000</updated>
                            <resolved>Thu, 31 Jul 2025 08:51:17 +0000</resolved>
                                                    <fixVersion>4.2.0</fixVersion>
                                    <component>HiveServer2</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="18010748" author="soumyakanti.das" created="Tue, 29 Jul 2025 22:20:01 +0000"  >&lt;p&gt;To understand why this occurs, we need to run &lt;tt&gt;explain vectorization detail&lt;/tt&gt;. We can see the following plan in &lt;tt&gt;Select Vectorization&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;selectExpressions:&#160;
&#160; IfExprColumnCondExpr(col 12:boolean, col 4:string, col 5:string)(
&#160; &#160; children:&#160;
&#160; &#160; &#160; StringGroupColEqualStringScalar(col 5: string, val AAAAAA)(
&#160; &#160; &#160; &#160; children:&#160;
&#160; &#160; &#160; &#160; &#160; StringUpper(col 4:string)(
&#160; &#160; &#160; &#160; &#160; &#160; children:&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; StringTrimCol(col 1:string) -&amp;gt; 4:string
&#160; &#160; &#160; &#160; &#160; ) -&amp;gt; 5:string
&#160; &#160; &#160; ) -&amp;gt; 12:boolean,&#160;
&#160; &#160; &#160;&#160;
&#160; &#160; &#160; ConstantVectorExpression(val AAAA_BBBB_CCCC_DDDD) -&amp;gt; 4:string,&#160;
&#160; &#160; &#160;&#160;
&#160; &#160; &#160; IfExprStringScalarStringScalar(col 13:boolean, val WWWW_XXXX_YYYY_ZZZZ, val N/A)(
&#160; &#160; &#160; &#160; children:&#160;
&#160; &#160; &#160; &#160; &#160; StringGroupColEqualStringScalar(col 6:string, val BBB)(
&#160; &#160; &#160; &#160; &#160; &#160; children:&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; StringUpper(col 5:string)(
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; children:&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; StringTrimCol(col 1:string) -&amp;gt; 5:string
&#160; &#160; &#160; &#160; &#160; &#160; &#160; ) -&amp;gt; 6:string
&#160; &#160; &#160; &#160; &#160; ) -&amp;gt; 13:boolean
&#160; &#160; &#160; ) -&amp;gt; 5:string
&#160; ) -&amp;gt; 6:string&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is the representation of the CASE WHEN statement:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;case
    when upper(trim(col2)) = &apos;AAAAAA&apos; then &apos;AAAA_BBBB_CCCC_DDDD&apos;
    when upper(trim(col2)) = &apos;BBB&apos; then &apos;WWWW_XXXX_YYYY_ZZZZ&apos;
    else &apos;N/A&apos;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;There are three children in the &lt;tt&gt;selectExpressions&lt;/tt&gt; shown above. The first corresponds to the IF expression, i.e., &lt;tt&gt;when upper(trim(col2)) = &apos;AAAAAA&apos;&lt;/tt&gt;. The second child represents the THEN, and in this case it is simply a &lt;tt&gt;ConstantVectorExpression&lt;/tt&gt;. And the third child is again a conditional (IF) statement that deals with the second WHEN statement in the query.&lt;/p&gt;

&lt;p&gt;During vectorized execution of the query, after the IF expression (first child) has been evaluated it is possible to mark and separate the rows into two different vectors corresponding to the THEN and ELSE case. And thus, after the second child (THEN expr) has been evaluated, it is possible to produce the final output for the rows corresponding the THEN case, without evaluating the third child (ELSE expr) first. This is what we do currently, as seen &lt;a href=&quot;https://github.com/apache/hive/blob/46f2783164584bddfef6efdc4d84586bb3114ba1/ql/src/java/org/apache/hadoop/hive/ql/exec/vector/expressions/IfExprColumnCondExpr.java#L97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. The issue arises when we write the partial output of IF-THEN to the final output column (col 6 in this case), and then use the same column during the evaluation of the ELSE expression (third child), because we can overwrite the final results in the column. In this particular example, we can see that col 6 is used to store the output of &lt;tt&gt;StringUpper&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; StringUpper(col 5:string)(
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; children:&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; StringTrimCol(col 1:string) -&amp;gt; 5:string
&#160; &#160; &#160; &#160; &#160; &#160; &#160; ) -&amp;gt; 6:string&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This issue is somewhat similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-26408&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-26408&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I think one of the potential solution is to simply ensure that all children have been evaluated before we start writing to the final output column. We see that most descendants of &lt;tt&gt;VectorExpression&lt;/tt&gt; evaluate their children by calling the &lt;a href=&quot;https://github.com/apache/hive/blob/46f2783164584bddfef6efdc4d84586bb3114ba1/ql/src/java/org/apache/hadoop/hive/ql/exec/vector/expressions/VectorExpression.java#L320&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;evaluateChildren&lt;/a&gt; method, which evaluates all the children one after another in a for loop. For IF-THEN-ELSE statements we do not do this as they may have to be evaluated conditionally sometimes. However, we should still ensure that the flow of execution is similar and should evaluate all children before writing anything to the final output column.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="18011116" author="krisztiankasa" created="Thu, 31 Jul 2025 08:51:17 +0000"  >&lt;p&gt;Merged to master. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=soumyakanti.das&quot; class=&quot;user-hover&quot; rel=&quot;soumyakanti.das&quot;&gt;soumyakanti.das&lt;/a&gt; for the fix.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13075791" name="test.q" size="1099" author="tarak271" created="Thu, 3 Apr 2025 11:38:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1v5s0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>