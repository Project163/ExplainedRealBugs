<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:50:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-15565] LLAP: GroupByOperator flushes hash table too frequently</title>
                <link>https://issues.apache.org/jira/browse/HIVE-15565</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;&lt;tt&gt;GroupByOperator::isTez&lt;/tt&gt; would be true in LLAP mode. Current memory computations can go wrong with &lt;tt&gt;isTez&lt;/tt&gt; checks in &lt;tt&gt;GroupByOperator&lt;/tt&gt;. For e.g, in a LLAP instance with Xmx128G and 12 executors, it would start flushing hash table for every record once it reaches around 42GB (hive.tez.container.size=7100, hive.map.aggr.hash.percentmemory=0.5).&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2017-01-08T23:40:21,339 INFO  [TezTaskRunner (1480722417364_1922_7_03_000004_1)] org.apache.hadoop.hive.ql.exec.GroupByOperator: Hash Table flushed: new size = 0
2017-01-08T23:40:21,339 INFO  [TezTaskRunner (1480722417364_1922_7_03_000012_1)] org.apache.hadoop.hive.ql.exec.GroupByOperator: Hash Table flushed: new size = 0
2017-01-08T23:40:21,339 INFO  [TezTaskRunner (1480722417364_1922_7_03_000004_1)] org.apache.hadoop.hive.ql.exec.GroupByOperator: Hash Tbl flush: #hash table = 1
2017-01-08T23:40:21,339 INFO  [TezTaskRunner (1480722417364_1922_7_03_000012_1)] org.apache.hadoop.hive.ql.exec.GroupByOperator: Hash Tbl flush: #hash table = 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13032979">HIVE-15565</key>
            <summary>LLAP: GroupByOperator flushes hash table too frequently</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rajesh.balamohan">Rajesh Balamohan</assignee>
                                    <reporter username="rajesh.balamohan">Rajesh Balamohan</reporter>
                        <labels>
                    </labels>
                <created>Mon, 9 Jan 2017 06:37:10 +0000</created>
                <updated>Tue, 25 Jul 2017 20:05:30 +0000</updated>
                            <resolved>Sun, 22 Jan 2017 22:29:17 +0000</resolved>
                                                    <fixVersion>2.2.0</fixVersion>
                                    <component>llap</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15811045" author="prasanth_j" created="Mon, 9 Jan 2017 08:27:25 +0000"  >&lt;p&gt;For LLAP, GBY hashtable memory should be shared by all executors. The problem is with tracking memory usage per thread. There is already an open jira for this. &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-15508&quot; title=&quot;LLAP: Find better way to track memory usage per executor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-15508&quot;&gt;HIVE-15508&lt;/a&gt;&lt;br/&gt;
Ideally, we want to track memory usage per executor and flush based on usage vs max memory available per executor ratio. &lt;/p&gt;</comment>
                            <comment id="15811206" author="hiveqa" created="Mon, 9 Jan 2017 09:44:25 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12846265/HIVE-15565.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12846265/HIVE-15565.1.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 6 failed/errored test(s), 10903 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=233)
TestSparkCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=122)
	[groupby3_map.q,union26.q,mapreduce1.q,mapjoin_addjar.q,bucket_map_join_spark1.q,udf_example_add.q,multi_insert_with_join.q,sample7.q,auto_join_nulls.q,ppd_outer_join4.q,load_dyn_part8.q,alter_merge_orc.q,sample6.q,bucket_map_join_1.q,auto_sortmerge_join_9.q]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[case_sensitivity] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[input_testxpath] (batchId=28)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[udf_coalesce] (batchId=75)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_char_simple] (batchId=146)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/2839/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/2839/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/2839/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/2839/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-2839/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-2839/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 6 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12846265 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15813221" author="sershe" created="Mon, 9 Jan 2017 23:39:11 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15817577" author="rajesh.balamohan" created="Wed, 11 Jan 2017 07:59:01 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt;. Committed to master.&lt;/p&gt;</comment>
                            <comment id="15824647" author="hagleitn" created="Mon, 16 Jan 2017 22:01:05 +0000"  >&lt;p&gt;I don&apos;t understand this - isn&apos;t the commit doing the exact opposite of what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt; says? This is flushing when the JVM memory is hit v the max allocated memory per executor. This would have a lot of bad side effects by having multiple queries/fragments step on one another...&lt;/p&gt;</comment>
                            <comment id="15824655" author="sershe" created="Mon, 16 Jan 2017 22:08:32 +0000"  >&lt;p&gt;Looking at it again (and at &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt; &apos;s comment that I cannot quite understand)... what is the task configured memory that we are no longer using? Is it set based on Tez executor size (or equivalent) in MapRecordProcessor? It&apos;s set from Tez context.&lt;br/&gt;
Also, why is this causing single-record flushes if we base on task memory?&lt;/p&gt;</comment>
                            <comment id="15824756" author="rajesh.balamohan" created="Tue, 17 Jan 2017 00:27:03 +0000"  >
&lt;p&gt;As per old impl, maxMemory in &lt;tt&gt;GroupByOperator&lt;/tt&gt; was 5,312,784,896. After running few queries (e.g q22,18, 70, 67) heap usage increases to ~64GB. Now when q22 is rerun, &lt;tt&gt;GroupByOperator::shouldBeFlushed&lt;/tt&gt; would always return true for every record due to the following calculation&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      usedMemory = isLlap ? usedMemory / numExecutors : usedMemory;
      rate = (float) usedMemory / (float) maxMemory;  &amp;lt;==== 64/12 = 5.33 GB / 5312784896 bytes  &amp;gt; memoryThreshold of 0.9.
      if(rate &amp;gt; memoryThreshold){
        return true;
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Even though q22 dataset is very small, it would end up flushing for every row. Patch fixes the assumption for isTez/isLLAP. But we still need &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-15508&quot; title=&quot;LLAP: Find better way to track memory usage per executor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-15508&quot;&gt;HIVE-15508&lt;/a&gt; for exact memory tracking. &lt;/p&gt;</comment>
                            <comment id="15828993" author="sseth" created="Wed, 18 Jan 2017 23:46:20 +0000"  >&lt;p&gt;After the patch, we won&apos;t flush in LLAP GroupBy, correct? used/numExecutors always &amp;lt; maxMemory ?&lt;/p&gt;

&lt;p&gt;Before the patch - it&apos;s random, and depends on other operators running in the system.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-15508&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-15508&lt;/a&gt; is pretty important - tracking memory per operator should help with this.&lt;/p&gt;</comment>
                            <comment id="15829228" author="rajesh.balamohan" created="Thu, 19 Jan 2017 03:17:20 +0000"  >&lt;p&gt;Had offline discussion with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt; on this. We do not need to flush the hashTable when &lt;tt&gt;numEntriesHashTable=0&lt;/tt&gt; in LLAP.  We can revert the existing patch and check for this condition for LLAP.  That would reduce the number of flushes by large margin.&lt;/p&gt;</comment>
                            <comment id="15829231" author="rajesh.balamohan" created="Thu, 19 Jan 2017 03:19:27 +0000"  >&lt;p&gt;Reverted the patch. Will post a separate patch for checking &quot;numEntriesHashTable==0&quot; for LLAP.&lt;/p&gt;</comment>
                            <comment id="15829282" author="prasanth_j" created="Thu, 19 Jan 2017 04:05:33 +0000"  >&lt;p&gt;This delays the memory check hoping memory will be freed up in the meantime. Although freeing up of memory is not guaranteed and may not happen at all because of on-heap metadata cache and when other executors are performing allocations. &lt;/p&gt;

&lt;p&gt;LGTM, +1. Pending tests.&lt;/p&gt;</comment>
                            <comment id="15831308" author="hiveqa" created="Fri, 20 Jan 2017 06:59:12 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12848220/HIVE-15565.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12848220/HIVE-15565.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 11 failed/errored test(s), 10963 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=235)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[specialChar] (batchId=22)
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver[encryption_join_with_different_encryption_keys] (batchId=159)
org.apache.hadoop.hive.cli.TestHBaseNegativeCliDriver.testCliDriver[cascade_dbdrop] (batchId=226)
org.apache.hadoop.hive.cli.TestHBaseNegativeCliDriver.testCliDriver[generatehfiles_require_family_path] (batchId=226)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[escape1] (batchId=139)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[escape2] (batchId=154)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[schema_evol_text_vec_part] (batchId=149)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=140)
org.apache.hadoop.hive.cli.TestNegativeMinimrCliDriver.testCliDriver[cluster_tasklog_retrieval] (batchId=87)
org.apache.hadoop.hive.cli.TestNegativeMinimrCliDriver.testCliDriver[minimr_broken_pipe] (batchId=87)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/3060/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/3060/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/3060/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/3060/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-3060/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-3060/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 11 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12848220 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15833738" author="rajesh.balamohan" created="Sun, 22 Jan 2017 22:29:17 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt;.  Committed to master. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12846265" name="HIVE-15565.1.patch" size="1772" author="rajesh.balamohan" created="Mon, 9 Jan 2017 06:40:39 +0000"/>
                            <attachment id="12848220" name="HIVE-15565.2.patch" size="804" author="rajesh.balamohan" created="Thu, 19 Jan 2017 03:45:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 43 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i38ffr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>