<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:27:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-28954] CI fails intermittently due to ephemeral-storage exhaustion</title>
                <link>https://issues.apache.org/jira/browse/HIVE-28954</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;The CI fails intermittently due to ephemeral-storage exhaustion. The failures on master have been quite often recently:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci.hive.apache.org/blue/organizations/jenkins/hive-precommit/detail/master/2512/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.hive.apache.org/blue/organizations/jenkins/hive-precommit/detail/master/2512/pipeline&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci.hive.apache.org/blue/organizations/jenkins/hive-precommit/detail/master/2511/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.hive.apache.org/blue/organizations/jenkins/hive-precommit/detail/master/2511/pipeline&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci.hive.apache.org/blue/organizations/jenkins/hive-precommit/detail/master/2510/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.hive.apache.org/blue/organizations/jenkins/hive-precommit/detail/master/2510/pipeline&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci.hive.apache.org/blue/organizations/jenkins/hive-precommit/detail/master/2507/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.hive.apache.org/blue/organizations/jenkins/hive-precommit/detail/master/2507/pipeline&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci.hive.apache.org/blue/organizations/jenkins/hive-precommit/detail/master/2505/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.hive.apache.org/blue/organizations/jenkins/hive-precommit/detail/master/2505/pipeline&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci.hive.apache.org/blue/organizations/jenkins/hive-precommit/detail/master/2501/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.hive.apache.org/blue/organizations/jenkins/hive-precommit/detail/master/2501/pipeline&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci.hive.apache.org/blue/organizations/jenkins/hive-precommit/detail/master/2474/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.hive.apache.org/blue/organizations/jenkins/hive-precommit/detail/master/2474/pipeline&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The error message is shown below.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Unable to create live FilePath for hive-precommit-master-2512-g4v1j-l5dbf-5l773; hive-precommit-master-2512-g4v1j-l5dbf-5l773 was marked offline: Pod failed (Reason: Evicted, Message: The node was low on resource: ephemeral-storage. Threshold quantity: 10120387530, available: 9866372Ki. Container jnlp was using 88Ki, request is 0, has larger consumption of ephemeral-storage. Container dind was using 188Ki, request is 0, has larger consumption of ephemeral-storage. Container hdb was using 453252Ki, request is 0, has larger consumption of ephemeral-storage. )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As the message indicates the node where the pod is running is low on ephemeral-storage leading to the eviction of some pods from the Kubernetes scheduler.&lt;/p&gt;

&lt;p&gt;The ephemeral-storage among other things stores all the jars, logs, and output from the test execution.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13617973">HIVE-28954</key>
            <summary>CI fails intermittently due to ephemeral-storage exhaustion</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zabetak">Stamatis Zampetakis</assignee>
                                    <reporter username="zabetak">Stamatis Zampetakis</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 13 May 2025 12:04:37 +0000</created>
                <updated>Tue, 29 Jul 2025 14:51:44 +0000</updated>
                            <resolved>Tue, 24 Jun 2025 14:17:58 +0000</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                    <component>Testing Infrastructure</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17951176" author="zabetak" created="Tue, 13 May 2025 12:24:22 +0000"  >&lt;p&gt;The ephemeral-storage capacity of each node of the GKE cluster is&#160; 101.2 GB out of which 47.06 GB are allocatable. Currently, the precommit pods do not define request/limit for the ephemeral-storage resource so scheduling does not take this aspect into account. Spot checking the disk usage on some pods it seems that the hdb container are consuming at least ~10GB. Usually, there are 5 pods running on each node so it seems that we can easily reach and exceed the allocatable space.&lt;/p&gt;

&lt;p&gt;In order to overcome the errors, we have various options:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Define resource request/limits for ephemeral storage to avoid scheduling pods on nodes with insufficient resources and stop pods/tests that are behaving badly from affecting good runs.&lt;/li&gt;
	&lt;li&gt;Increase the disk space for the nodes in the GKE cluster that will likely also increase the overall cost of each precommit run.&lt;/li&gt;
	&lt;li&gt;Decrease the disk space consumed by test execution by tuning logs, output, etc.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;In the context, of this ticket we should rather focus on option 1 and 2. Option 3, can be considered an independent improvement that needs careful investigation and analysis that has little to do with the CI infrastructure.&lt;/p&gt;</comment>
                            <comment id="17955238" author="zabetak" created="Fri, 30 May 2025 14:50:23 +0000"  >&lt;p&gt;Reviewing the observability charts of the GKE cluster shows that the &lt;b&gt;ephemeral storage used&lt;/b&gt; divided by &lt;b&gt;ephemeral storage allocatable&lt;/b&gt; quite often exceeds 100%. In the last 100 days (Feb 2025 to May 2025) the ephemeral storage has many times grown close to 150% of the allocatable space.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13076766/13076766_ephemeral-storage-usage-feb2025-may2025.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Those that have access to the GKE cloud infrastructure can check the ephemeral storage usage using the &lt;a href=&quot;https://console.cloud.google.com/monitoring/metrics-explorer;duration=P100D?pageState=%7B%22xyChart%22:%7B%22constantLines%22:%5B%5D,%22dataSets%22:%5B%7B%22plotType%22:%22LINE%22,%22pointConnectionMethod%22:%22GAP_DETECTION%22,%22targetAxis%22:%22Y1%22,%22timeSeriesQuery%22:%22fetch%20k8s_node%5Cn%7C%20filter%20(resource.project_id%20%3D%3D%20&amp;#39;gcp-hive-upstream&amp;#39;)%5Cn%7C%20filter%20(resource.cluster_name%20%3D%3D%20&amp;#39;hive-test-kube&amp;#39;)%5Cn%7C%20filter%20(resource.location%20%3D%3D%20&amp;#39;us-central1-c&amp;#39;)%5Cn%7C%20%7B%20metric%20kubernetes.io%2Fnode%2Fephemeral_storage%2Fused_bytes%5Cn%7C%20every%201m%5Cn%7C%20align%20next_older(2m)%5Cn%3B%20metric%20kubernetes.io%2Fnode%2Fephemeral_storage%2Fallocatable_bytes%5Cn%7C%20every%201m%5Cn%7C%20align%20next_older(2m)%20%7D%5Cn%7C%20group_by%20%5Bresource.cluster_name%5D,%20.sum()%5Cn%7C%20ratio%5Cn%7C%20scale%20%5C%22%25%5C%22%22,%22unitOverride%22:%22%22%7D%5D,%22options%22:%7B%22mode%22:%22COLOR%22%7D,%22y1Axis%22:%7B%22label%22:%22%22,%22scale%22:%22LINEAR%22%7D%7D%7D&amp;amp;project=gcp-hive-upstream&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;following link&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The ephemeral storage for a node can also be tracked via the Metrics API:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-bash&quot;&gt;
kubectl get --raw &lt;span class=&quot;code-quote-red&quot;&gt;&quot;/api/v1/nodes/gke-hive-test-kube-slave-pool9-bbcf4d84-p5kk/proxy/stats/summary&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and the information collected from there also confirms that the used ephemeral storage is rather high for the allocatable capacity.&lt;/p&gt;

&lt;p&gt;It is also possible to ssh to the respective GKE node and use the standard du/df commands to gather more specific information about the storage space.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-bash&quot;&gt;
gcloud compute ssh gke-hive-test-kube-slave-pool9-bbcf4d84-p5kk
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To keep the cluster in a healthy state the ephemeral storage usage should not exceed the allocatable capacity so ideally the used/allocatable percentage should be under 100% most of the time. Currently, the total disk capacity for each node in the GKE cluster is 100GB so I will bump this up to 160GB and this hopefully will be enough to keep the ephemeral storage inside the allocatable limits. This will increase the storage cost for each precommit run but based on the current prices the expected increase should be somewhere between 50-100$/month which is a rather small percentage of the total cost of the precommit infra. &lt;/p&gt;

&lt;p&gt;I run the following command to increase the total disk capacity to 160GB on the slave-pool9 node pool that is used for the pods that are running the tests&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;gcloud container node-pools update slave-pool9 --cluster hive-test-kube --disk-size 160 --zone us-central1-c
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;More details about the update command can be found in the following link:&lt;br/&gt;
&lt;a href=&quot;https://cloud.google.com/sdk/gcloud/reference/container/node-pools/update&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cloud.google.com/sdk/gcloud/reference/container/node-pools/update&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The changes are now in effect. I will now monitor the GKE cluster and update this ticket in a few weeks with respect to disk usage and cost.&lt;/p&gt;</comment>
                            <comment id="17955859" author="zabetak" created="Tue, 3 Jun 2025 11:20:05 +0000"  >&lt;p&gt;Inspecting the disk usage (grep &quot;df -h&quot; -B 1) in recent precommit runs on &lt;a href=&quot;https://ci.hive.apache.org/job/hive-precommit/job/master/2540/consoleText&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;master branch&lt;/a&gt; it seems that the HDB containers consumes between 7.2Gi and 14Gi of (ephemeral) disk space while running the tests. This space amounts to code, git metadata, build artifacts, logs, test reports, etc., that are under the Hive build directory. The container will also store other information outside the project dir so we should assume that there is some extra ephemeral space required for each run.&lt;/p&gt;

&lt;p&gt;Taking this into account we can set some ephemeral storage request and limits for the HDB container to allow for better scheduling of the pods in the GKE cluster and also guard against malfunctioning PRs/pods from affecting the overall health of the cluster. Based on the current disk usage and cluster capacity we can set the request to 10Gi and the limit to 20Gi. This change is implemented in &lt;a href=&quot;https://github.com/apache/hive/pull/5840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR#5840&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17985278" author="abstractdog" created="Mon, 23 Jun 2025 10:21:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zabetak&quot; class=&quot;user-hover&quot; rel=&quot;zabetak&quot;&gt;zabetak&lt;/a&gt;: this investigation along with the detailed documentation is huge!&lt;/p&gt;</comment>
                            <comment id="17985887" author="zabetak" created="Tue, 24 Jun 2025 14:17:58 +0000"  >&lt;p&gt;Fixed with &lt;a href=&quot;https://github.com/apache/hive/commit/32eedb2a29a855daaa805b4365b42848a66b1282&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/commit/32eedb2a29a855daaa805b4365b42848a66b1282&lt;/a&gt; and other changes as described above!&lt;/p&gt;</comment>
                            <comment id="17985891" author="zabetak" created="Tue, 24 Jun 2025 14:25:41 +0000"  >&lt;p&gt;I just checked the GKE observability metrics regarding the ephemeral storage usage in the last 45 days and since the increase of the disk size to 160GB on May 30, 2025, it is steadily below 100% so everything runs smoothly at the moment.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13077203/13077203_ephemeral-storage-usage-may12-jun24-2025.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13622918">HIVE-29081</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13617986">HIVE-28955</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13619909">HIVE-28989</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13076766" name="ephemeral-storage-usage-feb2025-may2025.png" size="630276" author="zabetak" created="Fri, 30 May 2025 08:30:35 +0000"/>
                            <attachment id="13077203" name="ephemeral-storage-usage-may12-jun24-2025.png" size="351339" author="zabetak" created="Tue, 24 Jun 2025 14:25:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            20 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1vtsw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>