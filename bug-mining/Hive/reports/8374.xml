<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:23:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-26632] Update DelegationTokenSecretManager current key ID to prevent erroneous database updates.</title>
                <link>https://issues.apache.org/jira/browse/HIVE-26632</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;While rolling a new master key, &lt;tt&gt;TokenStoreDelegationTokenSecretManager&lt;/tt&gt; does not update a base class member variable that tracks the current key ID. This can cause situations later where it attempts to update a key using an incorrect ID. This update attempt fails, even though the process had successfully generated a new master key. Since it appears to be a failure though, the thread immediately attempts to roll a new master key again, resulting in excess database load.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13486408">HIVE-26632</key>
            <summary>Update DelegationTokenSecretManager current key ID to prevent erroneous database updates.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cnauroth">Chris Nauroth</assignee>
                                    <reporter username="cnauroth">Chris Nauroth</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 14 Oct 2022 22:06:21 +0000</created>
                <updated>Tue, 15 Aug 2023 06:33:19 +0000</updated>
                            <resolved>Wed, 26 Oct 2022 11:51:40 +0000</resolved>
                                                    <fixVersion>4.0.0-beta-1</fixVersion>
                                    <component>Standalone Metastore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4200">1h 10m</timespent>
                                <comments>
                            <comment id="17617980" author="cnauroth" created="Fri, 14 Oct 2022 22:06:48 +0000"  >&lt;p&gt;Update DelegationTokenSecretManager current key ID to prevent erroneous database updates.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;TokenStoreDelegationTokenSecretManager#logUpdateMasterKey&lt;/tt&gt;, used in combination with &lt;tt&gt;DBTokenStore&lt;/tt&gt;, inserts a new master key to the &lt;tt&gt;MASTER_KEYS&lt;/tt&gt; table. The serialized &lt;tt&gt;DelegationKey&lt;/tt&gt; stored in the &lt;tt&gt;MASTER_KEY&lt;/tt&gt; column initially will contain an ID with the value of the base class member &lt;tt&gt;AbstractDelegationTokenSecretManager#currentId&lt;/tt&gt;. For example, for a freshly started HiveMetaStore process, this will use a value of 1. Then, there is a second update performed on the database row, setting a new serialized &lt;tt&gt;DelegationKey&lt;/tt&gt; with an ID that matches the value of the auto-incrementing &lt;tt&gt;KEY_ID&lt;/tt&gt; column. Note that this method does not update &lt;tt&gt;AbstractDelegationTokenSecretManager#currentId&lt;/tt&gt; for agreement with the new key ID.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;TokenStoreDelegationTokenSecretManager#rollMasterKeyExt&lt;/tt&gt; scans all rows in &lt;tt&gt;MASTER_KEYS&lt;/tt&gt;. If it finds a serialized &lt;tt&gt;MASTER_KEY&lt;/tt&gt; with an ID that matches its current value for &lt;tt&gt;AbstractDelegationTokenSecretManager#currentId&lt;/tt&gt;, then it will update the database row.&lt;/p&gt;

&lt;p&gt;We have observed a race condition while running multiple HiveMetaStore instances sharing the same database. The steps performed in &lt;tt&gt;logUpdateMasterKey&lt;/tt&gt; are not transactional. It&apos;s possible that &lt;tt&gt;rollMasterKeyExt&lt;/tt&gt; running in HiveMetaStore A scans a newly inserted row from &lt;tt&gt;logUpdateMasterKey&lt;/tt&gt; running in HiveMetaStore B that has not had the ID updated to the correct value yet. If that ID matches the &lt;tt&gt;currentId&lt;/tt&gt; in HiveMetaStore A, then it will attempt to update, but the ID in the update query won&apos;t match any row&apos;s &lt;tt&gt;KEY_ID&lt;/tt&gt;. The update fails with an exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2022-08-03T00:09:48,744 ERROR [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-9,5,main]] thrift.TokenStoreDelegationTokenSecretManager: ExpiredTokenRemover thread received unexpected exception. org.apache.hadoop.hive.thrift.DelegationTokenStore$TokenStoreException: NoSuchObjectException(message:No key found with keyId: 1)
org.apache.hadoop.hive.thrift.DelegationTokenStore$TokenStoreException: NoSuchObjectException(message:No key found with keyId: 1)
	at org.apache.hadoop.hive.thrift.DBTokenStore.invokeOnTokenStore(DBTokenStore.java:170) ~[hive-exec-2.3.7.jar:2.3.7]
	at org.apache.hadoop.hive.thrift.DBTokenStore.updateMasterKey(DBTokenStore.java:51) ~[hive-exec-2.3.7.jar:2.3.7]
	at org.apache.hadoop.hive.thrift.TokenStoreDelegationTokenSecretManager.rollMasterKeyExt(TokenStoreDelegationTokenSecretManager.java:269) ~[hive-exec-2.3.7.jar:2.3.7]
	at org.apache.hadoop.hive.thrift.TokenStoreDelegationTokenSecretManager$ExpiredTokenRemover.run(TokenStoreDelegationTokenSecretManager.java:301) [hive-exec-2.3.7.jar:2.3.7]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748) [?:1.8.0_312]
Caused by: org.apache.hadoop.hive.metastore.api.NoSuchObjectException: No key found with keyId: 1
	at org.apache.hadoop.hive.metastore.ObjectStore.updateMasterKey(ObjectStore.java:7727) ~[hive-exec-2.3.7.jar:2.3.7]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When this exception happens, &lt;tt&gt;ExpiredTokenRemoverThread&lt;/tt&gt; will not update &lt;tt&gt;lastMasterKeyUpdate&lt;/tt&gt;, so it immediately tries again to create a new master key, causing increased database load and extraneous rows in the &lt;tt&gt;MASTER_KEYS&lt;/tt&gt; table.&lt;/p&gt;

&lt;p&gt;This problem can be prevented if &lt;tt&gt;logUpdateMasterKey&lt;/tt&gt; also updates the base class &lt;tt&gt;currentId&lt;/tt&gt; to the correct ID value.&lt;/p&gt;</comment>
                            <comment id="17617984" author="cnauroth" created="Fri, 14 Oct 2022 22:21:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yigress&quot; class=&quot;user-hover&quot; rel=&quot;yigress&quot;&gt;yigress&lt;/a&gt; , &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vinayakumarb&quot; class=&quot;user-hover&quot; rel=&quot;vinayakumarb&quot;&gt;vinayakumarb&lt;/a&gt; , FYI.&lt;/p&gt;</comment>
                            <comment id="17624397" author="ayushtkn" created="Wed, 26 Oct 2022 11:51:28 +0000"  >&lt;p&gt;Committed to master.&lt;/p&gt;

&lt;p&gt;Thanx &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; for the contribution and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dengzh&quot; class=&quot;user-hover&quot; rel=&quot;dengzh&quot;&gt;dengzh&lt;/a&gt; for the review!!!&lt;/p&gt;</comment>
                            <comment id="17624614" author="cnauroth" created="Wed, 26 Oct 2022 16:54:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ayushtkn&quot; class=&quot;user-hover&quot; rel=&quot;ayushtkn&quot;&gt;ayushtkn&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dengzh&quot; class=&quot;user-hover&quot; rel=&quot;dengzh&quot;&gt;dengzh&lt;/a&gt;, thank you both!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 3 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z19dyg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12343559">3.2.0</customfieldvalue>
    <customfieldvalue id="12351489">4.0.0-alpha-2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>