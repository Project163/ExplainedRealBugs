<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:28:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-8808] HiveInputFormat caching cannot work with all input formats</title>
                <link>https://issues.apache.org/jira/browse/HIVE-8808</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;In &lt;tt&gt;HiveInputFormat&lt;/tt&gt; we implement instance caching (see &lt;tt&gt;getInputFormatFromCache&lt;/tt&gt;). In HS2, this assumes that InputFormats are stateless but I don&apos;t think this assumption is true, especially with regards to HBase.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12754255">HIVE-8808</key>
            <summary>HiveInputFormat caching cannot work with all input formats</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brocknoland">Brock Noland</assignee>
                                    <reporter username="brocknoland">Brock Noland</reporter>
                        <labels>
                    </labels>
                <created>Mon, 10 Nov 2014 21:35:06 +0000</created>
                <updated>Tue, 20 Feb 2018 05:02:09 +0000</updated>
                            <resolved>Wed, 19 Nov 2014 00:31:39 +0000</resolved>
                                                    <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14205366" author="brocknoland" created="Mon, 10 Nov 2014 21:37:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ndimiduk&quot; class=&quot;user-hover&quot; rel=&quot;ndimiduk&quot;&gt;ndimiduk&lt;/a&gt; would you agree that HBase input formats are not stateless?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sushanth&quot; class=&quot;user-hover&quot; rel=&quot;sushanth&quot;&gt;sushanth&lt;/a&gt; you&apos;ve done work with the formats. Your thoughts?&lt;/p&gt;</comment>
                            <comment id="14206979" author="ndimiduk" created="Tue, 11 Nov 2014 20:12:35 +0000"  >&lt;p&gt;Yes, it looks like our input formats are stateful. We&apos;re set up to specify a config object and that&apos;s closed over to provide custom record readers, based on which mapred API is being implemented.&lt;/p&gt;</comment>
                            <comment id="14206983" author="ndimiduk" created="Tue, 11 Nov 2014 20:14:53 +0000"  >&lt;p&gt;FYI, this may be changing with HBase 1.0 as we&apos;re reworking the way connection management is handled. I&apos;m behind on my reviews, so I don&apos;t know if this assumption will change.&lt;/p&gt;</comment>
                            <comment id="14207095" author="sushanth" created="Tue, 11 Nov 2014 21:23:55 +0000"  >&lt;p&gt;From a strict M/R standpoint:&lt;/p&gt;

&lt;p&gt;Traditional M/R guarantees state information availability to InputFormats through JobConf, and through serialized InputSplits. Any expectation past that by the InputFormat is not guaranteed to work. Practically, though, M/R does not standardize a setInput equivalent call, and thus, InputFormats wind up implementing their own methodologies. It is not unheard of for them to maintain state.&lt;/p&gt;

&lt;p&gt;In practice also, though, we absolutely need to have a standardization, to be able to access it from Hive/HCatalog. HCatalog took a route where it said that InputFormats, as currently defined are not well-specified enough to be able to do all the setup needed to be effectively stateless, and so, relegated that notion upwards, (in earlier versions of HCatalog to something called StorageDriver, but as of HCat 0.3, replaced with Hive&apos;s StorageHandler) to StorageHandlers, HCat&apos;s primary storage abstraction. While the InputFormat is itself considered stateless, a StorageHandler is considered stateful, and HCat does the following:&lt;/p&gt;

&lt;p&gt;a) Instantiate the appropriate StorageHandler using ReflectionUtils.newInstance   (will call setConf if available, and usually is)&lt;br/&gt;
b) Call configureInputJobProperties() on that StorageHandler to set it up for input, and it modifies a map of key value properties (jobProperties) that HCat ensures that it will put into JobConf/Job before calling any methods on the relevant InputFormat.&lt;br/&gt;
c) Call .getInputFormatClass,  that class eventually gets instantiated at run time with ReflectionUtils.newInstance(inputFormatClass, Job). Now, this allows the InputFormat to set up the Job (which already had the above map of kvps inserted into it) any which way it wants, without itself being stateful.&lt;br/&gt;
d) Call .getInputSplits, again passing in the relevant JobConf as the state-carrier into it, and the InputSplits themselves being a serializable state carrier on the outbound.&lt;br/&gt;
e) Call .createRecordReader on that InputFormat, again, the InputFormat itself can(and is) stateless, but gets passed in an InputSplit(has state) and a TaskAttemptContext (has state, with the above jobProperties map)&lt;/p&gt;</comment>
                            <comment id="14207154" author="brocknoland" created="Tue, 11 Nov 2014 21:53:47 +0000"  >&lt;p&gt;Thank you. I am thinking until the HBase input format is &quot;fixed&quot; we should either remove this cache entirely or not cache HBase input formats. Which do you prefer?&lt;/p&gt;</comment>
                            <comment id="14207169" author="sushanth" created="Tue, 11 Nov 2014 22:06:26 +0000"  >&lt;p&gt;+cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=elserj&quot; class=&quot;user-hover&quot; rel=&quot;elserj&quot;&gt;elserj&lt;/a&gt; for an accumulo perspective on this.&lt;/p&gt;

&lt;p&gt;My personal preference is that in getInputFormatFromCache, if we detect that the class is a hbase input format, then we return new instance and not populate the cache. I did something similar recently in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-8704&quot; title=&quot;HivePassThroughOutputFormat cannot proxy more than one kind of OF (in one process)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-8704&quot;&gt;&lt;del&gt;HIVE-8704&lt;/del&gt;&lt;/a&gt; for the output side for PTOF-based outputformats.&lt;/p&gt;</comment>
                            <comment id="14207183" author="elserj" created="Tue, 11 Nov 2014 22:15:00 +0000"  >&lt;p&gt;Thanks for looping me in, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sushanth&quot; class=&quot;user-hover&quot; rel=&quot;sushanth&quot;&gt;sushanth&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;As far as I can recall, Accumulo&apos;s InputFormat classes are stateless, relying on the state to be provided through the JobConf/InputSplits as you described. I know we have some &quot;annoyances&quot; where multiple calls to the InputFormat which alter the JobConf are not idempotent (they typically throw an error if things are re-set). I work around most of that pain in the StorageHandler impl.&lt;/p&gt;

&lt;p&gt;Nothing is coming to mind that would be fundamentally broken if we get a re-used instance of the input format. HTH test/evaluate this too.&lt;/p&gt;</comment>
                            <comment id="14207289" author="brocknoland" created="Tue, 11 Nov 2014 23:03:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;re-used instance of the input format.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Re-used is different than &quot;thread safe&quot;. Is the Accumulo support thread-safe?&lt;/p&gt;</comment>
                            <comment id="14209547" author="hiveqa" created="Thu, 13 Nov 2014 09:51:25 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12681162/HIVE-8808.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12681162/HIVE-8808.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 15 failed/errored test(s), 6686 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_udaf_histogram_numeric
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver_external_table_ppd
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver_hbase_binary_external_table_queries
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver_hbase_binary_map_queries
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver_hbase_binary_map_queries_prefix
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver_hbase_binary_storage_queries
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver_hbase_joins
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver_hbase_ppd_join
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver_hbase_ppd_key_range
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver_hbase_pushdown
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver_hbase_queries
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver_hbase_single_sourced_multi_insert
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver_hbase_timestamp
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver_ppd_key_ranges
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_optimize_nullscan
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1768/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1768/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1768/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1768/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-1768/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-1768/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 15 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12681162 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14213387" author="hiveqa" created="Sat, 15 Nov 2014 05:50:22 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12681651/HIVE-8808.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12681651/HIVE-8808.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 6688 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1800/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1800/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1800/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1800/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-1800/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-1800/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12681651 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14214859" author="brocknoland" created="Mon, 17 Nov 2014 17:15:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sushanth&quot; class=&quot;user-hover&quot; rel=&quot;sushanth&quot;&gt;sushanth&lt;/a&gt; can you take a peek at this one?&lt;/p&gt;</comment>
                            <comment id="14215297" author="sushanth" created="Mon, 17 Nov 2014 22:21:20 +0000"  >&lt;p&gt;+1, Looks good to me.&lt;/p&gt;</comment>
                            <comment id="14217137" author="sushanth" created="Wed, 19 Nov 2014 00:31:39 +0000"  >&lt;p&gt;Committed to trunk. Thanks, Brock!&lt;/p&gt;</comment>
                            <comment id="16369718" author="davelatham" created="Tue, 20 Feb 2018 04:55:01 +0000"  >&lt;p&gt;Bumped into this problem with another input format that wrapped an hbase input format.&#160; The wrapper did not have hbase in its name.&lt;/p&gt;

&lt;p&gt;I&apos;ve gotta ask, though:&#160; What&apos;s the purpose of caching a stateless object?&lt;/p&gt;

&lt;p&gt;If M/R supports calling setConf as part of the instantiation system, that seems intended to initialize state.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Other examples of stateful input formats broken by the caching:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/cloudera/kudu/blob/master/java/kudu-mapreduce/src/main/java/org/apache/kudu/mapreduce/KuduTableInputFormat.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cloudera/kudu/blob/master/java/kudu-mapreduce/src/main/java/org/apache/kudu/mapreduce/KuduTableInputFormat.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/twitter/elephant-bird/blob/master/core/src/main/java/com/twitter/elephantbird/mapred/input/DeprecatedInputFormatWrapper.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/twitter/elephant-bird/blob/master/core/src/main/java/com/twitter/elephantbird/mapred/input/DeprecatedInputFormatWrapper.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/hanborq/hadoop/blob/master/src/mapred/org/apache/hadoop/mapreduce/lib/db/DBInputFormat.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hanborq/hadoop/blob/master/src/mapred/org/apache/hadoop/mapreduce/lib/db/DBInputFormat.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12681651" name="HIVE-8808.patch" size="1644" author="brocknoland" created="Fri, 14 Nov 2014 23:36:37 +0000"/>
                            <attachment id="12681162" name="HIVE-8808.patch" size="1073" author="brocknoland" created="Wed, 12 Nov 2014 22:25:57 +0000"/>
                            <attachment id="12681161" name="HIVE-8808.patch" size="999" author="brocknoland" created="Wed, 12 Nov 2014 22:24:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 39 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22787:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>