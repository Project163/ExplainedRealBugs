<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:25:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-27876] Incorrect query results on tables with ClusterBy &amp; SortBy</title>
                <link>https://issues.apache.org/jira/browse/HIVE-27876</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Repro:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
create external table test_bucket(age &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, name string, dept string) clustered by (age, name) sorted by (age asc, name asc) into 2 buckets stored as orc;
insert into test_bucket values (1, &lt;span class=&quot;code-quote&quot;&gt;&apos;user1&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;dept1&apos;&lt;/span&gt;), ( 2, &lt;span class=&quot;code-quote&quot;&gt;&apos;user2&apos;&lt;/span&gt; , &lt;span class=&quot;code-quote&quot;&gt;&apos;dept2&apos;&lt;/span&gt;);
insert into test_bucket values (1, &lt;span class=&quot;code-quote&quot;&gt;&apos;user1&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;dept1&apos;&lt;/span&gt;), ( 2, &lt;span class=&quot;code-quote&quot;&gt;&apos;user2&apos;&lt;/span&gt; , &lt;span class=&quot;code-quote&quot;&gt;&apos;dept2&apos;&lt;/span&gt;);

&lt;span class=&quot;code-comment&quot;&gt;//empty wrong results
&lt;/span&gt;select age, name, count(*) from test_bucket group by &#160;age, name having count(*) &amp;gt; 1; 
+------+-------+------+
| age &#160;| name &#160;| _c2 &#160;|
+------+-------+------+
+------+-------+------+

&lt;span class=&quot;code-comment&quot;&gt;// Workaround
&lt;/span&gt;set hive.map.aggr=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
select age, name, count(*) from test_bucket group by &#160;age, name having count(*) &amp;gt; 1; 
+------+--------+------+
| age &#160;| &#160;name &#160;| _c2 &#160;|
+------+--------+------+
| 1 &#160; &#160;| user1 &#160;| 2 &#160; &#160;|
| 2 &#160; &#160;| user2 &#160;| 2 &#160; &#160;|
+------+--------+------+ &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13558133">HIVE-27876</key>
            <summary>Incorrect query results on tables with ClusterBy &amp; SortBy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rameshkumar">Ramesh Kumar Thangarajan</assignee>
                                    <reporter username="nareshpr">Naresh P R</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 15 Nov 2023 22:43:27 +0000</created>
                <updated>Fri, 29 Mar 2024 17:49:50 +0000</updated>
                            <resolved>Wed, 20 Dec 2023 09:04:17 +0000</resolved>
                                                    <fixVersion>4.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17788031" author="kkasa" created="Mon, 20 Nov 2023 14:06:47 +0000"  >&lt;p&gt;The query in the description has a plan:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
POSTHOOK: query: explain
select age, name, count(*) from test_bucket group by  age, name having count(*) &amp;gt; 1
POSTHOOK: type: QUERY
POSTHOOK: Input: &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@test_bucket
#### A masked pattern was here ####
STAGE DEPENDENCIES:
  Stage-0 is a root stage

STAGE PLANS:
  Stage: Stage-0
    Fetch Operator
      limit: -1
      Processor Tree:
        TableScan
          alias: test_bucket
          Select Operator
            expressions: age (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;), name (type: string)
            outputColumnNames: age, name
            Group By Operator
              aggregations: count()
              keys: age (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;), name (type: string)
              mode: &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt;
              outputColumnNames: _col0, _col1, _col2
              Filter Operator
                predicate: (_col2 &amp;gt; 1L) (type: &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;)
                ListSink
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this case 2 bucket files are created. Both are sorted but only at file level. The records are fetched this order by FetchOperator &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
1	user1	dept1
2	user2	dept2
1	user1	dept1
2	user2	dept2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Data is not sorted globally and group by operator treats all &lt;tt&gt;age, name&lt;/tt&gt; column values as distinct values hence &lt;tt&gt;count( * )&lt;/tt&gt; is 1 for all the key values then Filter operator filters out all records.&lt;/p&gt;

&lt;p&gt;Possible workaround to turn off map side group by optimization&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/hive/blob/feda35389dc28c8c9bf3c8a3d39de53ba90e41c0/common/src/java/org/apache/hadoop/hive/conf/HiveConf.java#L2019-L2022&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/feda35389dc28c8c9bf3c8a3d39de53ba90e41c0/common/src/java/org/apache/hadoop/hive/conf/HiveConf.java#L2019-L2022&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
set hive.map.groupby.sorted=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17788476" author="rameshkumar" created="Tue, 21 Nov 2023 16:31:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkasa&quot; class=&quot;user-hover&quot; rel=&quot;kkasa&quot;&gt;kkasa&lt;/a&gt; I was looking into fixing this. But I had 2 questions to think about:&lt;br/&gt;
1. Should we expect the data to be bucketed and sorted globally after the inserts? Because if all the 4 rows are inserted in the table in a single statement query like below, then I guess the optimization works fine.&lt;br/&gt;
insert into test_bucket values (1, &apos;user1&apos;, &apos;dept1&apos;), ( 2, &apos;user2&apos; , &apos;dept2&apos;), (1, &apos;user1&apos;, &apos;dept1&apos;), ( 2, &apos;user2&apos; , &apos;dept2&apos;);&lt;br/&gt;
2. Having map side group by is still useful even if the data is sorted locally within a bucket, it is only a problem when we remove the ReduceSinkOperator. In that case, can we just skip removing ReduceSinkOperator as part of the optimization. Will we still get any real improvements as part of this optimization(even after skipping to remove ReduceSinkOperator)?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17789045" author="kkasa" created="Thu, 23 Nov 2023 09:59:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rameshkumar&quot; class=&quot;user-hover&quot; rel=&quot;rameshkumar&quot;&gt;rameshkumar&lt;/a&gt;&lt;br/&gt;
1. Based on cwiki sort by ensures the record order at bucket file level.&lt;br/&gt;
&lt;a href=&quot;https://cwiki.apache.org/confluence/display/hive/languagemanual+ddl&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/hive/languagemanual+ddl&lt;/a&gt;&lt;br/&gt;
Another page shares more details&lt;br/&gt;
&lt;a href=&quot;https://cwiki.apache.org/confluence/display/Hive/LanguageManual+SortBy#LanguageManualSortBy-DifferencebetweenSortByandOrderBy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/Hive/LanguageManual+SortBy#LanguageManualSortBy-DifferencebetweenSortByandOrderBy&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;When inserting all records using one insert statement only one bucket file is created so global order matches the record order in that singe file.&lt;/p&gt;

&lt;p&gt;2. The goal of this optimization is to remove the RS because shuffle takes most of the execution time.&lt;br/&gt;
Group by can distribute key values two ways&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;using a hash table. It has limitations (memory).&lt;/li&gt;
	&lt;li&gt;the data is sorted by the group by keys. This is ensured by the RS.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;IIUC The optimization assumes if the physical order of the records in the table matches the group by needs then the RS can be removed. However it relies on the bucketing keys which according to 1) and also by the repro in description it doesn&apos;t ensures global ordering of the data.&lt;/p&gt;</comment>
                            <comment id="17789050" author="kkasa" created="Thu, 23 Nov 2023 10:10:17 +0000"  >&lt;p&gt;I found another data correctness issue regarding this optimization:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
create table test_bucket(age &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, name string, dept string) clustered by (age) sorted by (age asc) into 2 buckets stored as orc;

insert into test_bucket values (10, &lt;span class=&quot;code-quote&quot;&gt;&apos;user1&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;dept1&apos;&lt;/span&gt;), (10, &lt;span class=&quot;code-quote&quot;&gt;&apos;user2&apos;&lt;/span&gt; , &lt;span class=&quot;code-quote&quot;&gt;&apos;dept2&apos;&lt;/span&gt;), ( 2, &lt;span class=&quot;code-quote&quot;&gt;&apos;user2&apos;&lt;/span&gt; , &lt;span class=&quot;code-quote&quot;&gt;&apos;dept2&apos;&lt;/span&gt;);
insert into test_bucket values (1, &lt;span class=&quot;code-quote&quot;&gt;&apos;user1&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;dept1&apos;&lt;/span&gt;), ( 2, &lt;span class=&quot;code-quote&quot;&gt;&apos;user2&apos;&lt;/span&gt; , &lt;span class=&quot;code-quote&quot;&gt;&apos;dept2&apos;&lt;/span&gt;);

select * from test_bucket;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Order is not global:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2	user2	dept2
10	user1	dept1
10	user2	dept2
2	user2	dept2
1	user1	dept1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select age, count(*) from test_bucket group by age;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Records with key &lt;tt&gt;age = 2&lt;/tt&gt; are not aggregated:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2	1
10	2
2	1
1	1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;First insert creates one file:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
itests/qtest/target/localfs/warehouse/test_bucket/000000_0
{&lt;span class=&quot;code-quote&quot;&gt;&quot;age&quot;&lt;/span&gt;:2,&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;user2&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;dept&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;dept2&quot;&lt;/span&gt;}
{&lt;span class=&quot;code-quote&quot;&gt;&quot;age&quot;&lt;/span&gt;:10,&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;user1&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;dept&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;dept1&quot;&lt;/span&gt;}
{&lt;span class=&quot;code-quote&quot;&gt;&quot;age&quot;&lt;/span&gt;:10,&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;user2&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;dept&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;dept2&quot;&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Second insert creates 2 files:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
itests/qtest/target/localfs/warehouse/test_bucket/000000_0_copy_1
{&lt;span class=&quot;code-quote&quot;&gt;&quot;age&quot;&lt;/span&gt;:2,&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;user2&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;dept&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;dept2&quot;&lt;/span&gt;}

itests/qtest/target/localfs/warehouse/test_bucket/000001_0
{&lt;span class=&quot;code-quote&quot;&gt;&quot;age&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;user1&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;dept&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;dept1&quot;&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17798875" author="kkasa" created="Wed, 20 Dec 2023 09:04:17 +0000"  >&lt;p&gt;Megred to master. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rameshkumar&quot; class=&quot;user-hover&quot; rel=&quot;rameshkumar&quot;&gt;rameshkumar&lt;/a&gt; for the patch and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aturoczy&quot; class=&quot;user-hover&quot; rel=&quot;aturoczy&quot;&gt;aturoczy&lt;/a&gt; for review.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 47 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1lmwg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>