<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:14:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-6021] Problem in GroupByOperator for handling distinct aggrgations</title>
                <link>https://issues.apache.org/jira/browse/HIVE-6021</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Use the following test case with HIVE 0.12:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt; src(&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;);
&lt;span class=&quot;code-keyword&quot;&gt;load&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;local&lt;/span&gt; inpath &lt;span class=&quot;code-quote&quot;&gt;&apos;src/&lt;span class=&quot;code-keyword&quot;&gt;data&lt;/span&gt;/files/kv1.txt&apos;&lt;/span&gt; overwrite &lt;span class=&quot;code-keyword&quot;&gt;into&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt; src;
&lt;span class=&quot;code-keyword&quot;&gt;set&lt;/span&gt; hive.&lt;span class=&quot;code-keyword&quot;&gt;map&lt;/span&gt;.aggr=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;; 
&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;count&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;),&lt;span class=&quot;code-keyword&quot;&gt;count&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;distinct&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; src &lt;span class=&quot;code-keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We will get an ArrayIndexOutOfBoundsException from GroupByOperator:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.RuntimeException: Error in configuring object
	at org.apache.hadoop.util.ReflectionUtils.setJobConf(ReflectionUtils.java:93)
	at org.apache.hadoop.util.ReflectionUtils.setConf(ReflectionUtils.java:64)
	at org.apache.hadoop.util.ReflectionUtils.newInstance(ReflectionUtils.java:117)
	at org.apache.hadoop.mapred.ReduceTask.runOldReducer(ReduceTask.java:485)
	at org.apache.hadoop.mapred.ReduceTask.run(ReduceTask.java:420)
	at org.apache.hadoop.mapred.LocalJobRunner$Job.run(LocalJobRunner.java:260)
Caused by: java.lang.reflect.InvocationTargetException
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at java.lang.reflect.Method.invoke(Method.java:597)
	at org.apache.hadoop.util.ReflectionUtils.setJobConf(ReflectionUtils.java:88)
	... 5 more
Caused by: java.lang.RuntimeException: Reduce &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; initialization failed
	at org.apache.hadoop.hive.ql.exec.mr.ExecReducer.configure(ExecReducer.java:159)
	... 10 more
Caused by: java.lang.ArrayIndexOutOfBoundsException: 1
	at org.apache.hadoop.hive.ql.exec.GroupByOperator.initializeOp(GroupByOperator.java:281)
	at org.apache.hadoop.hive.ql.exec.Operator.initialize(Operator.java:377)
	at org.apache.hadoop.hive.ql.exec.mr.ExecReducer.configure(ExecReducer.java:152)
	... 10 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;explain select count(key),count(distinct value) from src group by key;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;STAGE PLANS:
  Stage: Stage-1
    Map Reduce
      Alias -&amp;gt; Map Operator Tree:
        src 
          TableScan
            alias: src
            Select Operator
              expressions:
                    expr: key
                    type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
                    expr: value
                    type: string
              outputColumnNames: key, value
              Reduce Output Operator
                key expressions:
                      expr: key
                      type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
                      expr: value
                      type: string
                sort order: ++
                Map-reduce partition columns:
                      expr: key
                      type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
                tag: -1
      Reduce Operator Tree:
        Group By Operator
          aggregations:
                expr: count(KEY._col0)   &lt;span class=&quot;code-comment&quot;&gt;// The parameter causes &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; problem
&lt;/span&gt;                           ^^^^^^^^^^^                
                expr: count(DISTINCT KEY._col1:0._col0)
          bucketGroup: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
          keys:
                expr: KEY._col0
                type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
          mode: complete
          outputColumnNames: _col0, _col1, _col2
          Select Operator
            expressions:
                  expr: _col1
                  type: bigint
                  expr: _col2
                  type: bigint
            outputColumnNames: _col0, _col1
            File Output Operator
              compressed: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
              GlobalTableId: 0
              table:
                  input format: org.apache.hadoop.mapred.TextInputFormat
                  output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat

  Stage: Stage-0
    Fetch Operator
      limit: -1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The root cause is within GroupByOperator.initializeOp(). The method forgets to handle the case:&lt;br/&gt;
For a query has distinct aggregations, there is an aggregation function has a parameter which is a groupby key column but not distinct key column.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (unionExprEval != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
          &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] names = parameters.get(j).getExprString().split(&lt;span class=&quot;code-quote&quot;&gt;&quot;\\.&quot;&lt;/span&gt;);
          &lt;span class=&quot;code-comment&quot;&gt;// parameters of the form : KEY.colx:t.coly
&lt;/span&gt;          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (Utilities.ReduceField.KEY.name().equals(names[0])) {
            &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name = names[names.length - 2];
            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; tag = &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.parseInt(name.split(&lt;span class=&quot;code-quote&quot;&gt;&quot;\\:&quot;&lt;/span&gt;)[1]);
            
            ...
            
          } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-comment&quot;&gt;// will be VALUE._COLx
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!nonDistinctAggrs.contains(i)) {
              nonDistinctAggrs.add(i);
            }
          }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12684208">HIVE-6021</key>
            <summary>Problem in GroupByOperator for handling distinct aggrgations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sunrui">Sun Rui</assignee>
                                    <reporter username="sunrui">Sun Rui</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Dec 2013 11:30:42 +0000</created>
                <updated>Wed, 18 Dec 2013 18:50:03 +0000</updated>
                            <resolved>Wed, 18 Dec 2013 18:50:03 +0000</resolved>
                                    <version>0.12.0</version>
                                    <fixVersion>0.13.0</fixVersion>
                                    <component>Query Processor</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13846400" author="xuefuz" created="Thu, 12 Dec 2013 16:13:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunrui&quot; class=&quot;user-hover&quot; rel=&quot;sunrui&quot;&gt;sunrui&lt;/a&gt; Thanks for your contribution. Do you mind providing the following?&lt;/p&gt;

&lt;p&gt;1. A test case similar to what you constructed to produce the problem?&lt;br/&gt;
2. A review board entry.&lt;/p&gt;</comment>
                            <comment id="13847234" author="sunrui" created="Fri, 13 Dec 2013 07:48:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xzhang&quot; class=&quot;user-hover&quot; rel=&quot;xzhang&quot;&gt;xzhang&lt;/a&gt; &lt;br/&gt;
test case added.&lt;br/&gt;
review board entry: &lt;a href=&quot;https://reviews.apache.org/r/16243/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/16243/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13847882" author="xuefuz" created="Fri, 13 Dec 2013 20:33:41 +0000"  >&lt;p&gt;Submit patch to allow test to run.&lt;/p&gt;</comment>
                            <comment id="13847996" author="hiveqa" created="Fri, 13 Dec 2013 22:29:13 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12618395/HIVE-6021.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12618395/HIVE-6021.1.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 4777 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/635/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/635/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/635/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/635/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12618395&lt;/p&gt;</comment>
                            <comment id="13849593" author="xuefuz" created="Mon, 16 Dec 2013 18:59:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunrui&quot; class=&quot;user-hover&quot; rel=&quot;sunrui&quot;&gt;sunrui&lt;/a&gt; Thanks for the update. Could you please attach your updated patch here? The review board has the latest thought.&lt;/p&gt;</comment>
                            <comment id="13849979" author="sunrui" created="Tue, 17 Dec 2013 01:32:56 +0000"  >&lt;p&gt;attach the updated patch.&lt;/p&gt;</comment>
                            <comment id="13850139" author="hiveqa" created="Tue, 17 Dec 2013 05:53:23 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12619014/HIVE-6021.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12619014/HIVE-6021.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 4790 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/666/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/666/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/666/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/666/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12619014&lt;/p&gt;</comment>
                            <comment id="13850733" author="xuefuz" created="Tue, 17 Dec 2013 18:14:41 +0000"  >&lt;p&gt;+1, patch looks good to me.&lt;/p&gt;</comment>
                            <comment id="13852013" author="xuefuz" created="Wed, 18 Dec 2013 18:50:03 +0000"  >&lt;p&gt;Patch committed to trunk. Thank Sun Rui for the contribution.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12618395" name="HIVE-6021.1.patch" size="1218" author="sunrui" created="Thu, 12 Dec 2013 11:35:41 +0000"/>
                            <attachment id="12619014" name="HIVE-6021.2.patch" size="8116" author="sunrui" created="Tue, 17 Dec 2013 01:32:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363280</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qmcf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363586</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>