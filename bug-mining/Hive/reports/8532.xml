<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:24:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-27494] Deduplicate the task result that generated by more branches in union all</title>
                <link>https://issues.apache.org/jira/browse/HIVE-27494</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-23891&quot; title=&quot;UNION ALL and multiple task attempts can cause file duplication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-23891&quot;&gt;&lt;del&gt;HIVE-23891&lt;/del&gt;&lt;/a&gt; adds the ability to deduplicate the task result that under the directory,&lt;/p&gt;

&lt;p&gt;&amp;lt;table-dir&amp;gt;/&amp;lt;staging-dir&amp;gt;/_tmp.-ext-10000/&amp;lt;dynamic-partition-dir&amp;gt;/HIVE_UNION_SUBDIR_1,&lt;/p&gt;

&lt;p&gt;but turns out to ignore taking the same action to the output directory for the same query:&lt;/p&gt;

&lt;p&gt;&amp;lt;table-dir&amp;gt;/&amp;lt;staging-dir&amp;gt;/_tmp.-ext-10000/&amp;lt;dynamic-partition-dir&amp;gt;/HIVE_UNION_SUBDIR_2.&lt;/p&gt;

&lt;p&gt;So user may still have the same data duplication problem upon multiple tez task attempts.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13542970">HIVE-27494</key>
            <summary>Deduplicate the task result that generated by more branches in union all</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dengzh">Zhihua Deng</assignee>
                                    <reporter username="dengzh">Zhihua Deng</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 10 Jul 2023 07:51:05 +0000</created>
                <updated>Tue, 23 Apr 2024 03:35:22 +0000</updated>
                            <resolved>Mon, 31 Jul 2023 08:25:29 +0000</resolved>
                                                    <fixVersion>4.0.0-beta-1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17744986" author="zabetak" created="Thu, 20 Jul 2023 09:18:05 +0000"  >&lt;p&gt;The description talks directly about some internal directory structure but it&apos;s difficult to follow for people (like myself) that are not familiar with the area. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dengzh&quot; class=&quot;user-hover&quot; rel=&quot;dengzh&quot;&gt;dengzh&lt;/a&gt; Can you add a few more high level infomration in the description (such as DDL, query, plan, etc.,) that leads into this kind of problematic situation? I had also a look in the PR but it has low level details about code and it&apos;s hard to follow.&lt;/p&gt;

&lt;p&gt;Before diving into a review I would like first to understand what the problem is.&lt;/p&gt;</comment>
                            <comment id="17745368" author="dengzh" created="Fri, 21 Jul 2023 04:06:58 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zabetak&quot; class=&quot;user-hover&quot; rel=&quot;zabetak&quot;&gt;zabetak&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;I attached an example, in the explain.out, there are two maps: Map1 and Map3. Map1 will put his intermediate result under the directory:&lt;/p&gt;

&lt;p&gt;${warehouse_dir}/nonacidpart/.hive-staging_hive_2023-07-21_11-39-00_562_4675614078807904377-1/-ext-10000/HIVE_UNION_SUBDIR_1, and Map3:&lt;/p&gt;

&lt;p&gt;${warehouse_dir}/nonacidpart/.hive-staging_hive_2023-07-21_11-39-00_562_4675614078807904377-1/-ext-10000/HIVE_UNION_SUBDIR_2&lt;/p&gt;

&lt;p&gt;The move task will move the ${warehouse_dir}/nonacidpart/.hive-staging_hive_2023-07-21_11-39-00_562_4675614078807904377-1/-ext-10000 to the table&apos;s directory.&lt;/p&gt;

&lt;p&gt;As this is a dynamic partition insert, so the final temp directory would be:&lt;/p&gt;

&lt;p&gt;${warehouse_dir}/nonacidpart/.hive-staging_hive_2023-07-21_11-39-00_562_4675614078807904377-1/_tmp.-ext-10000/${dynamic_partition}/HIVE_UNION_SUBDIR_1 for Map1.&lt;/p&gt;

&lt;p&gt;${warehouse_dir}/nonacidpart/.hive-staging_hive_2023-07-21_11-39-00_562_4675614078807904377-1/_tmp.-ext-10000/${dynamic_partition}/HIVE_UNION_SUBDIR_2 for Map3.&lt;/p&gt;

&lt;p&gt;When the TezTask finishes, it will close all operators one by one:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/hive/blob/81759a105e50b9fd8c66ffbf2920f425a1d7a64c/ql/src/java/org/apache/hadoop/hive/ql/exec/tez/TezTask.java#L679-L689&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/81759a105e50b9fd8c66ffbf2920f425a1d7a64c/ql/src/java/org/apache/hadoop/hive/ql/exec/tez/TezTask.java#L679-L689&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Assume the FS operator in Map1 closes first, it will rename the ${warehouse_dir}/nonacidpart/.hive-staging_hive_2023-07-21_11-39-00_562_4675614078807904377-1/_tmp.-ext-10000 to ${warehouse_dir}/nonacidpart/.hive-staging_hive_2023-07-21_11-39-00_562_4675614078807904377-1/_tmp.-ext-10000.moved:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/exec/Utilities.java#L1453-L1456&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/exec/Utilities.java#L1453-L1456&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So the FS operator in Map3 has no chance to take care of his result as the parent dir has been renamed to another directory.&lt;/p&gt;

&lt;p&gt;I think the temp directory with prefix &quot;_tmp.&quot; only belongs to the FS operator, if we guarantee the final output will be safety moved to the directory ${warehouse_dir}/nonacidpart/.hive-staging_hive_2023-07-21_11-39-00_562_4675614078807904377-1/-ext-10000 where the move task knows, it&apos;s safe to change the FS internal directory structure.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17749079" author="dengzh" created="Mon, 31 Jul 2023 08:25:29 +0000"  >&lt;p&gt;Fix has been merged. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkuzmenko&quot; class=&quot;user-hover&quot; rel=&quot;dkuzmenko&quot;&gt;dkuzmenko&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkasa&quot; class=&quot;user-hover&quot; rel=&quot;kkasa&quot;&gt;kkasa&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zabetak&quot; class=&quot;user-hover&quot; rel=&quot;zabetak&quot;&gt;zabetak&lt;/a&gt;&#160; for the review!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13318524">HIVE-23891</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13061494" name="ddl.q" size="508" author="dengzh" created="Fri, 21 Jul 2023 04:08:36 +0000"/>
                            <attachment id="13061495" name="explain.output" size="17560" author="dengzh" created="Fri, 21 Jul 2023 04:08:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 15 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1j1rs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>