<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:52:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-15282] Different modification times are used when an index is built and when its staleness is checked</title>
                <link>https://issues.apache.org/jira/browse/HIVE-15282</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;The index_auto_mult_tables and index_auto_mult_tables_compact q tests are failing from time to time with the following error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_index_auto_mult_tables

Failing for the past 1 build (Since Failed#16 )
Took 16 sec.
Error Message

Unexpected exception junit.framework.AssertionFailedError: Client Execution results failed with error code = 1
See ./ql/target/tmp/log/hive.log or ./itests/qtest/target/tmp/log/hive.log, or check ./ql/target/surefire-reports or ./itests/qtest/target/surefire-reports/ for specific test cases logs.
 at junit.framework.Assert.fail(Assert.java:57)
 at org.apache.hadoop.hive.ql.QTestUtil.failedDiff(QTestUtil.java:2001)
 at org.apache.hadoop.hive.cli.TestCliDriver.runTest(TestCliDriver.java:194)
 at org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_index_auto_mult_tables(TestCliDriver.java:142)
 at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
 at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
 at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
 at java.lang.reflect.Method.invoke(Method.java:606)
 at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)
 at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
 at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)
 at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
 at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
 at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
 at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:271)
 at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:70)
 at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:50)
 at org.junit.runners.ParentRunner$3.run(ParentRunner.java:238)
 at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:63)
 at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:236)
 at org.junit.runners.ParentRunner.access$000(ParentRunner.java:53)
 at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:229)
 at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
 at org.junit.runners.ParentRunner.run(ParentRunner.java:309)
 at org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:264)
 at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:153)
 at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:124)
 at org.apache.maven.surefire.booter.ForkedBooter.invokeProviderInSameClassLoader(ForkedBooter.java:200)
 at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:153)
 at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:103)


See ./ql/target/tmp/log/hive.log or ./itests/qtest/target/tmp/log/hive.log, or check ./ql/target/surefire-reports or ./itests/qtest/target/surefire-reports/ for specific test cases logs.
Stacktrace

junit.framework.AssertionFailedError: Unexpected exception junit.framework.AssertionFailedError: Client Execution results failed with error code = 1
See ./ql/target/tmp/log/hive.log or ./itests/qtest/target/tmp/log/hive.log, or check ./ql/target/surefire-reports or ./itests/qtest/target/surefire-reports/ for specific test cases logs.
	at junit.framework.Assert.fail(Assert.java:57)
	at org.apache.hadoop.hive.ql.QTestUtil.failedDiff(QTestUtil.java:2001)
	at org.apache.hadoop.hive.cli.TestCliDriver.runTest(TestCliDriver.java:194)
	at org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_index_auto_mult_tables(TestCliDriver.java:142)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:271)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:70)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:50)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:238)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:63)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:236)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:53)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:229)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:309)
	at org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:264)
	at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:153)
	at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:124)
	at org.apache.maven.surefire.booter.ForkedBooter.invokeProviderInSameClassLoader(ForkedBooter.java:200)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:153)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:103)


See ./ql/target/tmp/log/hive.log or ./itests/qtest/target/tmp/log/hive.log, or check ./ql/target/surefire-reports or ./itests/qtest/target/surefire-reports/ for specific test cases logs.
	at junit.framework.Assert.fail(Assert.java:57)
	at org.apache.hadoop.hive.ql.QTestUtil.failed(QTestUtil.java:2011)
	at org.apache.hadoop.hive.cli.TestCliDriver.runTest(TestCliDriver.java:198)
	at org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_index_auto_mult_tables(TestCliDriver.java:142)
Standard Output

Running: diff -a /home/hiveptest/hive-ptest-cloudera-slaves-0c70-6.vpc.cloudera.com-hiveptest-1/cdh-source/itests/qtest/../../itests/qtest/target/qfile-results/clientpositive/index_auto_mult_tables.q.out /home/hiveptest/hive-ptest-cloudera-slaves-0c70-6.vpc.cloudera.com-hiveptest-1/cdh-source/itests/qtest/../../ql/src/test/results/clientpositive/index_auto_mult_tables.q.out
216c216,218
&amp;lt;   Stage-1 depends on stages: Stage-3
---
&amp;gt;   Stage-1 depends on stages: Stage-3, Stage-5
&amp;gt;   Stage-6 is a root stage
&amp;gt;   Stage-5 depends on stages: Stage-6
224,225c226,227
&amp;lt;             alias: default__src_src_index__
&amp;lt;             filterExpr: (((((UDFToDouble(key) &amp;gt; 80.0) and (UDFToDouble(key) &amp;lt; 100.0)) and (UDFToDouble(key) &amp;gt; 70.0)) and (UDFToDouble(key) &amp;lt; 90.0)) and (not EWAH_BITMAP_EMPTY(_bitmaps))) (type: boolean)
---
&amp;gt;             alias: default__srcpart_srcpart_index__
&amp;gt;             filterExpr: (((((UDFToDouble(key) &amp;gt; 70.0) and (UDFToDouble(key) &amp;lt; 90.0)) and (UDFToDouble(key) &amp;gt; 80.0)) and (UDFToDouble(key) &amp;lt; 100.0)) and (not EWAH_BITMAP_EMPTY(_bitmaps))) (type: boolean)
227c229
&amp;lt;               predicate: (((((UDFToDouble(key) &amp;gt; 80.0) and (UDFToDouble(key) &amp;lt; 100.0)) and (UDFToDouble(key) &amp;gt; 70.0)) and (UDFToDouble(key) &amp;lt; 90.0)) and (not EWAH_BITMAP_EMPTY(_bitmaps))) (type: boolean)
---
&amp;gt;               predicate: (((((UDFToDouble(key) &amp;gt; 70.0) and (UDFToDouble(key) &amp;lt; 90.0)) and (UDFToDouble(key) &amp;gt; 80.0)) and (UDFToDouble(key) &amp;lt; 100.0)) and (not EWAH_BITMAP_EMPTY(_bitmaps))) (type: boolean)
316a319,358
&amp;gt;   Stage: Stage-6
&amp;gt;     Map Reduce
&amp;gt;       Map Operator Tree:
&amp;gt;           TableScan
&amp;gt;             alias: default__src_src_index__
&amp;gt;             filterExpr: (((((UDFToDouble(key) &amp;gt; 80.0) and (UDFToDouble(key) &amp;lt; 100.0)) and (UDFToDouble(key) &amp;gt; 70.0)) and (UDFToDouble(key) &amp;lt; 90.0)) and (not EWAH_BITMAP_EMPTY(_bitmaps))) (type: boolean)
&amp;gt;             Filter Operator
&amp;gt;               predicate: (((((UDFToDouble(key) &amp;gt; 80.0) and (UDFToDouble(key) &amp;lt; 100.0)) and (UDFToDouble(key) &amp;gt; 70.0)) and (UDFToDouble(key) &amp;lt; 90.0)) and (not EWAH_BITMAP_EMPTY(_bitmaps))) (type: boolean)
&amp;gt;               Select Operator
&amp;gt;                 expressions: _bucketname (type: string), _offset (type: bigint)
&amp;gt;                 outputColumnNames: _col0, _col1
&amp;gt;                 Group By Operator
&amp;gt;                   aggregations: collect_set(_col1)
&amp;gt;                   keys: _col0 (type: string)
&amp;gt;                   mode: hash
&amp;gt;                   outputColumnNames: _col0, _col1
&amp;gt;                   Reduce Output Operator
&amp;gt;                     key expressions: _col0 (type: string)
&amp;gt;                     sort order: +
&amp;gt;                     Map-reduce partition columns: _col0 (type: string)
&amp;gt;                     value expressions: _col1 (type: array&amp;lt;bigint&amp;gt;)
&amp;gt;       Reduce Operator Tree:
&amp;gt;         Group By Operator
&amp;gt;           aggregations: collect_set(VALUE._col0)
&amp;gt;           keys: KEY._col0 (type: string)
&amp;gt;           mode: mergepartial
&amp;gt;           outputColumnNames: _col0, _col1
&amp;gt;           File Output Operator
&amp;gt;             compressed: false
&amp;gt;             table:
&amp;gt;                 input format: org.apache.hadoop.mapred.TextInputFormat
&amp;gt;                 output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
&amp;gt;                 serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
&amp;gt; 
&amp;gt;   Stage: Stage-5
&amp;gt;     Move Operator
&amp;gt;       files:
&amp;gt;           hdfs directory: true
&amp;gt; #### A masked pattern was here ####
&amp;gt; 
325a368,372
&amp;gt; PREHOOK: Input: default@default__srcpart_srcpart_index__
&amp;gt; PREHOOK: Input: default@default__srcpart_srcpart_index__@ds=2008-04-08/hr=11
&amp;gt; PREHOOK: Input: default@default__srcpart_srcpart_index__@ds=2008-04-08/hr=12
&amp;gt; PREHOOK: Input: default@default__srcpart_srcpart_index__@ds=2008-04-09/hr=11
&amp;gt; PREHOOK: Input: default@default__srcpart_srcpart_index__@ds=2008-04-09/hr=12
335a383,387
&amp;gt; POSTHOOK: Input: default@default__srcpart_srcpart_index__
&amp;gt; POSTHOOK: Input: default@default__srcpart_srcpart_index__@ds=2008-04-08/hr=11
&amp;gt; POSTHOOK: Input: default@default__srcpart_srcpart_index__@ds=2008-04-08/hr=12
&amp;gt; POSTHOOK: Input: default@default__srcpart_srcpart_index__@ds=2008-04-09/hr=11
&amp;gt; POSTHOOK: Input: default@default__srcpart_srcpart_index__@ds=2008-04-09/hr=12
342a395,442
&amp;gt; 82	val_82
&amp;gt; 82	val_82
&amp;gt; 82	val_82
&amp;gt; 82	val_82
&amp;gt; 83	val_83
&amp;gt; 83	val_83
&amp;gt; 83	val_83
&amp;gt; 83	val_83
&amp;gt; 83	val_83
&amp;gt; 83	val_83
&amp;gt; 83	val_83
&amp;gt; 83	val_83
&amp;gt; 83	val_83
&amp;gt; 83	val_83
&amp;gt; 83	val_83
&amp;gt; 83	val_83
&amp;gt; 83	val_83
&amp;gt; 83	val_83
&amp;gt; 83	val_83
&amp;gt; 83	val_83
&amp;gt; 84	val_84
&amp;gt; 84	val_84
&amp;gt; 84	val_84
&amp;gt; 84	val_84
&amp;gt; 84	val_84
&amp;gt; 84	val_84
&amp;gt; 84	val_84
&amp;gt; 84	val_84
&amp;gt; 84	val_84
&amp;gt; 84	val_84
&amp;gt; 84	val_84
&amp;gt; 84	val_84
&amp;gt; 84	val_84
&amp;gt; 84	val_84
&amp;gt; 84	val_84
&amp;gt; 84	val_84
&amp;gt; 85	val_85
&amp;gt; 85	val_85
&amp;gt; 85	val_85
&amp;gt; 85	val_85
&amp;gt; 86	val_86
&amp;gt; 86	val_86
&amp;gt; 86	val_86
&amp;gt; 86	val_86
&amp;gt; 87	val_87
&amp;gt; 87	val_87
&amp;gt; 87	val_87
&amp;gt; 87	val_87
Standard Error

Begin query: index_auto_mult_tables.q
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Warning: fs.defaultFS is not set when running &quot;chgrp&quot; command.
Warning: fs.defaultFS is not set when running &quot;chmod&quot; command.
Exception: Client Execution results failed with error code = 1
See ./ql/target/tmp/log/hive.log or ./itests/qtest/target/tmp/log/hive.log, or check ./ql/target/surefire-reports or ./itests/qtest/target/surefire-reports/ for specific test cases logs.
junit.framework.AssertionFailedError: Client Execution results failed with error code = 1
See ./ql/target/tmp/log/hive.log or ./itests/qtest/target/tmp/log/hive.log, or check ./ql/target/surefire-reports or ./itests/qtest/target/surefire-reports/ for specific test cases logs.
	at junit.framework.Assert.fail(Assert.java:57)
	at org.apache.hadoop.hive.ql.QTestUtil.failedDiff(QTestUtil.java:2001)
	at org.apache.hadoop.hive.cli.TestCliDriver.runTest(TestCliDriver.java:194)
	at org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_index_auto_mult_tables(TestCliDriver.java:142)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:271)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:70)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:50)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:238)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:63)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:236)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:53)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:229)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:309)
	at org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:264)
	at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:153)
	at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:124)
	at org.apache.maven.surefire.booter.ForkedBooter.invokeProviderInSameClassLoader(ForkedBooter.java:200)
	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:153)
	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:103)
Failed query: index_auto_mult_tables.q
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;From the output of the failing test, it seems that the index on the srcpart table is not used. &lt;br/&gt;
The hive.log contains the following:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2016-11-07T02:47:45,992  INFO [6401ee51-9d53-4101-a14e-9067d0bc357d main] index.IndexWhereProcessor: checking index staleness...
2016-11-07T02:47:45,998  INFO [6401ee51-9d53-4101-a14e-9067d0bc357d main] index.IndexWhereProcessor: Index is stale on partition &apos;ds=2008-04-09/hr=11&apos;. Modified time (1478515600000) for &apos;pfile:/home/hiveptest/54.215.115.117-hiveptest-0/apache-github-source-source/itests/qtest/target/warehouse/srcpart/ds=2008-04-09/hr=11/kv1.txt&apos; is higher than index creation time (1478515599000).
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The staleness check fails for the index on the srcpart table for the ds=2008-04-09/hr=11 partition, so the index is really not used. The staleness check fails, because the modification time of the itests/qtest/target/warehouse/srcpart/ds=2008-04-09/hr=11/kv1.txt file (11:46:40:0) is higher than the index creation time (11:46:39:0).&lt;/p&gt;

&lt;p&gt;After some investigation, I found that this happens if the creation of the partition folder and moving the kv1.txt file happens when the second turns. So the folder is created at 11:46:39,961, but the MoveTask which moves the kv1.txt file to the folder starts at 11:46:39:961 and finishes at 11:46:40,012.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2016-11-07T02:46:39,961  INFO [9b9edc01-22c2-460e-b008-03878e74077e main] common.FileUtils: Creating directory if it doesn&apos;t exist: pfile:/home/hiveptest/54.215.115.117-hiveptest-0/apache-github-source-source/itests/qtest/target/warehouse/srcpart/ds=2008-04-09/hr=11
2016-11-07T02:46:39,973 DEBUG [9b9edc01-22c2-460e-b008-03878e74077e main] shims.HdfsUtils: {-chgrp,-R,hiveptest,pfile:/home/hiveptest/54.215.115.117-hiveptest-0/apache-github-source-source/itests/qtest/target/warehouse/srcpart/ds=2008-04-09}
2016-11-07T02:46:39,981 DEBUG [9b9edc01-22c2-460e-b008-03878e74077e main] shims.HdfsUtils: Return value is :0
2016-11-07T02:46:39,981 DEBUG [9b9edc01-22c2-460e-b008-03878e74077e main] shims.HdfsUtils: {-chmod,-R,755,pfile:/home/hiveptest/54.215.115.117-hiveptest-0/apache-github-source-source/itests/qtest/target/warehouse/srcpart/ds=2008-04-09}
2016-11-07T02:46:39,992 DEBUG [9b9edc01-22c2-460e-b008-03878e74077e main] shims.HdfsUtils: Return value is :0
2016-11-07T02:46:39,992 DEBUG [9b9edc01-22c2-460e-b008-03878e74077e main] metadata.Hive: The source path is /home/hiveptest/54.215.115.117-hiveptest-0/apache-github-source-source/data/files/kv1.txt/ and the destination path is /home/hiveptest/54.215.115.117-hiveptest-0/apache-github-source-source/itests/qtest/target/warehouse/srcpart/ds=2008-04-09/hr=11/kv1.txt/
2016-11-07T02:46:40,001 DEBUG [9b9edc01-22c2-460e-b008-03878e74077e main] shims.HdfsUtils: {-chgrp,-R,hiveptest,pfile:/home/hiveptest/54.215.115.117-hiveptest-0/apache-github-source-source/itests/qtest/target/warehouse/srcpart/ds=2008-04-09/hr=11/kv1.txt}
2016-11-07T02:46:40,006 DEBUG [9b9edc01-22c2-460e-b008-03878e74077e main] shims.HdfsUtils: Return value is :0
2016-11-07T02:46:40,006 DEBUG [9b9edc01-22c2-460e-b008-03878e74077e main] shims.HdfsUtils: {-chmod,-R,755,pfile:/home/hiveptest/54.215.115.117-hiveptest-0/apache-github-source-source/itests/qtest/target/warehouse/srcpart/ds=2008-04-09/hr=11/kv1.txt}
2016-11-07T02:46:40,012 DEBUG [9b9edc01-22c2-460e-b008-03878e74077e main] shims.HdfsUtils: Return value is :0
2016-11-07T02:46:40,012 DEBUG [9b9edc01-22c2-460e-b008-03878e74077e main] log.PerfLogger: &amp;lt;/PERFLOG method=FileMoves start=1478515599961 end=1478515600012 duration=51 from=MoveTask&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this case, the last modification time of the folder itests/qtest/target/warehouse/srcpart/ds=2008-04-09/hr=11/ will be 11:46:39 and of the kv1.txt will be 11:46:40.&lt;/p&gt;

&lt;p&gt;When the index is built in the DDLTask.alterIndex method, the modification time which is stored for each partition is the modification time of the folder:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if (baseTbl.isPartitioned()) {
  List&amp;lt;Partition&amp;gt; baseParts;
  if (alterIndex.getSpec() != null) {
    baseParts = db.getPartitions(baseTbl, alterIndex.getSpec());
  } else {
    baseParts = db.getPartitions(baseTbl);
  }
  if (baseParts != null) {
    for (Partition p : baseParts) {
      FileSystem fs = p.getDataLocation().getFileSystem(db.getConf());
      FileStatus fss = fs.getFileStatus(p.getDataLocation());
      basePartTs.put(p.getSpec(), fss.getModificationTime());
    }
  }
} else {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But when the staleness is checked in the IndexUtils.isIndexPartitionFresh method, it checks the modification time of the files in the partition folder:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  private static boolean isIndexPartitionFresh(Hive hive, Index index,
      Partition part) throws HiveException {
    LOG.info(&quot;checking index staleness...&quot;);
    try {
      String indexTs = index.getParameters().get(part.getSpec().toString());
      if (indexTs == null) {
        return false;
      }

      FileSystem partFs = part.getDataLocation().getFileSystem(hive.getConf());
      FileStatus[] parts = partFs.listStatus(part.getDataLocation(), FileUtils.HIDDEN_FILES_PATH_FILTER);
      for (FileStatus status : parts) {
        if (status.getModificationTime() &amp;gt; Long.parseLong(indexTs)) {
          LOG.info(&quot;Index is stale on partition &apos;&quot; + part.getName()
              + &quot;&apos;. Modified time (&quot; + status.getModificationTime() + &quot;) for &apos;&quot; + status.getPath()
              + &quot;&apos; is higher than index creation time (&quot; + indexTs + &quot;).&quot;);
          return false;
        }
      }
    } catch (IOException e) {
      throw new HiveException(&quot;Failed to grab timestamp information from partition &apos;&quot; + part.getName() + &quot;&apos;: &quot; + e.getMessage(), e);
    }
    return true;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Because of the modification time of the itests/qtest/target/warehouse/srcpart/ds=2008-04-09/hr=11/kv1.txt file is higher (11:46:40), than the modification time of the itests/qtest/target/warehouse/srcpart/ds=2008-04-09/hr=11 folder (11:46:39), the check fails and the index is not used which leads to the failure of the q test.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13023144">HIVE-15282</key>
            <summary>Different modification times are used when an index is built and when its staleness is checked</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kuczoram">Marta Kuczora</assignee>
                                    <reporter username="kuczoram">Marta Kuczora</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Nov 2016 10:15:23 +0000</created>
                <updated>Fri, 21 Jul 2017 18:26:21 +0000</updated>
                            <resolved>Tue, 7 Mar 2017 22:49:51 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>Indexing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="15693528" author="kuczoram" created="Thu, 24 Nov 2016 15:21:12 +0000"  >&lt;p&gt;The patch and the link to the review board is attached. Please review the patch.&lt;/p&gt;</comment>
                            <comment id="15693698" author="hiveqa" created="Thu, 24 Nov 2016 16:34:04 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12840430/HIVE-15282.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12840430/HIVE-15282.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 4 failed/errored test(s), 10733 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_schema_evol_3a] (batchId=133)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=133)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[join_acid_non_acid] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[union_fast_stats] (batchId=145)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/2284/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/2284/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/2284/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/2284/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-2284/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-2284/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12840430 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15693769" author="kuczoram" created="Thu, 24 Nov 2016 17:02:35 +0000"  >&lt;p&gt;The failing tests are not related to the changes in the patch.&lt;/p&gt;</comment>
                            <comment id="15892421" author="kuczoram" created="Thu, 2 Mar 2017 15:32:58 +0000"  >&lt;p&gt;Fixed the patch according to the review.&lt;/p&gt;</comment>
                            <comment id="15892919" author="hiveqa" created="Thu, 2 Mar 2017 20:25:25 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12855642/HIVE-15282.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12855642/HIVE-15282.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 10 failed/errored test(s), 10285 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestCommandProcessorFactory - did not produce a TEST-*.xml file (likely timed out) (batchId=272)
TestDbTxnManager - did not produce a TEST-*.xml file (likely timed out) (batchId=272)
TestDummyTxnManager - did not produce a TEST-*.xml file (likely timed out) (batchId=272)
TestHiveInputSplitComparator - did not produce a TEST-*.xml file (likely timed out) (batchId=272)
TestIndexType - did not produce a TEST-*.xml file (likely timed out) (batchId=272)
TestSplitFilter - did not produce a TEST-*.xml file (likely timed out) (batchId=272)
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[escape_comments] (batchId=229)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[schema_evol_text_vec_table] (batchId=147)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=224)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vector_between_in] (batchId=119)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/3896/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/3896/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/3896/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/3896/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-3896/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-3896/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 10 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12855642 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15900255" author="ashutoshc" created="Tue, 7 Mar 2017 22:00:22 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15900332" author="ashutoshc" created="Tue, 7 Mar 2017 22:49:51 +0000"  >&lt;p&gt;Pushed to master. Thanks, Marta!&lt;/p&gt;</comment>
                            <comment id="15901213" author="kuczoram" created="Wed, 8 Mar 2017 13:09:43 +0000"  >&lt;p&gt;Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ashutoshc&quot; class=&quot;user-hover&quot; rel=&quot;ashutoshc&quot;&gt;ashutoshc&lt;/a&gt; for committing the patch!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13044957">HIVE-15998</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12855642" name="HIVE-15282.2.patch" size="1486" author="kuczoram" created="Thu, 2 Mar 2017 15:32:58 +0000"/>
                            <attachment id="12840430" name="HIVE-15282.patch" size="1616" author="kuczoram" created="Thu, 24 Nov 2016 15:18:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i36qrj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>