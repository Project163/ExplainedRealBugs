<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 17:56:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-741] NULL is not handled correctly in join</title>
                <link>https://issues.apache.org/jira/browse/HIVE-741</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;With the following data in table input4_cb:&lt;/p&gt;

&lt;p&gt;Key        Value&lt;br/&gt;
------       --------&lt;br/&gt;
NULL     325&lt;br/&gt;
18          NULL&lt;/p&gt;

&lt;p&gt;The following query:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;select * from input4_cb a join input4_cb b on a.key = b.value;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;returns the following result:&lt;/p&gt;

&lt;p&gt;NULL    325    18   NULL&lt;/p&gt;

&lt;p&gt;The correct result should be empty set.&lt;/p&gt;

&lt;p&gt;When &apos;null&apos; is replaced by &apos;&apos; it works.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12432589">HIVE-741</key>
            <summary>NULL is not handled correctly in join</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="amareshwari">Amareshwari Sriramadasu</assignee>
                                    <reporter username="nzhang">Ning Zhang</reporter>
                        <labels>
                    </labels>
                <created>Sat, 8 Aug 2009 03:58:45 +0000</created>
                <updated>Thu, 16 Feb 2012 23:42:41 +0000</updated>
                            <resolved>Tue, 24 Aug 2010 22:21:00 +0000</resolved>
                                    <version>0.6.0</version>
                                    <fixVersion>0.7.0</fixVersion>
                                    <component>Query Processor</component>
                    <component>Serializers/Deserializers</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="12896789" author="amareshwari" created="Tue, 10 Aug 2010 07:21:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;When &apos;null&apos; is replaced by &apos;&apos; it works.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I see the same result even if &apos;null&apos; is replaced with &apos;&apos;.&lt;/p&gt;

&lt;p&gt;To reproduce the above, I created a table input1 with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;hive&amp;gt; create table input1 (key &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, value &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Loaded the following input using Load data command&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;in.txt
^A35
12^A
10^A1000
10^A100
100^A100
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I see the following output for join queries executed.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
hive&amp;gt; select * from input1 a join input1 b on a.key=b.value;

Output:
NULL    35      12      NULL
100     100     10      100
100     100     100     100

Expected Output:
100     100     10      100
100     100     100     100

hive&amp;gt; select * from input1 a left outer join input1 b on a.key=b.value;

OUTPUT:
NULL    35      12      NULL
10      1000    NULL    NULL
10      100     NULL    NULL
12      NULL    NULL    NULL
100     100     10      100
100     100     100     100

Expected Output:
NULL    35      NULL    NULL
10      1000    NULL    NULL
10      100     NULL    NULL
12      NULL    NULL    NULL
100     100     10      100
100     100     100     100

hive&amp;gt; select * from input1 a right outer join input1 b on a.key=b.value;

OUTPUT:
NULL    35      12      NULL
NULL    NULL    NULL    35
100     100     10      100
100     100     100     100
NULL    NULL    10      1000

ExpectedOutput:
NULL    NULL    NULL    35
NULL    NULL    12      NULL
100     100     10      100
100     100     100     100
NULL    NULL    10      1000

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Expected output is obtained from mysql db for a similar query.&lt;/p&gt;

&lt;p&gt;Ning, if you are not working on the fix for this, I would like to contribute. Would need your help understanding join code also, as I&apos;m a new to hive. &lt;/p&gt;</comment>
                            <comment id="12896792" author="amareshwari" created="Tue, 10 Aug 2010 07:36:24 +0000"  >&lt;p&gt;By adding logs to ExecReducer, I see that the input to reduce is the following:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;{&quot;key&quot;:{&quot;joinkey0&quot;:null},&quot;value&quot;:{&quot;_col0&quot;:null,&quot;_col1&quot;:35},&quot;alias&quot;:0}
{&quot;key&quot;:{&quot;joinkey0&quot;:null},&quot;value&quot;:{&quot;_col0&quot;:12,&quot;_col1&quot;:null},&quot;alias&quot;:1}
{&quot;key&quot;:{&quot;joinkey0&quot;:10},&quot;value&quot;:{&quot;_col0&quot;:10,&quot;_col1&quot;:1000},&quot;alias&quot;:0}
{&quot;key&quot;:{&quot;joinkey0&quot;:10},&quot;value&quot;:{&quot;_col0&quot;:10,&quot;_col1&quot;:100},&quot;alias&quot;:0}
{&quot;key&quot;:{&quot;joinkey0&quot;:12},&quot;value&quot;:{&quot;_col0&quot;:12,&quot;_col1&quot;:null},&quot;alias&quot;:0}
{&quot;key&quot;:{&quot;joinkey0&quot;:35},&quot;value&quot;:{&quot;_col0&quot;:null,&quot;_col1&quot;:35},&quot;alias&quot;:1}
{&quot;key&quot;:{&quot;joinkey0&quot;:100},&quot;value&quot;:{&quot;_col0&quot;:100,&quot;_col1&quot;:100},&quot;alias&quot;:0}
{&quot;key&quot;:{&quot;joinkey0&quot;:100},&quot;value&quot;:{&quot;_col0&quot;:10,&quot;_col1&quot;:100},&quot;alias&quot;:1}
{&quot;key&quot;:{&quot;joinkey0&quot;:100},&quot;value&quot;:{&quot;_col0&quot;:100,&quot;_col1&quot;:100},&quot;alias&quot;:1}
{&quot;key&quot;:{&quot;joinkey0&quot;:1000},&quot;value&quot;:{&quot;_col0&quot;:10,&quot;_col1&quot;:1000},&quot;alias&quot;:1}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And joinkey with null values are processed under same group, I think they should be processed in different groups, because comparison between nulls is not defined. &lt;/p&gt;</comment>
                            <comment id="12896793" author="nzhang" created="Tue, 10 Aug 2010 07:40:12 +0000"  >&lt;p&gt;I&apos;m not actively working on it. Please feel free to take it.&lt;/p&gt;</comment>
                            <comment id="12896974" author="nzhang" created="Tue, 10 Aug 2010 17:37:40 +0000"  >&lt;p&gt;The joins are implemented in the JoinOperator and CommonJoinOperators for regular reduce-side joins. The map-side joins are implemented in the MapJoinOperator. &lt;/p&gt;

&lt;p&gt;In the reduce side joins, the join keys are treated as distribution keys from the mappers to the reducers so that each group (marked by beginGroup() and endGroup()) will consists of rows with the same join keys. The reduce-side joins will cache all rows within a group except the last one (aka streaming table), which is scanned and cartesian producted with the cached rows of the other tables. I think the fix would be to check the NULL value of the join keys and do proper output based on the semantics of different types of joins. &lt;/p&gt;

&lt;p&gt;For the map-side join, it&apos;s basically a hash join where the small table is read in entirety in a hash table and probed while scanning the streaming table. &lt;/p&gt;

&lt;p&gt;There are other types of joins (bucketed map-side join, sort merge join etc.), but they all rely on the 3 classes mentioned above. &lt;/p&gt;

&lt;p&gt;Let me know if you have further questions for you to get started. &lt;/p&gt;</comment>
                            <comment id="12898132" author="tedxu" created="Fri, 13 Aug 2010 08:29:48 +0000"  >&lt;p&gt;Thanks for Ning and Amareshwari, we are looking forward to see the bug fixed. I think it&apos;s Okay to solve it by modifying the *JoinOperators, but it will be great if we can filter the NULL values in mappers, say, in ReduceSinkOperator, provided if we can know which part of the reduce sink key is from join (other than from group by, distinct, etc,.).  &lt;/p&gt;</comment>
                            <comment id="12898136" author="amareshwari" created="Fri, 13 Aug 2010 08:57:52 +0000"  >&lt;p&gt;Thanks Ning for the details.&lt;/p&gt;

&lt;p&gt;To summarize the implementation of join: &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;In reduce-side join, rows with same join keys are grouped together; and  in MapSide join, rows with same join keys are added the same entry in the hash table.&lt;/li&gt;
	&lt;li&gt;CommonJoinOperator.checkAndGenObject: The rows with same join key are cartesian producted with each other(i.e. with rows of different aliases). If there are no rows in one table alias, the rows of other table alias are ignored (for inner join) or cartesian producted with nulls (outer joins).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The above implementation works fine except for null join keys ; Since these rows are grouped together/hashed to same entry, the current issue exists.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think the fix would be to check the NULL value of the join keys and do proper output based on the semantics of different types of joins.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This would need special handling for each type of join (inner, left outer, right outer, full outer  an etc.). So, I&apos;m thinking the better solution is not group rows with null join keys together. Then the above join algorithm works correctly for all types of joins.&lt;/p&gt;

&lt;p&gt;Currently they are grouped together because HiveKey.compare compares the bytes of the key (in case of reduce-side join) and MapJoinObjectKey.equals returns true if both keys are null (in case of map-side join). I&apos;m trying to see if can come up with a solution which does not group rows with null join keys together. Please correct me if am wrong.&lt;/p&gt;</comment>
                            <comment id="12898141" author="amareshwari" created="Fri, 13 Aug 2010 09:14:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;but it will be great if we can filter the NULL values in mappers.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ted, we should not filter out the NULL values in mappers. Because for outer joins, these rows should be cartesian producted with nulls as shown in expected output in the &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-741?focusedCommentId=12896789&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12896789&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;comment &lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12898194" author="tedxu" created="Fri, 13 Aug 2010 11:36:09 +0000"  >&lt;p&gt;Sorry I&apos;m mistakenly expressed my idea, I mean values with NULL join keys shall be filtered out in mappers. &lt;/p&gt;

&lt;p&gt;I think values with NULL join keys shall be filtered out because NULL equals nothing, and Hive only support equal join.&lt;/p&gt;

&lt;p&gt;Please correct me if I&apos;m wrong. &lt;/p&gt;</comment>
                            <comment id="12898374" author="jvs" created="Fri, 13 Aug 2010 19:14:38 +0000"  >&lt;p&gt;@Ted:  as Amareshwari mentioned, a left outer join preserves rows on the left side regardless of whether the ON clause evaluates true.  So in that case (and similar cases for right/full outer join), we can&apos;t filter out the rows with null join keys.&lt;/p&gt;</comment>
                            <comment id="12898756" author="nzhang" created="Sun, 15 Aug 2010 21:37:37 +0000"  >&lt;p&gt;@Amareshwar, currently we already distinguish different join types with different functions (take a look at CommonJoinOperator.joinObjects()). I look forward to seeing your proposal to avoid grouping null-keyed rows.&lt;/p&gt;

&lt;p&gt;@Ted, I agree with Amareshwar and John that we cannot avoid rows (or the value part of the key-value pairs) with null as a key. However you have a point in that if we know the join operator does not involve outer join at all (we already have a flag noOuterJoin in JoinDesc), then we could avoid sending rows will null keys from the mappers to the reducers. This will save bandwidth as well as processing time. Could you open another JIRA and be able to submit a patch?&lt;/p&gt;</comment>
                            <comment id="12898772" author="tedxu" created="Mon, 16 Aug 2010 01:01:23 +0000"  >&lt;blockquote&gt;&lt;p&gt;a left outer join preserves rows on the left side regardless of whether the ON clause evaluates true&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That&apos;s right, thanks.&lt;/p&gt;</comment>
                            <comment id="12898858" author="amareshwari" created="Mon, 16 Aug 2010 11:44:40 +0000"  >&lt;p&gt;Attaching a simple patch which fixes JoinOperator (for reduce-side joins) and MapJoinOperator (for map-side joins) to not group the null join keys together. &lt;br/&gt;
Any comments on the approach/code are welcome.&lt;br/&gt;
Verified that SMBMapJoinOperator already filters nulls properly.&lt;/p&gt;</comment>
                            <comment id="12898996" author="he yongqiang" created="Mon, 16 Aug 2010 17:23:59 +0000"  >&lt;p&gt;the change looks good to me. Can you also add one or few tests for sort merge join?&lt;/p&gt;</comment>
                            <comment id="12899044" author="nzhang" created="Mon, 16 Aug 2010 19:27:59 +0000"  >&lt;p&gt;@Amareshwari, aside from adding new test cases for sort merge join, this patch also has some bugs. &lt;/p&gt;

&lt;p&gt;For example in your test data:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;hive&amp;gt; select * from myinput1
NULL    356
484 NULL
10  10

-- incorrect result below
hive&amp;gt; select * FROM myinput1 a left &lt;span class=&quot;code-keyword&quot;&gt;outer&lt;/span&gt; JOIN myinput1 b ON a.value = b.value; 
484 NULL    484 NULL
10  10  10  10
NULL    356 NULL    NULL

hive&amp;gt; select * FROM myinput1 a right &lt;span class=&quot;code-keyword&quot;&gt;outer&lt;/span&gt; JOIN myinput1 b ON a.value = b.value;
484 NULL    484 NULL
10  10  10  10
NULL    NULL    NULL    356

hive&amp;gt; select * FROM myinput1 a left &lt;span class=&quot;code-keyword&quot;&gt;outer&lt;/span&gt; JOIN myinput1 b right &lt;span class=&quot;code-keyword&quot;&gt;outer&lt;/span&gt; join myinput1 c ON a.value = b.value and b.value = c.value;
NULL    NULL    NULL    NULL    484 NULL
NULL    NULL    NULL    NULL    10  10
NULL    NULL    NULL    NULL    NULL    356
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Can you take a look? I&apos;m not sure whether ending a group and starting a new group for each null-keyed row works for all cases particularly in joins involving more than 2 tables and mixture of left and right outer joins.  &lt;/p&gt;</comment>
                            <comment id="12899177" author="namit" created="Mon, 16 Aug 2010 23:12:49 +0000"  >&lt;p&gt;For inner, left and right outer joins, a simpler fix would be to add a filter on top.&lt;/p&gt;

&lt;p&gt;For example, for &lt;/p&gt;

&lt;p&gt;A join B on A.c1 = B.c2&lt;/p&gt;


&lt;p&gt;add a filter before A (A.c1 is not null) and B (B.c2 is not null)&lt;/p&gt;

&lt;p&gt;For &lt;/p&gt;

&lt;p&gt;A left outer join B on A.c1 = B.c2, the filter before A is not needed and &lt;br/&gt;
similarly, for &lt;br/&gt;
A right outer join B on A.c1 = B.c2, the filter before B is not needed&lt;/p&gt;



&lt;p&gt;Some special handling might still be needed for full outer joins and sort-merge joins&lt;/p&gt;</comment>
                            <comment id="12899365" author="amareshwari" created="Tue, 17 Aug 2010 10:14:40 +0000"  >&lt;p&gt;Thanks Ning for your comments.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;select * FROM myinput1 a left outer JOIN myinput1 b ON a.value = b.value;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;select * FROM myinput1 a right outer JOIN myinput1 b ON a.value = b.value;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This is happening because I&apos;m assuming nr.get(0) in JoinOperator is the join-key. It seems it not always true that key is the first element in the ArrayList. When I modified a the code to the following, above queries are giving correct results.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      StructObjectInspector soi = (StructObjectInspector) inputObjInspectors[tag];
      StructField sf = soi.getStructFieldRef(Utilities.ReduceField.KEY
          .toString());
      &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; keyObject = soi.getStructFieldData(row, sf);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (SerDeUtils.isNullObject(keyObject, soi)) {
        endGroup();
        startGroup();
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Added method SerDeUtils.isNullObject(keyObject, soi) to know if the object passed is representing a NULL object.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;select * FROM myinput1 a left outer JOIN myinput1 b right outer join myinput1 c ON a.value = b.value and b.value = c.value;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Looking at Stage-1 of &quot;explain&quot; for the above query:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Stage: Stage-1
    Map Reduce
      Alias -&amp;gt; Map Operator Tree:
        a
          TableScan
            alias: a
            Reduce Output Operator
              sort order:
              tag: 0
              value expressions:
                    expr: key
                    type: int
                    expr: value
                    type: int
        b
          TableScan
            alias: b
            Reduce Output Operator
              sort order:
              tag: 1
              value expressions:
                    expr: key
                    type: int
                    expr: value
                    type: int
      Reduce Operator Tree:
        Join Operator
          condition map:
               Left Outer Join0 to 1
          condition expressions:
            0 {VALUE._col0} {VALUE._col1}
            1 {VALUE._col0} {VALUE._col1}
          handleSkewJoin: false
          outputColumnNames: _col0, _col1, _col4, _col5
          Filter Operator
            predicate:
                expr: (_col1 = _col5)
                type: boolean
            File Output Operator
              compressed: false
              GlobalTableId: 0
              table:
                  input format: org.apache.hadoop.mapred.SequenceFileInputFormat
                  output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Join happens without join key?  Here, join output is the Cartesian product of a and b on which FilterOperator is applied, Am I right? I see the semantics of inner/outer join on two tables without join condition is to produce Cartesian product. As a side note: &quot;MySql does not allow outer joins without join condition&quot;. &lt;br/&gt;
If Join is allowed without join condition to produce Cartesian product of the two tables, then my patch should be changed to consider if join-key is defined for the join or not.  I could reproduce it by simple query &quot;select * FROM myinput1 a JOIN myinput1 b&quot;. I think the same applies to MapJoin as well. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Verified that SMBMapJoinOperator already filters nulls properly. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Can you also add one or few tests for sort merge join? &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It seems my verification was wrong here, I thought if the table is sorted and hive.optimize.bucketmapjoin, hive.optimize.bucketmapjoin.sortedmerge are set to true, MapJoin uses SMBMapJoinOperator. But it was using MapJoinOperator it self. When I created a table with &quot;sorted by&quot; column, I see it using SMBMapJoinOperator. Currently if there are any nulls in the input table, SMBJoin fails with NullPointerException:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.lang.NullPointerException
	at org.apache.hadoop.io.IntWritable.compareTo(IntWritable.java:60)
	at org.apache.hadoop.io.WritableComparator.compare(WritableComparator.java:115)
	at org.apache.hadoop.hive.ql.exec.SMBMapJoinOperator.compareKeys(SMBMapJoinOperator.java:389)
	at org.apache.hadoop.hive.ql.exec.SMBMapJoinOperator.processKey(SMBMapJoinOperator.java:438)
	at org.apache.hadoop.hive.ql.exec.SMBMapJoinOperator.processOp(SMBMapJoinOperator.java:205)
	at org.apache.hadoop.hive.ql.exec.Operator.process(Operator.java:458)
	at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:698)
	at org.apache.hadoop.hive.ql.exec.TableScanOperator.processOp(TableScanOperator.java:45)
	at org.apache.hadoop.hive.ql.exec.Operator.process(Operator.java:458)
	at org.apache.hadoop.hive.ql.exec.SMBMapJoinOperator.fetchOneRow(SMBMapJoinOperator.java:479)
	... 17 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Will look into this. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;For inner, left and right outer joins, a simpler fix would be to add a filter on top. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Now, I agree it would be simpler &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. Will consider this also and see if i can do some special handling for full outer joins.&lt;/p&gt;</comment>
                            <comment id="12899753" author="nzhang" created="Wed, 18 Aug 2010 06:24:48 +0000"  >&lt;p&gt;@Amareshwari, sorry the syntax was wrong for the 3 table joins. Below is the correct syntax and plan.&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;explain select * from src a left &lt;span class=&quot;code-keyword&quot;&gt;outer&lt;/span&gt; join src b on (a.value=b.value) right &lt;span class=&quot;code-keyword&quot;&gt;outer&lt;/span&gt; join src c on (b.value=c.value);
OK
ABSTRACT SYNTAX TREE:
  (TOK_QUERY (TOK_FROM (TOK_RIGHTOUTERJOIN (TOK_LEFTOUTERJOIN (TOK_TABREF src a) (TOK_TABREF src b) (= (. (TOK_TABLE_OR_COL a) value) (. (TOK_TABLE_OR_COL b) value))) (TOK_TABREF src c) (= (. (TOK_TABLE_OR_COL b) value) (. (TOK_TABLE_OR_COL c) value)))) (TOK_INSERT (TOK_DESTINATION (TOK_DIR TOK_TMP_FILE)) (TOK_SELECT (TOK_SELEXPR TOK_ALLCOLREF))))

STAGE DEPENDENCIES:
  Stage-1 is a root stage
  Stage-0 is a root stage

STAGE PLANS:
  Stage: Stage-1
    Map Reduce
      Alias -&amp;gt; Map Operator Tree:
        a 
          TableScan
            alias: a
            Reduce Output Operator
              key expressions:
                    expr: value
                    type: string
              sort order: +
              Map-reduce partition columns:
                    expr: value
                    type: string
              tag: 0
              value expressions:
                    expr: key
                    type: string
                    expr: value
                    type: string
        b 
          TableScan
            alias: b
            Reduce Output Operator
              key expressions:
                    expr: value
                    type: string
              sort order: +
              Map-reduce partition columns:
                    expr: value
                    type: string
              tag: 1
              value expressions:
                    expr: key
                    type: string
                    expr: value
                    type: string
        c 
          TableScan
            alias: c
            Reduce Output Operator
              key expressions:
                    expr: value
                    type: string
              sort order: +
              Map-reduce partition columns:
                    expr: value
                    type: string
              tag: 2
              value expressions:
                    expr: key
                    type: string
                    expr: value
                    type: string
      Reduce Operator Tree:
        Join Operator
          condition map:
               Left Outer Join0 to 1
               Right Outer Join1 to 2
          condition expressions:
            0 {VALUE._col0} {VALUE._col1}
            1 {VALUE._col0} {VALUE._col1}
            2 {VALUE._col0} {VALUE._col1}
          handleSkewJoin: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
          outputColumnNames: _col0, _col1, _col4, _col5, _col8, _col9
          Select Operator
            expressions:
                  expr: _col0
                  type: string
                  expr: _col1
                  type: string
                  expr: _col4
                  type: string
                  expr: _col5
                  type: string
                  expr: _col8
                  type: string
                  expr: _col9
                  type: string
            outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5
            File Output Operator
              compressed: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
              GlobalTableId: 0
              table:
                  input format: org.apache.hadoop.mapred.TextInputFormat
                  output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat

  Stage: Stage-0
    Fetch Operator
      limit: -1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12899794" author="amareshwari" created="Wed, 18 Aug 2010 09:11:28 +0000"  >&lt;p&gt;Attaching patch that fixes the bugs in earlier patch, that Ning has found. Also adds more testcases.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Can you also add one or few tests for sort merge join? &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Attached file smbjoin_nulls.q.txt has tests for sort merge join. But it fails with NPE as mentioned as earlier. I tried to fix the NPE, but could not come up with a fix. Shall I do it on followup jira?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;For inner, left and right outer joins, a simpler fix would be to add a filter on top.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think this can be done as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1544&quot; title=&quot;Filtering out NULL-keyed rows in ReduceSinkOperator when no outer join involved&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1544&quot;&gt;HIVE-1544&lt;/a&gt; as an improvement.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;@Amareshwari, sorry the syntax was wrong for the 3 table joins. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ning, Hive was not complaining about the syntax. So, included this also in the testcase. The results are fine with the latest patch.&lt;/p&gt;</comment>
                            <comment id="12899795" author="amareshwari" created="Wed, 18 Aug 2010 09:16:10 +0000"  >&lt;p&gt;Submitting patch for the review of patch-741-1.txt &lt;/p&gt;</comment>
                            <comment id="12900174" author="amareshwari" created="Thu, 19 Aug 2010 05:12:28 +0000"  >&lt;p&gt;Patch fixes SMBMapJoinOperator also. I modified compareKeys(ArrayList&amp;lt;Object&amp;gt; k1, ArrayList&amp;lt;Object&amp;gt; k2) to do the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (hasNullElements(k1) &amp;amp;&amp;amp; hasNullElements(k2)) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; -1; &lt;span class=&quot;code-comment&quot;&gt;// just &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; k1 is smaller than k2
&lt;/span&gt;    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (hasNullElements(k1)) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (0 - k2.size());
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (hasNullElements(k2)) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; k1.size();
    }
   ... &lt;span class=&quot;code-comment&quot;&gt;//the existing code.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Does the above make sense?&lt;/p&gt;

&lt;p&gt;Updated the testcase with smb join queries. &lt;/p&gt;

&lt;p&gt;When I&apos;m running smb join on my local machine (pseudo distributed mode), I&apos;m getting different results. I think that is mostly because of &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-1561&quot; title=&quot;smb_mapjoin_8.q returns different results in miniMr mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-1561&quot;&gt;&lt;del&gt;HIVE-1561&lt;/del&gt;&lt;/a&gt;. Will update the issue with my findings.&lt;/p&gt;</comment>
                            <comment id="12900198" author="amareshwari" created="Thu, 19 Aug 2010 07:19:12 +0000"  >&lt;p&gt;All the tests passed with latest patch : patch-741-2.txt&lt;/p&gt;</comment>
                            <comment id="12900570" author="nzhang" created="Fri, 20 Aug 2010 04:19:19 +0000"  >&lt;p&gt;Looks good in general. Some minor comments:&lt;br/&gt;
 1) add more test cases for SMB joins. Currently the only test case has only 1 bucket which does not cover the most common use case. Can you add more test cases for more buckets? You can take a look at bucketed join queries included in the client positive tests.&lt;br/&gt;
 2) SMBMapJoinOperator.compareKey() is called for each row so it is critical for performance. In your code the hasNullElement() could be called 4 times in the worse case. If you cache the result it can be called only twice. &lt;/p&gt;

&lt;p&gt;Yongqiang, any further comments?&lt;/p&gt;</comment>
                            <comment id="12900602" author="amareshwari" created="Fri, 20 Aug 2010 07:24:31 +0000"  >&lt;p&gt;Thanks Ning for the comments.&lt;/p&gt;

&lt;p&gt;Patch incorporates the review comments. Looked at smb_mapjoin* query files and updated smb join queries. &lt;/p&gt;</comment>
                            <comment id="12900941" author="nzhang" created="Sat, 21 Aug 2010 00:20:33 +0000"  >&lt;p&gt;The SMB test case still has a minor issue: the tables was created as 2 buckets but there is only 1 file in the tables. This is conflicting to the table schema. If a table is defined as bucketd 2, there should be 2 files in the partition or table. They SMB join takes the 1st file in T1 join the 1st file in T2, and 2nd file in T1 join 2nd file in T2. So the test case should cover this use case. &lt;/p&gt;</comment>
                            <comment id="12901258" author="amareshwari" created="Mon, 23 Aug 2010 04:37:29 +0000"  >&lt;p&gt;Updated smb input with two files. &lt;/p&gt;</comment>
                            <comment id="12901275" author="nzhang" created="Mon, 23 Aug 2010 06:06:59 +0000"  >&lt;p&gt;Looks good except one mintor thing: SerDeUtils.java:369 should return true? Amareshwari, can you upload a new patch and I&apos;ll run unit tests. &lt;/p&gt;

&lt;p&gt;Yongqiang, can you test this patch on the production SMB join queries?&lt;/p&gt;
</comment>
                            <comment id="12901280" author="amareshwari" created="Mon, 23 Aug 2010 06:36:13 +0000"  >&lt;p&gt;Updated the patch. Thanks Ning for your help.&lt;/p&gt;</comment>
                            <comment id="12901503" author="he yongqiang" created="Mon, 23 Aug 2010 17:44:33 +0000"  >&lt;p&gt;+1. The patch looks good to me. &lt;br/&gt;
(Only have one minor comment on the name of &quot;hasNullElements&quot;, should we rename it since this function is used to determine all keys are null?)&lt;/p&gt;
</comment>
                            <comment id="12901508" author="he yongqiang" created="Mon, 23 Aug 2010 17:52:38 +0000"  >&lt;p&gt;also about Ning&apos;s comments:&lt;br/&gt;
&amp;gt;&amp;gt;2) SMBMapJoinOperator.compareKey() is called for each row so it is critical for performance. In your code the hasNullElement() could be called 4 times in the worse case. If you cache the result it can be called only twice.&lt;br/&gt;
Agree. Not sure how much overhead is there, will try to estimate the overhead over production running. That will be great if you can try to cache the null check results, so that it can only happen one time for each key. &lt;/p&gt;</comment>
                            <comment id="12901515" author="nzhang" created="Mon, 23 Aug 2010 18:05:51 +0000"  >&lt;p&gt;Amareshwari, aside from Yongqiang comment, join_null.q&apos;s result is not deterministic &amp;#8211; the SMB joins result in different orders. Can you make it deterministic by adding a &apos;order by&apos; clause at the end of the queries? I&apos;ll attach my test run results&lt;/p&gt;</comment>
                            <comment id="12901517" author="nzhang" created="Mon, 23 Aug 2010 18:07:29 +0000"  >&lt;p&gt;uploading test results join_null.q.out which has conflicts with the patch-741-5.txt.&lt;/p&gt;</comment>
                            <comment id="12901747" author="amareshwari" created="Tue, 24 Aug 2010 06:37:01 +0000"  >&lt;p&gt;Patch with following changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Renamed the method hasNullElements to hasAllNulls&lt;/li&gt;
	&lt;li&gt;Added keyToHasNullsMap to SMBMapJoinOperator to cache whether key has nulls or not, which is populated when the key elements are computed.&lt;/li&gt;
	&lt;li&gt;Added appropriate &quot;order by&quot; clauses to smb join queries in the testcase&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12902004" author="nzhang" created="Tue, 24 Aug 2010 18:28:10 +0000"  >&lt;p&gt;+1. Will commit if tests pass.&lt;/p&gt;</comment>
                            <comment id="12902109" author="nzhang" created="Tue, 24 Aug 2010 22:21:00 +0000"  >&lt;p&gt;Committed. Thanks Amareshwari!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                            <outwardlinks description="is a clone of">
                                        <issuelink>
            <issuekey id="12432443">HIVE-734</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12469118">HIVE-1460</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12471879">HIVE-1552</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12471879">HIVE-1552</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12542970">HIVE-2810</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12471750">HIVE-1544</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12452838" name="join_nulls.q.out" size="27508" author="nzhang" created="Mon, 23 Aug 2010 18:07:29 +0000"/>
                            <attachment id="12452383" name="patch-741-1.txt" size="28025" author="amareshwari" created="Wed, 18 Aug 2010 09:11:28 +0000"/>
                            <attachment id="12452484" name="patch-741-2.txt" size="33149" author="amareshwari" created="Thu, 19 Aug 2010 05:12:28 +0000"/>
                            <attachment id="12452613" name="patch-741-3.txt" size="40093" author="amareshwari" created="Fri, 20 Aug 2010 07:24:31 +0000"/>
                            <attachment id="12452772" name="patch-741-4.txt" size="41414" author="amareshwari" created="Mon, 23 Aug 2010 04:37:29 +0000"/>
                            <attachment id="12452782" name="patch-741-5.txt" size="41413" author="amareshwari" created="Mon, 23 Aug 2010 06:36:13 +0000"/>
                            <attachment id="12452898" name="patch-741-6.txt" size="42905" author="amareshwari" created="Tue, 24 Aug 2010 06:37:01 +0000"/>
                            <attachment id="12452165" name="patch-741.txt" size="7438" author="amareshwari" created="Mon, 16 Aug 2010 11:44:40 +0000"/>
                            <attachment id="12452384" name="smbjoin_nulls.q.txt" size="650" author="amareshwari" created="Wed, 18 Aug 2010 09:11:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>73331</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 14 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0lbhz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>122513</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>