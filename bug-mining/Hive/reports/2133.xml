<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:18:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-6873] DISTINCT clause in aggregates is handled incorrectly by vectorized execution</title>
                <link>https://issues.apache.org/jira/browse/HIVE-6873</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;The vectorized aggregates ignore the DISTINCT clause. This cause incorrect results. Due to how GroupByOperatorDesc adds the DISTINCT keys to the overall aggregate keys the vectorized aggregates do account for the extra key, but they do not process the data correctly for the key. the reduce side the aggregates the input from the vectorized map side to results that are only sometimes correct but mostly incorrect. &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-4607&quot; title=&quot;Support DISTINCT in vectorized aggregates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-4607&quot;&gt;HIVE-4607&lt;/a&gt; tracks the proper fix, but meantime I&apos;m filing a bug to disable vectorized execution if DISTINCT is present. Fix is trivial.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12707443">HIVE-6873</key>
            <summary>DISTINCT clause in aggregates is handled incorrectly by vectorized execution</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rusanu">Remus Rusanu</assignee>
                                    <reporter username="rusanu">Remus Rusanu</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Apr 2014 14:03:19 +0000</created>
                <updated>Fri, 11 Apr 2014 17:19:16 +0000</updated>
                            <resolved>Fri, 11 Apr 2014 15:11:18 +0000</resolved>
                                    <version>0.13.0</version>
                    <version>0.14.0</version>
                                    <fixVersion>0.13.0</fixVersion>
                                    <component>Query Processor</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13964181" author="rusanu" created="Wed, 9 Apr 2014 14:06:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhbutani&quot; class=&quot;user-hover&quot; rel=&quot;rhbutani&quot;&gt;rhbutani&lt;/a&gt; please consider this for 0.13 release.&lt;/p&gt;</comment>
                            <comment id="13964391" author="jnp" created="Wed, 9 Apr 2014 17:07:14 +0000"  >&lt;p&gt;Does the issue impact all aggregates? I have seen that count(distinct..) tests are passing, including tpcds queries.&lt;/p&gt;</comment>
                            <comment id="13964527" author="rusanu" created="Wed, 9 Apr 2014 18:39:40 +0000"  >&lt;p&gt;Allow for COUNT(DISTINCT expr) wich happens to work, by accident, dur to how reduce side handles the aggregate merge for COUNT(DISTINCT)&lt;/p&gt;</comment>
                            <comment id="13964641" author="jnp" created="Wed, 9 Apr 2014 20:39:51 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13965029" author="hiveqa" created="Thu, 10 Apr 2014 05:47:33 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12639447/HIVE-6873.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12639447/HIVE-6873.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 2 failed/errored test(s), 5570 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.ql.security.TestStorageBasedClientSideAuthorizationProvider.testSimplePrivileges
org.apache.hive.service.cli.thrift.TestThriftHttpCLIService.testExecuteStatementAsync
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/2198/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/2198/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/2198/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/2198/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 2 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12639447&lt;/p&gt;</comment>
                            <comment id="13965050" author="rusanu" created="Thu, 10 Apr 2014 06:18:52 +0000"  >&lt;p&gt;Failures are unrelated to the patch&lt;/p&gt;</comment>
                            <comment id="13965068" author="jnp" created="Thu, 10 Apr 2014 06:47:44 +0000"  >&lt;p&gt;It seems to me that all aggregates are working fine. The reason is that in a query like:&lt;br/&gt;
select sum(distinct a) from T group by b;&lt;br/&gt;
The map-side aggregation treats (b, a) as the key, therefore distinct values of a are getting propagated to the reducer, and for the distinct scenario reducer only takes the key and discards the values. &lt;/p&gt;</comment>
                            <comment id="13965099" author="rusanu" created="Thu, 10 Apr 2014 07:45:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jnp&quot; class=&quot;user-hover&quot; rel=&quot;jnp&quot;&gt;jnp&lt;/a&gt; From how I read GroupByOptimizer.java@227, I reckon there are some cases when the reduce side does expect the mapper to had been doing the correct aggregation:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;          &lt;span class=&quot;code-comment&quot;&gt;// Partial aggregation is not done &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; distincts on the mapper
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// However, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the data is bucketed/sorted on the distinct key, partial aggregation
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// can be performed on the mapper.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13965915" author="jnp" created="Thu, 10 Apr 2014 22:01:10 +0000"  >&lt;p&gt;Here is a scenario where we get incorrect result. It shows up on sorted bucketed column with hive.map.groupby.sorted=true, and only on group by queries with no keys.&lt;/p&gt;

&lt;p&gt;Here are the steps:&lt;/p&gt;

&lt;p&gt;hive&amp;gt; Create table T(a int, b int) clustered by (a) sorted by (a) stored as orc;&lt;/p&gt;

&lt;p&gt;load following data:&lt;br/&gt;
300  1&lt;br/&gt;
300  1&lt;br/&gt;
300  1&lt;br/&gt;
300  1&lt;br/&gt;
300  1&lt;/p&gt;

&lt;p&gt;hive&amp;gt; set hive.map.groupby.sorted=true;&lt;/p&gt;

&lt;p&gt;hive&amp;gt; select sum(distinct a) from T;  // Incorrect result.&lt;br/&gt;
hive&amp;gt; select count(distinct a) from T;  // This is also incorrect.&lt;/p&gt;
</comment>
                            <comment id="13965998" author="jnp" created="Thu, 10 Apr 2014 23:32:17 +0000"  >&lt;p&gt;The attached patch fixes the issue by disabling the optimization for sorted/bucketed columns if vectorization is on. This change impacts only the specific scenario being hit in the example above. A test is also added to reproduce the above scenario, and another test for normal distinct case.&lt;/p&gt;</comment>
                            <comment id="13966012" author="ashutoshc" created="Thu, 10 Apr 2014 23:43:28 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13966025" author="rhbutani" created="Thu, 10 Apr 2014 23:52:01 +0000"  >&lt;p&gt;+1 for 0.13&lt;/p&gt;</comment>
                            <comment id="13966179" author="hiveqa" created="Fri, 11 Apr 2014 03:36:55 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12639682/HIVE-6873.3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12639682/HIVE-6873.3.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 5614 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/2216/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/2216/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/2216/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/2216/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12639682&lt;/p&gt;</comment>
                            <comment id="13966357" author="rusanu" created="Fri, 11 Apr 2014 09:16:32 +0000"  >&lt;p&gt;Thanks for finding the problem repro and fix!&lt;/p&gt;</comment>
                            <comment id="13966360" author="rusanu" created="Fri, 11 Apr 2014 09:18:14 +0000"  >&lt;p&gt;set hive.map.groupby.sorted=true; was the missing part for me&#8230;&lt;/p&gt;

&lt;p&gt;From: Jitendra Nath Pandey (JIRA) &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;mailto:jira@apache.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jira@apache.org&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/mail_small.gif&quot; height=&quot;12&quot; width=&quot;13&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;br/&gt;
Sent: Friday, April 11, 2014 1:02 AM&lt;br/&gt;
To: Remus Rusanu&lt;br/&gt;
Subject: &lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Commented&amp;#93;&lt;/span&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-6873&quot; title=&quot;DISTINCT clause in aggregates is handled incorrectly by vectorized execution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-6873&quot;&gt;&lt;del&gt;HIVE-6873&lt;/del&gt;&lt;/a&gt;) DISTINCT clause in aggregates is handled incorrectly by vectorized execution&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;cid:image001.png@01CF557F.FDF58F90&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Jitendra Nath Pandey&amp;lt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jnp&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jnp&lt;/a&gt;&amp;gt; commented on &lt;span class=&quot;error&quot;&gt;&amp;#91;Bug&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-6873&quot; title=&quot;DISTINCT clause in aggregates is handled incorrectly by vectorized execution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-6873&quot;&gt;&lt;del&gt;HIVE-6873&lt;/del&gt;&lt;/a&gt;&amp;lt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-6873&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-6873&lt;/a&gt;&amp;gt;&lt;/p&gt;




&lt;p&gt;Re: DISTINCT clause in aggregates is handled incorrectly by vectorized execution&amp;lt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-6873&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-6873&lt;/a&gt;&amp;gt;&lt;/p&gt;



&lt;p&gt;Here is a scenario where we get incorrect result. It shows up on sorted bucketed column with hive.map.groupby.sorted=true, and only on group by queries with no keys.&lt;/p&gt;

&lt;p&gt;Here are the steps:&lt;/p&gt;

&lt;p&gt;hive&amp;gt; Create table T(a int, b int) clustered by (a) sorted by (a) stored as orc;&lt;/p&gt;

&lt;p&gt;load following data:&lt;br/&gt;
300 1&lt;br/&gt;
300 1&lt;br/&gt;
300 1&lt;br/&gt;
300 1&lt;br/&gt;
300 1&lt;/p&gt;

&lt;p&gt;hive&amp;gt; set hive.map.groupby.sorted=true;&lt;/p&gt;

&lt;p&gt;hive&amp;gt; select sum(distinct a) from T; // Incorrect result.&lt;br/&gt;
hive&amp;gt; select count(distinct a) from T; // This is also incorrect.&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Add Comment&amp;#93;&lt;/span&gt;&amp;lt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-6873#add-comment&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-6873#add-comment&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;Add Comment&amp;lt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-6873#add-comment&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-6873#add-comment&lt;/a&gt;&amp;gt;&lt;/p&gt;






&lt;p&gt;This message was sent by Atlassian JIRA (v6.2#6252-sha1:aa34325)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Atlassian logo&amp;#93;&lt;/span&gt;&lt;/p&gt;



</comment>
                            <comment id="13966630" author="rhbutani" created="Fri, 11 Apr 2014 15:11:18 +0000"  >&lt;p&gt;Committed to trunk and 0.13&lt;br/&gt;
Thanks Jitendra, Remus and Ashutosh&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12639400" name="HIVE-6873.1.patch" size="721" author="rusanu" created="Wed, 9 Apr 2014 14:05:52 +0000"/>
                            <attachment id="12639447" name="HIVE-6873.2.patch" size="791" author="rusanu" created="Wed, 9 Apr 2014 18:39:40 +0000"/>
                            <attachment id="12639682" name="HIVE-6873.3.patch" size="9525" author="jnp" created="Thu, 10 Apr 2014 23:32:17 +0000"/>
                            <attachment id="12639768" name="image001.png" size="1796" author="rusanu" created="Fri, 11 Apr 2014 09:18:14 +0000"/>
                            <attachment id="12639769" name="image002.png" size="1017" author="rusanu" created="Fri, 11 Apr 2014 09:18:14 +0000"/>
                            <attachment id="12639770" name="image003.png" size="1084" author="rusanu" created="Fri, 11 Apr 2014 09:18:14 +0000"/>
                            <attachment id="12639771" name="image004.png" size="2983" author="rusanu" created="Fri, 11 Apr 2014 09:18:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>385766</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 32 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ugfz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>386030</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>