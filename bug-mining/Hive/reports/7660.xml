<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:17:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-23703] Major QB compaction with multiple FileSinkOperators results in data loss and one original file</title>
                <link>https://issues.apache.org/jira/browse/HIVE-23703</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;h4&gt;&lt;a name=&quot;Problems&quot;&gt;&lt;/a&gt;Problems&lt;/h4&gt;

&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
drop table &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; exists tbl2;
create transactional table tbl2 (a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, b &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) clustered by (a) into 4 buckets stored as ORC TBLPROPERTIES(&lt;span class=&quot;code-quote&quot;&gt;&apos;transactional&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;transactional_properties&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;&apos;&lt;/span&gt;);
insert into tbl2 values(1,2),(1,3),(1,4),(2,2),(2,3),(2,4);
insert into tbl2 values(3,2),(3,3),(3,4),(4,2),(4,3),(4,4);
insert into tbl2 values(5,2),(5,3),(5,4),(6,2),(6,3),(6,4);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;E.g. in the example above, bucketId=0 when a=2 and a=6.&lt;/p&gt;

&lt;p&gt;1. Data loss&#160;&lt;br/&gt;
 In non-acid tables, an operator&apos;s temp files are named with their task id. Because of this snippet, temp files in the FileSinkOperator for compaction tables are identified by their bucket_id.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (conf.isCompactionTable()) {
 fsp.initializeBucketPaths(filesIdx, AcidUtils.BUCKET_PREFIX + &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(AcidUtils.BUCKET_DIGITS, bucketId),
 isNativeTable(), isSkewedStoredAsSubDirectories);
 } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
 fsp.initializeBucketPaths(filesIdx, taskId, isNativeTable(), isSkewedStoredAsSubDirectories);
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So 2 temp files containing data with a=2 and a=6 will be named bucket_0 and not 000000_0 and 000000_1 as they would normally.&lt;br/&gt;
 In FileSinkOperator.commit, when data with a=2, filename: bucket_0 is moved from _task_tmp.-ext-10002 to _tmp.-ext-10002, it overwrites the files already there with a=6 data, because it too is named bucket_0. You can see in the logs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 WARN [LocalJobRunner Map Task Executor #0] exec.FileSinkOperator: Target path file:.../hive/ql/target/tmp/org.apache.hadoop.hive.ql.TestTxnNoBuckets-1591107230237/warehouse/testmajorcompaction/base_0000002_v0000013/.hive-staging_hive_2020-06-02_07-15-21_771_8551447285061957908-1/_tmp.-ext-10002/bucket_00000 with a size 610 exists. Trying to delete it.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;2. Results in one original file&lt;br/&gt;
 OrcFileMergeOperator merges the results of the FSOp into 1 file named 000000_0.&lt;/p&gt;
&lt;h4&gt;&lt;a name=&quot;Fix&quot;&gt;&lt;/a&gt;Fix&lt;/h4&gt;

&lt;p&gt;1. FSOp will store data as: taskid/bucketId. e.g. 0_0/bucket_0&lt;/p&gt;

&lt;p&gt;2. OrcMergeFileOp, instead of merging a bunch of files into 1 file named 000000_0, will merge all files named bucket_0 into one file named bucket_0, and so on.&lt;/p&gt;

&lt;p&gt;3. MoveTask will get rid of the taskId directories if present and only move the bucket files in them, in case OrcMergeFileOp is not run.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13311745">HIVE-23703</key>
            <summary>Major QB compaction with multiple FileSinkOperators results in data loss and one original file</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="klcopp">Karen Coppage</assignee>
                                    <reporter username="klcopp">Karen Coppage</reporter>
                        <labels>
                            <label>compaction</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 16 Jun 2020 14:58:32 +0000</created>
                <updated>Thu, 17 Nov 2022 08:48:29 +0000</updated>
                            <resolved>Tue, 23 Jun 2020 09:17:21 +0000</resolved>
                                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="17141858" author="kuczoram" created="Mon, 22 Jun 2020 09:31:18 +0000"  >&lt;p&gt;+1&lt;br/&gt;
Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=klcopp&quot; class=&quot;user-hover&quot; rel=&quot;klcopp&quot;&gt;klcopp&lt;/a&gt; for the patch!&lt;/p&gt;</comment>
                            <comment id="17142780" author="klcopp" created="Tue, 23 Jun 2020 09:17:09 +0000"  >&lt;p&gt;Pushed to master. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kuczoram&quot; class=&quot;user-hover&quot; rel=&quot;kuczoram&quot;&gt;kuczoram&lt;/a&gt;,&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvary&quot; class=&quot;user-hover&quot; rel=&quot;pvary&quot;&gt;pvary&lt;/a&gt;&#160;and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkuzmenko&quot; class=&quot;user-hover&quot; rel=&quot;dkuzmenko&quot;&gt;dkuzmenko&lt;/a&gt;&#160;for reviewing!&lt;/p&gt;</comment>
                            <comment id="17149167" author="pvargacl" created="Wed, 1 Jul 2020 07:02:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=klcopp&quot; class=&quot;user-hover&quot; rel=&quot;klcopp&quot;&gt;klcopp&lt;/a&gt;&#160;looks like one of the new test is flaky:&lt;br/&gt;
&lt;a href=&quot;http://ci.hive.apache.org/blue/organizations/jenkins/hive-precommit/detail/PR-1143/6/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ci.hive.apache.org/blue/organizations/jenkins/hive-precommit/detail/PR-1143/6/tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17149194" author="pvary" created="Wed, 1 Jul 2020 07:45:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvargacl&quot; class=&quot;user-hover&quot; rel=&quot;pvargacl&quot;&gt;pvargacl&lt;/a&gt;: Could you please check with the flaky test jenkins: &lt;a href=&quot;http://ci.hive.apache.org/job/hive-flaky-check/55/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ci.hive.apache.org/job/hive-flaky-check/55/&lt;/a&gt;&lt;br/&gt;
If it is flaky, then we should disable it until it is fixed.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Peter&lt;/p&gt;</comment>
                            <comment id="17151822" author="pvargacl" created="Mon, 6 Jul 2020 07:11:21 +0000"  >&lt;p&gt;I have run the jenkins job with one test case and the whole test class, both of them passed, so it must have been some intermittent issue.&lt;/p&gt;</comment>
                            <comment id="17151850" author="klcopp" created="Mon, 6 Jul 2020 07:51:39 +0000"  >&lt;p&gt;Ok, thanks for checking &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvargacl&quot; class=&quot;user-hover&quot; rel=&quot;pvargacl&quot;&gt;pvargacl&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13267117">HIVE-22474</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13321459">HIVE-24015</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 19 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fwhs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>