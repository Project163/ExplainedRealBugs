<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:38:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-11710] Beeline embedded mode doesn&apos;t output query progress after setting any session property</title>
                <link>https://issues.apache.org/jira/browse/HIVE-11710</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Connect to beeline embedded mode &lt;tt&gt;beeline -u jdbc:hive2://&lt;/tt&gt;. Then set anything in the session like &lt;tt&gt;set aa=true;&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;After that, any query like &lt;tt&gt;select count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; from src;&lt;/tt&gt; will only output result but no query progress.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12861096">HIVE-11710</key>
            <summary>Beeline embedded mode doesn&apos;t output query progress after setting any session property</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aihuaxu">Aihua Xu</assignee>
                                    <reporter username="aihuaxu">Aihua Xu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 Sep 2015 19:12:46 +0000</created>
                <updated>Wed, 12 Dec 2018 13:59:22 +0000</updated>
                            <resolved>Thu, 22 Oct 2015 23:30:03 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>Beeline</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14738776" author="aihuaxu" created="Thu, 10 Sep 2015 13:56:50 +0000"  >&lt;p&gt;Currently we don&apos;t set SessionState.info to System.out which causes the query progress to output to System.err when set command is issued.&lt;/p&gt;

&lt;p&gt;Now with the change, the progress is output to console as expected.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;0: jdbc:hive2://&amp;gt; set a = 0;
No rows affected (0.003 seconds)
0: jdbc:hive2://&amp;gt; select count(*) from src;
Query ID = axu_20150910095139_f396d686-b4b1-4c5c-b8ed-4f74e2362920
Total jobs = 1
Launching Job 1 out of 1
Number of reduce tasks determined at compile time: 1
In order to change the average load for a reducer (in bytes):
  set hive.exec.reducers.bytes.per.reducer=&amp;lt;number&amp;gt;
In order to limit the maximum number of reducers:
  set hive.exec.reducers.max=&amp;lt;number&amp;gt;
In order to set a constant number of reducers:
  set mapreduce.job.reduces=&amp;lt;number&amp;gt;
Starting Job = job_local386038793_0002, Tracking URL = http://localhost:8080/
Kill Command = /Users/axu/Documents/workspaces/tools/hadoop/hadoop-2.6.0/bin/hadoop job  -kill job_local386038793_0002
Hadoop job information for Stage-1: number of mappers: 0; number of reducers: 0
2015-09-10 09:51:40,613 Stage-1 map = 100%,  reduce = 100%
Ended Job = job_local386038793_0002
MapReduce Jobs Launched: 
Stage-Stage-1:  HDFS Read: 0 HDFS Write: 0 SUCCESS
Total MapReduce CPU Time Spent: 0 msec
OK
+------+--+
| _c0  |
+------+--+
| 2    |
+------+--+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14738780" author="aihuaxu" created="Thu, 10 Sep 2015 13:58:19 +0000"  >&lt;p&gt;I didn&apos;t create code review for this since it&apos;s a simple change. Submit the first patch to see if it would break anything.&lt;/p&gt;</comment>
                            <comment id="14739219" author="xuefuz" created="Thu, 10 Sep 2015 17:46:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aihuaxu&quot; class=&quot;user-hover&quot; rel=&quot;aihuaxu&quot;&gt;aihuaxu&lt;/a&gt;, thanks for working on this. Could you please point out in the code how set command changes the progress output to System.err without your patch?&lt;/p&gt;</comment>
                            <comment id="14739314" author="aihuaxu" created="Thu, 10 Sep 2015 18:33:27 +0000"  >&lt;p&gt;Thanks Xuefu for reviewing the code.&lt;/p&gt;

&lt;p&gt;Actually it&apos;s following magic line which sets sessionState.err to System.err while we didn&apos;t set sessionState.info. &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      // TODO: for hadoop jobs, progress is printed out to session.err,		
74	      // we should find a way to feed back job progress to client		
75	      sessionState.err = new PrintStream(System.err, true, &quot;UTF-8&quot;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In SessionState class, it will redirect to System.err for info stream when SessionState.info is null.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    public static PrintStream getInfoStream() {
      SessionState ss = SessionState.get();
      return ((ss != null) &amp;amp;&amp;amp; (ss.info != null)) ? ss.info : getErrStream();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After taking a close look, the patch may not be a perfect fix. Actually SessionState.err was closed after set command (in HiveCommandOperation.java), but the object itself is left there. So when info is null and err is not null (but invalid), nothing is printed. Maybe we should recover SessionState.err after the set command is done.&lt;/p&gt;
</comment>
                            <comment id="14739348" author="xuefuz" created="Thu, 10 Sep 2015 18:50:36 +0000"  >&lt;p&gt;Could we also check what Hive CLI is doing w.r.t this?&lt;/p&gt;</comment>
                            <comment id="14739409" author="aihuaxu" created="Thu, 10 Sep 2015 19:17:15 +0000"  >&lt;p&gt;CLI sets as follows in CLIDriver.java.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      ss.out = new PrintStream(System.out, true, &quot;UTF-8&quot;);
      ss.info = new PrintStream(System.err, true, &quot;UTF-8&quot;);
      ss.err = new CachingPrintStream(System.err, true, &quot;UTF-8&quot;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="14739441" author="aihuaxu" created="Thu, 10 Sep 2015 19:37:50 +0000"  >&lt;p&gt;Actually after &lt;tt&gt;IOUtils.cleanup(LOG, parentSession.getSessionState().err);&lt;/tt&gt;, System.err will always be in a closed state although the object is there.&lt;/p&gt;

&lt;p&gt;Seems We shouldn&apos;t close System.err stream.&lt;/p&gt;</comment>
                            <comment id="14739518" author="aihuaxu" created="Thu, 10 Sep 2015 20:13:21 +0000"  >&lt;p&gt;Attach the new patch. &lt;/p&gt;

&lt;p&gt;We only close file stream, not System.err and System.out since if they are closed, later we won&apos;t be able to write to them anymore.&lt;/p&gt;</comment>
                            <comment id="14741703" author="hiveqa" created="Fri, 11 Sep 2015 23:10:13 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12755398/HIVE-11710.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12755398/HIVE-11710.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 3 failed/errored test(s), 9422 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation
org.apache.hive.hcatalog.hbase.TestPigHBaseStorageHandler.org.apache.hive.hcatalog.hbase.TestPigHBaseStorageHandler
org.apache.hive.hcatalog.streaming.TestStreaming.testTransactionBatchEmptyCommit
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5242/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5242/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5242/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5242/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5242/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5242/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12755398 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14743611" author="aihuaxu" created="Mon, 14 Sep 2015 14:45:29 +0000"  >&lt;p&gt;The failures are not caused by the patch.&lt;/p&gt;</comment>
                            <comment id="14744393" author="xuefuz" created="Mon, 14 Sep 2015 22:20:23 +0000"  >&lt;p&gt;In  HiveCommandOperation.tearDownSessionIO(), should we just close the result of this: new FileOutputStream(sessionState.getTmpOutputFile())? It looks like that we don&apos;t need to close either ss.out or ss.err. Otherwise, if one operation gets closed for any reason (such as timeout), then other operations in the same user session will get ss.out and ss.err that&apos;s closed. It&apos;s my understanding that session state is shared among operations in a hive session.&lt;/p&gt;</comment>
                            <comment id="14745465" author="aihuaxu" created="Tue, 15 Sep 2015 13:41:07 +0000"  >&lt;p&gt;Yeah. You are right. It really depends on how ss.out is used. Originally somehow I thought it&apos;s only used by this file, but actually it&apos;s not. I will remove that as well. &lt;/p&gt;</comment>
                            <comment id="14745483" author="aihuaxu" created="Tue, 15 Sep 2015 13:50:53 +0000"  >&lt;p&gt;OK. Seems it&apos;s fine since from the close() call shown below, we are deleting that temp file any way at that moment. So at that moment when close() is called, we can&apos;t write to that tmp file anyway since the file is getting deleted (&lt;tt&gt;cleanTmpFile()&lt;/tt&gt;).&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  public void close() throws HiveSQLException {
    setState(OperationState.CLOSED);
    tearDownSessionIO();
    cleanTmpFile();
    cleanupOperationLog();
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14875868" author="xuefuz" created="Fri, 18 Sep 2015 16:16:46 +0000"  >&lt;p&gt;Do you have any thoughts on this?&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;It looks like that we don&apos;t need to close either ss.out or ss.err. Otherwise, if one operation gets closed for any reason (such as timeout), then other operations in the same user session will get ss.out and ss.err that&apos;s closed. &lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="14876120" author="aihuaxu" created="Fri, 18 Sep 2015 18:37:32 +0000"  >&lt;p&gt;Xuefu, as I posted above, actually when close() is called, the temp file which ss.out is using will be deleted anyway so other operations shouldn&apos;t be allowed to use if close() is already called somewhere else. &lt;/p&gt;

&lt;p&gt;Yeah. I agree that seems like we may potentially run into such issue, but it would run into such issue even I&apos;m not closing ss.out since the tmp file is deleted by &lt;tt&gt;cleanTmpFile();&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;To tell the truth, I don&apos;t know exactly why we are setting ss.out in HiveCommandOptions. I can change to not to close ss.out, but it would leave to resource leaking since we are not closing the file. &lt;/p&gt;</comment>
                            <comment id="14902821" author="aihuaxu" created="Tue, 22 Sep 2015 15:43:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt; Attached the new patch which doesn&apos;t close the ss.out or ss.err. Can you help take a look the new patch?&lt;/p&gt;</comment>
                            <comment id="14903471" author="xuefuz" created="Tue, 22 Sep 2015 21:29:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aihuaxu&quot; class=&quot;user-hover&quot; rel=&quot;aihuaxu&quot;&gt;aihuaxu&lt;/a&gt;, your new patch looks good. One thing I&apos;m not 100% sure is what happens when deleting file w/o closing it first. &lt;/p&gt;

&lt;p&gt;Secondly, we could leak either &quot;new PrintStream&quot; or &quot;new FileOutputStream&quot; or both if there is any exception or if we don&apos;t close ss.out. This seems minor but reliable code is ideal.&lt;/p&gt;

&lt;p&gt;Thus, I suggest that we make sure that these objects are closed properly whether there is an exception or not.&lt;/p&gt;

&lt;p&gt;As you can see that session state is complete thread-unsafe (ref. &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-11402&quot; title=&quot;HS2 - add an option to disallow parallel query execution within a single Session&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-11402&quot;&gt;&lt;del&gt;HIVE-11402&lt;/del&gt;&lt;/a&gt;). However, this has nothing to do the problem you&apos;re addressing.&lt;/p&gt;</comment>
                            <comment id="14904121" author="hiveqa" created="Wed, 23 Sep 2015 08:00:13 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12761666/HIVE-11710.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12761666/HIVE-11710.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 4 failed/errored test(s), 9575 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_vector_groupby_reduce
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_vector_groupby_reduce
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation
org.apache.hive.hcatalog.hbase.TestPigHBaseStorageHandler.org.apache.hive.hcatalog.hbase.TestPigHBaseStorageHandler
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5381/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5381/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5381/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5381/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5381/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5381/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12761666 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14904502" author="aihuaxu" created="Wed, 23 Sep 2015 13:26:48 +0000"  >&lt;p&gt;Yeah. The second patch will leak &quot;PrintStream&quot;, so I think the first patch is reasonable actually in which will close the stream to the temp file before deleting the temp file. Let me check if the close() function will be called when an exception is thrown.&lt;/p&gt;</comment>
                            <comment id="14904628" author="aihuaxu" created="Wed, 23 Sep 2015 15:11:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt; I double checked. The first patch is good to handle closing the file handler when the current session is getting closing. The second patch will have the file handler leaking. &lt;/p&gt;

&lt;p&gt;Whether an exception occurs or not, hive will close the session, in which it will call &lt;tt&gt;HiveCommandOperation:close()&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;The first patch will see if the stream is a file stream or standard stream. If it&apos;s a file stream, then we should close it at last.&lt;/p&gt;

&lt;p&gt;Xuefu, how do you think? Should we proceed with the first patch?&lt;/p&gt;</comment>
                            <comment id="14904882" author="xuefuz" created="Wed, 23 Sep 2015 17:39:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aihuaxu&quot; class=&quot;user-hover&quot; rel=&quot;aihuaxu&quot;&gt;aihuaxu&lt;/a&gt;, looking at the two patches, I seem to see that either patch has a possibility of leaking resources, even if we consider in a single thread. The possible leaks are:&lt;/p&gt;

&lt;p&gt;1. If new new FileOutputStream() is successful but new PrintStream() is not, then the FileOutputStream instance is never closed.&lt;br/&gt;
2. In SQLOperation class, we never close these streams.&lt;/p&gt;

&lt;p&gt;I think the only change we need to make in HiveCommandOperation is to fix #1. The original tearDownSessionIO() seems fine with the changes in SQLOperation.&lt;/p&gt;</comment>
                            <comment id="14905037" author="aihuaxu" created="Wed, 23 Sep 2015 18:57:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt; Regarding #2, in SQLOperation class, the streams are using System.out and System.err. We shouldn&apos;t close them, right? If we did that, then later we wouldn&apos;t be able to write to System.out or System.err (actually that is the exact same issue as this issue).&lt;/p&gt;

&lt;p&gt;For #1, that is a possible leak. I will fix that.&lt;/p&gt;

&lt;p&gt;Let me know if I understand correctly on #2.&lt;/p&gt;

</comment>
                            <comment id="14905041" author="xuefuz" created="Wed, 23 Sep 2015 19:02:24 +0000"  >&lt;p&gt;For #2, I meant that we need something similar to HiveCommanOperation.tearDownSessionIO() in which the streams are closed. Each SQLOperation will initialize the streams and close them when done. Isn&apos;t this expected?&lt;/p&gt;</comment>
                            <comment id="14905070" author="aihuaxu" created="Wed, 23 Sep 2015 19:17:42 +0000"  >&lt;p&gt;For SQLOperation, the stream are System.out and System.err. We can&apos;t/shouldn&apos;t close them. &lt;/p&gt;

&lt;p&gt;That is how issue &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-11710&quot; title=&quot;Beeline embedded mode doesn&amp;#39;t output query progress after setting any session property&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-11710&quot;&gt;&lt;del&gt;HIVE-11710&lt;/del&gt;&lt;/a&gt; arises that we closed System.out in HiveCommandOperation, then later we can&apos;t write to System.out anymore for any sql.&lt;/p&gt;</comment>
                            <comment id="14905073" author="aihuaxu" created="Wed, 23 Sep 2015 19:18:47 +0000"  >&lt;p&gt;We will close File based stream, not standard System.out and System.err.&lt;/p&gt;</comment>
                            <comment id="14905087" author="xuefuz" created="Wed, 23 Sep 2015 19:27:11 +0000"  >&lt;blockquote&gt;
&lt;p&gt;For SQLOperation, the stream are System.out and System.err. We can&apos;t/shouldn&apos;t close them.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The might be some misunderstanding. We are opening the streams in the constructor (changes you made), and closing them when done (changes to be made). The same will happen to the subsequent queries. I don&apos;t understand why this still has the original problem. &lt;/p&gt;</comment>
                            <comment id="14905112" author="aihuaxu" created="Wed, 23 Sep 2015 19:41:13 +0000"  >&lt;p&gt;Indeed that we have misunderstanding. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Now I know what you mean. Actually when you close e.g., System.err or System.out in one place, later you will never reopen it again. So &lt;tt&gt;sessionState.out = new PrintStream(System.out, true, CharEncoding.UTF_8);&lt;/tt&gt; will create the stream object but the internal &quot;out&quot; will be still in &quot;closed&quot; state.   That&apos;s why I have to detect if it&apos;s a file based stream or not. If it is, then we close the stream; if not, we should leave it open.&lt;/p&gt;
</comment>
                            <comment id="14905128" author="xuefuz" created="Wed, 23 Sep 2015 19:54:04 +0000"  >&lt;p&gt;I see. If we don&apos;t close the PrintStream instances, won&apos;t there be leaks? Looks like we need to close these wrapper streams while keeping sys.out, sys.err, etc. open.&lt;/p&gt;</comment>
                            <comment id="14905158" author="aihuaxu" created="Wed, 23 Sep 2015 20:07:50 +0000"  >&lt;p&gt;PrintStream.close() will do &quot;flushing the stream and then closing the underlying output stream&quot; from the doc. Seems I need to add &quot;flushing the stream&quot; while keeping the underlying output stream open&quot;.&lt;/p&gt;
</comment>
                            <comment id="14905187" author="aihuaxu" created="Wed, 23 Sep 2015 20:24:50 +0000"  >&lt;p&gt;New patch which will flush the content when the session is closing.&lt;/p&gt;</comment>
                            <comment id="14905382" author="xuefuz" created="Wed, 23 Sep 2015 22:03:08 +0000"  >&lt;p&gt;Does the following pseudo code helps a little bit?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyPrintStream &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; PrintStream {
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isFileIO = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; MyPrintStream(...) {
  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.flush();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( file out stream) {
      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.close();
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
       &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.flush();
    }
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14907772" author="hiveqa" created="Fri, 25 Sep 2015 07:54:32 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12761965/HIVE-11710.3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12761965/HIVE-11710.3.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 4 failed/errored test(s), 9568 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestMiniTezCliDriver-vector_grouping_sets.q-scriptfile1.q-union2.q-and-12-more - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_vector_groupby_reduce
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_vector_groupby_reduce
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5408/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5408/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5408/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5408/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5408/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5408/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12761965 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14959103" author="aihuaxu" created="Thu, 15 Oct 2015 15:46:40 +0000"  >&lt;p&gt;Seems &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-11579&quot; title=&quot;Invoke the set command will close standard error output[beeline-cli]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-11579&quot;&gt;&lt;del&gt;HIVE-11579&lt;/del&gt;&lt;/a&gt; fixed one related issue, but the current incorrect behavior still exists.  1. There could be temp file handler leaking from HIveCommandOption class if somehow there are exception. 2. We still need to reset SessionState.out/info/err to System.out/err in SQLOperation, otherwise for embedded mode, the beeline client output will be redirected to the files, not to the console. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Ferd&quot; class=&quot;user-hover&quot; rel=&quot;Ferd&quot;&gt;Ferd&lt;/a&gt; You worked on &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-11579&quot; title=&quot;Invoke the set command will close standard error output[beeline-cli]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-11579&quot;&gt;&lt;del&gt;HIVE-11579&lt;/del&gt;&lt;/a&gt; recently and probably know that code well. There is a possibility that the temp file handlers are not closed if there is an exception during the following code, correct? And also we need to flush the output rather than closing the stream if the stream points to System.out/.err. right?&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      sessionState.out =
          new PrintStream(new FileOutputStream(sessionState.getTmpOutputFile()), true, CharEncoding.UTF_8);
      sessionState.err =
          new PrintStream(new FileOutputStream(sessionState.getTmpErrOutputFile()), true,CharEncoding.UTF_8);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt;  Sorry. Didn&apos;t get time to work on that.  MyPrintStream class will be cleaner, but it&apos;s not easy to differentiate if it&apos;s file based or not from the stream itself since System.out or System.err can also point to file based stream as well. So it&apos;s tight to the class HiveCommandOperation class themselves and we may need to pass a flag &quot;flushOnClose&quot; to the MyPrintStream class. Let me look into that.&lt;/p&gt;</comment>
                            <comment id="14959168" author="ferd" created="Thu, 15 Oct 2015 16:25:10 +0000"  >&lt;p&gt;Thank you for reaching me. I Agree that we should never close the standard err and out stream. Seems &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-11579&quot; title=&quot;Invoke the set command will close standard error output[beeline-cli]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-11579&quot;&gt;&lt;del&gt;HIVE-11579&lt;/del&gt;&lt;/a&gt; didn&apos;t addressing the Command Handler code path. Could you add some unit test for this as well? &lt;/p&gt;</comment>
                            <comment id="14959358" author="aihuaxu" created="Thu, 15 Oct 2015 18:28:27 +0000"  >&lt;p&gt;OK. Seems we don&apos;t need flush the string manually since autoFlush is set to true in PrintStream {{PrintStream(OutputStream out, boolean autoFlush, String encoding) }}.&lt;/p&gt;</comment>
                            <comment id="14959364" author="aihuaxu" created="Thu, 15 Oct 2015 18:29:23 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Ferd&quot; class=&quot;user-hover&quot; rel=&quot;Ferd&quot;&gt;Ferd&lt;/a&gt; I will try to add one unit test to cover that.&lt;/p&gt;</comment>
                            <comment id="14959601" author="aihuaxu" created="Thu, 15 Oct 2015 20:56:30 +0000"  >&lt;p&gt;Attached the new patch which will close the streams if there is an exception in HIveCommandOperation. Reset the streams for SQLOperation to standard out/err when initializing.&lt;/p&gt;</comment>
                            <comment id="14961636" author="hiveqa" created="Sat, 17 Oct 2015 01:28:02 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12766875/HIVE-11710.4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12766875/HIVE-11710.4.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 4 failed/errored test(s), 9698 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_udf_explode
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_udtf_explode
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation
org.apache.hive.jdbc.TestSSL.testSSLVersion
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5682/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5682/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5682/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5682/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5682/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5682/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12766875 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14963478" author="aihuaxu" created="Mon, 19 Oct 2015 15:36:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt; can you help review the new patch? &lt;/p&gt;</comment>
                            <comment id="14963592" author="xuefuz" created="Mon, 19 Oct 2015 16:48:54 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14969193" author="aihuaxu" created="Thu, 22 Oct 2015 14:00:03 +0000"  >&lt;p&gt;Xuefu, can you help submit the patch?&lt;/p&gt;</comment>
                            <comment id="14970097" author="xuefuz" created="Thu, 22 Oct 2015 23:30:03 +0000"  >&lt;p&gt;Committed to master. Thanks, Aihua.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13203987">HIVE-21033</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12761666" name="HIVE-11710.2.patch" size="5210" author="aihuaxu" created="Tue, 22 Sep 2015 15:42:36 +0000"/>
                            <attachment id="12761965" name="HIVE-11710.3.patch" size="5855" author="aihuaxu" created="Wed, 23 Sep 2015 20:24:50 +0000"/>
                            <attachment id="12766875" name="HIVE-11710.4.patch" size="6569" author="aihuaxu" created="Thu, 15 Oct 2015 20:52:38 +0000"/>
                            <attachment id="12755398" name="HIVE-11710.patch" size="5070" author="aihuaxu" created="Fri, 11 Sep 2015 13:04:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 4 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jo0f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>