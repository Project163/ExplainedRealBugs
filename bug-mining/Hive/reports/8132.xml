<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:21:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-25734] Wrongly-typed constant in case expression leads to incorrect empty result</title>
                <link>https://issues.apache.org/jira/browse/HIVE-25734</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The type of constants in case expressions should be inferred, if possible, by the &quot;surrounding&quot; input reference columns, if any.&lt;/p&gt;

&lt;p&gt;Consider the following table and query:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
create external table test_case (row_seq smallint, row_desc string) stored as parquet;
insert into test_case values (1, &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;);
insert into test_case values (2, &lt;span class=&quot;code-quote&quot;&gt;&apos;aa&apos;&lt;/span&gt;);
insert into test_case values (6, &lt;span class=&quot;code-quote&quot;&gt;&apos;aaaaaa&apos;&lt;/span&gt;);

with base_t as (select row_seq, row_desc,
  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; row_seq
    when 1 then &lt;span class=&quot;code-quote&quot;&gt;&apos;34&apos;&lt;/span&gt;
    when 6 then &lt;span class=&quot;code-quote&quot;&gt;&apos;35&apos;&lt;/span&gt;
    when 2 then &lt;span class=&quot;code-quote&quot;&gt;&apos;36&apos;&lt;/span&gt;
  end as zb from test_case where row_seq in (1,2,6))
select row_seq, row_desc, zb from base_t where zb &amp;lt;&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;34&apos;&lt;/span&gt;;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The aforementioned query fails by returning an empty results, while &quot;1 a 34&quot; is expected.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;To understand the root cause, let&apos;s consider the debug input and output of some related CBO rules which are triggered during the evaluation of the query:&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;--$0 is the column &apos;row_seq&apos;
1. HiveReduceExpressionsRule
Input: AND(IN($0, 1:SMALLINT, 2:SMALLINT, 6:SMALLINT), &amp;lt;&amp;gt;(CASE(=($0, 1:INTEGER), &apos;34&apos;:VARCHAR, =($0, 6:INTEGER), &apos;35&apos;:VARCHAR, =($0, 2:INTEGER), &apos;36&apos;:VARCHAR, null:VARCHAR), &apos;34&apos;:CHAR(2)))
Output: AND(IN($0, 1:SMALLINT, 2:SMALLINT, 6:SMALLINT), OR(=($0, 6:INTEGER), =($0, 2:INTEGER)), IS NOT TRUE(=($0, 1:INTEGER)))
2. HivePointLookupOptimizerRule.RexTransformIntoInClause
Input: AND(IN($0, 1:SMALLINT, 2:SMALLINT, 6:SMALLINT), OR(=($0, 6:INTEGER), =($0, 2:INTEGER)), IS NOT TRUE(=($0, 1:INTEGER)))
Output: AND(IN($0, 1:SMALLINT, 2:SMALLINT, 6:SMALLINT), IN($0, 6:INTEGER, 2:INTEGER), IS NOT TRUE(=($0, 1:INTEGER)))
3. HivePointLookupOptimizerRule.RexMergeInClause
Input: AND(IN($0, 1:SMALLINT, 2:SMALLINT, 6:SMALLINT), IN($0, 6:INTEGER, 2:INTEGER), IS NOT TRUE(=($0, 1:INTEGER)))
Output: false&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the first part, we can see that the constants are correctly typed as &quot;SMALLINT&quot; in the first part of the &quot;AND&quot; operand, while they are typed as &quot;INTEGER&quot; for the &quot;CASE&quot; expression, despite the input reference &quot;$0&quot; being available for inferring a more precise type.&lt;/p&gt;

&lt;p&gt;This type difference makes &quot;HivePointLookupOptimizerRule.RexMergeInClause&quot; missing the commonality between the two &quot;IN&quot; expressions, whose intersection is considered empty, hence the empty result.&lt;/p&gt;

&lt;p&gt;Providing a more refined type inference for &quot;case&quot; expressions should fix the issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13413479">HIVE-25734</key>
            <summary>Wrongly-typed constant in case expression leads to incorrect empty result</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="asolimando">Alessandro Solimando</assignee>
                                    <reporter username="asolimando">Alessandro Solimando</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 23 Nov 2021 21:10:16 +0000</created>
                <updated>Thu, 27 Feb 2025 10:30:05 +0000</updated>
                            <resolved>Tue, 30 Nov 2021 08:55:41 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                    <component>CBO</component>
                    <component>Query Planning</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="17450963" author="kgyrtkirk" created="Tue, 30 Nov 2021 08:55:41 +0000"  >&lt;p&gt;merged into master. Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=asolimando&quot; class=&quot;user-hover&quot; rel=&quot;asolimando&quot;&gt;asolimando&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13609995">HIVE-28792</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 50 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0x0yw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>