<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:53:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-16299] MSCK REPAIR TABLE should enforce partition key order when adding unknown partitions</title>
                <link>https://issues.apache.org/jira/browse/HIVE-16299</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/metadata/HiveMetaStoreChecker.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/metadata/HiveMetaStoreChecker.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;static String getPartitionName(Path tablePath, Path partitionPath, Set&amp;lt;String&amp;gt; partCols)&lt;/p&gt;

&lt;p&gt;------------------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;MSCK REPAIR validates that any sub-directory is in the format col=val and that there is indeed a partition column named &quot;col&quot;.&lt;br/&gt;
However, there is no validation of the partition column location and as a result false partitions are being created and so are directories that match those partitions. &lt;/p&gt;

&lt;p&gt;e.g. 1&lt;/p&gt;

&lt;p&gt;hive&amp;gt; dfs -mkdir -p /user/hive/warehouse/t/a=1/a=2/a=3/b=4/c=5;&lt;br/&gt;
hive&amp;gt; create external table t (i int) partitioned by (a int,b int,c int) ;&lt;br/&gt;
OK&lt;br/&gt;
hive&amp;gt; msck repair table t;&lt;br/&gt;
OK&lt;br/&gt;
Partitions not in metastore:	t:a=1/a=2/a=3/b=4/c=5&lt;br/&gt;
Repair: Added partition to metastore t:a=1/a=2/a=3/b=4/c=5&lt;br/&gt;
Time taken: 0.563 seconds, Fetched: 2 row(s)&lt;br/&gt;
hive&amp;gt; show partitions t;&lt;br/&gt;
OK&lt;br/&gt;
a=3/b=4/c=5&lt;br/&gt;
hive&amp;gt; dfs -ls -R /user/hive/warehouse/t;&lt;br/&gt;
drwxr-xr-x   - cloudera supergroup          0 2017-03-26 13:07 /user/hive/warehouse/t/a=1&lt;br/&gt;
drwxr-xr-x   - cloudera supergroup          0 2017-03-26 13:07 /user/hive/warehouse/t/a=1/a=2&lt;br/&gt;
drwxr-xr-x   - cloudera supergroup          0 2017-03-26 13:07 /user/hive/warehouse/t/a=1/a=2/a=3&lt;br/&gt;
drwxr-xr-x   - cloudera supergroup          0 2017-03-26 13:07 /user/hive/warehouse/t/a=1/a=2/a=3/b=4&lt;br/&gt;
drwxr-xr-x   - cloudera supergroup          0 2017-03-26 13:07 /user/hive/warehouse/t/a=1/a=2/a=3/b=4/c=5&lt;br/&gt;
drwxrwxrwx   - cloudera supergroup          0 2017-03-26 13:07 /user/hive/warehouse/t/a=3&lt;br/&gt;
drwxrwxrwx   - cloudera supergroup          0 2017-03-26 13:07 /user/hive/warehouse/t/a=3/b=4&lt;br/&gt;
drwxrwxrwx   - cloudera supergroup          0 2017-03-26 13:07 /user/hive/warehouse/t/a=3/b=4/c=5&lt;/p&gt;

&lt;p&gt;e.g. 2&lt;br/&gt;
hive&amp;gt; dfs -mkdir -p /user/hive/warehouse/t/c=3/b=2/a=1;&lt;br/&gt;
hive&amp;gt; create external table t (i int) partitioned by (a int,b int,c int);&lt;br/&gt;
OK&lt;br/&gt;
hive&amp;gt; msck repair table t;&lt;br/&gt;
OK&lt;br/&gt;
Partitions not in metastore:	t:c=3/b=2/a=1&lt;br/&gt;
Repair: Added partition to metastore t:c=3/b=2/a=1&lt;br/&gt;
Time taken: 0.512 seconds, Fetched: 2 row(s)&lt;br/&gt;
hive&amp;gt; show partitions t;&lt;br/&gt;
OK&lt;br/&gt;
a=1/b=2/c=3&lt;br/&gt;
hive&amp;gt; dfs -ls -R  /user/hive/warehouse/t;&lt;br/&gt;
drwxrwxrwx   - cloudera supergroup          0 2017-03-26 13:13 /user/hive/warehouse/t/a=1&lt;br/&gt;
drwxrwxrwx   - cloudera supergroup          0 2017-03-26 13:13 /user/hive/warehouse/t/a=1/b=2&lt;br/&gt;
drwxrwxrwx   - cloudera supergroup          0 2017-03-26 13:13 /user/hive/warehouse/t/a=1/b=2/c=3&lt;br/&gt;
drwxr-xr-x   - cloudera supergroup          0 2017-03-26 13:12 /user/hive/warehouse/t/c=3&lt;br/&gt;
drwxr-xr-x   - cloudera supergroup          0 2017-03-26 13:12 /user/hive/warehouse/t/c=3/b=2&lt;br/&gt;
drwxr-xr-x   - cloudera supergroup          0 2017-03-26 13:12 /user/hive/warehouse/t/c=3/b=2/a=1&lt;/p&gt;

</description>
                <environment></environment>
        <key id="13059240">HIVE-16299</key>
            <summary>MSCK REPAIR TABLE should enforce partition key order when adding unknown partitions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vihangk1">Vihang Karajgaonkar</assignee>
                                    <reporter username="dmarkovitz">Dudu Markovitz</reporter>
                        <labels>
                    </labels>
                <created>Sun, 26 Mar 2017 20:16:53 +0000</created>
                <updated>Tue, 22 May 2018 23:58:11 +0000</updated>
                            <resolved>Fri, 31 Mar 2017 04:09:53 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>Metastore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15943616" author="vihangk1" created="Mon, 27 Mar 2017 16:51:22 +0000"  >&lt;p&gt;I can take a look at this ...&lt;/p&gt;</comment>
                            <comment id="15948073" author="vihangk1" created="Wed, 29 Mar 2017 23:19:11 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dmarkovitz&quot; class=&quot;user-hover&quot; rel=&quot;dmarkovitz&quot;&gt;dmarkovitz&lt;/a&gt; I looked into this issue. I was not able to reproduce the first example you have in the description. What version of Hive are you using?&lt;/p&gt;

&lt;p&gt;However, I could reproduce the second example. It seem from the code that Hive expects that the partition sub-directory structure should be in the order of the fields defined in the partition spec. But I am not able to find any documentation saying that. If that is the case then I can create a patch to reject such partitions which do not follow the partition key order on the filesystem. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ashutoshc&quot; class=&quot;user-hover&quot; rel=&quot;ashutoshc&quot;&gt;ashutoshc&lt;/a&gt; any thoughts? Do you think if this is something we should enforce in the HiveMetastoreChecker?&lt;/p&gt;</comment>
                            <comment id="15948517" author="dmarkovitz" created="Thu, 30 Mar 2017 06:59:11 +0000"  >&lt;p&gt;Hi&lt;/p&gt;

&lt;p&gt;1.&lt;br/&gt;
The 1st example could be created on hive 1.1.0-cdh5.7.0 but not on Hive 1.2.1000.2.5.3.0-37.&lt;br/&gt;
The 2nd example could be created on both.&lt;/p&gt;

&lt;p&gt;2.&lt;br/&gt;
I think that a situation where a partition is created built on directories structure and then directories are built based on the partitions that were just added, is not healthy and should be prevented.&lt;br/&gt;
It would make a lot of sense to validated a complete path and not each directory separately.&lt;/p&gt;







</comment>
                            <comment id="15949235" author="ashutoshc" created="Thu, 30 Mar 2017 14:57:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vihangk1&quot; class=&quot;user-hover&quot; rel=&quot;vihangk1&quot;&gt;vihangk1&lt;/a&gt; yes we should enforce the key order in msck.&lt;/p&gt;</comment>
                            <comment id="15949862" author="ashutoshc" created="Thu, 30 Mar 2017 21:22:41 +0000"  >&lt;p&gt;It should use &lt;tt&gt;hive.msck.path.validation&lt;/tt&gt; to throw in case user wants that behavior.&lt;/p&gt;</comment>
                            <comment id="15949890" author="vihangk1" created="Thu, 30 Mar 2017 21:32:45 +0000"  >&lt;p&gt;Thats a good point. I think we can use this information to exit early during the listing phase itself. If there are invalid partition directories, we don&apos;t need to list them and throw error or skip based on the value of &lt;tt&gt;hive.msck.path.validation&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15950103" author="vihangk1" created="Fri, 31 Mar 2017 00:36:37 +0000"  >&lt;p&gt;Updating the patch with a better implementation. The patch makes changes to the parallel file listing algorithm so that the directory structure which do not follow the partition key specs are not searched. This early exit strategy will also help improve query response time on slower filesystems like S3 and when partition directory structure does not conform to partition definitions. MSCK will throw exception or log a warning based on the value of &lt;tt&gt;hive.msck.path.validation&lt;/tt&gt; configuration.&lt;/p&gt;</comment>
                            <comment id="15950106" author="vihangk1" created="Fri, 31 Mar 2017 00:43:35 +0000"  >&lt;p&gt;Linked the review url&lt;/p&gt;</comment>
                            <comment id="15950239" author="hiveqa" created="Fri, 31 Mar 2017 03:01:42 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12861352/HIVE-16299.02.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12861352/HIVE-16299.02.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 2 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 2 failed/errored test(s), 10544 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[comments] (batchId=35)
org.apache.hive.hcatalog.api.TestHCatClient.testTransportFailure (batchId=172)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/4477/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/4477/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/4477/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/4477/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-4477/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-4477/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 2 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12861352 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15950261" author="ashutoshc" created="Fri, 31 Mar 2017 03:19:42 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15950290" author="ashutoshc" created="Fri, 31 Mar 2017 04:09:53 +0000"  >&lt;p&gt;Pushed to master. Thanks, Vihang!&lt;/p&gt;</comment>
                            <comment id="15950302" author="vihangk1" created="Fri, 31 Mar 2017 04:25:23 +0000"  >&lt;p&gt;Fixed an issue for the skip mode. msck doesn&apos;t need to list any further if the partition directory is invalid even in skip mode.&lt;/p&gt;</comment>
                            <comment id="15950307" author="vihangk1" created="Fri, 31 Mar 2017 04:30:17 +0000"  >&lt;p&gt;Update to the patch : removed trailing space&lt;/p&gt;</comment>
                            <comment id="15951315" author="vihangk1" created="Fri, 31 Mar 2017 17:15:26 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ashutoshc&quot; class=&quot;user-hover&quot; rel=&quot;ashutoshc&quot;&gt;ashutoshc&lt;/a&gt; looks like we had a race condition yesterday when I updated a newer version of patch since I didn&apos;t see your comment when I posted the updated patch &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I have created &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-16347&quot; title=&quot;HiveMetastoreChecker should skip listing partitions which are not valid when hive.msck.path.validation is set to skip or ignore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-16347&quot;&gt;&lt;del&gt;HIVE-16347&lt;/del&gt;&lt;/a&gt; to fix the bug in this patch.&lt;/p&gt;</comment>
                            <comment id="16485905" author="vgarg" created="Tue, 22 May 2018 23:58:11 +0000"  >&lt;p&gt;Hive 3.0.0 has been released so closing this jira.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13060740">HIVE-16347</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12861333" name="HIVE-16299.01.patch" size="8748" author="vihangk1" created="Thu, 30 Mar 2017 21:03:08 +0000"/>
                            <attachment id="12861352" name="HIVE-16299.02.patch" size="22777" author="vihangk1" created="Fri, 31 Mar 2017 00:36:37 +0000"/>
                            <attachment id="12861379" name="HIVE-16299.03.patch" size="25299" author="vihangk1" created="Fri, 31 Mar 2017 04:25:23 +0000"/>
                            <attachment id="12861380" name="HIVE-16299.04.patch" size="25298" author="vihangk1" created="Fri, 31 Mar 2017 04:30:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ct5j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>