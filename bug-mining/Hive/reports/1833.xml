<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:15:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-5945] ql.plan.ConditionalResolverCommonJoin.resolveMapJoinTask also sums those tables which are not used in the child of this conditional task.</title>
                <link>https://issues.apache.org/jira/browse/HIVE-5945</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Here is an example&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;select
   i_item_id,
   s_state,
   avg(ss_quantity) agg1,
   avg(ss_list_price) agg2,
   avg(ss_coupon_amt) agg3,
   avg(ss_sales_price) agg4
FROM store_sales
JOIN date_dim on (store_sales.ss_sold_date_sk = date_dim.d_date_sk)
JOIN item on (store_sales.ss_item_sk = item.i_item_sk)
JOIN customer_demographics on (store_sales.ss_cdemo_sk = customer_demographics.cd_demo_sk)
JOIN store on (store_sales.ss_store_sk = store.s_store_sk)
where
   cd_gender = &lt;span class=&quot;code-quote&quot;&gt;&apos;F&apos;&lt;/span&gt; and
   cd_marital_status = &lt;span class=&quot;code-quote&quot;&gt;&apos;U&apos;&lt;/span&gt; and
   cd_education_status = &lt;span class=&quot;code-quote&quot;&gt;&apos;Primary&apos;&lt;/span&gt; and
   d_year = 2002 and
   s_state in (&lt;span class=&quot;code-quote&quot;&gt;&apos;GA&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;PA&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;LA&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;SC&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;MI&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;AL&apos;&lt;/span&gt;)
group by
   i_item_id,
   s_state
order by
   i_item_id,
   s_state
limit 100;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I turned off noconditionaltask. So, I expected that there will be 4 Map-only jobs for this query. However, I got 1 Map-only job (joining strore_sales and date_dim) and 3 MR job (for reduce joins.)&lt;/p&gt;

&lt;p&gt;So, I checked the conditional task determining the plan of the join involving item. In ql.plan.ConditionalResolverCommonJoin.resolveMapJoinTask, aliasToFileSizeMap contains all input tables used in this query and the intermediate table generated by joining store_sales and date_dim. So, when we sum the size of all small tables, the size of store_sales (which is around 45GB in my test) will be also counted.  &lt;/p&gt;</description>
                <environment></environment>
        <key id="12682703">HIVE-5945</key>
            <summary>ql.plan.ConditionalResolverCommonJoin.resolveMapJoinTask also sums those tables which are not used in the child of this conditional task.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="navis">Navis Ryu</assignee>
                                    <reporter username="yhuai">Yin Huai</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Dec 2013 15:31:00 +0000</created>
                <updated>Thu, 16 Jan 2014 17:46:52 +0000</updated>
                            <resolved>Thu, 16 Jan 2014 17:46:29 +0000</resolved>
                                    <version>0.8.0</version>
                    <version>0.9.0</version>
                    <version>0.10.0</version>
                    <version>0.11.0</version>
                    <version>0.12.0</version>
                    <version>0.13.0</version>
                                    <fixVersion>0.13.0</fixVersion>
                                    <component>Query Processor</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13838991" author="yhuai" created="Wed, 4 Dec 2013 15:37:10 +0000"  >&lt;p&gt;aliasToFileSizeMap should have aliases used in the next stage instead of all tables. &lt;/p&gt;</comment>
                            <comment id="13839008" author="yhuai" created="Wed, 4 Dec 2013 15:49:02 +0000"  >&lt;p&gt;Seems this bug was introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2095&quot; title=&quot;auto convert map join bug&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-2095&quot;&gt;&lt;del&gt;HIVE-2095&lt;/del&gt;&lt;/a&gt;. I am marking all affected versions.&lt;/p&gt;</comment>
                            <comment id="13844912" author="navis" created="Wed, 11 Dec 2013 01:27:33 +0000"  >&lt;p&gt;Running test. &lt;/p&gt;

&lt;p&gt;I&apos;ve heard MapJoin is not working after upgrading 0.11.0. &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-4042&quot; title=&quot;ignore mapjoin hint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-4042&quot;&gt;&lt;del&gt;HIVE-4042&lt;/del&gt;&lt;/a&gt; (ignoring mapjoin hint) which is included 0.11.0 seemed revealed this issue.&lt;/p&gt;</comment>
                            <comment id="13844968" author="yhuai" created="Wed, 11 Dec 2013 01:58:26 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=navis&quot; class=&quot;user-hover&quot; rel=&quot;navis&quot;&gt;navis&lt;/a&gt; for taking this issue. Can you attach the link to the review board? Also, I saw &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+                &lt;span class=&quot;code-comment&quot;&gt;// todo: should nullify summary &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; non-&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; tables,
&lt;/span&gt;+                &lt;span class=&quot;code-comment&quot;&gt;// not to be selected as a mapjoin target&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in your patch. Does a &quot;non-native&quot; table mean an intermediate table? If so, I think for a conditional task, it&apos;s better to keep the option to use the intermediate table as the small table.&lt;/p&gt;</comment>
                            <comment id="13844980" author="navis" created="Wed, 11 Dec 2013 02:11:22 +0000"  >&lt;p&gt;&quot;non-native table&quot; is table based on custom storage handler something like HBaseStorageHandler. In this case input summary for the table directory always contains 0 file and 0 length, which might confuse mapjoin resolver to take the table small enough to be hashed.&lt;/p&gt;

&lt;p&gt;I&apos;ll make a review board entry.&lt;/p&gt;</comment>
                            <comment id="13845045" author="hiveqa" created="Wed, 11 Dec 2013 03:43:00 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12618153/HIVE-5945.1.patch.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12618153/HIVE-5945.1.patch.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 3 failed/errored test(s), 4761 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_infer_bucket_sort_convert_join
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_mapjoin_hook
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver_hbase_scan_params
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/605/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/605/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/605/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/605/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12618153&lt;/p&gt;</comment>
                            <comment id="13845076" author="navis" created="Wed, 11 Dec 2013 05:13:20 +0000"  >&lt;p&gt;Fixed infer_bucket_sort_convert_join.q and mapjoin_hook, but cannot reproduce hbase_scan_params.q (it does not have any joins)&lt;/p&gt;</comment>
                            <comment id="13845262" author="hiveqa" created="Wed, 11 Dec 2013 10:15:45 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12618185/HIVE-5945.2.patch.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12618185/HIVE-5945.2.patch.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 4761 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/611/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/611/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/611/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/611/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12618185&lt;/p&gt;</comment>
                            <comment id="13851260" author="yhuai" created="Wed, 18 Dec 2013 01:54:13 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=navis&quot; class=&quot;user-hover&quot; rel=&quot;navis&quot;&gt;navis&lt;/a&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I left a few comments on the review board. I think the conditional task in the original trunk is not well tested. With a .q test file, we cannot test if a conditional task picks the right execution plan because the result of a .q file only shows the plan and the result. I think it is necessary to add a junit test to unit test the decision of resolveMapJoinTask. Also, let&apos;s add some logs in resolveMapJoinTask. Right now, we only have &quot;xx is filtered out by condition resolver.&quot; and &quot;xx is selected by condition resolver.&quot; in ConditionalTask. Through these two logs, we cannot know why a execution plan is selected. In resolveMapJoinTask, we can first log the size of tables which will be used in next task and then log why a path is selected.&lt;/p&gt;</comment>
                            <comment id="13851459" author="hiveqa" created="Wed, 18 Dec 2013 07:15:01 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12619255/HIVE-5945.3.patch.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12619255/HIVE-5945.3.patch.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 4762 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/682/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/682/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/682/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/682/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12619255&lt;/p&gt;</comment>
                            <comment id="13851756" author="yhuai" created="Wed, 18 Dec 2013 14:08:29 +0000"  >&lt;p&gt;Two minor comments in the review board.&lt;/p&gt;

&lt;p&gt;Two additional comments.&lt;br/&gt;
When we find &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;bigTableFileAlias != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;can we also log sumOfOthers and the threshold of the size of small tables? So, the log entry will show the size of the big table, the total size of other small tables, and the threshold of the size of small tables.&lt;br/&gt;
Also, can you add a unit test?&lt;/p&gt;

&lt;p&gt;Thanks &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13857297" author="hiveqa" created="Fri, 27 Dec 2013 04:23:51 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12620580/HIVE-5945.4.patch.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12620580/HIVE-5945.4.patch.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 4817 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/747/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/747/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/747/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/747/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12620580&lt;/p&gt;</comment>
                            <comment id="13858495" author="navis" created="Mon, 30 Dec 2013 00:46:37 +0000"  >&lt;p&gt;Missed comments in here.&lt;/p&gt;</comment>
                            <comment id="13858568" author="hiveqa" created="Mon, 30 Dec 2013 05:25:07 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12620793/HIVE-5945.5.patch.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12620793/HIVE-5945.5.patch.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 4818 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/767/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/767/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/767/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/767/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12620793&lt;/p&gt;</comment>
                            <comment id="13859114" author="yhuai" created="Mon, 30 Dec 2013 21:52:27 +0000"  >&lt;p&gt;Thanks Navis &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I played with your patch and found a issue which I commented at the review board. I am also attaching more info at here. For the query in the description, we can have 4 map-joins. There will be 3 different intermediate tables called $INTNAME. The current patch does not update the size of $INTNAME.&lt;/p&gt;

&lt;p&gt;Here are logs.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;13/12/30 16:48:25 INFO ql.Driver: MapReduce Jobs Launched: 
Job 0: Map: 1   Cumulative CPU: 12.76 sec   HDFS Read: 388445624 HDFS Write: 20815654 SUCCESS
13/12/30 16:48:25 INFO ql.Driver: Job 0: Map: 1   Cumulative CPU: 12.76 sec   HDFS Read: 388445624 HDFS Write: 20815654 SUCCESS
Job 1: Map: 1   Cumulative CPU: 9.18 sec   HDFS Read: 20816111 HDFS Write: 28593993 SUCCESS
13/12/30 16:48:25 INFO ql.Driver: Job 1: Map: 1   Cumulative CPU: 9.18 sec   HDFS Read: 20816111 HDFS Write: 28593993 SUCCESS
Job 2: Map: 1   Cumulative CPU: 17.38 sec   HDFS Read: 80660331 HDFS Write: 378063 SUCCESS
13/12/30 16:48:25 INFO ql.Driver: Job 2: Map: 1   Cumulative CPU: 17.38 sec   HDFS Read: 80660331 HDFS Write: 378063 SUCCESS
Job 3: Map: 1   Cumulative CPU: 2.06 sec   HDFS Read: 378520 HDFS Write: 96 SUCCESS
13/12/30 16:48:25 INFO ql.Driver: Job 3: Map: 1   Cumulative CPU: 2.06 sec   HDFS Read: 378520 HDFS Write: 96 SUCCESS
Job 4: Map: 1  Reduce: 1   Cumulative CPU: 2.45 sec   HDFS Read: 553 HDFS Write: 96 SUCCESS
13/12/30 16:48:25 INFO ql.Driver: Job 4: Map: 1  Reduce: 1   Cumulative CPU: 2.45 sec   HDFS Read: 553 HDFS Write: 96 SUCCESS
Job 5: Map: 1  Reduce: 1   Cumulative CPU: 2.33 sec   HDFS Read: 553 HDFS Write: 0 SUCCESS
13/12/30 16:48:25 INFO ql.Driver: Job 5: Map: 1  Reduce: 1   Cumulative CPU: 2.33 sec   HDFS Read: 553 HDFS Write: 0 SUCCESS
Total MapReduce CPU Time Spent: 46 seconds 160 msec
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Map-join1:
plan.ConditionalResolverCommonJoin: Driver alias is store_sales with size 388445409 (total size of others : 0, threshold : 25000000)
Stage-28 is selected by condition resolver.

Map-join2:
plan.ConditionalResolverCommonJoin: Driver alias is $INTNAME with size 20815654 (total size of others : 5051899, threshold : 25000000)
Stage-26 is selected by condition resolver.

Map-join3:
 plan.ConditionalResolverCommonJoin: Driver alias is customer_demographics with size 80660096 (total size of others : 20815654, threshold : 25000000)
Stage-24 is filtered out by condition resolver.

Map-join4:
plan.ConditionalResolverCommonJoin: Driver alias is $INTNAME with size 20815654 (total size of others : 3155, threshold : 25000000)
Stage-22 is selected by condition resolver.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;btw, a minor question. Why the log of map-join 1 shows the size of others 0?&lt;/p&gt;</comment>
                            <comment id="13859982" author="navis" created="Thu, 2 Jan 2014 01:28:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; Ah.. right. I&apos;ll check that (and zero size issue also). Thanks for the enlightening.&lt;/p&gt;</comment>
                            <comment id="13859994" author="navis" created="Thu, 2 Jan 2014 02:34:16 +0000"  >&lt;p&gt;Made not to share size of intermediate tables among ConditionalTasks, seemingly solving invalid lengths. But I cannot reproduce zero length problem. Is it(date_dim) non-native table?&lt;/p&gt;</comment>
                            <comment id="13861465" author="hiveqa" created="Fri, 3 Jan 2014 12:13:28 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12621023/HIVE-5945.6.patch.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12621023/HIVE-5945.6.patch.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 4873 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/790/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/790/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/790/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/790/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12621023&lt;/p&gt;</comment>
                            <comment id="13863047" author="yhuai" created="Mon, 6 Jan 2014 15:33:02 +0000"  >&lt;p&gt;Thanks Navis for the change. date_dim is a native table. Actually, I think the problem is org.apache.hadoop.hive.ql.plan.ConditionalResolverCommonJoin.getParticipants. It uses ctx.getAliasToTask(); to get all aliases. However, these aliases do not include aliases appearing in the MapLocalWork (those small tables.). So for a query like &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;set hive.auto.convert.join.noconditionaltask=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
select
   i_item_id
FROM store_sales
JOIN item on (store_sales.ss_item_sk = item.i_item_sk)
limit 10;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The plan is &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;STAGE DEPENDENCIES:
  Stage-5 is a root stage , consists of Stage-6, Stage-1
  Stage-6 has a backup stage: Stage-1
  Stage-3 depends on stages: Stage-6
  Stage-1
  Stage-0 is a root stage

STAGE PLANS:
  Stage: Stage-5
    Conditional Operator

  Stage: Stage-6
    Map Reduce Local Work
      Alias -&amp;gt; Map Local Tables:
        item 
          Fetch Operator
            limit: -1
      Alias -&amp;gt; Map Local Operator Tree:
        item 
          TableScan
            alias: item
            HashTable Sink Operator
              condition expressions:
                0 
                1 {i_item_id}
              handleSkewJoin: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
              keys:
                0 [Column[ss_item_sk]]
                1 [Column[i_item_sk]]
              Position of Big Table: 0

  Stage: Stage-3
    Map Reduce
      Alias -&amp;gt; Map Operator Tree:
        store_sales 
          TableScan
            alias: store_sales
            Map Join Operator
              condition map:
                   Inner Join 0 to 1
              condition expressions:
                0 
                1 {i_item_id}
              handleSkewJoin: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
              keys:
                0 [Column[ss_item_sk]]
                1 [Column[i_item_sk]]
              outputColumnNames: _col26
              Position of Big Table: 0
              Select Operator
                expressions:
                      expr: _col26
                      type: string
                outputColumnNames: _col0
                Limit
                  File Output Operator
                    compressed: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
                    GlobalTableId: 0
                    table:
                        input format: org.apache.hadoop.mapred.TextInputFormat
                        output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
                        serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
      Local Work:
        Map Reduce Local Work

  Stage: Stage-1
    Map Reduce
      Alias -&amp;gt; Map Operator Tree:
        item 
          TableScan
            alias: item
            Reduce Output Operator
              key expressions:
                    expr: i_item_sk
                    type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
              sort order: +
              Map-reduce partition columns:
                    expr: i_item_sk
                    type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
              tag: 1
              value expressions:
                    expr: i_item_id
                    type: string
        store_sales 
          TableScan
            alias: store_sales
            Reduce Output Operator
              key expressions:
                    expr: ss_item_sk
                    type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
              sort order: +
              Map-reduce partition columns:
                    expr: ss_item_sk
                    type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
              tag: 0
      Reduce Operator Tree:
        Join Operator
          condition map:
               Inner Join 0 to 1
          condition expressions:
            0 
            1 {VALUE._col1}
          handleSkewJoin: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
          outputColumnNames: _col26
          Select Operator
            expressions:
                  expr: _col26
                  type: string
            outputColumnNames: _col0
            Limit
              File Output Operator
                compressed: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
                GlobalTableId: 0
                table:
                    input format: org.apache.hadoop.mapred.TextInputFormat
                    output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
                    serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe

  Stage: Stage-0
    Fetch Operator
      limit: 10
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The alias of &quot;item&quot; will not be in the set returned by getParticipants. Thus, the input of sumOfExcept will be &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;aliasToSize: {store_sales=388445409, item=5051899}
aliases: [store_sales]
except: store_sales
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and then we get &quot;0&quot; for the size of small tables.&lt;/p&gt;

&lt;p&gt;I think in getParticipants, we can check the type of a task and if it is a MapRedTask, we can use getWork().getMapWork().getMapLocalWork() to get the local task. Then, we can get aliases of those small tables through aliasToWork.&lt;/p&gt;

&lt;p&gt;Another minor comment. Can you add a comment for the method of clone in the class of ConditionalResolverCommonJoinCtx to explain why we only want to copy aliasToKnownSize?&lt;/p&gt;

&lt;p&gt;Thanks &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13869351" author="hiveqa" created="Mon, 13 Jan 2014 08:07:22 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12622571/HIVE-5945.7.patch.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12622571/HIVE-5945.7.patch.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 5 failed/errored test(s), 4917 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_auto_join30
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_auto_join31
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_auto_join_filters
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_union22
org.apache.hadoop.hive.ql.plan.TestConditionalResolverCommonJoin.testResolvingDriverAlias
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/877/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/877/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/877/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/877/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12622571&lt;/p&gt;</comment>
                            <comment id="13869579" author="hiveqa" created="Mon, 13 Jan 2014 14:32:51 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12622597/HIVE-5945.8.patch.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12622597/HIVE-5945.8.patch.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 4917 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/882/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/882/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/882/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/882/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12622597&lt;/p&gt;</comment>
                            <comment id="13872582" author="yhuai" created="Wed, 15 Jan 2014 20:57:44 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13873656" author="yhuai" created="Thu, 16 Jan 2014 17:46:52 +0000"  >&lt;p&gt;Committed to trunk. Thanks, Navis!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12618153" name="HIVE-5945.1.patch.txt" size="13967" author="navis" created="Wed, 11 Dec 2013 01:24:02 +0000"/>
                            <attachment id="12618185" name="HIVE-5945.2.patch.txt" size="14781" author="navis" created="Wed, 11 Dec 2013 05:13:20 +0000"/>
                            <attachment id="12619255" name="HIVE-5945.3.patch.txt" size="16560" author="navis" created="Wed, 18 Dec 2013 05:03:42 +0000"/>
                            <attachment id="12620580" name="HIVE-5945.4.patch.txt" size="15626" author="navis" created="Fri, 27 Dec 2013 03:12:06 +0000"/>
                            <attachment id="12620793" name="HIVE-5945.5.patch.txt" size="19826" author="navis" created="Mon, 30 Dec 2013 02:20:10 +0000"/>
                            <attachment id="12621023" name="HIVE-5945.6.patch.txt" size="20785" author="navis" created="Thu, 2 Jan 2014 02:34:16 +0000"/>
                            <attachment id="12622571" name="HIVE-5945.7.patch.txt" size="21087" author="navis" created="Mon, 13 Jan 2014 02:33:30 +0000"/>
                            <attachment id="12622597" name="HIVE-5945.8.patch.txt" size="22292" author="navis" created="Mon, 13 Jan 2014 08:45:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>361960</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 44 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qe6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>362255</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>