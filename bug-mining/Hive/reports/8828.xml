<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:26:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-28938] Error in LATERAL VIEW with non native tables due to presence of incorrect virtual columns in RowResolver</title>
                <link>https://issues.apache.org/jira/browse/HIVE-28938</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;To reproduce, run:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;create external table test(id int, arr array&amp;lt;string&amp;gt;) stored by iceberg;
insert into test values (1, array(&quot;a&quot;, &quot;b&quot;)), (2, array(&quot;c&quot;, &quot;d&quot;)), (3, array(&quot;e&quot;, &quot;f&quot;));

select * from test
lateral view explode(arr) tbl1 as name
lateral view explode(arr) tbl2 as name1;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.ql.parse.SemanticException: Line 0:-1 Invalid column reference &apos;BLOCK__OFFSET__INSIDE__FILE&apos;
at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.genAllExprNodeDesc(SemanticAnalyzer.java:14032)
at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.genExprNodeDesc(SemanticAnalyzer.java:13971)
at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.genSelectPlan(SemanticAnalyzer.java:5027)
at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.genSelectPlan(SemanticAnalyzer.java:4801)
at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.genPostGroupByBodyPlan(SemanticAnalyzer.java:11888)
at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.genBodyPlan(SemanticAnalyzer.java:11827)
at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.genPlan(SemanticAnalyzer.java:12812)
at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.genPlan(SemanticAnalyzer.java:12665)
at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.genPlan(SemanticAnalyzer.java:12696)
at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.genPlan(SemanticAnalyzer.java:12678)
at org.apache.hadoop.hive.ql.parse.CalcitePlanner.genOPTree(CalcitePlanner.java:688)
at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.analyzeInternal(SemanticAnalyzer.java:13572)
at org.apache.hadoop.hive.ql.parse.CalcitePlanner.analyzeInternal(CalcitePlanner.java:489)
at org.apache.hadoop.hive.ql.parse.BaseSemanticAnalyzer.analyze(BaseSemanticAnalyzer.java:324)
at org.apache.hadoop.hive.ql.Compiler.analyze(Compiler.java:227)
at org.apache.hadoop.hive.ql.Compiler.compile(Compiler.java:108)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;BLOCK_&lt;em&gt;OFFSET&lt;/em&gt;&lt;em&gt;INSIDE&lt;/em&gt;_FILE should not be present for non native tables, but it is present because of the misclassification of ICEBERG tables as TableType.NATIVE in the method &lt;a href=&quot;https://github.com/apache/hive/blob/e7cdc0cac935b8e2c573edad9d6e790d8beeee40/ql/src/java/org/apache/hadoop/hive/ql/parse/CalcitePlanner.java#L3272&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;obtainTableType(Table tabMetaData)&lt;/a&gt;. This returns NATIVE for ICEBERG tables and subsequently adds incorrect virtual columns in &lt;a href=&quot;https://github.com/apache/hive/blob/e7cdc0cac935b8e2c573edad9d6e790d8beeee40/ql/src/java/org/apache/hadoop/hive/ql/parse/CalcitePlanner.java#L3079&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;genTableLogicalPlan&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Virtual column adding logic should be similar to &lt;a href=&quot;https://github.com/apache/hive/blob/e7cdc0cac935b8e2c573edad9d6e790d8beeee40/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java#L11990&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;P.S. This only occurs for multiple lateral views. My guess is that when we just have one lateral view, unnecessary fields are trimmed from the HiveProject on top of the HiveTableFunctionScan. But when we have two or more lateral views, HiveProjects which are not at the top of the plan has all fields as the lateral function on top of the Project (in HiveTableFunctionScan) refers to them.&lt;/p&gt;

&lt;p&gt;For example, this is a plan with two lateral views:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;query: explain cbo
select * from test
lateral view explode(arr) tbl1 as name
lateral view explode(arr) tbl2 as name1

CBO PLAN:
HiveProject(id=[$0], arr=[$1], name=[$8], name1=[$9])
  HiveTableFunctionScan(invocation=[LATERAL(explode($1), $0, $1, $2, $3, $4, $5, $6, $7, $8)], rowType=[RecordType(INTEGER id, VARCHAR(2147483647) ARRAY arr, INTEGER PARTITION__SPEC__ID, BIGINT PARTITION__HASH, VARCHAR(2147483647) FILE__PATH, BIGINT ROW__POSITION, VARCHAR(2147483647) PARTITION__PROJECTION, BIGINT SNAPSHOT__ID, VARCHAR(2147483647) tbl1.name, VARCHAR(2147483647) tbl2.name1)])
    HiveProject(id=[$0], arr=[$1], PARTITION__SPEC__ID=[$2], PARTITION__HASH=[$3], FILE__PATH=[$4], ROW__POSITION=[$5], PARTITION__PROJECTION=[$6], SNAPSHOT__ID=[$7], tbl1.name=[$8])
      HiveTableFunctionScan(invocation=[LATERAL(explode($1), $0, $1, $2, $3, $4, $5, $6, $7)], rowType=[RecordType(INTEGER id, VARCHAR(2147483647) ARRAY arr, INTEGER PARTITION__SPEC__ID, BIGINT PARTITION__HASH, VARCHAR(2147483647) FILE__PATH, BIGINT ROW__POSITION, VARCHAR(2147483647) PARTITION__PROJECTION, BIGINT SNAPSHOT__ID, VARCHAR(2147483647) tbl1.name)])
        HiveTableScan(table=[[default, test]], table:alias=[test]) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We can see the second Project has all columns because the lateral function on top of it refers to them. Whereas, this is a plan with just one lateral view:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;query: explain cbo
select * from test
lateral view explode(arr) tbl1 as name

CBO PLAN:
HiveProject(id=[$0], arr=[$1], name=[$8])
  HiveTableFunctionScan(invocation=[LATERAL(explode($1), $0, $1, $2, $3, $4, $5, $6, $7)], rowType=[RecordType(INTEGER id, VARCHAR(2147483647) ARRAY arr, INTEGER PARTITION__SPEC__ID, BIGINT PARTITION__HASH, VARCHAR(2147483647) FILE__PATH, BIGINT ROW__POSITION, VARCHAR(2147483647) PARTITION__PROJECTION, BIGINT SNAPSHOT__ID, VARCHAR(2147483647) tbl1.name)])
    HiveTableScan(table=[[default, test]], table:alias=[test])&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;P.P.S: The plans above are after applying the fix, so we only see correct virtual columns, but if the fix was not present, we would also see virtual columns like BLOCK_&lt;em&gt;OFFSET&lt;/em&gt;&lt;em&gt;INSIDE&lt;/em&gt;_FILE.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13616858">HIVE-28938</key>
            <summary>Error in LATERAL VIEW with non native tables due to presence of incorrect virtual columns in RowResolver</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="soumyakanti.das">Soumyakanti Das</assignee>
                                    <reporter username="soumyakanti.das">Soumyakanti Das</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 30 Apr 2025 22:37:47 +0000</created>
                <updated>Tue, 29 Jul 2025 14:51:23 +0000</updated>
                            <resolved>Mon, 12 May 2025 11:31:26 +0000</resolved>
                                    <version>4.0.1</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>Hive</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17950500" author="zabetak" created="Fri, 9 May 2025 12:00:34 +0000"  >&lt;p&gt;I reviewed PR#5798 and the changes seem reasonable. One question though is why do we refer to the virtual columns when lateral views are involved?&#160;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CBO PLAN:
HiveProject(id=[$0], arr=[$1], name=[$8], name1=[$9])
  HiveTableFunctionScan(invocation=[LATERAL(explode($1), $0, $1, $2, $3, $4, $5, $6, $7, $8)], rowType=[RecordType(INTEGER id, VARCHAR(2147483647) ARRAY arr, INTEGER PARTITION__SPEC__ID, BIGINT PARTITION__HASH, VARCHAR(2147483647) FILE__PATH, BIGINT ROW__POSITION, VARCHAR(2147483647) PARTITION__PROJECTION, BIGINT SNAPSHOT__ID, VARCHAR(2147483647) tbl1.name, VARCHAR(2147483647) tbl2.name1)])
    HiveProject(id=[$0], arr=[$1], PARTITION__SPEC__ID=[$2], PARTITION__HASH=[$3], FILE__PATH=[$4], ROW__POSITION=[$5], PARTITION__PROJECTION=[$6], SNAPSHOT__ID=[$7], tbl1.name=[$8])
      HiveTableFunctionScan(invocation=[LATERAL(explode($1), $0, $1, $2, $3, $4, $5, $6, $7)], rowType=[RecordType(INTEGER id, VARCHAR(2147483647) ARRAY arr, INTEGER PARTITION__SPEC__ID, BIGINT PARTITION__HASH, VARCHAR(2147483647) FILE__PATH, BIGINT ROW__POSITION, VARCHAR(2147483647) PARTITION__PROJECTION, BIGINT SNAPSHOT__ID, VARCHAR(2147483647) tbl1.name)])
        HiveTableScan(table=[[default, test]], table:alias=[test]) 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Even after removing non-existent columns such as &lt;tt&gt;BLOCK_OFFSETINSIDE_FILE&lt;/tt&gt; the plan still contains technical columns like &lt;tt&gt;PARTITION_&lt;em&gt;PROJECTION&lt;/tt&gt;, &lt;tt&gt;SNAPSHOT&lt;/em&gt;_ID&lt;/tt&gt;, etc. I think that these technical columns should not be introduced in the first place. Anyways removing &quot;redundant&quot; columns is more like an optimization that we can possibly leave as a follow-up patch if it makes sense.&lt;/p&gt;</comment>
                            <comment id="17950607" author="soumyakanti.das" created="Fri, 9 May 2025 20:30:12 +0000"  >&lt;p&gt;Another point to note is that virtual columns&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;BLOCK__OFFSET__INSIDE__FILE 
INPUT__FILE__NAME 
ROW__OFFSET__INSIDE__BLOCK
ROW__ID
ROW__IS__DELETED    &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
were getting added to other non native tables (HBase, Kudu).&lt;/p&gt;

&lt;p&gt;After this patch is merged these columns will not be present anymore which, I think, is the correct behavior.&lt;/p&gt;</comment>
                            <comment id="17950609" author="zabetak" created="Fri, 9 May 2025 20:53:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=soumyakanti.das&quot; class=&quot;user-hover&quot; rel=&quot;soumyakanti.das&quot;&gt;soumyakanti.das&lt;/a&gt; Please check if it was possible to query the aforementioned virtual columns for HBase and Kudu tables before the changes in PR#5798. In case the query wasn&apos;t failing with an error check also the returned results.&lt;/p&gt;</comment>
                            <comment id="17950925" author="zabetak" created="Mon, 12 May 2025 11:31:26 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/hive/commit/0e287d4b45b0ccf14c74353f01abd2e7dfdce62e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/commit/0e287d4b45b0ccf14c74353f01abd2e7dfdce62e&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            26 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1vmx4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>