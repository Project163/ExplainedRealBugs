<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:20:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-24579] Incorrect Result For Groupby With Limit</title>
                <link>https://issues.apache.org/jira/browse/HIVE-24579</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt; test(id &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;);
&lt;span class=&quot;code-keyword&quot;&gt;explain&lt;/span&gt; extended &lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; id,&lt;span class=&quot;code-keyword&quot;&gt;count&lt;/span&gt;(*) &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; test &lt;span class=&quot;code-keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; id &lt;span class=&quot;code-keyword&quot;&gt;limit&lt;/span&gt; 10;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There is an TopN unexpectly for map phase, which casues incorrect result.&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
STAGE PLANS:
  Stage: Stage-1
    Tez
      DagId: root_20210104141527_c599c0cd-ca2f-4c7d-a3cc-3a01d65c49a1:5
      Edges:
        Reducer 2 &amp;lt;- &lt;span class=&quot;code-keyword&quot;&gt;Map&lt;/span&gt; 1 (SIMPLE_EDGE)
      DagName: root_20210104141527_c599c0cd-ca2f-4c7d-a3cc-3a01d65c49a1:5
      Vertices:
        &lt;span class=&quot;code-keyword&quot;&gt;Map&lt;/span&gt; 1 
            &lt;span class=&quot;code-keyword&quot;&gt;Map&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt; Tree:
                TableScan
                  &lt;span class=&quot;code-keyword&quot;&gt;alias&lt;/span&gt;: test
                  &lt;span class=&quot;code-keyword&quot;&gt;Statistics&lt;/span&gt;: Num &lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;: 1 &lt;span class=&quot;code-keyword&quot;&gt;Data&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;size&lt;/span&gt;: 13500 Basic stats: COMPLETE &lt;span class=&quot;code-keyword&quot;&gt;Column&lt;/span&gt; stats: &lt;span class=&quot;code-keyword&quot;&gt;NONE&lt;/span&gt;
                  GatherStats: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
                  &lt;span class=&quot;code-keyword&quot;&gt;Select&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt;
                    expressions: id (&lt;span class=&quot;code-keyword&quot;&gt;type&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;)
                    outputColumnNames: id
                    &lt;span class=&quot;code-keyword&quot;&gt;Statistics&lt;/span&gt;: Num &lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;: 1 &lt;span class=&quot;code-keyword&quot;&gt;Data&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;size&lt;/span&gt;: 13500 Basic stats: COMPLETE &lt;span class=&quot;code-keyword&quot;&gt;Column&lt;/span&gt; stats: &lt;span class=&quot;code-keyword&quot;&gt;NONE&lt;/span&gt;
                    &lt;span class=&quot;code-keyword&quot;&gt;Group&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;By&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt;
                      aggregations: &lt;span class=&quot;code-keyword&quot;&gt;count&lt;/span&gt;()
                      &lt;span class=&quot;code-keyword&quot;&gt;keys&lt;/span&gt;: id (&lt;span class=&quot;code-keyword&quot;&gt;type&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;)
                      &lt;span class=&quot;code-keyword&quot;&gt;mode&lt;/span&gt;: hash
                      outputColumnNames: _col0, _col1
                      &lt;span class=&quot;code-keyword&quot;&gt;Statistics&lt;/span&gt;: Num &lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;: 1 &lt;span class=&quot;code-keyword&quot;&gt;Data&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;size&lt;/span&gt;: 13500 Basic stats: COMPLETE &lt;span class=&quot;code-keyword&quot;&gt;Column&lt;/span&gt; stats: &lt;span class=&quot;code-keyword&quot;&gt;NONE&lt;/span&gt;
                      Reduce &lt;span class=&quot;code-keyword&quot;&gt;Output&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt;
                        &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; expressions: _col0 (&lt;span class=&quot;code-keyword&quot;&gt;type&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;)
                        &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; sort &lt;span class=&quot;code-keyword&quot;&gt;order&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;a&lt;/span&gt;
                        sort &lt;span class=&quot;code-keyword&quot;&gt;order&lt;/span&gt;: +
                        &lt;span class=&quot;code-keyword&quot;&gt;Map&lt;/span&gt;-reduce &lt;span class=&quot;code-keyword&quot;&gt;partition&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;columns&lt;/span&gt;: _col0 (&lt;span class=&quot;code-keyword&quot;&gt;type&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;)
                        &lt;span class=&quot;code-keyword&quot;&gt;Statistics&lt;/span&gt;: Num &lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;: 1 &lt;span class=&quot;code-keyword&quot;&gt;Data&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;size&lt;/span&gt;: 13500 Basic stats: COMPLETE &lt;span class=&quot;code-keyword&quot;&gt;Column&lt;/span&gt; stats: &lt;span class=&quot;code-keyword&quot;&gt;NONE&lt;/span&gt;
                        tag: -1
                        TopN: 10
                        TopN Hash Memory &lt;span class=&quot;code-keyword&quot;&gt;Usage&lt;/span&gt;: 0.1
                        &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt; expressions: _col1 (&lt;span class=&quot;code-keyword&quot;&gt;type&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;bigint&lt;/span&gt;)
                        auto parallelism: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
            Execution &lt;span class=&quot;code-keyword&quot;&gt;mode&lt;/span&gt;: vectorized
            &lt;span class=&quot;code-keyword&quot;&gt;Path&lt;/span&gt; -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;Alias&lt;/span&gt;:
              &lt;span class=&quot;code-keyword&quot;&gt;file&lt;/span&gt;:/&lt;span class=&quot;code-keyword&quot;&gt;user&lt;/span&gt;/hive/warehouse/test [test]
            &lt;span class=&quot;code-keyword&quot;&gt;Path&lt;/span&gt; -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;Partition&lt;/span&gt;:
              &lt;span class=&quot;code-keyword&quot;&gt;file&lt;/span&gt;:/&lt;span class=&quot;code-keyword&quot;&gt;user&lt;/span&gt;/hive/warehouse/test 
                &lt;span class=&quot;code-keyword&quot;&gt;Partition&lt;/span&gt;
                  base &lt;span class=&quot;code-keyword&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;: test
                  &lt;span class=&quot;code-keyword&quot;&gt;input&lt;/span&gt; format: org.apache.hadoop.mapred.TextInputFormat
                  &lt;span class=&quot;code-keyword&quot;&gt;output&lt;/span&gt; format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
                  properties:
                    COLUMN_STATS_ACCURATE {&lt;span class=&quot;code-quote&quot;&gt;&quot;BASIC_STATS&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;COLUMN_STATS&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;}}
                    bucket_count -1
                    bucketing_version 2
                    &lt;span class=&quot;code-keyword&quot;&gt;column&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;delimiter&lt;/span&gt; ,
                    &lt;span class=&quot;code-keyword&quot;&gt;columns&lt;/span&gt; id
                    &lt;span class=&quot;code-keyword&quot;&gt;columns&lt;/span&gt;.comments 
                    &lt;span class=&quot;code-keyword&quot;&gt;columns&lt;/span&gt;.types &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;
                    &lt;span class=&quot;code-keyword&quot;&gt;file&lt;/span&gt;.inputformat org.apache.hadoop.mapred.TextInputFormat
                    &lt;span class=&quot;code-keyword&quot;&gt;file&lt;/span&gt;.outputformat org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
                    &lt;span class=&quot;code-keyword&quot;&gt;location&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;file&lt;/span&gt;:/&lt;span class=&quot;code-keyword&quot;&gt;user&lt;/span&gt;/hive/warehouse/test
                    &lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.test
                    numFiles 0
                    numRows 0
                    rawDataSize 0
                    serialization.ddl struct test { i32 id}
                    serialization.format 1
                    serialization.lib org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
                    totalSize 0
                    transient_lastDdlTime 1609730190
                  serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
                
                    &lt;span class=&quot;code-keyword&quot;&gt;input&lt;/span&gt; format: org.apache.hadoop.mapred.TextInputFormat
                    &lt;span class=&quot;code-keyword&quot;&gt;output&lt;/span&gt; format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
                    properties:
                      COLUMN_STATS_ACCURATE {&lt;span class=&quot;code-quote&quot;&gt;&quot;BASIC_STATS&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;COLUMN_STATS&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;}}
                      bucket_count -1
                      bucketing_version 2
                      &lt;span class=&quot;code-keyword&quot;&gt;column&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;delimiter&lt;/span&gt; ,
                      &lt;span class=&quot;code-keyword&quot;&gt;columns&lt;/span&gt; id
                      &lt;span class=&quot;code-keyword&quot;&gt;columns&lt;/span&gt;.comments 
                      &lt;span class=&quot;code-keyword&quot;&gt;columns&lt;/span&gt;.types &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;
                      &lt;span class=&quot;code-keyword&quot;&gt;file&lt;/span&gt;.inputformat org.apache.hadoop.mapred.TextInputFormat
                      &lt;span class=&quot;code-keyword&quot;&gt;file&lt;/span&gt;.outputformat org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
                      &lt;span class=&quot;code-keyword&quot;&gt;location&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;file&lt;/span&gt;:/&lt;span class=&quot;code-keyword&quot;&gt;user&lt;/span&gt;/hive/warehouse/test
                      &lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.test
                      numFiles 0
                      numRows 0
                      rawDataSize 0
                      serialization.ddl struct test { i32 id}
                      serialization.format 1
                      serialization.lib org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
                      totalSize 0
                      transient_lastDdlTime 1609730190
                    serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
                    &lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.test
                  &lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.test
            Truncated &lt;span class=&quot;code-keyword&quot;&gt;Path&lt;/span&gt; -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;Alias&lt;/span&gt;:
              /test [test]
        Reducer 2 
            Execution &lt;span class=&quot;code-keyword&quot;&gt;mode&lt;/span&gt;: vectorized
            Needs Tagging: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
            Reduce &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt; Tree:
              &lt;span class=&quot;code-keyword&quot;&gt;Group&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;By&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt;
                aggregations: &lt;span class=&quot;code-keyword&quot;&gt;count&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;VALUE&lt;/span&gt;._col0)
                &lt;span class=&quot;code-keyword&quot;&gt;keys&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;KEY&lt;/span&gt;._col0 (&lt;span class=&quot;code-keyword&quot;&gt;type&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;)
                &lt;span class=&quot;code-keyword&quot;&gt;mode&lt;/span&gt;: mergepartial
                outputColumnNames: _col0, _col1
                &lt;span class=&quot;code-keyword&quot;&gt;Statistics&lt;/span&gt;: Num &lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;: 1 &lt;span class=&quot;code-keyword&quot;&gt;Data&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;size&lt;/span&gt;: 13500 Basic stats: COMPLETE &lt;span class=&quot;code-keyword&quot;&gt;Column&lt;/span&gt; stats: &lt;span class=&quot;code-keyword&quot;&gt;NONE&lt;/span&gt;
                &lt;span class=&quot;code-keyword&quot;&gt;Limit&lt;/span&gt;
                  &lt;span class=&quot;code-keyword&quot;&gt;Number&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;: 10
                  &lt;span class=&quot;code-keyword&quot;&gt;Statistics&lt;/span&gt;: Num &lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;: 1 &lt;span class=&quot;code-keyword&quot;&gt;Data&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;size&lt;/span&gt;: 13500 Basic stats: COMPLETE &lt;span class=&quot;code-keyword&quot;&gt;Column&lt;/span&gt; stats: &lt;span class=&quot;code-keyword&quot;&gt;NONE&lt;/span&gt;
                  &lt;span class=&quot;code-keyword&quot;&gt;File&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Output&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt;
                    compressed: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
                    GlobalTableId: 0
                    directory: &lt;span class=&quot;code-keyword&quot;&gt;file&lt;/span&gt;:/tmp/root/7160ea24-52b9-47c3-aafc-c9200263a1c6/hive_2021-01-04_14-15-27_601_190083924675700904-1/-mr-10001/.hive-staging_hive_2021-01-04_14-15-27_601_190083924675700904-1/-ext-10002
                    NumFilesPerFileSink: 1
                    &lt;span class=&quot;code-keyword&quot;&gt;Statistics&lt;/span&gt;: Num &lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;: 1 &lt;span class=&quot;code-keyword&quot;&gt;Data&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;size&lt;/span&gt;: 13500 Basic stats: COMPLETE &lt;span class=&quot;code-keyword&quot;&gt;Column&lt;/span&gt; stats: &lt;span class=&quot;code-keyword&quot;&gt;NONE&lt;/span&gt;
                    Stats Publishing &lt;span class=&quot;code-keyword&quot;&gt;Key&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Prefix&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;file&lt;/span&gt;:/tmp/root/7160ea24-52b9-47c3-aafc-c9200263a1c6/hive_2021-01-04_14-15-27_601_190083924675700904-1/-mr-10001/.hive-staging_hive_2021-01-04_14-15-27_601_190083924675700904-1/-ext-10002/
                    &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt;:
                        &lt;span class=&quot;code-keyword&quot;&gt;input&lt;/span&gt; format: org.apache.hadoop.mapred.SequenceFileInputFormat
                        &lt;span class=&quot;code-keyword&quot;&gt;output&lt;/span&gt; format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
                        properties:
                          &lt;span class=&quot;code-keyword&quot;&gt;columns&lt;/span&gt; _col0,_col1
                          &lt;span class=&quot;code-keyword&quot;&gt;columns&lt;/span&gt;.types &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;bigint&lt;/span&gt;
                          &lt;span class=&quot;code-keyword&quot;&gt;escape&lt;/span&gt;.delim \
                          hive.serialization.extend.additional.&lt;span class=&quot;code-keyword&quot;&gt;nesting&lt;/span&gt;.levels &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
                          serialization.&lt;span class=&quot;code-keyword&quot;&gt;escape&lt;/span&gt;.crlf &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
                          serialization.format 1
                          serialization.lib org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
                        serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
                    TotalFiles: 1
                    GatherStats: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
                    MultiFileSpray: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;

  Stage: Stage-0
    &lt;span class=&quot;code-keyword&quot;&gt;Fetch&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;limit&lt;/span&gt;: 10
      Processor Tree:
        ListSink

&lt;span class=&quot;code-keyword&quot;&gt;Time&lt;/span&gt; taken: 0.102 seconds, Fetched: 143 &lt;span class=&quot;code-keyword&quot;&gt;row&lt;/span&gt;(s)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;






&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13348853">HIVE-24579</key>
            <summary>Incorrect Result For Groupby With Limit</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kkasa">Krisztian Kasa</assignee>
                                    <reporter username="nemon">Nemon Lou</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 4 Jan 2021 03:40:57 +0000</created>
                <updated>Thu, 17 Nov 2022 08:48:24 +0000</updated>
                            <resolved>Tue, 28 Sep 2021 10:41:48 +0000</resolved>
                                    <version>2.3.7</version>
                    <version>3.1.2</version>
                    <version>4.0.0</version>
                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                    <component>Physical Optimizer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6000">1h 40m</timespent>
                                <comments>
                            <comment id="17257932" author="nemon" created="Mon, 4 Jan 2021 03:43:34 +0000"  >&lt;p&gt;A workaround is hive.limit.pushdown.memory.usage=0 .&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17413144" author="kkasa" created="Fri, 10 Sep 2021 12:13:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nemon&quot; class=&quot;user-hover&quot; rel=&quot;nemon&quot;&gt;nemon&lt;/a&gt;&lt;br/&gt;
The TopN is introduced because the Reduce Sink operator does sorting by the id column and there is also a limit 10 defined. So it broadcast only the first 10 rows to the reducer.&lt;/p&gt;

&lt;p&gt;Could you please provide some test data which can be used to reproduce the incorrect result you mention in the summary?&lt;/p&gt;</comment>
                            <comment id="17413481" author="nemon" created="Sat, 11 Sep 2021 06:53:14 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkasa&quot; class=&quot;user-hover&quot; rel=&quot;kkasa&quot;&gt;kkasa&lt;/a&gt;&#160;for your attention.&lt;/p&gt;

&lt;p&gt;This issue only happens on a customer&apos;s cluster, and i could not get the data.&lt;/p&gt;

&lt;p&gt;This simplified reproduce step seems not match the customer&apos;s issue.&lt;/p&gt;

&lt;p&gt;Here is the original issue(with table name changed):&lt;/p&gt;

&lt;p&gt;&#160;The query result is different for the same store_id when change limit 10 to limit 100&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; store_id store_id_hive
, &lt;span class=&quot;code-keyword&quot;&gt;count&lt;/span&gt;(1) device_cnt_bound_30day
&lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; db_name.&lt;span class=&quot;code-keyword&quot;&gt;table_name&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; i_rep_date &amp;lt;= 20201226
&lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; i_rep_date &amp;gt;= &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(from_unixtime(unix_timestamp(&lt;span class=&quot;code-quote&quot;&gt;&apos;20201226&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;yyyyMMdd&apos;&lt;/span&gt;)-86400*29,&lt;span class=&quot;code-quote&quot;&gt;&apos;yyyyMMdd&apos;&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; nvl(is_curr_bound,1) = 1
&lt;span class=&quot;code-keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; store_id &lt;span class=&quot;code-keyword&quot;&gt;limit&lt;/span&gt; 10;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;query plan :&lt;br/&gt;
 &#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
|                      &lt;span class=&quot;code-keyword&quot;&gt;Explain&lt;/span&gt;                       |
+&lt;span class=&quot;code-comment&quot;&gt;----------------------------------------------------+
&lt;/span&gt;| &lt;span class=&quot;code-keyword&quot;&gt;Plan&lt;/span&gt; optimized &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; CBO.                             |
|                                                    |
| Vertex dependency &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; root stage                    |
| Reducer 2 &amp;lt;- &lt;span class=&quot;code-keyword&quot;&gt;Map&lt;/span&gt; 1 (SIMPLE_EDGE)                   |
|                                                    |
| Stage-0                                            |
|   &lt;span class=&quot;code-keyword&quot;&gt;Fetch&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt;                                   |
|     &lt;span class=&quot;code-keyword&quot;&gt;limit&lt;/span&gt;:10                                       |
|     Stage-1                                        |
|       Reducer 2                                    |
|       &lt;span class=&quot;code-keyword&quot;&gt;File&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Output&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt; [FS_8]                  |
|         &lt;span class=&quot;code-keyword&quot;&gt;Limit&lt;/span&gt; [LIM_7] (&lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;=10 width=39)           |
|           &lt;span class=&quot;code-keyword&quot;&gt;Number&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;:10                        |
|           &lt;span class=&quot;code-keyword&quot;&gt;Group&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;By&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt; [GBY_5] (&lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;=5618832 width=39) |
|             &lt;span class=&quot;code-keyword&quot;&gt;Output&lt;/span&gt;:[&lt;span class=&quot;code-quote&quot;&gt;&quot;_col0&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;_col1&quot;&lt;/span&gt;],aggregations:[&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;count&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;VALUE&lt;/span&gt;._col0)&quot;&lt;/span&gt;],&lt;span class=&quot;code-keyword&quot;&gt;keys&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;KEY&lt;/span&gt;._col0 |
|           &amp;lt;-&lt;span class=&quot;code-keyword&quot;&gt;Map&lt;/span&gt; 1 [SIMPLE_EDGE]                    |
|             SHUFFLE [RS_4]                         |
|               PartitionCols:_col0                  |
|               &lt;span class=&quot;code-keyword&quot;&gt;Group&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;By&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt; [GBY_3] (&lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;=11237665 width=39) |
|                 &lt;span class=&quot;code-keyword&quot;&gt;Output&lt;/span&gt;:[&lt;span class=&quot;code-quote&quot;&gt;&quot;_col0&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;_col1&quot;&lt;/span&gt;],aggregations:[&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;count&lt;/span&gt;()&quot;&lt;/span&gt;],&lt;span class=&quot;code-keyword&quot;&gt;keys&lt;/span&gt;:store_id |
|                 &lt;span class=&quot;code-keyword&quot;&gt;Select&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt; [SEL_2] (&lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;=11237665 width=39) |
|                   &lt;span class=&quot;code-keyword&quot;&gt;Output&lt;/span&gt;:[&lt;span class=&quot;code-quote&quot;&gt;&quot;store_id&quot;&lt;/span&gt;]              |
|                   &lt;span class=&quot;code-keyword&quot;&gt;Filter&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt; [FIL_9] (&lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;=11237665 width=39) |
|                     predicate:(NVL(is_curr_bound,1) = 1) |
|                     TableScan [TS_0] (&lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;=22475330 width=39) |
|                       db_name@&lt;span class=&quot;code-keyword&quot;&gt;table_name&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;table_name&lt;/span&gt;,Tbl:COMPLETE,Col:&lt;span class=&quot;code-keyword&quot;&gt;NONE&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;Output&lt;/span&gt;:[&lt;span class=&quot;code-quote&quot;&gt;&quot;store_id&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;is_curr_bound&quot;&lt;/span&gt;] |
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;part of the extended plan:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
+&lt;span class=&quot;code-comment&quot;&gt;----------------------------------------------------+
&lt;/span&gt;|                      &lt;span class=&quot;code-keyword&quot;&gt;Explain&lt;/span&gt;                       |
+&lt;span class=&quot;code-comment&quot;&gt;----------------------------------------------------+
&lt;/span&gt;| STAGE DEPENDENCIES:                                |
|   Stage-1 &lt;span class=&quot;code-keyword&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;a&lt;/span&gt; root stage                          |
|   Stage-0 depends &lt;span class=&quot;code-keyword&quot;&gt;on&lt;/span&gt; stages: Stage-1               |
|                                                    |
| STAGE PLANS:                                       |
|   Stage: Stage-1                                   |
|     Tez                                            |
|       DagId: omm_20201228025339_1ef293cf-c508-431a-bf00-6df95178c6e8:3229 |
|       Edges:                                       |
|         Reducer 2 &amp;lt;- &lt;span class=&quot;code-keyword&quot;&gt;Map&lt;/span&gt; 1 (SIMPLE_EDGE)           |
|       DagName: omm_20201228025339_1ef293cf-c508-431a-bf00-6df95178c6e8:3229 |
|       Vertices:                                    |
|         &lt;span class=&quot;code-keyword&quot;&gt;Map&lt;/span&gt; 1                                      |
|             &lt;span class=&quot;code-keyword&quot;&gt;Map&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt; Tree:                     |
|                 TableScan                          |
|                   &lt;span class=&quot;code-keyword&quot;&gt;alias&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;table_name&lt;/span&gt;  |
|                   &lt;span class=&quot;code-keyword&quot;&gt;Statistics&lt;/span&gt;: Num &lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;: 22475330 &lt;span class=&quot;code-keyword&quot;&gt;Data&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;size&lt;/span&gt;: 876537870 Basic stats: COMPLETE &lt;span class=&quot;code-keyword&quot;&gt;Column&lt;/span&gt; stats: &lt;span class=&quot;code-keyword&quot;&gt;NONE&lt;/span&gt; |
|                   GatherStats: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;               |
|                   &lt;span class=&quot;code-keyword&quot;&gt;Filter&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt;                  |
|                     isSamplingPred: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;          |
|                     predicate: (NVL(is_curr_bound,1) = 1) (&lt;span class=&quot;code-keyword&quot;&gt;type&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;boolean&lt;/span&gt;) |
|                     &lt;span class=&quot;code-keyword&quot;&gt;Statistics&lt;/span&gt;: Num &lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;: 11237665 &lt;span class=&quot;code-keyword&quot;&gt;Data&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;size&lt;/span&gt;: 438268935 Basic stats: COMPLETE &lt;span class=&quot;code-keyword&quot;&gt;Column&lt;/span&gt; stats: &lt;span class=&quot;code-keyword&quot;&gt;NONE&lt;/span&gt; |
|                     &lt;span class=&quot;code-keyword&quot;&gt;Select&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt;                |
|                       expressions: store_id (&lt;span class=&quot;code-keyword&quot;&gt;type&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;) |
|                       outputColumnNames: store_id  |
|                       &lt;span class=&quot;code-keyword&quot;&gt;Statistics&lt;/span&gt;: Num &lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;: 11237665 &lt;span class=&quot;code-keyword&quot;&gt;Data&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;size&lt;/span&gt;: 438268935 Basic stats: COMPLETE &lt;span class=&quot;code-keyword&quot;&gt;Column&lt;/span&gt; stats: &lt;span class=&quot;code-keyword&quot;&gt;NONE&lt;/span&gt; |
|                       &lt;span class=&quot;code-keyword&quot;&gt;Group&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;By&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt;            |
|                         aggregations: &lt;span class=&quot;code-keyword&quot;&gt;count&lt;/span&gt;()      |
|                         &lt;span class=&quot;code-keyword&quot;&gt;keys&lt;/span&gt;: store_id (&lt;span class=&quot;code-keyword&quot;&gt;type&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;) |
|                         &lt;span class=&quot;code-keyword&quot;&gt;mode&lt;/span&gt;: hash                 |
|                         outputColumnNames: _col0, _col1 |
|                         &lt;span class=&quot;code-keyword&quot;&gt;Statistics&lt;/span&gt;: Num &lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;: 11237665 &lt;span class=&quot;code-keyword&quot;&gt;Data&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;size&lt;/span&gt;: 438268935 Basic stats: COMPLETE &lt;span class=&quot;code-keyword&quot;&gt;Column&lt;/span&gt; stats: &lt;span class=&quot;code-keyword&quot;&gt;NONE&lt;/span&gt; |
|                         Reduce &lt;span class=&quot;code-keyword&quot;&gt;Output&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;Operator&lt;/span&gt;     |
|                           &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; expressions: _col0 (&lt;span class=&quot;code-keyword&quot;&gt;type&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;) |
|                           &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; sort &lt;span class=&quot;code-keyword&quot;&gt;order&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;a&lt;/span&gt;       |
|                           sort &lt;span class=&quot;code-keyword&quot;&gt;order&lt;/span&gt;: +            |
|                           &lt;span class=&quot;code-keyword&quot;&gt;Map&lt;/span&gt;-reduce &lt;span class=&quot;code-keyword&quot;&gt;partition&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;columns&lt;/span&gt;: _col0 (&lt;span class=&quot;code-keyword&quot;&gt;type&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;) |
|                           &lt;span class=&quot;code-keyword&quot;&gt;Statistics&lt;/span&gt;: Num &lt;span class=&quot;code-keyword&quot;&gt;rows&lt;/span&gt;: 11237665 &lt;span class=&quot;code-keyword&quot;&gt;Data&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;size&lt;/span&gt;: 438268935 Basic stats: COMPLETE &lt;span class=&quot;code-keyword&quot;&gt;Column&lt;/span&gt; stats: &lt;span class=&quot;code-keyword&quot;&gt;NONE&lt;/span&gt; |
|                           tag: -1                  |
|                           TopN: 10                 |
|                           TopN Hash Memory &lt;span class=&quot;code-keyword&quot;&gt;Usage&lt;/span&gt;: 0.1 |
|                           &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt; expressions: _col1 (&lt;span class=&quot;code-keyword&quot;&gt;type&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;bigint&lt;/span&gt;) |
|                           auto parallelism: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;   |
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17413502" author="nemon" created="Sat, 11 Sep 2021 10:30:11 +0000"  >&lt;p&gt;I have repoduce this issue.But data is too big to upload(more than 30mb), any suggestions? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkasa&quot; class=&quot;user-hover&quot; rel=&quot;kkasa&quot;&gt;kkasa&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17414006" author="nemon" created="Mon, 13 Sep 2021 08:14:50 +0000"  >&lt;p&gt;After debuging,I find the bug is quite intuitive:&lt;/p&gt;

&lt;p&gt;There is no order&#160;granted in the final result, but&#160;TopN in mapper filters out part of the data. Causing incorrect aggragation result of some keys.For example:&lt;/p&gt;

&lt;p&gt;Assume that key1 is in the top 10 key at first and then is squeezed by other keys, but some data is still transmitted to the downstream. As a result, key1 obtains an incorrect summarization result in the reduce phase.&lt;br/&gt;
However, the final result is not obtained from the top 10 keys but from the output results of multiple reduce. Therefore, key1 may be obtained, causing an error in the final result.&lt;/p&gt;</comment>
                            <comment id="17414151" author="nemon" created="Mon, 13 Sep 2021 11:34:36 +0000"  >&lt;p&gt;I think topn key operator has the same issue. What&apos;s your Opinion?&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkasa&quot; class=&quot;user-hover&quot; rel=&quot;kkasa&quot;&gt;kkasa&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17414657" author="nemon" created="Tue, 14 Sep 2021 01:33:41 +0000"  >&lt;p&gt;Another user also reports the same issue :&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-3562?focusedCommentId=17170367&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17170367&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-3562?focusedCommentId=17170367&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17170367&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17417640" author="kkasa" created="Mon, 20 Sep 2021 12:56:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nemon&quot; class=&quot;user-hover&quot; rel=&quot;nemon&quot;&gt;nemon&lt;/a&gt;&lt;br/&gt;
 Managed to reproduce this using a small dataset:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SET hive.optimize.topnkey=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
SET hive.vectorized.execution.enabled=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

-- Force using multiple mappers.
set tez.grouping.max-size=50;
set tez.grouping.min-size=25;

create table test(id string);
insert into test(id) values
(4), (3), (4), (3), (4), (3), (4), (3), (4), (3), (4), (3), (4), (3), (4), (3), (4), (3), (4), (10), (2), (1), (5);

select id, count(1) from test group by id limit 2;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
10	1
3	6  -- This should be 9
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I run above script using the TestMiniLlapLocalCliDriver.&lt;br/&gt;
 By setting&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SET hive.optimize.topnkey=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;TopNKeyOperator is disabled so &lt;b&gt;TopNHash&lt;/b&gt; in the &lt;b&gt;ReduceSinkOperator&lt;/b&gt; is used instead.&lt;/p&gt;

&lt;p&gt;I had two mappers and two reducers.&lt;br/&gt;
Each mapper has its own TopNHash instance. Since many rows have id=3 these rows are processed by both mappers and TopNHash instances. However in one of the mappers id=3 rows are filtered out by other rows.&lt;/p&gt;

&lt;p&gt;In the reducers the Group by operators (calculates the final result of aggregations) processed these rows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Reducer1 GBY: 
Key, Partial count
[10] 1
[3] 6
Reducer2 GBY:
Key, Partial count
[1] 1
[4] 7
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the end LimitOperators just take these rows and in the final step FetchOperator takes the first output file produced by one of the LimitOperators. The fetch task has also a limit of 2 so the it does not touch the second file created by the second LimitOperator.&lt;/p&gt;

&lt;p&gt;TopNKeyOperator is a kind of upgrade and a replacement of TopNHash. It can be even pushed down until TableScan operator if the conditions meet. So I don&apos;t think It would solve this issue.&lt;/p&gt;

&lt;p&gt;I think the solution is when GBY has aggregate functions transform the plan to a &lt;b&gt;group by id order by id limit 2&lt;/b&gt; plan. It has the same plan like in the description but It has an additional edge with a single Reducer. It is responsible to do a merge sort on the outputs of its source reducers and get the first n row of the result.&lt;/p&gt;</comment>
                            <comment id="17418562" author="nemon" created="Wed, 22 Sep 2021 12:14:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkasa&quot; class=&quot;user-hover&quot; rel=&quot;kkasa&quot;&gt;kkasa&lt;/a&gt; Good job! &lt;br/&gt;
After reading your PR, I have some concerns.&lt;br/&gt;
1. Does the sorting stage cause compatibility problems? For example, the returned content is different from the original after sort. &lt;br/&gt;
(There are many examples in the .q.out file). This seems to be less of a problem than the incorrect result.&lt;br/&gt;
2. Faster by topn + order by, or faster by reducing one stage (no topn + no order by)? Do different solutions need to be selected for different scenarios?&lt;br/&gt;
3. In the scenario where cbo=false, do we need to fix it?&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="17419176" author="kkasa" created="Thu, 23 Sep 2021 12:46:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nemon&quot; class=&quot;user-hover&quot; rel=&quot;nemon&quot;&gt;nemon&lt;/a&gt;&lt;br/&gt;
 Thanks for reviewing the patch.&lt;br/&gt;
 1. The original query is about returning the first n keys coming from the Group by operator. It can be any n keys. So I think many good result exists. By adding sorting we choose one of those possible n key sets.&lt;br/&gt;
 2. Run some tests in a 3 node test cluster and&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;found that with low NDV of group by keys the additional reducer for ordering is negligible sometimes even faster.&lt;/li&gt;
	&lt;li&gt;high NDV: topN + ordering is much faster. I think when topN is enabled the amount of data broadcasted to reducers from mappers can be much less.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;3. Not sure cbo=false is recommended. Lots of features are not working without cbo.&lt;/p&gt;</comment>
                            <comment id="17421310" author="kkasa" created="Tue, 28 Sep 2021 10:41:48 +0000"  >&lt;p&gt;Pushed to master. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kgyrtkirk&quot; class=&quot;user-hover&quot; rel=&quot;kgyrtkirk&quot;&gt;kgyrtkirk&lt;/a&gt;&#160;and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nemon&quot; class=&quot;user-hover&quot; rel=&quot;nemon&quot;&gt;nemon&lt;/a&gt;&#160;for review.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13421748">HIVE-25856</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 7 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0lzzc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>