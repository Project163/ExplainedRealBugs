<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:20:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-25203] HiveQueryResultSet and client operation are not expected to be closed twice</title>
                <link>https://issues.apache.org/jira/browse/HIVE-25203</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;While testing retry scenarios of &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-24786&quot; title=&quot;JDBC HttpClient should retry for idempotent and unsent http methods&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-24786&quot;&gt;&lt;del&gt;HIVE-24786&lt;/del&gt;&lt;/a&gt;, we found that HiveQueryResultSet.close() is called twice, which is not expected. There are 2 different issues here:&lt;/p&gt;

&lt;p&gt;1. ResultSet should not handle Statement as in HiveQueryResultSet:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.statement != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.statement &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; HiveStatement)) {
      HiveStatement s = (HiveStatement) &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.statement;
      s.closeClientOperation();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The hiearchy of Connection(HiveConnection) -&amp;gt; Statement(HiveStatement) -&amp;gt; ResultSet(HiveQueryResultSet) should be respected in a sense that the parent can handle child but not the opposite way, only except a single case, where the state of the result set has an effect on statement&apos;s state, which is &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/sql/Statement.html#closeOnCompletion()&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Statement.closeOnCompletion&lt;/a&gt;, which was introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-22698&quot; title=&quot;Support Statement#closeOnCompletion()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-22698&quot;&gt;&lt;del&gt;HIVE-22698&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
The above logic was introduced by &lt;a href=&quot;https://github.com/apache/hive/blame/master/jdbc/src/java/org/apache/hive/jdbc/HiveQueryResultSet.java#L276&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;HIVE-4974&lt;/a&gt;. Its intention was to make children able to return their parents, but that doesn&apos;t mean they should handle their parents&apos; lifecycle.&lt;/p&gt;

&lt;p&gt;2. Also, HiveStatement should close HiveQueryResultSet only if it&apos;s not already closed, so it would make sense to check ResultSet.isClosed() before closing. This is for the very same reason as another change above, to avoid duplicated close logic. &lt;/p&gt;

&lt;p&gt;Background: under normal circumstances, a close operation is idempotent, we should not worry about any side effects of calling it twice, but while testing &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-24786&quot; title=&quot;JDBC HttpClient should retry for idempotent and unsent http methods&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-24786&quot;&gt;&lt;del&gt;HIVE-24786&lt;/del&gt;&lt;/a&gt;, we found strange issues where in case of a SocketTimeoutException, such code path was hit in the jdbc client, that made HiveStatement.closeClientOperation() to be called twice, and it led to a WARNING on HS2 side. This is not expected as the operation close is protected by stmtHandle != null check, but yet it ran twice. To avoid situations like this, cleaning up duplicated close calls would help.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13382317">HIVE-25203</key>
            <summary>HiveQueryResultSet and client operation are not expected to be closed twice</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="abstractdog">L&#225;szl&#243; Bodor</assignee>
                                    <reporter username="abstractdog">L&#225;szl&#243; Bodor</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 6 Jun 2021 03:04:49 +0000</created>
                <updated>Thu, 17 Nov 2022 08:47:45 +0000</updated>
                            <resolved>Mon, 7 Jun 2021 09:33:51 +0000</resolved>
                                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17358014" author="abstractdog" created="Sun, 6 Jun 2021 04:14:01 +0000"  >&lt;p&gt;FYI: this was a debug logging while we investigated:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
1 row selected (14.303 seconds)
21/06/04 04:55:04 [main]: INFO jdbc.HiveConnection: HiveQueryResultSet.close(): org.apache.hive.jdbc.HiveStatement@523424b5
java.lang.RuntimeException
	at org.apache.hive.jdbc.HiveQueryResultSet.close(HiveQueryResultSet.java:310)
	at org.apache.hive.beeline.Commands.executeInternal(Commands.java:1041)
	at org.apache.hive.beeline.Commands.execute(Commands.java:1217)
	at org.apache.hive.beeline.Commands.sql(Commands.java:1146)
	at org.apache.hive.beeline.BeeLine.dispatch(BeeLine.java:1497)
	at org.apache.hive.beeline.BeeLine.execute(BeeLine.java:1355)
	at org.apache.hive.beeline.BeeLine.begin(BeeLine.java:1134)
	at org.apache.hive.beeline.BeeLine.begin(BeeLine.java:1082)
	at org.apache.hive.beeline.BeeLine.mainWithInputRedirection(BeeLine.java:546)
	at org.apache.hive.beeline.BeeLine.main(BeeLine.java:528)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.apache.hadoop.util.RunJar.run(RunJar.java:318)
	at org.apache.hadoop.util.RunJar.main(RunJar.java:232)
21/06/04 04:55:04 [main]: INFO jdbc.HiveConnection: HiveStatement closeClientOperation()
21/06/04 04:55:04 [main]: INFO jdbc.HiveConnection: HiveStatement closeStatementIfNeeded() stmtHandle: TOperationHandle(operationId:THandleIdentifier(guid:46 7F D7 60 2F 38 4C F5 AC 6F 08 C3 AC FA 13 A2, secret:A8 C7 B8 FF C4 88 4B C0 84 27 57 C1 C5 8C 44 F3), operationType:EXECUTE_STATEMENT, hasResultSet:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
21/06/04 04:55:04 [main]: INFO jdbc.HiveConnection: HiveStatement CloseOperation returned: TStatus(statusCode:SUCCESS_STATUS)
21/06/04 04:55:04 [main]: INFO jdbc.HiveConnection: HiveStatement close() isClosed: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
21/06/04 04:55:04 [main]: INFO jdbc.HiveConnection: HiveStatement closeClientOperation()
21/06/04 04:55:04 [main]: INFO jdbc.HiveConnection: HiveStatement closeStatementIfNeeded() stmtHandle: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
21/06/04 04:55:04 [main]: INFO jdbc.HiveConnection: HiveQueryResultSet.close(): org.apache.hive.jdbc.HiveStatement@523424b5
java.lang.RuntimeException
	at org.apache.hive.jdbc.HiveQueryResultSet.close(HiveQueryResultSet.java:310)
	at org.apache.hive.jdbc.HiveStatement.close(HiveStatement.java:252)
	at org.apache.hive.beeline.Commands.executeInternal(Commands.java:1067)
	at org.apache.hive.beeline.Commands.execute(Commands.java:1217)
	at org.apache.hive.beeline.Commands.sql(Commands.java:1146)
	at org.apache.hive.beeline.BeeLine.dispatch(BeeLine.java:1497)
	at org.apache.hive.beeline.BeeLine.execute(BeeLine.java:1355)
	at org.apache.hive.beeline.BeeLine.begin(BeeLine.java:1134)
	at org.apache.hive.beeline.BeeLine.begin(BeeLine.java:1082)
	at org.apache.hive.beeline.BeeLine.mainWithInputRedirection(BeeLine.java:546)
	at org.apache.hive.beeline.BeeLine.main(BeeLine.java:528)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.apache.hadoop.util.RunJar.run(RunJar.java:318)
	at org.apache.hadoop.util.RunJar.main(RunJar.java:232)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12661058">HIVE-4974</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13358849">HIVE-24786</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13277820">HIVE-22698</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 23 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0rozk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>