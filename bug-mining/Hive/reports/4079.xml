<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:39:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-12473] DPP: UDFs on the partition column side does not evaluate correctly</title>
                <link>https://issues.apache.org/jira/browse/HIVE-12473</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Related to &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-12462&quot; title=&quot;DPP: DPP optimizers need to run on the TS predicate not FIL &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-12462&quot;&gt;&lt;del&gt;HIVE-12462&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select count(1) from accounts a, transactions t where year(a.dt) = year(t.dt) and account_id = 22;

$hdt$_0:$hdt$_1:a
  TableScan (TS_2)
    alias: a
    filterExpr: (((account_id = 22) and year(dt) is not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) and (year(dt)) IN (RS[6])) (type: &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ends up being evaluated as &lt;tt&gt;year(cast(dt as int))&lt;/tt&gt; because the pruner only checks for final type, not the column type.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    ObjectInspector oi =
        PrimitiveObjectInspectorFactory.getPrimitiveWritableObjectInspector(TypeInfoFactory
            .getPrimitiveTypeInfo(si.fieldInspector.getTypeName()));

    Converter converter =
        ObjectInspectorConverters.getConverter(
            PrimitiveObjectInspectorFactory.javaStringObjectInspector, oi);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12914657">HIVE-12473</key>
            <summary>DPP: UDFs on the partition column side does not evaluate correctly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sershe">Sergey Shelukhin</assignee>
                                    <reporter username="gopalv">Gopal Vijayaraghavan</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Nov 2015 23:33:13 +0000</created>
                <updated>Tue, 16 Feb 2016 23:52:37 +0000</updated>
                            <resolved>Mon, 14 Dec 2015 20:59:41 +0000</resolved>
                                    <version>1.2.1</version>
                    <version>1.3.0</version>
                    <version>2.0.0</version>
                                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>Tez</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15020283" author="sershe" created="Sat, 21 Nov 2015 06:49:53 +0000"  >&lt;p&gt;Here&apos;s the patch. Can you check it on a real query? With this patch and the other DPP patch pruning appears to work, but on the query I have it doesn&apos;t prune anything so I can&apos;t be sure.&lt;/p&gt;</comment>
                            <comment id="15020286" author="gopalv" created="Sat, 21 Nov 2015 06:52:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt;: yes, will do that - seeing your patch gives me another idea.&lt;/p&gt;

&lt;p&gt;This can be looked up from the TableScan in the optimizer during generateEventOperatorPlan().&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      eventDesc.setTargetColumnName(column);
      eventDesc.setPartKey(partKey);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15021035" author="hiveqa" created="Sun, 22 Nov 2015 15:07:43 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12773640/HIVE-12473.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12773640/HIVE-12473.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 10 failed/errored test(s), 9834 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestHWISessionManager - did not produce a TEST-*.xml file
TestMiniLlapCliDriver - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_index_bitmap_auto_partitioned
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_notin
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_notin_having
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_explainuser_1
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_tez_dynpart_hashjoin_3
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_tez_smb_empty
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_uri_import
org.apache.hive.jdbc.TestSSL.testSSLVersion
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6100/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6100/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6100/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6100/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-6100/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-6100/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 10 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12773640 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="15023062" author="sershe" created="Mon, 23 Nov 2015 21:02:12 +0000"  >&lt;p&gt;The test failures are unrelated, but we need to look after &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-12462&quot; title=&quot;DPP: DPP optimizers need to run on the TS predicate not FIL &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-12462&quot;&gt;&lt;del&gt;HIVE-12462&lt;/del&gt;&lt;/a&gt; is committed.&lt;/p&gt;</comment>
                            <comment id="15023285" author="sershe" created="Mon, 23 Nov 2015 23:01:40 +0000"  >&lt;p&gt;Updated patch. &lt;/p&gt;</comment>
                            <comment id="15023286" author="sershe" created="Mon, 23 Nov 2015 23:02:06 +0000"  >&lt;p&gt;Wrong jira&lt;/p&gt;</comment>
                            <comment id="15025170" author="sershe" created="Tue, 24 Nov 2015 19:34:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt; can you take a look? I think looking for the column should actually be ok since the expression is not expected to have any other columns, they would not be able to evaluate because the row only has one value there. We could even just look for ExprCol... in theory.&lt;/p&gt;</comment>
                            <comment id="15026545" author="gopalv" created="Wed, 25 Nov 2015 10:05:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt;: LGTM - +1.&lt;/p&gt;

&lt;p&gt;I&apos;ll make a note &amp;amp; do a bit of type refactoring after talking to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hagleitn&quot; class=&quot;user-hover&quot; rel=&quot;hagleitn&quot;&gt;hagleitn&lt;/a&gt; next sprint.&lt;/p&gt;</comment>
                            <comment id="15027530" author="sershe" created="Wed, 25 Nov 2015 20:23:14 +0000"  >&lt;p&gt;Committed to master and branch-1.&lt;/p&gt;</comment>
                            <comment id="15054105" author="hagleitn" created="Sat, 12 Dec 2015 07:28:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt;/&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt; here&apos;s a comment in the code:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      // TODO: this is not necessarily going to work for all cases. At least, table name is needed.
      //       Also it&apos;s not clear if this is going to work with subquery columns and such.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Maybe commit when it does?&lt;/p&gt;</comment>
                            <comment id="15054106" author="hagleitn" created="Sat, 12 Dec 2015 07:29:15 +0000"  >&lt;p&gt;Also - there&apos;s not test in the code, so it&apos;s hard to try to repro and see what it does...&lt;/p&gt;</comment>
                            <comment id="15054147" author="hagleitn" created="Sat, 12 Dec 2015 08:45:20 +0000"  >&lt;p&gt;I can&apos;t figure out why this fix would be doing the right thing. The converter should work off of the final type, it needs to convert the string partition value to the output of the evaluator. I think this should be reverted.&lt;/p&gt;</comment>
                            <comment id="15054188" author="gopalv" created="Sat, 12 Dec 2015 09:57:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;The converter should work off of the final type, it needs to convert the string partition value to the output of the evaluator.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What it is doing before fix was &lt;tt&gt;cast(dt as int)&lt;/tt&gt;, which is wrong - it should do &lt;tt&gt;cast(dt as date)&lt;/tt&gt;. Even if the final UDF type is an int due to &lt;tt&gt;year(dt&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15056499" author="sershe" created="Mon, 14 Dec 2015 19:13:45 +0000"  >&lt;p&gt;The comment is not actually correct, as I realized later; we only receive one expression currently, so there&apos;s no chance of getting a wrong value.&lt;br/&gt;
The reason it does the right thing now is that the top-level expression does not need to be cast in general case, Hive already takes care of comparing correctly.&lt;br/&gt;
What needs to be cast is the partition column string. It needs to be cast to argument type of whatever it&apos;s passed to. Most of the time the partition column is the top-level expression and is passed into UDFCompareBlahBlah, but it&apos;s not always the case; it&apos;s different if it&apos;s wrapped in, and passed into, most UDFs (e.g. YEAR(date)). The patch changes the code to take the type of the argument, instead of taking the type of the top-level expression. &lt;/p&gt;</comment>
                            <comment id="15056697" author="hagleitn" created="Mon, 14 Dec 2015 20:52:15 +0000"  >&lt;p&gt;Even if that&apos;s the case there&apos;s no test case and the comment needs to be removed. There are actually test cases in dynamic_partition_pruning.q that use UDF and seem to work fine. It seems there&apos;s a patch on the way for &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-12462&quot; title=&quot;DPP: DPP optimizers need to run on the TS predicate not FIL &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-12462&quot;&gt;&lt;del&gt;HIVE-12462&lt;/del&gt;&lt;/a&gt;. When that&apos;s done I can add a test case plus cleanup to this jira.&lt;/p&gt;</comment>
                            <comment id="15056710" author="sershe" created="Mon, 14 Dec 2015 20:59:41 +0000"  >&lt;p&gt;Things like that are usually done in a follow-up JIRA...&lt;/p&gt;</comment>
                            <comment id="15056711" author="sershe" created="Mon, 14 Dec 2015 21:00:46 +0000"  >&lt;p&gt;Filed &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-12667&quot; title=&quot;Proper fix for HIVE-12473&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-12667&quot;&gt;&lt;del&gt;HIVE-12667&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12921764">HIVE-12667</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12773640" name="HIVE-12473.patch" size="3022" author="sershe" created="Sat, 21 Nov 2015 06:49:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 49 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2oo7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332641">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>