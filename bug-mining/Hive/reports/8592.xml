<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:25:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-27788] Exception when join has 2 Group By operators in the same branch in the same reducer</title>
                <link>https://issues.apache.org/jira/browse/HIVE-27788</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Sort- merge join with Group By + PTF operator leads&#160; to Runtime exception&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.RuntimeException: org.apache.hadoop.hive.ql.metadata.HiveException: Hive &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt; Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing row
	at org.apache.hadoop.hive.ql.exec.tez.ReduceRecordSource.pushRecord(ReduceRecordSource.java:313)
	at org.apache.hadoop.hive.ql.exec.tez.ReduceRecordProcessor.run(ReduceRecordProcessor.java:291)
	at org.apache.hadoop.hive.ql.exec.tez.TezProcessor.initializeAndRunProcessor(TezProcessor.java:293)
	... 15 more
Caused by: org.apache.hadoop.hive.ql.metadata.HiveException: Hive &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt; Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing row
	at org.apache.hadoop.hive.ql.exec.tez.ReduceRecordSource$GroupIterator.next(ReduceRecordSource.java:387)
	at org.apache.hadoop.hive.ql.exec.tez.ReduceRecordSource.pushRecord(ReduceRecordSource.java:303)
	... 17 more
Caused by: org.apache.hadoop.hive.ql.metadata.HiveException: org.apache.hadoop.hive.ql.metadata.HiveException: java.lang.RuntimeException: org.apache.hadoop.hive.ql.metadata.HiveException: org.apache.hadoop.hive.ql.metadata.HiveException: Attempting to overwrite nextKeyWritables[1]
	at org.apache.hadoop.hive.ql.exec.CommonMergeJoinOperator.joinOneGroup(CommonMergeJoinOperator.java:392)
	at org.apache.hadoop.hive.ql.exec.CommonMergeJoinOperator.joinOneGroup(CommonMergeJoinOperator.java:372)
	at org.apache.hadoop.hive.ql.exec.CommonMergeJoinOperator.process(CommonMergeJoinOperator.java:316)
	at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:888)
	at org.apache.hadoop.hive.ql.exec.SelectOperator.process(SelectOperator.java:94)
	at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:888)
	at org.apache.hadoop.hive.ql.exec.FilterOperator.process(FilterOperator.java:127)
	at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:888)
	at org.apache.hadoop.hive.ql.exec.PTFOperator$PTFInvocation.handleOutputRows(PTFOperator.java:337)
	at org.apache.hadoop.hive.ql.exec.PTFOperator$PTFInvocation.processRow(PTFOperator.java:325)
	at org.apache.hadoop.hive.ql.exec.PTFOperator.process(PTFOperator.java:139)
	at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:888)
	at org.apache.hadoop.hive.ql.exec.SelectOperator.process(SelectOperator.java:94)
	at org.apache.hadoop.hive.ql.exec.tez.ReduceRecordSource$GroupIterator.next(ReduceRecordSource.java:372)
	... 18 more
Caused by: org.apache.hadoop.hive.ql.metadata.HiveException: java.lang.RuntimeException: org.apache.hadoop.hive.ql.metadata.HiveException: org.apache.hadoop.hive.ql.metadata.HiveException: Attempting to overwrite nextKeyWritables[1]
	at org.apache.hadoop.hive.ql.exec.CommonMergeJoinOperator.fetchOneRow(CommonMergeJoinOperator.java:534)
	at org.apache.hadoop.hive.ql.exec.CommonMergeJoinOperator.fetchNextGroup(CommonMergeJoinOperator.java:488)
	at org.apache.hadoop.hive.ql.exec.CommonMergeJoinOperator.joinOneGroup(CommonMergeJoinOperator.java:390)
	... 31 more
Caused by: java.lang.RuntimeException: org.apache.hadoop.hive.ql.metadata.HiveException: org.apache.hadoop.hive.ql.metadata.HiveException: Attempting to overwrite nextKeyWritables[1]
	at org.apache.hadoop.hive.ql.exec.tez.ReduceRecordSource.pushRecord(ReduceRecordSource.java:313)
	at org.apache.hadoop.hive.ql.exec.CommonMergeJoinOperator.fetchOneRow(CommonMergeJoinOperator.java:522)
	... 33 more &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Issue can be reproduced with &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13063500/13063500_auto_sortmerge_join_17.q&quot; title=&quot;auto_sortmerge_join_17.q attached to HIVE-27788&quot;&gt;auto_sortmerge_join_17.q&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13553779">HIVE-27788</key>
            <summary>Exception when join has 2 Group By operators in the same branch in the same reducer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kkasa">Krisztian Kasa</assignee>
                                    <reporter username="rtrivedi12">Riju Trivedi</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 12 Oct 2023 02:58:01 +0000</created>
                <updated>Wed, 22 Nov 2023 04:04:29 +0000</updated>
                            <resolved>Wed, 22 Nov 2023 04:04:29 +0000</resolved>
                                    <version>4.0.0-beta-1</version>
                                                    <component>Operators</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17776189" author="kkasa" created="Tue, 17 Oct 2023 12:26:24 +0000"  >&lt;p&gt;Another repro with 3 records and inner join&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
set hive.optimize.semijoin.conversion = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

CREATE TABLE tbl1_n5(key &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, value string) CLUSTERED BY (key) SORTED BY (key) INTO 2 BUCKETS;

insert into tbl1_n5(key, value)
values
(0, &lt;span class=&quot;code-quote&quot;&gt;&apos;val_0&apos;&lt;/span&gt;),
(2, &lt;span class=&quot;code-quote&quot;&gt;&apos;val_2&apos;&lt;/span&gt;),
(9, &lt;span class=&quot;code-quote&quot;&gt;&apos;val_9&apos;&lt;/span&gt;);

explain
SELECT t1.key from
(SELECT  key , row_number() over(partition by key order by value desc) as rk from tbl1_n5) t1
join
( SELECT key,count(distinct value) as cp_count from tbl1_n5 group by key) t2
on t1.key = t2.key where rk = 1;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
POSTHOOK: query: explain
SELECT t1.key from
(SELECT  key , row_number() over(partition by key order by value desc) as rk from tbl1_n5) t1
join
( SELECT key,count(distinct value) as cp_count from tbl1_n5 group by key) t2
on t1.key = t2.key where rk = 1
POSTHOOK: type: QUERY
POSTHOOK: Input: &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@tbl1_n5
#### A masked pattern was here ####
STAGE DEPENDENCIES:
  Stage-1 is a root stage
  Stage-0 depends on stages: Stage-1

STAGE PLANS:
  Stage: Stage-1
    Tez
#### A masked pattern was here ####
      Edges:
        Reducer 2 &amp;lt;- Map 1 (SIMPLE_EDGE), Map 3 (SIMPLE_EDGE)
#### A masked pattern was here ####
      Vertices:
        Map 1 
            Map Operator Tree:
                TableScan
                  alias: tbl1_n5
                  filterExpr: key is not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; (type: &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;)
                  Statistics: Num rows: 3 Data size: 279 Basic stats: COMPLETE Column stats: COMPLETE
                  Filter Operator
                    predicate: key is not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; (type: &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;)
                    Statistics: Num rows: 3 Data size: 279 Basic stats: COMPLETE Column stats: COMPLETE
                    Reduce Output Operator
                      key expressions: key (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;), value (type: string)
                      &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; sort order: aa
                      sort order: +-
                      Map-reduce partition columns: key (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
                      Statistics: Num rows: 3 Data size: 279 Basic stats: COMPLETE Column stats: COMPLETE
            Execution mode: vectorized, llap
            LLAP IO: all inputs
        Map 3 
            Map Operator Tree:
                TableScan
                  alias: tbl1_n5
                  filterExpr: key is not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; (type: &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;)
                  Statistics: Num rows: 3 Data size: 279 Basic stats: COMPLETE Column stats: COMPLETE
                  Filter Operator
                    predicate: key is not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; (type: &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;)
                    Statistics: Num rows: 3 Data size: 279 Basic stats: COMPLETE Column stats: COMPLETE
                    Group By Operator
                      keys: key (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;), value (type: string)
                      minReductionHashAggr: 0.4
                      mode: hash
                      outputColumnNames: _col0, _col1
                      Statistics: Num rows: 3 Data size: 279 Basic stats: COMPLETE Column stats: COMPLETE
                      Reduce Output Operator
                        key expressions: _col0 (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;), _col1 (type: string)
                        &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; sort order: zz
                        sort order: ++
                        Map-reduce partition columns: _col0 (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
                        Statistics: Num rows: 3 Data size: 279 Basic stats: COMPLETE Column stats: COMPLETE
            Execution mode: vectorized, llap
            LLAP IO: all inputs
        Reducer 2 
            Reduce Operator Tree:
              Group By Operator
                keys: KEY._col0 (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;), KEY._col1 (type: string)
                mode: mergepartial
                outputColumnNames: _col0, _col1
                Statistics: Num rows: 3 Data size: 279 Basic stats: COMPLETE Column stats: COMPLETE
                Select Operator
                  expressions: _col0 (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
                  outputColumnNames: _col0
                  Statistics: Num rows: 3 Data size: 279 Basic stats: COMPLETE Column stats: COMPLETE
                  Group By Operator
                    keys: _col0 (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
                    mode: complete
                    outputColumnNames: _col0
                    Statistics: Num rows: 3 Data size: 12 Basic stats: COMPLETE Column stats: COMPLETE
                    Dummy Store
            Execution mode: llap
            Reduce Operator Tree:
              Select Operator
                expressions: KEY.reducesinkkey0 (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;), KEY.reducesinkkey1 (type: string)
                outputColumnNames: _col0, _col1
                Statistics: Num rows: 3 Data size: 279 Basic stats: COMPLETE Column stats: COMPLETE
                PTF Operator
                  Function definitions:
                      Input definition
                        input alias: ptf_0
                        output shape: _col0: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, _col1: string
                        type: WINDOWING
                      Windowing table definition
                        input alias: ptf_1
                        name: windowingtablefunction
                        order by: _col1 DESC NULLS FIRST
                        partition by: _col0
                        raw input shape:
                        window functions:
                            window function definition
                              alias: row_number_window_0
                              name: row_number
                              window function: GenericUDAFRowNumberEvaluator
                              window frame: ROWS PRECEDING(MAX)~FOLLOWING(MAX)
                              isPivotResult: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
                  Statistics: Num rows: 3 Data size: 279 Basic stats: COMPLETE Column stats: COMPLETE
                  Filter Operator
                    predicate: (row_number_window_0 = 1) (type: &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;)
                    Statistics: Num rows: 1 Data size: 93 Basic stats: COMPLETE Column stats: COMPLETE
                    Select Operator
                      expressions: _col0 (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
                      outputColumnNames: _col0
                      Statistics: Num rows: 1 Data size: 4 Basic stats: COMPLETE Column stats: COMPLETE
                      Merge Join Operator
                        condition map:
                             Inner Join 0 to 1
                        keys:
                          0 _col0 (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
                          1 _col0 (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
                        outputColumnNames: _col0
                        Statistics: Num rows: 1 Data size: 4 Basic stats: COMPLETE Column stats: COMPLETE
                        File Output Operator
                          compressed: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
                          Statistics: Num rows: 1 Data size: 4 Basic stats: COMPLETE Column stats: COMPLETE
                          table:
                              input format: org.apache.hadoop.mapred.SequenceFileInputFormat
                              output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
                              serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe

  Stage: Stage-0
    Fetch Operator
      limit: -1
      Processor Tree:
        ListSink
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The plan has a &lt;tt&gt;Merge Join Operator&lt;/tt&gt; in &lt;tt&gt;Reducer 2&lt;/tt&gt;. &lt;tt&gt;Reducer 2&lt;/tt&gt; has two operator trees: one for each join branches.&lt;br/&gt;
The first tree&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
GBY-SEL-GBY-DS
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;belongs to the subquery&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SELECT key,count(distinct value) as cp_count from tbl1_n5 group by key
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The aggregate call&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
count(distinct value)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;needs two group by operators&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the first one ensures the distinct values of the &lt;tt&gt;value&lt;/tt&gt; column.&lt;/li&gt;
	&lt;li&gt;the second aggregates by the &lt;tt&gt;key&lt;/tt&gt; column&lt;br/&gt;
The second tree does the other branch of the join with the PTF operator and the join itself.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Currently Merge Join Operator doesn&apos;t support more than one Group by operators in the same branch and in the same Reducer/Mapper instance because Group by operators doesn&apos;t forward the records to child operator immediately but buffers one output row and forwards it only when an input row comes with a different key value than the currently buffered.&lt;br/&gt;
Since we have two GBYs in this case 2 rows are buffered. When the underlying datasource run out of records the buffered records in GBYs has to be flushed &lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/hive/blob/b6847ed38b7d32586ab22e224904867f159b510e/ql/src/java/org/apache/hadoop/hive/ql/exec/tez/ReduceRecordSource.java#L268-L270&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/b6847ed38b7d32586ab22e224904867f159b510e/ql/src/java/org/apache/hadoop/hive/ql/exec/tez/ReduceRecordSource.java#L268-L270&lt;/a&gt;&lt;br/&gt;
In this case both buffered records are forwarded to Merge Join Operator but the operator couldn&apos;t process any records from the other side of the join and it leads to the exception mentioned in the description.&lt;br/&gt;
Example key values from both sides of the join:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
left 0 2 9
right 0 2 9
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;1. Join reads 0 from right.&lt;br/&gt;
2. Join &lt;a href=&quot;https://github.com/apache/hive/blob/b6847ed38b7d32586ab22e224904867f159b510e/ql/src/java/org/apache/hadoop/hive/ql/exec/CommonMergeJoinOperator.java#L484-L488&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;starts reading records&lt;/a&gt; from the left but GBY operators buffer records with key values 0 and 2 and no records forwarded to join.&lt;br/&gt;
3. Join is still reading from left because join &lt;a href=&quot;https://github.com/apache/hive/blob/b6847ed38b7d32586ab22e224904867f159b510e/ql/src/java/org/apache/hadoop/hive/ql/exec/CommonMergeJoinOperator.java#L268-L269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;key is matching&lt;/a&gt;. When 9 is read 0 is forwarded to the join from the left tree (2nd gby forwards its buffered record) and it is still a match.&lt;br/&gt;
4. Join tries to read from left again but source is empty hence &lt;a href=&quot;https://github.com/apache/hive/blob/b6847ed38b7d32586ab22e224904867f159b510e/ql/src/java/org/apache/hadoop/hive/ql/exec/tez/ReduceRecordSource.java#L268-L270&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;flush left operator tree&lt;/a&gt;&lt;br/&gt;
5. The 1st GBY forwards 9 hence 2nd GBY forwards 2 to the Join and Join founds a key mismatch hence &lt;a href=&quot;https://github.com/apache/hive/blob/b6847ed38b7d32586ab22e224904867f159b510e/ql/src/java/org/apache/hadoop/hive/ql/exec/CommonMergeJoinOperator.java#L271-L276&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;sets the flag left has a mismatch&lt;/a&gt;&lt;br/&gt;
6. 2nd GBY flush its buffered record with key 9 because flush is a recursive call and Join gets 9 from the left but it didn&apos;t had a chance to read anything from right. Exception is thrown.&lt;/p&gt;

&lt;p&gt;IMHO operator tree in a mapper/reducer having merge join shouldn&apos;t have branch with more than one GBY operator.&lt;br/&gt;
A possible solution is to disable SMB join conversion in such cases:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/hive/blob/b6847ed38b7d32586ab22e224904867f159b510e/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ConvertJoinMapJoin.java#L498&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/b6847ed38b7d32586ab22e224904867f159b510e/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ConvertJoinMapJoin.java#L498&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17783852" author="amansinha" created="Wed, 8 Nov 2023 01:43:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;A possible solution is to disable SMB join conversion in such cases:&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This seems a reasonable option.&#160; So both sides of the join will need to be examined for the presence of 2 or more GROUP-BY operators.&#160; The traversal would check until it hits a TableScan operator.&#160; If such a pattern is encountered, we would not generate the SMB join. It wasn&apos;t clear what role does the Partitioned Table Function (PTF) have to play in this.&#160; If the sufficient condition for the problem is the presence of 2 GROUP-BYs on either side of a join, I suppose the query could be simplified further.&#160;&lt;/p&gt;</comment>
                            <comment id="17786303" author="zabetak" created="Wed, 15 Nov 2023 10:40:44 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkasa&quot; class=&quot;user-hover&quot; rel=&quot;kkasa&quot;&gt;kkasa&lt;/a&gt; , can you elaborate a bit on the role of the PTF in this problem. The way that the summary and description are written they imply that PTF is necessary for the problem to occur but the extended analysis above does not refer to it. I agree with Aman that it would be useful to clarify this part and if possible simplify the repro further.&lt;/p&gt;</comment>
                            <comment id="17786353" author="kkasa" created="Wed, 15 Nov 2023 13:29:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zabetak&quot; class=&quot;user-hover&quot; rel=&quot;zabetak&quot;&gt;zabetak&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amansinha&quot; class=&quot;user-hover&quot; rel=&quot;amansinha&quot;&gt;amansinha&lt;/a&gt;&lt;br/&gt;
I think the summary of this jira is misleading. As per my analysis the issue is caused by&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The operator tree in a reducer has a merge join operator and any of the join branches has more than one GBY:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
RS-...-GBY-...-GBY-...-MERGEJOIN-...
               RS-...-/
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;the data have unique values in GBY key(s) processed by that branch or at least the last 3 records in the record stream.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The presence of PTF operator is irrelevant in this issue. It can be anything. Please see another example:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/hive/blob/17525f169b9a08cd715bfb42899e45b7c689c77a/ql/src/test/results/clientpositive/llap/subquery_in_having.q.out#L263-L391&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/17525f169b9a08cd715bfb42899e45b7c689c77a/ql/src/test/results/clientpositive/llap/subquery_in_having.q.out#L263-L391&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17786646" author="zabetak" created="Thu, 16 Nov 2023 07:56:48 +0000"  >&lt;p&gt;Thanks for the clarification &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkasa&quot; class=&quot;user-hover&quot; rel=&quot;kkasa&quot;&gt;kkasa&lt;/a&gt;! If PTF is irrelevant then let&apos;s update at least the summary accordingly so that we have a more meaningful entry in the release notes.&lt;/p&gt;</comment>
                            <comment id="17788620" author="kkasa" created="Wed, 22 Nov 2023 04:04:29 +0000"  >&lt;p&gt;Merged to master. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zabetak&quot; class=&quot;user-hover&quot; rel=&quot;zabetak&quot;&gt;zabetak&lt;/a&gt; for review.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13063500" name="auto_sortmerge_join_17.q" size="776" author="rtrivedi12" created="Thu, 12 Oct 2023 02:57:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 51 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1kw1k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>