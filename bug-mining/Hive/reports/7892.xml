<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:19:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-24666] Vectorized UDFToBoolean may unable to filter rows if input is string</title>
                <link>https://issues.apache.org/jira/browse/HIVE-24666</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;If we use cast boolean to filter rows,&#160; in vectorization mode the filter may be unable to filter rows,&#160; step to reproduce:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
create table vtb (key string, value string);
insert into table&#160;vtb values(&lt;span class=&quot;code-quote&quot;&gt;&apos;0&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;val0&apos;&lt;/span&gt;), (&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;valfalse&apos;&lt;/span&gt;),(&lt;span class=&quot;code-quote&quot;&gt;&apos;off&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;valoff&apos;&lt;/span&gt;),(&lt;span class=&quot;code-quote&quot;&gt;&apos;no&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;valno&apos;&lt;/span&gt;),(&lt;span class=&quot;code-quote&quot;&gt;&apos;vk&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;valvk&apos;&lt;/span&gt;);
select distinct value from&#160;vtb where &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(key as &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;);&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It&apos;s seems we don&apos;t generate a&#160;SelectColumnIsTrue to filter the rows if the casted type is string:&lt;br/&gt;
 &#160;&lt;a href=&quot;https://github.com/apache/hive/blob/ff6f3565e50148b7bcfbcf19b970379f2bd59290/ql/src/java/org/apache/hadoop/hive/ql/exec/vector/VectorizationContext.java#L2995-L2996&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/ff6f3565e50148b7bcfbcf19b970379f2bd59290/ql/src/java/org/apache/hadoop/hive/ql/exec/vector/VectorizationContext.java#L2995-L2996&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13353516">HIVE-24666</key>
            <summary>Vectorized UDFToBoolean may unable to filter rows if input is string</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dengzh">Zhihua Deng</assignee>
                                    <reporter username="dengzh">Zhihua Deng</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 20 Jan 2021 11:53:07 +0000</created>
                <updated>Mon, 2 Oct 2023 13:27:20 +0000</updated>
                            <resolved>Tue, 16 Feb 2021 22:29:53 +0000</resolved>
                                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                    <component>Vectorization</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3000">50m</timespent>
                                <comments>
                            <comment id="17268817" author="gopalv" created="Wed, 20 Jan 2021 19:30:28 +0000"  >&lt;p&gt;This looks like the wrong fix for the problem (i.e switching to UDFAdaptor, instead of fixing vectorized filter).&lt;/p&gt;</comment>
                            <comment id="17269040" author="dengzh" created="Thu, 21 Jan 2021 05:25:22 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt;&#160;for&#160;pointing it out. I&apos;ve updated the codes to fix the wrongly adaptor,&#160; could you please take another look?&#160;&lt;/p&gt;</comment>
                            <comment id="17270879" author="gopalv" created="Sun, 24 Jan 2021 14:16:53 +0000"  >&lt;p&gt;I see your fix, but I think this is a class of problems as it is pretty clear that the CastStringToBoolean only has a PROJECTION in it, so the SelectColumnIsTrue has got FILTER.&lt;/p&gt;

&lt;p&gt;So this might need a generic wrap PROJECTION with SelectColumnIsTrue as a general case (not just for cast or just that one cast boolean).&lt;/p&gt;</comment>
                            <comment id="17270881" author="gopalv" created="Sun, 24 Jan 2021 14:18:33 +0000"  >&lt;p&gt;So this fix is good, but it fixes only the specific issue by wrapping it with the filter (that modifies the .selected vector) - the real issue is hiding somewhere else.&lt;/p&gt;</comment>
                            <comment id="17270899" author="gopalv" created="Sun, 24 Jan 2021 14:20:31 +0000"  >&lt;p&gt;I think for an uncasted column, this is how it gets placed for decimal64.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/exec/vector/VectorizationContext.java#L1942&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/exec/vector/VectorizationContext.java#L1942&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (childExpr &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ExprNodeColumnDesc) {
          &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; colIndex = getInputColumnIndex((ExprNodeColumnDesc) childExpr);
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (childrenMode == VectorExpressionDescriptor.Mode.FILTER) {

            VectorExpression filterExpr = getFilterOnBooleanColumnExpression((ExprNodeColumnDesc) childExpr, colIndex);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (filterExpr == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
              &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            }

            children.add(filterExpr);
          }
          arguments[i] = colIndex;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17271106" author="dengzh" created="Mon, 25 Jan 2021 07:36:06 +0000"  >&lt;p&gt;Thanks much for the reply.&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160;So this might need a generic wrap PROJECTION with SelectColumnIsTrue as a general case (not just for cast or just that one cast boolean).&lt;/p&gt;

&lt;p&gt;I&apos;m not sure I understand for this,&#160; but put all non-boolean filter expressions casting at logical plan and move the vectorized UDFToBoolean to a standalone method.&#160; The vectorization has implemented the constants, user&#160;customized functions,&#160; columns that wrapping with&#160;SelectColumnIsTrue if use these to filter the rows.&#160; Cloud you please put it a little bit more if I am wrong&#65311;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160;but it fixes only the specific issue by wrapping it with the filter (that modifies the .selected vector) - the real issue is hiding somewhere else.&lt;/p&gt;

&lt;p&gt;I think the cause is that the&#160;vectorized expressions of UDFToBoolean only have&#160;PROJECTION mode in them, as you have explained, so when we use it to filter rows, we should evaluate SelectColumnIsTrue on the results of cast before forwarding the batch to the next operation.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17271616" author="gopalv" created="Mon, 25 Jan 2021 19:19:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;Cloud you please put it a little bit more if I am wrong&#65311;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re not wrong, this patch works for the specific bug you are reporting, but introduces deeper plan changes that are not necessary.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
FilterExprOrExpr(children: SelectColumnIsTrue(col 4:&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;)(children: CastLongToBooleanViaLongToLong(col 2:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) -&amp;gt; 4:&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;), SelectColumnIsTrue(col 5:&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;)(children: CastStringToBoolean(col 0) -&amp;gt; 5:&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Would have been correct even without the SelectColumnIsTrue&lt;/p&gt;</comment>
                            <comment id="17272061" author="dengzh" created="Tue, 26 Jan 2021 12:03:13 +0000"  >&lt;p&gt;Added a unit test(TestVectorFilterExpressions#testCastFilter)&#160;to show that a&#160;SelectColumnIsTrue is needed for the cast filter, and I will recheck on this.&lt;/p&gt;</comment>
                            <comment id="17274497" author="dengzh" created="Fri, 29 Jan 2021 15:07:46 +0000"  >&lt;p&gt;Correct me if wrong...&lt;br/&gt;
 Before the patch, queries like&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select count (distinct cint) from alltypesorc where &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(cint as &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the filter&#160;&lt;b&gt;&lt;em&gt;cast(cint as boolean)&lt;/em&gt;&lt;/b&gt; would be converted to&#160;&quot;&lt;em&gt;SelectColumnIsTrue(col 13:boolean)(children: VectorUDFAdaptor(UDFToBoolean(cint)) -&amp;gt; 13:boolean)&quot; .&lt;/em&gt;&#160;This is caused by the vectored expressions of&#160;UDFToBoolean all in project mode, so an adapter will be here.&lt;br/&gt;
 &#160;&lt;br/&gt;
 For &lt;em&gt;cint1 or cint2&lt;/em&gt;, SelectColumnIsTrue may not be needed,&#160; but this may make things a bit difficult as we should take some actions when the expression&#160;&lt;b&gt;or&lt;/b&gt; cannot be converted to vectorized filter, we should put a cast to the children and try again. For example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select count (distinct cint) from alltypesorc where cfloat or cint;&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the filter&#160;&lt;em&gt;&lt;b&gt;cfloat or cint&lt;/b&gt;&lt;/em&gt; would be converted into&#160;&#160;&lt;em&gt;&quot;SelectColumnIsTrue(col 13:boolean)(children: VectorUDFAdaptor((cfloat or cint)) -&amp;gt; 13:boolean)&quot;&lt;/em&gt;&lt;b&gt;,&lt;/b&gt;&#160; a ClassCastException can be seen at runtime because cfloat/cint is not the bool type,&#160;there may be some other cases that cannot be converted to the vectorized filter of GenericUDFOPOr and result to such problem.&lt;br/&gt;
 &#160;&lt;br/&gt;
 For these cases, a simple useful method is that we insert a bool type conversion when generating&#160;the expression, this can avoid the ClassCastException at runtime, make such filters be converted to vectorized&#65292;and also benefit the queries running on non vectorization mode.&lt;/p&gt;</comment>
                            <comment id="17277409" author="gopalv" created="Tue, 2 Feb 2021 19:19:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;This is caused by the vectored expressions of UDFToBoolean all in project mode, so an adapter will be here.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You are right about that, I thought the OrExpr would OR the booleans &amp;amp; then filter once, but it is a nested filter operator.&lt;/p&gt;

&lt;p&gt;I&apos;ll take a closer look at this patch - I think the independent function for the boolean cast could be enhanced to do what your code does inside getVectorExpression(). &lt;/p&gt;

&lt;p&gt;Let me check that quickly and if not ,I&apos;ll approve this PR instead of holding it back.&lt;/p&gt;</comment>
                            <comment id="17284158" author="dengzh" created="Sat, 13 Feb 2021 09:53:04 +0000"  >&lt;p&gt;Any comments or thoughts on the changes?&#160; thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="17284333" author="gopalv" created="Sun, 14 Feb 2021 05:25:48 +0000"  >&lt;p&gt;The new patch looks really good. You&apos;ve done exactly what I would have with the cast expr impl.&lt;/p&gt;

&lt;p&gt;Looks like this patch changes the non-vectorized code as well. I can see what you did in SemanticAnalyze &amp;amp; TypeCheckProc, but that code needs a comment (the complex type &quot;is not null&quot; + the cast for the other types).&lt;/p&gt;

&lt;p&gt;For example, if I saw this below change in a git bisect check, I would immediately look to see what removed the Filter operator (in context of this patch, that is pretty clear - but reading the SemanticAnalyzer is hard enough as it is).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
--- ql/src/test/results/clientpositive/llap/annotate_stats_filter.q.out
+++ ql/src/test/results/clientpositive/llap/annotate_stats_filter.q.out
@@ -375,12 +375,10 @@ STAGE PLANS:
       Processor Tree:
         TableScan
           alias: loc_orc
-          Filter Operator
-            predicate: &lt;span class=&quot;code-quote&quot;&gt;&apos;foo&apos;&lt;/span&gt; (type: string)
-            Select Operator
-              expressions: state (type: string), locid (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;), zip (type: bigint), year (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
-              outputColumnNames: _col0, _col1, _col2, _col3
-              ListSink
+          Select Operator
+            expressions: state (type: string), locid (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;), zip (type: bigint), year (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
+            outputColumnNames: _col0, _col1, _col2, _col3
+            ListSink
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17284337" author="gopalv" created="Sun, 14 Feb 2021 05:42:57 +0000"  >&lt;p&gt;LGTM - +1 &lt;/p&gt;

&lt;p&gt;will merge this on Tuesday. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dengzh&quot; class=&quot;user-hover&quot; rel=&quot;dengzh&quot;&gt;dengzh&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17285530" author="gopalv" created="Tue, 16 Feb 2021 22:29:53 +0000"  >&lt;p&gt;Pushed to master, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dengzh&quot; class=&quot;user-hover&quot; rel=&quot;dengzh&quot;&gt;dengzh&lt;/a&gt; for the work &amp;amp; patience. &lt;/p&gt;</comment>
                            <comment id="17285556" author="dengzh" created="Wed, 17 Feb 2021 00:04:00 +0000"  >&lt;p&gt;Thank you very much for the review and merge, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13552300">HIVE-27754</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13019191" name="HIVE-24666.2.patch" size="24441" author="dengzh" created="Fri, 22 Jan 2021 06:16:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 39 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0msx4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>