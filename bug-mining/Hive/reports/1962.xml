<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:16:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-5099] Some partition publish operation cause OOM in metastore backed by SQL Server</title>
                <link>https://issues.apache.org/jira/browse/HIVE-5099</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;For certain metastore operation combination, metastore operation hangs and metastore server eventually fail due to OOM. This happens when metastore is backed by SQL Server. Here is a testcase to reproduce:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TABLE tbl_repro_oom1 (a STRING, b INT) PARTITIONED BY (c STRING, d STRING);
CREATE TABLE tbl_repro_oom_2 (a STRING ) PARTITIONED BY (e STRING);
ALTER TABLE tbl_repro_oom1 ADD PARTITION (c=&lt;span class=&quot;code-quote&quot;&gt;&apos;France&apos;&lt;/span&gt;, d=4);
ALTER TABLE tbl_repro_oom1 ADD PARTITION (c=&lt;span class=&quot;code-quote&quot;&gt;&apos;Russia&apos;&lt;/span&gt;, d=3);
ALTER TABLE tbl_repro_oom_2 ADD PARTITION (e=&lt;span class=&quot;code-quote&quot;&gt;&apos;Russia&apos;&lt;/span&gt;);
ALTER TABLE tbl_repro_oom1 DROP PARTITION (c &amp;gt;= &lt;span class=&quot;code-quote&quot;&gt;&apos;India&apos;&lt;/span&gt;); --failure
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The code cause the issue is in ExpressionTree.java:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;valString = &lt;span class=&quot;code-quote&quot;&gt;&quot;partitionName.substring(partitionName.indexOf(\&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot; + keyEqual + &quot;&lt;/span&gt;\&lt;span class=&quot;code-quote&quot;&gt;&quot;)+&quot;&lt;/span&gt; + keyEqualLength + &lt;span class=&quot;code-quote&quot;&gt;&quot;).substring(0, partitionName.substring(partitionName.indexOf(\&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot; + keyEqual + &quot;&lt;/span&gt;\&lt;span class=&quot;code-quote&quot;&gt;&quot;)+&quot;&lt;/span&gt; + keyEqualLength + &lt;span class=&quot;code-quote&quot;&gt;&quot;).indexOf(\&quot;&lt;/span&gt;/\&lt;span class=&quot;code-quote&quot;&gt;&quot;))&quot;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The snapshot of table partition before the &quot;drop partition&quot; statement is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;PART_ID  CREATE_TIME    LAST_ACCESS_TIME      PART_NAME                SD_ID   TBL_ID 
93	1376526718	0	             c=France/d=4	127	33
94	1376526718	0	             c=Russia/d=3	128	33
95	1376526718	0	             e=Russia	        129	34
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Datanucleus query try to find the value of a particular key by locating &quot;$key=&quot; as the start, &quot;/&quot; as the end. For example, value of c in &quot;c=France/d=4&quot; by locating &quot;c=&quot; as the start, &quot;/&quot; following as the end. However, this query fail if we try to find value &quot;e&quot; in &quot;e=Russia&quot; since there is no tailing &quot;/&quot;. &lt;/p&gt;

&lt;p&gt;Other database works since the query plan first filter out the partition not belonging to tbl_repro_oom1. Whether this error surface or not depends on the query optimizer.&lt;/p&gt;

&lt;p&gt;When this exception happens, metastore keep trying and throw exception. The memory image of metastore contains a large number of exception objects:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;com.microsoft.sqlserver.jdbc.SQLServerException: Invalid length parameter passed to the LEFT or SUBSTRING function.
	at com.microsoft.sqlserver.jdbc.SQLServerException.makeFromDatabaseError(SQLServerException.java:197)
	at com.microsoft.sqlserver.jdbc.SQLServerResultSet$FetchBuffer.nextRow(SQLServerResultSet.java:4762)
	at com.microsoft.sqlserver.jdbc.SQLServerResultSet.fetchBufferNext(SQLServerResultSet.java:1682)
	at com.microsoft.sqlserver.jdbc.SQLServerResultSet.next(SQLServerResultSet.java:955)
	at org.apache.commons.dbcp.DelegatingResultSet.next(DelegatingResultSet.java:207)
	at org.apache.commons.dbcp.DelegatingResultSet.next(DelegatingResultSet.java:207)
	at org.datanucleus.store.rdbms.query.ForwardQueryResult.&amp;lt;init&amp;gt;(ForwardQueryResult.java:90)
	at org.datanucleus.store.rdbms.query.JDOQLQuery.performExecute(JDOQLQuery.java:686)
	at org.datanucleus.store.query.Query.executeQuery(Query.java:1791)
	at org.datanucleus.store.query.Query.executeWithMap(Query.java:1694)
	at org.datanucleus.api.jdo.JDOQuery.executeWithMap(JDOQuery.java:334)
	at org.apache.hadoop.hive.metastore.ObjectStore.listMPartitionsByFilter(ObjectStore.java:1715)
	at org.apache.hadoop.hive.metastore.ObjectStore.getPartitionsByFilter(ObjectStore.java:1590)
	at sun.reflect.GeneratedMethodAccessor5.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:601)
	at org.apache.hadoop.hive.metastore.RetryingRawStore.invoke(RetryingRawStore.java:111)
	at $Proxy4.getPartitionsByFilter(Unknown Source)
	at org.apache.hadoop.hive.metastore.HiveMetaStore$HMSHandler.get_partitions_by_filter(HiveMetaStore.java:2163)
	at sun.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:601)
	at org.apache.hadoop.hive.metastore.RetryingHMSHandler.invoke(RetryingHMSHandler.java:105)
	at $Proxy5.get_partitions_by_filter(Unknown Source)
	at org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$Processor$get_partitions_by_filter.getResult(ThriftHiveMetastore.java:5449)
	at org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$Processor$get_partitions_by_filter.getResult(ThriftHiveMetastore.java:5437)
	at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:32)
	at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:34)
	at org.apache.hadoop.hive.metastore.TSetIpAddressProcessor.process(TSetIpAddressProcessor.java:48)
	at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:176)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:722)
)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This eventually cause the OOM of metastore server. &lt;/p&gt;

&lt;p&gt;This Jira only try to fix the SQL exception, which prevent OOM from happening in the above scenario. We might also need to look at how to prevent metastore OOM when an error happen, but that is out of the scope of this Jira.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12663780">HIVE-5099</key>
            <summary>Some partition publish operation cause OOM in metastore backed by SQL Server</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daijy">Daniel Dai</assignee>
                                    <reporter username="daijy">Daniel Dai</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Aug 2013 01:00:07 +0000</created>
                <updated>Wed, 12 Mar 2014 12:32:42 +0000</updated>
                            <resolved>Wed, 12 Mar 2014 12:32:42 +0000</resolved>
                                                    <fixVersion>0.13.0</fixVersion>
                                    <component>Metastore</component>
                    <component>Windows</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13740524" author="daijy" created="Thu, 15 Aug 2013 01:11:51 +0000"  >&lt;p&gt;Attach patch, which appending a tailing &quot;/&quot; before searching &quot;/&quot;. There is one complexity though. There is no concat function in datanucleus query language. So I implement it in a datanucleus plug-in. I tested with sqlserver, mysql, postgresql, derby, and should theoretically work with oracle, db2.&lt;/p&gt;</comment>
                            <comment id="13844732" author="daijy" created="Tue, 10 Dec 2013 22:10:49 +0000"  >&lt;p&gt;Update the patch after &lt;a href=&quot;http://www.datanucleus.org/servlet/jira/browse/NUCRDBMS-718&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.datanucleus.org/servlet/jira/browse/NUCRDBMS-718&lt;/a&gt;. Need to upgrade datanucleus version to embrace the change.&lt;/p&gt;</comment>
                            <comment id="13844744" author="daijy" created="Tue, 10 Dec 2013 22:19:48 +0000"  >&lt;p&gt;Attach patch, which:&lt;br/&gt;
1. Remove hive-datanucleusplugin&lt;br/&gt;
2. Upgrade datanucleus version&lt;/p&gt;</comment>
                            <comment id="13844746" author="daijy" created="Tue, 10 Dec 2013 22:20:35 +0000"  >&lt;p&gt;Sorry, please ignore my last comment.&lt;/p&gt;</comment>
                            <comment id="13911000" author="thejas" created="Mon, 24 Feb 2014 23:46:56 +0000"  >&lt;p&gt;Linked to &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-5218&quot; title=&quot;datanucleus does not work with MS SQLServer in Hive metastore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-5218&quot;&gt;&lt;del&gt;HIVE-5218&lt;/del&gt;&lt;/a&gt;, which is another jira where upgrade of datanucleus version was proposed.&lt;/p&gt;</comment>
                            <comment id="13912370" author="hsubramaniyan" created="Wed, 26 Feb 2014 01:21:26 +0000"  >&lt;p&gt;non-binding +1. cc-ing &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ashutoshc&quot; class=&quot;user-hover&quot; rel=&quot;ashutoshc&quot;&gt;ashutoshc&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thejas&quot; class=&quot;user-hover&quot; rel=&quot;thejas&quot;&gt;thejas&lt;/a&gt; for review. &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-5218&quot; title=&quot;datanucleus does not work with MS SQLServer in Hive metastore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-5218&quot;&gt;&lt;del&gt;HIVE-5218&lt;/del&gt;&lt;/a&gt; should be marked as a duplicate of this jira, since this upgrades datanucleus to an ever newer version.&lt;/p&gt;</comment>
                            <comment id="13922640" author="thejas" created="Thu, 6 Mar 2014 15:23:46 +0000"  >&lt;p&gt;+1 . &lt;br/&gt;
Rebased the patch, changes were only to surrounding line version numbers.&lt;/p&gt;</comment>
                            <comment id="13922684" author="thejas" created="Thu, 6 Mar 2014 16:08:41 +0000"  >&lt;p&gt;FYI, the new versions of datanucleus in this patch has been tested to work with following databases&lt;/p&gt;

&lt;p&gt;MySQL 5.x&lt;br/&gt;
Oracle11g r2&lt;br/&gt;
Postgres 8.x&lt;br/&gt;
Postgres 9.x&lt;br/&gt;
SQL Server - Windows&lt;/p&gt;</comment>
                            <comment id="13924639" author="sershe" created="Sat, 8 Mar 2014 01:34:13 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13931704" author="thejas" created="Wed, 12 Mar 2014 12:32:42 +0000"  >&lt;p&gt;Patch committed to trunk and 0.13 branch (already in Harish&apos;s list for 0.13).&lt;br/&gt;
Thanks Daniel!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12667054">HIVE-5218</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12669107">HIVE-5303</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12667054">HIVE-5218</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12598125" name="HIVE-5099-1.patch" size="10082" author="daijy" created="Thu, 15 Aug 2013 01:11:51 +0000"/>
                            <attachment id="12618114" name="HIVE-5099-2.patch" size="1599" author="daijy" created="Tue, 10 Dec 2013 22:10:49 +0000"/>
                            <attachment id="12633157" name="HIVE-5099.3.patch" size="1599" author="thejas" created="Thu, 6 Mar 2014 15:21:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>343781</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1nab3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>344083</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>