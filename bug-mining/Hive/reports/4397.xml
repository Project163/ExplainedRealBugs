<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:43:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-11388] Allow ACID Compactor components to run in multiple metastores</title>
                <link>https://issues.apache.org/jira/browse/HIVE-11388</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;(this description is no loner accurate; see further comments)&lt;/p&gt;

&lt;p&gt;org.apache.hadoop.hive.ql.txn.compactor.Initiator is a thread that runs inside the metastore service to manage compactions of ACID tables.  There should be exactly 1 instance of this thread (even with multiple Thrift services).&lt;/p&gt;

&lt;p&gt;This is documented in &lt;a href=&quot;https://cwiki.apache.org/confluence/display/Hive/Hive+Transactions#HiveTransactions-Configuration&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/Hive/Hive+Transactions#HiveTransactions-Configuration&lt;/a&gt; but not enforced.&lt;/p&gt;

&lt;p&gt;Should add enforcement, since more than 1 Initiator could cause concurrent attempts to compact the same table/partition - which will not work.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12849495">HIVE-11388</key>
            <summary>Allow ACID Compactor components to run in multiple metastores</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ekoifman">Eugene Koifman</assignee>
                                    <reporter username="ekoifman">Eugene Koifman</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Jul 2015 01:16:59 +0000</created>
                <updated>Thu, 8 Apr 2021 12:18:27 +0000</updated>
                            <resolved>Fri, 25 Mar 2016 00:24:35 +0000</resolved>
                                    <version>1.0.0</version>
                                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>Transactions</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                                                            <comments>
                            <comment id="14696069" author="ekoifman" created="Thu, 13 Aug 2015 22:31:47 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vgumashta&quot; class=&quot;user-hover&quot; rel=&quot;vgumashta&quot;&gt;vgumashta&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14696092" author="vgumashta" created="Thu, 13 Aug 2015 22:44:46 +0000"  >&lt;p&gt;Or leader election using ZK? At any point only the leader starts the initiator thread.&lt;/p&gt;</comment>
                            <comment id="14999937" author="ekoifman" created="Wed, 11 Nov 2015 04:45:50 +0000"  >&lt;p&gt;A simpler idea:&lt;br/&gt;
The Initiator places a row in COMPACTION_QUEUE to &apos;schedule&apos; a compaction.&lt;br/&gt;
Before that it generates an ID from NEXT_COMPACTION_QUEUE_ID.&lt;br/&gt;
With &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-11948&quot; title=&quot;Investigate TxnHandler and CompactionTxnHandler to see where we improve concurrency&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-11948&quot;&gt;&lt;del&gt;HIVE-11948&lt;/del&gt;&lt;/a&gt; we have support for SELECT FOR UPDATE on every DB except Derby, though even w/o it we have Serializable isolation.  Either way we should be able to check that (db,table,partition,state=Initiated/Working) combination is unique.  &lt;/p&gt;

&lt;p&gt;This allows Initiator to run on any/every metastore while ensuring there is no double-compaction happening.  &lt;/p&gt;

&lt;p&gt;Need to come up with a solution for Cleaner.  Could add another state, such as &apos;bc&apos;= being cleaned, so that 1 cleaner marks a row as bc, and then others ignore it.  (This just needs to be cleaned up on failure)&lt;/p&gt;

&lt;p&gt;This avoids the ZK.&lt;/p&gt;</comment>
                            <comment id="15000995" author="ekoifman" created="Wed, 11 Nov 2015 20:05:06 +0000"  >&lt;p&gt;A simpler way to deal with Cleaner: entries in COMPACTION_QUEUE have WORKER_ID which includes hostname of the worker.  If cleaner runs on each metastore, we can make each Cleaner only handle entries from Worker(s) from the same host.  This will ensure Cleaner don&apos;t step on each other.&lt;/p&gt;

&lt;p&gt;Side note, when metastores get restarted (perhaps even on different host), we have logic to removeTimedoutWokers() so we can piggyback on this to ensure that Cleaner doesn&apos;t miss any compactions (in the long run at least).  But also see &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-11685&quot; title=&quot;Restarting Metastore kills Compactions - store Hadoop job id in COMPACTION_QUEUE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-11685&quot;&gt;HIVE-11685&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;We also want to make sure AcidHouseKeeper instances don&apos;t step on each other.&lt;/p&gt;
</comment>
                            <comment id="15001077" author="alangates" created="Wed, 11 Nov 2015 21:02:29 +0000"  >&lt;p&gt;Avoiding ZK is a major bonus.  I&apos;m wondering if your first proposal of having another state would be better.  Depending on the cleaner being on the same host seems like it has some issues:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;How do we deal with the case where the cleaner thread on a metastore dies?  The workers will keep compacting but no one will be cleaning up.&lt;/li&gt;
	&lt;li&gt;How do we detect orphaned compactions in the waiting for cleaning state?  Minus something like ZK it&apos;s not immediately obvious to me how to figure out that a given metastore instance died or was shut down and that another cleaner should step in and take over.  You could wait a day or something, but even then you&apos;d have to manage determining who stepped in.  Basically I think you&apos;ll have to have some form of coordination and doing it in the database seems like the best method.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15001593" author="ekoifman" created="Thu, 12 Nov 2015 02:37:32 +0000"  >&lt;p&gt;another note:  CompactionTxnHandler.cleanEmptyAbortedTxns() which runs from Initiator should ideally not run in parallel.  This won&apos;t corrupt anything, but may tax the DB unnecessarily.&lt;/p&gt;
</comment>
                            <comment id="15061006" author="ekoifman" created="Wed, 16 Dec 2015 22:18:22 +0000"  >&lt;p&gt;here is one general purpose mechanism:&lt;br/&gt;
create table MUTEX_TABLE(keyname varchar(512) PRIMARY KEY)&lt;/p&gt;

&lt;p&gt;Then any process that requires a mutex needs to insert a row into this table (as long as everyone agrees on the key) and then do a &quot;Select for update&quot; on this row.  If the process dies, &quot;select for update&quot; lock is automatically released.&lt;/p&gt;

&lt;p&gt;For example, if 2 Initiator instances want to schedule a compaction, each could&lt;br/&gt;
1. select * from MUTEX_TABLE where keyname=&quot;initiator&quot; for update.&lt;br/&gt;
If the &quot;initiator&quot; row is already there, only 1 will succeed.  The other one, once it unblocks, will already see &quot;this&quot; compaction scheduled.&lt;br/&gt;
2. if select in 1 misses, then Initiator can insert &quot;initiator&quot; row and then goto 1.  Because of PK only 1 will succeed.&lt;/p&gt;

&lt;p&gt;Since the keyname is arbitrary, it can be &quot;db/table/partition&quot; to coordinate Workers if necessary.&lt;/p&gt;

&lt;p&gt;A little primitive, but workable and avoids ZooKeeper and allows all parts of Compaction/HouseKeeping to run on multiple MS nodes.&lt;/p&gt;</comment>
                            <comment id="15066851" author="alangates" created="Mon, 21 Dec 2015 18:42:56 +0000"  >&lt;p&gt;I would suggest adding hostname to the MUTEX_TABLE so that admins can easily figure out which instance of metastore is running a given thread.&lt;/p&gt;

&lt;p&gt;But what happens when that metastore dies?  How does one of the existing metastores know to start an initiator?  The table will also need a &apos;last_hearbeat&apos; column that is updated each time the initiator runs.  Other initiator threads will need to spin checking this every minute or so to see if the previous initiator has died, and if so take over.  If the first metastore then heartbeats again it would have to discover it no longer holds the lock and kill its initiator thread.&lt;/p&gt;</comment>
                            <comment id="15066872" author="ekoifman" created="Mon, 21 Dec 2015 18:53:25 +0000"  >&lt;p&gt;I agree that the &quot;hostname&quot; field may is useful.&lt;/p&gt;

&lt;p&gt;The idea is that Initiator thread is running in each metastore.&lt;br/&gt;
But if it needs to perform some operation in a way that another Initiator doesn&apos;t attempt the same, then the row in MUTEX_TABLE with key=&quot;initiator&quot; will be locked using Select for Update to provide exclusive access.  If it dies, DB will automatically release the lock and another Initiator instance will be able to proceed.  &lt;/p&gt;
</comment>
                            <comment id="15066964" author="alangates" created="Mon, 21 Dec 2015 19:44:09 +0000"  >&lt;p&gt;Ok, that makes sense.  Since the row will never really appear in the database then the hostname field may not make sense.  A couple of other thoughts:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;This &quot;lock&quot; will be limited by any intervening commits.  This is probably ok as we probably shouldn&apos;t be locking across commits anyway, but we want to make sure we aren&apos;t inadvertently dropping the lock midway through.&lt;/li&gt;
	&lt;li&gt;Can we make this a couple of protected methods in TxnHandler &lt;tt&gt;void getMutex(String mutexName)&lt;/tt&gt; and &lt;tt&gt;void releaseMutex(String mutexName)&lt;/tt&gt;.  This way when the HBaseMetastore work gets around to implementing TxnHandler and has to do it in a completely different way it will still have internal method to do it with.  If this adds a bunch of work you can ignore the request.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15086442" author="ekoifman" created="Wed, 6 Jan 2016 22:56:25 +0000"  >&lt;p&gt;I don&apos;t think &quot;intervening commits&quot; are an issue.  Suppose getMutex() works like this:&lt;br/&gt;
1. get jdbc connection&lt;br/&gt;
2. run &quot;select for update&quot;&lt;br/&gt;
3. return &quot;Handle&quot; - which wraps connection/statement object.&lt;/p&gt;

&lt;p&gt;Then releaseMutex() will take &quot;Handle&quot; as parameter to commit/rollback to &quot;release&quot; the lock.&lt;br/&gt;
So if any other operation uses a separate jdbc connection to do work, it will be done with a &quot;protected&quot; block bounded by getMutex()/releaseMutex(Handle)&lt;/p&gt;
</comment>
                            <comment id="15192327" author="hiveqa" created="Sun, 13 Mar 2016 12:13:36 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12793166/HIVE-11388.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12793166/HIVE-11388.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 5 failed/errored test(s), 9789 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestMiniTezCliDriver-schema_evol_text_nonvec_mapwork_table.q-orc_vectorization_ppd.q-vector_left_outer_join2.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-groupby3_map.q-sample2.q-auto_join14.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-groupby_map_ppr_multi_distinct.q-table_access_keys_stats.q-groupby4_noskew.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-join_rc.q-insert1.q-vectorized_rcfile_columnar.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-ppd_join4.q-join9.q-ppd_join3.q-and-12-more - did not produce a TEST-*.xml file
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7254/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7254/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7254/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7254/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-7254/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-7254/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12793166 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="15196428" author="alangates" created="Tue, 15 Mar 2016 23:01:25 +0000"  >&lt;p&gt;TxnHandler.isDuplicateKeyError - There are only cases in here for Derby and MySQL.  The other options will need to be added before this is committed.&lt;/p&gt;

&lt;p&gt;Other than that looks good.&lt;/p&gt;


</comment>
                            <comment id="15205729" author="hiveqa" created="Tue, 22 Mar 2016 03:49:13 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12794647/HIVE-11388.7.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12794647/HIVE-11388.7.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 3 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 4 failed/errored test(s), 9850 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestSparkCliDriver-groupby3_map.q-sample2.q-auto_join14.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-groupby_map_ppr_multi_distinct.q-table_access_keys_stats.q-groupby4_noskew.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-join_rc.q-insert1.q-vectorized_rcfile_columnar.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-ppd_join4.q-join9.q-ppd_join3.q-and-12-more - did not produce a TEST-*.xml file
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7333/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7333/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7333/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7333/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-7333/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-7333/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12794647 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="15206848" author="ekoifman" created="Tue, 22 Mar 2016 17:33:23 +0000"  >&lt;p&gt;This change makes use of JDBC Connections, and thus the connection pool may need to be larger.  Pool size is currently hardcoded.  Should fix &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-12592&quot; title=&quot;Expose connection pool tuning props in TxnHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-12592&quot;&gt;HIVE-12592&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15206928" author="ekoifman" created="Tue, 22 Mar 2016 18:10:22 +0000"  >&lt;p&gt;fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-12725&quot; title=&quot;CompactionTxnHandler.findNextToCompact() may produce &amp;quot;Operation not allowed after ResultSet closed&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-12725&quot;&gt;&lt;del&gt;HIVE-12725&lt;/del&gt;&lt;/a&gt; is included here&lt;/p&gt;</comment>
                            <comment id="15206934" author="ekoifman" created="Tue, 22 Mar 2016 18:12:44 +0000"  >&lt;p&gt;This patch also includes a 1 character fix to an issue introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-13013&quot; title=&quot;Further Improve concurrency in TxnHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-13013&quot;&gt;&lt;del&gt;HIVE-13013&lt;/del&gt;&lt;/a&gt; (SQL stmt in TxnHandler.lockTransactionRecord())&lt;/p&gt;</comment>
                            <comment id="15207615" author="wzheng" created="Wed, 23 Mar 2016 00:32:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ekoifman&quot; class=&quot;user-hover&quot; rel=&quot;ekoifman&quot;&gt;ekoifman&lt;/a&gt; I have several questions regarding patch 7.&lt;br/&gt;
1. In TxnHandler.acquireLock implementation, there&apos;s a &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!rs.next())&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;block, after that, shouldn&apos;t there be an else block that deals with the case when there&apos;s existing key in AUX_TABLE (thus roll back the select for update and retry)?&lt;br/&gt;
2. In Cleaner.run(), I&apos;m not sure if we need currentToCleanSet, since we&apos;re essentially checking the existence of compactId2CompactInfoMap members in toClean set.&lt;br/&gt;
3. In TestTxnHandler.testMutexAPI, we can add two more asserts after //now 2 and //now 3 to confirm.&lt;/p&gt;</comment>
                            <comment id="15207696" author="ekoifman" created="Wed, 23 Mar 2016 01:35:09 +0000"  >&lt;p&gt;1. The purpose is to run Select For Update.  So if the key is already there, the 1st &quot;rs = stmt.executeQuery(sqlStmt);&quot; will do it.&lt;br/&gt;
2. we do need this.  Since you may have several Cleaner processes running, they will each accumulate state in these data structures.  But you don&apos;t know which instance will end up actually cleaning files so if you remove data from these structures you&apos;ll have a memory leak.&lt;br/&gt;
3. What would that confirm?  If the counts are off at this point, it means the 2nd thread somehow ran ahead and thus it will see its counts being different.&lt;/p&gt;</comment>
                            <comment id="15207886" author="wzheng" created="Wed, 23 Mar 2016 05:19:46 +0000"  >&lt;p&gt;Thanks Eugene.&lt;br/&gt;
1. I see. It would be helpful to have a comment by the first stmt.executeQuery since it&apos;s not explicit. I didn&apos;t realize that in the first round &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
2. I mean we do need such logic to filter out compactions cleaned by other Cleaners. I&apos;m saying we can have simpler code by directly using toClean. But I just realized that we need to extract id from CompactionInfo to have a convenient set, so never mind.&lt;br/&gt;
3. Agree.&lt;/p&gt;

&lt;p&gt;Btw what&apos;s the purpose of having column MT_KEY2?&lt;/p&gt;</comment>
                            <comment id="15208816" author="wzheng" created="Wed, 23 Mar 2016 17:26:55 +0000"  >&lt;p&gt;Patch looks good. +1&lt;/p&gt;</comment>
                            <comment id="15209423" author="hiveqa" created="Wed, 23 Mar 2016 23:37:11 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12794647/HIVE-11388.7.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12794647/HIVE-11388.7.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to build exiting with an error&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7349/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7349/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7349/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7349/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-7349/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-7349/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Tests exited with: NonZeroExitCodeException
Command &apos;bash /data/hive-ptest/working/scratch/source-prep.sh&apos; failed with exit status 1 and output &apos;+ [[ -n /usr/java/jdk1.7.0_45-cloudera ]]
+ export JAVA_HOME=/usr/java/jdk1.7.0_45-cloudera
+ JAVA_HOME=/usr/java/jdk1.7.0_45-cloudera
+ export PATH=/usr/java/jdk1.7.0_45-cloudera/bin/:/usr/local/apache-maven-3.0.5/bin:/usr/java/jdk1.7.0_45-cloudera/bin:/usr/local/apache-ant-1.9.1/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin:/home/hiveptest/bin
+ PATH=/usr/java/jdk1.7.0_45-cloudera/bin/:/usr/local/apache-maven-3.0.5/bin:/usr/java/jdk1.7.0_45-cloudera/bin:/usr/local/apache-ant-1.9.1/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin:/home/hiveptest/bin
+ export &apos;ANT_OPTS=-Xmx1g -XX:MaxPermSize=256m &apos;
+ ANT_OPTS=&apos;-Xmx1g -XX:MaxPermSize=256m &apos;
+ export &apos;M2_OPTS=-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128&apos;
+ M2_OPTS=&apos;-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128&apos;
+ cd /data/hive-ptest/working/
+ tee /data/hive-ptest/logs/PreCommit-HIVE-TRUNK-Build-7349/source-prep.txt
+ [[ false == \t\r\u\e ]]
+ mkdir -p maven ivy
+ [[ git = \s\v\n ]]
+ [[ git = \g\i\t ]]
+ [[ -z master ]]
+ [[ -d apache-github-source-source ]]
+ [[ ! -d apache-github-source-source/.git ]]
+ [[ ! -d apache-github-source-source ]]
+ cd apache-github-source-source
+ git fetch origin
From https://github.com/apache/hive
   28ec243..8fc708b  branch-1   -&amp;gt; origin/branch-1
+ git reset --hard HEAD
HEAD is now at 39d029e HIVE-13296 Add vectorized Q test with complex types showing count(*) etc work correctly (Matt McCline, reviewed by Prasanth Jayachandran)
+ git clean -f -d
Removing common/src/java/org/apache/hadoop/hive/conf/HiveConf.java.orig
+ git checkout master
Already on &apos;master&apos;
+ git reset --hard origin/master
HEAD is now at 39d029e HIVE-13296 Add vectorized Q test with complex types showing count(*) etc work correctly (Matt McCline, reviewed by Prasanth Jayachandran)
+ git merge --ff-only origin/master
Already up-to-date.
+ git gc
+ patchCommandPath=/data/hive-ptest/working/scratch/smart-apply-patch.sh
+ patchFilePath=/data/hive-ptest/working/scratch/build.patch
+ [[ -f /data/hive-ptest/working/scratch/build.patch ]]
+ chmod +x /data/hive-ptest/working/scratch/smart-apply-patch.sh
+ /data/hive-ptest/working/scratch/smart-apply-patch.sh /data/hive-ptest/working/scratch/build.patch
The patch does not appear to apply with p0, p1, or p2
+ exit 1
&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12794647 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="15209570" author="ekoifman" created="Thu, 24 Mar 2016 01:56:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wzheng&quot; class=&quot;user-hover&quot; rel=&quot;wzheng&quot;&gt;wzheng&lt;/a&gt; could you review branch-1 patch&lt;/p&gt;</comment>
                            <comment id="15210930" author="wzheng" created="Thu, 24 Mar 2016 20:45:56 +0000"  >&lt;p&gt;branch-1 patch looks good. +1&lt;/p&gt;</comment>
                            <comment id="15211585" author="lefty@hortonworks.com" created="Fri, 25 Mar 2016 08:18:20 +0000"  >&lt;p&gt;Does this need to be documented in the wiki for releases 1.3.0 and 2.1.0?&lt;/p&gt;</comment>
                            <comment id="15214754" author="alangates" created="Mon, 28 Mar 2016 19:42:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;Does this need to be documented in the wiki for releases 1.3.0 and 2.1.0?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I am not sure.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ekoifman&quot; class=&quot;user-hover&quot; rel=&quot;ekoifman&quot;&gt;ekoifman&lt;/a&gt; is this all of the work needed to make it possible to run multiple initiators and cleaners, or just part of it?  Have we tested running them in multiple metastores?  If the answer to those is yes, then the answer to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=leftylev&quot; class=&quot;user-hover&quot; rel=&quot;leftylev&quot;&gt;leftylev&lt;/a&gt;&apos;s question is: &quot;definitely&quot;.&lt;/p&gt;</comment>
                            <comment id="15437611" author="ekoifman" created="Thu, 25 Aug 2016 20:34:25 +0000"  >&lt;p&gt;This has been documented. The only real change is in &quot;hive.compactor.initiator.on&quot; of &lt;a href=&quot;https://cwiki.apache.org/confluence/display/Hive/Hive+Transactions#HiveTransactions-NewConfigurationParametersforTransactions&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/Hive/Hive+Transactions#HiveTransactions-NewConfigurationParametersforTransactions&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="17317139" author="jacquesjza" created="Thu, 8 Apr 2021 12:18:27 +0000"  >&lt;p&gt;The documentation for&#160;&#160;hive.compactor.initiator.on&lt;/p&gt;

&lt;p&gt;at &lt;a href=&quot;https://cwiki.apache.org/confluence/display/Hive/Configuration+Properties&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/Hive/Configuration+Properties&lt;/a&gt;&#160;still mentions &quot;It&apos;s critical that this is enabled on exactly one metastore service instance (not enforced yet).&quot;&lt;br/&gt;
i.e. missing the &quot;As of&#160;Hive 1.3.0&#160;this property may be enabled on any number of standalone metastore instances.&quot; comment added to the link above.&lt;/p&gt;

&lt;p&gt;Should both links be in sync?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12937102">HIVE-13013</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12953048">HIVE-13344</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12923613">HIVE-12725</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12918691">HIVE-12592</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12860422">HIVE-11685</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12794011" name="HIVE-11388.2.patch" size="27001" author="ekoifman" created="Thu, 17 Mar 2016 17:01:11 +0000"/>
                            <attachment id="12794315" name="HIVE-11388.4.patch" size="38047" author="ekoifman" created="Sat, 19 Mar 2016 04:28:36 +0000"/>
                            <attachment id="12794602" name="HIVE-11388.5.patch" size="37160" author="ekoifman" created="Mon, 21 Mar 2016 20:51:48 +0000"/>
                            <attachment id="12794623" name="HIVE-11388.6.patch" size="38749" author="ekoifman" created="Mon, 21 Mar 2016 22:37:04 +0000"/>
                            <attachment id="12794647" name="HIVE-11388.7.patch" size="39955" author="ekoifman" created="Tue, 22 Mar 2016 00:39:20 +0000"/>
                            <attachment id="12795136" name="HIVE-11388.branch-1.patch" size="41268" author="ekoifman" created="Thu, 24 Mar 2016 01:56:01 +0000"/>
                            <attachment id="12793166" name="HIVE-11388.patch" size="26747" author="ekoifman" created="Sun, 13 Mar 2016 01:02:56 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12928881">HIVE-12832</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 31 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2hzx3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>