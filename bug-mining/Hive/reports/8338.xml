<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:23:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-26472] Concurrent UPDATEs can cause duplicate rows</title>
                <link>https://issues.apache.org/jira/browse/HIVE-26472</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Concurrent UPDATEs to the same table can cause duplicate rows when the following occurs:&lt;br/&gt;
Two UPDATEs get assigned txnIds and writeIds like this:&lt;br/&gt;
UPDATE #1 = txnId: 100 writeId: 50 &amp;lt;--- commits first&lt;br/&gt;
UPDATE #2 = txnId: 101 writeId: 49&lt;/p&gt;

&lt;p&gt;To replicate the issue:&lt;br/&gt;
I applied the attach debug.diff patch which adds hive.lock.sleep.writeid (which controls the amount to sleep before acquiring a writeId) and hive.lock.sleep.post.writeid (which controls the amount to sleep after acquiring a writeId).&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE TABLE test_update(i &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) STORED AS ORC TBLPROPERTIES(&lt;span class=&quot;code-quote&quot;&gt;&apos;transactional&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;);
INSERT INTO test_update VALUES (1);

Start two beeline connections.
In connection #1 - run:
set hive.driver.parallel.compilation = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
set hive.lock.sleep.writeid=5s;
update test_update set i = 1 where i = 1;

Wait one second and in connection #2 - run:
set hive.driver.parallel.compilation = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
set hive.lock.sleep.post.writeid=10s;
update test_update set i = 1 where i = 1;

After both updates complete - it is likely that test_update contains two rows now.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-24211&quot; title=&quot;Replace Snapshot invalidate logic with WriteSet check for txn conflict detection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-24211&quot;&gt;&lt;del&gt;HIVE-24211&lt;/del&gt;&lt;/a&gt; seems to address the case when:&lt;br/&gt;
UPDATE #1 = txnId: 100 writeId: 50&lt;br/&gt;
UPDATE #2 = txnId: 101 writeId: 49 &amp;lt;--- commits first (I think this causes UPDATE #1 to detect the snapshot is out of date because commitedTxn &amp;gt; UPDATE #1s txnId)&lt;/p&gt;

&lt;p&gt;A possible work around is to set hive.driver.parallel.compilation = false, but this would only help in cases there is only one HS2 instance.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13476907">HIVE-26472</key>
            <summary>Concurrent UPDATEs can cause duplicate rows</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jfs">John Sherman</assignee>
                                    <reporter username="jfs">John Sherman</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 15 Aug 2022 23:39:08 +0000</created>
                <updated>Tue, 23 Aug 2022 13:28:49 +0000</updated>
                            <resolved>Tue, 23 Aug 2022 13:28:49 +0000</resolved>
                                    <version>4.0.0-alpha-1</version>
                                                    <component>HiveServer2</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="17580529" author="jfs" created="Wed, 17 Aug 2022 01:45:03 +0000"  >&lt;p&gt;The current purposed patch approach is to always re-allocate writeIds during recompilation when the transaction is not out of date (so the transaction gets re-used). If the transaction is out of date, this is already handled by a full rollback and open of a transaction.&lt;/p&gt;

&lt;p&gt;This involves clearing the writeId cache and adding an optional reallocate boolean to allocateTableWriteIds (that defaults to false). The reason the reallocate boolean is required, is that allocateTableWriteIds will return the previously acquired writeIds for the transaction otherwise. So we need to delete the old assigned writeIds and associate new ones with the txn.&lt;/p&gt;</comment>
                            <comment id="17583623" author="jfs" created="Tue, 23 Aug 2022 13:28:49 +0000"  >&lt;p&gt;Reviewed and committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13048144" name="debug.diff" size="3554" author="jfs" created="Mon, 15 Aug 2022 23:37:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 12 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z17rtk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12351489">4.0.0-alpha-2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>