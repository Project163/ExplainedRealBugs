<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:22:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-26270] Wrong timestamps when reading Hive 3.1.x Parquet files with vectorized reader</title>
                <link>https://issues.apache.org/jira/browse/HIVE-26270</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Parquet files written in Hive 3.1.x onwards with timezone set to US/Pacific.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;TABLE&lt;/span&gt; employee (eid &lt;span class=&quot;code-keyword&quot;&gt;INT&lt;/span&gt;, birth &lt;span class=&quot;code-keyword&quot;&gt;timestamp&lt;/span&gt;) STORED &lt;span class=&quot;code-keyword&quot;&gt;AS&lt;/span&gt; PARQUET;

&lt;span class=&quot;code-keyword&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;INTO&lt;/span&gt; employee &lt;span class=&quot;code-keyword&quot;&gt;VALUES&lt;/span&gt; 
(1, &lt;span class=&quot;code-quote&quot;&gt;&apos;1880-01-01 00:00:00&apos;&lt;/span&gt;),
(2, &lt;span class=&quot;code-quote&quot;&gt;&apos;1884-01-01 00:00:00&apos;&lt;/span&gt;),
(3, &lt;span class=&quot;code-quote&quot;&gt;&apos;1990-01-01 00:00:00&apos;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Parquet files read with Hive 4.0.0-apha-1 onwards.&lt;/p&gt;

&lt;p&gt;&lt;ins&gt;Without vectorization&lt;/ins&gt; results are correct.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; * &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; employee;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;1	1880-01-01 00:00:00
2	1884-01-01 00:00:00
3	1990-01-01 00:00:00
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;ins&gt;With vectorization&lt;/ins&gt; some timestamps are shifted.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;-- &lt;span class=&quot;code-keyword&quot;&gt;Disable&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;fetch&lt;/span&gt; task &lt;span class=&quot;code-keyword&quot;&gt;conversion&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;force&lt;/span&gt; vectorization kick &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;set&lt;/span&gt; hive.&lt;span class=&quot;code-keyword&quot;&gt;fetch&lt;/span&gt;.task.&lt;span class=&quot;code-keyword&quot;&gt;conversion&lt;/span&gt;=&lt;span class=&quot;code-keyword&quot;&gt;none&lt;/span&gt;;
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; * &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; employee;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;1	1879-12-31 23:52:58
2	1884-01-01 00:00:00
3	1990-01-01 00:00:00
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The problem is the same reported under &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-24074&quot; title=&quot;Incorrect handling of timestamp in Parquet/Avro when written in certain time zones in versions before Hive 3.x&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-24074&quot;&gt;&lt;del&gt;HIVE-24074&lt;/del&gt;&lt;/a&gt;. The data were written using the new Date/Time APIs (java.time) in version Hive 3.1.3 and here they were read using the old APIs (java.sql).&lt;/p&gt;

&lt;p&gt;The difference with &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-24074&quot; title=&quot;Incorrect handling of timestamp in Parquet/Avro when written in certain time zones in versions before Hive 3.x&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-24074&quot;&gt;&lt;del&gt;HIVE-24074&lt;/del&gt;&lt;/a&gt; is that here the problem appears only for vectorized execution while the non-vectorized reader is working fine so there is some &lt;b&gt;inconsistency in the behavior&lt;/b&gt; of vectorized and non vectorized readers.&lt;/p&gt;

&lt;p&gt;Non-vectorized reader works fine cause it derives automatically that it should use the new JDK APIs to read back the timestamp value. This is possible in this case cause there are metadata information in the file (i.e., the presence of &lt;tt&gt;writer.time.zone&lt;/tt&gt;) from where it can infer that the timestamps were written using the new Date/Time APIs.&lt;/p&gt;

&lt;p&gt;The inconsistent behavior between vectorized and non-vectorized reader is a regression caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-25104&quot; title=&quot;Backward incompatible timestamp serialization in Parquet for certain timezones&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-25104&quot;&gt;&lt;del&gt;HIVE-25104&lt;/del&gt;&lt;/a&gt;. This JIRA is an attempt to re-align the behavior between vectorized and non-vectorized readers.&lt;/p&gt;

&lt;p&gt;Note that if the file metadata are empty both vectorized and non-vectorized reader cannot determine which APIs to use for the conversion and in this case it is necessary the user to set the&lt;br/&gt;
&lt;tt&gt;hive.parquet.timestamp.legacy.conversion.enabled&lt;/tt&gt; explicitly to get back the correct results.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13447235">HIVE-26270</key>
            <summary>Wrong timestamps when reading Hive 3.1.x Parquet files with vectorized reader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zabetak">Stamatis Zampetakis</assignee>
                                    <reporter username="zabetak">Stamatis Zampetakis</reporter>
                        <labels>
                            <label>compatibility</label>
                            <label>pull-request-available</label>
                            <label>timestamp</label>
                    </labels>
                <created>Fri, 27 May 2022 13:57:38 +0000</created>
                <updated>Thu, 19 Dec 2024 22:24:58 +0000</updated>
                            <resolved>Fri, 3 Jun 2022 08:30:07 +0000</resolved>
                                                    <fixVersion>4.0.0-alpha-2</fixVersion>
                                    <component>HiveServer2</component>
                    <component>Parquet</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17545772" author="zabetak" created="Fri, 3 Jun 2022 08:30:07 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/hive/commit/ebaba1436831831e5c60227c476e5fc362012fe4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/commit/ebaba1436831831e5c60227c476e5fc362012fe4&lt;/a&gt;. Thanks for the review and the fruitful discussions around timestamps &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvary&quot; class=&quot;user-hover&quot; rel=&quot;pvary&quot;&gt;pvary&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13377889">HIVE-25104</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13324590">HIVE-24074</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13602733">IMPALA-13627</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 23 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z12r20:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12351489">4.0.0-alpha-2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>