<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:18:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-23712] metadata-only queries return incorrect results with empty acid partition</title>
                <link>https://issues.apache.org/jira/browse/HIVE-23712</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Similarly to &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-15397&quot; title=&quot;metadata-only queries may return incorrect results with empty tables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-15397&quot;&gt;&lt;del&gt;HIVE-15397&lt;/del&gt;&lt;/a&gt;, queries can return incorrect results for metadata-only queries, here is a repro scenario which affects master:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
set hive.support.concurrency=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
set hive.exec.dynamic.partition.mode=nonstrict;
set hive.txn.manager=org.apache.hadoop.hive.ql.lockmgr.DbTxnManager;

set hive.optimize.metadataonly=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;

create table test1 (id &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, val string) partitioned by (val2 string) STORED AS ORC TBLPROPERTIES (&lt;span class=&quot;code-quote&quot;&gt;&apos;transactional&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;&lt;/span&gt;);
describe formatted test1;

alter table test1 add partition (val2=&lt;span class=&quot;code-quote&quot;&gt;&apos;foo&apos;&lt;/span&gt;);
alter table test1 add partition (val2=&lt;span class=&quot;code-quote&quot;&gt;&apos;bar&apos;&lt;/span&gt;);
insert into test1 partition (val2=&lt;span class=&quot;code-quote&quot;&gt;&apos;foo&apos;&lt;/span&gt;) values (1, &lt;span class=&quot;code-quote&quot;&gt;&apos;abc&apos;&lt;/span&gt;);
select distinct val2, current_timestamp from test1;
insert into test1 partition (val2=&lt;span class=&quot;code-quote&quot;&gt;&apos;bar&apos;&lt;/span&gt;) values (1, &lt;span class=&quot;code-quote&quot;&gt;&apos;def&apos;&lt;/span&gt;);
delete from test1 where val2 = &lt;span class=&quot;code-quote&quot;&gt;&apos;bar&apos;&lt;/span&gt;;

select &lt;span class=&quot;code-quote&quot;&gt;&apos;--&amp;gt; hive.optimize.metadataonly=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;&lt;/span&gt;;
select distinct val2, current_timestamp from test1;


set hive.optimize.metadataonly=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
select &lt;span class=&quot;code-quote&quot;&gt;&apos;--&amp;gt; hive.optimize.metadataonly=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&apos;&lt;/span&gt;;
select distinct val2, current_timestamp from test1;

select current_timestamp, * from test1;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in this case 2 rows returned instead of 1 after a delete with metadata only optimization:&lt;br/&gt;
&lt;a href=&quot;https://github.com/abstractdog/hive/commit/a7f03513564d01f7c3ba4aa61c4c6537100b4d3f#diff-cb23043000831f41fe7041cb38f82224R114-R128&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/abstractdog/hive/commit/a7f03513564d01f7c3ba4aa61c4c6537100b4d3f#diff-cb23043000831f41fe7041cb38f82224R114-R128&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13311922">HIVE-23712</key>
            <summary>metadata-only queries return incorrect results with empty acid partition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="abstractdog">L&#225;szl&#243; Bodor</assignee>
                                    <reporter username="abstractdog">L&#225;szl&#243; Bodor</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 17 Jun 2020 09:35:49 +0000</created>
                <updated>Thu, 17 Nov 2022 08:48:21 +0000</updated>
                            <resolved>Wed, 14 Oct 2020 08:04:54 +0000</resolved>
                                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3000">50m</timespent>
                                <comments>
                            <comment id="17138436" author="abstractdog" created="Wed, 17 Jun 2020 13:35:16 +0000"  >&lt;p&gt;the root cause is that in &lt;a href=&quot;https://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/optimizer/physical/MetadataOnlyOptimizer.java#L124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;MetadataOnlyOptimizer&lt;/a&gt; the TS operator of test1 table is considered to be subject of metadata-only optimization and later &lt;a href=&quot;https://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/optimizer/physical/NullScanTaskDispatcher.java#L106&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;NullScanTaskDispatcher&lt;/a&gt; find a non-empty folder for this partition because of ACID operations, with files:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
hdfs:&lt;span class=&quot;code-comment&quot;&gt;//localhost:58447/build/ql/test/data/warehouse/test1/val2=bar/delete_delta_0000003_0000003_0000
&lt;/span&gt;hdfs:&lt;span class=&quot;code-comment&quot;&gt;//localhost:58447/build/ql/test/data/warehouse/test1/val2=bar/delta_0000002_0000002_0000&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;not sure about the perfect solution at the moment, but maybe the following scenario should be excluded somehow from metadata-only optimization:&lt;br/&gt;
1. there is a partitioned table:&lt;br/&gt;
create table test1 (id int, val string) partitioned by (val2 string) STORED AS ORC TBLPROPERTIES (&apos;transactional&apos;=&apos;true&apos;);&lt;br/&gt;
2. in a distinct query, only the partitioned column is selected:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select distinct val2, current_timestamp, &lt;span class=&quot;code-quote&quot;&gt;&apos;metadata &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;&lt;/span&gt; as query from test1;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in this case tsOp.getNeededColumnIDs() is empty (partition column is not present in needed columns)&lt;/p&gt;</comment>
                            <comment id="17213716" author="abstractdog" created="Wed, 14 Oct 2020 08:04:26 +0000"  >&lt;p&gt;forgot about this one, but now it&apos;s merged to master, thanks for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mustafaiman&quot; class=&quot;user-hover&quot; rel=&quot;mustafaiman&quot;&gt;mustafaiman&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ashutoshc&quot; class=&quot;user-hover&quot; rel=&quot;ashutoshc&quot;&gt;ashutoshc&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13026829">HIVE-15397</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fxko:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>