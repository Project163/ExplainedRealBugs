<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:18:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-24151] MultiDelimitSerDe shifts data if strings contain non-ASCII characters</title>
                <link>https://issues.apache.org/jira/browse/HIVE-24151</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-22360&quot; title=&quot;MultiDelimitSerDe returns wrong results in last column when the loaded file has more columns than those in table schema&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-22360&quot;&gt;&lt;del&gt;HIVE-22360&lt;/del&gt;&lt;/a&gt; intended to fix another MultiDelimitSerde problem (with NULL last columns) but introduced a regression: the approach of the fix is pretty much all wrong, as the existing logic that operated on bytes got replaced by regex matcher logic which deals in character positions, rather than byte positions. As some non ASCII characters consist of more than 1 byte, the whole record may get shifted due to this.&lt;/p&gt;

&lt;p&gt;With this&#160;ticket I&apos;m going to restore the old logic, and apply the proper fix on that, but keeping (and extending) the test cases added with &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-22360&quot; title=&quot;MultiDelimitSerDe returns wrong results in last column when the loaded file has more columns than those in table schema&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-22360&quot;&gt;&lt;del&gt;HIVE-22360&lt;/del&gt;&lt;/a&gt; so that we have a solution for both issues.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13327097">HIVE-24151</key>
            <summary>MultiDelimitSerDe shifts data if strings contain non-ASCII characters</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="szita">&#193;d&#225;m Szita</assignee>
                                    <reporter username="szita">&#193;d&#225;m Szita</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 11 Sep 2020 14:07:44 +0000</created>
                <updated>Thu, 17 Nov 2022 08:48:38 +0000</updated>
                            <resolved>Thu, 17 Sep 2020 08:07:34 +0000</resolved>
                                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="17194290" author="szita" created="Fri, 11 Sep 2020 14:25:09 +0000"  >&lt;p&gt;Since this is a partial revert I&apos;m placing the diff of LazyStruct.java for: before &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-22360&quot; title=&quot;MultiDelimitSerDe returns wrong results in last column when the loaded file has more columns than those in table schema&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-22360&quot;&gt;&lt;del&gt;HIVE-22360&lt;/del&gt;&lt;/a&gt; vs my current commit:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
szita@szita-MBP16:~/shadow/CDH/hive$ git diff 463dae9ee8f694002af492e7d05924423aeaed09:serde/src/java/org/apache/hadoop/hive/serde2/lazy/LazyStruct.java 5de36f990d89fcd5c3d7d2344a28e16e4c1f8c24:serde/src/java/org/apache/hadoop/hive/serde2/lazy/LazyStruct.java
diff --git a/serde/src/java/org/apache/hadoop/hive/serde2/lazy/LazyStruct.java b/serde/src/java/org/apache/hadoop/hive/serde2/lazy/LazyStruct.java
index f066aaa3bf5..66b15374dda 100644
--- a/serde/src/java/org/apache/hadoop/hive/serde2/lazy/LazyStruct.java
+++ b/serde/src/java/org/apache/hadoop/hive/serde2/lazy/LazyStruct.java
@@ -22,6 +22,8 @@
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.List; &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.google.common.primitives.Bytes;
+
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hive.serde2.MultiDelimitSerDe;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hive.serde2.SerDeException;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.slf4j.Logger;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.slf4j.LoggerFactory;
@@ -294,10 +296,10 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void parseMultiDelimit(&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] rawRow, &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] fieldDelimit) {
     }
     &lt;span class=&quot;code-comment&quot;&gt;// the indexes of the delimiters
&lt;/span&gt;     &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[] delimitIndexes = findIndexes(rawRow, fieldDelimit);
-    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; diff = fieldDelimit.length - 1;
+    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; diff = fieldDelimit.length - MultiDelimitSerDe.REPLACEMENT_DELIM_LENGTH;
     &lt;span class=&quot;code-comment&quot;&gt;// first field always starts from 0, even when missing
&lt;/span&gt;     startPosition[0] = 0;
-    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 1; i &amp;lt; fields.length; i++) {
+    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 1; i &amp;lt;= fields.length; i++) {
       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (delimitIndexes[i - 1] != -1) {
         &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; start = delimitIndexes[i - 1] + fieldDelimit.length;
         startPosition[i] = start - i * diff;
@@ -305,7 +307,6 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void parseMultiDelimit(&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] rawRow, &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] fieldDelimit) {
         startPosition[i] = length + 1;
       }
     }
-    startPosition[fields.length] = length + 1;
     Arrays.fill(fieldInited, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
     parsed = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
   }
@@ -315,7 +316,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void parseMultiDelimit(&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] rawRow, &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] fieldDelimit) {
     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fields.length &amp;lt;= 1) {
       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[0];
     }
-    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[] indexes = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[fields.length - 1];
+    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[] indexes = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[fields.length];
     Arrays.fill(indexes, -1);
     indexes[0] = Bytes.indexOf(array, target);
     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (indexes[0] == -1) {
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17197480" author="szita" created="Thu, 17 Sep 2020 08:07:26 +0000"  >&lt;p&gt;Committed to master. Thanks for reviewing Peter!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13262783">HIVE-22360</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 8 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0iitk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>