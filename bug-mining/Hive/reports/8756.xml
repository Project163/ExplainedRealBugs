<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:26:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-28620] Query result is cached in case of IOWD if the subquery is not trivial</title>
                <link>https://issues.apache.org/jira/browse/HIVE-28620</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-25907&quot; title=&quot;IOW Directory queries fails to write data to final path when query result cache is enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-25907&quot;&gt;&lt;del&gt;HIVE-25907&lt;/del&gt;&lt;/a&gt; fixed a case when an insert overwrite directory didn&apos;t write the data to the final path when the query results cache was enabled. The solution was implemented by checking the QB.parseInfo at a certain point in the semantic analysis and writing/reading a flag to a QB instance. The problem is that depending on the query (which produces the data to be inserted) can be of different complexity, and &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-25907&quot; title=&quot;IOW Directory queries fails to write data to final path when query result cache is enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-25907&quot;&gt;&lt;del&gt;HIVE-25907&lt;/del&gt;&lt;/a&gt; only took care of queries like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INSERT OVERWRITE DIRECTORY &lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;destination directory&amp;gt;&quot;&lt;/span&gt; SELECT * FROM iowd;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;but for queries like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 EXPLAIN EXTENDED INSERT OVERWRITE DIRECTORY &lt;span class=&quot;code-quote&quot;&gt;&apos;/tmp&apos;&lt;/span&gt;  select a13.CATEGORY_ID CATEGORY_ID, max(a14.CATEGORY_DESC) CATEGORY_DESC,a12.SUBCAT_ID  SUBCAT_ID,max(a13.SUBCAT_LONG_DESC)  SUBCAT_DESC,avg((a11.QTY_SOLD * (a11.UNIT_PRICE - a11.DISCOUNT)))  WJXBFS1,sum((a11.QTY_SOLD * a11.UNIT_COST)) WJXBFS2 from ORDER_DETAIL a11 join LU_ITEM a12 on  (a11.ITEM_ID = a12.ITEM_ID) join LU_SUBCATEG a13 on  (a12.SUBCAT_ID = a13.SUBCAT_ID) join LU_CATEGORY a14 on  (a13.CATEGORY_ID = a14.CATEGORY_ID) group by a13.CATEGORY_ID, a12.SUBCAT_ID;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;it doesn&apos;t work. The root cause is that the flag is set in &lt;a href=&quot;https://github.com/apache/hive/blob/883d5dfe25929ba5dcac635e752adf5561d28402/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java#L1836&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;one QB instance&lt;/a&gt;, but during the plan generation, genPlan is recursively called, moreover, this.qb doesn&apos;t refer to the main/root QB all the time, as &lt;a href=&quot;https://github.com/apache/hive/blob/883d5dfe25929ba5dcac635e752adf5561d28402/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java#L12435&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;setQB&lt;/a&gt; is called at every step, so when iterating and reaching the file sink generation plan, the QB instance is used is not the same as the one on which the isInsertOverwriteDirectory flag was set.&lt;/p&gt;

&lt;p&gt;When this issue is present, an EXPLAIN EXTENDED can reveal the strange strategy of a query when result cache is enabled, here is a snippet:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
|         Reducer 5                                  |
...
|                   File Output Operator             |
|                     bucketingVersion: 2            |
|                     compressed: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;              |
|                     GlobalTableId: 0               |
|                     directory: file:/efs/tmp/hive/_resultscache_/results-c7e3efee-ce91-41f5-9ce3-f95ec4d23f66/0de7c837-2868-4441-90ac-40c35a2f1d8d/.hive-staging_hive_2024-11-09_16-27-23_402_2565121622084463581-8/-ext-10000 |
|                     NumFilesPerFileSink: 1         |
|                     Statistics: Num rows: 3892258870 Data size: 46678382057 Basic stats: COMPLETE Column stats: NONE |
|                     Stats Publishing Key Prefix: file:/efs/tmp/hive/_resultscache_/results-c7e3efee-ce91-41f5-9ce3-f95ec4d23f66/0de7c837-2868-4441-90ac-40c35a2f1d8d/.hive-staging_hive_2024-11-09_16-27-23_402_2565121622084463581-8/-ext-10000/ |
|                     table:                         |
|                         input format: org.apache.hadoop.mapred.TextInputFormat |
|                         output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat |
|                         properties:                |
|                           bucketing_version -1     |
|                           columns _col0,_col1,_col2,_col3,_col4,_col5 |
|                           columns.types &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;:string:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;:string:&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;:&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; |
|                           serialization.format 1   |
|                           serialization.lib org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe |
|                         serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe |
|                     TotalFiles: 1                  |
|                     GatherStats: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;             |
|                     MultiFileSpray: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;          |
|                                                    |
|   Stage: Stage-2                                   |
|     Dependency Collection                          |
|                                                    |
|   Stage: Stage-0                                   |
|     Move Operator                                  |
|       files:                                       |
|           hdfs directory: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;                     |
|           source: file:/efs/tmp/hive/_resultscache_/results-c7e3efee-ce91-41f5-9ce3-f95ec4d23f66/0de7c837-2868-4441-90ac-40c35a2f1d8d/.hive-staging_hive_2024-11-09_16-27-23_402_2565121622084463581-8/-ext-10000 |
|           destination: file:/efs/tmp/hive/_resultscache_/results-c7e3efee-ce91-41f5-9ce3-f95ec4d23f66/0de7c837-2868-4441-90ac-40c35a2f1d8d |
|                                                    |
+----------------------------------------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;as in compile-time the IOWD query was considered cacheable, the FileSinkOperator ended up writing to the query result cache, then the MoveTask moved to the final path, which is also in the query cache, instead of the expected folder &apos;/tmp&apos; in this example&lt;/p&gt;

&lt;p&gt;so not only does the output hit the wrong location, but all the IOWD data ends up placed and moved on the query result cache&apos;s filesystem (which is revealed as a serious performance regression on cloud storage when hitting some throughput limits).&lt;/p&gt;


&lt;p&gt;whatever the solution is, it needs to bypass the query result cache for IOWD, so the the original behavior is restored and files go to the right place &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
|   Stage: Stage-0                                   |
|     Move Operator                                  |
|       files:                                       |
|           hdfs directory: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;                     |
|           source: s3a:&lt;span class=&quot;code-comment&quot;&gt;//somebucket/user/hive/.hive-staging_hive_2024-11-09_16-28-27_281_5911898841946485672-9/-ext-10000 |
&lt;/span&gt;|           destination:  s3a:&lt;span class=&quot;code-comment&quot;&gt;//somebucket/tmp|
&lt;/span&gt;|                                                    |
+----------------------------------------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13598310">HIVE-28620</key>
            <summary>Query result is cached in case of IOWD if the subquery is not trivial</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="abstractdog">L&#225;szl&#243; Bodor</assignee>
                                    <reporter username="abstractdog">L&#225;szl&#243; Bodor</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 10 Nov 2024 10:19:51 +0000</created>
                <updated>Tue, 29 Jul 2025 14:52:06 +0000</updated>
                            <resolved>Wed, 13 Nov 2024 10:35:51 +0000</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17897881" author="abstractdog" created="Wed, 13 Nov 2024 10:35:48 +0000"  >&lt;p&gt;merged to master, thanks a lot for the reviews: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkuzmenko&quot; class=&quot;user-hover&quot; rel=&quot;dkuzmenko&quot;&gt;dkuzmenko&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkasa&quot; class=&quot;user-hover&quot; rel=&quot;kkasa&quot;&gt;kkasa&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13425138">HIVE-25907</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13219438">HIVE-21386</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1sh9s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>