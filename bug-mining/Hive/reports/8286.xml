<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:22:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-25879] MetaStoreDirectSql test query should not query the whole DBS table</title>
                <link>https://issues.apache.org/jira/browse/HIVE-25879</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;The runTestQuery() in the org/apache/hadoop/hive/metastore/MetaStoreDirectSql.java is using a test query&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select &lt;span class=&quot;code-quote&quot;&gt;&quot;DB_ID&quot;&lt;/span&gt; from &lt;span class=&quot;code-quote&quot;&gt;&quot;DBS&quot;&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to determine whether the direct SQL can be used.&lt;/p&gt;

&lt;p&gt;With larger deployments with many (10k+) Hive databases it would be more efficienct to query a small table instead, for example the &quot;VERSION&quot; table should always have a single row only.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13423512">HIVE-25879</key>
            <summary>MetaStoreDirectSql test query should not query the whole DBS table</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mszurap">Miklos Szurap</assignee>
                                    <reporter username="mszurap">Miklos Szurap</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 19 Jan 2022 13:32:51 +0000</created>
                <updated>Wed, 16 Nov 2022 13:50:25 +0000</updated>
                            <resolved>Tue, 14 Jun 2022 13:15:14 +0000</resolved>
                                                    <fixVersion>4.0.0-alpha-2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6000">1h 40m</timespent>
                                <comments>
                            <comment id="17480430" author="mszurap" created="Sat, 22 Jan 2022 13:48:58 +0000"  >&lt;p&gt;Tested the change on a cluster with 13k databases in DBS. Enabled DEBUG level logging for the MetastoreDirectSqlUtils class:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2022-01-19 19:06:07,205 DEBUG org.apache.hadoop.hive.metastore.MetastoreDirectSqlUtils: [main]: Direct SQL query in 14.483568ms + 0.035888ms, the query is [select &lt;span class=&quot;code-quote&quot;&gt;&quot;DB_ID&quot;&lt;/span&gt; from &lt;span class=&quot;code-quote&quot;&gt;&quot;DBS&quot;&lt;/span&gt;]
2022-01-19 19:06:07,297 DEBUG org.apache.hadoop.hive.metastore.MetaStoreDirectSql: [main]: Using direct SQL, underlying DB is MYSQL
...
2022-01-19 19:09:20,310 DEBUG org.apache.hadoop.hive.metastore.MetastoreDirectSqlUtils: [pool-9-thread-2]: Direct SQL query in 10.274248ms + 0.035611ms, the query is [select &lt;span class=&quot;code-quote&quot;&gt;&quot;DB_ID&quot;&lt;/span&gt; from &lt;span class=&quot;code-quote&quot;&gt;&quot;DBS&quot;&lt;/span&gt;]
...
2022-01-19 19:14:10,270 DEBUG org.apache.hadoop.hive.metastore.MetastoreDirectSqlUtils: [pool-9-thread-6]: Direct SQL query in 116.101829ms + 0.033451ms, the query is [select &lt;span class=&quot;code-quote&quot;&gt;&quot;DB_ID&quot;&lt;/span&gt; from &lt;span class=&quot;code-quote&quot;&gt;&quot;DBS&quot;&lt;/span&gt;]
...
2022-01-19 19:15:35,195 DEBUG org.apache.hadoop.hive.metastore.MetastoreDirectSqlUtils: [pool-9-thread-7]: Direct SQL query in 36.400028ms + 0.025065ms, the query is [select &lt;span class=&quot;code-quote&quot;&gt;&quot;DB_ID&quot;&lt;/span&gt; from &lt;span class=&quot;code-quote&quot;&gt;&quot;DBS&quot;&lt;/span&gt;] &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The average runtime/delay for the test query with the DBS table is 39 ms:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ cat hadoop-cmf-HIVE-1-HIVEMETASTORE-*.log.out* | grep &lt;span class=&quot;code-quote&quot;&gt;&quot;MetastoreDirectSqlUtils.*select \&quot;&lt;/span&gt;DB_ID\&lt;span class=&quot;code-quote&quot;&gt;&quot; from \&quot;&lt;/span&gt;DBS\&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot; | grep -oP &quot;&lt;/span&gt;SQL query in [0-9]+&lt;span class=&quot;code-quote&quot;&gt;&quot; | awk &lt;span class=&quot;code-quote&quot;&gt;&apos;{print $NF}&apos;&lt;/span&gt; | awk &lt;span class=&quot;code-quote&quot;&gt;&apos;{sum += $1 } {count+=1 } END { print &quot;&lt;/span&gt;Count: &lt;span class=&quot;code-quote&quot;&gt;&quot; count &quot;&lt;/span&gt;, AVG: &quot; sum/count }&apos;&lt;/span&gt;
Count: 497, AVG: 39.6258 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Using VERSION table for the test query:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2022-01-21 12:07:26,091 DEBUG org.apache.hadoop.hive.metastore.MetastoreDirectSqlUtils: [pool-9-thread-7]: Direct SQL query in 2.258936ms + 0.007412ms, the query is [select &lt;span class=&quot;code-quote&quot;&gt;&quot;VER_ID&quot;&lt;/span&gt; from &lt;span class=&quot;code-quote&quot;&gt;&quot;VERSION&quot;&lt;/span&gt;]
...
2022-01-21 12:07:34,688 DEBUG org.apache.hadoop.hive.metastore.MetastoreDirectSqlUtils: [pool-9-thread-8]: Direct SQL query in 3.48132ms + 0.013131ms, the query is [select &lt;span class=&quot;code-quote&quot;&gt;&quot;VER_ID&quot;&lt;/span&gt; from &lt;span class=&quot;code-quote&quot;&gt;&quot;VERSION&quot;&lt;/span&gt;]
...
2022-01-21 12:08:15,329 DEBUG org.apache.hadoop.hive.metastore.MetastoreDirectSqlUtils: [pool-9-thread-9]: Direct SQL query in 1.042055ms + 0.005383ms, the query is [select &lt;span class=&quot;code-quote&quot;&gt;&quot;VER_ID&quot;&lt;/span&gt; from &lt;span class=&quot;code-quote&quot;&gt;&quot;VERSION&quot;&lt;/span&gt;] &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The average runtime/delay for the test query with the VERSION table is 3ms:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ cat hadoop-cmf-HIVE-1-HIVEMETASTORE-*.log.out* | grep &lt;span class=&quot;code-quote&quot;&gt;&quot;MetastoreDirectSqlUtils.*select \&quot;&lt;/span&gt;VER_ID\&lt;span class=&quot;code-quote&quot;&gt;&quot; from \&quot;&lt;/span&gt;VERSION\&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot; | grep -oP &quot;&lt;/span&gt;SQL query in [0-9]+&lt;span class=&quot;code-quote&quot;&gt;&quot; | awk &lt;span class=&quot;code-quote&quot;&gt;&apos;{print $NF}&apos;&lt;/span&gt; | awk &lt;span class=&quot;code-quote&quot;&gt;&apos;{sum += $1 } {count+=1 } END { print &quot;&lt;/span&gt;Count: &lt;span class=&quot;code-quote&quot;&gt;&quot; count &quot;&lt;/span&gt;, AVG: &quot; sum/count }&apos;&lt;/span&gt;
Count: 127, AVG: 3.71654 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Submitted a PR for this.&lt;/p&gt;</comment>
                            <comment id="17550924" author="mszurap" created="Tue, 7 Jun 2022 10:44:03 +0000"  >&lt;p&gt;The first PR #2964 has been closed due to inactivity on my side. Submitted a new PR #3348. The original idea for this jira was to run a query &lt;tt&gt;select &quot;VER_ID&quot; from &quot;VERSION&quot;&lt;/tt&gt;, however the unit tests failed in local derby environments where that VERSION table does not exists. Instead the proposed solution now is to run the following as a test query:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select &lt;span class=&quot;code-quote&quot;&gt;&quot;DB_ID&quot;&lt;/span&gt; from &lt;span class=&quot;code-quote&quot;&gt;&quot;DBS&quot;&lt;/span&gt; WHERE &lt;span class=&quot;code-quote&quot;&gt;&quot;DB_ID&quot;&lt;/span&gt;=1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17554096" author="kgyrtkirk" created="Tue, 14 Jun 2022 13:15:14 +0000"  >&lt;p&gt;merged into master; Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mszurap&quot; class=&quot;user-hover&quot; rel=&quot;mszurap&quot;&gt;mszurap&lt;/a&gt; for fixing this!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 22 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0yqaw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>