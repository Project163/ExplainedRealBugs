<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:20:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-25257] Incorrect row order validation for query-based MAJOR compaction</title>
                <link>https://issues.apache.org/jira/browse/HIVE-25257</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;In the insert query of the query-based MAJOR compaction, there is this function call: &quot;validate_acid_sort_order(ROW_&lt;em&gt;ID.writeId, ROW&lt;/em&gt;&lt;em&gt;ID.bucketId, ROW&lt;/em&gt;_ID.rowId)&quot;.&lt;br/&gt;
This is to validate if the order of the rows is correct. This validation is done by the GenericUDFValidateAcidSortOrder class and it assumes that the rows are in increasing order by bucketProperty, originalTransactionId and rowId. &lt;/p&gt;

&lt;p&gt;But actually the rows should be ordered by originalTransactionId, bucketProperty and rowId, otherwise the delete deltas cannot be applied correctly. And this is the order what the MR MAJOR compaction writes and how the split groups are created for the query-based MAJOR compaction. It doesn&apos;t cause any issue until there is only one bucketProperty in the files, but as soon as there are multiple bucketProperties in the same file, the validation will fail. This can be reproduced by running multiple merge statements after each other.&lt;br/&gt;
For example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE TABLE transactions (id int,value string) STORED AS ORC TBLPROPERTIES (&apos;transactional&apos;=&apos;true&apos;);

INSERT INTO transactions VALUES
(1, &apos;value_1&apos;),
(2, &apos;value_2&apos;),
(3, &apos;value_3&apos;),
(4, &apos;value_4&apos;),
(5, &apos;value_5&apos;);

CREATE TABLE merge_source_1(ID int,value string) STORED AS ORC;
INSERT INTO merge_source_1 VALUES 
(1, &apos;newvalue_1&apos;),
(2, &apos;newvalue_2&apos;),
(3, &apos;newvalue_3&apos;),
(6, &apos;value_6&apos;),
(7, &apos;value_7&apos;);

MERGE INTO transactions AS T USING merge_source_1 AS S ON T.ID = S.ID 
WHEN MATCHED AND (T.value != S.value AND S.value IS NOT NULL) THEN UPDATE SET value = S.value 
WHEN NOT MATCHED THEN INSERT VALUES (S.ID, S.value);

CREATE TABLE merge_source_2(
 ID int,
 value string)
STORED AS ORC;

INSERT INTO merge_source_2 VALUES
(1, &apos;newestvalue_1&apos;),
(2, &apos;newestvalue_2&apos;),
(5, &apos;newestvalue_5&apos;),
(7, &apos;newestvalue_7&apos;),
(8, &apos;value_18);

MERGE INTO transactions AS T 
USING merge_source_2 AS S
ON T.ID = S.ID
WHEN MATCHED AND (T.value != S.value AND S.value IS NOT NULL) THEN UPDATE SET value = S.value
WHEN NOT MATCHED THEN INSERT VALUES (S.ID, S.value);

ALTER TABLE transactions COMPACT &apos;MAJOR&apos;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The MAJOR compaction will fail with the following error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: org.apache.hadoop.hive.ql.metadata.HiveException: Wrong sort order of Acid rows detected for the rows: org.apache.hadoop.hive.ql.udf.generic.GenericUDFValidateAcidSortOrder$WriteIdRowId@4d3ef25e and org.apache.hadoop.hive.ql.udf.generic.GenericUDFValidateAcidSortOrder$WriteIdRowId@1c9df436
	at org.apache.hadoop.hive.ql.udf.generic.GenericUDFValidateAcidSortOrder.evaluate(GenericUDFValidateAcidSortOrder.java:80)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So the validation doesn&apos;t check for the correct row order. The correct order is originalTransactionId, bucketProperty, rowId.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13384169">HIVE-25257</key>
            <summary>Incorrect row order validation for query-based MAJOR compaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kuczoram">Marta Kuczora</assignee>
                                    <reporter username="kuczoram">Marta Kuczora</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 16 Jun 2021 14:02:45 +0000</created>
                <updated>Thu, 17 Nov 2022 08:48:43 +0000</updated>
                            <resolved>Fri, 18 Jun 2021 21:29:20 +0000</resolved>
                                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                    <component>Transactions</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="17365753" author="kuczoram" created="Fri, 18 Jun 2021 21:29:41 +0000"  >&lt;p&gt;Pushed to master! Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lpinter&quot; class=&quot;user-hover&quot; rel=&quot;lpinter&quot;&gt;lpinter&lt;/a&gt; for the review!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 21 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0s0eg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>