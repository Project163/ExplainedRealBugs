<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:22:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-26233] Problems reading back PARQUET timestamps above 10000 years</title>
                <link>https://issues.apache.org/jira/browse/HIVE-26233</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Timestamp values above year 10000 are not supported, but during the migration from Hive2 to Hive3 some might appear because of TZ issues. We should be able to at least read these tables before rewriting the data.&lt;/p&gt;

&lt;p&gt;For this we need to change the Timestamp.PRINT_FORMATTER, so no &lt;tt&gt;+&lt;/tt&gt; sign is appended to the timestamp if the year exceeds 4 digits.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13445420">HIVE-26233</key>
            <summary>Problems reading back PARQUET timestamps above 10000 years</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pvary">Peter Vary</assignee>
                                    <reporter username="pvary">Peter Vary</reporter>
                        <labels>
                            <label>backwards-compatibility</label>
                            <label>pull-request-available</label>
                            <label>timestamp</label>
                    </labels>
                <created>Tue, 17 May 2022 12:42:53 +0000</created>
                <updated>Wed, 16 Nov 2022 13:50:23 +0000</updated>
                            <resolved>Thu, 26 May 2022 15:16:04 +0000</resolved>
                                                    <fixVersion>4.0.0-alpha-2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="8400">2h 20m</timespent>
                                <comments>
                            <comment id="17538669" author="zabetak" created="Wed, 18 May 2022 08:53:27 +0000"  >&lt;p&gt;If we got values greater than 10000 due to bugs I suppose the original value for the year was close to 9999 which is also kind of extreme.&lt;/p&gt;

&lt;p&gt;Why do we need to retain/support this kind of dates?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17538685" author="pvary" created="Wed, 18 May 2022 09:29:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zabetak&quot; class=&quot;user-hover&quot; rel=&quot;zabetak&quot;&gt;zabetak&lt;/a&gt;: The bug did not cause problems with Hive 2.x, and the data is written out for several tables there. After migration to 3.x the user is not able to read the old data anymore. With this fix, they can at least read the data and rewrite the tables. Without this the table is not readable.&lt;/p&gt;</comment>
                            <comment id="17538692" author="zabetak" created="Wed, 18 May 2022 09:43:32 +0000"  >&lt;p&gt;Thanks for the feedback. Just to understand better the problem.&lt;/p&gt;

&lt;p&gt;Are they getting an exception?&lt;/p&gt;

&lt;p&gt;Are they getting null values?&lt;/p&gt;

&lt;p&gt;Are they getting wrong timestamps?&lt;/p&gt;</comment>
                            <comment id="17538744" author="pvary" created="Wed, 18 May 2022 11:07:54 +0000"  >&lt;p&gt; They are getting an exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.text.ParseException: Unparseable date: &lt;span class=&quot;code-quote&quot;&gt;&quot;+10000-01-01 04:59:59.999999&quot;&lt;/span&gt;
	at java.text.DateFormat.parse(DateFormat.java:366) ~[?:1.8.0_232]
	at org.apache.hadoop.hive.common.type.TimestampTZUtil.convertTimestampToZone(TimestampTZUtil.java:180) 
	at org.apache.hadoop.hive.ql.io.parquet.timestamp.NanoTimeUtils.getTimestamp(NanoTimeUtils.java:122)
	at org.apache.hadoop.hive.ql.io.parquet.convert.ETypeConverter$9$2.convert(ETypeConverter.java:710)
	at org.apache.hadoop.hive.ql.io.parquet.convert.ETypeConverter$9$2.convert(ETypeConverter.java:692) 
	at org.apache.hadoop.hive.ql.io.parquet.convert.ETypeConverter$BinaryConverter.setDictionary(ETypeConverter.java:933)
	at org.apache.parquet.column.impl.ColumnReaderBase.&amp;lt;init&amp;gt;(ColumnReaderBase.java:385)
	at org.apache.parquet.column.impl.ColumnReaderImpl.&amp;lt;init&amp;gt;(ColumnReaderImpl.java:46)
	at org.apache.parquet.column.impl.ColumnReadStoreImpl.getColumnReader(ColumnReadStoreImpl.java:84)
	at org.apache.parquet.io.RecordReaderImplementation.&amp;lt;init&amp;gt;(RecordReaderImplementation.java:271)
	at org.apache.parquet.io.MessageColumnIO$1.visit(MessageColumnIO.java:147) 
	at org.apache.parquet.io.MessageColumnIO$1.visit(MessageColumnIO.java:109) 
	at org.apache.parquet.filter2.compat.FilterCompat$NoOpFilter.accept(FilterCompat.java:165) 
	at org.apache.parquet.io.MessageColumnIO.getRecordReader(MessageColumnIO.java:109) 
	at org.apache.parquet.hadoop.InternalParquetRecordReader.checkRead(InternalParquetRecordReader.java:137) 
	at org.apache.parquet.hadoop.InternalParquetRecordReader.nextKeyValue(InternalParquetRecordReader.java:222) 
	at org.apache.parquet.hadoop.ParquetRecordReader.nextKeyValue(ParquetRecordReader.java:207) 
	at org.apache.hadoop.hive.ql.io.parquet.read.ParquetRecordReaderWrapper.&amp;lt;init&amp;gt;(ParquetRecordReaderWrapper.java:98) 
	at org.apache.hadoop.hive.ql.io.parquet.read.ParquetRecordReaderWrapper.&amp;lt;init&amp;gt;(ParquetRecordReaderWrapper.java:60) 
	at org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat.getRecordReader(MapredParquetInputFormat.java:93) 
	at org.apache.hadoop.hive.ql.exec.FetchOperator$FetchInputFormatSplit.getRecordReader(FetchOperator.java:810) 
	at org.apache.hadoop.hive.ql.exec.FetchOperator.getRecordReader(FetchOperator.java:365) 
	at org.apache.hadoop.hive.ql.exec.FetchOperator.getNextRow(FetchOperator.java:576) 
	at org.apache.hadoop.hive.ql.exec.FetchOperator.pushRow(FetchOperator.java:545) 
	at org.apache.hadoop.hive.ql.exec.FetchTask.fetch(FetchTask.java:150) 
	at org.apache.hadoop.hive.ql.Driver.getResults(Driver.java:912) 
	at org.apache.hadoop.hive.ql.reexec.ReExecDriver.getResults(ReExecDriver.java:243) 
	at org.apache.hive.service.cli.operation.SQLOperation.getNextRowSet(SQLOperation.java:476)
	... 13 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17540680" author="zabetak" created="Sun, 22 May 2022 20:41:09 +0000"  >&lt;p&gt;I am quite skeptical on changing the date formatter. As you said timestamp values above 10000 are not supported and I am getting the impression that it is not possible to have this value stored in Parquet files. The only way where such values may appear is during an upgrade which I think it is the case here.&lt;/p&gt;

&lt;p&gt;I did a few tests over the weekend (see the top-3 commits on &lt;a href=&quot;https://github.com/zabetak/hive/tree/timestamp-compatibility-tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;timestamp-compatibility-branch&lt;/a&gt;) where I stored 10K random dates in Hive 1.2.2, Hive 2.3.9, and Hive 3.1.3 and then I tried to read them back with current master, which was not possible. The results for 1.2.2 and 2.3.9 are quite discouraging since all dates are shifted and slightly better for 3.1.3 where there are fewer dates which are affected.&lt;/p&gt;

&lt;p&gt;I tried to find the cause for these changes starting from 3.1.3 and it turns out that the problem comes from the use of proleptic calendar (&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-22589&quot; title=&quot;Add storage support for ProlepticCalendar in ORC, Parquet, and Avro&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-22589&quot;&gt;&lt;del&gt;HIVE-22589&lt;/del&gt;&lt;/a&gt;). For this particular JIRA where the date goes above 10000 the cause is also the use of the proleptic calendar and more precisely the lines 44 to 47 in &lt;a href=&quot;https://github.com/apache/hive/blob/6bfb6f6a3676ac692d92a08b88f439794f20b488/ql/src/java/org/apache/hadoop/hive/ql/io/parquet/timestamp/NanoTimeUtils.java#L44&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;NanoTimeUtils.java&lt;/a&gt;. I did a quick test and the test case you included in the PR passes successfully by reverting these changes in NanoTimeUtils. Moreover, the test with 10K dates from version 3.1.3 also passes successfully by reverting the aforementioned lines.&lt;/p&gt;

&lt;p&gt;If I recall well &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-22589&quot; title=&quot;Add storage support for ProlepticCalendar in ORC, Parquet, and Avro&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-22589&quot;&gt;&lt;del&gt;HIVE-22589&lt;/del&gt;&lt;/a&gt; added some properties to retain backward compatibility so maybe the correct course of action is to check if we can fix the problem here by changing parts of the code to take those properties into account.&lt;/p&gt;</comment>
                            <comment id="17541313" author="pvary" created="Tue, 24 May 2022 07:32:21 +0000"  >&lt;p&gt;I checked the specific TS (9999-12-31-23:59:59.999) generated with Hive2.&lt;br/&gt;
The TS is converted to UTC and the resulting NanoTime has been written to Parquet. Since the local TZ was EST, the actual date written to Parquet is 10000-01-01-04:59:59.999.&lt;/p&gt;

&lt;p&gt;Since the TS was written with old Parquet/Hive, we correctly want to use the legacy timestamp conversion:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (legacyConversion) {
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        DateFormat formatter = getLegacyDateFormatter();
        formatter.setTimeZone(TimeZone.getTimeZone(fromZone));
        java.util.Date date = formatter.parse(ts.toSting());
        &lt;span class=&quot;code-comment&quot;&gt;// Set the formatter to use a different timezone
&lt;/span&gt;        formatter.setTimeZone(TimeZone.getTimeZone(toZone));
        Timestamp result = Timestamp.valueOf(formatter.format(date));
        result.setNanos(ts.getNanos());
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; result;
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (ParseException e) {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(e);
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This fails because to the &lt;tt&gt;toString()&lt;/tt&gt; prints &lt;tt&gt;&amp;#43;10000-01-01 04:59:59.999&lt;/tt&gt; - notice the &lt;tt&gt;&amp;#43;&lt;/tt&gt; sing at the beginning of the String. Then we try to parse it and we fail. So we have to either print it without the &lt;tt&gt;&amp;#43;&lt;/tt&gt; or parse it correctly. After my proposed changes we write it out without a &lt;tt&gt;&amp;#43;&lt;/tt&gt; sing, and we can read it back correctly. This way - after applying the conversion - we are able get back the original (9999-12-31-23:59:59.999) TS.&lt;/p&gt;</comment>
                            <comment id="17541951" author="zabetak" created="Wed, 25 May 2022 10:21:51 +0000"  >&lt;p&gt;I was wrong to believe that the problem here is a result of the proleptic calendar changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-22589&quot; title=&quot;Add storage support for ProlepticCalendar in ORC, Parquet, and Avro&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-22589&quot;&gt;&lt;del&gt;HIVE-22589&lt;/del&gt;&lt;/a&gt;. The test in the PR consistently fails with or without &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-22589&quot; title=&quot;Add storage support for ProlepticCalendar in ORC, Parquet, and Avro&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-22589&quot;&gt;&lt;del&gt;HIVE-22589&lt;/del&gt;&lt;/a&gt; so my previous observation was wrong. (I suspect my workspace was stale while I was doing the tests which led me to the wrong conclusions). &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I did a quick test and the test case you included in the PR passes successfully by reverting these changes in NanoTimeUtils&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There may other problems with the proleptic calendar changes but it&apos;s definitely not related with the problem described here so I will remove the direct link to &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-22589&quot; title=&quot;Add storage support for ProlepticCalendar in ORC, Parquet, and Avro&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-22589&quot;&gt;&lt;del&gt;HIVE-22589&lt;/del&gt;&lt;/a&gt; to avoid further confusion.&lt;/p&gt;

&lt;p&gt;Apart from that I did some additional experiments writing timestamps in Hive 2 and I confirm that what Peter is saying is true. Writing timestamps in any UTC - X timezone can result in a date greater than 10000 to be stored in the Parquet file and the latter cannot be handled by the current code. &lt;/p&gt;</comment>
                            <comment id="17541968" author="zabetak" created="Wed, 25 May 2022 10:47:14 +0000"  >&lt;p&gt;It&apos;s clear that people who need &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-24074&quot; title=&quot;Incorrect handling of timestamp in Parquet/Avro when written in certain time zones in versions before Hive 3.x&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-24074&quot;&gt;&lt;del&gt;HIVE-24074&lt;/del&gt;&lt;/a&gt; should also include this fix if they want to avoid this problem.&lt;/p&gt;</comment>
                            <comment id="17541969" author="zabetak" created="Wed, 25 May 2022 10:49:22 +0000"  >&lt;p&gt;Based on the git history I suspect the problem here starts appearing after &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-20007&quot; title=&quot;Hive should carry out timestamp computations in UTC&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-20007&quot;&gt;&lt;del&gt;HIVE-20007&lt;/del&gt;&lt;/a&gt; although I haven&apos;t tried to repeat the test on that commit.&lt;/p&gt;</comment>
                            <comment id="17542086" author="zabetak" created="Wed, 25 May 2022 15:00:41 +0000"  >&lt;p&gt;For the record, I think this problem affects AVRO format as well. Thankfully the fix in &lt;a href=&quot;https://github.com/apache/hive/pull/3295&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/pull/3295&lt;/a&gt; seems sufficient to cover all cases.&lt;/p&gt;</comment>
                            <comment id="17542532" author="pvary" created="Thu, 26 May 2022 15:16:04 +0000"  >&lt;p&gt;Pushed to master.&lt;br/&gt;
Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zabetak&quot; class=&quot;user-hover&quot; rel=&quot;zabetak&quot;&gt;zabetak&lt;/a&gt; for the review!&lt;/p&gt;</comment>
                            <comment id="17622067" author="zabetak" created="Fri, 21 Oct 2022 07:45:38 +0000"  >&lt;p&gt;The ticket is marked as resolved for 4.0.0 but we are currently underway of releasing 4.0.0-alpha-2 so I changed the fixVersion accordingly; If that is not accurate please update the fixVersion accordingly.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13168544">HIVE-20007</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="13324590">HIVE-24074</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 3 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z12fx4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>