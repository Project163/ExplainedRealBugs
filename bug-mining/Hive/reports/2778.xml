<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:26:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-8474] Vectorized reads of transactional tables fail when not all columns are selected</title>
                <link>https://issues.apache.org/jira/browse/HIVE-8474</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;create table concur_orc_tab(name varchar(50), age &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, gpa decimal(3, 2)) clustered by (age) into 2 buckets stored as orc TBLPROPERTIES (&lt;span class=&quot;code-quote&quot;&gt;&apos;transactional&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;&lt;/span&gt;);
select name, age from concur_orc_tab order by name;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;results in&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Diagnostic Messages &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; Task:
Error: java.io.IOException: java.lang.NullPointerException
        at org.apache.hadoop.hive.io.HiveIOExceptionHandlerChain.handleRecordReaderNextException(HiveIOExceptionHandlerChain.java:121)
        at org.apache.hadoop.hive.io.HiveIOExceptionHandlerUtil.handleRecordReaderNextException(HiveIOExceptionHandlerUtil.java:77)
        at org.apache.hadoop.hive.ql.io.HiveContextAwareRecordReader.doNext(HiveContextAwareRecordReader.java:352)
        at org.apache.hadoop.hive.ql.io.HiveRecordReader.doNext(HiveRecordReader.java:79)
        at org.apache.hadoop.hive.ql.io.HiveRecordReader.doNext(HiveRecordReader.java:33)
        at org.apache.hadoop.hive.ql.io.HiveContextAwareRecordReader.next(HiveContextAwareRecordReader.java:115)
        at org.apache.hadoop.mapred.MapTask$TrackedRecordReader.moveToNext(MapTask.java:199)
        at org.apache.hadoop.mapred.MapTask$TrackedRecordReader.next(MapTask.java:185)
        at org.apache.hadoop.mapred.MapRunner.run(MapRunner.java:52)
        at org.apache.hadoop.mapred.MapTask.runOldMapper(MapTask.java:450)
        at org.apache.hadoop.mapred.MapTask.run(MapTask.java:343)
        at org.apache.hadoop.mapred.YarnChild$2.run(YarnChild.java:163)
        at java.security.AccessController.doPrivileged(Native Method)
        at javax.security.auth.Subject.doAs(Subject.java:415)
        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1614)
        at org.apache.hadoop.mapred.YarnChild.main(YarnChild.java:158)
Caused by: java.lang.NullPointerException
        at org.apache.hadoop.hive.ql.exec.vector.VectorizedBatchUtil.setNullColIsNullValue(VectorizedBatchUtil.java:63)
        at org.apache.hadoop.hive.ql.exec.vector.VectorizedBatchUtil.addRowToBatchFrom(VectorizedBatchUtil.java:443)
        at org.apache.hadoop.hive.ql.exec.vector.VectorizedBatchUtil.addRowToBatch(VectorizedBatchUtil.java:214)
        at org.apache.hadoop.hive.ql.io.orc.VectorizedOrcAcidRowReader.next(VectorizedOrcAcidRowReader.java:95)
        at org.apache.hadoop.hive.ql.io.orc.VectorizedOrcAcidRowReader.next(VectorizedOrcAcidRowReader.java:43)
        at org.apache.hadoop.hive.ql.io.HiveContextAwareRecordReader.doNext(HiveContextAwareRecordReader.java:347)
        ... 13 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The issue is that the object inspector passed to VectorizedOrcAcidRowReader has all of the columns in the file rather than only the projected columns.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12748406">HIVE-8474</key>
            <summary>Vectorized reads of transactional tables fail when not all columns are selected</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gates">Alan Gates</assignee>
                                    <reporter username="gates">Alan Gates</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Oct 2014 20:35:41 +0000</created>
                <updated>Tue, 1 Oct 2019 22:07:38 +0000</updated>
                            <resolved>Wed, 22 Oct 2014 17:21:16 +0000</resolved>
                                    <version>0.14.0</version>
                                    <fixVersion>0.14.0</fixVersion>
                                    <component>Transactions</component>
                    <component>Vectorization</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14175664" author="alangates" created="Fri, 17 Oct 2014 22:46:49 +0000"  >&lt;p&gt;Further testing has also determined that attempts to select a partition column in vectorization results in a NPE as well.&lt;/p&gt;</comment>
                            <comment id="14175672" author="alangates" created="Fri, 17 Oct 2014 22:59:01 +0000"  >&lt;p&gt;This patch makes several changes in vectorization.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mmccline&quot; class=&quot;user-hover&quot; rel=&quot;mmccline&quot;&gt;mmccline&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ashutoshc&quot; class=&quot;user-hover&quot; rel=&quot;ashutoshc&quot;&gt;ashutoshc&lt;/a&gt;, as I am not very familiar with this code and as I know the code is very performance sensitive I would appreciate your feedback on the patch.&lt;/p&gt;

&lt;p&gt;The issue causing problems was that VectorizedBatchUtil.addRowToBatchFrom is used by VectorizedOrcAcidRowReader to take the merged rows from and acid read and put them in a vector batch.  But this method appears to have been built to be used by vector operators, not file formats where columns may be missing because they have been projected out or may already have values set as they are partition columns.  So I made the following changes:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;I changed addRowToBatchFrom to skip writing values into ColumnVectors that are null.  This handles the case where columns have been projected out and thus the ColumnVector is null.&lt;/li&gt;
	&lt;li&gt;I changed VectorizedRowBatch to have a boolean array to track which columns are partition columns and VectorizedRowBatchCtx.createVectorizedRowBatch to populate this array&lt;/li&gt;
	&lt;li&gt;I changed addRowToBatchFrom to skip writing values into ColumnVectors that are marked in VectorizedRowBatch as partition columns, since this results in overwriting the values that have already been put there by VectorizedRowBatchCtx.addPartitionColumnsToBatch&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;My concern is whether it is appropriate to mix in this functionality to skip projected out and partition columns into addRowToBatchFrom.  If you think it isn&apos;t good, I can write a new method to do this.  But that will involve a fair amount of duplicate code.  &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=owen.omalley&quot; class=&quot;user-hover&quot; rel=&quot;owen.omalley&quot;&gt;owen.omalley&lt;/a&gt;, I also changed VectorizedOrcAcidRowReader to set the partition column values after every call to VectorizedRowBatch.reset in next.  Without doing this the code was NPEing later in the pipeline because the partition column had been set to null.  It appeared that you had copied the code from VectorizedOrcInputFormat, which only called addPartitionColsToBatch once, but which never called reset.  I tried removing the call to reset but that caused other issues.&lt;/p&gt;</comment>
                            <comment id="14175914" author="hiveqa" created="Sat, 18 Oct 2014 08:17:22 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12675606/HIVE-8474.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12675606/HIVE-8474.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 1 failed/errored test(s), 6567 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_index_in_db
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1332/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1332/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1332/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1332/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-1332/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-1332/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 1 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12675606&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;PreCommit-HIVE-TRUNK-Build&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14176496" author="mmccline" created="Mon, 20 Oct 2014 00:28:03 +0000"  >
&lt;p&gt;Some background on vectorization.&lt;/p&gt;

&lt;p&gt;There are are &quot;shadow&quot; VectorizationContext data structures that track which columns of vectorized row batches for used by each vectorized operators.&lt;/p&gt;

&lt;p&gt;In row-by-row mode an operator can easily form a new row Object Array to correspond to the outputObjInspector.&lt;/p&gt;

&lt;p&gt;However, in Vectorization we mask or project away columns in a VectorizedRowBatch (e.g. VectorFilterOperator) so the same batch can travel down the operators without being copied.  Or, in the case of computing new columns, VectorSelectOperator will compute new scratch columns.&lt;/p&gt;

&lt;p&gt;So, the VectorizationContext starts as all the table columns for Map or the keys and values for Reduce and then as we go down the operators new VectorizationContext objects are cloned and their column and scratch column maps are modified.&lt;/p&gt;

&lt;p&gt;So, some operators do not use inputObjInspectors or outputObjInspector.  Others, do use them when the vector operator unpacks batches into rows to call an row mode operator.&lt;/p&gt;</comment>
                            <comment id="14176500" author="mmccline" created="Mon, 20 Oct 2014 00:36:33 +0000"  >
&lt;p&gt;I would prefer a clone of addToBatchFrom be cloned and chaged.  I know this duplicates code &amp;#8211; but it provides a cleaner place to have comments on the difference and not have extra code execute that doesn&apos;t provide value to the main path..&lt;/p&gt;

&lt;p&gt;After 0.14.0 we should look at getting the vector reader(s) and Vectorizer class to create the Map top level VectorizationContext with just the columns that are needed.&lt;/p&gt;

&lt;p&gt;Adding &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jnp&quot; class=&quot;user-hover&quot; rel=&quot;jnp&quot;&gt;jnp&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14177104" author="alangates" created="Mon, 20 Oct 2014 16:57:17 +0000"  >&lt;p&gt;Ok, I&apos;ll rework it not to use addToBatchFrom.  I do plan on factoring out the switch statement so that can be shared, but hopefully that will be alright.&lt;/p&gt;

&lt;p&gt;Are you ok with the changes to VectorizedRowBatch to add tracking the partition columns?&lt;/p&gt;</comment>
                            <comment id="14177186" author="mmccline" created="Mon, 20 Oct 2014 17:51:49 +0000"  >&lt;p&gt;Oh, I see, the partition columns are tracked in the auxiliary object VectoeizedRowBatchCtx that knows which are the partition columns.   You should be looking closely at it.&lt;/p&gt;</comment>
                            <comment id="14177198" author="alangates" created="Mon, 20 Oct 2014 17:58:44 +0000"  >&lt;p&gt;Are you saying that rather than changing VectorizedRowBatch I should just pass along the Ctx to my new acidAddToBatchFrom method and use that to figure out the partition columns?&lt;/p&gt;</comment>
                            <comment id="14177924" author="alangates" created="Tue, 21 Oct 2014 04:25:24 +0000"  >&lt;p&gt;A second version of the patch that incorporates Matt&apos;s feedback.  &lt;/p&gt;</comment>
                            <comment id="14178196" author="hiveqa" created="Tue, 21 Oct 2014 09:41:38 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12676025/HIVE-8474.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12676025/HIVE-8474.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 1 failed/errored test(s), 6568 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hive.minikdc.TestJdbcWithMiniKdc.testNegativeTokenAuth
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1370/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1370/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1370/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1370/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-1370/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-1370/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 1 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12676025 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14178390" author="mmccline" created="Tue, 21 Oct 2014 13:33:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gates&quot; class=&quot;user-hover&quot; rel=&quot;gates&quot;&gt;gates&lt;/a&gt; it looks great!  Thanks for refactoring the changes.&lt;/p&gt;

&lt;p&gt;(non-binding) +1&lt;/p&gt;
</comment>
                            <comment id="14178780" author="ashutoshc" created="Tue, 21 Oct 2014 18:19:31 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14180201" author="alangates" created="Wed, 22 Oct 2014 17:21:16 +0000"  >&lt;p&gt;Committed to trunk and branch 0.14.  Thanks Ashutosh and Matt for the reviews.&lt;/p&gt;</comment>
                            <comment id="14210825" author="thejas" created="Thu, 13 Nov 2014 19:42:47 +0000"  >&lt;p&gt;This has been fixed in 0.14 release. Please open new jira if you see any issues.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12676025" name="HIVE-8474.2.patch" size="32692" author="gates" created="Tue, 21 Oct 2014 04:25:24 +0000"/>
                            <attachment id="12675606" name="HIVE-8474.patch" size="14478" author="gates" created="Fri, 17 Oct 2014 22:59:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i217t3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>