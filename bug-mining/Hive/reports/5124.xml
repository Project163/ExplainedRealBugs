<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:49:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-15474] Extend limit propagation for chain of RS-GB-RS operators</title>
                <link>https://issues.apache.org/jira/browse/HIVE-15474</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;The goal is to extend the work started in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-14002&quot; title=&quot;Extend limit propagation to subsequent RS operators&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-14002&quot;&gt;&lt;del&gt;HIVE-14002&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;For instance, given the following query:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;explain&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;count&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; + 1) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; agg1 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; src 
&lt;span class=&quot;code-keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;, agg1 &lt;span class=&quot;code-keyword&quot;&gt;limit&lt;/span&gt; 20;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We generate the following physical plan:&lt;br/&gt;
&lt;tt&gt;TS1 - GBY2 - RS3 - GBY4 - RS5 - SEL6 - LIM7 - FS8&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;We can push the limit to RS3 operator, as we will generate records for the &lt;em&gt;top N&lt;/em&gt; keys, and thus, GBY4 will produce the &lt;em&gt;top N&lt;/em&gt; results. However, currently we do not do it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13029423">HIVE-15474</key>
            <summary>Extend limit propagation for chain of RS-GB-RS operators</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jcamacho">Jes&#250;s Camacho Rodr&#237;guez</assignee>
                                    <reporter username="jcamacho">Jes&#250;s Camacho Rodr&#237;guez</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Dec 2016 11:57:58 +0000</created>
                <updated>Tue, 27 Feb 2024 22:24:01 +0000</updated>
                            <resolved>Fri, 6 Jan 2017 09:31:44 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.2.0</fixVersion>
                                    <component>Physical Optimizer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15764250" author="hiveqa" created="Tue, 20 Dec 2016 13:49:27 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12844057/HIVE-15474.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12844057/HIVE-15474.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 11 failed/errored test(s), 10822 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=234)
TestVectorizedColumnReaderBase - did not produce a TEST-*.xml file (likely timed out) (batchId=251)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=39)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[udf_sort_array] (batchId=59)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=135)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=151)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=93)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/2653/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/2653/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/2653/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/2653/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-2653/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-2653/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 11 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12844057 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15764272" author="jcamacho" created="Tue, 20 Dec 2016 13:56:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ashutoshc&quot; class=&quot;user-hover&quot; rel=&quot;ashutoshc&quot;&gt;ashutoshc&lt;/a&gt;, could you take a look? Thanks&lt;/p&gt;</comment>
                            <comment id="15764826" author="xuefuz" created="Tue, 20 Dec 2016 18:02:26 +0000"  >&lt;p&gt;Didn&apos;t read the patch, but I&apos;m trying to understand if it&apos;s valid to push limit to group by. People frequently use order by and limit get rank functionality.&lt;/p&gt;</comment>
                            <comment id="15764900" author="jcamacho" created="Tue, 20 Dec 2016 18:35:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt;, thanks for leaving the comment, it would be great if you could take a look at the patch too.&lt;/p&gt;

&lt;p&gt;Propagating limit &lt;em&gt;N&lt;/em&gt; to GBy is valid iff GBy columns are a prefix of the OBy columns. This is due to the fact that GBy will not produce duplicates for those columns, while Hive implementation based on RS ensures that GBy output actually follows a certain order. Thus, we know that the GBy will output the top &lt;em&gt;N&lt;/em&gt; records.&lt;/p&gt;

&lt;p&gt;I took a conservative approach as we need to be sure that we remain correct; it might be that the condition could be relaxed even further for some corner cases. However, we should not do it without double checking the theoretical background.&lt;/p&gt;</comment>
                            <comment id="15765068" author="xuefuz" created="Tue, 20 Dec 2016 19:43:18 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jcamachorodriguez&quot; class=&quot;user-hover&quot; rel=&quot;jcamachorodriguez&quot;&gt;jcamachorodriguez&lt;/a&gt;, thanks for the explanation. &lt;/p&gt;

&lt;p&gt;Re: GBy will not produce duplicates for those columns, while Hive implementation based on RS ensures that GBy output actually follows a certain order.&lt;/p&gt;

&lt;p&gt;This assumption isn&apos;t always true, actually. While MR-styled shuffle has that property (maybe Tez too), but it&apos;s not true for Hive on Spark where groups are not necessarily ordered.&lt;/p&gt;

&lt;p&gt;Nevertheless, I&apos;m still not 100% if there is any impact. In fact, looking at test cases in the patch, I&apos;m sure of the plan difference. Thus, it would be very helpful if you can provide explain output for the example query for both w and w/o the optimization.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="15765176" author="jcamacho" created="Tue, 20 Dec 2016 20:32:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt;, thanks for the feedback. It is indeed true for MR and Tez. I am not so familiar with Spark as the backend. If it does not return ordered groups, are you sure the sequence of operators is still RS-GB-RS? That would mean that other optimizations, such as ReduceSinkDeDuplication, do not work properly (&amp;#63;). In turn, I would argue that RS is a physical operator that has certain semantics that should be respected, no matter the backend. However, if the sequence of operators is still that one, I can just disable the optimization for Hive on Spark.&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;/p&gt;

&lt;p&gt;Given this query:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;explain&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;count&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; + 1) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; agg1 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; src 
&lt;span class=&quot;code-keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;, agg1 &lt;span class=&quot;code-keyword&quot;&gt;limit&lt;/span&gt; 20;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Explain plan without patch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;STAGE DEPENDENCIES:
  Stage-1 is a root stage
  Stage-2 depends on stages: Stage-1
  Stage-0 depends on stages: Stage-2

STAGE PLANS:
  Stage: Stage-1
    Map Reduce
      Map Operator Tree:
          TableScan
            alias: src
            Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
            Select Operator
              expressions: key (type: string), value (type: string), (UDFToDouble(key) + 1.0) (type: &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;)
              outputColumnNames: _col0, _col1, _col2
              Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
              Group By Operator
                aggregations: count(_col2)
                keys: _col0 (type: string), _col1 (type: string)
                mode: hash
                outputColumnNames: _col0, _col1, _col2
                Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
                Reduce Output Operator
                  key expressions: _col0 (type: string), _col1 (type: string)
                  sort order: ++
                  Map-reduce partition columns: _col0 (type: string), _col1 (type: string)
                  Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
                  value expressions: _col2 (type: bigint)
      Reduce Operator Tree:
        Group By Operator
          aggregations: count(VALUE._col0)
          keys: KEY._col0 (type: string), KEY._col1 (type: string)
          mode: mergepartial
          outputColumnNames: _col0, _col1, _col2
          Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
          File Output Operator
            compressed: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
            table:
                input format: org.apache.hadoop.mapred.SequenceFileInputFormat
                output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
                serde: org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe

  Stage: Stage-2
    Map Reduce
      Map Operator Tree:
          TableScan
            Reduce Output Operator
              key expressions: _col0 (type: string), _col1 (type: string), _col2 (type: bigint)
              sort order: +++
              Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
              TopN Hash Memory Usage: 0.3
      Reduce Operator Tree:
        Select Operator
          expressions: KEY.reducesinkkey0 (type: string), KEY.reducesinkkey1 (type: string), KEY.reducesinkkey2 (type: bigint)
          outputColumnNames: _col0, _col1, _col2
          Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
          Limit
            &lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt; of rows: 20
            Statistics: Num rows: 20 Data size: 200 Basic stats: COMPLETE Column stats: NONE
            File Output Operator
              compressed: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
              Statistics: Num rows: 20 Data size: 200 Basic stats: COMPLETE Column stats: NONE
              table:
                  input format: org.apache.hadoop.mapred.SequenceFileInputFormat
                  output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
                  serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe

  Stage: Stage-0
    Fetch Operator
      limit: 20
      Processor Tree:
        ListSink
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Explain plan with patch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;STAGE DEPENDENCIES:
  Stage-1 is a root stage
  Stage-2 depends on stages: Stage-1
  Stage-0 depends on stages: Stage-2

STAGE PLANS:
  Stage: Stage-1
    Map Reduce
      Map Operator Tree:
          TableScan
            alias: src
            Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
            Select Operator
              expressions: key (type: string), value (type: string), (UDFToDouble(key) + 1.0) (type: &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;)
              outputColumnNames: _col0, _col1, _col2
              Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
              Group By Operator
                aggregations: count(_col2)
                keys: _col0 (type: string), _col1 (type: string)
                mode: hash
                outputColumnNames: _col0, _col1, _col2
                Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
                Reduce Output Operator
                  key expressions: _col0 (type: string), _col1 (type: string)
                  sort order: ++
                  Map-reduce partition columns: _col0 (type: string), _col1 (type: string)
                  Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
                  TopN Hash Memory Usage: 0.3
                  value expressions: _col2 (type: bigint)
      Reduce Operator Tree:
        Group By Operator
          aggregations: count(VALUE._col0)
          keys: KEY._col0 (type: string), KEY._col1 (type: string)
          mode: mergepartial
          outputColumnNames: _col0, _col1, _col2
          Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
          File Output Operator
            compressed: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
            table:
                input format: org.apache.hadoop.mapred.SequenceFileInputFormat
                output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
                serde: org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe

  Stage: Stage-2
    Map Reduce
      Map Operator Tree:
          TableScan
            Reduce Output Operator
              key expressions: _col0 (type: string), _col1 (type: string), _col2 (type: bigint)
              sort order: +++
              Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
              TopN Hash Memory Usage: 0.3
      Reduce Operator Tree:
        Select Operator
          expressions: KEY.reducesinkkey0 (type: string), KEY.reducesinkkey1 (type: string), KEY.reducesinkkey2 (type: bigint)
          outputColumnNames: _col0, _col1, _col2
          Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
          Limit
            &lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt; of rows: 20
            Statistics: Num rows: 20 Data size: 200 Basic stats: COMPLETE Column stats: NONE
            File Output Operator
              compressed: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
              Statistics: Num rows: 20 Data size: 200 Basic stats: COMPLETE Column stats: NONE
              table:
                  input format: org.apache.hadoop.mapred.SequenceFileInputFormat
                  output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
                  serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe

  Stage: Stage-0
    Fetch Operator
      limit: 20
      Processor Tree:
        ListSink
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Observe the only difference is the TopN annotation in the first stage, which prevents shuffling all the data.&lt;/p&gt;</comment>
                            <comment id="15765925" author="xuefuz" created="Wed, 21 Dec 2016 02:47:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirui&quot; class=&quot;user-hover&quot; rel=&quot;lirui&quot;&gt;lirui&lt;/a&gt;, could you also take a look at the proposal and comment here?&lt;/p&gt;</comment>
                            <comment id="15766929" author="lirui" created="Wed, 21 Dec 2016 12:24:50 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jcamachorodriguez&quot; class=&quot;user-hover&quot; rel=&quot;jcamachorodriguez&quot;&gt;jcamachorodriguez&lt;/a&gt;, I think it&apos;s an interesting optimization and please help me understand it better. For groupBy + orderBy query, we&apos;ll roughly have the following operator chain (assuming map side aggregation is on - GBY1 and RS2):&lt;br/&gt;
&lt;tt&gt;GBY1 &amp;#8211; RS2 &amp;#8211; GBY3 &amp;#8211; FS4 &amp;#8211; TS5 &amp;#8211; RS6 &amp;#8211; SEL7 &amp;#8211; FS8&lt;/tt&gt;&lt;br/&gt;
Is the proposal to push the limit into GBY3, so that we&apos;ll have less data for the sorting stage? If so, I think that requires the output of GBY3 already being sorted, right? For MR (and probably Tez too) the shuffled data is sorted by key within each partition, which means the input to GBY3 is sorted. So you&apos;re implying that given a sorted input, GBY operator will maintain that order in output?&lt;br/&gt;
If my understanding is correct so far, this will have some problem with Hive on Spark. Because for Spark, the groupBy shuffling doesn&apos;t guarantee an order - the input to GBY3 may not be sorted. This makes sense in that groupBy semantic doesn&apos;t require a specific ordering. But maybe we can make some change to adapt to this optimization. Actually I&apos;m also wondering: if we use parallel order by (to use a range partitioner rather than a hash partitioner in RS2), we can do the groupBy and orderBy in a single stage, which may improve performance in some cases.&lt;/p&gt;</comment>
                            <comment id="15782893" author="jcamacho" created="Wed, 28 Dec 2016 13:36:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirui&quot; class=&quot;user-hover&quot; rel=&quot;lirui&quot;&gt;lirui&lt;/a&gt;, sorry for taking some time replying, I was away for a few days.&lt;/p&gt;

&lt;p&gt;I have updated the description of this issue to try to explain better what I am trying to do. I think initial description was too brief and vague.&lt;/p&gt;

&lt;p&gt;Given the physical plan you provide, we will propagate the limit from RS4 into RS2 (observe the explain plan above). RS2 produces the &lt;em&gt;top N&lt;/em&gt; keys for each partition; thus, GBY3 operator produces only results for those keys. Observe in the patch that there is no change for the GBY operator.&lt;/p&gt;

&lt;p&gt;Concerning Spark. My current understanding is that the chain of operators is the same. But I was thinking further about it, and this optimization should not pose any problem in that context, since GBY logic has not changed. If Spark chooses to ignore RS2 since it is not sorting the input for GBY3, that should be fine: the limit is in the RS2 operator, not in GBY3. Spark will not benefit from the optimization, but it still remains correct.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Actually I&apos;m also wondering: if we use parallel order by (to use a range partitioner rather than a hash partitioner in RS2), we can do the groupBy and orderBy in a single stage, which may improve performance in some cases.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It might be beneficial in some cases indeed. However, it is a complex cost-based decision which would need multiple extensions, as I can think on multiple factors that would influence it, e.g., data skew, number of records for the top N groups, the limit of records itself, etc.&lt;/p&gt;</comment>
                            <comment id="15786788" author="lirui" created="Fri, 30 Dec 2016 03:43:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jcamachorodriguez&quot; class=&quot;user-hover&quot; rel=&quot;jcamachorodriguez&quot;&gt;jcamachorodriguez&lt;/a&gt;, thanks very much for the detailed explanations &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; For Spark, the operator chain is something like this:&lt;br/&gt;
&lt;tt&gt;GBY1 &#8211; RS2 &#8211; GBY3 &#8211; RS4 &#8211; SEL5 &#8211; FS6&lt;/tt&gt;&lt;br/&gt;
Since RS2 can produce the top N keys, I think this optimization doesn&apos;t require the input to GBY3 to be sorted. I mean we still feed the top N keys to GBY3, but after shuffling, those keys may not be in a sorted order. And the result should remain correct. Is that right?&lt;/p&gt;</comment>
                            <comment id="15787225" author="jcamacho" created="Fri, 30 Dec 2016 08:42:36 +0000"  >&lt;p&gt;That is correct &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I will update the patch to add the new q test to the MiniSparkCliDriver too.&lt;/p&gt;</comment>
                            <comment id="15795077" author="hiveqa" created="Tue, 3 Jan 2017 13:33:16 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12845376/HIVE-15474.01.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12845376/HIVE-15474.01.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 9 failed/errored test(s), 10914 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=233)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[case_sensitivity] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[input_testxpath] (batchId=28)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[udf_coalesce] (batchId=75)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_llap_counters] (batchId=136)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=93)
org.apache.hive.hcatalog.pig.TestTextFileHCatStorer.testPartColsInData (batchId=172)
org.apache.hive.hcatalog.pig.TestTextFileHCatStorer.testStoreMultiTables (batchId=172)
org.apache.hive.hcatalog.pig.TestTextFileHCatStorer.testWriteVarchar (batchId=172)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/2764/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/2764/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/2764/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/2764/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-2764/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-2764/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 9 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12845376 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15797276" author="lirui" created="Wed, 4 Jan 2017 05:56:54 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jcamachorodriguez&quot; class=&quot;user-hover&quot; rel=&quot;jcamachorodriguez&quot;&gt;jcamachorodriguez&lt;/a&gt; for enabling the Spark test. It looks good to me.&lt;br/&gt;
One more question, you mentioned the optimization works iff GBy columns are a prefix of the OBy columns. How about when the OBy columns are prefix of GBy columns? Won&apos;t the optimization work for that too?&lt;/p&gt;</comment>
                            <comment id="15798665" author="jcamacho" created="Wed, 4 Jan 2017 16:31:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirui&quot; class=&quot;user-hover&quot; rel=&quot;lirui&quot;&gt;lirui&lt;/a&gt;, the combination with &lt;em&gt;ReduceDeduplication&lt;/em&gt; makes the trick in the case you describe.&lt;/p&gt;

&lt;p&gt;Consider the following query:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;, value2, &lt;span class=&quot;code-keyword&quot;&gt;count&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; + 1) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; agg1 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; src 
&lt;span class=&quot;code-keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;, value2
&lt;span class=&quot;code-keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;limit&lt;/span&gt; 20;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In this case, OBy columns are a prefix of GBy columns. RS&lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt; in this case will end up with columns &lt;em&gt;key, value, value2&lt;/em&gt;. Then limit will be pushed by the new extension to the RS&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;As I stated above, I took a conservative approach as we need to be sure that we remain correct; it might be that the condition could be relaxed even further for some corner cases. However, I did not want to do it without checking the theoretical background further.&lt;/p&gt;</comment>
                            <comment id="15800947" author="lirui" created="Thu, 5 Jan 2017 09:58:04 +0000"  >&lt;p&gt;I see. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jcamachorodriguez&quot; class=&quot;user-hover&quot; rel=&quot;jcamachorodriguez&quot;&gt;jcamachorodriguez&lt;/a&gt;.&lt;br/&gt;
Instead of having another &lt;tt&gt;checkKeys&lt;/tt&gt;, can we do some refactor to reuse the current one? I think they&apos;re essentially the same - checking whether some keys are prefix of another series?&lt;/p&gt;</comment>
                            <comment id="15801201" author="jcamacho" created="Thu, 5 Jan 2017 12:09:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ruili&quot; class=&quot;user-hover&quot; rel=&quot;ruili&quot;&gt;ruili&lt;/a&gt;, thanks for the feedback.&lt;/p&gt;

&lt;p&gt;I have created two methods that are more generic (&lt;em&gt;checkPrefixKeys&lt;/em&gt; and &lt;em&gt;checkPrefixKeysUpstream&lt;/em&gt;) and moved them to ExprNodeDescUtils. Now they rely on the same logic. Could you take a look to the new patch? Thanks&lt;/p&gt;</comment>
                            <comment id="15801404" author="hiveqa" created="Thu, 5 Jan 2017 13:56:37 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12845788/HIVE-15474.03.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12845788/HIVE-15474.03.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 9 failed/errored test(s), 10915 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=233)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[case_sensitivity] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[input_testxpath] (batchId=28)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[udf_coalesce] (batchId=75)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_basic] (batchId=134)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_schema_evol_3a] (batchId=135)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[offset_limit_ppd_optimizer] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=139)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_3] (batchId=92)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/2800/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/2800/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/2800/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/2800/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-2800/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-2800/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 9 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12845788 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15801521" author="jcamacho" created="Thu, 5 Jan 2017 14:44:04 +0000"  >&lt;p&gt;Fails seem unrelated; none of the age=1 failures can be reproduced locally.&lt;/p&gt;</comment>
                            <comment id="15803369" author="lirui" created="Fri, 6 Jan 2017 03:17:38 +0000"  >&lt;p&gt;Thanks for the update &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jcamachorodriguez&quot; class=&quot;user-hover&quot; rel=&quot;jcamachorodriguez&quot;&gt;jcamachorodriguez&lt;/a&gt;. +1&lt;/p&gt;</comment>
                            <comment id="15804105" author="jcamacho" created="Fri, 6 Jan 2017 09:31:44 +0000"  >&lt;p&gt;Pushed to master, thanks for reviewing &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirui&quot; class=&quot;user-hover&quot; rel=&quot;lirui&quot;&gt;lirui&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12978170">HIVE-14002</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12845376" name="HIVE-15474.01.patch" size="60941" author="jcamachorodriguez" created="Tue, 3 Jan 2017 12:27:56 +0000"/>
                            <attachment id="12845788" name="HIVE-15474.03.patch" size="64025" author="jcamachorodriguez" created="Thu, 5 Jan 2017 12:46:52 +0000"/>
                            <attachment id="12844057" name="HIVE-15474.patch" size="14409" author="jcamachorodriguez" created="Tue, 20 Dec 2016 12:01:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 45 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37tin:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>