<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:22:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-26408] Vectorization: Fix deallocation of scratch columns, don&apos;t reuse a child ConstantVectorExpression as an output</title>
                <link>https://issues.apache.org/jira/browse/HIVE-26408</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;This is similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-15588&quot; title=&quot;Vectorization: Fix deallocation of scratch columns in VectorUDFCoalesce, etc to prevent wrong reuse&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-15588&quot;&gt;&lt;del&gt;HIVE-15588&lt;/del&gt;&lt;/a&gt;. With a customer query, I reproduced a vectorized expression tree like the below one (I&apos;ll attach a simple repro query when it&apos;s possible):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
selectExpressions: IfExprCondExprColumn(col 67:&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;, col 63:string, col 61:string)(children: StringColumnInList(col 13, values TermDeposit, RecurringDeposit, CertificateOfDeposit) -&amp;gt; 67:&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;, VectorCoalesce(columns [61, 62])(children: VectorUDFAdaptor(from_unixtime(to_unix_timestamp(CAST( _col1 AS DATE)), &lt;span class=&quot;code-quote&quot;&gt;&apos;MM-dd-yyyy&apos;&lt;/span&gt;))(children: VectorUDFUnixTimeStampDate(col 68)(children: CastStringToDate(col 33:string) -&amp;gt; 68:date) -&amp;gt; 69:bigint) -&amp;gt; 61:string, ConstantVectorExpression(val  ) -&amp;gt; 62:string) -&amp;gt; 63:string, ConstantVectorExpression(val ) -&amp;gt; 61:string) -&amp;gt; 62:string
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;query part was:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  CASE WHEN DLY_BAL.PDELP_VALUE in (
    &lt;span class=&quot;code-quote&quot;&gt;&apos;TermDeposit&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;RecurringDeposit&apos;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&apos;CertificateOfDeposit&apos;&lt;/span&gt;
  ) THEN NVL(
    (
      from_unixtime(
        unix_timestamp(
          &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(DLY_BAL.APATD_MTRTY_DATE as date)
        ),
        &lt;span class=&quot;code-quote&quot;&gt;&apos;MM-dd-yyyy&apos;&lt;/span&gt;
      )
    ),
    &lt;span class=&quot;code-quote&quot;&gt;&apos; &apos;&lt;/span&gt;
  ) ELSE &apos;&apos; END AS MAT_DTE
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here is the problem described:&lt;br/&gt;
1. IfExprCondExprColumn has 62:string as its &lt;a href=&quot;https://github.com/apache/hive/blob/d3309c0ea9da907af4d27427805084b7331a6c24/ql/src/java/org/apache/hadoop/hive/ql/exec/vector/expressions/IfExprCondExprColumn.java#L64&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;outputColumn&lt;/a&gt;, which is a reused scratch column (see 5) )&lt;br/&gt;
2. in evaluation time, &lt;a href=&quot;https://github.com/apache/hive/blob/d3309c0ea9da907af4d27427805084b7331a6c24/ql/src/java/org/apache/hadoop/hive/ql/exec/vector/expressions/IfExprCondExprColumn.java#L68&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;isRepeating is reset&lt;/a&gt;&lt;br/&gt;
3. in order to evaluate IfExprCondExprColumn, the conditional evaluation of children is required, so we go to &lt;a href=&quot;https://github.com/apache/hive/blob/d3309c0ea9da907af4d27427805084b7331a6c24/ql/src/java/org/apache/hadoop/hive/ql/exec/vector/expressions/IfExprCondExprColumn.java#L95&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;conditionalEvaluate&lt;/a&gt;&lt;br/&gt;
4. one of the children is ConstantVectorExpression(val  ) -&amp;gt; 62:string, which belongs to the second branch of VectorCoalesce, so to the &apos;&apos; empty string in NVL&apos;s second argument&lt;br/&gt;
5. in 4) 62: string column is set to an isRepeating column (and it&apos;s released by &lt;a href=&quot;https://github.com/apache/hive/blob/d3309c0ea9da907af4d27427805084b7331a6c24/ql/src/java/org/apache/hadoop/hive/ql/exec/vector/VectorizationContext.java#L2459&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;freeNonColumns&lt;/a&gt;), so it&apos;s marked as a reusable scratch column&lt;br/&gt;
6. after the conditional evaluation in 3), the final output of IfExprCondExprColumn set &lt;a href=&quot;https://github.com/apache/hive/blob/d3309c0ea9da907af4d27427805084b7331a6c24/ql/src/java/org/apache/hadoop/hive/ql/exec/vector/expressions/IfExprCondExprColumn.java#L99&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, but here we get an exception &lt;a href=&quot;https://github.com/apache/hive/blob/d3309c0ea9da907af4d27427805084b7331a6c24/storage-api/src/java/org/apache/hadoop/hive/ql/exec/vector/BytesColumnVector.java#L484&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2022-07-01T04:26:24,567 ERROR [TezTR-745267_1_35_6_0_0] tez.MapRecordSource: java.lang.AssertionError: Output column number expected to be 0 when isRepeating
	at org.apache.hadoop.hive.ql.exec.vector.BytesColumnVector.setElement(BytesColumnVector.java:494)
	at org.apache.hadoop.hive.ql.exec.vector.expressions.IfExprCondExprColumn.evaluate(IfExprCondExprColumn.java:108)
	at org.apache.hadoop.hive.ql.exec.vector.VectorSelectOperator.process(VectorSelectOperator.java:146)
	at org.apache.hadoop.hive.ql.exec.Operator.vectorForward(Operator.java:969)
	at org.apache.hadoop.hive.ql.exec.vector.mapjoin.VectorMapJoinGenerateResultOperator.forwardBigTableBatch(VectorMapJoinGenerateResultOperator.java:694)
	at org.apache.hadoop.hive.ql.exec.vector.mapjoin.VectorMapJoinInnerBigOnlyStringOperator.processBatch(VectorMapJoinInnerBigOnlyStringOperator.java:371)
	at org.apache.hadoop.hive.ql.exec.vector.mapjoin.VectorMapJoinCommonOperator.process(VectorMapJoinCommonOperator.java:839)
	at org.apache.hadoop.hive.ql.exec.Operator.vectorForward(Operator.java:969)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;this is clearly an incorrect scratch column reuse, where we reused the output of some children, and got that vector in an inconsistent state&lt;br/&gt;
this must not be fixed by resetting vectors in more places in IfExprCondExprColumn, as it would just hide the original issue&lt;/p&gt;

&lt;p&gt;I realized that the problem can be easily fixed by simply preventing releasing ConstantVectorExpressions, that&apos;s what I&apos;m trying to test now&lt;/p&gt;</description>
                <environment></environment>
        <key id="13472148">HIVE-26408</key>
            <summary>Vectorization: Fix deallocation of scratch columns, don&apos;t reuse a child ConstantVectorExpression as an output</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="abstractdog">L&#225;szl&#243; Bodor</assignee>
                                    <reporter username="abstractdog">L&#225;szl&#243; Bodor</reporter>
                        <labels>
                            <label>hive-3.2.0-candidate</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 18 Jul 2022 21:40:27 +0000</created>
                <updated>Mon, 5 Feb 2024 22:52:28 +0000</updated>
                            <resolved>Tue, 26 Jul 2022 06:42:17 +0000</resolved>
                                                    <fixVersion>4.0.0-alpha-2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17571227" author="abstractdog" created="Tue, 26 Jul 2022 06:42:06 +0000"  >&lt;p&gt;merged to master, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ayushtkn&quot; class=&quot;user-hover&quot; rel=&quot;ayushtkn&quot;&gt;ayushtkn&lt;/a&gt; for the review!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13201574">HIVE-20990</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13033996">HIVE-15588</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 16 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z16yk0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>