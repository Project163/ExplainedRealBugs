<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:38:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-11499] Datanucleus leaks classloaders when used using embedded metastore with HiveServer2 with UDFs</title>
                <link>https://issues.apache.org/jira/browse/HIVE-11499</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;When UDFs are used, we create a new classloader to add the UDF jar. Similar to what hadoop&apos;s reflection utils does(&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-11408&quot; title=&quot;HiveServer2 is leaking ClassLoaders when add jar / temporary functions are used due to constructor caching in Hadoop ReflectionUtils&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-11408&quot;&gt;&lt;del&gt;HIVE-11408&lt;/del&gt;&lt;/a&gt;), datanucleus caches the classloaders (&lt;a href=&quot;https://github.com/datanucleus/datanucleus-core/blob/3.2/src/java/org/datanucleus/NucleusContext.java#L161&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/datanucleus/datanucleus-core/blob/3.2/src/java/org/datanucleus/NucleusContext.java#L161&lt;/a&gt;). JDOPersistanceManager factory (1 per JVM) holds on to a NucleusContext reference (&lt;a href=&quot;https://github.com/datanucleus/datanucleus-api-jdo/blob/3.2/src/java/org/datanucleus/api/jdo/JDOPersistenceManagerFactory.java#L115&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/datanucleus/datanucleus-api-jdo/blob/3.2/src/java/org/datanucleus/api/jdo/JDOPersistenceManagerFactory.java#L115&lt;/a&gt;). Until we call  NucleusContext#close, the classloader cache is not cleared. In case of UDFs this can lead to permgen leak, as shown in the attached screenshot, where NucleusContext holds on to several URLClassloader objects.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12853055">HIVE-11499</key>
            <summary>Datanucleus leaks classloaders when used using embedded metastore with HiveServer2 with UDFs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vgumashta">Vaibhav Gumashta</assignee>
                                    <reporter username="vgumashta">Vaibhav Gumashta</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 Aug 2015 21:16:50 +0000</created>
                <updated>Wed, 15 Mar 2017 16:26:03 +0000</updated>
                            <resolved>Wed, 14 Oct 2015 01:56:38 +0000</resolved>
                                    <version>0.14.0</version>
                    <version>1.0.0</version>
                    <version>1.1.0</version>
                    <version>1.1.1</version>
                    <version>1.2.0</version>
                    <version>1.2.1</version>
                                    <fixVersion>1.3.0</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>HiveServer2</component>
                    <component>Metastore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14662478" author="vgumashta" created="Fri, 7 Aug 2015 21:21:29 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thejas&quot; class=&quot;user-hover&quot; rel=&quot;thejas&quot;&gt;thejas&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14679177" author="hiveqa" created="Sun, 9 Aug 2015 15:44:07 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 no tests executed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12749388/HIVE-11499.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12749388/HIVE-11499.1.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4888/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4888/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4888/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4888/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-4888/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-4888/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Tests exited with: NonZeroExitCodeException
Command &apos;bash /data/hive-ptest/working/scratch/source-prep.sh&apos; failed with exit status 1 and output &apos;+ [[ -n /usr/java/jdk1.7.0_45-cloudera ]]
+ export JAVA_HOME=/usr/java/jdk1.7.0_45-cloudera
+ JAVA_HOME=/usr/java/jdk1.7.0_45-cloudera
+ export PATH=/usr/java/jdk1.7.0_45-cloudera/bin/:/usr/local/apache-maven-3.0.5/bin:/usr/java/jdk1.7.0_45-cloudera/bin:/usr/local/apache-ant-1.9.1/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin:/home/hiveptest/bin
+ PATH=/usr/java/jdk1.7.0_45-cloudera/bin/:/usr/local/apache-maven-3.0.5/bin:/usr/java/jdk1.7.0_45-cloudera/bin:/usr/local/apache-ant-1.9.1/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin:/home/hiveptest/bin
+ export &apos;ANT_OPTS=-Xmx1g -XX:MaxPermSize=256m &apos;
+ ANT_OPTS=&apos;-Xmx1g -XX:MaxPermSize=256m &apos;
+ export &apos;M2_OPTS=-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128&apos;
+ M2_OPTS=&apos;-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128&apos;
+ cd /data/hive-ptest/working/
+ tee /data/hive-ptest/logs/PreCommit-HIVE-TRUNK-Build-4888/source-prep.txt
+ [[ false == \t\r\u\e ]]
+ mkdir -p maven ivy
+ [[ git = \s\v\n ]]
+ [[ git = \g\i\t ]]
+ [[ -z master ]]
+ [[ -d apache-github-source-source ]]
+ [[ ! -d apache-github-source-source/.git ]]
+ [[ ! -d apache-github-source-source ]]
+ cd apache-github-source-source
+ git fetch origin
+ git reset --hard HEAD
HEAD is now at 835d718 HIVE-11466: HIVE-10166 generates more data on hive.log causing Jenkins to fill all the disk (Reviewed by Prasanth)
+ git clean -f -d
Removing ql/src/java/org/apache/hadoop/hive/ql/hooks/PostExecOrcFileDump.java
Removing ql/src/test/queries/clientpositive/orc_file_dump.q
Removing ql/src/test/results/clientpositive/orc_file_dump.q.out
+ git checkout master
Already on &apos;master&apos;
+ git reset --hard origin/master
HEAD is now at 835d718 HIVE-11466: HIVE-10166 generates more data on hive.log causing Jenkins to fill all the disk (Reviewed by Prasanth)
+ git merge --ff-only origin/master
Already up-to-date.
+ git gc
+ patchCommandPath=/data/hive-ptest/working/scratch/smart-apply-patch.sh
+ patchFilePath=/data/hive-ptest/working/scratch/build.patch
+ [[ -f /data/hive-ptest/working/scratch/build.patch ]]
+ chmod +x /data/hive-ptest/working/scratch/smart-apply-patch.sh
+ /data/hive-ptest/working/scratch/smart-apply-patch.sh /data/hive-ptest/working/scratch/build.patch
patch: **** unexpected end of file in patch
patch: **** unexpected end of file in patch
patch: **** unexpected end of file in patch
The patch does not appear to apply with p0, p1, or p2
+ exit 1
&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12749388 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14730114" author="thejas" created="Fri, 4 Sep 2015 00:50:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vgumashta&quot; class=&quot;user-hover&quot; rel=&quot;vgumashta&quot;&gt;vgumashta&lt;/a&gt; Looks like the patch needs rebase for master.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;I think it would be better to create an ObjectStore function that does the cleanup, so that we limit the DN logic to that class.&lt;/li&gt;
	&lt;li&gt;LOG.info(e);  This can be change to LOG.warn(&quot;Failed to clean datanucleus classloader cache&quot;);&lt;/li&gt;
	&lt;li&gt;Orphan Jira references will clutter the code over time. I assume it was added to show which jira added that change, but we have git blame for that, and over time the code would change and these references would be very unreliable. IMO, Jira references are useful if they are needed to provide more context in a comment. eg &quot;DataNucleus caches classloaders in NucleusContext.classLoaderResolverMap . See references in profiler snapshot in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-11499&quot; title=&quot;Datanucleus leaks classloaders when used using embedded metastore with HiveServer2 with UDFs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-11499&quot;&gt;&lt;del&gt;HIVE-11499&lt;/del&gt;&lt;/a&gt;&quot; . Such references are not as likely to be out of sync.&lt;/li&gt;
&lt;/ol&gt;


</comment>
                            <comment id="14730116" author="thejas" created="Fri, 4 Sep 2015 00:52:03 +0000"  >&lt;p&gt;Can you also add a unit test for this ? Maybe in testjdbcdriver , have a test that adds jar, then close session and see if this object is empty ?&lt;/p&gt;</comment>
                            <comment id="14948271" author="vgumashta" created="Thu, 8 Oct 2015 08:27:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thejas&quot; class=&quot;user-hover&quot; rel=&quot;thejas&quot;&gt;thejas&lt;/a&gt; Patch attached incorporating your feedback.&lt;/p&gt;</comment>
                            <comment id="14949599" author="thejas" created="Thu, 8 Oct 2015 23:24:01 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14950259" author="hiveqa" created="Fri, 9 Oct 2015 11:37:06 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12765686/HIVE-11499.4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12765686/HIVE-11499.4.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 4 failed/errored test(s), 9657 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_udaf_histogram_numeric
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation
org.apache.hive.jdbc.TestJdbcWithMiniHS2.testAddJarDataNucleusUnCaching
org.apache.hive.jdbc.TestSSL.testSSLVersion
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5583/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5583/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5583/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5583/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5583/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5583/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12765686 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14956110" author="vgumashta" created="Wed, 14 Oct 2015 01:42:38 +0000"  >&lt;p&gt;TestJdbcWithMiniHS2.testAddJarDataNucleusUnCaching is failing because the test udf jar file is not yet in code base. It passes locally. This looks good to commit.&lt;/p&gt;</comment>
                            <comment id="14956123" author="vgumashta" created="Wed, 14 Oct 2015 01:56:38 +0000"  >&lt;p&gt;Patch committed to branches. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thejas&quot; class=&quot;user-hover&quot; rel=&quot;thejas&quot;&gt;thejas&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14962025" author="ashutoshc" created="Sat, 17 Oct 2015 18:30:58 +0000"  >&lt;p&gt;I noticed this patch checked in a jar file in git repo. Its usually not considered a good practice to check in binary files in source repo. We never know when we need to update source of that jar. Ideally, source code should be checked in and then it should be compiled in build phase and then used in test phase. &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hsubramaniyan&quot; class=&quot;user-hover&quot; rel=&quot;hsubramaniyan&quot;&gt;hsubramaniyan&lt;/a&gt; spent lot of time last year to make our repo binary-file free. Please reconsider decision of checking in a jar file.&lt;/p&gt;</comment>
                            <comment id="15012410" author="thejas" created="Wed, 18 Nov 2015 23:58:39 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-12458&quot; title=&quot;remove identity_udf.jar from source&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-12458&quot;&gt;HIVE-12458&lt;/a&gt; to remove the jar from source.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12914274">HIVE-12458</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13049790">HIVE-16160</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12850160">HIVE-11408</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12749388" name="HIVE-11499.1.patch" size="3229" author="vgumashta" created="Sat, 8 Aug 2015 00:11:55 +0000"/>
                            <attachment id="12765543" name="HIVE-11499.3.patch" size="12104" author="vgumashta" created="Thu, 8 Oct 2015 08:27:14 +0000"/>
                            <attachment id="12765686" name="HIVE-11499.4.patch" size="12057" author="vgumashta" created="Thu, 8 Oct 2015 22:02:41 +0000"/>
                            <attachment id="12749354" name="HS2-NucleusCache-Leak.tiff" size="852486" author="vgumashta" created="Fri, 7 Aug 2015 21:18:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ihhj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>