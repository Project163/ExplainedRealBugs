<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:53:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-16451] Race condition between HiveStatement.getQueryLog and HiveStatement.runAsyncOnServer</title>
                <link>https://issues.apache.org/jira/browse/HIVE-16451</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;During the BeeLineDriver testing I have met the following race condition:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Run the query asynchronously through BeeLine&lt;/li&gt;
	&lt;li&gt;Querying the logs in the BeeLine&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In the following code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;HiveStatement.runAsyncOnServer&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void runAsyncOnServer(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; sql) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; SQLException {
    checkConnection(&lt;span class=&quot;code-quote&quot;&gt;&quot;execute&quot;&lt;/span&gt;);

    closeClientOperation();
    initFlags();
[..]
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;HiveStatement.getQueryLog&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; getQueryLog(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; incremental, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; fetchSize)
      &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; SQLException, ClosedOrCancelledStatementException {
[..]
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (stmtHandle != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
[..]
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isQueryClosed) {
          &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ClosedOrCancelledStatementException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Method getQueryLog() failed. The &quot;&lt;/span&gt; +
              &lt;span class=&quot;code-quote&quot;&gt;&quot;statement has been closed or cancelled.&quot;&lt;/span&gt;);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
          &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; logs;
        }
      }
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (SQLException e) {
[..]
    }
[..]
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The runAsyncOnServer &lt;tt&gt;closeClientOperation&lt;/tt&gt; sets &lt;tt&gt;isQueryClosed&lt;/tt&gt; flag to true:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;HiveStatement.closeClientOperation&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  void closeClientOperation() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; SQLException {
[..]
    isQueryClosed = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    isExecuteStatementFailed = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    stmtHandle = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &lt;tt&gt;initFlags&lt;/tt&gt; sets it to false:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void initFlags() {
    isCancelled = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    isQueryClosed = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    isLogBeingGenerated = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    isExecuteStatementFailed = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    isOperationComplete = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If the &lt;tt&gt;getQueryLog&lt;/tt&gt; is called after the &lt;tt&gt;closeClientOperation&lt;/tt&gt;, but before the &lt;tt&gt;initFlags&lt;/tt&gt;, then we will have a following warning if verbose mode is set to true in BeeLine:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Warning: org.apache.hive.jdbc.ClosedOrCancelledStatementException: Method getQueryLog() failed. The statement has been closed or cancelled. (state=,code=0)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This caused this fail:&lt;br/&gt;
&lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/4691/testReport/org.apache.hadoop.hive.cli/TestBeeLineDriver/testCliDriver_smb_mapjoin_11_/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/4691/testReport/org.apache.hadoop.hive.cli/TestBeeLineDriver/testCliDriver_smb_mapjoin_11_/&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Error Message

Client result comparison failed with error code = 1 &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; executing fname=smb_mapjoin_11
16a17
&amp;gt; Warning: org.apache.hive.jdbc.ClosedOrCancelledStatementException: Method getQueryLog() failed. The statement has been closed or cancelled. (state=,code=0)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13064076">HIVE-16451</key>
            <summary>Race condition between HiveStatement.getQueryLog and HiveStatement.runAsyncOnServer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pvary">Peter Vary</assignee>
                                    <reporter username="pvary">Peter Vary</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Apr 2017 14:12:22 +0000</created>
                <updated>Mon, 17 Dec 2018 07:32:22 +0000</updated>
                            <resolved>Tue, 9 May 2017 14:27:41 +0000</resolved>
                                    <version>3.0.0</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>Beeline</component>
                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15969081" author="pvary" created="Fri, 14 Apr 2017 14:17:49 +0000"  >&lt;p&gt;Confirmed by adding sleep between the two method, like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;HiveStatement.runAsyncOnServer&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void runAsyncOnServer(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; sql) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; SQLException {
    checkConnection(&lt;span class=&quot;code-quote&quot;&gt;&quot;execute&quot;&lt;/span&gt;);

    closeClientOperation();
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().sleep(8000L);
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
      e.printStackTrace();
    }
    initFlags();
[..]
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This reproduced the errors.&lt;/p&gt;</comment>
                            <comment id="15969131" author="pvary" created="Fri, 14 Apr 2017 15:19:20 +0000"  >&lt;p&gt;A patch to solve the current problem.&lt;/p&gt;

&lt;p&gt;Create a new method &lt;tt&gt;closeStatementIfNeeded&lt;/tt&gt;, which only closes the statement, but does not touch the flags.&lt;/p&gt;

&lt;p&gt;Using this method should solve the problem, since the flags are not flip-flopping any more.&lt;/p&gt;</comment>
                            <comment id="15969348" author="hiveqa" created="Fri, 14 Apr 2017 18:06:58 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12863475/HIVE-16451.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12863475/HIVE-16451.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 14 failed/errored test(s), 10551 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestSSL - did not produce a TEST-*.xml file (likely timed out) (batchId=220)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=143)
org.apache.hadoop.hive.cli.TestSparkCliDriver.org.apache.hadoop.hive.cli.TestSparkCliDriver (batchId=100)
org.apache.hadoop.hive.ql.TestMetaStoreLimitPartitionRequest.testMoreComplexQueryWithDirectSqlTooManyPartitions (batchId=214)
org.apache.hadoop.hive.ql.TestMetaStoreLimitPartitionRequest.testQueryWithFallbackToORMTooManyPartitions1 (batchId=214)
org.apache.hadoop.hive.ql.TestMetaStoreLimitPartitionRequest.testQueryWithFallbackToORMTooManyPartitions2 (batchId=214)
org.apache.hadoop.hive.ql.TestMetaStoreLimitPartitionRequest.testQueryWithFallbackToORMTooManyPartitions3 (batchId=214)
org.apache.hadoop.hive.ql.TestMetaStoreLimitPartitionRequest.testQueryWithFallbackToORMTooManyPartitions4 (batchId=214)
org.apache.hadoop.hive.ql.TestMetaStoreLimitPartitionRequest.testQueryWithInWithFallbackToORMTooManyPartitions (batchId=214)
org.apache.hadoop.hive.ql.TestMetaStoreLimitPartitionRequest.testQueryWithInWithFallbackToORMTooManyPartitions2 (batchId=214)
org.apache.hadoop.hive.ql.TestMetaStoreLimitPartitionRequest.testQueryWithLikeWithFallbackToORMTooManyPartitions (batchId=214)
org.apache.hadoop.hive.ql.TestMetaStoreLimitPartitionRequest.testSimpleQueryWithDirectSqlTooManyPartitions (batchId=214)
org.apache.hive.jdbc.authorization.TestJdbcWithSQLAuthUDFBlacklist.testBlackListedUdfUsage (batchId=223)
org.apache.hive.jdbc.authorization.TestJdbcWithSQLAuthorization.testBlackListedUdfUsage (batchId=223)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/4697/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/4697/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/4697/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/4697/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-4697/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-4697/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 14 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12863475 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15969557" author="pvary" created="Fri, 14 Apr 2017 21:36:29 +0000"  >&lt;p&gt;Addressed test failures&lt;/p&gt;</comment>
                            <comment id="15969656" author="hiveqa" created="Fri, 14 Apr 2017 23:09:08 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12863506/HIVE-16451.02.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12863506/HIVE-16451.02.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 3 failed/errored test(s), 10578 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_order_null] (batchId=27)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=143)
org.apache.hive.jdbc.TestJdbcDriver2.testSelectExecAsync2 (batchId=221)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/4700/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/4700/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/4700/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/4700/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-4700/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-4700/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12863506 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15969857" author="pvary" created="Sat, 15 Apr 2017 07:55:14 +0000"  >&lt;p&gt;Retriggering the precommit with the same file, to check again.&lt;/p&gt;
</comment>
                            <comment id="15969882" author="hiveqa" created="Sat, 15 Apr 2017 09:13:50 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12863540/HIVE-16451.03.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12863540/HIVE-16451.03.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 3 failed/errored test(s), 10579 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_order_null] (batchId=27)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=143)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vector_count_distinct] (batchId=109)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/4703/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/4703/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/4703/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/4703/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-4703/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-4703/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12863540 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15972328" author="pvary" created="Tue, 18 Apr 2017 08:35:18 +0000"  >&lt;p&gt;This 2 are known flaky:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-15776&quot; title=&quot;Flaky test: TestMiniLlapLocalCliDriver vector_if_expr&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-15776&quot;&gt;HIVE-15776&lt;/a&gt; - Flaky test: TestMiniLlapLocalCliDriver vector_if_expr&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-16362&quot; title=&quot;Flaky test: TestMiniLlapLocalCliDriver.testCliDriver[vector_count_distinct]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-16362&quot;&gt;HIVE-16362&lt;/a&gt;- Flaky test: TestMiniLlapLocalCliDriver.testCliDriver&lt;span class=&quot;error&quot;&gt;&amp;#91;vector_count_distinct&amp;#93;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Registered 2 new flaky:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-16466&quot; title=&quot;Flaky test: TestJdbcDriver2.testSelectExecAsync2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-16466&quot;&gt;HIVE-16466&lt;/a&gt; - Flaky test: TestJdbcDriver2.testSelectExecAsync2&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-16467&quot; title=&quot;Flaky test: TestCliDriver.testCliDriver[vector_order_null]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-16467&quot;&gt;&lt;del&gt;HIVE-16467&lt;/del&gt;&lt;/a&gt; - Flaky test: TestCliDriver.testCliDriver&lt;span class=&quot;error&quot;&gt;&amp;#91;vector_order_null&amp;#93;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So I think the test failures are not related.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vgumashta&quot; class=&quot;user-hover&quot; rel=&quot;vgumashta&quot;&gt;vgumashta&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thejas&quot; class=&quot;user-hover&quot; rel=&quot;thejas&quot;&gt;thejas&lt;/a&gt;: Could you please review, since this patch affects Ambari specific code as well in &lt;tt&gt;HiveStatement.executeAsync&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Peter&lt;/p&gt;</comment>
                            <comment id="15977107" author="pvary" created="Thu, 20 Apr 2017 17:19:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vihangk1&quot; class=&quot;user-hover&quot; rel=&quot;vihangk1&quot;&gt;vihangk1&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ychena&quot; class=&quot;user-hover&quot; rel=&quot;ychena&quot;&gt;ychena&lt;/a&gt; could you please take a look?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Peter&lt;/p&gt;</comment>
                            <comment id="15977175" author="vihangk1" created="Thu, 20 Apr 2017 18:12:18 +0000"  >&lt;p&gt;Thanks for finding this out &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvary&quot; class=&quot;user-hover&quot; rel=&quot;pvary&quot;&gt;pvary&lt;/a&gt;. Although I didn&apos;t quite get how the patch fixes the race condition. The way I understand the issue is that there is a Logging thread and the thread executing the HiveStatement. Both these threads are accessing isLogBeingGenerated, isCancelled, isQueryClosed flags in the same HiveStatement object. None of these getters and setters are thread safe. I think there could be more undiscovered race-conditions in this execution path.&lt;/p&gt;</comment>
                            <comment id="15978339" author="pvary" created="Fri, 21 Apr 2017 08:56:38 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vihangk1&quot; class=&quot;user-hover&quot; rel=&quot;vihangk1&quot;&gt;vihangk1&lt;/a&gt; for taking the time to look at this!&lt;/p&gt;

&lt;p&gt;Currently during the &lt;tt&gt;HiveStatement.runAsyncOnServer&lt;/tt&gt; the &lt;tt&gt;isQueryClosed&lt;/tt&gt; flag is flipping:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Constructor sets initially sets it to true&lt;/li&gt;
	&lt;li&gt;The call &lt;tt&gt;closeClientOperation&lt;/tt&gt; sets it to false&lt;/li&gt;
	&lt;li&gt;The call &lt;tt&gt;initFlags&lt;/tt&gt; sets it to true again&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This happens even on the happy path, when there is no cancellation or errors, and could generate the &quot;Method getQueryLog() failed. The statement has been closed or cancelled.&quot; warning message.&lt;/p&gt;

&lt;p&gt;The getQueryLog, and runAsyncOnServer currently used parallel in very limited situations, which might not lead to race conditions in other cases. At least I have to find any concrete example, so I concentrated on the current problem.&lt;/p&gt;

&lt;p&gt;Changing the HiveStatement to a thread safe one would be a big change. I could do that, but was not sure that the community would agree with that - Shall we do that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vihangk1&quot; class=&quot;user-hover&quot; rel=&quot;vihangk1&quot;&gt;vihangk1&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ychena&quot; class=&quot;user-hover&quot; rel=&quot;ychena&quot;&gt;ychena&lt;/a&gt;? Would it worth the performance impact? Might worth a letter to the dev list....&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Peter&lt;/p&gt;

</comment>
                            <comment id="15981334" author="pvary" created="Mon, 24 Apr 2017 15:15:53 +0000"  >&lt;p&gt;On the weekend I did some thinking, and I realized that HiveStatement could not be made to thread safe (see execute, and getResultSet could be called from different threads and cause problems).&lt;/p&gt;

&lt;p&gt;We can not make the HiveStatement thread safe, but we should at least make sure that calling getQueryLog will not cause problems if it is called parallel with any of the followings: cancel, close, execute, executeAsync, executeQuery, executeUpdate, getUpdateCount and more interestingly for the HiveQueryResultSet.next too. It is a quiet complex problem for the first glance, so I created a new jira for it: &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-16517&quot; title=&quot;HiveStatement thread safety issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-16517&quot;&gt;&lt;del&gt;HIVE-16517&lt;/del&gt;&lt;/a&gt; - HiveStatement thread safety issues.&lt;/p&gt;

&lt;p&gt;In the meantime this patch could solve the problems which can arise during the happy path.&lt;/p&gt;
</comment>
                            <comment id="15996405" author="pvary" created="Thu, 4 May 2017 09:14:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anishek&quot; class=&quot;user-hover&quot; rel=&quot;anishek&quot;&gt;anishek&lt;/a&gt;: Could you please take a look at it, if you have time?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Peter&lt;/p&gt;</comment>
                            <comment id="15996473" author="anishek" created="Thu, 4 May 2017 09:55:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvary&quot; class=&quot;user-hover&quot; rel=&quot;pvary&quot;&gt;pvary&lt;/a&gt; The way i see the problem, query logs should not be requested until the query request is submitted. Additionally since HiveStatement is not thread safe  ==&amp;gt; dont think getting logs in a separate thread via LogRunnable is a great idea, to this end i had created &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-15940&quot; title=&quot;Query Logs to be merged with GetOperationStatus call&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-15940&quot;&gt;HIVE-15940&lt;/a&gt; a while back, which will bring back the processing to a single thread, but this will require some time to implement and is not trivial. &lt;/p&gt;

&lt;p&gt;For now your changes look good. &lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
anishek&lt;/p&gt;</comment>
                            <comment id="15996481" author="pvary" created="Thu, 4 May 2017 09:58:56 +0000"  >&lt;p&gt;Thanks for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anishek&quot; class=&quot;user-hover&quot; rel=&quot;anishek&quot;&gt;anishek&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="16000524" author="pvary" created="Mon, 8 May 2017 09:51:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ychena&quot; class=&quot;user-hover&quot; rel=&quot;ychena&quot;&gt;ychena&lt;/a&gt;: Could you please review and commit? This causing flaky TestBeeLineDriver tests.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Peter&lt;/p&gt;</comment>
                            <comment id="16000697" author="ychena" created="Mon, 8 May 2017 13:00:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvary&quot; class=&quot;user-hover&quot; rel=&quot;pvary&quot;&gt;pvary&lt;/a&gt;, it is a good fix, but I am not sure it is very effective if not thread safe. Anyway it is good to have for now.  +1&lt;/p&gt;</comment>
                            <comment id="16002774" author="ychena" created="Tue, 9 May 2017 14:27:41 +0000"  >&lt;p&gt;Committed the fix into master. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvary&quot; class=&quot;user-hover&quot; rel=&quot;pvary&quot;&gt;pvary&lt;/a&gt; for your contribution. &lt;/p&gt;</comment>
                            <comment id="16002874" author="pvary" created="Tue, 9 May 2017 15:28:53 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ychena&quot; class=&quot;user-hover&quot; rel=&quot;ychena&quot;&gt;ychena&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anishek&quot; class=&quot;user-hover&quot; rel=&quot;anishek&quot;&gt;anishek&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vihangk1&quot; class=&quot;user-hover&quot; rel=&quot;vihangk1&quot;&gt;vihangk1&lt;/a&gt; for the review and the commit!&lt;/p&gt;</comment>
                            <comment id="16486484" author="vgarg" created="Wed, 23 May 2018 00:00:53 +0000"  >&lt;p&gt;Hive 3.0.0 has been released so closing this jira.&lt;/p&gt;</comment>
                            <comment id="16722749" author="feiyuanxing" created="Mon, 17 Dec 2018 07:32:22 +0000"  >&lt;p&gt;well&#65281;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12863506" name="HIVE-16451.02.patch" size="2001" author="pvary" created="Fri, 14 Apr 2017 21:36:29 +0000"/>
                            <attachment id="12863540" name="HIVE-16451.03.patch" size="2001" author="pvary" created="Sat, 15 Apr 2017 07:55:14 +0000"/>
                            <attachment id="12863475" name="HIVE-16451.patch" size="1851" author="pvary" created="Fri, 14 Apr 2017 15:19:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 48 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3dmyv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>