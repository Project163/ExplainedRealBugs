<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 17:50:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-170] map-side aggregations does not work properly</title>
                <link>https://issues.apache.org/jira/browse/HIVE-170</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;map-side aggregation depends on runtime.freememory() which is not guaranteed to return the freeable memory - it depends on when the garbage collector is invoked last.&lt;br/&gt;
It might be a good idea to estimate the number of rows that can fit in the hash table and then flush the hash table based on that&lt;/p&gt;</description>
                <environment></environment>
        <key id="12410527">HIVE-170</key>
            <summary>map-side aggregations does not work properly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="namit">Namit Jain</assignee>
                                    <reporter username="namit">Namit Jain</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Dec 2008 23:34:51 +0000</created>
                <updated>Sat, 17 Dec 2011 00:08:57 +0000</updated>
                            <resolved>Wed, 17 Dec 2008 22:47:23 +0000</resolved>
                                                    <fixVersion>0.3.0</fixVersion>
                                    <component>Query Processor</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12656134" author="athusoo" created="Fri, 12 Dec 2008 19:50:27 +0000"  >&lt;p&gt;A few comments on this:&lt;/p&gt;

&lt;p&gt;1. I think we should not have the number of rows as a session level parameter. Instead we should just estimate these by estimating the row size at run time (instead of the config time). I think we should just use that estimate and the session level max memory size set by the user to estimate the number of rows.&lt;br/&gt;
2. In order to estimate the size of the hash table we should do some simple experiments to see what the (hash table size/number of rows) factor is and then use that to scale our estimates.&lt;/p&gt;

&lt;p&gt;Otherwise, this looks like a nice thing that can give us a lot of oomph in the performance side of things.&lt;/p&gt;</comment>
                            <comment id="12656190" author="jsensarma" created="Fri, 12 Dec 2008 22:49:37 +0000"  >&lt;p&gt;one significant optimization we can/should make is when flushing - flush the entries that have been seen the least often (basically MFU caching). if we have a count aggregate function we can use that - or if not - might be worth keeping a count in any case.&lt;/p&gt;

&lt;p&gt;default value of hashmaxmemory - perhaps this should be something like Runtime.getRuntime().maxMemory() - 512m (since we know mappers need some memory anyway).&lt;/p&gt;

&lt;p&gt;i suspect Namit is using number of rows as an escape valve in case the memory computation is not correct. i do think that we are making life a little difficult for the user - remember that they not only have to manipulate the hash map memory - but they also have to size up the jvm spawning options so that heap size is increased. this is fairly obscure. it also turns out that the jvm options include non memory related stuff (although in later hadoop options - memory parameterization is separated out i think) - for example ours looks like this (-Xmx1024m -Djava.net.preferIPv4Stack=true)&lt;/p&gt;

&lt;p&gt;it&apos;s worth asking if we can base it on the heap size only. the problem with the freememory approach was that it didn&apos;t account for garbage collection. on the other hand - we can call gc() every some time that we hit some higher free memory threshold and then flush out the map everytime we hit some lower free memory threshold (to guarantee that we dont hit OOM). wouldn&apos;t this be easier for the user (just set jvm option)&lt;/p&gt;

&lt;p&gt;this would also be much preferable from the perspective of any future cluster scheduling based on memory. tasks should just need to specify total memory required and then figure out how to use it well. schedulers can work off this memory requirement. if the memory requirement has to be then subdivided into different components (like hive hashmap) - then things become complicated.&lt;/p&gt;
</comment>
                            <comment id="12656198" author="namit" created="Fri, 12 Dec 2008 23:20:44 +0000"  >&lt;p&gt;I agree with the flushing optimization - but that can be a follow-up.&lt;/p&gt;

&lt;p&gt;Default value of Runtime.getRuntime().maxMemory() - 512m is also OK.&lt;/p&gt;

&lt;p&gt;I was using the number of rows as an escape value.&lt;/p&gt;

&lt;p&gt;But I dont think invoking garbage collector explicitly is a good idea. &lt;/p&gt;

&lt;p&gt;A third category where developers often mistakenly think they are helping the garbage collector is the use of System.gc(), which triggers a garbage collection (actually, it merely suggests that this might be a good time for a garbage collection). Unfortunately, System.gc() triggers a full collection, which includes tracing all live objects in the heap and sweeping and compacting the old generation. This can be a lot of work. In general, it is better to let the system decide when it needs to collect the heap, and whether or not to do a full collection. Most of the time, a minor collection will do the job. Worse, calls to System.gc() are often deeply buried where developers may be unaware of their presence, and where they might get triggered far more often than necessary. If you are concerned that your application might have hidden calls to System.gc() buried in libraries, you can invoke the JVM with the -XX:+DisableExplicitGC option to prevent calls to System.gc() and triggering a garbage collection. &lt;/p&gt;

&lt;p&gt;I think it is too expensive to use that.&lt;/p&gt;

&lt;p&gt;Instead of asking the user to specify hive hashmap memory, the user can specify that as a fraction of total task memory. The default will be close to 1 i.e all task memory will be used.&lt;/p&gt;
</comment>
                            <comment id="12657588" author="zshao" created="Wed, 17 Dec 2008 22:47:11 +0000"  >&lt;p&gt;Committed revision 727506.&lt;/p&gt;</comment>
                            <comment id="12657589" author="zshao" created="Wed, 17 Dec 2008 22:47:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-170&quot; title=&quot;map-side aggregations does not work properly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-170&quot;&gt;&lt;del&gt;HIVE-170&lt;/del&gt;&lt;/a&gt;. Map-side aggregations to estimate memory size. (Namit via zshao)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12410216">HIVE-135</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12395914" name="170.patch" size="12171" author="namit" created="Fri, 12 Dec 2008 07:21:56 +0000"/>
                            <attachment id="12396338" name="patch.170.3" size="17796" author="namit" created="Wed, 17 Dec 2008 19:10:10 +0000"/>
                            <attachment id="12396135" name="patch.2" size="17738" author="namit" created="Mon, 15 Dec 2008 22:52:28 +0000"/>
                            <attachment id="12395963" name="patch2" size="12171" author="namit" created="Fri, 12 Dec 2008 19:14:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>73732</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 49 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0l8an:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>121994</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>