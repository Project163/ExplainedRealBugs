<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:25:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-28042] DigestMD5 token expired or does not exist error while opening a new connection to HMS</title>
                <link>https://issues.apache.org/jira/browse/HIVE-28042</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;In our deployment we are facing the following exception in the HMS logs when a HMS connection is opened from the HS2 in cases where a session is open for a long time leading to query failures:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2024-01-24T02:11:21,324 ERROR [TThreadPoolServer WorkerProcess-760394]: transport.TSaslTransport (TSaslTransport.java:open) - SASL negotiation failurejavax.security.sasl.SaslException: DIGEST-MD5: IO error acquiring password&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at com.sun.security.sasl.digest.DigestMD5Server.validateClientResponse(DigestMD5Server.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at com.sun.security.sasl.digest.DigestMD5Server.evaluateResponse(DigestMD5Server.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.thrift.transport.TSaslTransport$SaslParticipant.evaluateChallengeOrResponse(TSaslTransport.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.thrift.transport.TSaslTransport.open(TSaslTransport.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.thrift.transport.TSaslServerTransport.open(TSaslServerTransport.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.thrift.transport.TSaslServerTransport$Factory.getTransport(TSaslServerTransport.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.hadoop.hive.metastore.security.HadoopThriftAuthBridge$Server$TUGIAssumingTransportFactory$1.run(HadoopThriftAuthBridge.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.hadoop.hive.metastore.security.HadoopThriftAuthBridge$Server$TUGIAssumingTransportFactory$1.run(HadoopThriftAuthBridge.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at java.security.AccessController.doPrivileged(Native Method)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at javax.security.auth.Subject.doAs(Subject.javA)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.hadoop.hive.metastore.security.HadoopThriftAuthBridge$Server$TUGIAssumingTransportFactory.getTransport(HadoopThriftAuthBridge.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java)Caused by: org.apache.hadoop.security.token.SecretManager$InvalidToken: token expired or does not exist: HIVE_DELEGATION_TOKEN owner=***, renewer=***, realUser=*****************, issueDate=1705973286139, maxDate=1706578086139, sequenceNumber=3294063, masterKeyId=7601&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.hadoop.hive.metastore.security.TokenStoreDelegationTokenSecretManager.retrievePassword(TokenStoreDelegationTokenSecretManager.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.hadoop.hive.metastore.security.TokenStoreDelegationTokenSecretManager.retrievePassword(TokenStoreDelegationTokenSecretManager.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.hadoop.hive.metastore.security.HadoopThriftAuthBridge$Server$SaslDigestCallbackHandler.getPassword(HadoopThriftAuthBridge.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.hadoop.hive.metastore.security.HadoopThriftAuthBridge$Server$SaslDigestCallbackHandler.handle(HadoopThriftAuthBridge.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at com.sun.security.sasl.digest.DigestMD5Server.validateClientResponse(DigestMD5Server.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; ... 15 more &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13566482">HIVE-28042</key>
            <summary>DigestMD5 token expired or does not exist error while opening a new connection to HMS</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vikramahuja_">Vikram Ahuja</assignee>
                                    <reporter username="vikramahuja_">Vikram Ahuja</reporter>
                        <labels>
                            <label>hive-4.0.1-merged</label>
                            <label>hive-4.0.1-must</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 29 Jan 2024 08:37:19 +0000</created>
                <updated>Wed, 5 Nov 2025 13:20:38 +0000</updated>
                            <resolved>Mon, 22 Jul 2024 16:01:37 +0000</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                    <fixVersion>4.0.1</fixVersion>
                                    <component>Standalone Metastore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17812151" author="vikramahuja_" created="Tue, 30 Jan 2024 05:43:39 +0000"  >&lt;p&gt;&lt;b&gt;Another instance of this issue:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2024-01-24T02:11:21,324 ERROR [TThreadPoolServer WorkerProcess-760394]: transport.TSaslTransport (TSaslTransport.java:open) 
- SASL negotiation failurejavax.security.sasl.SaslException: DIGEST-MD5: IO error acquiring password
at com.sun.security.sasl.digest.DigestMD5Server.validateClientResponse(DigestMD5Server.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at com.sun.security.sasl.digest.DigestMD5Server.evaluateResponse(DigestMD5Server.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.thrift.transport.TSaslTransport$SaslParticipant.evaluateChallengeOrResponse(TSaslTransport.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.thrift.transport.TSaslTransport.open(TSaslTransport.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.thrift.transport.TSaslServerTransport.open(TSaslServerTransport.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.thrift.transport.TSaslServerTransport$Factory.getTransport(TSaslServerTransport.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.hadoop.hive.metastore.security.HadoopThriftAuthBridge$Server$TUGIAssumingTransportFactory$1.run(HadoopThriftAuthBridge.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.hadoop.hive.metastore.security.HadoopThriftAuthBridge$Server$TUGIAssumingTransportFactory$1.run(HadoopThriftAuthBridge.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at java.security.AccessController.doPrivileged(Native Method)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at javax.security.auth.Subject.doAs(Subject.javA)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.hadoop.hive.metastore.security.HadoopThriftAuthBridge$Server$TUGIAssumingTransportFactory.getTransport(HadoopThriftAuthBridge.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java)Caused by: org.apache.hadoop.security.token.SecretManager$InvalidToken: token expired or does not exist: HIVE_DELEGATION_TOKEN owner=***, renewer=***, realUser=*****************, issueDate=1705973286139, maxDate=1706578086139, sequenceNumber=3294063, masterKeyId=7601&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.hadoop.hive.metastore.security.TokenStoreDelegationTokenSecretManager.retrievePassword(TokenStoreDelegationTokenSecretManager.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.hadoop.hive.metastore.security.TokenStoreDelegationTokenSecretManager.retrievePassword(TokenStoreDelegationTokenSecretManager.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.hadoop.hive.metastore.security.HadoopThriftAuthBridge$Server$SaslDigestCallbackHandler.getPassword(HadoopThriftAuthBridge.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
at org.apache.hadoop.hive.metastore.security.HadoopThriftAuthBridge$Server$SaslDigestCallbackHandler.handle(HadoopThriftAuthBridge.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; at com.sun.security.sasl.digest.DigestMD5Server.validateClientResponse(DigestMD5Server.java)&#160;&#160;&#160;&#160;&#160;&#160;&#160; ... 15 more &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Analysis of the issue:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;This particular issue is only happening when the HS2 tries to open a new Digest MD5 based Thrift TSaslClientTransport in cases where the session is open for a long time. In such cases whenever a new transport is opened it actually tries to authenticate and uses a retrieve password call with the token that it is storing in the tokenStore, The tokenStore has zookeeper, DB and memory based implementation. However this issue is regardless of the implementations.&lt;/p&gt;

&lt;p&gt;HS2 uses the same metaStoreClient object across all the connections that is embedded in Hive.java but in some cases we have observed that is recreating a new metaStoreClient with a fresh connection(TSaslClientTransport). Two use cases that I discovered which were leading to these issues were:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;MSCK repair&lt;/li&gt;
		&lt;li&gt;RetryingMetaStoreClient in case of any HMS issues(applicable to any sql query which interacts with the HMS)&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Root cause of this issue:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;There is a background thread called ExpiredTokenRemover running in HMS (class: TokenStoreDelegationTokenSecretManager.java ). This expiry thread itself is removing the token from the tokenStore after the renewal time has passed and also removing it after expiry time, but is should only remove it post expiry time as the token can be renewed till then.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Will be raising a fix for the same by changing the code where token is deleted after renewal time itself has passed.&lt;/p&gt;</comment>
                            <comment id="17812159" author="vikramahuja_" created="Tue, 30 Jan 2024 06:22:28 +0000"  >&lt;p&gt;Raised PR: &lt;a href=&quot;https://github.com/apache/hive/pull/5049&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/pull/5049&lt;/a&gt; for the same&lt;/p&gt;</comment>
                            <comment id="17812178" author="zhangbutao" created="Tue, 30 Jan 2024 07:47:35 +0000"  >&lt;p&gt;&#160;Just thinking aloud. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;set hive.cluster.delegation.token.store.class=org.apache.hadoop.hive.metastore.security.DBTokenStore;&lt;/p&gt;

&lt;p&gt;Did you try to use DBTokenStore to store the token info? Maybe it is better than the default token store MemoryTokenStore, maybe it can fix your issue?&lt;/p&gt;</comment>
                            <comment id="17812191" author="vikramahuja_" created="Tue, 30 Jan 2024 08:25:47 +0000"  >&lt;p&gt;Thanks for the comment, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhangbutao&quot; class=&quot;user-hover&quot; rel=&quot;zhangbutao&quot;&gt;zhangbutao&lt;/a&gt; . The tokenStore has zookeeper, DB and memory based implementations. We are using Zookeeper based implementation in our scenarios.&lt;/p&gt;

&lt;p&gt;However this issue is regardless of the TokenStore&apos;s implementation(zookeeper, DB and memory). The expiry thread that is removing token is also removing tokens post renewal date irrespective of tokenStore Implementation.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17867795" author="chinnalalam" created="Mon, 22 Jul 2024 16:01:37 +0000"  >&lt;p&gt;&lt;font color=&quot;#172b4d&quot;&gt;Merged to master !! Thanks for the &lt;/font&gt;&lt;font color=&quot;#172b4d&quot;&gt;PR &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vikramahuja_&quot; class=&quot;user-hover&quot; rel=&quot;vikramahuja_&quot;&gt;vikramahuja_&lt;/a&gt;&#160;&lt;/font&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13610439">HIVE-28797</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13071628" name="HIVE-28042 - DigestMD5 error during opening connection to HMS.pdf" size="320476" author="vikramahuja_" created="Wed, 18 Sep 2024 10:49:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 16 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1n22o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>