<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:24:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-8188] ExprNodeGenericFuncEvaluator::_evaluate() loads class annotations in a tight loop</title>
                <link>https://issues.apache.org/jira/browse/HIVE-8188</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;When running a near-constant UDF, most of the CPU is burnt within the VM trying to read the class annotations for every row.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12669934/12669934_udf-deterministic.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12742654">HIVE-8188</key>
            <summary>ExprNodeGenericFuncEvaluator::_evaluate() loads class annotations in a tight loop</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gopalv">Gopal Vijayaraghavan</assignee>
                                    <reporter username="gopalv">Gopal Vijayaraghavan</reporter>
                        <labels>
                            <label>Performance</label>
                    </labels>
                <created>Fri, 19 Sep 2014 06:36:58 +0000</created>
                <updated>Mon, 8 Feb 2016 08:30:53 +0000</updated>
                            <resolved>Thu, 25 Sep 2014 19:38:27 +0000</resolved>
                                    <version>0.14.0</version>
                                    <fixVersion>0.14.0</fixVersion>
                                    <component>UDF</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14140154" author="prasanth_j" created="Fri, 19 Sep 2014 07:54:46 +0000"  >&lt;p&gt;I think its because hash-aggregation needs to estimate the size of the hash map. The values of the hashmaps are UDAFs whose aggregation buffer size can be estimated if the aggregation buffer has this annotation &quot;@AggregationType(estimable = true)&quot;. GroupByOperator.shouldBeFlushed() is called for every row that is added to hash map. shouldBeFlushed() calls isEstimable() helper function which uses reflection every time to see if the aggregation function is estimable. Not sure why it is done this way but yes this will be slow as hell. This needs to be fixed.&lt;/p&gt;</comment>
                            <comment id="14140232" author="prasanth_j" created="Fri, 19 Sep 2014 09:22:00 +0000"  >&lt;p&gt;I tried to avoid this reflection invocation multiple times in inner loop by computing total aggregation size once and reusing it in inner loop. I ran the following query&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;select ss_quantity, ss_store_sk, ss_promo_sk, count(ss_list_price), count(ss_sales_price), sum(ss_ext_sales_price) from store_sales_orc group by ss_quantity,ss_store_sk,ss_promo_sk;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;store_sales had 2880404 rows. The original execution time was 18.5s and with the above changes the time went down to 15.5s which is ~17% gain which explains the reflection cost from the attached image.&lt;/p&gt;</comment>
                            <comment id="14141095" author="gopalv" created="Fri, 19 Sep 2014 19:02:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt;: that is pretty neat, speedup.&lt;/p&gt;

&lt;p&gt;But that&apos;s not the place I found the fix in, it was in isDeterministic() within the Constant codepath in ExprNode evaluator.&lt;/p&gt;</comment>
                            <comment id="14141099" author="prasanth_j" created="Fri, 19 Sep 2014 19:04:52 +0000"  >&lt;p&gt;Looking at the attached PNG (GBY + Reflection), I thought its UDAF that uses reflection in inner loop. Looks like many places needs improvement then. &lt;/p&gt;</comment>
                            <comment id="14142300" author="hiveqa" created="Sun, 21 Sep 2014 02:20:20 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12670244/HIVE-8188.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12670244/HIVE-8188.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 1 failed/errored test(s), 6298 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.ql.parse.TestParse.testParse_union
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/904/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/904/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/904/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/904/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-904/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-904/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 1 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12670244&lt;/p&gt;</comment>
                            <comment id="14147477" author="hagleitn" created="Thu, 25 Sep 2014 06:42:07 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14147481" author="hagleitn" created="Thu, 25 Sep 2014 06:46:04 +0000"  >&lt;p&gt;on commit, you might want to add some comments saying that annotation lookups are expensive and that isDeterministic and isEstimable cannot change while running through the op pipeline.&lt;/p&gt;</comment>
                            <comment id="14148201" author="hagleitn" created="Thu, 25 Sep 2014 19:38:27 +0000"  >&lt;p&gt;Committed to trunk.&lt;/p&gt;</comment>
                            <comment id="14148225" author="hagleitn" created="Thu, 25 Sep 2014 19:59:29 +0000"  >&lt;p&gt;Committed to .14 branch.&lt;/p&gt;</comment>
                            <comment id="14148539" author="navis" created="Fri, 26 Sep 2014 00:29:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt; The original patch didn&apos;t used annotation, but a reviewer wanted that to be an annotation. So I&apos;ve just replaced instanceOf to isEstimable(), not thinking deeper. Thing had done like that. Still my bad.&lt;/p&gt;</comment>
                            <comment id="14148558" author="prasanth_j" created="Fri, 26 Sep 2014 00:49:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=navis&quot; class=&quot;user-hover&quot; rel=&quot;navis&quot;&gt;navis&lt;/a&gt; Looking for annotation using reflection one time is not a big problem. But using it in inner loop (as it was done in Group By) is &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14148581" author="gopalv" created="Fri, 26 Sep 2014 01:10:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=navis&quot; class=&quot;user-hover&quot; rel=&quot;navis&quot;&gt;navis&lt;/a&gt;: No worries, took a special benchmark run to catch this.&lt;/p&gt;

&lt;p&gt;I&apos;m trying to catch anything that looks like a .14 regression before the RC goes out - the UDF that hit this case was the NOW() UDF patch.&lt;/p&gt;</comment>
                            <comment id="14210641" author="thejas" created="Thu, 13 Nov 2014 19:41:51 +0000"  >&lt;p&gt;This has been fixed in 0.14 release. Please open new jira if you see any issues.&lt;/p&gt;</comment>
                            <comment id="15134050" author="spring" created="Fri, 5 Feb 2016 12:01:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hagleitn&quot; class=&quot;user-hover&quot; rel=&quot;hagleitn&quot;&gt;hagleitn&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thejas&quot; class=&quot;user-hover&quot; rel=&quot;thejas&quot;&gt;thejas&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;GenericUDAFEvaluator.isEstimable(agg) always returns false, because annotation AggregationType has default RetentionPolicy.CLASS and cannot  be  retained by the VM at run time.&lt;/p&gt;

&lt;p&gt;As result estimate method will never be executed.&lt;/p&gt;

&lt;p&gt;I am going to open new jira issue, if no objections&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12745062">HIVE-8313</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12937437">HIVE-13021</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12670243" name="HIVE-8188.1.patch" size="1652" author="gopalv" created="Sat, 20 Sep 2014 19:06:01 +0000"/>
                            <attachment id="12670244" name="HIVE-8188.2.patch" size="5194" author="gopalv" created="Sat, 20 Sep 2014 19:07:32 +0000"/>
                            <attachment id="12669934" name="udf-deterministic.png" size="108479" author="gopalv" created="Fri, 19 Sep 2014 06:37:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 41 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i208rr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>