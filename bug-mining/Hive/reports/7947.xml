<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:19:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-24957] Wrong results when subquery has COALESCE in correlation predicate</title>
                <link>https://issues.apache.org/jira/browse/HIVE-24957</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Consider the following example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt; author (
    a_authorkey   &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;,
    a_name &lt;span class=&quot;code-keyword&quot;&gt;varchar&lt;/span&gt;(50));

&lt;span class=&quot;code-keyword&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt; book (
    b_bookkey   &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;,
    b_title &lt;span class=&quot;code-keyword&quot;&gt;varchar&lt;/span&gt;(50),
    b_authorkey &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;);

&lt;span class=&quot;code-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;into&lt;/span&gt; author &lt;span class=&quot;code-keyword&quot;&gt;values&lt;/span&gt; (10, &lt;span class=&quot;code-quote&quot;&gt;&apos;Victor Hugo&apos;&lt;/span&gt;);
&lt;span class=&quot;code-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;into&lt;/span&gt; author &lt;span class=&quot;code-keyword&quot;&gt;values&lt;/span&gt; (20, &lt;span class=&quot;code-quote&quot;&gt;&apos;Alexandre Dumas&apos;&lt;/span&gt;);
&lt;span class=&quot;code-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;into&lt;/span&gt; author &lt;span class=&quot;code-keyword&quot;&gt;values&lt;/span&gt; (300, &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;UNKNOWN&lt;/span&gt;&apos;&lt;/span&gt;);

&lt;span class=&quot;code-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;into&lt;/span&gt; book &lt;span class=&quot;code-keyword&quot;&gt;values&lt;/span&gt; (1, &lt;span class=&quot;code-quote&quot;&gt;&apos;Les Miserables&apos;&lt;/span&gt;, 10);
&lt;span class=&quot;code-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;into&lt;/span&gt; book &lt;span class=&quot;code-keyword&quot;&gt;values&lt;/span&gt; (2, &lt;span class=&quot;code-quote&quot;&gt;&apos;The &lt;span class=&quot;code-keyword&quot;&gt;Count&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;of&lt;/span&gt; Monte Cristo&apos;&lt;/span&gt;, 20);
&lt;span class=&quot;code-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;into&lt;/span&gt; book &lt;span class=&quot;code-keyword&quot;&gt;values&lt;/span&gt; (3, &lt;span class=&quot;code-quote&quot;&gt;&apos;Men &lt;span class=&quot;code-keyword&quot;&gt;Without&lt;/span&gt; Women&apos;&lt;/span&gt;, 30);
&lt;span class=&quot;code-keyword&quot;&gt;insert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;into&lt;/span&gt; book &lt;span class=&quot;code-keyword&quot;&gt;values&lt;/span&gt; (4, &lt;span class=&quot;code-quote&quot;&gt;&apos;Odyssey&apos;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);

&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; b.b_title
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; book b
&lt;span class=&quot;code-keyword&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;exists&lt;/span&gt;
          (&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; a_authorkey
           &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; author &lt;span class=&quot;code-keyword&quot;&gt;a&lt;/span&gt;
           &lt;span class=&quot;code-keyword&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;coalesce&lt;/span&gt;(b.b_authorkey, 300) = &lt;span class=&quot;code-keyword&quot;&gt;a&lt;/span&gt;.a_authorkey);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Expected results&lt;/b&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;B_TITLE&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Les Miserables&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;The Count of Monte Cristo&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Odyssey&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&lt;b&gt;Actual results&lt;/b&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;B_TITLE&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Les Miserables&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;The Count of Monte Cristo&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&lt;tt&gt;Odyssey&lt;/tt&gt; is missing from the result set and it shouldn&apos;t since with the application of COALESCE operator it should match with the UNKNOWN author.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13368649">HIVE-24957</key>
            <summary>Wrong results when subquery has COALESCE in correlation predicate</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zabetak">Stamatis Zampetakis</assignee>
                                    <reporter username="zabetak">Stamatis Zampetakis</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 30 Mar 2021 13:10:26 +0000</created>
                <updated>Thu, 17 Nov 2022 08:47:36 +0000</updated>
                            <resolved>Thu, 22 Apr 2021 11:21:44 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3000">50m</timespent>
                                <comments>
                            <comment id="17311521" author="zabetak" created="Tue, 30 Mar 2021 13:20:46 +0000"  >&lt;p&gt;The problem lies in the query plan and more specifically in the &lt;tt&gt;HiveRelDecorrelator&lt;/tt&gt;. &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2021-03-30T06:16:57,682 DEBUG [d8fca83a-1e2a-4864-8730-f496318a0e47 main] rules.RelFieldTrimmer: Plan after trimming unused fields
HiveProject(b_title=[$0])
  HiveFilter(condition=[EXISTS({
HiveProject(a_authorkey=[$0])
  HiveFilter(condition=[=(CASE(IS NOT NULL($cor0.b_authorkey), $cor0.b_authorkey, 300), $0)])
    HiveTableScan(table=[[default, author]], table:alias=[a])
})])
    HiveProject(b_title=[$1], b_authorkey=[$2])
      HiveTableScan(table=[[default, book]], table:alias=[b])

2021-03-30T06:16:57,682 DEBUG [d8fca83a-1e2a-4864-8730-f496318a0e47 main] parse.CalcitePlanner: Plan before removing subquery:
HiveProject(b_title=[$1])
  HiveFilter(condition=[EXISTS({
HiveProject(a_authorkey=[$0])
  HiveFilter(condition=[=(CASE(IS NOT NULL($cor0.b_authorkey), $cor0.b_authorkey, 300), $0)])
    HiveTableScan(table=[[default, author]], table:alias=[a])
})])
    HiveTableScan(table=[[default, book]], table:alias=[b])

2021-03-30T06:16:57,690 DEBUG [d8fca83a-1e2a-4864-8730-f496318a0e47 main] parse.CalcitePlanner: Plan just after removing subquery:
HiveProject(b_title=[$1])
  LogicalCorrelate(correlation=[$cor0], joinType=[semi], requiredColumns=[{2}])
    HiveTableScan(table=[[default, book]], table:alias=[b])
    HiveProject(literalTrue=[true])
      HiveProject(a_authorkey=[$0])
        HiveFilter(condition=[=(CASE(IS NOT NULL($cor0.b_authorkey), $cor0.b_authorkey, 300), $0)])
          HiveTableScan(table=[[default, author]], table:alias=[a])

2021-03-30T06:16:57,796 DEBUG [d8fca83a-1e2a-4864-8730-f496318a0e47 main] parse.CalcitePlanner: Plan after decorrelation:
HiveProject(b_title=[$1])
  HiveSemiJoin(condition=[=($8, $2)], joinType=[semi])
    HiveTableScan(table=[[default, book]], table:alias=[b])
    HiveProject(literalTrue=[true], b_authorkey=[$1])
      HiveProject(a_authorkey=[$0], b_authorkey=[$6])
        HiveJoin(condition=[=(CASE(IS NOT NULL($6), $6, 300), $0)], joinType=[inner], algorithm=[none], cost=[not available])
          HiveTableScan(table=[[default, author]], table:alias=[a])
          HiveAggregate(group=[{0}])
            HiveProject(b_authorkey=[$2])
              HiveTableScan(table=[[default, book]], table:alias=[b])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The problem starts with the introduction of the &lt;tt&gt;HiveSemiJoin&lt;/tt&gt;. Due to that books with NULL &lt;tt&gt;b_authorkey&lt;/tt&gt; are removed from the result set. &lt;/p&gt;</comment>
                            <comment id="17312977" author="kgyrtkirk" created="Thu, 1 Apr 2021 08:12:26 +0000"  >&lt;p&gt;I was wondering if changing the semijoin compare conditional to &lt;tt&gt;&amp;lt;=&amp;gt;&lt;/tt&gt; (is not distinct) would help in this case or not - not sure if we can do I saw some null related comments in the decorrelator...&lt;/p&gt;

&lt;p&gt;it seems to me that we could avoid this issue by materializing the coalesced value before the correlated subq:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
with 
    b as (select *,coalesce(b_authorkey, 300) as bb from book)
select b.b_title
from b
where exists
          (select a_authorkey
           from author a
           where bb = a.a_authorkey);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17313012" author="zabetak" created="Thu, 1 Apr 2021 08:48:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;it seems to me that we could avoid this issue by materializing the coalesced value before the correlated subq:&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kgyrtkirk&quot; class=&quot;user-hover&quot; rel=&quot;kgyrtkirk&quot;&gt;kgyrtkirk&lt;/a&gt;&#160; This is what I thought as well &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;I am building a prototype along this idea.&lt;/p&gt;</comment>
                            <comment id="17327904" author="kkasa" created="Thu, 22 Apr 2021 11:21:44 +0000"  >&lt;p&gt;Pushed to master. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zabetak&quot; class=&quot;user-hover&quot; rel=&quot;zabetak&quot;&gt;zabetak&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13368845">CALCITE-4560</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="13370744">HIVE-24999</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 29 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0pdgo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>