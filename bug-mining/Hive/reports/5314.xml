<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:51:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-15743] vectorized text parsing: speed up double parse</title>
                <link>https://issues.apache.org/jira/browse/HIVE-15743</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Double.parseDouble(
                new String(bytes, fieldStart, fieldLength, StandardCharsets.UTF_8));&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This takes ~25% of the query time in some cases.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13038357">HIVE-15743</key>
            <summary>vectorized text parsing: speed up double parse</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="teddy.choi">Teddy Choi</assignee>
                                    <reporter username="sershe">Sergey Shelukhin</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 Jan 2017 04:14:42 +0000</created>
                <updated>Wed, 27 Mar 2024 12:58:07 +0000</updated>
                            <resolved>Mon, 27 Feb 2017 20:13:43 +0000</resolved>
                                                    <fixVersion>2.3.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15840937" author="sershe" created="Fri, 27 Jan 2017 04:21:01 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mmccline&quot; class=&quot;user-hover&quot; rel=&quot;mmccline&quot;&gt;mmccline&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We can probably just c/p parts of FloatingDecimal - merge the parsing and doubleValue, and change them to operate on byte array. It only needs to recognize like 6-8 letters aside from normal numeric stuff (nan and infinity aside), so we should be safe since we always use utf8&lt;/p&gt;</comment>
                            <comment id="15840955" author="mmccline" created="Fri, 27 Jan 2017 04:37:04 +0000"  >&lt;p&gt;Wow that is a high percentage!&lt;/p&gt;

&lt;p&gt;Ya, I looked at some of those Java runtime classes recently (when I was doing FastDecimal) and it is doable.  All numeric related characters are UTF-8.   There is considerable magic code around exponents, etc in them though but because of that I doubt few people are brave enough to change it.  So, our transformed version would be &quot;relatively safe&quot;.&lt;/p&gt;</comment>
                            <comment id="15842355" author="gopalv" created="Fri, 27 Jan 2017 07:16:47 +0000"  >&lt;p&gt;The CPU cache counters for this issue is available here &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://people.apache.org/~gopalv/llap-perf.tar.bz2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://people.apache.org/~gopalv/llap-perf.tar.bz2&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15846132" author="teddy.choi" created="Mon, 30 Jan 2017 23:25:07 +0000"  >&lt;p&gt;Most of the OpenJDK code is licensed under GPL. I&apos;m not sure whether we can just copy and paste then fix it in ASL.&lt;/p&gt;</comment>
                            <comment id="15846142" author="teddy.choi" created="Mon, 30 Jan 2017 23:30:48 +0000"  >&lt;p&gt;This is an initial implementation. Copy/pasted, and merged code. And made it to use byte arrays. It already showed some performance improvements. I will look deeper for more optimizations.&lt;/p&gt;</comment>
                            <comment id="15846171" author="sershe" created="Mon, 30 Jan 2017 23:53:56 +0000"  >&lt;p&gt;We cannot copy-paste it.&lt;br/&gt;
I think the crucial aspect of a new implementation should be avoiding allocations. Java does at least 3 - String, FloatingDecimal, Double; maybe more, I didn&apos;t read it too closely.&lt;br/&gt;
It would be good to go straight from byte[] to double.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15846175" author="gopalv" created="Mon, 30 Jan 2017 23:55:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure whether we can just copy and paste then fix it in ASL.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, we can&apos;t - this is not a gray area at all. If the implementation is from GPL licensed code, it cannot be committed into Apache at all.&lt;/p&gt;

&lt;p&gt;This feature requires porting a standard dtoa.c from an MIT licensed project, like Mozilla nspr or Python.&lt;/p&gt;</comment>
                            <comment id="15846196" author="gopalv" created="Tue, 31 Jan 2017 00:20:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=teddy.choi&quot; class=&quot;user-hover&quot; rel=&quot;teddy.choi&quot;&gt;teddy.choi&lt;/a&gt;: left one comment on RB anyway - we need to move to a model like your earlier patch, with a DoubleParser object allocated at the start of init for LazySimpleDeserializeRead.&lt;/p&gt;</comment>
                            <comment id="15846235" author="gopalv" created="Tue, 31 Jan 2017 01:00:56 +0000"  >&lt;p&gt;A quick look for a similar API for Double parsing showed up (BSD Licensed)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/bourgesl/jnumbers/tree/master/src/main/java/org/jnumbers&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/bourgesl/jnumbers/tree/master/src/main/java/org/jnumbers&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15846251" author="teddy.choi" created="Tue, 31 Jan 2017 01:15:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt;, Its first page notes that &quot;Note: accuracy of Double/Float parsing is not as good as JDK (1/2 ulp) but is correct (and enough for all-purposes) ~ 2 ulps (ie 5e-16 relative error)&quot;. Will it be okay? Meanwhile, I will try to port strtod from C in BSD. Thank you.&lt;/p&gt;</comment>
                            <comment id="15846728" author="teddy.choi" created="Tue, 31 Jan 2017 12:06:54 +0000"  >&lt;p&gt;I made a patch by porting strtod() in C in BSD. It&apos;s 10x faster, but it has 5e-16 relative errors. I made its unit test to fail to reflect these errors. It will take relatively longer time to make the smallest error in parsing.&lt;/p&gt;</comment>
                            <comment id="15847333" author="sershe" created="Tue, 31 Jan 2017 19:07:39 +0000"  >&lt;p&gt;does there have to be a string, as well as toCharArray? The original code has bytes as input. String creation is actually more than half of the cost of going from byte[] to double (see picture).&lt;/p&gt;

&lt;p&gt;Also, I am not sure how important the precision issue is; however, one thing to suggest, if it&apos;s rare and easy to detect, is to handle the 99% cases fast, and fall back to Double.parse(new String) in exotic/rare cases.&lt;/p&gt;</comment>
                            <comment id="15847429" author="gopalv" created="Tue, 31 Jan 2017 20:14:59 +0000"  >
&lt;p&gt;&amp;gt; String creation is actually more than half of the cost of going from byte[] to double (see picture).&lt;/p&gt;

&lt;p&gt;Specifically, it is a TLAB alloc miss. The code which is there is already ~10x faster, but we can do better by giving up String &amp;amp; assuming utf8 bytes always. &lt;/p&gt;

&lt;p&gt;Also a MutableDouble::parse() would let the system return a (Success, Value) tuple, which should allow for the fall back re-execution pathway to kick in for any failures.&lt;/p&gt;

&lt;p&gt;&amp;gt; if it&apos;s rare and easy to detect, is to handle the 99% cases fast, and fall back to Double.parse(new String) in exotic/rare cases.&lt;/p&gt;

&lt;p&gt;I ran through all the data examples I have from various cases. The largest number of digits in raw data was 18 digits (15,2), with the most common Decimal source pattern hovering around (9,2).&lt;/p&gt;

&lt;p&gt;None of them would be hit by a 2 ULP error, but we can always fall back to original parser for digits &amp;gt; 18.&lt;/p&gt;</comment>
                            <comment id="15849604" author="teddy.choi" created="Thu, 2 Feb 2017 07:52:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt;, that&apos;s a practical idea!&lt;/p&gt;</comment>
                            <comment id="15851322" author="teddy.choi" created="Fri, 3 Feb 2017 10:47:30 +0000"  >&lt;p&gt;This patch uses a byte array to skip encoding. When it gets a number with shorter digits than 16, then it parses faster with double arithmetics. Otherwise, it parses slower with Double.parseDouble. It also has unit tests and a benchmark test.&lt;/p&gt;</comment>
                            <comment id="15851921" author="hiveqa" created="Fri, 3 Feb 2017 18:48:53 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12850813/HIVE-15743.3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12850813/HIVE-15743.3.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 5 failed/errored test(s), 10212 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=235)
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver[encryption_join_with_different_encryption_keys] (batchId=159)
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver (batchId=162)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=223)
org.apache.hadoop.hive.llap.daemon.impl.TestTaskExecutorService.testWaitQueuePreemption (batchId=278)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/3357/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/3357/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/3357/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/3357/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-3357/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-3357/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12850813 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15853081" author="teddy.choi" created="Sun, 5 Feb 2017 02:51:42 +0000"  >&lt;p&gt;This patch applies Sergey&apos;s feedback. It uses a trimed string for precision check, and limits strtod(String) for testing only.&lt;/p&gt;</comment>
                            <comment id="15853106" author="hiveqa" created="Sun, 5 Feb 2017 04:42:21 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12851060/HIVE-15743.4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12851060/HIVE-15743.4.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 7 failed/errored test(s), 10225 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=235)
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver[encryption_join_with_different_encryption_keys] (batchId=159)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[schema_evol_text_vec_table] (batchId=147)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_varchar_simple] (batchId=153)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=223)
org.apache.hadoop.hive.cli.TestSparkNegativeCliDriver.org.apache.hadoop.hive.cli.TestSparkNegativeCliDriver (batchId=230)
org.apache.hadoop.hive.llap.daemon.impl.TestTaskExecutorService.testWaitQueuePreemption (batchId=277)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/3381/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/3381/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/3381/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/3381/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-3381/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-3381/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 7 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12851060 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15854630" author="sershe" created="Mon, 6 Feb 2017 19:56:15 +0000"  >&lt;p&gt;+1 cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15881743" author="sershe" created="Fri, 24 Feb 2017 01:38:36 +0000"  >&lt;p&gt;Hmm... should this be committed?&lt;/p&gt;</comment>
                            <comment id="15884594" author="teddy.choi" created="Sun, 26 Feb 2017 07:36:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt;, please proceed. Thank you.&lt;/p&gt;</comment>
                            <comment id="15886455" author="sershe" created="Mon, 27 Feb 2017 20:13:43 +0000"  >&lt;p&gt;Committed to master. Thanks for the patch!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13049305">HIVE-16148</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13573526">HIVE-28155</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12850082" name="HIVE-15743.1.patch" size="77394" author="teddy.choi" created="Mon, 30 Jan 2017 23:30:47 +0000"/>
                            <attachment id="12850184" name="HIVE-15743.2.patch" size="11777" author="teddy.choi" created="Tue, 31 Jan 2017 12:06:54 +0000"/>
                            <attachment id="12850813" name="HIVE-15743.3.patch" size="13364" author="teddy.choi" created="Fri, 3 Feb 2017 10:47:30 +0000"/>
                            <attachment id="12851060" name="HIVE-15743.4.patch" size="13392" author="teddy.choi" created="Sun, 5 Feb 2017 02:51:42 +0000"/>
                            <attachment id="12849643" name="tpch-without.png" size="283865" author="sershe" created="Fri, 27 Jan 2017 04:15:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 38 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39aan:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>