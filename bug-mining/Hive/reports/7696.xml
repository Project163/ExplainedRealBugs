<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:17:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-23873] Querying Hive JDBCStorageHandler table fails with NPE when CBO is off</title>
                <link>https://issues.apache.org/jira/browse/HIVE-23873</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Scenario is Hive table having same schema as table in Oracle, however when we query the table with data it fails with NPE, below is the trace.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.io.IOException: java.lang.NullPointerException
        at org.apache.hadoop.hive.ql.exec.FetchOperator.getNextRow(FetchOperator.java:617) ~[hive-exec-3.1.0.3.1.5.0-152.jar:3.1.0.3.1.5.0-152]
        at org.apache.hadoop.hive.ql.exec.FetchOperator.pushRow(FetchOperator.java:524) ~[hive-exec-3.1.0.3.1.5.0-152.jar:3.1.0.3.1.5.0-152]
        at org.apache.hadoop.hive.ql.exec.FetchTask.fetch(FetchTask.java:146) ~[hive-exec-3.1.0.3.1.5.0-152.jar:3.1.0.3.1.5.0-152]
        at org.apache.hadoop.hive.ql.Driver.getResults(Driver.java:2739) ~[hive-exec-3.1.0.3.1.5.0-152.jar:3.1.0.3.1.5.0-152]
        at org.apache.hadoop.hive.ql.reexec.ReExecDriver.getResults(ReExecDriver.java:229) ~[hive-exec-3.1.0.3.1.5.0-152.jar:3.1.0.3.1.5.0-152]
        at org.apache.hive.service.cli.operation.SQLOperation.getNextRowSet(SQLOperation.java:473) ~[hive-service-3.1.0.3.1.5.0-152.jar:3.1.0.3.1.5.0-152]
        ... 34 more
Caused by: java.lang.NullPointerException
        at org.apache.hive.storage.jdbc.JdbcSerDe.deserialize(JdbcSerDe.java:164) ~[hive-jdbc-handler-3.1.0.3.1.5.0-152.jar:3.1.0.3.1.5.0-152]
        at org.apache.hadoop.hive.ql.exec.FetchOperator.getNextRow(FetchOperator.java:598) ~[hive-exec-3.1.0.3.1.5.0-152.jar:3.1.0.3.1.5.0-152]
        at org.apache.hadoop.hive.ql.exec.FetchOperator.pushRow(FetchOperator.java:524) ~[hive-exec-3.1.0.3.1.5.0-152.jar:3.1.0.3.1.5.0-152]
        at org.apache.hadoop.hive.ql.exec.FetchTask.fetch(FetchTask.java:146) ~[hive-exec-3.1.0.3.1.5.0-152.jar:3.1.0.3.1.5.0-152]
        at org.apache.hadoop.hive.ql.Driver.getResults(Driver.java:2739) ~[hive-exec-3.1.0.3.1.5.0-152.jar:3.1.0.3.1.5.0-152]
        at org.apache.hadoop.hive.ql.reexec.ReExecDriver.getResults(ReExecDriver.java:229) ~[hive-exec-3.1.0.3.1.5.0-152.jar:3.1.0.3.1.5.0-152]
        at org.apache.hive.service.cli.operation.SQLOperation.getNextRowSet(SQLOperation.java:473) ~[hive-service-3.1.0.3.1.5.0-152.jar:3.1.0.3.1.5.0-152]
        ... 34 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Problem appears when column names in Oracle are in Upper case and since in Hive, table and column names are forced to store in lowercase during creation. User runs into NPE error while fetching data.&lt;/p&gt;

&lt;p&gt;While deserializing data, input consists of column names in lower case which fails to get the value&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/hive/blob/rel/release-3.1.2/jdbc-handler/src/main/java/org/apache/hive/storage/jdbc/JdbcSerDe.java#L136&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/rel/release-3.1.2/jdbc-handler/src/main/java/org/apache/hive/storage/jdbc/JdbcSerDe.java#L136&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
rowVal = ((ObjectWritable)value).get();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Log Snio:&lt;br/&gt;
=============&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-07-17T16:49:09,598 INFO  [04ed42ec-91d2-4662-aee7-37e840a06036 HiveServer2-Handler-Pool: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-104]: dao.GenericJdbcDatabaseAccessor (:()) - Query to execute is [select * from TESTHIVEJDBCSTORAGE]
2020-07-17T16:49:10,642 INFO  [04ed42ec-91d2-4662-aee7-37e840a06036 HiveServer2-Handler-Pool: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-104]: jdbc.JdbcSerDe (:()) - *** ColumnKey = ID
2020-07-17T16:49:10,642 INFO  [04ed42ec-91d2-4662-aee7-37e840a06036 HiveServer2-Handler-Pool: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-104]: jdbc.JdbcSerDe (:()) - *** Blob value = {fname=OW[class=&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,value=Name1], id=OW[class=&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;,value=1]}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Simple Reproducer for this case.&lt;br/&gt;
=============&lt;br/&gt;
1. Create table in Oracle&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
create table TESTHIVEJDBCSTORAGE(ID INT, FNAME VARCHAR(20));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2. Insert dummy data.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Insert into TESTHIVEJDBCSTORAGE values (1, &lt;span class=&quot;code-quote&quot;&gt;&apos;Name1&apos;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3. Create JDBCStorageHandler table in Hive.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE EXTERNAL TABLE &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.TESTHIVEJDBCSTORAGE_HIVE_TBL (ID INT, FNAME VARCHAR(20)) 
STORED BY &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.hive.storage.jdbc.JdbcStorageHandler&apos;&lt;/span&gt; 
TBLPROPERTIES ( 
&lt;span class=&quot;code-quote&quot;&gt;&quot;hive.sql.database.type&quot;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&quot;ORACLE&quot;&lt;/span&gt;, 
&lt;span class=&quot;code-quote&quot;&gt;&quot;hive.sql.jdbc.driver&quot;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&quot;oracle.jdbc.OracleDriver&quot;&lt;/span&gt;, 
&lt;span class=&quot;code-quote&quot;&gt;&quot;hive.sql.jdbc.url&quot;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&quot;jdbc:oracle:thin:@orachehostname/XE&quot;&lt;/span&gt;, 
&lt;span class=&quot;code-quote&quot;&gt;&quot;hive.sql.dbcp.username&quot;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&quot;chiran&quot;&lt;/span&gt;, 
&lt;span class=&quot;code-quote&quot;&gt;&quot;hive.sql.dbcp.password&quot;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&quot;supersecurepassword&quot;&lt;/span&gt;, 
&lt;span class=&quot;code-quote&quot;&gt;&quot;hive.sql.table&quot;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&quot;TESTHIVEJDBCSTORAGE&quot;&lt;/span&gt;, 
&lt;span class=&quot;code-quote&quot;&gt;&quot;hive.sql.dbcp.maxActive&quot;&lt;/span&gt; = &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt; 
);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;4. Query Hive table, fails with NPE.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;gt; select * from &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.TESTHIVEJDBCSTORAGE_HIVE_TBL;
INFO  : Compiling command(queryId=hive_20200717164857_cd6f5020-4a69-4a2d-9e63-9db99d0121bc): select * from &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.TESTHIVEJDBCSTORAGE_HIVE_TBL
INFO  : Semantic Analysis Completed (retrial = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
INFO  : Returning Hive schema: Schema(fieldSchemas:[FieldSchema(name:testhivejdbcstorage_hive_tbl.id, type:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, comment:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;), FieldSchema(name:testhivejdbcstorage_hive_tbl.fname, type:varchar(20), comment:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)], properties:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
INFO  : Completed compiling command(queryId=hive_20200717164857_cd6f5020-4a69-4a2d-9e63-9db99d0121bc); Time taken: 9.914 seconds
INFO  : Executing command(queryId=hive_20200717164857_cd6f5020-4a69-4a2d-9e63-9db99d0121bc): select * from &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.TESTHIVEJDBCSTORAGE_HIVE_TBL
INFO  : Completed executing command(queryId=hive_20200717164857_cd6f5020-4a69-4a2d-9e63-9db99d0121bc); Time taken: 0.019 seconds
INFO  : OK
Error: java.io.IOException: java.lang.NullPointerException (state=,code=0)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Assuming that there are no repercussions, can we convert the column names to lowercase fetched from Database/Query pointing to table in JDBCStorageHandler?&lt;br/&gt;
Attaching the patch for the case.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13317458">HIVE-23873</key>
            <summary>Querying Hive JDBCStorageHandler table fails with NPE when CBO is off</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chiran54321">Chiran Ravani</assignee>
                                    <reporter username="chiran54321">Chiran Ravani</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 17 Jul 2020 17:06:46 +0000</created>
                <updated>Tue, 27 Feb 2024 22:24:02 +0000</updated>
                            <resolved>Mon, 3 Aug 2020 14:41:26 +0000</resolved>
                                    <version>3.1.0</version>
                    <version>3.1.1</version>
                    <version>3.1.2</version>
                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                    <component>HiveServer2</component>
                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="17160110" author="srahman" created="Fri, 17 Jul 2020 17:51:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chiran54321&quot; class=&quot;user-hover&quot; rel=&quot;chiran54321&quot;&gt;chiran54321&lt;/a&gt; Do you see the same issue with hive master branch?&lt;/p&gt;</comment>
                            <comment id="17160324" author="chiran54321" created="Sat, 18 Jul 2020 03:48:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srahman&quot; class=&quot;user-hover&quot; rel=&quot;srahman&quot;&gt;srahman&lt;/a&gt; Yes, problem exists with Master branch too. Going by Code, it does not seem we are handling column name case conversion in Master branch.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-07-18T03:44:39,678 INFO  [83565622-bc0d-4dbd-b463-88188d46b64e main]: dao.GenericJdbcDatabaseAccessor (:()) - Query to execute is [select * from TESTHIVEJDBCSTORAGE]
2020-07-18T03:44:39,898 ERROR [83565622-bc0d-4dbd-b463-88188d46b64e main]: CliDriver (:()) - Failed with exception java.io.IOException:java.lang.NullPointerException
java.io.IOException: java.lang.NullPointerException
        at org.apache.hadoop.hive.ql.exec.FetchOperator.getNextRow(FetchOperator.java:638)
        at org.apache.hadoop.hive.ql.exec.FetchOperator.pushRow(FetchOperator.java:545)
        at org.apache.hadoop.hive.ql.exec.FetchTask.fetch(FetchTask.java:150)
        at org.apache.hadoop.hive.ql.Driver.getResults(Driver.java:603)
        at org.apache.hadoop.hive.ql.reexec.ReExecDriver.getResults(ReExecDriver.java:243)
        at org.apache.hadoop.hive.cli.CliDriver.processLocalCmd(CliDriver.java:277)
        at org.apache.hadoop.hive.cli.CliDriver.processCmd1(CliDriver.java:201)
        at org.apache.hadoop.hive.cli.CliDriver.processCmd(CliDriver.java:127)
        at org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:422)
        at org.apache.hadoop.hive.cli.CliDriver.executeDriver(CliDriver.java:862)
        at org.apache.hadoop.hive.cli.CliDriver.run(CliDriver.java:798)
        at org.apache.hadoop.hive.cli.CliDriver.main(CliDriver.java:717)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:498)
        at org.apache.hadoop.util.RunJar.run(RunJar.java:318)
        at org.apache.hadoop.util.RunJar.main(RunJar.java:232)
Caused by: java.lang.NullPointerException
        at org.apache.hive.storage.jdbc.JdbcSerDe.deserialize(JdbcSerDe.java:235)
        at org.apache.hadoop.hive.ql.exec.FetchOperator.getNextRow(FetchOperator.java:619)
        ... 17 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17161068" author="srahman" created="Mon, 20 Jul 2020 09:32:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chiran54321&quot; class=&quot;user-hover&quot; rel=&quot;chiran54321&quot;&gt;chiran54321&lt;/a&gt; Interesting... We do have a qtest external_jdbc_table4.q which cover the above use case and it passes.  Assuming the above stack Trace was generated with master hive branch, had there been a case sensitive issue &lt;a href=&quot;https://github.com/apache/hive/blob/master/jdbc-handler/src/main/java/org/apache/hive/storage/jdbc/JdbcSerDe.java#L229&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/master/jdbc-handler/src/main/java/org/apache/hive/storage/jdbc/JdbcSerDe.java#L229&lt;/a&gt; , value should be null and ultimately the the rowVal will be set to null &lt;a href=&quot;https://github.com/apache/hive/blob/master/jdbc-handler/src/main/java/org/apache/hive/storage/jdbc/JdbcSerDe.java#L233&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/master/jdbc-handler/src/main/java/org/apache/hive/storage/jdbc/JdbcSerDe.java#L233&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="17161674" author="chiran54321" created="Tue, 21 Jul 2020 02:46:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srahman&quot; class=&quot;user-hover&quot; rel=&quot;srahman&quot;&gt;srahman&lt;/a&gt; Thanks for adding more light to it.  I am now able to further narrow down the issue with CBO. The problem appears only when CBO is off.  Below is the query run with CBO on for Derby.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
20/07/20 19:49:18 [787073ad-c44e-4e04-8cfb-ba49e14602a0 main]: INFO dao.GenericJdbcDatabaseAccessor: Query to execute is [SELECT &lt;span class=&quot;code-quote&quot;&gt;&quot;IKEY&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;bkey&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;fkey&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;dkey&quot;&lt;/span&gt;
FROM &lt;span class=&quot;code-quote&quot;&gt;&quot;EXTERNAL_JDBC_SIMPLE_DERBY2_TABLE1&quot;&lt;/span&gt;]
20/07/20 19:49:18 [Hive Hook Proto Log Writer 0]: INFO zlib.ZlibFactory: Successfully loaded &amp;amp; initialized &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;-zlib library
20/07/20 19:49:18 [Hive Hook Proto Log Writer 0]: INFO compress.CodecPool: Got brand-&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; compressor [.deflate]
20/07/20 19:49:18 [787073ad-c44e-4e04-8cfb-ba49e14602a0 main]: INFO jdbc.JdbcSerDe: **** Blob data = {dkey=OW[class=&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;,value=20.0], bkey=OW[class=&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;,value=20], fkey=OW[class=&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;Float&lt;/span&gt;,value=20.0], IKEY=OW[class=&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;,value=20]}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When turning off CBO, query picked is Select * and problem appears.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
20/07/21 03:08:44 [ce531fd3-ca3f-4dc4-8681-3cf1233f27df main]: INFO jdbc.JdbcInputFormat: Creating 1 input split limit:-1, offset:0
20/07/21 03:08:44 [ce531fd3-ca3f-4dc4-8681-3cf1233f27df main]: INFO dao.GenericJdbcDatabaseAccessor: Query to execute is [select * from EXTERNAL_JDBC_SIMPLE_DERBY2_TABLE1]
Failed with exception java.io.IOException:java.lang.NullPointerException
20/07/21 03:08:44 [ce531fd3-ca3f-4dc4-8681-3cf1233f27df main]: ERROR CliDriver: Failed with exception java.io.IOException:java.lang.NullPointerException
java.io.IOException: java.lang.NullPointerException
.
.
Caused by: java.lang.NullPointerException
	at org.apache.hive.storage.jdbc.JdbcSerDe.deserialize(JdbcSerDe.java:235)
	at org.apache.hadoop.hive.ql.exec.FetchOperator.getNextRow(FetchOperator.java:619)
	... 17 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With Oracle, the CBO fails and skipped causing the problem, below is my trace.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
20/07/21 02:13:18 [Heartbeater-0]: INFO metastore.RetryingMetaStoreClient: RetryingMetaStoreClient proxy=&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.hadoop.hive.ql.metadata.SessionHiveMetaStoreClient ugi=hive@EXAMPLE.COM (auth:KERBEROS) retries=24 delay=5 lifetime=0
20/07/21 02:14:31 [f68e0ab8-1585-4db5-a872-20790c5eb3dd main]: ERROR parse.CalcitePlanner: CBO failed, skipping CBO.
java.lang.IllegalArgumentException: Multiple entries with same key: APEX_ACTIVITY_LOG=JdbcTable {APEX_ACTIVITY_LOG} and APEX_ACTIVITY_LOG=JdbcTable {APEX_ACTIVITY_LOG}
	at org.apache.hive.com.google.common.collect.ImmutableMap.checkNoConflict(ImmutableMap.java:136) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hive.com.google.common.collect.RegularImmutableMap.checkNoConflictInKeyBucket(RegularImmutableMap.java:98) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hive.com.google.common.collect.RegularImmutableMap.fromEntryArray(RegularImmutableMap.java:84) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hive.com.google.common.collect.ImmutableMap$Builder.build(ImmutableMap.java:295) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.calcite.adapter.jdbc.JdbcSchema.computeTables(JdbcSchema.java:295) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.calcite.adapter.jdbc.JdbcSchema.getTableMap(JdbcSchema.java:351) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.calcite.adapter.jdbc.JdbcSchema.getTable(JdbcSchema.java:345) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner$CalcitePlannerAction.genTableLogicalPlan(CalcitePlanner.java:3203) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner$CalcitePlannerAction.genLogicalPlan(CalcitePlanner.java:5182) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner$CalcitePlannerAction.apply(CalcitePlanner.java:1849) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner$CalcitePlannerAction.apply(CalcitePlanner.java:1795) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.calcite.tools.Frameworks.lambda$withPlanner$0(Frameworks.java:130) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.calcite.prepare.CalcitePrepareImpl.perform(CalcitePrepareImpl.java:915) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.calcite.tools.Frameworks.withPrepare(Frameworks.java:179) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.calcite.tools.Frameworks.withPlanner(Frameworks.java:125) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner.logicalPlan(CalcitePlanner.java:1556) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner.genOPTree(CalcitePlanner.java:541) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.analyzeInternal(SemanticAnalyzer.java:12460) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner.analyzeInternal(CalcitePlanner.java:435) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.parse.BaseSemanticAnalyzer.analyze(BaseSemanticAnalyzer.java:290) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.&lt;span class=&quot;code-object&quot;&gt;Compiler&lt;/span&gt;.analyze(&lt;span class=&quot;code-object&quot;&gt;Compiler&lt;/span&gt;.java:219) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.&lt;span class=&quot;code-object&quot;&gt;Compiler&lt;/span&gt;.compile(&lt;span class=&quot;code-object&quot;&gt;Compiler&lt;/span&gt;.java:104) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.Driver.compile(Driver.java:166) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.Driver.compileInternal(Driver.java:402) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.Driver.compileAndRespond(Driver.java:351) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.Driver.compileAndRespond(Driver.java:345) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.reexec.ReExecDriver.compileAndRespond(ReExecDriver.java:129) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.ql.reexec.ReExecDriver.run(ReExecDriver.java:231) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.cli.CliDriver.processLocalCmd(CliDriver.java:256) ~[hive-cli-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.cli.CliDriver.processCmd1(CliDriver.java:201) ~[hive-cli-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.cli.CliDriver.processCmd(CliDriver.java:127) ~[hive-cli-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:422) ~[hive-cli-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.cli.CliDriver.executeDriver(CliDriver.java:862) ~[hive-cli-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.cli.CliDriver.run(CliDriver.java:798) ~[hive-cli-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at org.apache.hadoop.hive.cli.CliDriver.main(CliDriver.java:717) ~[hive-cli-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[?:1.8.0_112]
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[?:1.8.0_112]
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:1.8.0_112]
	at java.lang.reflect.Method.invoke(Method.java:498) ~[?:1.8.0_112]
	at org.apache.hadoop.util.RunJar.run(RunJar.java:318) ~[hadoop-common-3.1.1.3.1.5.5-2.jar:?]
	at org.apache.hadoop.util.RunJar.main(RunJar.java:232) ~[hadoop-common-3.1.1.3.1.5.5-2.jar:?]
20/07/21 02:14:31 [f68e0ab8-1585-4db5-a872-20790c5eb3dd main]: INFO parse.CalcitePlanner: Completed phase 1 of Semantic Analysis
20/07/21 02:14:31 [f68e0ab8-1585-4db5-a872-20790c5eb3dd main]: INFO parse.CalcitePlanner: Get metadata &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; source tables
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With that, I think problem with Oracle CBO should be fixed. I will investigate the issue ob what could be causing such problem.&lt;br/&gt;
Also, maybe we can fix for condition when CBO is disabled or for any reason CBO is skipped. Attaching second patch.&lt;/p&gt;</comment>
                            <comment id="17161746" author="srahman" created="Tue, 21 Jul 2020 06:07:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chiran54321&quot; class=&quot;user-hover&quot; rel=&quot;chiran54321&quot;&gt;chiran54321&lt;/a&gt; Even though it makes sense to change the column names to lower case, I am not sure of the side effects it can have.&lt;/p&gt;

&lt;p&gt;The core of the problem here is the inconsistency in the value of hiveColumnList from JbdcSerde and JdbcRecordIterator. we could do something like &lt;a href=&quot;https://github.com/apache/hive/blob/master/jdbc-handler/src/main/java/org/apache/hive/storage/jdbc/JdbcSerDe.java#L103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/master/jdbc-handler/src/main/java/org/apache/hive/storage/jdbc/JdbcSerDe.java#L103&lt;/a&gt; in  &lt;a href=&quot;https://github.com/apache/hive/blob/master/jdbc-handler/src/main/java/org/apache/hive/storage/jdbc/dao/JdbcRecordIterator.java#L62&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/master/jdbc-handler/src/main/java/org/apache/hive/storage/jdbc/dao/JdbcRecordIterator.java#L62&lt;/a&gt; when conf.get(Constants.JDBC_QUERY) == null which i think will solve this problem&lt;/p&gt;

&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jcamachorodriguez&quot; class=&quot;user-hover&quot; rel=&quot;jcamachorodriguez&quot;&gt;jcamachorodriguez&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17165584" author="srahman" created="Mon, 27 Jul 2020 09:59:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chiran54321&quot; class=&quot;user-hover&quot; rel=&quot;chiran54321&quot;&gt;chiran54321&lt;/a&gt; Any update on this? I can pick this if you are busy with other stuffs.&lt;/p&gt;</comment>
                            <comment id="17166042" author="chiran54321" created="Tue, 28 Jul 2020 00:41:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srahman&quot; class=&quot;user-hover&quot; rel=&quot;srahman&quot;&gt;srahman&lt;/a&gt; I was on leave, could not work over weekend. I tested with existing test cases which passes with Lower Case patch, however I got your point, modified the code for JdbcRecordIterator.java to fetch column names using ResultSetMetaData, attached updated patch.&lt;/p&gt;

&lt;p&gt;CC: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jcamachorodriguez&quot; class=&quot;user-hover&quot; rel=&quot;jcamachorodriguez&quot;&gt;jcamachorodriguez&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17166155" author="srahman" created="Tue, 28 Jul 2020 04:53:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chiran54321&quot; class=&quot;user-hover&quot; rel=&quot;chiran54321&quot;&gt;chiran54321&lt;/a&gt; To run hive pre-commit tests you need to raise pull request in github (hive-repo). Can you please do the same? and  please add a test around this case.&lt;/p&gt;</comment>
                            <comment id="17166261" author="chiran54321" created="Tue, 28 Jul 2020 08:35:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srahman&quot; class=&quot;user-hover&quot; rel=&quot;srahman&quot;&gt;srahman&lt;/a&gt; Thanks, Added CBO off test case and created a PR: &lt;a href=&quot;https://github.com/apache/hive/pull/1328&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/pull/1328&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17170077" author="jcamacho" created="Mon, 3 Aug 2020 14:41:26 +0000"  >&lt;p&gt;Pushed to master, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chiran54321&quot; class=&quot;user-hover&quot; rel=&quot;chiran54321&quot;&gt;chiran54321&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="17170079" author="jcamacho" created="Mon, 3 Aug 2020 14:44:29 +0000"  >&lt;p&gt;Thanks for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srahman&quot; class=&quot;user-hover&quot; rel=&quot;srahman&quot;&gt;srahman&lt;/a&gt;, I had not checked the JIRA before merging and did not add your name to the commit message, but credit where is due.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13007887" name="HIVE-23873.01.patch" size="862" author="chiran54321" created="Fri, 17 Jul 2020 17:09:31 +0000"/>
                            <attachment id="13008045" name="HIVE-23873.02.patch" size="1854" author="chiran54321" created="Tue, 21 Jul 2020 02:52:21 +0000"/>
                            <attachment id="13008524" name="HIVE-23873.3.patch" size="3170" author="chiran54321" created="Tue, 28 Jul 2020 00:41:52 +0000"/>
                            <attachment id="13008552" name="HIVE-23873.4.patch" size="5635" author="chiran54321" created="Tue, 28 Jul 2020 08:30:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 15 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0gvi8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>