<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:13:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-3455] ANSI CORR(X,Y) is incorrect</title>
                <link>https://issues.apache.org/jira/browse/HIVE-3455</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;A simple test with 2 collinear vectors returns a wrong result.&lt;br/&gt;
The problem is the merge of variances, file:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/viewvc/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/udf/generic/GenericUDAFCorrelation.java?revision=1157222&amp;amp;view=markup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/udf/generic/GenericUDAFCorrelation.java?revision=1157222&amp;amp;view=markup&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;lines:&lt;br/&gt;
347: myagg.xvar += xvarB + (xavgA - xavgB) * (xavgA - xavgB) * myagg.count;&lt;br/&gt;
348: myagg.yvar += yvarB + (yavgA - yavgB) * (yavgA - yavgB) * myagg.count;&lt;/p&gt;

&lt;p&gt;the correct merge should be like this:&lt;br/&gt;
347: myagg.xvar += xvarB + (xavgA - xavgB) * (xavgA - xavgB) / myagg.count * nA * nB;&lt;br/&gt;
348: myagg.yvar += yvarB + (yavgA - yavgB) * (yavgA - yavgB) / myagg.count * nA * nB;&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12607356">HIVE-3455</key>
            <summary>ANSI CORR(X,Y) is incorrect</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maximbo">Maxim Bolotin</assignee>
                                    <reporter username="maximbo">Maxim Bolotin</reporter>
                        <labels>
                            <label>patch</label>
                    </labels>
                <created>Wed, 12 Sep 2012 22:49:22 +0000</created>
                <updated>Fri, 6 Dec 2013 00:55:59 +0000</updated>
                            <resolved>Fri, 6 Dec 2013 00:55:59 +0000</resolved>
                                    <version>0.7.1</version>
                    <version>0.8.0</version>
                    <version>0.8.1</version>
                    <version>0.9.0</version>
                    <version>0.9.1</version>
                    <version>0.10.0</version>
                    <version>0.11.0</version>
                    <version>0.12.0</version>
                                    <fixVersion>0.13.0</fixVersion>
                                    <component>UDF</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13454461" author="maximbo" created="Wed, 12 Sep 2012 23:00:36 +0000"  >&lt;p&gt;284,285c282,283&lt;br/&gt;
&amp;lt;         double xavgOld = myagg.xavg;&lt;br/&gt;
&amp;lt;         double yavgOld = myagg.yavg;&lt;br/&gt;
&amp;#8212;&lt;br/&gt;
&amp;gt;         double deltaX = vx - myagg.xavg;&lt;br/&gt;
&amp;gt;         double deltaY = vy - myagg.yavg;&lt;br/&gt;
287,288c285,286&lt;br/&gt;
&amp;lt;         myagg.xavg += (vx - xavgOld) / myagg.count;&lt;br/&gt;
&amp;lt;         myagg.yavg += (vy - yavgOld) / myagg.count;&lt;br/&gt;
&amp;#8212;&lt;br/&gt;
&amp;gt;         myagg.xavg += deltaX / ((double) myagg.count);&lt;br/&gt;
&amp;gt;         myagg.yavg += deltaY / ((double) myagg.count);&lt;br/&gt;
290,292c288,290&lt;br/&gt;
&amp;lt;             myagg.covar += (vx - xavgOld) * (vy - myagg.yavg);&lt;br/&gt;
&amp;lt;             myagg.xvar += (vx - xavgOld) * (vx - myagg.xavg);&lt;br/&gt;
&amp;lt;             myagg.yvar += (vy - yavgOld) * (vy - myagg.yavg);&lt;br/&gt;
&amp;#8212;&lt;br/&gt;
&amp;gt;             myagg.covar += deltaX * (vy - myagg.yavg);&lt;br/&gt;
&amp;gt;             myagg.xvar += deltaX * (vx - myagg.xavg);&lt;br/&gt;
&amp;gt;             myagg.yvar += deltaY * (vy - myagg.yavg);&lt;br/&gt;
345,350c343,351&lt;br/&gt;
&amp;lt;           myagg.xavg = (xavgA * nA + xavgB * nB) / myagg.count;&lt;br/&gt;
&amp;lt;           myagg.yavg = (yavgA * nA + yavgB * nB) / myagg.count;&lt;br/&gt;
&amp;lt;           myagg.xvar += xvarB + (xavgA - xavgB) * (xavgA - xavgB) * myagg.count;&lt;br/&gt;
&amp;lt;           myagg.yvar += yvarB + (yavgA - yavgB) * (yavgA - yavgB) * myagg.count;&lt;br/&gt;
&amp;lt;           myagg.covar +=&lt;br/&gt;
&amp;lt;               covarB + (xavgA - xavgB) * (yavgA - yavgB) * ((double) (nA * nB) / myagg.count);&lt;br/&gt;
&amp;#8212;&lt;br/&gt;
&amp;gt;           double n=myagg.count;&lt;br/&gt;
&amp;gt;           double nn=nA*nB/n;&lt;br/&gt;
&amp;gt;           double dX = xavgA-xavgB;&lt;br/&gt;
&amp;gt;           double dY = yavgA-yavgB;&lt;br/&gt;
&amp;gt;           myagg.xavg = xavgA * nA / n + xavgB * nB / n;&lt;br/&gt;
&amp;gt;           myagg.yavg = yavgA * nA / n + yavgB * nB / n;&lt;br/&gt;
&amp;gt;           myagg.xvar  += xvarB  + dX * dX * nn ;&lt;br/&gt;
&amp;gt;           myagg.yvar  += yvarB  + dY * dY * nn ;&lt;br/&gt;
&amp;gt;           myagg.covar += covarB + dX * dY * nn;&lt;/p&gt;</comment>
                            <comment id="13454465" author="maximbo" created="Wed, 12 Sep 2012 23:06:56 +0000"  >&lt;p&gt;the test, the correct answer is 1.&lt;br/&gt;
hive&amp;gt; select * from max_corr ;&lt;br/&gt;
OK&lt;br/&gt;
1	2&lt;br/&gt;
2	4&lt;br/&gt;
3	6&lt;br/&gt;
Time taken: 2.304 seconds&lt;br/&gt;
hive&amp;gt; select corr(a,b) from max_corr ;&lt;br/&gt;
Total MapReduce jobs = 1&lt;br/&gt;
Launching Job 1 out of 1&lt;br/&gt;
Number of reduce tasks determined at compile time: 1&lt;br/&gt;
In order to change the average load for a reducer (in bytes):&lt;br/&gt;
  set hive.exec.reducers.bytes.per.reducer=&amp;lt;number&amp;gt;&lt;br/&gt;
In order to limit the maximum number of reducers:&lt;br/&gt;
  set hive.exec.reducers.max=&amp;lt;number&amp;gt;&lt;br/&gt;
In order to set a constant number of reducers:&lt;br/&gt;
  set mapred.reduce.tasks=&amp;lt;number&amp;gt;&lt;br/&gt;
Starting Job = job_201207232322_2781, Tracking URL = &lt;a href=&quot;http://*****/jobdetails.jsp?jobid=job_201207232322_2781&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://*****/jobdetails.jsp?jobid=job_201207232322_2781&lt;/a&gt;&lt;br/&gt;
Kill Command = /usr/lib/hadoop/bin/hadoop job  -Dmapred.job.tracker=hdfs://***** -kill job_201207232322_2781&lt;br/&gt;
2012-09-12 10:04:17,663 Stage-1 map = 0%,  reduce = 0%&lt;br/&gt;
2012-09-12 10:04:20,681 Stage-1 map = 100%,  reduce = 0%&lt;br/&gt;
2012-09-12 10:04:27,720 Stage-1 map = 100%,  reduce = 33%&lt;br/&gt;
2012-09-12 10:04:28,728 Stage-1 map = 100%,  reduce = 100%&lt;br/&gt;
Ended Job = job_201207232322_2781&lt;br/&gt;
OK&lt;br/&gt;
0.27586206896551724&lt;br/&gt;
Time taken: 15.088 seconds&lt;br/&gt;
hive&amp;gt; &lt;/p&gt;</comment>
                            <comment id="13458414" author="appodictic" created="Wed, 19 Sep 2012 05:14:17 +0000"  >&lt;p&gt;I think your data file must be in error.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;FROM (

select inline ( array( struct(1,2), struct(2,4), struct(3,6) ) ) as (x,y) from dummy limit 3

) b select corr(b.x,b.y) 

OK
0.9999999999999999
Time taken: 9.436 seconds

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;hive&amp;gt; FROM (
    &amp;gt; 
    &amp;gt; select inline ( array( struct(1,3), struct(2,2), struct(3,1) ) ) as (x,y) from dummy limit 3
    &amp;gt; 
    &amp;gt; ) b select corr(b.x,b.y) ;

Mapred Local Task Succeeded . Convert the Join into MapJoin
OK
-0.9999999999999999
Time taken: 10.842 seconds

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looks good compared to. &lt;a href=&quot;http://my.safaribooksonline.com/book/databases/sql/9780596155322/ansi-sql-aggregate-functions/id3490390&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://my.safaribooksonline.com/book/databases/sql/9780596155322/ansi-sql-aggregate-functions/id3490390&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please re-open if I am wrong.&lt;/p&gt;</comment>
                            <comment id="13458416" author="maximbo" created="Wed, 19 Sep 2012 05:18:53 +0000"  >&lt;p&gt;the whole point of the bug is that the MERGE part is wrong, not the MAP, you can&apos;t test it with just inline array, you have to have at least to pieces to merge in a reducer. please check again the formula in the merge part.&lt;/p&gt;</comment>
                            <comment id="13458417" author="maximbo" created="Wed, 19 Sep 2012 05:19:18 +0000"  >&lt;p&gt;the whole point of the bug is that the MERGE part is wrong, not the MAP, you can&apos;t test it with just inline array, you have to have at least to pieces to merge in a reducer. please check again the formula in the merge part.&lt;/p&gt;</comment>
                            <comment id="13458422" author="appodictic" created="Wed, 19 Sep 2012 05:32:20 +0000"  >&lt;p&gt;I will look into this more. You example uses a select * which does not have a reduce phase. So I do not see how your example produces that result.&lt;/p&gt;</comment>
                            <comment id="13458427" author="maximbo" created="Wed, 19 Sep 2012 05:43:01 +0000"  >&lt;p&gt;I do have a cluster with 26 nodes, select * just an example of a simple table.&lt;br/&gt;
The table was created by &quot;create external table ... location ... ;&quot;&lt;br/&gt;
For this table &quot;select corr(a,b) from t;&quot; hive starts 2 mappers and 1 reducer.&lt;br/&gt;
The unit test for this function doesn&apos;t cover all cases.&lt;/p&gt;</comment>
                            <comment id="13458446" author="appodictic" created="Wed, 19 Sep 2012 06:23:11 +0000"  >&lt;p&gt;Good catch I set the input format to NLineInput &lt;/p&gt;

&lt;p&gt;create table data6 (name string, x int, y int) stored as inputformat &apos;org.apache.hadoop.mapred.lib.NLineInputFormat&apos; outputformat &apos;org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat&apos;;&lt;/p&gt;

&lt;p&gt;This did indeed mess produce the wrongresults. Nice catch. Will patch shortly.&lt;/p&gt;</comment>
                            <comment id="13458636" author="appodictic" created="Wed, 19 Sep 2012 12:32:40 +0000"  >&lt;p&gt;Can you please attach your diff as something that will apply with patch -p0. I do not know how to apply your patch.&lt;/p&gt;</comment>
                            <comment id="13458891" author="maximbo" created="Wed, 19 Sep 2012 17:49:37 +0000"  >&lt;p&gt;the patch for the&lt;br/&gt;
src/ql/src/java/org/apache/hadoop/hive/ql/udf/generic&lt;/p&gt;</comment>
                            <comment id="13527286" author="ashutoshc" created="Sat, 8 Dec 2012 23:12:11 +0000"  >&lt;p&gt;Patch needs a testcase. Maxim / Ed, if you guys are working on this, can you please add a testcase and update the patch?&lt;/p&gt;</comment>
                            <comment id="13724590" author="jhartlaub" created="Tue, 30 Jul 2013 23:19:01 +0000"  >&lt;p&gt;Attached are a data file, a &quot;.q&quot; file and a &quot;.q.out&quot; file that exercise the corr merge problem.  The patch in this ticket passes this test.  (test correlates a variable with itself using a CLUSTER BY column)&lt;/p&gt;</comment>
                            <comment id="13795726" author="thejas" created="Tue, 15 Oct 2013 22:13:20 +0000"  >&lt;p&gt;Clearing fix version. in hive the fix version is set after a patch is committed.&lt;/p&gt;</comment>
                            <comment id="13834648" author="kostiantyn" created="Thu, 28 Nov 2013 09:33:48 +0000"  >&lt;p&gt;Hi all,&lt;br/&gt;
I have dumped into the same issue. Maxim&apos;s patch is correct, I applied it and everything works correct&lt;br/&gt;
I&apos;m pretty sure it must be included into trunk ASAP, because of current Hive&apos;s implementation is incorrect&lt;/p&gt;</comment>
                            <comment id="13838833" author="kostiantyn" created="Wed, 4 Dec 2013 11:47:24 +0000"  >&lt;p&gt;Does Anybody work on including this path into release branches?&lt;/p&gt;</comment>
                            <comment id="13839803" author="navis" created="Thu, 5 Dec 2013 04:50:20 +0000"  >&lt;p&gt;This is apparently a bug. Rebased patch with a test case and +1 for me.&lt;/p&gt;</comment>
                            <comment id="13839866" author="hiveqa" created="Thu, 5 Dec 2013 06:32:02 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12617110/HIVE-3455.1.patch.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12617110/HIVE-3455.1.patch.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 4458 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/525/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/525/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/525/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/525/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12617110&lt;/p&gt;</comment>
                            <comment id="13840758" author="navis" created="Fri, 6 Dec 2013 00:55:59 +0000"  >&lt;p&gt;Committed to trunk. Thanks Maxim!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12471821">HIVE-1549</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12617110" name="HIVE-3455.1.patch.txt" size="6494" author="navis" created="Thu, 5 Dec 2013 04:48:04 +0000"/>
                            <attachment id="12595069" name="HIVE3455.corrTest.tar.gz" size="3490" author="jhartlaub" created="Tue, 30 Jul 2013 23:19:01 +0000"/>
                            <attachment id="12545764" name="my.patch" size="2133" author="maximbo" created="Wed, 19 Sep 2012 17:49:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>242100</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 50 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i02iqf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12636</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>the patch for the&lt;br/&gt;
src/ql/src/java/org/apache/hadoop/hive/ql/udf/generic</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310230" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Tags</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>correlation UDAF</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>