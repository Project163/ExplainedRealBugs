<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:21:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-24849] Create external table socket timeout when location has large number of files</title>
                <link>https://issues.apache.org/jira/browse/HIVE-24849</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;ol&gt;
	&lt;li&gt;The create table API call timeout when during an external table creation on a location where the number files in the S3 location is large ( ie: ~10K objects ).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The default timeout `hive.metastore.client.socket.timeout` is `600s` current workaround is it to increase the timeout to a higher value&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2021-03-04T01:37:42,761 ERROR [66b8024b-e52f-42b8-8629-a45383bcac0c main([])]: exec.DDLTask (DDLTask.java:failed(639)) - org.apache.hadoop.hive.ql.metadata.HiveException: org.apache.thrift.transport.TTransportException: java.net.SocketTimeoutException: Read timed out
 at org.apache.hadoop.hive.ql.metadata.Hive.createTable(Hive.java:873)
 at org.apache.hadoop.hive.ql.metadata.Hive.createTable(Hive.java:878)
 at org.apache.hadoop.hive.ql.exec.DDLTask.createTable(DDLTask.java:4356)
 at org.apache.hadoop.hive.ql.exec.DDLTask.execute(DDLTask.java:354)
 at org.apache.hadoop.hive.ql.exec.Task.executeTask(Task.java:199)
 at org.apache.hadoop.hive.ql.exec.TaskRunner.runSequential(TaskRunner.java:100)
 at org.apache.hadoop.hive.ql.Driver.launchTask(Driver.java:2183)
 at org.apache.hadoop.hive.ql.Driver.execute(Driver.java:1839)
 at org.apache.hadoop.hive.ql.Driver.runInternal(Driver.java:1526)
 at org.apache.hadoop.hive.ql.Driver.run(Driver.java:1237)
 at org.apache.hadoop.hive.ql.Driver.run(Driver.java:1227)
 at org.apache.hadoop.hive.cli.CliDriver.processLocalCmd(CliDriver.java:233)
 at org.apache.hadoop.hive.cli.CliDriver.processCmd(CliDriver.java:184)
 at org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:403)
 at org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:336)
 at org.apache.hadoop.hive.cli.CliDriver.processReader(CliDriver.java:474)
 at org.apache.hadoop.hive.cli.CliDriver.processFile(CliDriver.java:490)
 at org.apache.hadoop.hive.cli.CliDriver.executeDriver(CliDriver.java:793)
 at org.apache.hadoop.hive.cli.CliDriver.run(CliDriver.java:759)
 at org.apache.hadoop.hive.cli.CliDriver.main(CliDriver.java:686)
 at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
 at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
 at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
 at java.lang.reflect.Method.invoke(Method.java:498)
 at org.apache.hadoop.util.RunJar.run(RunJar.java:239)
 at org.apache.hadoop.util.RunJar.main(RunJar.java:153)
Caused by: org.apache.thrift.transport.TTransportException: java.net.SocketTimeoutException: Read timed out
 at org.apache.thrift.transport.TIOStreamTransport.read(TIOStreamTransport.java:129)
 at org.apache.thrift.transport.TTransport.readAll(TTransport.java:86)
 at org.apache.thrift.protocol.TBinaryProtocol.readAll(TBinaryProtocol.java:429)
 at org.apache.thrift.protocol.TBinaryProtocol.readI32(TBinaryProtocol.java:318)
 at org.apache.thrift.protocol.TBinaryProtocol.readMessageBegin(TBinaryProtocol.java:219)
 at org.apache.thrift.TServiceClient.receiveBase(TServiceClient.java:77)
 at org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$Client.recv_create_table_with_environment_context(ThriftHiveMetastore.java:1199)
 at org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$Client.create_table_with_environment_context(ThriftHiveMetastore.java:1185)
 at org.apache.hadoop.hive.metastore.HiveMetaStoreClient.create_table_with_environment_context(HiveMetaStoreClient.java:2399)
 at org.apache.hadoop.hive.ql.metadata.SessionHiveMetaStoreClient.create_table_with_environment_context(SessionHiveMetaStoreClient.java:93)
 at org.apache.hadoop.hive.metastore.HiveMetaStoreClient.createTable(HiveMetaStoreClient.java:752)
 at org.apache.hadoop.hive.metastore.HiveMetaStoreClient.createTable(HiveMetaStoreClient.java:740)
 at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
 at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
 at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
 at java.lang.reflect.Method.invoke(Method.java:498)
 at org.apache.hadoop.hive.metastore.RetryingMetaStoreClient.invoke(RetryingMetaStoreClient.java:173)
 at com.sun.proxy.$Proxy37.createTable(Unknown Source)
 at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
 at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
 at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
 at java.lang.reflect.Method.invoke(Method.java:498)
 at org.apache.hadoop.hive.metastore.HiveMetaStoreClient$SynchronizedHandler.invoke(HiveMetaStoreClient.java:2330)
 at com.sun.proxy.$Proxy37.createTable(Unknown Source)
 at org.apache.hadoop.hive.ql.metadata.Hive.createTable(Hive.java:863)
 ... 25 more
Caused by: java.net.SocketTimeoutException: Read timed out
 at java.net.SocketInputStream.socketRead0(Native Method)
 at java.net.SocketInputStream.socketRead(SocketInputStream.java:116)
 at java.net.SocketInputStream.read(SocketInputStream.java:171)
 at java.net.SocketInputStream.read(SocketInputStream.java:141)
 at java.io.BufferedInputStream.fill(BufferedInputStream.java:246)
 at java.io.BufferedInputStream.read1(BufferedInputStream.java:286)
 at java.io.BufferedInputStream.read(BufferedInputStream.java:345)
 at org.apache.thrift.transport.TIOStreamTransport.read(TIOStreamTransport.java:127)
 ... 49 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Understanding is the create table should not check the exisiting files/partitions and the validation is done when the table is read.&lt;/p&gt;

&lt;p&gt;The issue could be reproduced executing the below statment in Hive CLI where the location should contain ~10k objects&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SET hive.stats.autogather=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
DROP table &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; exists tTable;
CREATE EXTERNAL TABLE tTable(
   id string,
   mId string,
   wd bigint,
&#160; &#160;lang string,
&#160; &#160;tcountry string,
&#160; &#160;vId bigint
) 
ROW FORMAT DELIMITED FIELDS TERMINATED BY &lt;span class=&quot;code-quote&quot;&gt;&apos;,&apos;&lt;/span&gt; LINES TERMINATED BY &lt;span class=&quot;code-quote&quot;&gt;&apos;\n&apos;&lt;/span&gt;
LOCATION &lt;span class=&quot;code-quote&quot;&gt;&quot;s3:&lt;span class=&quot;code-comment&quot;&gt;//&amp;lt;your bucket&amp;gt;/&quot;&lt;/span&gt;
&lt;/span&gt;TBLPROPERTIES (&lt;span class=&quot;code-quote&quot;&gt;&apos;serialization.&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;.format&apos;&lt;/span&gt; = &apos;&apos;);&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;AWS EMR 5.23 with default Hive metastore and external location S3&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</environment>
        <key id="13362431">HIVE-24849</key>
            <summary>Create external table socket timeout when location has large number of files</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="glapark">Sungwoo Park</assignee>
                                    <reporter username="maxmithun">Mithun Antony</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 4 Mar 2021 23:21:22 +0000</created>
                <updated>Thu, 17 Nov 2022 08:48:30 +0000</updated>
                            <resolved>Mon, 22 Nov 2021 11:23:59 +0000</resolved>
                                    <version>2.3.4</version>
                    <version>3.1.2</version>
                    <version>4.0.0</version>
                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                    <component>Metastore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="17300233" author="glapark" created="Fri, 12 Mar 2021 11:13:05 +0000"  >&lt;p&gt;I think both HiveServer2 and Metastore try connections to S3 when &apos;create external table&apos; is executed with a concrete location.&lt;/p&gt;

&lt;p&gt;Here is part of the trace log of MinIO when &apos;create external table&apos; is executed.&lt;br/&gt;
0: jdbc:hive2://orange1:444/&amp;gt; CREATE EXTERNAL TABLE t2 (value string) PARTITIONED BY (`date` string, shard string) LOCATION &apos;s3a://tmp/load/&apos;;&lt;/p&gt;

&lt;p&gt;01:29:41.889 &lt;span class=&quot;error&quot;&gt;&amp;#91;404 Not Found&amp;#93;&lt;/span&gt; s3.HeadObject orange0:9000/tmp/load 192.168.10.2      667&#181;s       &#8593; 153 B &#8595; 196 B&lt;br/&gt;
01:29:41.893 &lt;span class=&quot;error&quot;&gt;&amp;#91;404 Not Found&amp;#93;&lt;/span&gt; s3.HeadObject orange0:9000/tmp/load/ 192.168.10.2      749&#181;s       &#8593; 153 B &#8595; 196 B&lt;br/&gt;
01:29:41.897 &lt;span class=&quot;error&quot;&gt;&amp;#91;200 OK&amp;#93;&lt;/span&gt; s3.ListObjectsV2 orange0:9000/tmp/?list-type=2&amp;amp;delimiter=%2F&amp;amp;max-keys=1&amp;amp;prefix=load%2F&amp;amp;fetch-owner=false  192.168.10.2      1.788ms      &#8593; 153 B &#8595; 611 B&lt;br/&gt;
01:29:41.903 &lt;span class=&quot;error&quot;&gt;&amp;#91;404 Not Found&amp;#93;&lt;/span&gt; s3.HeadObject orange0:9000/tmp/load 192.168.10.2      561&#181;s       &#8593; 153 B &#8595; 196 B&lt;br/&gt;
01:29:41.906 &lt;span class=&quot;error&quot;&gt;&amp;#91;404 Not Found&amp;#93;&lt;/span&gt; s3.HeadObject orange0:9000/tmp/load/ 192.168.10.2      714&#181;s       &#8593; 153 B &#8595; 196 B&lt;br/&gt;
01:29:41.910 &lt;span class=&quot;error&quot;&gt;&amp;#91;200 OK&amp;#93;&lt;/span&gt; s3.ListObjectsV2 orange0:9000/tmp/?list-type=2&amp;amp;delimiter=%2F&amp;amp;max-keys=1&amp;amp;prefix=load%2F&amp;amp;fetch-owner=false  192.168.10.2      1.079ms      &#8593; 153 B &#8595; 611 B&lt;br/&gt;
01:29:41.914 &lt;span class=&quot;error&quot;&gt;&amp;#91;200 OK&amp;#93;&lt;/span&gt; s3.ListObjectsV2 orange0:9000/tmp/?list-type=2&amp;amp;delimiter=%2F&amp;amp;max-keys=5000&amp;amp;prefix=load%2F&amp;amp;fetch-owner=false  192.168.10.2      10.547ms     &#8593; 153 B &#8595; 6.8 KiB&lt;br/&gt;
01:29:41.962 &lt;span class=&quot;error&quot;&gt;&amp;#91;200 OK&amp;#93;&lt;/span&gt; s3.HeadBucket orange0:9000/tmp/ 192.168.10.2      507&#181;s       &#8593; 153 B &#8595; 189 B&lt;br/&gt;
01:29:41.983 &lt;span class=&quot;error&quot;&gt;&amp;#91;404 Not Found&amp;#93;&lt;/span&gt; s3.HeadObject orange0:9000/tmp/load 192.168.10.2      419&#181;s       &#8593; 153 B &#8595; 196 B&lt;br/&gt;
01:29:41.985 &lt;span class=&quot;error&quot;&gt;&amp;#91;404 Not Found&amp;#93;&lt;/span&gt; s3.HeadObject orange0:9000/tmp/load/ 192.168.10.2      810&#181;s       &#8593; 153 B &#8595; 196 B&lt;br/&gt;
01:29:41.989 &lt;span class=&quot;error&quot;&gt;&amp;#91;200 OK&amp;#93;&lt;/span&gt; s3.ListObjectsV2 orange0:9000/tmp/?list-type=2&amp;amp;delimiter=%2F&amp;amp;max-keys=1&amp;amp;prefix=load%2F&amp;amp;fetch-owner=false  192.168.10.2      1.415ms      &#8593; 153 B &#8595; 611 B&lt;/p&gt;

&lt;p&gt;The problem here is that HiveServer2 and Metastore send ListObjectV2 requests which are equivalent to executing &apos;aws s3api list-objects-V2 --bucket ...&apos; and thus make a recursive traversal of the destination bucket. As a result, the execution time is proportional to the number of entries inside the bucket.&lt;/p&gt;

&lt;p&gt;For HiveServer2, we can update toTable() method in CreateTableDesc.java. It has this code:&lt;/p&gt;

&lt;p&gt;if (!this.isCTAS &amp;amp;&amp;amp; (tbl.getPath() == null || (tbl.isEmpty() &amp;amp;&amp;amp; !isExternal()))) {&lt;/p&gt;

&lt;p&gt;This code is bad because it calls tbl.isEmpty() which sends a ListObjectV2 request, but only to return false in the end as isExternal() evalutes to true. We can revise the code as follows:&lt;/p&gt;

&lt;p&gt;if (!this.isCTAS &amp;amp;&amp;amp; (tbl.getPath() == null || (!isExternal() &amp;amp;&amp;amp; tbl.isEmpty()))) {&lt;/p&gt;

&lt;p&gt;Now, HiveServer2 does not send ListObjectV2 requests. Still Metastore sends a ListObjectV2 request from Warehouse.isDir().&lt;/p&gt;

&lt;p&gt;So, a partial solution is to revise toTable() method in CreateTableDesc.java.&lt;/p&gt;</comment>
                            <comment id="17367438" author="stevel@apache.org" created="Tue, 22 Jun 2021 15:08:47 +0000"  >&lt;p&gt;is hive doing its own recursive treewalk or calling listFiles(path, recursive=true). That call is much, much faster against S3, as well as potentially for HDFS/webhdfs i&lt;/p&gt;</comment>
                            <comment id="17367439" author="stevel@apache.org" created="Tue, 22 Jun 2021 15:09:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=glapark&quot; class=&quot;user-hover&quot; rel=&quot;glapark&quot;&gt;glapark&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Now, HiveServer2 does not send ListObjectV2 requests. Still Metastore sends a ListObjectV2 request from Warehouse.isDir().&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;don&apos;t worry, that will be size limited and is the probe for &quot;is this a directory?&quot;&lt;/p&gt;</comment>
                            <comment id="17371535" author="stevel@apache.org" created="Tue, 29 Jun 2021 17:17:36 +0000"  >&lt;p&gt;How does tbl.isEmpty() work? Does it do a listStatus call (blocks for all direct children) or use an iterator (listStatusIterator(), listFiles()) and return false if the returned iterator .hasNext() is true?  Using an iterator is better as the wait time will that for a single S3 or ABFS LIST call, rather than block for all the results&lt;/p&gt;</comment>
                            <comment id="17371947" author="glapark" created="Wed, 30 Jun 2021 11:10:20 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isEmpty() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; HiveException {
    Preconditions.checkNotNull(getPath());
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      FileSystem fs = FileSystem.get(getPath().toUri(), SessionState.getSessionConf());
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; !fs.exists(getPath()) || fs.listStatus(getPath(), FileUtils.HIDDEN_FILES_PATH_FILTER).length == 0;
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HiveException(e);
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;isEmpty() calls listStatus(). So, isEmpty() can be rewritten using listStatusIterator/listFiles() as you suggest.&lt;/p&gt;

&lt;p&gt;Do you have an idea how to rewrite isDir()?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isDir(Path f) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; MetaException {
    FileSystem fs;
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      fs = getFs(f);
      FileStatus fstatus = fs.getFileStatus(f);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!fstatus.isDir()) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
      }
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (FileNotFoundException e) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
      MetaStoreUtils.logAndThrowMetaException(e);
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17372145" author="stevel@apache.org" created="Wed, 30 Jun 2021 18:17:16 +0000"  >
&lt;p&gt;Something like this&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;existence check is integrated into the LIST call, saves 1 request against all stores, 2 for s3&lt;/li&gt;
	&lt;li&gt;listing is incremental, so can determine if a dir is not empty without processing all the output,&lt;br/&gt;
  at least on those stores which do the listings incrementally (hdfs, webhdfs, s3a, abfs).&lt;br/&gt;
  on the others it is no slower than listStatus, which is what it calls internally.&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;


  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isEmpty() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; HiveException {
    Preconditions.checkNotNull(getPath());
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      FileSystem fs = FileSystem.get(getPath().toUri(),
          SessionState.getSessionConf());
      RemoteIterator&amp;lt;FileStatus&amp;gt; it = listStatusIterator(getPath);
      &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (it.hasNext()) {
        FileStatus fs = it.next();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (FileUtils.HIDDEN_FILES_PATH_FILTER.accept(fs.getPath())) {
          &lt;span class=&quot;code-comment&quot;&gt;// something not matching the filter exists
&lt;/span&gt;          &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        }
        
      }
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (FileNotFoundException e) {
      &lt;span class=&quot;code-comment&quot;&gt;// list failed
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HiveException(e);
    }
  }
  &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

  &lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For isDir(), I&apos;d just call FileSystem.isDir(path) and ignore the deprecation warning, which is there to make people look at their uses and wonder if there are more efficient ways. (too often app code has isFile, isDir or exists() before some API Call which would just raise a FileNotFoundException anyway). &lt;/p&gt;

&lt;p&gt;What I would I recommend doing is looking at uses of isDir() and wondering if they could be eliminated entirely.&lt;/p&gt;</comment>
                            <comment id="17394678" author="glapark" created="Fri, 6 Aug 2021 10:16:57 +0000"  >&lt;p&gt;I have created a pull request (for the master branch):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/hive/pull/2567&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/pull/2567&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Let me create a separate JIRA for removing uses of isDir().&lt;/p&gt;</comment>
                            <comment id="17395101" author="glapark" created="Sat, 7 Aug 2021 05:31:18 +0000"  >&lt;p&gt;Upon further inspection, the above pull request is enough for fixing the issue addressed in this JIRA.&lt;/p&gt;

&lt;p&gt;After applying the patch in the above pull request, &apos;CREATE EXTERNAL TABLE&apos; sends a single ListObjectsV2 request with max-keys=1, so the call returns almost immediately. Note that before applying the patch, a request ListObjectsV2 with max-keys=5000 is sent, so it can take a lot of time.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE EXTERNAL TABLE load10 (value string) PARTITIONED BY (`date` string, shard string) LOCATION &lt;span class=&quot;code-quote&quot;&gt;&apos;s3a:&lt;span class=&quot;code-comment&quot;&gt;//tmp/load10/&apos;&lt;/span&gt;;
&lt;/span&gt;
04:16:16.078 [200 OK] s3.ListObjectsV2 orange0:9000/tmp/?list-type=2&amp;amp;delimiter=%2F&amp;amp;max-keys=1&amp;amp;prefix=load10%2F&amp;amp;fetch-owner=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;  192.168.10.2      2.763ms      &#8593; 153 B &#8595; 614 B
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This ListOjbectsV2 request originates from Warehouse.isDir() called from HiveMetaStore.create_table_core():&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!wh.isDir(tblPath)) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!wh.mkdirs(tblPath)) {
              &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MetaException(tblPath
              + &lt;span class=&quot;code-quote&quot;&gt;&quot; is not a directory or unable to create one&quot;&lt;/span&gt;);
            }
          madeDir = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
          }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Optimizing this code by calling Warehouse.mkdirs() as shown below (similar to the solution in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-24546&quot; title=&quot;Avoid unwanted cloud storage call during dynamic partition load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-24546&quot;&gt;HIVE-24546&lt;/a&gt;) makes no improvement because in both cases, we send a single ListOjbectsV2 request with max-keys=1 anyway.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
          &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isDir = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, mkdirs = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
          &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            mkdirs = wh.mkdirs(tblPath);
          } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (MetaException e) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!wh.isDir(tblPath)) {  &lt;span class=&quot;code-comment&quot;&gt;// check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; file system is read-only and tblPath already exists
&lt;/span&gt;              &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
              isDir = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
            }
          }
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (mkdirs) {
            madeDir = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
          } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isDir &amp;amp;&amp;amp; !wh.isDir(tblPath)) {
              &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MetaException(tblPath
                  + &lt;span class=&quot;code-quote&quot;&gt;&quot; is not a directory or unable to create one&quot;&lt;/span&gt;);
            }
          }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In conclusion, the above pull request fixes the issue with &apos;CREATE EXTERNAL TABLE&apos;. Thanks for suggesting the fix in isEmpty().&lt;/p&gt;</comment>
                            <comment id="17395153" author="glapark" created="Sat, 7 Aug 2021 08:00:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt;, Could you elaborate on how FileSystem.listStatusIterator() is less expensive than FileSystem.listStatus()?&#160;In the thread of&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-25277&quot; title=&quot;Slow Hive partition deletion for Cloud object stores with expensive ListFiles&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-25277&quot;&gt;&lt;del&gt;HIVE-25277&lt;/del&gt;&lt;/a&gt;, it is pointed out that&#160;FileSystem.listStatusIterator() calls FileSystem.listStatus().&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; FileStatus[] statusList = listStatus(f);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/hadoop/blob/03cfc852791c14fad39db4e5b14104a276c08e59/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/AbstractFileSystem.java#L944&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hadoop/blob/03cfc852791c14fad39db4e5b14104a276c08e59/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/AbstractFileSystem.java#L944&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17447343" author="kgyrtkirk" created="Mon, 22 Nov 2021 11:23:59 +0000"  >&lt;p&gt;merged into master. Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=glapark&quot; class=&quot;user-hover&quot; rel=&quot;glapark&quot;&gt;glapark&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 51 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ob94:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>