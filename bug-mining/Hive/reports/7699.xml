<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:17:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-23763] Query based minor compaction produces wrong files when rows with different buckets Ids are processed by the same FileSinkOperator</title>
                <link>https://issues.apache.org/jira/browse/HIVE-23763</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;How to reproduce:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Create an unbucketed ACID table&lt;/li&gt;
	&lt;li&gt;Insert a bigger amount of data into this table so there would be multiple bucket files in the table&lt;br/&gt;
The files in the table should look like this:&lt;br/&gt;
/warehouse/tablespace/managed/hive/bubu_acid/delta_0000001_0000001_0000/bucket_00000_0&lt;br/&gt;
/warehouse/tablespace/managed/hive/bubu_acid/delta_0000001_0000001_0000/bucket_00001_0&lt;br/&gt;
/warehouse/tablespace/managed/hive/bubu_acid/delta_0000001_0000001_0000/bucket_00002_0&lt;br/&gt;
/warehouse/tablespace/managed/hive/bubu_acid/delta_0000001_0000001_0000/bucket_00003_0&lt;br/&gt;
/warehouse/tablespace/managed/hive/bubu_acid/delta_0000001_0000001_0000/bucket_00004_0&lt;br/&gt;
/warehouse/tablespace/managed/hive/bubu_acid/delta_0000001_0000001_0000/bucket_00005_0&lt;/li&gt;
	&lt;li&gt;Do some delete on rows with different bucket Ids&lt;br/&gt;
The files in a delete delta should look like this:&lt;br/&gt;
/warehouse/tablespace/managed/hive/bubu_acid/delete_delta_0000002_0000002_0000/bucket_00000&lt;br/&gt;
/warehouse/tablespace/managed/hive/bubu_acid/delete_delta_0000006_0000006_0000/bucket_00003&lt;br/&gt;
/warehouse/tablespace/managed/hive/bubu_acid/delete_delta_0000006_0000006_0000/bucket_00001&lt;/li&gt;
	&lt;li&gt;Run the query-based minor compaction&lt;/li&gt;
	&lt;li&gt;After the compaction the newly created delete delta containes only 1 bucket file. This file contains rows from all buckets and the table becomes unusable&lt;br/&gt;
/warehouse/tablespace/managed/hive/bubu_acid/delete_delta_0000001_0000007_v0000066/bucket_00000&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The issue happens only if rows with different bucket Ids are processed by the same FileSinkOperator. &lt;br/&gt;
In the FileSinkOperator.process method, the files for the compaction table are created like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    if (!bDynParts &amp;amp;&amp;amp; !filesCreated) {
      if (lbDirName != null) {
        if (valToPaths.get(lbDirName) == null) {
          createNewPaths(null, lbDirName);
        }
      } else {
        if (conf.isCompactionTable()) {
          int bucketProperty = getBucketProperty(row);
          bucketId = BucketCodec.determineVersion(bucketProperty).decodeWriterId(bucketProperty);
        }
        createBucketFiles(fsp);
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When the first row is processed, the file is created and then the filesCreated variable is set to true. Then when the other rows are processed, the first if statement will be false, so no new file gets created, but the row will be written into the file created for the first row.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13313465">HIVE-23763</key>
            <summary>Query based minor compaction produces wrong files when rows with different buckets Ids are processed by the same FileSinkOperator</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kuczoram">Marta Kuczora</assignee>
                                    <reporter username="kuczoram">Marta Kuczora</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 25 Jun 2020 14:51:36 +0000</created>
                <updated>Thu, 17 Nov 2022 08:47:54 +0000</updated>
                            <resolved>Tue, 4 Aug 2020 10:51:00 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                    <component>Transactions</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7800">2h 10m</timespent>
                                <comments>
                            <comment id="17170714" author="kuczoram" created="Tue, 4 Aug 2020 10:50:18 +0000"  >&lt;p&gt;Some details about the fix:&lt;/p&gt;

&lt;p&gt;The insert query which is running by the MINOR compaction uses the reducers and not just the mappers like the query of the MAJOR compaction. Also the temp table the query insert into is clustered by bucket number and sorted bu bucket number, original transaction and row Id. Because of these, even though the split groups are created correctly per buckets, the rows are not always distributed correctly between the reducers. It can happen that one reducer and so one FileSinkOperator gets rows from the same bucket and then writes them into one file which will result a corrupted file. We cannot always prevent to have rows from multiple buckets in one FileSinkOperator, for example if the reducer number is smaller than the table&apos;s bucket number. So the FileSinkOperator got extended in this patch to be able to handle rows from multiple buckets. It is similar what the createDynamicBuckets method does for delete deltas.&lt;br/&gt;
The other part of the patch is to make sure that rows from the same bucket would always get to the same FileSinkOperator. Therefore the ReduceSinkOperator got extended to use the bucket number when distributing the rows.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17170715" author="kuczoram" created="Tue, 4 Aug 2020 10:50:52 +0000"  >&lt;p&gt;Pushed to master. Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvary&quot; class=&quot;user-hover&quot; rel=&quot;pvary&quot;&gt;pvary&lt;/a&gt;&#160;for the review!&lt;/p&gt;</comment>
                            <comment id="17325760" author="klcopp" created="Tue, 20 Apr 2021 12:38:44 +0000"  >&lt;p&gt;A similar-looking situation can occur in MR-based minor compaction, in that case&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-17231&quot; title=&quot;ColumnizedDeleteEventRegistry.DeleteReaderValue optimization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-17231&quot;&gt;&lt;del&gt;HIVE-17231&lt;/del&gt;&lt;/a&gt; can help.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13321459">HIVE-24015</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 30 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0g72o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>