<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 17:52:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-560] column pruning not working with map joins</title>
                <link>https://issues.apache.org/jira/browse/HIVE-560</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;drop table tst1;&lt;br/&gt;
drop table tst2;&lt;/p&gt;

&lt;p&gt;create table tst1(a1 string, a2 string, a3 string, a4 string);&lt;br/&gt;
create table tst2(b1 string, b2 string, b3 string, b4 string);&lt;/p&gt;


&lt;p&gt;explain select /*+ MAPJOIN(a) */ a.a1, a.a2 from tst1 a join tst2 b ON a.a2=b.b2;&lt;/p&gt;



&lt;p&gt;the select is after the join - column pruning is not happening&lt;/p&gt;</description>
                <environment></environment>
        <key id="12427933">HIVE-560</key>
            <summary>column pruning not working with map joins</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="he yongqiang">He Yongqiang</assignee>
                                    <reporter username="namit">Namit Jain</reporter>
                        <labels>
                    </labels>
                <created>Mon, 15 Jun 2009 20:43:15 +0000</created>
                <updated>Sat, 17 Dec 2011 00:07:13 +0000</updated>
                            <resolved>Thu, 25 Jun 2009 05:51:42 +0000</resolved>
                                    <version>0.4.0</version>
                                    <fixVersion>0.4.0</fixVersion>
                                    <component>Query Processor</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12721624" author="he yongqiang" created="Fri, 19 Jun 2009 02:27:01 +0000"  >&lt;p&gt;A draft version. But it does not work for join32.q(both with and without mapjoin hint). And ppd_join2.q&apos;s output data seems not correct.&lt;br/&gt;
Other tests passed.&lt;/p&gt;</comment>
                            <comment id="12721870" author="he yongqiang" created="Fri, 19 Jun 2009 16:44:05 +0000"  >&lt;p&gt;hive-560-2009-06-19-5.patch passed all test clidriver and testparse tests in my local. &lt;br/&gt;
Also it fixed the problems of the earlier patch.&lt;br/&gt;
it added a proc in column pruner for processing join op.&lt;/p&gt;</comment>
                            <comment id="12721876" author="namit" created="Fri, 19 Jun 2009 16:54:48 +0000"  >&lt;p&gt;I will take a look and get back to you&lt;/p&gt;</comment>
                            <comment id="12722068" author="namit" created="Fri, 19 Jun 2009 22:32:45 +0000"  >&lt;p&gt;Can you explain how is it working ? I was not able to understand it from the code.&lt;br/&gt;
Also, there still seems to be a problem: for eg. in join1.q, src1.value is not used but&lt;br/&gt;
it is not pruned right away.&lt;/p&gt;</comment>
                            <comment id="12722140" author="he yongqiang" created="Sat, 20 Jun 2009 05:10:11 +0000"  >&lt;p&gt;From the explan, i think src1.value is pruned, isn&apos;t it?&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;STAGE PLANS:
  Stage: Stage-1
    Map Reduce
      Alias -&amp;gt; Map Operator Tree:
        src2 
            Reduce Output Operator
              key expressions:
                    expr: key
                    type: string
              sort order: +
              Map-reduce partition columns:
                    expr: key
                    type: string
              tag: 1
              value expressions:
                    expr: value
                    type: string
        src1 
            Reduce Output Operator
              key expressions:
                    expr: key
                    type: string
              sort order: +
              Map-reduce partition columns:
                    expr: key
                    type: string
              tag: 0
              value expressions:
                    expr: key
                    type: string
      Reduce Operator Tree:
        Join Operator
          condition map:
               Inner Join 0 to 1
          condition expressions:
            0 {VALUE._col0}
            1 {VALUE._col1}
          Select Operator
            expressions:
                  expr: _col0
                  type: string
                  expr: _col3
                  type: string
            Select Operator
              expressions:
                    expr: UDFToInteger(_col0)
                    type: int
                    expr: _col1
                    type: string
              File Output Operator
                compressed: false
                GlobalTableId: 1
                table:
                    input format: org.apache.hadoop.mapred.TextInputFormat
                    output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
                    serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
                    name: dest_j1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12722143" author="he yongqiang" created="Sat, 20 Jun 2009 05:20:26 +0000"  >&lt;p&gt;Some commets about the modification:&lt;br/&gt;
join is pruned by seeing which of its output column names is used by its children and removing its unused exprs. &lt;br/&gt;
And for each parent reduce sink, the join also remember which of the parent output columns it used. These are saved in the newly added field &apos;joinPrunedColLists&apos; in pruner context. &lt;br/&gt;
In reduce sink, if its child is a join, it will gets the information of which output is used by the child join, and prunes itself accordingly.&lt;/p&gt;</comment>
                            <comment id="12722848" author="namit" created="Mon, 22 Jun 2009 21:41:20 +0000"  >&lt;p&gt;You are assuming that Column Pruning is happening before map join conversion - which is true today, but may be a bad assumption in the long term.&lt;br/&gt;
Ideally, the optimizations should be completely independent of each other.&lt;/p&gt;

&lt;p&gt;Therefore, both kinds of trees - before and after map join conversion should be supported.&lt;/p&gt;</comment>
                            <comment id="12723507" author="he yongqiang" created="Wed, 24 Jun 2009 09:14:50 +0000"  >&lt;p&gt;Modifed the code to let column pruning be independ with map join conversion. &lt;br/&gt;
hive-560-2009-06-24-mapjoin-before-column-pruning.patch and hive-560-2009-06-24-normal(mapjoin-after-column-pruning).patch share the same set of modifications.&lt;br/&gt;
They both passed tests in my local.&lt;/p&gt;

&lt;p&gt;hive-560-2009-06-24-mapjoin-before-column-pruning.patch is not created against truck. And in it, map join conversion is done before column prune started( by reordering them in optimizer).&lt;/p&gt;

&lt;p&gt;hive-560-2009-06-24-normal(mapjoin-after-column-pruning).patch is the one we needed and i retest and patched with truck code.&lt;/p&gt;</comment>
                            <comment id="12723843" author="namit" created="Thu, 25 Jun 2009 01:15:21 +0000"  >&lt;p&gt;          List&amp;lt;Boolean&amp;gt; removed = conf.getRemovedList().get(alias);&lt;br/&gt;
          for (int i = 0; i &amp;lt; sz; i++) {&lt;br/&gt;
            for (; pos &amp;lt; removed.size(); pos++) {&lt;br/&gt;
              if (pos &amp;lt; structFields.size() &amp;amp;&amp;amp; !removed.get(pos)) &lt;/p&gt;
{
                structFieldObjectInspectors.add(structFields.get(pos)
                    .getFieldObjectInspector());
                pos++;
                break;
              }
&lt;p&gt;            }&lt;br/&gt;
          }&lt;br/&gt;
        }&lt;/p&gt;


&lt;p&gt;Looks like there is some bug in above code in MapJoinOperator - what if nothing is removed i.e all columns are selected.&lt;br/&gt;
Also, it might be a good idea not to use removedList at runtime, but create the correct list from removedList at compile time itself.&lt;/p&gt;</comment>
                            <comment id="12723849" author="he yongqiang" created="Thu, 25 Jun 2009 01:23:21 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      if (conf.getOutputColumnNames().size() &amp;lt; structFields.size()) {
        List&amp;lt;ObjectInspector&amp;gt; structFieldObjectInspectors = new ArrayList&amp;lt;ObjectInspector&amp;gt;();
        for (Byte alias : order) {
          int sz = conf.getExprs().get(alias).size();
          int pos = 0;
          List&amp;lt;Boolean&amp;gt; removed = conf.getRemovedList().get(alias);
          for (int i = 0; i &amp;lt; sz; i++) {
            for (; pos &amp;lt; removed.size(); pos++) {
              if (pos &amp;lt; structFields.size() &amp;amp;&amp;amp; !removed.get(pos)) {
                structFieldObjectInspectors.add(structFields.get(pos)
                    .getFieldObjectInspector());
                pos++;
                break;
              }
            }
          }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;if (conf.getOutputColumnNames().size() &amp;lt; structFields.size()) can avoid the situations you mentioned(if all columns are selected).&lt;/p&gt;</comment>
                            <comment id="12723852" author="he yongqiang" created="Thu, 25 Jun 2009 01:27:08 +0000"  >&lt;p&gt;&amp;gt;&amp;gt;it might be a good idea not to use removedList at runtime, but create the correct list from removedList at compile time itself.&lt;br/&gt;
you mean what we should use is a retain list instead of a remove list?&lt;/p&gt;</comment>
                            <comment id="12723855" author="namit" created="Thu, 25 Jun 2009 01:32:21 +0000"  >&lt;p&gt;yes, and dont increment pos in 2 places - can you rewrite this portion&lt;/p&gt;</comment>
                            <comment id="12723859" author="he yongqiang" created="Thu, 25 Jun 2009 01:34:27 +0000"  >&lt;p&gt;Will try to upload a new one today.&lt;/p&gt;</comment>
                            <comment id="12723865" author="namit" created="Thu, 25 Jun 2009 01:43:34 +0000"  >&lt;p&gt;Thanks, otherwise it looks good&lt;/p&gt;</comment>
                            <comment id="12723869" author="namit" created="Thu, 25 Jun 2009 01:53:06 +0000"  >
&lt;p&gt;In ColumnPrunerProcFactory: line 482, you are checking for&lt;br/&gt;
mapJoin with mapJoin&lt;/p&gt;

&lt;p&gt;if(mapJoin) {&lt;/p&gt;

&lt;p&gt;...&lt;br/&gt;
    if (mapJoin) &lt;/p&gt;
{

   ...

}

&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;The inner check can be omitted.&lt;/p&gt;</comment>
                            <comment id="12723870" author="he yongqiang" created="Thu, 25 Jun 2009 01:56:12 +0000"  >&lt;p&gt;done. Namit, thanks! I will test it locally and upload.&lt;/p&gt;</comment>
                            <comment id="12723877" author="he yongqiang" created="Thu, 25 Jun 2009 02:23:18 +0000"  >&lt;p&gt;Upload a new patch integrating with Namit&apos;s comments (Thanks Namit).&lt;br/&gt;
Since the modification is not major comparing to the previous one, I test the new patch with a full test of test parse, but only a subset of test cli driver testcases (only queries with join*.q are tested).&lt;/p&gt;</comment>
                            <comment id="12723878" author="he yongqiang" created="Thu, 25 Jun 2009 02:41:30 +0000"  >&lt;p&gt;reupload hive-560-2009-06-25.patch. &lt;/p&gt;</comment>
                            <comment id="12723908" author="namit" created="Thu, 25 Jun 2009 05:51:42 +0000"  >&lt;p&gt;Committed. Thanks Yongqiang&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12424247">HIVE-460</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12411178" name="hive-560-2009-06-19-2.patch" size="27879" author="he yongqiang" created="Fri, 19 Jun 2009 02:27:01 +0000"/>
                            <attachment id="12411241" name="hive-560-2009-06-19-5.patch" size="208933" author="he yongqiang" created="Fri, 19 Jun 2009 16:44:05 +0000"/>
                            <attachment id="12411626" name="hive-560-2009-06-24-mapjoin-before-column-pruning.patch" size="273188" author="he yongqiang" created="Wed, 24 Jun 2009 09:14:50 +0000"/>
                            <attachment id="12411627" name="hive-560-2009-06-24-normal(mapjoin-after-column-pruning).patch" size="278327" author="he yongqiang" created="Wed, 24 Jun 2009 09:14:50 +0000"/>
                            <attachment id="12411741" name="hive-560-2009-06-25.patch" size="277242" author="he yongqiang" created="Thu, 25 Jun 2009 02:41:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>73445</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 22 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0lai7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>122352</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>