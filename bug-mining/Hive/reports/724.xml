<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 17:59:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-2472] Metastore statistics are not being updated for CTAS queries.</title>
                <link>https://issues.apache.org/jira/browse/HIVE-2472</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;We need to add a Statistics task at the end of a CTAS query in order to update the metastore statistics for the table being created.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12525237">HIVE-2472</key>
            <summary>Metastore statistics are not being updated for CTAS queries.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rsurowka">Robert Sur&#243;wka</assignee>
                                    <reporter username="kevinwilfong">Kevin Wilfong</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 Sep 2011 20:24:03 +0000</created>
                <updated>Thu, 2 Feb 2012 22:09:31 +0000</updated>
                            <resolved>Fri, 11 Nov 2011 06:13:27 +0000</resolved>
                                                    <fixVersion>0.8.0</fixVersion>
                                    <component>Statistics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13117643" author="jiraposter@reviews.apache.org" created="Thu, 29 Sep 2011 21:49:45 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2120/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2120/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for hive, Yongqiang He and Ning Zhang.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;(This is not needed for RC-2)&lt;/p&gt;

&lt;p&gt;I modified StatsTask so that it could be created from a CTAS query.&lt;/p&gt;

&lt;p&gt;The StatsTask is created where StatsTask are typically created, but instead of being appended to the final MoveTask it is stored in the QB.  This is because the SemanticAnalyzer appends the task to create the table to the task tree in order to ensure atomicity.  The StatsTask requires that the table already be created, by putting it in the QB, the SemanticAnalyzer is able to access it and append to it to the create table task.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; title=&quot;Metastore statistics are not being updated for CTAS queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-2472&quot;&gt;&lt;del&gt;HIVE-2472&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-2472&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1177363 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1177363 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/QB.java 1177363 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1177363 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1177363 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/ctas.q.out 1177363 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/merge3.q.out 1177363 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1177363 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1177363 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2120/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2120/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;I ran a CTAS query and verified the stats appeared in the console at the end of the query, and that they were stored in the table&apos;s metadata.&lt;/p&gt;

&lt;p&gt;I ran the unit test queries, and updated the output of the ones which use CTAS queries&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Kevin&lt;/p&gt;
</comment>
                            <comment id="13143477" author="jiraposter@reviews.apache.org" created="Thu, 3 Nov 2011 19:47:32 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2583/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2011-11-03 19:46:23.842574)&lt;/p&gt;


&lt;p&gt;Review request for Ning Zhang and Kevin Wilfong.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Now table stats will be collected for CTAS queries.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; title=&quot;Metastore statistics are not being updated for CTAS queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-2472&quot;&gt;&lt;del&gt;HIVE-2472&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-2472&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1196269 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/ctas.q.out 1196269 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/database.q.out 1196269 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/merge3.q.out 1196269 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1196269 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1196269 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2583/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;run ant tests with overwrite option, changes to out files are part of the diff&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Robert&lt;/p&gt;
</comment>
                            <comment id="13143478" author="rsurowka" created="Thu, 3 Nov 2011 19:48:12 +0000"  >&lt;p&gt;The diff for &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; title=&quot;Metastore statistics are not being updated for CTAS queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-2472&quot;&gt;&lt;del&gt;HIVE-2472&lt;/del&gt;&lt;/a&gt;.2.patch can be found at &lt;a href=&quot;https://reviews.apache.org/r/2583/diff/#index_header&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/diff/#index_header&lt;/a&gt; (last version). &lt;/p&gt;</comment>
                            <comment id="13143483" author="jiraposter@reviews.apache.org" created="Thu, 3 Nov 2011 19:51:33 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2583/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2011-11-03 19:50:15.818785)&lt;/p&gt;


&lt;p&gt;Review request for Ning Zhang and Kevin Wilfong.&lt;/p&gt;


&lt;p&gt;Summary (updated)&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):&lt;/p&gt;


&lt;p&gt;Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.&lt;/p&gt;

&lt;p&gt;There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.&lt;/p&gt;

&lt;p&gt;FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn&apos;t change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). &lt;/p&gt;

&lt;p&gt;Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.&lt;/p&gt;

&lt;p&gt;Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.&lt;/p&gt;

&lt;p&gt;Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what&apos;s wrong).&lt;/p&gt;


&lt;p&gt;I noticed that to database.q.out &quot;Cannot get table db1.db1.conflict_name&quot; in line 1224 was added, but it wasn&apos;t present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; title=&quot;Metastore statistics are not being updated for CTAS queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-2472&quot;&gt;&lt;del&gt;HIVE-2472&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-2472&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1196269 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/ctas.q.out 1196269 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/database.q.out 1196269 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/merge3.q.out 1196269 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1196269 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1196269 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2583/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;run ant tests with overwrite option, changes to out files are part of the diff&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Robert&lt;/p&gt;
</comment>
                            <comment id="13143494" author="jiraposter@reviews.apache.org" created="Thu, 3 Nov 2011 20:05:32 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2583/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2011-11-03 20:05:20.364390)&lt;/p&gt;


&lt;p&gt;Review request for Ning Zhang and Kevin Wilfong.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;In version 3 there was a missclick mistake I made in eclipse (after the out files were already generated, but before I diffed the patch). It is corrected now, please ignore 3rd version, and when looking for changes compare version 4 with version 2. &lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):&lt;/p&gt;


&lt;p&gt;Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.&lt;/p&gt;

&lt;p&gt;There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.&lt;/p&gt;

&lt;p&gt;FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn&apos;t change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). &lt;/p&gt;

&lt;p&gt;Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.&lt;/p&gt;

&lt;p&gt;Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.&lt;/p&gt;

&lt;p&gt;Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what&apos;s wrong).&lt;/p&gt;


&lt;p&gt;I noticed that to database.q.out &quot;Cannot get table db1.db1.conflict_name&quot; in line 1224 was added, but it wasn&apos;t present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; title=&quot;Metastore statistics are not being updated for CTAS queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-2472&quot;&gt;&lt;del&gt;HIVE-2472&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-2472&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1196269 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1196269 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/ctas.q.out 1196269 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/database.q.out 1196269 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/merge3.q.out 1196269 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1196269 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1196269 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2583/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;run ant tests with overwrite option, changes to out files are part of the diff&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Robert&lt;/p&gt;
</comment>
                            <comment id="13145886" author="jiraposter@reviews.apache.org" created="Mon, 7 Nov 2011 22:26:51 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2583/#review3089&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/#review3089&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2583/#comment6894&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/#comment6894&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    why do we need to check partitions.size() == 0? Isn&apos;t it the case that when a partitioned table first created and there is no partitions yet, it will satisfy this condition? &lt;/p&gt;



&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2583/#comment6895&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/#comment6895&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    code style nitpick: space between &apos;if&apos; and &apos;(&apos; &lt;/p&gt;



&lt;p&gt;trunk/ql/src/test/results/clientpositive/ctas.q.out&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2583/#comment6896&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/#comment6896&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Here I think the plan should be stage-3 (StatsTask) depends on stage-4 (DDLTask), which depends on stage-0 (MoveTask).&lt;/p&gt;

&lt;p&gt;    Also can you change the .q file to add describe formatted &amp;lt;created_table&amp;gt; to verify that the stats are gathered for the newly created table after CTAS?&lt;/p&gt;



&lt;p&gt;trunk/ql/src/test/results/clientpositive/ctas.q.out&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2583/#comment6897&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/#comment6897&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    Same here. &lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ning&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2011-11-03 20:05:20, Robert Sur&#243;wka wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/2583/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-11-03 20:05:20)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for Ning Zhang and Kevin Wilfong.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn&apos;t change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what&apos;s wrong).&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I noticed that to database.q.out &quot;Cannot get table db1.db1.conflict_name&quot; in line 1224 was added, but it wasn&apos;t present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; title=&quot;Metastore statistics are not being updated for CTAS queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-2472&quot;&gt;&lt;del&gt;HIVE-2472&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-2472&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/ctas.q.out 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/database.q.out 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/merge3.q.out 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2583/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;run ant tests with overwrite option, changes to out files are part of the diff&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Robert&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13146052" author="jiraposter@reviews.apache.org" created="Tue, 8 Nov 2011 02:54:51 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2011-11-07 22:24:59, Ning Zhang wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Actually after CTAS the partitions collection wasn&apos;t null, whereas it was just empty (I also commented on it near the end of the diff description). I will do all other changes requested ASAP, thank you. &lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Robert&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2583/#review3089&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/#review3089&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2011-11-03 20:05:20, Robert Sur&#243;wka wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/2583/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-11-03 20:05:20)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for Ning Zhang and Kevin Wilfong.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn&apos;t change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what&apos;s wrong).&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I noticed that to database.q.out &quot;Cannot get table db1.db1.conflict_name&quot; in line 1224 was added, but it wasn&apos;t present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; title=&quot;Metastore statistics are not being updated for CTAS queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-2472&quot;&gt;&lt;del&gt;HIVE-2472&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-2472&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/ctas.q.out 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/database.q.out 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/merge3.q.out 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1196269 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2583/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;run ant tests with overwrite option, changes to out files are part of the diff&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Robert&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13146069" author="jiraposter@reviews.apache.org" created="Tue, 8 Nov 2011 04:10:51 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2583/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2011-11-08 04:08:52.506156)&lt;/p&gt;


&lt;p&gt;Review request for Ning Zhang and Kevin Wilfong.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;I implemented all the change requests (hopefully), with one exception that I already commented about.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):&lt;/p&gt;


&lt;p&gt;Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.&lt;/p&gt;

&lt;p&gt;There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.&lt;/p&gt;

&lt;p&gt;FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn&apos;t change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). &lt;/p&gt;

&lt;p&gt;Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.&lt;/p&gt;

&lt;p&gt;Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.&lt;/p&gt;

&lt;p&gt;Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what&apos;s wrong).&lt;/p&gt;


&lt;p&gt;I noticed that to database.q.out &quot;Cannot get table db1.db1.conflict_name&quot; in line 1224 was added, but it wasn&apos;t present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; title=&quot;Metastore statistics are not being updated for CTAS queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-2472&quot;&gt;&lt;del&gt;HIVE-2472&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-2472&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1199067 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1199067 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1199067 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1199067 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1199067 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1199067 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1199067 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1199067 &lt;br/&gt;
  trunk/ql/src/test/queries/clientpositive/ctas.q 1199067 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/ctas.q.out 1199067 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/database.q.out 1199067 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/merge3.q.out 1199067 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1199067 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1199067 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2583/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;run ant tests with overwrite option, changes to out files are part of the diff&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Robert&lt;/p&gt;
</comment>
                            <comment id="13146438" author="jiraposter@reviews.apache.org" created="Tue, 8 Nov 2011 17:59:51 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2011-11-07 22:24:59, Ning Zhang wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/ql/src/test/results/clientpositive/ctas.q.out, line 25&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2583/diff/4/?file=56200#file56200line25&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/diff/4/?file=56200#file56200line25&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Here I think the plan should be stage-3 (StatsTask) depends on stage-4 (DDLTask), which depends on stage-0 (MoveTask).&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     Also can you change the .q file to add describe formatted &amp;lt;created_table&amp;gt; to verify that the stats are gathered for the newly created table after CTAS?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Change to amend this was done in Semantic Analyzer around line 7050&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Robert&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2583/#review3089&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/#review3089&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2011-11-08 04:08:52, Robert Sur&#243;wka wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/2583/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-11-08 04:08:52)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for Ning Zhang and Kevin Wilfong.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn&apos;t change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what&apos;s wrong).&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I noticed that to database.q.out &quot;Cannot get table db1.db1.conflict_name&quot; in line 1224 was added, but it wasn&apos;t present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; title=&quot;Metastore statistics are not being updated for CTAS queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-2472&quot;&gt;&lt;del&gt;HIVE-2472&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-2472&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/queries/clientpositive/ctas.q 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/ctas.q.out 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/database.q.out 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/merge3.q.out 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2583/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;run ant tests with overwrite option, changes to out files are part of the diff&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Robert&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13147520" author="jiraposter@reviews.apache.org" created="Thu, 10 Nov 2011 06:53:51 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2583/#review3124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/#review3124&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;



&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2583/#comment6939&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/#comment6939&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    style nitpick: removing tab.&lt;/p&gt;



&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2583/#comment6959&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/#comment6959&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    here, rather than checkin partitions.size()==0, I think it&apos;s better to change getPartitionList() to return null when it is CTAS (i.e., getLoadFileDesc() != null). &lt;/p&gt;



&lt;p&gt;trunk/ql/src/test/results/clientpositive/database.q.out&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2583/#comment6958&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/#comment6958&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    I suspect this is caused by the change in SemanticAnalyzer.java around line 7906. Can you test if this is caused by that change? If so you&apos;ll need to resolve this rather than updating the .out file. &lt;/p&gt;



&lt;p&gt;trunk/ql/src/test/results/clientpositive/merge3.q.out&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2583/#comment6960&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/#comment6960&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    here stage-2 should only depends on stage-6.&lt;/p&gt;

&lt;p&gt;    also please add &apos;desc formatted &amp;lt;tbl&amp;gt;&apos; to verify the stats are correct.&lt;/p&gt;



&lt;p&gt;trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out&lt;br/&gt;
&amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2583/#comment6961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/#comment6961&lt;/a&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;    same: stage-2 should only depends on stage-4.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ning&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2011-11-08 04:08:52, Robert Sur&#243;wka wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/2583/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-11-08 04:08:52)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for Ning Zhang and Kevin Wilfong.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn&apos;t change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what&apos;s wrong).&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I noticed that to database.q.out &quot;Cannot get table db1.db1.conflict_name&quot; in line 1224 was added, but it wasn&apos;t present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; title=&quot;Metastore statistics are not being updated for CTAS queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-2472&quot;&gt;&lt;del&gt;HIVE-2472&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-2472&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/queries/clientpositive/ctas.q 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/ctas.q.out 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/database.q.out 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/merge3.q.out 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2583/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;run ant tests with overwrite option, changes to out files are part of the diff&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Robert&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13147894" author="jiraposter@reviews.apache.org" created="Thu, 10 Nov 2011 18:30:51 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2011-11-10 06:52:08, Ning Zhang wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This code is not a part of this patch!&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-11-10 06:52:08, Ning Zhang wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/ql/src/test/results/clientpositive/database.q.out, line 1224&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2583/diff/5/?file=56835#file56835line1224&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/diff/5/?file=56835#file56835line1224&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     I suspect this is caused by the change in SemanticAnalyzer.java around line 7906. Can you test if this is caused by that change? If so you&apos;ll need to resolve this rather than updating the .out file.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I strongly doubt it, as no other code in Hive except the one I added myself, knows that db name is being stored there. Yet I will check it. &lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;On 2011-11-10 06:52:08, Ning Zhang wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; trunk/ql/src/test/results/clientpositive/merge3.q.out, line 60&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &amp;lt;&lt;a href=&quot;https://reviews.apache.org/r/2583/diff/5/?file=56836#file56836line60&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/diff/5/?file=56836#file56836line60&lt;/a&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     here stage-2 should only depends on stage-6.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;     also please add &apos;desc formatted &amp;lt;tbl&amp;gt;&apos; to verify the stats are correct.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I will investigate this in the following one, it is actually quite strange (possibly generating out file failed), thank you. &lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Robert&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2583/#review3124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/#review3124&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2011-11-08 04:08:52, Robert Sur&#243;wka wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/2583/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2011-11-08 04:08:52)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for Ning Zhang and Kevin Wilfong.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn&apos;t change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what&apos;s wrong).&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I noticed that to database.q.out &quot;Cannot get table db1.db1.conflict_name&quot; in line 1224 was added, but it wasn&apos;t present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; title=&quot;Metastore statistics are not being updated for CTAS queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-2472&quot;&gt;&lt;del&gt;HIVE-2472&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-2472&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/queries/clientpositive/ctas.q 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/ctas.q.out 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/database.q.out 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/merge3.q.out 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1199067 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2583/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;run ant tests with overwrite option, changes to out files are part of the diff&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Robert&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13148112" author="jiraposter@reviews.apache.org" created="Thu, 10 Nov 2011 23:35:51 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/2583/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2011-11-10 23:34:41.924906)&lt;/p&gt;


&lt;p&gt;Review request for Ning Zhang and Kevin Wilfong.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Hopefully all the earlier mentioned problems have been amended. Actually there was a bug in my code that caused &quot;Cannot get table db1.db1.conflict_name&quot; to happen, it&apos;s solved by change in LoadFileDesc.java around line 45.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):&lt;/p&gt;


&lt;p&gt;Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.&lt;/p&gt;

&lt;p&gt;There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.&lt;/p&gt;

&lt;p&gt;FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn&apos;t change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). &lt;/p&gt;

&lt;p&gt;Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.&lt;/p&gt;

&lt;p&gt;Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.&lt;/p&gt;

&lt;p&gt;Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what&apos;s wrong).&lt;/p&gt;


&lt;p&gt;I noticed that to database.q.out &quot;Cannot get table db1.db1.conflict_name&quot; in line 1224 was added, but it wasn&apos;t present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; title=&quot;Metastore statistics are not being updated for CTAS queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-2472&quot;&gt;&lt;del&gt;HIVE-2472&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-2472&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1200588 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1200588 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1200588 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1200588 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1200588 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1200588 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1200588 &lt;br/&gt;
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1200588 &lt;br/&gt;
  trunk/ql/src/test/queries/clientpositive/ctas.q 1200588 &lt;br/&gt;
  trunk/ql/src/test/queries/clientpositive/merge3.q 1200588 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/ctas.q.out 1200588 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/database.q.out 1200588 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/merge3.q.out 1200588 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1200588 &lt;br/&gt;
  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1200588 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/2583/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/2583/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;run ant tests with overwrite option, changes to out files are part of the diff&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Robert&lt;/p&gt;
</comment>
                            <comment id="13148128" author="nzhang" created="Thu, 10 Nov 2011 23:59:56 +0000"  >&lt;p&gt;+1.&lt;/p&gt;</comment>
                            <comment id="13148287" author="nzhang" created="Fri, 11 Nov 2011 06:13:27 +0000"  >&lt;p&gt;Committed. Thanks Robert and Kevin!&lt;/p&gt;</comment>
                            <comment id="13148421" author="hudson" created="Fri, 11 Nov 2011 11:01:45 +0000"  >&lt;p&gt;Integrated in Hive-trunk-h0.21 #1076 (See &lt;a href=&quot;https://builds.apache.org/job/Hive-trunk-h0.21/1076/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hive-trunk-h0.21/1076/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2472&quot; title=&quot;Metastore statistics are not being updated for CTAS queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-2472&quot;&gt;&lt;del&gt;HIVE-2472&lt;/del&gt;&lt;/a&gt;. Metastore statistics are not being updated for CTAS queries. (Robert Surowka via Ning Zhang)&lt;/p&gt;

&lt;p&gt;nzhang : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1200744&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1200744&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/queries/clientpositive/ctas.q&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/queries/clientpositive/merge3.q&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/results/clientpositive/ctas.q.out&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/results/clientpositive/database.q.out&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/results/clientpositive/merge3.q.out&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12407019">HIVE-33</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12497066" name="HIVE-2472.1.patch.txt" size="78889" author="kevinwilfong" created="Thu, 29 Sep 2011 21:48:17 +0000"/>
                            <attachment id="12502208" name="HIVE-2472.2.patch" size="98197" author="rsurowka" created="Thu, 3 Nov 2011 19:45:33 +0000"/>
                            <attachment id="12502211" name="HIVE-2472.3.patch" size="97281" author="rsurowka" created="Thu, 3 Nov 2011 20:06:25 +0000"/>
                            <attachment id="12502879" name="HIVE-2472.4.patch" size="114245" author="rsurowka" created="Tue, 8 Nov 2011 04:09:48 +0000"/>
                            <attachment id="12503305" name="HIVE-2472.5.patch" size="117002" author="rsurowka" created="Thu, 10 Nov 2011 23:35:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40364</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 2 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i00x4v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3300</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>