<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:27:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-8760] Pass a copy of HiveConf to hooks</title>
                <link>https://issues.apache.org/jira/browse/HIVE-8760</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;because hadoop&apos;s &lt;tt&gt;Configuration&lt;/tt&gt; is not thread-safe&lt;/p&gt;</description>
                <environment></environment>
        <key id="12753481">HIVE-8760</key>
            <summary>Pass a copy of HiveConf to hooks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hagleitn">Gunther Hagleitner</assignee>
                                    <reporter username="ashutoshc">Ashutosh Chauhan</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Nov 2014 19:24:53 +0000</created>
                <updated>Sat, 8 Nov 2014 05:04:21 +0000</updated>
                            <resolved>Sat, 8 Nov 2014 01:14:06 +0000</resolved>
                                    <version>0.13.0</version>
                    <version>0.14.0</version>
                                                    <component>Configuration</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14200809" author="gopalv" created="Thu, 6 Nov 2014 20:02:38 +0000"  >&lt;p&gt;This is a perf regression for all well-written Hive hooks that exist.&lt;/p&gt;

&lt;p&gt;There is previous information to indicate copying Configuration is not a fast operation. In &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-4486&quot; title=&quot;FetchOperator slows down SMB map joins by 50% when there are many partitions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-4486&quot;&gt;&lt;del&gt;HIVE-4486&lt;/del&gt;&lt;/a&gt; we&apos;ve gone from a query which took 347.66 seconds down to 218 seconds by throwing out unnecessary &lt;tt&gt;new HiveConf();&lt;/tt&gt; calls.&lt;/p&gt;

&lt;p&gt;If this is a thread-safety issue, then the hook spawning its own threads should synchronize - since this is class base config, which is pluggable that is very clearly the minimum impact fix.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; HookContext hookContext) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; currentTime = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis();
+  &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; HiveConf confCopy = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HiveConf(hookContext.getConf());
    executor.submit(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;() {
... &lt;span class=&quot;code-comment&quot;&gt;// use local value off the closure capture in thread runnable&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14200813" author="ashutoshc" created="Thu, 6 Nov 2014 20:05:09 +0000"  >&lt;p&gt;But why to make an assumption about what hook is doing? Isnt it prudent that Hive does a safe thing when it can.&lt;/p&gt;</comment>
                            <comment id="14200852" author="gopalv" created="Thu, 6 Nov 2014 20:26:09 +0000"  >&lt;p&gt;Immutable structures are prudent from an API design stand-point - copying always to get to a shared-nothing model potentially breaks anyone who relied on synchronization on that object elsewhere.&lt;/p&gt;

&lt;p&gt;The stability impact of copying is currently invisible and unknown, but eventually a lot of System.identityHashcode is applied to debug those and System.err, because LOG.info() is synchronized.&lt;/p&gt;

&lt;p&gt;The performance impact of however is well known (as quoted earlier). The core API issue over-all for me is that we don&apos;t have immutable Conf objects - I keep hitting these &lt;tt&gt;new Configuration()&lt;/tt&gt; perf issues (track &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-11223&quot; title=&quot;Offer a read-only conf alternative to new Configuration()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-11223&quot;&gt;HADOOP-11223&lt;/a&gt; for the impact on HDFS).&lt;/p&gt;

&lt;p&gt;At the very least, I know the stability impact of copying in one Hook, the surface is rather narrow for that problem to trace through (i.e &quot;ship Hook2.java, Hook3.java etc and test them without rebuilding all of hive&quot;).&lt;/p&gt;

&lt;p&gt;On top of it, the biggest user of Hooks seems to be itests (which ships something like 20 single thread hooks). You&apos;ll be slowing down all of them, all the time.&lt;/p&gt;</comment>
                            <comment id="14201090" author="hiveqa" created="Thu, 6 Nov 2014 22:35:29 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12679919/HIVE-8760.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12679919/HIVE-8760.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 6700 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1670/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1670/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1670/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1670/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-1670/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-1670/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12679919 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14201347" author="ashutoshc" created="Fri, 7 Nov 2014 01:12:25 +0000"  >&lt;p&gt;Underlying hadoop bug is fixed, no workaround needed in Hive&lt;/p&gt;</comment>
                            <comment id="14201535" author="gopalv" created="Fri, 7 Nov 2014 03:44:32 +0000"  >&lt;p&gt;Reopened because hadoop-common reverted changes.&lt;/p&gt;</comment>
                            <comment id="14202695" author="hagleitn" created="Fri, 7 Nov 2014 21:14:57 +0000"  >&lt;p&gt;I&apos;d like to propose a different change with smaller scope to get at least into hive .14. I think that&apos;d be safer for 2 reasons:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;It only changes ATSHook, anyone else will not see a change to their hooks&lt;/li&gt;
	&lt;li&gt;It&apos;s faster if you run w/o ATSHook, because the clone only happens there. Cloning is fairly expensive.&lt;/li&gt;
	&lt;li&gt;It&apos;s a workaround for a hadoop issue. We should still try to get the hadoop problem fixed and take it back out for perf reasons. That limits the changes to only ATSHook again&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Note: ExecHooks and hadoop conf have been around unchanged for quite a while so leaving the code path alone as much as possible for .14 seems a safe choice.&lt;/p&gt;</comment>
                            <comment id="14202720" author="gopalv" created="Fri, 7 Nov 2014 21:30:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;It&apos;s faster if you run w/o ATSHook, because the clone only happens there. Cloning is fairly expensive.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1 - this is a more contained fix for 0.14. This does not change any existing behaviour or API contracts.&lt;/p&gt;

&lt;p&gt;This will not break outside of ATSHook, which we can disable in case it shows issues.&lt;/p&gt;

&lt;p&gt;Copying always will be slow, but it runs the risk of changing the API contract strictness too late for 0.14. Badly written hooks might fail, if they use the common conf to pass variables between different hooks.&lt;/p&gt;

&lt;p&gt;For a cleaner solution long-term (0.15+), I think we need a &lt;tt&gt;new HiveConf(conf).asReadonly()&lt;/tt&gt;, to enforce the API contract for such badly behaving hooks.&lt;/p&gt;</comment>
                            <comment id="14203073" author="hagleitn" created="Sat, 8 Nov 2014 01:01:02 +0000"  >&lt;p&gt;Actually - cancelling patch. Since patch is ATSHook only, it&apos;s easier and quicker to verify locally.&lt;/p&gt;</comment>
                            <comment id="14203082" author="hagleitn" created="Sat, 8 Nov 2014 01:14:06 +0000"  >&lt;p&gt;Committed to trunk and .14.&lt;/p&gt;</comment>
                            <comment id="14203222" author="hiveqa" created="Sat, 8 Nov 2014 05:04:21 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 no tests executed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12680270/HIVE-8760.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12680270/HIVE-8760.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1698/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1698/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1698/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/1698/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-1698/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-1698/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Tests exited with: NonZeroExitCodeException
Command &apos;bash /data/hive-ptest/working/scratch/source-prep.sh&apos; failed with exit status 1 and output &apos;+ [[ -n /usr/java/jdk1.7.0_45-cloudera ]]
+ export JAVA_HOME=/usr/java/jdk1.7.0_45-cloudera
+ JAVA_HOME=/usr/java/jdk1.7.0_45-cloudera
+ export PATH=/usr/java/jdk1.7.0_45-cloudera/bin/:/usr/local/apache-maven-3.0.5/bin:/usr/java/jdk1.7.0_45-cloudera/bin:/usr/local/apache-ant-1.9.1/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin:/home/hiveptest/bin
+ PATH=/usr/java/jdk1.7.0_45-cloudera/bin/:/usr/local/apache-maven-3.0.5/bin:/usr/java/jdk1.7.0_45-cloudera/bin:/usr/local/apache-ant-1.9.1/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin:/home/hiveptest/bin
+ export &apos;ANT_OPTS=-Xmx1g -XX:MaxPermSize=256m &apos;
+ ANT_OPTS=&apos;-Xmx1g -XX:MaxPermSize=256m &apos;
+ export &apos;M2_OPTS=-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128&apos;
+ M2_OPTS=&apos;-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128&apos;
+ cd /data/hive-ptest/working/
+ tee /data/hive-ptest/logs/PreCommit-HIVE-TRUNK-Build-1698/source-prep.txt
+ [[ false == \t\r\u\e ]]
+ mkdir -p maven ivy
+ [[ svn = \s\v\n ]]
+ [[ -n &apos;&apos; ]]
+ [[ -d apache-svn-trunk-source ]]
+ [[ ! -d apache-svn-trunk-source/.svn ]]
+ [[ ! -d apache-svn-trunk-source ]]
+ cd apache-svn-trunk-source
+ svn revert -R .
Reverted &apos;metastore/src/gen/thrift/gen-py/hive_metastore/constants.py&apos;
Reverted &apos;metastore/src/gen/thrift/gen-cpp/hive_metastore_constants.h&apos;
Reverted &apos;metastore/src/gen/thrift/gen-cpp/hive_metastore_constants.cpp&apos;
Reverted &apos;metastore/src/gen/thrift/gen-rb/hive_metastore_constants.rb&apos;
Reverted &apos;metastore/src/gen/thrift/gen-javabean/org/apache/hadoop/hive/metastore/api/hive_metastoreConstants.java&apos;
Reverted &apos;metastore/src/gen/thrift/gen-php/metastore/Types.php&apos;
Reverted &apos;metastore/if/hive_metastore.thrift&apos;
Reverted &apos;ql/src/test/org/apache/hadoop/hive/ql/txn/compactor/TestInitiator.java&apos;
Reverted &apos;ql/src/test/org/apache/hadoop/hive/ql/parse/TestUpdateDeleteSemanticAnalyzer.java&apos;
Reverted &apos;ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/Initiator.java&apos;
Reverted &apos;ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java&apos;
++ awk &apos;{print $2}&apos;
++ egrep -v &apos;^X|^Performing status on external&apos;
++ svn status --no-ignore
+ rm -rf target datanucleus.log ant/target shims/target shims/0.20/target shims/0.20S/target shims/0.23/target shims/aggregator/target shims/common/target shims/common-secure/target shims/scheduler/target packaging/target hbase-handler/target testutils/target jdbc/target metastore/target itests/target itests/hcatalog-unit/target itests/test-serde/target itests/qtest/target itests/hive-unit-hadoop2/target itests/hive-minikdc/target itests/hive-unit/target itests/custom-serde/target itests/util/target hcatalog/target hcatalog/core/target hcatalog/streaming/target hcatalog/server-extensions/target hcatalog/webhcat/svr/target hcatalog/webhcat/java-client/target hcatalog/hcatalog-pig-adapter/target accumulo-handler/target hwi/target common/target common/src/gen service/target contrib/target serde/target beeline/target odbc/target cli/target ql/dependency-reduced-pom.xml ql/target
+ svn update

Fetching external item into &apos;hcatalog/src/test/e2e/harness&apos;
External at revision 1637510.

At revision 1637510.
+ patchCommandPath=/data/hive-ptest/working/scratch/smart-apply-patch.sh
+ patchFilePath=/data/hive-ptest/working/scratch/build.patch
+ [[ -f /data/hive-ptest/working/scratch/build.patch ]]
+ chmod +x /data/hive-ptest/working/scratch/smart-apply-patch.sh
+ /data/hive-ptest/working/scratch/smart-apply-patch.sh /data/hive-ptest/working/scratch/build.patch
The patch does not appear to apply with p0, p1, or p2
+ exit 1
&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12680270 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12753083">HADOOP-11274</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12680270" name="HIVE-8760.2.patch" size="2295" author="hagleitn" created="Fri, 7 Nov 2014 21:14:57 +0000"/>
                            <attachment id="12679919" name="HIVE-8760.patch" size="1372" author="ashutoshc" created="Thu, 6 Nov 2014 19:26:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i222lr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>