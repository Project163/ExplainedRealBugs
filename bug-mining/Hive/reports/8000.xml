<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:20:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-25243] Llap external client - Handle nested values when the parent struct is null</title>
                <link>https://issues.apache.org/jira/browse/HIVE-25243</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Consider the following table in text format - &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+-------------------------------+
|              c8               |
+-------------------------------+
| NULL                          |
| {&lt;span class=&quot;code-quote&quot;&gt;&quot;r&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;s&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;t&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}  |
| {&lt;span class=&quot;code-quote&quot;&gt;&quot;r&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;s&quot;&lt;/span&gt;:9,&lt;span class=&quot;code-quote&quot;&gt;&quot;t&quot;&lt;/span&gt;:2.2}       |
+-------------------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When we query above table via llap external client, it throws following exception - &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.NullPointerException: src
        at io.netty.util.internal.ObjectUtil.checkNotNull(ObjectUtil.java:33)
        at io.netty.buffer.UnsafeByteBufUtil.setBytes(UnsafeByteBufUtil.java:537)
        at io.netty.buffer.PooledUnsafeDirectByteBuf.setBytes(PooledUnsafeDirectByteBuf.java:199)
        at io.netty.buffer.WrappedByteBuf.setBytes(WrappedByteBuf.java:486)
        at io.netty.buffer.UnsafeDirectLittleEndian.setBytes(UnsafeDirectLittleEndian.java:34)
        at io.netty.buffer.ArrowBuf.setBytes(ArrowBuf.java:933)
        at org.apache.arrow.vector.BaseVariableWidthVector.setBytes(BaseVariableWidthVector.java:1191)
        at org.apache.arrow.vector.BaseVariableWidthVector.setSafe(BaseVariableWidthVector.java:1026)
        at org.apache.hadoop.hive.ql.io.arrow.Serializer.lambda$&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;$15(Serializer.java:834)
        at org.apache.hadoop.hive.ql.io.arrow.Serializer.writeGeneric(Serializer.java:777)
        at org.apache.hadoop.hive.ql.io.arrow.Serializer.writePrimitive(Serializer.java:581)
        at org.apache.hadoop.hive.ql.io.arrow.Serializer.write(Serializer.java:290)
        at org.apache.hadoop.hive.ql.io.arrow.Serializer.writeStruct(Serializer.java:359)
        at org.apache.hadoop.hive.ql.io.arrow.Serializer.write(Serializer.java:296)
        at org.apache.hadoop.hive.ql.io.arrow.Serializer.serializeBatch(Serializer.java:213)
        at org.apache.hadoop.hive.ql.exec.vector.filesink.VectorFileSinkArrowOperator.process(VectorFileSinkArrowOperator.java:135)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Created a test to repro it - &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
 * TestMiniLlapVectorArrowWithLlapIODisabled - turns off llap io &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; testing LLAP external client flow.
 * The aim of turning off LLAP IO is -
 * when we create table through &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; test, LLAP caches them and returns the same
 * when we &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; a read query, due to &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; we miss some code paths which may have been hit otherwise.
 */
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestMiniLlapVectorArrowWithLlapIODisabled &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; BaseJdbcWithMiniLlap {

  @BeforeClass
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void beforeTest() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    HiveConf conf = defaultConf();
    conf.setBoolVar(ConfVars.LLAP_OUTPUT_FORMAT_ARROW, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
    conf.setBoolVar(ConfVars.HIVE_VECTORIZATION_FILESINK_ARROW_NATIVE_ENABLED, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
    conf.set(ConfVars.LLAP_IO_ENABLED.varname, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;);
    BaseJdbcWithMiniLlap.beforeTest(conf);
  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; InputFormat&amp;lt;NullWritable, Row&amp;gt; getInputFormat() {
    &lt;span class=&quot;code-comment&quot;&gt;//For unit testing, no harm in hard-coding allocator ceiling to LONG.MAX_VALUE
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LlapArrowRowInputFormat(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE);
  }

  @Test
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testNullsInStructFields() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    createDataTypesTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;datatypes&quot;&lt;/span&gt;);
    RowCollector2 rowCollector = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RowCollector2();
    &lt;span class=&quot;code-comment&quot;&gt;// c8 struct&amp;lt;r:string,s:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,t:&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;&amp;gt;
&lt;/span&gt;    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; query = &lt;span class=&quot;code-quote&quot;&gt;&quot;select c8 from datatypes&quot;&lt;/span&gt;;
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; rowCount = processQuery(query, 1, rowCollector);
    assertEquals(3, rowCount);
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Cause - As we see in the table above, first row of the table is NULL, and correspondingly we get &lt;tt&gt;structVector.isNull&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;=true&lt;/tt&gt; in arrow serializer but we don&apos;t get &lt;tt&gt;isNull&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;=true&lt;/tt&gt; for the fields of struct. And later the code goes for setting such fields in arrow vector and we see above exception.&lt;/p&gt;

</description>
                <environment></environment>
        <key id="13383700">HIVE-25243</key>
            <summary>Llap external client - Handle nested values when the parent struct is null</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ShubhamChaurasia">Shubham Chaurasia</assignee>
                                    <reporter username="ShubhamChaurasia">Shubham Chaurasia</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 14 Jun 2021 10:17:25 +0000</created>
                <updated>Thu, 17 Nov 2022 08:48:44 +0000</updated>
                            <resolved>Fri, 25 Jun 2021 06:14:02 +0000</resolved>
                                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                    <component>Serializers/Deserializers</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="5400">1.5h</timespent>
                                <comments>
                            <comment id="17369256" author="shubhamchaurasia" created="Fri, 25 Jun 2021 06:14:37 +0000"  >&lt;p&gt;Thanks for the review and merge &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maheshk114&quot; class=&quot;user-hover&quot; rel=&quot;maheshk114&quot;&gt;maheshk114&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 20 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0rxig:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>