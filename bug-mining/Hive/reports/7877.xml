<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:19:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-24569] LLAP daemon leaks file descriptors/log4j appenders</title>
                <link>https://issues.apache.org/jira/browse/HIVE-24569</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;With &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-9756&quot; title=&quot;LLAP: use log4j 2 for llap (log to separate files, etc.)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-9756&quot;&gt;&lt;del&gt;HIVE-9756&lt;/del&gt;&lt;/a&gt; query logs in LLAP are directed to different files (file per query) using a Log4j2 routing appender. Without a purge policy in place, appenders are created dynamically by the routing appender, one for each query, and remain in memory forever. The dynamic appenders write to files so each appender holds to a file descriptor. &lt;/p&gt;

&lt;p&gt;Further work &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-14224&quot; title=&quot;LLAP rename query specific log files once a query is complete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-14224&quot;&gt;&lt;del&gt;HIVE-14224&lt;/del&gt;&lt;/a&gt; has mitigated the issue by introducing a custom purging policy (LlapRoutingAppenderPurgePolicy) which deletes the dynamic appenders (and closes the respective files) when the query is completed (org.apache.hadoop.hive.llap.daemon.impl.QueryTracker#handleLogOnQueryCompletion). &lt;/p&gt;

&lt;p&gt;However, in the presence of multiple threads appending to the logs there are race conditions. In an internal Hive cluster the number of file descriptors started going up approx one descriptor leaking per query. After some debugging it turns out that one thread (running the QueryTracker#handleLogOnQueryCompletion) signals that the query has finished and thus the purge policy should get rid of the respective appender (and close the file) while another (Task-Executor-0) attempts to append another log message for the same query. The initial appender is closed after the request from the query tracker but a new one is created to accomodate the message from the task executor and the latter is never removed thus creating a leak. &lt;/p&gt;

&lt;p&gt;Similar leaks have been identified and fixed for HS2 with the most similar one being that described &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-22753?focusedCommentId=17021041&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17021041&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;here&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;The problem relies on the timing of threads so it may not manifestate in all versions between 2.2.0 and 4.0.0. Usually the leak can be seen either via lsof (or other similar command) with the following output:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# 1494391 is the PID of the LLAP daemon process
ls -ltr /proc/1494391/fd
...
lrwx------ 1 hive hadoop 64 Dec 24 12:08 978 -&amp;gt; /hadoop/yarn/log/application_1608659125567_0006/container_e04_1608659125567_0006_01_000002/hive_20201224121724_66ce273d-54a9-4dcd-a9fb-20cb5691cef7-dag_1608659125567_0008_194.log
lrwx------ 1 hive hadoop 64 Dec 24 12:08 977 -&amp;gt; /hadoop/yarn/log/application_1608659125567_0006/container_e04_1608659125567_0006_01_000002/hive_20201224121804_ce53eeb5-c73f-4999-b7a4-b4dd04d4e4de-dag_1608659125567_0008_197.log
lrwx------ 1 hive hadoop 64 Dec 24 12:08 974 -&amp;gt; /hadoop/yarn/log/application_1608659125567_0006/container_e04_1608659125567_0006_01_000002/hive_20201224122002_1693bd7d-2f0e-4673-a8d1-b7cb14a02204-dag_1608659125567_0008_204.log
lrwx------ 1 hive hadoop 64 Dec 24 12:08 989 -&amp;gt; /hadoop/yarn/log/application_1608659125567_0006/container_e04_1608659125567_0006_01_000002/hive_20201224121909_6a56218f-06c7-4906-9907-4b6dd824b100-dag_1608659125567_0008_201.log
lrwx------ 1 hive hadoop 64 Dec 24 12:08 984 -&amp;gt; /hadoop/yarn/log/application_1608659125567_0006/container_e04_1608659125567_0006_01_000002/hive_20201224121754_78ef49a0-bc23-478f-9a16-87fa25e7a287-dag_1608659125567_0008_196.log
lrwx------ 1 hive hadoop 64 Dec 24 12:08 983 -&amp;gt; /hadoop/yarn/log/application_1608659125567_0006/container_e04_1608659125567_0006_01_000002/hive_20201224121855_e65b9ebf-b2ec-4159-9570-1904442b7048-dag_1608659125567_0008_200.log
lrwx------ 1 hive hadoop 64 Dec 24 12:08 981 -&amp;gt; /hadoop/yarn/log/application_1608659125567_0006/container_e04_1608659125567_0006_01_000002/hive_20201224121818_e9051ae3-1316-46af-aabb-22c53ed2fda7-dag_1608659125567_0008_198.log
lrwx------ 1 hive hadoop 64 Dec 24 12:08 980 -&amp;gt; /hadoop/yarn/log/application_1608659125567_0006/container_e04_1608659125567_0006_01_000002/hive_20201224121744_fcf37921-4351-4368-95ee-b5be2592d89a-dag_1608659125567_0008_195.log
lrwx------ 1 hive hadoop 64 Dec 24 12:08 979 -&amp;gt; /hadoop/yarn/log/application_1608659125567_0006/container_e04_1608659125567_0006_01_000002/hive_20201224121837_e80c0024-f6bc-4b3c-85ed-5c0c85c55787-dag_1608659125567_0008_199.log
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;or in the heap dump with many appenders (in my case &lt;tt&gt;LlapWrappedAppender&lt;/tt&gt;) holding indirectly open file descriptors:&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13017626/13017626_llap-appender-gc-roots.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;
</description>
                <environment></environment>
        <key id="13347781">HIVE-24569</key>
            <summary>LLAP daemon leaks file descriptors/log4j appenders</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zabetak">Stamatis Zampetakis</assignee>
                                    <reporter username="zabetak">Stamatis Zampetakis</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 24 Dec 2020 18:14:46 +0000</created>
                <updated>Tue, 27 Feb 2024 22:23:58 +0000</updated>
                            <resolved>Tue, 26 Jan 2021 16:49:46 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                    <component>llap</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6000">1h 40m</timespent>
                                <comments>
                            <comment id="17254630" author="zabetak" created="Thu, 24 Dec 2020 18:17:53 +0000"  >&lt;p&gt;The fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-17128&quot; title=&quot;Operation Logging leaks file descriptors as the log4j Appender is never closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-17128&quot;&gt;&lt;del&gt;HIVE-17128&lt;/del&gt;&lt;/a&gt; deals with more or less the same problem but in HS2 process.&lt;/p&gt;</comment>
                            <comment id="17254631" author="zabetak" created="Thu, 24 Dec 2020 18:21:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-22127&quot; title=&quot;Query Routing logging appender is leaking resources of RandomAccessFileManager.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-22127&quot;&gt;HIVE-22127&lt;/a&gt; also concerns HS2 and most likely it was solved by &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-17128&quot; title=&quot;Operation Logging leaks file descriptors as the log4j Appender is never closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-17128&quot;&gt;&lt;del&gt;HIVE-17128&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17254632" author="zabetak" created="Thu, 24 Dec 2020 18:25:37 +0000"  >&lt;p&gt;I believe relying on &lt;tt&gt;LlapRoutingAppenderPurgePolicy&lt;/tt&gt; is very prone to errors and hard to reproduce bugs due to race conditions. I think the safest way to move forward and avoid a lot of this small fixes in the future is to rely on a less precise but more robust &lt;tt&gt;PurgePolicy&lt;/tt&gt; such as the &lt;tt&gt;IdlePurgePolicy&lt;/tt&gt;. I tested a config with &lt;tt&gt;IdlePurgePolicy&lt;/tt&gt; on a test cluster and the problem no longer appears. Possibly as part of this fix I will try to get rid of &lt;tt&gt;LlapRoutingAppenderPurgePolicy&lt;/tt&gt; and related classes also for HS2 and not only for LLAP.&lt;/p&gt;</comment>
                            <comment id="17266250" author="jcamacho" created="Fri, 15 Jan 2021 17:59:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mustafaiman&quot; class=&quot;user-hover&quot; rel=&quot;mustafaiman&quot;&gt;mustafaiman&lt;/a&gt;, could any of you review this patch? Thanks&lt;/p&gt;</comment>
                            <comment id="17266271" author="prasanth_j" created="Fri, 15 Jan 2021 18:13:42 +0000"  >&lt;p&gt;Left a question about how the Idle purging is triggered (we wanted to avoid files being closed too frequently). Looks good otherwise, +1. Thanks for adding tests for it!&#160;&lt;/p&gt;</comment>
                            <comment id="17266421" author="zabetak" created="Fri, 15 Jan 2021 23:55:30 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt;, I replied in the PR. If you think that 5 sec of inactivity is very low then we can increase this value; we may keep the descriptor open for a bit longer but it is better if it is not on us to manage the lifecycle of appenders.&lt;/p&gt;</comment>
                            <comment id="17267187" author="zabetak" created="Mon, 18 Jan 2021 11:38:46 +0000"  >&lt;p&gt;It turns out that the race condition that leads to the leak of file descriptors/appenders is already logged in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-14300&quot; title=&quot;LLAP: Renaming query specific files on completion should wait for completion of threads in the daemon&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-14300&quot;&gt;HIVE-14300&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17267193" author="zabetak" created="Mon, 18 Jan 2021 11:47:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt; indicated in the PR that removing the &apos;.done&apos; suffix in log files (which happens with the current PR) may cause some problems with respect to yarn log aggregation and tez ui. I searched a bit around the history of this naming pattern and it seems that indeed there are some dependencies with yarn and tez (relevant issues are &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-14224&quot; title=&quot;LLAP rename query specific log files once a query is complete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-14224&quot;&gt;&lt;del&gt;HIVE-14224&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-14225&quot; title=&quot;Llap slider package should support configuring YARN rolling log aggregation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-14225&quot;&gt;&lt;del&gt;HIVE-14225&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SLIDER-116&quot; title=&quot;Log handling for long-lived applications&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SLIDER-116&quot;&gt;&lt;del&gt;SLIDER-116&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/TEZ-3629&quot; title=&quot;Tez UI: Enable the UI to display log links from LLAP&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TEZ-3629&quot;&gt;&lt;del&gt;TEZ-3629&lt;/del&gt;&lt;/a&gt;) so using plainly the &lt;tt&gt;IdlePurgePolicy&lt;/tt&gt; may not be possible.&lt;/p&gt;</comment>
                            <comment id="17272235" author="kgyrtkirk" created="Tue, 26 Jan 2021 16:49:46 +0000"  >&lt;p&gt;merged into master. Thank you Stamatis for fixing this (and also extending the test infra along the way) and Prashanth for reviewing the changes!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13560992">HIVE-27941</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="12991295">HIVE-14300</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13531134">HIVE-27209</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13251896">HIVE-22127</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13088540">HIVE-17128</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13280654">HIVE-22753</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13350636">HIVE-24590</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13357140">HIVE-24747</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13017626" name="llap-appender-gc-roots.png" size="104643" author="zabetak" created="Thu, 24 Dec 2020 18:14:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ltdc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12343343">4.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>