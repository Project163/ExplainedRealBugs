<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:18:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-23851] MSCK REPAIR Command With Partition Filtering Fails While Dropping Partitions</title>
                <link>https://issues.apache.org/jira/browse/HIVE-23851</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;&lt;b&gt;Steps to reproduce:&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Create external table&lt;/li&gt;
	&lt;li&gt;Run msck command to sync all the partitions with metastore&lt;/li&gt;
	&lt;li&gt;Remove one of the partition path&lt;/li&gt;
	&lt;li&gt;Run msck repair with partition filtering&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;b&gt;Stack Trace:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 2020-07-15T02:10:29,045 ERROR [4dad298b-28b1-4e6b-94b6-aa785b60c576 main] ppr.PartitionExpressionForMetastore: Failed to deserialize the expression
 java.lang.IndexOutOfBoundsException: Index: 110, Size: 0
 at java.util.ArrayList.rangeCheck(ArrayList.java:657) ~[?:1.8.0_192]
 at java.util.ArrayList.get(ArrayList.java:433) ~[?:1.8.0_192]
 at org.apache.hive.com.esotericsoftware.kryo.util.MapReferenceResolver.getReadObject(MapReferenceResolver.java:60) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
 at org.apache.hive.com.esotericsoftware.kryo.Kryo.readReferenceOrNull(Kryo.java:857) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
 at org.apache.hive.com.esotericsoftware.kryo.Kryo.readObject(Kryo.java:707) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
 at org.apache.hadoop.hive.ql.exec.SerializationUtilities$KryoWithHooks.readObject(SerializationUtilities.java:211) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
 at org.apache.hadoop.hive.ql.exec.SerializationUtilities.deserializeObjectFromKryo(SerializationUtilities.java:806) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
 at org.apache.hadoop.hive.ql.exec.SerializationUtilities.deserializeExpressionFromKryo(SerializationUtilities.java:775) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
 at org.apache.hadoop.hive.ql.optimizer.ppr.PartitionExpressionForMetastore.deserializeExpr(PartitionExpressionForMetastore.java:96) [hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
 at org.apache.hadoop.hive.ql.optimizer.ppr.PartitionExpressionForMetastore.convertExprToFilter(PartitionExpressionForMetastore.java:52) [hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
 at org.apache.hadoop.hive.metastore.PartFilterExprUtil.makeExpressionTree(PartFilterExprUtil.java:48) [hive-standalone-metastore-server-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
 at org.apache.hadoop.hive.metastore.ObjectStore.getPartitionsByExprInternal(ObjectStore.java:3593) [hive-standalone-metastore-server-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]
 at org.apache.hadoop.hive.metastore.VerifyingObjectStore.getPartitionsByExpr(VerifyingObjectStore.java:80) [hive-standalone-metastore-server-4.0.0-SNAPSHOT-tests.jar:4.0.0-SNAPSHOT]
 at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[?:1.8.0_192]
 at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[?:1.8.0_192]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Cause:&lt;/b&gt;&lt;br/&gt;
In case of msck repair with partition filtering we expect expression proxy class to be set as PartitionExpressionForMetastore ( &lt;a href=&quot;https://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/ddl/misc/msck/MsckAnalyzer.java#L78&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/ddl/misc/msck/MsckAnalyzer.java#L78&lt;/a&gt; ), While dropping partition we serialize the drop partition filter expression as ( &lt;a href=&quot;https://github.com/apache/hive/blob/master/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/Msck.java#L589&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/master/standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/Msck.java#L589&lt;/a&gt; ) which is incompatible during deserializtion happening in PartitionExpressionForMetastore ( &lt;a href=&quot;https://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionExpressionForMetastore.java#L52&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionExpressionForMetastore.java#L52&lt;/a&gt; ) hence the query fails with Failed to deserialize the expression.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Solutions&lt;/b&gt;:&lt;br/&gt;
I could think of two approaches to this problem&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Since PartitionExpressionForMetastore is required only during parition pruning step, We can switch back the expression proxy class to MsckPartitionExpressionProxy once the partition pruning step is done.&lt;/li&gt;
	&lt;li&gt;The other solution is to make serialization process in msck drop partition filter expression compatible with the one with PartitionExpressionForMetastore, We can do this via Reflection since the drop partition serialization happens in Msck class (standadlone-metatsore) by this way we can completely remove the need for class MsckPartitionExpressionProxy and this also helps to reduce the complexity of Msck Repair command with parition filtering to work with ease (no need to set the expression proxyClass config).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I am personally inclined to the 2nd approach. Before moving on i want to know if this is the best approach or is there any other better/easier approach to solve this problem.&lt;/p&gt;

&lt;p&gt;PS: qtest added in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-22957&quot; title=&quot;Support Partition Filtering In MSCK REPAIR TABLE Command&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-22957&quot;&gt;&lt;del&gt;HIVE-22957&lt;/del&gt;&lt;/a&gt; mainly focused on adding missing partition. Forgot to add case for dropping partition.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13316900">HIVE-23851</key>
            <summary>MSCK REPAIR Command With Partition Filtering Fails While Dropping Partitions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srahman">Syed Shameerur Rahman</assignee>
                                    <reporter username="srahman">Syed Shameerur Rahman</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 15 Jul 2020 11:13:27 +0000</created>
                <updated>Thu, 17 Nov 2022 08:48:52 +0000</updated>
                            <resolved>Fri, 9 Oct 2020 08:22:20 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="19800">5.5h</timespent>
                                <comments>
                            <comment id="17158086" author="srahman" created="Wed, 15 Jul 2020 11:14:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kgyrtkirk&quot; class=&quot;user-hover&quot; rel=&quot;kgyrtkirk&quot;&gt;kgyrtkirk&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt; Any thoughts on the above issue?&lt;/p&gt;</comment>
                            <comment id="17158126" author="asinkovits" created="Wed, 15 Jul 2020 12:36:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srahman&quot; class=&quot;user-hover&quot; rel=&quot;srahman&quot;&gt;srahman&lt;/a&gt; I&apos;m a bit confused now. Is this the same issue as &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-23808&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-23808&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="17158137" author="srahman" created="Wed, 15 Jul 2020 12:57:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=asinkovits&quot; class=&quot;user-hover&quot; rel=&quot;asinkovits&quot;&gt;asinkovits&lt;/a&gt; I guess &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-23808&quot; title=&quot;&amp;quot;MSCK REPAIR.. DROP Partitions fail&amp;quot; with kryo Exception &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-23808&quot;&gt;&lt;del&gt;HIVE-23808&lt;/del&gt;&lt;/a&gt; might be due to misconfiguration, may be the value of metastore.expression.proxy is forcefully set to org.apache.hadoop.hive.ql.optimizer.ppr.PartitionExpressionForMetastore. Check qtest msck_repair_drop.q &lt;/p&gt;

&lt;p&gt;In this case &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-23851&quot; title=&quot;MSCK REPAIR Command With Partition Filtering Fails While Dropping Partitions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-23851&quot;&gt;&lt;del&gt;HIVE-23851&lt;/del&gt;&lt;/a&gt; , We set metastore.expression.proxy to org.apache.hadoop.hive.ql.optimizer.ppr.PartitionExpressionForMetastore for partition filtering and hence hitting this issue&lt;/p&gt;</comment>
                            <comment id="17208490" author="srahman" created="Tue, 6 Oct 2020 05:26:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kgyrtkirk&quot; class=&quot;user-hover&quot; rel=&quot;kgyrtkirk&quot;&gt;kgyrtkirk&lt;/a&gt; Could you please review the PR?&lt;/p&gt;</comment>
                            <comment id="17210717" author="kgyrtkirk" created="Fri, 9 Oct 2020 08:22:20 +0000"  >&lt;p&gt;merged into master. Thank you Syed Shameerur Rahman!&lt;/p&gt;</comment>
                            <comment id="17258298" author="amagyar" created="Mon, 4 Jan 2021 16:06:30 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srahman&quot; class=&quot;user-hover&quot; rel=&quot;srahman&quot;&gt;srahman&lt;/a&gt;, it looks like the same exception can be thrown from&#160;&lt;/p&gt;

&lt;p&gt;filterPartitionsByExpr() as well. This patch addresses only&#160;convertExprToFilter().&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IndexOutOfBoundsException: Index: 97, Size: 0
        at java.util.ArrayList.rangeCheck(ArrayList.java:657) ~[?:1.8.0_232]
        at java.util.ArrayList.get(ArrayList.java:433) ~[?:1.8.0_232]
        at org.apache.hive.com.esotericsoftware.kryo.util.MapReferenceResolver.getReadObject(MapReferenceResolver.java:60) ~[hive-exec-3.1.3000.7.2.7.0-144.jar:3.1.3000.7.2.7.0-SNAPSHOT]
        at org.apache.hive.com.esotericsoftware.kryo.Kryo.readReferenceOrNull(Kryo.java:834) ~[hive-exec-3.1.3000.7.2.7.0-144.jar:3.1.3000.7.2.7.0-SNAPSHOT]
        at org.apache.hive.com.esotericsoftware.kryo.Kryo.readObject(Kryo.java:684) ~[hive-exec-3.1.3000.7.2.7.0-144.jar:3.1.3000.7.2.7.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.exec.SerializationUtilities$KryoWithHooks.readObject(SerializationUtilities.java:211) ~[hive-exec-3.1.3000.7.2.7.0-144.jar:3.1.3000.7.2.7.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.exec.SerializationUtilities.deserializeObjectFromKryo(SerializationUtilities.java:814) ~[hive-exec-3.1.3000.7.2.7.0-144.jar:3.1.3000.7.2.7.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.exec.SerializationUtilities.deserializeExpressionFromKryo(SerializationUtilities.java:775) ~[hive-exec-3.1.3000.7.2.7.0-144.jar:3.1.3000.7.2.7.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.optimizer.ppr.PartitionExpressionForMetastore.deserializeExpr(PartitionExpressionForMetastore.java:116) [hive-exec-3.1.3000.7.2.7.0-144.jar:3.1.3000.7.2.7.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.optimizer.ppr.PartitionExpressionForMetastore.filterPartitionsByExpr(PartitionExpressionForMetastore.java:88) [hive-exec-3.1.3000.7.2.7.0-144.jar:3.1.3000.7.2.7.0-SNAPSHOT] &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I see the original issue was fixed by skipping the deserialization and returning the exprBytes as string when the deserialization would fail. But&#160;&lt;/p&gt;

&lt;p&gt;filterPartitionsByExpr returns a boolean. Would returning false be an acceptable fix when deserialization fails in&lt;/p&gt;

&lt;p&gt;filterPartitionsByExpr?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kgyrtkirk&quot; class=&quot;user-hover&quot; rel=&quot;kgyrtkirk&quot;&gt;kgyrtkirk&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17388228" author="ckulkarni" created="Tue, 27 Jul 2021 18:10:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ashutoshc&quot; class=&quot;user-hover&quot; rel=&quot;ashutoshc&quot;&gt;ashutoshc&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srahman&quot; class=&quot;user-hover&quot; rel=&quot;srahman&quot;&gt;srahman&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kgyrtkirk&quot; class=&quot;user-hover&quot; rel=&quot;kgyrtkirk&quot;&gt;kgyrtkirk&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt;&#160;I am trying to implement an API in a downstream project (Trino) which would eventually call the Hive&#160;&lt;tt&gt;ThriftHiveMetastore.Iface#drop_partitions_req()&lt;/tt&gt; API.&lt;/p&gt;

&lt;p&gt;I see that in this Jira, we have a separate implementation of the&#160;&lt;tt&gt;PartitionExpressionProxy&lt;/tt&gt; class which doesn&apos;t depend on any hive-exec classes and is accessible to a standalone HMS. I wish to do the same thing.&lt;/p&gt;

&lt;p&gt;Is there any way to support calling bulkdropPartitions APIs for&#160; downstream projects without having to make changes to Hive and implement their own &lt;tt&gt;PartitionExpressionProxy&lt;/tt&gt; class? Any discussions/examples of projects that may have done this?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13288892">HIVE-22957</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13349170">HIVE-24584</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 16 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0gs2w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>