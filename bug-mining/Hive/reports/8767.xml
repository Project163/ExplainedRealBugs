<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:26:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-28473] INSERT OVERWRITE LOCAL DIRECTORY writes staging files to wrong hdfs directory</title>
                <link>https://issues.apache.org/jira/browse/HIVE-28473</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;using HIVE 3.1.3 ; mr engine; HADOOP 3.3.4&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Description&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;When I try to insert data into the local directory &quot;/path/to/local&quot;, Hive usually first creates an intermediate HDFS directory like &quot;hdfs:/session/execution/.staging-hive-xx&quot;, which is based on sessionId and executionId. After that, it moves the results to the local filesystem at &quot;/path/to/local&quot;.&lt;/p&gt;

&lt;p&gt;However, it&#8217;s currently trying to create an intermediate HDFS directory at &quot;hdfs:/path/to/local/.staging-hive-xx&quot;, which incorrectly uses the local filesystem path. This causes an error because it&apos;s attempting to create a new path starting from &lt;tt&gt;/root&lt;/tt&gt;, where we don&apos;t have sufficient permissions.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It can be reproduced by:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INSERT OVERWRITE LOCAL DIRECTORY &lt;span class=&quot;code-quote&quot;&gt;&quot;/path/to/local/dir&quot;&lt;/span&gt;
select a 
from table 
group by a; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;StackTrace:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
RuntimeException: cannot create staging directory &lt;span class=&quot;code-quote&quot;&gt;&quot;hdfs:/path/to/local/dir/.hive-staging-xx&quot;&lt;/span&gt;:
Permission denied: user=aaa, access=WRITE, inode=&lt;span class=&quot;code-quote&quot;&gt;&quot;/&quot;&lt;/span&gt;:hdfs:hdfs:drwxr-xr-x &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;ANALYSE&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In function &lt;em&gt;org.apache.hadoop.hive.ql.parse.SemanticAnalyzer#createFileSinkDesc.&lt;/em&gt; We do the same execution for both &lt;em&gt;QBMetaData.DEST_LOCAL_FILE&lt;/em&gt; and &lt;em&gt;QBMetaData.DEST_DFS_FILE,&lt;/em&gt;&#160;and then we set the value&#160;&lt;em&gt;ctx.getTempDirForInterimJobPath(dest_path).toString() to&lt;/em&gt;&#160;&lt;em&gt;statsTmpLoc&lt;/em&gt;. But for local filesystem dest_path is always totally different from the paths of HADOOP filesystem, and then we get the exception that we cannot create a HDFS directory because we don&apos;t have sufficient permissions.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;SOLUTION&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;we should modify the function &#160;&lt;em&gt;org.apache.hadoop.hive.ql.parse.SemanticAnalyzer#createFileSinkDesc&lt;/em&gt;&#160;to treat &lt;em&gt;QBMetaData.DEST_LOCAL_FILE&lt;/em&gt; and &lt;em&gt;QBMetaData.DEST_DFS_FILE&lt;/em&gt; differently by&#160;giving the value &lt;em&gt;ctx.getMRTmpPath().toString()&lt;/em&gt; to &lt;em&gt;statsTmpLoc&lt;/em&gt; to avoid creating a wrong intermediate direcoty.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Hadoop 3.3.4&lt;br/&gt;
HIVE 3.1.3&lt;/p&gt;

&lt;p&gt;mapreduce engine&lt;/p&gt;</environment>
        <key id="13589834">HIVE-28473</key>
            <summary>INSERT OVERWRITE LOCAL DIRECTORY writes staging files to wrong hdfs directory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ylllllllll">liang yu</assignee>
                                    <reporter username="ylllllllll">liang yu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 23 Aug 2024 02:59:17 +0000</created>
                <updated>Tue, 29 Jul 2025 14:52:01 +0000</updated>
                            <resolved>Fri, 20 Dec 2024 05:47:58 +0000</resolved>
                                    <version>3.1.3</version>
                                    <fixVersion>4.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17907281" author="zhangbutao" created="Fri, 20 Dec 2024 05:47:58 +0000"  >&lt;p&gt;Merged to master.&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ylllllllll&quot; class=&quot;user-hover&quot; rel=&quot;ylllllllll&quot;&gt;ylllllllll&lt;/a&gt; for the contribution!!!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            46 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1r13c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>