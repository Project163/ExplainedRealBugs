<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:22:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-26298] Selecting complex types on migrated iceberg table does not work</title>
                <link>https://issues.apache.org/jira/browse/HIVE-26298</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;I am working on implementing NameMapping in Impala (mainly replicating Hive&apos;s functionality) and ran into the following issue:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE TABLE array_demo
(
&#160; int_primitive INT,
&#160; int_array ARRAY&amp;lt;INT&amp;gt;,
&#160; int_array_array ARRAY&amp;lt;ARRAY&amp;lt;INT&amp;gt;&amp;gt;,
&#160; int_to_array_array_Map MAP&amp;lt;INT,ARRAY&amp;lt;ARRAY&amp;lt;INT&amp;gt;&amp;gt;&amp;gt;
)
STORED AS ORC;

INSERT INTO array_demo values (0, array(1), array(array(2), array(3,4)), map(5,array(array(6),array(7,8))));

select * from array_demo;
+---------------------------+-----------------------+-----------------------------+------------------------------------+
| array_demo.int_primitive &#160;| array_demo.int_array &#160;| array_demo.int_array_array &#160;| array_demo.int_to_array_array_map &#160;|
+---------------------------+-----------------------+-----------------------------+------------------------------------+
| 0 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; | [1] &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; | [[2],[3,4]] &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; | {5:[[6],[7,8]]} &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;|
+---------------------------+-----------------------+-----------------------------+------------------------------------+
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Converting to iceberg&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ALTER TABLE array_demo SET TBLPROPERTIES (&lt;span class=&quot;code-quote&quot;&gt;&apos;storage_handler&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.iceberg.mr.hive.HiveIcebergStorageHandler&apos;&lt;/span&gt;)

select * from array_demo;
INFO &#160;: Compiling command(queryId=gfurnstahl_20220608102746_54bf3e74-e12b-400b-94a9-4e4c9fe460fe): select * from array_demo
INFO &#160;: No Stats &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@array_demo, Columns: int_primitive, int_array, int_to_array_array_map, int_array_array
INFO &#160;: Semantic Analysis Completed (retrial = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
INFO &#160;: Created Hive schema: Schema(fieldSchemas:[FieldSchema(name:array_demo.int_primitive, type:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, comment:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;), FieldSchema(name:array_demo.int_array, type:array&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;, comment:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;), FieldSchema(name:array_demo.int_array_array, type:array&amp;lt;array&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt;, comment:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;), FieldSchema(name:array_demo.int_to_array_array_map, type:map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,array&amp;lt;array&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt;, comment:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)], properties:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
INFO &#160;: Completed compiling command(queryId=gfurnstahl_20220608102746_54bf3e74-e12b-400b-94a9-4e4c9fe460fe); Time taken: 0.036 seconds
INFO &#160;: Executing command(queryId=gfurnstahl_20220608102746_54bf3e74-e12b-400b-94a9-4e4c9fe460fe): select * from array_demo
INFO &#160;: Completed executing command(queryId=gfurnstahl_20220608102746_54bf3e74-e12b-400b-94a9-4e4c9fe460fe); Time taken: 0.0 seconds
INFO &#160;: OK
Error: java.io.IOException: java.lang.IllegalArgumentException: Can not promote MAP type to INTEGER (state=,code=0)

select int_primitive from array_demo;
+----------------+
| int_primitive &#160;|
+----------------+
| 0 &#160; &#160; &#160; &#160; &#160; &#160; &#160;|
+----------------+
1 row selected (0.088 seconds)
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Removing schema.name-mapping.default solves it&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ALTER TABLE array_demo UNSET TBLPROPERTIES (&lt;span class=&quot;code-quote&quot;&gt;&apos;schema.name-mapping.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;&apos;&lt;/span&gt;);

select * from array_demo;
+---------------------------+-----------------------+-----------------------------+------------------------------------+
| array_demo.int_primitive &#160;| array_demo.int_array &#160;| array_demo.int_array_array &#160;| array_demo.int_to_array_array_map &#160;|
+---------------------------+-----------------------+-----------------------------+------------------------------------+
| 0 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; | [1] &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; | [[2],[3,4]] &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; | {5:[[6],[7,8]]} &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;|
+---------------------------+-----------------------+-----------------------------+------------------------------------+
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Possible cause:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The name mapping generated and pushed into schema.name-mapping.default is different from the name mapping in the schema in the metadata.json (attached it)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13448954">HIVE-26298</key>
            <summary>Selecting complex types on migrated iceberg table does not work</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lpinter">L&#225;szl&#243; Pint&#233;r</assignee>
                                    <reporter username="gfurnstahl">Gergely F&#252;rnst&#225;hl</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 8 Jun 2022 08:39:15 +0000</created>
                <updated>Wed, 16 Nov 2022 13:50:35 +0000</updated>
                            <resolved>Thu, 16 Jun 2022 06:12:46 +0000</resolved>
                                                    <fixVersion>4.0.0-alpha-2</fixVersion>
                                    <component>Iceberg integration</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="17551582" author="JIRAUSER283863" created="Wed, 8 Jun 2022 12:11:48 +0000"  >&lt;p&gt;Investigated a bit more, without schema.name-mapping.default its still uses the same iceberg API and works correctly (for the given query&apos;s &quot;subschema&quot;):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/iceberg/blob/90225d6c9413016d611e2ce5eff37db1bc1b4fc5/orc/src/main/java/org/apache/iceberg/orc/OrcIterable.java#L87&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/iceberg/blob/90225d6c9413016d611e2ce5eff37db1bc1b4fc5/orc/src/main/java/org/apache/iceberg/orc/OrcIterable.java#L87&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Step completed: &lt;span class=&quot;code-quote&quot;&gt;&quot;thread=55e54b9c-8458-49f3-b345-a71abe886c30 HiveServer2-Handler-Pool: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-141&quot;&lt;/span&gt;, org.apache.iceberg.orc.OrcIterable.iterator(), line=81 bci=1755e54b9c-8458-49f3-b345-a71abe886c30 HiveServer2-Handler-Pool: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-141[1] print nameMapping
&#160;nameMapping = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
55e54b9c-8458-49f3-b345-a71abe886c30 HiveServer2-Handler-Pool: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-141[1] print schema
&#160;schema = &quot;table {
&#160; 4: int_to_array_array_map: optional map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, list&amp;lt;list&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt;
}&quot;

Step completed: &lt;span class=&quot;code-quote&quot;&gt;&quot;thread=55e54b9c-8458-49f3-b345-a71abe886c30 HiveServer2-Handler-Pool: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-141&quot;&lt;/span&gt;, org.apache.iceberg.orc.OrcIterable.iterator(), line=89 bci=6155e54b9c-8458-49f3-b345-a71abe886c30 HiveServer2-Handler-Pool: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-141[1] print nameMapping
&#160;nameMapping = &quot;[
&#160; ([int_to_array_array_map] -&amp;gt; 4, [ ([key] -&amp;gt; 8), ([value] -&amp;gt; 9, [ ([element] -&amp;gt; 10, [ ([element] -&amp;gt; 11) ]) ]) ])
]&quot;
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Compared to when the table property namemapping is generated:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/hive/blob/c9e12d84ca0c72732cd24aa0b160f474309f5de9/iceberg/iceberg-handler/src/main/java/org/apache/iceberg/mr/hive/HiveIcebergMetaHook.java#L325&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/c9e12d84ca0c72732cd24aa0b160f474309f5de9/iceberg/iceberg-handler/src/main/java/org/apache/iceberg/mr/hive/HiveIcebergMetaHook.java#L325&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Step completed: &lt;span class=&quot;code-quote&quot;&gt;&quot;thread=HiveServer2-Background-Pool: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-757&quot;&lt;/span&gt;, org.apache.iceberg.mr.hive.HiveIcebergMetaHook.preAlterTable(), line=326 bci=398HiveServer2-Background-Pool: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-757[1] print preAlterTableProperties
&#160;preAlterTableProperties = &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.iceberg.mr.hive.HiveIcebergMetaHook$PreAlterTableProperties@105f9694&quot;&lt;/span&gt;
HiveServer2-Background-Pool: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-757[1] print preAlterTableProperties.schema
&#160;preAlterTableProperties.schema = &quot;table {
&#160; 1: int_primitive: optional &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
&#160; 2: int_array: optional list&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;
&#160; 4: int_array_array: optional list&amp;lt;list&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt;
&#160; 7: int_to_array_array_map: optional map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, list&amp;lt;list&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt;
}&quot;
HiveServer2-Background-Pool: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-757[1] print nameMapping
&#160;nameMapping = &quot;[
&#160; ([int_primitive] -&amp;gt; 1)
&#160; ([int_array] -&amp;gt; 2, [ ([element] -&amp;gt; 3) ])
&#160; ([int_array_array] -&amp;gt; 4, [ ([element] -&amp;gt; 6, [ ([element] -&amp;gt; 5) ]) ])
&#160; ([int_to_array_array_map] -&amp;gt; 7, [ ([key] -&amp;gt; 10), ([value] -&amp;gt; 11, [ ([element] -&amp;gt; 9, [ ([element] -&amp;gt; 8) ]) ]) ])
]&quot;
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Seems like the top level field_ids are already wrong when preAlterTableProperties.schema is created.&lt;/p&gt;

&lt;p&gt;Edit:&lt;br/&gt;
And the traversal is different too&lt;/p&gt;</comment>
                            <comment id="17554915" author="lpinter" created="Thu, 16 Jun 2022 06:12:37 +0000"  >&lt;p&gt;Merged into master. Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvary&quot; class=&quot;user-hover&quot; rel=&quot;pvary&quot;&gt;pvary&lt;/a&gt; for the review!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13449753">HIVE-26317</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13449762">HIVE-26318</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13044758" name="00001-a5d522f4-a065-44e6-983b-ba66596b4332.metadata.json" size="5342" author="gfurnstahl" created="Wed, 8 Jun 2022 08:37:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 21 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z131ns:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>