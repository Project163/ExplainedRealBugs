<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:26:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-28669] Deadlock found when TxnStoreMutex trying to acquireLock</title>
                <link>https://issues.apache.org/jira/browse/HIVE-28669</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Build from the latest master, use the MySQL as back db to run the HMS. After a while, in HMS logs, we can see the deadlock exception:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; 2024-12-16T09:21:39,677 ERROR [Metastore Scheduled Worker 13] service.AcidHouseKeeperService: Unexpected exception in thread: Metastore Scheduled Worker 13, message: Unable to lock HouseKeeper due to: PreparedStatementCallback; SQL [INSERT INTO &quot;AUX_TABLE&quot; (&quot;MT_KEY1&quot;, &quot;MT_KEY2&quot;) VALUES(?, 0)]; (conn=1315) Deadlock found when trying to get lock; try restarting transaction; nested exception is java.sql.SQLTransactionRollbackException: (conn=1315) Deadlock found when trying to get lock; try restarting transaction
java.lang.RuntimeException: Unable to lock HouseKeeper due to: PreparedStatementCallback; SQL [INSERT INTO &quot;AUX_TABLE&quot; (&quot;MT_KEY1&quot;, &quot;MT_KEY2&quot;) VALUES(?, 0)]; (conn=1315) Deadlock found when trying to get lock; try restarting transaction; nested exception is java.sql.SQLTransactionRollbackException: (conn=1315) Deadlock found when trying to get lock; try restarting transaction
&#160; &#160; &#160; &#160; at org.apache.hadoop.hive.metastore.txn.TxnStoreMutex.acquireLock(TxnStoreMutex.java:85) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
&#160; &#160; &#160; &#160; at org.apache.hadoop.hive.metastore.txn.service.AcidHouseKeeperService.run(AcidHouseKeeperService.java:83) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
&#160; &#160; &#160; &#160; at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[?:1.8.0_292]
&#160; &#160; &#160; &#160; at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308) ~[?:1.8.0_292]
&#160; &#160; &#160; &#160; at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180) ~[?:1.8.0_292]
&#160; &#160; &#160; &#160; at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294) ~[?:1.8.0_292]
&#160; &#160; &#160; &#160; at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[?:1.8.0_292]
&#160; &#160; &#160; &#160; at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) ~[?:1.8.0_292]
&#160; &#160; &#160; &#160; at java.lang.Thread.run(Thread.java:748) ~[?:1.8.0_292]
Caused by: org.springframework.dao.DeadlockLoserDataAccessException: PreparedStatementCallback; SQL [INSERT INTO &quot;AUX_TABLE&quot; (&quot;MT_KEY1&quot;, &quot;MT_KEY2&quot;) VALUES(?, 0)]; (conn=1315) Deadlock found when trying to get lock; try restarting transaction; nested exception is java.sql.SQLTransactionRollbackException: (conn=1315) Deadlock found when trying to get lock; try restarting transaction
&#160; &#160; &#160; &#160; at org.springframework.jdbc.support.SQLErrorCodeSQLExceptionTranslator.doTranslate(SQLErrorCodeSQLExceptionTranslator.java:268) ~[spring-jdbc-5.3.39.jar:5.3.39]
&#160; &#160; &#160; &#160; at org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:73) ~[spring-jdbc-5.3.39.jar:5.3.39]
&#160; &#160; &#160; &#160; at org.springframework.jdbc.core.JdbcTemplate.translateException(JdbcTemplate.java:1575) ~[spring-jdbc-5.3.39.jar:5.3.39]
&#160; &#160; &#160; &#160; at org.springframework.jdbc.core.JdbcTemplate.execute(JdbcTemplate.java:667) ~[spring-jdbc-5.3.39.jar:5.3.39]
&#160; &#160; &#160; &#160; at org.springframework.jdbc.core.JdbcTemplate.update(JdbcTemplate.java:960) ~[spring-jdbc-5.3.39.jar:5.3.39]
&#160; &#160; &#160; &#160; at org.springframework.jdbc.core.JdbcTemplate.update(JdbcTemplate.java:981) ~[spring-jdbc-5.3.39.jar:5.3.39]
&#160; &#160; &#160; &#160; at org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate.update(NamedParameterJdbcTemplate.java:331) ~[spring-jdbc-5.3.39.jar:5.3.39]
&#160; &#160; &#160; &#160; at org.apache.hadoop.hive.metastore.txn.TxnStoreMutex.acquireLock(TxnStoreMutex.java:81) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
&#160; &#160; &#160; &#160; ... 8 more
Caused by: java.sql.SQLTransactionRollbackException: (conn=1315) Deadlock found when trying to get lock; try restarting transaction
&#160; &#160; &#160; &#160; at org.mariadb.jdbc.internal.util.exceptions.ExceptionMapper.get(ExceptionMapper.java:245) ~[mariadb-java-client-2.5.0.jar:?]
&#160; &#160; &#160; &#160; at org.mariadb.jdbc.internal.util.exceptions.ExceptionMapper.getException(ExceptionMapper.java:164) ~[mariadb-java-client-2.5.0.jar:?]
&#160; &#160; &#160; &#160; at org.mariadb.jdbc.MariaDbStatement.executeExceptionEpilogue(MariaDbStatement.java:244) ~[mariadb-java-client-2.5.0.jar:?]
&#160; &#160; &#160; &#160; at org.mariadb.jdbc.ClientSidePreparedStatement.executeInternal(ClientSidePreparedStatement.java:225) ~[mariadb-java-client-2.5.0.jar:?]
&#160; &#160; &#160; &#160; at org.mariadb.jdbc.ClientSidePreparedStatement.execute(ClientSidePreparedStatement.java:145) ~[mariadb-java-client-2.5.0.jar:?]
&#160; &#160; &#160; &#160; at org.mariadb.jdbc.ClientSidePreparedStatement.executeUpdate(ClientSidePreparedStatement.java:176) ~[mariadb-java-client-2.5.0.jar:?]
&#160; &#160; &#160; &#160; at org.apache.hive.com.zaxxer.hikari.pool.ProxyPreparedStatement.executeUpdate(ProxyPreparedStatement.java:61) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
&#160; &#160; &#160; &#160; at org.apache.hive.com.zaxxer.hikari.pool.HikariProxyPreparedStatement.executeUpdate(HikariProxyPreparedStatement.java) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
&#160; &#160; &#160; &#160; at org.springframework.jdbc.core.JdbcTemplate.lambda$update$2(JdbcTemplate.java:965) ~[spring-jdbc-5.3.39.jar:5.3.39]2024-12-16T09:21:39,677 ERROR [Metastore Scheduled Worker 13] service.AcidHouseKeeperService: Unexpected exception in thread: Metastore Scheduled Worker 13, message: Unable to lock HouseKeeper due to: PreparedStatementCallback; SQL [INSERT INTO &quot;AUX_TABLE&quot; (&quot;MT_KEY1&quot;, &quot;MT_KEY2&quot;) VALUES(?, 0)]; (conn=1315) Deadlock found when trying to get lock; try restarting transaction; nested exception is java.sql.SQLTransactionRollbackException: (conn=1315) Deadlock found when trying to get lock; try restarting transaction
java.lang.RuntimeException: Unable to lock HouseKeeper due to: PreparedStatementCallback; SQL [INSERT INTO &quot;AUX_TABLE&quot; (&quot;MT_KEY1&quot;, &quot;MT_KEY2&quot;) VALUES(?, 0)]; (conn=1315) Deadlock found when trying to get lock; try restarting transaction; nested exception is java.sql.SQLTransactionRollbackException: (conn=1315) Deadlock found when trying to get lock; try restarting transaction
&#160; &#160; &#160; &#160; at org.apache.hadoop.hive.metastore.txn.TxnStoreMutex.acquireLock(TxnStoreMutex.java:85) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
&#160; &#160; &#160; &#160; at org.apache.hadoop.hive.metastore.txn.service.AcidHouseKeeperService.run(AcidHouseKeeperService.java:83) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
&#160; &#160; &#160; &#160; at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[?:1.8.0_292]
&#160; &#160; &#160; &#160; at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308) ~[?:1.8.0_292]
&#160; &#160; &#160; &#160; at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180) ~[?:1.8.0_292]
&#160; &#160; &#160; &#160; at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294) ~[?:1.8.0_292]
&#160; &#160; &#160; &#160; at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[?:1.8.0_292]
&#160; &#160; &#160; &#160; at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) ~[?:1.8.0_292]
&#160; &#160; &#160; &#160; at java.lang.Thread.run(Thread.java:748) ~[?:1.8.0_292]
Caused by: org.springframework.dao.DeadlockLoserDataAccessException: PreparedStatementCallback; SQL [INSERT INTO &quot;AUX_TABLE&quot; (&quot;MT_KEY1&quot;, &quot;MT_KEY2&quot;) VALUES(?, 0)]; (conn=1315) Deadlock found when trying to get lock; try restarting transaction; nested exception is java.sql.SQLTransactionRollbackException: (conn=1315) Deadlock found when trying to get lock; try restarting transaction
&#160; &#160; &#160; &#160; at org.springframework.jdbc.support.SQLErrorCodeSQLExceptionTranslator.doTranslate(SQLErrorCodeSQLExceptionTranslator.java:268) ~[spring-jdbc-5.3.39.jar:5.3.39]
&#160; &#160; &#160; &#160; at org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:73) ~[spring-jdbc-5.3.39.jar:5.3.39]
&#160; &#160; &#160; &#160; at org.springframework.jdbc.core.JdbcTemplate.translateException(JdbcTemplate.java:1575) ~[spring-jdbc-5.3.39.jar:5.3.39]
&#160; &#160; &#160; &#160; at org.springframework.jdbc.core.JdbcTemplate.execute(JdbcTemplate.java:667) ~[spring-jdbc-5.3.39.jar:5.3.39]
&#160; &#160; &#160; &#160; at org.springframework.jdbc.core.JdbcTemplate.update(JdbcTemplate.java:960) ~[spring-jdbc-5.3.39.jar:5.3.39]
&#160; &#160; &#160; &#160; at org.springframework.jdbc.core.JdbcTemplate.update(JdbcTemplate.java:981) ~[spring-jdbc-5.3.39.jar:5.3.39]
&#160; &#160; &#160; &#160; at org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate.update(NamedParameterJdbcTemplate.java:331) ~[spring-jdbc-5.3.39.jar:5.3.39]
&#160; &#160; &#160; &#160; at org.apache.hadoop.hive.metastore.txn.TxnStoreMutex.acquireLock(TxnStoreMutex.java:81) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
&#160; &#160; &#160; &#160; ... 8 more
Caused by: java.sql.SQLTransactionRollbackException: (conn=1315) Deadlock found when trying to get lock; try restarting transaction
&#160; &#160; &#160; &#160; at org.mariadb.jdbc.internal.util.exceptions.ExceptionMapper.get(ExceptionMapper.java:245) ~[mariadb-java-client-2.5.0.jar:?]
&#160; &#160; &#160; &#160; at org.mariadb.jdbc.internal.util.exceptions.ExceptionMapper.getException(ExceptionMapper.java:164) ~[mariadb-java-client-2.5.0.jar:?]
&#160; &#160; &#160; &#160; at org.mariadb.jdbc.MariaDbStatement.executeExceptionEpilogue(MariaDbStatement.java:244) ~[mariadb-java-client-2.5.0.jar:?]
&#160; &#160; &#160; &#160; at org.mariadb.jdbc.ClientSidePreparedStatement.executeInternal(ClientSidePreparedStatement.java:225) ~[mariadb-java-client-2.5.0.jar:?]
&#160; &#160; &#160; &#160; at org.mariadb.jdbc.ClientSidePreparedStatement.execute(ClientSidePreparedStatement.java:145) ~[mariadb-java-client-2.5.0.jar:?]
&#160; &#160; &#160; &#160; at org.mariadb.jdbc.ClientSidePreparedStatement.executeUpdate(ClientSidePreparedStatement.java:176) ~[mariadb-java-client-2.5.0.jar:?]
&#160; &#160; &#160; &#160; at org.apache.hive.com.zaxxer.hikari.pool.ProxyPreparedStatement.executeUpdate(ProxyPreparedStatement.java:61) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
&#160; &#160; &#160; &#160; at org.apache.hive.com.zaxxer.hikari.pool.HikariProxyPreparedStatement.executeUpdate(HikariProxyPreparedStatement.java) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
&#160; &#160; &#160; &#160; at org.springframework.jdbc.core.JdbcTemplate.lambda$update$2(JdbcTemplate.java:965) ~[spring-jdbc-5.3.39.jar:5.3.39]
...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13602228">HIVE-28669</key>
            <summary>Deadlock found when TxnStoreMutex trying to acquireLock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dengzh">Zhihua Deng</assignee>
                                    <reporter username="dengzh">Zhihua Deng</reporter>
                        <labels>
                            <label>hive-4.1.0-must</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 16 Dec 2024 08:33:49 +0000</created>
                <updated>Tue, 29 Jul 2025 14:51:36 +0000</updated>
                            <resolved>Wed, 8 Jan 2025 07:43:05 +0000</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                    <component>Standalone Metastore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17907299" author="JIRAUSER295901" created="Fri, 20 Dec 2024 08:32:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dengzh&quot; class=&quot;user-hover&quot; rel=&quot;dengzh&quot;&gt;dengzh&lt;/a&gt;, we have seen the similar stacktrace in hive4 on MaterializationsRebuildLockCleanerTask. If I recall correctly, it was because of &lt;b&gt;mysql&lt;/b&gt; configuration &lt;b&gt;transaction_isolation.&lt;/b&gt;&#160;By default it is &lt;b&gt;REPEATABLE-READ&lt;/b&gt; and it&#160;needs to be set to &lt;b&gt;READ-COMMITTED&lt;/b&gt;&#160;to avoid this issue.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Indhumathi27&quot; class=&quot;user-hover&quot; rel=&quot;Indhumathi27&quot;&gt;Indhumathi27&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17907332" author="dengzh" created="Fri, 20 Dec 2024 10:16:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Aggarwal_Raghav&quot; class=&quot;user-hover&quot; rel=&quot;Aggarwal_Raghav&quot;&gt;Aggarwal_Raghav&lt;/a&gt; yes, changing the isolation level can solve the issue, I was thinking making the &lt;b&gt;READ-COMMITTED&lt;/b&gt; as default in TxnStore, where the isolation used to be.&lt;/p&gt;</comment>
                            <comment id="17910951" author="dengzh" created="Wed, 8 Jan 2025 07:43:06 +0000"  >&lt;p&gt;Fix has been pushed to master. Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Aggarwal_Raghav&quot; class=&quot;user-hover&quot; rel=&quot;Aggarwal_Raghav&quot;&gt;Aggarwal_Raghav&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Indhumathi27&quot; class=&quot;user-hover&quot; rel=&quot;Indhumathi27&quot;&gt;Indhumathi27&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkuzmenko&quot; class=&quot;user-hover&quot; rel=&quot;dkuzmenko&quot;&gt;dkuzmenko&lt;/a&gt; for the review!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            44 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1t568:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>