<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:27:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-28222] Ambiguous table alias exception for queries with self joins</title>
                <link>https://issues.apache.org/jira/browse/HIVE-28222</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Various queries containing more than 2 joins of the same table (self joins) fail at compile time.&lt;/p&gt;

&lt;p&gt;A simple reproducer is outlined below.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt; t1 (&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;);

&lt;span class=&quot;code-keyword&quot;&gt;explain&lt;/span&gt; cbo
&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; * &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; 
(&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;, BLOCK__OFFSET__INSIDE__FILE, INPUT__FILE__NAME, ROW__ID, ROW__IS__DELETED &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; t1) &lt;span class=&quot;code-keyword&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;join&lt;/span&gt;
(&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;, BLOCK__OFFSET__INSIDE__FILE, INPUT__FILE__NAME, ROW__ID, ROW__IS__DELETED &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; t1) b &lt;span class=&quot;code-keyword&quot;&gt;join&lt;/span&gt;
(&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;, BLOCK__OFFSET__INSIDE__FILE, INPUT__FILE__NAME, ROW__ID, ROW__IS__DELETED &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; t1) &lt;span class=&quot;code-keyword&quot;&gt;c&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The query fails with the following stacktrace:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.ql.parse.SemanticException: Line 0:-1 Ambiguous table alias &apos;t1&apos;
        at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.processTable(SemanticAnalyzer.java:1167) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.processJoin(SemanticAnalyzer.java:1679) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.doPhase1(SemanticAnalyzer.java:1899) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.doPhase1(SemanticAnalyzer.java:2113) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.doPhase1(SemanticAnalyzer.java:1754) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.parse.CalcitePlanner.genOPTree(CalcitePlanner.java:628) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.analyzeInternal(SemanticAnalyzer.java:13178) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.parse.CalcitePlanner.analyzeInternal(CalcitePlanner.java:465) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.parse.BaseSemanticAnalyzer.analyze(BaseSemanticAnalyzer.java:327) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.parse.ExplainSemanticAnalyzer.analyzeInternal(ExplainSemanticAnalyzer.java:180) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.parse.BaseSemanticAnalyzer.analyze(BaseSemanticAnalyzer.java:327) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.Compiler.analyze(Compiler.java:224) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.Compiler.compile(Compiler.java:107) ~[hive-exec-4.1.0-SNAPSHOT.jar:4.1.0-SNAPSHOT]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The same problem can be hit in other ways when using materialized views (&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13068478/13068478_cbo_self_join_ambiguous_alias_mv.q&quot; title=&quot;cbo_self_join_ambiguous_alias_mv.q attached to HIVE-28222&quot;&gt;cbo_self_join_ambiguous_alias_mv.q&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;) and common table expressions ( &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13068479/13068479_cbo_self_join_ambiguous_alias_cte.q&quot; title=&quot;cbo_self_join_ambiguous_alias_cte.q attached to HIVE-28222&quot;&gt;cbo_self_join_ambiguous_alias_cte.q&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13577358">HIVE-28222</key>
            <summary>Ambiguous table alias exception for queries with self joins</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zabetak">Stamatis Zampetakis</assignee>
                                    <reporter username="zabetak">Stamatis Zampetakis</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 26 Apr 2024 12:33:27 +0000</created>
                <updated>Tue, 7 Oct 2025 08:37:09 +0000</updated>
                            <resolved>Mon, 11 Aug 2025 09:44:26 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.2.0</fixVersion>
                                    <component>CBO</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17841200" author="zabetak" created="Fri, 26 Apr 2024 12:38:05 +0000"  >&lt;p&gt;The query fails while trying to transform the optimized AST obtained from the CBO plan to an Operator tree. The final CBO plan that leads to the &quot;problematic&quot; AST is shown below.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2024-04-26T05:15:50,258 DEBUG [798b06bb-715e-4933-87a0-0bfe7dbe4c22 main] translator.PlanModifierForASTConv: Final plan after modifier
&#160;HiveProject(a.key=[$0], a.value=[$1], a.block__offset__inside__file=[$2], a.input__file__name=[$3], a.row__id=[$4], a.row__is__deleted=[$5], b.key=[$12], b.value=[$13], b.block__offset__inside__file=[$14], b.input__file__name=[$15], b.row__id=[$16], b.row__is__deleted=[$17
], c.key=[$6], c.value=[$7], c.block__offset__inside__file=[$8], c.input__file__name=[$9], c.row__id=[$10], c.row__is__deleted=[$11])
&#160; HiveJoin(condition=[true], joinType=[inner], algorithm=[none], cost=[not available])
&#160; &#160; HiveJoin(condition=[true], joinType=[inner], algorithm=[none], cost=[not available])
&#160; &#160; &#160; HiveProject(key=[$0], value=[$1], BLOCK__OFFSET__INSIDE__FILE=[$2], INPUT__FILE__NAME=[$3], ROW__ID=[$4], ROW__IS__DELETED=[$5])
&#160; &#160; &#160; &#160; HiveTableScan(table=[[default, t1]], table:alias=[t1])
&#160; &#160; &#160; HiveTableScan(table=[[default, t1]], table:alias=[t1])
&#160; &#160; HiveTableScan(table=[[default, t1]], table:alias=[t1])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It is worth noticing that a HiveTableScan with the &quot;t1&quot; alias appears three times. The exception is raised when a HiveJoin contains the same table scan multiple times (without an interleaving project) cause the generated AST is ambiguous.&lt;/p&gt;</comment>
                            <comment id="17928946" author="zabetak" created="Thu, 20 Feb 2025 23:39:42 +0000"  >&lt;p&gt;The problem can also appear after the &lt;a href=&quot;https://github.com/apache/hive/blob/12966e7cd7e33ff71a0f860e1112e57af7993012/ql/src/java/org/apache/hadoop/hive/ql/parse/CalcitePlanner.java#L1752&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CTE rewriting phase&lt;/a&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-28259&quot; title=&quot;Common table expression detection and rewrites using CBO&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-28259&quot;&gt;&lt;del&gt;HIVE-28259&lt;/del&gt;&lt;/a&gt;) since CTEs are represented as materialized views.&#160;&lt;/p&gt;</comment>
                            <comment id="18013188" author="zabetak" created="Mon, 11 Aug 2025 09:44:26 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/hive/commit/3b970251f456f49a73297e06bc5f2e1a794dad2a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/commit/3b970251f456f49a73297e06bc5f2e1a794dad2a&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13630852">HIVE-29249</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13579250">HIVE-28259</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13068479" name="cbo_self_join_ambiguous_alias_cte.q" size="209" author="zabetak" created="Fri, 26 Apr 2024 12:29:56 +0000"/>
                            <attachment id="13068478" name="cbo_self_join_ambiguous_alias_mv.q" size="410" author="zabetak" created="Fri, 26 Apr 2024 12:29:56 +0000"/>
                            <attachment id="13068477" name="cbo_self_join_ambiguous_alias_subquery.q" size="392" author="zabetak" created="Fri, 26 Apr 2024 12:29:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ow9c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>