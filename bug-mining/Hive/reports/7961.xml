<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:20:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-21935] Hive Vectorization : degraded performance with vectorize UDF  </title>
                <link>https://issues.apache.org/jira/browse/HIVE-21935</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;with vectorization turned on and hive.vectorized.adaptor.usage.mode=all we were seeing severe performance degradation. looking at the task jstacks it seems that it is running the code which vectorizes UDF and stuck in some loop.&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
jstack -l 14954 | grep 0x3af0 -A20
&lt;span class=&quot;code-quote&quot;&gt;&quot;TezChild&quot;&lt;/span&gt; #15 daemon prio=5 os_prio=0 tid=0x00007f157538d800 nid=0x3af0 runnable [0x00007f1547581000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
	at org.apache.hadoop.hive.ql.exec.vector.VectorAssignRow.assignRowColumn(VectorAssignRow.java:573)
	at org.apache.hadoop.hive.ql.exec.vector.VectorAssignRow.assignRowColumn(VectorAssignRow.java:350)
	at org.apache.hadoop.hive.ql.exec.vector.udf.VectorUDFAdaptor.setResult(VectorUDFAdaptor.java:205)
	at org.apache.hadoop.hive.ql.exec.vector.udf.VectorUDFAdaptor.evaluate(VectorUDFAdaptor.java:150)
	at org.apache.hadoop.hive.ql.exec.vector.expressions.VectorExpression.evaluateChildren(VectorExpression.java:271)
	at org.apache.hadoop.hive.ql.exec.vector.expressions.ListIndexColScalar.evaluate(ListIndexColScalar.java:59)
	at org.apache.hadoop.hive.ql.exec.vector.VectorSelectOperator.process(VectorSelectOperator.java:146)
	at org.apache.hadoop.hive.ql.exec.Operator.vectorForward(Operator.java:965)
	at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:938)
	at org.apache.hadoop.hive.ql.exec.TableScanOperator.process(TableScanOperator.java:125)
	at org.apache.hadoop.hive.ql.exec.vector.VectorMapOperator.process(VectorMapOperator.java:889)
	at org.apache.hadoop.hive.ql.exec.tez.MapRecordSource.processRow(MapRecordSource.java:92)
	at org.apache.hadoop.hive.ql.exec.tez.MapRecordSource.pushRecord(MapRecordSource.java:76)
	at org.apache.hadoop.hive.ql.exec.tez.MapRecordProcessor.run(MapRecordProcessor.java:426)
	at org.apache.hadoop.hive.ql.exec.tez.TezProcessor.initializeAndRunProcessor(TezProcessor.java:267)
	at org.apache.hadoop.hive.ql.exec.tez.TezProcessor.run(TezProcessor.java:250)
	at org.apache.tez.runtime.LogicalIOProcessorRuntimeTask.run(LogicalIOProcessorRuntimeTask.java:374)
	at org.apache.tez.runtime.task.TaskRunner2Callable$1.run(TaskRunner2Callable.java:73)
	at org.apache.tez.runtime.task.TaskRunner2Callable$1.run(TaskRunner2Callable.java:61)
[yarn@hdp32b ~]$ jstack -l 14954 | grep 0x3af0 -A20
&lt;span class=&quot;code-quote&quot;&gt;&quot;TezChild&quot;&lt;/span&gt; #15 daemon prio=5 os_prio=0 tid=0x00007f157538d800 nid=0x3af0 runnable [0x00007f1547581000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
	at org.apache.hadoop.hive.ql.exec.vector.BytesColumnVector.ensureSize(BytesColumnVector.java:554)
	at org.apache.hadoop.hive.ql.exec.vector.VectorAssignRow.assignRowColumn(VectorAssignRow.java:570)
	at org.apache.hadoop.hive.ql.exec.vector.VectorAssignRow.assignRowColumn(VectorAssignRow.java:350)
	at org.apache.hadoop.hive.ql.exec.vector.udf.VectorUDFAdaptor.setResult(VectorUDFAdaptor.java:205)
	at org.apache.hadoop.hive.ql.exec.vector.udf.VectorUDFAdaptor.evaluate(VectorUDFAdaptor.java:150)
	at org.apache.hadoop.hive.ql.exec.vector.expressions.VectorExpression.evaluateChildren(VectorExpression.java:271)
	at org.apache.hadoop.hive.ql.exec.vector.expressions.ListIndexColScalar.evaluate(ListIndexColScalar.java:59)
	at org.apache.hadoop.hive.ql.exec.vector.VectorSelectOperator.process(VectorSelectOperator.java:146)
	at org.apache.hadoop.hive.ql.exec.Operator.vectorForward(Operator.java:965)
	at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:938)
	at org.apache.hadoop.hive.ql.exec.TableScanOperator.process(TableScanOperator.java:125)
	at org.apache.hadoop.hive.ql.exec.vector.VectorMapOperator.process(VectorMapOperator.java:889)
	at org.apache.hadoop.hive.ql.exec.tez.MapRecordSource.processRow(MapRecordSource.java:92)
	at org.apache.hadoop.hive.ql.exec.tez.MapRecordSource.pushRecord(MapRecordSource.java:76)
	at org.apache.hadoop.hive.ql.exec.tez.MapRecordProcessor.run(MapRecordProcessor.java:426)
	at org.apache.hadoop.hive.ql.exec.tez.TezProcessor.initializeAndRunProcessor(TezProcessor.java:267)
	at org.apache.hadoop.hive.ql.exec.tez.TezProcessor.run(TezProcessor.java:250)
	at org.apache.tez.runtime.LogicalIOProcessorRuntimeTask.run(LogicalIOProcessorRuntimeTask.java:374)
	at org.apache.tez.runtime.task.TaskRunner2Callable$1.run(TaskRunner2Callable.java:73)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;after setting the hive.vectorized.adaptor.usage.mode=none query did complete much faster.&lt;/p&gt;

&lt;p&gt;Steps To Reproduce:&lt;br/&gt;
1. Create Table:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+----------------------------------------------------+
|                   createtab_stmt                   |
+----------------------------------------------------+
| CREATE EXTERNAL TABLE `splittestloc`(              |
|   `id` &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,                                        |
|   `value` string)                                  |
| ROW FORMAT SERDE                                   |
|   &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe&apos;&lt;/span&gt;  |
| WITH SERDEPROPERTIES (                             |
|   &lt;span class=&quot;code-quote&quot;&gt;&apos;field.delim&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;,&apos;&lt;/span&gt;,                               |
|   &lt;span class=&quot;code-quote&quot;&gt;&apos;serialization.format&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;,&apos;&lt;/span&gt;)                      |
| STORED AS INPUTFORMAT                              |
|   &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.hadoop.mapred.TextInputFormat&apos;&lt;/span&gt;       |
| OUTPUTFORMAT                                       |
|   &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat&apos;&lt;/span&gt; |
| LOCATION                                           |
|   &lt;span class=&quot;code-quote&quot;&gt;&apos;hdfs:&lt;span class=&quot;code-comment&quot;&gt;//hdp31a.hdp.local:8020/tmp/splittableloc&apos;&lt;/span&gt; |
&lt;/span&gt;| TBLPROPERTIES (                                    |
|   &lt;span class=&quot;code-quote&quot;&gt;&apos;bucketing_version&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;2&apos;&lt;/span&gt;,                         |
|   &lt;span class=&quot;code-quote&quot;&gt;&apos;transient_lastDdlTime&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;1561482451&apos;&lt;/span&gt;)            |
+----------------------------------------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2. Sample data: table has some 40M rows and sample data is generated using following script.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in {1..40000000} ; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; echo $i,&lt;span class=&quot;code-quote&quot;&gt;&quot;start#mid#&quot;&lt;/span&gt;$i &amp;gt;&amp;gt; data.log ; done
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3. I believe this should be reproducible with hive generic split but I am attaching the custom UDF to split the string.&lt;/p&gt;

&lt;p&gt;4. create a function&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
add jar /tmp/CustomSplit-1.0-SNAPSHOT.jar; 
create temporary function mysplit as &lt;span class=&quot;code-quote&quot;&gt;&apos;com.rajkrrsingh.split.test.CustomSplit&apos;&lt;/span&gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;5. run the following query which will reproduce the issue if vectorization turned on.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
create temporary table tmp2 as select id,mysplit(value,&lt;span class=&quot;code-quote&quot;&gt;&quot;#&quot;&lt;/span&gt;)[2] from splittestloc 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment>&lt;p&gt;Hive-3, JDK-8&lt;/p&gt;</environment>
        <key id="13242241">HIVE-21935</key>
            <summary>Hive Vectorization : degraded performance with vectorize UDF  </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mustafaiman">Mustafa &#304;man</assignee>
                                    <reporter username="Rajkumar Singh">Rajkumar Singh</reporter>
                        <labels>
                            <label>performance</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 28 Jun 2019 21:42:53 +0000</created>
                <updated>Mon, 5 Jun 2023 19:51:11 +0000</updated>
                            <resolved>Mon, 17 May 2021 23:39:42 +0000</resolved>
                                    <version>3.1.1</version>
                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                    <component>Vectorization</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6000">1h 40m</timespent>
                                <comments>
                            <comment id="16875255" author="gopalv" created="Fri, 28 Jun 2019 21:52:15 +0000"  >&lt;p&gt;Actually, the execution is buffering 1024 rows - the index is not evaluated until the 1024 split calls are queued up&lt;/p&gt;</comment>
                            <comment id="16876376" author="rajkumar singh" created="Mon, 1 Jul 2019 17:30:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt; This is greatly affecting the job performance, with hive.vectorized.adaptor.usage.mode=all the same job is taking ~5000seconds  while setting the property none it will be able to complete in ~21seconds. is there a way we can increase the rows queued for buffering?&lt;/p&gt;</comment>
                            <comment id="16890525" author="gopalv" created="Mon, 22 Jul 2019 22:57:37 +0000"  >&lt;p&gt;This is an indirect side-effect of vectorizing ListColumnVector - not directly the UDF&lt;/p&gt;</comment>
                            <comment id="17338676" author="mustafaiman" created="Mon, 3 May 2021 23:41:56 +0000"  >&lt;p&gt;VectorMapOperator does not reset output columns in VectorizedRowBatch for text input. It resets only input columns. Normally this does not cause problems because VectorizedRowBatch size generally stays the same at 1024 rows. However, ListColumnVector and MapColumnVector can grow indefinitely unless they are reset after each row batch is processed. This is what happens here. ListColumnVector just grows until it can fit all thousands of rows.&lt;/p&gt;

&lt;p&gt;I sent &lt;a href=&quot;https://github.com/apache/hive/pull/2242&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/pull/2242&lt;/a&gt;&#160;to fix this. For some reason original implementation excludes output columns from reset. I think all the columns can be reset without a problem. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt;&#160;do you have any idea if this is breaking anything?&lt;/p&gt;</comment>
                            <comment id="17346482" author="mustafaiman" created="Mon, 17 May 2021 23:39:42 +0000"  >&lt;p&gt;Merged to master. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pgaref&quot; class=&quot;user-hover&quot; rel=&quot;pgaref&quot;&gt;pgaref&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abstractdog&quot; class=&quot;user-hover&quot; rel=&quot;abstractdog&quot;&gt;abstractdog&lt;/a&gt;&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajesh.balamohan&quot; class=&quot;user-hover&quot; rel=&quot;rajesh.balamohan&quot;&gt;rajesh.balamohan&lt;/a&gt;&#160;and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt;&#160;for reviews.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13538818">HIVE-27412</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12973212" name="CustomSplit-1.0-SNAPSHOT.jar" size="4762" author="Rajkumar Singh" created="Fri, 28 Jun 2019 21:43:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 26 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z047o8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>