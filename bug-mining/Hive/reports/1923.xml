<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:16:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-6389] LazyBinaryColumnarSerDe-based RCFile tables break when looking up elements in null-maps.</title>
                <link>https://issues.apache.org/jira/browse/HIVE-6389</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;RCFile tables that use the LazyBinaryColumnarSerDe don&apos;t seem to handle look-ups into map-columns when the value of the column is null.&lt;/p&gt;

&lt;p&gt;When an RCFile table is created with LazyBinaryColumnarSerDe (as is default in 0.12), and queried as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;select mymap[&lt;span class=&quot;code-quote&quot;&gt;&apos;1024&apos;&lt;/span&gt;] from mytable;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and if the mymap column has nulls, then one is treated to the following guttural utterance:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2014-02-05 21:50:25,050 FATAL mr.ExecMapper (ExecMapper.java:map(194)) - org.apache.hadoop.hive.ql.metadata.HiveException: Hive &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt; Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing row {&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;mymap&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;isnull&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}
  at org.apache.hadoop.hive.ql.exec.MapOperator.process(MapOperator.java:534)
  at org.apache.hadoop.hive.ql.exec.mr.ExecMapper.map(ExecMapper.java:177)
  at org.apache.hadoop.mapred.MapRunner.run(MapRunner.java:54)
  at org.apache.hadoop.mapred.MapTask.runOldMapper(MapTask.java:429)
  at org.apache.hadoop.mapred.MapTask.run(MapTask.java:341)
  at org.apache.hadoop.mapred.LocalJobRunner$Job$MapTaskRunnable.run(LocalJobRunner.java:235)
  at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
  at java.util.concurrent.FutureTask.run(FutureTask.java:262)
  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
  at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744)
Caused by: java.lang.ClassCastException: java.lang.&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to org.apache.hadoop.io.Text
  at org.apache.hadoop.hive.serde2.objectinspector.primitive.WritableStringObjectInspector.getPrimitiveWritableObject(WritableStringObjectInspector.java:41)
  at org.apache.hadoop.hive.serde2.lazy.LazyUtils.writePrimitiveUTF8(LazyUtils.java:226)
  at org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe.serialize(LazySimpleSerDe.java:486)
  at org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe.serializeField(LazySimpleSerDe.java:439)
  at org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe.serialize(LazySimpleSerDe.java:423)
  at org.apache.hadoop.hive.ql.exec.FileSinkOperator.processOp(FileSinkOperator.java:560)
  at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:790)
  at org.apache.hadoop.hive.ql.exec.SelectOperator.processOp(SelectOperator.java:87)
  at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:790)
  at org.apache.hadoop.hive.ql.exec.TableScanOperator.processOp(TableScanOperator.java:92)
  at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:790)
  at org.apache.hadoop.hive.ql.exec.MapOperator.process(MapOperator.java:524)
  ... 10 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A patch is on the way, but the short of it is that the LazyBinaryMapOI needs to return nulls if either the map or the lookup-key is null.&lt;/p&gt;

&lt;p&gt;This is handled correctly for Text data, and for RCFiles using ColumnarSerDe.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12693800">HIVE-6389</key>
            <summary>LazyBinaryColumnarSerDe-based RCFile tables break when looking up elements in null-maps.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mithun">Mithun Radhakrishnan</assignee>
                                    <reporter username="mithun">Mithun Radhakrishnan</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 Feb 2014 01:33:32 +0000</created>
                <updated>Mon, 3 Mar 2014 18:06:24 +0000</updated>
                            <resolved>Mon, 3 Mar 2014 18:06:24 +0000</resolved>
                                    <version>0.10.0</version>
                    <version>0.11.0</version>
                    <version>0.12.0</version>
                    <version>0.13.0</version>
                                    <fixVersion>0.13.0</fixVersion>
                                    <component>Serializers/Deserializers</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13894087" author="mithun" created="Fri, 7 Feb 2014 01:35:17 +0000"  >&lt;p&gt;The fix (for trunk/) is attached.&lt;/p&gt;</comment>
                            <comment id="13895283" author="hiveqa" created="Sat, 8 Feb 2014 00:07:34 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12627529/Hive-6389.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12627529/Hive-6389.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 1 failed/errored test(s), 5040 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestMinimrCliDriver.testCliDriver_auto_sortmerge_join_16
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/1241/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/1241/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/1241/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/1241/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 1 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12627529&lt;/p&gt;</comment>
                            <comment id="13915876" author="ashutoshc" created="Fri, 28 Feb 2014 15:31:31 +0000"  >&lt;p&gt;Mithun, is the stack trace you posted above correct? &lt;br/&gt;
From bug description I would have expected NPE from LazyBinaryColSerde on read side, but stack trace suggests some exception while writing data and that too from LazySimpleSerde. &lt;br/&gt;
Also, looking at code in LazyBinaryMapOI, it doesn&apos;t look like that key is dereferenced in a manner which can throw NPE. So, not sure how your null catching of key will fix problem you described.&lt;br/&gt;
I think I am struggling to understand both problem as well as fix. If you can add the testcase in your patch, that will help a lot.&lt;/p&gt;</comment>
                            <comment id="13917697" author="mithun" created="Mon, 3 Mar 2014 02:36:58 +0000"  >&lt;p&gt;Hey, Ashutosh. As a matter of fact, this stack trace is the result of running &quot;select mymap[ &apos;xyz&apos; ] from mytable&quot;, if mytable has null values for mymap. Although the bug is in the LazyBinaryObjectInspector for Maps, it doesn&apos;t manifest at the time of read.&lt;br/&gt;
The reason you&apos;re seeing a fail in LazySimpleSerde is because the results of the query are being serialized into String (i.e. to console).&lt;/p&gt;

&lt;p&gt;The LazyBinaryMapOI returns -1 for NULL maps. WHen the LazySimpleSerde attempts to convert this Integer into Text, we get this bad-cast exception. The OI should have been returning nulls for null objects, like the ColumnarSerDe does.&lt;/p&gt;

&lt;p&gt;The way I tested this is:&lt;br/&gt;
1. create table mytable_text( mymap map&amp;lt;string, string&amp;gt; ) stored as textfile;&lt;br/&gt;
2. echo &quot;\N\n\N\n\N&quot; &amp;gt; /tmp/mytable.txt &amp;amp;&amp;amp; hdfs dfs -copyFromLocal /tmp/mytable.txt /user/hive/warehouse/mytable_text&lt;br/&gt;
3. create table mytable_rcfile( mymap map&amp;lt;string, string&amp;gt; ) stored as rcfile; &amp;#8211; LazyBinaryColumnarSerDe&lt;br/&gt;
4. insert overwrite table mytable_rcfile select mymap from mytable_text;&lt;br/&gt;
5. select mymap&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;blah&amp;#39;&amp;#93;&lt;/span&gt; from mytable_rcfile;&lt;/p&gt;

&lt;p&gt;Steps 1-4 is simply to insert a null-map into an RCFile-based table.&lt;br/&gt;
Step 5 causes the null-map to be returned by LazyBinaryMapOI as &apos;-1&apos;, etc.&lt;/p&gt;

&lt;p&gt;This patch brings LazyBinaryMapOI&apos;s behaviour in line with LazyMapOI. (This is likely just a copy-paste error, from getMapSize().&lt;/p&gt;
</comment>
                            <comment id="13917716" author="ashutoshc" created="Mon, 3 Mar 2014 03:44:43 +0000"  >&lt;p&gt;I see.  Thanks for explanation. Makes sense now.&lt;br/&gt;
Problem is map itself is null, I thought you are dealing with a case of null-key in a map and fixing it by if ( .. || key == null) check. Although key == null check is not required, because null will be correctly returned in that case (also evident in LazyMapOI). Fix is to return null instead of -1 for data == null case. Anyhow, fix looks good. &lt;br/&gt;
+1 can you re-upload the patch to get Hive QA to re-run.&lt;/p&gt;</comment>
                            <comment id="13918147" author="mithun" created="Mon, 3 Mar 2014 15:20:46 +0000"  >&lt;p&gt;Pulling patch. Will capitalize and resubmit.&lt;/p&gt;</comment>
                            <comment id="13918149" author="mithun" created="Mon, 3 Mar 2014 15:21:29 +0000"  >&lt;p&gt;Renamed.&lt;/p&gt;</comment>
                            <comment id="13918277" author="hiveqa" created="Mon, 3 Mar 2014 17:09:13 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12632273/HIVE-6389.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12632273/HIVE-6389.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 2 failed/errored test(s), 5218 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestMinimrCliDriver.testCliDriver_bucketizedhiveinputformat
org.apache.hive.hcatalog.mapreduce.TestHCatMutablePartitioned.testHCatPartitionedTable
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/1605/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/1605/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/1605/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/1605/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 2 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12632273&lt;/p&gt;</comment>
                            <comment id="13918332" author="ashutoshc" created="Mon, 3 Mar 2014 18:06:24 +0000"  >&lt;p&gt;Committed to trunk. Thanks, Mithun!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12632273" name="HIVE-6389.patch" size="792" author="mithun" created="Mon, 3 Mar 2014 15:21:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>372309</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 38 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1s5vj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>372613</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>