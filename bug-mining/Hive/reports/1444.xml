<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:09:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-5144] HashTableSink allocates empty new Object[] arrays &amp; OOMs - use a static emptyRow instead</title>
                <link>https://issues.apache.org/jira/browse/HIVE-5144</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;The map-join hashtable sink in the local-task creates an in-memory hashtable with the following code.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] value = JoinUtil.computeMapJoinValues(row, joinValues[alias],
...
 MapJoinRowContainer rowContainer = tableContainer.get(key);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rowContainer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      rowContainer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MapJoinRowContainer();
      rowContainer.add(value);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But for a query where the joinValues&lt;span class=&quot;error&quot;&gt;&amp;#91;alias&amp;#93;&lt;/span&gt;.size() == 0, this results in a large number of unnecessary allocations which would be better served with a copy-on-write default value container &amp;amp; a pre-allocated zero object array which is immutable (the only immutable array there is in java).&lt;/p&gt;

&lt;p&gt;The query tested is roughly the following to scan all of customer_demographics in the hash-sink&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select c_salutation, count(1)
 from customer
      JOIN customer_demographics ON customer.c_current_cdemo_sk = customer_demographics.cd_demo_sk
 group by c_salutation
 limit 10
;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When running with current trunk, the code results in an OOM with 512Mb ram.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2013-08-23 05:11:26	Processing rows:	1400000	Hashtable size:	1399999	Memory usage:	292418944	percentage:	0.579

Execution failed with exit status: 3
Obtaining error information
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment>&lt;p&gt;Ubuntu LXC + -Xmx512m client opts&lt;/p&gt;</environment>
        <key id="12665264">HIVE-5144</key>
            <summary>HashTableSink allocates empty new Object[] arrays &amp; OOMs - use a static emptyRow instead</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gopalv">Gopal Vijayaraghavan</assignee>
                                    <reporter username="gopalv">Gopal Vijayaraghavan</reporter>
                        <labels>
                            <label>perfomance</label>
                    </labels>
                <created>Fri, 23 Aug 2013 17:15:49 +0000</created>
                <updated>Tue, 15 Oct 2013 23:30:49 +0000</updated>
                            <resolved>Tue, 27 Aug 2013 16:48:54 +0000</resolved>
                                                    <fixVersion>0.12.0</fixVersion>
                                    <component>Query Processor</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13748737" author="gopalv" created="Fri, 23 Aug 2013 17:21:36 +0000"  >&lt;p&gt;With the attached patch, the memory usage drops from 199 Mb per million rows to approx 99 Mb per million rows.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2013-08-23 05:14:06	Processing rows:	1900000	Hashtable size:	1899999	Memory usage:	197394288	percentage:	0.391
...
OK
	2475
Dr.	40003
Mrs.	16612
Ms.	16617
Mr.	23590
Miss	16368
Sir	23394
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13748749" author="gopalv" created="Fri, 23 Aug 2013 17:29:33 +0000"  >&lt;p&gt;Tests running with `ant test -Dmodule=ql -Dresolvers=internal -Dtestcase=TestCliDriver -Dqfile_pattern=&lt;b&gt;mapjoin&lt;/b&gt;`&lt;/p&gt;

&lt;p&gt;Submit-patch for full QA run.&lt;/p&gt;</comment>
                            <comment id="13748839" author="ashutoshc" created="Fri, 23 Aug 2013 18:31:34 +0000"  >&lt;p&gt;Nice findings, Gopal!&lt;/p&gt;

&lt;p&gt;Couple of comments:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shall we do initialization of empty row and container in the constructor?&lt;/li&gt;
	&lt;li&gt;Also mark these fields as transient.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13748846" author="gopalv" created="Fri, 23 Aug 2013 18:45:05 +0000"  >&lt;p&gt;I followed the pattern from MapJoinKey and MapJoinRowContainer which both use static final EMPTY_OBJECT_ARRAY[].&lt;/p&gt;

&lt;p&gt;And since the empty items are immutable, I followed the same pattern.&lt;/p&gt;
</comment>
                            <comment id="13748896" author="gopalv" created="Fri, 23 Aug 2013 19:26:35 +0000"  >&lt;p&gt;Test case run finished, auto_join30.q fails. &lt;/p&gt;

&lt;p&gt;Cancelling patch.&lt;/p&gt;</comment>
                            <comment id="13750158" author="gopalv" created="Mon, 26 Aug 2013 15:46:23 +0000"  >&lt;p&gt;Bad merge in patch.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;((hasFilter(alias) &amp;amp;&amp;amp; joinFilters[alias].size() &amp;gt; 0) || joinValues[alias]
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;((hasFilter(alias) &amp;amp;&amp;amp; filterMaps[alias].length &amp;gt; 0) || joinValues[alias].
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The check is supposed to be on filterMaps not joinFilters.&lt;/p&gt;

&lt;p&gt;This fixes test-failures found in the last run.&lt;/p&gt;</comment>
                            <comment id="13750182" author="ashutoshc" created="Mon, 26 Aug 2013 16:06:32 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13751426" author="ashutoshc" created="Tue, 27 Aug 2013 16:48:54 +0000"  >&lt;p&gt;Committed to trunk. Thanks, Gopal!&lt;/p&gt;</comment>
                            <comment id="13751824" author="hudson" created="Tue, 27 Aug 2013 22:42:55 +0000"  >&lt;p&gt;FAILURE: Integrated in Hive-trunk-hadoop2-ptest #73 (See &lt;a href=&quot;https://builds.apache.org/job/Hive-trunk-hadoop2-ptest/73/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hive-trunk-hadoop2-ptest/73/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-5144&quot; title=&quot;HashTableSink allocates empty new Object[] arrays &amp;amp; OOMs - use a static emptyRow instead&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-5144&quot;&gt;&lt;del&gt;HIVE-5144&lt;/del&gt;&lt;/a&gt; : HashTableSink allocates empty new Object[] arrays &amp;amp; OOMs - use a static emptyRow instead (Gopal V via Ashutosh Chauhan) (hashutosh: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1517877&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1517877&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/HashTableSinkOperator.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13752025" author="hudson" created="Wed, 28 Aug 2013 01:56:23 +0000"  >&lt;p&gt;FAILURE: Integrated in Hive-trunk-hadoop1-ptest #141 (See &lt;a href=&quot;https://builds.apache.org/job/Hive-trunk-hadoop1-ptest/141/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hive-trunk-hadoop1-ptest/141/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-5144&quot; title=&quot;HashTableSink allocates empty new Object[] arrays &amp;amp; OOMs - use a static emptyRow instead&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-5144&quot;&gt;&lt;del&gt;HIVE-5144&lt;/del&gt;&lt;/a&gt; : HashTableSink allocates empty new Object[] arrays &amp;amp; OOMs - use a static emptyRow instead (Gopal V via Ashutosh Chauhan) (hashutosh: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1517877&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1517877&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/HashTableSinkOperator.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13752072" author="hudson" created="Wed, 28 Aug 2013 03:32:00 +0000"  >&lt;p&gt;SUCCESS: Integrated in Hive-trunk-h0.21 #2294 (See &lt;a href=&quot;https://builds.apache.org/job/Hive-trunk-h0.21/2294/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hive-trunk-h0.21/2294/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-5144&quot; title=&quot;HashTableSink allocates empty new Object[] arrays &amp;amp; OOMs - use a static emptyRow instead&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-5144&quot;&gt;&lt;del&gt;HIVE-5144&lt;/del&gt;&lt;/a&gt; : HashTableSink allocates empty new Object[] arrays &amp;amp; OOMs - use a static emptyRow instead (Gopal V via Ashutosh Chauhan) (hashutosh: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1517877&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1517877&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/HashTableSinkOperator.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13752349" author="hudson" created="Wed, 28 Aug 2013 12:42:19 +0000"  >&lt;p&gt;FAILURE: Integrated in Hive-trunk-hadoop2 #386 (See &lt;a href=&quot;https://builds.apache.org/job/Hive-trunk-hadoop2/386/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hive-trunk-hadoop2/386/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-5144&quot; title=&quot;HashTableSink allocates empty new Object[] arrays &amp;amp; OOMs - use a static emptyRow instead&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-5144&quot;&gt;&lt;del&gt;HIVE-5144&lt;/del&gt;&lt;/a&gt; : HashTableSink allocates empty new Object[] arrays &amp;amp; OOMs - use a static emptyRow instead (Gopal V via Ashutosh Chauhan) (hashutosh: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1517877&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1517877&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/HashTableSinkOperator.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13796081" author="ashutoshc" created="Tue, 15 Oct 2013 23:30:49 +0000"  >&lt;p&gt;This issue has been fixed and released as part of 0.12 release. If you find further issues, please create a new jira and link it to this one.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12599661" name="HIVE-5144.01.patch" size="2363" author="gopalv" created="Fri, 23 Aug 2013 17:21:36 +0000"/>
                            <attachment id="12599958" name="HIVE-5144.02.patch" size="2362" author="gopalv" created="Mon, 26 Aug 2013 15:46:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>345204</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 6 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1nj27:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>345505</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Save memory in HashTableSink for key-only map-joins, by reusing a single EMPTY_ROW_CONTAINER object</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>