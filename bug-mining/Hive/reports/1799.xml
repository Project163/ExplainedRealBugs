<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:14:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-5891] Alias conflict when merging multiple mapjoin tasks into their common child mapred task</title>
                <link>https://issues.apache.org/jira/browse/HIVE-5891</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Use the following test case with HIVE 0.12:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt; src(&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;);
&lt;span class=&quot;code-keyword&quot;&gt;load&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;local&lt;/span&gt; inpath &lt;span class=&quot;code-quote&quot;&gt;&apos;src/&lt;span class=&quot;code-keyword&quot;&gt;data&lt;/span&gt;/files/kv1.txt&apos;&lt;/span&gt; overwrite &lt;span class=&quot;code-keyword&quot;&gt;into&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt; src;
&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; * &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; (
  &lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;c&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
    (&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;a&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; src &lt;span class=&quot;code-keyword&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;join&lt;/span&gt; src b &lt;span class=&quot;code-keyword&quot;&gt;on&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;a&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;=b.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;a&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;) tmp
    &lt;span class=&quot;code-keyword&quot;&gt;join&lt;/span&gt; src &lt;span class=&quot;code-keyword&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;on&lt;/span&gt; tmp.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;=&lt;span class=&quot;code-keyword&quot;&gt;c&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;union&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;all&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;c&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
    (&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;a&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; src &lt;span class=&quot;code-keyword&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;join&lt;/span&gt; src b &lt;span class=&quot;code-keyword&quot;&gt;on&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;a&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;=b.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;a&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;) tmp
    &lt;span class=&quot;code-keyword&quot;&gt;join&lt;/span&gt; src &lt;span class=&quot;code-keyword&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;on&lt;/span&gt; tmp.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;=&lt;span class=&quot;code-keyword&quot;&gt;c&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;
) x;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We will get a NullPointerException from Union Operator:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.RuntimeException: org.apache.hadoop.hive.ql.metadata.HiveException: Hive Runtime Error while processing row {&quot;_col0&quot;:0}
	at org.apache.hadoop.hive.ql.exec.mr.ExecMapper.map(ExecMapper.java:175)
	at org.apache.hadoop.mapred.MapRunner.run(MapRunner.java:50)
	at org.apache.hadoop.mapred.MapTask.runOldMapper(MapTask.java:436)
	at org.apache.hadoop.mapred.MapTask.run(MapTask.java:372)
	at org.apache.hadoop.mapred.LocalJobRunner$Job.run(LocalJobRunner.java:212)
Caused by: org.apache.hadoop.hive.ql.metadata.HiveException: Hive Runtime Error while processing row {&quot;_col0&quot;:0}
	at org.apache.hadoop.hive.ql.exec.MapOperator.process(MapOperator.java:544)
	at org.apache.hadoop.hive.ql.exec.mr.ExecMapper.map(ExecMapper.java:157)
	... 4 more
Caused by: java.lang.NullPointerException
	at org.apache.hadoop.hive.ql.exec.UnionOperator.processOp(UnionOperator.java:120)
	at org.apache.hadoop.hive.ql.exec.Operator.process(Operator.java:504)
	at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:842)
	at org.apache.hadoop.hive.ql.exec.SelectOperator.processOp(SelectOperator.java:88)
	at org.apache.hadoop.hive.ql.exec.Operator.process(Operator.java:504)
	at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:842)
	at org.apache.hadoop.hive.ql.exec.CommonJoinOperator.genUniqueJoinObject(CommonJoinOperator.java:652)
	at org.apache.hadoop.hive.ql.exec.CommonJoinOperator.genUniqueJoinObject(CommonJoinOperator.java:655)
	at org.apache.hadoop.hive.ql.exec.CommonJoinOperator.checkAndGenObject(CommonJoinOperator.java:758)
	at org.apache.hadoop.hive.ql.exec.MapJoinOperator.processOp(MapJoinOperator.java:220)
	at org.apache.hadoop.hive.ql.exec.Operator.process(Operator.java:504)
	at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:842)
	at org.apache.hadoop.hive.ql.exec.TableScanOperator.processOp(TableScanOperator.java:91)
	at org.apache.hadoop.hive.ql.exec.Operator.process(Operator.java:504)
	at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:842)
	at org.apache.hadoop.hive.ql.exec.MapOperator.process(MapOperator.java:534)
	... 5 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The root cause is in CommonJoinTaskDispatcher.mergeMapJoinTaskIntoItsChildMapRedTask().&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  +--------------+      +--------------+
  | MapJoin task |      | MapJoin task |
  +--------------+      +--------------+
             \             /
              \           /
             +--------------+
             |  Union task  |
             +--------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;             
&lt;p&gt;CommonJoinTaskDispatcher merges the two MapJoin tasks into their common child: Union task. The two MapJoin tasks have the same alias name for their big tables: $INTNAME, which is the name of the temporary table of a join stream. The aliasToWork map uses alias as key, so eventually only the MapJoin operator tree of one MapJoin task is saved into the aliasToWork map of the Union task, while the MapJoin operator tree of another MapJoin task is lost. As a result, Union operator won&apos;t be initialized because not all of its parents gets intialized (The Union operator itself indicates it has two parents, but actually it has only 1 parent because another parent is lost).&lt;/p&gt;

&lt;p&gt;This issue does not exist in HIVE 0.11 and thus is a regression bug in HIVE 0.12.&lt;/p&gt;

&lt;p&gt;The propsed solution is to use the query ID as prefix for the join stream name to avoid conflict and add sanity check code in CommonJoinTaskDispatcher that merge of a MapJoin task into its child MapRed task is skipped if there is any alias conflict. Please review the patch. I am not sure if the patch properly handles the case of DemuxOperator.&lt;/p&gt;

&lt;p&gt;BTW, anyone knows the origin of &quot;$INTNAME&quot;? it is so confusing, maybe we can replace it with a meaningful name.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12681234">HIVE-5891</key>
            <summary>Alias conflict when merging multiple mapjoin tasks into their common child mapred task</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sunrui">Sun Rui</assignee>
                                    <reporter username="sunrui">Sun Rui</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Nov 2013 10:10:45 +0000</created>
                <updated>Wed, 25 Dec 2013 23:09:18 +0000</updated>
                            <resolved>Wed, 25 Dec 2013 23:09:18 +0000</resolved>
                                    <version>0.12.0</version>
                                    <fixVersion>0.13.0</fixVersion>
                                    <component>Query Processor</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13832744" author="ashutoshc" created="Tue, 26 Nov 2013 16:37:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunrui&quot; class=&quot;user-hover&quot; rel=&quot;sunrui&quot;&gt;sunrui&lt;/a&gt; Can you add your test case as .q file in patch. You need to set hive.auto.convert.join=true; to effect map-join in .q tests. Also, I think it may result in lot of update to .q.out files since we may now use different alias than $INTNAME which appears in .q.out files.&lt;br/&gt;
Also, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; can you take a look to see if this has any affect on Demux Operator. I don&apos;t think so, but you ll know better.&lt;/p&gt;</comment>
                            <comment id="13832779" author="yhuai" created="Tue, 26 Nov 2013 17:28:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunrui&quot; class=&quot;user-hover&quot; rel=&quot;sunrui&quot;&gt;sunrui&lt;/a&gt; What will the plan of the query in the description look like with your patch? Will MapJoins and the Union be executed in the same job? Seems those two tmps appearing in the same position in those MapJoins triggered the bug. I was thinking if ids in those two QBJoinTrees are the same? If so, aliases of those two tables are probably still the same. 0.11 does not have this bug because it does not use a single job to evaluate those MapJoins and the Union.&lt;/p&gt;

&lt;p&gt;I do not think it will affect Demux since Demux is at the reducer side.&lt;/p&gt;

&lt;p&gt;btw, I also think &quot;$INTNAME&quot; is confusing... Seems it is used to represent those intermediate results. I&apos;d like a name which has a meaningful part which can represent how this intermediate results are generated and a unique part to address the issue shown in this jira.&lt;/p&gt;</comment>
                            <comment id="13833386" author="sunrui" created="Wed, 27 Nov 2013 02:46:59 +0000"  >&lt;p&gt;Yin Huai  The following is the explain output for the merged task:&lt;/p&gt;
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;  Stage: Stage-4&lt;br/&gt;
    Map Reduce&lt;br/&gt;
      Alias -&amp;gt; Map Operator Tree:&lt;br/&gt;
        null-subquery1:x-subquery1:$INTNAME &lt;br/&gt;
            Map Join Operator&lt;br/&gt;
              condition map:&lt;br/&gt;
                   Inner Join 0 to 1&lt;br/&gt;
              condition expressions:&lt;br/&gt;
                0 &lt;br/&gt;
                1 &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {key}&lt;/span&gt; 
&lt;p&gt;              handleSkewJoin: false&lt;br/&gt;
              keys:&lt;br/&gt;
                0 [Column&lt;span class=&quot;error&quot;&gt;&amp;#91;_col0&amp;#93;&lt;/span&gt;]&lt;br/&gt;
                1 [Column&lt;span class=&quot;error&quot;&gt;&amp;#91;key&amp;#93;&lt;/span&gt;]&lt;br/&gt;
              outputColumnNames: _col1&lt;br/&gt;
              Position of Big Table: 0&lt;br/&gt;
              Select Operator&lt;br/&gt;
                expressions:&lt;br/&gt;
                      expr: _col1&lt;br/&gt;
                      type: int&lt;br/&gt;
                outputColumnNames: _col0&lt;br/&gt;
                Union&lt;br/&gt;
                  Select Operator&lt;br/&gt;
                    expressions:&lt;br/&gt;
                          expr: _col0&lt;br/&gt;
                          type: int&lt;br/&gt;
                    outputColumnNames: _col0&lt;br/&gt;
                    File Output Operator&lt;br/&gt;
                      compressed: false&lt;br/&gt;
                      GlobalTableId: 0&lt;br/&gt;
                      table:&lt;br/&gt;
                          input format: org.apache.hadoop.mapred.TextInputFormat&lt;br/&gt;
                          output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat&lt;br/&gt;
        null-subquery2:x-subquery2:$INTNAME &lt;br/&gt;
            Map Join Operator&lt;br/&gt;
              condition map:&lt;br/&gt;
                   Inner Join 0 to 1&lt;br/&gt;
              condition expressions:&lt;br/&gt;
                0 &lt;br/&gt;
                1 &lt;/p&gt;&lt;/div&gt;
&lt;p&gt;              handleSkewJoin: false&lt;br/&gt;
              keys:&lt;br/&gt;
                0 [Column&lt;span class=&quot;error&quot;&gt;&amp;#91;_col0&amp;#93;&lt;/span&gt;]&lt;br/&gt;
                1 [Column&lt;span class=&quot;error&quot;&gt;&amp;#91;key&amp;#93;&lt;/span&gt;]&lt;br/&gt;
              outputColumnNames: _col1&lt;br/&gt;
              Position of Big Table: 0&lt;br/&gt;
              Select Operator&lt;br/&gt;
                expressions:&lt;br/&gt;
                      expr: _col1&lt;br/&gt;
                      type: int&lt;br/&gt;
                outputColumnNames: _col0&lt;br/&gt;
                Union&lt;br/&gt;
                  Select Operator&lt;br/&gt;
                    expressions:&lt;br/&gt;
                          expr: _col0&lt;br/&gt;
                          type: int&lt;br/&gt;
                    outputColumnNames: _col0&lt;br/&gt;
                    File Output Operator&lt;br/&gt;
                      compressed: false&lt;br/&gt;
                      GlobalTableId: 0&lt;br/&gt;
                      table:&lt;br/&gt;
                          input format: org.apache.hadoop.mapred.TextInputFormat&lt;br/&gt;
                          output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat&lt;br/&gt;
      Local Work:&lt;br/&gt;
        Map Reduce Local Work&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As you can see, MapJoins and the Union are to be executed in the same job. The aliases are changed from &quot;$INTNAME&quot; to &quot;null-subquery1:x-subquery1:$INTNAME&quot; and &quot;null-subquery2:x-subquery2:$INTNAME&quot; respectively.&lt;/p&gt;

&lt;p&gt;I am thinking maybe we can change the intermediate alias name for a join stream from &quot;$INTNAME&quot; to &quot;$JOIN_INTERMEDIATE&quot;. But which better name do you think for the case of DemuxOperator?&lt;/p&gt;

&lt;p&gt;Ashutosh Chauhan : I will add the test case as a .q file when we finalize the patch&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13833409" author="yhuai" created="Wed, 27 Nov 2013 03:28:21 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunrui&quot; class=&quot;user-hover&quot; rel=&quot;sunrui&quot;&gt;sunrui&lt;/a&gt; for confirming the plan. Will &quot;JOIN_INTERMEDIATE&quot; give an impression that the dataset is an intermediate dataset during the processing of join instead of an input dataset?&lt;/p&gt;

&lt;p&gt;Also, I am sorry that I did not get your question about DemuxOperator. Why DemuxOperator is related to this issue?  I think Demux is not related to your change since it is an operator at the reducer side. &lt;/p&gt;</comment>
                            <comment id="13833477" author="sunrui" created="Wed, 27 Nov 2013 05:30:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; Yes, &quot;$JOIN_INTERMEDIATE&quot; is intended to name an intermediate dataset during the processing of join, not for input dataset. Is there anything wrong with my understanding?  &quot;$JOIN_STREAM&quot; is also another candidate maybe.&lt;/p&gt;

&lt;p&gt;GenMapRedUtils.java:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; needsTagging(ReduceWork rWork) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; rWork != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; (rWork.getReducer().getClass() == JoinOperator.class ||
         rWork.getReducer().getClass() == DemuxOperator.class);
  }

splitTasks():
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (needsTagging(cplan.getReduceWork())) {
      &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; origStreamDesc;
      Operator&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; OperatorDesc&amp;gt; joinOp = cplan.getReduceWork().getReducer();
      QBJoinTree joinTree = parseCtx.getJoinContext().get(joinOp);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (joinTree != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        streamDesc = joinTree.getJoinStreamDesc();
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        streamDesc = &lt;span class=&quot;code-quote&quot;&gt;&quot;$INTNAME&quot;&lt;/span&gt;;
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Look at the above piece of code, an alias is also needed when the reduce work starts&lt;br/&gt;
with a DemuxOperator. For this case, &quot;$INTNAME&quot; is still un-changed because I have no&lt;br/&gt;
idea how DemuxOperator works.&lt;/p&gt;</comment>
                            <comment id="13833857" author="yhuai" created="Wed, 27 Nov 2013 15:10:28 +0000"  >&lt;p&gt;I think the main problem is mergeMapJoinTaskIntoItsChildMapRedTask happens in the physical optimization phase which is after we break the plan using GenMapRedUtils. In this case &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (cplan.getMapWork().getAliasToWork().get(streamDesc) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
  streamDesc = origStreamDesc.concat(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.valueOf(++pos));
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;will not help because those MapJoins were ReduceJoins and they were in different MR jobs. Also, seems the pattern triggers the bug looks like this...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;             Union or Join
             /            \
            /              \
       MapJoin1             MapJoin1
      /       \            /        \
   MR1         small1     MR2        small2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In here, MR1 and MR2 are two MapReduce jobs which generates intermediate datasets. small1 and small2 are two small tables. When mergeMapJoinTaskIntoItsChildMapRedTask attaches MapJoin1 and MapJoin2 to the Map phase of the job for Union or Join, MR1 and MR2 has the same alias... Actually, I am thinking using the id of a QB may be a good alias for an intermediate dataset. Thoughts?&lt;/p&gt;

&lt;p&gt;I think your change will not affect DemuxOperator because before GenMapRedUtils starts to work, Correlation Optimizer (&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-2206&quot; title=&quot;add a new optimizer for query correlation discovery and optimization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-2206&quot;&gt;&lt;del&gt;HIVE-2206&lt;/del&gt;&lt;/a&gt;) has already generated the optimized plan. But let&apos;s give it a try. Can you try this query and see if there is anything wrong?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;set&lt;/span&gt; hive.&lt;span class=&quot;code-keyword&quot;&gt;optimize&lt;/span&gt;.correlation=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; tmp1.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;
             &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; src
            &lt;span class=&quot;code-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;a&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, b.&lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;) tmp1
&lt;span class=&quot;code-keyword&quot;&gt;JOIN&lt;/span&gt;
           (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; src
           &lt;span class=&quot;code-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;value&lt;/span&gt;) tmp2
&lt;span class=&quot;code-keyword&quot;&gt;ON&lt;/span&gt; (tmp1.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;=tmp2.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;JOIN&lt;/span&gt;
         (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;
          &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; src
          &lt;span class=&quot;code-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;) tmp3
&lt;span class=&quot;code-keyword&quot;&gt;ON&lt;/span&gt; (tmp2.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;=tmp3.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;BY&lt;/span&gt; tmp1.&lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The plan should have three MR jobs. The first one is used to evaluate tmp1. The second is used to evaluate tmp2. And the third one is used to evaluate the join of tmp1, tmp2, and tmp3, and gby.&lt;/p&gt;</comment>
                            <comment id="13834539" author="sunrui" created="Thu, 28 Nov 2013 06:19:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; I did try to use the QB id. Something like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;     streamDesc = parseCtx.getQB().getId() + &lt;span class=&quot;code-quote&quot;&gt;&quot;:$INTNAME&quot;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But parseCtx.getQB().getId() returns null. I don&apos;t know the reason.&lt;/p&gt;

&lt;p&gt;Actually, the id of QB is same as that of QBJoinTree. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;QBJoinTree &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Serializable{
  ...
  &lt;span class=&quot;code-comment&quot;&gt;// The subquery identifier from QB.
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// It is of the form topSubQuery:innerSubQuery:....:innerMostSubQuery
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; id;  
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And QBJoinTree has a method getJoinStreamDesc() which is supposed to return the name for the intermediate dataset of the join operation. But this method is not used now. So I tried to use this method in my patch.&lt;/p&gt;

&lt;p&gt;I tried your query. There is nothing wrong with it in HIVE 0.12. Below is part of the plan:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  Stage: Stage-2
    Map Reduce
      Alias -&amp;gt; Map Operator Tree:
        $INTNAME 
            Reduce Output Operator
              key expressions:
                    expr: _col0
                    type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
              sort order: +
              Map-reduce partition columns:
                    expr: _col0
                    type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
              tag: 0
              value expressions:
                    expr: _col0
                    type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
        $INTNAME1 
            Reduce Output Operator
              key expressions:
                    expr: _col0
                    type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
              sort order: +
              Map-reduce partition columns:
                    expr: _col0
                    type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
              tag: 1
        tmp3:src 
          TableScan
            alias: src
            Select Operator
              expressions:
                    expr: key
                    type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
              outputColumnNames: key
              Group By Operator
                bucketGroup: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
                keys:
                      expr: key
                      type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
                mode: hash
                outputColumnNames: _col0
                Reduce Output Operator
                  key expressions:
                        expr: _col0
                        type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
                  sort order: +
                  Map-reduce partition columns:
                        expr: _col0
                        type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
                  tag: 2
      Reduce Operator Tree:
        Demux Operator
          Mux Operator
            Join Operator

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13850246" author="sunrui" created="Tue, 17 Dec 2013 08:40:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; I think we can leave &quot;$INTNAME&quot; as is for this issue. Do you have any further comments? if no, I can prepare a new patch for review.&lt;/p&gt;</comment>
                            <comment id="13851007" author="yhuai" created="Tue, 17 Dec 2013 22:29:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunrui&quot; class=&quot;user-hover&quot; rel=&quot;sunrui&quot;&gt;sunrui&lt;/a&gt; Sorry for getting back late.&lt;/p&gt;

&lt;p&gt;I just took a look at QB. Seems it uses aliasToSubq to store the mapping from aliases to sub query expressions (QBExpr). Then, a QBExpr also stores a QB which represents the subquery QB. With this recursive way, all QBs for different levels of the query are stored. So, parseCtx.getQB() only gets the main query block and its id is null. I am not sure if we can get the right QB (the QB for a subquery) from GenMapRedUtils.splitTasks... Can you take a quick look to see if it is easy to get the correct QB? If so, we can use the id of a QB to replace INTNAME. If not, let&apos;s use joinTree.getId for those JoinOperators. Seems we do not need to take special care to DemuxOperator. Can you create a review request for your patch? I can leave comments on the review board.&lt;/p&gt;

&lt;p&gt;Also, since QBJoinTree.getJoinStreamDesc is not used, let&apos;s delete it.&lt;/p&gt;</comment>
                            <comment id="13852894" author="sunrui" created="Thu, 19 Dec 2013 13:39:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; Thanks for your comments&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
It seems there is no quick way to get the correct QB for a join operator. However, since QBJoinTree&apos;s id is same as it&apos;s QB&apos;s id, we can just use QBJoinTree&apos;s id as QB&apos;s id. I found simliar usages in the HIVE code base.&lt;/p&gt;

&lt;p&gt;I note that something wrong in my first patch. parseCtx.getJoinContext() is used to map the join operator to its QBJoinTree, but this is not enough. A join operator may be a MapJoin or SMBJoin operator instead of a common join operator, so parseCtx.getMapJoinContext() and parseCtx.getSmbMapJoinContext() should also be checked.&lt;/p&gt;

&lt;p&gt;I have another thought. Maybe we can define a method in GenMapRedUtils. On each invokation, this method returns a unique intermediate name. Thus we don&apos;t have to use QB&apos;s id.&lt;/p&gt;

&lt;p&gt;What&apos;s your opinion?&lt;/p&gt;</comment>
                            <comment id="13853583" author="yhuai" created="Fri, 20 Dec 2013 01:48:46 +0000"  >&lt;p&gt;i see. yes, seems getMapJoinContext and getSmbMapJoinContext can also have QBJoinTrees. I think it will be good to show meaningful aliases for those intermediate results. So, users can know where does an intermediate result come from. Since it is not easy to get the correct QB.id, I prefer to use QBJoinTree.id right now. Once this bug has been fixed, we can work on a followup jira to get rid of INTNAME. Also, I guess that we do not have an unit test to cover this bug. Can you add an test query in multiMapJoin2.q and comment the reason that we need this test? Thanks.&lt;/p&gt;</comment>
                            <comment id="13853939" author="sunrui" created="Fri, 20 Dec 2013 13:03:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt;&lt;br/&gt;
I attached a new patch and created review board entry:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/16422/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/16422/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13853983" author="sunrui" created="Fri, 20 Dec 2013 14:18:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; This patch does not include modifications to the test output files of other impacted test queries. You can review the code change first. I will submit a new patch later.&lt;/p&gt;</comment>
                            <comment id="13854022" author="yhuai" created="Fri, 20 Dec 2013 14:55:21 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunrui&quot; class=&quot;user-hover&quot; rel=&quot;sunrui&quot;&gt;sunrui&lt;/a&gt;. LGTM. I left two minor comments on the review board.&lt;/p&gt;</comment>
                            <comment id="13855353" author="sunrui" created="Mon, 23 Dec 2013 03:12:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt;&lt;br/&gt;
I updated the patch per your comments.&lt;/p&gt;

&lt;p&gt;I ran a round of ClientPostive test and found that q.out files of many test queries need to modified because &quot;$INTNAME&quot; in the explained plan would be changed to &quot;null:$INTNAME&quot;. This is because the QB id for the top query is null. This makes no sense, so I enhanced the logic a little bit: don&apos;t use a QB id as prefix for the intermediate name if it is null.&lt;/p&gt;</comment>
                            <comment id="13856336" author="hiveqa" created="Tue, 24 Dec 2013 14:40:48 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12620115/HIVE-5891.3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12620115/HIVE-5891.3.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 4811 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/738/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/738/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/738/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/738/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12620115&lt;/p&gt;</comment>
                            <comment id="13856420" author="ashutoshc" created="Tue, 24 Dec 2013 18:43:52 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13856676" author="ashutoshc" created="Wed, 25 Dec 2013 23:09:18 +0000"  >&lt;p&gt;Committed to trunk. Thanks, Sun!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12656770">HIVE-4827</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12615813" name="HIVE-5891.1.patch" size="3018" author="sunrui" created="Tue, 26 Nov 2013 10:23:51 +0000"/>
                            <attachment id="12619813" name="HIVE-5891.2.patch" size="27406" author="sunrui" created="Fri, 20 Dec 2013 13:04:16 +0000"/>
                            <attachment id="12620115" name="HIVE-5891.3.patch" size="35184" author="sunrui" created="Mon, 23 Dec 2013 03:13:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>360499</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 47 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1q57r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>360798</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>