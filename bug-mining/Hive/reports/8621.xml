<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:25:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-27948] Wrong results when using materialized views with non-deterministic/dynamic functions</title>
                <link>https://issues.apache.org/jira/browse/HIVE-27948</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;There are certain SQL functions that return different results across different executions. Usually we refer to these functions as non-deterministic or dynamic. Some examples are: UNIX_TIMESTAMP(), CURRENT_TIMESTAMP, CURRENT_DATE, etc.&lt;/p&gt;

&lt;p&gt;When a materialized view definition contains such functions the queries that are using this view may return wrong results.&lt;/p&gt;

&lt;p&gt;Consider the following scenario where we populate the employee table with timestamps representing the future. For making this easily reproable in self-contained test the timestamps are only a few seconds apart.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;TABLE&lt;/span&gt; EMPS (ENAME &lt;span class=&quot;code-keyword&quot;&gt;STRING&lt;/span&gt;, BIRTH_EPOCH_SECS &lt;span class=&quot;code-keyword&quot;&gt;INT&lt;/span&gt;) STORED &lt;span class=&quot;code-keyword&quot;&gt;AS&lt;/span&gt; ORC TBLPROPERTIES (&lt;span class=&quot;code-quote&quot;&gt;&apos;transactional&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;&lt;/span&gt;);

&lt;span class=&quot;code-keyword&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;INTO&lt;/span&gt; EMPS
&lt;span class=&quot;code-keyword&quot;&gt;VALUES&lt;/span&gt; (&lt;span class=&quot;code-quote&quot;&gt;&apos;Victor&apos;&lt;/span&gt;, UNIX_TIMESTAMP()),
       (&lt;span class=&quot;code-quote&quot;&gt;&apos;Alex&apos;&lt;/span&gt;, UNIX_TIMESTAMP() + 2),
       (&lt;span class=&quot;code-quote&quot;&gt;&apos;Bob&apos;&lt;/span&gt;, UNIX_TIMESTAMP() + 5),
       (&lt;span class=&quot;code-quote&quot;&gt;&apos;Alice&apos;&lt;/span&gt;, UNIX_TIMESTAMP() + 10);

&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; MATERIALIZED &lt;span class=&quot;code-keyword&quot;&gt;VIEW&lt;/span&gt; v_emp &lt;span class=&quot;code-keyword&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; * &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; EMPS &lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; BIRTH_EPOCH_SECS &amp;lt;= UNIX_TIMESTAMP();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When the materialized view is created it is populated with only the rows that match the timestamp at the given time.&lt;/p&gt;

&lt;p&gt;To demonstrate the problem run the following queries with view based rewritting disabled and enabled.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;set&lt;/span&gt; hive.materializedview.rewriting.&lt;span class=&quot;code-keyword&quot;&gt;sql&lt;/span&gt;=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; * &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; EMPS &lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; BIRTH_EPOCH_SECS &amp;lt;= UNIX_TIMESTAMP();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Victor	1702302786
Alex	1702302788
Bob	1702302791
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;set&lt;/span&gt; hive.materializedview.rewriting.&lt;span class=&quot;code-keyword&quot;&gt;sql&lt;/span&gt;=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; * &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; EMPS &lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; BIRTH_EPOCH_SECS &amp;lt;= UNIX_TIMESTAMP();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Victor	1702302786
Alex	1702302788
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Naturally the second query should return more rows than the first one since UNIX_TIMESTAMP is constantly growing. However, when view based rewritting is in use the second query will use the results from the materialized view which are by now obsolete (missing Bob entry).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13561416">HIVE-27948</key>
            <summary>Wrong results when using materialized views with non-deterministic/dynamic functions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kkasa">Krisztian Kasa</assignee>
                                    <reporter username="zabetak">Stamatis Zampetakis</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 11 Dec 2023 15:48:56 +0000</created>
                <updated>Fri, 29 Mar 2024 17:49:50 +0000</updated>
                            <resolved>Mon, 8 Jan 2024 13:10:03 +0000</resolved>
                                    <version>4.0.0-beta-1</version>
                                    <fixVersion>4.0.0</fixVersion>
                                    <component>CBO</component>
                    <component>Materialized views</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17795421" author="zabetak" created="Mon, 11 Dec 2023 15:55:05 +0000"  >&lt;p&gt;It seems that before &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-24274&quot; title=&quot;Implement Query Text based MaterializedView rewrite&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-24274&quot;&gt;&lt;del&gt;HIVE-24274&lt;/del&gt;&lt;/a&gt;, it was not possible to create materialized views with non-deterministic/dynamic functions. I am not sure why this requirement was relaxed with the feature added by &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-24274&quot; title=&quot;Implement Query Text based MaterializedView rewrite&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-24274&quot;&gt;&lt;del&gt;HIVE-24274&lt;/del&gt;&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkasa&quot; class=&quot;user-hover&quot; rel=&quot;kkasa&quot;&gt;kkasa&lt;/a&gt; any ideas why we changed the SemanticException to a plain console/log message in &lt;a href=&quot;https://github.com/apache/hive/blob/0e9282b3ed7c59dee3e3a950bd3cd390cca2652b/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java#L14668&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SemanticAnalyzer&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17795424" author="zabetak" created="Mon, 11 Dec 2023 16:02:13 +0000"  >&lt;p&gt;The problem is reproducible in &lt;a href=&quot;https://github.com/apache/hive/commit/0e9282b3ed7c59dee3e3a950bd3cd390cca2652b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;current master&lt;/a&gt; using &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13065210/13065210_materialized_view_unix_timestamp.q&quot; title=&quot;materialized_view_unix_timestamp.q attached to HIVE-27948&quot;&gt;materialized_view_unix_timestamp.q&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; mvn test -Dtest=TestMiniLlapLocalCliDriver -Dqfile=materialized_view_unix_timestamp.q -Dtest.output.overwrite
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17797157" author="kkasa" created="Fri, 15 Dec 2023 12:31:41 +0000"  >&lt;p&gt;The general rule is if there is any error message during materialized view definition validation the MV can not be used by Calcite to perform query rewrites but it can be used for text/AST based rewrite algorithm so MV creation succeeds with a warning message.&lt;/p&gt;

&lt;p&gt; As the description shows this logic can not be applied to any type of MVs, so I submitted a patch to filter out MVs which doesn&apos;t support any type of rewrite algorithm.&lt;/p&gt;

&lt;p&gt;Thanks for reporting this bug.&lt;/p&gt;</comment>
                            <comment id="17804267" author="kkasa" created="Mon, 8 Jan 2024 13:10:03 +0000"  >&lt;p&gt;Merged to master. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zabetak&quot; class=&quot;user-hover&quot; rel=&quot;zabetak&quot;&gt;zabetak&lt;/a&gt; for reporting, reproducing the issue and review the PR.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13335430">HIVE-24274</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13533972">HIVE-27291</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13065210" name="materialized_view_unix_timestamp.q" size="704" author="zabetak" created="Mon, 11 Dec 2023 16:01:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 44 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1m6ts:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>