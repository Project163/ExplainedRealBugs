<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:25:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-27658] Error resolving join keys during conversion to dynamic partition hashjoin</title>
                <link>https://issues.apache.org/jira/browse/HIVE-27658</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;In certain cases the compilation of queries fail during the conversion to a dynamic partition hash join with the stacktrace similar to the one shown below.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2023-08-31T10:22:21,738 WARN  [HiveServer2-Handler-Pool: Thread-100]: thrift.ThriftCLIService (()) - Error executing statement: 
org.apache.hive.service.cli.HiveSQLException: Error while compiling statement: FAILED: SemanticException Error resolving join keys
	at org.apache.hive.service.cli.operation.Operation.toSQLException(Operation.java:335) ~[hive-service-100.jar:?]
	at org.apache.hive.service.cli.operation.SQLOperation.prepare(SQLOperation.java:199) ~[hive-service-100.jar:?]
	at org.apache.hive.service.cli.operation.SQLOperation.runInternal(SQLOperation.java:260) ~[hive-service-100.jar:?]
	at org.apache.hive.service.cli.operation.Operation.run(Operation.java:247) ~[hive-service-100.jar:?]
	at org.apache.hive.service.cli.session.HiveSessionImpl.executeStatementInternal(HiveSessionImpl.java:541) ~[hive-service-100.jar:?]
	at org.apache.hive.service.cli.session.HiveSessionImpl.executeStatementAsync(HiveSessionImpl.java:527) ~[hive-service-100.jar:?]
	at org.apache.hive.service.cli.CLIService.executeStatementAsync(CLIService.java:312) ~[hive-service-100.jar:?]
	at org.apache.hive.service.cli.thrift.ThriftCLIService.ExecuteStatement(ThriftCLIService.java:562) ~[hive-service-100.jar:?]
	at org.apache.hive.service.rpc.thrift.TCLIService$Processor$ExecuteStatement.getResult(TCLIService.java:1557) ~[hive-exec-100.jar:?]
	at org.apache.hive.service.rpc.thrift.TCLIService$Processor$ExecuteStatement.getResult(TCLIService.java:1542) ~[hive-exec-100.jar:?]
	at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:39) ~[hive-exec-100.jar:?]
	at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:39) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.metastore.security.HadoopThriftAuthBridge$Server$TUGIAssumingProcessor.process(HadoopThriftAuthBridge.java:647) ~[hive-exec-100.jar:?]
	at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:286) ~[hive-exec-100.jar:?]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[?:1.8.0_312]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) ~[?:1.8.0_312]
	at java.lang.Thread.run(Thread.java:748) [?:1.8.0_312]
Caused by: org.apache.hadoop.hive.ql.parse.SemanticException: Error resolving join keys
	at org.apache.hadoop.hive.ql.optimizer.MapJoinProcessor.getMapJoinDesc(MapJoinProcessor.java:1105) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.optimizer.MapJoinProcessor.convertJoinOpMapJoinOp(MapJoinProcessor.java:372) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.optimizer.ConvertJoinMapJoin.convertJoinMapJoin(ConvertJoinMapJoin.java:1056) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.optimizer.ConvertJoinMapJoin.convertJoinDynamicPartitionedHashJoin(ConvertJoinMapJoin.java:1280) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.optimizer.ConvertJoinMapJoin.fallbackToReduceSideJoin(ConvertJoinMapJoin.java:1312) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.optimizer.ConvertJoinMapJoin.checkAndConvertSMBJoin(ConvertJoinMapJoin.java:371) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.optimizer.ConvertJoinMapJoin.process(ConvertJoinMapJoin.java:151) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.lib.DefaultRuleDispatcher.dispatch(DefaultRuleDispatcher.java:90) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.lib.DefaultGraphWalker.dispatchAndReturn(DefaultGraphWalker.java:105) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.lib.DefaultGraphWalker.dispatch(DefaultGraphWalker.java:89) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.lib.ForwardWalker.walk(ForwardWalker.java:74) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.lib.DefaultGraphWalker.startWalking(DefaultGraphWalker.java:120) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.parse.TezCompiler.runStatsDependentOptimizations(TezCompiler.java:447) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.parse.TezCompiler.optimizeOperatorPlan(TezCompiler.java:160) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.parse.TaskCompiler.compile(TaskCompiler.java:144) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.analyzeInternal(SemanticAnalyzer.java:12320) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner.analyzeInternal(CalcitePlanner.java:330) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.parse.BaseSemanticAnalyzer.analyze(BaseSemanticAnalyzer.java:285) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.parse.ExplainSemanticAnalyzer.analyzeInternal(ExplainSemanticAnalyzer.java:164) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.parse.BaseSemanticAnalyzer.analyze(BaseSemanticAnalyzer.java:285) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.Driver.compile(Driver.java:659) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.Driver.compileInternal(Driver.java:1826) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.Driver.compileAndRespond(Driver.java:1773) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.Driver.compileAndRespond(Driver.java:1768) ~[hive-exec-100.jar:?]
	at org.apache.hadoop.hive.ql.reexec.ReExecDriver.compileAndRespond(ReExecDriver.java:126) ~[hive-exec-100.jar:?]
	at org.apache.hive.service.cli.operation.SQLOperation.prepare(SQLOperation.java:197) ~[hive-service-100.jar:?]
	... 15 more
2023-08-31T10:22:33,838 INFO  [org.apache.ranger.audit.queue.AuditBatchQueue0]: provider.BaseAuditHandler (())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem was originally reported for a query with a LEFT SEMI JOIN and the scenario is outlined below.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;database&lt;/span&gt; test_condition;
&lt;span class=&quot;code-keyword&quot;&gt;use&lt;/span&gt; test_condition;

&lt;span class=&quot;code-keyword&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;external&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt; to_szyy_user_right_issue_log_df(flow_no_ &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;, activity_code_ &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;, right_id_ &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;, user_id_ &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;,issue_flag_ &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;) partitioned &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; (ds &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;)
STORED &lt;span class=&quot;code-keyword&quot;&gt;AS&lt;/span&gt; parquet TBLPROPERTIES(&lt;span class=&quot;code-quote&quot;&gt;&apos;parquet.&lt;span class=&quot;code-keyword&quot;&gt;compress&lt;/span&gt;&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;SNAPPY&apos;&lt;/span&gt;);


&lt;span class=&quot;code-keyword&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;external&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt; to_t0111_s62t1_cst_prft_df(dccp_stcd &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;,dccp_ordr_ar_id &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;) partitioned &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; (ds &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;)
STORED &lt;span class=&quot;code-keyword&quot;&gt;AS&lt;/span&gt; parquet TBLPROPERTIES(&lt;span class=&quot;code-quote&quot;&gt;&apos;parquet.&lt;span class=&quot;code-keyword&quot;&gt;compress&lt;/span&gt;&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;SNAPPY&apos;&lt;/span&gt;);


&lt;span class=&quot;code-keyword&quot;&gt;alter&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt; to_szyy_user_right_issue_log_df &lt;span class=&quot;code-keyword&quot;&gt;add&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;partition&lt;/span&gt;(ds=&lt;span class=&quot;code-quote&quot;&gt;&apos;2023-08-24&apos;&lt;/span&gt;);
&lt;span class=&quot;code-keyword&quot;&gt;alter&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt; to_t0111_s62t1_cst_prft_df &lt;span class=&quot;code-keyword&quot;&gt;add&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;partition&lt;/span&gt;(ds=&lt;span class=&quot;code-quote&quot;&gt;&apos;2023-08-24&apos;&lt;/span&gt;);


&lt;span class=&quot;code-keyword&quot;&gt;alter&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt; to_szyy_user_right_issue_log_df &lt;span class=&quot;code-keyword&quot;&gt;partition&lt;/span&gt;(ds=&lt;span class=&quot;code-quote&quot;&gt;&apos;2023-08-24&apos;&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;update&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;statistics&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;set&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&apos;numRows&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;8146725&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;rawDataSize&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;46331126445&apos;&lt;/span&gt;);
&lt;span class=&quot;code-keyword&quot;&gt;alter&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt; to_t0111_s62t1_cst_prft_df &lt;span class=&quot;code-keyword&quot;&gt;partition&lt;/span&gt;(ds=&lt;span class=&quot;code-quote&quot;&gt;&apos;2023-08-24&apos;&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;update&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;statistics&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;set&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&apos;numRows&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;15680439&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;rawDataSize&apos;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;56180088521&apos;&lt;/span&gt;);

&lt;span class=&quot;code-keyword&quot;&gt;set&lt;/span&gt; hive.auto.&lt;span class=&quot;code-keyword&quot;&gt;convert&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;join&lt;/span&gt;.noconditionaltask.&lt;span class=&quot;code-keyword&quot;&gt;size&lt;/span&gt;=8153960755
&lt;span class=&quot;code-keyword&quot;&gt;set&lt;/span&gt; hive.auto.&lt;span class=&quot;code-keyword&quot;&gt;convert&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;join&lt;/span&gt;=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-keyword&quot;&gt;set&lt;/span&gt; hive.&lt;span class=&quot;code-keyword&quot;&gt;optimize&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;dynamic&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;partition&lt;/span&gt;.hashjoin=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-keyword&quot;&gt;set&lt;/span&gt; hive.stats.&lt;span class=&quot;code-keyword&quot;&gt;fetch&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;column&lt;/span&gt;.stats=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-keyword&quot;&gt;set&lt;/span&gt; hive.cbo.&lt;span class=&quot;code-keyword&quot;&gt;enable&lt;/span&gt;=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;


&lt;span class=&quot;code-keyword&quot;&gt;explain&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; flow_no_, activity_code_, right_id_, user_id_
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; test_condition.to_szyy_user_right_issue_log_df rlog
&lt;span class=&quot;code-keyword&quot;&gt;left&lt;/span&gt; semi &lt;span class=&quot;code-keyword&quot;&gt;join&lt;/span&gt; test_condition.to_t0111_s62t1_cst_prft_df prft &lt;span class=&quot;code-keyword&quot;&gt;on&lt;/span&gt; prft.ds = &lt;span class=&quot;code-quote&quot;&gt;&apos;2023-08-24&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;and&lt;/span&gt;  rlog.flow_no_ = prft.dccp_ordr_ar_id
&lt;span class=&quot;code-keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; flow_no_, activity_code_, right_id_, user_id_;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &lt;tt&gt;SemanticException&lt;/tt&gt; reported above is thrown by the &lt;a href=&quot;https://github.com/apache/hive/blob/9b4ea7affa4902fc2849f1a88b68103940fc9866/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ConvertJoinMapJoin.java#L1590&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dynamic partition hashjoin transformation logic&lt;/a&gt; of so a workaround consists in disabling the respective optimization via the &lt;tt&gt;hive.optimize.dynamic.partition.hashjoin&lt;/tt&gt; property.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13549213">HIVE-27658</key>
            <summary>Error resolving join keys during conversion to dynamic partition hashjoin</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zabetak">Stamatis Zampetakis</assignee>
                                    <reporter username="bigdata_zoodev">xiaojunxiang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 31 Aug 2023 02:33:50 +0000</created>
                <updated>Fri, 29 Mar 2024 17:50:06 +0000</updated>
                            <resolved>Fri, 8 Dec 2023 12:42:38 +0000</resolved>
                                    <version>3.1.3</version>
                    <version>4.0.0-beta-1</version>
                                    <fixVersion>4.0.0</fixVersion>
                                    <component>Query Planning</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17790159" author="zabetak" created="Mon, 27 Nov 2023 16:15:28 +0000"  >&lt;p&gt;The LEFT SEMI JOIN scenario described in the description of this ticket compiles successfully in &lt;a href=&quot;https://github.com/apache/hive/commit/9b4ea7affa4902fc2849f1a88b68103940fc9866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;current master&lt;/a&gt;. However, the same exception can be reproduced now in master using the scenario attached in &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13064716/13064716_hive27658.q&quot; title=&quot;hive27658.q attached to HIVE-27658&quot;&gt;hive27658.q&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; using only INNER JOINs and fine tuning the table statistics. The stacktrace of the error on current master is shown below:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;mvn test -Dtest=TestMiniLlapLocalCliDriver -Dqfile=hive27658.q -Dtest.output.overwrite
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.ql.parse.SemanticException: Error resolving join keys
	at org.apache.hadoop.hive.ql.optimizer.MapJoinProcessor.getMapJoinDesc(MapJoinProcessor.java:1309)
	at org.apache.hadoop.hive.ql.optimizer.MapJoinProcessor.convertJoinOpMapJoinOp(MapJoinProcessor.java:556)
	at org.apache.hadoop.hive.ql.optimizer.ConvertJoinMapJoin.convertJoinMapJoin(ConvertJoinMapJoin.java:1306)
	at org.apache.hadoop.hive.ql.optimizer.ConvertJoinMapJoin.convertJoinDynamicPartitionedHashJoin(ConvertJoinMapJoin.java:1540)
	at org.apache.hadoop.hive.ql.optimizer.ConvertJoinMapJoin.fallbackToReduceSideJoin(ConvertJoinMapJoin.java:1573)
	at org.apache.hadoop.hive.ql.optimizer.ConvertJoinMapJoin.checkAndConvertSMBJoin(ConvertJoinMapJoin.java:494)
	at org.apache.hadoop.hive.ql.optimizer.ConvertJoinMapJoin.process(ConvertJoinMapJoin.java:161)
	at org.apache.hadoop.hive.ql.lib.DefaultRuleDispatcher.dispatch(DefaultRuleDispatcher.java:90)
	at org.apache.hadoop.hive.ql.lib.DefaultGraphWalker.dispatchAndReturn(DefaultGraphWalker.java:105)
	at org.apache.hadoop.hive.ql.lib.DefaultGraphWalker.dispatch(DefaultGraphWalker.java:89)
	at org.apache.hadoop.hive.ql.lib.ForwardWalker.walk(ForwardWalker.java:74)
	at org.apache.hadoop.hive.ql.lib.DefaultGraphWalker.startWalking(DefaultGraphWalker.java:120)
	at org.apache.hadoop.hive.ql.parse.TezCompiler.runStatsDependentOptimizations(TezCompiler.java:496)
	at org.apache.hadoop.hive.ql.parse.TezCompiler.optimizeOperatorPlan(TezCompiler.java:229)
	at org.apache.hadoop.hive.ql.parse.TaskCompiler.compile(TaskCompiler.java:181)
	at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.compilePlan(SemanticAnalyzer.java:13053)
	at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.analyzeInternal(SemanticAnalyzer.java:13271)
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner.analyzeInternal(CalcitePlanner.java:465)
	at org.apache.hadoop.hive.ql.parse.BaseSemanticAnalyzer.analyze(BaseSemanticAnalyzer.java:327)
	at org.apache.hadoop.hive.ql.parse.ExplainSemanticAnalyzer.analyzeInternal(ExplainSemanticAnalyzer.java:180)
	at org.apache.hadoop.hive.ql.parse.BaseSemanticAnalyzer.analyze(BaseSemanticAnalyzer.java:327)
	at org.apache.hadoop.hive.ql.Compiler.analyze(Compiler.java:224)
	at org.apache.hadoop.hive.ql.Compiler.compile(Compiler.java:107)
	at org.apache.hadoop.hive.ql.Driver.compile(Driver.java:519)
	at org.apache.hadoop.hive.ql.Driver.compileInternal(Driver.java:471)
	at org.apache.hadoop.hive.ql.Driver.compileAndRespond(Driver.java:436)
	at org.apache.hadoop.hive.ql.Driver.compileAndRespond(Driver.java:430)
	at org.apache.hadoop.hive.ql.reexec.ReExecDriver.compileAndRespond(ReExecDriver.java:121)
	at org.apache.hadoop.hive.ql.reexec.ReExecDriver.run(ReExecDriver.java:227)
	at org.apache.hadoop.hive.cli.CliDriver.processLocalCmd(CliDriver.java:257)
	at org.apache.hadoop.hive.cli.CliDriver.processCmd1(CliDriver.java:201)
	at org.apache.hadoop.hive.cli.CliDriver.processCmd(CliDriver.java:127)
	at org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:425)
	at org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:356)
	at org.apache.hadoop.hive.ql.QTestUtil.executeClientInternal(QTestUtil.java:733)
	at org.apache.hadoop.hive.ql.QTestUtil.executeClient(QTestUtil.java:703)
	at org.apache.hadoop.hive.cli.control.CoreCliDriver.runTest(CoreCliDriver.java:115)
	at org.apache.hadoop.hive.cli.control.CliAdapter.runTest(CliAdapter.java:157)
	at org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver(TestMiniLlapLocalCliDriver.java:62)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17791647" author="zabetak" created="Thu, 30 Nov 2023 14:09:10 +0000"  >&lt;p&gt;For convenience, the query in &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13064716/13064716_hive27658.q&quot; title=&quot;hive27658.q attached to HIVE-27658&quot;&gt;hive27658.q&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; is presented below.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; TC.CONST_DATE, TB.PRODUCT_SK
&lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; TABLE_A TA
&lt;span class=&quot;code-keyword&quot;&gt;INNER&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;JOIN&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; TO_DATE(FROM_UNIXTIME(1701088643)) &lt;span class=&quot;code-keyword&quot;&gt;AS&lt;/span&gt; CONST_DATE) TC
&lt;span class=&quot;code-keyword&quot;&gt;ON&lt;/span&gt; TA.START_DATE = TC.CONST_DATE
&lt;span class=&quot;code-keyword&quot;&gt;INNER&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;JOIN&lt;/span&gt; TABLE_B TB
&lt;span class=&quot;code-keyword&quot;&gt;ON&lt;/span&gt; TB.START_DATE = TC.CONST_DATE &lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; TA.PRODUCT_ID = TB.PRODUCT_ID;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The operator tree before hitting the error described above is depicted in &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13064859/13064859_hive27658-query-plan.pdf&quot; title=&quot;hive27658-query-plan.pdf attached to HIVE-27658&quot;&gt;hive27658-query-plan.pdf&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;. The problem is triggered while trying to convert the JOIN&lt;span class=&quot;error&quot;&gt;&amp;#91;14&amp;#93;&lt;/span&gt; operator into a dynamic partition hash join.&lt;/p&gt;

&lt;p&gt;The dynamic partition hash join is the first operator that appears in a Reduce Operator Tree and the plan usually looks like the snippet below.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Reduce Operator Tree:
  Map Join Operator
    condition map:
         Inner Join 0 to 1
    keys:
      0 KEY.reducesinkkey0 (type: bigint), KEY.reducesinkkey1 (type: bigint)
      1 KEY.reducesinkkey0 (type: bigint), KEY.reducesinkkey1 (type: bigint)
    outputColumnNames: _col2, _col5, _col7, _col9, _col15
    input vertices:
      0 Map 1
    Statistics: Num rows: 1178531569624 Data size: 414666308907440 Basic stats: COMPLETE Column stats: COMPLETE
    DynamicPartitionHashJoin: true
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Observe that the column names for the keys are using the &quot;KEY.reducesinkkey&quot; prefix and the implementation depends on this naming convention for working properly.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;ExprNodeDescUtils#resolveJoinKeysAsRSColumns&lt;/tt&gt; method tries to map the join keys to the output column names from the RS operators using the &lt;tt&gt;columnExprMap&lt;/tt&gt; mapping that is present on the RS operators. In this case, it fails to resolve the &quot;0 _col1 (type:int), _col2 (type: date)&quot; keys from the RS&lt;span class=&quot;error&quot;&gt;&amp;#91;12&amp;#93;&lt;/span&gt; operator because &quot;_col2 (type: date)&quot; is not present in the &lt;tt&gt;columnExprMap&lt;/tt&gt; of RS&lt;span class=&quot;error&quot;&gt;&amp;#91;12&amp;#93;&lt;/span&gt; thus it returns &lt;tt&gt;null&lt;/tt&gt; and triggers the aforementioned exception.&lt;/p&gt;

&lt;p&gt;Looking closer to RS&lt;span class=&quot;error&quot;&gt;&amp;#91;12&amp;#93;&lt;/span&gt; we can see that there is a slight inconsistency between the columnExprMap and the key expressions. The KEY.reducesinkkey1 denotes that the input expression is a constant date but this is not reflected in the key expressions where _col2 is an expression referencing a column. It appears the constant propagation logic did not trigger completely for RS&lt;span class=&quot;error&quot;&gt;&amp;#91;12&amp;#93;&lt;/span&gt; leaving it to some intermediary state that is problematic for the dynamic partition hash join conversion.&lt;/p&gt;</comment>
                            <comment id="17794677" author="zabetak" created="Fri, 8 Dec 2023 12:42:21 +0000"  >&lt;p&gt;The DPHJ is a performance optimization so there is no reason to raise a fatal error when the conversion cannot be performed. It is preferable to simply skip the conversion and use a regular join instead of blocking completely the query. The MapJoinProcessor.getMapJoinDesc method already returns null in certain cases, so it is safe to add another exit condition. &lt;/p&gt;

&lt;p&gt;It is still meaningful to fix the inconsistency observed above in the RS&lt;span class=&quot;error&quot;&gt;&amp;#91;12&amp;#93;&lt;/span&gt; but this can be done independently in other tickets (there can be multiple ways to do it as well). There is always the risk that plan will not satisfy the assumptions of DPHJ  so it makes perfect sense to skip the conversion (instead of failing) when this happens; PR#4930 adopts this approach.&lt;/p&gt;

</comment>
                            <comment id="17794678" author="zabetak" created="Fri, 8 Dec 2023 12:42:26 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/hive/commit/f396676b09d9dd706b4bff4e1c1d999f9f3b1d2f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/commit/f396676b09d9dd706b4bff4e1c1d999f9f3b1d2f&lt;/a&gt;. Thanks for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkuzmenko&quot; class=&quot;user-hover&quot; rel=&quot;dkuzmenko&quot;&gt;dkuzmenko&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13064859" name="hive27658-query-plan.pdf" size="14356" author="zabetak" created="Thu, 30 Nov 2023 14:08:49 +0000"/>
                            <attachment id="13064716" name="hive27658.q" size="1410" author="zabetak" created="Mon, 27 Nov 2023 16:11:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 48 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1k3wg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>