<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:58:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-17826] Error writing to RandomAccessFile after operation log is closed</title>
                <link>https://issues.apache.org/jira/browse/HIVE-17826</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;We are seeing the error from HS2 process stdout.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2017-09-07 10:17:23,933 AsyncLogger-1 ERROR Attempted to append to non-started appender query-file-appender
2017-09-07 10:17:23,934 AsyncLogger-1 ERROR Attempted to append to non-started appender query-file-appender
2017-09-07 10:17:23,935 AsyncLogger-1 ERROR Unable to write to stream /var/log/hive/operation_logs/dd38df5b-3c09-48c9-ad64-a2eee093bea6/hive_20170907101723_1a6ad4b9-f662-4e7a-a495-06e3341308f9 for appender query-file-appender
2017-09-07 10:17:23,935 AsyncLogger-1 ERROR An exception occurred processing Appender query-file-appender org.apache.logging.log4j.core.appender.AppenderLoggingException: Error writing to RandomAccessFile /var/log/hive/operation_logs/dd38df5b-3c09-48c9-ad64-a2eee093bea6/hive_20170907101723_1a6ad4b9-f662-4e7a-a495-06e3341308f9
	at org.apache.logging.log4j.core.appender.RandomAccessFileManager.flush(RandomAccessFileManager.java:114)
	at org.apache.logging.log4j.core.appender.RandomAccessFileManager.write(RandomAccessFileManager.java:103)
	at org.apache.logging.log4j.core.appender.OutputStreamManager.write(OutputStreamManager.java:136)
	at org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.append(AbstractOutputStreamAppender.java:105)
	at org.apache.logging.log4j.core.appender.RandomAccessFileAppender.append(RandomAccessFileAppender.java:89)
	at org.apache.logging.log4j.core.config.AppenderControl.tryCallAppender(AppenderControl.java:152)
	at org.apache.logging.log4j.core.config.AppenderControl.callAppender0(AppenderControl.java:125)
	at org.apache.logging.log4j.core.config.AppenderControl.callAppenderPreventRecursion(AppenderControl.java:116)
	at org.apache.logging.log4j.core.config.AppenderControl.callAppender(AppenderControl.java:84)
	at org.apache.logging.log4j.core.appender.routing.RoutingAppender.append(RoutingAppender.java:112)
	at org.apache.logging.log4j.core.config.AppenderControl.tryCallAppender(AppenderControl.java:152)
	at org.apache.logging.log4j.core.config.AppenderControl.callAppender0(AppenderControl.java:125)
	at org.apache.logging.log4j.core.config.AppenderControl.callAppenderPreventRecursion(AppenderControl.java:116)
	at org.apache.logging.log4j.core.config.AppenderControl.callAppender(AppenderControl.java:84)
	at org.apache.logging.log4j.core.config.LoggerConfig.callAppenders(LoggerConfig.java:390)
	at org.apache.logging.log4j.core.config.LoggerConfig.processLogEvent(LoggerConfig.java:378)
	at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:362)
	at org.apache.logging.log4j.core.config.AwaitCompletionReliabilityStrategy.log(AwaitCompletionReliabilityStrategy.java:79)
	at org.apache.logging.log4j.core.async.AsyncLogger.actualAsyncLog(AsyncLogger.java:385)
	at org.apache.logging.log4j.core.async.RingBufferLogEvent.execute(RingBufferLogEvent.java:103)
	at org.apache.logging.log4j.core.async.RingBufferLogEventHandler.onEvent(RingBufferLogEventHandler.java:43)
	at org.apache.logging.log4j.core.async.RingBufferLogEventHandler.onEvent(RingBufferLogEventHandler.java:28)
	at com.lmax.disruptor.BatchEventProcessor.run(BatchEventProcessor.java:129)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.Thread.run(Thread.java:748)
Caused by: java.io.IOException: Stream Closed
	at java.io.RandomAccessFile.writeBytes(Native Method)
	at java.io.RandomAccessFile.write(RandomAccessFile.java:525)
	at org.apache.logging.log4j.core.appender.RandomAccessFileManager.flush(RandomAccessFileManager.java:111)
	... 25 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="13110175">HIVE-17826</key>
            <summary>Error writing to RandomAccessFile after operation log is closed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="asherman">Andrew Sherman</assignee>
                                    <reporter username="asherman">Andrew Sherman</reporter>
                        <labels>
                    </labels>
                <created>Wed, 18 Oct 2017 00:19:34 +0000</created>
                <updated>Tue, 8 Mar 2022 12:39:37 +0000</updated>
                            <resolved>Mon, 30 Oct 2017 20:44:05 +0000</resolved>
                                                    <fixVersion>3.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16208636" author="asherman" created="Wed, 18 Oct 2017 00:20:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-17128&quot; title=&quot;Operation Logging leaks file descriptors as the log4j Appender is never closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-17128&quot;&gt;&lt;del&gt;HIVE-17128&lt;/del&gt;&lt;/a&gt; prevented file descriptors leaks by closing the log4j Appender used for Operation Logs.&lt;br/&gt;
Sometimes logging is attempted even after the Operation is closed.&lt;br/&gt;
The current appender, a RandomAccessFileAppender, will continue to try to&lt;br/&gt;
write to its log file even after it has been stopped.&lt;br/&gt;
To fix this, create a new class, HushableMutableRandomAccessAppender based on log4j&apos;s RandomAccessFileAppender.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/logging-log4j2/blob/master/log4j-core/src/main/java/org/apache/logging/log4j/core/appender/RandomAccessFileAppender.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/blob/master/log4j-core/src/main/java/org/apache/logging/log4j/core/appender/RandomAccessFileAppender.java&lt;/a&gt;&lt;br/&gt;
Unfortunately that class is final and hard to extend by delegation so the code is copied here.&lt;br/&gt;
The only substantive change is that a stopped HushableMutableRandomAccessAppender will no longer append&lt;br/&gt;
after it has been stopped.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  if (isStopped()) {
    // Don&apos;t try to log anything when appender is stopped
    return;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Make log4j OperationLogging use the CloseableRandomAccessFileAppender&lt;br/&gt;
Add a test that writes to the appender after it has been stopped.&lt;br/&gt;
Add a minimal LogEvent implementation for testing&lt;/p&gt;</comment>
                            <comment id="16210405" author="hiveqa" created="Thu, 19 Oct 2017 00:50:25 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12892871/HIVE-17826.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12892871/HIVE-17826.1.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 2 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 14 failed/errored test(s), 11280 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[llap_acid_fast] (batchId=156)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[optimize_nullscan] (batchId=163)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[subquery_multi] (batchId=110)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[subquery_notin] (batchId=133)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[subquery_scalar] (batchId=119)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[subquery_select] (batchId=119)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[subquery_views] (batchId=108)
org.apache.hadoop.hive.cli.TestSparkPerfCliDriver.testCliDriver[query16] (batchId=243)
org.apache.hadoop.hive.cli.TestSparkPerfCliDriver.testCliDriver[query94] (batchId=243)
org.apache.hadoop.hive.cli.TestTezPerfCliDriver.testCliDriver[query14] (batchId=241)
org.apache.hadoop.hive.cli.TestTezPerfCliDriver.testCliDriver[query16] (batchId=241)
org.apache.hadoop.hive.cli.TestTezPerfCliDriver.testCliDriver[query94] (batchId=241)
org.apache.hadoop.hive.cli.control.TestDanglingQOuts.checkDanglingQOut (batchId=204)
org.apache.hive.jdbc.TestTriggersTezSessionPoolManager.testTriggerHighShuffleBytes (batchId=229)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/7366/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/7366/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/7366/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/7366/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-7366/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-7366/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 14 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12892871 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="16211565" author="asherman" created="Thu, 19 Oct 2017 19:11:26 +0000"  >&lt;p&gt;Test failures appear unrelated to my change.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aihuaxu&quot; class=&quot;user-hover&quot; rel=&quot;aihuaxu&quot;&gt;aihuaxu&lt;/a&gt; please can you review?&lt;/p&gt;</comment>
                            <comment id="16211593" author="aihuaxu" created="Thu, 19 Oct 2017 19:32:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=asherman&quot; class=&quot;user-hover&quot; rel=&quot;asherman&quot;&gt;asherman&lt;/a&gt; Thanks for working on it.&lt;/p&gt;

&lt;p&gt;The idea sounds good. I&apos;m wondering if we could also add delaying the stop() (e.g. for 5 seconds) so we will not miss any outputs typically? Since if the clients miss the output, it could be an issue for the client especially for a script. &lt;/p&gt;</comment>
                            <comment id="16211942" author="asherman" created="Thu, 19 Oct 2017 23:53:01 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aihuaxu&quot; class=&quot;user-hover&quot; rel=&quot;aihuaxu&quot;&gt;aihuaxu&lt;/a&gt; I did think about that but I am not sure how to do it in a simple and clean way.   cleanupOperationLog() is called from Operation.closeO so adding a delay inline will prevent the session from terminating which seems weird. And doing it asynchronously makes it more complicated. &lt;/p&gt;

&lt;p&gt;But as we just discussed IRL I will think about it some more.&lt;/p&gt;</comment>
                            <comment id="16217913" author="asherman" created="Wed, 25 Oct 2017 00:15:52 +0000"  >&lt;p&gt;I looked into an alternative solution which is to use an &lt;a href=&quot;https://logging.apache.org/log4j/2.x/manual/appenders.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;IdlePurgePolicy&lt;/a&gt;. This can be inserted into log4j when the RoutingAppender Is created in LogDivertAppender. The IdlePurgePolicy works by scheduling a thread to run at a configurable interval. When the thread runs it checks if any of the RoutingAppender&#8217;s sub-Appenders have been idle for more than a configurable time. Any that are found are stopped and the AppenderControl  is removed. &lt;br/&gt;
I was able to use this instead of LogUtils.stopQueryAppender() to cause OperationLogs to close, providing an alternative mechanism for avoiding the file descriptor leak fixed in  &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-17128&quot; title=&quot;Operation Logging leaks file descriptors as the log4j Appender is never closed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-17128&quot;&gt;&lt;del&gt;HIVE-17128&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The problem I see is that an IdlePurgePolicy may prematurely close the log for a long running operation if the operation is not logging. I experimented to see what happens when logging with a particular key restarts after being closed by IdlePurgePolicy. The good thing is that the logging does succeed but the bad thing is that the second log file appears to overwrite the original log file.&lt;/p&gt;

&lt;p&gt;So I think that the original fix I proposed may be simpler and safer.&lt;/p&gt;

&lt;p&gt;Edited to add: we may also need &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-17373&quot; title=&quot;Upgrade some dependency versions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-17373&quot;&gt;HIVE-17373&lt;/a&gt; to be completed in order to get bug fixes to  log4j&lt;/p&gt;</comment>
                            <comment id="16220661" author="asherman" created="Thu, 26 Oct 2017 15:52:30 +0000"  >&lt;p&gt;What do you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aihuaxu&quot; class=&quot;user-hover&quot; rel=&quot;aihuaxu&quot;&gt;aihuaxu&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="16222661" author="aihuaxu" created="Fri, 27 Oct 2017 16:53:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=asherman&quot; class=&quot;user-hover&quot; rel=&quot;asherman&quot;&gt;asherman&lt;/a&gt; Make sense. Let&apos;s just take your original fix then. +1. &lt;/p&gt;</comment>
                            <comment id="16222677" author="asherman" created="Fri, 27 Oct 2017 17:01:45 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aihuaxu&quot; class=&quot;user-hover&quot; rel=&quot;aihuaxu&quot;&gt;aihuaxu&lt;/a&gt;, do we need more review? If not can you push this when convenient?&lt;/p&gt;</comment>
                            <comment id="16225696" author="aihuaxu" created="Mon, 30 Oct 2017 20:44:06 +0000"  >&lt;p&gt;Pushed to master. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=asherman&quot; class=&quot;user-hover&quot; rel=&quot;asherman&quot;&gt;asherman&lt;/a&gt; for the work.&lt;/p&gt;</comment>
                            <comment id="16225708" author="asherman" created="Mon, 30 Oct 2017 20:56:45 +0000"  >&lt;p&gt;Thank you for the review and push&lt;/p&gt;</comment>
                            <comment id="16485627" author="ashutoshc" created="Tue, 22 May 2018 23:16:59 +0000"  >&lt;p&gt;This jira is resolved and released with Hive 3.0 If you find an issue with it, please create a new jira.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13432629">HIVE-26014</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12892871" name="HIVE-17826.1.patch" size="21264" author="asherman" created="Wed, 18 Oct 2017 19:13:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3le2n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>