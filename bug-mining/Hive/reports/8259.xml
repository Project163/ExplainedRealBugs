<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:22:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-25758] OOM due to recursive application of CBO rules</title>
                <link>https://issues.apache.org/jira/browse/HIVE-25758</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Reproducing query is as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
create table test1 (act_nbr string);
create table test2 (month &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);
create table test3 (mth &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, con_usd &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;);

EXPLAIN
   SELECT c.month,
          d.con_usd
   FROM
     (SELECT &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(regexp_replace(substr(add_months(from_unixtime(unix_timestamp(), &lt;span class=&quot;code-quote&quot;&gt;&apos;yyyy-MM-dd&apos;&lt;/span&gt;), -1), 1, 7), &lt;span class=&quot;code-quote&quot;&gt;&apos;-&apos;&lt;/span&gt;, &apos;&apos;) AS &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) AS month
      FROM test1
      UNION ALL
      SELECT month
      FROM test2
      WHERE month = 202110) c
   JOIN test3 d ON c.month = d.mth; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Different plans are generated during the first CBO steps, last being:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2021-12-01T08:28:08,598 DEBUG [a18191bb-3a2b-4193-9abf-4e37dd1996bb main] parse.CalcitePlanner: Plan after decorre
lation:
HiveProject(month=[$0], con_usd=[$2])
&#160; HiveJoin(condition=[=($0, $1)], joinType=[inner], algorithm=[none], cost=[not available])
&#160; &#160; HiveProject(month=[$0])
&#160; &#160; &#160; HiveUnion(all=[true])
&#160; &#160; &#160; &#160; HiveProject(month=[CAST(regexp_replace(substr(add_months(FROM_UNIXTIME(UNIX_TIMESTAMP, _UTF-16LE&apos;yyyy-MM-d
d&apos;:VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot;), -1), 1, 7), _UTF-16LE&apos;-&apos;:VARCHAR(2147483647) CHARACTER SET &quot;UTF-
16LE&quot;, _UTF-16LE&apos;&apos;:VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot;)):INTEGER])
&#160; &#160; &#160; &#160; &#160; HiveTableScan(table=[[default, test1]], table:alias=[test1])
&#160; &#160; &#160; &#160; HiveProject(month=[$0])
&#160; &#160; &#160; &#160; &#160; HiveFilter(condition=[=($0, CAST(202110):INTEGER)])
&#160; &#160; &#160; &#160; &#160; &#160; HiveTableScan(table=[[default, test2]], table:alias=[test2])
&#160; &#160; HiveTableScan(table=[[default, test3]], table:alias=[d])&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Then, the HEP planner will keep expanding the filter expression with redundant expressions, such as the following, where the identical CAST expression is present multiple times:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;rel#118:HiveFilter.HIVE.[].any(input=HepRelVertex#39,condition=IN(CAST(regexp_replace(substr(add_months(FROM_UNIXTIME(UNIX_TIMESTAMP, _UTF-16LE&apos;yyyy-MM-dd&apos;:VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot;), -1), 1, 7), _UTF-16LE&apos;-&apos;:VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot;, _UTF-16LE&apos;&apos;:VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot;)):INTEGER, CAST(regexp_replace(substr(add_months(FROM_UNIXTIME(UNIX_TIMESTAMP, _UTF-16LE&apos;yyyy-MM-dd&apos;:VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot;), -1), 1, 7), _UTF-16LE&apos;-&apos;:VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot;, _UTF-16LE&apos;&apos;:VARCHAR(2147483647) CHARACTER SET &quot;UTF-16LE&quot;)):INTEGER, 202110))&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The problem seems to come from a bad interaction of at least &lt;em&gt;HiveFilterProjectTransposeRule&lt;/em&gt; and &lt;em&gt;HiveJoinPushTransitivePredicatesRule&lt;/em&gt;, possibly more.&lt;/p&gt;

&lt;p&gt;Most probably then UNION part can be removed and the reproducer be simplified even further.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13414857">HIVE-25758</key>
            <summary>OOM due to recursive application of CBO rules</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="asolimando">Alessandro Solimando</assignee>
                                    <reporter username="asolimando">Alessandro Solimando</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 1 Dec 2021 16:57:59 +0000</created>
                <updated>Thu, 24 Apr 2025 09:10:10 +0000</updated>
                            <resolved>Wed, 27 Apr 2022 08:49:51 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.0.0-alpha-2</fixVersion>
                                    <component>CBO</component>
                    <component>Query Planning</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="15000">4h 10m</timespent>
                                <comments>
                            <comment id="17480604" author="asolimando" created="Sun, 23 Jan 2022 11:53:33 +0000"  >&lt;p&gt;Yet another problematic query falling under the same issue:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE TABLE tableA
(
    `bd_id`            bigint,
    `quota_type`       string
);

select a.bd_id
from (
    select t.bd_id
    from tableA t
    where (t.bd_id = 8 and t.quota_type in(&apos;A&apos;,&apos;C&apos;)) or (t.bd_id = 9 and t.quota_type in (&apos;A&apos;,&apos;B&apos;))
 ) a join (
     select t.bd_id
     from tableA t
     where t.bd_id = 9 and t.quota_type in (&apos;A&apos;,&apos;B&apos;)
     union all
     select t.bd_id
     from tableA t
     where (t.bd_id = 8 and t.quota_type in(&apos;A&apos;,&apos;C&apos;)) or (t.bd_id = 9 and t.quota_type in (&apos;A&apos;,&apos;B&apos;))
) b on a.bd_id = b.bd_id
where a.bd_id = 8 or a.bd_id &amp;lt;&amp;gt;8;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17528659" author="zabetak" created="Wed, 27 Apr 2022 08:49:51 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/hive/commit/7583142cbffcb3958a546a9aaa15700bbc243df9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/commit/7583142cbffcb3958a546a9aaa15700bbc243df9&lt;/a&gt;. Thanks for the PR &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=asolimando&quot; class=&quot;user-hover&quot; rel=&quot;asolimando&quot;&gt;asolimando&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13278350">HIVE-22710</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13385144">HIVE-25275</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13421272">HIVE-25851</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13581913">HIVE-28310</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13616231">HIVE-28924</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 29 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0x9gw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>