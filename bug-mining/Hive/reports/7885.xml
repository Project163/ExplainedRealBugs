<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:19:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-24584] IndexOutOfBoundsException from Kryo when running msck repair</title>
                <link>https://issues.apache.org/jira/browse/HIVE-24584</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;The following exception is coming when running &quot;msck repair table t1 sync partitions&quot;.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IndexOutOfBoundsException: Index: 97, Size: 0
        at java.util.ArrayList.rangeCheck(ArrayList.java:657) ~[?:1.8.0_232]
        at java.util.ArrayList.get(ArrayList.java:433) ~[?:1.8.0_232]
        at org.apache.hive.com.esotericsoftware.kryo.util.MapReferenceResolver.getReadObject(MapReferenceResolver.java:60) ~[hive-exec-3.1.3000.7.2.7.0-144.jar:3.1.3000.7.2.7.0-SNAPSHOT]
        at org.apache.hive.com.esotericsoftware.kryo.Kryo.readReferenceOrNull(Kryo.java:834) ~[hive-exec-3.1.3000.7.2.7.0-144.jar:3.1.3000.7.2.7.0-SNAPSHOT]
        at org.apache.hive.com.esotericsoftware.kryo.Kryo.readObject(Kryo.java:684) ~[hive-exec-3.1.3000.7.2.7.0-144.jar:3.1.3000.7.2.7.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.exec.SerializationUtilities$KryoWithHooks.readObject(SerializationUtilities.java:211) ~[hive-exec-3.1.3000.7.2.7.0-144.jar:3.1.3000.7.2.7.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.exec.SerializationUtilities.deserializeObjectFromKryo(SerializationUtilities.java:814) ~[hive-exec-3.1.3000.7.2.7.0-144.jar:3.1.3000.7.2.7.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.exec.SerializationUtilities.deserializeExpressionFromKryo(SerializationUtilities.java:775) ~[hive-exec-3.1.3000.7.2.7.0-144.jar:3.1.3000.7.2.7.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.optimizer.ppr.PartitionExpressionForMetastore.deserializeExpr(PartitionExpressionForMetastore.java:116) [hive-exec-3.1.3000.7.2.7.0-144.jar:3.1.3000.7.2.7.0-SNAPSHOT]
        at org.apache.hadoop.hive.ql.optimizer.ppr.PartitionExpressionForMetastore.filterPartitionsByExpr(PartitionExpressionForMetastore.java:88) [hive-exec-3.1.3000.7.2.7.0-144.jar:3.1.3000.7.2.7.0-SNAPSHOT]  &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13349170">HIVE-24584</key>
            <summary>IndexOutOfBoundsException from Kryo when running msck repair</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="amagyar">Attila Magyar</assignee>
                                    <reporter username="amagyar">Attila Magyar</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 5 Jan 2021 11:27:36 +0000</created>
                <updated>Thu, 17 Nov 2022 13:14:51 +0000</updated>
                            <resolved>Thu, 4 Feb 2021 14:54:22 +0000</resolved>
                                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4200">1h 10m</timespent>
                                <comments>
                            <comment id="17258905" author="amagyar" created="Tue, 5 Jan 2021 12:56:20 +0000"  >&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srahman&quot; class=&quot;user-hover&quot; rel=&quot;srahman&quot;&gt;srahman&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17263983" author="srahman" created="Wed, 13 Jan 2021 08:34:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amagyar&quot; class=&quot;user-hover&quot; rel=&quot;amagyar&quot;&gt;amagyar&lt;/a&gt; - As per my understanding all msck command flow are defaulted to use MsckPartitionExpressionProxy unless EXPRESSION_PROXY_CLASS is explicitly given.&lt;br/&gt;
So is there any reason for explicitly setting EXPRESSION_PROXY_CLASS or am i missing anything? Because the above mentioned problem doesn&apos;t arise if you use the default path.&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Configuration getMsckConf(Configuration conf) {
    &lt;span class=&quot;code-comment&quot;&gt;// the only reason we are using &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; conf here is to override EXPRESSION_PROXY_CLASS
&lt;/span&gt;    Configuration metastoreConf = MetastoreConf.newMetastoreConf(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Configuration(conf));
    metastoreConf.set(MetastoreConf.ConfVars.EXPRESSION_PROXY_CLASS.getVarname(),
        metastoreConf.get(MetastoreConf.ConfVars.EXPRESSION_PROXY_CLASS.getVarname(),
            MsckPartitionExpressionProxy.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getCanonicalName()));
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; metastoreConf;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17263996" author="amagyar" created="Wed, 13 Jan 2021 09:05:15 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srahman&quot; class=&quot;user-hover&quot; rel=&quot;srahman&quot;&gt;srahman&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for the input. My understanding is that PartitionExpressionForMetastore is the default value of &quot;metastore.expression.proxy&quot; (In HiveConf.java/MetaStoreConf.java).&lt;/p&gt;

&lt;p&gt;Msck attempts to override this by creating a&#160;HiveMetaStoreClient with a modified config object. However unless HS2 and HMS are running inside the same process (or Msck is called within HMS via the periodically running PartitionManagementTask) this doesn&apos;t work.&lt;/p&gt;

&lt;p&gt;In case of a remote HMS, Msck should have called&#160;msc.setMetaConf() or something that modifies the config via thrift.&lt;/p&gt;</comment>
                            <comment id="17273303" author="srahman" created="Thu, 28 Jan 2021 04:39:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amagyar&quot; class=&quot;user-hover&quot; rel=&quot;amagyar&quot;&gt;amagyar&lt;/a&gt; Do you have any reproducible use case? Because i am not able to reproduce this on Hive 3.1.2 or Is this the issue of current master or different hive version?&lt;/p&gt;</comment>
                            <comment id="17273439" author="amagyar" created="Thu, 28 Jan 2021 09:15:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srahman&quot; class=&quot;user-hover&quot; rel=&quot;srahman&quot;&gt;srahman&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If you have a hive with a remote, non embedded HMS then:&lt;br/&gt;
1.) create external table t1 (c1 int, c2 int) partitioned by (c3 int) location &apos;hdfs:///warehouse/tablespace/external/hive/t1&apos;;&lt;/p&gt;

&lt;p&gt;2.)&lt;br/&gt;
insert into t1 partition(c3=1) values (1,1);&lt;br/&gt;
insert into t1 partition(c3=2) values (2,2);&lt;br/&gt;
insert into t1 partition(c3=3) values (3,3);&lt;/p&gt;

&lt;p&gt;3.) hdfs dfs -rm -r hdfs:///warehouse/tablespace/external/hive/t1/c3=3&lt;/p&gt;

&lt;p&gt;4.) msck repair table t1 sync partitions;&lt;/p&gt;</comment>
                            <comment id="17276184" author="amagyar" created="Mon, 1 Feb 2021 09:33:58 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srahman&quot; class=&quot;user-hover&quot; rel=&quot;srahman&quot;&gt;srahman&lt;/a&gt;, did you manage to reproduce it?&lt;/p&gt;</comment>
                            <comment id="17276212" author="srahman" created="Mon, 1 Feb 2021 09:53:56 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amagyar&quot; class=&quot;user-hover&quot; rel=&quot;amagyar&quot;&gt;amagyar&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Unfortunately i am not able to reproduce this. Here is my setup&lt;/p&gt;

&lt;p&gt;Hive Verison - 3.1.2 , I tried this in non-embedded mode i.e HMS (HMS running in different JVM from HS2) with SQL DB hosted locally (Running on the same node where my HS2 and HMS server are running). &lt;/p&gt;

&lt;p&gt;Am i missing anything?&lt;/p&gt;</comment>
                            <comment id="17277208" author="amagyar" created="Tue, 2 Feb 2021 15:38:46 +0000"  >&lt;p&gt;Hi Syed, thanks for trying it out.&lt;/p&gt;

&lt;p&gt;I think it should have worked that way. Anyway I created a test that reproduces the issue, depending on what value you set for&#160;IS_METASTORE_REMOTE.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ cd itests/hive-unit
$ mvn test -Dtest=TestMsck
$ grep &lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to deserialize the expression&quot;&lt;/span&gt; target/tmp/log/hive.log &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The test doesn&apos;t fail in any case (that&apos;s a testing issue) but you can see the Kryo related error in the log when you run it with&#160;IS_METASTORE_REMOTE=true.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13019859/13019859_msckrepro.patch&quot; title=&quot;msckrepro.patch attached to HIVE-24584&quot;&gt;msckrepro.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17278754" author="srahman" created="Thu, 4 Feb 2021 10:31:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amagyar&quot; class=&quot;user-hover&quot; rel=&quot;amagyar&quot;&gt;amagyar&lt;/a&gt; Thanks for coming up with the Test Case,&lt;/p&gt;

&lt;p&gt;The change looks good to me! (+1).&lt;br/&gt;
Looping in &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kgyrtkirk&quot; class=&quot;user-hover&quot; rel=&quot;kgyrtkirk&quot;&gt;kgyrtkirk&lt;/a&gt; for an extra confirmation!&lt;/p&gt;</comment>
                            <comment id="17278884" author="ngangam" created="Thu, 4 Feb 2021 14:54:10 +0000"  >&lt;p&gt;Fix has been committed to master. Closing the jira. Thank you for the fix &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amagyar&quot; class=&quot;user-hover&quot; rel=&quot;amagyar&quot;&gt;amagyar&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                                                <inwardlinks description="Is contained by">
                                        <issuelink>
            <issuekey id="13503018">HIVE-26751</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13316900">HIVE-23851</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13019859" name="msckrepro.patch" size="4668" author="amagyar" created="Tue, 2 Feb 2021 15:38:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0m1xc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>