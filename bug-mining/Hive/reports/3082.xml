<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:29:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-9359] Export of a large table causes OOM in Metastore and Client</title>
                <link>https://issues.apache.org/jira/browse/HIVE-9359</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Running hive export on a table with a large number of partitions winds up making the metastore and client run out of memory. The number of places we wind up having a copy of the entire partitions object wind up being as follows:&lt;/p&gt;

&lt;p&gt;Metastore&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(temporarily) Metastore MPartition objects&lt;/li&gt;
	&lt;li&gt;List&amp;lt;Partition&amp;gt; that gets persisted before sending to thrift&lt;/li&gt;
	&lt;li&gt;thrift copy of all of those partitions&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Client side&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;thrift copy of partitions&lt;/li&gt;
	&lt;li&gt;deepcopy of above to create List&amp;lt;Partition&amp;gt; objects&lt;/li&gt;
	&lt;li&gt;JSONObject that contains all of those above partition objects&lt;/li&gt;
	&lt;li&gt;List&amp;lt;ReadEntity&amp;gt; which each encapsulates the aforesaid partition objects.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This memory usage needs to be drastically reduced.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12767111">HIVE-9359</key>
            <summary>Export of a large table causes OOM in Metastore and Client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sushanth">Sushanth Sowmyan</assignee>
                                    <reporter username="sushanth">Sushanth Sowmyan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Jan 2015 12:41:26 +0000</created>
                <updated>Tue, 1 Oct 2019 22:07:51 +0000</updated>
                            <resolved>Thu, 22 Jan 2015 19:17:16 +0000</resolved>
                                                    <fixVersion>1.0.0</fixVersion>
                                    <component>Import/Export</component>
                    <component>Metastore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14275148" author="sushanth" created="Tue, 13 Jan 2015 12:42:07 +0000"  >&lt;p&gt;To fix this completely would need a significant retrofit of the client side, as well as some ability to do paginated batch retrieves from the metastore.&lt;/p&gt;

&lt;p&gt;A quick solution that goes a good deal of the way, however, is as follows:&lt;/p&gt;

&lt;p&gt;a) Changing some usages of List&amp;lt;Partition&amp;gt; to Iterable&amp;lt;Partition&amp;gt;, and have a PartitionIterable that implements the above interface to replace usages of List&amp;lt;Partition&amp;gt;, and have that class lazily fetch partitions on need. While having a pagination scheme from the metastore would be great, a good short term solution that&apos;s possible is to simply store the partition names rather than the entire partition objects, so a PartitionIterable can, in the meanwhile, get the partition names, and then handle the pagination itself.&lt;/p&gt;

&lt;p&gt;This solves the oom issues on the metastore completely, and gets rid of the thrift copy problem as well as the List&amp;lt;Partition&amp;gt; deepcopy problem. It introduces a load of storing all the partition names, but this is far less costly than the above.&lt;/p&gt;

&lt;p&gt;b) Changing the json serialization to output each element as they come, rather than constructing one large JSONObject, and writing that out in one go. This solves the large JSONObject problem.&lt;/p&gt;

&lt;p&gt;This still does not solve the problem of having a large number of ReadEntities, but that&apos;s something that&apos;s better tacked by doing something like a metadata-only-export, or changing export to be able to export a partial partition specification at a time, both of which are the subjects of further jiras I will be filing shortly.&lt;/p&gt;</comment>
                            <comment id="14275149" author="sushanth" created="Tue, 13 Jan 2015 12:43:41 +0000"  >&lt;p&gt;patch attached.&lt;/p&gt;</comment>
                            <comment id="14277245" author="hiveqa" created="Wed, 14 Jan 2015 17:15:14 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12691936/HIVE-9359.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12691936/HIVE-9359.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 5 failed/errored test(s), 7304 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestSparkClient - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_optimize_nullscan
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_optimize_nullscan
org.apache.hadoop.hive.ql.TestMTQueries.testMTQueries1
org.apache.hive.jdbc.TestSSL.testSSLFetchHttp
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2360/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2360/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2360/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2360/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-2360/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-2360/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12691936 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14278057" author="sushanth" created="Thu, 15 Jan 2015 01:34:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gates&quot; class=&quot;user-hover&quot; rel=&quot;gates&quot;&gt;gates&lt;/a&gt;, could you please review this patch?&lt;/p&gt;</comment>
                            <comment id="14282856" author="sushanth" created="Mon, 19 Jan 2015 18:53:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vikram.dixit&quot; class=&quot;user-hover&quot; rel=&quot;vikram.dixit&quot;&gt;vikram.dixit&lt;/a&gt;, this is another bug I&apos;d like to see in 0.14.1, because it has a pretty significant memory impact on the metastore if a user runs an export on a table with too many partituons.&lt;/p&gt;</comment>
                            <comment id="14283082" author="alangates" created="Mon, 19 Jan 2015 22:20:25 +0000"  >&lt;p&gt;One question: in EximUtil.createExportDump - is there a streaming JSON writer you could use so that we&apos;re not forced to hand-code JSON.  Maybe the JSON we&apos;re writing is simple enough, but this looks like it could end in a mess if our JSON gets complex.&lt;/p&gt;</comment>
                            <comment id="14283090" author="sushanth" created="Mon, 19 Jan 2015 22:27:05 +0000"  >&lt;p&gt;I see your concern. Jackson has a streaming api style with JSONGenerator, but I haven&apos;t yet been able to confirm if it generates the JSON object and then flushes as many others seem to do, or whether it actually writes out as it receives instructions. I can investigate a bit more on that end.&lt;/p&gt;</comment>
                            <comment id="14286629" author="sushanth" created="Thu, 22 Jan 2015 00:28:28 +0000"  >&lt;p&gt;Updated patch to use JsonGenerator.&lt;/p&gt;</comment>
                            <comment id="14286719" author="alangates" created="Thu, 22 Jan 2015 01:13:05 +0000"  >&lt;p&gt;+1.&lt;/p&gt;</comment>
                            <comment id="14287621" author="hiveqa" created="Thu, 22 Jan 2015 15:38:04 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12693758/HIVE-9359.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12693758/HIVE-9359.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 4 failed/errored test(s), 7347 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_index_auto_mult_tables
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_udaf_histogram_numeric
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_udaf_percentile_approx_23
org.apache.hive.hcatalog.streaming.TestStreaming.testEndpointConnection
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2475/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2475/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2475/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2475/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-2475/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-2475/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12693758 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14288033" author="alangates" created="Thu, 22 Jan 2015 19:17:16 +0000"  >&lt;p&gt;Patch 2 committed to trunk.  I don&apos;t believe the test failures are related, since they are all in code not even remotely close to export/import.&lt;/p&gt;</comment>
                            <comment id="14292686" author="vikram.dixit" created="Tue, 27 Jan 2015 00:10:28 +0000"  >&lt;p&gt;+1 for 1.0&lt;/p&gt;</comment>
                            <comment id="14292709" author="sushanth" created="Tue, 27 Jan 2015 00:25:27 +0000"  >&lt;p&gt;Committed to branch-1.0. Thanks, Vikram!&lt;/p&gt;</comment>
                            <comment id="14327559" author="thejas" created="Thu, 19 Feb 2015 14:45:00 +0000"  >&lt;p&gt;Updating release version for jiras resolved in 1.0.0 .&lt;/p&gt;</comment>
                            <comment id="14327844" author="thejas" created="Thu, 19 Feb 2015 18:21:49 +0000"  >&lt;p&gt;This issue has been fixed in Apache Hive 1.0.0. If there is any issue with the fix, please open a new jira to address it.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12693758" name="HIVE-9359.2.patch" size="11144" author="sushanth" created="Thu, 22 Jan 2015 00:28:28 +0000"/>
                            <attachment id="12691936" name="HIVE-9359.patch" size="10900" author="sushanth" created="Tue, 13 Jan 2015 12:43:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 39 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i24b07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>