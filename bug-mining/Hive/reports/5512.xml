<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:53:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-16487] Serious Zookeeper exception is logged when a race condition happens</title>
                <link>https://issues.apache.org/jira/browse/HIVE-16487</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;A customer started to see this in the logs, but happily everything was working as intended:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2017-03-30 12:01:59,446 ERROR ZooKeeperHiveLockManager: [HiveServer2-Background-Pool: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-620]: Serious Zookeeper exception: 
org.apache.zookeeper.KeeperException$NoNodeException: KeeperErrorCode = NoNode &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /hive_zookeeper_namespace/&amp;lt;TABLE_NAME&amp;gt;/LOCK-SHARED-
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This was happening, because a race condition between the lock releasing, and lock acquiring. The thread releasing the lock removes the parent ZK node just after the thread acquiring the lock made sure, that the parent node exists.&lt;/p&gt;

&lt;p&gt;Since this can happen without any real problem, I plan to add NODEEXISTS, and NONODE as a transient ZooKeeper exception, so the users are not confused.&lt;/p&gt;

&lt;p&gt;Also, the original author of ZooKeeperHiveLockManager maybe planned to handle different ZooKeeperExceptions differently, and the code is hard to understand. See the &lt;tt&gt;continue&lt;/tt&gt; and the &lt;tt&gt;break&lt;/tt&gt;. The &lt;tt&gt;break&lt;/tt&gt; only breaks the switch, and not the loop which IMHO is not intuitive:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
[..]
        ret = lockPrimitive(key, mode, keepAlive, parentCreated, 
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e1) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (e1 &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; KeeperException) {
          KeeperException e = (KeeperException) e1;
          &lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; (e.code()) {
          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; CONNECTIONLOSS:
          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; OPERATIONTIMEOUT:
            LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Possibly &lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt; ZooKeeper exception: &quot;&lt;/span&gt;, e);
            &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
          &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;:
            LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Serious Zookeeper exception: &quot;&lt;/span&gt;, e);
            &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
          }
        }
[..]
      }
    } &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (tryNum &amp;lt; numRetriesForLock);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If we do not want to try again in case of a &quot;Serious Zookeeper exception:&quot;, then we should add a label to the do loop, and break it in the switch.&lt;/p&gt;

&lt;p&gt;If we do want to try regardless of the type of the ZK exception, then we should just change the &lt;tt&gt;continue;&lt;/tt&gt; to &lt;tt&gt;break;&lt;/tt&gt; and move the lines part of the code which did not run in case of &lt;tt&gt;continue&lt;/tt&gt; to the &lt;tt&gt;default&lt;/tt&gt; switch, so it is easier to understand the code.&lt;/p&gt;

&lt;p&gt;Any suggestions or ideas &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ctang.ma&quot; class=&quot;user-hover&quot; rel=&quot;ctang.ma&quot;&gt;ctang.ma&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=szehon&quot; class=&quot;user-hover&quot; rel=&quot;szehon&quot;&gt;szehon&lt;/a&gt;?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13065503">HIVE-16487</key>
            <summary>Serious Zookeeper exception is logged when a race condition happens</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pvary">Peter Vary</assignee>
                                    <reporter username="pvary">Peter Vary</reporter>
                        <labels>
                    </labels>
                <created>Thu, 20 Apr 2017 12:08:14 +0000</created>
                <updated>Wed, 23 May 2018 00:00:28 +0000</updated>
                            <resolved>Mon, 1 May 2017 13:59:34 +0000</resolved>
                                    <version>3.0.0</version>
                                    <fixVersion>2.3.2</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Locking</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15976624" author="ctang.ma" created="Thu, 20 Apr 2017 12:41:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvary&quot; class=&quot;user-hover&quot; rel=&quot;pvary&quot;&gt;pvary&lt;/a&gt;, your analysis makes sense. Thanks.&lt;/p&gt;</comment>
                            <comment id="15977080" author="pvary" created="Thu, 20 Apr 2017 17:04:31 +0000"  >&lt;p&gt;The proposed patch:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Keeping the retying behavior&lt;/li&gt;
	&lt;li&gt;NONODE, and NODEEXISTS are not Serious Zookeeper exceptions&lt;/li&gt;
	&lt;li&gt;Moved the exit check into the switch&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15983128" author="ctang.ma" created="Tue, 25 Apr 2017 16:12:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvary&quot; class=&quot;user-hover&quot; rel=&quot;pvary&quot;&gt;pvary&lt;/a&gt; I think the Exception e1 will be eaten, if it is not an instance of KeeperException, after numRetriesForLock with this patch.&lt;/p&gt;</comment>
                            <comment id="15988806" author="pvary" created="Fri, 28 Apr 2017 13:37:43 +0000"  >&lt;p&gt;Cleaned up the code a little.&lt;br/&gt;
I think it is more readable this way.&lt;/p&gt;</comment>
                            <comment id="15988954" author="ctang.ma" created="Fri, 28 Apr 2017 14:55:22 +0000"  >&lt;p&gt;LGTM, +1 pending tests.&lt;/p&gt;</comment>
                            <comment id="15989775" author="hiveqa" created="Sat, 29 Apr 2017 05:36:32 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12865547/HIVE-16487.02.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12865547/HIVE-16487.02.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 3 failed/errored test(s), 10635 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestAccumuloCliDriver.testCliDriver[accumulo_index] (batchId=225)
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[smb_mapjoin_2] (batchId=234)
org.apache.hive.jdbc.TestMultiSessionsHS2WithLocalClusterSpark.testSparkQuery (batchId=223)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/4933/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/4933/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/4933/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/4933/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-4933/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-4933/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12865547 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15989833" author="pvary" created="Sat, 29 Apr 2017 10:18:23 +0000"  >&lt;p&gt;The failures are not related:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;There is a patch waiting for commit which will solve TestBeeLineDriver.testCliDriver&lt;span class=&quot;error&quot;&gt;&amp;#91;smb_mapjoin_2&amp;#93;&lt;/span&gt;. See: &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-16451&quot; title=&quot;Race condition between HiveStatement.getQueryLog and HiveStatement.runAsyncOnServer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-16451&quot;&gt;&lt;del&gt;HIVE-16451&lt;/del&gt;&lt;/a&gt; - Race condition between HiveStatement.getQueryLog and HiveStatement.runAsyncOnServer&lt;/li&gt;
	&lt;li&gt;Created new flaky test jira, since I have already seen this recently: &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-16561&quot; title=&quot;Flaky test :TestMultiSessionsHS2WithLocalClusterSpark.testSparkQuery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-16561&quot;&gt;HIVE-16561&lt;/a&gt; - Flaky test :TestMultiSessionsHS2WithLocalClusterSpark.testSparkQuery&lt;/li&gt;
	&lt;li&gt;There is ongoing work for TestAccumuloCliDriver.testCliDriver&lt;span class=&quot;error&quot;&gt;&amp;#91;accumulo_index&amp;#93;&lt;/span&gt;. See: &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-15795&quot; title=&quot;Support Accumulo Index Tables in Hive Accumulo Connector&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-15795&quot;&gt;&lt;del&gt;HIVE-15795&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
Support Accumulo Index Tables in Hive Accumulo Connector&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks for the review,&lt;br/&gt;
Peter&lt;/p&gt;</comment>
                            <comment id="15990822" author="ctang.ma" created="Mon, 1 May 2017 13:59:34 +0000"  >&lt;p&gt;Committed to 3.0.0 and 2.4.0. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pvary&quot; class=&quot;user-hover&quot; rel=&quot;pvary&quot;&gt;pvary&lt;/a&gt; for the patch.&lt;/p&gt;</comment>
                            <comment id="15990932" author="pvary" created="Mon, 1 May 2017 15:09:11 +0000"  >&lt;p&gt;Thanks for the review and the commit Chaoyu Tang!&lt;/p&gt;</comment>
                            <comment id="16486394" author="vgarg" created="Wed, 23 May 2018 00:00:28 +0000"  >&lt;p&gt;Hive 3.0.0 has been released so closing this jira.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12865547" name="HIVE-16487.02.patch" size="4299" author="pvary" created="Fri, 28 Apr 2017 13:37:43 +0000"/>
                            <attachment id="12864317" name="HIVE-16487.patch" size="1877" author="pvary" created="Thu, 20 Apr 2017 17:04:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3dv67:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>