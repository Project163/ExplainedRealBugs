<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:21:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-24590] Operation Logging still leaks the log4j Appenders</title>
                <link>https://issues.apache.org/jira/browse/HIVE-24590</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;I&apos;m using Hive 3.1.2 with options below.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hive.server2.logging.operation.enabled=true&lt;/li&gt;
	&lt;li&gt;hive.server2.logging.operation.level=VERBOSE&lt;/li&gt;
	&lt;li&gt;hive.async.log.enabled=false&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I already know the ticket,&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-17128&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-17128&lt;/a&gt;&#160;but HS2 still leaks log4j RandomAccessFileManager.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13018234/13018234_Screen+Shot+2021-01-06+at+18.42.05.png&quot; height=&quot;197&quot; width=&quot;756&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;I checked the operation log file which is not closed/deleted properly.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13018233/13018233_Screen+Shot+2021-01-06+at+18.42.24.png&quot; height=&quot;272&quot; width=&quot;603&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Then there&apos;s the log,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
client.TezClient: Shutting down Tez Session, sessionName= ....&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13018232/13018232_Screen+Shot+2021-01-06+at+18.42.55.png&quot; height=&quot;26&quot; width=&quot;1372&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13350636">HIVE-24590</key>
            <summary>Operation Logging still leaks the log4j Appenders</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zabetak">Stamatis Zampetakis</assignee>
                                    <reporter username="euigeun_chung">Eugene Chung</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 6 Jan 2021 10:35:52 +0000</created>
                <updated>Thu, 17 Nov 2022 08:47:50 +0000</updated>
                            <resolved>Tue, 9 Nov 2021 12:27:02 +0000</resolved>
                                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                    <component>Logging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="22800">6h 20m</timespent>
                                <comments>
                            <comment id="17259613" author="zabetak" created="Wed, 6 Jan 2021 11:12:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=euigeun_chung&quot; class=&quot;user-hover&quot; rel=&quot;euigeun_chung&quot;&gt;euigeun_chung&lt;/a&gt;&#160;which process is leaking descriptors? HS2 or LLAP?&#160;&lt;/p&gt;</comment>
                            <comment id="17259615" author="euigeun_chung" created="Wed, 6 Jan 2021 11:14:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zabetak&quot; class=&quot;user-hover&quot; rel=&quot;zabetak&quot;&gt;zabetak&lt;/a&gt;&#160;It&apos;s HS2.&lt;/p&gt;</comment>
                            <comment id="17259616" author="zabetak" created="Wed, 6 Jan 2021 11:15:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=euigeun_chung&quot; class=&quot;user-hover&quot; rel=&quot;euigeun_chung&quot;&gt;euigeun_chung&lt;/a&gt;&#160; OK I just noticed in the description that you are referring to the HS2 process.&lt;/p&gt;</comment>
                            <comment id="17259649" author="zabetak" created="Wed, 6 Jan 2021 11:59:07 +0000"  >&lt;p&gt;I assume the reason of why there is still a leak is the same with&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-24569&quot; title=&quot;LLAP daemon leaks file descriptors/log4j appenders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-24569&quot;&gt;&lt;del&gt;HIVE-24569&lt;/del&gt;&lt;/a&gt;, meaning that cleanup is performed with&#160;Operation#cleanupOperationLog so one appender is closed but then another thread comes and attempts to write to the same file thus creating an additional appender that will never be closed.&lt;/p&gt;

&lt;p&gt;This also explains why the content of the respective log file has only one line. During the &lt;tt&gt;cleanupOperationLog&lt;/tt&gt;,&#160;&lt;tt&gt;OperationLogCleaner&lt;/tt&gt; is called so the full operation log file will be deleted but then if somebody else tries to write to it (e.g., TezClient) the file will be recreated leading to the leak.&#160;&lt;/p&gt;</comment>
                            <comment id="17259686" author="euigeun_chung" created="Wed, 6 Jan 2021 12:49:35 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13018240/13018240_add_debug_log_and_trace.patch&quot; title=&quot;add_debug_log_and_trace.patch attached to HIVE-24590&quot;&gt;add_debug_log_and_trace.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&#160;I added some debug logs like this patch to&#160;HushableRandomAccessFileAppender. (Note that my&#160;HushableRandomAccessFileAppender is patched with&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-22753&quot; title=&quot;Fix gradual mem leak: Operationlog related appenders should be cleared up on errors &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-22753&quot;&gt;&lt;del&gt;HIVE-22753&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13018241/13018241_Screen+Shot+2021-01-06+at+21.38.32.png&quot; height=&quot;38&quot; width=&quot;893&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;The operation log is stopped with&#160;HushableRandomAccessFileAppender.stop().&lt;/p&gt;

&lt;p&gt;Then it seems that operation log file with the different name is created by the same thread.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13018242/13018242_Screen+Shot+2021-01-06+at+21.47.28.png&quot; height=&quot;30&quot; width=&quot;1249&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17259725" author="euigeun_chung" created="Wed, 6 Jan 2021 13:55:24 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2021-01-06T22:35:48,371]  INFO [HiveServer2-HttpHandler-Pool: Thread-101] client.TezClient: Shutting down Tez Session, sessionName=********og-20210106222500-bc649f09-a16a-4295-ac16-f3e86883364b, applicationId=application_1591769205146_5391722
2021-01-06 22:35:48,373 HiveServer2-HttpHandler-Pool: Thread-101 WARN /*******/logs/hive_operation/edcd87dd-1fd5-4bdb-b29b-e125a05c1dfd/****_20210106223510_2bf8d74d-5347-4e56-a316-7a59a83f860f for RandomAccessFileManager is created. org.apache.hadoop.hive.ql.log.HushableRandomAccessFileAppender$DebugTrace: /*******/logs/hive_operation/edcd87dd-1fd5-4bdb-b29b-e125a05c1dfd/irteam_20210106223510_2bf8d74d-5347-4e56-a316-7a59a83f860f
	at org.apache.hadoop.hive.ql.log.HushableRandomAccessFileAppender.createAppender(HushableRandomAccessFileAppender.java:217)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.apache.logging.log4j.core.config.plugins.util.PluginBuilder.build(PluginBuilder.java:136)
	at org.apache.logging.log4j.core.config.AbstractConfiguration.createPluginObject(AbstractConfiguration.java:958)
	at org.apache.logging.log4j.core.config.AbstractConfiguration.createConfiguration(AbstractConfiguration.java:898)
	at org.apache.logging.log4j.core.appender.routing.RoutingAppender.createAppender(RoutingAppender.java:271)
	at org.apache.logging.log4j.core.appender.routing.RoutingAppender.getControl(RoutingAppender.java:255)
	at org.apache.logging.log4j.core.appender.routing.RoutingAppender.append(RoutingAppender.java:225)
	at org.apache.logging.log4j.core.config.AppenderControl.tryCallAppender(AppenderControl.java:156)
	at org.apache.logging.log4j.core.config.AppenderControl.callAppender0(AppenderControl.java:129)
	at org.apache.logging.log4j.core.config.AppenderControl.callAppenderPreventRecursion(AppenderControl.java:120)
	at org.apache.logging.log4j.core.config.AppenderControl.callAppender(AppenderControl.java:84)
	at org.apache.logging.log4j.core.config.LoggerConfig.callAppenders(LoggerConfig.java:448)
	at org.apache.logging.log4j.core.config.LoggerConfig.processLogEvent(LoggerConfig.java:433)
	at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:417)
	at org.apache.logging.log4j.core.config.LoggerConfig.logParent(LoggerConfig.java:439)
	at org.apache.logging.log4j.core.config.LoggerConfig.processLogEvent(LoggerConfig.java:434)
	at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:417)
	at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:403)
	at org.apache.logging.log4j.core.config.AwaitCompletionReliabilityStrategy.log(AwaitCompletionReliabilityStrategy.java:63)
	at org.apache.logging.log4j.core.Logger.logMessage(Logger.java:146)
	at org.apache.log4j.Category.forcedLog(Category.java:357)
	at org.apache.log4j.Category.log(Category.java:445)
	at org.slf4j.impl.Log4jLoggerAdapter.info(Log4jLoggerAdapter.java:304)
	at org.apache.tez.client.TezClient.stop(TezClient.java:737)
	at org.apache.hadoop.hive.ql.exec.tez.TezSessionState.closeClient(TezSessionState.java:710)
	at org.apache.hadoop.hive.ql.exec.tez.TezSessionState.close(TezSessionState.java:677)
	at org.apache.hadoop.hive.ql.exec.tez.TezSessionPoolSession.close(TezSessionPoolSession.java:111)
	at org.apache.hadoop.hive.ql.exec.tez.TezSessionPoolManager.closeIfNotDefault(TezSessionPoolManager.java:354)
	at org.apache.hadoop.hive.ql.session.SessionState.close(SessionState.java:1765)
	at org.apache.hive.service.cli.session.HiveSessionImpl.close(HiveSessionImpl.java:761)
	at org.apache.hive.service.cli.session.HiveSessionImplwithUGI.close(HiveSessionImplwithUGI.java:93)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.apache.hive.service.cli.session.HiveSessionProxy.invoke(HiveSessionProxy.java:78)
	at org.apache.hive.service.cli.session.HiveSessionProxy.access$000(HiveSessionProxy.java:36)
	at org.apache.hive.service.cli.session.HiveSessionProxy$1.run(HiveSessionProxy.java:63)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:422)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1729)
	at org.apache.hive.service.cli.session.HiveSessionProxy.invoke(HiveSessionProxy.java:59)
	at com.sun.proxy.$Proxy63.close(Unknown Source)
	at org.apache.hive.service.cli.session.SessionManager.closeSession(SessionManager.java:553)
	at org.apache.hive.service.cli.CLIService.closeSession(CLIService.java:241)
	at org.apache.hive.service.cli.thrift.ThriftCLIService.CloseSession(ThriftCLIService.java:522)
	at org.apache.hive.service.rpc.thrift.TCLIService$Processor$CloseSession.getResult(TCLIService.java:1517)
	at org.apache.hive.service.rpc.thrift.TCLIService$Processor$CloseSession.getResult(TCLIService.java:1502)
	at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:39)
	at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:39)
	at org.apache.thrift.server.TServlet.doPost(TServlet.java:83)
	at org.apache.hive.service.cli.thrift.ThriftHttpServlet.doPost(ThriftHttpServlet.java:207)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:707)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:790)
	at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:848)
	at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:584)
	at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:224)
	at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1180)
	at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:512)
	at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)
	at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1112)
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)
	at org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:493)
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)
	at org.eclipse.jetty.server.Server.handle(Server.java:534)
	at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:320)
	at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:251)
	at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:283)
	at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:108)
	at org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)
	at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.executeProduceConsume(ExecuteProduceConsume.java:303)
	at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceConsume(ExecuteProduceConsume.java:148)
	at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:136)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:748)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think the main cause of the leak is that logging of TezClient.stop() is logged as the operation log.&lt;/p&gt;

&lt;p&gt;At the very beginning of&#160;HiveSessionImpl.close(), shouldn&apos;t it be cleared for operation log setting of the log4j context?&lt;/p&gt;

&lt;p&gt;Note that my tez client is 0.9.2.&lt;/p&gt;</comment>
                            <comment id="17259778" author="zabetak" created="Wed, 6 Jan 2021 14:59:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;Then it seems that operation log file with the different name is created by the same thread&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;A different file but for the same query right? &lt;/p&gt;

&lt;p&gt;After stopping the appender the log4j context should be cleared otherwise whatever is logged afterwards (with the same context) is gonna recreate an appender that we cannot close.&lt;/p&gt;</comment>
                            <comment id="17259845" author="euigeun_chung" created="Wed, 6 Jan 2021 16:16:18 +0000"  >&lt;p&gt;&amp;gt; A different file but for the same query right?&lt;/p&gt;

&lt;p&gt;It seems not. The query which is done normally and the closing of its session on the same HttpHandler thread.&lt;/p&gt;

&lt;p&gt;I think in the flow of closing session, logging of TezClient.close() is creating the operation log.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	at org.apache.log4j.Category.log(Category.java:445)
	at org.slf4j.impl.Log4jLoggerAdapter.info(Log4jLoggerAdapter.java:304)
	at org.apache.tez.client.TezClient.stop(TezClient.java:737)
	at org.apache.hadoop.hive.ql.exec.tez.TezSessionState.closeClient(TezSessionState.java:710)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17259857" author="zabetak" created="Wed, 6 Jan 2021 16:29:25 +0000"  >&lt;p&gt;The appender/files are created and closed based on the queryId. This queryId is in the log4j context (usually in ThreadLocal variables) and can be present in various threads. I suspect that the thread local is cleared on some threads but not on others. If you are tracking the creation of the appenders you can see if the same appender is created twice.&lt;/p&gt;</comment>
                            <comment id="17259880" author="zabetak" created="Wed, 6 Jan 2021 16:57:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;Then it seems that operation log file with the different name is created by the same thread.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Given that they have a different name I suppose it means that somebody changed the log4j context on this thread (to reflect another session/query) but possibly at a bad timing.&lt;/p&gt;</comment>
                            <comment id="17259881" author="euigeun_chung" created="Wed, 6 Jan 2021 16:58:02 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2021-01-06 22:35:48,150 edcd87dd-1fd5-4bdb-b29b-e125a05c1dfd HiveServer2-HttpHandler-Pool: Thread-102 WARN /******/logs/hive_operation/edcd87dd-1fd5-4bdb-b29b-e125a05c1dfd/******_20210106223512_515ce970-bde2-4066-bebf-f97c039ece3c for RandomAccessFileManager is stopped. org.apache.hadoop.hive.ql.log.HushableRandomAccessFileAppender$DebugTrace: /******/logs/hive_operation/edcd87dd-1fd5-4bdb-b29b-e125a05c1dfd/******_20210106223512_515ce970-bde2-4066-bebf-f97c039ece3c

&amp;lt;--- The query is done. There&apos;s a sessionId between time and the thread name.

[2021-01-06T22:35:48,371] INFO [HiveServer2-HttpHandler-Pool: Thread-101] client.TezClient: Shutting down Tez Session, sessionName=********og-20210106222500-bc649f09-a16a-4295-ac16-f3e86883364b, applicationId=application_1591769205146_5391722
2021-01-06 22:35:48,373 HiveServer2-HttpHandler-Pool: Thread-101 WARN /******/logs/hive_operation/edcd87dd-1fd5-4bdb-b29b-e125a05c1dfd/****_20210106223510_2bf8d74d-5347-4e56-a316-7a59a83f860f for RandomAccessFileManager is created. org.apache.hadoop.hive.ql.log.HushableRandomAccessFileAppender$DebugTrace: /******/logs/hive_operation/edcd87dd-1fd5-4bdb-b29b-e125a05c1dfd/******_20210106223510_2bf8d74d-5347-4e56-a316-7a59a83f860f

&amp;lt;--- The session is closing. There&apos;s NO sessionId between time and the thread name. It means log4j MDC is cleared.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Is it safe not to create&#160;HushableRandomAccessFileAppender if log4j MDC has no operation context?&lt;/p&gt;

&lt;p&gt;I&apos;m thinking of it as a solution to the leak. (+ I know where MDC contexts are set.&#160;&lt;a href=&quot;https://github.com/apache/hive/blob/8190d2be7b7165effa62bd21b7d60ef81fb0e4af/common/src/java/org/apache/hadoop/hive/common/LogUtils.java#L218&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/8190d2be7b7165effa62bd21b7d60ef81fb0e4af/common/src/java/org/apache/hadoop/hive/common/LogUtils.java#L218&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="17259883" author="zabetak" created="Wed, 6 Jan 2021 17:04:02 +0000"  >&lt;p&gt;I think a good solution is to use &lt;tt&gt;IdlePurgePolicy&lt;/tt&gt; and let log4j take care of the rest but if you have other ideas please share them.&lt;/p&gt;</comment>
                            <comment id="17261235" author="euigeun_chung" created="Fri, 8 Jan 2021 11:14:59 +0000"  >&lt;p&gt;I&apos;ve been digging it for days, and have found that MDC is not cleared.&lt;/p&gt;

&lt;p&gt;Even I call MDC.clear() at org.apache.hive.service.cli.session.HiveSessionImpl.close(), the MDC context set by LogUtils.registerLoggingContext() still exists at org.apache.hadoop.hive.ql.log.HushableRandomAccessFileAppender.createAppender().&lt;/p&gt;

&lt;p&gt;While following the codes related to slf4j MDC, it actually calls Log4jMDCAdapter and finally accesses log4j ThreadContext. It is basically stack-based. I don&apos;t know how&#160;log4j ThreadContext works exactly right now, but the log4j MDC stacks at the point of HiveSessionImpl.close() and&#160;HushableRandomAccessFileAppender.createAppender() seems to be different.&#160;&lt;/p&gt;

&lt;p&gt;When I call log4j ThreadContext.clearAll() instead of MDC.clear()(=ThreadContext.clearMap()),&#160;HushableRandomAccessFileAppender.createAppender() is not called anymore at the time of closing session.&lt;/p&gt;</comment>
                            <comment id="17261248" author="euigeun_chung" created="Fri, 8 Jan 2021 11:28:03 +0000"  >&lt;p&gt;I think&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;we can set disableThreadContextStack to true if MDC is not necessary to be stack-based. &lt;a href=&quot;https://logging.apache.org/log4j/2.x/manual/thread-context.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://logging.apache.org/log4j/2.x/manual/thread-context.html&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;we can call&#160;ThreadContext.clearAll() instead of MDC.clear() at LogUtils.unregisterLoggingContext().&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17261251" author="zabetak" created="Fri, 8 Jan 2021 11:48:48 +0000"  >&lt;p&gt;Thanks for looking into this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=euigeun_chung&quot; class=&quot;user-hover&quot; rel=&quot;euigeun_chung&quot;&gt;euigeun_chung&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The main problem is the leak of appenders and file descriptors and I think this can be solved by adopting an appropriate purge policy as I wrote earlier. If this happens then we may remove LogUtils.unregisterLoggingContext() altogether.&#160;&lt;/p&gt;

&lt;p&gt;If the leak is solved then the next question is: are the log messages directed to the proper files or not? Depending on the answer we may need to look on how to clear/set the log4j context.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17261266" author="euigeun_chung" created="Fri, 8 Jan 2021 12:09:38 +0000"  >&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13018369/13018369_Screen+Shot+2021-01-08+at+21.01.40.png&quot; height=&quot;34&quot; width=&quot;1486&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;I have a question. Couldn&apos;t operation logs be idle for an hour like screenshot or days if the query time is very long?&lt;/p&gt;

&lt;p&gt;My concern is that setting the time for purge policy could be difficult.&lt;/p&gt;</comment>
                            <comment id="17261280" author="euigeun_chung" created="Fri, 8 Jan 2021 12:33:01 +0000"  >&lt;p&gt;&amp;gt; are the log messages directed to the proper files or not?&lt;/p&gt;

&lt;p&gt;I observed the situation. Sometimes logs for HDFS delegation token generated by other accounts are shown in my operation log. (I am using kerberized Hadoop &amp;amp; Hive.)&lt;/p&gt;</comment>
                            <comment id="17261298" author="zabetak" created="Fri, 8 Jan 2021 13:20:52 +0000"  >&lt;p&gt;I may have misunderstood what IdlePurgePolicy does. In my mind, I was thinking that if the appender is removed due to inactivity and then at some point in time there is a request to write to the same route then a new appender (pointing to the same file) could open without problem.&lt;/p&gt;</comment>
                            <comment id="17262748" author="zabetak" created="Mon, 11 Jan 2021 16:07:46 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=euigeun_chung&quot; class=&quot;user-hover&quot; rel=&quot;euigeun_chung&quot;&gt;euigeun_chung&lt;/a&gt;, can you try out the patch in &lt;a href=&quot;https://github.com/apache/hive/pull/1849&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/pull/1849&lt;/a&gt;&#160;and see what it gives on your setting?&lt;/p&gt;</comment>
                            <comment id="17264100" author="euigeun_chung" created="Wed, 13 Jan 2021 11:58:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zabetak&quot; class=&quot;user-hover&quot; rel=&quot;zabetak&quot;&gt;zabetak&lt;/a&gt;&#160;Okay. Let me try.&lt;/p&gt;</comment>
                            <comment id="17265040" author="zabetak" created="Thu, 14 Jan 2021 17:23:08 +0000"  >&lt;p&gt;Many thanks for the help &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=euigeun_chung&quot; class=&quot;user-hover&quot; rel=&quot;euigeun_chung&quot;&gt;euigeun_chung&lt;/a&gt;! Let me know when you have the results &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17404424" author="glapark" created="Wed, 25 Aug 2021 12:51:02 +0000"  >&lt;p&gt;I find that similarly to calling ThreadContext.clearAll(), explicitly calling MDC.remove() in the reverse order also works fine in Hive 3.1.2.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void unregisterLoggingContext(Configuration conf) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (HiveConf.getBoolVar(conf, HiveConf.ConfVars.HIVE_SERVER2_LOGGING_OPERATION_ENABLED)) {
      MDC.remove(OPERATIONLOG_LEVEL_KEY);
    }
    MDC.remove(QUERYID_LOG_KEY);
    MDC.remove(SESSIONID_LOG_KEY);
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17441130" author="zabetak" created="Tue, 9 Nov 2021 12:27:02 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/hive/commit/2dcd72f22d0edccfb5a21b56b7c9a60f5371837e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2dcd72f22d0edccfb5a21b56b7c9a60f5371837e&lt;/a&gt;. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=euigeun_chung&quot; class=&quot;user-hover&quot; rel=&quot;euigeun_chung&quot;&gt;euigeun_chung&lt;/a&gt; for helping out testing this fix and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=belugabehr&quot; class=&quot;user-hover&quot; rel=&quot;belugabehr&quot;&gt;belugabehr&lt;/a&gt; for the review and insightful discussion. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310460">
                    <name>Child-Issue</name>
                                                                <inwardlinks description="is a child of">
                                        <issuelink>
            <issuekey id="13280654">HIVE-22753</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13429987">HIVE-25970</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13088540">HIVE-17128</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13347781">HIVE-24569</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="13432629">HIVE-26014</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13018234" name="Screen Shot 2021-01-06 at 18.42.05.png" size="295441" author="euigeun_chung" created="Wed, 6 Jan 2021 10:26:38 +0000"/>
                            <attachment id="13018233" name="Screen Shot 2021-01-06 at 18.42.24.png" size="236917" author="euigeun_chung" created="Wed, 6 Jan 2021 10:26:38 +0000"/>
                            <attachment id="13018232" name="Screen Shot 2021-01-06 at 18.42.55.png" size="88418" author="euigeun_chung" created="Wed, 6 Jan 2021 10:26:38 +0000"/>
                            <attachment id="13018241" name="Screen Shot 2021-01-06 at 21.38.32.png" size="189059" author="euigeun_chung" created="Wed, 6 Jan 2021 12:45:27 +0000"/>
                            <attachment id="13018242" name="Screen Shot 2021-01-06 at 21.47.28.png" size="94366" author="euigeun_chung" created="Wed, 6 Jan 2021 12:48:42 +0000"/>
                            <attachment id="13018369" name="Screen Shot 2021-01-08 at 21.01.40.png" size="63234" author="euigeun_chung" created="Fri, 8 Jan 2021 12:05:14 +0000"/>
                            <attachment id="13018240" name="add_debug_log_and_trace.patch" size="1860" author="euigeun_chung" created="Wed, 6 Jan 2021 12:42:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0mb5s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>