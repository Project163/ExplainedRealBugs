<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:27:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-28790] ACID deletes are failing with ArrayIndexOutOfBoundsException when direct insert is enabled </title>
                <link>https://issues.apache.org/jira/browse/HIVE-28790</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;&lt;b&gt;Steps to reproduce:&lt;/b&gt;&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    set mapreduce.job.reduces=7;
    create external table ext(a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) stored as textfile;
    insert into table ext values(1),(2),(3),(4),(5),(6),(7), (8), (9), (12);
    create table full_acid(a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) stored as orc tblproperties(&lt;span class=&quot;code-quote&quot;&gt;&quot;transactional&quot;&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;);

    insert into table full_acid select * from ext where a != 3 and a &amp;lt;=7 group by a;
    insert into table full_acid select * from ext where a&amp;gt;7 group by a;

    set mapreduce.job.reduces=1;
    delete from full_acid where a in (2, 12);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The delete will fail with the following exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.ArrayIndexOutOfBoundsException: 6
	at org.apache.hadoop.hive.ql.exec.FileSinkOperator$FSPaths.closeWriters(FileSinkOperator.java:258)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;The problem&lt;/b&gt; is in the FileSinkOperator.createDynamicBucket method:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; createDynamicBucket(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; bucketNum) {
      &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; assumes all paths are bucket names (which means no lookup is needed)
&lt;/span&gt;      &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; writerOffset = bucketNum;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (updaters.length &amp;lt;= writerOffset) {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.updaters = Arrays.copyOf(updaters, writerOffset + 1);
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.outPaths = Arrays.copyOf(outPaths, writerOffset + 1);
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.finalPaths = Arrays.copyOf(finalPaths, writerOffset + 1);
      }

      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.finalPaths[writerOffset] == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (conf.isDirectInsert()) {
          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.outPathsCommitted = Arrays.copyOf(outPathsCommitted, writerOffset + 1);
          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.finalPaths[writerOffset] = buildTmpPath();
          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.outPaths[writerOffset] = buildTmpPath();
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
          &lt;span class=&quot;code-comment&quot;&gt;// uninitialized bucket
&lt;/span&gt;          &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; bucketName =
              Utilities.replaceTaskIdFromFilename(Utilities.getTaskId(hconf), bucketNum);
          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.finalPaths[writerOffset] = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(bDynParts ? buildTmpPath() : parent, bucketName);
          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.outPaths[writerOffset] = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(buildTaskOutputTempPath(), bucketName);
        }
      }
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; writerOffset;
    }
  } &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;FSPaths&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the first part the updaters, outPaths and finalPaths arrays are copied if the writerOffset is not smaller than their length. So these array are extended. But in the second part when the outPathsCommitted array is copied, the size of the array is not compared with the writerOffset. So it can happen that the outPathsCommitted array is reduced. If this situation happens it leads to the ArrayIndexOutOfBoundsException when closing the writes, because the outPathsCommitted array is shorter than the updaters array.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;About the reproduction:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The first insert into the full_acid table creates files with buckets 1, 2, 3, 5, 6&lt;br/&gt;
The second insert creates the files with buckets 1, 4, 6&lt;/p&gt;

&lt;p&gt;The bucket number for 6 is 537264128, for 4 is 537133056, so for 4 it is smaller than for 6.&lt;br/&gt;
To reproduce the issue, we need to delete a row from bucket 6 and bucket 4 together and make it so, that both rows are processed by the same FileSinkOperator. It will process the row from bucket 6 first, so makes the arraycopy in dynamicBucketing with the writerOffset 6. Then comes the row for 4 and in the dynamicBucketing it will do the second arrayCopy wrongly. So the finalPath array will be size 7, but the outPathsCommitted will be arrayCopied to size 4+1. This will cause the exception when closing the writers.&lt;br/&gt;
By setting the reducer number to 1 before the delete, both rows are processed by the same FileSinkOperator.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13609933">HIVE-28790</key>
            <summary>ACID deletes are failing with ArrayIndexOutOfBoundsException when direct insert is enabled </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kokila19">Kokila N</assignee>
                                    <reporter username="kuczoram">Marta Kuczora</reporter>
                        <labels>
                            <label>hive-4.1.0-must</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 26 Feb 2025 21:05:55 +0000</created>
                <updated>Tue, 29 Jul 2025 14:51:47 +0000</updated>
                            <resolved>Thu, 3 Jul 2025 18:34:59 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                    <fixVersion>4.2.0</fixVersion>
                                    <component>Transactions</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17988045" author="dkuzmenko" created="Thu, 3 Jul 2025 04:34:26 +0000"  >&lt;p&gt;Merged to master.&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kuczoram&quot; class=&quot;user-hover&quot; rel=&quot;kuczoram&quot;&gt;kuczoram&lt;/a&gt; for the comprehensive issue description and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kokila19&quot; class=&quot;user-hover&quot; rel=&quot;kokila19&quot;&gt;kokila19&lt;/a&gt; for the fix.&lt;/p&gt;

&lt;p&gt;Please cherry-pick the fix into branch-4.1&lt;/p&gt;</comment>
                            <comment id="17993064" author="JIRAUSER298458" created="Thu, 3 Jul 2025 11:54:25 +0000"  >&lt;p&gt;Cherry-picked to branch-4.1&#160;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/hive/pull/5922&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/pull/5922&lt;/a&gt; -&amp;gt; waiting for tests to complete successfully.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13303586">HIVE-23410</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ugmo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>