<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:31:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-9839] HiveServer2 leaks OperationHandle on async queries which fail at compile phase</title>
                <link>https://issues.apache.org/jira/browse/HIVE-9839</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Using beeline to connect to HiveServer2.And type the following:&lt;br/&gt;
drop table if exists table_not_exists;&lt;br/&gt;
select * from table_not_exists;&lt;/p&gt;

&lt;p&gt;There will be an OperationHandle object staying in HiveServer2&apos;s memory for ever even after quit from beeline .&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12779033">HIVE-9839</key>
            <summary>HiveServer2 leaks OperationHandle on async queries which fail at compile phase</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nemon">Nemon Lou</assignee>
                                    <reporter username="nemon">Nemon Lou</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Mar 2015 12:03:11 +0000</created>
                <updated>Mon, 18 May 2015 19:56:06 +0000</updated>
                            <resolved>Thu, 26 Mar 2015 16:39:18 +0000</resolved>
                                    <version>0.13.1</version>
                    <version>0.14.0</version>
                    <version>1.0.0</version>
                    <version>1.1.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                                    <component>HiveServer2</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="14344992" author="nemon" created="Tue, 3 Mar 2015 12:15:25 +0000"  >&lt;p&gt;The piece of code in org.apache.hive.service.cli.session.HiveSessionImpl.java that causing this issue:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; OperationHandle executeStatementInternal(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; statement, Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; confOverlay,
370	      &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; runAsync)
371	          &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; HiveSQLException {
372	    acquire(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
373	
374	    OperationManager operationManager = getOperationManager();
375	    ExecuteStatementOperation operation = operationManager
376	        .newExecuteStatementOperation(getSession(), statement, confOverlay, runAsync);
377	    OperationHandle opHandle = operation.getHandle();
378	    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
379	      operation.run();
380	      opHandleSet.add(opHandle);
381	      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; opHandle;
382	    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (HiveSQLException e) {
383	      &lt;span class=&quot;code-comment&quot;&gt;// Cleanup opHandle in &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; the query is synchronous
&lt;/span&gt;384	      &lt;span class=&quot;code-comment&quot;&gt;// Async query needs to retain and pass back the opHandle &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; error reporting
&lt;/span&gt;385	      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!runAsync) {
386	        operationManager.closeOperation(opHandle);
387	      }
388	      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
389	    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
390	      release(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
391	    }
392	  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When a HiveSQLException throw from line 379,the opHandle is not closed due to async mode and is not been put into opHandleSet for future clean up.&lt;br/&gt;
Async query is the default query mode in hiveserver2 clients.&lt;/p&gt;</comment>
                            <comment id="14345001" author="nemon" created="Tue, 3 Mar 2015 12:20:37 +0000"  >&lt;p&gt;The simple way to fix this issue is just removing line 385 and line 387.That means ,always clean up OperationHandle when HiveSQlException occurs duing query.&lt;/p&gt;</comment>
                            <comment id="14345660" author="vgumashta" created="Tue, 3 Mar 2015 20:16:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nemon&quot; class=&quot;user-hover&quot; rel=&quot;nemon&quot;&gt;nemon&lt;/a&gt; On a quick pass, this won&apos;t be an acceptable solution, as for async queries, HiveSessionImpl#executeStatementInternal will return immediately but the opHandle is required for later error reporting/operation status check. Let me go over the code a bit more though to add more comments. &lt;/p&gt;</comment>
                            <comment id="14345666" author="vgumashta" created="Tue, 3 Mar 2015 20:21:38 +0000"  >&lt;p&gt;One possible solution was implemented here: &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-5799&quot; title=&quot;session/operation timeout for hiveserver2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-5799&quot;&gt;&lt;del&gt;HIVE-5799&lt;/del&gt;&lt;/a&gt;, which periodically cleans up expired/timed-out operation handles.&lt;/p&gt;</comment>
                            <comment id="14345682" author="vgumashta" created="Tue, 3 Mar 2015 20:30:01 +0000"  >&lt;p&gt;I&apos;ve created &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-9842&quot; title=&quot;Enable session/operation timeout by default in HiveServer2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-9842&quot;&gt;&lt;del&gt;HIVE-9842&lt;/del&gt;&lt;/a&gt; to enable session/op timeout by default. Shall upload a patch shortly.&lt;/p&gt;</comment>
                            <comment id="14346230" author="nemon" created="Wed, 4 Mar 2015 02:03:33 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vgumashta&quot; class=&quot;user-hover&quot; rel=&quot;vgumashta&quot;&gt;vgumashta&lt;/a&gt; for your comments.&lt;br/&gt;
Correct me if i am wrong:&lt;br/&gt;
For failed async queries,opHandle never pass back to client side for now.Only HiveSQLException&apos;s message is passed back.So client side can not use opHandle  for later error reporting/operation status check.&lt;br/&gt;
 &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-5799&quot; title=&quot;session/operation timeout for hiveserver2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-5799&quot;&gt;&lt;del&gt;HIVE-5799&lt;/del&gt;&lt;/a&gt; is a possible solution,when opHandle expired/timed-out internal is carefully configured .If the creation of orphan opHandles is much faster than opHandle expired internal,we still need a complete fix (or fix the failed queries in time).&lt;br/&gt;
Anyway,it&apos;s will be good to fix this issue directly.Though the way to fix it is not clear for me now.&lt;/p&gt;</comment>
                            <comment id="14349331" author="jxiang" created="Thu, 5 Mar 2015 19:31:33 +0000"  >&lt;p&gt;I attached a patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-9601&quot; title=&quot;New Beeline queries will hang If Beeline terminates in-properly [Spark Branch]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-9601&quot;&gt;&lt;del&gt;HIVE-9601&lt;/del&gt;&lt;/a&gt; which should be able to handle such orphan sessions. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nemon&quot; class=&quot;user-hover&quot; rel=&quot;nemon&quot;&gt;nemon&lt;/a&gt;, can you give it a try?&lt;/p&gt;</comment>
                            <comment id="14349885" author="nemon" created="Fri, 6 Mar 2015 03:24:50 +0000"  >&lt;p&gt;For failed async queries,opHandle never pass back to client side for now.&lt;br/&gt;
--Here i mean only for failed async queries which fail at compile phase.&lt;/p&gt;</comment>
                            <comment id="14349886" author="nemon" created="Fri, 6 Mar 2015 03:24:53 +0000"  >&lt;p&gt;For failed async queries,opHandle never pass back to client side for now.&lt;br/&gt;
--Here i mean only for failed async queries which fail at compile phase.&lt;/p&gt;</comment>
                            <comment id="14349887" author="nemon" created="Fri, 6 Mar 2015 03:24:56 +0000"  >&lt;p&gt;For failed async queries,opHandle never pass back to client side for now.&lt;br/&gt;
--Here i mean only for failed async queries which fail at compile phase.&lt;/p&gt;</comment>
                            <comment id="14349888" author="nemon" created="Fri, 6 Mar 2015 03:24:58 +0000"  >&lt;p&gt;For failed async queries,opHandle never pass back to client side for now.&lt;br/&gt;
--Here i mean only for failed async queries which fail at compile phase.&lt;/p&gt;</comment>
                            <comment id="14349889" author="nemon" created="Fri, 6 Mar 2015 03:24:59 +0000"  >&lt;p&gt;For failed async queries,opHandle never pass back to client side for now.&lt;br/&gt;
--Here i mean only for failed async queries which fail at compile phase.&lt;/p&gt;</comment>
                            <comment id="14349890" author="nemon" created="Fri, 6 Mar 2015 03:24:59 +0000"  >&lt;p&gt;For failed async queries,opHandle never pass back to client side for now.&lt;br/&gt;
--Here i mean only for failed async queries which fail at compile phase.&lt;/p&gt;</comment>
                            <comment id="14349891" author="nemon" created="Fri, 6 Mar 2015 03:24:59 +0000"  >&lt;p&gt;For failed async queries,opHandle never pass back to client side for now.&lt;br/&gt;
--Here i mean only for failed async queries which fail at compile phase.&lt;/p&gt;</comment>
                            <comment id="14349892" author="nemon" created="Fri, 6 Mar 2015 03:25:02 +0000"  >&lt;p&gt;For failed async queries,opHandle never pass back to client side for now.&lt;br/&gt;
--Here i mean only for failed async queries which fail at compile phase.&lt;/p&gt;</comment>
                            <comment id="14349927" author="nemon" created="Fri, 6 Mar 2015 04:09:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;jxiang&lt;/a&gt; Thanks for the information.I think they are different scenarios.In &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-9839&quot; title=&quot;HiveServer2 leaks OperationHandle on async queries which fail at compile phase&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-9839&quot;&gt;&lt;del&gt;HIVE-9839&lt;/del&gt;&lt;/a&gt;,OperationHandle is never been closed even after session is closed.&lt;/p&gt;</comment>
                            <comment id="14350548" author="jxiang" created="Fri, 6 Mar 2015 16:30:50 +0000"  >&lt;p&gt;I see. That means &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-9842&quot; title=&quot;Enable session/operation timeout by default in HiveServer2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-9842&quot;&gt;&lt;del&gt;HIVE-9842&lt;/del&gt;&lt;/a&gt; can not fix the leakage either since the opHandler is not put in the set at all in this case. I agree it should fix the problem by removing line 385 and 387. We can also just switch line 379 and 380.&lt;/p&gt;</comment>
                            <comment id="14357962" author="nemon" created="Thu, 12 Mar 2015 01:53:21 +0000"  >&lt;p&gt;Uploading a Btrace script which can catch this leak .&lt;/p&gt;</comment>
                            <comment id="14369472" author="ychena" created="Thu, 19 Mar 2015 15:07:12 +0000"  >&lt;p&gt;Hi, any progress in this issue? Thanks.&lt;br/&gt;
If OperationHandle has to be returned to report the error in Async mode, maybe we can do following, then client can close it; If not, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;jxiang&lt;/a&gt;&apos;s patch should be fine.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; OperationHandle executeStatementInternal(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; statement, Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; confOverlay,
      &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; runAsync)
          &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; HiveSQLException {
    acquire(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);

    OperationManager operationManager = getOperationManager();
    ExecuteStatementOperation operation = operationManager
        .newExecuteStatementOperation(getSession(), statement, confOverlay, runAsync);
    OperationHandle opHandle = operation.getHandle();
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      operation.run();
      opHandleSet.add(opHandle);
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; opHandle;
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (HiveSQLException e) {
      &lt;span class=&quot;code-comment&quot;&gt;// Cleanup opHandle in &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; the query is synchronous
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// Async query needs to retain and pass back the opHandle &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; error reporting
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!runAsync) {
        operationManager.closeOperation(opHandle);
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
      }
      &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        opHandleSet.add(opHandle);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; opHandle;
      }
      
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
      release(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14374764" author="nemon" created="Sun, 22 Mar 2015 03:03:29 +0000"  >&lt;p&gt;Refering to SQLOperation.java,there is no chance that a HiveSQLException throws and the asyn background operation submits to thread pool successfully at the same time.Only line 181 and line 244 can causing  HiveSQLException.&lt;br/&gt;
So the answer to &quot;If OperationHandle has to be returned to report the error in Async mode&quot; is no.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; @Override
178	  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void runInternal() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; HiveSQLException {
179	    setState(OperationState.PENDING);
180	    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; HiveConf opConfig = getConfigForOperation();
181	    prepare(opConfig);
182	    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!shouldRunAsync()) {
183	      runQuery(opConfig);
184	    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
185	      &lt;span class=&quot;code-comment&quot;&gt;// We&apos;ll pass ThreadLocals in the background thread from the foreground (handler) thread
&lt;/span&gt;186	      &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SessionState parentSessionState = SessionState.get();
187	      &lt;span class=&quot;code-comment&quot;&gt;// ThreadLocal Hive object needs to be set in background thread.
&lt;/span&gt;188	      &lt;span class=&quot;code-comment&quot;&gt;// The metastore client in Hive is associated with right user.
&lt;/span&gt;189	      &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Hive parentHive = getSessionHive();
190	      &lt;span class=&quot;code-comment&quot;&gt;// Current UGI will get used by metastore when metsatore is in embedded mode
&lt;/span&gt;191	      &lt;span class=&quot;code-comment&quot;&gt;// So &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; needs to get passed to the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; background thread
&lt;/span&gt;192	      &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; UserGroupInformation currentUGI = getCurrentUGI(opConfig);
193	      &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; impl to call runInternal asynchronously,
&lt;/span&gt;194	      &lt;span class=&quot;code-comment&quot;&gt;// from a different thread
&lt;/span&gt;195	      &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; backgroundOperation = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;() {
196	        @Override
197	        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
198	          PrivilegedExceptionAction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; doAsAction = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PrivilegedExceptionAction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt;() {
199	            @Override
200	            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; run() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; HiveSQLException {
201	              Hive.set(parentHive);
202	              SessionState.setCurrentSessionState(parentSessionState);
203	              &lt;span class=&quot;code-comment&quot;&gt;// Set current OperationLog in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; async thread &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; keeping on saving query log.
&lt;/span&gt;204	              registerCurrentOperationLog();
205	              &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
206	                runQuery(opConfig);
207	              } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (HiveSQLException e) {
208	                setOperationException(e);
209	                LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error running hive query: &quot;&lt;/span&gt;, e);
210	              } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
211	                unregisterOperationLog();
212	              }
213	              &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
214	            }
215	          };
216	
217	          &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
218	            currentUGI.doAs(doAsAction);
219	          } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
220	            setOperationException(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HiveSQLException(e));
221	            LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error running hive query as user : &quot;&lt;/span&gt; + currentUGI.getShortUserName(), e);
222	          }
223	          &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
224	            /**
225	             * We&apos;ll cache the ThreadLocal RawStore object &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; background thread &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; an orderly cleanup
226	             * when &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; thread is garbage collected later.
227	             * @see org.apache.hive.service.server.ThreadWithGarbageCleanup#finalize()
228	             */
229	            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ThreadWithGarbageCleanup.currentThread() &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ThreadWithGarbageCleanup) {
230	              ThreadWithGarbageCleanup currentThread =
231	                  (ThreadWithGarbageCleanup) ThreadWithGarbageCleanup.currentThread();
232	              currentThread.cacheThreadLocalRawStore();
233	            }
234	          }
235	        }
236	      };
237	      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
238	        &lt;span class=&quot;code-comment&quot;&gt;// This submit blocks &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; no background threads are available to run &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; operation
&lt;/span&gt;239	        Future&amp;lt;?&amp;gt; backgroundHandle =
240	            getParentSession().getSessionManager().submitBackgroundOperation(backgroundOperation);
241	        setBackgroundHandle(backgroundHandle);
242	      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (RejectedExecutionException rejected) {
243	        setState(OperationState.ERROR);
244	        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HiveSQLException(&lt;span class=&quot;code-quote&quot;&gt;&quot;The background threadpool cannot accept&quot;&lt;/span&gt; +
245	            &lt;span class=&quot;code-quote&quot;&gt;&quot; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; task &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; execution, please retry the operation&quot;&lt;/span&gt;, rejected);
246	      }
247	    }
248	  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="14376000" author="ychena" created="Mon, 23 Mar 2015 14:56:14 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nemon&quot; class=&quot;user-hover&quot; rel=&quot;nemon&quot;&gt;nemon&lt;/a&gt;. So, should &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jxiang&quot; class=&quot;user-hover&quot; rel=&quot;jxiang&quot;&gt;jxiang&lt;/a&gt; submit his patch and resolve the issue after review?&lt;/p&gt;</comment>
                            <comment id="14376078" author="jxiang" created="Mon, 23 Mar 2015 15:46:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ychena&quot; class=&quot;user-hover&quot; rel=&quot;ychena&quot;&gt;ychena&lt;/a&gt;, to clarify, I submitted a patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-9601&quot; title=&quot;New Beeline queries will hang If Beeline terminates in-properly [Spark Branch]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-9601&quot;&gt;&lt;del&gt;HIVE-9601&lt;/del&gt;&lt;/a&gt;, not for this one. As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nemon&quot; class=&quot;user-hover&quot; rel=&quot;nemon&quot;&gt;nemon&lt;/a&gt; pointed out, this is a different issue (from &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-9601&quot; title=&quot;New Beeline queries will hang If Beeline terminates in-properly [Spark Branch]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-9601&quot;&gt;&lt;del&gt;HIVE-9601&lt;/del&gt;&lt;/a&gt;). I agree with Nemon and like his patch (for this issue).&lt;/p&gt;</comment>
                            <comment id="14376797" author="ychena" created="Mon, 23 Mar 2015 22:34:44 +0000"  >&lt;p&gt;Sorry &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nemon&quot; class=&quot;user-hover&quot; rel=&quot;nemon&quot;&gt;nemon&lt;/a&gt;, I thought Jimmy added the patch. So could you submit the patch and solve the issue? Thanks&lt;/p&gt;</comment>
                            <comment id="14377424" author="nemon" created="Tue, 24 Mar 2015 07:19:04 +0000"  >&lt;p&gt;Adding an test case.&lt;/p&gt;</comment>
                            <comment id="14377678" author="hiveqa" created="Tue, 24 Mar 2015 11:01:12 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12706848/HIVE-9839.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12706848/HIVE-9839.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 7825 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/3130/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/3130/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/3130/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/3130/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-3130/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-3130/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12706848 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14377744" author="nemon" created="Tue, 24 Mar 2015 11:52:54 +0000"  >&lt;p&gt;This patch is ready for review.Thanks&lt;/p&gt;</comment>
                            <comment id="14378764" author="jxiang" created="Tue, 24 Mar 2015 22:09:59 +0000"  >&lt;p&gt;The patch looks good to me. However, the test is confusing. Perhaps it is because the static importing of those Mockito functions. Could you fix that? The test doesn&apos;t need to extend TestCase any more, right?&lt;/p&gt;</comment>
                            <comment id="14379188" author="nemon" created="Wed, 25 Mar 2015 02:42:26 +0000"  >&lt;p&gt;Updating the patch addressing Jimmy&apos;s comments.&lt;br/&gt;
The test case is mainly verifying that OperationManager.closeOperation(opHandle) is invoked when&lt;br/&gt;
getting a HiveSQLException during sync query.&lt;/p&gt;</comment>
                            <comment id="14379241" author="jxiang" created="Wed, 25 Mar 2015 03:47:46 +0000"  >&lt;p&gt;I was wondering if we can use Mockito.mock instead of using static import. The same for other Mockito methods. Another thing, instead of introducing a new class HiveSessionImplForTest, should we use an anonymous inner class in creating? Thanks.&lt;/p&gt;</comment>
                            <comment id="14379296" author="nemon" created="Wed, 25 Mar 2015 04:59:18 +0000"  >&lt;p&gt;Updating again.Thanks for your advice.&lt;/p&gt;</comment>
                            <comment id="14379998" author="jxiang" created="Wed, 25 Mar 2015 14:56:23 +0000"  >&lt;p&gt;Thanks for making the change. +1 pending on test.&lt;/p&gt;</comment>
                            <comment id="14380428" author="hiveqa" created="Wed, 25 Mar 2015 18:27:34 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12707139/HIVE-9839.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12707139/HIVE-9839.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 1 failed/errored test(s), 8338 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestMinimrCliDriver.testCliDriver_schemeAuthority
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/3150/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/3150/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/3150/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/3150/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-3150/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-3150/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 1 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12707139 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14381329" author="nemon" created="Thu, 26 Mar 2015 04:15:06 +0000"  >&lt;p&gt;Seems that the failure is unrelated.&lt;br/&gt;
Running this on my local computer doesn&apos;t fail:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&quot;mvn test -Phadoop-2 -Dtest=TestCliDriver -Dqfile=schemeAuthority.q&quot; &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The result:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Running org.apache.hadoop.hive.cli.TestCliDriver&lt;br/&gt;
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 66.08 sec - in org.apache.hadoop.hive.cli.TestCliDriver&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Submit again.&lt;/p&gt;</comment>
                            <comment id="14382175" author="csun" created="Thu, 26 Mar 2015 16:39:18 +0000"  >&lt;p&gt;Committed to trunk. Thanks Nemon for working on this, and Jimmy for reviewing!&lt;/p&gt;</comment>
                            <comment id="14549054" author="sushanth" created="Mon, 18 May 2015 19:56:06 +0000"  >&lt;p&gt;This issue has been fixed and released as part of the 1.2.0 release. If you find an issue which seems to be related to this one, please create a new jira and link this one with new jira.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12773100">HIVE-9601</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12779170">HIVE-9842</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12678732">HIVE-5799</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12712658">HIVE-7021</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12707139" name="HIVE-9839.patch" size="5598" author="nemon" created="Wed, 25 Mar 2015 04:59:18 +0000"/>
                            <attachment id="12707119" name="HIVE-9839.patch" size="7146" author="nemon" created="Wed, 25 Mar 2015 02:42:26 +0000"/>
                            <attachment id="12706848" name="HIVE-9839.patch" size="6834" author="nemon" created="Tue, 24 Mar 2015 07:19:04 +0000"/>
                            <attachment id="12706492" name="HIVE-9839.patch" size="1139" author="nemon" created="Mon, 23 Mar 2015 09:34:21 +0000"/>
                            <attachment id="12704072" name="OperationHandleMonitor.java" size="953" author="nemon" created="Thu, 12 Mar 2015 01:53:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 27 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i26acf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>