<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:20:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-7225] Unclosed Statement&apos;s in TxnHandler</title>
                <link>https://issues.apache.org/jira/browse/HIVE-7225</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;There&apos;re several methods in TxnHandler where Statement (local to the method) is not closed upon return.&lt;br/&gt;
Here&apos;re a few examples:&lt;br/&gt;
In compact():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        stmt.executeUpdate(s);
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Going to commit&quot;&lt;/span&gt;);
        dbConn.commit();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In showCompact():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      Statement stmt = dbConn.createStatement();
      &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s = &lt;span class=&quot;code-quote&quot;&gt;&quot;select cq_database, cq_table, cq_partition, cq_state, cq_type, cq_worker_id, &quot;&lt;/span&gt; +
          &lt;span class=&quot;code-quote&quot;&gt;&quot;cq_start, cq_run_as from COMPACTION_QUEUE&quot;&lt;/span&gt;;
      LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Going to execute query &amp;lt;&quot;&lt;/span&gt; + s + &lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;gt;&quot;&lt;/span&gt;);
      ResultSet rs = stmt.executeQuery(s);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12720915">HIVE-7225</key>
            <summary>Unclosed Statement&apos;s in TxnHandler</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="skoh5">steve, Oh</assignee>
                                    <reporter username="yuzhihong@gmail.com">Ted Yu</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Jun 2014 17:32:39 +0000</created>
                <updated>Thu, 13 Nov 2014 19:41:09 +0000</updated>
                            <resolved>Tue, 24 Jun 2014 20:18:26 +0000</resolved>
                                                    <fixVersion>0.14.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14034027" author="alangates" created="Tue, 17 Jun 2014 16:49:02 +0000"  >&lt;p&gt;Steve, thanks for the patch.  A few comments:&lt;br/&gt;
I don&apos;t think there&apos;s a need to explicitly close the ResultSet.  According to the JavaDocs on Statement.close(), it closes any associated ResultSets.  So making this call seems like a waste of time.&lt;br/&gt;
If we&apos;re going to do this, it should be done in CompactionTxnHanlder as well, since that subclasses this class and uses all of the same methods.&lt;br/&gt;
But that if leads to my last comment.  Is this necessary at all?  All of the public methods close the db connection as soon as they are done.  Is there any value to closing the individual statements in that collection first?&lt;/p&gt;</comment>
                            <comment id="14034148" author="yuzhihong@gmail.com" created="Tue, 17 Jun 2014 18:07:59 +0000"  >&lt;p&gt;Does this answer your question ?&lt;br/&gt;
&lt;a href=&quot;http://stackoverflow.com/questions/2708689/impact-of-java-sql-connection-close-on-java-sql-statement-objects-and-the-like&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/2708689/impact-of-java-sql-connection-close-on-java-sql-statement-objects-and-the-like&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14034192" author="alangates" created="Tue, 17 Jun 2014 18:38:53 +0000"  >&lt;p&gt;No.  We aren&apos;t leaving these connections open for a long time.  We&apos;re closing them quite quickly at the end of each Thrift RPC.  If we were leaving them open for a long time then I would agree that it was important to close the statements.&lt;/p&gt;</comment>
                            <comment id="14034400" author="yuzhihong@gmail.com" created="Tue, 17 Jun 2014 21:29:39 +0000"  >&lt;p&gt;Hive depends on BoneCP 0.8.0&lt;/p&gt;

&lt;p&gt;I cloned BoneCP locally and looked at their code.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ConnectionHandle &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Connection,Serializable{
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In ConnectionHandle ctor, I see:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.detectUnclosedStatements = pool.getConfig().isDetectUnclosedStatements();
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.closeOpenStatements = pool.getConfig().isCloseOpenStatements();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In close() method:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.closeOpenStatements){
          &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Entry&amp;lt;Statement, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; statementEntry: &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.trackedStatement.entrySet()){
            statementEntry.getKey().close();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.detectUnclosedStatements){
              logger.warn(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(UNCLOSED_LOG_ERROR_MESSAGE, statementEntry.getValue()));
            }
          }
          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.trackedStatement.clear();
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In Hive codebase, I don&apos;t see call that turns on closeOpenStatements.&lt;/p&gt;</comment>
                            <comment id="14036377" author="alangates" created="Wed, 18 Jun 2014 21:02:45 +0000"  >&lt;p&gt;Interesting, since part of the contract of Connection.close is &quot;Releases this Connection object&apos;s database and JDBC resources immediately instead of waiting for them to be automatically released.&quot; it&apos;s disappointing to see that connection pooling technologies may not be doing this.  Any info on whether the default is to close the open statements or leave them open?  We could add a call to configure the pool to make sure we close the open statements.  &lt;/p&gt;

&lt;p&gt;Separately, in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-7246&quot; title=&quot;Hive transaction manager hardwires bonecp as the JDBC pooling implementation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-7246&quot;&gt;&lt;del&gt;HIVE-7246&lt;/del&gt;&lt;/a&gt; I&apos;m working to make the connection pooling configurable, so rather than make sure we handle this for each pool type it makes more sense to do as you suggest and make sure we close the statements.  So I remove my question on whether this makes sense to do.  &lt;/p&gt;</comment>
                            <comment id="14036388" author="yuzhihong@gmail.com" created="Wed, 18 Jun 2014 21:08:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;whether the default is to close the open statements&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;As far as I can tell from the source code, default value for closeOpenStatements is false. This is understandable: tracking open statements would consume more resources. For well designed / implemented client, this shouldn&apos;t be necessary.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;make sure we close the statements&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Do you have time to take a look at Steve&apos;s patch ?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="14036405" author="alangates" created="Wed, 18 Jun 2014 21:17:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;Do you have time to take a look at Steve&apos;s patch ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I did.  My other two comments still stand.  There&apos;s no reason to spend time closing ResultSets as the Statement close will do that.  And this should be done in CompactionTxnHandler as well as TxnHandler.&lt;/p&gt;</comment>
                            <comment id="14039668" author="yuzhihong@gmail.com" created="Sat, 21 Jun 2014 03:20:41 +0000"  >&lt;p&gt;Patch v3 addresses Alan&apos;s comments above.&lt;/p&gt;</comment>
                            <comment id="14040041" author="hiveqa" created="Sun, 22 Jun 2014 06:38:10 +0000"  >

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Overall&lt;/font&gt;: -1 at least one tests failed&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12651800/hive-7225.3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12651800/hive-7225.3.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 5 failed/errored test(s), 5668 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_dynpart_sort_optimization
org.apache.hadoop.hive.cli.TestMinimrCliDriver.testCliDriver_root_dir_external_table
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_ctas
org.apache.hive.hcatalog.pig.TestOrcHCatLoader.testReadDataPrimitiveTypes
org.apache.hive.jdbc.miniHS2.TestHiveServer2.testConnection
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-Build/548/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-Build/548/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-Build/548/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-Build/548/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-Build-548/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-Build-548/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12651800&lt;/p&gt;</comment>
                            <comment id="14041306" author="alangates" created="Mon, 23 Jun 2014 21:01:50 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14042617" author="alangates" created="Tue, 24 Jun 2014 20:18:26 +0000"  >&lt;p&gt;Patch 3 checked in.  Thank you Ted and Steve for your combined efforts.&lt;/p&gt;</comment>
                            <comment id="14210498" author="thejas" created="Thu, 13 Nov 2014 19:41:09 +0000"  >&lt;p&gt;This has been fixed in 0.14 release. Please open new jira if you see any issues.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12650815" name="HIVE-7225.1.patch" size="36664" author="skoh5" created="Tue, 17 Jun 2014 15:08:31 +0000"/>
                            <attachment id="12651800" name="hive-7225.3.patch" size="37334" author="yuzhihong@gmail.com" created="Sat, 21 Jun 2014 03:20:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>399114</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1wpjz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>399231</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>