<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:13:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-5817] column name to index mapping in VectorizationContext is broken</title>
                <link>https://issues.apache.org/jira/browse/HIVE-5817</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Columns coming from different operators may have the same internal names (&quot;_colNN&quot;). There exists a query in the form &lt;tt&gt;select b.cb, a.ca from a JOIN b ON ... JOIN x ON ...;&lt;/tt&gt;  (distilled from a more complex query), which runs ok w/o vectorization. With vectorization, it will run ok for most ca, but for some ca it will fail (or can probably return incorrect results). That is because when building column-to-VRG-index map in VectorizationContext, internal column name for ca that the first map join operator adds to the mapping may be the same as internal name for cb that the 2nd one tries to add. 2nd VMJ doesn&apos;t add it (see code in ctor), and when it&apos;s time for it to output stuff, it retrieves wrong index from the map by name, and then wrong vector from VRG.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12679126">HIVE-5817</key>
            <summary>column name to index mapping in VectorizationContext is broken</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rusanu">Remus Rusanu</assignee>
                                    <reporter username="sershe">Sergey Shelukhin</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Nov 2013 23:01:45 +0000</created>
                <updated>Mon, 24 Mar 2014 17:54:44 +0000</updated>
                            <resolved>Wed, 27 Nov 2013 16:50:38 +0000</resolved>
                                    <version>0.13.0</version>
                                    <fixVersion>0.13.0</fixVersion>
                                    <component>Vectorization</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13823192" author="sershe" created="Fri, 15 Nov 2013 01:34:48 +0000"  >&lt;p&gt;tried to make all columns unique within a query, but too many things in Hive depend upon _colN names either explicitly by getting number back out of them, or implicitly (such as reducer code when generating OI for distincts). May upload patch somewhere, let me try to maintain lineage in vectorization instead.&lt;/p&gt;</comment>
                            <comment id="13823270" author="sershe" created="Fri, 15 Nov 2013 04:33:42 +0000"  >&lt;p&gt;I will be gone for a week shortly, so if someone decides to take over... I examined two options:&lt;br/&gt;
1) Making the assumption true (all column names unique).&lt;br/&gt;
2) Adding lineage information to column map.&lt;br/&gt;
I was previously unfamiliar with either part of the codebase so I may be missing some important part, feel free to comment or take over.&lt;/p&gt;

&lt;p&gt;For (1), I have a partial patch. Unfortunately, many places in hive explicitly or implicitly make assumptions about column names generated by semanticanalyzer or other operators. I&apos;ve fixed a few places, but those that remain were pretty tough to figure out, patch needs more work. Also, patch will be quite &quot;epic&quot; in its impact relative to the problem, so it&apos;s the less-preferred approach.&lt;br/&gt;
For (2), adding lineage is easy (output column names are indeed unique within one operator, operator ID can be used and it can be retrieved by tag during the operator, or maps could be scoped to each operator, so an operator would be initialized with &quot;input maps&quot; coming from &quot;output maps&quot; from its parents, and in turn generate the &quot;output map&quot;), but the problem is on retrieve side, because anyone retrieving the column would have to know the lineage of what he&apos;s retrieving (from which parent it&apos;s coming). &lt;br/&gt;
I&apos;ve started studying the code of operators to see what kind of assumptions can be made in all the places this map is accessed, esp. e.g. getVectorExpression recursive call thru getCustomUDFExpression, when expressions for UDF parameters are retrieved. It&apos;s not quite clear how to get lineage for these parameters and whether it&apos;s guaranteed to be from the same parent in any given processOp call. But this seems to be a promising approach.&lt;/p&gt;</comment>
                            <comment id="13824345" author="sershe" created="Sat, 16 Nov 2013 02:40:54 +0000"  >&lt;p&gt;Here are 2 patches. Unique cols is abandoned patch with solution 1. &lt;br/&gt;
the main one is for (2), I was able to compile queries properly but running fails. It&apos;s probably something related to passing of serialized stuff thru scratch map, but I cannot get MR logging to work in tests so it&apos;s hard to tell.&lt;/p&gt;

&lt;p&gt;If someone wants to take over either patch, feel free... I will get back to it the monday after next earliest.&lt;/p&gt;</comment>
                            <comment id="13824346" author="sershe" created="Sat, 16 Nov 2013 02:41:43 +0000"  >&lt;p&gt;General pattern - &quot;TODO#&quot; marks where I was going to fix something, double check something, or the debug logging (e,g, TODO# adding blah) that needs to be removed&lt;/p&gt;</comment>
                            <comment id="13828257" author="ehans" created="Wed, 20 Nov 2013 23:04:58 +0000"  >&lt;p&gt;Uploaded &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-5817&quot; title=&quot;column name to index mapping in VectorizationContext is broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-5817&quot;&gt;&lt;del&gt;HIVE-5817&lt;/del&gt;&lt;/a&gt;.00-broken.patch here to make it easier to review the differences:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/15740/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/15740/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13828397" author="ehans" created="Thu, 21 Nov 2013 02:04:30 +0000"  >&lt;p&gt;I was able to create a smaller repro as follows.&lt;/p&gt;

&lt;p&gt;First, create the table alltypesorc (this is a standard table that is in the Hive source code as test data).&lt;/p&gt;

&lt;p&gt;set hive.vectorized.execution.enabled = false;&lt;/p&gt;

&lt;p&gt;create table store(s_store_sk int, s_city string)&lt;br/&gt;
stored as orc;&lt;/p&gt;

&lt;p&gt;insert overwrite table store&lt;br/&gt;
select cint, cstring1&lt;br/&gt;
from alltypesorc&lt;br/&gt;
where cint not in (&lt;br/&gt;
-3728, -563, 762, 6981, 253665376, 528534767, 626923679);&lt;/p&gt;

&lt;p&gt;create table store_sales(ss_store_sk int, ss_hdemo_sk int, ss_net_profit double)&lt;br/&gt;
stored as orc;&lt;/p&gt;

&lt;p&gt;insert overwrite table store_sales&lt;br/&gt;
select cint, cint, cdouble&lt;br/&gt;
from alltypesorc&lt;br/&gt;
where cint not in (&lt;br/&gt;
-3728, -563, 762, 6981, 253665376, 528534767, 626923679);&lt;/p&gt;

&lt;p&gt;create table household_demographics(hd_demo_sk int)&lt;br/&gt;
stored as orc;&lt;/p&gt;

&lt;p&gt;insert overwrite table household_demographics&lt;br/&gt;
select cint &lt;br/&gt;
from alltypesorc&lt;br/&gt;
where cint not in (&lt;br/&gt;
-3728, -563, 762, 6981, 253665376, 528534767, 626923679);&lt;/p&gt;

&lt;p&gt;&amp;#8211; the NOT IN condition makes sure all the cint values are unique&lt;/p&gt;

&lt;p&gt;&amp;#8211; finally, run this:&lt;br/&gt;
set hive.vectorized.execution.enabled = true;&lt;/p&gt;

&lt;p&gt;select store.s_city, ss_net_profit&lt;br/&gt;
    from store_sales&lt;br/&gt;
     JOIN store ON store_sales.ss_store_sk = store.s_store_sk  &lt;br/&gt;
     JOIN household_demographics ON store_sales.ss_hdemo_sk = household_demographics.hd_demo_sk&lt;br/&gt;
    limit 100;&lt;/p&gt;

&lt;p&gt;Expected result: 100 rows of output are produced&lt;br/&gt;
Actual result:&lt;br/&gt;
...&lt;br/&gt;
2013-11-20 17:57:37,487 Stage-4 map = 0%,  reduce = 0%&lt;br/&gt;
2013-11-20 17:58:04,585 Stage-4 map = 100%,  reduce = 100%&lt;br/&gt;
Ended Job = job_201311191600_0022 with errors&lt;br/&gt;
Error during job, obtaining debugging information...&lt;br/&gt;
Job Tracking URL: &lt;a href=&quot;http://localhost:50030/jobdetails.jsp?jobid=job_201311191600_0022&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:50030/jobdetails.jsp?jobid=job_201311191600_0022&lt;/a&gt;&lt;br/&gt;
Examining task ID: task_201311191600_0022_m_000002 (and more) from job job_201311191600_0022&lt;/p&gt;

&lt;p&gt;Task with the most failures(4):&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;Task ID:&lt;br/&gt;
  task_201311191600_0022_m_000000&lt;/p&gt;

&lt;p&gt;URL:&lt;br/&gt;
  &lt;a href=&quot;http://localhost:50030/taskdetails.jsp?jobid=job_201311191600_0022&amp;amp;tipid=task_201311191600_0022_m_000000&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:50030/taskdetails.jsp?jobid=job_201311191600_0022&amp;amp;tipid=task_201311191600_0022_m_000000&lt;/a&gt;&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;Diagnostic Messages for this Task:&lt;br/&gt;
java.lang.RuntimeException: org.apache.hadoop.hive.ql.metadata.HiveException: Hive Runtime Error while processing row&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.mr.ExecMapper.map(ExecMapper.java:181)&lt;br/&gt;
        at org.apache.hadoop.mapred.MapRunner.run(MapRunner.java:50)&lt;br/&gt;
        at org.apache.hadoop.mapred.MapTask.runOldMapper(MapTask.java:430)&lt;br/&gt;
        at org.apache.hadoop.mapred.MapTask.run(MapTask.java:366)&lt;br/&gt;
        at org.apache.hadoop.mapred.Child$4.run(Child.java:266)&lt;br/&gt;
        at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
        at javax.security.auth.Subject.doAs(Subject.java:396)&lt;br/&gt;
        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1136)&lt;br/&gt;
        at org.apache.hadoop.mapred.Child.main(Child.java:260)&lt;br/&gt;
Caused by: org.apache.hadoop.hive.ql.metadata.HiveException: Hive Runtime Error while processing row&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.vector.VectorMapOperator.process(VectorMapOperator.java:45)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.mr.ExecMapper.map(ExecMapper.java:163)&lt;br/&gt;
        ... 8 more&lt;br/&gt;
Caused by: org.apache.hadoop.hive.ql.metadata.HiveException: Incompatible Long vector column and primitive category STRING&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.vector.VectorColumnAssignFactory.buildObjectAssign(VectorColumnAssignFactory.java:278)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.vector.VectorColumnAssignFactory.buildAssigners(VectorColumnAssignFactory.java:365)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.vector.VectorMapJoinOperator.internalForward(VectorMapJoinOperator.java:235)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.CommonJoinOperator.genAllOneUniqueJoinObject(CommonJoinOperator.java:675)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.CommonJoinOperator.checkAndGenObject(CommonJoinOperator.java:758)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.MapJoinOperator.processOp(MapJoinOperator.java:224)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.vector.VectorMapJoinOperator.processOp(VectorMapJoinOperator.java:293)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.Operator.process(Operator.java:489)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:827)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.vector.VectorMapJoinOperator.flushOutput(VectorMapJoinOperator.java:249)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.vector.VectorMapJoinOperator.internalForward(VectorMapJoinOperator.java:244)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.CommonJoinOperator.genAllOneUniqueJoinObject(CommonJoinOperator.java:675)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.CommonJoinOperator.checkAndGenObject(CommonJoinOperator.java:758)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.MapJoinOperator.processOp(MapJoinOperator.java:224)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.vector.VectorMapJoinOperator.processOp(VectorMapJoinOperator.java:293)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.Operator.process(Operator.java:489)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:827)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.TableScanOperator.processOp(TableScanOperator.java:91)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.Operator.process(Operator.java:489)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:827)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.exec.vector.VectorMapOperator.process(VectorMapOperator.java:43)&lt;br/&gt;
        ... 9 more&lt;/p&gt;


</comment>
                            <comment id="13829536" author="ehans" created="Fri, 22 Nov 2013 01:02:05 +0000"  >&lt;p&gt;I&apos;m looking at &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-5817&quot; title=&quot;column name to index mapping in VectorizationContext is broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-5817&quot;&gt;&lt;del&gt;HIVE-5817&lt;/del&gt;&lt;/a&gt;.00-broken.patch. It looks like a reasonable approach. It does complicate the function interfaces in VectorizationContext a bit because the soureId parameter is added to a lot of functions. The way I understand it, Remus suggested maybe having a different VectorizationContext for each operator (for which there would be a specific VectorizedRowBatch structure). Then the sourceId could perhaps be an instance variable of VectorizationContext and make the function interface simpler. Does anybody have an opinion on this?&lt;/p&gt;</comment>
                            <comment id="13830247" author="rusanu" created="Fri, 22 Nov 2013 19:22:29 +0000"  >&lt;p&gt;I think the only real problem operator is JOIN. Is not necessarily &#8216;one VC per operator&#8217; but more like &#8216;one VC per query region&#8217; where query region is defined by boundaries between different VS requirements (basically different result shapes). An operator like JOIN is one that clearly introduces a boundary, and the interesting part is that it needs two vectorization contexts: one for it&#8217;s input(s) and one for it&#8217;s output. So it would be more along the line that during vectorization each operator takes an VC (for its input, provided by its parent operator) and gives out a VC for its output, for its child operators to consume. Most operators would give out the same VC they get as input (ie. they do not change shape). And there is serialization too, which is handled separately (as properties added to the Map).&lt;/p&gt;

&lt;p&gt;I&apos;ll try to come up with actual code over this week end.&lt;/p&gt;</comment>
                            <comment id="13830430" author="ashutoshc" created="Fri, 22 Nov 2013 23:52:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ehans&quot; class=&quot;user-hover&quot; rel=&quot;ehans&quot;&gt;ehans&lt;/a&gt; I tried your query. With that I can repro this on a 1-node cluster, but when I use this query in .q file and run mvn test, test actually passes. Any idea why?&lt;/p&gt;</comment>
                            <comment id="13830459" author="ashutoshc" created="Sat, 23 Nov 2013 00:33:08 +0000"  >&lt;p&gt;Aah.. I missed one config which is required to repro in .q file {{ set hive.auto.convert.join=true; }} Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ehans&quot; class=&quot;user-hover&quot; rel=&quot;ehans&quot;&gt;ehans&lt;/a&gt; for test-case.&lt;/p&gt;</comment>
                            <comment id="13830465" author="ashutoshc" created="Sat, 23 Nov 2013 00:46:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rusanu&quot; class=&quot;user-hover&quot; rel=&quot;rusanu&quot;&gt;rusanu&lt;/a&gt; Another approach I am mulling over is to prepend table alias in the column name in that map. That way keys in that map will be unique across different tables, so that they won&apos;t collide. Change there is all the callers also need to prepend table alias than, but since all of them have ExprNodeDesc which has table alias, this should work out fine. What do you think ?&lt;/p&gt;</comment>
                            <comment id="13831541" author="rusanu" created="Mon, 25 Nov 2013 15:23:47 +0000"  >&lt;p&gt;I have  the implementation of &apos;vectorization regions&quot; almost done and I know how to finish it. Will post a patch tomorrow. &lt;/p&gt;

&lt;p&gt;Using the qualified column names (alias + column) will work probably, I don&apos;t think a query can have duplicate aliases (not up to par on my ANSI readings one can tell...). Thing is that will ripple everywhere in the vectorization context, we&apos;ll have to modify all the expression builders to use the alias.column as a key. If the &quot;region concept&quot; will work, will have a much more contained impact.&lt;/p&gt;</comment>
                            <comment id="13831645" author="ehans" created="Mon, 25 Nov 2013 17:24:10 +0000"  >&lt;p&gt;Great! Thanks for jumping in.&lt;/p&gt;</comment>
                            <comment id="13831772" author="sershe" created="Mon, 25 Nov 2013 18:58:49 +0000"  >&lt;p&gt;Currently other operators also change the column names. In fact there&apos;s new method that gets the source operator for lineage, note that the only place where it passes thru to parent is Filter - everyone except filter passes their own column names to child ops (which may or may not be necessary).&lt;/p&gt;</comment>
                            <comment id="13831953" author="rusanu" created="Mon, 25 Nov 2013 21:53:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/15849/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/15849/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13831960" author="prasanth_j" created="Mon, 25 Nov 2013 21:58:24 +0000"  >&lt;p&gt;I came across this exact same issue (column name collision) when I worked on &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-5369&quot; title=&quot;Annotate hive operator tree with statistics from metastore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-5369&quot;&gt;&lt;del&gt;HIVE-5369&lt;/del&gt;&lt;/a&gt;. As Ashutosh pointed out tabAlias.colName will work. This is what I am using for resolving column names from different parent operators. Reference code can be found in JoinStatsRule under StatsRulesProcFactory.java.&lt;br/&gt;
Another option is every operator will have output row schema which has list of ColumnInfo. ColumnInfo internally contains internal column name and table alias, when used as a key for hashmap should avoid column name collision. Hope this helps.&lt;/p&gt;</comment>
                            <comment id="13831966" author="ashutoshc" created="Mon, 25 Nov 2013 22:01:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rusanu&quot; class=&quot;user-hover&quot; rel=&quot;rusanu&quot;&gt;rusanu&lt;/a&gt; We should add test-case provided by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ehans&quot; class=&quot;user-hover&quot; rel=&quot;ehans&quot;&gt;ehans&lt;/a&gt; earlier in the comment thread as part of this patch.&lt;/p&gt;</comment>
                            <comment id="13831968" author="rusanu" created="Mon, 25 Nov 2013 22:03:52 +0000"  >&lt;p&gt;My patch .4 addresses the issue the following manner:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;vector operators can implement optional interface VectorizationContextRegion. If they do, they must provide a new vectorization context to be used by child operators. In my patch only VectorMapJoinOperator does so.&lt;/li&gt;
	&lt;li&gt;vectorizer walks up the stack of parent nodes to locate the first one (last one?) that created a vectorization context, and this is the vectorization context used to vectorize the current node. At the root of the stack there is a table scan that always creates a vectorization context.&lt;/li&gt;
	&lt;li&gt;I made the VectorMapJoinOperator build the output VectorizedRowBatch using the VectorizedRowBatchCtx class, same as ORC and RC scanners do. This is more consistent and removes the need for the VectorizedRowBatch.buildBatch method (was used only by VMJ)&lt;/li&gt;
	&lt;li&gt;add a simplified init to VectorizedRowBatchCtx  to be used by VMJ (or any other operator we decide).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I did not enable yet &apos;submit patch&apos; because more code can be removed  (the mapper scratch for vector type map) , code that was use donly by VMJ to enable it to build the output batch. Using VectorizedRowBatchCtx  makes all that code obsolete.&lt;/p&gt;

&lt;p&gt;I tested the repro query and passes fine, produces 100 rows (I assume they&apos;re the right ones...). I will do some more testing.&lt;/p&gt;</comment>
                            <comment id="13831972" author="rusanu" created="Mon, 25 Nov 2013 22:07:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt;: why I wanted to do it via &apos;vectorization regions&apos; is because I believe this concept is needed not only for name resolution. Currently, w/o &apos;regions&apos;, the same vectorization context is used for the entire query tree. this results in very wide (many columns) contexts, because there has to be a column in the context for every intermediate column. With Joins, this becomes quite wide.&lt;/p&gt;</comment>
                            <comment id="13831979" author="rusanu" created="Mon, 25 Nov 2013 22:16:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt;: not sure about other operators. Aren&apos;t they covered by the existing addOutputColumn mechanism?&lt;/p&gt;</comment>
                            <comment id="13832020" author="sershe" created="Mon, 25 Nov 2013 22:47:57 +0000"  >&lt;p&gt;About the other operators, what do you mean? In the explain of the original query I was looking at, vectorized select does this&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Select Operator
                  expressions:
                        expr: _col22
                        type: string
                        expr: _col53
                        type: float
                  outputColumnNames: _col0, _col1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In that case, _col22 from 2 preceding joins happened to collide, but cannot, for example, _col1 from the last join become _col0 of select? So the collision will happen when _col1 of select is added and there&apos;s already _col1 from the last join&lt;/p&gt;</comment>
                            <comment id="13832197" author="ashutoshc" created="Tue, 26 Nov 2013 02:10:27 +0000"  >&lt;p&gt;Did some testing and found testcase : vectorization_part_project.q is failing after applying this patch with following stack trace:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.RuntimeException: org.apache.hadoop.hive.ql.metadata.HiveException: Hive &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt; Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing row
        at org.apache.hadoop.hive.ql.exec.mr.ExecMapper.map(ExecMapper.java:181)
        at org.apache.hadoop.mapred.MapRunner.run(MapRunner.java:50)
        at org.apache.hadoop.mapred.MapTask.runOldMapper(MapTask.java:436)
        at org.apache.hadoop.mapred.MapTask.run(MapTask.java:372)
        at org.apache.hadoop.mapred.LocalJobRunner$Job.run(LocalJobRunner.java:212)
Caused by: org.apache.hadoop.hive.ql.metadata.HiveException: Hive &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt; Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing row
        at org.apache.hadoop.hive.ql.exec.vector.VectorMapOperator.process(VectorMapOperator.java:45)
        at org.apache.hadoop.hive.ql.exec.mr.ExecMapper.map(ExecMapper.java:163)
        ... 4 more
Caused by: org.apache.hadoop.hive.ql.metadata.HiveException: Error evaluating (cdouble + 2)
        at org.apache.hadoop.hive.ql.exec.vector.VectorSelectOperator.processOp(VectorSelectOperator.java:117)
        at org.apache.hadoop.hive.ql.exec.Operator.process(Operator.java:489)
        at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:827)
        at org.apache.hadoop.hive.ql.exec.TableScanOperator.processOp(TableScanOperator.java:91)
        at org.apache.hadoop.hive.ql.exec.Operator.process(Operator.java:489)
        at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:827)
        at org.apache.hadoop.hive.ql.exec.vector.VectorMapOperator.process(VectorMapOperator.java:43)
        ... 5 more
Caused by: java.lang.ArrayIndexOutOfBoundsException: 13
        at org.apache.hadoop.hive.ql.exec.vector.expressions.gen.DoubleColAddLongScalar.evaluate(DoubleColAddLongScalar.java:57)
        at org.apache.hadoop.hive.ql.exec.vector.VectorSelectOperator.processOp(VectorSelectOperator.java:115)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13832232" author="ashutoshc" created="Tue, 26 Nov 2013 02:47:53 +0000"  >&lt;p&gt;We should add following .q file in patch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;set hive.auto.convert.join=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
create table store(s_store_sk &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, s_city string)
stored as orc;
insert overwrite table store
select cint, cstring1
from alltypesorc
where cint not in (
-3728, -563, 762, 6981, 253665376, 528534767, 626923679);
create table store_sales(ss_store_sk &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, ss_hdemo_sk &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, ss_net_profit &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;)
stored as orc;
insert overwrite table store_sales
select cint, cint, cdouble
from alltypesorc
where cint not in (
-3728, -563, 762, 6981, 253665376, 528534767, 626923679);
create table household_demographics(hd_demo_sk &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
stored as orc;
insert overwrite table household_demographics
select cint
from alltypesorc
where cint not in (
-3728, -563, 762, 6981, 253665376, 528534767, 626923679);

set hive.vectorized.execution.enabled = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
select store.s_city, ss_net_profit
from store_sales
JOIN store ON store_sales.ss_store_sk = store.s_store_sk
JOIN household_demographics ON store_sales.ss_hdemo_sk = household_demographics.hd_demo_sk
;

set hive.auto.convert.join=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
set hive.vectorized.execution.enabled = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I tested the patch on above query and output returned are correct.&lt;/p&gt;</comment>
                            <comment id="13832558" author="rusanu" created="Tue, 26 Nov 2013 13:12:16 +0000"  >&lt;p&gt;This patch fixes the regression with vectorization_part_project.q &lt;br/&gt;
I added vectorized_context_regression_5817.q but I&apos;m unable to create an expected .out file because mvn test fails on my Windows enlistment:&lt;/p&gt;

&lt;p&gt;-------------------------------------------------------&lt;br/&gt;
 T E S T S&lt;br/&gt;
-------------------------------------------------------&lt;br/&gt;
Running org.apache.hadoop.hive.cli.TestCliDriver&lt;br/&gt;
Tests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 32.067 sec &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.hadoop.hive.cli.TestCliDriver&lt;br/&gt;
initializationError(org.apache.hadoop.hive.cli.TestCliDriver)  Time elapsed: 0.006 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!&lt;br/&gt;
java.lang.AssertionError: null&lt;br/&gt;
        at org.apache.hadoop.hive.ql.QTestUtil.getHdfsUriString(QTestUtil.java:288)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.QTestUtil.convertPathsFromWindowsToHdfs(QTestUtil.java:276)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.QTestUtil.initConf(QTestUtil.java:233)&lt;br/&gt;
        at org.apache.hadoop.hive.ql.QTestUtil.&amp;lt;init&amp;gt;(QTestUtil.java:317)&lt;br/&gt;
        at org.apache.hadoop.hive.cli.TestCliDriver.&amp;lt;clinit&amp;gt;(TestCliDriver.java:39)&lt;/p&gt;</comment>
                            <comment id="13832727" author="ashutoshc" created="Tue, 26 Nov 2013 16:19:26 +0000"  >&lt;p&gt;Same patch as .5 but also containing .q.out file for new test.&lt;/p&gt;</comment>
                            <comment id="13832728" author="ashutoshc" created="Tue, 26 Nov 2013 16:20:08 +0000"  >&lt;p&gt;Submitting patch for Hive QA to pick up&lt;/p&gt;</comment>
                            <comment id="13832735" author="ashutoshc" created="Tue, 26 Nov 2013 16:28:07 +0000"  >&lt;p&gt;+1 I tested Remus&apos;s latest patch both with .q files as well with junit tests. All tests passed.&lt;/p&gt;</comment>
                            <comment id="13832810" author="rusanu" created="Tue, 26 Nov 2013 18:00:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt; Let me think about that (the SELECT and other operators). My patch handles cases where the input batch is different from the output batch (eg. JOIN, GROUP BY) but is not good for SELECT operator because it forces copy from in batch to out batch. What I uploaded is still needed for JOIN, is much better than how JOIN used to handle this issue, but you have a point that the solution may not be complete.&lt;/p&gt;</comment>
                            <comment id="13832929" author="sershe" created="Tue, 26 Nov 2013 19:33:03 +0000"  >&lt;p&gt;Patch looks good to me for what it does, +1&lt;br/&gt;
Should it also handle GBY?&lt;br/&gt;
Do you want to file a separate JIRA for the select case? I can try to make repro next week&lt;/p&gt;</comment>
                            <comment id="13832972" author="rusanu" created="Tue, 26 Nov 2013 20:05:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt; VGBY is outputing rowmode output (since the next operator is always a reduce sink, and also there was no vector sink when we implemented VGBY). Had the VGBY output batch mode, it would need to do the same thing JOIN does (use a vectorization context, generate output batch etc).&lt;/p&gt;</comment>
                            <comment id="13833926" author="hiveqa" created="Wed, 27 Nov 2013 16:35:48 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12615853/HIVE-5817.6.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12615853/HIVE-5817.6.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 4660 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/457/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/457/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/457/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/457/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12615853&lt;/p&gt;</comment>
                            <comment id="13833941" author="ashutoshc" created="Wed, 27 Nov 2013 16:50:38 +0000"  >&lt;p&gt;Committed to trunk. Thanks, Sergey for initial investigation. Thanks, Remus for patch. Thanks, Eric for reproducible test-case!&lt;/p&gt;</comment>
                            <comment id="13841981" author="sershe" created="Sat, 7 Dec 2013 01:20:40 +0000"  >&lt;p&gt;It seems like I cannot make a repro for select... even though there are name collisions, the mappings are correct. Perhaps when someone finds a bug we can solve it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13945418" author="jnp" created="Mon, 24 Mar 2014 17:54:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;It seems like I cannot make a repro for select... even though there are name collisions, the mappings are correct. Perhaps when someone finds a bug we can solve it .&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-6349&quot; title=&quot;Column name map is broken &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-6349&quot;&gt;&lt;del&gt;HIVE-6349&lt;/del&gt;&lt;/a&gt; patch includes a test that reproduces the problem for vectorized select. The patch also fixes the issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12692634">HIVE-6349</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12614192" name="HIVE-5817-uniquecols.broken.patch" size="64702" author="sershe" created="Sat, 16 Nov 2013 02:40:54 +0000"/>
                            <attachment id="12614191" name="HIVE-5817.00-broken.patch" size="61514" author="sershe" created="Sat, 16 Nov 2013 02:40:54 +0000"/>
                            <attachment id="12615679" name="HIVE-5817.4.patch" size="13824" author="rusanu" created="Mon, 25 Nov 2013 21:49:27 +0000"/>
                            <attachment id="12615830" name="HIVE-5817.5.patch" size="16997" author="rusanu" created="Tue, 26 Nov 2013 13:12:16 +0000"/>
                            <attachment id="12615853" name="HIVE-5817.6.patch" size="34369" author="ashutoshc" created="Tue, 26 Nov 2013 16:19:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>358491</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 35 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1psrz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>358781</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>