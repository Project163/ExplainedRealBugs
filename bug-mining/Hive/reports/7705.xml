<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:17:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-23963] UnsupportedOperationException in queries 74 and 84 while applying HiveCardinalityPreservingJoinRule</title>
                <link>https://issues.apache.org/jira/browse/HIVE-23963</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;The following TPC-DS queries: &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;cbo_query74.q&lt;/li&gt;
	&lt;li&gt;cbo_query84.q&lt;/li&gt;
	&lt;li&gt;query74.q&lt;/li&gt;
	&lt;li&gt;query84.q&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;fail on the metastore with the partitioned TPC-DS 30TB dataset.&lt;/p&gt;

&lt;p&gt;The stacktraces for cbo_query74 and cbo_query84 show that the problem originates while applying HiveCardinalityPreservingJoinRule.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13320374">HIVE-23963</key>
            <summary>UnsupportedOperationException in queries 74 and 84 while applying HiveCardinalityPreservingJoinRule</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kkasa">Krisztian Kasa</assignee>
                                    <reporter username="zabetak">Stamatis Zampetakis</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 31 Jul 2020 10:13:29 +0000</created>
                <updated>Tue, 27 Feb 2024 22:24:02 +0000</updated>
                            <resolved>Fri, 7 Aug 2020 15:09:32 +0000</resolved>
                                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                    <component>CBO</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4200">1h 10m</timespent>
                                <comments>
                            <comment id="17168611" author="zabetak" created="Fri, 31 Jul 2020 10:14:44 +0000"  >&lt;p&gt;I will provide soon a patch (basically a new QTest driver) where the problem can be reproduced easily.&lt;/p&gt;</comment>
                            <comment id="17169820" author="zabetak" created="Mon, 3 Aug 2020 08:39:33 +0000"  >&lt;p&gt;The problem can be reproduced with the patch in &lt;a href=&quot;https://github.com/apache/hive/pull/1347&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR#1347&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17169985" author="kkasa" created="Mon, 3 Aug 2020 12:28:18 +0000"  >&lt;p&gt;When cost is calculated in&#160;HiveOnTezCostModel&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/hive/blob/28b6384e9ba287188015418b4c38c85dfdde8133/ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/cost/HiveOnTezCostModel.java#L403&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hive/blob/28b6384e9ba287188015418b4c38c85dfdde8133/ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/cost/HiveOnTezCostModel.java#L403&lt;/a&gt;&lt;br/&gt;
We need the RelDistribution of a Project node.&lt;/p&gt;

&lt;p&gt;The RelDistribution is calculated by:&lt;br/&gt;
1. get the Project input&apos;s RelDistribution. In this case this is a TableScan on the customer table partitioned by the c_customer_sk column -&amp;gt; HiveRelDistribution(hash&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;) - the number &lt;b&gt;0&lt;/b&gt; indicates that the c_customer_sk column is the 0th in the customer table but in general it can be anywhere.&lt;br/&gt;
2. The c_customer_sk is the 0th expression in the project but in general it can be anywhere so we need a mapping to map the key indexes in the RelDistribution. &lt;/p&gt;

&lt;p&gt;This mapping is an INVERSE_FUNCTION&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/calcite/blob/2088488ac8327b19512a76a122cae2961fc551c3/core/src/main/java/org/apache/calcite/rel/core/Project.java#L375&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/calcite/blob/2088488ac8327b19512a76a122cae2961fc551c3/core/src/main/java/org/apache/calcite/rel/core/Project.java#L375&lt;/a&gt;&lt;br/&gt;
which does not support &lt;b&gt;getTargetOpt&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jcamachorodriguez&quot; class=&quot;user-hover&quot; rel=&quot;jcamachorodriguez&quot;&gt;jcamachorodriguez&lt;/a&gt; &lt;br/&gt;
Can the mapping type changed to something else which support getTargetOpt?&lt;/p&gt;</comment>
                            <comment id="17170071" author="jcamacho" created="Mon, 3 Aug 2020 14:29:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkasa&quot; class=&quot;user-hover&quot; rel=&quot;kkasa&quot;&gt;kkasa&lt;/a&gt;, I think that should be explored on Calcite side indeed. I was checking the code and may need to wait for a release though?&lt;/p&gt;

&lt;p&gt;I saw we rely on that method in &lt;tt&gt;HiveRelDistribution&lt;/tt&gt;. Is it possible to create the map using &lt;tt&gt;mapping.iterator()&lt;/tt&gt; and rely on that map to get the value for each key? I think that may provide a valid workaround.&lt;/p&gt;</comment>
                            <comment id="17173192" author="jcamacho" created="Fri, 7 Aug 2020 15:09:32 +0000"  >&lt;p&gt;Pushed to master, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkasa&quot; class=&quot;user-hover&quot; rel=&quot;kkasa&quot;&gt;kkasa&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13008823" name="cbo_query74_stacktrace.txt" size="12094" author="zabetak" created="Fri, 31 Jul 2020 10:13:05 +0000"/>
                            <attachment id="13008822" name="cbo_query84_stacktrace.txt" size="12040" author="zabetak" created="Fri, 31 Jul 2020 10:13:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 14 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0hdh4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>