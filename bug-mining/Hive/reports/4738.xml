<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:46:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-14139] NPE dropping permanent function</title>
                <link>https://issues.apache.org/jira/browse/HIVE-14139</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;To reproduce:&lt;br/&gt;
1. Start a CLI session and create a permanent function.&lt;br/&gt;
2. Exit current CLI session.&lt;br/&gt;
3. Start a new CLI session and drop the function.&lt;/p&gt;

&lt;p&gt;Stack trace:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;FAILED: error during drop function: java.lang.NullPointerException
	at org.apache.hadoop.hive.ql.exec.Registry.removePersistentFunctionUnderLock(Registry.java:513)
	at org.apache.hadoop.hive.ql.exec.Registry.unregisterFunction(Registry.java:501)
	at org.apache.hadoop.hive.ql.exec.FunctionRegistry.unregisterPermanentFunction(FunctionRegistry.java:1532)
	at org.apache.hadoop.hive.ql.exec.FunctionTask.dropPermanentFunction(FunctionTask.java:228)
	at org.apache.hadoop.hive.ql.exec.FunctionTask.execute(FunctionTask.java:95)
	at org.apache.hadoop.hive.ql.exec.Task.executeTask(Task.java:197)
	at org.apache.hadoop.hive.ql.exec.TaskRunner.runSequential(TaskRunner.java:100)
	at org.apache.hadoop.hive.ql.Driver.launchTask(Driver.java:1860)
	at org.apache.hadoop.hive.ql.Driver.execute(Driver.java:1564)
	at org.apache.hadoop.hive.ql.Driver.runInternal(Driver.java:1316)
	at org.apache.hadoop.hive.ql.Driver.run(Driver.java:1085)
	at org.apache.hadoop.hive.ql.Driver.run(Driver.java:1073)
	at org.apache.hadoop.hive.cli.CliDriver.processLocalCmd(CliDriver.java:232)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12985689">HIVE-14139</key>
            <summary>NPE dropping permanent function</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lirui">Rui Li</assignee>
                                    <reporter username="lirui">Rui Li</reporter>
                        <labels>
                    </labels>
                <created>Thu, 30 Jun 2016 09:08:02 +0000</created>
                <updated>Wed, 26 Jul 2017 03:30:04 +0000</updated>
                            <resolved>Wed, 13 Jul 2016 05:19:21 +0000</resolved>
                                                    <fixVersion>2.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15357596" author="sershe" created="Thu, 30 Jun 2016 18:10:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lirui&quot; class=&quot;user-hover&quot; rel=&quot;lirui&quot;&gt;lirui&lt;/a&gt; are you looking into it? I can take a look today or tomorrow otherwise.&lt;/p&gt;</comment>
                            <comment id="15357977" author="sershe" created="Thu, 30 Jun 2016 22:35:02 +0000"  >&lt;p&gt;Which version is this, btw?&lt;/p&gt;</comment>
                            <comment id="15358251" author="lirui" created="Fri, 1 Jul 2016 02:20:42 +0000"  >&lt;p&gt;The problem is that we failed to register the function with &lt;tt&gt;Hive.registerAllFunctionsOnce -&amp;gt; reloadFunctions&lt;/tt&gt;. When we call &lt;tt&gt;FunctionRegistry.registerPermanentFunction&lt;/tt&gt;, we set registerToSession to false so that the custom jar won&apos;t be downloaded and we end up with a &lt;tt&gt;ClassNotFoundException&lt;/tt&gt;. Therefore we get the NPE when we try to drop the function.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt; - I found this with latest master code. BTW do you know why we choose not to register the function to session when calling &lt;tt&gt;Hive.registerAllFunctionsOnce&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="15358656" author="lirui" created="Fri, 1 Jul 2016 08:32:30 +0000"  >&lt;p&gt;The v1 patch registers function to session when loading them. Verified it fixes the issue on my side.&lt;/p&gt;</comment>
                            <comment id="15358907" author="lirui" created="Fri, 1 Jul 2016 12:49:39 +0000"  >&lt;p&gt;Another way to fix this is adding the function resource to class path when calling &lt;tt&gt;FunctionRegistry.registerPermanentFunction&lt;/tt&gt;, regardless whether need to register to session. I think this makes sense because the UDF class needs to be loaded anyway.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt; which way do you prefer or do you have better ideas? Thanks.&lt;/p&gt;</comment>
                            <comment id="15359459" author="sershe" created="Fri, 1 Jul 2016 18:45:48 +0000"  >&lt;p&gt;The code to not register it to session goes all the way to the original session registry patch.&lt;br/&gt;
I think the reason might be performance - we don&apos;t want to load the function resource for all the functions from metastore, which might be a lot of functions. It may be loaded on first use, not sure. I think we should handle at remove time rather than loading all resources before they are needed...&lt;/p&gt;</comment>
                            <comment id="15359888" author="lirui" created="Sat, 2 Jul 2016 01:16:47 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt; for the explanations. I agree performance is a valid concern. But not loading the resources leaves the system registry in a somehow inconsistent state: the function is registered in &lt;tt&gt;mFunctions&lt;/tt&gt; but not in &lt;tt&gt;persistent&lt;/tt&gt;, causing this NPE. If we think that is acceptable (although there&apos;s an assert to check this), maybe we can just ignore &lt;tt&gt;persistent&lt;/tt&gt; if the function doesn&apos;t exist?&lt;br/&gt;
Or we can make &lt;tt&gt;persistent&lt;/tt&gt; a  map from ClassName (instead of class) to RefCount? Would like to know your opinions, thanks.&lt;/p&gt;</comment>
                            <comment id="15360046" author="hiveqa" created="Sat, 2 Jul 2016 07:25:00 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12815715/HIVE-14139.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12815715/HIVE-14139.1.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 6 failed/errored test(s), 10287 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_all
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_join
org.apache.hadoop.hive.cli.TestMinimrCliDriver.testCliDriver_schemeAuthority
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/345/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/345/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/345/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/345/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-345/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-345/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 6 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12815715 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15361293" author="lirui" created="Mon, 4 Jul 2016 13:13:35 +0000"  >&lt;p&gt;Patch v2 makes the persistent map of className -&amp;gt; refCount. This way, we don&apos;t have to load function resource if not registering to session. And we don&apos;t have to load the resource just in order to drop the function.&lt;br/&gt;
Also adds a UT to cover this.&lt;/p&gt;</comment>
                            <comment id="15361470" author="hiveqa" created="Mon, 4 Jul 2016 15:30:28 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12816044/HIVE-14139.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12816044/HIVE-14139.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 5 failed/errored test(s), 10293 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_all
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_join
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/361/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/361/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/361/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/361/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-361/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-361/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12816044 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15362499" author="lirui" created="Tue, 5 Jul 2016 13:34:20 +0000"  >&lt;p&gt;Just realised I missed some update to the new test. Upload patch v3 for that.&lt;/p&gt;</comment>
                            <comment id="15362930" author="sershe" created="Tue, 5 Jul 2016 18:18:58 +0000"  >&lt;p&gt;It is consistent logically, we know about the function but don&apos;t load it until requested. We can just add safety check on removal and not assume it&apos;s loaded, does it make sense?&lt;/p&gt;</comment>
                            <comment id="15363230" author="hiveqa" created="Tue, 5 Jul 2016 20:54:28 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12816188/HIVE-14139.3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12816188/HIVE-14139.3.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 6 failed/errored test(s), 10296 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_all
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_join
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/371/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/371/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/371/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/371/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-371/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-371/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 6 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12816188 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15363624" author="lirui" created="Wed, 6 Jul 2016 02:12:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt; - do you mean we should just return if &lt;tt&gt;refCount&lt;/tt&gt; is null?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void removePersistentFunctionUnderLock(FunctionInfo fi) {
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; className = fi.getClassName();
    &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; refCount = persistent.get(className);
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; refCount != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (refCount == 1) {
      persistent.remove(className);
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      persistent.put(className, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.valueOf(refCount - 1));
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15365497" author="sershe" created="Thu, 7 Jul 2016 02:33:18 +0000"  >&lt;p&gt;Sorry, I was looking at the wrong patch (01). I am not sure that the class name in isPersistent will be the same as the one in add.. given the UDFBridge stuff, UDTF resolver etc. Would it make sense to not remove it from the map if it&apos;s missing? &lt;br/&gt;
I actually wonder, the NPE results from us not adding it in the first place, so wouldn&apos;t using string lead to the same problem where we don&apos;t add the string (rather than not adding the class) so we cannot find it?&lt;/p&gt;</comment>
                            <comment id="15365509" author="lirui" created="Thu, 7 Jul 2016 02:47:35 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt;, sorry the code in my last comment is the patched version. What we have in upstream is&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void removePersistentFunctionUnderLock(FunctionInfo fi) {
    &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; functionClass = getPermanentUdfClass(fi);
    &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; refCount = persistent.get(functionClass);
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; refCount != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (refCount == 1) {
      persistent.remove(functionClass);
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      persistent.put(functionClass, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.valueOf(refCount - 1));
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You can see why we don&apos;t add it in the first place is because we don&apos;t load the function resource, so we don&apos;t have the class to put into &lt;tt&gt;persistent&lt;/tt&gt;. So using class name instead class will fix this. But if the class name can somehow be changed like you said, I&apos;m also OK to just return if &lt;tt&gt;refCount&lt;/tt&gt; is null. What do you think?&lt;/p&gt;</comment>
                            <comment id="15370239" author="lirui" created="Mon, 11 Jul 2016 06:15:29 +0000"  >&lt;p&gt;Patch v4 adds safe check to avoid the NPE.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt;, could you take a look and let me know if it reflects what you have in mind? Thanks.&lt;/p&gt;</comment>
                            <comment id="15370879" author="hiveqa" created="Mon, 11 Jul 2016 14:31:26 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12817081/HIVE-14139.4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12817081/HIVE-14139.4.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 8 failed/errored test(s), 10304 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_all
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_join
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestMinimrCliDriver.org.apache.hadoop.hive.cli.TestMinimrCliDriver
org.apache.hadoop.hive.llap.tezplugins.TestLlapTaskSchedulerService.testDelayedLocalityNodeCommErrorImmediateAllocation
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/466/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/466/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/466/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/466/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-466/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-466/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 8 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12817081 - PreCommit-HIVE-MASTER-Build&lt;/p&gt;</comment>
                            <comment id="15372115" author="lirui" created="Tue, 12 Jul 2016 03:13:06 +0000"  >&lt;p&gt;Failures not related: &lt;tt&gt;TestLlapTaskSchedulerService&lt;/tt&gt; cannot be reproduced locally, others have failed multiple times.&lt;/p&gt;</comment>
                            <comment id="15374314" author="sershe" created="Wed, 13 Jul 2016 04:28:03 +0000"  >&lt;p&gt;+1, sorry for the delay&lt;/p&gt;</comment>
                            <comment id="15374368" author="lirui" created="Wed, 13 Jul 2016 05:19:21 +0000"  >&lt;p&gt;Committed to master. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sershe&quot; class=&quot;user-hover&quot; rel=&quot;sershe&quot;&gt;sershe&lt;/a&gt; for the review.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12815715" name="HIVE-14139.1.patch" size="904" author="lirui" created="Fri, 1 Jul 2016 08:32:30 +0000"/>
                            <attachment id="12816044" name="HIVE-14139.2.patch" size="6413" author="lirui" created="Mon, 4 Jul 2016 13:13:35 +0000"/>
                            <attachment id="12816188" name="HIVE-14139.3.patch" size="6689" author="lirui" created="Tue, 5 Jul 2016 13:34:20 +0000"/>
                            <attachment id="12817081" name="HIVE-14139.4.patch" size="952" author="lirui" created="Mon, 11 Jul 2016 06:15:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 19 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30cx3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>