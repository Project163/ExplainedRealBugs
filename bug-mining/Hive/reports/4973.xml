<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:48:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-13423] Handle the overflow case for decimal datatype for sum()</title>
                <link>https://issues.apache.org/jira/browse/HIVE-13423</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;When a column col1 defined as decimal and if the sum of the column overflows, we will try to increase the decimal precision by 10. But if it&apos;s reaching 38 (the max precision), the overflow still could happen. Right now, if such case happens, the following exception will throw since hive is writing incorrect data.&lt;/p&gt;

&lt;p&gt;Follow the following steps to repro. &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE TABLE DECIMAL_PRECISION(dec decimal(38,18));
INSERT INTO DECIMAL_PRECISION VALUES(98765432109876543210.12345), (98765432109876543210.12345);
SELECT SUM(dec) FROM DECIMAL_PRECISION;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.lang.ArrayIndexOutOfBoundsException: 1
        at org.apache.hadoop.hive.serde2.lazybinary.LazyBinaryUtils.readVInt(LazyBinaryUtils.java:314) ~[hive-exec-2.2.0-SNAPSHOT.jar:2.2.0-SNAPSHOT]
        at org.apache.hadoop.hive.serde2.lazybinary.LazyBinaryUtils.checkObjectByteInfo(LazyBinaryUtils.java:219) ~[hive-exec-2.2.0-SNAPSHOT.jar:2.2.0-SNAPSHOT]
        at org.apache.hadoop.hive.serde2.lazybinary.LazyBinaryStruct.parse(LazyBinaryStruct.java:142) ~[hive-exec-2.2.0-SNAPSHOT.jar:2.2.0-SNAPSHOT]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12956154">HIVE-13423</key>
            <summary>Handle the overflow case for decimal datatype for sum()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aihuaxu">Aihua Xu</assignee>
                                    <reporter username="aihuaxu">Aihua Xu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Apr 2016 13:49:08 +0000</created>
                <updated>Wed, 26 Jul 2017 03:30:14 +0000</updated>
                            <resolved>Thu, 20 Oct 2016 13:40:06 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.2.0</fixVersion>
                                    <component>Query Processor</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15576521" author="aihuaxu" created="Fri, 14 Oct 2016 21:20:07 +0000"  >&lt;p&gt;Patch-1: simple change that when the sum is out of decimal range, then give a warning and return null as the result. &lt;/p&gt;</comment>
                            <comment id="15577232" author="hiveqa" created="Sat, 15 Oct 2016 03:06:34 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12833448/HIVE-13423.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12833448/HIVE-13423.1.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 7 failed/errored test(s), 10564 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[acid_globallimit]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[order_null]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[union_fast_stats]
org.apache.hive.beeline.TestBeelineArgParsing.testAddLocalJarWithoutAddDriverClazz[0]
org.apache.hive.beeline.TestBeelineArgParsing.testAddLocalJar[0]
org.apache.hive.beeline.TestBeelineArgParsing.testAddLocalJar[1]
org.apache.hive.jdbc.authorization.TestJdbcWithSQLAuthorization.testBlackListedUdfUsage
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/1577/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/1577/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/1577/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/1577/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-1577/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-1577/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 7 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12833448 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15582458" author="aihuaxu" created="Mon, 17 Oct 2016 14:50:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ctang.ma&quot; class=&quot;user-hover&quot; rel=&quot;ctang.ma&quot;&gt;ctang.ma&lt;/a&gt; Initially I remember we had issues with GroupBy on this decimal data type, but I couldn&apos;t see such issue any more (seems it has been fixed by &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-6459&quot; title=&quot;Change the precison/scale for intermediate sum result in the avg() udf &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-6459&quot;&gt;&lt;del&gt;HIVE-6459&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;But we still have a small issue that when the sum overflows, it will produce corrupted intermediate file and give ArrayIndexOutOfBoundsException. &lt;/p&gt;

&lt;p&gt;Can you help take a look at the simple fix or do you have a better idea?&lt;/p&gt;</comment>
                            <comment id="15582911" author="ctang.ma" created="Mon, 17 Oct 2016 17:52:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aihuaxu&quot; class=&quot;user-hover&quot; rel=&quot;aihuaxu&quot;&gt;aihuaxu&lt;/a&gt; The patch looks good. The issue might also exist in all other arithmetic functions or operations like plus&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/add.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;, multiplication&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; etc I believe. I wonder if we need truncate the scale like SQLServer does to fit the intermediate data to the precision as discussed in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-14281&quot; title=&quot;Issue in decimal multiplication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-14281&quot;&gt;HIVE-14281&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt;, you have more insights into the decimal and what is your thought?&lt;/p&gt;</comment>
                            <comment id="15582931" author="xuefuz" created="Mon, 17 Oct 2016 17:59:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aihuaxu&quot; class=&quot;user-hover&quot; rel=&quot;aihuaxu&quot;&gt;aihuaxu&lt;/a&gt;, thanks for looking into this. Do we know the cause of ArrayIndexOutOfBoundsException?&lt;/p&gt;

&lt;p&gt;Giving a warning message is fine, though that may not help all cases. I think the right behavior is to return NULL when result overflows but to provide a strict mode in which error will be thrown instead. This should be considered for all such cases.&lt;/p&gt;

&lt;p&gt;One thing to find out is to sum integer columns. In such case, overflowing can also occur. I expect that NULL will be returned. For decimal, we should do the same until a general strict mode is implemented.&lt;/p&gt;
</comment>
                            <comment id="15582946" author="aihuaxu" created="Mon, 17 Oct 2016 18:03:43 +0000"  >&lt;p&gt;Yes. ArrayIndexOutOfBoundsException is because of the overflow and with this patch we does return NULL when the overflow occurs.&lt;/p&gt;

&lt;p&gt;When there is an overflow, we are writing a &apos;non-null&apos; flag to the file since the data indeed is a non-null, while later when we try to interpret the data, it resolves to null since it overflows. That causes to generate a corrupted file.&lt;/p&gt;


</comment>
                            <comment id="15582953" author="aihuaxu" created="Mon, 17 Oct 2016 18:05:47 +0000"  >&lt;p&gt;Does Oracle truncate? Seems hive follows more on Oracle (which follows more on sql standard). &lt;/p&gt;</comment>
                            <comment id="15583055" author="xuefuz" created="Mon, 17 Oct 2016 18:39:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ctang.ma&quot; class=&quot;user-hover&quot; rel=&quot;ctang.ma&quot;&gt;ctang.ma&lt;/a&gt;/&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aihuaxu&quot; class=&quot;user-hover&quot; rel=&quot;aihuaxu&quot;&gt;aihuaxu&lt;/a&gt;, as to sacrificing scale for bigger integer part, it doesn&apos;t seem to be a viable option. The precision/scale of the result type of sum udf is determined statically as result metadata. That is, the result type of sum(decimal(p, s)) is decimal(p+10, s), which is decided before seeing any actual data. Thus, at run time when the data is actually processed, we cannot return the result of decimal( p+10+d, s-d) because the data (result) doesn&apos;t conform to the metadata (type decimal(p+10, s).&lt;/p&gt;

&lt;p&gt;Please feel free to check standards or what other dbs are dong. As far as I know, there is no standard that permits this.&lt;/p&gt;</comment>
                            <comment id="15589113" author="aihuaxu" created="Wed, 19 Oct 2016 15:56:46 +0000"  >&lt;p&gt;Doesn&apos;t seem to have standard for that.&lt;/p&gt;

&lt;p&gt;I feel we can just return null if it&apos;s out of the range as well. Seems clean and also match what we have for other datatypes in Hive.&lt;/p&gt;

&lt;p&gt;The attached patch is to return null if the sum is out of range. Can we commit this change?&lt;/p&gt;</comment>
                            <comment id="15589241" author="xuefuz" created="Wed, 19 Oct 2016 16:54:34 +0000"  >&lt;p&gt;This sounds good to me. I&apos;d +1 on this unless &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ctang.ma&quot; class=&quot;user-hover&quot; rel=&quot;ctang.ma&quot;&gt;ctang.ma&lt;/a&gt; has some objections.&lt;/p&gt;</comment>
                            <comment id="15589243" author="xuefuz" created="Wed, 19 Oct 2016 16:54:36 +0000"  >&lt;p&gt;This sounds good to me. I&apos;d +1 on this unless &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ctang.ma&quot; class=&quot;user-hover&quot; rel=&quot;ctang.ma&quot;&gt;ctang.ma&lt;/a&gt; has some objections.&lt;/p&gt;</comment>
                            <comment id="15589253" author="ctang.ma" created="Wed, 19 Oct 2016 16:58:13 +0000"  >&lt;p&gt;Sound good to me as well.&lt;/p&gt;</comment>
                            <comment id="15589285" author="xuefuz" created="Wed, 19 Oct 2016 17:13:05 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15591839" author="aihuaxu" created="Thu, 20 Oct 2016 13:40:06 +0000"  >&lt;p&gt;Pushed to master. Thanks Xuefu and Chaoyu for reviewing.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12695793">HIVE-6459</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12833448" name="HIVE-13423.1.patch" size="5554" author="aihuaxu" created="Fri, 14 Oct 2016 21:18:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 4 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vnvb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>