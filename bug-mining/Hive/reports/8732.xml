<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:26:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-28264] OOM/slow compilation when query contains SELECT clauses with nested expressions</title>
                <link>https://issues.apache.org/jira/browse/HIVE-28264</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;TABLE&lt;/span&gt; t0 (`title` &lt;span class=&quot;code-keyword&quot;&gt;string&lt;/span&gt;);
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; x10 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
    (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L10&apos;&lt;/span&gt;,x9, x9, x9, x9) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x10 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
        (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L9&apos;&lt;/span&gt;,x8, x8, x8, x8) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x9 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
            (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L8&apos;&lt;/span&gt;,x7, x7, x7, x7) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x8 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
                (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L7&apos;&lt;/span&gt;,x6, x6, x6, x6) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x7 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
                    (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L6&apos;&lt;/span&gt;,x5, x5, x5, x5) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x6 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
                        (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L5&apos;&lt;/span&gt;,x4, x4, x4, x4) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x5 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
                            (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L4&apos;&lt;/span&gt;,x3, x3, x3, x3) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x4 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
                                (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L3&apos;&lt;/span&gt;,x2, x2, x2, x2) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x3 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
                                    (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L2&apos;&lt;/span&gt;,x1, x1, x1, x1) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x2 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
                                        (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L1&apos;&lt;/span&gt;,x0, x0, x0, x0) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x1 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
                                            (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L0&apos;&lt;/span&gt;,title, title, title, title) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x0 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; t0) t1) t2) t3) t4) t5) t6) t7) t8) t9) t10) t
&lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; x10 = &lt;span class=&quot;code-quote&quot;&gt;&apos;Something&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The query above fails with OOM when run with the TestMiniLlapLocalCliDriver and the default max heap size configuration effective for tests (-Xmx2048m).&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.OutOfMemoryError: Java heap space
	at java.util.Arrays.copyOf(Arrays.java:3332)
	at java.lang.AbstractStringBuilder.ensureCapacityInternal(AbstractStringBuilder.java:124)
	at java.lang.AbstractStringBuilder.append(AbstractStringBuilder.java:448)
	at java.lang.StringBuilder.append(StringBuilder.java:136)
	at org.apache.calcite.rex.RexCall.computeDigest(RexCall.java:152)
	at org.apache.calcite.rex.RexCall.toString(RexCall.java:165)
	at org.apache.calcite.rex.RexCall.appendOperands(RexCall.java:105)
	at org.apache.calcite.rex.RexCall.computeDigest(RexCall.java:151)
	at org.apache.calcite.rex.RexCall.toString(RexCall.java:165)
	at java.lang.String.valueOf(String.java:2994)
	at java.lang.StringBuilder.append(StringBuilder.java:131)
	at org.apache.calcite.rel.externalize.RelWriterImpl.explain_(RelWriterImpl.java:90)
	at org.apache.calcite.rel.externalize.RelWriterImpl.done(RelWriterImpl.java:144)
	at org.apache.calcite.rel.AbstractRelNode.explain(AbstractRelNode.java:246)
	at org.apache.calcite.rel.externalize.RelWriterImpl.explainInputs(RelWriterImpl.java:122)
	at org.apache.calcite.rel.externalize.RelWriterImpl.explain_(RelWriterImpl.java:116)
	at org.apache.calcite.rel.externalize.RelWriterImpl.done(RelWriterImpl.java:144)
	at org.apache.calcite.rel.AbstractRelNode.explain(AbstractRelNode.java:246)
	at org.apache.calcite.plan.RelOptUtil.toString(RelOptUtil.java:2308)
	at org.apache.calcite.plan.RelOptUtil.toString(RelOptUtil.java:2292)
	at org.apache.hadoop.hive.ql.optimizer.calcite.RuleEventLogger.ruleProductionSucceeded(RuleEventLogger.java:73)
	at org.apache.calcite.plan.MulticastRelOptListener.ruleProductionSucceeded(MulticastRelOptListener.java:68)
	at org.apache.calcite.plan.AbstractRelOptPlanner.notifyTransformation(AbstractRelOptPlanner.java:370)
	at org.apache.calcite.plan.hep.HepPlanner.applyTransformationResults(HepPlanner.java:702)
	at org.apache.calcite.plan.hep.HepPlanner.applyRule(HepPlanner.java:545)
	at org.apache.calcite.plan.hep.HepPlanner.applyRules(HepPlanner.java:407)
	at org.apache.calcite.plan.hep.HepPlanner.executeInstruction(HepPlanner.java:271)
	at org.apache.calcite.plan.hep.HepInstruction$RuleCollection.execute(HepInstruction.java:74)
	at org.apache.calcite.plan.hep.HepPlanner.executeProgram(HepPlanner.java:202)
	at org.apache.calcite.plan.hep.HepPlanner.findBestExp(HepPlanner.java:189)
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner$CalcitePlannerAction.executeProgram(CalcitePlanner.java:2452)
	at org.apache.hadoop.hive.ql.parse.CalcitePlanner$CalcitePlannerAction.executeProgram(CalcitePlanner.java:2411)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13579521">HIVE-28264</key>
            <summary>OOM/slow compilation when query contains SELECT clauses with nested expressions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kkasa">Krisztian Kasa</assignee>
                                    <reporter username="zabetak">Stamatis Zampetakis</reporter>
                        <labels>
                            <label>hive-4.0.1-merged</label>
                            <label>hive-4.0.1-must</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 16 May 2024 13:00:17 +0000</created>
                <updated>Tue, 29 Jul 2025 14:52:07 +0000</updated>
                            <resolved>Wed, 11 Sep 2024 10:56:04 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                    <fixVersion>4.0.1</fixVersion>
                                    <component>CBO</component>
                    <component>HiveServer2</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17846978" author="zabetak" created="Thu, 16 May 2024 14:34:39 +0000"  >&lt;p&gt;To understand the problem let&apos;s consider a much simpler variation of the query in the description.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; x1 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
    (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L1&apos;&lt;/span&gt;,x0, x0) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x1 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
        (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L0&apos;&lt;/span&gt;,title, title) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x0 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; t0) t1) t2;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It is easy to see that the SELECT clauses can be merged together leading to the following query.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L1&apos;&lt;/span&gt;,concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L0&apos;&lt;/span&gt;,title, title), concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L0&apos;&lt;/span&gt;,title, title)) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x1 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; t0;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The two queries are equivalent, however they don&apos;t contain the same number of &lt;tt&gt;concat_ws&lt;/tt&gt; calls. The first contains two calls while the second contains three calls and the expression in the SELECT clause is bigger than both of the previous expressions.&lt;/p&gt;

&lt;p&gt;When the query has nested function calls (CONCAT or anything else) then merging those together leads to bigger expressions. In fact the growth rate of the expression is exponential to the number of its arguments. &lt;/p&gt;

&lt;p&gt;&lt;ins&gt;Examples:&lt;/ins&gt;&lt;br/&gt;
When the CONCAT function has two arguments then for each nested level the expression grows by a factor of two. The size of the final expression is (1-2^L)/(1-2) where L is the levels of nesting.&lt;br/&gt;
When the CONCAT functions has four arguments (as the query in the description) the for each nested level the expression grows by a factor of four.  The size of the final expression is (1-4^L)/(1-4) where L is the levels of nesting.&lt;/p&gt;

&lt;p&gt;There are various optimization rules (eg., HiveFieldTrimmerRule, HiveProjectMergeRule, etc.) that will try to merge expressions together and when this happens in an uncontrolled manner the resulting expression is exponentially big, which can further lead to OOM problems, very slow compilation,  etc. Clearly it is not always beneficial to merge expressions together and the aforementioned rules do have some logic in place to avoid this kind of huge expansion. Both rules pass from &lt;tt&gt;RelOptUtil#pushPastProjectUnlessBloat&lt;/tt&gt; so they can be tuned via the bloat parameter.&lt;/p&gt;

&lt;p&gt;However, there are also other rules that are affected by this exponential growth problem , such as &lt;tt&gt;HiveFilterProjectTransposeRule&lt;/tt&gt;, and currently they do not have logic to prevent that.&lt;br/&gt;
&lt;ins&gt;Before&lt;/ins&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; x1 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
    (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L1&apos;&lt;/span&gt;,x0, x0) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x1 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
        (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L0&apos;&lt;/span&gt;,title, title) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x0 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; t0) t1) t2
&lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; x1 = &lt;span class=&quot;code-quote&quot;&gt;&apos;Something&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;ins&gt;After&lt;/ins&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; x1 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
    (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L1&apos;&lt;/span&gt;,x0, x0) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x1 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;
        (&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L0&apos;&lt;/span&gt;,title, title) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; x0 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; t0
         &lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L1&apos;&lt;/span&gt;,concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L0&apos;&lt;/span&gt;,title, title), concat_ws(&lt;span class=&quot;code-quote&quot;&gt;&apos;L0&apos;&lt;/span&gt;,title, title)) = &lt;span class=&quot;code-quote&quot;&gt;&apos;Something&apos;&lt;/span&gt;) t1) t2;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In this case the exponential growth happens when trying to push the filter down past the projections. A possible solution would be to improve HiveFilterProjectTransposeRule and other rules that may be affected to avoid creating overly complex expressions using a similar bloat configuration parameter.&lt;/p&gt;</comment>
                            <comment id="17847000" author="asolimando" created="Thu, 16 May 2024 15:11:28 +0000"  >&lt;p&gt;I guess the problem applies to the respective Calcite rules from which the Hive ones were derived, do you know if that has been addressed there?&lt;/p&gt;</comment>
                            <comment id="17880933" author="kkasa" created="Wed, 11 Sep 2024 10:56:04 +0000"  >&lt;p&gt;Merged to master. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zabetak&quot; class=&quot;user-hover&quot; rel=&quot;zabetak&quot;&gt;zabetak&lt;/a&gt; for reporting this and reviewing the patch.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13587693">CALCITE-6513</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 9 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1p9jc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>