<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:39:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-12491] Improve ndv heuristic for functions</title>
                <link>https://issues.apache.org/jira/browse/HIVE-12491</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;The eased out denominator has to detect duplicate row-stats from different attributes.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;select account_id from customers c,  customer_activation ca
  where c.customer_id = ca.customer_id
  and year(ca.dt) = year(c.dt) and month(ca.dt) = month(c.dt)
  and year(ca.dt) between year(&lt;span class=&quot;code-quote&quot;&gt;&apos;2013-12-26&apos;&lt;/span&gt;) and year(&lt;span class=&quot;code-quote&quot;&gt;&apos;2013-12-26&apos;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; getEasedOutDenominator(List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; distinctVals) {
      &lt;span class=&quot;code-comment&quot;&gt;// Exponential back-off &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; NDVs.
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// 1) Descending order sort of NDVs
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// 2) denominator = NDV1 * (NDV2 ^ (1/2)) * (NDV3 ^ (1/4))) * ....
&lt;/span&gt;      Collections.sort(distinctVals, Collections.reverseOrder());

      &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; denom = distinctVals.get(0);
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 1; i &amp;lt; distinctVals.size(); i++) {
        denom = (&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;) (denom * &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.pow(distinctVals.get(i), 1.0 / (1 &amp;lt;&amp;lt; i)));
      }

      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; denom;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This gets &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;8007986, 821974390, 821974390&amp;#93;&lt;/span&gt;&lt;/tt&gt;, which is actually 3 columns 2 of which are derived from the same column.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        Reduce Output Operator (RS_12)
          key expressions: _col0 (type: bigint), year(_col2) (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;), month(_col2) (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
          sort order: +++
          Map-reduce partition columns: _col0 (type: bigint), year(_col2) (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;), month(_col2) (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
          value expressions: _col1 (type: bigint)
          Join Operator (JOIN_13)
            condition map:
                 Inner Join 0 to 1
            keys:
              0 _col0 (type: bigint), year(_col1) (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;), month(_col1) (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
              1 _col0 (type: bigint), year(_col2) (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;), month(_col2) (type: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
            outputColumnNames: _col3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So the eased out denominator is off by a factor of 30,000 or so, causing OOMs in map-joins.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12915142">HIVE-12491</key>
            <summary>Improve ndv heuristic for functions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ashutoshc">Ashutosh Chauhan</assignee>
                                    <reporter username="gopalv">Gopal Vijayaraghavan</reporter>
                        <labels>
                    </labels>
                <created>Sun, 22 Nov 2015 06:53:00 +0000</created>
                <updated>Tue, 16 Feb 2016 23:52:21 +0000</updated>
                            <resolved>Wed, 2 Dec 2015 17:40:12 +0000</resolved>
                                    <version>1.3.0</version>
                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>Statistics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15020875" author="gopalv" created="Sun, 22 Nov 2015 06:58:23 +0000"  >&lt;p&gt;band-aid fix.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;              &lt;span class=&quot;code-comment&quot;&gt;// To avoid denominator getting larger and aggressively reducing
&lt;/span&gt;              &lt;span class=&quot;code-comment&quot;&gt;// number of rows, we will ease out denominator.
&lt;/span&gt;              denom = getEasedOutDenominator(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;(distinctVals)));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15020886" author="gopalv" created="Sun, 22 Nov 2015 07:25:07 +0000"  >&lt;p&gt;Actually, this might be a candidate for the PK-FK case, since _col0 there is a primary key.&lt;/p&gt;</comment>
                            <comment id="15020900" author="gopalv" created="Sun, 22 Nov 2015 08:27:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jcamachorodriguez&quot; class=&quot;user-hover&quot; rel=&quot;jcamachorodriguez&quot;&gt;jcamachorodriguez&lt;/a&gt;: since Calcite has a similar rule internally - what would be the right heuristic here?&lt;/p&gt;</comment>
                            <comment id="15025171" author="ashutoshc" created="Tue, 24 Nov 2015 19:34:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt; In CBO, we use same logic for easedOutDenominator which is here in StatsRuleProcFactory. Check out : HiveRelMdSelectivity::exponentialBackoff()&lt;br/&gt;
However, PK-FK inference is only done for a single key case currently in StatsRuleProcFactory. Are you thinking extending that to multiple keys will help us in getting better row estimates for this particular query?&lt;br/&gt;
I am not sure why is it currently restricted to 1 key. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pxiong&quot; class=&quot;user-hover&quot; rel=&quot;pxiong&quot;&gt;pxiong&lt;/a&gt; might know more if there are any gotchas in lifting that restriction ?&lt;/p&gt;</comment>
                            <comment id="15025956" author="pxiong" created="Wed, 25 Nov 2015 01:37:48 +0000"  >&lt;p&gt;PK-FK inference in StatsRuleProcFactory is not limited to a single PK and a single FK. It is limited to a single PK only. That is, we allow single PK and multiple FKs. In a single PK and multiple FKs case, we first use PK-FK relationship to estimate the row count, NDV, etc and then join with other FKs without PK-FK inference. Hope it helps.&lt;/p&gt;</comment>
                            <comment id="15025977" author="ashutoshc" created="Wed, 25 Nov 2015 01:54:14 +0000"  >&lt;p&gt;I guess what Gopal is pointing out is multiple PK case is missing which might help this use case. (as demonstrated in his WIP patch). &lt;br/&gt;
Other thing is we failed to recognize that out of 3 columns, two are different udfs on same column, so we incorrectly computed denom for that. Ideally, we need to fix both but doing atleast one of these two will help.&lt;/p&gt;</comment>
                            <comment id="15027319" author="ashutoshc" created="Wed, 25 Nov 2015 18:24:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt; If you have minimal query which repros the effect, can you post it here?&lt;/p&gt;</comment>
                            <comment id="15027755" author="gopalv" created="Wed, 25 Nov 2015 23:00:37 +0000"  >&lt;p&gt;Added a minimal query which demonstrates the issue.&lt;/p&gt;</comment>
                            <comment id="15033094" author="prasanth_j" created="Tue, 1 Dec 2015 05:02:25 +0000"  >&lt;p&gt;NDVs for UDFs is currently assumed to be worst case which is the number of rows. Ideally, for built-in UDFs, if the UDFType is non-deterministic then we should assume the above worst case (ex. UDFRand) as we cannot estimate the output NDV. But if the UDF is deterministic like UDFMonth then we should instead use the NDV of the column referenced in the UDF. &lt;/p&gt;</comment>
                            <comment id="15033096" author="prasanth_j" created="Tue, 1 Dec 2015 05:06:00 +0000"  >&lt;p&gt;For the example in the description, NDV for year(_col2) is 821974390 and NDV for month(_col2) is 821974390. I am guessing this value came from number of rows of the relation that _col2 belongs to. Since, year and month are built-in UDFs and are deterministic we should instead get the NDV of _col2. This will automatically ease out the denominator and will provide better estimates.&lt;/p&gt;</comment>
                            <comment id="15033220" author="ashutoshc" created="Tue, 1 Dec 2015 06:59:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt; Could you take a look?&lt;/p&gt;</comment>
                            <comment id="15033225" author="prasanth_j" created="Tue, 1 Dec 2015 07:05:01 +0000"  >&lt;p&gt;LGTM, +1. Pending tests. Any idea what&apos;s the estimate for the query that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt; posted?&lt;/p&gt;</comment>
                            <comment id="15033327" author="pxiong" created="Tue, 1 Dec 2015 08:25:01 +0000"  >&lt;p&gt;looks like a good heuristic for NDV estimation of UDFs. +1. Btw, could you move &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;1280	         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (countDistincts &amp;gt; numRows) {
1281	           countDistincts = numRows;
1282	         }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to the inside of the previous for loop and break when countDistincts is over numRows? It may save some CPU cycles. &lt;/p&gt;</comment>
                            <comment id="15034314" author="ashutoshc" created="Tue, 1 Dec 2015 18:35:42 +0000"  >&lt;p&gt;Addressed comments and little bit of refactoring in StatsRuleProcFactory (no logic change there) for better readability.&lt;/p&gt;</comment>
                            <comment id="15034374" author="ashutoshc" created="Tue, 1 Dec 2015 19:06:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/40827/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/40827/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15035167" author="ashutoshc" created="Wed, 2 Dec 2015 02:49:28 +0000"  >&lt;p&gt;We can exploit semantic information about known udfs which have bounded NDVs.&lt;/p&gt;</comment>
                            <comment id="15035613" author="hiveqa" created="Wed, 2 Dec 2015 10:35:18 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12775220/HIVE-12491.5.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12775220/HIVE-12491.5.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to no test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 13 failed/errored test(s), 9869 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TestHWISessionManager - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_orc_llap
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_union17
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_dynamic_partition_pruning
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_tez_union_multiinsert
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vectorized_dynamic_partition_pruning
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_explainuser_2
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_mergejoin
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_tez_union_multiinsert
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_uri_import
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_union17
org.apache.hadoop.hive.metastore.TestHiveMetaStorePartitionSpecs.testGetPartitionSpecs_WithAndWithoutPartitionGrouping
org.apache.hive.jdbc.TestSSL.testSSLVersion
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6195/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6195/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6195/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6195/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-6195/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-6195/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 13 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12775220 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="15036223" author="ashutoshc" created="Wed, 2 Dec 2015 17:40:12 +0000"  >&lt;p&gt;Test failures are either unrelated or stats update. Pushed to master.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12775090" name="HIVE-12491.2.patch" size="28473" author="ashutoshc" created="Tue, 1 Dec 2015 18:35:41 +0000"/>
                            <attachment id="12775196" name="HIVE-12491.3.patch" size="36946" author="ashutoshc" created="Wed, 2 Dec 2015 02:49:28 +0000"/>
                            <attachment id="12775214" name="HIVE-12491.4.patch" size="58349" author="ashutoshc" created="Wed, 2 Dec 2015 05:27:06 +0000"/>
                            <attachment id="12775220" name="HIVE-12491.5.patch" size="58474" author="ashutoshc" created="Wed, 2 Dec 2015 06:15:31 +0000"/>
                            <attachment id="12773719" name="HIVE-12491.WIP.patch" size="6199" author="gopalv" created="Sun, 22 Nov 2015 08:26:41 +0000"/>
                            <attachment id="12774975" name="HIVE-12491.patch" size="2719" author="ashutoshc" created="Tue, 1 Dec 2015 06:59:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 51 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2or6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332641">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>