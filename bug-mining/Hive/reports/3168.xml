<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:30:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-9755] Hive built-in &quot;ngram&quot; UDAF fails when a mapper has no matches.</title>
                <link>https://issues.apache.org/jira/browse/HIVE-9755</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;hive&amp;gt; describe ngramtest;&lt;br/&gt;
OK&lt;br/&gt;
col1                	int                 	                    &lt;br/&gt;
col3                	string              	                    &lt;br/&gt;
Time taken: 0.192 seconds, Fetched: 2 row(s)&lt;/p&gt;

&lt;p&gt;SELECT explode(ngrams(sentences(lower(t.col3)), 3, 10)) as x FROM (SELECT col3  FROM ngramtest WHERE col1=0) t;&lt;/p&gt;

&lt;p&gt;when any result has value equal null, returned the error. &lt;/p&gt;

&lt;p&gt;2015-01-08 09:15:00,262 FATAL ExecReducer: org.apache.hadoop.hive.ql.metadata.HiveException: Hive Runtime Error while processing row (tag=0) {&quot;key&quot;:{},&quot;value&quot;:&lt;/p&gt;
{&quot;_col0&quot;:[&quot;0&quot;,&quot;0&quot;,&quot;0&quot;,&quot;0&quot;]}
&lt;p&gt;,&quot;alias&quot;:0} &lt;br/&gt;
at org.apache.hadoop.hive.ql.exec.ExecReducer.reduce(ExecReducer.java:258) &lt;br/&gt;
at org.apache.hadoop.mapred.ReduceTask.runOldReducer(ReduceTask.java:506) &lt;br/&gt;
at org.apache.hadoop.mapred.ReduceTask.run(ReduceTask.java:447) &lt;br/&gt;
at org.apache.hadoop.mapred.Child$4.run(Child.java:268) &lt;br/&gt;
at java.security.AccessController.doPrivileged(Native Method) &lt;br/&gt;
at javax.security.auth.Subject.doAs(Subject.java:396) &lt;br/&gt;
at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1408) &lt;br/&gt;
at org.apache.hadoop.mapred.Child.main(Child.java:262) &lt;br/&gt;
Caused by: org.apache.hadoop.hive.ql.metadata.HiveException: GenericUDAFnGramEvaluator: mismatch in value for &apos;n&apos;, which usually is caused by a non-constant expression. Found &apos;0&apos; and &apos;1&apos;. &lt;br/&gt;
at org.apache.hadoop.hive.ql.udf.generic.GenericUDAFnGrams$GenericUDAFnGramEvaluator.merge(GenericUDAFnGrams.java:242) &lt;br/&gt;
at org.apache.hadoop.hive.ql.udf.generic.GenericUDAFEvaluator.aggregate(GenericUDAFEvaluator.java:142) &lt;br/&gt;
at org.apache.hadoop.hive.ql.exec.GroupByOperator.updateAggregations(GroupByOperator.java:658) &lt;br/&gt;
at org.apache.hadoop.hive.ql.exec.GroupByOperator.processAggr(GroupByOperator.java:911) &lt;br/&gt;
at org.apache.hadoop.hive.ql.exec.GroupByOperator.processKey(GroupByOperator.java:753) &lt;br/&gt;
at org.apache.hadoop.hive.ql.exec.GroupByOperator.processOp(GroupByOperator.java:819) &lt;br/&gt;
at org.apache.hadoop.hive.ql.exec.Operator.process(Operator.java:474) &lt;br/&gt;
at org.apache.hadoop.hive.ql.exec.ExecReducer.reduce(ExecReducer.java:249) &lt;/p&gt;
</description>
                <environment></environment>
        <key id="12776945">HIVE-9755</key>
            <summary>Hive built-in &quot;ngram&quot; UDAF fails when a mapper has no matches.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ngangam">Naveen Gangam</assignee>
                                    <reporter username="ngangam">Naveen Gangam</reporter>
                        <labels>
                    </labels>
                <created>Mon, 23 Feb 2015 20:50:43 +0000</created>
                <updated>Thu, 20 Aug 2015 17:30:06 +0000</updated>
                            <resolved>Fri, 27 Feb 2015 18:35:36 +0000</resolved>
                                    <version>0.14.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                                    <component>UDF</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14333879" author="ngangam" created="Mon, 23 Feb 2015 22:07:04 +0000"  >&lt;p&gt;When a mapper returns an empty result set, the ngram UDAF has nothing to merge during the reduce phase, merge(). The code&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; n = &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.parseInt(partialNGrams.get(partialNGrams.size()-1).toString());
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(myagg.n &amp;gt; 0 &amp;amp;&amp;amp; myagg.n != n) {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HiveException(getClass().getSimpleName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;: mismatch in value &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;n&apos;&lt;/span&gt;&quot;&lt;/span&gt;
            + &lt;span class=&quot;code-quote&quot;&gt;&quot;, which usually is caused by a non-constant expression. Found &lt;span class=&quot;code-quote&quot;&gt;&apos;&quot;&lt;/span&gt;+n+&lt;span class=&quot;code-quote&quot;&gt;&quot;&apos;&lt;/span&gt; and &apos;&quot;&lt;/span&gt;
            + myagg.n + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos;.&quot;&lt;/span&gt;);
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the code snippet above, the variables &quot;n&quot; and &quot;myagg.n&quot; refer to the same value (the n in nGrams). This value gets added to end of the partial nGrams list generated by each mapper. However, this value gets initialized during the map phase (iterate() method call). So if iterate() is never called, when the mapper resultset is empty, this value is never initialized to the &quot;n&quot; value from the query so defaults to java integer default of 0.&lt;/p&gt;

&lt;p&gt;The merge() method currently checks for null partial objects&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void merge(AggregationBuffer agg, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; partial) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; HiveException {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(partial == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Given the design, there is atleast one element is this partial buffer (the &quot;n&quot; value) so it may never be null. The merge() should be a no-op if the value of &quot;n&quot; is ZERO.&lt;/p&gt;

&lt;p&gt;I will upload a patch shortly.&lt;/p&gt;
</comment>
                            <comment id="14334371" author="ngangam" created="Tue, 24 Feb 2015 04:16:11 +0000"  >&lt;p&gt;The merge() method during the reduce phase of the ngram UDAF should be a NO-OP when the mapper returns an empty set. The value of ZERO returned in the list (one and only one item) is an indicator that the iterate() method was never called in that map job. So returning from merge() with no action.&lt;/p&gt;</comment>
                            <comment id="14334503" author="hiveqa" created="Tue, 24 Feb 2015 06:54:06 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12700330/HIVE-9755.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12700330/HIVE-9755.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 7566 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2853/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2853/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2853/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2853/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-2853/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-2853/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12700330 - PreCommit-HIVE-TRUNK-Build&lt;/p&gt;</comment>
                            <comment id="14334939" author="ngangam" created="Tue, 24 Feb 2015 14:43:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasadm&quot; class=&quot;user-hover&quot; rel=&quot;prasadm&quot;&gt;prasadm&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=szehon&quot; class=&quot;user-hover&quot; rel=&quot;szehon&quot;&gt;szehon&lt;/a&gt; Could you please review this? Thank you&lt;/p&gt;</comment>
                            <comment id="14335498" author="brocknoland" created="Tue, 24 Feb 2015 21:35:28 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14340528" author="brocknoland" created="Fri, 27 Feb 2015 18:35:36 +0000"  >&lt;p&gt;Thank you Naveen! I have committed this to trunk.&lt;/p&gt;</comment>
                            <comment id="14548935" author="sushanth" created="Mon, 18 May 2015 19:53:49 +0000"  >&lt;p&gt;This issue has been fixed and released as part of the 1.2.0 release. If you find an issue which seems to be related to this one, please create a new jira and link this one with new jira.&lt;/p&gt;</comment>
                            <comment id="14705359" author="wzheng" created="Thu, 20 Aug 2015 17:30:06 +0000"  >&lt;p&gt;Add unit test&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12700330" name="HIVE-9755.patch" size="1065" author="ngangam" created="Tue, 24 Feb 2015 04:16:11 +0000"/>
                            <attachment id="12751538" name="HIVE-9755.ut.patch" size="6757" author="wzheng" created="Thu, 20 Aug 2015 17:30:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 13 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i25xxj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>