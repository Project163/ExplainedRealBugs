<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:06:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-4103] Remove System.gc() call from the map-join local-task loop</title>
                <link>https://issues.apache.org/jira/browse/HIVE-4103</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;Hive&apos;s HashMapWrapper calls System.gc() twice within the HashMapWrapper::isAbort() which produces a significant slow-down during the loop.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2013-03-01 04:54:28 The gc calls took 677 ms
2013-03-01 04:54:28     Processing rows:        200000  Hashtable size: 199999  Memory usage:   62955432        rate:   0.033
2013-03-01 04:54:31 The gc calls took 956 ms
2013-03-01 04:54:31     Processing rows:        300000  Hashtable size: 299999  Memory usage:   90826656        rate:   0.048
2013-03-01 04:54:33 The gc calls took 967 ms
2013-03-01 04:54:33     Processing rows:        384160  Hashtable size: 384160  Memory usage:   114412712       rate:   0.06
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12634913">HIVE-4103</key>
            <summary>Remove System.gc() call from the map-join local-task loop</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gopalv">Gopal Vijayaraghavan</assignee>
                                    <reporter username="gopalv">Gopal Vijayaraghavan</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Mar 2013 21:53:07 +0000</created>
                <updated>Thu, 16 May 2013 21:10:45 +0000</updated>
                            <resolved>Sat, 20 Apr 2013 20:52:32 +0000</resolved>
                                                    <fixVersion>0.11.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13590983" author="gopalv" created="Fri, 1 Mar 2013 22:00:15 +0000"  >&lt;p&gt;Remove the thread-stopping System.gc() calls from isAbort()&lt;/p&gt;</comment>
                            <comment id="13590988" author="gopalv" created="Fri, 1 Mar 2013 22:01:51 +0000"  >&lt;p&gt;On a run, the difference was &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2013-03-01 04:57:21	Upload 1 File to: file:/tmp/root/hive_2013-03-01_16-56-53_785_1192800933446838868/-local-10002/HashTable-Stage-1/MapJoin-demographics-01--.hashtable File size: 18426794
2013-03-01 04:57:21	End of local task; Time Taken: 22.426 sec.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;versus, after-fix&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2013-03-01 04:56:26	Upload 1 File to: file:/tmp/root/hive_2013-03-01_16-56-01_539_5116929752955084952/-local-10002/HashTable-Stage-1/MapJoin-demographics-01--.hashtable File size: 18426794
2013-03-01 04:56:26	End of local task; Time Taken: 19.874 sec.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13611226" author="ashutoshc" created="Fri, 22 Mar 2013 20:55:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt; System.gc() calls were made to get better estimate of free memory which than is decided to kill task or not if its using too much memory. I don&apos;t think its safe to remove this call. As a downside, we may kill a local task thinking its using too much memory, whereas in reality, it could have gone on to completion.&lt;/p&gt;</comment>
                            <comment id="13611419" author="gopalv" created="Fri, 22 Mar 2013 23:25:38 +0000"  >&lt;p&gt;I&apos;m following some commonly repeated wisdom here &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://stackoverflow.com/questions/2414105/why-is-it-a-bad-practice-to-call-system-gc/2414120#2414120&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/2414105/why-is-it-a-bad-practice-to-call-system-gc/2414120#2414120&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;THe corner cases merely require -Xmx to be upped, but this slows down the queries by 8-10%.&lt;/p&gt;</comment>
                            <comment id="13611542" author="brocknoland" created="Sat, 23 Mar 2013 03:29:13 +0000"  >&lt;p&gt;Agreed it&apos;s a bad practice in general to call sys.gc(), but I think the issue here is that we are trying to decide if it&apos;s possible to do a map join out on the cluster therefore we need a good estimate of memory consumed? &lt;/p&gt;</comment>
                            <comment id="13635782" author="hagleitn" created="Thu, 18 Apr 2013 22:39:26 +0000"  >&lt;p&gt;I took some time to test out the two versions of the code. I ran a number of mapjoins ranging from small to at the limit and finally over the limit. In summary: Without the gc calls we overestimate the used memory very slightly. The biggest one I&apos;ve seen is ~1%. The errors btw always cause the estimates to be more conservative, never less. The performance benefit on the other hand is quite substantial: On that large run it went from 120s to 56s with Gopals patch. I think we should move forward with this.&lt;/p&gt;

&lt;p&gt;Largest run:&lt;/p&gt;

&lt;p&gt;With Patch:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-04-18 05:29:36     Starting to launch local task to process map join;      maximum memory = 1065484288
2013-04-18 05:29:42     Processing rows:        200000  Hashtable size: 199999  Memory usage:   108807528       rate:   0.102
2013-04-18 05:29:44     Processing rows:        300000  Hashtable size: 299999  Memory usage:   158575416       rate:   0.149
2013-04-18 05:29:46     Processing rows:        400000  Hashtable size: 399999  Memory usage:   211033848       rate:   0.198
2013-04-18 05:29:48     Processing rows:        500000  Hashtable size: 499999  Memory usage:   260673400       rate:   0.245
2013-04-18 05:29:50     Processing rows:        600000  Hashtable size: 599999  Memory usage:   310156256       rate:   0.291
2013-04-18 05:29:53     Processing rows:        700000  Hashtable size: 699999  Memory usage:   359750536       rate:   0.338
2013-04-18 05:29:54     Processing rows:        800000  Hashtable size: 799999  Memory usage:   417989768       rate:   0.392
2013-04-18 05:29:57     Processing rows:        900000  Hashtable size: 899999  Memory usage:   460568536       rate:   0.432
2013-04-18 05:29:58     Processing rows:        1000000 Hashtable size: 999999  Memory usage:   510475320       rate:   0.479
2013-04-18 05:30:01     Processing rows:        1100000 Hashtable size: 1099999 Memory usage:   559513584       rate:   0.525
2013-04-18 05:30:03     Processing rows:        1200000 Hashtable size: 1199999 Memory usage:   609277088       rate:   0.572
2013-04-18 05:30:06     Processing rows:        1300000 Hashtable size: 1299999 Memory usage:   659366968       rate:   0.619
2013-04-18 05:30:07     Processing rows:        1400000 Hashtable size: 1399999 Memory usage:   708744832       rate:   0.665
2013-04-18 05:30:08     Processing rows:        1500000 Hashtable size: 1499999 Memory usage:   758335688       rate:   0.712
2013-04-18 05:30:13     Processing rows:        1600000 Hashtable size: 1599999 Memory usage:   825625224       rate:   0.775
2013-04-18 05:30:14     Processing rows:        1646400 Hashtable size: 1646400 Memory usage:   848652056       rate:   0.796
2013-04-18 05:30:14     Dump the hashtable into file: file:/tmp/hrt_qa/hive_2013-04-18_17-29-31_517_1864473086199137375/-local-10002/HashTable-Stage-1/MapJoin-cd-11--.hashtable
2013-04-18 05:30:32     Upload 1 File to: file:/tmp/hrt_qa/hive_2013-04-18_17-29-31_517_1864473086199137375/-local-10002/HashTable-Stage-1/MapJoin-cd-11--.hashtable File size: 127593266
2013-04-18 05:30:32     End of local task; Time Taken: 56.264 sec.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Without patch:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-04-18 05:55:22     Starting to launch local task to process map join;      maximum memory = 1065484288
2013-04-18 05:55:29     Processing rows:        200000  Hashtable size: 199999  Memory usage:   108779608       rate:   0.102
2013-04-18 05:55:33     Processing rows:        300000  Hashtable size: 299999  Memory usage:   157203744       rate:   0.148
2013-04-18 05:55:37     Processing rows:        400000  Hashtable size: 399999  Memory usage:   208667552       rate:   0.196
2013-04-18 05:55:42     Processing rows:        500000  Hashtable size: 499999  Memory usage:   258126352       rate:   0.242
2013-04-18 05:55:46     Processing rows:        600000  Hashtable size: 599999  Memory usage:   307734104       rate:   0.289
2013-04-18 05:55:51     Processing rows:        700000  Hashtable size: 699999  Memory usage:   357043768       rate:   0.335
2013-04-18 05:55:57     Processing rows:        800000  Hashtable size: 799999  Memory usage:   415059928       rate:   0.39
2013-04-18 05:56:04     Processing rows:        900000  Hashtable size: 899999  Memory usage:   460135344       rate:   0.432
2013-04-18 05:56:10     Processing rows:        1000000 Hashtable size: 999999  Memory usage:   509690176       rate:   0.478
2013-04-18 05:56:18     Processing rows:        1100000 Hashtable size: 1099999 Memory usage:   559042448       rate:   0.525
2013-04-18 05:56:25     Processing rows:        1200000 Hashtable size: 1199999 Memory usage:   608652728       rate:   0.571
2013-04-18 05:56:33     Processing rows:        1300000 Hashtable size: 1299999 Memory usage:   657959872       rate:   0.618
2013-04-18 05:56:42     Processing rows:        1400000 Hashtable size: 1399999 Memory usage:   707441328       rate:   0.664
2013-04-18 05:56:51     Processing rows:        1500000 Hashtable size: 1499999 Memory usage:   756877400       rate:   0.71
2013-04-18 05:57:01     Processing rows:        1600000 Hashtable size: 1599999 Memory usage:   823254568       rate:   0.773
2013-04-18 05:57:12     Processing rows:        1646400 Hashtable size: 1646400 Memory usage:   837505640       rate:   0.786
2013-04-18 05:57:12     Dump the hashtable into file: file:/tmp/hrt_qa/hive_2013-04-18_17-55-16_725_2217141373925203269/-local-10002/HashTable-Stage-1/MapJoin-cd-01--.hashtable
2013-04-18 05:57:22     Upload 1 File to: file:/tmp/hrt_qa/hive_2013-04-18_17-55-16_725_2217141373925203269/-local-10002/HashTable-Stage-1/MapJoin-cd-01--.hashtable File size: 127593266
2013-04-18 05:57:22     End of local task; Time Taken: 120.19 sec.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Small run:&lt;/p&gt;

&lt;p&gt;without patch:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-04-18 05:08:06     Starting to launch local task to process map join;      maximum memory = 1065484288
2013-04-18 05:08:15     Processing rows:        200000  Hashtable size: 199999  Memory usage:   109063800       rate:   0.102
2013-04-18 05:08:18     Processing rows:        274400  Hashtable size: 274400  Memory usage:   144697408       rate:   0.136
2013-04-18 05:08:18     Dump the hashtable into file: file:/tmp/hrt_qa/hive_2013-04-18_17-08-02_486_1659630314838477132/-local-10002/HashTable-Stage-1/MapJoin-cd-51--.hashtable
2013-04-18 05:08:21     Upload 1 File to: file:/tmp/hrt_qa/hive_2013-04-18_17-08-02_486_1659630314838477132/-local-10002/HashTable-Stage-1/MapJoin-cd-51--.hashtable File size: 21263116
2013-04-18 05:08:21     End of local task; Time Taken: 14.35 sec.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;with fix:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-04-18 05:11:45     Starting to launch local task to process map join;      maximum memory = 1065484288
2013-04-18 05:11:52     Processing rows:        200000  Hashtable size: 199999  Memory usage:   109177944       rate:   0.102
2013-04-18 05:11:54     Processing rows:        274400  Hashtable size: 274400  Memory usage:   146485584       rate:   0.137
2013-04-18 05:11:54     Dump the hashtable into file: file:/tmp/hrt_qa/hive_2013-04-18_17-11-39_065_4048995808819270025/-local-10002/HashTable-Stage-1/MapJoin-cd-01--.hashtable
2013-04-18 05:11:57     Upload 1 File to: file:/tmp/hrt_qa/hive_2013-04-18_17-11-39_065_4048995808819270025/-local-10002/HashTable-Stage-1/MapJoin-cd-01--.hashtable File size: 21263116
2013-04-18 05:11:57     End of local task; Time Taken: 12.226 sec.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13637109" author="ashutoshc" created="Sat, 20 Apr 2013 03:46:10 +0000"  >&lt;p&gt;Thanks, Gunther for running experiments. Difference of 56 vs 120 seconds is quite substantial. I agree, we should move ahead with the patch. &lt;br/&gt;
+1&lt;/p&gt;</comment>
                            <comment id="13637358" author="ashutoshc" created="Sat, 20 Apr 2013 20:52:32 +0000"  >&lt;p&gt;Committed to trunk. Thanks, Gopal and Gunther!&lt;/p&gt;</comment>
                            <comment id="13637467" author="hudson" created="Sun, 21 Apr 2013 04:26:52 +0000"  >&lt;p&gt;Integrated in Hive-trunk-hadoop2 #168 (See &lt;a href=&quot;https://builds.apache.org/job/Hive-trunk-hadoop2/168/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hive-trunk-hadoop2/168/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-4103&quot; title=&quot;Remove System.gc() call from the map-join local-task loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-4103&quot;&gt;&lt;del&gt;HIVE-4103&lt;/del&gt;&lt;/a&gt; : Remove System.gc() call from the map-join local-task loop (Gopal V via Ashutosh Chauhan) (Revision 1470227)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
hashutosh : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1470227&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1470227&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/persistence/HashMapWrapper.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13637709" author="hudson" created="Mon, 22 Apr 2013 01:10:11 +0000"  >&lt;p&gt;Integrated in Hive-trunk-h0.21 #2073 (See &lt;a href=&quot;https://builds.apache.org/job/Hive-trunk-h0.21/2073/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hive-trunk-h0.21/2073/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-4103&quot; title=&quot;Remove System.gc() call from the map-join local-task loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-4103&quot;&gt;&lt;del&gt;HIVE-4103&lt;/del&gt;&lt;/a&gt; : Remove System.gc() call from the map-join local-task loop (Gopal V via Ashutosh Chauhan) (Revision 1470227)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
hashutosh : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1470227&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1470227&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/persistence/HashMapWrapper.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12571658" name="HIVE-4103.patch" size="624" author="gopalv" created="Fri, 1 Mar 2013 22:00:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>315406</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 31 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ifdj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>315750</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Remove System.gc() calls from HashMapWrapper::isAbort() to avoid slow-downs during local task of the map-join</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>