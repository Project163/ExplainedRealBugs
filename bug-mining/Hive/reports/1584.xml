<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:11:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-5474] drop table hangs when concurrency=true</title>
                <link>https://issues.apache.org/jira/browse/HIVE-5474</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;This is seen in hive 0.12 branch sequential test run. TestThriftHttpCLIService.testExecuteStatement&lt;/p&gt;


&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/job/Hive-branch-0.12-hadoop1/13/testReport/org.apache.hive.service.cli.thrift/TestThriftHttpCLIService/testExecuteStatement/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hive-branch-0.12-hadoop1/13/testReport/org.apache.hive.service.cli.thrift/TestThriftHttpCLIService/testExecuteStatement/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;stderr has &quot;FAILED: Error in acquiring locks: Locks on the underlying&lt;br/&gt;
objects cannot be acquired. retry after some time&quot;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12672551">HIVE-5474</key>
            <summary>drop table hangs when concurrency=true</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jdere">Jason Dere</assignee>
                                    <reporter username="thejas">Thejas Nair</reporter>
                        <labels>
                    </labels>
                <created>Sun, 6 Oct 2013 20:52:20 +0000</created>
                <updated>Mon, 14 Oct 2013 07:29:58 +0000</updated>
                            <resolved>Sun, 13 Oct 2013 16:15:33 +0000</resolved>
                                                    <fixVersion>0.13.0</fixVersion>
                                    <component>HiveServer2</component>
                    <component>Locking</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13787826" author="vgumashta" created="Sun, 6 Oct 2013 23:35:24 +0000"  >&lt;p&gt;This looks like a test only issue. I tried connecting with beeline in http mode (note: http currently works in auth: NOSASL and does not support doAs), and it works fine. &lt;/p&gt;

&lt;p&gt;In the tests, I&apos;m setting lock manager to embedded, but looks like the test run in the previous test case is not releasing the lock on the table. I tried running TestThriftBinaryCLIService and TestThriftHttpCLIService sequentially using the patch in: &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-4907&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;HIVE-4907&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;However, in my opinion, this should not be a blocker for 0.12.&lt;/p&gt;</comment>
                            <comment id="13787851" author="thejas" created="Mon, 7 Oct 2013 02:15:33 +0000"  >&lt;p&gt;I also tried running TestThriftHttpCLIService and TestThriftBinaryCLIService in isolation and the failure did not happen.&lt;br/&gt;
This is a problem caused by state left behind by previous test. I would not consider this to be a blocker for 0.12 release.&lt;/p&gt;</comment>
                            <comment id="13791137" author="jdere" created="Thu, 10 Oct 2013 03:09:06 +0000"  >&lt;p&gt;Digging around this one, looks like there may be an issue with the EmbeddedLockManager. The test is trying to run &quot;DROP TABLE test_exec_thrift&quot;, and is attempting to acquire the following locks from the EmbeddedLockManager:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SHARED, default/test_exec_thrift&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;SHARED, default&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;EXCLUSIVE, default/test_exec_thrift&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;SHARED, default&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;SHARED, default&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;After EmbeddedLockManager.sortLocks(), the locks are sorted and acquired in this order:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;SHARED, default&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;SHARED, default&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;SHARED, default&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;EXCLUSIVE, default/test_exec_thrift&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;SHARED, default/test_exec_thrift&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;The problem is that once the exclusive lock on test_exec_thrift is acquired, the EmbeddedLockManager is unable to get the shared lock on that table.&lt;br/&gt;
So I think the fix here is that the lock requests generated by Driver.acquireReadWriteLocks() should be de-duped, so that we fetch either a shared or exclusive lock, not both. Either that, or the lock managers need to be updated to allow multiple locks on the same object to succeed if it&apos;s from the same query. But I think the first solution would be more appropriate, and would be more in line with &lt;a href=&quot;https://cwiki.apache.org/confluence/display/Hive/Locking&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/Hive/Locking&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13791998" author="jdere" created="Thu, 10 Oct 2013 21:18:35 +0000"  >&lt;p&gt;Uploading patch v1.  Dedup the locks requested, preferring exclusive locks over shared locks.&lt;/p&gt;</comment>
                            <comment id="13792122" author="jdere" created="Thu, 10 Oct 2013 23:53:47 +0000"  >&lt;p&gt;patch v2 - adds q file test&lt;/p&gt;</comment>
                            <comment id="13793104" author="hiveqa" created="Fri, 11 Oct 2013 22:43:05 +0000"  >

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;Overall&lt;/font&gt;: +1 all checks pass&lt;/p&gt;

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12607918/HIVE-5474.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12607918/HIVE-5474.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 4396 tests passed&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/1110/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/1110/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/1110/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/1110/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13793111" author="ashutoshc" created="Fri, 11 Oct 2013 22:50:16 +0000"  >&lt;p&gt;Is it better to change List&amp;lt;HiveLockObj&amp;gt; to Set&amp;lt;HiveLockObj&amp;gt; ?&lt;/p&gt;</comment>
                            <comment id="13793133" author="jdere" created="Fri, 11 Oct 2013 23:27:06 +0000"  >&lt;p&gt;I don&apos;t think a set helps with the de-duping effort, if there is a shared lock request and exclusive lock request we want to make sure that the exclusive lock is the one that is kept. So either way we need extra logic to take care of that.&lt;/p&gt;</comment>
                            <comment id="13793154" author="ashutoshc" created="Sat, 12 Oct 2013 00:09:17 +0000"  >&lt;p&gt;Thats correct.. dedup logic would still be required.. but using set makes the intent clear that we cannot have duplicates which are possible in list.&lt;/p&gt;</comment>
                            <comment id="13793190" author="jdere" created="Sat, 12 Oct 2013 01:06:41 +0000"  >&lt;p&gt;Still disagree here, since the set is not actually helping here - you could insert both &lt;span class=&quot;error&quot;&gt;&amp;#91;EXCLUSIVE, default/test_exec_thrift&amp;#93;&lt;/span&gt; and &lt;span class=&quot;error&quot;&gt;&amp;#91;SHARED, default/test_exec_thrift&amp;#93;&lt;/span&gt; into the set because the two locks wouldn&apos;t be considere equivalent to each other.  And we&apos;d have to implement equals() and hashCode(), for something that isn&apos;t actually helping. &lt;br/&gt;
Also I think that having a Set here gives the sense that users do not have to worry about handling duplicates themselves, when in fact they do.&lt;/p&gt;</comment>
                            <comment id="13793225" author="ashutoshc" created="Sat, 12 Oct 2013 03:18:49 +0000"  >&lt;p&gt;Makes sense. +1&lt;/p&gt;</comment>
                            <comment id="13793694" author="ashutoshc" created="Sun, 13 Oct 2013 16:15:33 +0000"  >&lt;p&gt;Committed to trunk. Thanks, Jason!&lt;/p&gt;</comment>
                            <comment id="13793740" author="hudson" created="Sun, 13 Oct 2013 18:21:29 +0000"  >&lt;p&gt;FAILURE: Integrated in Hive-trunk-hadoop1-ptest #203 (See &lt;a href=&quot;https://builds.apache.org/job/Hive-trunk-hadoop1-ptest/203/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hive-trunk-hadoop1-ptest/203/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-5474&quot; title=&quot;drop table hangs when concurrency=true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-5474&quot;&gt;&lt;del&gt;HIVE-5474&lt;/del&gt;&lt;/a&gt; : drop table hangs when concurrency=true (Jason Dere via Ashutosh Chauhan) (hashutosh: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1531704&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1531704&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/Driver.java&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/org/apache/hadoop/hive/ql/TestDriver.java&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/queries/clientpositive/drop_with_concurrency.q&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/results/clientpositive/drop_with_concurrency.q.out&lt;/li&gt;
	&lt;li&gt;/hive/trunk/service/src/test/org/apache/hive/service/cli/thrift/ThriftCLIServiceTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13793770" author="hudson" created="Sun, 13 Oct 2013 20:01:49 +0000"  >&lt;p&gt;FAILURE: Integrated in Hive-trunk-h0.21 #2398 (See &lt;a href=&quot;https://builds.apache.org/job/Hive-trunk-h0.21/2398/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hive-trunk-h0.21/2398/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-5474&quot; title=&quot;drop table hangs when concurrency=true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-5474&quot;&gt;&lt;del&gt;HIVE-5474&lt;/del&gt;&lt;/a&gt; : drop table hangs when concurrency=true (Jason Dere via Ashutosh Chauhan) (hashutosh: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1531704&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1531704&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/Driver.java&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/org/apache/hadoop/hive/ql/TestDriver.java&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/queries/clientpositive/drop_with_concurrency.q&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/results/clientpositive/drop_with_concurrency.q.out&lt;/li&gt;
	&lt;li&gt;/hive/trunk/service/src/test/org/apache/hive/service/cli/thrift/ThriftCLIServiceTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13793807" author="hudson" created="Sun, 13 Oct 2013 22:16:06 +0000"  >&lt;p&gt;FAILURE: Integrated in Hive-trunk-hadoop2-ptest #138 (See &lt;a href=&quot;https://builds.apache.org/job/Hive-trunk-hadoop2-ptest/138/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hive-trunk-hadoop2-ptest/138/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-5474&quot; title=&quot;drop table hangs when concurrency=true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-5474&quot;&gt;&lt;del&gt;HIVE-5474&lt;/del&gt;&lt;/a&gt; : drop table hangs when concurrency=true (Jason Dere via Ashutosh Chauhan) (hashutosh: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1531704&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1531704&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/Driver.java&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/org/apache/hadoop/hive/ql/TestDriver.java&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/queries/clientpositive/drop_with_concurrency.q&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/results/clientpositive/drop_with_concurrency.q.out&lt;/li&gt;
	&lt;li&gt;/hive/trunk/service/src/test/org/apache/hive/service/cli/thrift/ThriftCLIServiceTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13793972" author="hudson" created="Mon, 14 Oct 2013 07:29:58 +0000"  >&lt;p&gt;ABORTED: Integrated in Hive-trunk-hadoop2 #500 (See &lt;a href=&quot;https://builds.apache.org/job/Hive-trunk-hadoop2/500/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hive-trunk-hadoop2/500/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-5474&quot; title=&quot;drop table hangs when concurrency=true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-5474&quot;&gt;&lt;del&gt;HIVE-5474&lt;/del&gt;&lt;/a&gt; : drop table hangs when concurrency=true (Jason Dere via Ashutosh Chauhan) (hashutosh: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1531704&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1531704&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/Driver.java&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/org/apache/hadoop/hive/ql/TestDriver.java&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/queries/clientpositive/drop_with_concurrency.q&lt;/li&gt;
	&lt;li&gt;/hive/trunk/ql/src/test/results/clientpositive/drop_with_concurrency.q.out&lt;/li&gt;
	&lt;li&gt;/hive/trunk/service/src/test/org/apache/hive/service/cli/thrift/ThriftCLIServiceTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12607890" name="HIVE-5474.1.patch" size="5149" author="jdere" created="Thu, 10 Oct 2013 21:18:35 +0000"/>
                            <attachment id="12607918" name="HIVE-5474.2.patch" size="6782" author="jdere" created="Thu, 10 Oct 2013 23:53:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>352174</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 6 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1opwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>352462</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>