<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:26:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-28530] Set files in thread safe manner in HiveSequenceFileInputFormat</title>
                <link>https://issues.apache.org/jira/browse/HIVE-28530</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;When running Hive load tests, we observed Beeline can fetch wrong query result which is from another one running at same time.  We ruled out Load Balancing issue, because it happened to a single HiveServer2.  And we found this issue only happens when &lt;b&gt;hive.query.result.cached.enabled is false.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;All test queries are in the same format as below: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select concat(&lt;span class=&quot;code-quote&quot;&gt;&apos;total record (test_$PID)=&apos;&lt;/span&gt;,count(*)) as count_record from t1t
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We randomized the query by replacing the $PID with the Beeline PID and the test driver ran 10 Beeline concurrently.  The table t1t is static and has a few rows. So now the test driver can check if the query result is equal to: total record (test_recon_mock_$PID)=2&lt;/p&gt;

&lt;p&gt;When query result cache is disabled,  we can see randomly query got a wrong result, and can always reproduced.  For example, below two queries were running in parallel:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
queryId=hive_20240701103742_ff1adb2d-e9eb-448d-990e-00ab371e9db6): select concat(&lt;span class=&quot;code-quote&quot;&gt;&apos;total record (test_21535)=&apos;&lt;/span&gt;,count(*)) as count_record from t1t

queryId=hive_20240701103742_9bdfff92-89e1-4bcd-88ea-bf73ba5fd93d): select concat(&lt;span class=&quot;code-quote&quot;&gt;&apos;total record (test_21566)=&apos;&lt;/span&gt;,count(*)) as count_record from t1t
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;While the second query is supposed to get below result:&lt;br/&gt;
&lt;b&gt;total record (test_21566)=2&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;But actually Beeline got below result:&lt;br/&gt;
&lt;b&gt;total record (test_21535)=2&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;There is no error in the HS2 log.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13592611">HIVE-28530</key>
            <summary>Set files in thread safe manner in HiveSequenceFileInputFormat</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sbadhya">Sourabh Badhya</assignee>
                                    <reporter username="ximz">Xiaomin Zhang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 19 Sep 2024 14:21:42 +0000</created>
                <updated>Tue, 29 Jul 2025 14:51:21 +0000</updated>
                            <resolved>Wed, 25 Sep 2024 16:10:14 +0000</resolved>
                                    <version>3.0.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>HiveServer2</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17883028" author="ximz" created="Thu, 19 Sep 2024 14:24:03 +0000"  >&lt;p&gt;Issue seems related to below jira:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-21279&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-21279&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In this jira, a new HiveSequenceFileInputFormat was introduced and it has a volatile field fileStatuses, which is referenced twice in the FetchOperator by getNextSplits() call, only when query.result.cache is disabled. Unfortunately this field access is not thread-safe because the HiveSequenceFileInputFormat object itself is actually a shared object. Due to this, there could be various failing scenarios such like:&lt;/p&gt;

&lt;p&gt;1) One thread set fileStatuses to null, another thread overrides it to its result files ==&amp;gt; getting a wrong result from another query&lt;/p&gt;

&lt;p&gt;2) One thread set fileStatuses to its result files, then another thread overrides it to null ==&amp;gt; getting empty result&lt;/p&gt;</comment>
                            <comment id="17884659" author="JIRAUSER287127" created="Wed, 25 Sep 2024 16:10:14 +0000"  >&lt;p&gt;Merged to master.&lt;br/&gt;
Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ximz&quot; class=&quot;user-hover&quot; rel=&quot;ximz&quot;&gt;ximz&lt;/a&gt; for the detailed repro and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkuzmenko&quot; class=&quot;user-hover&quot; rel=&quot;dkuzmenko&quot;&gt;dkuzmenko&lt;/a&gt; for the reviews.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13216108">HIVE-21279</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13597710">HIVE-28609</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 7 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ri74:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>