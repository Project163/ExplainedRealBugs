<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:20:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-25170] Data error in constant propagation caused by wrong colExprMap generated in SemanticAnalyzer</title>
                <link>https://issues.apache.org/jira/browse/HIVE-25170</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

SET hive.remove.orderby.in.subquery=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

EXPLAIN
SELECT constant_col, key, max(value)
FROM
(
  SELECT &lt;span class=&quot;code-quote&quot;&gt;&apos;constant&apos;&lt;/span&gt; as constant_col, key, value
  FROM src
  DISTRIBUTE BY constant_col, key
  SORT BY constant_col, key, value
) a
GROUP BY constant_col, key
LIMIT 10;

OK
Vertex dependency in root stage
Reducer 2 &amp;lt;- Map 1 (SIMPLE_EDGE)
Reducer 3 &amp;lt;- Reducer 2 (SIMPLE_EDGE)Stage-0
  Fetch Operator
    limit:10
    Stage-1
      Reducer 3
      File Output Operator [FS_10]
        Limit [LIM_9] (rows=1 width=368)
          &lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt; of rows:10
          Select Operator [SEL_8] (rows=1 width=368)
            Output:[&lt;span class=&quot;code-quote&quot;&gt;&quot;_col0&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;_col1&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;_col2&quot;&lt;/span&gt;]
            Group By Operator [GBY_7] (rows=1 width=368)
              Output:[&lt;span class=&quot;code-quote&quot;&gt;&quot;_col0&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;_col1&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;_col2&quot;&lt;/span&gt;],aggregations:[&lt;span class=&quot;code-quote&quot;&gt;&quot;max(VALUE._col0)&quot;&lt;/span&gt;],keys:&lt;span class=&quot;code-quote&quot;&gt;&apos;constant&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;constant&apos;&lt;/span&gt;
            &amp;lt;-Reducer 2 [SIMPLE_EDGE]
              SHUFFLE [RS_6]
                PartitionCols:&lt;span class=&quot;code-quote&quot;&gt;&apos;constant&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;constant&apos;&lt;/span&gt;
                Group By Operator [GBY_5] (rows=1 width=368)
                  Output:[&lt;span class=&quot;code-quote&quot;&gt;&quot;_col0&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;_col1&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;_col2&quot;&lt;/span&gt;],aggregations:[&lt;span class=&quot;code-quote&quot;&gt;&quot;max(_col2)&quot;&lt;/span&gt;],keys:&lt;span class=&quot;code-quote&quot;&gt;&apos;constant&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;constant&apos;&lt;/span&gt;
                  Select Operator [SEL_3] (rows=500 width=178)
                    Output:[&lt;span class=&quot;code-quote&quot;&gt;&quot;_col2&quot;&lt;/span&gt;]
                  &amp;lt;-Map 1 [SIMPLE_EDGE]
                    SHUFFLE [RS_2]
                      PartitionCols:&lt;span class=&quot;code-quote&quot;&gt;&apos;constant&apos;&lt;/span&gt;, _col1
                      Select Operator [SEL_1] (rows=500 width=178)
                        Output:[&lt;span class=&quot;code-quote&quot;&gt;&quot;_col1&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;_col2&quot;&lt;/span&gt;]
                        TableScan [TS_0] (rows=500 width=10)
                          src,src,Tbl:COMPLETE,Col:COMPLETE,Output:[&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Obviously, the PartitionCols in Reducer 2 is wrong. Instead of &apos;constant&apos;, &apos;constant&apos;, it should be &apos;constant&apos;, _col1&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;That&apos;s because after &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-13808&quot; title=&quot;Use constant expressions to backtrack when we create ReduceSink&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-13808&quot;&gt;&lt;del&gt;HIVE-13808&lt;/del&gt;&lt;/a&gt;,&#160; SemanticAnalyzer uses sortCols to generate the colExprMap structure in the key part, while the key columns are generated by newSortCols, leading to a column and expr mismatch when the constant column is not the trailing column in the key columns.&lt;/p&gt;

&lt;p&gt;Constant propagation optimizer uses this&#160;colExprMap and finds extra const expression in the mismatched map, resulting in this error.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In fact, colExprMap is used by multiple optimizers, which makes this quite a serious problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13380660">HIVE-25170</key>
            <summary>Data error in constant propagation caused by wrong colExprMap generated in SemanticAnalyzer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zhangweilst">Wei Zhang</assignee>
                                    <reporter username="zhangweilst">Wei Zhang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 27 May 2021 03:56:27 +0000</created>
                <updated>Wed, 24 May 2023 12:36:35 +0000</updated>
                            <resolved>Fri, 6 Aug 2021 13:27:51 +0000</resolved>
                                    <version>3.1.2</version>
                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                                    <component>Query Planning</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17354841" author="zhangweilst" created="Tue, 1 Jun 2021 06:23:52 +0000"  >&lt;p&gt;I&apos;ve fixated an patch for this issue in github. Can somebody help review the code? Thanks!&lt;/p&gt;</comment>
                            <comment id="17394762" author="kgyrtkirk" created="Fri, 6 Aug 2021 13:27:51 +0000"  >&lt;p&gt;merged into master. Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhangweilst&quot; class=&quot;user-hover&quot; rel=&quot;zhangweilst&quot;&gt;zhangweilst&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13366432">HIVE-24915</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 14 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0retk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>