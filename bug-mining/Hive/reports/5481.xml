<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 18:53:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HIVE-16427] Fix multi-insert query and write qtests</title>
                <link>https://issues.apache.org/jira/browse/HIVE-16427</link>
                <project id="12310843" key="HIVE">Hive</project>
                    <description>&lt;p&gt;On &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-16415&quot; title=&quot;Add tests covering single inserts of zero rows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-16415&quot;&gt;&lt;del&gt;HIVE-16415&lt;/del&gt;&lt;/a&gt;, it was found that the bug reported to be fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-14519&quot; title=&quot;Multi insert query bug&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-14519&quot;&gt;&lt;del&gt;HIVE-14519&lt;/del&gt;&lt;/a&gt; was not actually fixed.&lt;/p&gt;

&lt;p&gt;This task is to find the problem, fix it, and add qtests to verify no future regression.&lt;/p&gt;

&lt;p&gt;Specifically, the following query does not produce correct answers: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;From (select * from src) a
insert overwrite directory &lt;span class=&quot;code-quote&quot;&gt;&apos;/tmp/emp/dir1/&apos;&lt;/span&gt;
select key, value
insert overwrite directory &lt;span class=&quot;code-quote&quot;&gt;&apos;/tmp/emp/dir2/&apos;&lt;/span&gt;
select &lt;span class=&quot;code-quote&quot;&gt;&apos;header&apos;&lt;/span&gt;
limit 0
insert overwrite directory &lt;span class=&quot;code-quote&quot;&gt;&apos;/tmp/emp/dir3/&apos;&lt;/span&gt;
select key, value 
where key = 100;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This gives incorrect result in master. All dirs end up with 0 rows instead of just dir2.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13063622">HIVE-16427</key>
            <summary>Fix multi-insert query and write qtests</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ychena">Yongzhi Chen</assignee>
                                    <reporter username="poeppt">Thomas Poepping</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Apr 2017 20:44:02 +0000</created>
                <updated>Wed, 23 May 2018 00:00:50 +0000</updated>
                            <resolved>Wed, 19 Apr 2017 05:35:35 +0000</resolved>
                                                    <fixVersion>3.0.0</fixVersion>
                                    <component>Logical Optimizer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15968111" author="spena" created="Thu, 13 Apr 2017 19:19:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ychena&quot; class=&quot;user-hover&quot; rel=&quot;ychena&quot;&gt;ychena&lt;/a&gt; Seems the patch on &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-14519&quot; title=&quot;Multi insert query bug&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-14519&quot;&gt;&lt;del&gt;HIVE-14519&lt;/del&gt;&lt;/a&gt; fixed the issue partially. Here&apos;s another test case that is causing multi-insert query to fail.&lt;/p&gt;</comment>
                            <comment id="15968214" author="ychena" created="Thu, 13 Apr 2017 21:11:03 +0000"  >&lt;p&gt;Yes, it is a different case, &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-14519&quot; title=&quot;Multi insert query bug&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-14519&quot;&gt;&lt;del&gt;HIVE-14519&lt;/del&gt;&lt;/a&gt; fixed the case that null return caused by filter. This test case is the null value caused by limit statement.&lt;/p&gt;</comment>
                            <comment id="15968653" author="ychena" created="Fri, 14 Apr 2017 05:31:53 +0000"  >&lt;p&gt;Process the case for limit 0&lt;/p&gt;</comment>
                            <comment id="15968717" author="hiveqa" created="Fri, 14 Apr 2017 07:13:19 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12863423/HIVE-16427.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12863423/HIVE-16427.1.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 1 failed/errored test(s), 10574 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hive.beeline.TestBeeLineWithArgs.testQueryProgressParallel (batchId=217)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/4689/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/4689/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/4689/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/4689/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-4689/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-4689/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 1 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12863423 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15968951" author="ychena" created="Fri, 14 Apr 2017 12:15:34 +0000"  >&lt;p&gt;The failure is not related.&lt;/p&gt;</comment>
                            <comment id="15971295" author="ashutoshc" created="Mon, 17 Apr 2017 16:26:52 +0000"  >&lt;p&gt;Logic to determine if its a multi-insert query is not correct. It assumes its TS-SEL-LIM pipeline which is not necessarily true, you may have arbitrary number of operators between LIM and TS. You need to traverse the tree. Similar improvement needs to be made for where false case as well.&lt;/p&gt;</comment>
                            <comment id="15971357" author="ychena" created="Mon, 17 Apr 2017 17:17:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ashutoshc&quot; class=&quot;user-hover&quot; rel=&quot;ashutoshc&quot;&gt;ashutoshc&lt;/a&gt;, is it true that from TS to LIM0 (or the null Filter), if there are any branch between the two operations, the need to convertMetadataOnly will be false ?&lt;br/&gt;
For example:&lt;br/&gt;
TS -OP1-OP2-OP3-LIM0 will need to convertMetadataOnly,&lt;/p&gt;

&lt;p&gt;But following will not: &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TS-OP1-OP2-OP3-LIM0
        |
      OP4
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15971461" author="ashutoshc" created="Mon, 17 Apr 2017 18:34:32 +0000"  >&lt;p&gt;No. Imagine  a case where  OP4  and OP1 are RS and OP2 is Join. OP4 may have TS its parent as RS. That pipeline is essentially a join pipeline where this optimization is still valid. &lt;/p&gt;</comment>
                            <comment id="15971740" author="ychena" created="Mon, 17 Apr 2017 22:16:15 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ashutoshc&quot; class=&quot;user-hover&quot; rel=&quot;ashutoshc&quot;&gt;ashutoshc&lt;/a&gt;, I just attached patch2 to handle both cases:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TS-OP1-OP2-OP3-LIM0
          |
        OP4
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TS-OP1-OP2-OP3-LIM0
  |____|
         OP4
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The basic idea of the patch is: if all the streams from TS go into lim0/filterfalse, then the TS can be optimized with MetadataOnly&lt;/p&gt;</comment>
                            <comment id="15971788" author="hiveqa" created="Mon, 17 Apr 2017 23:03:14 +0000"  >

&lt;p&gt;Here are the results of testing the latest attachment:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12863691/HIVE-16427.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12863691/HIVE-16427.2.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;green&quot;&gt;SUCCESS:&lt;/font&gt; +1 due to 1 test(s) being added or modified.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;ERROR:&lt;/font&gt; -1 due to 4 failed/errored test(s), 10565 tests executed&lt;br/&gt;
&lt;b&gt;Failed tests:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.hadoop.hive.cli.TestBlobstoreCliDriver.testCliDriver[insert_overwrite_table] (batchId=237)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_order_null] (batchId=27)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=143)
org.apache.hadoop.hive.cli.TestSparkCliDriver.org.apache.hadoop.hive.cli.TestSparkCliDriver (batchId=98)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/4713/testReport&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/4713/testReport&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HIVE-Build/4713/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HIVE-Build/4713/console&lt;/a&gt;&lt;br/&gt;
Test logs: &lt;a href=&quot;http://104.198.109.242/logs/PreCommit-HIVE-Build-4713/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://104.198.109.242/logs/PreCommit-HIVE-Build-4713/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Messages:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;

&lt;p&gt;ATTACHMENT ID: 12863691 - PreCommit-HIVE-Build&lt;/p&gt;</comment>
                            <comment id="15971802" author="ashutoshc" created="Mon, 17 Apr 2017 23:15:31 +0000"  >&lt;p&gt;Patch looks good. Couple of stylistic improvements:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Can you rename canSkipData() to isNullOpPresentInAllBranches() ?&lt;/li&gt;
	&lt;li&gt;Also, add a comment  for method something like following : {{ We need to make sure that Null Operator (LIM or FIL) is present in all branches of multi-insert query before applying the optimization. This method does full tree traversal starting from TS and will return true only if it finds target Null operator on each branch }} Add/edit comment as you find appropriate.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15972570" author="ychena" created="Tue, 18 Apr 2017 12:19:57 +0000"  >&lt;p&gt;The failures are not related.&lt;br/&gt;
Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ashutoshc&quot; class=&quot;user-hover&quot; rel=&quot;ashutoshc&quot;&gt;ashutoshc&lt;/a&gt; for the review, attached patch 3 addresses the issues. &lt;/p&gt;</comment>
                            <comment id="15973410" author="ashutoshc" created="Tue, 18 Apr 2017 20:21:19 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15974106" author="ashutoshc" created="Wed, 19 Apr 2017 05:35:35 +0000"  >&lt;p&gt;Pushed to master. Thanks, Yongzhi!&lt;/p&gt;</comment>
                            <comment id="16486475" author="vgarg" created="Wed, 23 May 2018 00:00:50 +0000"  >&lt;p&gt;Hive 3.0.0 has been released so closing this jira.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12996689">HIVE-14519</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12863423" name="HIVE-16427.1.patch" size="4443" author="ychena" created="Fri, 14 Apr 2017 05:31:53 +0000"/>
                            <attachment id="12863691" name="HIVE-16427.2.patch" size="7733" author="ychena" created="Mon, 17 Apr 2017 22:06:45 +0000"/>
                            <attachment id="12863812" name="HIVE-16427.3.patch" size="8063" author="ychena" created="Tue, 18 Apr 2017 12:19:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3dk5z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>