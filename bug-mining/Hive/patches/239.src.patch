diff --git a/CHANGES.txt b/CHANGES.txt
index be3fd89997..5d4e69f942 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -65,6 +65,9 @@ Trunk -  Unreleased
     HIVE-780. Better error messages for wrong argument lengths in UDAFs
     (Zheng Shao via namit)
 
+    HIVE-790. racce conditions with script and union operators
+    (Ning Zhang via namit)
+
 Release 0.4.0 -  Unreleased
 
   INCOMPATIBLE CHANGES
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java b/ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java
index 4613ad6a76..86cca49851 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java
@@ -565,9 +565,8 @@ protected void checkAndGenObject() throws HiveException {
    * All done
    * 
    */
-  public void close(boolean abort) throws HiveException {
+  public void closeOp(boolean abort) throws HiveException {
     LOG.trace("Join Op close");
-    super.close(abort);
   }
 
   @Override
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/exec/FileSinkOperator.java b/ql/src/java/org/apache/hadoop/hive/ql/exec/FileSinkOperator.java
index 2f774ca218..69cf719eeb 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/exec/FileSinkOperator.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/exec/FileSinkOperator.java
@@ -183,18 +183,8 @@ public void processOp(Object row, int tag) throws HiveException {
   }
 
   @Override
-  public void close(boolean abort) throws HiveException {
+  public void closeOp(boolean abort) throws HiveException {
 
-    if (state == State.CLOSE) 
-      return;
-
-    // Since close of super class is not invoked, update counters
-    if (counterNameToEnum != null) {
-      incrCounter(numInputRowsCntr, inputRows);
-      incrCounter(numOutputRowsCntr, outputRows);
-      incrCounter(timeTakenCntr, totalTime);
-    }
-    state = State.CLOSE;
     if (!abort) {
       if (outWriter != null) {
         try {
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java b/ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java
index 1d56b9f0bd..b7c88136fa 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java
@@ -701,7 +701,7 @@ protected void forward(ArrayList<Object> keys, AggregationBuffer[] aggs) throws
    * We need to forward all the aggregations to children.
    * 
    */
-  public void close(boolean abort) throws HiveException {
+  public void closeOp(boolean abort) throws HiveException {
     if (!abort) {
       try {
         // If there is no grouping key and no row came to this operator
@@ -750,7 +750,6 @@ else if (aggregations != null) {
         throw new HiveException(e);
       }
     }
-    super.close(abort);
   }
 
   // Group by contains the columns needed - no need to aggregate from children
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/exec/MapJoinOperator.java b/ql/src/java/org/apache/hadoop/hive/ql/exec/MapJoinOperator.java
index b7aedc2612..9df3cd664c 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/exec/MapJoinOperator.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/exec/MapJoinOperator.java
@@ -322,11 +322,10 @@ public String getName() {
     return "MAPJOIN";
   }
   
-  public void close(boolean abort) throws HiveException {
+  public void closeOp(boolean abort) throws HiveException {
     for (File hTbl : hTables) {
       deleteDir(hTbl);
     }
-    super.close(abort);
   }
   
   private void deleteDir(File dir) {
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java b/ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java
index 9b47d03cbd..320b41c1ce 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java
@@ -63,6 +63,8 @@ public static enum Counter {DESERIALIZE_ERRORS}
   transient private boolean isPartitioned;
   private Map<MapInputPath, MapOpCtx> opCtxMap;
   
+  private ArrayList<Operator<? extends Serializable>> extraChildrenToClose = null;
+  
   private static class MapInputPath {
     String path;
     String alias;
@@ -280,15 +282,36 @@ public void setChildren(Configuration hconf) throws HiveException {
   public void initializeOp(Configuration hconf) throws HiveException {
     // set that parent initialization is done and call initialize on children
     state = State.INIT;
+    List<Operator<? extends Serializable>> children = getChildOperators();
+
     for (Entry<MapInputPath, MapOpCtx> entry : opCtxMap.entrySet()) {
       // Add alias, table name, and partitions to hadoop conf so that their children will
       // inherit these
       HiveConf.setVar(hconf, HiveConf.ConfVars.HIVETABLENAME, entry.getValue().tableName);
       HiveConf.setVar(hconf, HiveConf.ConfVars.HIVEPARTITIONNAME, entry.getValue().partName);
       Operator<? extends Serializable> op = entry.getKey().op;
+      
+      // op is not in the children list, so need to remember it and close it afterwards
+      if ( children.indexOf(op) == -1 ) {
+        if ( extraChildrenToClose == null ) {
+          extraChildrenToClose = new ArrayList<Operator<? extends Serializable>>();
+        }
+        extraChildrenToClose.add(op);
+      }
       op.initialize(hconf, new ObjectInspector[]{entry.getValue().getRowObjectInspector()});
     }
   }
+  
+  /**
+   * close extra child operators that are initialized but are not executed.
+   */
+  public void closeOp(boolean abort) throws HiveException {
+    if ( extraChildrenToClose != null ) {
+      for (Operator<? extends Serializable> op : extraChildrenToClose) {
+        op.close(abort);
+      }
+    }
+  }
 
   public void process(Writable value) throws HiveException {
     try {
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/exec/Operator.java b/ql/src/java/org/apache/hadoop/hive/ql/exec/Operator.java
index a48be347d2..d3049e6bb0 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/exec/Operator.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/exec/Operator.java
@@ -73,12 +73,20 @@ public abstract class Operator <T extends Serializable> implements Serializable,
   
 
   private static int seqId;
-
+  
   // It can be optimized later so that an operator operator (init/close) is performed
   // only after that operation has been performed on all the parents. This will require
   // initializing the whole tree in all the mappers (which might be required for mappers
   // spanning multiple files anyway, in future)
-  public static enum State { UNINIT, INIT, CLOSE };
+  public static enum State { 
+    UNINIT,   // initialize() has not been called
+    INIT,     // initialize() has been called and close() has not been called,
+              // or close() has been called but one of its parent is not closed.
+    CLOSE     // all its parents operators are in state CLOSE and called close() 
+              // to children. Note: close() being called and its state being CLOSE is
+              // difference since close() could be called but state is not CLOSE if 
+              // one of its parent is not in state CLOSE..
+  };
   transient protected State state = State.UNINIT;
 
   static {
@@ -130,7 +138,7 @@ public void setParentOperators(List<Operator<? extends Serializable>> parentOper
   public List<Operator<? extends Serializable>> getParentOperators() {
     return parentOperators;
   }
-
+  
   protected T conf;
   protected boolean done;
 
@@ -305,6 +313,7 @@ public void initialize(Configuration hconf, ObjectInspector[] inputOIs) throws H
     }
     // derived classes can set this to different object if needed
     outputObjInspector = inputObjInspectors[0];
+    
     initializeOp(hconf);
     LOG.info("Initialization Done " + id + " " + getName());
   }
@@ -394,10 +403,35 @@ public void endGroup() throws HiveException {
     LOG.debug("End group Done");
   }
 
+  private boolean allInitializedParentsAreClosed() {
+    if (parentOperators != null) {
+      for(Operator<? extends Serializable> parent: parentOperators) {
+        if (!(parent.state == State.CLOSE ||
+              parent.state == State.UNINIT)) {
+          return false;
+        }
+      }
+    }
+    return true;
+  }
+  
+  // This close() function does not need to be synchronized
+  // since it is called by its parents' main thread, so no
+  // more than 1 thread should call this close() function.
   public void close(boolean abort) throws HiveException {
+
     if (state == State.CLOSE) 
       return;
 
+    // check if all parents are finished
+    if (!allInitializedParentsAreClosed()) 
+      return;
+    
+    // set state as CLOSE as long as all parents are closed
+    // state == CLOSE doesn't mean all children are also in state CLOSE
+    state = State.CLOSE;
+    LOG.info(id + " finished. closing... ");
+    
     if (counterNameToEnum != null) {
       incrCounter(numInputRowsCntr, inputRows);
       incrCounter(numOutputRowsCntr, outputRows);
@@ -406,6 +440,9 @@ public void close(boolean abort) throws HiveException {
     
     LOG.info(id + " forwarded " + cntr + " rows");
 
+    // call the operator specific close routine
+    closeOp(abort);
+
     try {
       logStats();
       if(childOperators == null)
@@ -414,14 +451,22 @@ public void close(boolean abort) throws HiveException {
       for(Operator<? extends Serializable> op: childOperators) {
         op.close(abort);
       }
-      state = State.CLOSE;
 
-      LOG.info("Close done");
+      LOG.info(id + " Close done");
     } catch (HiveException e) {
       e.printStackTrace();
       throw e;
     }
   }
+  
+  /**
+   * Operator specific close routine. Operators which inherents this
+   * class should overwrite this funtion for their specific cleanup
+   * routine.
+   */
+  protected void closeOp(boolean abort) throws HiveException {
+  }
+
 
   /**
    * Unlike other operator interfaces which are called from map or reduce task,
@@ -851,6 +896,4 @@ public HashMap<String, ProgressCounter> getCounterNameToEnum() {
   public void setCounterNameToEnum(HashMap<String, ProgressCounter> counterNameToEnum) {
     this.counterNameToEnum = counterNameToEnum;
   }
-
-
 }
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/exec/UnionOperator.java b/ql/src/java/org/apache/hadoop/hive/ql/exec/UnionOperator.java
index 80013799d2..afa04dda8f 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/exec/UnionOperator.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/exec/UnionOperator.java
@@ -110,21 +110,21 @@ protected void initializeOp(Configuration hconf) throws HiveException {
   }
   
   @Override
-  public void processOp(Object row, int tag) throws HiveException {
+  public synchronized void processOp(Object row, int tag) throws HiveException {
 
     StructObjectInspector soi = parentObjInspectors[tag];
-      List<? extends StructField> fields = parentFields[tag];
+    List<? extends StructField> fields = parentFields[tag];
 
-      if (needsTransform[tag]) {
-        for (int c = 0; c < fields.size(); c++) {
-          outputRow.set(c, columnTypeResolvers[c].convertIfNecessary(
-              soi.getStructFieldData(row, fields.get(c)),
-              fields.get(c).getFieldObjectInspector()));
-        }
-        forward(outputRow, outputObjInspector);
-      } else {
-        forward(row, inputObjInspectors[tag]);
+    if (needsTransform[tag]) {
+      for (int c = 0; c < fields.size(); c++) {
+        outputRow.set(c, columnTypeResolvers[c].convertIfNecessary(
+                                     soi.getStructFieldData(row, fields.get(c)),
+                                     fields.get(c).getFieldObjectInspector()));
       }
+      forward(outputRow, outputObjInspector);
+    } else {
+      forward(row, inputObjInspectors[tag]);
+    }
   }
 
   /**
diff --git a/ql/src/test/queries/clientpositive/union_script.q b/ql/src/test/queries/clientpositive/union_script.q
new file mode 100644
index 0000000000..df35859f59
--- /dev/null
+++ b/ql/src/test/queries/clientpositive/union_script.q
@@ -0,0 +1,7 @@
+select * from (
+  select transform(key) using 'cat' as cola from src)s order by cola;
+
+select * from (
+  select transform(key) using 'cat' as cola from src
+  union all
+  select transform(key) using 'cat' as cola from src) s order by cola;
diff --git a/ql/src/test/results/clientpositive/union_script.q.out b/ql/src/test/results/clientpositive/union_script.q.out
new file mode 100644
index 0000000000..f648fa8e4c
--- /dev/null
+++ b/ql/src/test/results/clientpositive/union_script.q.out
@@ -0,0 +1,1510 @@
+query: select * from (
+  select transform(key) using 'cat' as cola from src)s order by cola
+Input: default/src
+Output: file:/data/users/nzhang/work/790/790-trunk-apache-hive/build/ql/tmp/1290779299/10000
+0
+0
+0
+10
+100
+100
+103
+103
+104
+104
+105
+11
+111
+113
+113
+114
+116
+118
+118
+119
+119
+119
+12
+12
+120
+120
+125
+125
+126
+128
+128
+128
+129
+129
+131
+133
+134
+134
+136
+137
+137
+138
+138
+138
+138
+143
+145
+146
+146
+149
+149
+15
+15
+150
+152
+152
+153
+155
+156
+157
+158
+160
+162
+163
+164
+164
+165
+165
+166
+167
+167
+167
+168
+169
+169
+169
+169
+17
+170
+172
+172
+174
+174
+175
+175
+176
+176
+177
+178
+179
+179
+18
+18
+180
+181
+183
+186
+187
+187
+187
+189
+19
+190
+191
+191
+192
+193
+193
+193
+194
+195
+195
+196
+197
+197
+199
+199
+199
+2
+20
+200
+200
+201
+202
+203
+203
+205
+205
+207
+207
+208
+208
+208
+209
+209
+213
+213
+214
+216
+216
+217
+217
+218
+219
+219
+221
+221
+222
+223
+223
+224
+224
+226
+228
+229
+229
+230
+230
+230
+230
+230
+233
+233
+235
+237
+237
+238
+238
+239
+239
+24
+24
+241
+242
+242
+244
+247
+248
+249
+252
+255
+255
+256
+256
+257
+258
+26
+26
+260
+262
+263
+265
+265
+266
+27
+272
+272
+273
+273
+273
+274
+275
+277
+277
+277
+277
+278
+278
+28
+280
+280
+281
+281
+282
+282
+283
+284
+285
+286
+287
+288
+288
+289
+291
+292
+296
+298
+298
+298
+30
+302
+305
+306
+307
+307
+308
+309
+309
+310
+311
+311
+311
+315
+316
+316
+316
+317
+317
+318
+318
+318
+321
+321
+322
+322
+323
+325
+325
+327
+327
+327
+33
+331
+331
+332
+333
+333
+335
+336
+338
+339
+34
+341
+342
+342
+344
+344
+345
+348
+348
+348
+348
+348
+35
+35
+35
+351
+353
+353
+356
+360
+362
+364
+365
+366
+367
+367
+368
+369
+369
+369
+37
+37
+373
+374
+375
+377
+378
+379
+382
+382
+384
+384
+384
+386
+389
+392
+393
+394
+395
+395
+396
+396
+396
+397
+397
+399
+399
+4
+400
+401
+401
+401
+401
+401
+402
+403
+403
+403
+404
+404
+406
+406
+406
+406
+407
+409
+409
+409
+41
+411
+413
+413
+414
+414
+417
+417
+417
+418
+419
+42
+42
+421
+424
+424
+427
+429
+429
+43
+430
+430
+430
+431
+431
+431
+432
+435
+436
+437
+438
+438
+438
+439
+439
+44
+443
+444
+446
+448
+449
+452
+453
+454
+454
+454
+455
+457
+458
+458
+459
+459
+460
+462
+462
+463
+463
+466
+466
+466
+467
+468
+468
+468
+468
+469
+469
+469
+469
+469
+47
+470
+472
+475
+477
+478
+478
+479
+480
+480
+480
+481
+482
+483
+484
+485
+487
+489
+489
+489
+489
+490
+491
+492
+492
+493
+494
+495
+496
+497
+498
+498
+498
+5
+5
+5
+51
+51
+53
+54
+57
+58
+58
+64
+65
+66
+67
+67
+69
+70
+70
+70
+72
+72
+74
+76
+76
+77
+78
+8
+80
+82
+83
+83
+84
+84
+85
+86
+87
+9
+90
+90
+90
+92
+95
+95
+96
+97
+97
+98
+98
+query: select * from (
+  select transform(key) using 'cat' as cola from src
+  union all
+  select transform(key) using 'cat' as cola from src) s order by cola
+Input: default/src
+Output: file:/data/users/nzhang/work/790/790-trunk-apache-hive/build/ql/tmp/1729338552/10000
+0
+0
+0
+0
+0
+0
+10
+10
+100
+100
+100
+100
+103
+103
+103
+103
+104
+104
+104
+104
+105
+105
+11
+11
+111
+111
+113
+113
+113
+113
+114
+114
+116
+116
+118
+118
+118
+118
+119
+119
+119
+119
+119
+119
+12
+12
+12
+12
+120
+120
+120
+120
+125
+125
+125
+125
+126
+126
+128
+128
+128
+128
+128
+128
+129
+129
+129
+129
+131
+131
+133
+133
+134
+134
+134
+134
+136
+136
+137
+137
+137
+137
+138
+138
+138
+138
+138
+138
+138
+138
+143
+143
+145
+145
+146
+146
+146
+146
+149
+149
+149
+149
+15
+15
+15
+15
+150
+150
+152
+152
+152
+152
+153
+153
+155
+155
+156
+156
+157
+157
+158
+158
+160
+160
+162
+162
+163
+163
+164
+164
+164
+164
+165
+165
+165
+165
+166
+166
+167
+167
+167
+167
+167
+167
+168
+168
+169
+169
+169
+169
+169
+169
+169
+169
+17
+17
+170
+170
+172
+172
+172
+172
+174
+174
+174
+174
+175
+175
+175
+175
+176
+176
+176
+176
+177
+177
+178
+178
+179
+179
+179
+179
+18
+18
+18
+18
+180
+180
+181
+181
+183
+183
+186
+186
+187
+187
+187
+187
+187
+187
+189
+189
+19
+19
+190
+190
+191
+191
+191
+191
+192
+192
+193
+193
+193
+193
+193
+193
+194
+194
+195
+195
+195
+195
+196
+196
+197
+197
+197
+197
+199
+199
+199
+199
+199
+199
+2
+2
+20
+20
+200
+200
+200
+200
+201
+201
+202
+202
+203
+203
+203
+203
+205
+205
+205
+205
+207
+207
+207
+207
+208
+208
+208
+208
+208
+208
+209
+209
+209
+209
+213
+213
+213
+213
+214
+214
+216
+216
+216
+216
+217
+217
+217
+217
+218
+218
+219
+219
+219
+219
+221
+221
+221
+221
+222
+222
+223
+223
+223
+223
+224
+224
+224
+224
+226
+226
+228
+228
+229
+229
+229
+229
+230
+230
+230
+230
+230
+230
+230
+230
+230
+230
+233
+233
+233
+233
+235
+235
+237
+237
+237
+237
+238
+238
+238
+238
+239
+239
+239
+239
+24
+24
+24
+24
+241
+241
+242
+242
+242
+242
+244
+244
+247
+247
+248
+248
+249
+249
+252
+252
+255
+255
+255
+255
+256
+256
+256
+256
+257
+257
+258
+258
+26
+26
+26
+26
+260
+260
+262
+262
+263
+263
+265
+265
+265
+265
+266
+266
+27
+27
+272
+272
+272
+272
+273
+273
+273
+273
+273
+273
+274
+274
+275
+275
+277
+277
+277
+277
+277
+277
+277
+277
+278
+278
+278
+278
+28
+28
+280
+280
+280
+280
+281
+281
+281
+281
+282
+282
+282
+282
+283
+283
+284
+284
+285
+285
+286
+286
+287
+287
+288
+288
+288
+288
+289
+289
+291
+291
+292
+292
+296
+296
+298
+298
+298
+298
+298
+298
+30
+30
+302
+302
+305
+305
+306
+306
+307
+307
+307
+307
+308
+308
+309
+309
+309
+309
+310
+310
+311
+311
+311
+311
+311
+311
+315
+315
+316
+316
+316
+316
+316
+316
+317
+317
+317
+317
+318
+318
+318
+318
+318
+318
+321
+321
+321
+321
+322
+322
+322
+322
+323
+323
+325
+325
+325
+325
+327
+327
+327
+327
+327
+327
+33
+33
+331
+331
+331
+331
+332
+332
+333
+333
+333
+333
+335
+335
+336
+336
+338
+338
+339
+339
+34
+34
+341
+341
+342
+342
+342
+342
+344
+344
+344
+344
+345
+345
+348
+348
+348
+348
+348
+348
+348
+348
+348
+348
+35
+35
+35
+35
+35
+35
+351
+351
+353
+353
+353
+353
+356
+356
+360
+360
+362
+362
+364
+364
+365
+365
+366
+366
+367
+367
+367
+367
+368
+368
+369
+369
+369
+369
+369
+369
+37
+37
+37
+37
+373
+373
+374
+374
+375
+375
+377
+377
+378
+378
+379
+379
+382
+382
+382
+382
+384
+384
+384
+384
+384
+384
+386
+386
+389
+389
+392
+392
+393
+393
+394
+394
+395
+395
+395
+395
+396
+396
+396
+396
+396
+396
+397
+397
+397
+397
+399
+399
+399
+399
+4
+4
+400
+400
+401
+401
+401
+401
+401
+401
+401
+401
+401
+401
+402
+402
+403
+403
+403
+403
+403
+403
+404
+404
+404
+404
+406
+406
+406
+406
+406
+406
+406
+406
+407
+407
+409
+409
+409
+409
+409
+409
+41
+41
+411
+411
+413
+413
+413
+413
+414
+414
+414
+414
+417
+417
+417
+417
+417
+417
+418
+418
+419
+419
+42
+42
+42
+42
+421
+421
+424
+424
+424
+424
+427
+427
+429
+429
+429
+429
+43
+43
+430
+430
+430
+430
+430
+430
+431
+431
+431
+431
+431
+431
+432
+432
+435
+435
+436
+436
+437
+437
+438
+438
+438
+438
+438
+438
+439
+439
+439
+439
+44
+44
+443
+443
+444
+444
+446
+446
+448
+448
+449
+449
+452
+452
+453
+453
+454
+454
+454
+454
+454
+454
+455
+455
+457
+457
+458
+458
+458
+458
+459
+459
+459
+459
+460
+460
+462
+462
+462
+462
+463
+463
+463
+463
+466
+466
+466
+466
+466
+466
+467
+467
+468
+468
+468
+468
+468
+468
+468
+468
+469
+469
+469
+469
+469
+469
+469
+469
+469
+469
+47
+47
+470
+470
+472
+472
+475
+475
+477
+477
+478
+478
+478
+478
+479
+479
+480
+480
+480
+480
+480
+480
+481
+481
+482
+482
+483
+483
+484
+484
+485
+485
+487
+487
+489
+489
+489
+489
+489
+489
+489
+489
+490
+490
+491
+491
+492
+492
+492
+492
+493
+493
+494
+494
+495
+495
+496
+496
+497
+497
+498
+498
+498
+498
+498
+498
+5
+5
+5
+5
+5
+5
+51
+51
+51
+51
+53
+53
+54
+54
+57
+57
+58
+58
+58
+58
+64
+64
+65
+65
+66
+66
+67
+67
+67
+67
+69
+69
+70
+70
+70
+70
+70
+70
+72
+72
+72
+72
+74
+74
+76
+76
+76
+76
+77
+77
+78
+78
+8
+8
+80
+80
+82
+82
+83
+83
+83
+83
+84
+84
+84
+84
+85
+85
+86
+86
+87
+87
+9
+9
+90
+90
+90
+90
+90
+90
+92
+92
+95
+95
+95
+95
+96
+96
+97
+97
+97
+97
+98
+98
+98
+98
