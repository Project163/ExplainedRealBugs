diff --git a/CHANGES.txt b/CHANGES.txt
index d5928229ad..85b42e89b6 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -142,6 +142,9 @@ Release 0.2.0 - Unreleased
 
   BUG FIXES
 
+    HIVE-340. Fixed null pointer exception with nulls in map-side aggregation.
+    (Namit Jain via zshao)
+
     HIVE-308. UNION ALL: FileSinkOperator now adds files in case the target
     exists. (zshao)
 
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java b/ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java
index a692c59d8c..7f7b0f422b 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java
@@ -516,7 +516,9 @@ private boolean shouldBeFlushed(ArrayList<Object> newKeys) {
     if ((numEntriesHashTable == 0) || ((numEntries % NUMROWSESTIMATESIZE) == 0)) {
       for (Integer pos : keyPositionsSize) {
         Object key = newKeys.get(pos.intValue());
-        totalVariableSize += ((String)key).length();
+        // Ignore nulls
+        if (key != null)
+          totalVariableSize += ((String)key).length();
       }
 
       UDAFEvaluator[] aggs = null;
