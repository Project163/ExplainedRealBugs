diff --git a/build-common.xml b/build-common.xml
index 5ffd960c75..070303ed7e 100644
--- a/build-common.xml
+++ b/build-common.xml
@@ -91,11 +91,15 @@
 
       <!-- Include build/dist/lib on the classpath before Ivy and exclude hive jars from Ivy to make sure we get the local changes when we test Hive -->
       <fileset dir="${build.dir.hive}/dist/lib" includes="*.jar" erroronmissingdir="false" excludes="**/hive_contrib*.jar,**/hive-contrib*.jar,**/lib*.jar"/>
-      <fileset dir="${hive.root}/build/ivy/lib/test" includes="*.jar" erroronmissingdir="false" excludes="**/hive_*.jar,**/hive-*.jar"/>
-      <fileset dir="${hive.root}/build/ivy/lib/default" includes="*.jar" erroronmissingdir="false" excludes="**/hive_*.jar,**/hive-*.jar" />
       <fileset dir="${hive.root}/testlibs" includes="*.jar"/>
-      <fileset dir="${hive.root}/build/ivy/lib/hadoop0.${hadoop.mr.rev}.shim" includes="*.jar" />
+      <fileset dir="${build.ivy.lib.dir}/hadoop0.${hadoop.mr.rev}.shim" includes="*.jar" erroronmissingdir="false" />
       <pathelement location="${build.classes}" />
+
+      <!-- we strip out hadoop jars present in places other than the hadoop shimmed dir-->
+      <fileset dir="${hive.root}/build/ivy/lib/test" includes="*.jar" erroronmissingdir="false"
+               excludes="**/hive_*.jar,**/hive-*.jar,**/hadoop-*.jar"/>
+      <fileset dir="${hive.root}/build/ivy/lib/default" includes="*.jar" erroronmissingdir="false"
+               excludes="**/hive_*.jar,**/hive-*.jar,**/hadoop-*.jar" />
     </distinctelementsclasspath>
   </target>
 
@@ -176,7 +180,9 @@
     <pathelement location="${build.dir.hive}/classes"/>
     <fileset dir="${build.dir.hive}" includes="*/*.jar"/>
     <fileset dir="${hive.root}/lib" includes="*.jar"/>
+    <fileset dir="${build.ivy.lib.dir}/hadoop0.${hadoop.mr.rev}.shim" includes="*.jar" erroronmissingdir="false" />
     <fileset dir="${build.ivy.lib.dir}/default" includes="*.jar"
+             excludes="**/hadoop-*.jar"
              erroronmissingdir="false"/>
   </path>
 
diff --git a/build.properties b/build.properties
index de9432e1bc..aa3c9b4452 100644
--- a/build.properties
+++ b/build.properties
@@ -28,7 +28,7 @@ javac.args.warnings=
 
 hadoop-0.20.version=0.20.2
 hadoop-0.20S.version=1.0.0
-hadoop-0.23.version=0.23.1
+hadoop-0.23.version=2.0.0-alpha
 hadoop.version=${hadoop-0.20.version}
 hadoop.security.version=${hadoop-0.20S.version}
 # Used to determine which set of Hadoop artifacts we depend on.
diff --git a/ivy/common-configurations.xml b/ivy/common-configurations.xml
index e109a6841a..154b7cbc20 100644
--- a/ivy/common-configurations.xml
+++ b/ivy/common-configurations.xml
@@ -22,10 +22,12 @@
   <conf name="runtime" description="runtime but not the artifact"/>
   <conf name="test" extends="hadoop${hadoop.mr.rev}.test,compile" visibility="private" />
   <conf name="hadoop20.compile" visibility="private"/>
+  <conf name="hadoop20S.compile" visibility="private"/>
   <conf name="hadoop23.compile" visibility="private"/>
   <conf name="hadoop20.test" visibility="private"/>
+  <conf name="hadoop20S.test" visibility="private"/>
   <conf name="hadoop23.test" visibility="private"/>
   <conf name="hadoop0.20.shim" visibility="private"/>
   <conf name="hadoop0.20S.shim" visibility="private"/>
   <conf name="hadoop0.23.shim" visibility="private"/>
-</configurations>
\ No newline at end of file
+</configurations>
diff --git a/shims/build.xml b/shims/build.xml
index a8a95d06e4..529e8460b7 100644
--- a/shims/build.xml
+++ b/shims/build.xml
@@ -40,20 +40,7 @@ to call at top-level: ant deploy-contrib compile-core-test
   <property name="shims.0.20S.hadoop.ivy.dir" value="${hive.root}/build/ivy/lib/hadoop0.20S.shim" />
   <property name="shims.0.23.hadoop.ivy.dir" value="${hive.root}/build/ivy/lib/hadoop0.23.shim" />
 
-  <target name="set-test-classpath">
-    <path id="test.classpath">
-      <pathelement location="${test.build.classes}" />
-      <pathelement location="" />
-      <pathelement location="${test.src.data.dir}/conf"/>
-      <pathelement location="${hive.conf.dir}"/>
-      <fileset dir="${hive.root}/testlibs" includes="*.jar" />
-      <fileset dir="${shims.0.20S.hadoop.ivy.dir}" includes="*.jar" excludes="slf4j-*.jar" />
-      <fileset dir="../lib" includes="*.jar" />
-      <path refid="classpath" />
-    </path>
-  </target>
-
-  <target name="build_shims"
+  <target name="build-shims"
           description="Build shims against a particular hadoop version">
     <echo message="Project: ${ant.project.name}"/>
     <echo message="Compiling ${sources} against hadoop ${hadoop.version.ant-internal} (${hadoop.root})"/>
@@ -86,7 +73,7 @@ to call at top-level: ant deploy-contrib compile-core-test
     <for param="shimName" list="${shims.include}">
       <sequential>
         <echo>Building shims @{shimName}</echo>
-        <antcall target="build_shims" inheritRefs="false" inheritAll="false">
+        <antcall target="build-shims" inheritRefs="false" inheritAll="false">
           <param name="hadoop.version.ant-internal" value="${shims.@{shimName}.version}" />
           <param name="sources" value="${shims.@{shimName}.sources}" />
           <param name="hadoop.ivy.dir" value="${shims.@{shimName}.hadoop.ivy.dir}" />
@@ -95,49 +82,99 @@ to call at top-level: ant deploy-contrib compile-core-test
       </sequential>
     </for>  	
   </target>
-  
-  <target name="compile_secure_test"
-          depends="set-test-classpath"
-          description="Test shims against a particular hadoop version">
+
+  <target name="compile-test-worker"
+          description="worker to compile tests, takes worker.test.src.dir parameter"
+          depends="set-test-classpath">  
     <echo message="Project: ${ant.project.name}"/>
-    <getversionpref property="hadoop.version.ant-internal.prefix" input="${hadoop.version.ant-internal}" />
-    <echo message="Compiling shim tests against hadoop ${hadoop.version.ant-internal} (${hadoop.root})"/>
-    <javac
-     encoding="${build.encoding}"
-     srcdir="${test.src.dir}"
-     includes="org/apache/hadoop/**/*.java"
-     excludes="**/TestSerDe.java"
-     destdir="${test.build.classes}"
-     debug="${javac.debug}"
-     optimize="${javac.optimize}"
-     target="${javac.version}"
-     source="${javac.version}"
-     deprecation="${javac.deprecation}"
-     includeantruntime="false">
-      <compilerarg line="${javac.args} ${javac.args.warnings}" />
-      <classpath refid="test.classpath"/>
-    </javac>
-    <javac
-     encoding="${build.encoding}"
-     srcdir="${test.build.src}"
-     includes="org/apache/hadoop/**/*.java"
-     destdir="${test.build.classes}"
-     debug="${javac.debug}"
-     optimize="${javac.optimize}"
-     target="${javac.version}"
-     source="${javac.version}"
-     deprecation="${javac.deprecation}"
-     includeantruntime="false">
-      <compilerarg line="${javac.args} ${javac.args.warnings}" />
-      <classpath refid="test.classpath"/>
-    </javac>
+    <echo message="Compiling shim tests against hadoop ${hadoop.mr.rev}"/>
+    <if>
+      <available file="${worker.test.src.dir}" type="dir"/>
+      <then>
+        <echo message="        Test srcdir : ${worker.test.src.dir} "/>
+        <javac
+         encoding="${build.encoding}"
+         srcdir="${worker.test.src.dir}"
+         includes="org/apache/hadoop/**/*.java"
+         excludes="**/TestSerDe.java"
+         destdir="${test.build.classes}"
+         debug="${javac.debug}"
+         optimize="${javac.optimize}"
+         target="${javac.version}"
+         source="${javac.version}"
+         deprecation="${javac.deprecation}"
+         includeantruntime="false">
+          <compilerarg line="${javac.args} ${javac.args.warnings}" />
+          <classpath refid="test.classpath"/>
+        </javac>
+      </then>
+      <else>
+        <echo message="        Skipping nonexistent test srcdir : ${worker.test.src.dir} "/>
+      </else>
+    </if>
   </target>
-  
-  <target name="compile-test" depends="compile,ivy-retrieve-test">
-    <echo message="Project: ${ant.project.name}"/>
-    <!-- TODO: move tests to version directory -->
-    <antcall target="compile_secure_test" inheritRefs="false" inheritAll="false">
-      <param name="hadoop.version.ant-internal" value="${hadoop.security.version}" />
+
+  <target name="determine-versions-for-tests">
+    <condition property="is.20">
+      <equals arg1="${hadoop.mr.rev}" arg2="20" />
+    </condition>
+    <condition property="is.20S">
+      <equals arg1="${hadoop.mr.rev}" arg2="20S" />
+    </condition>
+    <condition property="is.23">
+      <equals arg1="${hadoop.mr.rev}" arg2="23" />
+    </condition>
+    <condition property="is.secure">
+      <or>
+        <istrue value="${is.20S}" />
+        <istrue value="${is.23}" />
+      </or>
+    </condition>
+  </target>
+
+  <target name="compile-23-test" if="is.23">
+    <antcall target="compile-test-worker" inheritRefs="false" inheritAll="false">
+      <param name="worker.test.src.dir" value="${basedir}/src/0.23/test" />
+    </antcall>
+  </target>
+
+  <target name="compile-20S-test" if="is.20S">
+    <antcall target="compile-test-worker" inheritRefs="false" inheritAll="false">
+      <param name="worker.test.src.dir" value="${basedir}/src/0.20S/test" />
     </antcall>
   </target>
+
+  <target name="compile-20-test" if="is.20">
+    <antcall target="compile-test-worker" inheritRefs="false" inheritAll="false">
+      <param name="worker.test.src.dir" value="${basedir}/src/0.20/test" />
+    </antcall>
+   </target>
+
+  <target name="compile-common-secure-test" if="is.secure">
+     <antcall target="compile-test-worker" inheritRefs="false" inheritAll="false">
+       <param name="worker.test.src.dir" value="${basedir}/src/common-secure/test" />
+     </antcall>
+   </target>
+
+  <target name="compile-common-test">
+    <antcall target="compile-test-worker" inheritRefs="false" inheritAll="false">
+      <param name="worker.test.src.dir" value="${basedir}/src/test" />
+    </antcall>
+    <antcall target="compile-test-worker" inheritRefs="false" inheritAll="false">
+      <param name="worker.test.src.dir" value="${basedir}/src/common/test" />
+    </antcall>
+    <antcall target="compile-test-worker" inheritRefs="false" inheritAll="false">
+      <param name="worker.test.src.dir" value="${test.build.src}" />
+    </antcall>
+  </target>
+
+  <target name="compile-test" depends="compile,ivy-retrieve-test,determine-versions-for-tests">
+    <echo message="Project: ${ant.project.name}"/>
+    <antcall target="compile-common-test" />
+    <antcall target="compile-common-secure-test" />
+    <antcall target="compile-20-test" />
+    <antcall target="compile-20S-test" />
+    <antcall target="compile-23-test" />
+  </target>
+
 </project>
diff --git a/shims/src/test/org/apache/hadoop/hive/thrift/TestHadoop20SAuthBridge.java b/shims/src/common-secure/test/org/apache/hadoop/hive/thrift/TestHadoop20SAuthBridge.java
similarity index 99%
rename from shims/src/test/org/apache/hadoop/hive/thrift/TestHadoop20SAuthBridge.java
rename to shims/src/common-secure/test/org/apache/hadoop/hive/thrift/TestHadoop20SAuthBridge.java
index 2c196bb6a1..172e031153 100644
--- a/shims/src/test/org/apache/hadoop/hive/thrift/TestHadoop20SAuthBridge.java
+++ b/shims/src/common-secure/test/org/apache/hadoop/hive/thrift/TestHadoop20SAuthBridge.java
@@ -28,6 +28,7 @@
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.Enumeration;
+import java.util.List;
 
 import junit.framework.TestCase;
 
@@ -96,7 +97,7 @@ protected DelegationTokenStore getTokenStore(Configuration conf) throws IOExcept
 
   private void configureSuperUserIPAddresses(Configuration conf,
       String superUserShortName) throws IOException {
-    ArrayList<String> ipList = new ArrayList<String>();
+    List<String> ipList = new ArrayList<String>();
     Enumeration<NetworkInterface> netInterfaceList = NetworkInterface
         .getNetworkInterfaces();
     while (netInterfaceList.hasMoreElements()) {
diff --git a/shims/src/test/org/apache/hadoop/hive/thrift/TestZooKeeperTokenStore.java b/shims/src/common-secure/test/org/apache/hadoop/hive/thrift/TestZooKeeperTokenStore.java
similarity index 100%
rename from shims/src/test/org/apache/hadoop/hive/thrift/TestZooKeeperTokenStore.java
rename to shims/src/common-secure/test/org/apache/hadoop/hive/thrift/TestZooKeeperTokenStore.java
