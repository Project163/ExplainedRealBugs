diff --git a/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java b/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
index d6eba2f1c9..170d0f4e47 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
@@ -13719,7 +13719,7 @@ public static final Map<ASTNode, String> translateFieldDesc(ASTNode node, HiveCo
   public void validate() throws SemanticException {
     boolean wasAcidChecked = false;
     // Validate inputs and outputs have right protectmode to execute the query
-    for (ReadEntity readEntity : getInputs()) {
+    for (ReadEntity readEntity : getAllInputs()) {
       ReadEntity.Type type = readEntity.getType();
 
       if (type != ReadEntity.Type.TABLE &&
@@ -13744,7 +13744,7 @@ public void validate() throws SemanticException {
       }
     }
 
-    for (WriteEntity writeEntity : getOutputs()) {
+    for (WriteEntity writeEntity : getAllOutputs()) {
       WriteEntity.Type type = writeEntity.getType();
 
       if (type == WriteEntity.Type.PARTITION || type == WriteEntity.Type.DUMMYPARTITION) {
diff --git a/ql/src/test/queries/clientpositive/cte_mat_acid_1.q b/ql/src/test/queries/clientpositive/cte_mat_acid_1.q
new file mode 100644
index 0000000000..50188b3f43
--- /dev/null
+++ b/ql/src/test/queries/clientpositive/cte_mat_acid_1.q
@@ -0,0 +1,16 @@
+set hive.support.concurrency=true;
+set hive.txn.manager=org.apache.hadoop.hive.ql.lockmgr.DbTxnManager;
+
+set hive.optimize.cte.materialize.threshold=2;
+set hive.optimize.cte.materialize.full.aggregate.only=false;
+
+create table t1 (a int, b int) stored as orc TBLPROPERTIES ('transactional'='true');
+
+with cte as (
+  select a, count(*) as c1 from t1
+  group by a)
+select cte1.a, cte1.c1
+ from cte cte1,
+      cte cte2
+where cte1.a = cte2.a
+  and cte1.a > 10;
diff --git a/ql/src/test/results/clientpositive/llap/cte_mat_acid_1.q.out b/ql/src/test/results/clientpositive/llap/cte_mat_acid_1.q.out
new file mode 100644
index 0000000000..242a47fcd8
--- /dev/null
+++ b/ql/src/test/results/clientpositive/llap/cte_mat_acid_1.q.out
@@ -0,0 +1,36 @@
+PREHOOK: query: create table t1 (a int, b int) stored as orc TBLPROPERTIES ('transactional'='true')
+PREHOOK: type: CREATETABLE
+PREHOOK: Output: database:default
+PREHOOK: Output: default@t1
+POSTHOOK: query: create table t1 (a int, b int) stored as orc TBLPROPERTIES ('transactional'='true')
+POSTHOOK: type: CREATETABLE
+POSTHOOK: Output: database:default
+POSTHOOK: Output: default@t1
+PREHOOK: query: with cte as (
+  select a, count(*) as c1 from t1
+  group by a)
+select cte1.a, cte1.c1
+ from cte cte1,
+      cte cte2
+where cte1.a = cte2.a
+  and cte1.a > 10
+PREHOOK: type: QUERY
+PREHOOK: Input: default@cte
+PREHOOK: Input: default@t1
+PREHOOK: Output: database:default
+PREHOOK: Output: default@cte
+#### A masked pattern was here ####
+POSTHOOK: query: with cte as (
+  select a, count(*) as c1 from t1
+  group by a)
+select cte1.a, cte1.c1
+ from cte cte1,
+      cte cte2
+where cte1.a = cte2.a
+  and cte1.a > 10
+POSTHOOK: type: QUERY
+POSTHOOK: Input: default@cte
+POSTHOOK: Input: default@t1
+POSTHOOK: Output: database:default
+POSTHOOK: Output: default@cte
+#### A masked pattern was here ####
