diff --git a/CHANGES.txt b/CHANGES.txt
index 9734111a88..0328eb9593 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -30,8 +30,7 @@ Trunk -  Unreleased
     HIVE-1178. enforce bucketing for a table.
     (Namit Jain via He Yongqiang)
 
-  IMPROVEMENTS
-
+  IMPROVEMENTS 
     HIVE-983. Function from_unixtime takes long.
     (Ning Zhang via zshao)
 
@@ -95,6 +94,9 @@ Trunk -  Unreleased
 
     HIVE-1181. Make it optional to check file format. (Yongqiang He via zshao)
 
+    HIVE-1182. Fix TestCliDriver too many open file error.
+    (Zheng Shao via Ning Zhang)
+
   OPTIMIZATIONS
 
   BUG FIXES
diff --git a/ql/src/test/org/apache/hadoop/hive/ql/QTestUtil.java b/ql/src/test/org/apache/hadoop/hive/ql/QTestUtil.java
index 208a31ba07..4401315f7d 100644
--- a/ql/src/test/org/apache/hadoop/hive/ql/QTestUtil.java
+++ b/ql/src/test/org/apache/hadoop/hive/ql/QTestUtil.java
@@ -234,6 +234,8 @@ public void addFile(File qf) throws Exception {
       qsb.append(dis.readLine() + "\n");
     }
     qMap.put(qf.getName(), qsb.toString());
+    
+    dis.close();
   }
 
   public void cleanUp() throws Exception {
@@ -469,6 +471,10 @@ public void cliInit(String tname, boolean recreate) throws Exception {
     ss.out = new PrintStream(fo, true, "UTF-8");
     ss.err = ss.out;
     ss.setIsSilent(true);
+    SessionState oldSs = SessionState.get();
+    if (oldSs != null) {
+      oldSs.out.close();
+    }
     SessionState.start(ss);
     cliDriver = new CliDriver();
   }
diff --git a/ql/src/test/templates/TestCliDriver.vm b/ql/src/test/templates/TestCliDriver.vm
index 9d065f9134..2af0809ace 100644
--- a/ql/src/test/templates/TestCliDriver.vm
+++ b/ql/src/test/templates/TestCliDriver.vm
@@ -38,9 +38,6 @@ public class $className extends TestCase {
 
       qt = new QTestUtil("$resultsDir.getCanonicalPath()", "$logDir.getCanonicalPath()", miniMR);
 
-#foreach ($qf in $qfiles)
-      qt.addFile("$qf.getCanonicalPath()");
-#end
     }
     catch (Exception e) {
       System.out.println("Exception: " + e.getMessage());
@@ -81,6 +78,9 @@ public class $className extends TestCase {
   public void testCliDriver_$tname() throws Exception {
     try {
       System.out.println("Begin query: " + "$fname");
+
+      qt.addFile("$qf.getCanonicalPath()");
+
       qt.cliInit("$fname");
       int ecode = qt.executeClient("$fname");
       if (ecode != 0) {
diff --git a/ql/src/test/templates/TestNegativeCliDriver.vm b/ql/src/test/templates/TestNegativeCliDriver.vm
index 7efe7d1df2..ddee2493fd 100644
--- a/ql/src/test/templates/TestNegativeCliDriver.vm
+++ b/ql/src/test/templates/TestNegativeCliDriver.vm
@@ -27,9 +27,6 @@ public class $className extends TestCase {
     try {
       qt = new QTestUtil("$resultsDir.getCanonicalPath()", "$logDir.getCanonicalPath()");
 
-#foreach ($qf in $qfiles)
-      qt.addFile("$qf.getCanonicalPath()");
-#end
     }
     catch (Throwable e) {
       e.printStackTrace();
@@ -56,6 +53,9 @@ public class $className extends TestCase {
   public void testNegativeCliDriver_$tname() throws Exception {
     try {
       System.out.println("Begin query: " + "$fname");
+
+      qt.addFile("$qf.getCanonicalPath()");
+
       qt.cliInit("$fname");
       int ecode = qt.executeClient("$fname");
       if (ecode == 0) {
diff --git a/ql/src/test/templates/TestParse.vm b/ql/src/test/templates/TestParse.vm
index 807d715f4c..8fa56a9979 100644
--- a/ql/src/test/templates/TestParse.vm
+++ b/ql/src/test/templates/TestParse.vm
@@ -23,10 +23,6 @@ public class $className extends TestCase {
   protected void setUp() {
     try {
       qt = new QTestUtil("$resultsDir.getCanonicalPath()", "$logDir.getCanonicalPath()");
-
-#foreach ($qf in $qfiles)
-      qt.addFile("$qf.getCanonicalPath()");
-#end
     }
     catch (Exception e) {
       System.out.println("Exception: " + e.getMessage());
@@ -54,6 +50,9 @@ public class $className extends TestCase {
   public void testParse_$tname() throws Exception {
     try {
       System.out.println("Begin query: " + "$fname");
+
+      qt.addFile("$qf.getCanonicalPath()");
+
       qt.init("$fname");
       ASTNode tree = qt.parseQuery("$fname");
       int ecode = qt.checkParseResults("$fname", tree);
diff --git a/ql/src/test/templates/TestParseNegative.vm b/ql/src/test/templates/TestParseNegative.vm
index e40e604625..87718fc269 100755
--- a/ql/src/test/templates/TestParseNegative.vm
+++ b/ql/src/test/templates/TestParseNegative.vm
@@ -23,10 +23,6 @@ public class $className extends TestCase {
   protected void setUp() {
     try {
       qt = new QTestUtil("$resultsDir.getCanonicalPath()", "$logDir.getCanonicalPath()");
-
-#foreach ($qf in $qfiles)
-      qt.addFile("$qf.getCanonicalPath()");
-#end
     }
     catch (Exception e) {
       System.out.println("Exception: " + e.getMessage());
@@ -54,6 +50,9 @@ public class $className extends TestCase {
   public void testParseNegative_$tname() throws Exception {
     try {
       System.out.println("Begin query: " + "$fname");
+
+      qt.addFile("$qf.getCanonicalPath()");
+
       qt.init("$fname");
       ASTNode tree = qt.parseQuery("$fname");
       List<Task<? extends Serializable>> tasks = qt.analyzeAST(tree);
