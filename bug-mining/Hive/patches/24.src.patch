diff --git a/CHANGES.txt b/CHANGES.txt
index 6ce1b7bbcb..b86a8e696a 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -36,6 +36,9 @@ Trunk (unreleased changes)
 
   BUG FIXES
 
+    HIVE-129. Fix aux.jar packaging to work properly with 0.17 and 0.18 
+    versions of hadoop. (Joydeep Sarma via zshao)
+
     HIVE-162. Fix join0.q test failure with hadoop 0.17. (zshao)
 
     HIVE-146. Fix builds for non-default build directory.
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/exec/ExecDriver.java b/ql/src/java/org/apache/hadoop/hive/ql/exec/ExecDriver.java
index 84a5e9384b..5938b7491c 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/exec/ExecDriver.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/exec/ExecDriver.java
@@ -23,6 +23,8 @@
 import java.net.URI;
 import java.net.URLEncoder;
 import java.net.URLDecoder;
+import java.net.URL;
+import java.net.URLClassLoader;
 
 import org.apache.commons.logging.LogFactory;
 import org.apache.commons.lang.StringUtils;
@@ -86,13 +88,19 @@ public void initialize (HiveConf conf) {
     String realFiles = getRealFiles(job);
     if (realFiles != null && realFiles.length() > 0) {
       job.set("tmpfiles", realFiles);
+
+      // workaround for hadoop-17 - jobclient only looks at commandlineconfig
+      Configuration commandConf = JobClient.getCommandLineConfig();
+      if(commandConf != null) {
+        commandConf.set("tmpfiles", realFiles);
+      }
     }
   }
 
   /**
    * Constructor/Initialization for invocation as independent utility
    */
-  public ExecDriver(mapredWork plan, JobConf job, boolean isSilent) {
+  public ExecDriver(mapredWork plan, JobConf job, boolean isSilent) throws HiveException {
     setWork(plan);
     this.job = job;
     LOG = LogFactory.getLog(this.getClass().getName());
@@ -219,6 +227,27 @@ private void inferNumReducers() throws Exception {
     }
   }
 
+  /**
+   * Add new elements to the classpath
+   * @param newPaths Array of classpath elements
+   */
+  private static void addToClassPath(String [] newPaths) throws Exception {
+    Thread curThread = Thread.currentThread();
+    URLClassLoader loader = (URLClassLoader)curThread.getContextClassLoader();
+    List<URL> curPath = Arrays.asList(loader.getURLs());
+    ArrayList<URL> newPath = new ArrayList<URL> ();
+
+    for(String onestr: newPaths) {
+      URL oneurl = (new File(onestr)).toURL();
+      if(!curPath.contains(oneurl)) {
+        newPath.add(oneurl);
+      }
+    }
+    
+    loader = new URLClassLoader(newPath.toArray(new URL[0]), loader);
+    curThread.setContextClassLoader(loader);
+  }
+
   /**
    * Execute a query plan using Hadoop
    */
@@ -401,6 +430,20 @@ public static void main(String[] args) throws IOException, HiveException {
       pathData = fs.open(new Path(planFileName));
     }
     
+    // workaround for hadoop-17 - libjars are not added to classpath. this affects local
+    // mode execution
+    boolean localMode = HiveConf.getVar(conf, HiveConf.ConfVars.HADOOPJT).equals("local");
+    if(localMode) {
+      String auxJars = HiveConf.getVar(conf, HiveConf.ConfVars.HIVEAUXJARS);
+      if (StringUtils.isNotBlank(auxJars)) {
+        try {
+          addToClassPath(StringUtils.split(auxJars, ","));
+        } catch (Exception e) {
+          throw new HiveException (e.getMessage(), e);
+        }
+      }
+    }
+
     mapredWork plan = Utilities.deserializeMapRedWork(pathData);
     ExecDriver ed = new ExecDriver(plan, conf, isSilent);
     int ret = ed.execute();
diff --git a/service/src/gen-javabean/org/apache/hadoop/hive/service/ThriftHive.java b/service/src/gen-javabean/org/apache/hadoop/hive/service/ThriftHive.java
index 4e3eb6f031..0fbc35a843 100644
--- a/service/src/gen-javabean/org/apache/hadoop/hive/service/ThriftHive.java
+++ b/service/src/gen-javabean/org/apache/hadoop/hive/service/ThriftHive.java
@@ -587,7 +587,7 @@ public void write(TProtocol oprot) throws TException {
     public String toString() {
       StringBuilder sb = new StringBuilder("execute_result(");
       sb.append("ex:");
-      sb.append(this.ex.toString());
+      sb.append(this.ex);
       sb.append(")");
       return sb.toString();
     }
@@ -810,7 +810,7 @@ public String toString() {
       sb.append("success:");
       sb.append(this.success);
       sb.append(",ex:");
-      sb.append(this.ex.toString());
+      sb.append(this.ex);
       sb.append(")");
       return sb.toString();
     }
@@ -1120,7 +1120,7 @@ public String toString() {
       sb.append("success:");
       sb.append(this.success);
       sb.append(",ex:");
-      sb.append(this.ex.toString());
+      sb.append(this.ex);
       sb.append(")");
       return sb.toString();
     }
@@ -1376,7 +1376,7 @@ public String toString() {
       sb.append("success:");
       sb.append(this.success);
       sb.append(",ex:");
-      sb.append(this.ex.toString());
+      sb.append(this.ex);
       sb.append(")");
       return sb.toString();
     }
@@ -1599,7 +1599,7 @@ public String toString() {
       sb.append("success:");
       sb.append(this.success);
       sb.append(",ex:");
-      sb.append(this.ex.toString());
+      sb.append(this.ex);
       sb.append(")");
       return sb.toString();
     }
diff --git a/service/src/gen-php/ThriftHive.php b/service/src/gen-php/ThriftHive.php
index 69c44adf23..9a9072c923 100644
--- a/service/src/gen-php/ThriftHive.php
+++ b/service/src/gen-php/ThriftHive.php
@@ -744,6 +744,9 @@ class ThriftHive_fetchN_result {
     $xfer = 0;
     $xfer += $output->writeStructBegin('ThriftHive_fetchN_result');
     if ($this->success !== null) {
+      if (!is_array($this->success)) {
+        throw new TProtocolException('Bad type in structure.', TProtocolException::INVALID_DATA);
+      }
       $xfer += $output->writeFieldBegin('success', TType::LST, 0);
       {
         $output->writeListBegin(TType::STRING, count($this->success));
@@ -911,6 +914,9 @@ class ThriftHive_fetchAll_result {
     $xfer = 0;
     $xfer += $output->writeStructBegin('ThriftHive_fetchAll_result');
     if ($this->success !== null) {
+      if (!is_array($this->success)) {
+        throw new TProtocolException('Bad type in structure.', TProtocolException::INVALID_DATA);
+      }
       $xfer += $output->writeFieldBegin('success', TType::LST, 0);
       {
         $output->writeListBegin(TType::STRING, count($this->success));
