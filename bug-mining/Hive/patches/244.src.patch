diff --git a/CHANGES.txt b/CHANGES.txt
index 74f84d76f5..4677f9f668 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -88,6 +88,9 @@ Trunk -  Unreleased
 
     HIVE-810. add test and annotation for jdbc udf (Edward Capriolo via namit)
 
+    HIVE-812. Hive compiled with ant package works with all supported hadoop versions
+    (Zheng Shao via namit)
+
 Release 0.4.0 -  Unreleased
 
   INCOMPATIBLE CHANGES
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/udf/UDAFMax.java b/ql/src/java/org/apache/hadoop/hive/ql/udf/UDAFMax.java
index 78e2ad4123..becbe41f7b 100755
--- a/ql/src/java/org/apache/hadoop/hive/ql/udf/UDAFMax.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/udf/UDAFMax.java
@@ -22,6 +22,7 @@
 import org.apache.hadoop.hive.ql.exec.UDAFEvaluator;
 import org.apache.hadoop.hive.serde2.io.DoubleWritable;
 import org.apache.hadoop.hive.serde2.io.ShortWritable;
+import org.apache.hadoop.hive.shims.ShimLoader;
 import org.apache.hadoop.io.FloatWritable;
 import org.apache.hadoop.io.IntWritable;
 import org.apache.hadoop.io.LongWritable;
@@ -245,7 +246,7 @@ public boolean iterate(Text o) {
         if (mEmpty) {
           mMax = new Text(o);
           mEmpty = false;
-        } else if (mMax.compareTo(o) < 0) {
+        } else if (ShimLoader.getHadoopShims().compareText(mMax, o) < 0) {
           mMax.set(o);
         }
       }
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/udf/UDAFMin.java b/ql/src/java/org/apache/hadoop/hive/ql/udf/UDAFMin.java
index 202dad78bd..df2bd088a4 100755
--- a/ql/src/java/org/apache/hadoop/hive/ql/udf/UDAFMin.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/udf/UDAFMin.java
@@ -22,6 +22,7 @@
 import org.apache.hadoop.hive.ql.exec.UDAFEvaluator;
 import org.apache.hadoop.hive.serde2.io.DoubleWritable;
 import org.apache.hadoop.hive.serde2.io.ShortWritable;
+import org.apache.hadoop.hive.shims.ShimLoader;
 import org.apache.hadoop.io.FloatWritable;
 import org.apache.hadoop.io.IntWritable;
 import org.apache.hadoop.io.LongWritable;
@@ -244,7 +245,7 @@ public boolean iterate(Text o) {
         if (mEmpty) {
           mMin = new Text(o);
           mEmpty = false;
-        } else if (mMin.compareTo(o) > 0) {
+        } else if (ShimLoader.getHadoopShims().compareText(mMin, o) > 0) {
           mMin.set(o);
         }
       }
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/udf/UDFOPEqualOrGreaterThan.java b/ql/src/java/org/apache/hadoop/hive/ql/udf/UDFOPEqualOrGreaterThan.java
index 04d6985424..4e65b41936 100755
--- a/ql/src/java/org/apache/hadoop/hive/ql/udf/UDFOPEqualOrGreaterThan.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/udf/UDFOPEqualOrGreaterThan.java
@@ -24,6 +24,7 @@
 import org.apache.hadoop.hive.serde2.io.ByteWritable;
 import org.apache.hadoop.hive.serde2.io.DoubleWritable;
 import org.apache.hadoop.hive.serde2.io.ShortWritable;
+import org.apache.hadoop.hive.shims.ShimLoader;
 import org.apache.hadoop.io.BooleanWritable;
 import org.apache.hadoop.io.FloatWritable;
 import org.apache.hadoop.io.IntWritable;
@@ -48,7 +49,7 @@ public BooleanWritable evaluate(Text a, Text b)  {
     if ((a == null) || (b == null)) {
       r = null;
     } else {
-      r.set(a.compareTo(b) >= 0);
+      r.set(ShimLoader.getHadoopShims().compareText(a, b) >= 0);
     }
     // LOG.info("evaluate(" + a + "," + b + ")=" + r);
     return r;
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/udf/UDFOPEqualOrLessThan.java b/ql/src/java/org/apache/hadoop/hive/ql/udf/UDFOPEqualOrLessThan.java
index 3330e45bbf..d37ac451ef 100755
--- a/ql/src/java/org/apache/hadoop/hive/ql/udf/UDFOPEqualOrLessThan.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/udf/UDFOPEqualOrLessThan.java
@@ -24,6 +24,7 @@
 import org.apache.hadoop.hive.serde2.io.ByteWritable;
 import org.apache.hadoop.hive.serde2.io.DoubleWritable;
 import org.apache.hadoop.hive.serde2.io.ShortWritable;
+import org.apache.hadoop.hive.shims.ShimLoader;
 import org.apache.hadoop.io.BooleanWritable;
 import org.apache.hadoop.io.FloatWritable;
 import org.apache.hadoop.io.IntWritable;
@@ -48,7 +49,7 @@ public BooleanWritable evaluate(Text a, Text b)  {
     if ((a == null) || (b == null)) {
       r = null;
     } else {
-      r.set(a.compareTo(b) <= 0);
+      r.set(ShimLoader.getHadoopShims().compareText(a, b) <= 0);
     }
     // LOG.info("evaluate(" + a + "," + b + ")=" + r);
     return r;
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/udf/UDFOPGreaterThan.java b/ql/src/java/org/apache/hadoop/hive/ql/udf/UDFOPGreaterThan.java
index 2ba4d4b4d6..069ea4aec2 100755
--- a/ql/src/java/org/apache/hadoop/hive/ql/udf/UDFOPGreaterThan.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/udf/UDFOPGreaterThan.java
@@ -26,6 +26,7 @@
 import org.apache.hadoop.hive.serde2.io.ByteWritable;
 import org.apache.hadoop.hive.serde2.io.DoubleWritable;
 import org.apache.hadoop.hive.serde2.io.ShortWritable;
+import org.apache.hadoop.hive.shims.ShimLoader;
 import org.apache.hadoop.io.BooleanWritable;
 import org.apache.hadoop.io.FloatWritable;
 import org.apache.hadoop.io.IntWritable;
@@ -50,7 +51,7 @@ public BooleanWritable evaluate(Text a, Text b)  {
     if ((a == null) || (b == null)) {
       r = null;
     } else {
-      r.set(a.compareTo(b) > 0);
+      r.set(ShimLoader.getHadoopShims().compareText(a, b) > 0);
     }
     // LOG.info("evaluate(" + a + "," + b + ")=" + r);
     return r;
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/udf/UDFOPLessThan.java b/ql/src/java/org/apache/hadoop/hive/ql/udf/UDFOPLessThan.java
index 1edafd2c58..9043eb9ef7 100755
--- a/ql/src/java/org/apache/hadoop/hive/ql/udf/UDFOPLessThan.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/udf/UDFOPLessThan.java
@@ -26,6 +26,7 @@
 import org.apache.hadoop.hive.serde2.io.ByteWritable;
 import org.apache.hadoop.hive.serde2.io.DoubleWritable;
 import org.apache.hadoop.hive.serde2.io.ShortWritable;
+import org.apache.hadoop.hive.shims.ShimLoader;
 import org.apache.hadoop.io.BooleanWritable;
 import org.apache.hadoop.io.FloatWritable;
 import org.apache.hadoop.io.IntWritable;
@@ -50,7 +51,7 @@ public BooleanWritable evaluate(Text a, Text b)  {
     if ((a == null) || (b == null)) {
       r = null;
     } else {
-      r.set(a.compareTo(b) < 0);
+      r.set(ShimLoader.getHadoopShims().compareText(a, b) < 0);
     }
     // LOG.info("evaluate(" + a + "," + b + ")=" + r);
     return r;
diff --git a/ql/src/test/org/apache/hadoop/hive/ql/udf/UDAFTestMax.java b/ql/src/test/org/apache/hadoop/hive/ql/udf/UDAFTestMax.java
index 901637e8b8..934b7caaae 100644
--- a/ql/src/test/org/apache/hadoop/hive/ql/udf/UDAFTestMax.java
+++ b/ql/src/test/org/apache/hadoop/hive/ql/udf/UDAFTestMax.java
@@ -22,6 +22,7 @@
 import org.apache.hadoop.hive.ql.exec.UDAFEvaluator;
 import org.apache.hadoop.hive.serde2.io.DoubleWritable;
 import org.apache.hadoop.hive.serde2.io.ShortWritable;
+import org.apache.hadoop.hive.shims.ShimLoader;
 import org.apache.hadoop.io.FloatWritable;
 import org.apache.hadoop.io.IntWritable;
 import org.apache.hadoop.io.LongWritable;
@@ -245,7 +246,7 @@ public boolean iterate(Text o) {
         if (mEmpty) {
           mMax = new Text(o);
           mEmpty = false;
-        } else if (mMax.compareTo(o) < 0) {
+        } else if (ShimLoader.getHadoopShims().compareText(mMax, o) < 0) {
           mMax.set(o);
         }
       }
diff --git a/serde/src/java/org/apache/hadoop/hive/serde2/objectinspector/ObjectInspectorUtils.java b/serde/src/java/org/apache/hadoop/hive/serde2/objectinspector/ObjectInspectorUtils.java
index 6f932dc95b..392d1c91b3 100644
--- a/serde/src/java/org/apache/hadoop/hive/serde2/objectinspector/ObjectInspectorUtils.java
+++ b/serde/src/java/org/apache/hadoop/hive/serde2/objectinspector/ObjectInspectorUtils.java
@@ -38,6 +38,7 @@
 import org.apache.hadoop.hive.serde2.objectinspector.primitive.ShortObjectInspector;
 import org.apache.hadoop.hive.serde2.objectinspector.primitive.StringObjectInspector;
 import org.apache.hadoop.hive.serde2.typeinfo.TypeInfoUtils;
+import org.apache.hadoop.hive.shims.ShimLoader;
 import org.apache.hadoop.io.Text;
 
 /**
@@ -429,7 +430,8 @@ public static int compare(Object o1, ObjectInspector oi1, Object o2, ObjectInspe
               Text t2 = (Text)poi2.getPrimitiveWritableObject(o2);
               return t1 == null
                      ? (t2 == null ? 0 : -1)
-                     : (t2 == null ? 1 : t1.compareTo(t2));
+                     : (t2 == null ? 1 : 
+                       ShimLoader.getHadoopShims().compareText(t1, t2));
             } else {
               String s1 = (String)poi1.getPrimitiveJavaObject(o1);
               String s2 = (String)poi2.getPrimitiveJavaObject(o2);
diff --git a/shims/src/0.17/java/org/apache/hadoop/hive/shims/Hadoop17Shims.java b/shims/src/0.17/java/org/apache/hadoop/hive/shims/Hadoop17Shims.java
index 8399dfe967..528b499a04 100644
--- a/shims/src/0.17/java/org/apache/hadoop/hive/shims/Hadoop17Shims.java
+++ b/shims/src/0.17/java/org/apache/hadoop/hive/shims/Hadoop17Shims.java
@@ -20,6 +20,7 @@
 import org.apache.hadoop.conf.Configuration;
 import org.apache.hadoop.fs.FileSystem;
 import org.apache.hadoop.fs.Path;
+import org.apache.hadoop.io.Text;
 import org.apache.hadoop.dfs.MiniDFSCluster;
 import org.apache.hadoop.mapred.InputFormat;
 import org.apache.hadoop.mapred.JobClient;
@@ -75,4 +76,18 @@ public void shutdown() {
       cluster.shutdown();
     }
   }
+
+  /**
+   * We define this function here to make the code compatible between
+   * hadoop 0.17 and hadoop 0.20.
+   *
+   * Hive binary that compiled Text.compareTo(Text) with hadoop 0.20 won't
+   * work with hadoop 0.17 because in hadoop 0.20, Text.compareTo(Text) is
+   * implemented in org.apache.hadoop.io.BinaryComparable, and Java compiler
+   * references that class, which is not available in hadoop 0.17.
+   */
+  public int compareText(Text a, Text b) {
+    return a.compareTo(b);
+  }
+
 }
diff --git a/shims/src/0.18/java/org/apache/hadoop/hive/shims/Hadoop18Shims.java b/shims/src/0.18/java/org/apache/hadoop/hive/shims/Hadoop18Shims.java
index 195a1db4ad..889a128337 100644
--- a/shims/src/0.18/java/org/apache/hadoop/hive/shims/Hadoop18Shims.java
+++ b/shims/src/0.18/java/org/apache/hadoop/hive/shims/Hadoop18Shims.java
@@ -20,6 +20,7 @@
 import org.apache.hadoop.conf.Configuration;
 import org.apache.hadoop.fs.FileSystem;
 import org.apache.hadoop.fs.Path;
+import org.apache.hadoop.io.Text;
 import org.apache.hadoop.dfs.MiniDFSCluster;
 import org.apache.hadoop.mapred.InputFormat;
 import org.apache.hadoop.mapred.JobClient;
@@ -76,4 +77,18 @@ public void shutdown() {
       cluster.shutdown();
     }
   }
-}
\ No newline at end of file
+
+  /**
+   * We define this function here to make the code compatible between
+   * hadoop 0.17 and hadoop 0.20.
+   *
+   * Hive binary that compiled Text.compareTo(Text) with hadoop 0.20 won't
+   * work with hadoop 0.17 because in hadoop 0.20, Text.compareTo(Text) is
+   * implemented in org.apache.hadoop.io.BinaryComparable, and Java compiler
+   * references that class, which is not available in hadoop 0.17.
+   */
+  public int compareText(Text a, Text b) {
+    return a.compareTo(b);
+  }
+
+}
diff --git a/shims/src/0.19/java/org/apache/hadoop/hive/shims/Hadoop19Shims.java b/shims/src/0.19/java/org/apache/hadoop/hive/shims/Hadoop19Shims.java
index cb61295c68..2e4a7fe998 100644
--- a/shims/src/0.19/java/org/apache/hadoop/hive/shims/Hadoop19Shims.java
+++ b/shims/src/0.19/java/org/apache/hadoop/hive/shims/Hadoop19Shims.java
@@ -20,6 +20,7 @@
 import org.apache.hadoop.conf.Configuration;
 import org.apache.hadoop.fs.FileSystem;
 import org.apache.hadoop.fs.Path;
+import org.apache.hadoop.io.Text;
 import org.apache.hadoop.hdfs.MiniDFSCluster;
 import org.apache.hadoop.mapred.InputFormat;
 import org.apache.hadoop.mapred.JobClient;
@@ -76,4 +77,18 @@ public void shutdown() {
       cluster.shutdown();
     }
   }
-}
\ No newline at end of file
+
+  /**
+   * We define this function here to make the code compatible between
+   * hadoop 0.17 and hadoop 0.20.
+   *
+   * Hive binary that compiled Text.compareTo(Text) with hadoop 0.20 won't
+   * work with hadoop 0.17 because in hadoop 0.20, Text.compareTo(Text) is
+   * implemented in org.apache.hadoop.io.BinaryComparable, and Java compiler
+   * references that class, which is not available in hadoop 0.17.
+   */
+  public int compareText(Text a, Text b) {
+    return a.compareTo(b);
+  }
+
+}
diff --git a/shims/src/0.20/java/org/apache/hadoop/hive/shims/Hadoop20Shims.java b/shims/src/0.20/java/org/apache/hadoop/hive/shims/Hadoop20Shims.java
index cc6be06f0f..811540e836 100644
--- a/shims/src/0.20/java/org/apache/hadoop/hive/shims/Hadoop20Shims.java
+++ b/shims/src/0.20/java/org/apache/hadoop/hive/shims/Hadoop20Shims.java
@@ -20,6 +20,7 @@
 import org.apache.hadoop.conf.Configuration;
 import org.apache.hadoop.fs.FileSystem;
 import org.apache.hadoop.fs.Path;
+import org.apache.hadoop.io.Text;
 import org.apache.hadoop.hdfs.MiniDFSCluster;
 import org.apache.hadoop.mapred.InputFormat;
 import org.apache.hadoop.mapred.JobClient;
@@ -73,4 +74,18 @@ public void shutdown() {
       cluster.shutdown();
     }
   }
-}
\ No newline at end of file
+
+  /**
+   * We define this function here to make the code compatible between
+   * hadoop 0.17 and hadoop 0.20.
+   *
+   * Hive binary that compiled Text.compareTo(Text) with hadoop 0.20 won't
+   * work with hadoop 0.17 because in hadoop 0.20, Text.compareTo(Text) is
+   * implemented in org.apache.hadoop.io.BinaryComparable, and Java compiler
+   * references that class, which is not available in hadoop 0.17.
+   */
+  public int compareText(Text a, Text b) {
+    return a.compareTo(b);
+  }
+
+}
diff --git a/shims/src/common/java/org/apache/hadoop/hive/shims/HadoopShims.java b/shims/src/common/java/org/apache/hadoop/hive/shims/HadoopShims.java
index 6c4a92f88e..5745e195ab 100644
--- a/shims/src/common/java/org/apache/hadoop/hive/shims/HadoopShims.java
+++ b/shims/src/common/java/org/apache/hadoop/hive/shims/HadoopShims.java
@@ -20,6 +20,7 @@
 import org.apache.hadoop.conf.Configuration;
 import org.apache.hadoop.fs.FileSystem;
 import org.apache.hadoop.fs.Path;
+import org.apache.hadoop.io.Text;
 import org.apache.hadoop.mapred.InputFormat;
 import org.apache.hadoop.mapred.JobClient;
 import org.apache.hadoop.mapred.JobConf;
@@ -78,4 +79,16 @@ public interface MiniDFSShim {
     public FileSystem getFileSystem() throws IOException;
     public void shutdown() throws IOException;
   }
+
+  /**
+   * We define this function here to make the code compatible between
+   * hadoop 0.17 and hadoop 0.20.
+   *
+   * Hive binary that compiled Text.compareTo(Text) with hadoop 0.20 won't
+   * work with hadoop 0.17 because in hadoop 0.20, Text.compareTo(Text) is
+   * implemented in org.apache.hadoop.io.BinaryComparable, and Java compiler
+   * references that class, which is not available in hadoop 0.17.
+   */
+  public int compareText(Text a, Text b);
+
 }
