diff --git a/dev-support/jenkins-execute-hms-test.sh b/dev-support/jenkins-execute-hms-test.sh
index a0b6f84273..f7f973bc27 100644
--- a/dev-support/jenkins-execute-hms-test.sh
+++ b/dev-support/jenkins-execute-hms-test.sh
@@ -165,9 +165,11 @@ create_publish_file() {
 
 if patch_contains_hms_upgrade "$PATCH_URL"; then
 	ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i $SSH_KEY $SSH_HOST "
-		rm -rf metastore/ &&
-		svn co http://svn.apache.org/repos/asf/hive/$BRANCH/testutils/metastore metastore &&
-		sudo bash -x metastore/execute-test-on-lxc.sh --patch \"${PATCH_URL}\" --branch $BRANCH
+		rm -rf hive/ &&
+		svn co http://svn.apache.org/repos/asf/hive/$BRANCH hive &&
+		cd hive/ &&
+		curl ${PATCH_URL} | bash -x testutils/ptest2/src/main/resources/smart-apply-patch.sh - &&
+		sudo bash -x testutils/metastore/execute-test-on-lxc.sh --patch \"${PATCH_URL}\" --branch $BRANCH
 	"
 	BUILD_STATUS=$?
 	if [[ $BUILD_STATUS = 0 ]]; then
diff --git a/testutils/metastore/execute-test-on-lxc.sh b/testutils/metastore/execute-test-on-lxc.sh
index ab4cbc2e4f..59eba268a5 100644
--- a/testutils/metastore/execute-test-on-lxc.sh
+++ b/testutils/metastore/execute-test-on-lxc.sh
@@ -70,9 +70,11 @@ lxc_exists() {
 }
 
 lxc_create() {
-	lxc-create -n $1 -t download -- --dist "ubuntu" --release "trusty" --arch "amd64"
+	lxc-create -n $1 -t download -- --dist "ubuntu" --release "trusty" --arch "amd64" || return 1
+	lxc_start $1 || return 1
 	lxc-attach -n $1 -- apt-get update
-	lxc-attach -n $1 -- apt-get install -y openssh-server subversion
+	lxc-attach -n $1 -- apt-get install -y openssh-server subversion patch
+
 	printf "root\nroot" | sudo lxc-attach -n $1 -- passwd
 	lxc-attach -n $1 -- sed -i /etc/ssh/sshd_config 's/^PermitRootLogin without-password/PermitRootLogin yes/'
 	lxc-attach -n $1 -- service ssh restart
@@ -83,20 +85,29 @@ lxc_running() {
 }
 
 lxc_start() {
-	lxc-start -n $1 --daemon
-	lxc-wait -n mysql -s RUNNING
+	lxc-start -n $1 --daemon || return 1
+	lxc-wait -n $1 -s RUNNING || return 1
 	sleep 10 # wait a little longer
 }
 
+lxc_stop() {
+	lxc-stop -n $1
+}
+
 lxc_prepare() {
 	echo "Downloading hive source code from SVN, branch='$BRANCH' ..."
-	lxc-attach -n $1 -- rm -rf /tmp/hive
-	lxc-attach -n $1 -- mkdir /tmp/hive
 
-	lxc-attach -n $1 -- svn co http://svn.apache.org/repos/asf/hive/$BRANCH /tmp/hive >/dev/null
-
-	lxc-attach -n $1 -- wget $PATCH_URL -O /tmp/hive/hms.patch
-	lxc-attach -n $1 -- patch -s -N -d /tmp/hive -p1 -i /tmp/hive/hms.patch
+	tmpfile=$(mktemp)
+	cat>$tmpfile<<EOF
+rm -rf hive
+mkdir hive
+svn co http://svn.apache.org/repos/asf/hive/$BRANCH hive >/dev/null
+cd hive
+wget $PATCH_URL -O hms.patch
+bash -x testutils/ptest2/src/main/resources/smart-apply-patch.sh hms.patch
+EOF
+
+	lxc-attach -n $1 -- bash -x -e < $tmpfile
 }
 
 lxc_print_metastore_log() {
@@ -104,7 +115,7 @@ lxc_print_metastore_log() {
 }
 
 run_tests() {
-	lxc-attach -n $1 -- bash /tmp/hive/testutils/metastore/metastore-upgrade-test.sh --db $1
+	lxc-attach -n $1 -- bash hive/testutils/metastore/metastore-upgrade-test.sh --db $1
 }
 
 # Install LXC packages if needed
@@ -142,4 +153,6 @@ do
 	echo "Running metastore upgrade tests for $name..."
 	run_tests $name
 	log "$(lxc_print_metastore_log $name)"
+
+	lxc_stop $name
 done
