diff --git a/CHANGES.txt b/CHANGES.txt
index c0de60d317..9c5a2a344a 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -282,6 +282,9 @@ Trunk - Unreleased
     HIVE-587. Duplicate results from multiple TIP
     (Zheng Shao via namit)
 
+    HIVE-582. bug in column pruning
+    (He Yongqiang via namit)
+
 Release 0.3.1 - Unreleased
 
   INCOMPATIBLE CHANGES
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java b/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
index 9f39c4d254..773ecaf376 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
@@ -301,14 +301,17 @@ private void handleChildren(SelectOperator op,
     }
   }
   
-  private static boolean[] getPruneReduceSinkOpRetainFlags(List<String> retainedParentOpOutputCols, ReduceSinkOperator reduce){
+  private static boolean[] getPruneReduceSinkOpRetainFlags(
+      List<String> retainedParentOpOutputCols, ReduceSinkOperator reduce) {
     reduceSinkDesc reduceConf = reduce.getConf();
     java.util.ArrayList<exprNodeDesc> originalValueEval = reduceConf.getValueCols();
     boolean[] flags = new boolean[originalValueEval.size()];
     for (int i = 0; i < originalValueEval.size(); i++) {
       flags[i] = false;
       List<String> current = originalValueEval.get(i).getCols();
-      if (current != null) {
+      if (current == null || current.size() == 0) {
+        flags[i] = true;
+      } else {
         for (int j = 0; j < current.size(); j++) {
           if (retainedParentOpOutputCols.contains(current.get(j))) {
             flags[i] = true;
diff --git a/ql/src/test/results/clientpositive/nullgroup.q.out b/ql/src/test/results/clientpositive/nullgroup.q.out
index c6e06acd64..36e6293f60 100644
--- a/ql/src/test/results/clientpositive/nullgroup.q.out
+++ b/ql/src/test/results/clientpositive/nullgroup.q.out
@@ -54,7 +54,7 @@ STAGE PLANS:
 
 query: select count(1) from src x where x.key > 9999
 Input: default/src
-Output: file:/data/users/pchakka/workspace/oshive/build/ql/tmp/956604429/10000
+Output: file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/1268175684/10000
 0
 query: explain
 select count(1) from src x where x.key > 9999
@@ -112,7 +112,7 @@ STAGE PLANS:
 
 query: select count(1) from src x where x.key > 9999
 Input: default/src
-Output: file:/data/users/pchakka/workspace/oshive/build/ql/tmp/354015080/10000
+Output: file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/1223713151/10000
 0
 query: explain
 select count(1) from src x where x.key > 9999
@@ -144,6 +144,9 @@ STAGE PLANS:
                           expr: rand()
                           type: double
                     tag: -1
+                    value expressions:
+                          expr: 1
+                          type: int
       Reduce Operator Tree:
         Group By Operator
           aggregations:
@@ -160,7 +163,7 @@ STAGE PLANS:
   Stage: Stage-2
     Map Reduce
       Alias -> Map Operator Tree:
-        file:/data/users/pchakka/workspace/oshive/build/ql/tmp/200770525/10002 
+        file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/163149910/10002 
             Reduce Output Operator
               sort order: 
               tag: -1
@@ -190,7 +193,7 @@ STAGE PLANS:
 
 query: select count(1) from src x where x.key > 9999
 Input: default/src
-Output: file:/data/users/pchakka/workspace/oshive/build/ql/tmp/1979407901/10000
+Output: file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/1599407772/10000
 0
 query: explain
 select count(1) from src x where x.key > 9999
@@ -218,6 +221,9 @@ STAGE PLANS:
                   Reduce Output Operator
                     sort order: 
                     tag: -1
+                    value expressions:
+                          expr: 1
+                          type: int
       Reduce Operator Tree:
         Group By Operator
           aggregations:
@@ -241,5 +247,5 @@ STAGE PLANS:
 
 query: select count(1) from src x where x.key > 9999
 Input: default/src
-Output: file:/data/users/pchakka/workspace/oshive/build/ql/tmp/126794078/10000
+Output: file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/1652857331/10000
 0
diff --git a/ql/src/test/results/clientpositive/nullgroup2.q.out b/ql/src/test/results/clientpositive/nullgroup2.q.out
index 17e383f686..67969736e5 100644
--- a/ql/src/test/results/clientpositive/nullgroup2.q.out
+++ b/ql/src/test/results/clientpositive/nullgroup2.q.out
@@ -63,7 +63,7 @@ STAGE PLANS:
   Stage: Stage-2
     Map Reduce
       Alias -> Map Operator Tree:
-        file:/data/users/pchakka/workspace/oshive/build/ql/tmp/1813446506/10002 
+        file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/728386179/10002 
             Reduce Output Operator
               key expressions:
                     expr: _col0
@@ -104,7 +104,7 @@ STAGE PLANS:
 
 query: select x.key, count(1) from src x where x.key > 9999 group by x.key
 Input: default/src
-Output: file:/data/users/pchakka/workspace/oshive/build/ql/tmp/1274223349/10000
+Output: file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/284238698/10000
 query: explain
 select x.key, count(1) from src x where x.key > 9999 group by x.key
 ABSTRACT SYNTAX TREE:
@@ -178,7 +178,7 @@ STAGE PLANS:
 
 query: select x.key, count(1) from src x where x.key > 9999 group by x.key
 Input: default/src
-Output: file:/data/users/pchakka/workspace/oshive/build/ql/tmp/2031150875/10000
+Output: file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/1931999488/10000
 query: explain
 select x.key, count(1) from src x where x.key > 9999 group by x.key
 ABSTRACT SYNTAX TREE:
@@ -215,6 +215,9 @@ STAGE PLANS:
                           expr: rand()
                           type: double
                     tag: -1
+                    value expressions:
+                          expr: 1
+                          type: int
       Reduce Operator Tree:
         Group By Operator
           aggregations:
@@ -234,7 +237,7 @@ STAGE PLANS:
   Stage: Stage-2
     Map Reduce
       Alias -> Map Operator Tree:
-        file:/data/users/pchakka/workspace/oshive/build/ql/tmp/1094899532/10002 
+        file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/1264700371/10002 
             Reduce Output Operator
               key expressions:
                     expr: _col0
@@ -275,7 +278,7 @@ STAGE PLANS:
 
 query: select x.key, count(1) from src x where x.key > 9999 group by x.key
 Input: default/src
-Output: file:/data/users/pchakka/workspace/oshive/build/ql/tmp/2019724226/10000
+Output: file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/192620128/10000
 query: explain
 select x.key, count(1) from src x where x.key > 9999 group by x.key
 ABSTRACT SYNTAX TREE:
@@ -311,6 +314,9 @@ STAGE PLANS:
                           expr: key
                           type: string
                     tag: -1
+                    value expressions:
+                          expr: 1
+                          type: int
       Reduce Operator Tree:
         Group By Operator
           aggregations:
@@ -339,4 +345,4 @@ STAGE PLANS:
 
 query: select x.key, count(1) from src x where x.key > 9999 group by x.key
 Input: default/src
-Output: file:/data/users/pchakka/workspace/oshive/build/ql/tmp/629412428/10000
+Output: file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/5517742/10000
diff --git a/ql/src/test/results/clientpositive/nullgroup4.q.out b/ql/src/test/results/clientpositive/nullgroup4.q.out
index ed5dd5b85d..fe4d2d650d 100644
--- a/ql/src/test/results/clientpositive/nullgroup4.q.out
+++ b/ql/src/test/results/clientpositive/nullgroup4.q.out
@@ -64,7 +64,7 @@ STAGE PLANS:
   Stage: Stage-2
     Map Reduce
       Alias -> Map Operator Tree:
-        file:/data/users/pchakka/workspace/oshive/build/ql/tmp/797179428/10002 
+        file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/630845842/10002 
             Reduce Output Operator
               sort order: 
               tag: -1
@@ -99,7 +99,7 @@ STAGE PLANS:
 
 query: select count(1), count(distinct x.value) from src x where x.key = 9999
 Input: default/src
-Output: file:/data/users/pchakka/workspace/oshive/build/ql/tmp/176192106/10000
+Output: file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/1938635713/10000
 0	0
 query: explain
 select count(1), count(distinct x.value) from src x where x.key = 9999
@@ -172,7 +172,7 @@ STAGE PLANS:
 
 query: select count(1), count(distinct x.value) from src x where x.key = 9999
 Input: default/src
-Output: file:/data/users/pchakka/workspace/oshive/build/ql/tmp/1240165665/10000
+Output: file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/2019754835/10000
 0	0
 query: explain
 select count(1), count(distinct x.value) from src x where x.key = 9999
@@ -210,6 +210,9 @@ STAGE PLANS:
                           expr: value
                           type: string
                     tag: -1
+                    value expressions:
+                          expr: 1
+                          type: int
       Reduce Operator Tree:
         Group By Operator
           aggregations:
@@ -227,7 +230,7 @@ STAGE PLANS:
   Stage: Stage-2
     Map Reduce
       Alias -> Map Operator Tree:
-        file:/data/users/pchakka/workspace/oshive/build/ql/tmp/123668648/10002 
+        file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/1425841757/10002 
             Reduce Output Operator
               sort order: 
               tag: -1
@@ -262,7 +265,7 @@ STAGE PLANS:
 
 query: select count(1), count(distinct x.value) from src x where x.key = 9999
 Input: default/src
-Output: file:/data/users/pchakka/workspace/oshive/build/ql/tmp/2060544994/10000
+Output: file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/2042822876/10000
 0	0
 query: explain
 select count(1), count(distinct x.value) from src x where x.key = 9999
@@ -296,6 +299,9 @@ STAGE PLANS:
                           type: string
                     sort order: +
                     tag: -1
+                    value expressions:
+                          expr: 1
+                          type: int
       Reduce Operator Tree:
         Group By Operator
           aggregations:
@@ -322,5 +328,5 @@ STAGE PLANS:
 
 query: select count(1), count(distinct x.value) from src x where x.key = 9999
 Input: default/src
-Output: file:/data/users/pchakka/workspace/oshive/build/ql/tmp/131032386/10000
+Output: file:/Users/char/Documents/workspace/Hive-460/build/ql/tmp/2013029014/10000
 0	0
