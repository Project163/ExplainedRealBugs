diff --git a/CHANGES.txt b/CHANGES.txt
index bbb28f4bd4..cb1cb93230 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -162,7 +162,7 @@ Trunk - Unreleased
     the expression string is empty. (Zheng Shao via athusoo)
 
     HIVE-410: Heartbeating for streaming jobs should not depend on stdout.
-    (Ashish Thusoo via njain)
+    (Ashish Thusoo via namit)
 
     HIVE-499. Fix for CAST operator on the same type. (Zheng Shao via athusoo)
 
@@ -181,7 +181,7 @@ Trunk - Unreleased
     HIVE-500. Fix select from newly created table.
     (Yongqiang He via zshao)
 
-    HIVE-451. Fix ORDER BY xxx DESC (He Yongqiang via njain)
+    HIVE-451. Fix ORDER BY xxx DESC (He Yongqiang via namit)
 
     HIVE-467. Scratch data location should be on different filesystems for
     different types of intermediate data. (Joydeep Sen Sarma via rmurthy)
@@ -200,6 +200,9 @@ Trunk - Unreleased
     HIVE-525. Fix Eclipse classpath by adding Hadoop test jar. 
     (Prasad Chakka via johan)
 
+    HIVE-495. Fix join of a table of ThriftSerDe with complex columns
+    (Zheng Shao via namit)
+
 Release 0.3.1 - Unreleased
 
   INCOMPATIBLE CHANGES
diff --git a/data/files/complex.seq b/data/files/complex.seq
index 3cf3966bad..c27d5c09b1 100644
Binary files a/data/files/complex.seq and b/data/files/complex.seq differ
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/exec/JoinOperator.java b/ql/src/java/org/apache/hadoop/hive/ql/exec/JoinOperator.java
index 1228a67ff9..e6a526d9c8 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/exec/JoinOperator.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/exec/JoinOperator.java
@@ -37,6 +37,7 @@
 import org.apache.hadoop.hive.ql.plan.joinDesc;
 import org.apache.hadoop.conf.Configuration;
 import org.apache.hadoop.hive.serde2.objectinspector.InspectableObject;
+import org.apache.hadoop.hive.serde2.objectinspector.ListObjectInspector;
 import org.apache.hadoop.hive.serde2.objectinspector.ObjectInspector;
 import org.apache.hadoop.hive.serde2.objectinspector.ObjectInspectorUtils;
 import org.apache.hadoop.hive.serde2.objectinspector.ObjectInspectorFactory;
@@ -44,6 +45,7 @@
 import org.apache.hadoop.hive.serde2.objectinspector.StandardStructObjectInspector;
 import org.apache.hadoop.hive.serde2.objectinspector.StructField;
 import org.apache.hadoop.hive.serde2.objectinspector.StructObjectInspector;
+import org.apache.hadoop.hive.serde2.objectinspector.ObjectInspectorUtils.ObjectInspectorCopyOption;
 import org.apache.hadoop.hive.serde2.objectinspector.primitive.PrimitiveObjectInspectorFactory;
 import org.apache.hadoop.hive.serde2.typeinfo.TypeInfoFactory;
 import org.apache.hadoop.io.Text;
@@ -161,8 +163,12 @@ public void initialize(Configuration hconf, Reporter reporter, ObjectInspector[]
     for (Byte alias : order) {
       int sz = map.get(alias).size();
       StructObjectInspector fldObjIns = (StructObjectInspector)((StructObjectInspector)inputObjInspector[alias.intValue()]).getStructFieldRef("VALUE").getFieldObjectInspector();
-      for (int i = 0; i < sz; i++)
-        structFieldObjectInspectors.add(fldObjIns.getAllStructFieldRefs().get(i).getFieldObjectInspector());
+      for (int i = 0; i < sz; i++) {
+        structFieldObjectInspectors.add(
+            ObjectInspectorUtils.getStandardObjectInspector(
+                fldObjIns.getAllStructFieldRefs().get(i).getFieldObjectInspector(),
+                ObjectInspectorCopyOption.KEEP));
+      }
     }
     
     joinOutputObjectInspector = ObjectInspectorFactory
diff --git a/ql/src/test/queries/clientpositive/join_thrift.q b/ql/src/test/queries/clientpositive/join_thrift.q
new file mode 100644
index 0000000000..1b4d491207
--- /dev/null
+++ b/ql/src/test/queries/clientpositive/join_thrift.q
@@ -0,0 +1,12 @@
+DESCRIBE src_thrift;
+
+EXPLAIN
+SELECT s1.aint, s2.lintstring
+FROM src_thrift s1
+JOIN src_thrift s2
+ON s1.aint = s2.aint;
+
+SELECT s1.aint, s2.lintstring
+FROM src_thrift s1
+JOIN src_thrift s2
+ON s1.aint = s2.aint;
diff --git a/ql/src/test/results/clientpositive/case_sensitivity.q.out b/ql/src/test/results/clientpositive/case_sensitivity.q.out
index a50c693678..af3ed210a6 100644
--- a/ql/src/test/results/clientpositive/case_sensitivity.q.out
+++ b/ql/src/test/results/clientpositive/case_sensitivity.q.out
@@ -19,7 +19,7 @@ STAGE PLANS:
                     expr: lint
                     type: array<int>
                     expr: lintstring
-                    type: array<struct<myint:int,mystring:string>>
+                    type: array<struct<myint:int,mystring:string,underscore_int:int>>
               Filter Operator
                 predicate:
                     expr: (0[0] > 0)
@@ -56,7 +56,7 @@ Input: default/src_thrift
 Output: default/dest1
 query: SELECT DEST1.* FROM Dest1
 Input: default/dest1
-Output: /data/users/athusoo/commits/hive_trunk_ws8/ql/../build/ql/tmp/256252840/400813971.10000
+Output: /data/users/zshao/tools/495-trunk-apache-hive/ql/../build/ql/tmp/154752222/89798452.10000
 2	1
 4	8
 6	27
diff --git a/ql/src/test/results/clientpositive/describe_xpath.q.out b/ql/src/test/results/clientpositive/describe_xpath.q.out
index 18f95d1819..79d1dca23e 100644
--- a/ql/src/test/results/clientpositive/describe_xpath.q.out
+++ b/ql/src/test/results/clientpositive/describe_xpath.q.out
@@ -14,6 +14,7 @@ query: -- Describe a complex element of a list
 describe src_thrift.lintString.$elem$
 myint	int	from deserializer
 mystring	string	from deserializer
+underscore_int	int	from deserializer
 query: -- Describe a member of an element of a list
 describe src_thrift.lintString.$elem$.myint
 myint	int	from deserializer
diff --git a/ql/src/test/results/clientpositive/input17.q.out b/ql/src/test/results/clientpositive/input17.q.out
index ae155984cf..b07bc2e0cf 100644
--- a/ql/src/test/results/clientpositive/input17.q.out
+++ b/ql/src/test/results/clientpositive/input17.q.out
@@ -26,13 +26,13 @@ STAGE PLANS:
                     expr: lint
                     type: array<int>
                     expr: lintstring
-                    type: array<struct<myint:int,mystring:string>>
+                    type: array<struct<myint:int,mystring:string,underscore_int:int>>
               Select Operator
                 expressions:
                       expr: (0 + 1[0])
                       type: int
                       expr: 2[0]
-                      type: struct<myint:int,mystring:string>
+                      type: struct<myint:int,mystring:string,underscore_int:int>
                 Transform Operator
                   command: /bin/cat
                   output info:
@@ -97,15 +97,15 @@ Input: default/src_thrift
 Output: default/dest1
 query: SELECT dest1.* FROM dest1
 Input: default/dest1
-Output: /data/users/athusoo/commits/hive_trunk_ws8/ql/../build/ql/tmp/10910343/1742990479.10000
-NULL	{"myint":null,"mystring":null}
--1461153966	{"myint":49,"mystring":"343"}
--1952710705	{"myint":25,"mystring":"125"}
--734328905	{"myint":16,"mystring":"64"}
--751827636	{"myint":4,"mystring":"8"}
-1244525196	{"myint":36,"mystring":"216"}
-1638581586	{"myint":64,"mystring":"512"}
-1712634731	{"myint":0,"mystring":"0"}
-336964422	{"myint":81,"mystring":"729"}
-465985201	{"myint":1,"mystring":"1"}
-477111225	{"myint":9,"mystring":"27"}
+Output: /data/users/zshao/tools/495-trunk-apache-hive/ql/../build/ql/tmp/899544746/1236316343.10000
+NULL	{"myint":null,"mystring":null,"underscore_int":null}
+-1461153966	{"myint":49,"mystring":"343","underscore_int":7}
+-1952710705	{"myint":25,"mystring":"125","underscore_int":5}
+-734328905	{"myint":16,"mystring":"64","underscore_int":4}
+-751827636	{"myint":4,"mystring":"8","underscore_int":2}
+1244525196	{"myint":36,"mystring":"216","underscore_int":6}
+1638581586	{"myint":64,"mystring":"512","underscore_int":8}
+1712634731	{"myint":0,"mystring":"0","underscore_int":0}
+336964422	{"myint":81,"mystring":"729","underscore_int":9}
+465985201	{"myint":1,"mystring":"1","underscore_int":1}
+477111225	{"myint":9,"mystring":"27","underscore_int":3}
diff --git a/ql/src/test/results/clientpositive/input5.q.out b/ql/src/test/results/clientpositive/input5.q.out
index db0bd4f66f..c338cd868e 100644
--- a/ql/src/test/results/clientpositive/input5.q.out
+++ b/ql/src/test/results/clientpositive/input5.q.out
@@ -24,13 +24,13 @@ STAGE PLANS:
                     expr: lint
                     type: array<int>
                     expr: lintstring
-                    type: array<struct<myint:int,mystring:string>>
+                    type: array<struct<myint:int,mystring:string,underscore_int:int>>
               Select Operator
                 expressions:
                       expr: 0
                       type: array<int>
                       expr: 1
-                      type: array<struct<myint:int,mystring:string>>
+                      type: array<struct<myint:int,mystring:string,underscore_int:int>>
                 Transform Operator
                   command: /bin/cat
                   output info:
@@ -89,15 +89,15 @@ Input: default/src_thrift
 Output: default/dest1
 query: SELECT dest1.* FROM dest1
 Input: default/dest1
-Output: /data/users/athusoo/commits/hive_trunk_ws8/ql/../build/ql/tmp/248520134/578564891.10000
-[0,0,0]	[{"myint":0,"mystring":"0"}]
-[1,2,3]	[{"myint":1,"mystring":"1"}]
-[2,4,6]	[{"myint":4,"mystring":"8"}]
-[3,6,9]	[{"myint":9,"mystring":"27"}]
-[4,8,12]	[{"myint":16,"mystring":"64"}]
-[5,10,15]	[{"myint":25,"mystring":"125"}]
-[6,12,18]	[{"myint":36,"mystring":"216"}]
-[7,14,21]	[{"myint":49,"mystring":"343"}]
-[8,16,24]	[{"myint":64,"mystring":"512"}]
-[9,18,27]	[{"myint":81,"mystring":"729"}]
+Output: /data/users/zshao/tools/495-trunk-apache-hive/ql/../build/ql/tmp/1082689233/217248273.10000
+[0,0,0]	[{"myint":0,"mystring":"0","underscore_int":0}]
+[1,2,3]	[{"myint":1,"mystring":"1","underscore_int":1}]
+[2,4,6]	[{"myint":4,"mystring":"8","underscore_int":2}]
+[3,6,9]	[{"myint":9,"mystring":"27","underscore_int":3}]
+[4,8,12]	[{"myint":16,"mystring":"64","underscore_int":4}]
+[5,10,15]	[{"myint":25,"mystring":"125","underscore_int":5}]
+[6,12,18]	[{"myint":36,"mystring":"216","underscore_int":6}]
+[7,14,21]	[{"myint":49,"mystring":"343","underscore_int":7}]
+[8,16,24]	[{"myint":64,"mystring":"512","underscore_int":8}]
+[9,18,27]	[{"myint":81,"mystring":"729","underscore_int":9}]
 null	null
diff --git a/ql/src/test/results/clientpositive/input_testxpath.q.out b/ql/src/test/results/clientpositive/input_testxpath.q.out
index 3922a2ef3a..d04fdc0eb9 100644
--- a/ql/src/test/results/clientpositive/input_testxpath.q.out
+++ b/ql/src/test/results/clientpositive/input_testxpath.q.out
@@ -19,7 +19,7 @@ STAGE PLANS:
                     expr: lint
                     type: array<int>
                     expr: lintstring
-                    type: array<struct<myint:int,mystring:string>>
+                    type: array<struct<myint:int,mystring:string,underscore_int:int>>
                     expr: mstringstring
                     type: map<string,string>
               Select Operator
@@ -56,7 +56,7 @@ Input: default/src_thrift
 Output: default/dest1
 query: SELECT dest1.* FROM dest1
 Input: default/dest1
-Output: /data/users/athusoo/commits/hive_trunk_ws8/ql/../build/ql/tmp/403047878/395453459.10000
+Output: /data/users/zshao/tools/495-trunk-apache-hive/ql/../build/ql/tmp/600192558/110692382.10000
 0	0	NULL
 2	1	NULL
 4	8	value_2
diff --git a/ql/src/test/results/clientpositive/input_testxpath2.q.out b/ql/src/test/results/clientpositive/input_testxpath2.q.out
index 04396b0373..5210a5d6c4 100644
--- a/ql/src/test/results/clientpositive/input_testxpath2.q.out
+++ b/ql/src/test/results/clientpositive/input_testxpath2.q.out
@@ -19,7 +19,7 @@ STAGE PLANS:
                     expr: lint
                     type: array<int>
                     expr: lintstring
-                    type: array<struct<myint:int,mystring:string>>
+                    type: array<struct<myint:int,mystring:string,underscore_int:int>>
                     expr: mstringstring
                     type: map<string,string>
               Filter Operator
@@ -60,7 +60,7 @@ Input: default/src_thrift
 Output: default/dest1
 query: SELECT dest1.* FROM dest1
 Input: default/dest1
-Output: /data/users/athusoo/commits/hive_trunk_ws8/ql/../build/ql/tmp/627000844/1811724340.10000
+Output: /data/users/zshao/tools/495-trunk-apache-hive/ql/../build/ql/tmp/108328031/145804882.10000
 3	1	1
 3	1	1
 3	1	1
diff --git a/ql/src/test/results/clientpositive/input_testxpath3.q.out b/ql/src/test/results/clientpositive/input_testxpath3.q.out
index 62e569d89e..105696137f 100644
--- a/ql/src/test/results/clientpositive/input_testxpath3.q.out
+++ b/ql/src/test/results/clientpositive/input_testxpath3.q.out
@@ -18,7 +18,7 @@ STAGE PLANS:
                     expr: mstringstring
                     type: map<string,string>
                     expr: lintstring
-                    type: array<struct<myint:int,mystring:string>>
+                    type: array<struct<myint:int,mystring:string,underscore_int:int>>
               Select Operator
                 expressions:
                       expr: 0['key_9']
@@ -40,7 +40,7 @@ STAGE PLANS:
 query: FROM src_thrift
 SELECT src_thrift.mstringstring['key_9'], src_thrift.lintstring.myint
 Input: default/src_thrift
-Output: /data/users/athusoo/commits/hive_trunk_ws8/ql/../build/ql/tmp/535177843/787258899.10000
+Output: /data/users/zshao/tools/495-trunk-apache-hive/ql/../build/ql/tmp/47313672/383253534.10000
 NULL	[0]
 NULL	[1]
 NULL	[4]
diff --git a/ql/src/test/results/clientpositive/input_testxpath4.q.out b/ql/src/test/results/clientpositive/input_testxpath4.q.out
index f39a0f406f..555798a53b 100644
--- a/ql/src/test/results/clientpositive/input_testxpath4.q.out
+++ b/ql/src/test/results/clientpositive/input_testxpath4.q.out
@@ -21,7 +21,7 @@ STAGE PLANS:
                     expr: mstringstring
                     type: map<string,string>
                     expr: lintstring
-                    type: array<struct<myint:int,mystring:string>>
+                    type: array<struct<myint:int,mystring:string,underscore_int:int>>
               Filter Operator
                 predicate:
                     expr: ((0['key_9'] is not null and 1.myint is not null) and 1 is not null)
@@ -50,7 +50,7 @@ WHERE src_thrift.mstringstring['key_9'] IS NOT NULL
       OR lintstring.myint IS NOT NULL
       OR lintstring IS NOT NULL
 Input: default/src_thrift
-Output: /data/users/athusoo/commits/hive_trunk_ws8/ql/../build/ql/tmp/9314654/120165410.10000
+Output: /data/users/zshao/tools/495-trunk-apache-hive/ql/../build/ql/tmp/115422682/57144029.10000
 NULL	[0]
 NULL	[1]
 NULL	[4]
diff --git a/ql/src/test/results/clientpositive/join_thrift.q.out b/ql/src/test/results/clientpositive/join_thrift.q.out
new file mode 100644
index 0000000000..9bddb3f9b6
--- /dev/null
+++ b/ql/src/test/results/clientpositive/join_thrift.q.out
@@ -0,0 +1,103 @@
+query: DESCRIBE src_thrift
+aint	int	from deserializer
+astring	string	from deserializer
+lint	array<int>	from deserializer
+lstring	array<string>	from deserializer
+lintstring	array<org.apache.hadoop.hive.serde2.thrift.test.IntString>	from deserializer
+mstringstring	map<string,string>	from deserializer
+query: EXPLAIN
+SELECT s1.aint, s2.lintstring
+FROM src_thrift s1
+JOIN src_thrift s2
+ON s1.aint = s2.aint
+ABSTRACT SYNTAX TREE:
+  (TOK_QUERY (TOK_FROM (TOK_JOIN (TOK_TABREF src_thrift s1) (TOK_TABREF src_thrift s2) (= (. (TOK_TABLE_OR_COL s1) aint) (. (TOK_TABLE_OR_COL s2) aint)))) (TOK_INSERT (TOK_DESTINATION (TOK_DIR TOK_TMP_FILE)) (TOK_SELECT (TOK_SELEXPR (. (TOK_TABLE_OR_COL s1) aint)) (TOK_SELEXPR (. (TOK_TABLE_OR_COL s2) lintstring)))))
+
+STAGE DEPENDENCIES:
+  Stage-1 is a root stage
+  Stage-0 is a root stage
+
+STAGE PLANS:
+  Stage: Stage-1
+    Map Reduce
+      Alias -> Map Operator Tree:
+        s2 
+            Select Operator
+              expressions:
+                    expr: aint
+                    type: int
+                    expr: lintstring
+                    type: array<struct<myint:int,mystring:string,underscore_int:int>>
+              Reduce Output Operator
+                key expressions:
+                      expr: 0
+                      type: int
+                sort order: +
+                Map-reduce partition columns:
+                      expr: 0
+                      type: int
+                tag: 1
+                value expressions:
+                      expr: 0
+                      type: int
+                      expr: 1
+                      type: array<struct<myint:int,mystring:string,underscore_int:int>>
+        s1 
+            Select Operator
+              expressions:
+                    expr: aint
+                    type: int
+              Reduce Output Operator
+                key expressions:
+                      expr: 0
+                      type: int
+                sort order: +
+                Map-reduce partition columns:
+                      expr: 0
+                      type: int
+                tag: 0
+                value expressions:
+                      expr: 0
+                      type: int
+      Reduce Operator Tree:
+        Join Operator
+          condition map:
+               Inner Join 0 to 1
+          condition expressions:
+            0 {VALUE.0}
+            1 {VALUE.0} {VALUE.1}
+          Select Operator
+            expressions:
+                  expr: 0
+                  type: int
+                  expr: 2
+                  type: array<struct<myint:int,mystring:string,underscore_int:int>>
+            File Output Operator
+              compressed: false
+              GlobalTableId: 0
+              table:
+                  input format: org.apache.hadoop.mapred.TextInputFormat
+                  output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
+
+  Stage: Stage-0
+    Fetch Operator
+      limit: -1
+
+
+query: SELECT s1.aint, s2.lintstring
+FROM src_thrift s1
+JOIN src_thrift s2
+ON s1.aint = s2.aint
+Input: default/src_thrift
+Output: /data/users/zshao/tools/495-trunk-apache-hive/ql/../build/ql/tmp/1611059524/151199080.10000
+-1952710710	[{"myint":25,"mystring":"125","underscore_int":5}]
+-1461153973	[{"myint":49,"mystring":"343","underscore_int":7}]
+-751827638	[{"myint":4,"mystring":"8","underscore_int":2}]
+-734328909	[{"myint":16,"mystring":"64","underscore_int":4}]
+0	null
+336964413	[{"myint":81,"mystring":"729","underscore_int":9}]
+465985200	[{"myint":1,"mystring":"1","underscore_int":1}]
+477111222	[{"myint":9,"mystring":"27","underscore_int":3}]
+1244525190	[{"myint":36,"mystring":"216","underscore_int":6}]
+1638581578	[{"myint":64,"mystring":"512","underscore_int":8}]
+1712634731	[{"myint":0,"mystring":"0","underscore_int":0}]
diff --git a/serde/if/test/complex.thrift b/serde/if/test/complex.thrift
index 58bd6111e6..713844ab8f 100644
--- a/serde/if/test/complex.thrift
+++ b/serde/if/test/complex.thrift
@@ -3,6 +3,7 @@ namespace java org.apache.hadoop.hive.serde2.thrift.test
 struct IntString {
   1: i32  myint;
   2: string myString;
+  3: i32  underscore_int;
 }
 
 struct Complex {
diff --git a/serde/src/gen-java/org/apache/hadoop/hive/serde2/thrift/test/IntString.java b/serde/src/gen-java/org/apache/hadoop/hive/serde2/thrift/test/IntString.java
index 29264ce03c..9a596f28c9 100644
--- a/serde/src/gen-java/org/apache/hadoop/hive/serde2/thrift/test/IntString.java
+++ b/serde/src/gen-java/org/apache/hadoop/hive/serde2/thrift/test/IntString.java
@@ -19,11 +19,13 @@
 public class IntString implements TBase, java.io.Serializable {
   public int myint;
   public String myString;
+  public int underscore_int;
 
   public final Isset __isset = new Isset();
   public static final class Isset implements java.io.Serializable {
     public boolean myint = false;
     public boolean myString = false;
+    public boolean underscore_int = false;
   }
 
   public IntString() {
@@ -31,13 +33,16 @@ public IntString() {
 
   public IntString(
     int myint,
-    String myString)
+    String myString,
+    int underscore_int)
   {
     this();
     this.myint = myint;
     this.__isset.myint = true;
     this.myString = myString;
     this.__isset.myString = true;
+    this.underscore_int = underscore_int;
+    this.__isset.underscore_int = true;
   }
 
   public boolean equals(Object that) {
@@ -70,6 +75,15 @@ public boolean equals(IntString that) {
         return false;
     }
 
+    boolean this_present_underscore_int = true;
+    boolean that_present_underscore_int = true;
+    if (this_present_underscore_int || that_present_underscore_int) {
+      if (!(this_present_underscore_int && that_present_underscore_int))
+        return false;
+      if (this.underscore_int != that.underscore_int)
+        return false;
+    }
+
     return true;
   }
 
@@ -104,6 +118,14 @@ public void read(TProtocol iprot) throws TException {
             TProtocolUtil.skip(iprot, field.type);
           }
           break;
+        case 3:
+          if (field.type == TType.I32) {
+            this.underscore_int = iprot.readI32();
+            this.__isset.underscore_int = true;
+          } else { 
+            TProtocolUtil.skip(iprot, field.type);
+          }
+          break;
         default:
           TProtocolUtil.skip(iprot, field.type);
           break;
@@ -131,6 +153,12 @@ public void write(TProtocol oprot) throws TException {
       oprot.writeString(this.myString);
       oprot.writeFieldEnd();
     }
+    field.name = "underscore_int";
+    field.type = TType.I32;
+    field.id = 3;
+    oprot.writeFieldBegin(field);
+    oprot.writeI32(this.underscore_int);
+    oprot.writeFieldEnd();
     oprot.writeFieldStop();
     oprot.writeStructEnd();
   }
@@ -141,6 +169,8 @@ public String toString() {
     sb.append(this.myint);
     sb.append(",myString:");
     sb.append(this.myString);
+    sb.append(",underscore_int:");
+    sb.append(this.underscore_int);
     sb.append(")");
     return sb.toString();
   }
diff --git a/serde/src/java/org/apache/hadoop/hive/serde2/objectinspector/ObjectInspectorUtils.java b/serde/src/java/org/apache/hadoop/hive/serde2/objectinspector/ObjectInspectorUtils.java
index 3ea5794b2c..fa53e92ed3 100644
--- a/serde/src/java/org/apache/hadoop/hive/serde2/objectinspector/ObjectInspectorUtils.java
+++ b/serde/src/java/org/apache/hadoop/hive/serde2/objectinspector/ObjectInspectorUtils.java
@@ -113,7 +113,7 @@ public enum ObjectInspectorCopyOption {
   }
   
   /**
-   * Get the standard ObjectInspector for an ObjectInspector.
+   * Get the corresponding standard ObjectInspector for an ObjectInspector.
    * 
    * The returned ObjectInspector can be used to inspect the standard object.
    */
@@ -144,14 +144,15 @@ public static ObjectInspector getStandardObjectInspector(ObjectInspector oi, Obj
       }
       case LIST: {
         ListObjectInspector loi = (ListObjectInspector)oi;
-        result = ObjectInspectorFactory.getStandardListObjectInspector(loi.getListElementObjectInspector());
+        result = ObjectInspectorFactory.getStandardListObjectInspector(
+            getStandardObjectInspector(loi.getListElementObjectInspector(), objectInspectorOption));
         break;
       }
       case MAP: {
         MapObjectInspector moi = (MapObjectInspector)oi;
         result = ObjectInspectorFactory.getStandardMapObjectInspector(
-            moi.getMapKeyObjectInspector(),
-            moi.getMapValueObjectInspector());
+            getStandardObjectInspector(moi.getMapKeyObjectInspector(), objectInspectorOption),
+            getStandardObjectInspector(moi.getMapValueObjectInspector(), objectInspectorOption));
         break;
       }
       case STRUCT: {
@@ -161,7 +162,7 @@ public static ObjectInspector getStandardObjectInspector(ObjectInspector oi, Obj
         List<ObjectInspector> fieldObjectInspectors = new ArrayList<ObjectInspector>(fields.size());
         for(StructField f : fields) {
           fieldNames.add(f.getFieldName());
-          fieldObjectInspectors.add(f.getFieldObjectInspector());
+          fieldObjectInspectors.add(getStandardObjectInspector(f.getFieldObjectInspector(), objectInspectorOption));
         }
         result = ObjectInspectorFactory.getStandardStructObjectInspector(fieldNames, fieldObjectInspectors);
         break;
diff --git a/serde/src/java/org/apache/hadoop/hive/serde2/typeinfo/TypeInfoUtils.java b/serde/src/java/org/apache/hadoop/hive/serde2/typeinfo/TypeInfoUtils.java
index 434a0972f6..27dc62a2c0 100644
--- a/serde/src/java/org/apache/hadoop/hive/serde2/typeinfo/TypeInfoUtils.java
+++ b/serde/src/java/org/apache/hadoop/hive/serde2/typeinfo/TypeInfoUtils.java
@@ -59,16 +59,20 @@ private static class TypeInfoParser {
     private static class Token {
       public int position;
       public String text;
-      public boolean isAlphaDigit;
+      public boolean isType;
       public String toString() {
         return "" + position + ":" + text;
       }
     };
     
+    private static boolean isTypeChar(char c) {
+      return Character.isLetterOrDigit(c) || c == '_' || c == '.';
+    }
+    
     /**
      * Tokenize the typeInfoString.
-     * The rule is simple: all consecutive alphadigits are in one token, and all 
-     * other characters are one character per token.
+     * The rule is simple: all consecutive alphadigits and '_', '.' are in one
+     * token, and all other characters are one character per token.
      * 
      * tokenize("map<int,string>") should return ["map","<","int",",","string",">"]
      */
@@ -79,12 +83,12 @@ private static ArrayList<Token> tokenize(String typeInfoString) {
       while (end <= typeInfoString.length()) {
         // last character ends a token? 
         if (end == typeInfoString.length() 
-            || !Character.isLetterOrDigit(typeInfoString.charAt(end-1))
-            || !Character.isLetterOrDigit(typeInfoString.charAt(end))) {
+            || !isTypeChar(typeInfoString.charAt(end-1))
+            || !isTypeChar(typeInfoString.charAt(end))) {
           Token t = new Token();
           t.position = begin;
           t.text = typeInfoString.substring(begin, end);
-          t.isAlphaDigit = Character.isLetterOrDigit(typeInfoString.charAt(begin));
+          t.isType = isTypeChar(typeInfoString.charAt(begin));
           tokens.add(t);
           begin = end;
         }          
@@ -138,17 +142,17 @@ private Token expect(String item, String alternative) {
             && null == PrimitiveObjectInspectorUtils.getTypeEntryFromTypeName(t.text)
             && !t.text.equals(alternative)) {
           throw new IllegalArgumentException("Error: " + item + " expected at the position "
-              + t.position + " of '" + typeInfoString + "'" );
+              + t.position + " of '" + typeInfoString + "' but '" + t.text + "' is found." );
         }
       } else if (item.equals("name")) {
-        if (!t.isAlphaDigit && !t.text.equals(alternative)) {
+        if (!t.isType && !t.text.equals(alternative)) {
           throw new IllegalArgumentException("Error: " + item + " expected at the position "
-              + t.position + " of '" + typeInfoString + "'" );
+              + t.position + " of '" + typeInfoString + "' but '" + t.text + "' is found." );
         }
       } else {
         if (!item.equals(t.text) && !t.text.equals(alternative)) {
           throw new IllegalArgumentException("Error: " + item + " expected at the position "
-              + t.position + " of '" + typeInfoString + "'" );
+              + t.position + " of '" + typeInfoString + "' but '" + t.text + "' is found." );
         }
       }
       iToken ++;
diff --git a/serde/src/test/org/apache/hadoop/hive/serde2/objectinspector/TestObjectInspectorUtils.java b/serde/src/test/org/apache/hadoop/hive/serde2/objectinspector/TestObjectInspectorUtils.java
index eb145217fa..5a3162ee2c 100644
--- a/serde/src/test/org/apache/hadoop/hive/serde2/objectinspector/TestObjectInspectorUtils.java
+++ b/serde/src/test/org/apache/hadoop/hive/serde2/objectinspector/TestObjectInspectorUtils.java
@@ -85,9 +85,10 @@ public void testObjectInspectorUtils() throws Throwable {
       assertEquals(ObjectInspectorFactory.getStandardListObjectInspector(
           PrimitiveObjectInspectorFactory.javaStringObjectInspector),
           fields.get(3).getFieldObjectInspector());
-      assertEquals(ObjectInspectorFactory.getStandardListObjectInspector(
-          ObjectInspectorFactory.getReflectionObjectInspector(IntString.class, 
-              ObjectInspectorFactory.ObjectInspectorOptions.THRIFT)),
+      assertEquals(ObjectInspectorUtils.getStandardObjectInspector(
+              ObjectInspectorFactory.getStandardListObjectInspector(
+              ObjectInspectorFactory.getReflectionObjectInspector(IntString.class, 
+              ObjectInspectorFactory.ObjectInspectorOptions.THRIFT))),
           fields.get(4).getFieldObjectInspector());
       assertEquals(ObjectInspectorFactory.getStandardMapObjectInspector(
           PrimitiveObjectInspectorFactory.javaStringObjectInspector,
diff --git a/serde/src/test/org/apache/hadoop/hive/serde2/thrift_test/CreateSequenceFile.java b/serde/src/test/org/apache/hadoop/hive/serde2/thrift_test/CreateSequenceFile.java
index dc2b0f3ebb..06a48cd613 100644
--- a/serde/src/test/org/apache/hadoop/hive/serde2/thrift_test/CreateSequenceFile.java
+++ b/serde/src/test/org/apache/hadoop/hive/serde2/thrift_test/CreateSequenceFile.java
@@ -106,7 +106,7 @@ public static void main(String[] args) throws Exception {
       ArrayList<String> slist = new ArrayList<String>();
       slist.add("" + i*10); slist.add("" + i*100); slist.add("" + i*1000);
       ArrayList<IntString> islist = new ArrayList<IntString>();
-      islist.add(new IntString(i*i, ""+ i*i*i));
+      islist.add(new IntString(i*i, ""+ i*i*i, i));
       HashMap<String,String> hash = new HashMap<String,String>();
       hash.put("key_" + i, "value_" + i);
       
