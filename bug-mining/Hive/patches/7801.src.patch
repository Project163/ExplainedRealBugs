diff --git a/ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/rules/HiveCardinalityPreservingJoinOptimization.java b/ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/rules/HiveCardinalityPreservingJoinOptimization.java
index d4b796a32d..7d9d4faeda 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/rules/HiveCardinalityPreservingJoinOptimization.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/rules/HiveCardinalityPreservingJoinOptimization.java
@@ -32,7 +32,6 @@
 
 import org.apache.calcite.plan.RelOptCluster;
 import org.apache.calcite.rel.RelNode;
-import org.apache.calcite.rel.core.Aggregate;
 import org.apache.calcite.rel.core.JoinRelType;
 import org.apache.calcite.rel.metadata.RelMetadataQuery;
 import org.apache.calcite.rel.type.RelDataTypeField;
@@ -123,7 +122,9 @@ public RelNode trim(RelBuilder relBuilder, RelNode root) {
         newColumnNames.add(relDataTypeField.getName());
       }
 
-      List<JoinedBackFields> lineages = getExpressionLineageOf(rootFieldList, rootInput);
+      // Bit set to gather the refs that backtrack to constant values
+      BitSet constants = new BitSet();
+      List<JoinedBackFields> lineages = getExpressionLineageOf(rootFieldList, rootInput, constants);
       if (lineages == null) {
         LOG.debug("Some projected field lineage can not be determined");
         return root;
@@ -132,7 +133,7 @@ public RelNode trim(RelBuilder relBuilder, RelNode root) {
       // 1. Collect candidate tables for join back and map RexNodes coming from those tables to their index in the
       // rootInput row type
       // Collect all used fields from original plan
-      ImmutableBitSet fieldsUsed = ImmutableBitSet.of();
+      ImmutableBitSet fieldsUsed = ImmutableBitSet.of(constants.stream().toArray());
       List<TableToJoinBack> tableToJoinBackList = new ArrayList<>(lineages.size());
       Map<Integer, RexNode> rexNodesToShuttle = new HashMap<>(rootInput.getRowType().getFieldCount());
 
@@ -242,7 +243,7 @@ public RelNode trim(RelBuilder relBuilder, RelNode root) {
   }
 
   private List<JoinedBackFields> getExpressionLineageOf(
-      List<RexInputRef> projectExpressions, RelNode projectInput) {
+      List<RexInputRef> projectExpressions, RelNode projectInput, BitSet constants) {
     RelMetadataQuery relMetadataQuery = RelMetadataQuery.instance();
     Map<RexTableInputRef.RelTableRef, JoinedBackFieldsBuilder> fieldMappingBuilders = new HashMap<>();
     List<RexTableInputRef.RelTableRef> tablesOrdered = new ArrayList<>(); // use this list to keep the order of tables
@@ -254,14 +255,23 @@ private List<JoinedBackFields> getExpressionLineageOf(
       }
 
       RexNode rexNode = expressionLineage.iterator().next();
-      for (RexTableInputRef rexTableInputRef : rexTableInputRef(rexNode)) {
-        RexTableInputRef.RelTableRef tableRef = rexTableInputRef.getTableRef();
-        JoinedBackFieldsBuilder joinedBackFieldsBuilder = fieldMappingBuilders.computeIfAbsent(
-            tableRef, k -> {
-              tablesOrdered.add(tableRef);
-              return new JoinedBackFieldsBuilder(tableRef);
-            });
-        joinedBackFieldsBuilder.add(expr, rexNode, rexTableInputRef);
+      List<RexTableInputRef> refs = rexTableInputRef(rexNode);
+      if (refs.isEmpty()) {
+        if (!RexUtil.isConstant(rexNode)) {
+          LOG.debug("Unknown expression that should be a constant: {}", rexNode);
+          return null;
+        }
+        constants.set(expr.getIndex());
+      } else {
+        for (RexTableInputRef rexTableInputRef : refs) {
+          RexTableInputRef.RelTableRef tableRef = rexTableInputRef.getTableRef();
+          JoinedBackFieldsBuilder joinedBackFieldsBuilder = fieldMappingBuilders.computeIfAbsent(
+              tableRef, k -> {
+                tablesOrdered.add(tableRef);
+                return new JoinedBackFieldsBuilder(tableRef);
+              });
+          joinedBackFieldsBuilder.add(expr, rexNode, rexTableInputRef);
+        }
       }
     }
 
diff --git a/ql/src/test/queries/clientpositive/cardinality_preserving_join_opt2.q b/ql/src/test/queries/clientpositive/cardinality_preserving_join_opt2.q
new file mode 100644
index 0000000000..28b91e36f9
--- /dev/null
+++ b/ql/src/test/queries/clientpositive/cardinality_preserving_join_opt2.q
@@ -0,0 +1,99 @@
+set hive.support.concurrency=true;
+set hive.txn.manager=org.apache.hadoop.hive.ql.lockmgr.DbTxnManager;
+set hive.strict.checks.cartesian.product=false;
+set hive.stats.fetch.column.stats=true;
+
+create database if not exists mydb_e10;
+
+use mydb_e10;
+
+create table if not exists f_tab_e10(
+      c1 int,
+      c2 timestamp,
+      c3 decimal(10,2)
+)
+partitioned by (c3_date string)
+stored as orc TBLPROPERTIES ('transactional'='true');
+
+create table if not exists d1_tab_e10(
+      c1 int,
+      c2 char(16) not null,
+      c3 char(10),
+      c4 varchar(60),
+      c5 char(15),
+      c6 char(10),
+      c7 varchar(60),
+      c8 varchar(30),
+      c9 char(2),
+      c10 char(10),
+      c11 varchar(20),
+      c12 decimal(5,2),
+      c13 char(20),
+      primary key (c1) disable novalidate rely
+)
+stored as orc TBLPROPERTIES ('transactional'='true');
+
+create table if not exists d2_tab_e10(
+      c1 int,
+      c2 char(16),
+      c3 int,
+      c4 char(10),
+      c5 char(20),
+      c6 char(30),
+      c7 char(13),
+      c8 char(50),
+      c9 date,
+      primary key (c1) disable novalidate rely,
+      foreign key  (c3) references d1_tab_e10 (c1) disable novalidate rely
+)
+stored as orc TBLPROPERTIES ('transactional'='true');
+
+create table if not exists d3_tab_e10(
+      c1 int,
+      c2 char(16),
+      c3 date,
+      c4 varchar(200),
+      c5 char(2),
+      c6 int,
+      c7 int,
+      c8 char(50),
+      primary key (c1) disable novalidate rely
+)
+stored as orc TBLPROPERTIES ('transactional'='true');
+
+create table if not exists d4_tab_e10(
+      c1 char(2),
+      c2 decimal(7,2)
+)
+stored as orc TBLPROPERTIES ('transactional'='true');
+
+create table if not exists f2_tab_e10(
+      c1 int,
+      c2 int,
+      c3 char(2),
+      c4 date,
+      c5 date,
+      foreign key  (c1) references d3_tab_e10 (c1) disable novalidate rely,
+      foreign key  (c2) references d2_tab_e10 (c1) disable novalidate rely
+)
+stored as orc TBLPROPERTIES ('transactional'='true');
+
+explain cbo
+select c.c1, c.c5, c.c6, ca.c3, ca.c4, ca.c5, ca.c6,
+ca.c7, ca.c8, ca.c9, ca.c10, ca.c11, cm.c1, cm.c4, cm.c5, r.c2
+from
+f2_tab_e10 cm, d2_tab_e10 c, d1_tab_e10 ca, f_tab_e10 mr, d3_tab_e10 m, d4_tab_e10 r
+where
+c.c1 = cm.c2
+and c.c3 = ca.c1
+and cm.c1 = m.c1
+and m.c5 = r.c1
+and m.c6 = 1
+and (cm.c5 is null or cm.c5 > date_format(current_date,'yyyy-MM-01'));
+
+drop table f_tab_e10;
+drop table f2_tab_e10;
+drop table d2_tab_e10;
+drop table d4_tab_e10;
+drop table d3_tab_e10;
+drop table d1_tab_e10;
diff --git a/ql/src/test/results/clientpositive/llap/cardinality_preserving_join_opt2.q.out b/ql/src/test/results/clientpositive/llap/cardinality_preserving_join_opt2.q.out
new file mode 100644
index 0000000000..3e0aea625b
--- /dev/null
+++ b/ql/src/test/results/clientpositive/llap/cardinality_preserving_join_opt2.q.out
@@ -0,0 +1,292 @@
+PREHOOK: query: create database if not exists mydb_e10
+PREHOOK: type: CREATEDATABASE
+PREHOOK: Output: database:mydb_e10
+POSTHOOK: query: create database if not exists mydb_e10
+POSTHOOK: type: CREATEDATABASE
+POSTHOOK: Output: database:mydb_e10
+PREHOOK: query: use mydb_e10
+PREHOOK: type: SWITCHDATABASE
+PREHOOK: Input: database:mydb_e10
+POSTHOOK: query: use mydb_e10
+POSTHOOK: type: SWITCHDATABASE
+POSTHOOK: Input: database:mydb_e10
+PREHOOK: query: create table if not exists f_tab_e10(
+      c1 int,
+      c2 timestamp,
+      c3 decimal(10,2)
+)
+partitioned by (c3_date string)
+stored as orc TBLPROPERTIES ('transactional'='true')
+PREHOOK: type: CREATETABLE
+PREHOOK: Output: database:mydb_e10
+PREHOOK: Output: mydb_e10@f_tab_e10
+POSTHOOK: query: create table if not exists f_tab_e10(
+      c1 int,
+      c2 timestamp,
+      c3 decimal(10,2)
+)
+partitioned by (c3_date string)
+stored as orc TBLPROPERTIES ('transactional'='true')
+POSTHOOK: type: CREATETABLE
+POSTHOOK: Output: database:mydb_e10
+POSTHOOK: Output: mydb_e10@f_tab_e10
+PREHOOK: query: create table if not exists d1_tab_e10(
+      c1 int,
+      c2 char(16) not null,
+      c3 char(10),
+      c4 varchar(60),
+      c5 char(15),
+      c6 char(10),
+      c7 varchar(60),
+      c8 varchar(30),
+      c9 char(2),
+      c10 char(10),
+      c11 varchar(20),
+      c12 decimal(5,2),
+      c13 char(20),
+      primary key (c1) disable novalidate rely
+)
+stored as orc TBLPROPERTIES ('transactional'='true')
+PREHOOK: type: CREATETABLE
+PREHOOK: Output: database:mydb_e10
+PREHOOK: Output: mydb_e10@d1_tab_e10
+POSTHOOK: query: create table if not exists d1_tab_e10(
+      c1 int,
+      c2 char(16) not null,
+      c3 char(10),
+      c4 varchar(60),
+      c5 char(15),
+      c6 char(10),
+      c7 varchar(60),
+      c8 varchar(30),
+      c9 char(2),
+      c10 char(10),
+      c11 varchar(20),
+      c12 decimal(5,2),
+      c13 char(20),
+      primary key (c1) disable novalidate rely
+)
+stored as orc TBLPROPERTIES ('transactional'='true')
+POSTHOOK: type: CREATETABLE
+POSTHOOK: Output: database:mydb_e10
+POSTHOOK: Output: mydb_e10@d1_tab_e10
+PREHOOK: query: create table if not exists d2_tab_e10(
+      c1 int,
+      c2 char(16),
+      c3 int,
+      c4 char(10),
+      c5 char(20),
+      c6 char(30),
+      c7 char(13),
+      c8 char(50),
+      c9 date,
+      primary key (c1) disable novalidate rely,
+      foreign key  (c3) references d1_tab_e10 (c1) disable novalidate rely
+)
+stored as orc TBLPROPERTIES ('transactional'='true')
+PREHOOK: type: CREATETABLE
+PREHOOK: Output: database:mydb_e10
+PREHOOK: Output: mydb_e10@d2_tab_e10
+POSTHOOK: query: create table if not exists d2_tab_e10(
+      c1 int,
+      c2 char(16),
+      c3 int,
+      c4 char(10),
+      c5 char(20),
+      c6 char(30),
+      c7 char(13),
+      c8 char(50),
+      c9 date,
+      primary key (c1) disable novalidate rely,
+      foreign key  (c3) references d1_tab_e10 (c1) disable novalidate rely
+)
+stored as orc TBLPROPERTIES ('transactional'='true')
+POSTHOOK: type: CREATETABLE
+POSTHOOK: Output: database:mydb_e10
+POSTHOOK: Output: mydb_e10@d2_tab_e10
+PREHOOK: query: create table if not exists d3_tab_e10(
+      c1 int,
+      c2 char(16),
+      c3 date,
+      c4 varchar(200),
+      c5 char(2),
+      c6 int,
+      c7 int,
+      c8 char(50),
+      primary key (c1) disable novalidate rely
+)
+stored as orc TBLPROPERTIES ('transactional'='true')
+PREHOOK: type: CREATETABLE
+PREHOOK: Output: database:mydb_e10
+PREHOOK: Output: mydb_e10@d3_tab_e10
+POSTHOOK: query: create table if not exists d3_tab_e10(
+      c1 int,
+      c2 char(16),
+      c3 date,
+      c4 varchar(200),
+      c5 char(2),
+      c6 int,
+      c7 int,
+      c8 char(50),
+      primary key (c1) disable novalidate rely
+)
+stored as orc TBLPROPERTIES ('transactional'='true')
+POSTHOOK: type: CREATETABLE
+POSTHOOK: Output: database:mydb_e10
+POSTHOOK: Output: mydb_e10@d3_tab_e10
+PREHOOK: query: create table if not exists d4_tab_e10(
+      c1 char(2),
+      c2 decimal(7,2)
+)
+stored as orc TBLPROPERTIES ('transactional'='true')
+PREHOOK: type: CREATETABLE
+PREHOOK: Output: database:mydb_e10
+PREHOOK: Output: mydb_e10@d4_tab_e10
+POSTHOOK: query: create table if not exists d4_tab_e10(
+      c1 char(2),
+      c2 decimal(7,2)
+)
+stored as orc TBLPROPERTIES ('transactional'='true')
+POSTHOOK: type: CREATETABLE
+POSTHOOK: Output: database:mydb_e10
+POSTHOOK: Output: mydb_e10@d4_tab_e10
+PREHOOK: query: create table if not exists f2_tab_e10(
+      c1 int,
+      c2 int,
+      c3 char(2),
+      c4 date,
+      c5 date,
+      foreign key  (c1) references d3_tab_e10 (c1) disable novalidate rely,
+      foreign key  (c2) references d2_tab_e10 (c1) disable novalidate rely
+)
+stored as orc TBLPROPERTIES ('transactional'='true')
+PREHOOK: type: CREATETABLE
+PREHOOK: Output: database:mydb_e10
+PREHOOK: Output: mydb_e10@f2_tab_e10
+POSTHOOK: query: create table if not exists f2_tab_e10(
+      c1 int,
+      c2 int,
+      c3 char(2),
+      c4 date,
+      c5 date,
+      foreign key  (c1) references d3_tab_e10 (c1) disable novalidate rely,
+      foreign key  (c2) references d2_tab_e10 (c1) disable novalidate rely
+)
+stored as orc TBLPROPERTIES ('transactional'='true')
+POSTHOOK: type: CREATETABLE
+POSTHOOK: Output: database:mydb_e10
+POSTHOOK: Output: mydb_e10@f2_tab_e10
+Warning: Shuffle Join MERGEJOIN[93][tables = [$hdt$_0, $hdt$_1]] in Stage 'Reducer 2' is a cross product
+PREHOOK: query: explain cbo
+select c.c1, c.c5, c.c6, ca.c3, ca.c4, ca.c5, ca.c6,
+ca.c7, ca.c8, ca.c9, ca.c10, ca.c11, cm.c1, cm.c4, cm.c5, r.c2
+from
+f2_tab_e10 cm, d2_tab_e10 c, d1_tab_e10 ca, f_tab_e10 mr, d3_tab_e10 m, d4_tab_e10 r
+where
+c.c1 = cm.c2
+and c.c3 = ca.c1
+and cm.c1 = m.c1
+and m.c5 = r.c1
+and m.c6 = 1
+and (cm.c5 is null or cm.c5 > date_format(current_date,'yyyy-MM-01'))
+PREHOOK: type: QUERY
+PREHOOK: Input: mydb_e10@d1_tab_e10
+PREHOOK: Input: mydb_e10@d2_tab_e10
+PREHOOK: Input: mydb_e10@d3_tab_e10
+PREHOOK: Input: mydb_e10@d4_tab_e10
+PREHOOK: Input: mydb_e10@f2_tab_e10
+PREHOOK: Input: mydb_e10@f_tab_e10
+#### A masked pattern was here ####
+POSTHOOK: query: explain cbo
+select c.c1, c.c5, c.c6, ca.c3, ca.c4, ca.c5, ca.c6,
+ca.c7, ca.c8, ca.c9, ca.c10, ca.c11, cm.c1, cm.c4, cm.c5, r.c2
+from
+f2_tab_e10 cm, d2_tab_e10 c, d1_tab_e10 ca, f_tab_e10 mr, d3_tab_e10 m, d4_tab_e10 r
+where
+c.c1 = cm.c2
+and c.c3 = ca.c1
+and cm.c1 = m.c1
+and m.c5 = r.c1
+and m.c6 = 1
+and (cm.c5 is null or cm.c5 > date_format(current_date,'yyyy-MM-01'))
+POSTHOOK: type: QUERY
+POSTHOOK: Input: mydb_e10@d1_tab_e10
+POSTHOOK: Input: mydb_e10@d2_tab_e10
+POSTHOOK: Input: mydb_e10@d3_tab_e10
+POSTHOOK: Input: mydb_e10@d4_tab_e10
+POSTHOOK: Input: mydb_e10@f2_tab_e10
+POSTHOOK: Input: mydb_e10@f_tab_e10
+#### A masked pattern was here ####
+CBO PLAN:
+HiveProject(c1=[$11], c5=[$13], c6=[$14], c3=[$1], c4=[$2], c51=[$3], c61=[$4], c7=[$5], c8=[$6], c9=[$7], c10=[$8], c11=[$9], c12=[$19], c41=[$21], c52=[$22], c2=[$18])
+  HiveJoin(condition=[=($11, $20)], joinType=[inner], algorithm=[none], cost=[not available])
+    HiveJoin(condition=[=($12, $0)], joinType=[inner], algorithm=[none], cost=[not available])
+      HiveJoin(condition=[true], joinType=[inner], algorithm=[none], cost=[not available])
+        HiveProject(c1=[$0], c3=[$2], c4=[$3], c5=[$4], c6=[$5], c7=[$6], c8=[$7], c9=[$8], c10=[$9], c11=[$10])
+          HiveTableScan(table=[[mydb_e10, d1_tab_e10]], table:alias=[ca])
+        HiveProject(DUMMY=[0])
+          HiveTableScan(table=[[mydb_e10, f_tab_e10]], table:alias=[mr])
+      HiveProject(c1=[$0], c3=[$2], c5=[$4], c6=[$5])
+        HiveFilter(condition=[IS NOT NULL($2)])
+          HiveTableScan(table=[[mydb_e10, d2_tab_e10]], table:alias=[c])
+    HiveProject(c1=[$0], c5=[$1], c10=[$2], c2=[$3], c11=[$4], c20=[$5], c4=[$6], c50=[$7])
+      HiveJoin(condition=[=($4, $0)], joinType=[inner], algorithm=[none], cost=[not available])
+        HiveJoin(condition=[=($1, $2)], joinType=[inner], algorithm=[none], cost=[not available])
+          HiveProject(c1=[$0], c5=[$4])
+            HiveFilter(condition=[AND(=($5, 1), IS NOT NULL($4))])
+              HiveTableScan(table=[[mydb_e10, d3_tab_e10]], table:alias=[m])
+          HiveProject(c1=[$0], c2=[$1])
+            HiveFilter(condition=[IS NOT NULL($0)])
+              HiveTableScan(table=[[mydb_e10, d4_tab_e10]], table:alias=[r])
+        HiveProject(c1=[$0], c2=[$1], c4=[$3], c5=[$4])
+          HiveFilter(condition=[AND(OR(IS NULL($4), >($4, 2020-10-01)), IS NOT NULL($1), IS NOT NULL($0))])
+            HiveTableScan(table=[[mydb_e10, f2_tab_e10]], table:alias=[cm])
+
+PREHOOK: query: drop table f_tab_e10
+PREHOOK: type: DROPTABLE
+PREHOOK: Input: mydb_e10@f_tab_e10
+PREHOOK: Output: mydb_e10@f_tab_e10
+POSTHOOK: query: drop table f_tab_e10
+POSTHOOK: type: DROPTABLE
+POSTHOOK: Input: mydb_e10@f_tab_e10
+POSTHOOK: Output: mydb_e10@f_tab_e10
+PREHOOK: query: drop table f2_tab_e10
+PREHOOK: type: DROPTABLE
+PREHOOK: Input: mydb_e10@f2_tab_e10
+PREHOOK: Output: mydb_e10@f2_tab_e10
+POSTHOOK: query: drop table f2_tab_e10
+POSTHOOK: type: DROPTABLE
+POSTHOOK: Input: mydb_e10@f2_tab_e10
+POSTHOOK: Output: mydb_e10@f2_tab_e10
+PREHOOK: query: drop table d2_tab_e10
+PREHOOK: type: DROPTABLE
+PREHOOK: Input: mydb_e10@d2_tab_e10
+PREHOOK: Output: mydb_e10@d2_tab_e10
+POSTHOOK: query: drop table d2_tab_e10
+POSTHOOK: type: DROPTABLE
+POSTHOOK: Input: mydb_e10@d2_tab_e10
+POSTHOOK: Output: mydb_e10@d2_tab_e10
+PREHOOK: query: drop table d4_tab_e10
+PREHOOK: type: DROPTABLE
+PREHOOK: Input: mydb_e10@d4_tab_e10
+PREHOOK: Output: mydb_e10@d4_tab_e10
+POSTHOOK: query: drop table d4_tab_e10
+POSTHOOK: type: DROPTABLE
+POSTHOOK: Input: mydb_e10@d4_tab_e10
+POSTHOOK: Output: mydb_e10@d4_tab_e10
+PREHOOK: query: drop table d3_tab_e10
+PREHOOK: type: DROPTABLE
+PREHOOK: Input: mydb_e10@d3_tab_e10
+PREHOOK: Output: mydb_e10@d3_tab_e10
+POSTHOOK: query: drop table d3_tab_e10
+POSTHOOK: type: DROPTABLE
+POSTHOOK: Input: mydb_e10@d3_tab_e10
+POSTHOOK: Output: mydb_e10@d3_tab_e10
+PREHOOK: query: drop table d1_tab_e10
+PREHOOK: type: DROPTABLE
+PREHOOK: Input: mydb_e10@d1_tab_e10
+PREHOOK: Output: mydb_e10@d1_tab_e10
+POSTHOOK: query: drop table d1_tab_e10
+POSTHOOK: type: DROPTABLE
+POSTHOOK: Input: mydb_e10@d1_tab_e10
+POSTHOOK: Output: mydb_e10@d1_tab_e10
