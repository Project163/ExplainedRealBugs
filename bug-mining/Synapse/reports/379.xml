<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:09:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SYNAPSE-871] Connection Leaks When Using DBReport Mediator with XADataSources</title>
                <link>https://issues.apache.org/jira/browse/SYNAPSE-871</link>
                <project id="12310201" key="SYNAPSE">Synapse</project>
                    <description>&lt;p&gt;When using Synapse inside Tomcat with the Atomikos transaction manager, when DBReport is participating in a distributed transaction, the connections it is created are not getting returned back to the connection pool, and the connections eventually runs out. By looking at the code, it seems to be that, the mediator gets a new connection from the data source, and it also looks up the connection for a second time using a Statement object it created, it seems, this getting the connection again from the Statement is faulty in some cases, where when used with MySQL, it ends up with connection leaks. So I&apos;m proposing to just create the connection at one time and pass the connection to others methods that are needed, i.e. AbstractDBMediator#getPreparedStatement.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The entry in Tomcat&apos;s context.xml for defining the data source is as follows:&lt;br/&gt;
=======================================================&lt;br/&gt;
    &amp;lt;Resource&lt;br/&gt;
name=&quot;jdbc/db1&quot;&lt;br/&gt;
auth=&quot;Container&quot;&lt;br/&gt;
type=&quot;com.atomikos.jdbc.AtomikosDataSourceBean&quot;&lt;br/&gt;
factory=&quot;com.atomikos.tomcat.BeanFactory&quot;&lt;br/&gt;
uniqueResourceName=&quot;java:comp/env/jdbc/db1&quot;&lt;br/&gt;
xaDataSourceClassName=&quot;com.mysql.jdbc.jdbc2.optional.MysqlXADataSource&quot;&lt;br/&gt;
xaProperties.databaseName=&quot;SEQUENCE_DB&quot;&lt;br/&gt;
xaProperties.serverName=&quot;localhost&quot;&lt;br/&gt;
xaProperties.port=&quot;3306&quot;&lt;br/&gt;
xaProperties.user=&quot;root&quot;&lt;br/&gt;
xaProperties.password=&quot;123&quot;&lt;br/&gt;
xaProperties.url=&quot;jdbc:mysql://localhost:3306/SEQUENCE_DB?pinGlobalTxToPhysicalConnection=true&quot;&lt;br/&gt;
/&amp;gt;&lt;br/&gt;
=======================================================&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The database used above contains a single table called &quot;SEQUENCE&quot; which only has a auto increment integer as the primary key.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Atomikos has been integrated with Tomcat as it is mentioned here: &lt;a href=&quot;http://www.atomikos.com/Documentation/Tomcat7Integration35&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.atomikos.com/Documentation/Tomcat7Integration35&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The DBReport mediator definition:-&lt;br/&gt;
=======================================================&lt;br/&gt;
&amp;lt;dbreport useTransaction=&quot;true&quot;&amp;gt;&lt;br/&gt;
                     &amp;lt;connection&amp;gt;&lt;br/&gt;
                        &amp;lt;pool&amp;gt;&lt;br/&gt;
                           &amp;lt;password&amp;gt;123&amp;lt;/password&amp;gt;&lt;br/&gt;
                           &amp;lt;user&amp;gt;root&amp;lt;/user&amp;gt;&lt;br/&gt;
                           &amp;lt;dsName&amp;gt;java:comp/env/jdbc/db1&amp;lt;/dsName&amp;gt;&lt;br/&gt;
                           &amp;lt;url&amp;gt;jdbc:mysql://localhost:3306/SEQUENCE_DB&amp;lt;/url&amp;gt;&lt;br/&gt;
                           &amp;lt;icClass&amp;gt;org.apache.naming.java.javaURLContextFactory&amp;lt;/icClass&amp;gt;&lt;br/&gt;
                        &amp;lt;/pool&amp;gt;&lt;br/&gt;
                     &amp;lt;/connection&amp;gt;&lt;br/&gt;
                     &amp;lt;statement&amp;gt;&lt;br/&gt;
                        &amp;lt;sql&amp;gt;INSERT INTO SEQUENCE VALUES ()&amp;lt;/sql&amp;gt;&lt;br/&gt;
                     &amp;lt;/statement&amp;gt;&lt;br/&gt;
                  &amp;lt;/dbreport&amp;gt;&lt;br/&gt;
=======================================================&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Execute the above DBReport mediator to reproduce the connection leak scenario.&lt;/li&gt;
&lt;/ul&gt;


</description>
                <environment>Tomcat 7, Atomikos 3.7.0, Synapse 2.1.0, MySQL 5.1.0.</environment>
        <key id="12554249">SYNAPSE-871</key>
            <summary>Connection Leaks When Using DBReport Mediator with XADataSources</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hiranya">Hiranya Kasub Jayathilaka</assignee>
                                    <reporter username="anjana">Anjana Fernando</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 May 2012 23:15:54 +0000</created>
                <updated>Sun, 18 Aug 2013 00:02:17 +0000</updated>
                            <resolved>Sun, 21 Jul 2013 01:29:18 +0000</resolved>
                                    <version>2.1</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13270082" author="anjana" created="Mon, 7 May 2012 23:17:59 +0000"  >&lt;p&gt;A patch to fix the above mentioned issue has been attached here.&lt;/p&gt;</comment>
                            <comment id="13714594" author="hiranya" created="Sun, 21 Jul 2013 01:29:18 +0000"  >&lt;p&gt;Applied the patch. Thanks Anjana for the contribution.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12525930" name="SYNAPSE-871-Patch.txt" size="2846" author="anjana" created="Mon, 7 May 2012 23:17:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>238478</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 18 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i17szz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>253667</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>