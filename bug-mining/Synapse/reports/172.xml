<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:07:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SYNAPSE-304] BaseUtils uses incorrect strategy to distinguish between XML, text and binary</title>
                <link>https://issues.apache.org/jira/browse/SYNAPSE-304</link>
                <project id="12310201" key="SYNAPSE">Synapse</project>
                    <description>&lt;p&gt;BaseUtils#setSOAPEnvelope (together with BaseUtils#handleLegacyMessage) is used by the  VFS, Mail, JMS and AMQP transports and implements the following strategy to distinguish between XML, text and binary payloads: It first tries to parse the payload as XML. If that fails, it tries to load it as text using BaseUtils#getMessageTextPayload. If that fails again, it loads the message as binary data using BaseUtils#getMessageBinaryPayload.&lt;/p&gt;

&lt;p&gt;This strategy has the following flaws:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Corrupted or invalid XML messages are not detected as such but interpreted as text or binary data. This will almost certainly lead to errors at a later stage in the processing (typically in a mediation that doesn&apos;t expect text or binary payloads), but for the user it is difficult to identify the root cause of the problem.&lt;/li&gt;
	&lt;li&gt;The VFSUtils and MailUtils implementation of the getMessageTextPayload method actually never fail (except if the file or mime part can&apos;t be read). The reason is that they read the content as binary and then construct a String object using new String(byte[]). This constructor never throws an exception, even if there are byte sequences not valid in the platform&apos;s default charset. Therefore the VFS and mail transport listeners will never process messages as binary payloads. This problem can&apos;t be solved because there is in fact no (reliable) way to distinguish text from binary data by inspecting the content alone. Also note that using the platform&apos;s default charset to decode the message is also incorrect (see &lt;a href=&quot;https://issues.apache.org/jira/browse/SYNAPSE-261&quot; title=&quot;VFS transport doesn&amp;#39;t handle text file encoding&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SYNAPSE-261&quot;&gt;&lt;del&gt;SYNAPSE-261&lt;/del&gt;&lt;/a&gt;).&lt;/li&gt;
	&lt;li&gt;This approach doesn&apos;t allow using custom message builders to parse messages that are neither XML nor plain text or binary.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think that every transport should first determine the content type of the message and than decode the message according to that content type, rather than trying different ways to decode the message. The decoding should be delegated to the message builder corresponding to the content type. This approach has the following advantages:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Corrupted or invalid messages trigger an appropriate error immediately.&lt;/li&gt;
	&lt;li&gt;Since for text payloads the content type can include information about the charset (text/plain; charset=...), it provides a straightforward solution for issues like &lt;a href=&quot;https://issues.apache.org/jira/browse/SYNAPSE-261&quot; title=&quot;VFS transport doesn&amp;#39;t handle text file encoding&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SYNAPSE-261&quot;&gt;&lt;del&gt;SYNAPSE-261&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;Custom message builders can be used.&lt;/li&gt;
	&lt;li&gt;It naturally fits into Axis&apos; architecture since it correctly uses the concepts of transport and message builder.&lt;/li&gt;
	&lt;li&gt;It leads to a more consistent behavior between different transports (in particular with the NIO HTTP transport).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The transport should determine the content type either from the service configuration (e.g. the transport.vfs.ContentType property for VFS) or from information available at the transport protocol level (Content-Type header for mail messages, FileContentInfo or file suffix for VFS, message type for JMS, etc.).&lt;/p&gt;

&lt;p&gt;The algorithm to select the message builder based on the content type and to invoke it to create the SOAP infoset is already implemented in the TransportUtils.createSOAPMessage utility method in the Axis2 kernel (which is also used by the NIO HTTP and the UDP transport). Therefore the proposed changes are:&lt;br/&gt;
1. Create message builders for text and binary payloads (which are the counterparts of PlainTextFormatter and BinaryFormatter introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/SYNAPSE-261&quot; title=&quot;VFS transport doesn&amp;#39;t handle text file encoding&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SYNAPSE-261&quot;&gt;&lt;del&gt;SYNAPSE-261&lt;/del&gt;&lt;/a&gt;).&lt;br/&gt;
2. Let ServerManager#start register these new message builders by default in the Axis configuration for content types &quot;text/plain&quot; and &quot;application/octet-stream&quot; respectively (in a similar way as AxisConfigBuilder#populateConfig registers default message builders for text/xml, application/soap+xml, etc.). In addition they should be added to the default axis2.xml file shipped with Synapse.&lt;br/&gt;
3. Make sure that every affected transport implements an appropriate strategy to determine the content type and uses TransportUtils.createSOAPMessage instead of BaseUtils#setSOAPEnvelope to process the message payload.&lt;br/&gt;
4. Remove BaseUtils#setSOAPEnvelope and related code without replacement.&lt;/p&gt;

&lt;p&gt;The proposed work plan is as follows:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;For release 1.2, implement 1 and 2 as well as 3 for the VFS transport. This allows to completely resolve issue &lt;a href=&quot;https://issues.apache.org/jira/browse/SYNAPSE-261&quot; title=&quot;VFS transport doesn&amp;#39;t handle text file encoding&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SYNAPSE-261&quot;&gt;&lt;del&gt;SYNAPSE-261&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;For release 1.3, implement 3 and 4 for all remaining transports (for JMS and AMQP after &lt;a href=&quot;https://issues.apache.org/jira/browse/SYNAPSE-303&quot; title=&quot;Create abstract messaging transport&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SYNAPSE-303&quot;&gt;&lt;del&gt;SYNAPSE-303&lt;/del&gt;&lt;/a&gt; has been handled).&lt;/li&gt;
&lt;/ul&gt;

</description>
                <environment></environment>
        <key id="12395788">SYNAPSE-304</key>
            <summary>BaseUtils uses incorrect strategy to distinguish between XML, text and binary</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="veithen">Andreas Veithen-Knowles</assignee>
                                    <reporter username="veithen">Andreas Veithen-Knowles</reporter>
                        <labels>
                    </labels>
                <created>Sat, 10 May 2008 21:37:49 +0000</created>
                <updated>Thu, 2 May 2013 02:29:15 +0000</updated>
                            <resolved>Wed, 29 Oct 2008 21:43:31 +0000</resolved>
                                                    <fixVersion>2.0</fixVersion>
                                    <component>Transports</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12595905" author="veithen" created="Sun, 11 May 2008 12:03:49 +0000"  >&lt;p&gt;The way the VFS transport determines the content type needs review. Indeed VFSTransportListener#startListeningForService considers the content type as a mandatory service parameter (see usage of getRequiredServiceParam), while VFSTransportListener#processFile defines some fallback mechanisms (such as looking at the file name suffix) if it is not specified as service parameter...&lt;/p&gt;

&lt;p&gt;I will leave it like that for 1.2, but for 1.3 we should sort this out.&lt;/p&gt;</comment>
                            <comment id="12595908" author="veithen" created="Sun, 11 May 2008 13:04:48 +0000"  >&lt;p&gt;Things in scope for the 1.2 release have been implemented. Items planned for 1.3 will be implemented later.&lt;/p&gt;</comment>
                            <comment id="12643665" author="veithen" created="Wed, 29 Oct 2008 21:43:31 +0000"  >&lt;p&gt;The mail, VFS and JMS transports now all use message builders and the code in BaseUtils#setSOAPEnvelope (and related methods) has been moved to AMQPUtils (the AMQP transport being the last transport using it). Since &lt;a href=&quot;https://issues.apache.org/jira/browse/SYNAPSE-303&quot; title=&quot;Create abstract messaging transport&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SYNAPSE-303&quot;&gt;&lt;del&gt;SYNAPSE-303&lt;/del&gt;&lt;/a&gt; has been deferred, the present issue can be considered as resolved.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12398201">SYNAPSE-359</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12392211">SYNAPSE-261</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12395786">SYNAPSE-303</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>183533</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 4 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i11imf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>216983</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>