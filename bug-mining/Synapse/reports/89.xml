<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:07:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SYNAPSE-225] Leaking resources when the connection times out.</title>
                <link>https://issues.apache.org/jira/browse/SYNAPSE-225</link>
                <project id="12310201" key="SYNAPSE">Synapse</project>
                    <description>&lt;p&gt;I&apos;m using 1.1.1-RC1.  When a connection times out, I can see using lsof pipes being left open.  This does not happen when the connection works normally.&lt;/p&gt;

&lt;p&gt;Steps to reproduce:&lt;/p&gt;

&lt;p&gt;1. Check the open files&lt;br/&gt;
2. Run the SimpleStockQuoteApplication successfully&lt;br/&gt;
3. Check the open files (open files will go up on the first successful request, but not subsequent successful request&lt;br/&gt;
4. Run the SimpleStockQuoteApplication this time with a  -Daddurl that will generate a timeout.&lt;br/&gt;
5. Check the open files.  Repeat steps 4 and 5.  The number will continue to grow.&lt;/p&gt;

&lt;p&gt;My output from a test:&lt;/p&gt;

&lt;p&gt;skrall@skralldesktop ~/files/downloads/synapse/synapse-1.1.1/samples/axis2Client $ lsof -p 27788 | wc -l&lt;br/&gt;
245&lt;br/&gt;
skrall@skralldesktop ~/files/downloads/synapse/synapse-1.1.1/samples/axis2Client $ lsof -p 27788 | grep pipe | wc -l&lt;br/&gt;
24&lt;br/&gt;
skrall@skralldesktop ~/files/downloads/synapse/synapse-1.1.1/samples/axis2Client $ ant stockquote -Daddurl=&lt;a href=&quot;http://localhost:9000/soap/SimpleStockQuoteService&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:9000/soap/SimpleStockQuoteService&lt;/a&gt; -Dtrpurl=&lt;a href=&quot;http://localhost:8080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080&lt;/a&gt;&lt;br/&gt;
Buildfile: build.xml&lt;/p&gt;

&lt;p&gt;init:&lt;/p&gt;

&lt;p&gt;compile:&lt;/p&gt;

&lt;p&gt;stockquote:&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; Standard :: Stock price = $99.43283516858692&lt;/p&gt;

&lt;p&gt;BUILD SUCCESSFUL&lt;br/&gt;
Total time: 2 seconds&lt;br/&gt;
skrall@skralldesktop ~/files/downloads/synapse/synapse-1.1.1/samples/axis2Client $ lsof -p 27788 | wc -l&lt;br/&gt;
245&lt;br/&gt;
skrall@skralldesktop ~/files/downloads/synapse/synapse-1.1.1/samples/axis2Client $ lsof -p 27788 | grep pipe | wc -l&lt;br/&gt;
24&lt;/p&gt;

&lt;p&gt;skrall@skralldesktop ~/files/downloads/synapse/synapse-1.1.1/samples/axis2Client $ ant stockquote -Daddurl=http://&amp;lt;HostThatWillCauseTimeout&amp;gt;:9000/soap/SimpleStockQuoteService -Dtrpurl=&lt;a href=&quot;http://localhost:8080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080&lt;/a&gt;&lt;br/&gt;
Buildfile: build.xml&lt;/p&gt;

&lt;p&gt;init:&lt;/p&gt;

&lt;p&gt;compile:&lt;/p&gt;

&lt;p&gt;stockquote:&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; 2008-01-15 16:05:40,829 &lt;span class=&quot;error&quot;&gt;&amp;#91;-&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt;  INFO HTTPSender Unable to sendViaPost to url&lt;a href=&quot;http://localhost:8080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080&lt;/a&gt;&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; java.net.SocketTimeoutException: Read timed out&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at java.net.SocketInputStream.socketRead0(Native Method)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at java.net.SocketInputStream.read(SocketInputStream.java:129)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at java.io.BufferedInputStream.fill(BufferedInputStream.java:218)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at java.io.BufferedInputStream.read(BufferedInputStream.java:237)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpParser.readRawLine(HttpParser.java:77)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpParser.readLine(HttpParser.java:105)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpConnection.readLine(HttpConnection.java:1115)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.MultiThreadedHttpConnectionManager$HttpConnectionAdapter.readLine(MultiThreadedHttpConnectionManager.java:1373)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpMethodBase.readStatusLine(HttpMethodBase.java:1832)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpMethodBase.readResponse(HttpMethodBase.java:1590)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpMethodBase.execute(HttpMethodBase.java:995)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpMethodDirector.executeWithRetry(HttpMethodDirector.java:397)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpMethodDirector.executeMethod(HttpMethodDirector.java:170)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpClient.executeMethod(HttpClient.java:396)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpClient.executeMethod(HttpClient.java:346)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.transport.http.AbstractHTTPSender.executeMethod(AbstractHTTPSender.java:520)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.transport.http.HTTPSender.sendViaPost(HTTPSender.java:191)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.transport.http.HTTPSender.send(HTTPSender.java:77)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.transport.http.CommonsHTTPTransportSender.writeMessageWithCommons(CommonsHTTPTransportSender.java:327)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.transport.http.CommonsHTTPTransportSender.invoke(CommonsHTTPTransportSender.java:206)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.engine.AxisEngine.send(AxisEngine.java:396)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.description.OutInAxisOperationClient.send(OutInAxisOperation.java:374)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.description.OutInAxisOperationClient.executeImpl(OutInAxisOperation.java:211)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.client.OperationClient.execute(OperationClient.java:163)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.client.ServiceClient.sendReceive(ServiceClient.java:528)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.client.ServiceClient.sendReceive(ServiceClient.java:508)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at samples.userguide.StockQuoteClient.executeClient(Unknown Source)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at samples.userguide.StockQuoteClient.main(Unknown Source)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; org.apache.axis2.AxisFault: Read timed out&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.AxisFault.makeFault(AxisFault.java:417)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.transport.http.HTTPSender.sendViaPost(HTTPSender.java:195)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.transport.http.HTTPSender.send(HTTPSender.java:77)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.transport.http.CommonsHTTPTransportSender.writeMessageWithCommons(CommonsHTTPTransportSender.java:327)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.transport.http.CommonsHTTPTransportSender.invoke(CommonsHTTPTransportSender.java:206)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.engine.AxisEngine.send(AxisEngine.java:396)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.description.OutInAxisOperationClient.send(OutInAxisOperation.java:374)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.description.OutInAxisOperationClient.executeImpl(OutInAxisOperation.java:211)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.client.OperationClient.execute(OperationClient.java:163)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.client.ServiceClient.sendReceive(ServiceClient.java:528)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.client.ServiceClient.sendReceive(ServiceClient.java:508)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at samples.userguide.StockQuoteClient.executeClient(Unknown Source)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at samples.userguide.StockQuoteClient.main(Unknown Source)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt; Caused by: java.net.SocketTimeoutException: Read timed out&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at java.net.SocketInputStream.socketRead0(Native Method)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at java.net.SocketInputStream.read(SocketInputStream.java:129)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at java.io.BufferedInputStream.fill(BufferedInputStream.java:218)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at java.io.BufferedInputStream.read(BufferedInputStream.java:237)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpParser.readRawLine(HttpParser.java:77)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpParser.readLine(HttpParser.java:105)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpConnection.readLine(HttpConnection.java:1115)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.MultiThreadedHttpConnectionManager$HttpConnectionAdapter.readLine(MultiThreadedHttpConnectionManager.java:1373)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpMethodBase.readStatusLine(HttpMethodBase.java:1832)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpMethodBase.readResponse(HttpMethodBase.java:1590)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpMethodBase.execute(HttpMethodBase.java:995)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpMethodDirector.executeWithRetry(HttpMethodDirector.java:397)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpMethodDirector.executeMethod(HttpMethodDirector.java:170)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpClient.executeMethod(HttpClient.java:396)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.commons.httpclient.HttpClient.executeMethod(HttpClient.java:346)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.transport.http.AbstractHTTPSender.executeMethod(AbstractHTTPSender.java:520)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     at org.apache.axis2.transport.http.HTTPSender.sendViaPost(HTTPSender.java:191)&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;java&amp;#93;&lt;/span&gt;     ... 11 more&lt;/p&gt;

&lt;p&gt;BUILD SUCCESSFUL&lt;br/&gt;
Total time: 32 seconds&lt;br/&gt;
skrall@skralldesktop ~/files/downloads/synapse/synapse-1.1.1/samples/axis2Client $ lsof -p 27788 | wc -l&lt;br/&gt;
250&lt;br/&gt;
skrall@skralldesktop ~/files/downloads/synapse/synapse-1.1.1/samples/axis2Client $ lsof -p 27788 | grep pipe | wc -l&lt;br/&gt;
28&lt;/p&gt;</description>
                <environment>[&lt;a href=&apos;mailto:root@lou-lxapachetest&apos;&gt;root@lou-lxapachetest&lt;/a&gt; ~]# cat /etc/redhat-release &lt;br/&gt;
Red Hat Enterprise Linux Server release 5.1 (Tikanga)&lt;br/&gt;
[&lt;a href=&apos;mailto:root@lou-lxapachetest&apos;&gt;root@lou-lxapachetest&lt;/a&gt; ~]# uname -a&lt;br/&gt;
Linux lou-lxapachetest 2.6.18-53.el5 #1 SMP Wed Oct 10 16:34:02 EDT 2007 i686 i686 i386 GNU/Linux&lt;br/&gt;
[&lt;a href=&apos;mailto:root@lou-lxapachetest&apos;&gt;root@lou-lxapachetest&lt;/a&gt; ~]# java -version&lt;br/&gt;
java version &amp;quot;1.5.0_13&amp;quot;&lt;br/&gt;
Java(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_13-b05)&lt;br/&gt;
Java HotSpot(TM) Client VM (build 1.5.0_13-b05, mixed mode, sharing)&lt;br/&gt;
[&lt;a href=&apos;mailto:root@lou-lxapachetest&apos;&gt;root@lou-lxapachetest&lt;/a&gt; ~]# &lt;br/&gt;
</environment>
        <key id="12386307">SYNAPSE-225</key>
            <summary>Leaking resources when the connection times out.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ruwan">Ruwan Linton</assignee>
                                    <reporter username="skrall">SteveKrall</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 Jan 2008 21:29:34 +0000</created>
                <updated>Wed, 23 Apr 2008 04:07:07 +0000</updated>
                            <resolved>Tue, 22 Apr 2008 06:10:09 +0000</resolved>
                                    <version>1.1.1</version>
                                    <fixVersion>1.2</fixVersion>
                                    <component>Transports</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12564066" author="skrall" created="Wed, 30 Jan 2008 15:54:09 +0000"  >&lt;p&gt;Another way that I can see this behavior is to just hit &lt;a href=&quot;http://localhost:8080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080&lt;/a&gt; with a web browser, and watching the open files for the synapse process.&lt;/p&gt;

&lt;p&gt;Our server is running out of open files, I think mostly due to the first scenario above.  But just hitting the server with the web browser is a little easier to reproduce.  &lt;/p&gt;

&lt;p&gt;I tried 1.1.1 the final release, and the issue is still there.&lt;/p&gt;</comment>
                            <comment id="12589287" author="jef" created="Tue, 15 Apr 2008 23:40:48 +0000"  >&lt;p&gt;DISCLAIMER - I am not now, nor have I ever been, a Java developer.&lt;/p&gt;

&lt;p&gt;From what I can tell there are two issues, both with org.apache.synapse.transport.nhttp.ServerHandler:&lt;/p&gt;

&lt;p&gt;Problem #1: sink() and source() channels opened in requestReceived() only get closed in inputReady() and outputReady() respectively.  &lt;/p&gt;

&lt;p&gt;If the request is null (for instance, you hit &lt;a href=&quot;http://localhost:8080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080&lt;/a&gt; with a browser) inputReady does not get called and the sink() channel stays open.  Likewise, if there is no response (say, you send the request straight to a drop mediator)  outputReady does not get run and the source() channel stays open.&lt;/p&gt;

&lt;p&gt;Solution #1:  Check to make sure the source() and sink() channels are closed when closed() is called.  This should clean up anything that wasn&apos;t closed by inputReady() or outputReady():&lt;/p&gt;

&lt;p&gt;    public void closed(final NHttpServerConnection conn) {&lt;/p&gt;

&lt;p&gt;        // Check sink and source channels and close them if they aren&apos;t closed already.&lt;br/&gt;
        // Normally these should be closed by inputReady() and outputReady(). A null request&lt;br/&gt;
        // or response will not hit inputReady and outputReady however.&lt;/p&gt;

&lt;p&gt;        HttpContext context = conn.getContext();&lt;br/&gt;
        WritableByteChannel sink = (WritableByteChannel) context.getAttribute(REQUEST_SINK_CHANNEL);&lt;br/&gt;
        ReadableByteChannel source = (ReadableByteChannel) context.getAttribute(RESPONSE_SOURCE_CHANNEL);&lt;br/&gt;
        try {&lt;br/&gt;
            if (sink.isOpen()) {&lt;br/&gt;
                sink.close();&lt;br/&gt;
                if (log.isTraceEnabled()) &lt;/p&gt;
{
                    log.trace(&quot;Closed stale sink channel&quot;);
                }
&lt;p&gt;            }&lt;br/&gt;
            if (source.isOpen()) {&lt;br/&gt;
                source.close();&lt;br/&gt;
                if (log.isTraceEnabled()) &lt;/p&gt;
{
                    log.trace(&quot;Closed stale source channel&quot;);
                }
&lt;p&gt;            }&lt;br/&gt;
        } catch (IOException ignore) {}&lt;/p&gt;

&lt;p&gt;        if (log.isTraceEnabled()) &lt;/p&gt;
{
            log.trace(&quot;Connection closed&quot;);
        }
&lt;p&gt;    }&lt;/p&gt;


&lt;p&gt;I can&apos;t think of any reason not to close those channels on connection close, but I didn&apos;t audit the code exhaustively.  Using the browser connection to &lt;a href=&quot;http://localhost:8080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080&lt;/a&gt; to reproduce, this gets me from 4 leaked FIFO pipes to 2.&lt;/p&gt;

&lt;p&gt;Problem #2:  Each pipe has two channels, sink() and source().  requestReceived() opens two pipes, requestPipe and responsePipe.  The sink() channel on requestPipe is assigned and passed to the ServerWorker process.  The source() channel on the responsePipe is assigned and passed to the ServerWorker process.  This leaves the source() channel on requestPipe and the sink() channel on responsePipe unassigned to anything, but still consuming FIFO handles as reported by lsof.  Also they never get closed, as they are neither assigned nor can they be referrenced.&lt;/p&gt;

&lt;p&gt;Solution #2:  Open an single pipe and assign the sink() channel to the input stream and the source() channel to the output stream.  Not only does it take less resource, it avoids creating orphans of the unused channels:&lt;/p&gt;

&lt;p&gt;    public void requestReceived(final NHttpServerConnection conn) {&lt;/p&gt;

&lt;p&gt;        HttpContext context = conn.getContext();&lt;br/&gt;
        HttpRequest request = conn.getHttpRequest();&lt;br/&gt;
        context.setAttribute(ExecutionContext.HTTP_REQUEST, request);&lt;/p&gt;

&lt;p&gt;        // allocate temporary buffers to process this request&lt;br/&gt;
        context.setAttribute(REQUEST_BUFFER, ByteBuffer.allocate(cfg.getBufferZise()));&lt;br/&gt;
        context.setAttribute(RESPONSE_BUFFER, ByteBuffer.allocate(cfg.getBufferZise()));&lt;/p&gt;

&lt;p&gt;        try {&lt;br/&gt;
            PipeImpl handlerPipe = new PipeImpl(); // the pipe for request and response&lt;br/&gt;
            context.setAttribute(REQUEST_SINK_CHANNEL, handlerPipe.sink());&lt;br/&gt;
            context.setAttribute(RESPONSE_SOURCE_CHANNEL, handlerPipe.source());&lt;/p&gt;

&lt;p&gt;            // create the default response to this request&lt;br/&gt;
            ProtocolVersion httpVersion = request.getRequestLine().getProtocolVersion();&lt;br/&gt;
            HttpResponse response = responseFactory.newHttpResponse(&lt;br/&gt;
                httpVersion, HttpStatus.SC_OK, context);&lt;br/&gt;
            response.setParams(this.params);&lt;/p&gt;

&lt;p&gt;            // create a basic HttpEntity using the source channel of the response pipe&lt;br/&gt;
            BasicHttpEntity entity = new BasicHttpEntity();&lt;br/&gt;
            entity.setContent(Channels.newInputStream(handlerPipe.source()));&lt;br/&gt;
            if (httpVersion.greaterEquals(HttpVersion.HTTP_1_1)) &lt;/p&gt;
{
                entity.setChunked(true);
            }
&lt;p&gt;            response.setEntity(entity);&lt;/p&gt;

&lt;p&gt;            // hand off processing of the request to a thread off the pool&lt;br/&gt;
            workerPool.execute(&lt;br/&gt;
                new ServerWorker(cfgCtx, conn, isHttps, metrics, this,&lt;br/&gt;
                    request, Channels.newInputStream(handlerPipe.source()),&lt;br/&gt;
                    response, Channels.newOutputStream(handlerPipe.sink())));&lt;/p&gt;

&lt;p&gt;        } catch (IOException e) {&lt;br/&gt;
            handleException(&quot;Error processing request received for : &quot; +&lt;br/&gt;
                request.getRequestLine().getUri(), e, conn);&lt;br/&gt;
            if (metrics != null) &lt;/p&gt;
{
               metrics.incrementFaultsReceiving();
            }
&lt;p&gt;        } catch (Exception e) {&lt;br/&gt;
            handleException(&quot;Error processing request received for : &quot; +&lt;br/&gt;
                request.getRequestLine().getUri(), e, conn);&lt;br/&gt;
            if (metrics != null) &lt;/p&gt;
{
                metrics.incrementFaultsReceiving();
            }
&lt;p&gt;        }&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;These changes appear to solve the problem for me, though I haven&apos;t tested exhaustively.  My test box for this:&lt;/p&gt;

&lt;p&gt;webdev:~# cat /etc/redhat-release&lt;br/&gt;
CentOS release 5 (Final)&lt;/p&gt;

&lt;p&gt;webdev:~# uname -a&lt;br/&gt;
Linux webdev.siriuscom.com 2.6.18-53.el5xen #1 SMP Mon Nov 12 03:26:12 EST 2007 i686 i686 i386 GNU/Linux&lt;/p&gt;

&lt;p&gt;webdev:~# java -version&lt;br/&gt;
java version &quot;1.5.0_14&quot;&lt;br/&gt;
Java(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_14-b03)&lt;br/&gt;
Java HotSpot(TM) Client VM (build 1.5.0_14-b03, mixed mode, sharing)&lt;/p&gt;

&lt;p&gt;webdev:~# ls -l synapse-1.1.1-src.tar.gz&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 root root 6167030 Jan 28 08:04 synapse-1.1.1-src.tar.gz&lt;/p&gt;

&lt;p&gt;--Jef.&lt;/p&gt;</comment>
                            <comment id="12590280" author="asankha" created="Fri, 18 Apr 2008 04:05:44 +0000"  >&lt;p&gt;Hi Jef&lt;/p&gt;

&lt;p&gt;Sorry to reply to this a bit late.. but thanks for the very detailed analysis and your findings in helping us fix this issue. I will attend to this ASAP or this will be committed by Ruwan soon.&lt;/p&gt;

&lt;p&gt;Thanks again and we look forward to your continued help&lt;br/&gt;
asankha&lt;/p&gt;</comment>
                            <comment id="12590511" author="jef" created="Fri, 18 Apr 2008 16:44:21 +0000"  >&lt;p&gt;Thanks, Asankha.  In further testing, I&apos;m seeing some problems with the fix above thowing a ClosedChannelException in ClientWorker in in some normal circumstances (i.e., sequence not terminated by a Drop mediator - which is my application).  Not sure if this is my channel cleanup or the combining of the req and resp pipes, but I&apos;m looking into it.&lt;/p&gt;

&lt;p&gt;Efficacy of the solution notwithstanding, I think the problem determination is basically correct.&lt;/p&gt;

&lt;p&gt;Jef.&lt;/p&gt;</comment>
                            <comment id="12591209" author="ruwan" created="Tue, 22 Apr 2008 06:04:29 +0000"  >&lt;p&gt;Thanks Jeff for providing the correct guidance to find the root cause, and thanks Steve for figuring this out. This seems to be a hidden issue. After an extensive debugging session with the help of Asankha (who fond the root cause according to the explanation of Jeff), I was able to fix this issue.&lt;/p&gt;

&lt;p&gt;We open the sink and the source from a pipe and do not (actually we cannot) use the source of the same pipe to serialize the response and are using a different pipe for the response. So on the exceptional flow, one of either sink or source left open and hence O/S does not release the pipe.&lt;/p&gt;

&lt;p&gt;Now it seems fixed, Jeff and Steve you may verify this fix so that we are 100% sure&lt;/p&gt;</comment>
                            <comment id="12591210" author="ruwan" created="Tue, 22 Apr 2008 06:10:08 +0000"  >&lt;p&gt;Fixed on the SVN trunk&lt;/p&gt;</comment>
                            <comment id="12591480" author="jef" created="Tue, 22 Apr 2008 23:45:03 +0000"  >&lt;p&gt;Ruwan - thanks very much to you and Anankha for your work in resolving this.  From my testing, the fix in SVN 650563 looks good.&lt;/p&gt;

&lt;p&gt;I tested the following scenarios in synapse-1.1.1 (pre-fix) and synapse-1.2-SNAPSHOT (650563) (post-fix):&lt;/p&gt;

&lt;p&gt;Scenario 1, normal request/response via proxy.&lt;/p&gt;

&lt;p&gt;1. SOAP consumer posts request to Synapse at &lt;a href=&quot;http://localhost:8080/soap/Proxied_Service&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/soap/Proxied_Service&lt;/a&gt;&lt;br/&gt;
2. Synapse forwards request to external SOAP provider&lt;br/&gt;
3. External SOAP provider returns response to Synapse&lt;br/&gt;
4. Synapse forwards response to SOAP consumer&lt;/p&gt;

&lt;p&gt;FIFO leaks: two in pre-fix, zero in post-fix.&lt;/p&gt;

&lt;p&gt;Scenario 2, null request to Synapse:&lt;/p&gt;

&lt;p&gt;1. Web browser accesses &lt;a href=&quot;http://localhost:8080/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;FIFO leaks: four in pre-fix, zero in post-fix.&lt;/p&gt;

&lt;p&gt;Scenario 3, null response to client:&lt;/p&gt;

&lt;p&gt;1. SOAP consumer posts request to Synapse at &lt;a href=&quot;http://localhost:8080/soap/Proxied_Service&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/soap/Proxied_Service&lt;/a&gt;&lt;br/&gt;
2. Synapse forwards request to external SOAP provider&lt;br/&gt;
3. External SOAP provider returns response to Synapse&lt;br/&gt;
4. Synapse routes response message to drop mediator&lt;/p&gt;

&lt;p&gt;FIFO leaks: 5 in pre-fix, zero in post fix.&lt;/p&gt;

&lt;p&gt;As you and Asankha are also maintainers on the WSO2-ESB project, you may also be interested to know that I ran these tests against a standalone synapse and also the 2008-01-30 snapshot of wso2-esb-1.6 (with updated synapse-transports and httpcore jars, the latter needed for DefaultedHttpParams.class).  Everything identical to results above.&lt;/p&gt;

&lt;p&gt;In wso2-esb, I also tested replacing the SOAP consumer in Scenario 3 with a message injected by the messageInjector task - three leaks pre-fix, zero leaks post-fix.  Works great.&lt;/p&gt;

&lt;p&gt;Again, thanks for your outstanding efforts on this one.&lt;/p&gt;

&lt;p&gt;Jef.&lt;/p&gt;</comment>
                            <comment id="12591522" author="asankha" created="Wed, 23 Apr 2008 03:23:40 +0000"  >&lt;p&gt;Jef / Steve&lt;/p&gt;

&lt;p&gt;Thank you both for bringing this to our notice and helping us to fix this.. although we did test and continue to use the free JProfiler license we have been granted - whenever we get the time, to make sure we release resources etc. some times I have seen leaks which are much more difficult to notice or figure out. These are best figured out by observation, analysis and human intelligence and code review.. and we are truly lucky to have great users like you to help us with these!&lt;/p&gt;

&lt;p&gt;cheers&lt;br/&gt;
asankha&lt;/p&gt;</comment>
                            <comment id="12591525" author="ruwan" created="Wed, 23 Apr 2008 04:07:07 +0000"  >&lt;p&gt;Jeff, &lt;/p&gt;

&lt;p&gt;Adding to Asankha, it is really great to see that we are having a community like you, steve and so on. Also thanks a lot for testing all these scenarios. To be frank, even I didn&apos;t check all the scenarios that you mentioned above and it is nice to see all of them are working as expected. Once again it is the community which drive these open source projects and thanks for providing us the right guidance.&lt;/p&gt;

&lt;p&gt;Ruwan&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>183455</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 32 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i11cjb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>215997</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>