<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:09:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SYNAPSE-1015] Message building fails at high concurrency when the outsequence is content aware </title>
                <link>https://issues.apache.org/jira/browse/SYNAPSE-1015</link>
                <project id="12310201" key="SYNAPSE">Synapse</project>
                    <description>&lt;p&gt;When invoke the following proxy at a concurrency (around 200) &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&amp;lt;proxy xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://ws.apache.org/ns/synapse&quot;&lt;/span&gt;
       name=&lt;span class=&quot;code-quote&quot;&gt;&quot;HelloProxy&quot;&lt;/span&gt;
       transports=&lt;span class=&quot;code-quote&quot;&gt;&quot;https,http&quot;&lt;/span&gt;
       statistics=&lt;span class=&quot;code-quote&quot;&gt;&quot;disable&quot;&lt;/span&gt;
       trace=&lt;span class=&quot;code-quote&quot;&gt;&quot;disable&quot;&lt;/span&gt;
       startOnLoad=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;&amp;gt;
   &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;target&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;inSequence&amp;gt;&lt;/span&gt;
         &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;send&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;endpoint&amp;gt;&lt;/span&gt;
               &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;address uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://localhost:9765/services/HelloService/&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/endpoint&amp;gt;&lt;/span&gt;
         &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/send&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/inSequence&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;outSequence&amp;gt;&lt;/span&gt;
         &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;enrich&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;source type=&lt;span class=&quot;code-quote&quot;&gt;&quot;inline&quot;&lt;/span&gt; clone=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
               &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;sss xmlns=&quot;&quot;&amp;gt;&lt;/span&gt;a&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/sss&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/source&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;target type=&lt;span class=&quot;code-quote&quot;&gt;&quot;property&quot;&lt;/span&gt; property=&lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
         &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/enrich&amp;gt;&lt;/span&gt;
         &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;send/&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/outSequence&amp;gt;&lt;/span&gt;
   &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/target&amp;gt;&lt;/span&gt;
   &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;publishWSDL uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://localhost:9765/services/HelloService?wsdl&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
   &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;description/&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/proxy&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Following exception occurs after a while,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2016-05-23 23:51:09,455 [-] [PassThroughMessageProcessor-30] ERROR RelayUtils Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; building PassThrough stream
org.apache.axiom.om.DeferredParsingException: com.ctc.wstx.exc.WstxUnexpectedCharException: Illegal character (NULL, unicode 0) encountered: not valid in any content
 at [row,col {unknown-source}]: [1,1]
	at org.apache.axiom.om.impl.builder.StAXOMBuilder.parserNext(StAXOMBuilder.java:681)
	at org.apache.axiom.om.impl.builder.StAXOMBuilder.next(StAXOMBuilder.java:184)
	at org.apache.axiom.core.CoreParentNodeSupport.ajc$interMethod$org_apache_axiom_core_CoreParentNodeSupport$org_apache_axiom_core_CoreParentNode$buildNext(CoreParentNodeSupport.aj:96)
	at org.apache.axiom.om.impl.llom.OMDocumentImpl.buildNext(OMDocumentImpl.java:1)
	at org.apache.axiom.core.CoreParentNodeSupport.ajc$interMethodDispatch1$org_apache_axiom_core_CoreParentNodeSupport$org_apache_axiom_core_CoreParentNode$buildNext(CoreParentNodeSupport.aj)
	at org.apache.axiom.core.CoreParentNodeSupport.ajc$interMethod$org_apache_axiom_core_CoreParentNodeSupport$org_apache_axiom_core_CoreParentNode$coreGetFirstChild(CoreParentNodeSupport.aj:113)
	at org.apache.axiom.om.impl.llom.OMDocumentImpl.coreGetFirstChild(OMDocumentImpl.java:1)
	at org.apache.axiom.core.CoreParentNodeSupport.ajc$interMethodDispatch1$org_apache_axiom_core_CoreParentNodeSupport$org_apache_axiom_core_CoreParentNode$coreGetFirstChild(CoreParentNodeSupport.aj)
	at org.apache.axiom.core.CoreDocumentSupport.ajc$interMethod$org_apache_axiom_core_CoreDocumentSupport$org_apache_axiom_core_CoreDocument$coreGetDocumentElement(CoreDocumentSupport.aj:42)
	at org.apache.axiom.om.impl.llom.OMDocumentImpl.coreGetDocumentElement(OMDocumentImpl.java:1)
	at org.apache.axiom.om.impl.common.AxiomDocumentSupport.ajc$interMethod$org_apache_axiom_om_impl_common_AxiomDocumentSupport$org_apache_axiom_om_impl_intf_AxiomDocument$getOMDocumentElement(AxiomDocumentSupport.aj:32)
	at org.apache.axiom.om.impl.llom.OMDocumentImpl.getOMDocumentElement(OMDocumentImpl.java:1)
	at org.apache.axiom.om.impl.builder.StAXOMBuilder.getDocumentElement(StAXOMBuilder.java:557)
	at org.apache.axiom.om.impl.builder.StAXOMBuilder.getDocumentElement(StAXOMBuilder.java:553)
	at org.apache.axis2.builder.SOAPBuilder.processDocument(SOAPBuilder.java:53)
	at org.apache.synapse.transport.passthru.util.DeferredMessageBuilder.getDocument(DeferredMessageBuilder.java:114)
	at org.apache.synapse.transport.passthru.util.RelayUtils.buildMessage(RelayUtils.java:146)
	at org.apache.synapse.transport.passthru.util.RelayUtils.buildMessage(RelayUtils.java:86)
	at org.apache.synapse.mediators.AbstractListMediator.mediate(AbstractListMediator.java:62)
	at org.apache.synapse.mediators.base.SequenceMediator.mediate(SequenceMediator.java:114)
	at org.apache.synapse.core.axis2.Axis2SynapseEnvironment.injectMessage(Axis2SynapseEnvironment.java:230)
	at org.apache.synapse.core.axis2.SynapseCallbackReceiver.handleMessage(SynapseCallbackReceiver.java:444)
	at org.apache.synapse.core.axis2.SynapseCallbackReceiver.receive(SynapseCallbackReceiver.java:221)
	at org.apache.axis2.engine.AxisEngine.receive(AxisEngine.java:169)
	at org.apache.synapse.transport.passthru.ClientWorker.run(ClientWorker.java:221)
	at org.apache.axis2.transport.base.threads.NativeWorkerPool$1.run(NativeWorkerPool.java:173)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: com.ctc.wstx.exc.WstxUnexpectedCharException: Illegal character (NULL, unicode 0) encountered: not valid in any content
 at [row,col {unknown-source}]: [1,1]
	at com.ctc.wstx.sr.StreamScanner.constructNullCharException(StreamScanner.java:630)
	at com.ctc.wstx.sr.StreamScanner.throwInvalidSpace(StreamScanner.java:660)
	at com.ctc.wstx.sr.StreamScanner.throwInvalidSpace(StreamScanner.java:651)
	at com.ctc.wstx.sr.BasicStreamReader.readSpacePrimary(BasicStreamReader.java:4965)
	at com.ctc.wstx.sr.BasicStreamReader.nextFromProlog(BasicStreamReader.java:2008)
	at com.ctc.wstx.sr.BasicStreamReader.next(BasicStreamReader.java:1134)
	at org.apache.axiom.util.stax.wrapper.XMLStreamReaderWrapper.next(XMLStreamReaderWrapper.java:225)
	at org.apache.axiom.util.stax.dialect.DisallowDoctypeDeclStreamReaderWrapper.next(DisallowDoctypeDeclStreamReaderWrapper.java:34)
	at org.apache.axiom.util.stax.wrapper.XMLStreamReaderWrapper.next(XMLStreamReaderWrapper.java:225)
	at org.apache.axiom.om.impl.builder.StAXOMBuilder.parserNext(StAXOMBuilder.java:666)
	... 28 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12972143">SYNAPSE-1015</key>
            <summary>Message building fails at high concurrency when the outsequence is content aware </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="raviu">Ravi Undupitiya</assignee>
                                    <reporter username="bsendruan">Senduran</reporter>
                        <labels>
                    </labels>
                <created>Mon, 23 May 2016 18:27:05 +0000</created>
                <updated>Fri, 9 Sep 2016 13:59:54 +0000</updated>
                            <resolved>Fri, 9 Sep 2016 13:59:53 +0000</resolved>
                                    <version>2.1</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>Core</component>
                    <component>Transports</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15296852" author="bsendruan" created="Mon, 23 May 2016 18:41:54 +0000"  >&lt;p&gt;Reason for this is, Pipe class has two variables(inBufferInputMode, outBufferInputMode) which are corresponding to its buffer and outputBuffer&apos;s read/write flag. &lt;br/&gt;
And setting the read / write mode is happening by passing the AtomicBoolean and buffer. Even though we have used compare and set. at high concurrency this does not behave as expected. Making the buffer self contained with its corresponding read / write flag eliminates this issue. &lt;/p&gt;

&lt;p&gt;As a fix I have wrapped the ByteBuffer with an atomic boolean (called ControlledByteBuffer), and using it instead of bytebuffer, setting to read mode / write mode  logic is written in controlledByteBuffer. &lt;/p&gt;</comment>
                            <comment id="15296855" author="bsendruan" created="Mon, 23 May 2016 18:42:38 +0000"  >&lt;p&gt;attaching the fix&lt;/p&gt;</comment>
                            <comment id="15302977" author="hiranya" created="Thu, 26 May 2016 21:38:14 +0000"  >&lt;p&gt;Can you briefly explain how having the atomic boolean flags separate from the buffers lead to this issue? I like the idea of the ControlledByteBuffer, but I&apos;d like to understand the exact root cause of the bug.&lt;/p&gt;</comment>
                            <comment id="15315591" author="bsendruan" created="Sat, 4 Jun 2016 17:52:07 +0000"  >&lt;p&gt;Hi Hiranya,&lt;/p&gt;

&lt;p&gt;First we identified, that some of the message building were failing at high concurrency(around 400). To narrow down the issue, we added verbose println statements to log the buffer&apos;s position and limit. We could observer that the failing requests got flipped / compacted additionally or didn&apos;t at all. Since before setting the input mode / output mode, the atomic boolean flag is getting set. So the only possible we could think of is, that the value of the atomic boolean is incorrect when it comes to set the value.(i.e the input mode is getting set only if the previous state is output mode, so if the state is already input mode it won&apos;t get set) The problem here is, per each request the pipe object is created. so the atomic boolean also created per pipe. And it is not possible to get an incorrect value. But according to the println statements that only possible could be the read / write flag is not set in correctly. So we  created the ControlledByteBuffer with ByteBuffer and its flag.&lt;/p&gt;

&lt;p&gt;Also recently we came across another issue. Which also validates the advantage of ByteBuffer and its flag are being together. &lt;br/&gt;
The issue is when response&apos;s end of chunk character comes after a delay, the consecutive request is not getting its response (request timeouts).&lt;br/&gt;
When the end of chunk flag is received after a delay and the decoder reads it as 0 bytes so the buffer is (still) empty and when it got compacted (in the setInputMode method) the buffer becomes full and the suspendInput() is called. so the consecutive request is getting timeout.  This issue occurs when the response path is content aware. When the message body is received(without end of chunk flag), it is produced to buffer successfully, and it is consumed from the outbuffer (since the response path is content aware). Meanwhile the buffer is cleared and released to the buffer factory (but note that the pipe object is still holding its reference and the inputMode of the buffer as false, because when buffer is read it calls the setOutput Mode and flag is set to false). &lt;br/&gt;
When the end of chunk flag is received, it is produced to the same buffer, (which is cleared and released to the buffer factory), but it gets compacted because the input mode is false, so setInputMode() set the flag to true and compact the empty buffer, which eventually becomes full and suspendInput is called. When we wrapped the ByteBuffer and its flag together, it won&apos;t happen because, when we release it to the factory, we forcefully set its input mode to true. so we can&apos;t again set the flag to true and it won&apos;t get compacted.&lt;/p&gt;

&lt;p&gt;Above explanations are based on my understanding and observation. I believe it gives some idea about the fix I tried.&lt;/p&gt;

&lt;p&gt;Thank you&lt;br/&gt;
Senduran &lt;/p&gt;</comment>
                            <comment id="15444039" author="raviu" created="Sun, 28 Aug 2016 20:09:49 +0000"  >&lt;p&gt;This fix is committed with revision 1758147. &lt;/p&gt;</comment>
                            <comment id="15444105" author="hudson" created="Sun, 28 Aug 2016 20:55:09 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Synapse - Trunk #5274 (See &lt;a href=&quot;https://builds.apache.org/job/Synapse%20-%20Trunk/5274/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Synapse%20-%20Trunk/5274/&lt;/a&gt;)&lt;br/&gt;
Fix by Senduran for &lt;a href=&quot;https://issues.apache.org/jira/browse/SYNAPSE-1015&quot; title=&quot;Message building fails at high concurrency when the outsequence is content aware &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SYNAPSE-1015&quot;&gt;&lt;del&gt;SYNAPSE-1015&lt;/del&gt;&lt;/a&gt; (ravi: rev 1758147)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) java/modules/transports/core/nhttp/src/main/java/org/apache/synapse/transport/passthru/Pipe.java&lt;/li&gt;
	&lt;li&gt;(edit) java/modules/transports/core/nhttp/src/main/java/org/apache/synapse/transport/passthru/SourceContext.java&lt;/li&gt;
	&lt;li&gt;(edit) java/modules/transports/core/nhttp/src/main/java/org/apache/synapse/transport/passthru/TargetContext.java&lt;/li&gt;
	&lt;li&gt;(edit) java/modules/transports/core/nhttp/src/main/java/org/apache/synapse/transport/passthru/util/BufferFactory.java&lt;/li&gt;
	&lt;li&gt;(add) java/modules/transports/core/nhttp/src/main/java/org/apache/synapse/transport/passthru/util/ControlledByteBuffer.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12805710" name="controlled-bytebuffer-fix.diff" size="15982" author="bsendruan" created="Mon, 23 May 2016 18:42:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 12 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ydsf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>