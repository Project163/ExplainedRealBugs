diff --git a/java/modules/core/src/main/java/org/apache/synapse/util/xpath/ThreadSafeDelegatingFunctionContext.java b/java/modules/core/src/main/java/org/apache/synapse/util/xpath/ThreadSafeDelegatingFunctionContext.java
index 4e5414e9c..ecdf9d40d 100755
--- a/java/modules/core/src/main/java/org/apache/synapse/util/xpath/ThreadSafeDelegatingFunctionContext.java
+++ b/java/modules/core/src/main/java/org/apache/synapse/util/xpath/ThreadSafeDelegatingFunctionContext.java
@@ -29,7 +29,7 @@ public class ThreadSafeDelegatingFunctionContext implements FunctionContext {
     private final ThreadLocal<FunctionContext> delegate = new ThreadLocal<FunctionContext>();
 
     public ThreadSafeDelegatingFunctionContext() {
-        this.delegate.set(new XPathFunctionContext());
+        this.delegate.set(new XPathFunctionContext(true));
     }
 
     public void setDelegate(FunctionContext delegate) {
diff --git a/java/modules/extensions/src/main/java/org/apache/synapse/mediators/xquery/MediatorCustomVariable.java b/java/modules/extensions/src/main/java/org/apache/synapse/mediators/xquery/MediatorCustomVariable.java
index d505d70d0..c8fcc0bfe 100644
--- a/java/modules/extensions/src/main/java/org/apache/synapse/mediators/xquery/MediatorCustomVariable.java
+++ b/java/modules/extensions/src/main/java/org/apache/synapse/mediators/xquery/MediatorCustomVariable.java
@@ -22,6 +22,7 @@ import net.sf.saxon.javax.xml.xquery.XQItemType;
 import org.apache.axiom.om.OMElement;
 import org.apache.axiom.om.OMNode;
 import org.apache.axiom.om.OMText;
+import org.apache.axiom.om.xpath.AXIOMXPath;
 import org.apache.axiom.soap.SOAP11Constants;
 import org.apache.axiom.soap.SOAP12Constants;
 import org.apache.commons.logging.Log;
@@ -48,7 +49,7 @@ public class MediatorCustomVariable extends MediatorVariable {
     /**
      * The XPath expression which yeilds the element from given XMLDocument
      */
-    private SynapseXPath expression;
+    private AXIOMXPath expression;
 
     /**
      * The key to lookup the xml document from registry
@@ -72,7 +73,7 @@ public class MediatorCustomVariable extends MediatorVariable {
         super(name);
         // create the default XPath
         try {
-            this.expression = new SynapseXPath(DEFAULT_XPATH);
+            this.expression = new AXIOMXPath(DEFAULT_XPATH);
             this.expression.addNamespace("s11", SOAP11Constants.SOAP_ENVELOPE_NAMESPACE_URI);
             this.expression.addNamespace("s12", SOAP12Constants.SOAP_ENVELOPE_NAMESPACE_URI);
         } catch (JaxenException e) {
@@ -164,7 +165,7 @@ public class MediatorCustomVariable extends MediatorVariable {
         throw new SynapseException(msg);
     }
 
-    public void setExpression(SynapseXPath expression) {
+    public void setExpression(AXIOMXPath expression) {
         this.expression = expression;
     }
 
@@ -176,7 +177,7 @@ public class MediatorCustomVariable extends MediatorVariable {
         return regKey;
     }
 
-    public SynapseXPath getExpression() {
+    public AXIOMXPath getExpression() {
         return expression;
     }
 }
diff --git a/java/modules/extensions/src/main/java/org/apache/synapse/mediators/xquery/XQueryMediator.java b/java/modules/extensions/src/main/java/org/apache/synapse/mediators/xquery/XQueryMediator.java
index 1f10afc10..439de87d2 100644
--- a/java/modules/extensions/src/main/java/org/apache/synapse/mediators/xquery/XQueryMediator.java
+++ b/java/modules/extensions/src/main/java/org/apache/synapse/mediators/xquery/XQueryMediator.java
@@ -25,6 +25,7 @@ import org.apache.axiom.om.OMNode;
 import org.apache.axiom.om.impl.builder.StAXOMBuilder;
 import org.apache.axiom.om.impl.dom.DOOMAbstractFactory;
 import org.apache.axiom.om.util.ElementHelper;
+import org.apache.axiom.om.xpath.AXIOMXPath;
 import org.apache.axiom.soap.SOAP11Constants;
 import org.apache.axiom.soap.SOAP12Constants;
 import org.apache.synapse.MessageContext;
@@ -33,7 +34,6 @@ import org.apache.synapse.config.Entry;
 import org.apache.synapse.config.SynapseConfigUtils;
 import org.apache.synapse.mediators.AbstractMediator;
 import org.apache.synapse.mediators.MediatorProperty;
-import org.apache.synapse.util.xpath.SynapseXPath;
 import org.jaxen.JaxenException;
 import org.w3c.dom.Element;
 import org.xml.sax.InputSource;
@@ -87,7 +87,7 @@ public class XQueryMediator extends AbstractMediator {
     /**
      * The (optional) XPath expression which yeilds the target element to attached the result
      */
-    private SynapseXPath target = null;
+    private AXIOMXPath target = null;
 
     /**
      * The list of variables for binding to the DyanamicContext in order to available for querying
@@ -122,7 +122,7 @@ public class XQueryMediator extends AbstractMediator {
     public XQueryMediator() {
         // create the default XPath
         try {
-            this.target = new SynapseXPath(DEFAULT_XPATH);
+            this.target = new AXIOMXPath(DEFAULT_XPATH);
             this.target.addNamespace("s11", SOAP11Constants.SOAP_ENVELOPE_NAMESPACE_URI);
             this.target.addNamespace("s12", SOAP12Constants.SOAP_ENVELOPE_NAMESPACE_URI);
         } catch (JaxenException e) {
@@ -600,7 +600,7 @@ public class XQueryMediator extends AbstractMediator {
      */
     public OMNode getTargetNode(MessageContext synCtx) {
         try {
-            Object o = target.evaluate(synCtx);
+            Object o = target.evaluate(synCtx.getEnvelope());
             if (o instanceof OMNode) {
                 return (OMNode) o;
             } else if (o instanceof List && !((List) o).isEmpty()) {
@@ -664,11 +664,11 @@ public class XQueryMediator extends AbstractMediator {
         return variables;
     }
 
-    public SynapseXPath getTarget() {
+    public AXIOMXPath getTarget() {
         return target;
     }
 
-    public void setTarget(SynapseXPath target) {
+    public void setTarget(AXIOMXPath target) {
         this.target = target;
     }
 
diff --git a/java/modules/extensions/src/main/java/org/apache/synapse/mediators/xquery/XQueryMediatorFactory.java b/java/modules/extensions/src/main/java/org/apache/synapse/mediators/xquery/XQueryMediatorFactory.java
index bfa3ef701..17d390582 100644
--- a/java/modules/extensions/src/main/java/org/apache/synapse/mediators/xquery/XQueryMediatorFactory.java
+++ b/java/modules/extensions/src/main/java/org/apache/synapse/mediators/xquery/XQueryMediatorFactory.java
@@ -21,6 +21,7 @@ package org.apache.synapse.mediators.xquery;
 import net.sf.saxon.javax.xml.xquery.XQItemType;
 import org.apache.axiom.om.OMAttribute;
 import org.apache.axiom.om.OMElement;
+import org.apache.axiom.om.xpath.AXIOMXPath;
 import org.apache.commons.logging.Log;
 import org.apache.commons.logging.LogFactory;
 import org.apache.synapse.Mediator;
@@ -73,11 +74,11 @@ public class XQueryMediatorFactory extends AbstractMediatorFactory {
             String targetValue = attrTarget.getAttributeValue();
             if (targetValue != null) {
                 try {
-                    xQueryMediator.setTarget(SynapseXPathFactory.getSynapseXPath(elem,
-                        new QName(XMLConfigConstants.NULL_NAMESPACE, "target")));
+                    AXIOMXPath xpath = new AXIOMXPath(attrTarget.getAttributeValue());
+                    OMElementUtils.addNameSpaces(xpath, elem, log);
+                    xQueryMediator.setTarget(xpath);
                 } catch (JaxenException e) {
-                    handleException("Invalid XPath specified for the target attribute : " +
-                        targetValue);
+                    handleException("Invalid XPath specified for the target attribute : " + targetValue);
                 }
             }
         }
@@ -114,8 +115,9 @@ public class XQueryMediatorFactory extends AbstractMediatorFactory {
                         }
                         if (expr != null && !"".equals(expr)) {
                             try {
-                                ((MediatorCustomVariable) variable).setExpression(
-                                    SynapseXPathFactory.getSynapseXPath(variableOM, ATT_EXPR_Q));
+                                AXIOMXPath xpath = new AXIOMXPath(expr);
+                                OMElementUtils.addNameSpaces(xpath, variableOM, log);
+                                ((MediatorCustomVariable) variable).setExpression(xpath);
 
                             } catch (JaxenException e) {
                                 handleException("Invalid XPath specified for" +
diff --git a/java/modules/extensions/src/main/java/org/apache/synapse/mediators/xquery/XQueryMediatorSerializer.java b/java/modules/extensions/src/main/java/org/apache/synapse/mediators/xquery/XQueryMediatorSerializer.java
index cee47dab0..891a03381 100644
--- a/java/modules/extensions/src/main/java/org/apache/synapse/mediators/xquery/XQueryMediatorSerializer.java
+++ b/java/modules/extensions/src/main/java/org/apache/synapse/mediators/xquery/XQueryMediatorSerializer.java
@@ -21,6 +21,7 @@ package org.apache.synapse.mediators.xquery;
 import net.sf.saxon.javax.xml.xquery.XQItemType;
 import org.apache.axiom.om.OMElement;
 import org.apache.axiom.om.OMNamespace;
+import org.apache.axiom.om.xpath.AXIOMXPath;
 import org.apache.commons.logging.Log;
 import org.apache.commons.logging.LogFactory;
 import org.apache.synapse.Mediator;
@@ -66,10 +67,11 @@ public class XQueryMediatorSerializer extends AbstractMediatorSerializer {
 
         saveTracingState(xquery, queryMediator);
 
-        SynapseXPath targetXPath = queryMediator.getTarget();
+        AXIOMXPath targetXPath = queryMediator.getTarget();
         if (targetXPath != null && !XQueryMediator.DEFAULT_XPATH.equals(targetXPath.toString())) {
 
-            SynapseXPathSerializer.serializeXPath(targetXPath, xquery, "target");
+            xquery.addAttribute(fac.createOMAttribute("target", nullNS, targetXPath.toString()));
+            serializeNamespaces(xquery, targetXPath);
         }
 
         List pros = queryMediator.getDataSourceProperties();
@@ -141,12 +143,13 @@ public class XQueryMediatorSerializer extends AbstractMediatorSerializer {
                             customElement.addAttribute(fac.createOMAttribute(
                                 "key", nullNS, regkey));
                         }
-                        SynapseXPath expression = variable.getExpression();
+                        AXIOMXPath expression = variable.getExpression();
                         if (expression != null &&
                             !XQueryMediator.DEFAULT_XPATH.equals(expression.toString())) {
 
-                            SynapseXPathSerializer.serializeXPath(
-                                expression, customElement, "expression");
+                            customElement.addAttribute(fac.createOMAttribute(
+                                    "expression", nullNS, expression.toString()));
+                            serializeNamespaces(customElement, expression);
                         }
                         String type = null;
                         int varibelType = variable.getType();
