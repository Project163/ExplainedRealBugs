{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3303","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3303/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3303/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3303/events","html_url":"https://github.com/sidekiq/sidekiq/issues/3303","id":198362625,"node_id":"MDU6SXNzdWUxOTgzNjI2MjU=","number":3303,"title":"Same job (identical JID) runs twice","user":{"login":"krallin","id":1737686,"node_id":"MDQ6VXNlcjE3Mzc2ODY=","avatar_url":"https://avatars.githubusercontent.com/u/1737686?v=4","gravatar_id":"","url":"https://api.github.com/users/krallin","html_url":"https://github.com/krallin","followers_url":"https://api.github.com/users/krallin/followers","following_url":"https://api.github.com/users/krallin/following{/other_user}","gists_url":"https://api.github.com/users/krallin/gists{/gist_id}","starred_url":"https://api.github.com/users/krallin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/krallin/subscriptions","organizations_url":"https://api.github.com/users/krallin/orgs","repos_url":"https://api.github.com/users/krallin/repos","events_url":"https://api.github.com/users/krallin/events{/privacy}","received_events_url":"https://api.github.com/users/krallin/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2017-01-02T17:26:29Z","updated_at":"2019-10-26T01:22:42Z","closed_at":"2017-01-09T17:46:46Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi there,\r\n\r\nRuby version: `ruby 2.2.4p230 (2015-12-16 revision 53155) [x86_64-linux]`\r\nSidekiq / Pro / Enterprise version(s): `sidekiq (3.5.0)`\r\n\r\nA little (hopefully useful) context: we're running Sidekiq in a slightly unconventional setup. Sidekiq is used to coordinate jobs across processing clusters that are running in different AWS regions and each run their own Redis instances (we have several hundreds of these).\r\n\r\nOccasionally, these Redis instances may be unreachable or laggy for various reasons:\r\n\r\n- They can be geographically pretty far away\r\n- There's other stuff running on these Redis instances, which can occasionally compete for resources\r\n\r\nBottom line, now and then it might take a little while to enqueue jobs to Redis, such that things time out.\r\n\r\nThis is pretty apparent in our logs: most of the time, it takes 0.25 seconds to enqueue a job, but now and then, it takes ~ 5.25 seconds (5 seconds happens to be the default timeout in redis-rb, which we use).\r\n\r\nUnfortunately, when it does take ~ 5.25 seconds, we end up with the same job (same JID) running twice on the destination instance concurrently. Here are some examples from our logs:\r\n\r\n```\r\n2016-12-28T23:05:45.137Z 14090 TID-m2cek Sweetness::Jobs::Delegate JID-5fe3127779677d1e133d1b40 INFO: start\r\n2016-12-28T23:05:45.160Z 14090 TID-1emhzg Sweetness::Jobs::Delegate JID-5fe3127779677d1e133d1b40 INFO: start\r\n2016-12-28T23:05:46.920Z 14090 TID-1emhzg Sweetness::Jobs::Delegate JID-5fe3127779677d1e133d1b40 INFO: done: 1.761 sec\r\n2016-12-28T23:05:47.052Z 14090 TID-m2cek Sweetness::Jobs::Delegate JID-5fe3127779677d1e133d1b40 INFO: done: 1.916 sec\r\n```\r\n\r\n```\r\n2016-12-28T23:14:19.572Z 18537 TID-fstk8 Sweetness::Jobs::Delegate JID-66a2c3098751a54024b37cb4 INFO: start\r\n2016-12-28T23:14:19.587Z 18537 TID-fgiwo Sweetness::Jobs::Delegate JID-66a2c3098751a54024b37cb4 INFO: start\r\n2016-12-28T23:14:21.296Z 18537 TID-fstk8 Sweetness::Jobs::Delegate JID-66a2c3098751a54024b37cb4 INFO: done: 1.723 sec\r\n2016-12-28T23:14:21.370Z 18537 TID-fgiwo Sweetness::Jobs::Delegate JID-66a2c3098751a54024b37cb4 INFO: done: 1.784 sec\r\n```\r\n\r\n```\r\n2016-12-29T00:47:06.545Z 8580 TID-fasn4 Sweetness::Jobs::Delegate JID-d28199210162a8974746661d INFO: start\r\n2016-12-29T00:47:06.559Z 8580 TID-e73h4 Sweetness::Jobs::Delegate JID-d28199210162a8974746661d INFO: start\r\n2016-12-29T00:47:07.616Z 8580 TID-e73h4 Sweetness::Jobs::Delegate JID-d28199210162a8974746661d INFO: done: 1.057 sec\r\n2016-12-29T00:47:07.906Z 8580 TID-fasn4 Sweetness::Jobs::Delegate JID-d28199210162a8974746661d INFO: done: 1.361 sec\r\n```\r\n\r\nIn each of these instances, the two threads running the same job at the same time are in the same process. I should also mention that retries are disabled here.\r\n\r\nI suspect this is caused by the fact that `redis-rb` automatically re-runs a command when it times out.\r\n\r\nI tried reproducing this locally by using `socat TCP-LISTEN:6379,fork,bind=0.0.0.0,reuseaddr STDOUT` to emulate an unresponsive Redis, and it appears that `redis-rb` will indeed push twice in this scenario (here's the output when I use `Redis.new.lpush('foo', 'bar')`):\r\n\r\n```\r\n*3\r\n$5\r\nlpush\r\n$3\r\nfoo\r\n$3\r\nbar\r\n*3\r\n$5\r\nlpush\r\n$3\r\nfoo\r\n$3\r\nbar\r\n```\r\n\r\n(of course, since Socat posing as Redis is completely unresponsive even after the retry, this will take 10 seconds before timing out on the client side, but the second `*3` line does show up 5 seconds after the first one)\r\n\r\nFor comparison, using `Redis.new(reconnect_attempts: 0).lpush('foo', 'bar')` does throw an error after the 5 seconds timeout, without retrying the `LPUSH` operation a second time.\r\n\r\nWe're planning to deploy the `reconnect_attempts: 0` workaround throughout our infrastructure soon (and we're happy to report whether that solves the issue), but I believe it's a design goal for Sidekiq that the same JID cannot execute concurrently across two workers (from here: https://github.com/mperham/sidekiq/issues/2398), so I thought perhaps you'd like to hear about this failure scenario! (and perhaps you'd want to set `reconnect_attempts` to 0 by default in Sidekiq?).\r\n\r\nThanks!","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3303/reactions","total_count":12,"+1":12,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3303/timeline","performed_via_github_app":null,"state_reason":"completed"}