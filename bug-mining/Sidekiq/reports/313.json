{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6061","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6061/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6061/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6061/events","html_url":"https://github.com/sidekiq/sidekiq/issues/6061","id":1919911767,"node_id":"I_kwDOADDA9M5yb4dX","number":6061,"title":"`no implicit conversion of String into Integer` in batch status after upgrade from 6 to 7","user":{"login":"jimmyaurora","id":127795831,"node_id":"U_kgDOB54Cdw","avatar_url":"https://avatars.githubusercontent.com/u/127795831?v=4","gravatar_id":"","url":"https://api.github.com/users/jimmyaurora","html_url":"https://github.com/jimmyaurora","followers_url":"https://api.github.com/users/jimmyaurora/followers","following_url":"https://api.github.com/users/jimmyaurora/following{/other_user}","gists_url":"https://api.github.com/users/jimmyaurora/gists{/gist_id}","starred_url":"https://api.github.com/users/jimmyaurora/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimmyaurora/subscriptions","organizations_url":"https://api.github.com/users/jimmyaurora/orgs","repos_url":"https://api.github.com/users/jimmyaurora/repos","events_url":"https://api.github.com/users/jimmyaurora/events{/privacy}","received_events_url":"https://api.github.com/users/jimmyaurora/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-09-29T21:11:10Z","updated_at":"2023-09-29T21:51:47Z","closed_at":"2023-09-29T21:51:47Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: 3.1.4\r\nRails version: 6.1\r\nSidekiq / Pro / Enterprise version(s): 7.1.4 / 7.1.4 / 7.1.2\r\n\r\nPlease include your initializer, sidekiq.yml, and any error message with the full backtrace.\r\n\r\nWe started seeing the error consistently after deploying the upgrade from 6 to 7.\r\n\r\ninitializer\r\n```require_relative \"redis\" # Making sure redis is loaded before Sidekiq.\r\n\r\n# To setup sidekiq with redis locally:\r\n# You will have to start redis: $ redis-server\r\n# And also start sidekiq:       $ bundle exec sidekiq\r\n\r\nrequire \"sidekiq/pro/expiry\"\r\n\r\n# default_worker_options can only be set using Sidekiq as it not a server configuration\r\nSidekiq.default_job_options = {\"retry\" => false} unless Rails.env.production?\r\n\r\n# Configure Sidekiq Pro to use Datadog agent to send job metrics to Datadog.\r\n# See https://app.datadoghq.com/account/settings#integrations/sidekiq.\r\nrequire \"datadog/statsd\"\r\nSidekiq::Pro.dogstatsd = -> { Datadog::Statsd.new(\"localhost\", 8125, namespace: \"sidekiq\") }\r\n\r\nredis_config = {\r\n  url: Rails.application.config_for(:redis)[:url],\r\n  db: Rails.application.config_for(:redis)[:db],\r\n  size: Rails.application.config_for(:sidekiq)[:concurrency] + 5,\r\n  protocol: 2\r\n}\r\n\r\n# Customize and enable global stats submission with Sidekiq::Enterprise::History\r\nSidekiq::Enterprise::History.send(:prepend, Sidekiq::EnterpriseStats)\r\n\r\nSidekiq.configure_server do |config|\r\n  config.redis = redis_config\r\n\r\n  config.on(:fork) do\r\n    # See https://github.com/sidekiq/sidekiq/wiki/Ent-Multi-Process#application-preload\r\n    ActiveRecord::Base.clear_active_connections!\r\n\r\n    # Same as with puma - multi-process deployments require initializing LD for each process\r\n    # See https://docs.launchdarkly.com/sdk/server-side/ruby#initializing-ldclient-in-a-rails-application\r\n    FeatureFlags.configure(\r\n      sdk_key: ENV[\"LAUNCHDARKLY_SDK_KEY\"],\r\n      redis_url: ENV[\"LAUNCHDARKLY_REDIS_URL\"],\r\n      redis_prefix: \"feature-flags\",\r\n      redis_expiration: 30, # seconds\r\n      local_flags_file: (Rails.root.join(\"config\", \"development_feature_flags.json\") if Rails.env.development?)\r\n    )\r\n\r\n    config.retain_history(30)\r\n  end\r\n\r\n  # Use Sidekiq logger for normal logs so worker/thread/job can be correlated\r\n  Rails.logger = Sidekiq.logger\r\n\r\n  # Add sidekiq metrics statsd middleware for Datadog integration.\r\n  # See https://app.datadoghq.com/account/settings#integrations/sidekiq.\r\n  config.server_middleware do |chain|\r\n    # this middleware should be first in the chain to correctly measure queue wait time\r\n    require \"sidekiq/middleware/server/statsd\"\r\n\r\n    chain.add Sidekiq::Middleware::QueueStatsd\r\n\r\n    chain.add Sidekiq::Middleware::OnCompletedCallback\r\n\r\n    # Override the DEFAULT_OPTIONS to add common tags (e.g. service:)\r\n    Sidekiq::Middleware::Server::Statsd.options = ->(w, _, q) do\r\n      {tags: [\"worker:#{w}\", \"queue:#{q}\"] + Sidekiq::CommonTags.metrics_tags}\r\n    end\r\n    chain.add Sidekiq::Middleware::Server::Statsd\r\n\r\n    chain.add Sidekiq::Middleware::PodNameTagger\r\n\r\n    # Added last because we want to measure mem \"use\" by the job, not by middleware\r\n    chain.add Sidekiq::Middleware::MemStatsd\r\n  end\r\n\r\n  # the server can also act as a client, so make sure client middleware runs there as well\r\n  # docs: https://github.com/sidekiq/sidekiq/wiki/Middleware#client-middleware-registered-in-both-places\r\n  config.client_middleware do |chain|\r\n    chain.add Sidekiq::Middleware::OnEnqueuedCallback\r\n  end\r\n\r\n  # start the cron job that will poll for SQS messages coming from the Client Service for product enablement\r\n  if ENV.fetch(\"CS_PRODUCT_ENABLEMENT_ENABLED\", \"false\") == \"true\"\r\n    config.periodic do |mgr|\r\n      # see any crontab reference for the first argument\r\n      # e.g. http://www.adminschoice.com/crontab-quick-reference\r\n      # or   https://crontab.guru/\r\n      mgr.register(\"* * * * *\", CreditAdapter::Workers::ProductEnablementMessagePoller.to_s)\r\n    end\r\n  end\r\nend\r\n\r\nSidekiq.configure_client do |config|\r\n  config.redis = redis_config\r\n\r\n  config.client_middleware do |chain|\r\n    chain.add Sidekiq::Middleware::OnEnqueuedCallback\r\n  end\r\n\r\n  config.retain_history(30)\r\nend\r\n```\r\nsidekiq.yml\r\n```defaults: &defaults\r\n  :concurrency: <%= ENV[\"SIDEKIQ_MAX_THREADS\"] || 10 %>\r\n\r\n  # If we notice that only critical jobs are executed and default/low jobs are\r\n  # accumulating in their queue, we should update these to weighted queues.\r\n  # Ref: https://github.com/mperham/sidekiq/wiki/Advanced-Options#queues\r\n  # Article: https://phil.tech/2016/tips-on-sidekiq-queues/\r\n  :queues:\r\n    - [\"critical\", <%= ENV[\"SIDEKIQ_QUEUE_CRITICAL_WEIGHT\"] || 1 %>]\r\n    - [\"default\", <%= ENV[\"SIDEKIQ_QUEUE_DEFAULT_WEIGHT\"] || 1 %>]\r\n\r\n  # Most of our workers perform work that is user initiated, as in a user is\r\n  # actively waiting for the worker to finish to then receive some output from us.\r\n  # In this context, waiting more than 5 minutes is unrealistic, hence I set the\r\n  # global max retry count from 25 to 4.\r\n  # Docs: https://github.com/mperham/sidekiq/wiki/Error-Handling\r\n  :max_retries: 4 # Equals to ~ 5 minutes\r\n\r\ndevelopment:\r\n  <<: *defaults\r\n  :concurrency: <%= ENV['SIDEKIQ_MAX_THREADS'] || 2 %>\r\n  :verbose: true\r\n  :logfile: log/sidekiq.log\r\n\r\ntest:        *defaults\r\nstaging:     *defaults\r\nalpha:       *defaults\r\nbeta:        *defaults\r\ndelta:       *defaults\r\nepsilon:     *defaults\r\ngamma:       *defaults\r\nsandbox:     *defaults\r\nproduction:  *defaults\r\ndeployed_development:  *defaults\r\n```\r\nstacktrace\r\n```TypeError: no implicit conversion of String into Integer\r\n/app/vendor/bundle/ruby/3.1.0/gems/sidekiq-pro-7.1.4/lib/sidekiq/batch/status.rb:34:in `load_data': no implicit conversion of String into Integer (TypeError)\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-pro-7.1.4/lib/sidekiq/batch/status.rb:23:in `initialize'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-pro-7.1.4/lib/sidekiq/batch/callback.rb:14:in `new'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-pro-7.1.4/lib/sidekiq/batch/callback.rb:14:in `perform'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:210:in `execute_job'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:180:in `block (4 levels) in process'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:180:in `traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:183:in `block in traverse'\r\n\tfrom /app/lib/sidekiq/middleware/mem_statsd.rb:37:in `call'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:182:in `traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:183:in `block in traverse'\r\n\tfrom /app/lib/sidekiq/middleware/pod_name_tagger.rb:18:in `call'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:182:in `traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:183:in `block in traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-pro-7.1.4/lib/sidekiq/middleware/server/statsd.rb:40:in `call'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:182:in `traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:183:in `block in traverse'\r\n\tfrom /app/lib/sidekiq/middleware/on_completed_callback.rb:18:in `call'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:182:in `traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:183:in `block in traverse'\r\n\tfrom /app/lib/sidekiq/middleware/queue_statsd.rb:30:in `call'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:182:in `traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:183:in `block in traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-pro-7.1.4/lib/sidekiq/pro/expiry.rb:37:in `call'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:182:in `traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:183:in `block in traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/ddtrace-1.11.0/lib/datadog/tracing/contrib/sidekiq/server_tracer.rb:79:in `block in call'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/ddtrace-1.11.0/lib/datadog/tracing/trace_operation.rb:192:in `block in measure'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/ddtrace-1.11.0/lib/datadog/tracing/span_operation.rb:150:in `measure'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/ddtrace-1.11.0/lib/datadog/tracing/trace_operation.rb:192:in `measure'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/ddtrace-1.11.0/lib/datadog/tracing/tracer.rb:380:in `start_span'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/ddtrace-1.11.0/lib/datadog/tracing/tracer.rb:160:in `block in trace'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/ddtrace-1.11.0/lib/datadog/tracing/context.rb:45:in `activate!'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/ddtrace-1.11.0/lib/datadog/tracing/tracer.rb:159:in `trace'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/ddtrace-1.11.0/lib/datadog/tracing.rb:18:in `trace'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/ddtrace-1.11.0/lib/datadog/tracing/contrib/sidekiq/server_tracer.rb:40:in `call'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:182:in `traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:183:in `block in traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-pro-7.1.4/lib/sidekiq/batch/middleware.rb:58:in `call'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:182:in `traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:183:in `block in traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-ent-7.1.2/lib/sidekiq-ent/limiter/middleware.rb:10:in `call'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:182:in `traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:183:in `block in traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sentry-sidekiq-4.8.0/lib/sentry/sidekiq/sentry_context_middleware.rb:24:in `call'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:182:in `traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:183:in `block in traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/metrics/tracking.rb:26:in `track'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/metrics/tracking.rb:122:in `call'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:182:in `traverse'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/middleware/chain.rb:173:in `invoke'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:179:in `block (3 levels) in process'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:140:in `block (6 levels) in dispatch'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/job_retry.rb:114:in `local'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:139:in `block (5 levels) in dispatch'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/rails.rb:16:in `block in call'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/activesupport-6.1.7.4/lib/active_support/execution_wrapper.rb:91:in `wrap'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/activesupport-6.1.7.4/lib/active_support/reloader.rb:72:in `block in wrap'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/activesupport-6.1.7.4/lib/active_support/execution_wrapper.rb:91:in `wrap'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/activesupport-6.1.7.4/lib/active_support/reloader.rb:71:in `wrap'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/rails.rb:15:in `call'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:135:in `block (4 levels) in dispatch'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:271:in `stats'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:130:in `block (3 levels) in dispatch'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/job_logger.rb:13:in `call'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:129:in `block (2 levels) in dispatch'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/job_retry.rb:81:in `global'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:128:in `block in dispatch'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/job_logger.rb:39:in `prepare'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:127:in `dispatch'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:178:in `block (2 levels) in process'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:177:in `handle_interrupt'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:177:in `block in process'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:176:in `handle_interrupt'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:176:in `process'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:82:in `process_one'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/processor.rb:72:in `run'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/component.rb:10:in `watchdog'\r\n\tfrom /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.1.4/lib/sidekiq/component.rb:19:in `block in safe_thread'```\r\n\r\nIf you are using an old version, have you checked the changelogs to see if your issue has been fixed in a later version?\r\n\r\nhttps://github.com/sidekiq/sidekiq/blob/main/Changes.md\r\nhttps://github.com/sidekiq/sidekiq/blob/main/Pro-Changes.md\r\nhttps://github.com/sidekiq/sidekiq/blob/main/Ent-Changes.md\r\n","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6061/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6061/timeline","performed_via_github_app":null,"state_reason":"completed"}