{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4401","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4401/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4401/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4401/events","html_url":"https://github.com/sidekiq/sidekiq/issues/4401","id":537288898,"node_id":"MDU6SXNzdWU1MzcyODg4OTg=","number":4401,"title":"Sidekiq not stopping to take new jubs during deployment even with TSTP signal","user":{"login":"feliperaul","id":743879,"node_id":"MDQ6VXNlcjc0Mzg3OQ==","avatar_url":"https://avatars.githubusercontent.com/u/743879?v=4","gravatar_id":"","url":"https://api.github.com/users/feliperaul","html_url":"https://github.com/feliperaul","followers_url":"https://api.github.com/users/feliperaul/followers","following_url":"https://api.github.com/users/feliperaul/following{/other_user}","gists_url":"https://api.github.com/users/feliperaul/gists{/gist_id}","starred_url":"https://api.github.com/users/feliperaul/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/feliperaul/subscriptions","organizations_url":"https://api.github.com/users/feliperaul/orgs","repos_url":"https://api.github.com/users/feliperaul/repos","events_url":"https://api.github.com/users/feliperaul/events{/privacy}","received_events_url":"https://api.github.com/users/feliperaul/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-12-13T00:43:38Z","updated_at":"2020-01-08T17:10:18Z","closed_at":"2020-01-08T16:59:26Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: 2.5.3\r\nSidekiq / Pro / Enterprise version(s): Sidekiq Open Source 5.2.2\r\n\r\nAt the beginning of our deploy, we issue a `sudo systemctl reload sidekiq`, which we assume should trigger the ExecReload command in the sidekiq.service file.\r\n\r\nOurs ExecReload command is ExecReload=/bin/kill -TSTP $MAINPID\r\n\r\nThe whole file is below. \r\n\r\nHowever, we can confirm that sidekiq is not stopping to take new jobs during the deployment, and even clicking on the 'stop' button in the web interface makes the process disappear for a few seconds, but it comes right back and starts processing new jobs.\r\n\r\nHere's ou sidekiq.service file:\r\n\r\n```\r\n{{ ansible_managed | comment }}\r\n\r\n[Unit]\r\nDescription=Sidekiq\r\nAfter=network.target syslog.target redis.service mysql.service\r\nWants=network.target syslog.target redis.service mysql.service\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\n\r\n[Service]\r\nType=simple\r\n\r\nWorkingDirectory=/var/www/{{ param_app_name }}/application\r\n\r\nExecStart=/bin/bash -lc 'cd /var/www/{{ param_app_name }}/application; /home/{{ param_user_name }}/.rbenv/shims/bundle exec sidekiq -e production -C /var/www/{{ param_app_name }}/shared/config/sidekiq.yml'\r\n\r\nExecReload=/bin/kill -TSTP $MAINPID\r\n\r\nExecStop=/bin/kill -TERM $MAINPID\r\n\r\nUser={{ param_user_name }}\r\n\r\nGroup={{ param_user_name }}\r\n\r\nUMask=0002\r\n\r\nRestartSec=3\r\nRestart=always\r\n\r\nStandardOutput=file:/var/www/{{ param_app_name }}/shared/log/sidekiq.log\r\n\r\nSyslogIdentifier=sidekiq\r\n\r\nEnvironment=MALLOC_ARENA_MAX=2\r\n```\r\n\r\n","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4401/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4401/timeline","performed_via_github_app":null,"state_reason":"completed"}