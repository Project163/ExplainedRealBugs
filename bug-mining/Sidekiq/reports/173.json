{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3169","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3169/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3169/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3169/events","html_url":"https://github.com/sidekiq/sidekiq/issues/3169","id":180110318,"node_id":"MDU6SXNzdWUxODAxMTAzMTg=","number":3169,"title":"Pro Web UI not working after 4.2.2 upgrade","user":{"login":"ursuscamp","id":5460951,"node_id":"MDQ6VXNlcjU0NjA5NTE=","avatar_url":"https://avatars.githubusercontent.com/u/5460951?v=4","gravatar_id":"","url":"https://api.github.com/users/ursuscamp","html_url":"https://github.com/ursuscamp","followers_url":"https://api.github.com/users/ursuscamp/followers","following_url":"https://api.github.com/users/ursuscamp/following{/other_user}","gists_url":"https://api.github.com/users/ursuscamp/gists{/gist_id}","starred_url":"https://api.github.com/users/ursuscamp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ursuscamp/subscriptions","organizations_url":"https://api.github.com/users/ursuscamp/orgs","repos_url":"https://api.github.com/users/ursuscamp/repos","events_url":"https://api.github.com/users/ursuscamp/events{/privacy}","received_events_url":"https://api.github.com/users/ursuscamp/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-09-29T17:19:27Z","updated_at":"2016-09-29T20:24:57Z","closed_at":"2016-09-29T20:24:57Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: 2.1.9\nSidekiq / Pro / Enterprise version(s): 4.2.2 / 3.3.3 / 1.3.2\n\nWe are using Redis sharding, and the UI for the second shard is returning the following exception after upgrading:\n\n```\n> RuntimeError - can't modify frozen Hash:\n  rack-protection (1.5.3) lib/rack/protection/xss_header.rb:20:in `call'\n  rack-protection (1.5.3) lib/rack/protection/base.rb:49:in `call'\n  rack-protection (1.5.3) lib/rack/protection/base.rb:49:in `call'\n  rack-protection (1.5.3) lib/rack/protection/path_traversal.rb:16:in `call'\n  rack-protection (1.5.3) lib/rack/protection/json_csrf.rb:18:in `call'\n  rack-protection (1.5.3) lib/rack/protection/base.rb:49:in `call'\n  rack-protection (1.5.3) lib/rack/protection/base.rb:49:in `call'\n  rack-protection (1.5.3) lib/rack/protection/frame_options.rb:31:in `call'\n  rack-protection (1.5.3) lib/rack/protection/base.rb:49:in `call'\n  rack (1.6.4) lib/rack/session/abstract/id.rb:225:in `context'\n  rack (1.6.4) lib/rack/session/abstract/id.rb:220:in `call'\n  rack (1.6.4) lib/rack/urlmap.rb:66:in `block in call'\n  rack (1.6.4) lib/rack/urlmap.rb:50:in `each'\n  rack (1.6.4) lib/rack/urlmap.rb:50:in `call'\n  rack (1.6.4) lib/rack/builder.rb:153:in `call'\n  sidekiq (4.2.2) lib/sidekiq/web.rb:88:in `call'\n  sidekiq (4.2.2) lib/sidekiq/web.rb:93:in `call'\n  actionpack (4.2.7) lib/action_dispatch/routing/mapper.rb:51:in `serve'\n  actionpack (4.2.7) lib/action_dispatch/journey/router.rb:43:in `block in serve'\n  actionpack (4.2.7) lib/action_dispatch/journey/router.rb:30:in `each'\n  actionpack (4.2.7) lib/action_dispatch/journey/router.rb:30:in `serve'\n  actionpack (4.2.7) lib/action_dispatch/routing/route_set.rb:817:in `call'\n  browsernizer (0.2.4) lib/browsernizer/router.rb:19:in `call'\n  bullet (5.1.1) lib/bullet/rack.rb:12:in `call'\n  warden (1.2.6) lib/warden/manager.rb:35:in `block in call'\n  warden (1.2.6) lib/warden/manager.rb:34:in `catch'\n  warden (1.2.6) lib/warden/manager.rb:34:in `call'\n  rack (1.6.4) lib/rack/etag.rb:24:in `call'\n  rack (1.6.4) lib/rack/conditionalget.rb:25:in `call'\n  rack (1.6.4) lib/rack/head.rb:13:in `call'\n  actionpack (4.2.7) lib/action_dispatch/middleware/params_parser.rb:27:in `call'\n  actionpack (4.2.7) lib/action_dispatch/middleware/flash.rb:260:in `call'\n  rack (1.6.4) lib/rack/session/abstract/id.rb:225:in `context'\n  rack (1.6.4) lib/rack/session/abstract/id.rb:220:in `call'\n  actionpack (4.2.7) lib/action_dispatch/middleware/cookies.rb:560:in `call'\n  activerecord (4.2.7) lib/active_record/query_cache.rb:36:in `call'\n  activerecord (4.2.7) lib/active_record/connection_adapters/abstract/connection_pool.rb:653:in `call'\n  actionpack (4.2.7) lib/action_dispatch/middleware/callbacks.rb:29:in `block in call'\n  activesupport (4.2.7) lib/active_support/callbacks.rb:88:in `__run_callbacks__'\n  activesupport (4.2.7) lib/active_support/callbacks.rb:778:in `_run_call_callbacks'\n  activesupport (4.2.7) lib/active_support/callbacks.rb:81:in `run_callbacks'\n  actionpack (4.2.7) lib/action_dispatch/middleware/callbacks.rb:27:in `call'\n  actionpack (4.2.7) lib/action_dispatch/middleware/reloader.rb:73:in `call'\n  actionpack (4.2.7) lib/action_dispatch/middleware/remote_ip.rb:78:in `call'\n  better_errors (2.1.1) lib/better_errors/middleware.rb:84:in `protected_app_call'\n  better_errors (2.1.1) lib/better_errors/middleware.rb:79:in `better_errors_call'\n  better_errors (2.1.1) lib/better_errors/middleware.rb:57:in `call'\n  actionpack (4.2.7) lib/action_dispatch/middleware/debug_exceptions.rb:17:in `call'\n  wash_out (0.10.0) lib/wash_out/middleware.rb:8:in `call'\n  actionpack (4.2.7) lib/action_dispatch/middleware/show_exceptions.rb:30:in `call'\n  railties (4.2.7) lib/rails/rack/logger.rb:38:in `call_app'\n  railties (4.2.7) lib/rails/rack/logger.rb:20:in `block in call'\n  activesupport (4.2.7) lib/active_support/tagged_logging.rb:68:in `block in tagged'\n  activesupport (4.2.7) lib/active_support/tagged_logging.rb:26:in `tagged'\n  activesupport (4.2.7) lib/active_support/tagged_logging.rb:68:in `tagged'\n  railties (4.2.7) lib/rails/rack/logger.rb:20:in `call'\n  actionpack (4.2.7) lib/action_dispatch/middleware/request_id.rb:21:in `call'\n  rack (1.6.4) lib/rack/methodoverride.rb:22:in `call'\n  rack (1.6.4) lib/rack/runtime.rb:18:in `call'\n  activesupport (4.2.7) lib/active_support/cache/strategy/local_cache_middleware.rb:28:in `call'\n  rack (1.6.4) lib/rack/lock.rb:17:in `call'\n  rack (1.6.4) lib/rack/sendfile.rb:113:in `call'\n  railties (4.2.7) lib/rails/engine.rb:518:in `call'\n  railties (4.2.7) lib/rails/application.rb:165:in `call'\n  rack (1.6.4) lib/rack/content_length.rb:15:in `call'\n  thin (1.5.1) lib/thin/connection.rb:81:in `block in pre_process'\n  thin (1.5.1) lib/thin/connection.rb:79:in `catch'\n  thin (1.5.1) lib/thin/connection.rb:79:in `pre_process'\n  thin (1.5.1) lib/thin/connection.rb:54:in `process'\n  thin (1.5.1) lib/thin/connection.rb:39:in `receive_data'\n  eventmachine (1.0.9.1) lib/eventmachine.rb:193:in `run_machine'\n  eventmachine (1.0.9.1) lib/eventmachine.rb:193:in `run'\n  thin (1.5.1) lib/thin/backends/base.rb:63:in `start'\n  thin (1.5.1) lib/thin/server.rb:159:in `start'\n  rack (1.6.4) lib/rack/handler/thin.rb:19:in `run'\n  rack (1.6.4) lib/rack/server.rb:286:in `start'\n  railties (4.2.7) lib/rails/commands/server.rb:80:in `start'\n  railties (4.2.7) lib/rails/commands/commands_tasks.rb:80:in `block in server'\n  railties (4.2.7) lib/rails/commands/commands_tasks.rb:75:in `tap'\n  railties (4.2.7) lib/rails/commands/commands_tasks.rb:75:in `server'\n  railties (4.2.7) lib/rails/commands/commands_tasks.rb:39:in `run_command!'\n  railties (4.2.7) lib/rails/commands.rb:17:in `<top (required)>'\n  bin/rails:4:in `require'\n  bin/rails:4:in `<main>'\n```\n\nHere is how we are mounting the UIs in our routes.rb:\n\n``` ruby\nmount Sidekiq::Web => '/admin/sidekiq'\nmount Sidekiq::Pro::Web.with(redis_pool: SECONDARY_REDIS_POOL), at: '/admin/sidekiq_secondary', as: 'sidekiq_secondary'\n```\n\nAccording to the Sharding wiki page, only the Pro UI supports multiple Web UIs, so I did what the Pro UI wiki page recommended and attempted to mount them like this:\n\n``` ruby\nmount Sidekiq::Pro::Web => '/admin/sidekiq'\nmount Sidekiq::Pro::Web.with(redis_pool: SECONDARY_REDIS_POOL), at: '/admin/sidekiq_secondary', as: 'sidekiq_secondary'`\n```\n\nBut then we get the following exception + stacktrace:\n\n```\n> RuntimeError - A rack application must be specified:\n  actionpack (4.2.7) lib/action_dispatch/routing/mapper.rb:580:in `mount'\n  config/routes.rb:9:in `block (2 levels) in <top (required)>'\n  devise (3.5.10) lib/devise/rails/routes.rb:287:in `block in authenticate'\n  devise (3.5.10) lib/devise/rails/routes.rb:473:in `block in constraints_for'\n  actionpack (4.2.7) lib/action_dispatch/routing/mapper.rb:941:in `block in constraints'\n  actionpack (4.2.7) lib/action_dispatch/routing/mapper.rb:817:in `scope'\n  actionpack (4.2.7) lib/action_dispatch/routing/mapper.rb:941:in `constraints'\n  devise (3.5.10) lib/devise/rails/routes.rb:472:in `constraints_for'\n  devise (3.5.10) lib/devise/rails/routes.rb:286:in `authenticate'\n  config/routes.rb:8:in `block in <top (required)>'\n  actionpack (4.2.7) lib/action_dispatch/routing/route_set.rb:432:in `instance_exec'\n  actionpack (4.2.7) lib/action_dispatch/routing/route_set.rb:432:in `eval_block'\n  actionpack (4.2.7) lib/action_dispatch/routing/route_set.rb:410:in `draw'\n  config/routes.rb:4:in `<top (required)>'\n  activesupport (4.2.7) lib/active_support/dependencies.rb:268:in `load'\n  activesupport (4.2.7) lib/active_support/dependencies.rb:268:in `block in load'\n  activesupport (4.2.7) lib/active_support/dependencies.rb:240:in `load_dependency'\n  activesupport (4.2.7) lib/active_support/dependencies.rb:268:in `load'\n  railties (4.2.7) lib/rails/application/routes_reloader.rb:40:in `block in load_paths'\n  railties (4.2.7) lib/rails/application/routes_reloader.rb:40:in `each'\n  railties (4.2.7) lib/rails/application/routes_reloader.rb:40:in `load_paths'\n  railties (4.2.7) lib/rails/application/routes_reloader.rb:16:in `reload!'\n  railties (4.2.7) lib/rails/application/routes_reloader.rb:26:in `block in updater'\n  activesupport (4.2.7) lib/active_support/file_update_checker.rb:75:in `call'\n  activesupport (4.2.7) lib/active_support/file_update_checker.rb:75:in `execute'\n  railties (4.2.7) lib/rails/application/routes_reloader.rb:7:in `execute'\n  railties (4.2.7) lib/rails/application/finisher.rb:81:in `block (2 levels) in <module:Finisher>'\n  activesupport (4.2.7) lib/active_support/callbacks.rb:446:in `instance_exec'\n  activesupport (4.2.7) lib/active_support/callbacks.rb:446:in `block in make_lambda'\n  activesupport (4.2.7) lib/active_support/callbacks.rb:192:in `call'\n  activesupport (4.2.7) lib/active_support/callbacks.rb:192:in `block in simple'\n  activesupport (4.2.7) lib/active_support/callbacks.rb:504:in `call'\n  activesupport (4.2.7) lib/active_support/callbacks.rb:504:in `block in call'\n  activesupport (4.2.7) lib/active_support/callbacks.rb:504:in `each'\n  activesupport (4.2.7) lib/active_support/callbacks.rb:504:in `call'\n  activesupport (4.2.7) lib/active_support/callbacks.rb:92:in `__run_callbacks__'\n  activesupport (4.2.7) lib/active_support/callbacks.rb:778:in `_run_prepare_callbacks'\n  activesupport (4.2.7) lib/active_support/callbacks.rb:81:in `run_callbacks'\n  actionpack (4.2.7) lib/action_dispatch/middleware/reloader.rb:83:in `prepare!'\n  actionpack (4.2.7) lib/action_dispatch/middleware/reloader.rb:71:in `call'\n  actionpack (4.2.7) lib/action_dispatch/middleware/remote_ip.rb:78:in `call'\n  better_errors (2.1.1) lib/better_errors/middleware.rb:84:in `protected_app_call'\n  better_errors (2.1.1) lib/better_errors/middleware.rb:79:in `better_errors_call'\n  better_errors (2.1.1) lib/better_errors/middleware.rb:57:in `call'\n  actionpack (4.2.7) lib/action_dispatch/middleware/debug_exceptions.rb:17:in `call'\n  wash_out (0.10.0) lib/wash_out/middleware.rb:8:in `call'\n  actionpack (4.2.7) lib/action_dispatch/middleware/show_exceptions.rb:30:in `call'\n  railties (4.2.7) lib/rails/rack/logger.rb:38:in `call_app'\n  railties (4.2.7) lib/rails/rack/logger.rb:20:in `block in call'\n  activesupport (4.2.7) lib/active_support/tagged_logging.rb:68:in `block in tagged'\n  activesupport (4.2.7) lib/active_support/tagged_logging.rb:26:in `tagged'\n  activesupport (4.2.7) lib/active_support/tagged_logging.rb:68:in `tagged'\n  railties (4.2.7) lib/rails/rack/logger.rb:20:in `call'\n  actionpack (4.2.7) lib/action_dispatch/middleware/request_id.rb:21:in `call'\n  rack (1.6.4) lib/rack/methodoverride.rb:22:in `call'\n  rack (1.6.4) lib/rack/runtime.rb:18:in `call'\n  activesupport (4.2.7) lib/active_support/cache/strategy/local_cache_middleware.rb:28:in `call'\n  rack (1.6.4) lib/rack/lock.rb:17:in `call'\n  rack (1.6.4) lib/rack/sendfile.rb:113:in `call'\n  railties (4.2.7) lib/rails/engine.rb:518:in `call'\n  railties (4.2.7) lib/rails/application.rb:165:in `call'\n  rack (1.6.4) lib/rack/content_length.rb:15:in `call'\n  thin (1.5.1) lib/thin/connection.rb:81:in `block in pre_process'\n  thin (1.5.1) lib/thin/connection.rb:79:in `catch'\n  thin (1.5.1) lib/thin/connection.rb:79:in `pre_process'\n  thin (1.5.1) lib/thin/connection.rb:54:in `process'\n  thin (1.5.1) lib/thin/connection.rb:39:in `receive_data'\n  eventmachine (1.0.9.1) lib/eventmachine.rb:193:in `run_machine'\n  eventmachine (1.0.9.1) lib/eventmachine.rb:193:in `run'\n  thin (1.5.1) lib/thin/backends/base.rb:63:in `start'\n  thin (1.5.1) lib/thin/server.rb:159:in `start'\n  rack (1.6.4) lib/rack/handler/thin.rb:19:in `run'\n  rack (1.6.4) lib/rack/server.rb:286:in `start'\n  railties (4.2.7) lib/rails/commands/server.rb:80:in `start'\n  railties (4.2.7) lib/rails/commands/commands_tasks.rb:80:in `block in server'\n  railties (4.2.7) lib/rails/commands/commands_tasks.rb:75:in `tap'\n  railties (4.2.7) lib/rails/commands/commands_tasks.rb:75:in `server'\n  railties (4.2.7) lib/rails/commands/commands_tasks.rb:39:in `run_command!'\n  railties (4.2.7) lib/rails/commands.rb:17:in `<top (required)>'\n  bin/rails:4:in `require'\n  bin/rails:4:in `<main>'\n```\n","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3169/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3169/timeline","performed_via_github_app":null,"state_reason":"completed"}