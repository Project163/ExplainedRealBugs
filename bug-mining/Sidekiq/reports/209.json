{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3806","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3806/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3806/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3806/events","html_url":"https://github.com/sidekiq/sidekiq/issues/3806","id":309098346,"node_id":"MDU6SXNzdWUzMDkwOTgzNDY=","number":3806,"title":"`RAILS_MAX_THREADS` parity with Redis pool for client (i.e. Rails server)","user":{"login":"cupakromer","id":1524496,"node_id":"MDQ6VXNlcjE1MjQ0OTY=","avatar_url":"https://avatars.githubusercontent.com/u/1524496?v=4","gravatar_id":"","url":"https://api.github.com/users/cupakromer","html_url":"https://github.com/cupakromer","followers_url":"https://api.github.com/users/cupakromer/followers","following_url":"https://api.github.com/users/cupakromer/following{/other_user}","gists_url":"https://api.github.com/users/cupakromer/gists{/gist_id}","starred_url":"https://api.github.com/users/cupakromer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cupakromer/subscriptions","organizations_url":"https://api.github.com/users/cupakromer/orgs","repos_url":"https://api.github.com/users/cupakromer/repos","events_url":"https://api.github.com/users/cupakromer/events{/privacy}","received_events_url":"https://api.github.com/users/cupakromer/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-03-27T19:15:25Z","updated_at":"2018-03-27T22:46:58Z","closed_at":"2018-03-27T22:46:58Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: 2.5.0\r\nRails: 5.1.5\r\nSidekiq / Pro / Enterprise version(s): Sidekiq 5.1.1\r\n\r\n## Issue\r\n\r\nIn Sidekiq 4.2.0 (issue #2985 implemented https://github.com/mperham/sidekiq/commit/52828e42123cc1c54b2a326bda5d00965ec05acb) the ability to use `RAILS_MAX_THREADS` was introduced to allow tuning of concurrency with the `RAILS_MAX_THREADS`. The problem is this only applies for the [Sidekiq server run via CLI](https://github.com/mperham/sidekiq/blob/60a41d3f36db25ff2bebade5bb516d38d4240b7b/lib/sidekiq/cli.rb#L243) (e.g. `worker: RAILS_MAX_THREADS=10 bundle exec sidekiq`), not the Rails server process (e.g. `web: bundle exec puma -C config/puma.rb`).\r\n\r\nWhen the Rails server is running the connection is often made to `Sidekiq::Client` (such as with [`ActiveJob::QueueAdapters::SidekiqAdapter`](https://github.com/rails/rails/blob/v5.1.5/activejob/lib/active_job/queue_adapters/sidekiq_adapter.rb#L20) which does not have a `redis_pool` yet. It then attempts to create one [defaulting to a pool size of 5](https://github.com/mperham/sidekiq/blob/60a41d3f36db25ff2bebade5bb516d38d4240b7b/lib/sidekiq/redis_connection.rb#L18).\r\n\r\n<details>\r\n<summary>Sample Rails `ActiveJob` Stack</summary>\r\n\r\n```\r\n.gem/ruby/2.5.0/gems/sidekiq-5.1.1/lib/sidekiq.rb:125:in `redis_pool'\r\n.gem/ruby/2.5.0/gems/sidekiq-5.1.1/lib/sidekiq/client.rb:42:in `initialize'\r\n.gem/ruby/2.5.0/gems/sidekiq-5.1.1/lib/sidekiq/client.rb:131:in `new'\r\n.gem/ruby/2.5.0/gems/sidekiq-5.1.1/lib/sidekiq/client.rb:131:in `push'\r\n.gem/ruby/2.5.0/gems/activejob-5.1.5/lib/active_job/queue_adapters/sidekiq_adapter.rb:20:in `enqueue'\r\n.gem/ruby/2.5.0/gems/activejob-5.1.5/lib/active_job/enqueuing.rb:51:in `block in enqueue'\r\n.gem/ruby/2.5.0/gems/activesupport-5.1.5/lib/active_support/callbacks.rb:108:in `block in run_callbacks'\r\n.gem/ruby/2.5.0/gems/activejob-5.1.5/lib/active_job/logging.rb:15:in `block (3 levels) in <module:Logging>'\r\n.gem/ruby/2.5.0/gems/activejob-5.1.5/lib/active_job/logging.rb:44:in `block in tag_logger'\r\n.gem/ruby/2.5.0/gems/activesupport-5.1.5/lib/active_support/tagged_logging.rb:69:in `block in tagged'\r\n.gem/ruby/2.5.0/gems/activesupport-5.1.5/lib/active_support/tagged_logging.rb:26:in `tagged'\r\n.gem/ruby/2.5.0/gems/activesupport-5.1.5/lib/active_support/tagged_logging.rb:69:in `tagged'\r\n.gem/ruby/2.5.0/gems/activejob-5.1.5/lib/active_job/logging.rb:44:in `tag_logger'\r\n.gem/ruby/2.5.0/gems/activejob-5.1.5/lib/active_job/logging.rb:14:in `block (2 levels) in <module:Logging>'\r\n.gem/ruby/2.5.0/gems/activesupport-5.1.5/lib/active_support/callbacks.rb:117:in `instance_exec'\r\n.gem/ruby/2.5.0/gems/activesupport-5.1.5/lib/active_support/callbacks.rb:117:in `block in run_callbacks'\r\n.gem/ruby/2.5.0/gems/activesupport-5.1.5/lib/active_support/callbacks.rb:135:in `run_callbacks'\r\n.gem/ruby/2.5.0/gems/activejob-5.1.5/lib/active_job/enqueuing.rb:47:in `enqueue'\r\n.gem/ruby/2.5.0/gems/activejob-5.1.5/lib/active_job/enqueuing.rb:18:in `perform_later'\r\n```\r\n\r\n</details>\r\n\r\n<br/>\r\n\r\nDepending on network speed, server load, job data size, and the `RAILS_MAX_THREADS` setting it's possible all of the Redis connections are in use resulting in a `Timeout::Error`.\r\n\r\n## Workaround\r\n\r\nUse an initializer to explicitly set the pool size:\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\n# See https://github.com/mperham/sidekiq/wiki/Using-Redis\r\nSidekiq.configure_client do |config|\r\n  # Without an explicit `size` here the pool will be set to 5\r\n  #\r\n  # See:\r\n  #   - https://github.com/mperham/sidekiq/blob/v5.1.1/lib/sidekiq/redis_connection.rb#L18\r\n  #   - https://github.com/mperham/sidekiq/blob/v5.1.1/lib/sidekiq/cli.rb#L244\r\n  config.redis = {\r\n    size: Integer(ENV.fetch(\"RAILS_MAX_THREADS\", 5)),\r\n  }\r\nend\r\n```\r\n\r\n## Proposed Solution\r\n\r\nI believe to resolve this the Redis pool creation needs similar logic to the CLI. I recognize this is complicated by the fact there is both a server and a client. I think the solution is something like the following, but I don't have enough knowledge of the Sidekiq internals to say for certain:\r\n\r\n```ruby\r\n# Sidekiq::RedisConnection.create (lib/sidekiq/redis_connection.rb#L18)\r\n# ...\r\n\r\nsize = if options[:size]\r\n         options[:size]\r\n       elsif Sidekiq.server?\r\n         Sidekiq.options[:concurrency] + 5\r\n       elsif ENV[\"RAILS_MAX_THREADS\"]\r\n         Integer(ENV[\"RAILS_MAX_THREADS\"])\r\n       else\r\n         5\r\n       end\r\n\r\nverify_sizing(size, Sidekiq.options[:concurrency]) if Sidekiq.server?\r\n\r\n# ...\r\n```\r\n","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3806/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3806/timeline","performed_via_github_app":null,"state_reason":"completed"}