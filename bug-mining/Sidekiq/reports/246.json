{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4480","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4480/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4480/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4480/events","html_url":"https://github.com/sidekiq/sidekiq/issues/4480","id":577071978,"node_id":"MDU6SXNzdWU1NzcwNzE5Nzg=","number":4480,"title":"Ajax uses setInterval instead of setTimeout, leading to server load","user":{"login":"oskarpearson","id":129002,"node_id":"MDQ6VXNlcjEyOTAwMg==","avatar_url":"https://avatars.githubusercontent.com/u/129002?v=4","gravatar_id":"","url":"https://api.github.com/users/oskarpearson","html_url":"https://github.com/oskarpearson","followers_url":"https://api.github.com/users/oskarpearson/followers","following_url":"https://api.github.com/users/oskarpearson/following{/other_user}","gists_url":"https://api.github.com/users/oskarpearson/gists{/gist_id}","starred_url":"https://api.github.com/users/oskarpearson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oskarpearson/subscriptions","organizations_url":"https://api.github.com/users/oskarpearson/orgs","repos_url":"https://api.github.com/users/oskarpearson/repos","events_url":"https://api.github.com/users/oskarpearson/events{/privacy}","received_events_url":"https://api.github.com/users/oskarpearson/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-03-06T17:23:45Z","updated_at":"2020-03-15T20:32:10Z","closed_at":"2020-03-15T20:32:10Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Thanks for a great product\r\n\r\nRuby version: 2.6.3\r\nSidekiq / Pro / Enterprise version(s): Sidekiq 5.2.8 (code for 6.0.5/master on github contains the same issue)\r\n\r\nInitializer and error message: not applicable\r\n\r\n### Detail:\r\n\r\nThe javascript at https://github.com/mperham/sidekiq/blob/master/web/assets/javascripts/application.js#L58 uses `setInterval`. This queues a query to the backend via ajax irrespective of whether the last AJAX request has responded or not.\r\n\r\nIf there are problems with the infrastructure running the Sidekiq web ui (eg, overloaded web servers), this will make those problems worse - since ajax requests will be queued continuously and increase the established connections to the web ui host.\r\n\r\nThe general practice is to instead use `setTimeout` to queue a new request on completion of the last request. See https://makitweb.com/how-to-fire-ajax-request-on-regular-interval/ for more information.\r\n\r\n### Why:\r\n\r\nUnfortunately, we had a large number of items incorrectly queued with large message bodies (exceeding the size listed at https://github.com/mperham/sidekiq/blob/455e9d56f46f0299eaf3b761596207e15f906a39/lib/sidekiq/extensions/generic_proxy.rb#L7)\r\n\r\nIn trying to access the web page, clicking `poll` would bring the management app down. This is because running `lrange queue:low 0 24` would take 6 seconds to respond. In the time it took the first ajax request to respond another 3 ajax requests were queued - which then took 6 seconds to respond each. In short order, this exceeded the number of connections on the web server and it restarted when the load balancer removed it.","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4480/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4480/timeline","performed_via_github_app":null,"state_reason":"completed"}