{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4498","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4498/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4498/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4498/events","html_url":"https://github.com/sidekiq/sidekiq/issues/4498","id":584081514,"node_id":"MDU6SXNzdWU1ODQwODE1MTQ=","number":4498,"title":"Jobs processed during shutdown not appearing in stats ","user":{"login":"ouranos","id":19894,"node_id":"MDQ6VXNlcjE5ODk0","avatar_url":"https://avatars.githubusercontent.com/u/19894?v=4","gravatar_id":"","url":"https://api.github.com/users/ouranos","html_url":"https://github.com/ouranos","followers_url":"https://api.github.com/users/ouranos/followers","following_url":"https://api.github.com/users/ouranos/following{/other_user}","gists_url":"https://api.github.com/users/ouranos/gists{/gist_id}","starred_url":"https://api.github.com/users/ouranos/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ouranos/subscriptions","organizations_url":"https://api.github.com/users/ouranos/orgs","repos_url":"https://api.github.com/users/ouranos/repos","events_url":"https://api.github.com/users/ouranos/events{/privacy}","received_events_url":"https://api.github.com/users/ouranos/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2020-03-19T00:24:29Z","updated_at":"2020-03-19T02:46:52Z","closed_at":"2020-03-19T02:46:52Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: ruby-2.5.1\r\nSidekiq version: 6.0.5\r\n\r\nHi, \r\nTo test deployment and graceful restart of Sidekiq workers, I've created a dummy jobs that just sleeps and output to stdout:\r\n```ruby\r\nclass SleepyWorker < BaseWorker\r\n  SLEEP = 30\r\n\r\n  def perform steps = 10\r\n    steps.times do |i|\r\n      puts \"Sleeping for #{SLEEP}s (#{i}/#{steps})\"\r\n      sleep SLEEP\r\n    end\r\n    puts \"I'm done\"\r\n  end\r\nend\r\n```\r\n\r\nMy initializer is pretty standard:\r\n```ruby\r\nredis_config = { url: ENV['REDIS_SIDEKIQ_URL'] }\r\n\r\n# Use redis authentication if available\r\nredis_config[:password] = ENV['REDIS_SIDEKIQ_PASSWORD'] if ENV['REDIS_SIDEKIQ_PASSWORD'].present?\r\n\r\nSidekiq.configure_server do |config|\r\n  config.redis = redis_config\r\nend\r\n\r\nSidekiq.configure_client do |config|\r\n  config.redis = redis_config\r\nend\r\n```\r\n\r\nI've increased the shutdown timeout to 8 minutes in `config/sidekiq.yml`:\r\n```yml\r\n:timeout: 480 # 8m, default is 25s\r\n```\r\n\r\nI'm stopping Sidekiq with the `TERM` signal after having enqueued a 5min sleeping job, I'm expecting:\r\n- Sidekiq to stop accepting new jobs -> worker shows as quiet in the UI ✅ \r\n- Sidekiq to wait for the job to be done before shutting down ✅ \r\n- The numbers of processed jobs to be increased by 1 => Busy is at 1 while processing but Processed is not increased :x:\r\n\r\nAm I missing something?","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4498/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4498/timeline","performed_via_github_app":null,"state_reason":"completed"}