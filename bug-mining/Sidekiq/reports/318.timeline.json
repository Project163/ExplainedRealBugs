[{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1883856440","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-1883856440","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":1883856440,"node_id":"IC_kwDOADDA9M5wSV44","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-01-09T21:52:22Z","updated_at":"2024-01-09T21:52:22Z","body":"We can either guarantee that Batch jobs are pushed atomically at the end of the `jobs` block or transactionally, but not both. What do you expect to happen?","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1883856440/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1884033644","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-1884033644","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":1884033644,"node_id":"IC_kwDOADDA9M5wTBJs","user":{"login":"ernie","id":14947,"node_id":"MDQ6VXNlcjE0OTQ3","avatar_url":"https://avatars.githubusercontent.com/u/14947?v=4","gravatar_id":"","url":"https://api.github.com/users/ernie","html_url":"https://github.com/ernie","followers_url":"https://api.github.com/users/ernie/followers","following_url":"https://api.github.com/users/ernie/following{/other_user}","gists_url":"https://api.github.com/users/ernie/gists{/gist_id}","starred_url":"https://api.github.com/users/ernie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ernie/subscriptions","organizations_url":"https://api.github.com/users/ernie/orgs","repos_url":"https://api.github.com/users/ernie/repos","events_url":"https://api.github.com/users/ernie/events{/privacy}","received_events_url":"https://api.github.com/users/ernie/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-01-10T01:07:59Z","updated_at":"2024-01-10T01:07:59Z","body":"Heya @mperham! Long time no see. Is this a case of \"we're using it wrong\" or is there a real question here?","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1884033644/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ernie","id":14947,"node_id":"MDQ6VXNlcjE0OTQ3","avatar_url":"https://avatars.githubusercontent.com/u/14947?v=4","gravatar_id":"","url":"https://api.github.com/users/ernie","html_url":"https://github.com/ernie","followers_url":"https://api.github.com/users/ernie/followers","following_url":"https://api.github.com/users/ernie/following{/other_user}","gists_url":"https://api.github.com/users/ernie/gists{/gist_id}","starred_url":"https://api.github.com/users/ernie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ernie/subscriptions","organizations_url":"https://api.github.com/users/ernie/orgs","repos_url":"https://api.github.com/users/ernie/repos","events_url":"https://api.github.com/users/ernie/events{/privacy}","received_events_url":"https://api.github.com/users/ernie/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":11437402608,"node_id":"MEE_lADOADDA9M57kvJ0zwAAAAKpuOnw","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/11437402608","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-01-10T01:08:00Z","performed_via_github_app":null},{"id":11437402615,"node_id":"SE_lADOADDA9M57kvJ0zwAAAAKpuOn3","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/11437402615","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-01-10T01:08:00Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1884038510","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-1884038510","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":1884038510,"node_id":"IC_kwDOADDA9M5wTCVu","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-01-10T01:14:26Z","updated_at":"2024-01-10T01:14:26Z","body":"I apologize for the less than useful initial reply. It looks like the transactional push delay causes the batch to go out of scope and so the job does not get a BID associated. That seems like a footgun I should handle. üëçüèª","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1884038510/reactions","total_count":2,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":2,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1884065753","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-1884065753","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":1884065753,"node_id":"IC_kwDOADDA9M5wTI_Z","user":{"login":"noaelad","id":14058109,"node_id":"MDQ6VXNlcjE0MDU4MTA5","avatar_url":"https://avatars.githubusercontent.com/u/14058109?v=4","gravatar_id":"","url":"https://api.github.com/users/noaelad","html_url":"https://github.com/noaelad","followers_url":"https://api.github.com/users/noaelad/followers","following_url":"https://api.github.com/users/noaelad/following{/other_user}","gists_url":"https://api.github.com/users/noaelad/gists{/gist_id}","starred_url":"https://api.github.com/users/noaelad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noaelad/subscriptions","organizations_url":"https://api.github.com/users/noaelad/orgs","repos_url":"https://api.github.com/users/noaelad/repos","events_url":"https://api.github.com/users/noaelad/events{/privacy}","received_events_url":"https://api.github.com/users/noaelad/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-01-10T01:51:48Z","updated_at":"2024-01-10T01:51:48Z","body":"Clarified the description a little bit, I hope that helps. Ideally the jobs would still be pushed at the end of the transaction, but they would get their BID assigned. If it's not possible to do both, then I guess it's more important for a BID to be assigned than to enqueue at the end of the transaction.\r\nIt seems like `transactional_push!` already doesn't support `push_bulk`, so it would make sense to explicitly decide that it doesn't support batches either, but the way it currently stands it's definitely a footgun.\r\nThanks for looking into it!","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1884065753/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"noaelad","id":14058109,"node_id":"MDQ6VXNlcjE0MDU4MTA5","avatar_url":"https://avatars.githubusercontent.com/u/14058109?v=4","gravatar_id":"","url":"https://api.github.com/users/noaelad","html_url":"https://github.com/noaelad","followers_url":"https://api.github.com/users/noaelad/followers","following_url":"https://api.github.com/users/noaelad/following{/other_user}","gists_url":"https://api.github.com/users/noaelad/gists{/gist_id}","starred_url":"https://api.github.com/users/noaelad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noaelad/subscriptions","organizations_url":"https://api.github.com/users/noaelad/orgs","repos_url":"https://api.github.com/users/noaelad/repos","events_url":"https://api.github.com/users/noaelad/events{/privacy}","received_events_url":"https://api.github.com/users/noaelad/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1902290809","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-1902290809","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":1902290809,"node_id":"IC_kwDOADDA9M5xYqd5","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-01-20T22:32:37Z","updated_at":"2024-01-20T22:32:37Z","body":"Somehow this works for me. I can't reproduce the behavior yet. Can you use 7.2.0?\r\n\r\n```ruby\r\n  it \"works transactionally\" do\r\n    q = Sidekiq::Queue.new\r\n    assert_equal 0, q.size\r\n\r\n    require \"active_record\"\r\n    ActiveRecord::Base.establish_connection(\r\n      adapter: \"sqlite3\",\r\n      database: \"test.db\"\r\n    )\r\n    require \"after_commit_everywhere\"\r\n    Sidekiq.default_job_options[\"client_class\"] = Sidekiq::TransactionAwareClient\r\n    Sidekiq::JobUtil::TRANSIENT_ATTRIBUTES << \"client_class\"\r\n\r\n    class XAJob\r\n      include Sidekiq::Job\r\n    end\r\n\r\n    ActiveRecord::Base.transaction do\r\n      b = Sidekiq::Batch.new\r\n      b.jobs do\r\n        XAJob.perform_async\r\n      end\r\n      assert_equal 1, q.size\r\n    end\r\n    assert_equal 1, q.size\r\n  end\r\n```","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1902290809/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1902293892","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-1902293892","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":1902293892,"node_id":"IC_kwDOADDA9M5xYrOE","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-01-20T22:34:14Z","updated_at":"2024-01-20T22:34:14Z","body":"I suspect the batch refactoring in 7.1.x fixing inline execution also changed this behavior.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1902293892/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":11547605829,"node_id":"CE_lADOADDA9M57kvJ0zwAAAAKwSntF","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/11547605829","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"80f5f73f8e74a5775866a016fe42446dfc1b861e","commit_url":"https://api.github.com/repos/sidekiq/sidekiq/commits/80f5f73f8e74a5775866a016fe42446dfc1b861e","created_at":"2024-01-20T22:55:46Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1902333720","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-1902333720","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":1902333720,"node_id":"IC_kwDOADDA9M5xY08Y","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-01-20T22:56:08Z","updated_at":"2024-01-20T22:56:08Z","body":"Try main and see if it works better for you.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1902333720/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":11601743659,"node_id":"REFE_lADOADDA9M57kvJ0zwAAAAKzhI8r","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/11601743659","actor":{"login":"kostasrim","id":11015979,"node_id":"MDQ6VXNlcjExMDE1OTc5","avatar_url":"https://avatars.githubusercontent.com/u/11015979?v=4","gravatar_id":"","url":"https://api.github.com/users/kostasrim","html_url":"https://github.com/kostasrim","followers_url":"https://api.github.com/users/kostasrim/followers","following_url":"https://api.github.com/users/kostasrim/following{/other_user}","gists_url":"https://api.github.com/users/kostasrim/gists{/gist_id}","starred_url":"https://api.github.com/users/kostasrim/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kostasrim/subscriptions","organizations_url":"https://api.github.com/users/kostasrim/orgs","repos_url":"https://api.github.com/users/kostasrim/repos","events_url":"https://api.github.com/users/kostasrim/events{/privacy}","received_events_url":"https://api.github.com/users/kostasrim/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"80f5f73f8e74a5775866a016fe42446dfc1b861e","commit_url":"https://api.github.com/repos/kostasrim/sidekiq/commits/80f5f73f8e74a5775866a016fe42446dfc1b861e","created_at":"2024-01-25T19:53:59Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1932972688","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-1932972688","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":1932972688,"node_id":"IC_kwDOADDA9M5zNtKQ","user":{"login":"noaelad","id":14058109,"node_id":"MDQ6VXNlcjE0MDU4MTA5","avatar_url":"https://avatars.githubusercontent.com/u/14058109?v=4","gravatar_id":"","url":"https://api.github.com/users/noaelad","html_url":"https://github.com/noaelad","followers_url":"https://api.github.com/users/noaelad/followers","following_url":"https://api.github.com/users/noaelad/following{/other_user}","gists_url":"https://api.github.com/users/noaelad/gists{/gist_id}","starred_url":"https://api.github.com/users/noaelad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noaelad/subscriptions","organizations_url":"https://api.github.com/users/noaelad/orgs","repos_url":"https://api.github.com/users/noaelad/repos","events_url":"https://api.github.com/users/noaelad/events{/privacy}","received_events_url":"https://api.github.com/users/noaelad/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-02-07T21:31:54Z","updated_at":"2024-02-07T21:31:54Z","body":"The problem still exists on main. The test you wrote isn't testing the issue I mentioned, which involves the batch id not being set. I'm also not convinced this test passes, given that it's trying to use transactional push, I would expect the `q.size` outside the transaction to be +1 the `q.size` inside the transaction...\r\n\r\nI would rewrite it as:\r\n```\r\nit \"works transactionally\" do\r\n  q = Sidekiq::Queue.new\r\n  assert_equal 0, q.size\r\n\r\n  require \"active_record\"\r\n  ActiveRecord::Base.establish_connection(\r\n    adapter: \"sqlite3\",\r\n    database: \"test.db\"\r\n  )\r\n  require \"after_commit_everywhere\"\r\n  Sidekiq.default_job_options[\"client_class\"] = Sidekiq::TransactionAwareClient\r\n  Sidekiq::JobUtil::TRANSIENT_ATTRIBUTES << \"client_class\"\r\n\r\n  class XAJob\r\n    include Sidekiq::Job\r\n  end\r\n\r\n  ActiveRecord::Base.transaction do\r\n    b = Sidekiq::Batch.new\r\n    b.jobs do\r\n      XAJob.perform_async\r\n    end\r\n    assert_equal 1, q.size\r\n    assert_equal q.first.klass, 'Sidekiq::Batch::Empty'\r\n  end\r\n  assert_equal 2, q.size\r\n  assert_equal q.map{|j| j.klass}, ['Sidekiq::Batch::Empty', 'XAJob']\r\n  assert_equal q.map{|j| j.bid}, [b.bid, b.bid]\r\nend\r\n```\r\n\r\nthe last assertion is still broken on main.\r\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1932972688/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"noaelad","id":14058109,"node_id":"MDQ6VXNlcjE0MDU4MTA5","avatar_url":"https://avatars.githubusercontent.com/u/14058109?v=4","gravatar_id":"","url":"https://api.github.com/users/noaelad","html_url":"https://github.com/noaelad","followers_url":"https://api.github.com/users/noaelad/followers","following_url":"https://api.github.com/users/noaelad/following{/other_user}","gists_url":"https://api.github.com/users/noaelad/gists{/gist_id}","starred_url":"https://api.github.com/users/noaelad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noaelad/subscriptions","organizations_url":"https://api.github.com/users/noaelad/orgs","repos_url":"https://api.github.com/users/noaelad/repos","events_url":"https://api.github.com/users/noaelad/events{/privacy}","received_events_url":"https://api.github.com/users/noaelad/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1934706208","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-1934706208","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":1934706208,"node_id":"IC_kwDOADDA9M5zUUYg","user":{"login":"noaelad","id":14058109,"node_id":"MDQ6VXNlcjE0MDU4MTA5","avatar_url":"https://avatars.githubusercontent.com/u/14058109?v=4","gravatar_id":"","url":"https://api.github.com/users/noaelad","html_url":"https://github.com/noaelad","followers_url":"https://api.github.com/users/noaelad/followers","following_url":"https://api.github.com/users/noaelad/following{/other_user}","gists_url":"https://api.github.com/users/noaelad/gists{/gist_id}","starred_url":"https://api.github.com/users/noaelad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noaelad/subscriptions","organizations_url":"https://api.github.com/users/noaelad/orgs","repos_url":"https://api.github.com/users/noaelad/repos","events_url":"https://api.github.com/users/noaelad/events{/privacy}","received_events_url":"https://api.github.com/users/noaelad/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-02-08T18:27:31Z","updated_at":"2024-02-08T18:27:31Z","body":"@mperham sorry it took me a while to respond, wanted to make sure you saw this? ^\r\nCan we reopen this issue?","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1934706208/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"noaelad","id":14058109,"node_id":"MDQ6VXNlcjE0MDU4MTA5","avatar_url":"https://avatars.githubusercontent.com/u/14058109?v=4","gravatar_id":"","url":"https://api.github.com/users/noaelad","html_url":"https://github.com/noaelad","followers_url":"https://api.github.com/users/noaelad/followers","following_url":"https://api.github.com/users/noaelad/following{/other_user}","gists_url":"https://api.github.com/users/noaelad/gists{/gist_id}","starred_url":"https://api.github.com/users/noaelad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noaelad/subscriptions","organizations_url":"https://api.github.com/users/noaelad/orgs","repos_url":"https://api.github.com/users/noaelad/repos","events_url":"https://api.github.com/users/noaelad/events{/privacy}","received_events_url":"https://api.github.com/users/noaelad/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":11749781453,"node_id":"MEE_lADOADDA9M57kvJ0zwAAAAK8V2_N","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/11749781453","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-02-08T18:27:32Z","performed_via_github_app":null},{"id":11749781463,"node_id":"SE_lADOADDA9M57kvJ0zwAAAAK8V2_X","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/11749781463","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-02-08T18:27:32Z","performed_via_github_app":null},{"id":11750648891,"node_id":"REE_lADOADDA9M57kvJ0zwAAAAK8ZKw7","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/11750648891","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"reopened","commit_id":null,"commit_url":null,"created_at":"2024-02-08T19:55:05Z","state_reason":"reopened","performed_via_github_app":null},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1934841994","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-1934841994","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":1934841994,"node_id":"IC_kwDOADDA9M5zU1iK","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-02-08T19:57:47Z","updated_at":"2024-02-08T19:57:47Z","body":"Are you using Sidekiq + Sidekiq Pro 7.2.0? 7.1.0 will not work.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1934841994/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1935072014","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-1935072014","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":1935072014,"node_id":"IC_kwDOADDA9M5zVtsO","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-02-08T23:06:12Z","updated_at":"2024-02-08T23:06:12Z","body":"Batch jobs do not pay attention to transactional boundaries. The `batch.jobs` semantic is clear: all job are pushed at the end of the jobs block.\r\n\r\n```ruby\r\n  ActiveRecord::Base.transaction do\r\n    b = Sidekiq::Batch.new\r\n    b.jobs do\r\n      XAJob.perform_async\r\n    end # the job will be pushed here\r\n    assert_equal 1, q.size\r\n    assert_equal q.first.klass, 'Sidekiq::Batch::Empty' # nope, this will be XAJob\r\n  end\r\n  assert_equal 2, q.size # nope, only one job\r\n  assert_equal q.map{|j| j.klass}, ['Sidekiq::Batch::Empty', 'XAJob']\r\n  assert_equal q.map{|j| j.bid}, [b.bid, b.bid] # and yes, you should get a bid\r\n```","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1935072014/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1936456530","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-1936456530","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":1936456530,"node_id":"IC_kwDOADDA9M5za_tS","user":{"login":"noaelad","id":14058109,"node_id":"MDQ6VXNlcjE0MDU4MTA5","avatar_url":"https://avatars.githubusercontent.com/u/14058109?v=4","gravatar_id":"","url":"https://api.github.com/users/noaelad","html_url":"https://github.com/noaelad","followers_url":"https://api.github.com/users/noaelad/followers","following_url":"https://api.github.com/users/noaelad/following{/other_user}","gists_url":"https://api.github.com/users/noaelad/gists{/gist_id}","starred_url":"https://api.github.com/users/noaelad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noaelad/subscriptions","organizations_url":"https://api.github.com/users/noaelad/orgs","repos_url":"https://api.github.com/users/noaelad/repos","events_url":"https://api.github.com/users/noaelad/events{/privacy}","received_events_url":"https://api.github.com/users/noaelad/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-02-09T19:04:38Z","updated_at":"2024-02-09T19:04:57Z","body":"> Batch jobs do not pay attention to transactional boundaries\r\n\r\nIs this documented somewhere? This is surprising to me and also does not match the behavior I'm seeing, in both 7.1.0 and 7.2.0\r\n\r\nWith Sidekiq + Sidekiq Pro both on 7.2.0 what I'm seeing is:\r\n\r\n```\r\n  ActiveRecord::Base.transaction do\r\n    b = Sidekiq::Batch.new\r\n    b.jobs do\r\n      XAJob.perform_async\r\n    end # the XAJob job is not pushed here, instead there is a Sidekiq::Batch::Empty job\r\n    assert_equal 1, q.size\r\n    assert_equal q.first.klass, 'Sidekiq::Batch::Empty' # this part passes\r\n  end\r\n  assert_equal 2, q.size # I see two jobs here\r\n  assert_equal q.map{|j| j.klass}, ['Sidekiq::Batch::Empty', 'XAJob'] # this part passes\r\n  assert_equal q.map{|j| j.bid}, [b.bid, b.bid] # this part fails, with the second bid being nil\r\n```","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1936456530/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"noaelad","id":14058109,"node_id":"MDQ6VXNlcjE0MDU4MTA5","avatar_url":"https://avatars.githubusercontent.com/u/14058109?v=4","gravatar_id":"","url":"https://api.github.com/users/noaelad","html_url":"https://github.com/noaelad","followers_url":"https://api.github.com/users/noaelad/followers","following_url":"https://api.github.com/users/noaelad/following{/other_user}","gists_url":"https://api.github.com/users/noaelad/gists{/gist_id}","starred_url":"https://api.github.com/users/noaelad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noaelad/subscriptions","organizations_url":"https://api.github.com/users/noaelad/orgs","repos_url":"https://api.github.com/users/noaelad/repos","events_url":"https://api.github.com/users/noaelad/events{/privacy}","received_events_url":"https://api.github.com/users/noaelad/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1936478588","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-1936478588","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":1936478588,"node_id":"IC_kwDOADDA9M5zbFF8","user":{"login":"noaelad","id":14058109,"node_id":"MDQ6VXNlcjE0MDU4MTA5","avatar_url":"https://avatars.githubusercontent.com/u/14058109?v=4","gravatar_id":"","url":"https://api.github.com/users/noaelad","html_url":"https://github.com/noaelad","followers_url":"https://api.github.com/users/noaelad/followers","following_url":"https://api.github.com/users/noaelad/following{/other_user}","gists_url":"https://api.github.com/users/noaelad/gists{/gist_id}","starred_url":"https://api.github.com/users/noaelad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noaelad/subscriptions","organizations_url":"https://api.github.com/users/noaelad/orgs","repos_url":"https://api.github.com/users/noaelad/repos","events_url":"https://api.github.com/users/noaelad/events{/privacy}","received_events_url":"https://api.github.com/users/noaelad/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-02-09T19:22:56Z","updated_at":"2024-02-09T19:22:56Z","body":"As a side note, with 7.1.0 I am not seeing the `Sidekiq::Batch::Empty` job, but the missing bid issue is still there\r\n\r\n```\r\n  ActiveRecord::Base.transaction do\r\n    b = Sidekiq::Batch.new\r\n    b.jobs do\r\n      XAJob.perform_async\r\n    end # the XAJob job is not pushed here\r\n    assert_equal 0, q.size # passes\r\n  end\r\n  assert_equal 1, q.size # passes\r\n  assert_equal q.map{|j| j.klass}, ['XAJob'] # passes\r\n  assert_equal q.map{|j| j.bid}, [b.bid] # fails, j.bid is nil\r\n```","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1936478588/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"noaelad","id":14058109,"node_id":"MDQ6VXNlcjE0MDU4MTA5","avatar_url":"https://avatars.githubusercontent.com/u/14058109?v=4","gravatar_id":"","url":"https://api.github.com/users/noaelad","html_url":"https://github.com/noaelad","followers_url":"https://api.github.com/users/noaelad/followers","following_url":"https://api.github.com/users/noaelad/following{/other_user}","gists_url":"https://api.github.com/users/noaelad/gists{/gist_id}","starred_url":"https://api.github.com/users/noaelad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noaelad/subscriptions","organizations_url":"https://api.github.com/users/noaelad/orgs","repos_url":"https://api.github.com/users/noaelad/repos","events_url":"https://api.github.com/users/noaelad/events{/privacy}","received_events_url":"https://api.github.com/users/noaelad/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1936482878","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-1936482878","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":1936482878,"node_id":"IC_kwDOADDA9M5zbGI-","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-02-09T19:26:07Z","updated_at":"2024-02-09T19:26:07Z","body":"You need Sidekiq main + Pro 7.2.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1936482878/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1936505933","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-1936505933","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":1936505933,"node_id":"IC_kwDOADDA9M5zbLxN","user":{"login":"noaelad","id":14058109,"node_id":"MDQ6VXNlcjE0MDU4MTA5","avatar_url":"https://avatars.githubusercontent.com/u/14058109?v=4","gravatar_id":"","url":"https://api.github.com/users/noaelad","html_url":"https://github.com/noaelad","followers_url":"https://api.github.com/users/noaelad/followers","following_url":"https://api.github.com/users/noaelad/following{/other_user}","gists_url":"https://api.github.com/users/noaelad/gists{/gist_id}","starred_url":"https://api.github.com/users/noaelad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noaelad/subscriptions","organizations_url":"https://api.github.com/users/noaelad/orgs","repos_url":"https://api.github.com/users/noaelad/repos","events_url":"https://api.github.com/users/noaelad/events{/privacy}","received_events_url":"https://api.github.com/users/noaelad/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-02-09T19:44:22Z","updated_at":"2024-02-09T19:44:22Z","body":"ü§¶ I didn't realize main was ahead of 7.2.0 and included [this fix](https://github.com/sidekiq/sidekiq/commit/80f5f73f8e74a5775866a016fe42446dfc1b861e). My bad üò¨ \r\n\r\nLooks like that resolved the issue! I will (ask our infra team to) update when it gets released. Thank you!","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1936505933/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"noaelad","id":14058109,"node_id":"MDQ6VXNlcjE0MDU4MTA5","avatar_url":"https://avatars.githubusercontent.com/u/14058109?v=4","gravatar_id":"","url":"https://api.github.com/users/noaelad","html_url":"https://github.com/noaelad","followers_url":"https://api.github.com/users/noaelad/followers","following_url":"https://api.github.com/users/noaelad/following{/other_user}","gists_url":"https://api.github.com/users/noaelad/gists{/gist_id}","starred_url":"https://api.github.com/users/noaelad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noaelad/subscriptions","organizations_url":"https://api.github.com/users/noaelad/orgs","repos_url":"https://api.github.com/users/noaelad/repos","events_url":"https://api.github.com/users/noaelad/events{/privacy}","received_events_url":"https://api.github.com/users/noaelad/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":11761939421,"node_id":"CE_lADOADDA9M57kvJ0zwAAAAK9EPPd","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/11761939421","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2024-02-09T19:56:17Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/2034797075","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-2034797075","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":2034797075,"node_id":"IC_kwDOADDA9M55SIoT","user":{"login":"adrian-gomez","id":1303680,"node_id":"MDQ6VXNlcjEzMDM2ODA=","avatar_url":"https://avatars.githubusercontent.com/u/1303680?v=4","gravatar_id":"","url":"https://api.github.com/users/adrian-gomez","html_url":"https://github.com/adrian-gomez","followers_url":"https://api.github.com/users/adrian-gomez/followers","following_url":"https://api.github.com/users/adrian-gomez/following{/other_user}","gists_url":"https://api.github.com/users/adrian-gomez/gists{/gist_id}","starred_url":"https://api.github.com/users/adrian-gomez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adrian-gomez/subscriptions","organizations_url":"https://api.github.com/users/adrian-gomez/orgs","repos_url":"https://api.github.com/users/adrian-gomez/repos","events_url":"https://api.github.com/users/adrian-gomez/events{/privacy}","received_events_url":"https://api.github.com/users/adrian-gomez/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-04-03T14:33:03Z","updated_at":"2024-04-03T14:33:03Z","body":"@mperham I'm working on updating sidekiq and bump into this issue (([isolator](https://github.com/palkan/isolator) alerted us of pushing to jobs while inside a transaction). Our scenario is as follows:\r\n- create a batch\r\n- push jobs into the batch that we actually want to track and consider part of the batch\r\n- when those jobs are processed they might open a db transaction perform some tasks that might also push other jobs to sidekiq that we don't really care to track inside the batch and would rather just keep the old behavior of pushing after the transaction is done.\r\n\r\nFor the pushing after the transaction part I believe we can add `AfterCommitEverywhere.after_commit { Worker.peform_async }` manually to all those places which is doable but kind of pain (and not needed when those jobs are pushing for other parts of the app that's not using batches). Can you think of any other way to get back old behavior?\r\n\r\nIt seems that side effect of that would be that those jobs would be hanlded outside the batch. Is this assumption correct?\r\n\r\nI think the uniqueness of our scenario is that we have jobs that we care to track as part of the batch and some jobs that we don't. Idealy we would be able to provide a list to the bach of what classes are part of it and it would only track those instead of assuming every job pushed in the context of a batch is part of it.\r\n\r\npd: sorry to post on a closed issue, not sure if that was the way to go or if I should have opened a new one","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/2034797075/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"adrian-gomez","id":1303680,"node_id":"MDQ6VXNlcjEzMDM2ODA=","avatar_url":"https://avatars.githubusercontent.com/u/1303680?v=4","gravatar_id":"","url":"https://api.github.com/users/adrian-gomez","html_url":"https://github.com/adrian-gomez","followers_url":"https://api.github.com/users/adrian-gomez/followers","following_url":"https://api.github.com/users/adrian-gomez/following{/other_user}","gists_url":"https://api.github.com/users/adrian-gomez/gists{/gist_id}","starred_url":"https://api.github.com/users/adrian-gomez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adrian-gomez/subscriptions","organizations_url":"https://api.github.com/users/adrian-gomez/orgs","repos_url":"https://api.github.com/users/adrian-gomez/repos","events_url":"https://api.github.com/users/adrian-gomez/events{/privacy}","received_events_url":"https://api.github.com/users/adrian-gomez/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":12343290477,"node_id":"MEE_lADOADDA9M57kvJ0zwAAAALft6pt","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/12343290477","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-04-03T14:33:04Z","performed_via_github_app":null},{"id":12343290491,"node_id":"SE_lADOADDA9M57kvJ0zwAAAALft6p7","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/12343290491","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-04-03T14:33:04Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/2035438711","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-2035438711","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":2035438711,"node_id":"IC_kwDOADDA9M55UlR3","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-04-03T19:42:02Z","updated_at":"2024-04-03T19:42:02Z","body":"* Batch guarantees that jobs are pushed at the end of the `jobs` block atomically.\r\n* Transactional push guarantees that jobs are pushed after the transaction is committed.\r\n\r\nWe cannot provide both guarantees at the same time.\r\n\r\nHere's an idea: do the work to separate those two concerns. Either commit your transactions before creating the batch or scope the transaction within the `jobs` block so your jobs are committed before the batch jobs are pushed:\r\n\r\nCommit in batch:\r\n```ruby\r\nbatch.jobs do\r\n  User.transaction do\r\n    ...\r\n  end\r\nend\r\n```\r\n\r\nCommit then batch:\r\n```ruby\r\nUser.transaction do\r\n  ...\r\nend\r\nbatch.jobs do\r\nend\r\n```","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/2035438711/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/2037139767","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-2037139767","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":2037139767,"node_id":"IC_kwDOADDA9M55bEk3","user":{"login":"adrian-gomez","id":1303680,"node_id":"MDQ6VXNlcjEzMDM2ODA=","avatar_url":"https://avatars.githubusercontent.com/u/1303680?v=4","gravatar_id":"","url":"https://api.github.com/users/adrian-gomez","html_url":"https://github.com/adrian-gomez","followers_url":"https://api.github.com/users/adrian-gomez/followers","following_url":"https://api.github.com/users/adrian-gomez/following{/other_user}","gists_url":"https://api.github.com/users/adrian-gomez/gists{/gist_id}","starred_url":"https://api.github.com/users/adrian-gomez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adrian-gomez/subscriptions","organizations_url":"https://api.github.com/users/adrian-gomez/orgs","repos_url":"https://api.github.com/users/adrian-gomez/repos","events_url":"https://api.github.com/users/adrian-gomez/events{/privacy}","received_events_url":"https://api.github.com/users/adrian-gomez/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-04-04T12:55:26Z","updated_at":"2024-04-04T12:55:26Z","body":"We don't have a problem or a transaction at the initial level. We do:\r\n```\r\n  batch.jobs do\r\n    UserWorker.perform_async(id)\r\n  end\r\n\r\n  class UserWorker\r\n    def perform(id)\r\n      user = User.find(id)\r\n      user.transaction do\r\n         user.thing\r\n         OtherWorker.perform_async(id)\r\n      end\r\n    end\r\n  end\r\n```\r\nwith the latest changes `OtherWorker` is fired inmediatly (before the commit) and its also added as part of the batch. Where before it would wait for the transaction to commit and not be part of the barch.\r\nWe could do:\r\n```\r\n  class UserWorker\r\n    def perform(id)\r\n      user = User.find(id)\r\n      user.transaction do\r\n         user.thing\r\n         AfterCommitEverywhere.after_commit { OtherWorker.perform_async(id) }\r\n      end\r\n    end\r\n  end\r\n```\r\nbut thats kind of annoing since the call for that worker might be nested insde a bunch of method calls (and sometimes its called without a batch being present in those cases we wouldn't need the `AfterCommitEverywhere` block.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/2037139767/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"adrian-gomez","id":1303680,"node_id":"MDQ6VXNlcjEzMDM2ODA=","avatar_url":"https://avatars.githubusercontent.com/u/1303680?v=4","gravatar_id":"","url":"https://api.github.com/users/adrian-gomez","html_url":"https://github.com/adrian-gomez","followers_url":"https://api.github.com/users/adrian-gomez/followers","following_url":"https://api.github.com/users/adrian-gomez/following{/other_user}","gists_url":"https://api.github.com/users/adrian-gomez/gists{/gist_id}","starred_url":"https://api.github.com/users/adrian-gomez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adrian-gomez/subscriptions","organizations_url":"https://api.github.com/users/adrian-gomez/orgs","repos_url":"https://api.github.com/users/adrian-gomez/repos","events_url":"https://api.github.com/users/adrian-gomez/events{/privacy}","received_events_url":"https://api.github.com/users/adrian-gomez/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/2042616907","html_url":"https://github.com/sidekiq/sidekiq/issues/6160#issuecomment-2042616907","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6160","id":2042616907,"node_id":"IC_kwDOADDA9M55v9xL","user":{"login":"adrian-gomez","id":1303680,"node_id":"MDQ6VXNlcjEzMDM2ODA=","avatar_url":"https://avatars.githubusercontent.com/u/1303680?v=4","gravatar_id":"","url":"https://api.github.com/users/adrian-gomez","html_url":"https://github.com/adrian-gomez","followers_url":"https://api.github.com/users/adrian-gomez/followers","following_url":"https://api.github.com/users/adrian-gomez/following{/other_user}","gists_url":"https://api.github.com/users/adrian-gomez/gists{/gist_id}","starred_url":"https://api.github.com/users/adrian-gomez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adrian-gomez/subscriptions","organizations_url":"https://api.github.com/users/adrian-gomez/orgs","repos_url":"https://api.github.com/users/adrian-gomez/repos","events_url":"https://api.github.com/users/adrian-gomez/events{/privacy}","received_events_url":"https://api.github.com/users/adrian-gomez/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-04-08T12:26:54Z","updated_at":"2024-04-08T12:26:54Z","body":"Just to close the loop, turns out that pushing jobs from a job inside a batch DOES NOT push the jobs to the batch automatically that was happening on our test because of some workarounds we have to be able to perform integration tests on jobs that depend on batches. Sorry for the noise!","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/2042616907/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"adrian-gomez","id":1303680,"node_id":"MDQ6VXNlcjEzMDM2ODA=","avatar_url":"https://avatars.githubusercontent.com/u/1303680?v=4","gravatar_id":"","url":"https://api.github.com/users/adrian-gomez","html_url":"https://github.com/adrian-gomez","followers_url":"https://api.github.com/users/adrian-gomez/followers","following_url":"https://api.github.com/users/adrian-gomez/following{/other_user}","gists_url":"https://api.github.com/users/adrian-gomez/gists{/gist_id}","starred_url":"https://api.github.com/users/adrian-gomez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adrian-gomez/subscriptions","organizations_url":"https://api.github.com/users/adrian-gomez/orgs","repos_url":"https://api.github.com/users/adrian-gomez/repos","events_url":"https://api.github.com/users/adrian-gomez/events{/privacy}","received_events_url":"https://api.github.com/users/adrian-gomez/received_events","type":"User","user_view_type":"public","site_admin":false}}]