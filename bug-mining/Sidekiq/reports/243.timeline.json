[{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/565256278","html_url":"https://github.com/sidekiq/sidekiq/issues/4401#issuecomment-565256278","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4401","id":565256278,"node_id":"MDEyOklzc3VlQ29tbWVudDU2NTI1NjI3OA==","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-12-13T01:04:25Z","updated_at":"2019-12-13T01:04:25Z","body":"Iâ€™d guess the issue is the overly complex ExecStart line, so MAINPID is bash rather than Sidekiq? Start Sidekiq directly.\n\n> On Dec 12, 2019, at 16:43, flprben <notifications@github.com> wrote:\n> \n> ï»¿\n> Ruby version: 2.5.3\n> Sidekiq / Pro / Enterprise version(s): Sidekiq Open Source 5.2.2\n> \n> At the beginning of our deploy, we issue a sudo systemctl reload sidekiq, which we assume should trigger the ExecReload command in the sidekiq.service file.\n> \n> Ours ExecReload command is ExecReload=/bin/kill -TSTP $MAINPID\n> \n> The whole file is below.\n> \n> However, we can confirm that sidekiq is not stopping to take new jobs during the deployment, and even clicking on the 'stop' button in the web interface makes the process disappear for a few seconds, but it comes right back and starts processing new jobs.\n> \n> Here's ou sidekiq.service file:\n> \n> {{ ansible_managed | comment }}\n> \n> [Unit]\n> Description=Sidekiq\n> After=network.target syslog.target redis.service mysql.service\n> Wants=network.target syslog.target redis.service mysql.service\n> \n> [Install]\n> WantedBy=multi-user.target\n> \n> [Service]\n> Type=simple\n> \n> WorkingDirectory=/var/www/{{ param_app_name }}/application\n> \n> ExecStart=/bin/bash -lc 'cd /var/www/{{ param_app_name }}/application; /home/{{ param_user_name }}/.rbenv/shims/bundle exec sidekiq -e production -C /var/www/{{ param_app_name }}/shared/config/sidekiq.yml'\n> \n> ExecReload=/bin/kill -TSTP $MAINPID\n> \n> ExecStop=/bin/kill -TERM $MAINPID\n> \n> User={{ param_user_name }}\n> \n> Group={{ param_user_name }}\n> \n> UMask=0002\n> \n> RestartSec=3\n> Restart=always\n> \n> StandardOutput=file:/var/www/{{ param_app_name }}/shared/log/sidekiq.log\n> \n> SyslogIdentifier=sidekiq\n> \n> Environment=MALLOC_ARENA_MAX=2\n> â€”\n> You are receiving this because you are subscribed to this thread.\n> Reply to this email directly, view it on GitHub, or unsubscribe.\n","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/565256278/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/565388432","html_url":"https://github.com/sidekiq/sidekiq/issues/4401#issuecomment-565388432","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4401","id":565388432,"node_id":"MDEyOklzc3VlQ29tbWVudDU2NTM4ODQzMg==","user":{"login":"feliperaul","id":743879,"node_id":"MDQ6VXNlcjc0Mzg3OQ==","avatar_url":"https://avatars.githubusercontent.com/u/743879?v=4","gravatar_id":"","url":"https://api.github.com/users/feliperaul","html_url":"https://github.com/feliperaul","followers_url":"https://api.github.com/users/feliperaul/followers","following_url":"https://api.github.com/users/feliperaul/following{/other_user}","gists_url":"https://api.github.com/users/feliperaul/gists{/gist_id}","starred_url":"https://api.github.com/users/feliperaul/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/feliperaul/subscriptions","organizations_url":"https://api.github.com/users/feliperaul/orgs","repos_url":"https://api.github.com/users/feliperaul/repos","events_url":"https://api.github.com/users/feliperaul/events{/privacy}","received_events_url":"https://api.github.com/users/feliperaul/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-12-13T10:27:44Z","updated_at":"2019-12-13T10:27:44Z","body":"@mperham Mike, we followed the content of the example you provided in https://github.com/mperham/sidekiq/blob/master/examples/systemd/sidekiq.service\r\n\r\nIt reads:\r\n```\r\n# If you use rbenv:\r\n# ExecStart=/bin/bash -lc '/home/deploy/.rbenv/shims/bundle exec sidekiq -e production'\r\n```\r\n\r\nThis is all a little bit greek to us ðŸ˜¬ So the correct ExecStart would be:\r\n\r\n```\r\nExecStart=/home/{{ param_user_name }}/.rbenv/shims/bundle exec sidekiq -e production -C /var/www/{{ param_app_name }}/shared/config/sidekiq.yml\r\n```\r\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/565388432/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"feliperaul","id":743879,"node_id":"MDQ6VXNlcjc0Mzg3OQ==","avatar_url":"https://avatars.githubusercontent.com/u/743879?v=4","gravatar_id":"","url":"https://api.github.com/users/feliperaul","html_url":"https://github.com/feliperaul","followers_url":"https://api.github.com/users/feliperaul/followers","following_url":"https://api.github.com/users/feliperaul/following{/other_user}","gists_url":"https://api.github.com/users/feliperaul/gists{/gist_id}","starred_url":"https://api.github.com/users/feliperaul/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/feliperaul/subscriptions","organizations_url":"https://api.github.com/users/feliperaul/orgs","repos_url":"https://api.github.com/users/feliperaul/repos","events_url":"https://api.github.com/users/feliperaul/events{/privacy}","received_events_url":"https://api.github.com/users/feliperaul/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":2880890994,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50Mjg4MDg5MDk5NA==","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/2880890994","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2019-12-13T10:27:44Z","performed_via_github_app":null},{"id":2880890995,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDI4ODA4OTA5OTU=","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/2880890995","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2019-12-13T10:27:45Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/565507685","html_url":"https://github.com/sidekiq/sidekiq/issues/4401#issuecomment-565507685","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4401","id":565507685,"node_id":"MDEyOklzc3VlQ29tbWVudDU2NTUwNzY4NQ==","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-12-13T16:28:14Z","updated_at":"2019-12-13T16:28:14Z","body":"If that's the standard example, it will work so the issue must be something else.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/565507685/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/566233488","html_url":"https://github.com/sidekiq/sidekiq/issues/4401#issuecomment-566233488","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4401","id":566233488,"node_id":"MDEyOklzc3VlQ29tbWVudDU2NjIzMzQ4OA==","user":{"login":"feliperaul","id":743879,"node_id":"MDQ6VXNlcjc0Mzg3OQ==","avatar_url":"https://avatars.githubusercontent.com/u/743879?v=4","gravatar_id":"","url":"https://api.github.com/users/feliperaul","html_url":"https://github.com/feliperaul","followers_url":"https://api.github.com/users/feliperaul/followers","following_url":"https://api.github.com/users/feliperaul/following{/other_user}","gists_url":"https://api.github.com/users/feliperaul/gists{/gist_id}","starred_url":"https://api.github.com/users/feliperaul/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/feliperaul/subscriptions","organizations_url":"https://api.github.com/users/feliperaul/orgs","repos_url":"https://api.github.com/users/feliperaul/repos","events_url":"https://api.github.com/users/feliperaul/events{/privacy}","received_events_url":"https://api.github.com/users/feliperaul/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-12-16T20:39:51Z","updated_at":"2019-12-16T20:39:51Z","body":"Any idea how I can debug this?","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/566233488/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"feliperaul","id":743879,"node_id":"MDQ6VXNlcjc0Mzg3OQ==","avatar_url":"https://avatars.githubusercontent.com/u/743879?v=4","gravatar_id":"","url":"https://api.github.com/users/feliperaul","html_url":"https://github.com/feliperaul","followers_url":"https://api.github.com/users/feliperaul/followers","following_url":"https://api.github.com/users/feliperaul/following{/other_user}","gists_url":"https://api.github.com/users/feliperaul/gists{/gist_id}","starred_url":"https://api.github.com/users/feliperaul/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/feliperaul/subscriptions","organizations_url":"https://api.github.com/users/feliperaul/orgs","repos_url":"https://api.github.com/users/feliperaul/repos","events_url":"https://api.github.com/users/feliperaul/events{/privacy}","received_events_url":"https://api.github.com/users/feliperaul/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/572159016","html_url":"https://github.com/sidekiq/sidekiq/issues/4401#issuecomment-572159016","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4401","id":572159016,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MjE1OTAxNg==","user":{"login":"spaceform","id":59660017,"node_id":"MDQ6VXNlcjU5NjYwMDE3","avatar_url":"https://avatars.githubusercontent.com/u/59660017?v=4","gravatar_id":"","url":"https://api.github.com/users/spaceform","html_url":"https://github.com/spaceform","followers_url":"https://api.github.com/users/spaceform/followers","following_url":"https://api.github.com/users/spaceform/following{/other_user}","gists_url":"https://api.github.com/users/spaceform/gists{/gist_id}","starred_url":"https://api.github.com/users/spaceform/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spaceform/subscriptions","organizations_url":"https://api.github.com/users/spaceform/orgs","repos_url":"https://api.github.com/users/spaceform/repos","events_url":"https://api.github.com/users/spaceform/events{/privacy}","received_events_url":"https://api.github.com/users/spaceform/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-01-08T16:53:36Z","updated_at":"2020-01-08T17:10:18Z","body":"Here's one thought which may help.\r\n\r\nThe ExecStart line starts a bash shell and the bash shell starts sidekiq, and so sidekiq is likely running as a child process under the bash process.\r\n\r\nThe ExecReload line will send the TSTP signal to the $MAINPID process which is bash, but the bash process won't send this signal to the sidekiq child process. Therefore the sidekiq process never gets the TSTP signal.\r\n\r\nPerhaps you could resolve this by prefixing the bundle command with `exec`. `exec` will make the bash shell be replaced by the sidekiq process and so the $MAINPID process will be sidekiq instead of bash. e.g.:\r\n\r\n`ExecStart=/bin/bash -lc 'cd /var/www/{{ param_app_name }}/application; exec /home/{{ param_user_name }}/.rbenv/shims/bundle exec sidekiq -e production -C /var/www/{{ param_app_name }}/shared/config/sidekiq.yml'`\r\n\r\nSide note: The ExecReload line as is doesn't seem to actually reload sidekiq. It just sends the TSTP signal. Perhaps that's what you expect to happen but I thought I'd mention it just in case.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/572159016/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"spaceform","id":59660017,"node_id":"MDQ6VXNlcjU5NjYwMDE3","avatar_url":"https://avatars.githubusercontent.com/u/59660017?v=4","gravatar_id":"","url":"https://api.github.com/users/spaceform","html_url":"https://github.com/spaceform","followers_url":"https://api.github.com/users/spaceform/followers","following_url":"https://api.github.com/users/spaceform/following{/other_user}","gists_url":"https://api.github.com/users/spaceform/gists{/gist_id}","starred_url":"https://api.github.com/users/spaceform/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spaceform/subscriptions","organizations_url":"https://api.github.com/users/spaceform/orgs","repos_url":"https://api.github.com/users/spaceform/repos","events_url":"https://api.github.com/users/spaceform/events{/privacy}","received_events_url":"https://api.github.com/users/spaceform/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":2931991596,"node_id":"MDExOkNsb3NlZEV2ZW50MjkzMTk5MTU5Ng==","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/2931991596","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"8c4a05214101acd6b9cef52a26dea665750cf4b2","commit_url":"https://api.github.com/repos/sidekiq/sidekiq/commits/8c4a05214101acd6b9cef52a26dea665750cf4b2","created_at":"2020-01-08T16:59:26Z","state_reason":null,"performed_via_github_app":null},{"id":12683522783,"node_id":"REFE_lADOADDA9M4gBmDCzwAAAALz_zLf","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/12683522783","actor":{"login":"jasonpenny","id":6033,"node_id":"MDQ6VXNlcjYwMzM=","avatar_url":"https://avatars.githubusercontent.com/u/6033?v=4","gravatar_id":"","url":"https://api.github.com/users/jasonpenny","html_url":"https://github.com/jasonpenny","followers_url":"https://api.github.com/users/jasonpenny/followers","following_url":"https://api.github.com/users/jasonpenny/following{/other_user}","gists_url":"https://api.github.com/users/jasonpenny/gists{/gist_id}","starred_url":"https://api.github.com/users/jasonpenny/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasonpenny/subscriptions","organizations_url":"https://api.github.com/users/jasonpenny/orgs","repos_url":"https://api.github.com/users/jasonpenny/repos","events_url":"https://api.github.com/users/jasonpenny/events{/privacy}","received_events_url":"https://api.github.com/users/jasonpenny/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"8c4a05214101acd6b9cef52a26dea665750cf4b2","commit_url":"https://api.github.com/repos/Appboy/sidekiq/commits/8c4a05214101acd6b9cef52a26dea665750cf4b2","created_at":"2024-05-02T13:39:45Z","performed_via_github_app":null}]